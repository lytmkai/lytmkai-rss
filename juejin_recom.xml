<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[GLM-4.6V 初探：国产 AI 能边写边自己配图了]]></title>    <link>https://juejin.cn/post/7582102297480740906</link>    <guid>https://juejin.cn/post/7582102297480740906</guid>    <pubDate>2025-12-10T14:34:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582102297480740906" data-draft-id="7582102297480724522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GLM-4.6V 初探：国产 AI 能边写边自己配图了"/> <meta itemprop="keywords" content="ChatGLM (智谱),人工智能"/> <meta itemprop="datePublished" content="2025-12-10T14:34:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GLM-4.6V 初探：国产 AI 能边写边自己配图了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:34:58.000Z" title="Wed Dec 10 2025 14:34:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写文章时总会遇到需要插图解释的地方，之前分享过<code>即梦</code>可以为文章全文配图了。</p>
<p>《<a href="https://juejin.cn/post/7566526381727924266" target="_blank" title="https://juejin.cn/post/7566526381727924266">即梦AI竟然可以全文一键配图了？ - 掘金</a>》</p>
<p>但终归还需要手动复制、粘贴，体验没有那么完美。</p>
<p>常用的 AI 我当时也尝试了，只有 <code>Gemini</code> 给出了图文混排的结果。</p>
<p>如今，国产模型给出了选择——<code>GLM-4.6V</code>，一键搞定图文混排内容创作。</p>
<h2 data-id="heading-0">GLM-4.6V</h2>
<p><code>GLM</code> 的 V 系列是智谱模型中的多模态大模型，效果一直不错。</p>
<p>本次发布包括两款模型：</p>
<ul>
<li><strong>GLM-4.6V（106B-A12B）</strong>：面向云端与高性能集群场景的基础版；</li>
<li><strong>GLM-4.6V-Flash（9B）</strong>：面向本地部署与低延迟应用的轻量版。</li>
</ul>
<p>其中，<code>Flash</code> 版本依然免费提供给大家使用。</p>
<p>这次发布的主要内容如下：</p>
<ul>
<li>训练时上下文窗口提升到 <code>128k tokens</code>，在视觉理解精度上达到同参数规模 <code>SOTA</code>。</li>
<li>首次在模型架构中将 <code>Function Call</code>（工具调用）能力原生融入视觉模型，打通从**「视觉感知」<strong>到</strong>「可执行行动（Action）」**的链路。</li>
</ul>
<p>我们直接到 <code>z.ai</code> 上体验下“工具调用能力原生融入视觉模型”是什么感受。</p>
<h2 data-id="heading-1">原生多模态工具调用实测</h2>
<p>场景比较简单，我让 <code>GLM-4.6V</code> 帮我写一篇 <code>Gemini 3 Pro</code> 的科普文章，重要的是输出要图文混排。</p>
<p><strong>提示词</strong></p>
<pre><code class="hljs">帮我写一篇介绍 Gemini 3 pro 的科普文章，需要图文并茂
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e8826a8cca4bcbba31f8b44b1a42a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765982098&amp;x-signature=Q209VOJIxpVk%2BCB6EPE7kzOipm0%3D" alt="" loading="lazy"/></p>
<p>截图中可以看到思考过程中就可以调用图片搜索工具（<code>Function</code>），查找适合的图片以供使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e5ddf442c704204a875bdee0c0da20b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765982098&amp;x-signature=924RGg%2BDpS5X%2F2k7ol%2Bz4cT4Bqc%3D" alt="" loading="lazy"/></p>
<p>后续也确实在文章中使用了上面的图片，并针对图片进行了文字解释。</p>
<p>整个过程完全自动化，一轮对话就能得到一篇图文并茂的高质量文章了。</p>
<h2 data-id="heading-2">结语</h2>
<p>这意味着，以后的内容创作，终于不用在不同模型间来回切换了。</p>
<p>但我认为意义远不止这一点。</p>
<p><strong>多模态大模型中的“多”一直指的是可以支持的种类多，而不是一轮对话中的语料模态“多”</strong>。</p>
<p>现在，使用 GLM-4.6V，我们可以一次性传递文字、图片两种模态，后续语音、视频估计也会陆续出现。</p>
<p>这种模型能力的提升，将会更加精准的描述真实世界，相应的，模型后续的服务水平也一定会再次提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊聊协程里的 Semaphore：别让协程挤爆门口]]></title>    <link>https://juejin.cn/post/7582016579858169890</link>    <guid>https://juejin.cn/post/7582016579858169890</guid>    <pubDate>2025-12-10T14:18:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579858169890" data-draft-id="7582036070159695872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊聊协程里的 Semaphore：别让协程挤爆门口"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-10T14:18:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RainyJiang"/> <meta itemprop="url" content="https://juejin.cn/user/2287404300943566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊聊协程里的 Semaphore：别让协程挤爆门口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2287404300943566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RainyJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:18:11.000Z" title="Wed Dec 10 2025 14:18:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-dune-light">.hljs-comment,.hljs-quote{color:#7d7a68}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d73737}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#b65611}.hljs-bullet,.hljs-string,.hljs-symbol{color:#60ac39}.hljs-section,.hljs-title{color:#6684e1}.hljs-keyword,.hljs-selector-tag{color:#b854d4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefbec;color:#6e6b5e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在工作中遇到了一个非常普通的小需求，客户端需要从云端上拉取一堆图片链接，并且针对图片做升序处理后展示最终列表。听起来是不是很简单呢，不就是“下载 → 看大小 → 排排序“就搞定了。结果一跑，服务器差点被我按在地上摩擦。因为图片一多，协程一个个像打了鸡血一样，<strong>同时起飞！同时请求！同时冲向服务器！</strong> 这边的客户端是觉得很爽，很嗨了。但云服务器那边就不太乐观了：“兄der你冷静点，我不是 CDN，我只是个普通打工人 API 啊！”</p>
<p>是的，当成百上千万个协程一起拉图片的时候，网络连接开始爆满，服务端响应变慢，客户端排序逻辑还没跑起来，先被自己的并发压垮了。这时候恭喜你，体验到了<strong>无限制并发的恐怖后果</strong>。</p>
<p>就是在这混乱的“协程暴走事件”中，笔者意识到：<strong>需要有人来控场，需要一个能让协程排队、有序、文明办事的存在。</strong></p>
<p>于是<em>Kotlin</em>的 <em>Semaphore</em>信号量闪亮登场了，相信各位小伙伴都不陌生了。它像一个经验丰富的交通指挥员，站在网络请求入口处，对协程们说：“别挤别挤，一个一个来，最多五个同时下载，懂？”。从那以后，图片请求不再挤爆服务器，排序流程顺顺利利。</p>
<p>OK, 相信小伙伴们已经知道今天我们要聊什么了，没错，今天要聊的主角，就是那个能帮大家<strong>维持秩序、防止过度热情</strong>的小家伙：<em>Semaphore(信号量)</em> 。</p>
<h2 data-id="heading-1">一句话解释协程中的<em>Semaphore</em></h2>
<p>这时候就有同学要问了，啥是协程中的<em>Semaphore</em>，它和Java当中的<em>Semaphore</em>是一个东西么？</p>
<p>我们打个比方，假如我们刚刚开了一家火锅店，但店里此时只有 5 个炉子。顾客排成长龙，每个顾客都想自己涮菜。这时候怎么办？</p>
<p>于是你定了以下的规则：</p>
<ul>
<li>同时最多5个顾客拿到烤炉（许可证）</li>
<li>当有顾客吃完了（<em>release</em>），下一个顾客再接着上(<em>acquire</em>)</li>
</ul>
<p>这就是信号量的职责所在，Kotlin的<em>Semaphore</em>也干着类似的事情，它控制着<strong>同时能有多少个协程进入某段代码</strong>。一旦超过了？那后面就<strong>乖乖排队、挂起等待</strong>。</p>
<p>Java中同样也叫这个，但很可惜，它们并不算是同一个东西。我们可以简单理解为：一个是 <strong>“协程世界的交警”</strong> ，一个是 <strong>“线程世界的交警”</strong> ，都不在一个地方，工作方式也有所不同。具体这里就不过多延展，感兴趣的小伙伴可以仔细研究研究，下面笔者用一个表格简单概括下它们之前的区别</p>


















































<table><thead><tr><th/><th>Java Semaphore</th><th>Kotlin Coroutine Semaphore</th></tr></thead><tbody><tr><td>所属包</td><td><em>java.util.concurrent</em></td><td><em>kotlinx.coroutines.sync</em></td></tr><tr><td>控制对象</td><td>线程</td><td>协程</td></tr><tr><td>阻塞方式</td><td>阻塞线程（<em>Blocking</em>）</td><td>挂起协程（<em>Suspending</em>）</td></tr><tr><td>性能特征</td><td>线程上下文切换开销大</td><td>非阻塞、轻量、可扩展</td></tr><tr><td>使用语法</td><td><em>acquire()</em> / <em>release()</em></td><td><em>withPermit { ... }</em> （挂起安全的）</td></tr><tr><td>出错后释放</td><td>手动 <em>try...finally</em></td><td>自动（<em>withPermit</em>）</td></tr><tr><td>使用场景</td><td>多线程同步、并发限流</td><td>协程并发控制、异步限流</td></tr><tr><td>公平性</td><td>可选公平模式</td><td>默认不公平（可自定义逻辑）</td></tr></tbody></table>
<h2 data-id="heading-2">如何使用<em>Semaphore</em></h2>
<p>Kotlin的<em>Semaphore</em>核心用户其实就是两个字：进出</p>
<ul>
<li><em>acquire</em>:申请许可证（进门）</li>
<li>release: 释放许可证（出门）</li>
</ul>
<p>由于Kotlin中懒得使用<em>try..finally</em>, 所以官方非常贴心的封装了个函数，自动帮你 acquire + release，就像门禁刷脸自动出入，不必担心忘记带卡而被关在了外面。</p>
<pre><code class="hljs language-arduino" lang="arduino">semaphore.withPermit {
    <span class="hljs-comment">// 受保护的代码区</span>
}
</code></pre>
<h2 data-id="heading-3">聊聊一些使用<em>Semaphore</em>的场景</h2>
<h3 data-id="heading-4">场景1：限流请求，不被封号</h3>
<p>假设我们要抓取几十个网页，但网站规定每次最多 5 个并发。直接上<em>Sempahore</em></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchAll</span><span class="hljs-params">(urls: <span class="hljs-type">List</span>)</span></span> = coroutineScope {
    <span class="hljs-keyword">val</span> semaphore = Semaphore(<span class="hljs-number">5</span>)
    urls.map { url -&gt;
        async {
            semaphore.withPermit {
                println(&amp;#<span class="hljs-number">34</span>;开始抓取 $url&amp;#<span class="hljs-number">34</span>;)
                delay(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟网络请求</span>
                &amp;#<span class="hljs-number">34</span>;内容来自 $url&amp;#<span class="hljs-number">34</span>;
            }
        }
    }.awaitAll()
}
</code></pre>
<p><em>Semaphore</em>在这里就是我们的“爬虫节流阀”，优雅地让你在不被 ban 掉的边缘反复试探。兄弟，别试探了</p>
<h3 data-id="heading-5">场景2：CPU 密集任务的节流阀</h3>
<p>如果我们有一些非常重且耗时的计算任务Task,</p>
<pre><code class="hljs language-scss" lang="scss">(<span class="hljs-number">1</span>..<span class="hljs-number">10000000</span>)<span class="hljs-selector-class">.map</span> {
    async { <span class="hljs-built_in">heavyCompute</span>(it) }
}<span class="hljs-selector-class">.awaitAll</span>()
​
</code></pre>
<p>CPU迟早被我们榨干了，改用<em>Samphore</em>试试吧</p>
<pre><code class="hljs language-scss" lang="scss">val semaphore = <span class="hljs-built_in">Semaphore</span>(Runtime.getRuntime()<span class="hljs-selector-class">.availableProcessors</span>())
(<span class="hljs-number">1</span>..<span class="hljs-number">10000000</span>)<span class="hljs-selector-class">.map</span> {
    async {
        semaphore<span class="hljs-selector-class">.withPermit</span> {
            <span class="hljs-built_in">heavyCompute</span>(it)
        }
    }
}<span class="hljs-selector-class">.awaitAll</span>()
</code></pre>
<p>CPU终于能喘口气，不再进行成千上百万个计算内卷中。</p>
<h2 data-id="heading-6">注意事项：一些容易翻车的点</h2>
<h3 data-id="heading-7">1. 忘记 <em>release()</em> → 协程永远卡在门口</h3>
<p>如果我们手动使用 <em>acquire()</em> ，却在中途代码块中报错了、return、或者忘记在 <em>finally</em>中调用 <em>release()</em> ，那许可证就“丢了”。剩余<em>permits</em>会越来越少，最后所有协程都会停在 <em>acquire()</em> 这一步，再也不继续执行。</p>
<p>就像饭店一共 3 个炉子，有个客人用完忘了还炉子，还把炉子带走了，全店从此只能开 2 个炉子，之后客人纷纷效仿，以至于最后厨房彻底瘫痪。</p>
<pre><code class="hljs language-scss" lang="scss">semaphore<span class="hljs-selector-class">.acquire</span>()
<span class="hljs-built_in">doSomething</span>()  <span class="hljs-comment">// 这里如果抛异常了...</span>
semaphore<span class="hljs-selector-class">.release</span>() <span class="hljs-comment">// 根本进不到这行</span>
</code></pre>
<p><strong>解决办法：一般情况下，用 <em>withPermit {}</em> 永远不会忘记释放！</strong></p>
<h3 data-id="heading-8">2. 重入信号量 → 协程“自锁成仙”</h3>
<p>这是啥意思呢？我们要知道<em>Semaphore</em> <strong>不是可重入的</strong>。同一个协程内部如果还没有释放前一个许可证，又再次 <em>acquire()</em> ，就会陷入死锁。因为自己拿着许可证，却又在等自己释放它。</p>
<pre><code class="hljs language-scss" lang="scss">semaphore<span class="hljs-selector-class">.withPermit</span> {
    <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;外层开始&amp;#<span class="hljs-number">34</span>;)
    semaphore<span class="hljs-selector-class">.withPermit</span> {  <span class="hljs-comment">// 冲突点就在这里</span>
        <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;内层：永远进不来&amp;#<span class="hljs-number">34</span>;)
    }
}
</code></pre>
<p>这段代码永远执行不到内层，因为外层拿着许可证不放。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>不要在受控区域里再次调用受控区域。</li>
<li>如果确实需要嵌套结构，改用别的机制（如<em>Mutex</em>）。</li>
</ul>
<h3 data-id="heading-9">3. 不公平调度 → 你以为是排队，其实是“插队现场”</h3>
<p>协程的<em>Semaphore</em> 是<strong>不保证公平性的</strong>。它不会确保“先等待的协程先获得许可证”。只要许可证释放时，有协程竞争到，它就上，谁先谁后，调度器说了算。</p>
<p><strong>这意味着：</strong></p>
<ul>
<li>某些协程可能一直抢不到许可证。</li>
<li>这在大量协程等待 + 高竞争的情况下更明显。</li>
</ul>
<p>就好比在网红店门口排队买奶茶，店员一开门让客人进来，结果永远是站得近的那几个人挤进去了。排在远处的几个倒霉蛋可能等了 10 分钟还是没进去。</p>
<pre><code class="hljs language-scss" lang="scss">val semaphore = <span class="hljs-built_in">Semaphore</span>(<span class="hljs-number">1</span>)
​
repeat(<span class="hljs-number">100</span>) { <span class="hljs-selector-tag">i</span> -&gt;
    launch {
        if (i == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 0号协程：可怜娃，可能永远等不到</span>
            semaphore<span class="hljs-selector-class">.withPermit</span> {
                <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">0</span>号终于进来了&amp;#<span class="hljs-number">34</span>;)
            }
        } else {
            semaphore<span class="hljs-selector-class">.withPermit</span> {
                <span class="hljs-comment">// 其他协程执行得更快，可能一直占着节奏</span>
            }
        }
    }
}
</code></pre>
<p>因为调度器会更“偏爱”执行速度快、生命周期短的协程，0 号协程可能一直抢不到时机。</p>
<p>好了，<strong>那么我们如何避免不公平引起的问题？</strong></p>
<p><strong>如果我们业务确实需要“先来先服务（FIFO）”，可以直接用手动队列：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> mutex = Mutex()
<span class="hljs-keyword">val</span> queue = ArrayDeque&gt;()
​
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fairAcquire</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> waiter = CompletableDeferred()
    mutex.lock()
    <span class="hljs-keyword">val</span> first = queue.isEmpty()
    queue.add(waiter)
    mutex.unlock()
    <span class="hljs-keyword">if</span> (!first) {
        waiter.await() <span class="hljs-comment">// 等前面的协程释放</span>
    }
}
​
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fairRelease</span><span class="hljs-params">()</span></span> {
    mutex.lock()
    queue.removeFirstOrNull()?.complete(<span class="hljs-built_in">Unit</span>)
    mutex.unlock()
}
</code></pre>
<p>此时我们再在 <em>withPermit</em> 外层套这套“公平队列”，就能实现真正的<strong>公平信号量</strong>。但大多数业务其实不需要这么严格，只要并发数量不夸张，默认的<em>Semaphore</em>是完全够用的。</p>
<h2 data-id="heading-10">尾声</h2>
<p>如果把协程世界比作一座城市：<em>launch</em> 是汽车 ，<em>delay</em> 是红灯，那 <em>Semaphore</em> 就是交通指挥员 。没有它，协程就会像一群没刹车的司机，挤成一锅粥。有了它，大家文明出行，井然有序。</p>
<p>那么什么时候该用<em>Semaphore</em>？</p>
<ul>
<li>
<p>当你想限制“同时干活的人数”，比如说一次只允许 <strong>5 个协程下载图片</strong>。</p>
</li>
<li>
<p>当你要保护一个“有限资源”，比如说数据库连接池只有 <strong>5 个连接</strong>，必须排队使用。</p>
</li>
<li>
<p>当你担心 API 被你打到 429，比如说云端接口规定 <strong>每秒最多 10 个请求</strong>，那必须乖乖遵守。</p>
</li>
<li>
<p>当你想让 CPU 活得久一点，比如说图片处理、AI 推理、压缩等重操作，不适合让几十个协程一起上。</p>
</li>
</ul>
<p>简单来说，当你需要“允许最多 N 个协程同时执行某段代码”的时候，可以考虑考虑<em>Semaphore</em>。</p>
<p>好了，就写到这里吧。</p>
<p>祝各位早安午安晚安，祉猷并茂，顺遂无虞。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo]]></title>    <link>https://juejin.cn/post/7582036070159941632</link>    <guid>https://juejin.cn/post/7582036070159941632</guid>    <pubDate>2025-12-10T14:58:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070159941632" data-draft-id="7582067084840124470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T14:58:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:58:54.000Z" title="Wed Dec 10 2025 14:58:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 开发中，我们习惯了浏览器的“智能”：切换标签页时页面会自动刷新，断网重连后请求会自动重试。这是因为浏览器底层自动处理了窗口聚焦（Window Focus）和网络状态（Online Status）的事件。</p>
<p>然而，在 <strong>React Native (Expo)</strong> 环境中，App 默认是“盲”和“聋”的。TanStack Query 不知道用户什么时候把 App 切到了后台，也不知道手机什么时候断了网。</p>
<p>为了让 App 拥有极致的用户体验（如：切回来自动刷新、断网自动暂停重试），我们需要手动配置 <strong>“感官系统”</strong> 。本文将深入解读 <strong><code>AppStateStatus</code></strong> 和 <strong><code>setOnline</code></strong>，并提供生产环境的完整配置方案。</p>
<hr/>
<h2 data-id="heading-0">一、 深度解读：App 的“感官系统”</h2>
<h3 data-id="heading-1">1. 视觉神经：<code>AppStateStatus</code> (应用状态)</h3>
<p>AppStateStatus 是 React Native 原生提供的一个状态类型，用于描述 App 当前处于什么处境。</p>
<p><strong>三个核心状态：</strong></p>
<ul>
<li><strong><code>active</code> (前台/活跃)</strong> ：用户正在盯着屏幕，App 在最上层运行。这是我们唯一希望触发数据刷新的状态。</li>
<li><strong><code>background</code> (后台)</strong> ：用户按了 Home 键，或者切换到了微信。App 还在内存中运行，但界面不可见。</li>
<li><strong><code>inactive</code> (非活跃)</strong> ：App 处于“半死不活”的过渡态（如被来电画面覆盖、拉下了通知栏、iOS 多任务切换界面）。</li>
</ul>
<p>为什么要配置它？</p>
<p>TanStack Query 有一个核心功能叫 Window Focus Refetching。</p>
<ul>
<li><strong>问题</strong>：RN 默认没有 <code>window.onfocus</code> 事件。</li>
<li><strong>解决</strong>：我们需要监听 <code>AppState</code> 的变化。当状态变为 <code>active</code> 时，手动调用 <code>focusManager.setFocused(true)</code>。</li>
<li><strong>效果</strong>：TanStack Query 收到信号后，会立即检查页面上的数据是否过期（Stale）。如果过期，它会在后台悄悄发起请求，用户切回来的一瞬间看到的就是最新数据。</li>
</ul>
<h3 data-id="heading-2">2. 听觉神经：<code>setOnline</code> (联网回调)</h3>
<p>setOnline 不是一个你可以直接导入的函数，它是 TanStack Query 的 onlineManager.setEventListener 方法传递给你的一个回调函数（参数）。你可以把它理解为 TanStack Query 递给你的一把“开关”。</p>
<p><strong>逻辑流程图：从断网到重连</strong></p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">---------------------------+</span>
| 📡 物理层                  |
| 手机 <span class="hljs-number">4</span>G/WiFi 信号变化       |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (触发系统事件)
+<span class="hljs-comment">-------------+-------------+</span>
| 🎧 B: NetInfo 监听器       |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (获取状态: isConnected)
+<span class="hljs-comment">-------------+-------------+</span>
| 💻 C: 开发者代码逻辑        |
| (app/_layout.tsx)         |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (调用 setOnline)
+<span class="hljs-comment">-------------+-------------+</span>
| ⚙️ D: TanStack Query      |
|     (onlineManager)       |
+<span class="hljs-comment">-------------+-------------+</span>
       /             \
      / (<span class="hljs-literal">false</span>)       \ (<span class="hljs-literal">true</span>)
     v                 v
+<span class="hljs-comment">---------+       +---------+</span>
| E: 🛑   |       | F: 🚀   |
| 暂停     |       | 恢复    |
| (Pause) |       | (Resume)|
| 停止重试 |       | 立即重试 |
+<span class="hljs-comment">---------+       +---------+</span>
</code></pre>
<p><strong>为什么要配置它？</strong></p>
<ul>
<li><strong>省电保护</strong>：如果没配置，断网时 TanStack Query 会傻傻地一直重试请求，消耗用户电量。配置后，断网即休眠。</li>
<li><strong>体验优化</strong>：如果没配置，网络恢复后，App 不会有反应，用户必须手动下拉刷新。配置后，<strong>信号恢复的瞬间，数据自动加载成功</strong>（“电梯效应”）。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 生产环境完整配置 (<code>app/_layout.tsx</code>)</h2>
<p>这是融合了上述原理的完整配置代码。请确保你已安装了 <code>@react-native-community/netinfo</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppState</span>, <span class="hljs-title class_">AppStateStatus</span>, <span class="hljs-title class_">Platform</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Slot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NetInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/netinfo'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">QueryClient</span>, 
  <span class="hljs-title class_">QueryClientProvider</span>, 
  focusManager, 
  onlineManager 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 1. 配置网络监听 (给 App 装上“耳朵”)</span>
<span class="hljs-comment">// =================================================================</span>
onlineManager.<span class="hljs-title function_">setEventListener</span>(<span class="hljs-function">(<span class="hljs-params">setOnline</span>) =&gt;</span> {
  <span class="hljs-comment">// setOnline 是 Query 传进来的一个函数，用来接收网络状态</span>
  <span class="hljs-comment">// 我们使用 NetInfo 来监听真实的网络变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NetInfo</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-comment">// state.isConnected 可能为 null，用 !! 强转为 boolean</span>
    <span class="hljs-comment">// 当这里调用 setOnline(true) 时，Query 会立即重试刚才失败的请求</span>
    <span class="hljs-title function_">setOnline</span>(!!state.<span class="hljs-property">isConnected</span>);
  });
});

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 2. 配置 App 状态监听 (给 App 装上“眼睛”)</span>
<span class="hljs-comment">// =================================================================</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onAppStateChange</span>(<span class="hljs-params">status: AppStateStatus</span>) {
  <span class="hljs-comment">// Web 浏览器会自动处理窗口聚焦，只有原生 App 需要手动处理</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> !== <span class="hljs-string">'web'</span>) {
    <span class="hljs-comment">// 核心逻辑：</span>
    <span class="hljs-comment">// 当 AppState 变为 'active' (前台) 时</span>
    <span class="hljs-comment">// 我们手动告诉 Query 的 focusManager：“用户现在聚焦在 App 上了”</span>
    <span class="hljs-comment">// Query 收到信号后，会检查页面数据是否过期 (stale)，如果过期则自动 Refetch</span>
    focusManager.<span class="hljs-title function_">setFocused</span>(status === <span class="hljs-string">'active'</span>);
  }
}

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 3. 初始化 QueryClient (配置全局策略)</span>
<span class="hljs-comment">// =================================================================</span>
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>,             <span class="hljs-comment">// 失败后自动重试 2 次</span>
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 数据 1 分钟内算“新鲜”，切回来也不刷新</span>
                            <span class="hljs-comment">// 超过 1 分钟后切回来，会触发自动刷新</span>
    },
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 注册 AppState 监听器</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 开始监听系统状态变化</span>
    <span class="hljs-keyword">const</span> subscription = <span class="hljs-title class_">AppState</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, onAppStateChange);
    
    <span class="hljs-comment">// 组件卸载时取消监听，这是防止内存泄漏的标准做法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">remove</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    
      {<span class="hljs-comment">/* Slot 是 Expo Router 的页面入口 */</span>}
      
    
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 总结</h2>
<p>在 React Native 中使用 TanStack Query，<strong>90% 的人只做了“安装”，而忽略了“配置”</strong> 。</p>
<p>如果不配置这两个管理器，你的 App 就失去了灵魂：</p>
<ol>
<li><strong><code>AppStateStatus</code> + <code>focusManager</code></strong>：让 App 知道“<strong>我醒了</strong>”，从而实现微信切回来的自动刷新。</li>
<li><strong><code>setOnline</code> + <code>onlineManager</code></strong>：让 App 知道“<strong>我有网了</strong>”，从而实现走出电梯后的自动重连。</li>
</ol>
<p>只要在 <code>_layout.tsx</code> 中写好配置代码，你应用里所有的 <code>useQuery</code> 就都自动拥有了这些原生级别的感知能力。这就是从“能用”到“好用”的关键跨越。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔]]></title>    <link>https://juejin.cn/post/7581999251368460340</link>    <guid>https://juejin.cn/post/7581999251368460340</guid>    <pubDate>2025-12-10T14:30:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581999251368460340" data-draft-id="7582036070159745024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T14:30:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:30:11.000Z" title="Wed Dec 10 2025 14:30:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>据 <code>大厂日报</code> 称，美团履约团队近期正在推行"全栈化"转型。据悉，终端组的部分前端同学在 11 月末左右转到了后端组做全栈（前后端代码一起写），主要是 agent 相关项目。内部打听了一下，团子目前全栈开发还相对靠谱，上线把控比较严格。</p>
<p>这一消息在技术圈引起了广泛关注，也反映了 AI 时代下前端工程师向全栈转型的必然趋势。但更重要的是，我们需要深入思考：AI 到底给前端带来了什么冲击？为什么前端转全栈成为了必然选择？</p>
<p>最近，前端圈里不断有"前端已死"的话语流出。有人说 AI 工具会替代前端开发，有人说低代码平台会让前端失业，还有人说前端工程师的价值正在快速下降。这些声音虽然有些极端，但确实反映了 AI 时代前端面临的真实挑战。</p>
<h2 data-id="heading-0">一、AI 对前端的冲击：挑战与机遇并存</h2>
<h3 data-id="heading-1">1. 代码生成能力的冲击</h3>
<p>冲击点：</p>
<ul>
<li>低复杂度页面生成：AI 工具（如 Claude Code、Cursor）已经能够快速生成常见的 UI 组件、页面布局</li>
<li>重复性工作被替代：表单、列表、详情页等标准化页面，AI 生成效率远超人工</li>
<li>学习门槛降低：新手借助 AI 也能快速产出基础代码，前端"入门红利"消失</li>
</ul>
<p>影响：
传统前端开发中，大量时间花在"写页面"上。AI 的出现，让这部分工作变得极其高效，甚至可以说，只会写页面的前端工程师，价值正在快速下降。这也正是"前端已死"论调的主要依据之一。</p>
<h3 data-id="heading-2">2. 业务逻辑前移的冲击</h3>
<p>冲击点：</p>
<ul>
<li>AI Agent 项目激增：如美团案例中的 agent 相关项目，需要前后端一体化开发</li>
<li>实时交互需求：AI 应用的流式响应、实时对话，要求前后端紧密配合</li>
<li>数据流转复杂化：AI 模型调用、数据处理、状态管理，都需要全栈视角</li>
</ul>
<p>影响：
纯前端工程师在 AI 项目中往往只能负责 UI 层，无法深入业务逻辑。而 AI 项目的核心价值在于业务逻辑和数据处理，这恰恰是后端能力。</p>
<h3 data-id="heading-3">3. 技术栈边界的模糊</h3>
<p>冲击点：</p>
<ul>
<li>前后端一体化趋势：Next.js、Remix 等全栈框架兴起，前后端代码同仓库</li>
<li>Serverless 架构：边缘函数、API 路由，前端开发者需要理解后端逻辑</li>
<li>AI 服务集成：调用 AI API、处理流式数据、管理状态，都需要后端知识</li>
</ul>
<p>影响：
前端和后端的边界正在消失。只会前端的前端工程师，在 AI 时代会发现自己"够不着"核心业务。</p>
<h3 data-id="heading-4">4. 职业发展的天花板</h3>
<p>冲击点：</p>
<ul>
<li>技术深度要求：AI 项目需要理解数据流、算法逻辑、系统架构</li>
<li>业务理解能力：全栈开发者能更好地理解业务全貌，做出技术决策</li>
<li>团队协作效率：全栈开发者减少前后端沟通成本，提升交付效率</li>
</ul>
<p>影响：
在 AI 时代，只会前端的前端工程师，职业天花板明显。而全栈开发者能够：</p>
<ul>
<li>独立负责完整功能模块</li>
<li>深入理解业务逻辑</li>
<li>在技术决策中发挥更大作用</li>
</ul>
<h2 data-id="heading-5">二、为什么前端转全栈是必然选择？</h2>
<h3 data-id="heading-6">1. AI 项目的本质需求</h3>
<p>正如美团案例所示，AI 项目（特别是 Agent 项目）的特点：</p>
<ul>
<li>前后端代码一起写：业务逻辑复杂，需要前后端协同</li>
<li>数据流处理：AI 模型的输入输出、流式响应处理</li>
<li>状态管理复杂：对话状态、上下文管理、错误处理</li>
</ul>
<p>这些需求，纯前端工程师无法独立完成，必须掌握后端能力。</p>
<h3 data-id="heading-7">2. 技术发展的趋势</h3>
<ul>
<li>全栈框架普及：Next.js、Remix、SvelteKit 等，都在推动全栈开发</li>
<li>边缘计算兴起：Cloudflare Workers、Vercel Edge Functions，前端需要写后端逻辑</li>
<li>微前端 + 微服务：前后端一体化部署，降低系统复杂度</li>
</ul>
<h3 data-id="heading-8">3. 市场需求的转变</h3>
<ul>
<li>招聘要求变化：越来越多的岗位要求"全栈能力"</li>
<li>项目交付效率：全栈开发者能独立交付功能，减少沟通成本</li>
<li>技术决策能力：全栈开发者能更好地评估技术方案</li>
</ul>
<h2 data-id="heading-9">三、后端技术栈的选择：Node.js、Python、Go</h2>
<p>对于前端转全栈，后端技术栈的选择至关重要。不同技术栈有不同优势，需要根据项目需求选择。</p>
<h3 data-id="heading-10">1. Node.js + Nest.js：前端转全栈的最佳起点</h3>
<p>优势：</p>
<ul>
<li>零语言切换：JavaScript/TypeScript 前后端通用</li>
<li>生态统一：npm 包前后端共享，工具链一致</li>
<li>学习成本低：利用现有技能，快速上手</li>
<li>AI 集成友好：LangChain.js、OpenAI SDK 等完善支持</li>
</ul>
<p>适用场景：</p>
<ul>
<li>Web 应用后端</li>
<li>实时应用（WebSocket、SSE）</li>
<li>微服务架构</li>
<li>AI Agent 项目（如美团案例）</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Node.js 基础（事件循环、模块系统）</li>
<li>Nest.js 框架（模块化、依赖注入）</li>
<li>数据库集成（TypeORM、Prisma）</li>
<li>AI 服务集成（OpenAI、流式处理）</li>
</ol>
<h3 data-id="heading-11">2. Python + FastAPI：AI 项目的首选</h3>
<p>优势：</p>
<ul>
<li>AI 生态最完善：OpenAI、LangChain、LlamaIndex 等原生支持</li>
<li>数据科学能力：NumPy、Pandas 等数据处理库</li>
<li>快速开发：语法简洁，开发效率高</li>
<li>模型部署：TensorFlow、PyTorch 等模型框架</li>
</ul>
<p>适用场景：</p>
<ul>
<li>AI/ML 项目</li>
<li>数据分析后端</li>
<li>科学计算服务</li>
<li>Agent 项目（需要复杂 AI 逻辑）</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Python 基础（语法、数据结构）</li>
<li>FastAPI 框架（异步、类型提示）</li>
<li>AI 库集成（OpenAI、LangChain）</li>
<li>数据处理（Pandas、NumPy）</li>
</ol>
<h3 data-id="heading-12">3. Go：高性能场景的选择</h3>
<p>优势：</p>
<ul>
<li>性能优秀：编译型语言，执行效率高</li>
<li>并发能力强：Goroutine 并发模型</li>
<li>部署简单：单文件部署，资源占用少</li>
<li>云原生友好：Docker、Kubernetes 生态完善</li>
</ul>
<p>适用场景：</p>
<ul>
<li>高并发服务</li>
<li>微服务架构</li>
<li>云原生应用</li>
<li>性能敏感场景</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Go 基础（语法、并发模型）</li>
<li>Web 框架（Gin、Echo）</li>
<li>数据库操作（GORM）</li>
<li>微服务开发</li>
</ol>
<h3 data-id="heading-13">4. 技术栈选择建议</h3>
<p>对于前端转全栈的开发者：</p>
<ol>
<li>
<p>首选 Node.js：如果目标是快速转全栈，Node.js 是最佳选择</p>
<ul>
<li>学习成本最低</li>
<li>前后端代码复用</li>
<li>适合大多数 Web 应用</li>
</ul>
</li>
<li>
<p>考虑 Python：如果专注 AI 项目</p>
<ul>
<li>AI 生态最完善</li>
<li>适合复杂 AI 逻辑</li>
<li>数据科学能力</li>
</ul>
</li>
<li>
<p>学习 Go：如果追求性能</p>
<ul>
<li>高并发场景</li>
<li>微服务架构</li>
<li>云原生应用</li>
</ul>
</li>
</ol>
<p>建议：</p>
<ul>
<li>第一阶段：选择 Node.js，快速转全栈</li>
<li>第二阶段：根据项目需求，学习 Python 或 Go</li>
<li>长期目标：掌握多种技术栈，根据场景选择</li>
</ul>
<h2 data-id="heading-14">四、总结</h2>
<p>AI 时代的到来，给前端带来了深刻冲击：</p>
<ol>
<li>代码生成能力：低复杂度页面生成被 AI 替代</li>
<li>业务逻辑前移：AI 项目需要前后端一体化</li>
<li>技术边界模糊：前后端边界正在消失</li>
<li>职业天花板：只会前端的前端工程师，发展受限</li>
</ol>
<p>前端转全栈，是 AI 时代的必然选择。</p>
<p>对于技术栈选择：</p>
<ul>
<li>Node.js：前端转全栈的最佳起点，学习成本低</li>
<li>Python：AI 项目的首选，生态完善</li>
<li>Go：高性能场景的选择，云原生友好</li>
</ul>
<p>正如美团的全栈化实践所示，全栈开发还相对靠谱，关键在于：</p>
<ul>
<li>选择合适的技术栈</li>
<li>建立严格的开发流程</li>
<li>持续学习和实践</li>
</ul>
<p>对于前端开发者来说，AI 时代既是挑战，也是机遇。转全栈，不仅能应对 AI 冲击，更能打开职业发展的新空间。那些"前端已死"的声音，其实是在提醒我们：只有不断进化，才能在这个时代立足。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[亲历外企裁员：上午还在写代码，下午工位就空了]]></title>    <link>https://juejin.cn/post/7582048028393144370</link>    <guid>https://juejin.cn/post/7582048028393144370</guid>    <pubDate>2025-12-10T15:03:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582048028393144370" data-draft-id="7581893894176473098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="亲历外企裁员：上午还在写代码，下午工位就空了"/> <meta itemprop="keywords" content="程序员,面试,求职"/> <meta itemprop="datePublished" content="2025-12-10T15:03:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Konata_9"/> <meta itemprop="url" content="https://juejin.cn/user/888061123629997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            亲历外企裁员：上午还在写代码，下午工位就空了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888061123629997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Konata_9
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T15:03:33.000Z" title="Wed Dec 10 2025 15:03:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880839605848438f9804473043fa7eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=reIjBJw%2BHfgqkvnA4V3NXxxTRdE%3D" alt="jimeng-2025-12-09-9499-现代办公室内部，冷色调，蓝色和灰色为主，空荡荡的工位，几台亮着的显示器，窗外是阴..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-0">引子：不再是“主动的选择”</h2>
<p>记得 2018 年的时候，年轻与互联网的兴起，只要简历挂在求职 APP 上，立马就会有猎头或者 HR 来联系。在那时，离职通常伴随着的是薪资增长和职级的跃升。</p>
<p>那时候的我们，仿佛是在草原上逐水草而居的游牧民族，哪里水草丰美就去哪里，从未想过草原也会有枯黄的一天。</p>
<p>然而今天，我第一次以旁观者的身份，见证了一场并非出于自愿的离别。当大环境不再安定、当时代的红利退潮，裸泳的不仅是企业，还有每一个身处其中的个体。</p>
<h2 data-id="heading-1">现场：两小时的“消失术”</h2>
<p>早在一个月前，空气中就已经弥漫着不安的味道。或者说早在 HC（Headcount）冻结时，就已经埋下了伏笔。</p>
<p>11月的时候，一些原本该续签的合同被搁置，那时候我们就知道，暴风雨要来了。但我没想到，它来得如此迅猛且安静。</p>
<p>早上 9 点，无意间瞥见 Leader 们聚在一间会议室中开会。原以为是他们的例会，没曾想会是裁员的开始键：</p>
<p>Leader 谈话 -&gt; 确认赔偿 -&gt; 签字 -&gt; 交还电脑 -&gt; 离开。</p>
<p>这场“斩首行动”持续了不到两个小时，迅速且安静。整个过程持续到了上午 11 点，尘埃落定。整个部门合计少了四分之一的人。</p>
<p>外企的体面在这一刻展现得淋漓尽致，同时也冷酷得令人心惊。没有多余的废话，只有流程和结果。前一分钟还在和我说要修 CI 错误的同事，后一分钟工位就已经回来和我们告别了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01d87d8803d641c88b9d35d15b92d0db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=R6hhlK08SlzoNNQHm%2Bcp7iDlDpA%3D" alt="jimeng-2025-12-09-6938-咖啡厅的一角，桌上放着两杯咖啡，模糊的背景是繁华的城市CBD，透过玻璃窗看外面，..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-2">午餐：焦虑的泡沫</h2>
<p>中午，“幸存”下来的同事不约而同地一起去吃饭。</p>
<p>话题不再是往日的“最近哪个 AI 技术栈很火”、“哪个 Node.js 的库可以用到项目里”，而是变成了“现在出去了能做什么”、“还会有下一波吗”。</p>
<p>谈到赔偿，由于不方便透露，只能算是“中规中矩”。即不会像佳能那样上新闻，也不会闹到仲裁。</p>
<p>在六七年前，这笔钱可能是一笔快乐的旅游基金；而在当下的环境中，它更像是一笔“过冬费”，是面对未知的漫长寒冬时，手里仅有的一点余粮。</p>
<p>吃完饭后，大家也是心照不宣地散着步。专门挑了太阳最大的地方走了好久，仿佛可以驱散身上的寒气。</p>
<p>但我们都清楚，我们这些留下来的人，也没有太多庆幸。更多的是一种“兔死狐悲”的无力感。谁也不知道，下一次名单上会不会有自己的名字。</p>
<h2 data-id="heading-3">下午：沉默的办公室</h2>
<p>回到工位，工作还得继续。代码还在那里，Bug 还没修完，PR 还等着 Merge。</p>
<p>但当看到 PR 中那些点了 Approve 或者留下 Comments 的“前”同事的头像，竟有一丝不想 Merge 的冲动。</p>
<p>发生了这么大的事情后，办公室的氛围自然变了。往常到了下班点，大家可能还会为了赶进度再多待一会儿或者一起聊会天。但今天，一到时间，Leader 们就示意大家早点回去，不要再加班了。</p>
<p>这不仅是一种体恤，更像是一种无声的宣告：当“努力”已经无法对抗“趋势”时，大家默契地选择了“节能模式”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/596a116a9413405193ac5f31db691cc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=SUJthrxWEZFvtxHGMilMp4LAF8w%3D" alt="jimeng-2025-12-09-2436-一个人孤独地站在高楼的落地窗前，背影，俯瞰着下面繁忙但渺小的城市车流，夕阳西下或..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-4">结语</h2>
<p>古人云：“山雨欲来风满楼”。今天的这场裁员，或许只是时代大潮中的一朵浪花。</p>
<p>外企曾经是我们心中的避风港，意味着高薪、体面、Work-Life Balance。但今天的一切告诉我们，在这个充满不确定性的时代，没有绝对的安全岛。</p>
<p>对于我们每一个技术人来说，或许是时候重新审视自己的核心竞争力了。当大潮退去，我们手里握着的，究竟是可以随时变现的技能，还是一张随时可能失效的工牌？</p>
<p>最后的最后，我想说我们组本来人也不多，大家关系也都很好，平时说说笑笑也很开心。衷心祝愿他们能在后面的日子顺利。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？]]></title>    <link>https://juejin.cn/post/7582016579857989666</link>    <guid>https://juejin.cn/post/7582016579857989666</guid>    <pubDate>2025-12-10T13:07:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579857989666" data-draft-id="7582016579857973282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？"/> <meta itemprop="keywords" content="前端,CSS,HTML"/> <meta itemprop="datePublished" content="2025-12-10T13:07:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="胡gh"/> <meta itemprop="url" content="https://juejin.cn/user/494101298678516"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/494101298678516/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    胡gh
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:07:47.000Z" title="Wed Dec 10 2025 13:07:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h3 data-id="heading-0">前言</h3>
<p>在现代 Web 开发中，<code>transform</code> 几乎成了动效与居中的代名词。它高效、灵活、支持硬件加速，一句 <code>transform: translate(-50%, -50%)</code> 就能优雅实现未知尺寸元素的绝对居中——这曾是多少前端开发者梦寐以求的解决方案。然而，在赞美其强大之余，我们是否忽略了它那“温柔面具”下的另一面？<strong><code>transform</code> 不仅改变视觉，更悄然重塑了 CSS 的底层规则——尤其是与 <code>position</code> 的交互，常常成为布局崩坏的隐形元凶。</strong></p>
<hr/>
<h3 data-id="heading-1">一、<code>transform</code> 的“理想面”：高效、无侵入、表现力强</h3>
<h4 data-id="heading-2">核心优势：不扰动文档流</h4>
<p>这是 <code>transform</code> 最被称道的特性：<strong>它只作用于合成层（compositing layer），不影响文档流中的占位</strong>。<br/>
对比传统方案：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 低效：触发重排（reflow） */</span>
<span class="hljs-selector-class">.box</span> { <span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>; }

<span class="hljs-comment">/* 高效：仅触发合成（compositing） */</span>
<span class="hljs-selector-class">.box</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(<span class="hljs-number">20px</span>, <span class="hljs-number">10px</span>); }
</code></pre>
<p>前者会迫使浏览器重新计算整个布局树，而后者直接由 GPU 处理，帧率更高、能耗更低。</p>
<h4 data-id="heading-3">经典用例：绝对居中</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.centered</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<ul>
<li><strong>无需知道宽高</strong>：<code>-50%</code> 基于元素自身尺寸，完美适配动态内容。</li>
<li><strong>语义清晰</strong>：意图明确，代码简洁。</li>
<li><strong>性能优异</strong>：远胜 <code>margin: auto</code> 或 <code>calc()</code> 方案。</li>
</ul>
<h4 data-id="heading-4">交互增强：微动效提升体验</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.02</span>);
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span> ease;
}
</code></pre>
<p>这种“浮起”效果已成为现代 UI 的标配，而 <code>transform</code> 是实现它的最佳载体。</p>
<hr/>
<h3 data-id="heading-5">二、<code>transform</code> 的“暗面”：当它遇上 <code>position</code></h3>
<p>问题来了：<strong>如果 <code>transform</code> 如此美好，为何无数开发者在使用 Modal、Tooltip 时遭遇“fixed 元素跟着滚动”的诡异现象？</strong></p>
<p>答案就藏在 CSS 规范的一个角落里：</p>
<blockquote>
<p><strong>“任何非 <code>none</code> 的 <code>transform</code> 值，都会使该元素成为其 <code>position: fixed</code> 后代的包含块（containing block）。”</strong></p>
</blockquote>
<p>这意味着：<strong><code>fixed</code> 元素的定位参考系，不再是视口，而是最近的带 <code>transform</code> 的祖先！</strong></p>
<h4 data-id="heading-6">实例：一个“失效”的固定导航栏</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"app"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"animated-section"</span>&gt; 
    &lt;nav <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar"</span>&gt;我是导航栏&lt;/nav&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.animated-section</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">/* 哪怕是“无操作”变换！ */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>; <span class="hljs-comment">/* 足够滚动 */</span>
}

<span class="hljs-selector-class">.navbar</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: black;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
}
</code></pre>
<p><strong>预期行为</strong>：导航栏固定在顶部，页面滚动时不动。<br/>
<strong>实际行为</strong>：导航栏随 <code>.animated-section</code> 一起滚动！</p>
<blockquote>
<p><strong>原因</strong>：<code>.animated-section</code> 因 <code>transform</code> 成为新的包含块，<code>fixed</code> 的 <code>top: 0</code> 变成了“相对于该容器顶部”，而非视口。</p>
</blockquote>
<p>这并非浏览器 bug，而是 <strong>CSS 规范的明确设计</strong>。但对开发者而言，这却是一个典型的“符合规范但违背直觉”的陷阱。</p>
<hr/>
<h2 data-id="heading-7">补充</h2>
<hr/>
<h5 data-id="heading-8">关键补充属性</h5>
<h6 data-id="heading-9">1. <code>transform-origin</code>：修改变换原点</h6>
<p>默认变换原点是元素中心（<code>50% 50%</code> 或 <code>center center</code>），可通过该属性自定义：</p>
<ul>
<li>
<p>语法：<code>transform-origin: x y;</code>（x/y 支持 px、%、关键字（left/right/top/bottom/center））；</p>
</li>
<li>
<p>示例：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">45deg</span>);
  <span class="hljs-attribute">transform-origin</span>: left top; <span class="hljs-comment">/* 绕左上角旋转 */</span>
}
</code></pre>
</li>
</ul>
<h6 data-id="heading-10">2. <code>transform-style</code>：3D 变换层级</h6>
<p>当使用 3D 变换（如 <code>rotateX/rotateY</code>）时，需设置该属性让子元素继承 3D 空间：</p>
<ul>
<li><code>transform-style: preserve-3d;</code>：保留 3D 变换效果（常用）；</li>
<li><code>transform-style: flat;</code>：默认值，子元素扁平化到 2D 平面。</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、不止 <code>transform</code>：<code>filter</code> 与 <code>perspective</code> 的共谋</h3>
<p>更令人头疼的是，<strong><code>transform</code> 并非孤例</strong>。以下属性同样会创建新的包含块：</p>
<ul>
<li><code>filter: blur(0)</code>（哪怕无视觉变化）</li>
<li><code>perspective: 1000px</code></li>
<li><code>will-change: transform</code></li>
</ul>
<p>它们常被用于：</p>
<ul>
<li>动画库（Framer Motion、GSAP）自动注入 <code>transform</code></li>
<li>组件库内部使用 <code>filter</code> 实现毛玻璃效果</li>
<li>3D 卡片组件启用 <code>perspective</code></li>
</ul>
<p>结果就是：<strong>你的 <code>fixed</code> Modal 突然无法覆盖全屏，Tooltip 错位，悬浮按钮失效……</strong></p>
<hr/>
<h3 data-id="heading-12">四、反思：我们是否过度依赖 <code>transform</code>？</h3>
<p><code>transform</code> 的流行，某种程度上掩盖了我们对 CSS 布局模型理解的不足。我们习惯性地用它解决一切位置问题，却忘了问：</p>
<blockquote>
<p><strong>“这个元素真的需要脱离文档流吗？它的祖先是否干净？”</strong></p>
</blockquote>
<p>在 React/Vue 等组件化框架中，问题被进一步放大：</p>
<ul>
<li>组件嵌套深，难以追踪哪个祖先加了 <code>transform</code></li>
<li>第三方库内部实现不可控</li>
<li>动画与布局逻辑耦合，调试困难</li>
</ul>
<p>于是，<code>transform</code> 从“解决方案”变成了“问题源头”。</p>
<hr/>
<h3 data-id="heading-13">五、破局之道：理性使用 + 架构规避</h3>
<h4 data-id="heading-14">1. <strong>浮层组件必须脱离当前上下文</strong></h4>
<p>在 React 中，<strong>永远使用 <code>ReactDOM.createPortal</code> 渲染 Modal/Toast/Dropdown</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Modal</span> = (<span class="hljs-params">{ children }</span>) =&gt; 
  <span class="hljs-title function_">createPortal</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
  );
</code></pre>
<p>这样可确保其祖先无 <code>transform</code>，<code>fixed</code> 行为符合预期。</p>
<h4 data-id="heading-15">2. <strong>避免在可能包含浮层的区域使用 <code>transform</code></strong></h4>
<ul>
<li>导航区域、主内容区慎用动画</li>
<li>若必须用，确保浮层不在其子树中</li>
</ul>
<h4 data-id="heading-16">3. <strong>调试时牢记“包含块”概念</strong></h4>
<p>当 <code>fixed</code> 行为异常，立即检查：</p>
<ul>
<li>所有祖先是否有 <code>transform</code> / <code>filter</code> / <code>perspective</code></li>
<li>是否意外创建了层叠上下文</li>
</ul>
<hr/>
<h3 data-id="heading-17">结语：工具无善恶，认知定成败</h3>
<p><code>transform</code> 本身并无过错。它是 CSS 进化的重要里程碑，极大提升了 Web 的表现力与性能。<br/>
<strong>真正的风险，来自于我们对其副作用的无知，以及对“简单一行代码就能解决问题”的盲目信任。</strong></p>
<p>前端开发不仅是写代码，更是理解系统。当我们熟练运用 <code>transform: translate(-50%, -50%)</code> 的同时，也应深知：</p>
<blockquote>
<p><strong>每一个看似优雅的解决方案背后，都有一套严密的规则在运行。忽视规则，终将被规则反噬。</strong></p>
</blockquote>
<p>因此，请继续热爱 <code>transform</code>，但请带着敬畏之心使用它——尤其是在与 <code>position</code> 共舞之时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文讲清：AI大模型预训练与后训练的数据选择]]></title>    <link>https://juejin.cn/post/7581893894176325642</link>    <guid>https://juejin.cn/post/7581893894176325642</guid>    <pubDate>2025-12-10T13:07:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581893894176325642" data-draft-id="7582063437413728294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文讲清：AI大模型预训练与后训练的数据选择"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-10T13:07:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文讲清：AI大模型预训练与后训练的数据选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:07:25.000Z" title="Wed Dec 10 2025 13:07:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>一、预训练的数据选择</strong></p>
<p><strong>模型影响力驱动（Influence / Importance-based Selection）</strong></p>
<p>MATES: Model-Aware Data Selection for Efficient Pretraining with Data Influence Models</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de65d2c485d0479291b89d50a8bcec2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=hyHRbLGFgx1axPSY1ir5Nx3LXvw%3D" alt="图片" loading="lazy"/></p>
<p>MATES创新性地设计了一种动态适应模型需求的数据筛选机制。</p>
<p>区别于传统静态过滤方法，该研究指出模型在训练进程中会持续改变对不同数据特征的"偏好倾向"，因此数据筛选策略需实现与训练进度的同步动态优化。</p>
<p>其方法论核心在于建立"数据价值评估模型"。</p>
<p>实施流程包含：训练周期内通过周期性探测（probe）量化各数据样本对模型性能的实际贡献度，利用该评估结果训练轻量级预测模型，进而预判海量语料中每项数据的潜在价值权重。</p>
<p>在后续训练阶段中，系统将优先采用预测价值较高的数据样本。</p>
<p>跨多种规模语言模型的验证实验显示，相较于随机采样或静态规则过滤，MATES在多项任务中实现平均性能的显著提升，且达成同等性能所需的计算资源可降低约50%。</p>
<p>该成果证实：基于模型实时状态的动态数据筛选机制，相比固定规则策略具有显著优势，代表了预训练数据管理技术的重要发展方向。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p>
<p><strong>质量 + 多样性平衡（Quality–Diversity Joint Methods）</strong></p>
<p>Harnessing Diversity for Important Data Selection in Pretraining Large Language Models</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c87bdc62a3490b96d3f030ee5977c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=q6YXg%2Bc4CCJmBxMKTNAm3ysOdLI%3D" alt="图片" loading="lazy"/></p>
<p>这篇论文聚焦于一个经典却易被忽略的挑战：仅依据"重要性"（如影响力或质量）筛选数据，往往会导致所选数据在语言风格、知识领域和语义分布上呈现高度同质化，进而削弱模型的泛化性能。</p>
<p>研究者提出的Quad方法创新性地通过同步优化数据的重要性和多样性来应对这一难题。</p>
<p>该方法首先采用高效的反向Hessian计算技术，量化每条数据对模型训练的影响权重。随后将语料库基于语义表示划分为多个簇，每个簇被建模为多臂赌博机问题中的一个独立"臂"。</p>
<p>在数据选择过程中，算法不仅优先筛选高影响力数据，还会主动挖掘那些被低频选择却具备潜在价值的簇，从而确保数据集的整体多样性。</p>
<p>实验验证显示，Quad在多个基准测试中均优于传统数据选择方法，并能显著增强模型的零样本学习能力。</p>
<p>该研究有力证明了在预训练数据筛选中，多样性与质量具有同等关键价值，同时提供了一个兼具可扩展性和实用性的解决方案。</p>
<p>QuaDMix: Quality–Diversity Balanced Data Selection for Efficient LLM Pretraining</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c796dac68845f48d56d62749c9ed58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=VuWC0tGKta%2Fhq%2FNfLzdcvnc7MIQ%3D" alt="图片" loading="lazy"/></p>
<p>QuaDMix 的研究表明，在预训练数据选择中，"质量"与"多样性"的传统独立处理方式会导致显著失衡，典型表现为高质量数据在特定领域的过度集中。</p>
<p>针对这一问题，QuaDMix 创新性地开发了一个集成框架，通过参数化采样分布同步整合两个关键维度。</p>
<p>该方法实施包含三个核心步骤：</p>
<p><strong>‌多维质量评估‌</strong>：对每项数据实施语言流畅性、文本复杂度及数据清洁度等多元指标量化</p>
<p><strong>‌领域特征标注‌</strong>：采用分类算法明确数据所属领域类别</p>
<p><strong>‌动态采样机制‌</strong>：基于"质量向量+领域标签"的复合函数计算采样概率，并通过小规模实验优化参数配置</p>
<p>实验数据证实，相较于单一优化质量或多样性的基准方法，QuaDMix 的协同优化策略在跨任务测试中实现了7%以上的性能增益。</p>
<p>这一成果验证了质量-多样性统一框架在数据筛选中的优越性。</p>
<p>Learning from the Best, Differently: A Diversity-Driven Rethinking on Data Selection</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b3bbeff73a4e0f8dbf142d6d4166ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=CV6UCRHgtryOCro35jyGTg8nAdA%3D" alt="图片" loading="lazy"/></p>
<p>这篇论文对数据筛选的常规方法——"按评分排序并选取前k名（最高分数据）"——提出了质疑。</p>
<p>作者指出，该方法的局限性在于：评分体系往往融合了多个关联维度（如语言质量、知识密度、语义复杂度等），导致高分数据虽然在综合评分上表现优异，却容易在多个维度上呈现高度趋同，造成数据多样性的显著不足。</p>
<p>尤为严重的是，这种单一化的筛选策略甚至可能损害下游任务的表现。</p>
<p>针对这一问题，研究团队创新性地提出了ODiS（正交多样性感知选择框架）。其核心流程包括：</p>
<p>1）对数据进行多维度评估，涵盖语言质量（language quality）、知识/事实质量（knowledge quality）、语义理解难度（comprehension difficulty）等关键指标；</p>
<p>2）通过主成分分析（PCA）实现维度正交化处理，消除各维度间的相关性，确保特征独立性；</p>
<p>3）为每个正交维度训练独立评分模型，将PCA投影得分回归到数据层面，实现大规模语料的快速评分。</p>
<p>在构建训练集时，该方法并非简单选取总体评分最高的数据，而是从每个正交维度分别筛选高分数据（或按比例采样），从而既保证多维覆盖又维持数据多样性（因不同维度的最优数据通常具有差异性）。</p>
<p>实验结果表明，采用ODiS筛选的数据训练的模型，在多个下游任务中均显著优于传统单一评分基准。研究特别发现，当维度间重叠率被控制在2%以下时，模型性能表现更为稳定优异。</p>
<p>该研究的理论价值在于：颠覆了"高分即优质训练数据"的传统认知，系统论证了通过细分质量指标和主动引入多样性来提升模型泛化能力的重要性，而非盲目追求总分最高的数据。</p>
<p><strong>多策略集成驱动（Collaborative / Ensemble Methods）</strong></p>
<p>Efficient Pretraining Data Selection via Multi-Actor Collaboration</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/442a3c20bc3646a0965321aacd9df5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=th9AaVcWWJqTYBORzdv7FgZ8yrk%3D" alt="图片" loading="lazy"/></p>
<p>当前数据选择领域已发展出多种先进方法论（质量导向/影响力导向/多样性感知/领域混合等），如何通过协同整合这些方法以最大化优势并规避潜在矛盾？</p>
<p>研究团队创新性地设计了多智能体协同的数据筛选框架。</p>
<p>将各类数据选择策略视为独立运行的"智能体"：例如，质量过滤智能体(quality filtering)专注数据纯度，多样性智能体(diversity)维护样本分布均衡。</p>
<p>影响力智能体(influence)评估数据对模型的关键作用，领域混合智能体(domain mixing)优化跨领域数据配比。</p>
<p>在预训练过程中，各智能体会基于实时模型状态动态更新其优先级规则（即根据当前模型性能自适应调整数据偏好）。</p>
<p>中央调度器则通过动态分配各智能体权重（决定不同训练阶段的主导策略），实现多维度信号的有效融合。</p>
<p>实验验证表明，相较于单一方法或固定组合策略，该多智能体协同机制不仅能显著提升预训练收敛速度，更在数据利用率上实现突破性改进。</p>
<p>这项工作为数据选择提供了更具适应性的系统化方案：无需局限于特定策略的取舍，而是将多元策略构建为专家协作网络，使系统能够自主选择与模型状态最优匹配的方法组合。</p>
<p><strong>结构化知识/技能驱动（Skill- or Structure-aware Selection）</strong></p>
<p>MASS: Mathematical Data Selection via Skill Graphs</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969d8e08404949589305de22c79a34b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=oGodgvOx%2BOlAZG2NwQPtf7FGICg%3D" alt="图片" loading="lazy"/></p>
<p>MASS 的核心创新在于数学与推理领域预训练数据的筛选机制。</p>
<p>研究团队指出，数学文本蕴含独特的结构特征与技能关联性，传统通用过滤方法难以精准识别这些特性。</p>
<p>为此，MASS 创新性地引入"技能图谱"（skill graph）框架，通过可视化数学能力间的拓扑关系实现数据价值量化评估。</p>
<p>该方法实施分为三个关键步骤：</p>
<p>1）从权威数学资源中提取基础数学技能（如代数、几何、微积分、证明推理等），建立以技能为节点、依赖关系为边的知识图谱；</p>
<p>2）对候选数学文本进行技能成分分析，将其与图谱进行匹配，综合计算覆盖技能的数量、层级权重和关键性指标；</p>
<p>3）依据多维评分体系对数据排序，筛选出对模型数学能力提升最具针对性的数据子集。</p>
<p>实验结果表明，采用MASS筛选数据的模型在数学推理任务中表现全面超越基准模型，尤其在数据规模缩减50%-70%的条件下，仍能实现4%-6%的性能提升。</p>
<p>这一验证充分证明，基于领域知识构建结构化技能图谱并指导数据选择，是优化模型专业能力的有效范式。</p>
<p><strong>任务相关性驱动（Task-aware Data Selection）</strong></p>
<p>Language Models Improve When Pretraining Data Matches Target Tasks</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37605e64ca58451ea2cdd17989d51506~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=tKW7AwvqwlFhUXK%2F%2F5qQ0muM1Vw%3D" alt="图片" loading="lazy"/></p>
<p>该研究聚焦于预训练语言模型的核心问题：当训练数据分布与目标任务高度一致时，模型性能能否实现显著优化。</p>
<p>研究者创新性地提出了一种高效数据筛选框架BETR（Benchmark-Targeted Ranking）</p>
<p>其核心机制包含三个步骤：首先将目标任务样本与预训练数据子集进行向量空间对齐，通过相似度计算建立初始排序；</p>
<p>继而借助轻量分类器将排序策略泛化至全量语料库；最终筛选出与目标任务分布匹配度最高的训练数据。</p>
<p>通过构建数百个实验模型并验证不同数据规模下的scaling law，研究发现BETR筛选的数据可使计算效率提升2倍以上，且模型表现显著优于原始数据或基础过滤方法。</p>
<p>在目标benchmark与下游任务存在分布偏移的场景中，BETR仍能保持与基准数据相当甚至更优的性能。</p>
<p>研究明确证实：预训练数据与任务需求的分布匹配度较数据规模更具决定性影响。采用可扩展的轻量级任务相关性排序方法，能够在维持计算成本的前提下显著提升模型质量。</p>
<p><strong>二、后训练的数据选择</strong></p>
<p><strong>在线和离线数据选择结合</strong></p>
<p>Towards High Data Efficiency in Reinforcement Learning with Verifiable Reward</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/771460e406224dfaa535fdb096ad1ef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=LpLDTWJIQhwE8Ef%2BAhn7KlK2n78%3D" alt="图片" loading="lazy"/></p>
<p><strong>‌动机‌</strong></p>
<p>当前RLVR方法依赖增加训练数据规模与rollout数量来增强模型推理能力，但这一方式显著提升了训练成本（计算资源消耗、时间投入）并降低了数据利用效率。</p>
<p>‌离线数据选择‌的局限性体现在：传统方法需在全量数据集上训练以评估数据选择指标（如奖励趋势分析、梯度对齐），计算负担沉重；或仅关注单一维度（如样本难度过滤），忽视样本间的关联性。</p>
<p>‌在线rollout效率问题‌：现有方法（以GRESO为例）仅能对零方差样本进行粗略筛选，无法有效识别具有高探索潜力的样本，导致大量计算资源被低贡献样本占用。</p>
<p><strong>‌方法‌</strong></p>
<p><strong>‌多维度离线数据筛选框架‌</strong></p>
<p>1.1 采用LLM最终层token嵌入构建样本表征空间，基于余弦相似度建立相似度图网络。</p>
<p>1.2 通过PageRank权重与行列式点过程协同优化，实现子集多样性与影响力的联合最大化。</p>
<p>1.3 对初步筛选后的子集执行策略离线rollout，以样本准确率量化难度指标，并按正态分布优先选取中等难度样本。</p>
<p><strong>‌基于熵的在线rollout优化机制‌</strong></p>
<p>2.1 设计滑动窗口内历史熵与优势函数的动态加权指标，精准识别高探索潜力样本进行在线rollout。</p>
<p>2.2 实施动态样本重放策略，确保训练覆盖所有样本的充分学习。</p>
<p><strong>‌实验验证‌</strong></p>
<p>该方法仅需20%数据即可达到全量训练性能，同时实现训练耗时降低40%、rollout数量减少60%的优化效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ccec261439942269fda3a9fb5e03dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=rLxwhr5NnMVXiaD51nfyH1Oz1OQ%3D" alt="图片" loading="lazy"/></p>
<p>本文在三个模型和五个推理数据集上都进行了详细的实验，实验结果表明 DEPO 在各个数据集上都展现出强大的性能和效率优势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38cf6f8dd5d0485d9f1fe9915fdd30cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=FUQEzJitAgyWT8AP5m9%2BVXVzwfQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>在线数据选择</strong></p>
<p>Act Only When It Pays: Efficient Reinforcement Learning for LLM Reasoning via Selective Rollouts</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b43327d7e226433ebc50ebfd7ed1554b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=YLL47yKGQdvZokosQQh1LIxmylw%3D" alt="图片" loading="lazy"/></p>
<p>论文分析了提示在不同训练epoch中的奖励动态，发现零方差提示（即所有响应的奖励都相同的提示）在训练过程中具有很强的时间一致性。</p>
<p>自适应调整探索概率：采用了一种自适应机制来自动调整探索概率，根据目标零方差比例和实际观察到的零方差比例动态调整探索概率。</p>
<p>自适应采样批次大小：如果当前批次中有效提示的数量不足，算法会根据需要动态调整采样批次大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856319c7d68d4dd1a640ec2fd06cb7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=RSxm9lAghAbIKtLGNkNwjeD17lI%3D" alt="图片" loading="lazy"/></p>
<p><strong>离线数据选择</strong></p>
<p>LearnAlign: Reasoning Data Selection for Reinforcement Learning in Large Language Models Based on Improved Gradient Alignment</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a97f74c1a7a4ce684ebb9495d1923ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=xcJMr8AeGO64GeSgZSfXBUX8w%2Fw%3D" alt="图片" loading="lazy"/></p>
<p>‌梯度对齐‌：研究通过一阶泰勒展开近似模型参数更新对损失函数的作用，将数据点间的影响力量化为两者梯度的内积值。</p>
<p>‌可学性‌：采用成功概率作为评估指标，表征数据点对模型性能优化的潜在贡献度。</p>
<p>‌LearnAlign分数‌：综合数据可学性与梯度对齐结果，生成该分数以量化数据点间的相似性及学习价值。</p>
<p><strong>‌数据筛选流程‌</strong></p>
<p>‌预热训练‌：随机抽取训练数据的小规模子集进行初始训练，为梯度估计提供稳定基础。</p>
<p>‌梯度信息处理‌：在预热阶段计算各数据点梯度，并通过随机投影实现降维。</p>
<p>‌分数矩阵构建‌：基于降维梯度数据，计算所有数据点对的LearnAlign分数，形成完整矩阵。</p>
<p>‌最终筛选‌：依据矩阵均值排序，选取得分最高的前N个数据点作为最优子集。</p>
<p>Reinforcement Learning for Reasoning in Large Language Models with One Training Example</p>
<p>论文提出了“1-shot RLVR”的概念，旨在探究仅使用一个训练样本是否能够实现与使用大规模数据集相当的性能提升。</p>
<p>通过分析训练样本的历史方差得分，选择具有最高方差的样本作为训练数据。这种方法基于假设高方差样本在训练过程中可能提供更丰富的信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9795239bddf74e709670bb169d0848b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=g9YiJRwxXKU3Z9YEw0boP8tKG80%3D" alt="图片" loading="lazy"/></p>
<p>LIMR: Less is More for RL Scaling</p>
<p>以模型平均奖励曲线为基准，衡量单个样本学习轨迹与整体学习轨迹的匹配度。</p>
<p>通过归一化对齐分数评估样本对模型学习的贡献值，分数越高表明样本与模型学习路径的一致性越强，其对模型优化的促进作用也越显著。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8170c65a789c421b8f27c66e299d842e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=iPghKIwEdsUL%2BSJs334GpfI0J3o%3D" alt="图片" loading="lazy"/></p>
<p>Data-Efficient RLVR via Off-Policy Influence Guidance</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1216d58140fb47e491c23af134717135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=zsWsQftE0bhZWdPBLqgvSTjwO%2BI%3D" alt="图片" loading="lazy"/></p>
<p><strong>理论扩展与方法创新‌</strong></p>
<p>将监督学习的影响函数理论推广至RLVR领域，建立训练样本对策略性能影响的一阶近似量化模型。</p>
<p>通过离策略估计技术，利用行为策略生成的离线轨迹替代实时策略梯度计算，实现完全离线化的高效训练流程。</p>
<p><strong>‌计算优化技术‌</strong></p>
<p>采用稀疏随机投影方法，在梯度运算前通过随机维度丢弃与低维变换，显著减少存储需求与计算复杂度，同时实验表明该方法能有效保持向量内积的排序特性。</p>
<p><strong>‌框架设计与应用‌</strong></p>
<p>基于上述理论构建多阶段课程学习系统CROPI，框架通过动态筛选验证集影响力最大的数据子集，分阶段实施GRPO算法更新策略，实现高效渐进式学习。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34bc180b4bb4e8d9bf1212b95461197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=j%2Bhvq41q0e%2F2YrzWBTAiLAzuDmI%3D" alt="图片" loading="lazy"/></p>
<p>‌第一阶段‌：采用9k道均衡难度题目，每道题执行8次rollout训练，总序列长度24k，有效避免模型陷入模式固化；</p>
<p>‌第二阶段‌：筛选极端困难样本，通过64次rollout的阶梯式训练（分三阶段逐步强化），不断推动模型突破性能极限。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[离开舒适区100天，我后悔了吗？]]></title>    <link>https://juejin.cn/post/7582021506190327854</link>    <guid>https://juejin.cn/post/7582021506190327854</guid>    <pubDate>2025-12-10T13:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582021506190327854" data-draft-id="7581995152190963754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="离开舒适区100天，我后悔了吗？"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T13:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优弧"/> <meta itemprop="url" content="https://juejin.cn/user/852876722177533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            离开舒适区100天，我后悔了吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/852876722177533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优弧
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:16:40.000Z" title="Wed Dec 10 2025 13:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>各位朋友好，我是优弧。今天想用一种轻松的方式，记录一个小小的里程碑：<strong>我来到新部门，已经满100天了。</strong></p>
<p>如果把职场比作一段旅程，这100天像是从一条熟悉的主路，转入了一条全新的小径。风景不同，路况也迥异。过去，我更多是在既定方向里把事情做深做透；如今，则像是在一片新的地基上，一砖一瓦地搭建起"规则、方法与节奏"。</p>
<p>我现在所在的团队，从事的是<strong>数据标注与评测</strong>相关工作。很多人一听"标注"，第一反应是"是不是就是打标签？"——我最初也是这么想的。但真正深入之后才发现：它更像是把人类的判断，转化为一套清晰、一致、可复用的"语言"。这些语言会凝结成数据，数据会塑造模型，模型再反过来影响产品体验。它不张扬，却至关重要。</p>
<hr/>
<h2 data-id="heading-0"><strong>这100天，我主要做了三件事</strong></h2>
<p><strong>第一件：把模糊变清晰。</strong></p>
<p>新方向里，最常见的困难不是"做不出来"，而是"大家以为理解一致，其实各有各的理解"。所以我花了大量时间做"对齐"——把需求写清楚，把边界讲明白，把容易产生歧义的地方用具体案例固定下来。</p>
<p>这件事看似不起眼，却能让后来的人少走许多弯路。</p>
<p><strong>第二件：把事情做得更稳。</strong></p>
<p>在这里，"做完"不是终点，"能稳定交付"才是。</p>
<p>我参与梳理流程、完善检查机制，也会和一线同事一起复盘：哪里最容易出错？是规则没讲清楚，还是样例不够充分，还是工具设计让人产生误解？</p>
<p>我们在努力把"靠经验"变成"靠机制"，把"凭感觉"变成"有共识"。</p>
<p><strong>第三件：把经验沉淀下来。</strong></p>
<p>我越来越相信一个朴素的道理：<strong>团队的效率，很大程度上取决于能否把经验写下来、传下去、复用起来。</strong></p>
<p>所以这段时间，我持续在做文档化、样例库整理、常见问题汇总，让新人上手更快，老同事协作更顺。</p>
<hr/>
<h2 data-id="heading-1"><strong>这100天，我最大的收获</strong></h2>
<p>说实话，新方向并不轻松。它不像冲刺型项目那样"立竿见影"，更多是"润物无声"。但也正因如此，它让我学会了另一种能力：<strong>耐心地把一件事做成体系。</strong></p>
<p>我也更深刻地体会到——所谓成长，不一定是站到更高的位置，有时候是换一个角度看世界：从追求结果，到构建方法；从解决一个问题，到消除一类问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>几点真实的小感悟</strong></h2>
<ul>
<li>很多分歧不是谁对谁错，只是大家站在不同位置，看同一件事。</li>
<li>把规则写清楚，比想象中更难；写清楚之后，比想象中更有价值。</li>
<li>让事情"稳定"，往往比让事情"快速"更考验功力。</li>
</ul>
<hr/>
<h2 data-id="heading-3"><strong>写在最后</strong></h2>
<p>100天当然不算长，但足以让我确认：我已经在一个新的方向上重新出发了。离开不是告别，更像是把自己推入一个更陌生的场景，再学一次"如何把事情做好"。</p>
<p>最后，用一句我很喜欢的话收尾（我一直拿它提醒自己）：</p>
<blockquote>
<p>"这个世界上没有什么生活方式是完全正确的，神山圣湖并不是终点。接受平凡的自我，但不放弃理想和信仰，热爱生活。我们都在路上，也许路的尽头是什么，从来都不重要。"</p>
</blockquote>
<p>感谢这一路遇到的每一个人。也希望下一个100天，我能继续保持好奇、保持笃定，把这条路走得更深、更稳。</p>
<hr/>
<h2 data-id="heading-4"><strong>顺便打个小广告</strong></h2>
<p>既然聊到了数据标注，也借这个机会说一声：<strong>我们的标注平台即将上线，现在开始招募标注员啦！</strong></p>
<p>如果你是计算机相关专业背景，对代码有热情，想用专业能力做点有价值的事（顺便赚点外快），欢迎了解一下：</p>
<p><strong>我们在找这样的你：</strong></p>
<ul>
<li><strong>研发工程师</strong>，能独立理解并修改开源或企业级代码，熟悉单测与验证流程</li>
<li><strong>3年以上开发经验</strong>，熟悉 Git、单元测试、模块化架构，能阅读、理解、调试中大型项目</li>
<li>掌握主流开发语言（Python / Java / JS / TS / Rust / C / C++）</li>
<li>具备问题抽象、代码重构与性能优化经验，能从开发者视角构造高质量问题与解决方案</li>
</ul>
<p><strong>工作方式：</strong></p>
<ul>
<li>线上灵活办公，时间自由安排</li>
<li>每周投入 <strong>20小时以上</strong> 即可</li>
</ul>
<p><strong>薪酬待遇：</strong></p>
<ul>
<li>时薪 <strong>50～100元</strong>，具体以项目最终定价为准</li>
</ul>
<p>当然，如果你是<strong>本科及以上学历、有计算机相关背景</strong>的同学，也非常欢迎报名——我们同样期待新鲜血液的加入！</p>
<p>感兴趣的朋友可以私信我，或者留言咨询。期待与你在标注的世界里相遇。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b97428020c7546358f63495bf510c9ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY5byn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765977400&amp;x-signature=mGucn44Ekj10SZR2l2FMUbCu4ss%3D" alt="1_1067699600_171_85_3_1067549210_6ec3197faa53f1febc00f936e9787654.png" width="30%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(4)---KV Cache]]></title>    <link>https://juejin.cn/post/7582039917216989184</link>    <guid>https://juejin.cn/post/7582039917216989184</guid>    <pubDate>2025-12-10T13:27:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917216989184" data-draft-id="7581117416811708459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(4)---KV Cache"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-10T13:27:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(4)---KV Cache
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:27:58.000Z" title="Wed Dec 10 2025 13:27:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(4)---KV Cache</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 原理</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 技术路径</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 对比</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 协同工作</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 定义</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 KV Cache的记忆结构</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 API总结 (KVCacheMemory)</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 KVCacheMemory代码</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.4 流程</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 重要组件</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 KVCacheItem</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 build_kv_cache</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x04 示例</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.1 何时使用：</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.2 关键点：</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概要</h3>
<p>在MemOS中，KV Cache最适合存储<strong>语义稳定且经常复用的背景信息</strong>，例如：</p>
<ul>
<li>常见问题（FAQs）或特定领域知识</li>
<li>先前的对话历史</li>
</ul>
<p>这些稳定的<strong>明文记忆项</strong>由<code>MemScheduler</code>模块自动识别和管理。一旦被选中，它们就会被提前转换成KV格式的表示(<code>KVCacheItem</code>)。这个预计算步骤以可复用的格式存储记忆的激活状态（键值对张量），允许它们在推理期间注入到模型的注意力缓存中</p>
<p>一旦进行转换，这些KV记忆就可以<strong>跨查询复用</strong>，而不需要对原始内容重新编码。这减少了处理和存储大量文本的计算开销，使其成为需要<strong>快速响应时间</strong>和<strong>高吞吐量</strong>的应用程序的理想选择。</p>
<h3 data-id="heading-2">0x01 原理</h3>
<p>KVCacheMemory 是MemOS中用于存储和管理KV cache的专用记忆模块，主要用于加速大语言模型（LLMs）推理并支持有效的上下文复用。<strong>KVCacheMemory</strong> 将最近或稳定的上下文作为激活缓存保存，有助于对于会话式和生成式人工智能系统。</p>
<h4 data-id="heading-3">1.1 技术路径</h4>
<p>若要替大模型补上记忆的缺口，如今的产业界大致踩出两条技术路径，各有利弊，也决定了产品落地的不同走向。</p>
<ul>
<li>第一条路是“外挂式”的文本记忆。做法直截了当：先把对话里的关键信息提炼成可读的文字，再写进向量库或图数据库；待模型需要时，按语义相似度把它们重新召回即可。这相当于给模型配一本随身的智能记事本，写进去的是什么，以后读出来的也是什么，人类一眼就能核对、删改或增补。</li>
<li>第二条路是“内置式”的张量记忆。在模型内部新增数十亿参数，充当隐式的“记忆池”，一切信息都被压缩成高维张量存于其中。此法的好处是召回路径短，与推理过程融为一体；代价则是不可读、不可改，一旦写错，只能重新训练，无法像删改文档那样随手修正。</li>
</ul>
<p>KVCacheMemory 看起来是介于两者之间的一条路。</p>
<p>KVCacheMemory 对应了激活记忆，即运行时的 KV 缓存和隐藏状态（高效率）。MemOS 使用 KVCacheMemory （最近或稳定的上下文）来加速多轮对话，高效的运行时状态缓存。适合对话中的快速重用、多轮会话。</p>
<h4 data-id="heading-4">1.2 对比</h4>
<p>我们比对下是否带 KV Cache 的区别：</p>
<ul>
<li>
<p>无KV Cache记忆</p>
<ul>
<li>每个新查询都被添加到完整的提示模板中，包括背景知识。</li>
<li>模型必须在整个序列上<strong>重新计算token嵌入和注意力</strong>——即使是未更改的记忆。</li>
</ul>
</li>
<li>
<p>有KV Cache记忆</p>
<ul>
<li>背景知识以键值对张量的形式<strong>缓存一次</strong>。</li>
<li>对于每个查询，只对新用户输入（查询token）进行编码。</li>
<li>之前缓存的KV被直接注入到注意力机制中。</li>
</ul>
</li>
</ul>
<p>这种分离减少了预填充阶段的冗余计算，从而导致:</p>
<ul>
<li>跳过背景知识的重复编码</li>
<li>更快的查询token和缓存记忆之间的注意力计算</li>
<li><strong>降低首次token时间(Time To First Token, TTFT)</strong> 生成过程中的延迟</li>
</ul>
<p>这种优化在以下方面特别有价值:</p>
<ul>
<li>多回合聊天机器人交互</li>
<li>检索增强生成或上下文增强生成(RAG, CAG)</li>
<li>在固定文档或FAQ风格记忆上操作的助理</li>
</ul>
<p>我们再比对下 TreeTextMemory 和 KVCacheMemory ：</p>
<ul>
<li>TreeTextMemory 将你的长时记忆存储在图数据库（Neo4j）中。</li>
<li>KVCacheMemory 将最近或稳定的上下文作为激活缓存保存。</li>
<li>二者在一个 MemCube 中协同工作，由你的 <code>MOS</code> Pipeline 统一管理。</li>
</ul>
<h4 data-id="heading-5">1.3 协同工作</h4>
<p>MemOS 将记忆视为一个生态系统——不仅仅是静态数据，而是演进的知识。以下是三种核心记忆类型如何协同工作：</p>

























<table><thead><tr><th>记忆类型</th><th>描述</th><th>何时使用</th></tr></thead><tbody><tr><td><strong>参数记忆</strong></td><td>知识提炼到模型权重中</td><td>常青技能、稳定领域专业知识</td></tr><tr><td><strong>激活记忆</strong></td><td>短期 KV cache 和隐藏状态</td><td>对话中的快速重用、多轮会话</td></tr><tr><td><strong>明文记忆</strong></td><td>文本、文档、图节点或向量块</td><td>可搜索、可检查、演进知识</td></tr></tbody></table>
<p>MemOS 让用户在生命周期循环中调度所有三种记忆类型：</p>
<ul>
<li>高频的明文记忆可以提炼为参数化权重。</li>
<li>高频激活路径成为可重用的 KV 模板。</li>
<li>陈旧的参数化或激活单元可以降级为明文记忆以进行追溯。</li>
</ul>
<p>使用 MemOS，用户的 AI 不仅仅是存储事实——它<strong><strong>记忆</strong></strong>、<strong><strong>理解</strong></strong>和<strong><strong>成长</strong></strong>。</p>
<p><strong>深入理解</strong></p>
<ul>
<li>随着时间的推移，频繁使用的明文记忆可以提炼为参数化形式。</li>
<li>很少使用的权重或缓存可以降级为纯文本存储以进行审计和重新训练。</li>
</ul>
<h3 data-id="heading-6">0x02 定义</h3>
<h4 data-id="heading-7">2.1 KV Cache的记忆结构</h4>
<p>通过<code>KVCacheMemory</code>实现基于KV的记忆复用，在保持相同输出的同时，大大减少了模型大小和查询类型之间的延迟。通过将可复用记忆从明文提示转移到预先计算的KV Cache，MemOS消除了冗余的上下文编码，并实现了更快的响应时间，特别是在实时的、记忆增强的LLM应用程序中。</p>
<p>每个缓存被存储为一个<code>KVCacheItem</code>:</p>

























<table><thead><tr><th>字段</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>kv_cache_id</code></td><td><code>str</code></td><td>缓存中的唯一ID(UUID)</td></tr><tr><td><code>kv_cache</code></td><td><code>DynamicCache</code></td><td>实际的KV Cache(transformers)</td></tr><tr><td><code>metadata</code></td><td><code>dict</code></td><td>元数据 (源, 抽取时间等.)</td></tr></tbody></table>
<p>总体逻辑如下：</p>
<ul>
<li>KVCacheItem 是数据载体，KVCacheMemory 是管理多个KVCacheItem 的内存系统，对外提供操作接口。</li>
<li>KVCacheMemory 是管理多个 KVCacheItem 的内存系统（使用kv_cache_memories这个字典结构来保存），提供了CRUD操作，负责 KVCacheItem 的创建、存储、检索、合并和持久化。</li>
<li>KVCacheItem 是单个激活记忆的数据结构。继承自基础激活内存项，专门存储 LLM 的动态 KV 缓存，支持自定义元数据和关联文本记录。KVCacheItem 包含多个KVCacheRecords，KVCacheRecords存储与缓存相关的文本记忆信息。</li>
</ul>
<h4 data-id="heading-8">2.2 API总结 (KVCacheMemory)</h4>
<p>KVCacheMemory 提供了CRUD操作，用户可以直接使用。</p>
<p>初始化代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">KVCacheMemory</span>(config: KVCacheMemoryConfig)
</code></pre>
<p>核心方法如下：</p>





















































<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>extract(text)</code></td><td>使用LLM从输入文本中提取KV Cache</td></tr><tr><td><code>add(memories)</code></td><td>添加一个或多个<code>KVCacheItem</code>到记忆中</td></tr><tr><td><code>get(memory_id)</code></td><td>根据ID获取单个缓存</td></tr><tr><td><code>get_by_ids(ids)</code></td><td>根据IDs获取多个缓存</td></tr><tr><td><code>get_all()</code></td><td>返回所有存储的缓存</td></tr><tr><td><code>get_cache(cache_ids)</code></td><td>从多个IDs合并并返回组合缓存</td></tr><tr><td><code>delete(ids)</code></td><td>通过IDs删除缓存</td></tr><tr><td><code>delete_all()</code></td><td>删除所有缓存</td></tr><tr><td><code>dump(dir)</code></td><td>将所有缓存序列化到目录中的pickle文件</td></tr><tr><td><code>load(dir)</code></td><td>从目录中的pickle文件加载缓存</td></tr><tr><td><code>from_textual_memory(mem)</code></td><td>将<code>TextualMemoryItem</code> 转换为 <code>KVCacheItem</code></td></tr></tbody></table>
<p>当调用<code>dump(dir)</code>, 系统写到:</p>
<pre><code class="hljs">/
</code></pre>
<p>该文件包含所有KV Cache的pickle字典，可以使用<code>load(dir)</code>重新加载。</p>
<h4 data-id="heading-9">2.3 KVCacheMemory代码</h4>
<p>KVCacheMemory：</p>
<ul>
<li>该类是基于键值缓存的激活内存存储机制，用于管理 LLM 的键值缓存（KV Cache）</li>
<li>提供了完整的键值缓存提取、添加、查询、合并、删除等功能</li>
<li>支持将文本内容转换为 KV 缓存格式，也支持与文本内存项的相互转换</li>
<li>特色是针对不同版本的 transformers 库进行了兼容处理，实现了高效的多层缓存合并操作，通过批量拼接张量提升性能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f5e3319eb04d6c8aab313bfb499189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=zsYh%2FwW%2FnpTvEiK2dd%2Bd5lagvL4%3D" alt="memos-kv-1" loading="lazy"/></p>
<p>memos-kv-1</p>
<p>具体代码如下。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">KVCacheMemory</span>(BaseActMemory):
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
    用于激活内存的键值缓存存储器。
    这种内存类型设计用于存储和检索键值缓存。
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;

    @<span class="hljs-selector-tag">require_python_package</span>(
        import_name=&amp;#<span class="hljs-number">34</span>;torch&amp;#<span class="hljs-number">34</span>;,
        install_link=&amp;#<span class="hljs-number">34</span>;<span class="hljs-attribute">https</span>:<span class="hljs-comment">//pytorch.org/get-started/locally/&amp;#34;,</span>
    )
    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">__init__</span>(self, <span class="hljs-attribute">config</span>: KVCacheMemoryConfig) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;使用配置初始化<span class="hljs-selector-tag">KV</span>缓存存储器。<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.config</span> = <span class="hljs-selector-tag">config</span>  # 存储配置信息
        # 根据配置创建<span class="hljs-selector-tag">LLM</span>实例，用于提取<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span> = <span class="hljs-selector-tag">LLMFactory</span><span class="hljs-selector-class">.from_config</span>(config.extractor_llm)
        # 存储<span class="hljs-selector-tag">KV</span>缓存项的字典，以<span class="hljs-selector-tag">ID</span>为键
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span>: <span class="hljs-selector-tag">dict</span><span class="hljs-selector-attr">[str, KVCacheItem]</span> = {}

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">extract</span>(self, <span class="hljs-attribute">text</span>: str) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;基于文本提取内存。

        使用<span class="hljs-selector-tag">LLM</span>从提供的文本中构建<span class="hljs-selector-tag">KV</span>缓存。

        参数:
            <span class="hljs-selector-tag">text</span>: 用于提取内存的输入文本

        返回:
            提取的内存项
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        # 使用<span class="hljs-selector-tag">LLM</span>从文本构建<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">kv_cache</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span><span class="hljs-selector-class">.build_kv_cache</span>(text)

        # 创建包含提取的缓存的<span class="hljs-selector-tag">KV</span>缓存项
        <span class="hljs-selector-tag">cache_item</span> = <span class="hljs-selector-tag">KVCacheItem</span>(
            memory=kv_cache,
            metadata={<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">source_text</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">text</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">extracted_at</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">datetime</span><span class="hljs-selector-class">.now</span>()<span class="hljs-selector-class">.isoformat</span>()},
        )

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">cache_item</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">add</span>(self, <span class="hljs-attribute">memories</span>: list[KVCacheItem]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;将内存添加到<span class="hljs-selector-tag">KV</span>缓存存储器中。

        参数:
            <span class="hljs-selector-tag">memories</span>: 要添加的<span class="hljs-selector-tag">KV</span>缓存项列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memories</span>:
            <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-attr">[memory.id]</span> = <span class="hljs-selector-tag">memory</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_cache</span>(self, <span class="hljs-attribute">cache_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">DynamicCache</span> | <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;将多个<span class="hljs-selector-tag">KV</span>缓存合并为一个缓存。

        参数:
            <span class="hljs-selector-tag">cache_ids</span>: 要合并的缓存<span class="hljs-selector-tag">ID</span>列表

        返回:
            合并后的<span class="hljs-selector-tag">DynamicCache</span>，如果未找到缓存则返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">caches_to_merge</span> = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">cache_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">cache_ids</span>:
            <span class="hljs-selector-tag">cache_item</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.get</span>(cache_id)
            <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">cache_item</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">cache_item</span><span class="hljs-selector-class">.memory</span>:
                <span class="hljs-selector-tag">caches_to_merge</span><span class="hljs-selector-class">.append</span>(cache_item.memory)

        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">caches_to_merge</span>:
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">None</span>

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">._concat_caches</span>(caches_to_merge)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get</span>(self, <span class="hljs-attribute">memory_id</span>: str) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span> | <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>获取内存。

        参数:
            <span class="hljs-selector-tag">memory_id</span>: 要检索的内存<span class="hljs-selector-tag">ID</span>

        返回:
            内存字典，如果未找到则返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.get</span>(memory_id)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_by_ids</span>(self, <span class="hljs-attribute">memory_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">list</span><span class="hljs-selector-attr">[KVCacheItem | None]</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>列表获取多个内存。

        参数:
            <span class="hljs-selector-tag">memory_ids</span>: 要检索的内存<span class="hljs-selector-tag">ID</span>列表

        返回:
            内存字典列表，对于不存在的<span class="hljs-selector-tag">ID</span>返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">results</span> = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memory_ids</span>:
            <span class="hljs-selector-tag">memory</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.get</span>(memory_id)
            <span class="hljs-selector-tag">results</span><span class="hljs-selector-class">.append</span>(memory)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">results</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_all</span>(self) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">list</span><span class="hljs-selector-attr">[KVCacheItem]</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取所有内存。

        返回:
            存储器中所有<span class="hljs-selector-tag">KV</span>缓存项的列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">list</span>(self.kv_cache_memories.<span class="hljs-built_in">values</span>())

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">delete</span>(self, <span class="hljs-attribute">memory_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>删除内存。

        参数:
            <span class="hljs-selector-tag">memory_ids</span>: 要删除的内存<span class="hljs-selector-tag">ID</span>列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memory_ids</span>:
            <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.pop</span>(memory_id, None)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">delete_all</span>(self) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;删除所有内存。<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.clear</span>()

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">from_textual_memory</span>(self, <span class="hljs-attribute">mem</span>: TextualMemoryItem) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        将<span class="hljs-selector-tag">TextualMemoryItem</span>转换为<span class="hljs-selector-tag">KVCacheItem</span>。
        此方法从文本内存中提取键值缓存。
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        # 从文本内存内容构建<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">kv_cache</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span><span class="hljs-selector-class">.build_kv_cache</span>(mem.memory)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">KVCacheItem</span>(memory=kv_cache, metadata=mem.metadata.<span class="hljs-built_in">model_dump</span>())

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">_concat_caches</span>(self, <span class="hljs-attribute">caches</span>: list[DynamicCache]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">DynamicCache</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        更快的拼接合并：对于每个层，收集所有缓存的张量
        并每层执行一次<span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>操作。
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">torch</span>

        <span class="hljs-selector-tag">assert</span> <span class="hljs-selector-tag">caches</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;至少需要一个缓存<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">len</span>(caches) == <span class="hljs-number">1</span>:
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">caches</span><span class="hljs-selector-attr">[0]</span>

        <span class="hljs-selector-tag">merged</span> = <span class="hljs-selector-tag">DynamicCache</span>()
        <span class="hljs-selector-tag">num_layers</span> = <span class="hljs-selector-tag">len</span>(caches[<span class="hljs-number">0</span>].key_cache)

        # 处理<span class="hljs-selector-tag">transformers</span> <span class="hljs-number">4.54</span><span class="hljs-selector-class">.0</span>及以上版本的缓存结构
        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">Version</span>(<span class="hljs-built_in">version</span>(&amp;#<span class="hljs-number">34</span>;transformers&amp;#<span class="hljs-number">34</span>;)) &gt;= <span class="hljs-selector-tag">Version</span>(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">4.54</span>.<span class="hljs-number">0</span>&amp;#<span class="hljs-number">34</span>;):
            <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.append_new_layers</span>(num_layers - <span class="hljs-number">1</span>)
            <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">layer</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">range</span>(num_layers):
                # 收集当前层的所有<span class="hljs-selector-tag">K</span>和<span class="hljs-selector-tag">V</span>
                <span class="hljs-selector-tag">keys</span> = <span class="hljs-selector-attr">[c.layers[layer]</span><span class="hljs-selector-class">.keys</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                <span class="hljs-selector-tag">vals</span> = <span class="hljs-selector-attr">[c.layers[layer]</span><span class="hljs-selector-class">.values</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                # 每层执行一次拼接
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.layers</span><span class="hljs-selector-attr">[layer]</span><span class="hljs-selector-class">.keys</span> = <span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>(keys, dim=-<span class="hljs-number">2</span>)
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.layers</span><span class="hljs-selector-attr">[layer]</span><span class="hljs-selector-class">.values</span> = <span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>(vals, dim=-<span class="hljs-number">2</span>)

        # 处理旧版本<span class="hljs-selector-tag">transformers</span>的缓存结构
        <span class="hljs-selector-tag">else</span>:
            <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">layer</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">range</span>(num_layers):
                # 收集当前层的所有<span class="hljs-selector-tag">K</span>和<span class="hljs-selector-tag">V</span>
                <span class="hljs-selector-tag">keys</span> = <span class="hljs-selector-attr">[c.key_cache[layer]</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                <span class="hljs-selector-tag">vals</span> = <span class="hljs-selector-attr">[c.value_cache[layer]</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                # 每层执行一次拼接
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.key_cache</span><span class="hljs-selector-class">.append</span>(torch.<span class="hljs-built_in">cat</span>(keys, dim=-<span class="hljs-number">2</span>))
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.value_cache</span><span class="hljs-selector-class">.append</span>(torch.<span class="hljs-built_in">cat</span>(vals, dim=-<span class="hljs-number">2</span>))

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">merged</span>
</code></pre>
<h4 data-id="heading-10">2.4 流程</h4>
<p>几个重要的流程图总结如下：</p>
<h5 data-id="heading-11">2.4.1 初始化流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78458bd760bf44b9964728899e51f8d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=E5s74L6kysYEs3n%2FAW15%2BuivNII%3D" alt="memos-kv-2" loading="lazy"/></p>
<p>memos-kv-2</p>
<h5 data-id="heading-12">2.4.2 提取与添加流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd3a737a9e5a4ff6a6a5802fd66a5ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=mxvHCMSvbNm0aW7tNj37%2FslaRmg%3D" alt="memos-kv-3" loading="lazy"/></p>
<p>memos-kv-3</p>
<h5 data-id="heading-13">2.4.3 缓存合并流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fea80e2833b4cc7ba01ac8897d67a3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=poVfMQ5opVMxVhhwulYjR4w3jSo%3D" alt="memos-kv-4" loading="lazy"/></p>
<p>memos-kv-4</p>
<h3 data-id="heading-14">0x03 重要组件</h3>
<h4 data-id="heading-15">3.1 KVCacheItem</h4>
<h5 data-id="heading-16">3.1.1 定义</h5>
<ul>
<li>
<p>该代码定义了 MemOS 中激活内存相关的数据模型，用于标准化存储 KV 缓存及关联元数据。</p>
</li>
<li>
<p>核心是<code>KVCacheItem</code>类，继承自基础激活内存项，专门存储 LLM 的动态 KV 缓存，支持自定义元数据和关联文本记录。</p>
</li>
<li>
<p>衍生类<code>VLLMKVCacheItem</code>适配 vLLM 场景，将缓存存储改为提示字符串（因 vLLM 在服务端预加载 KV 缓存）。</p>
</li>
<li>
<p>特色是使用 Pydantic 模型实现数据结构化，自动生成唯一 ID，支持任意类型字段（适配 DynamicCache），同时通过<code>KVCacheRecords</code>记录文本内存来源和组合信息，保证数据可追溯。</p>
<p>class ActivationMemoryItem(BaseModel):
    """基础激活内存项模型，定义激活内存的核心结构"""
    # 内存项唯一ID，默认使用UUID4自动生成
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    # 内存具体内容，支持任意类型
    memory: Any
    # 内存关联的元数据，默认空字典
    metadata: dict = {}</p>
<p>class KVCacheRecords(BaseModel):
    """KV缓存关联的文本记录模型，用于追溯缓存来源"""
    # 转换为激活内存的文本内存列表
    text_memories: list[str] = Field(
        default=[],
        description="转换为激活内存的文本内存列表",
    )
    # 使用组装模板组合所有文本内存后的单一字符串
    composed_text_memory: str = Field(
        default="",
        description="使用组装模板将所有文本内存组合成的单一字符串",
    )
    # 提交时间（用于调度消息），默认使用UTC当前时间
    timestamp: datetime = Field(
        default_factory=datetime.utcnow, description="调度消息的提交时间"
    )</p>
<p>class KVCacheItem(ActivationMemoryItem):
    """KV缓存内存项模型，专门存储键值缓存数据"""
    # 缓存项唯一ID，默认使用UUID4自动生成（覆盖父类字段）
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    # 存储KV键值对的动态缓存，默认初始化空DynamicCache
    memory: DynamicCache = Field(
        default_factory=DynamicCache,
        description="用于在内存中存储键值对的动态缓存",
    )
    # 与KV缓存项关联的元数据，默认空字典（覆盖父类字段）
    metadata: dict = Field(
        default_factory=dict, description="与KV缓存项关联的元数据"
    )</p>
<p>    # 配置模型以允许任意类型字段（支持DynamicCache作为字段类型）
    model_config = ConfigDict(arbitrary_types_allowed=True)
    # 关联的文本记录，默认初始化空KVCacheRecords
    records: KVCacheRecords = KVCacheRecords()</p>
<p>class VLLMKVCacheItem(KVCacheItem):
    """
    vLLM专用KV缓存项模型，存储提示字符串而非DynamicCache对象。
    原因是vLLM通过预加载在服务端处理KV缓存。
    """</p>
<p>    # 重写memory字段，存储提示字符串而非DynamicCache（适配vLLM）
    memory: str = Field(
        default="",
        description="用于在vLLM服务端预加载KV缓存的提示字符串",
    )</p>
</li>
</ul>
<h5 data-id="heading-17">3.1.2 关联</h5>
<p>KVCacheItem 和 KVCacheMemory 是互相联系的。KVCacheItem 是数据单元/单个记忆单元，KVCacheMemory 是管理系统/激活记忆的存储系统。</p>
<ul>
<li>KVCacheMemory 是管理多个 KVCacheItem 的内存系统，提供了完整的CRUD（创建、存储、检索、合并和持久化）操作。</li>
<li>KVCacheMemory 中有self.kv_cache_memories: dict[str, KVCacheItem] = {}。</li>
<li>KVCacheRecords 是 KVCacheItem 的一部分，为 KVCacheItem 提供了重要的元数据支持，使得系统可以有效管理和跟踪KV Cache 的状态变化。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9557074120a4867885cb17bd995d498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=j3A2feoZvXYsqd8tlrocTErxpfw%3D" alt="memos-kv-5" loading="lazy"/></p>
<p>memos-kv-5</p>
<h4 data-id="heading-18">3.2 build_kv_cache</h4>
<p>KVCacheMemory 会使用LLM把文本构建成KV Cache，或者说是构建成KV 向量。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">self.llm</span> = LLMFactory.from_config(config.extractor_llm)

<span class="hljs-attr">kv_cache</span> = self.llm.build_kv_cache(text)
</code></pre>
<p>HFLLM类是基于 Hugging Face Transformers 的 LLM 封装，支持缓存增强生成（CAG）和采样功能。</p>
<ul>
<li>核心能力是将多种格式的输入（字符串、字符串列表、聊天消息列表）转换为标准 KV 缓存，为后续生成任务提供上下文加速。</li>
<li>内置温度、Top-K、Top-P 等采样策略的日志处理器，支持灵活的生成配置。</li>
<li>特色是自动适配模型和分词器初始化，支持多种输入格式标准化，通过单次前向传播高效构建 KV 缓存。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682ad97f1e8c43e59d48126caf1dff76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=0ylugVAas%2ByZdF1tABOd3gB9XHc%3D" alt="memos-kv-6" loading="lazy"/></p>
<p>memos-kv-6</p>
<p>初始化流程如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3dbe488535b4269801fbb8ee5a715dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=ODQR5vEH2vgns%2FuIPeKWwEPgteY%3D" alt="memos-kv-7" loading="lazy"/></p>
<p>memos-kv-7</p>
<p>build_kv_cache()流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e826990178c642e187773af1ef7695fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=8zbctLkwDuUCuEEpqhu%2F%2Filob6s%3D" alt="memos-kv-8" loading="lazy"/></p>
<p>memos-kv-8</p>
<p>具体代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HFLLM</span>(<span class="hljs-title class_ inherited__">BaseLLM</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
    HFLLM：支持缓存增强生成（CAG）和采样的Transformers LLM类。
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;    </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: HFLLMConfig</span>):
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        初始化HFLLM模型和分词器，并设置用于采样的日志处理器。
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        self.config = config  <span class="hljs-comment"># 存储模型配置信息</span>

        <span class="hljs-comment"># 如果未指定模型，使用默认模型</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.config.model_name_or_path:
            self.config.model_name_or_path = &amp;<span class="hljs-comment">#34;Qwen/Qwen3-1.7B&amp;#34;</span>

        <span class="hljs-comment"># 初始化Hugging Face模型</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            self.config.model_name_or_path, torch_dtype=&amp;<span class="hljs-comment">#34;auto&amp;#34;, device_map=&amp;#34;auto&amp;#34;</span>
        )
        <span class="hljs-comment"># 初始化分词器，启用快速分词模式</span>
        self.tokenizer = AutoTokenizer.from_pretrained(
            self.config.model_name_or_path, use_fast=<span class="hljs-literal">True</span>
        )

        <span class="hljs-comment"># 初始化用于采样的日志处理器列表</span>
        processors = []
        <span class="hljs-comment"># 温度调节：控制生成的随机性，非1.0时添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(self.config, &amp;<span class="hljs-comment">#34;temperature&amp;#34;, 1.0) != 1.0:</span>
            processors.append(TemperatureLogitsWarper(self.config.temperature))
        <span class="hljs-comment"># Top-K采样：限制仅从概率最高的K个token中选择，K&gt;0时添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(self.config, &amp;<span class="hljs-comment">#34;top_k&amp;#34;, 0) &gt; 0:</span>
            processors.append(TopKLogitsWarper(self.config.top_k))
        <span class="hljs-comment"># Top-P采样：限制仅从累积概率达P的token子集选择，0&lt;p&gt; DynamicCache:</span>
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        通过单次前向传播从聊天消息构建KV缓存。
        支持以下输入类型：
            - <span class="hljs-built_in">str</span>：用作系统提示词。
            - <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]：拼接后用作系统提示词。
            - <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]：直接用作聊天消息（需包含&amp;<span class="hljs-comment">#34;role&amp;#34;和&amp;#34;content&amp;#34;键）。</span>
        消息始终会转换为标准聊天模板格式。
        异常：
            ValueError：如果模板处理后的提示词为空。
        返回：
            DynamicCache：构建完成的KV缓存对象。
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        <span class="hljs-keyword">import</span> torch

        <span class="hljs-comment"># 处理多种输入类型，统一转换为标准聊天消息格式</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(messages, <span class="hljs-built_in">str</span>):
            <span class="hljs-comment"># 字符串输入转为系统提示词格式</span>
            messages = [
                {
                    &amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;system&amp;#34;,</span>
                    &amp;<span class="hljs-comment">#34;content&amp;#34;: f&amp;#34;Below is some information about the user.\n{messages}&amp;#34;,</span>
                }
            ]
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(messages, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">and</span> messages <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(messages[<span class="hljs-number">0</span>], <span class="hljs-built_in">str</span>):
            <span class="hljs-comment"># 字符串列表输入拼接后转为系统提示词</span>
            messages = [
                {
                    &amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;system&amp;#34;,</span>
                    &amp;<span class="hljs-comment">#34;content&amp;#34;: f&amp;#34;Below is some information about the user.\n{' '.join(messages)}&amp;#34;,</span>
                }
            ]
        
        <span class="hljs-comment"># 应用聊天模板生成完整提示词（不添加生成提示，不分词）</span>
        prompt = self.tokenizer.apply_chat_template(
            messages, tokenize=<span class="hljs-literal">False</span>, add_generation_prompt=<span class="hljs-literal">False</span>
        )
        <span class="hljs-comment"># 对提示词进行分词，转换为模型输入格式</span>
        inputs = self.tokenizer(prompt, return_tensors=&amp;<span class="hljs-comment">#34;pt&amp;#34;)</span>
        <span class="hljs-comment"># 将输入ID移至模型所在设备，转换为长整型</span>
        inputs[&amp;<span class="hljs-comment">#34;input_ids&amp;#34;] = inputs[&amp;#34;input_ids&amp;#34;].to(self.model.device, dtype=torch.long)</span>
        <span class="hljs-comment"># 获取序列长度</span>
        seq_len = inputs[&amp;<span class="hljs-comment">#34;input_ids&amp;#34;].size(-1)</span>
        
        <span class="hljs-comment"># 检查提示词是否为空</span>
        <span class="hljs-keyword">if</span> seq_len == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(
                &amp;<span class="hljs-comment">#34;聊天模板处理后的提示词为空，无法构建KV缓存。请检查你的消息输入。&amp;#34;</span>
            )
        
        <span class="hljs-comment"># 初始化动态KV缓存</span>
        kv = DynamicCache()
        <span class="hljs-comment"># 关闭梯度计算，执行前向传播构建缓存</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            self.model(**inputs, use_cache=<span class="hljs-literal">True</span>, past_key_values=kv)
        
        <span class="hljs-comment"># 截取有效长度的缓存（去除可能的冗余部分）</span>
        <span class="hljs-keyword">for</span> i, (k, v) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(kv.key_cache, kv.value_cache, strict=<span class="hljs-literal">False</span>)):
            kv.key_cache[i] = k[:, :, :seq_len, :]
            kv.value_cache[i] = v[:, :, :seq_len, :]
        
        <span class="hljs-keyword">return</span> kv
</code></pre>
<h3 data-id="heading-19">0x04 示例</h3>
<h4 data-id="heading-20">4.1 何时使用：</h4>
<ul>
<li>你想要短期工作记忆以加快多轮对话速度。</li>
<li>适合聊天机器人会话加速或提示复用。</li>
<li>最适合缓存隐藏状态 / KV 对。</li>
</ul>
<h4 data-id="heading-21">4.2 关键点：</h4>
<ul>
<li>
<p>用 KVCacheMemory，不含显式明文记忆。</p>
</li>
<li>
<p>演示提取 → 添加 → 合并 → 获取 → 删除。</p>
</li>
<li>
<p>展示如何导出/加载 KV cache。</p>
</li>
</ul>
<p>以下是KV Cache的使用示例。</p>
<pre><code class="hljs language-xml" lang="xml">from memos.configs.memory import MemoryConfigFactory
from memos.memories.factory import MemoryFactory

# 为 KVCacheMemory（HuggingFace 后端）创建配置
config = MemoryConfigFactory(
    backend=<span class="hljs-symbol">&amp;#34;</span>kv_cache<span class="hljs-symbol">&amp;#34;</span>,
    config={
        <span class="hljs-symbol">&amp;#34;</span>extractor_llm<span class="hljs-symbol">&amp;#34;</span>: {
            <span class="hljs-symbol">&amp;#34;</span>backend<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>huggingface<span class="hljs-symbol">&amp;#34;</span>,
            <span class="hljs-symbol">&amp;#34;</span>config<span class="hljs-symbol">&amp;#34;</span>: {
                <span class="hljs-symbol">&amp;#34;</span>model_name_or_path<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>Qwen/Qwen3-0.6B<span class="hljs-symbol">&amp;#34;</span>,
                <span class="hljs-symbol">&amp;#34;</span>max_tokens<span class="hljs-symbol">&amp;#34;</span>: 32,
                <span class="hljs-symbol">&amp;#34;</span>add_generation_prompt<span class="hljs-symbol">&amp;#34;</span>: True,
                <span class="hljs-symbol">&amp;#34;</span>remove_think_prefix<span class="hljs-symbol">&amp;#34;</span>: True,
            },
        },
    },
)

# 实例化 KVCacheMemory
kv_mem = MemoryFactory.from_config(config)

# 提取一个 KVCacheItem（DynamicCache）
prompt = [
    {<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>user<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>What is MemOS?<span class="hljs-symbol">&amp;#34;</span>},
    {<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>assistant<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>MemOS is a memory operating system for LLMs.<span class="hljs-symbol">&amp;#34;</span>},
]
print(<span class="hljs-symbol">&amp;#34;</span>===== Extract KVCacheItem =====<span class="hljs-symbol">&amp;#34;</span>)
cache_item = kv_mem.extract(prompt)
print(cache_item)

# 将缓存添加到内存中
kv_mem.add([cache_item])
print(<span class="hljs-symbol">&amp;#34;</span>All caches:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())

# 通过 ID 获取
retrieved = kv_mem.get(cache_item.id)
print(<span class="hljs-symbol">&amp;#34;</span>Retrieved:<span class="hljs-symbol">&amp;#34;</span>, retrieved)

# 合并缓存（模拟多轮对话）
item2 = kv_mem.extract([{<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>user<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>Tell me a joke.<span class="hljs-symbol">&amp;#34;</span>}])
kv_mem.add([item2])
merged = kv_mem.get_cache([cache_item.id, item2.id])
print(<span class="hljs-symbol">&amp;#34;</span>Merged cache:<span class="hljs-symbol">&amp;#34;</span>, merged)

# 删除其中一个
kv_mem.delete([cache_item.id])
print(<span class="hljs-symbol">&amp;#34;</span>After delete:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())

# 导出和加载缓存
kv_mem.dump(<span class="hljs-symbol">&amp;#34;</span>tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
print(<span class="hljs-symbol">&amp;#34;</span>Dumped to tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
kv_mem.delete_all()
kv_mem.load(<span class="hljs-symbol">&amp;#34;</span>tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
print(<span class="hljs-symbol">&amp;#34;</span>Loaded caches:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())
</code></pre>
<h3 data-id="heading-22">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑]]></title>    <link>https://juejin.cn/post/7581999251368214580</link>    <guid>https://juejin.cn/post/7581999251368214580</guid>    <pubDate>2025-12-10T12:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581999251368214580" data-draft-id="7582016579857956898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T12:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T12:40:34.000Z" title="Wed Dec 10 2025 12:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI应用快速发展的今天，如何保障生产环境的安全成为了企业关注的焦点。传统的开发方式往往只关注功能实现，却忽视了底层框架的供应链安全风险，特别是当你使用的技术栈升级到最新架构时，一些隐藏的安全漏洞可能在不经意间就让你的服务器"裸奔"在互联网上。</p>
<p>这2天Dify用户炸锅了！号称"史上最严重"的React漏洞CVE-2025-55182被曝光，CVSS评分高达10.0满分。这个漏洞源于React Server Components（RSC）和Next.js App Router架构的反序列化缺陷，攻击者无需任何身份验证，只需发送一个精心构造的HTTP请求，就能在服务器上执行任意代码，直接拿下服务器权限。更可怕的是，全球已有大量Dify自托管实例被植入挖矿程序、窃取API密钥、甚至建立持久化后门。好家伙，这不就是现代版的"一键夺舍"吗？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c1a4f593844cb89f62021410fadfeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=I73MxHnI1%2FpfPewU2GWNZI7iekE%3D" alt="1765352612636" loading="lazy"/></p>
<p>今天我们就带小伙伴们深入了解CVE-2025-55182漏洞的来龙去脉，并手把手教大家在Dify平台上进行安全修复升级，避开升级过程中的各种大坑。呵呵，保证让你的Dify实例固若金汤！</p>
<h2 data-id="heading-1">✨ 漏洞核心特征</h2>
<ul>
<li><strong>🔥 CVSS 10.0满分</strong>: 史上最严重的React安全漏洞，影响范围极广</li>
<li><strong>💀 无需身份验证</strong>: 攻击者不需要登录，只要服务暴露在公网即可攻击</li>
<li><strong>⚡ 远程代码执行</strong>: 一个HTTP请求直接获取服务器Shell权限</li>
<li><strong>🎯 精准打击Dify</strong>: 使用Next.js App Router的Dify v1.9.x-v1.10.1全线受影响</li>
<li><strong>💰 高价值目标</strong>: 可窃取OpenAI/Claude API密钥、数据库凭证等核心资产</li>
<li><strong>🔗 供应链攻击</strong>: 源头漏洞在React，Next.js连带受影响，波及整个生态</li>
<li><strong>⚠️ 升级有坑</strong>: 官方镜像标签存在错误，盲目升级可能无效</li>
<li><strong>🛡️ WAF可防御</strong>: 通过雷池等WAF可临时拦截攻击，争取升级时间</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba3fb6ddce9f41389d4b0014545b65f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qiH2tMhPh0zXDbOn1CNxx6eNAvo%3D" alt="1765359233004" loading="lazy"/></p>
<h2 data-id="heading-2">🛠️ 技术背景：从CSR到RSC的架构演进</h2>
<p>要理解这个漏洞为什么这么严重，我们得先了解React和Next.js的技术演进史。呵呵，别怕，我用大白话给大家讲清楚。</p>
<h3 data-id="heading-3">React架构的三次进化</h3>
<p><strong>第一代：客户端渲染（CSR）</strong></p>
<ul>
<li><strong>时代</strong>: 2013-2016年</li>
<li><strong>特点</strong>: 服务器只发送空HTML，浏览器下载JS后动态生成页面</li>
<li><strong>问题</strong>: 首屏慢、SEO差、JS体积大</li>
</ul>
<p><strong>第二代：服务端渲染（SSR）</strong></p>
<ul>
<li><strong>时代</strong>: 2016-2022年</li>
<li><strong>代表</strong>: Next.js Pages Router</li>
<li><strong>特点</strong>: 服务器生成完整HTML，浏览器"注水"(Hydration)实现交互</li>
<li><strong>问题</strong>: 仍需下载全量JS，Hydration延迟高</li>
</ul>
<p><strong>第三代：React Server Components（RSC）</strong></p>
<ul>
<li><strong>时代</strong>: 2022年至今</li>
<li><strong>代表</strong>: Next.js 13+ App Router</li>
<li><strong>特点</strong>: 组件分为服务端组件和客户端组件，服务端组件不发送到客户端</li>
<li><strong>优势</strong>: JS体积减少90%，性能大幅提升</li>
<li><strong>风险</strong>: 引入了新的通信协议——Flight Protocol</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b2af5864b204ccb94dc8eb167b9f927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=mO3HF%2ByaDHpoaF%2F7y8B2mThl%2F%2Fg%3D" alt="1765359490644" loading="lazy"/></p>
<h3 data-id="heading-4">Flight协议：漏洞的"元凶"</h3>
<p>为了让服务端组件和客户端组件能够无缝通信，React团队设计了Flight Protocol。这个协议不仅要传输数据，还要传输组件树结构、Promise对象、甚至服务端函数引用。传统的JSON格式无法满足这些复杂需求，于是React实现了一套自定义的序列化/反序列化机制。</p>
<p><strong>问题就出在这里！</strong> 当服务器反序列化客户端发来的Flight协议数据时，没有充分验证数据的安全性，导致攻击者可以构造恶意的序列化数据，触发服务器执行任意代码。</p>



































<table><thead><tr><th>架构特征</th><th>CSR</th><th>SSR</th><th>RSC</th></tr></thead><tbody><tr><td>执行位置</td><td>浏览器</td><td>服务器+浏览器</td><td><strong>服务器(Server Components)</strong></td></tr><tr><td>数据传输</td><td>JSON API</td><td>HTML字符串</td><td><strong>Flight协议序列化流</strong></td></tr><tr><td>主要风险</td><td>XSS, CSRF</td><td>XSS, 注入</td><td><strong>反序列化RCE</strong></td></tr><tr><td>受此漏洞影响</td><td>❌ 否</td><td>❌ 否</td><td>✅ <strong>是</strong></td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2ef3b88e8e94dccb5a73a827d7208a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=rIcvKM7MgPYIzDt7ul1i%2FNgtwgE%3D" alt="unnamed" loading="lazy"/></p>
<h2 data-id="heading-5">🎯 漏洞影响范围</h2>
<h3 data-id="heading-6">受影响的Dify版本</h3>
<ul>
<li><strong>Dify v1.9.0 - v1.10.1</strong>: 全线受影响</li>
<li><strong>核心受害者</strong>: dify-web容器（前端服务）</li>
<li><strong>技术栈</strong>: Next.js 15.x + React 19.x (App Router架构)</li>
</ul>
<h3 data-id="heading-7">受影响的Next.js版本</h3>
<ul>
<li><strong>Next.js 13.4+</strong>: 使用App Router的所有版本</li>
<li><strong>Next.js 14.x, 15.x, 16.x</strong>: 全部受影响</li>
<li><strong>Pages Router用户</strong>: 完全不受影响（使用pages/目录）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5776fc850747483cb84ff99bb5fde6eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=jW%2FQggaNk1PRCoT6%2FP0%2FPpoAqUw%3D" alt="1765359829068" loading="lazy"/></p>
<h3 data-id="heading-8">攻击后果</h3>
<p>根据真实案例，攻击者成功入侵后会进行以下操作：</p>
<ol>
<li><strong>资源劫持</strong>: 部署XMRig挖矿程序，CPU占用飙升至100%</li>
<li><strong>凭证窃取</strong>: 读取环境变量中的API密钥（OpenAI/Claude/AWS等）</li>
<li><strong>数据泄露</strong>: 窃取数据库密码，访问PostgreSQL中的敏感数据</li>
<li><strong>持久化后门</strong>: 在.next目录写入Webshell，修改cron任务</li>
<li><strong>内网渗透</strong>: 以Dify为跳板，攻击内网其他服务</li>
</ol>
<h2 data-id="heading-9">安全漏洞复现</h2>
<h3 data-id="heading-10">dify部署</h3>
<p>我这里使用最新的dify1.10.1版本给大家演示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/696793f4461d4e6bb7144e94a857821e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=0goLQnWVNDTCtk3GpfmU3iyWulM%3D" alt="image-20251210142140149" loading="lazy"/></p>
<p>我们在本地电脑上使用docker compose 安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15400be90bf6476f8dee205408ce7f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=6UImSO6oKh9CrV%2FDuNieKjV1emI%3D" alt="image-20251210142250397" loading="lazy"/></p>
<p>下图我们按照官方的部署方式部署了一个1.10.1版本（算是比较新的版本）</p>
<h3 data-id="heading-11">漏洞检查</h3>
<p>我们这里在github搜索CVE-2025-55182 搜到这个开源项目 把这个代码下载到本地</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80743f80aa3b4e2b900a549df74e0fc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=f4%2FLXLZIucU7%2B6brm98cfcq7FHI%3D" alt="image-20251210142527875" loading="lazy"/></p>
<p>代码下载本地</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c9f2e623e045fdbc6875a648e4cc0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=swuy7Yjyyhse9mBLm2Niw0SEkbs%3D" alt="image-20251210142556609" loading="lazy"/></p>
<p>这个poc.py 代码非常简单，我们在命令行窗口直接下面地址</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py http://127.0.0.1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0e0912140494c1e94e0f2d51a0bb9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=HYTo7QLZlga5T4OjnrWRSUXOmv4%3D" alt="image-20251210142741505" loading="lazy"/></p>
<p>出现下面的画面我们的浮现了上手漏洞。脚本已经成功拿到数据库返回uid=1001 用户root。如果这个暴露在互联网，如果没有安全防护WAF等安全设备硬件或者软件基本上我通过这一行命令就可以成功拿到服务器权限了。</p>
<h3 data-id="heading-12">扫描生成环境</h3>
<p>我们公司也少量的使用的dify做一些信息查询和统计。我们查看一下生产环境的版本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/505762073565409ba3795f8a8d6d1164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=hdZ2KGWAgpbiDCifrp07V32%2F8hk%3D" alt="image-20251210143144806" loading="lazy"/></p>
<p>我们检查下面当前生产环境使用的是1.9.0 版本。刚才我们上面给大家演示的是1.10.1 版本也是成功拿下，我们也在想这个脚本是不是也可以拿下生产环境？答案我也不知道，我们来试一试。</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py https://xxx.xxx.com
</code></pre>
<p>生产环境我们用域名来实现访问的所以地址是上面的信息（我这里影藏了。）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7725baac73804b82892e540ad3e817af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=i3XZFO0m6smfRrksfmUWhX0Idk0%3D" alt="image-20251210143455362" loading="lazy"/></p>
<p>返回了一串信息还有一个403。返回信息是一个HTML，我们抓出来保存HTML</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4119049fdc4a1f914087a2356fd8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=yH1g7Z0%2B0HAFsYmWvjKHo8N45Cs%3D" alt="image-20251210143608687" loading="lazy"/></p>
<p>我们看到这里的POC请求被我们的雷池WAF成功拦截了。因为这个是一个反序列化漏洞，WAF通过判断成功拦截了一些非法请求。成功保护了我们后端程序不给其他非法工具攻击成功。</p>
<p>所以生产环境中我们在前端增加一个WAF防护拦截还是有必要的。这样我们可以给后端程序争取升级的时间，有效的包含我们的信息资产不会被攻击到。</p>
<h2 data-id="heading-13">升级漏洞修复</h2>
<h3 data-id="heading-14">升级包介绍</h3>
<p>知道了上面的安全漏洞我们按照官方提供的安全漏洞镜像包升级就可以了。我们在dify官方镜像包</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05dbd70c3d9b45c7a2ac72ad74d12527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qCLre2thsUXuv3Y%2Bky9W%2B9Imqlw%3D" alt="image-20251210144155082" loading="lazy"/></p>
<p>我们把代码下载到本地</p>
<p>我们打开代码进入docker文件夹中找到docker-compose.yaml 并打开它。这个地方其实有一个坑，上周官方紧急修改了BUG，但是这个docker-compose.yaml里面的镜像文件并没有修复还是老的langgenius/dify-api:1.10.1、langgenius/dify-web:1.10.1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2360905e55e14333821cb2a64ecf07ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=muTDAXELtkAlbrhO2Y2yGASDS7A%3D" alt="image-20251210145019818" loading="lazy"/></p>
<p>我们需要注意这个地方应该是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4802dceb49644ef6bc73a24e846716c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=oBNcZkPUKfluXkWLTO97ihyBYkk%3D" alt="image-20251210145142608" loading="lazy"/></p>
<p>很多小伙伴被坑了一把，服务器我是周末手工升级的，公司的环境我周一（2025年12月8日）安排其他人升级的，结果升级后没有修复这个漏洞复现了。我今天仔细检查了升级的记录发现上述问题。</p>
<p>新的升级包已经修复了这个问题，我看升级时间大概是昨天</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb09e74d74e4426683964437001b17df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=71U2JH2rTVLV1y7cbwaZ7SiZaak%3D" alt="image-20251210145510508" loading="lazy"/></p>
<p>大家可以使用比较工具比较（我平时升级都不是安装官方方式升级，官方升级坑多）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a69845cbef74c92b981f7ba0d276a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=S9gjUnSkOi680M8yHiVIeXkkA64%3D" alt="image-20251210145742384" loading="lazy"/></p>
<p>确保以上版本是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1 升级后才不会有问题。</p>
<p>顺便提一嘴，我使用的比较工具名字叫做BCompare，写代码、分析代码比较文档神器。我这个工具我用了很多年了推荐给大家。（工具下载大家可以网上搜，这里就不给提供下载包了，包我也没有。）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f88b807a23c45b1b71a3011597f6b7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qm7Wf8EXFGxMiNvhwsfm9l1zicM%3D" alt="image-20251210153213972" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9666bd409caf442fb6fcaff70121b6b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=sjYGLb6w3cM8wAuUu3peble3se4%3D" alt="image-20251210153151439" loading="lazy"/></p>
<h3 data-id="heading-15">升级复测</h3>
<p>我们确保升级版本是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1 正确的修复镜像后启动dify, 接下来我们还是使用前面的验证脚本测试</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py  http://192.168.210.10
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f21b69f5d4240689b9122b33507ed7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=irbi7Dae%2FfYskOBA2skGKd8N19A%3D" alt="image-20251210150011032" loading="lazy"/></p>
<p>出现404了。这个测试方法我是绕过公司网络安全防护WAF验证的。这POC 没有返回信息，说明安全漏洞已经修复没有出现反弹的序列化漏洞了。</p>
<h2 data-id="heading-16">总结</h2>
<p>今天主要带大家了解并实现了Dify平台CVE-2025-55182高危安全漏洞的完整检测与修复流程，该漏洞以"React Server Components反序列化缺陷 + CVSS 10.0满分评级"为核心特征，结合Next.js App Router架构和Flight协议的不安全反序列化机制，通过无需身份验证的恶意HTTP请求直接触发远程代码执行，形成了一套从漏洞检测到安全加固的全链路防御方案。</p>
<p>在实际应用中，该修复方案不仅解决了React生态史上最严重的安全漏洞威胁，还通过对比CSR/SSR/RSC三代架构演进揭示了Flight协议设计缺陷的根本原因，技术深度远超简单的"打补丁"操作；特别是通过真实的生产环境WAF拦截案例、官方镜像标签错误踩坑经历、周末紧急升级与周一复测失败的血泪教训等关键信息点，有效帮助小伙伴们避开升级过程中12月6-8日期间docker-compose.yaml配置文件未更新-fix.1后缀的致命陷阱。</p>
<p>感兴趣的小伙伴可以按照文中提供的步骤进行实践，根据实际部署架构调整镜像版本检查和POC测试方法。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案]]></title>    <link>https://juejin.cn/post/7581858890608476196</link>    <guid>https://juejin.cn/post/7581858890608476196</guid>    <pubDate>2025-12-10T11:14:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608476196" data-draft-id="7581995152190783530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-10T11:14:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:14:37.000Z" title="Wed Dec 10 2025 11:14:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。鸿蒙在跨设备数据传输的能力，即丝滑又酷炫，今天的内容，V 哥想分享一下基于鸿蒙 6.0（API21）实现跨设备实时滤镜同步的完整方案，结合分布式软总线与 <code>PixelMap</code> 的协同处理流程：</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">一、技术架构设计</h3>

























<table><thead><tr><th>层级</th><th>组件</th><th>功能说明</th></tr></thead><tbody><tr><td><strong>应用层</strong></td><td>手机（客户端）</td><td>调用相机生成 <code>PixelMap</code>，应用滤镜算法，通过 RPC 发送数据</td></tr><tr><td><strong>传输层</strong></td><td>分布式软总线（SoftBus）</td><td>设备自动发现、低延迟传输渲染指令流</td></tr><tr><td><strong>渲染层</strong></td><td>平板（服务端）</td><td>接收 <code>PixelMap</code> 数据流，通过 <code>CanvasRenderer</code> 实时渲染</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">二、核心实现步骤</h3>
<h4 data-id="heading-2">1. <strong>环境配置与权限声明</strong></h4>
<p>在 <code>module.json5</code> 中添加分布式能力与相机权限：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;module&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;requestPermissions&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ohos.permission.DISTRIBUTED_DATASYNC&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 分布式数据同步</span>
        &amp;#<span class="hljs-number">34</span>;reason&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;跨设备传输PixelMap数据&amp;#<span class="hljs-number">34</span>;
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ohos.permission.CAMERA&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;usedScene&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> &amp;#<span class="hljs-number">34</span>;abilities&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;CameraAbility&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;abilities&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;CameraAbility&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;distributedEnabled&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>  <span class="hljs-comment">// 启用分布式能力</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">2. <strong>设备发现与连接管理</strong></h4>
<p>使用 <code>DistributedDeviceManager</code> 获取目标设备 NetworkId：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> distributedDeviceManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.distributedDeviceManager'</span>;

<span class="hljs-comment">// 发现可用设备</span>
<span class="hljs-keyword">let</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(context);
<span class="hljs-keyword">let</span> deviceList = deviceManager.<span class="hljs-title function_">getTrustedDeviceListSync</span>();
<span class="hljs-keyword">let</span> targetDevice = deviceList.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">device</span> =&gt;</span> device.<span class="hljs-property">deviceName</span> === &amp;#<span class="hljs-number">34</span>;平板设备&amp;#<span class="hljs-number">34</span>;);
<span class="hljs-keyword">let</span> networkId = targetDevice.<span class="hljs-property">networkId</span>;
</code></pre>
<h4 data-id="heading-4">3. <strong>手机端：相机捕获与滤镜处理</strong></h4>
<p>通过 <code>@ohos.multimedia.camera</code> 获取相机帧数据并转换为 <code>PixelMap</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> camera <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.multimedia.camera'</span>;

<span class="hljs-comment">// 创建相机预览流</span>
camera.<span class="hljs-title function_">createPreviewOutput</span>(cameraManager, surfaceId).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">previewOutput</span>) =&gt;</span> {
  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameStart'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 获取图像数据并应用滤镜</span>
    <span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMapFromSurface</span>(surfaceId);
    <span class="hljs-keyword">let</span> filteredPixelMap = <span class="hljs-title function_">applySepiaFilter</span>(pixelMap);  <span class="hljs-comment">// 示例：棕褐色滤镜</span>
    <span class="hljs-title function_">sendToTablet</span>(filteredPixelMap, networkId);
  });
});

<span class="hljs-comment">// 滤镜算法示例（棕褐色调）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">applySepiaFilter</span>(<span class="hljs-params">pixelMap: image.PixelMap</span>): image.<span class="hljs-property">PixelMap</span> {
  <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">getImageData</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arrayBuffer.<span class="hljs-property">length</span>; i += <span class="hljs-number">4</span>) {
    <span class="hljs-keyword">let</span> r = arrayBuffer[i], g = arrayBuffer[i+<span class="hljs-number">1</span>], b = arrayBuffer[i+<span class="hljs-number">2</span>];
    arrayBuffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.393</span>) + (g * <span class="hljs-number">0.769</span>) + (b * <span class="hljs-number">0.189</span>));
    arrayBuffer[i+<span class="hljs-number">1</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.349</span>) + (g * <span class="hljs-number">0.686</span>) + (b * <span class="hljs-number">0.168</span>));
    arrayBuffer[i+<span class="hljs-number">2</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.272</span>) + (g * <span class="hljs-number">0.534</span>) + (b * <span class="hljs-number">0.131</span>));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMapFromData</span>(arrayBuffer, pixelMap.<span class="hljs-title function_">getImageInfo</span>());
}
</code></pre>
<h4 data-id="heading-5">4. <strong>跨设备数据传输（RPC 调用）</strong></h4>
<p><strong>服务端（平板）定义远程接口</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {
  <span class="hljs-comment">// 接收手机端发送的PixelMap数据</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRemoteMessageRequest</span>(<span class="hljs-params">code: <span class="hljs-built_in">number</span>, data: rpc.MessageSequence, reply: rpc.MessageSequence</span>) {
    <span class="hljs-keyword">if</span> (code === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">let</span> pixelMapData = data.<span class="hljs-title function_">readObject</span>() <span class="hljs-keyword">as</span> image.<span class="hljs-property">PixelMap</span>;  <span class="hljs-comment">// 反序列化数据</span>
      <span class="hljs-title function_">renderOnCanvas</span>(pixelMapData);  <span class="hljs-comment">// 在平板端渲染</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<p><strong>客户端（手机）绑定服务并发送数据</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 构造Want对象绑定平板服务</span>
<span class="hljs-keyword">let</span> want = {
  <span class="hljs-attr">bundleName</span>: &amp;#<span class="hljs-number">34</span>;com.<span class="hljs-property">example</span>.<span class="hljs-property">tabletapp</span>&amp;#<span class="hljs-number">34</span>;,
  <span class="hljs-attr">abilityName</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-title class_">FilterServiceAbility</span>&amp;#<span class="hljs-number">34</span>;,
  <span class="hljs-attr">deviceId</span>: networkId  <span class="hljs-comment">// 目标设备标识</span>
};

<span class="hljs-comment">// 发送滤镜处理后的PixelMap</span>
<span class="hljs-keyword">let</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Context</span>.<span class="hljs-title function_">connectService</span>(want);
<span class="hljs-keyword">let</span> data = rpc.<span class="hljs-property">MessageSequence</span>.<span class="hljs-title function_">create</span>();
data.<span class="hljs-title function_">writeObject</span>(pixelMap);
proxy.<span class="hljs-title function_">sendMessageRequest</span>(<span class="hljs-number">1</span>, data);
</code></pre>
<h4 data-id="heading-6">5. <strong>平板端：实时渲染与显示</strong></h4>
<p>使用 <code>CanvasRenderer</code> 渲染接收到的 <code>PixelMap</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> ui <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.arkui.ui'</span>;

<span class="hljs-comment">// 创建画布组件</span>
struct <span class="hljs-title class_">FilterCanvas</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Canvas</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">onCanvasReady</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }

  <span class="hljs-title function_">onCanvasReady</span>(<span class="hljs-params">ctx: CanvasRenderingContext2D</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>) {
      ctx.<span class="hljs-title function_">drawImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">360</span>, <span class="hljs-number">640</span>);  <span class="hljs-comment">// 渲染图像</span>
    }
  }

  <span class="hljs-comment">// 接收手机端数据更新UI</span>
  <span class="hljs-title function_">updatePixelMap</span>(<span class="hljs-params">newPixelMap: image.PixelMap</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = newPixelMap;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、性能优化关键点</h3>
<ol>
<li>
<p><strong>数据压缩传输</strong></p>
<ul>
<li>将 <code>PixelMap</code> 转换为 <code>ArrayBuffer</code> 后使用 LZ4 压缩，减少软总线带宽占用。</li>
<li>代码示例：
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> compressedData = zlib.<span class="hljs-title function_">compress</span>(pixelMap.<span class="hljs-title function_">getImageData</span>(), { <span class="hljs-attr">level</span>: <span class="hljs-number">3</span> });
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>渲染帧率控制</strong></p>
<ul>
<li>通过 <code>requestAnimationFrame</code> 限制刷新率（如 30fps），避免平板端过载。</li>
</ul>
</li>
<li>
<p><strong>错误处理与重连</strong></p>
<ul>
<li>监听设备断开事件，自动切换至本地渲染：
<pre><code class="hljs language-typescript" lang="typescript">deviceManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'deviceOffline'</span>, <span class="hljs-function">(<span class="hljs-params">device</span>) =&gt;</span> {
  <span class="hljs-title function_">showDialog</span>(<span class="hljs-string">'设备断开，已切换本地模式'</span>);
  <span class="hljs-title function_">switchToLocalRender</span>();
});
</code></pre>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">四、完整流程示意图</h3>
<pre><code class="hljs language-css" lang="css">手机端采集 → 滤镜处理 → 软总线传输 → 平板渲染 → 显示反馈
    ↓          ↓           ↓           ↓         ↓
  Camera → PixelMap → RPC调用 → <span class="hljs-selector-tag">Canvas</span> → UI更新
</code></pre>
<hr/>
<h3 data-id="heading-9">注意事项</h3>
<ol>
<li><strong>设备兼容性</strong>：需确保双端设备为 HarmonyOS 6.0 及以上版本，且登录同一华为账号。</li>
<li><strong>延迟优化</strong>：若传输延迟 &gt;100ms，可降低图像分辨率（如 720p→480p）。</li>
<li><strong>隐私安全</strong>：传输的 <code>PixelMap</code> 数据需在本地完成脱敏处理，避免敏感信息泄露。</li>
</ol>
<p>通过以上方案，可实现手机拍摄后滤镜效果实时同步至平板渲染，充分发挥鸿蒙分布式能力与图像处理性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter Path.computeMetrics() 的使用注意点]]></title>    <link>https://juejin.cn/post/7582003642191937578</link>    <guid>https://juejin.cn/post/7582003642191937578</guid>    <pubDate>2025-12-10T11:20:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582003642191937578" data-draft-id="7581858890608492580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter Path.computeMetrics() 的使用注意点"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-10T11:20:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter Path.computeMetrics() 的使用注意点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:20:00.000Z" title="Wed Dec 10 2025 11:20:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个Path转虚线的扩展</p>
<pre><code class="hljs language-java" lang="java">extension DashedPathExtension on Path {
  <span class="hljs-comment">/// 转换为虚线 Path（安全版）</span>
  <span class="hljs-comment">/// [solidLength]：实线段长度（像素）</span>
  <span class="hljs-comment">/// [gapLength]：空线段长度（像素）</span>
  <span class="hljs-comment">/// 返回：新的虚线 Path（原 Path 不变）</span>
  Path <span class="hljs-title function_">toDashedPath</span><span class="hljs-params">({
    required <span class="hljs-type">double</span> solidLength,
    required <span class="hljs-type">double</span> gapLength,
  })</span> {
    <span class="hljs-comment">// 前置参数校验</span>
    <span class="hljs-keyword">assert</span>(solidLength &gt; <span class="hljs-number">0</span>, &amp;#<span class="hljs-number">34</span>;实线段长度必须大于<span class="hljs-number">0</span>&amp;#<span class="hljs-number">34</span>;);
    <span class="hljs-keyword">assert</span>(gapLength &gt;= <span class="hljs-number">0</span>, &amp;#<span class="hljs-number">34</span>;空线段长度不能为负数&amp;#<span class="hljs-number">34</span>;);

    <span class="hljs-comment">// 1. 安全获取 PathMetrics 并校验</span>
    <span class="hljs-comment">//final PathMetrics metrics = computeMetrics();</span>
    <span class="hljs-comment">// // 校验1：PathMetrics 为空 → 返回空 Path</span>
    <span class="hljs-comment">//if (metrics.isEmpty) return Path();</span>

    <span class="hljs-comment">// 2. 遍历 metrics（兼容多段路径），避免 first 直接报错</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Path</span> <span class="hljs-variable">dashedPath</span> <span class="hljs-operator">=</span> Path();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> PathMetric metric in <span class="hljs-title function_">computeMetrics</span><span class="hljs-params">()</span>) {
      <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">totalLength</span> <span class="hljs-operator">=</span> metric.length;
      <span class="hljs-comment">// 校验2：单段路径长度为0 → 跳过</span>
      <span class="hljs-keyword">if</span> (totalLength &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// 3. 循环绘制实线段（始终从实线开始）</span>
      <span class="hljs-type">double</span> <span class="hljs-variable">currentDistance</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;
      <span class="hljs-keyword">while</span> (currentDistance &lt; totalLength) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">solidEnd</span> <span class="hljs-operator">=</span> currentDistance + solidLength;
        <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">actualEnd</span> <span class="hljs-operator">=</span> solidEnd &gt; totalLength ? totalLength : solidEnd;

        <span class="hljs-comment">// 提取实线段并添加到虚线 Path</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Path</span> <span class="hljs-variable">segment</span> <span class="hljs-operator">=</span> metric.extractPath(currentDistance, actualEnd);
        dashedPath.addPath(segment, Offset.zero);

        <span class="hljs-comment">// 跳过空线段</span>
        currentDistance = solidEnd + gapLength;
      }
    }

    <span class="hljs-keyword">return</span> dashedPath;
  }
}
</code></pre>
<p>注意点是这个</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 1. 安全获取 PathMetrics 并校验</span>
    <span class="hljs-comment">// final PathMetrics metrics = computeMetrics();</span>
    <span class="hljs-comment">// // // 校验1：PathMetrics 为空 → 返回空 Path</span>
    <span class="hljs-comment">// if (metrics.isEmpty) return Path();</span>
</code></pre>
<p>这里调用了 metrics.isEmpty()</p>
<pre><code class="hljs language-js" lang="js">  bool get isEmpty =&gt; !iterator.<span class="hljs-title function_">moveNext</span>();
</code></pre>
<p>也就是调用了迭代器的moveNext() 再次遍历metrics 就会从第二个元素开始。
如果迭代器本身只有一个元素,这个时候调用metrics.first 救护报错no element。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？]]></title>    <link>https://juejin.cn/post/7582036070159269888</link>    <guid>https://juejin.cn/post/7582036070159269888</guid>    <pubDate>2025-12-10T11:29:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070159269888" data-draft-id="7581876069609504811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T11:29:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:29:43.000Z" title="Wed Dec 10 2025 11:29:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，<strong>数据持久化</strong>（Data Persistence）是绕不开的话题。无论是为了让用户免于重复登录，还是保存用户的偏好设置（如深色模式），我们都需要将数据存储在用户的设备上。</p>
<p>对于使用 Expo 开发的 React Native 项目，官方推荐了两种截然不同的存储方案：<strong><code>AsyncStorage</code></strong> 和 <strong><code>expo-secure-store</code></strong>。</p>
<p>本文将深入解析这两者的区别、适用场景，并教你如何在项目中优雅地封装它们。</p>
<hr/>
<h2 data-id="heading-0">方案一：AsyncStorage（通用存储）</h2>
<p><strong>AsyncStorage</strong> 是 React Native 社区维护的一个异步、非加密的键值对（Key-Value）存储系统。你可以把它想象成浏览器端的 <code>localStorage</code>。</p>
<h3 data-id="heading-1">1. 适用场景</h3>
<p>由于它是<strong>未加密</strong>的，任何拥有设备文件系统访问权限的人（或恶意软件）都能读取这些数据。因此，它<strong>只适合</strong>存储：</p>
<ul>
<li>✅ 用户偏好设置（如：是否开启推送、语言设置、主题色）</li>
<li>✅ 应用缓存数据（如：首页的临时数据列表）</li>
<li>✅ Redux/Zustand 状态的持久化</li>
<li>❌ <strong>绝对不要存</strong>：用户密码、身份认证 Token、信用卡信息</li>
</ul>
<h3 data-id="heading-2">2. 安装</h3>
<pre><code class="hljs language-Bash" lang="Bash">npx expo install @react-native-async-storage/async-storage
</code></pre>
<h3 data-id="heading-3">3. 使用示例</h3>
<p>AsyncStorage 只能存储字符串。如果你要存储对象，需要使用 <code>JSON.stringify</code> 和 <code>JSON.parse</code> 进行转换。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AsyncStorage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-async-storage/async-storage'</span>;

<span class="hljs-comment">// 1. 存储数据 (Key 必须是字符串，Value 也必须是字符串)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveSettings</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'app_theme'</span>, <span class="hljs-string">'dark'</span>);
    <span class="hljs-comment">// 存储对象需序列化</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'user_profile'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }));
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存失败'</span>, e);
  }
};

<span class="hljs-comment">// 2. 读取数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadSettings</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> theme = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'app_theme'</span>);
    
    <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'user_profile'</span>);
    <span class="hljs-keyword">const</span> userProfile = jsonValue != <span class="hljs-literal">null</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonValue) : <span class="hljs-literal">null</span>;
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(theme, userProfile);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取失败'</span>, e);
  }
};

<span class="hljs-comment">// 3. 删除/清空</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clearData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'app_theme'</span>); <span class="hljs-comment">// 删除单个</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 清空所有（慎用）</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-4">方案二：expo-secure-store（安全存储）</h2>
<p><strong>SecureStore</strong> 是 Expo 提供的一个库，它利用了操作系统底层的安全机制来加密存储数据。</p>
<ul>
<li><strong>iOS</strong>: 使用 <strong>Keychain Services</strong>（钥匙串）。</li>
<li><strong>Android</strong>: 使用 <strong>SharedPreferences</strong>（配合 Keystore 加密）。</li>
</ul>
<h3 data-id="heading-5">1. 适用场景</h3>
<p>这是存储敏感数据的唯一正确选择：</p>
<ul>
<li>✅ 身份认证 Token (Auth Token / Refresh Token)</li>
<li>✅ 用户密码 (Password)</li>
<li>✅ API 密钥 (API Keys)</li>
</ul>
<h3 data-id="heading-6">2. 安装</h3>
<pre><code class="hljs language-Bash" lang="Bash">npx expo install expo-secure-store
</code></pre>
<h3 data-id="heading-7">3. 使用示例</h3>
<p>API 与 AsyncStorage 非常相似，但它保证了数据是加密落盘的。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">SecureStore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-secure-store'</span>;

<span class="hljs-comment">// 1. 存储敏感数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 注意：Key 和 Value 都必须是字符串</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">setItemAsync</span>(<span class="hljs-string">'user_token'</span>, token);
};

<span class="hljs-comment">// 2. 读取数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">getItemAsync</span>(<span class="hljs-string">'user_token'</span>);
  <span class="hljs-keyword">if</span> (token) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取到 Token:'</span>, token);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未找到 Token'</span>);
  }
};

<span class="hljs-comment">// 3. 删除数据 (如用户登出时)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">deleteItemAsync</span>(<span class="hljs-string">'user_token'</span>);
};
</code></pre>
<hr/>
<h2 data-id="heading-8">深度对比：该选哪一个？</h2>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>AsyncStorage</strong></th><th><strong>SecureStore</strong></th></tr></thead><tbody><tr><td><strong>安全性</strong></td><td>🚨 <strong>低</strong> (明文存储，类似 TXT 文件)</td><td>🔒 <strong>高</strong> (OS 级硬件加密)</td></tr><tr><td><strong>存储容量</strong></td><td>较大 (几 MB 到几十 MB 没问题)</td><td>极小 (建议只存 &lt; 2KB 的短字符串)</td></tr><tr><td><strong>读写速度</strong></td><td>快</td><td>稍慢 (涉及解密过程)</td></tr><tr><td><strong>数据类型</strong></td><td>仅字符串 (需手动 JSON 序列化)</td><td>仅字符串</td></tr><tr><td><strong>核心用途</strong></td><td>缓存、设置、非敏感状态</td><td><strong>Token、密码、证书</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">最佳实践：封装统一的存储工具</h2>
<p>在真实的项目开发中，我们不应该在 UI 组件里直接调用 <code>AsyncStorage</code> 或 <code>SecureStore</code>，而是应该封装一个工具模块。这样既能统一管理 Key，又能屏蔽底层实现的差异。</p>
<p>以下是一个推荐的 <strong><code>utils/storage.ts</code></strong> 封装示例：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// utils/storage.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AsyncStorage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-async-storage/async-storage'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">SecureStore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-secure-store'</span>;

<span class="hljs-comment">// 定义所有的 Key，防止手误写错</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEYS</span> = {
  <span class="hljs-attr">TOKEN</span>: <span class="hljs-string">'auth_token'</span>,
  <span class="hljs-attr">USER_INFO</span>: <span class="hljs-string">'user_info'</span>,
  <span class="hljs-attr">THEME</span>: <span class="hljs-string">'app_theme'</span>,
};

<span class="hljs-comment">/**
 * 敏感数据存储工具 (使用 SecureStore)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthStorage</span> = {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setToken</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">setItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>, token);
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">getItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>);
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">clearToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">deleteItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>);
  },
};

<span class="hljs-comment">/**
 * 普通数据存储工具 (使用 AsyncStorage)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppStorage</span> = {
  <span class="hljs-comment">// 封装对象存储，自动处理 JSON 转换</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setUser</span>(<span class="hljs-params">user: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user);
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">USER_INFO</span>, jsonValue);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Saving user failed'</span>, e);
    }
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">USER_INFO</span>);
      <span class="hljs-keyword">return</span> jsonValue != <span class="hljs-literal">null</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonValue) : <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Loading user failed'</span>, e);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">clearAll</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">clear</span>();
  }
};
</code></pre>
<h3 data-id="heading-10">如何在业务中使用？</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthStorage</span>, <span class="hljs-title class_">AppStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/storage'</span>;

<span class="hljs-comment">// 登录成功后</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLoginSuccess</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">apiResponse</span>) =&gt; {
    <span class="hljs-keyword">const</span> { token, user } = apiResponse;
    
    <span class="hljs-comment">// 1. Token 进保险箱</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AuthStorage</span>.<span class="hljs-title function_">setToken</span>(token);
    
    <span class="hljs-comment">// 2. 用户信息进普通仓库</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setUser</span>(user);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录数据已持久化'</span>);
};

<span class="hljs-comment">// 退出登录时</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AuthStorage</span>.<span class="hljs-title function_">clearToken</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>); 
};
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>在 React Native (Expo) 开发中，请务必遵守 <strong>“数据分级”</strong> 原则：</p>
<ol>
<li><strong>Token 和密码</strong>：必须通过 <code>expo-secure-store</code> 放入系统的“保险箱”。</li>
<li><strong>设置和缓存</strong>：可以通过 <code>@react-native-async-storage/async-storage</code> 放入普通的“储物柜”。</li>
</ol>
<p>通过合理的封装，你可以让代码更安全、更整洁，也更易于维护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code终端从入门到精通完全指南]]></title>    <link>https://juejin.cn/post/7581995152190849066</link>    <guid>https://juejin.cn/post/7581995152190849066</guid>    <pubDate>2025-12-10T11:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581995152190849066" data-draft-id="7582003642191986730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code终端从入门到精通完全指南"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-10T11:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code终端从入门到精通完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:32:13.000Z" title="Wed Dec 10 2025 11:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前，Visual Studio Code的集成终端已成为开发者日常工作中不可或缺的工具。它不仅能运行 <code>echo</code>、 <code>ls</code> 和 <code>git</code> 等命令，还与编辑器深度集成，支持工作区文件链接和错误检测等功能。无论你是使用Bash、Zsh还是PowerShell，VS Code终端都能满足你的需求。</p>
<p>打开终端的三种方式：</p>
<ul>
<li>快捷键： <code>Ctrl+``（Windows/Linux）或</code>Cmd+``（macOS）</li>
<li>菜单栏：<strong>查看 &gt; 终端</strong></li>
<li>命令面板： <code>Ctrl+Shift+P</code> 输入<strong>终端：新建终端</strong></li>
</ul>
<p>终端默认工作目录为当前打开的VS Code项目根目录，这意味着你可以直接运行与项目相关的命令，无需额外切换路径。</p>
<h2 data-id="heading-0">基础操作</h2>
<p>VS Code终端提供丰富的交互功能，让你能够高效地与命令输出进行交互。命令通常会输出文件路径或URL，你只需按住Ctrl/Cmd键，将鼠标悬停在文件名上，然后点击链接，VS Code会自动在编辑器中打开该文件。对于URL，点击后会在默认浏览器中打开。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84d6c57dd60b450e92beef7718da6538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=4H%2FOhO%2FDF18%2BzKMRRk2OyHbSps8%3D" alt="image.png" loading="lazy"/></p>
<p>核心快捷键一览：</p>
<ul>
<li>新建终端： `Ctrl+Shift+``</li>
<li>切换终端： <code>Ctrl+PageUp/PageDown</code></li>
<li>分屏终端： <code>Ctrl+\</code>（Windows/Linux）或 <code>Cmd+\</code>（macOS）</li>
<li>关闭终端： <code>Ctrl+Shift+W</code></li>
</ul>
<p>命令历史导航：</p>
<ul>
<li>向上查看历史命令： <code>↑</code> 键</li>
<li>向下查看历史命令： <code>↓</code> 键</li>
<li>搜索历史命令： <code>Ctrl+R</code>（Bash/Zsh）或 <code>F8</code>（PowerShell）</li>
</ul>
<p>创建命令列表文件示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Bash/Zsh</span>
<span class="hljs-built_in">ls</span> -l /usr/bin &gt; Command.txt

<span class="hljs-comment"># PowerShell</span>
Get-Command | Out-File -FilePath .\Command.txt
</code></pre>
<h2 data-id="heading-1">配置文件</h2>
<p>终端配置文件是特定于平台的shell配置，由可执行文件路径、参数和其他自定义项组成。VS Code会自动检测几个常见的配置文件，你也可以根据需要进行自定义或添加新的配置文件。</p>
<p>设置默认配置文件步骤：</p>
<ul>
<li>打开命令面板（ <code>Ctrl+Shift+P</code>）</li>
<li>搜索"终端: 选择默认配置文件"</li>
<li>从下拉菜单中选择你常用的shell</li>
</ul>
<p>默认情况下，Linux和macOS上的默认shell是 <code>$SHELL</code> 环境变量指定的程序，Windows系统默认使用PowerShell。</p>
<p>自定义配置文件示例（settings.json）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.profiles.windows&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;PowerShell - NoProfile&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;source&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;PowerShell&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;-NoProfile&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;Git Bash&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;path&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;C<span class="hljs-punctuation">:</span>\\Program Files\\Git\\bin\\bash.exe&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;--login&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.defaultProfile.windows&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;Git Bash&amp;#<span class="hljs-number">34</span>;
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-2">Shell集成</h2>
<p>VS Code能够与常见的Shell集成，使终端可以更深入地了解Shell内部的情况。这种集成启用了工作目录检测、命令检测、装饰和导航等有用功能。</p>
<p>支持的Shell包括Linux/macOS上的bash、fish、pwsh、zsh，以及Windows上的Git Bash和pwsh。默认情况下，当从VS Code启动受支持的Shell时，Shell集成脚本会自动激活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b355fbec424e5e8275491b8a54f1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=NXlmF6%2Fyz06hJSfBTsrjT04vTVs%3D" alt="image.png" loading="lazy"/></p>
<p>手动安装Shell集成（以bash为例）：</p>
<ul>
<li>打开配置文件： <code>code ~/.bashrc</code></li>
<li>添加以下内容：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">[[ &amp;<span class="hljs-comment">#34;$TERM_PROGRAM&amp;#34; == &amp;#34;vscode&amp;#34; ]] &amp;&amp; . &amp;#34;$(code --locate-shell-integration-path bash)&amp;#34;</span>
</code></pre>
<ul>
<li>重新加载配置： <code>source ~/.bashrc</code></li>
</ul>
<p>Shell集成质量分为"无"、"丰富"和"基本"三个等级。将鼠标悬停在终端选项卡上可以查看当前的集成质量状态。</p>
<h2 data-id="heading-3">外观设置</h2>
<p>VS Code终端的外观可以进行广泛的自定义，包括文本样式、光标样式和选项卡等。通过调整这些设置，你可以打造一个既美观又符合个人习惯的终端环境。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae78ca4728114d5d88c0be960dc88101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=h5QGs71bzL1R1B1B3xBrAw6u6bY%3D" alt="image.png" loading="lazy"/></p>
<p>常用外观设置（settings.json）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.fontFamily&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;'Fira Code'<span class="hljs-punctuation">,</span> 'Hack NF'<span class="hljs-punctuation">,</span> monospace&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.fontSize&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.lineHeight&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">1.2</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorStyle&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;line&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorWidth&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorBlinking&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;workbench.colorCustomizations&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;terminal.background&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;#<span class="hljs-number">1e1</span>e1e&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;terminal.foreground&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;#e0e0e0&amp;#<span class="hljs-number">34</span>;
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Powerline和Nerd Fonts配置：</p>
<pre><code class="hljs language-json" lang="json">&amp;#<span class="hljs-number">34</span>;terminal.integrated.fontFamily&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;'DejaVu Sans Mono for Powerline'<span class="hljs-punctuation">,</span> 'Hack NF'&amp;#<span class="hljs-number">34</span>;
</code></pre>
<h2 data-id="heading-4">高级功能</h2>
<p>VS Code终端提供了许多高级功能，帮助你进一步提升开发效率。</p>
<h3 data-id="heading-5">持久会话</h3>
<p>终端支持两种持久会话类型：</p>
<ul>
<li>进程重新连接：重新加载窗口时重新连接到先前的进程</li>
<li>进程恢复：重新启动VS Code时恢复终端内容并重新启动进程</li>
</ul>
<p>禁用持久会话：</p>
<pre><code class="hljs language-json" lang="json">&amp;#<span class="hljs-number">34</span>;terminal.integrated.enablePersistentSessions&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
</code></pre>
<h3 data-id="heading-6">命令别名设置</h3>
<p>通过shell配置文件实现常用命令的快捷方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Bash/Zsh用户编辑~/.bashrc或~/.zshrc</span>
<span class="hljs-built_in">alias</span> ll=<span class="hljs-string">'ls -la'</span>
<span class="hljs-built_in">alias</span> gs=<span class="hljs-string">'git status'</span>
<span class="hljs-built_in">alias</span> gp=<span class="hljs-string">'git push'</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787d064309364ed6968e86f8009678a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=BjsdY09agq3FF9p5UzyLkJ4TOyc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">自定义键盘快捷键</h3>
<p>在keybindings.json中配置终端快捷键：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;key&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ctrl+shift+t&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;command&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;workbench.action.terminal.sendSequence&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> &amp;#<span class="hljs-number">34</span>;text&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;npm run dev\n&amp;#<span class="hljs-number">34</span>; <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">多终端管理</h3>
<ul>
<li>重命名终端：右键终端选项卡 &gt; <strong>重命名</strong></li>
<li>移动终端：拖拽终端选项卡到编辑器区域或新窗口</li>
<li>终端分组：右键终端 &gt; <strong>移动到新组</strong></li>
</ul>
<h3 data-id="heading-9">任务自动化</h3>
<p>在工作区根目录创建 <code>.vscode/tasks.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;version&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">2.0</span><span class="hljs-number">.0</span>&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;tasks&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;label&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;启动开发服务器&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;type&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;shell&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;command&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;npm run dev&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;group&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;kind&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;build&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;isDefault&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;problemMatcher&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用 <code>Ctrl+Shift+B</code> 快速运行任务。</p>
<p>VS Code终端不仅仅是一个命令执行工具，它是你开发工作流的核心部分。花时间配置好终端，每天节省的操作时间会累积成显著的效率优势。无论你是刚入门的新手还是经验丰富的开发者，掌握这些终端技巧都将使你的VS Code体验更加流畅和高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代C++系统编程中类型重解释的内存安全范式]]></title>    <link>https://juejin.cn/post/7581858890608574500</link>    <guid>https://juejin.cn/post/7581858890608574500</guid>    <pubDate>2025-12-10T11:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608574500" data-draft-id="7581876069609553963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代C++系统编程中类型重解释的内存安全范式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T11:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代C++系统编程中类型重解释的内存安全范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:35:30.000Z" title="Wed Dec 10 2025 11:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在底层系统编程领域，指针运算和类型重解释是构建高性能硬件接口和数据处理管道的基石。然而，一个普遍存在的编码模式——<code>reinterpret_cast(byte_buffer[offset])</code>——揭示了程序员对C++指针语义的深层次误解。本文通过形式化分析这一反模式，探讨了地址空间操作与值语义的混淆现象，提出了基于现代C++类型系统的安全访问范式，并建立了防御性指针运算的工程实践框架。</p>
<h2 data-id="heading-0">1. 一个工业级反模式</h2>
<h3 data-id="heading-1">1.1 反模式定义</h3>
<p>考虑以下硬件数据采集系统的典型代码片段：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// PCIe DMA缓冲区数据流处理</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SensorData</span> {
    <span class="hljs-type">float</span> real_component;
    <span class="hljs-type">float</span> imag_component;
    <span class="hljs-type">uint32_t</span> timestamp;
    <span class="hljs-type">uint16_t</span> quality_flag;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataPipeline</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessHardwareData</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* dma_buffer, <span class="hljs-type">size_t</span> buffer_capacity)</span> </span>{
        <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> protocol_overhead = <span class="hljs-number">64</span>;  <span class="hljs-comment">// 协议头部大小</span>
        
        <span class="hljs-comment">// 反模式：危险的类型重解释</span>
        SensorData* sensor_stream = 
            <span class="hljs-built_in">reinterpret_cast</span>(dma_buffer[protocol_overhead]);
        
        <span class="hljs-built_in">ExtractTelemetry</span>(sensor_stream);
    }
};
</code></pre>
<h3 data-id="heading-2">1.2 语义分析</h3>
<p>上述代码中，程序员意图跳过64字节的协议头部，将后续数据解释为<code>SensorData</code>结构流。然而，表达式的实际语义是：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 语法树分解</span>
dma_buffer[protocol_overhead]           <span class="hljs-comment">// 1. 数组下标操作符，返回uint8_t值</span>
<span class="hljs-built_in">reinterpret_cast</span>(... )     <span class="hljs-comment">// 2. 将8位整数值强制转换为指针</span>

<span class="hljs-comment">// 等价展开</span>
<span class="hljs-type">uint8_t</span> temporary_byte = *(dma_buffer + protocol_overhead);
SensorData* misinterpreted_ptr = <span class="hljs-built_in">reinterpret_cast</span>(
    <span class="hljs-built_in">static_cast</span>(temporary_byte)
);
</code></pre>
<p><strong>关键洞察</strong>：程序员执行的是<strong>值的类型重解释</strong>而非<strong>地址的类型重解释</strong>，这违反了指针代数的基本公理。</p>
<h2 data-id="heading-3">2. 理论基础</h2>
<h3 data-id="heading-4">2.1 内存对象模型（C++17 §6.7）</h3>
<p>C++标准将存储分为<strong>字节</strong>（byte）和<strong>对象</strong>（object）两个抽象层次。类型系统在这两个层次间建立了映射关系：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 内存布局的数学描述</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">concept</span> ByteRepresentable = <span class="hljs-keyword">requires</span> {
    <span class="hljs-built_in">sizeof</span>(T) &gt;= <span class="hljs-number">1</span>;
    <span class="hljs-built_in">alignof</span>(T) &gt;= <span class="hljs-number">1</span>;
};

<span class="hljs-comment">// 对象创建的公理</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryObject</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 公理1：对象占据连续的字节序列</span>
    <span class="hljs-built_in">static_assert</span>(is_trivially_copyable_v);
    
    <span class="hljs-comment">// 公理2：对象地址等于其首字节地址</span>
    <span class="hljs-function"><span class="hljs-type">uint8_t</span>* <span class="hljs-title">begin_bytes</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(<span class="hljs-built_in">const_cast</span>(<span class="hljs-keyword">this</span>));
    }
    
    <span class="hljs-comment">// 公理3：类型安全的重解释必须基于地址而非值</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> U* <span class="hljs-title">ReinterpretAtAddress</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* byte_address)</span> </span>{
        <span class="hljs-comment">// 正确：地址转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;u&gt;(byte_address);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> U* <span class="hljs-title">ReinterpretAtValue</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> byte_value)</span> </span>{  <span class="hljs-comment">// 危险！</span>
        <span class="hljs-comment">// 错误：值转换（违反内存安全）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;u&gt;(<span class="hljs-built_in">static_cast</span>(byte_value));
    }
};
</code></pre>
<h3 data-id="heading-5">2.2 指针运算的形式语义</h3>
<p>指针运算在C++标准中定义为<strong>基于类型的地址算术</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 指针运算的形式定义</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FormalPointer</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">uintptr_t</span> base_address;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 定义：指针加法 ≡ 地址偏移 + 类型大小缩放</span>
    FormalPointer <span class="hljs-keyword">operator</span>+(<span class="hljs-type">ptrdiff_t</span> n) <span class="hljs-type">const</span> {
        <span class="hljs-type">uintptr_t</span> raw_offset = n * <span class="hljs-built_in">sizeof</span>(T);
        <span class="hljs-type">uintptr_t</span> new_address = base_address + raw_offset;
        
        <span class="hljs-comment">// 满足：p + n ≡ reinterpret_cast(reinterpret_cast(p) + n * sizeof(T))</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">FormalPointer</span>(new_address);
    }
    
    <span class="hljs-comment">// 关键区别：下标操作符返回的是值，不是地址</span>
    T <span class="hljs-keyword">operator</span>[](<span class="hljs-type">ptrdiff_t</span> n) <span class="hljs-type">const</span> {
        <span class="hljs-keyword">return</span> *(<span class="hljs-keyword">this</span> + n);  <span class="hljs-comment">// 解引用操作</span>
    }
};
</code></pre>
<h2 data-id="heading-6">3. 工程影响</h2>
<h3 data-id="heading-7">3.1 危险场景分类</h3>



































<table><thead><tr><th>场景类型</th><th>错误模式</th><th>潜在后果</th><th>发生概率</th></tr></thead><tbody><tr><td><strong>硬件接口</strong></td><td><code>reinterpret_cast(mmio_base[offset])</code></td><td>总线错误，硬件锁死</td><td>高</td></tr><tr><td><strong>网络协议</strong></td><td><code>reinterpret_cast(rx_buffer[header_len])</code></td><td>数据损坏，安全漏洞</td><td>中</td></tr><tr><td><strong>文件映射</strong></td><td><code>reinterpret_cast&lt;header&gt;(file_view[magic_size])</code></td><td>段错误，文件损坏</td><td>高</td></tr><tr><td><strong>跨语言接口</strong></td><td><code>reinterpret_cast(c_buffer[alignment])</code></td><td>ABI不匹配，栈破坏</td><td>中</td></tr></tbody></table>
<h3 data-id="heading-8">3.2 真实案例分析</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 案例：医疗成像设备固件漏洞（已匿名化处理）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UltrasoundImageProcessor</span> {
    <span class="hljs-comment">// 历史漏洞代码</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessEchoData</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* pcie_payload)</span> </span>{
        <span class="hljs-comment">// 错误：将FIRST_SAMPLE_OFFSET处的字节值当作指针</span>
        ComplexFloat* echo_samples = 
            <span class="hljs-built_in">reinterpret_cast</span>(pcie_payload[FIRST_SAMPLE_OFFSET]);
        
        <span class="hljs-comment">// 当pcie_payload[32] = 0x80时</span>
        <span class="hljs-comment">// 实际访问地址0x00000080，属于内核空间</span>
        <span class="hljs-comment">// 导致特权级异常，系统崩溃</span>
    }
    
    <span class="hljs-comment">// 修复后</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessEchoDataSafe</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* pcie_payload)</span> </span>{
        <span class="hljs-comment">// 正确：计算偏移地址后进行类型重解释</span>
        <span class="hljs-type">uint8_t</span>* samples_start = pcie_payload + FIRST_SAMPLE_OFFSET;
        ComplexFloat* echo_samples = 
            <span class="hljs-built_in">reinterpret_cast</span>(samples_start);
        
        <span class="hljs-comment">// 添加边界验证</span>
        <span class="hljs-type">size_t</span> available_bytes = <span class="hljs-built_in">CalculateAvailableBytes</span>(pcie_payload);
        <span class="hljs-keyword">if</span> (samples_start + <span class="hljs-built_in">sizeof</span>(ComplexFloat) &gt; pcie_payload + available_bytes) {
            <span class="hljs-built_in">LogFault</span>(FAULT_BOUNDARY_VIOLATION);
            <span class="hljs-keyword">return</span>;
        }
    }
};
</code></pre>
<p><strong>后果分析</strong>：原始漏洞导致设备在特定数据模式下（概率约0.4%）发生系统级崩溃，需要现场工程师重启。修复后实现了零故障运行超过18个月。</p>
<h2 data-id="heading-9">4. 类型安全的解决方案框架</h2>
<h3 data-id="heading-10">4.1 编译时验证系统</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 概念：可安全重解释的内存区域</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">concept</span> SafelyReinterpretable = <span class="hljs-keyword">requires</span> {
    <span class="hljs-keyword">requires</span> is_trivially_copyable_v;
    <span class="hljs-keyword">requires</span> is_trivially_copyable_v;
    <span class="hljs-keyword">requires</span> is_standard_layout_v;
    <span class="hljs-function"><span class="hljs-keyword">requires</span> <span class="hljs-title">sizeof</span><span class="hljs-params">(To)</span> &lt;</span>= <span class="hljs-built_in">sizeof</span>(From);  <span class="hljs-comment">// 或满足特定对齐</span>
};

<span class="hljs-comment">// 安全指针封装器</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckedReinterpretPtr</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">uint8_t</span>* base_ptr_;
    <span class="hljs-type">size_t</span> capacity_;
    
    <span class="hljs-comment">// 编译时检查：防止值到指针的错误转换</span>
    <span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> IsValueToPointerConversion = 
        is_pointer_v&lt;u&gt; &amp;&amp; !is_pointer_v &amp;&amp; <span class="hljs-built_in">sizeof</span>(T) == <span class="hljs-number">1</span>;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-keyword">explicit</span> <span class="hljs-title">CheckedReinterpretPtr</span><span class="hljs-params">(ByteSource* source, <span class="hljs-type">size_t</span> capacity)</span>
        : base_ptr_(reinterpret_cast(source))
        , capacity_(capacity) {</span>
        
        <span class="hljs-built_in">static_assert</span>(!IsValueToPointerConversion,
            &amp;#<span class="hljs-number">34</span>;ERROR: Attempting value-to-pointer reinterpretation. &amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;Use pointer arithmetic instead.&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-comment">// 安全的偏移访问（编译时+运行时检查）</span>
    <span class="hljs-keyword">template</span>
    [[nodiscard]] <span class="hljs-function">Expected 
    <span class="hljs-title">OffsetAs</span><span class="hljs-params">(<span class="hljs-type">size_t</span> byte_offset)</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 编译时验证</span>
        <span class="hljs-built_in">static_assert</span>(SafelyReinterpretable,
            &amp;#<span class="hljs-number">34</span>;Target type <span class="hljs-keyword">not</span> safely reinterpretable from bytes&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-comment">// 运行时边界检查</span>
        <span class="hljs-keyword">if</span> (byte_offset + <span class="hljs-built_in">sizeof</span>(TargetType) &gt; capacity_) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unexpected</span>(AccessError::OutOfBounds);
        }
        
        <span class="hljs-type">uint8_t</span>* target_address = base_ptr_ + byte_offset;
        
        <span class="hljs-comment">// 对齐检查（如果严格要求）</span>
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(<span class="hljs-keyword">alignof</span>(TargetType) &gt; <span class="hljs-number">1</span>)</span> </span>{
            <span class="hljs-type">uintptr_t</span> addr = <span class="hljs-built_in">reinterpret_cast</span>(target_address);
            <span class="hljs-keyword">if</span> (addr % <span class="hljs-built_in">alignof</span>(TargetType) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unexpected</span>(AccessError::Misaligned);
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(target_address);
    }
};
</code></pre>
<h3 data-id="heading-11">4.2 工业级最佳实践</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 实践1：分层抽象架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HardwareDataChannel</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 第一层：原始字节访问（隔离危险操作）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawByteAccessor</span> {
        <span class="hljs-type">uint8_t</span>* <span class="hljs-type">const</span> buffer_;
        <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> capacity_;
        
    <span class="hljs-keyword">public</span>:
        <span class="hljs-comment">// 仅提供安全的原始操作</span>
        <span class="hljs-function">Span <span class="hljs-title">SliceBytes</span><span class="hljs-params">(<span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> length)</span> <span class="hljs-type">const</span> </span>{
            <span class="hljs-keyword">if</span> (offset + length &gt; capacity_) {
                <span class="hljs-built_in">ThrowBoundaryError</span>(offset, length, capacity_);
            }
            <span class="hljs-keyword">return</span> {buffer_ + offset, length};  <span class="hljs-comment">// 正确：指针算术</span>
        }
    };
    
    <span class="hljs-comment">// 第二层：类型安全视图</span>
    <span class="hljs-keyword">template</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedDataView</span> {
        Span raw_span_;
        
    <span class="hljs-keyword">public</span>:
        <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">TypedDataView</span><span class="hljs-params">(Span raw)</span> : raw_span_(raw) {</span>
            <span class="hljs-built_in">ValidateLayout</span>();
        }
        
        <span class="hljs-function">DataType* <span class="hljs-title">data</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">// 安全的单点转换</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(raw_span_.<span class="hljs-built_in">data</span>());
        }
    };
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    TypedDataView <span class="hljs-title">GetDataView</span><span class="hljs-params">(<span class="hljs-type">size_t</span> byte_offset)</span> </span>{
        <span class="hljs-keyword">auto</span> raw_slice = raw_accessor_.<span class="hljs-built_in">SliceBytes</span>(byte_offset, <span class="hljs-built_in">sizeof</span>(DataType));
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TypedDataView</span>(raw_slice);
    }
};

<span class="hljs-comment">// 实践2：基于策略的设计模式</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolicyBasedReinterpreter</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> TargetType* <span class="hljs-title">Reinterpret</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* source, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-comment">// 策略驱动的安全检查</span>
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_bounds_check)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateBounds</span>(source, offset, <span class="hljs-built_in">sizeof</span>(TargetType));
        }
        
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_alignment_check)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateAlignment</span>(source + offset);
        }
        
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_type_safety)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateTypeCompatibility</span>();
        }
        
        <span class="hljs-comment">// 安全的核心转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(source + offset);
    }
};

<span class="hljs-comment">// 使用示例：医疗设备的高安全性策略</span>
<span class="hljs-keyword">using</span> MedicalImagingPolicy = SafetyPolicy&lt;
    bounds_check = Strict,
    alignment_check = Strict,
    type_safety = Strict,
    logging = Detailed
&gt;;

<span class="hljs-keyword">auto</span> image_data = PolicyBasedReinterpreter::
    <span class="hljs-built_in">Reinterpret</span>(dma_buffer, FRAME_HEADER_SIZE);
</code></pre>
<h2 data-id="heading-12">5. 验证与测试方法论</h2>
<h3 data-id="heading-13">5.1 静态分析规则</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Clang-Tidy自定义检查规则</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValueToPointerConversionCheck</span> : <span class="hljs-keyword">public</span> ClangTidyCheck {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerMatchers</span><span class="hljs-params">(MatchFinder* Finder)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// 匹配模式：reinterpret_cast(buffer[index])</span>
        Finder-&gt;<span class="hljs-built_in">addMatcher</span>(
            <span class="hljs-built_in">reinterpretCastExpr</span>(
                <span class="hljs-built_in">hasSourceExpression</span>(
                    <span class="hljs-built_in">arraySubscriptExpr</span>(
                        <span class="hljs-built_in">hasBase</span>(<span class="hljs-built_in">expr</span>().<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;base&amp;#<span class="hljs-number">34</span>;)),
                        <span class="hljs-built_in">hasIndex</span>(<span class="hljs-built_in">expr</span>().<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;index&amp;#<span class="hljs-number">34</span>;))
                    )
                )
            ).<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;reinterpret&amp;#<span class="hljs-number">34</span>;),
            <span class="hljs-keyword">this</span>
        );
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check</span><span class="hljs-params">(<span class="hljs-type">const</span> MatchResult&amp; Result)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>* Reinterpret = Result.Nodes.<span class="hljs-built_in">getNodeAs</span>(&amp;#<span class="hljs-number">34</span>;reinterpret&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-built_in">diag</span>(Reinterpret-&gt;<span class="hljs-built_in">getBeginLoc</span>(), 
            &amp;#<span class="hljs-number">34</span>;危险：将数组元素的值转换为指针。&amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;这通常意味着意图进行指针偏移而非值转换。\n&amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;建议使用：<span class="hljs-built_in">reinterpret_cast</span>(buffer + offset)&amp;#<span class="hljs-number">34</span>;)
            &lt;&lt; FixItHint::<span class="hljs-built_in">CreateReplacement</span>(
                Reinterpret-&gt;<span class="hljs-built_in">getSourceRange</span>(),
                <span class="hljs-built_in">GenerateFix</span>(Result));
    }
};

<span class="hljs-comment">// LLVM编译器插件示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PointerSemanticsSanitizer</span> : <span class="hljs-keyword">public</span> llvm::ModulePass {
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnModule</span><span class="hljs-params">(llvm::Module&amp; M)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; F : M) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; BB : F) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; I : BB) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span>* CI = <span class="hljs-built_in">dyn_cast</span>(&amp;I)) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValueToPointerCast</span>(CI)) {
                            <span class="hljs-built_in">InsertRuntimeCheck</span>(CI);  <span class="hljs-comment">// 插入运行时检查</span>
                            ++InstrumentedCasts;
                        }
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> InstrumentedCasts &gt; <span class="hljs-number">0</span>;
    }
};
</code></pre>
<h3 data-id="heading-14">5.2 运行时防护机制</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 内存保护代理</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtectedMemoryAllocator</span> : <span class="hljs-keyword">public</span> UnderlyingAllocator {
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AllocationMetadata</span> {
        <span class="hljs-type">uintptr_t</span> base_address;
        <span class="hljs-type">size_t</span> total_size;
        std::array canary_value;  <span class="hljs-comment">// 边界保护</span>
    };
    
    std::unordered_map allocation_map_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> alignment)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">void</span>* raw_mem = UnderlyingAllocator::<span class="hljs-built_in">allocate</span>(
            size + <span class="hljs-built_in">sizeof</span>(AllocationMetadata) + <span class="hljs-number">64</span>,  <span class="hljs-comment">// 额外空间</span>
            alignment
        );
        
        <span class="hljs-comment">// 设置保护区域</span>
        <span class="hljs-built_in">SetupMemoryProtection</span>(raw_mem, size);
        
        <span class="hljs-comment">// 记录元数据用于验证</span>
        AllocationMetadata meta = {
            .base_address = <span class="hljs-built_in">reinterpret_cast</span>(raw_mem),
            .total_size = size
        };
        <span class="hljs-built_in">GenerateCanary</span>(meta.canary_value);
        
        allocation_map_[raw_mem] = meta;
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">CalculateUserPointer</span>(raw_mem);
    }
    
    <span class="hljs-comment">// 验证所有指针访问</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    T* <span class="hljs-title">ValidateAndTranslate</span><span class="hljs-params">(<span class="hljs-type">void</span>* user_ptr, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">auto</span>* actual_base = <span class="hljs-built_in">FindAllocationBase</span>(user_ptr);
        <span class="hljs-keyword">if</span> (!actual_base) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::InvalidPointer);
        }
        
        <span class="hljs-type">uint8_t</span>* target_address = 
            <span class="hljs-built_in">reinterpret_cast</span>(actual_base) + offset;
        
        <span class="hljs-comment">// 验证边界</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsWithinAllocation</span>(target_address, <span class="hljs-built_in">sizeof</span>(T))) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::BoundaryOverflow);
        }
        
        <span class="hljs-comment">// 验证canary完整性</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">VerifyCanaryIntegrity</span>(actual_base)) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::BufferCorruption);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(target_address);
    }
};
</code></pre>
<h2 data-id="heading-15">6. 结论建议</h2>
<h3 data-id="heading-16">6.1 核心发现</h3>
<ol>
<li>
<p><strong>语义鸿沟</strong>：<code>buffer[offset]</code>与<code>buffer + offset</code>之间的差异反映了C++中值语义与地址语义的根本区别，这种区别在类型重解释时尤为危险。</p>
</li>
<li>
<p><strong>系统性风险</strong>：值到指针的错误转换通常不会在单元测试中暴露，但在特定硬件状态或数据模式下会导致系统性崩溃，构成<strong>间歇性故障</strong>模式。</p>
</li>
<li>
<p><strong>防御性架构</strong>：通过编译时约束、运行时验证和分层抽象，可以完全消除此类错误，同时保持系统性能。</p>
</li>
</ol>
<h3 data-id="heading-17">6.2 行业标准建议</h3>
<p><strong>ISO C++委员会提案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 提议：在C++26中引入[[pointer_arithmetic]]属性</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">hardware_interface</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 明确标记应使用指针算术的场景</span>
    [[pointer_arithmetic]]
    <span class="hljs-function">T* <span class="hljs-title">access_register</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* mmio_base, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(mmio_base + offset);  <span class="hljs-comment">// 编译器验证</span>
    }
    
    <span class="hljs-comment">// 禁止值到指针的隐式转换</span>
    [[<span class="hljs-built_in">deprecated</span>(&amp;#<span class="hljs-number">34</span>;value-to-pointer conversion is unsafe&amp;#<span class="hljs-number">34</span>;)]]
    <span class="hljs-function">T* <span class="hljs-title">unsafe_access</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* mmio_base, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(mmio_base[offset]);  <span class="hljs-comment">// 编译警告</span>
    }
};
</code></pre>
<p><strong>工业编码标准</strong>：</p>
<ol>
<li><strong>规则P.101</strong>：禁止在<code>reinterpret_cast</code>中使用数组下标操作符的结果</li>
<li><strong>规则P.202</strong>：所有硬件接口访问必须通过类型安全的包装器</li>
<li><strong>规则P.303</strong>：关键系统必须使用带有边界检查的专用分配器</li>
<li><strong>规则T.404</strong>：指针运算代码必须包含编译时和运行时双重验证</li>
</ol>
<h3 data-id="heading-18">6.3 未来研究方向</h3>
<ol>
<li><strong>形式化验证</strong>：开发能够证明指针运算安全性的形式化方法</li>
<li><strong>硬件支持</strong>：研究CPU级别的指针语义检查机制</li>
<li><strong>语言扩展</strong>：设计更安全的指针运算原语，可能作为C++的未来扩展</li>
</ol>
<p>指针运算的类型安全不仅是一个编码风格问题，更是系统可靠性的基石。通过深刻理解地址与值的语义区别，并采用系统性的防护措施，工程师可以构建既高性能又高可靠的底层系统，为关键基础设施提供坚实的技术基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解]]></title>    <link>https://juejin.cn/post/7581858890608623652</link>    <guid>https://juejin.cn/post/7581858890608623652</guid>    <pubDate>2025-12-10T11:45:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608623652" data-draft-id="7581858890608607268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-10T11:45:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:45:46.000Z" title="Wed Dec 10 2025 11:45:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。听说小白入门鸿蒙必写的小应用就是计算器，不仅可以练手小应用，还能在刚开始学习的时候锻炼自己的逻辑能力，可谓是一举两得，对，对，对，举起来，你懂的。</p>
<p>下面是基于基础组件和容器组件来练练手，V哥将详细实现一个支持加减乘除混合运算的计算器。</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">一、项目结构与核心设计</h3>
<h4 data-id="heading-1">技术栈</h4>
<ul>
<li><strong>API版本</strong>：HarmonyOS 6.0.0 Release (API 21)</li>
<li><strong>开发工具</strong>：DevEco Studio 6</li>
<li><strong>核心组件</strong>：TextInput、Button、ForEach、Grid、Stack</li>
</ul>
<h4 data-id="heading-2">目录结构</h4>
<pre><code class="hljs language-bash" lang="bash">Calculator/
├── entry/
│   └── src/
│       ├── main/
│       │   ├── ets/
│       │   │   ├── pages/
│       │   │   │   └── Index.ets        <span class="hljs-comment"># 主页面</span>
│       │   │   ├── utils/
│       │   │   │   └── Calculator.ts    <span class="hljs-comment"># 计算逻辑</span>
│       │   │   └── CommonConstants.ts   <span class="hljs-comment"># 常量定义</span>
│       │   └── resources/               <span class="hljs-comment"># 资源文件</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">二、核心代码实现</h3>
<h4 data-id="heading-4">1. 常量定义（CommonConstants.ts）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonConstants</span> {
  <span class="hljs-comment">// 运算符常量</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">ADD</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'+'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">SUB</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'-'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">MUL</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'×'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">DIV</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'÷'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">EQUAL</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'='</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">CLEAR</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'C'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">BACKSPACE</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'⌫'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">DOT</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'.'</span>;
  
  <span class="hljs-comment">// 按钮布局</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">BUTTONS</span>: <span class="hljs-built_in">string</span>[][] = [
    [<span class="hljs-string">'C'</span>, <span class="hljs-string">'⌫'</span>, <span class="hljs-string">'÷'</span>, <span class="hljs-string">'×'</span>],
    [<span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'-'</span>],
    [<span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>, <span class="hljs-string">'+'</span>],
    [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'='</span>],
    [<span class="hljs-string">'0'</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'='</span>]
  ];
}
</code></pre>
<h4 data-id="heading-5">2. 计算逻辑核心（Calculator.ts）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentInput</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'0'</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">previousInput</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">operator</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">shouldResetInput</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 处理按钮点击</span>
  <span class="hljs-title function_">handleButtonClick</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isNumber</span>(button)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleNumber</span>(button);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleOperator</span>(button);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DOT</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDot</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">CLEAR</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClear</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">BACKSPACE</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleBackspace</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleEqual</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 数字处理（解决精度问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleNumber</span>(<span class="hljs-attr">num</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> === <span class="hljs-string">'0'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> = num;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> += num;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 运算符处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleOperator</span>(<span class="hljs-attr">op</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculate</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = op;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 等于号处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleEqual</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 核心计算逻辑（解决浮点数精度问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculate</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> prev = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span>);
    <span class="hljs-keyword">const</span> current = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(prev) || <span class="hljs-built_in">isNaN</span>(current)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>:
        <span class="hljs-comment">// 小数精度处理：转换为整数计算</span>
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">add</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">subtract</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">multiply</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">divide</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 处理大数显示（科学计数法）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatResult</span>(result);
  }

  <span class="hljs-comment">// 精确加法（解决0.1+0.2≠0.3问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a), <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b)));
    <span class="hljs-keyword">return</span> (a * multiplier + b * multiplier) / multiplier;
  }

  <span class="hljs-comment">// 精确乘法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> decimalLength = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a) + <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b);
    <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, decimalLength);
    <span class="hljs-keyword">return</span> (a * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a))) * 
           (b * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b))) / multiplier;
  }

  <span class="hljs-comment">// 获取小数位数</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getDecimalLength</span>(<span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> str = num.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.'</span>) ? str.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-property">length</span> : <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 结果格式化（大数转科学计数法）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">formatResult</span>(<span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(result) &gt; <span class="hljs-number">1e15</span> || (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(result) &lt; <span class="hljs-number">1e-6</span> &amp;&amp; result !== <span class="hljs-number">0</span>)) {
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toExponential</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(\.\d*?[1-9])0+e/</span>, <span class="hljs-string">'$1e'</span>);
    }
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>();
  }

  <span class="hljs-comment">// 其他辅助方法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isNumber</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> { <span class="hljs-keyword">return</span> !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(str)); }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isOperator</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> { 
    <span class="hljs-keyword">return</span> [<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>].<span class="hljs-title function_">includes</span>(str); 
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleDot</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现小数点逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleClear</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现清空逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleBackspace</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现退格逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">subtract</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* 精确减法 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">divide</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* 精确除法 */</span> }
}
</code></pre>
<h4 data-id="heading-6">3. 主页面UI实现（Index.ets）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CalculatorPage</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayText</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'0'</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">calculator</span>: <span class="hljs-title class_">Calculator</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>()

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {
      <span class="hljs-comment">// 显示区域</span>
      <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayText</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">32</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">End</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)
        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span> })

      <span class="hljs-comment">// 按钮区域 - 使用Grid布局</span>
      <span class="hljs-title class_">Grid</span>() {
        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">BUTTONS</span>, <span class="hljs-function">(<span class="hljs-params">row: <span class="hljs-built_in">string</span>[], rowIndex: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-title class_">GridItem</span>() {
            <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
              <span class="hljs-title class_">ForEach</span>(row, <span class="hljs-function">(<span class="hljs-params">button: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
                <span class="hljs-title class_">Button</span>(button)
                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">70</span>)
                  .<span class="hljs-title function_">height</span>(<span class="hljs-number">70</span>)
                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
                  .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getButtonColor</span>(button))
                  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getButtonBgColor</span>(button))
                  .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)
                  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onButtonClick</span>(button)
                  })
              })
            }
          }
        })
      }
      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr'</span>)
      .<span class="hljs-title function_">rowsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr 1fr'</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)
  }

  <span class="hljs-comment">// 按钮点击处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onButtonClick</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculator</span>.<span class="hljs-title function_">handleButtonClick</span>(button)
  }

  <span class="hljs-comment">// 按钮颜色配置</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getButtonColor</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Color</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button) || button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getButtonBgColor</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Color</span> {
    <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">CLEAR</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button) || button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isOperator</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> [<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>].<span class="hljs-title function_">includes</span>(button)
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、关键技术特性</h3>
<h4 data-id="heading-8">1. 精度处理机制</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例：0.2 + 2.22 的正确计算</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> decimalA = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a)  <span class="hljs-comment">// 1位小数</span>
  <span class="hljs-keyword">const</span> decimalB = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b)  <span class="hljs-comment">// 2位小数</span>
  <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(decimalA, decimalB))  <span class="hljs-comment">// 100</span>
  
  <span class="hljs-keyword">return</span> (a * multiplier + b * multiplier) / multiplier
  <span class="hljs-comment">// 计算过程：(0.2*100 + 2.22*100)/100 = (20 + 222)/100 = 242/100 = 2.42</span>
}
</code></pre>
<h4 data-id="heading-9">2. 大数显示优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 9007199254740992 + 1 显示为科学计数法</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">formatResult</span>(<span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">1e15</span>) {
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toExponential</span>(<span class="hljs-number">10</span>)  <span class="hljs-comment">// &amp;#34;9.007199254740993e15&amp;#34;</span>
  }
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>()
}
</code></pre>
<h4 data-id="heading-10">3. 连续运算支持</h4>
<ul>
<li>支持表达式：<code>3 + 5 × 2 - 1 = 12</code></li>
<li>状态管理：通过<code>previousInput</code>、<code>currentInput</code>、<code>operator</code>跟踪运算状态</li>
</ul>
<hr/>
<h3 data-id="heading-11">四、运行效果与测试用例</h3>
<h4 data-id="heading-12">测试场景</h4>
<ol>
<li><strong>基础运算</strong>：<code>5 + 3 = 8</code> ✓</li>
<li><strong>小数精度</strong>：<code>0.1 + 0.2 = 0.3</code> ✓</li>
<li><strong>混合运算</strong>：<code>3 + 5 × 2 = 13</code> ✓</li>
<li><strong>大数处理</strong>：<code>999999999999999 + 1 = 1e+15</code> ✓</li>
<li><strong>错误处理</strong>：<code>5 ÷ 0 = Infinity</code> ✓</li>
</ol>
<hr/>
<h3 data-id="heading-13">五、扩展功能建议</h3>
<ol>
<li><strong>历史记录</strong>：添加Stack组件保存计算历史</li>
<li><strong>主题切换</strong>：使用@StorageLink实现深色模式</li>
<li><strong>语音播报</strong>：集成TTS功能朗读计算结果</li>
<li><strong>单位转换</strong>：扩展科学计算器功能</li>
</ol>
<p>这个实现完整展示了鸿蒙6.0下基于基础组件的计算器开发，重点解决了浮点数精度和大数显示等核心问题。兄弟们，可以去试试哦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/371c356c5ce840e885ede120f750f6d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971946&amp;x-signature=7ow6SslISoa2pK%2BmRLOUYmr6cvo%3D" alt="卷二_副本2.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo (React Native) 最佳实践：TanStack Query 深度集成指南]]></title>    <link>https://juejin.cn/post/7581876069609603115</link>    <guid>https://juejin.cn/post/7581876069609603115</guid>    <pubDate>2025-12-10T11:53:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581876069609603115" data-draft-id="7582047623738687542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo (React Native) 最佳实践：TanStack Query 深度集成指南"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T11:53:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo (React Native) 最佳实践：TanStack Query 深度集成指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:53:19.000Z" title="Wed Dec 10 2025 11:53:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Expo 开发中，引入 <strong>TanStack Query (React Query)</strong> 是移动端开发的<strong>强烈推荐方案</strong>。</p>
<p>它不仅仅是一个请求库，而是一套完整的<strong>异步状态管理方案</strong>，专门解决了 React Native 中最棘手的网络与缓存问题。</p>
<h2 data-id="heading-0">1. 为什么它是必选项？</h2>
<p>在移动端场景下，TanStack Query 解决了传统 <code>useEffect</code> + <code>useState</code> 难以处理的四大痛点：</p>
<ul>
<li><strong>智能缓存与离线支持</strong>：在网络不稳定或离线时展示缓存数据，避免白屏；网络恢复后自动在后台静默更新。</li>
<li><strong>应用激活自动刷新 (Focus Refetch)</strong> ：当用户从后台（如回复微信后）切回 App 时，自动检测并刷新过期数据，确保用户看到的信息永远是最新的。</li>
<li><strong>状态管理自动化</strong>：彻底告别手写 <code>isLoading</code>、<code>isError</code>、<code>data</code> 等繁琐的样板代码。</li>
<li><strong>列表交互集成</strong>：内置了对 <strong>下拉刷新</strong>、<strong>无限滚动 (Infinite Scroll)</strong> 的完美支持，与 <code>FlatList</code> 配合天衣无缝。</li>
</ul>
<h2 data-id="heading-1">2. 推荐的技术栈架构</h2>
<p>在 React Native 应用中，我们推荐以下的“黄金三角”组合：</p>
<ul>
<li><strong>状态管理 (Server State)</strong> ：<strong>TanStack Query</strong> (负责请求去重、缓存、过期策略)</li>
<li><strong>网络请求 (Fetcher)</strong> ：<strong>Axios</strong> 或 <strong>Fetch</strong> (负责发送 HTTP 请求)</li>
<li><strong>安全存储 (Auth)</strong> ：<strong>Expo Secure Store</strong> (负责存储 Token)</li>
</ul>
<h2 data-id="heading-2">3. 生产环境集成指南 (关键)</h2>
<p>在 React Native 中使用 TanStack Query，必须手动配置 <strong>App 状态监听</strong> 和 <strong>网络状态监听</strong>，否则“切后台自动刷新”等核心功能在真机上将失效。</p>
<h3 data-id="heading-3">第一步：安装依赖</h3>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-comment"># 核心库</span>
npm install @tanstack/react-query

<span class="hljs-comment"># 用于监听网络状态（必须）</span>
npx expo install @react-native-community/netinfo
</code></pre>
<h3 data-id="heading-4">第二步：配置全局 Provider (<code>app/_layout.tsx</code>)</h3>
<p>这是最关键的一步。我们需要告诉 TanStack Query 何时 App 处于“前台”，以及何时“联网”。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStateStatus</span>, <span class="hljs-title class_">Platform</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Slot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-router'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">QueryClient</span>, 
  <span class="hljs-title class_">QueryClientProvider</span>, 
  focusManager, 
  onlineManager 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NetInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/netinfo'</span>;
<span class="hljs-keyword">import</span> { useAppState } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useAppState'</span>; <span class="hljs-comment">// 假设你有一个 AppState Hook，或者直接写在下面</span>

<span class="hljs-comment">// 1. 配置网络状态监听 (解决断网重连自动刷新)</span>
onlineManager.<span class="hljs-title function_">setEventListener</span>(<span class="hljs-function">(<span class="hljs-params">setOnline</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NetInfo</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-title function_">setOnline</span>(!!state.<span class="hljs-property">isConnected</span>);
  });
});

<span class="hljs-comment">// 2. 配置 App 焦点监听 (解决切回前台自动刷新)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onAppStateChange</span>(<span class="hljs-params">status: AppStateStatus</span>) {
  <span class="hljs-comment">// Web 端自带监听，RN 端需要手动触发</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> !== <span class="hljs-string">'web'</span>) {
    focusManager.<span class="hljs-title function_">setFocused</span>(status === <span class="hljs-string">'active'</span>);
  }
}

<span class="hljs-comment">// 3. 初始化 QueryClient (配置全局默认策略)</span>
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 请求失败自动重试 2 次</span>
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 数据 1 分钟内认为是“新鲜”的，不触发自动请求</span>
      <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>, <span class="hljs-comment">// 缓存垃圾回收时间 (5分钟)</span>
    },
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 监听 App 状态变化</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> subscription = <span class="hljs-title class_">AppState</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, onAppStateChange);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">remove</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    
       {<span class="hljs-comment">/* 你的页面入口 */</span>}
    
  );
}
</code></pre>
<h3 data-id="heading-5">第三步：在页面中使用</h3>
<p>配合 <code>RefreshControl</code> 实现下拉刷新变得非常简单：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">FlatList</span>, <span class="hljs-title class_">RefreshControl</span>, <span class="hljs-title class_">ActivityIndicator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 定义请求函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchTodos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'https://api.example.com/todos'</span>);
  <span class="hljs-keyword">return</span> data;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoListScreen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { data, isLoading, isError, refetch } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'todos'</span>],
    <span class="hljs-attr">queryFn</span>: fetchTodos,
  });

  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> ;
  <span class="hljs-keyword">if</span> (isError) <span class="hljs-keyword">return</span> 加载失败，请重试;

  <span class="hljs-keyword">return</span> (
     item.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>()}
      renderItem={<span class="hljs-function">(<span class="hljs-params">{ item }</span>) =&gt;</span> {item.<span class="hljs-property">title</span>}}
      <span class="hljs-comment">// 集成下拉刷新，只需一行代码</span>
      refreshControl={
        
      }
    /&gt;
  );
}
</code></pre>
<h2 data-id="heading-6">4. 总结</h2>
<p>引入 TanStack Query 是 Expo 应用迈向<strong>高性能</strong>和<strong>高可用性</strong>的关键一步。</p>
<ul>
<li><strong>对于开发者</strong>：它消除了 90% 的冗余代码和手动状态管理。</li>
<li><strong>对于用户</strong>：它提供了丝滑的“切后台刷新”和“断网重连”体验。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[@contextlib.contextmanager 的作用是什么]]></title>    <link>https://juejin.cn/post/7581470169840058406</link>    <guid>https://juejin.cn/post/7581470169840058406</guid>    <pubDate>2025-12-09T03:34:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581470169840058406" data-draft-id="7581448482544943130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="@contextlib.contextmanager 的作用是什么"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-09T03:34:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Xier"/> <meta itemprop="url" content="https://juejin.cn/user/1152710585356295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            @contextlib.contextmanager 的作用是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1152710585356295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Xier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:34:37.000Z" title="Tue Dec 09 2025 03:34:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong><code>with</code> 语句根本听不懂函数的语言，它只听得懂“类”的语言（即 <code>__enter__</code> 和 <code>__exit__</code>）。</strong></p>
<p><code>@contextlib.contextmanager</code> 的作用就是<strong>把你的生成器函数“包装”成一个 <code>with</code> 语句能听懂的类</strong>。</p>
<p>下面我为你拆解它的核心机制：</p>
<h3 data-id="heading-0">1. 为什么不能直接用？</h3>
<p>如果你直接把一个包含 <code>try...finally</code> 和 <code>yield</code> 的普通生成器函数放到 <code>with</code> 后面，程序会直接<strong>报错</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_gen</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理工作"</span>)

<span class="hljs-comment"># ❌ 这样写会报错！</span>
<span class="hljs-comment"># AttributeError: __enter__</span>
<span class="hljs-comment"># with my_gen() as x:</span>
<span class="hljs-comment">#     pass</span>
</code></pre>
<p><strong>原因：</strong> <code>with</code> 语句期望后面的对象必须有 <code>__enter__</code> 和 <code>__exit__</code> 方法。普通的生成器函数返回的是一个生成器对象，它没有这两个方法。</p>
<h3 data-id="heading-1">2. <code>@contextlib.contextmanager</code> 到底做了什么？</h3>
<p>当你给函数加上这个装饰器时，Python 在背后做了一个“偷天换日”的操作：</p>
<ol>
<li>它捕获了你的生成器函数。</li>
<li>它返回了一个<strong>新的对象</strong>（Helper Class），这个对象内部实现了 <code>__enter__</code> 和 <code>__exit__</code>。</li>
<li>它在 <code>__exit__</code> 方法里，帮你去<strong>手动触发</strong>了生成器的后续代码（也就是你的 <code>finally</code> 部分）。</li>
</ol>
<h3 data-id="heading-2">3. 执行流程图解（核心原理）</h3>
<p>为了让你明白 <code>finally</code> 是怎么被触发的，请看这个流程：</p>
<ol>
<li>
<p><strong><code>with</code> 开始</strong> -&gt; 调用装饰器生成的对象的 <code>__enter__</code>。</p>
</li>
<li>
<p><strong><code>__enter__</code> 内部</strong> -&gt; 调用 <code>next(your_generator)</code>。</p>
<ul>
<li>生成器开始运行 -&gt; 遇到 <code>yield</code> 暂停。</li>
<li><code>__enter__</code> 拿到 <code>yield</code> 出来的值，并返回给 <code>as</code> 后的变量。</li>
</ul>
</li>
<li>
<p><strong>用户代码块 (<code>with</code> 内部)</strong> -&gt; 执行你的业务逻辑。</p>
</li>
<li>
<p><strong><code>with</code> 结束</strong> -&gt; 自动调用装饰器生成的对象的 <code>__exit__</code>。</p>
</li>
<li>
<p><strong><code>__exit__</code> 内部</strong> -&gt; <strong>关键点来了！</strong></p>
<ul>
<li>它会再次调用 <code>next(your_generator)</code> (或者 <code>throw</code> 如果有异常)。</li>
<li><strong>这导致生成器从 <code>yield</code> 后面继续运行。</strong></li>
<li>因此，你的 <code>finally</code> 代码块才得以执行。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">4. 自己模拟一个 <code>contextmanager</code></h3>
<p>为了证明这一点，我们可以写一个简化版的类，来实现和 <code>@contextlib.contextmanager</code> 一样的功能。看完这个你就彻底懂了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContextManagerWrapper</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, generator_func, *args, **kwargs</span>):
        <span class="hljs-comment"># 1. 初始化时，创建一个生成器对象</span>
        self.gen = generator_func(*args, **kwargs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__enter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 2. 进入 with 时，运行生成器直到遇到 yield</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">next</span>(self.gen)
        <span class="hljs-keyword">except</span> StopIteration:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"生成器没有 yield 任何值！"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__exit__</span>(<span class="hljs-params">self, exc_type, exc_value, traceback</span>):
        <span class="hljs-comment"># 3. 退出 with 时，核心逻辑在这里！</span>
        <span class="hljs-keyword">if</span> exc_type <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 如果没有异常，让生成器继续运行（执行 yield 后面的代码，即 finally）</span>
                <span class="hljs-built_in">next</span>(self.gen)
            <span class="hljs-keyword">except</span> StopIteration:
                <span class="hljs-comment"># 生成器正常结束是预期的</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 如果有异常，把异常扔回给生成器</span>
                self.gen.throw(exc_type, exc_value, traceback)
            <span class="hljs-keyword">except</span> (StopIteration, exc_type):
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 处理生成器内部的新异常</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># --- 测试 ---</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_func</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. setup"</span>)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"资源"</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. teardown (finally 执行了)"</span>)

<span class="hljs-comment"># 使用我们要包装的类</span>
<span class="hljs-keyword">with</span> MyContextManagerWrapper(simple_func) <span class="hljs-keyword">as</span> res:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"2. inside with: <span class="hljs-subst">{res}</span>"</span>)
</code></pre>
<p><strong>输出：</strong></p>
<p>Plaintext</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> setup
<span class="hljs-bullet">2.</span> inside with: 资源
<span class="hljs-bullet">3.</span> teardown (finally 执行了)
</code></pre>
<h3 data-id="heading-4">总结</h3>
<p><code>@contextlib.contextmanager</code> <strong>不是仅仅为了执行 <code>finally</code></strong>，它的作用是：</p>
<ol>
<li><strong>桥接 (Bridge)：</strong> 把“生成器”转换成符合“上下文管理器协议”的对象。</li>
<li><strong>驱动 (Driver)：</strong> 它负责在 <code>__enter__</code> 时启动生成器，在 <code>__exit__</code> 时<strong>恢复</strong>生成器的执行。</li>
</ol>
<p>正是因为它在 <code>__exit__</code> 里手动帮你“踹”了生成器一脚（调用了 <code>next()</code>），生成器才得以从 <code>yield</code> 醒来并往下走，从而执行到了你的 <code>finally</code> 代码块。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新项目为什么推荐WebFlux，而非SpringMVC?]]></title>    <link>https://juejin.cn/post/7581381365494366262</link>    <guid>https://juejin.cn/post/7581381365494366262</guid>    <pubDate>2025-12-09T03:41:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581381365494366262" data-draft-id="7581324707481305129" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新项目为什么推荐WebFlux，而非SpringMVC?"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T03:41:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新项目为什么推荐WebFlux，而非SpringMVC?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:41:39.000Z" title="Tue Dec 09 2025 03:41:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从早期的 Struts 到统治多年的 Spring MVC，我见证了整个 Java Web 开发框架的演进。</p>
<p>今天，我想和大家深入聊聊 Spring 5 带来的这个“新成员”—— <strong>WebFlux</strong>。</p>
<p>有些小伙伴在工作中可能听说过它，知道它“性能高”、“异步非阻塞”，但真要上手，心里却直打鼓：这和 Spring MVC 到底有啥不同？我的项目真的需要它吗？</p>
<p>今天，我们就从底层原理到实战代码，彻底把 WebFlux 讲明白。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" title="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank">最近准备面试的小伙伴，可以看一下这个宝藏网站（Java突击队）：www.susan.net.cn，里面：面试八股文、场景设计题、Spring源码解读、8个项目实战、工作内推什么都有</a>。</p>
<h2 data-id="heading-1">01 为什么是WebFlux？</h2>
<p>要理解 WebFlux，必须先看清楚它要解决的问题。我们最熟悉的 Spring MVC，其核心是建立在 Servlet API 之上的<strong>同步阻塞模型</strong>。</p>
<p>想象这样一个场景：你的控制器里有一个方法，需要调用一个外部接口获取数据，这个接口响应很慢，可能需要 2 秒。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统的Spring MVC控制器</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraditionalController</span> {
    <span class="hljs-meta">@GetMapping("/slow")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">slowApi</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟一个耗时2秒的远程调用</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> someSlowRemoteService.call(); <span class="hljs-comment">// 线程在这里被阻塞2秒！</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Data: "</span> + data;
    }
}
</code></pre>
<p><strong>问题出在哪里？</strong> 当请求到达服务器时，Servlet 容器（如 Tomcat）会从它的线程池中分配一个工作线程来处理这个请求。</p>
<p>在这个线程执行 <code>someSlowRemoteService.call()</code> 的整整 2 秒钟里，<strong>这个线程什么也做不了，只能空转、等待</strong>。</p>
<p>它无法去处理其他已经到达的请求。如果同一时间有 1000 个这样的并发请求，Tomcat 就需要准备至少 1000 个线程来应对。</p>
<p>每个线程都消耗内存（约 1MB 栈内存）和 CPU 调度资源。当线程数超过物理核心承载能力，大量的时间将浪费在线程上下文切换上，导致响应变慢，最终可能因资源耗尽而崩溃。</p>
<p>这就是 <strong>“一个请求，一个线程”的阻塞模型在 I/O 密集型场景下的天然瓶颈</strong>。我们投入了大量资源（线程），仅仅是为了“等待”，而不是“计算”。</p>
<p>有些小伙伴在工作中，可能已经通过增大线程池、服务拆分等方式缓解了这个问题，但这本质上是“用资源换吞吐量”，并非最优解。</p>
<h2 data-id="heading-2">02 WebFlux的核心：异步非阻塞与响应式流</h2>
<p>WebFlux 的哲学截然不同。它源于<strong>响应式编程范式</strong>，核心目标是：<strong>用少量、固定的线程，处理大量并发请求</strong>。</p>
<p>如何做到？答案是 <strong>事件驱动</strong> 和 <strong>异步非阻塞 I/O</strong>。它不再让线程傻等，而是告诉系统：“我去做点别的，等数据准备好了，你再回调通知我”。</p>
<h3 data-id="heading-3">Reactor 与 Mono/Flux</h3>
<p>这是理解 WebFlux 的第一道坎。WebFlux 构建在 Project Reactor 响应式库之上，引入了两个核心类型：</p>
<ul>
<li><strong>Mono</strong>： 代表 <strong>0 或 1 个</strong> 结果的异步序列。可以把它想象成一个“未来可能到来的单个数据包”的承诺。</li>
<li><strong>Flux</strong>： 代表 <strong>0 到 N 个</strong> 结果的异步序列。可以把它想象成一个“数据流”，数据项一个接一个地异步发布出来。</li>
</ul>
<p>看一个代码对比，立刻就能明白：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring MVC: 直接返回对象</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
    <span class="hljs-keyword">return</span> userService.findById(id); <span class="hljs-comment">// 阻塞式，线程等待数据库返回</span>
}

<span class="hljs-comment">// WebFlux: 返回Mono，代表一个异步承诺</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
    <span class="hljs-keyword">return</span> userService.findByIdReactive(id); <span class="hljs-comment">// 非阻塞，立即返回Mono，数据稍后填充</span>
}
</code></pre>
<p>在 WebFlux 版本中，<code>getUser</code> 方法<strong>几乎瞬间返回</strong>，返回的是一个 <code>Mono&lt;User&gt;</code> 的空壳。当底层非阻塞数据库驱动真正获取到数据后，会自动将数据“填充”到这个 <code>Mono</code> 里，并最终发送给客户端。在这个过程中，线程没有被挂起，它可以立刻去处理其他请求。</p>
<p>我们可以通过下面这张图，直观感受两种模型处理多个慢请求时的巨大差异：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47208efe6f154e3e9c0f4f454f51dc87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=sy9F4uC%2FtkQMfAFsd4sOfs8AZ4g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">背压（Backpressure）：响应式流的精髓</h3>
<p>这或许是 WebFlux 最精妙也最容易被忽视的特性。在传统的拉取模型中，消费者控制节奏。而在响应式流中，数据由生产者主动推送，如果生产者太快，消费者来不及处理怎么办？</p>
<p><strong>背压机制</strong>允许消费者（如下游服务）主动告知生产者（如上游数据源）“我最多还能处理多少”，生产者据此调整推送速率，避免消费者被压垮。这为构建健壮的流处理系统提供了基础保障，是 Reactive Streams 规范的核心。</p>
<h2 data-id="heading-5">03 两种编程模型：注解与函数式</h2>
<p>有些小伙伴一听要学新框架就头大，生怕过去 Spring MVC 的经验白费。别担心，WebFlux 贴心地提供了两种编程模型，平滑过渡。</p>
<h3 data-id="heading-6">1. 注解模型：最熟悉的陌生人</h3>
<p>这种方式和 Spring MVC <strong>几乎一模一样</strong>，学习成本极低。主要区别仅在于返回值和部分参数类型。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveOrderController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReactiveOrderService orderService;

    <span class="hljs-comment">// 返回Flux，代表多个订单的流</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> Flux&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderService.findAll();
    }

    <span class="hljs-comment">// 返回Mono</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> Mono&lt;Order&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-keyword">return</span> orderService.findById(id);
    }

    <span class="hljs-comment">// 参数也可以是Mono</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Mono&lt;Order&gt; orderMono)</span> {
        <span class="hljs-keyword">return</span> orderMono.flatMap(orderService::save).then();
    }
}
</code></pre>
<p>可以看到，除了 <code>Flux</code> 和 <code>Mono</code> 这些类型，其他注解 <code>@RestController</code>、<code>@GetMapping</code> 都是老熟人。这对于现有项目进行部分重构或新项目启动非常友好。</p>
<h3 data-id="heading-7">2. 函数式模型：更灵活轻量的选择</h3>
<p>这是 WebFlux 的另一面，更像是在用 <strong>Java 8 的 Lambda 表达式和函数式接口来定义路由和处理逻辑</strong>，它不依赖于注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterFunctionConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routeOrder</span><span class="hljs-params">(ReactiveOrderHandler orderHandler)</span> {
        <span class="hljs-keyword">return</span> RouterFunctions.route()
                .GET(<span class="hljs-string">"/fn/orders"</span>, orderHandler::getAll)
                .GET(<span class="hljs-string">"/fn/orders/{id}"</span>, orderHandler::getById)
                .POST(<span class="hljs-string">"/fn/orders"</span>, orderHandler::create)
                .build();
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveOrderHandler</span> {
    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">getAll</span><span class="hljs-params">(ServerRequest request)</span> {
        Flux&lt;Order&gt; orders = ... <span class="hljs-comment">// 获取订单流</span>
        <span class="hljs-keyword">return</span> ServerResponse.ok()
                .contentType(MediaType.APPLICATION_JSON)
                .body(orders, Order.class);
    }
    <span class="hljs-comment">// ... 其他处理方法</span>
}
</code></pre>
<p>函数式模型将所有路由和处理器暴露为明确的 Bean，<strong>声明清晰，易于测试，且运行时开销更小</strong>，特别适合微服务场景中功能明确、结构简洁的端点。</p>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了20多家大厂的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h2 data-id="heading-8">04 深入核心：WebFlux如何运转</h2>
<p>理解了表面用法，我们以注解模型为例，深入一层，看看一个请求在 WebFlux 内部是如何流转的。</p>
<p>WebFlux 的核心调度器不再是 Servlet 容器的线程池，而是一个名为 <code>DispatcherHandler</code> 的组件，它扮演着类似 Spring MVC 中 <code>DispatcherServlet</code> 的角色。</p>
<ol>
<li><strong>请求接收</strong>： 以 Netty 为例，I/O 线程接收到 HTTP 请求，将其封装为 <code>ServerWebExchange</code>（一个非阻塞的请求-响应交换对象）。</li>
<li><strong>寻找处理器</strong>： <code>DispatcherHandler</code> 调用一组 <code>HandlerMapping</code>，根据请求路径等信息，找到对应的控制器方法（就是一个 <code>Handler</code>）。</li>
<li><strong>执行处理</strong>： <code>DispatcherHandler</code> 再通过 <code>HandlerAdapter</code> 去实际执行这个控制器方法。我们的方法返回一个 <code>Mono</code> 或 <code>Flux</code>。</li>
<li><strong>处理结果</strong>： <code>HandlerResultHandler</code> 负责处理这个反应式返回类型，将流中的数据序列化（如转为 JSON），并通过非阻塞 I/O 写回响应。</li>
</ol>
<p>整个过程中，<strong>所有环节都是非阻塞的</strong>。线程只在有 CPU 计算任务时才忙碌，一旦遇到 I/O 等待，就会去处理其他任务，从而实现极高的资源利用率。</p>
<p>下面是 WebFlux 核心组件协同处理请求的架构图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/999baa7b71514b11b705d8981fd15709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=dwDZ8W7t5nyQ6VhZVjQESCP2TgU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">05 性能与选择：并非银弹</h2>
<p>读到这里，有些小伙伴可能摩拳擦掌，准备把现有项目全盘迁移到 WebFlux。<strong>且慢！技术选型最忌“为了用而用”</strong>。</p>
<p>WebFlux 和 Spring MVC 不是替代关系，而是互补关系，它们共同扩展了 Spring 生态的能力边界。</p>
<h3 data-id="heading-10">性能真相</h3>
<ul>
<li><strong>WebFlux 的优势在于高并发、低延迟的 I/O 密集型场景</strong>。当你的应用有大量外部调用（数据库、微服务、API）、慢连接或长轮询（如聊天）时，WebFlux 能用更少的资源提供更稳定的吞吐量。</li>
<li><strong>WebFlux 不会让你的 CPU 密集型计算更快</strong>。如果业务逻辑本身就是复杂的计算，没有太多 I/O 等待，那么切换到 WebFlux 可能看不到收益，甚至因为响应式链的开销而略有下降。</li>
<li><strong>资源利用率是核心优势</strong>。WebFlux 通过减少线程数量，降低了内存消耗和上下文切换开销，使系统在压力下的表现更加可预测和稳定。</li>
</ul>
<h3 data-id="heading-11">代价与挑战</h3>
<ul>
<li><strong>编程范式转换</strong>： 从“指令式”思维切换到“声明式”、“函数式”的反应式思维是一大挑战。调试链式调用的 <code>Mono/Flux</code> 也比调试普通代码更困难。</li>
<li><strong>生态兼容性</strong>： 你的整个技术栈都需要支持非阻塞。<strong>这意味着你常用的阻塞式数据库驱动（如 JDBC）、Redis 客户端等可能无法直接使用</strong>，必须寻找其反应式版本（如 R2DBC、Lettuce）。这是一条“全栈反应式”的不归路。</li>
<li><strong>学习曲线</strong>： 团队需要时间学习 Reactor 丰富的操作符（<code>map</code>, <code>flatMap</code>, <code>zip</code> 等）和错误处理机制。</li>
</ul>
<h3 data-id="heading-12">如何选择？</h3>
<p>你可以遵循以下的决策流程，来判断你的项目是否真的需要 WebFlux：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015ef95dff174171918d00a929c206a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=qn%2BeB3u21kXBa2mzSMZMaLDKsJE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>对于新项目</strong>： 如果是微服务网关（Spring Cloud Gateway 就是基于 WebFlux）、实时监控、消息推送等场景，WebFlux 是绝佳选择。</p>
<p><strong>对于现有项目</strong>： <strong>不要轻易重构！</strong> 如果 Spring MVC 运行良好，重构的成本和风险极高。</p>
<p>一个更务实的切入点是：<strong>先在 Spring MVC 项目中使用 <code>WebClient</code>（WebFlux 提供的非阻塞 HTTP 客户端）来调用外部慢服务</strong>，这能立即为你的应用带来部分非阻塞的优势。</p>
<hr/>
<h2 data-id="heading-13">06 总结</h2>
<p>WebFlux 是 Spring 应对现代高并发、低延迟应用需求交出的一份优秀答卷。</p>
<p>它通过异步非阻塞和响应式流的技术，在 I/O 密集型领域展现出巨大优势。</p>
<p>但它不是一个“傻瓜式”的性能提升按钮，而是一套完整的、有门槛的新编程范式。</p>
<p>我们的职责不是追逐最酷的技术，而是<strong>为业务场景选择最合适的技术</strong>。</p>
<p>在你决定拥抱 WebFlux 之前，不妨先问自己三个问题：</p>
<ol>
<li>我的应用瓶颈真的是 I/O 吗？</li>
<li>我的团队和技术栈准备好“全栈反应式”了吗？</li>
<li>预期的收益能否覆盖学习和改造成本？</li>
</ol>
<p>想清楚这些问题，你的选择自然会清晰起来。</p>
<p>技术世界没有银弹，<strong>理解原理，权衡利弊，方是长期主义者的生存之道</strong>。</p>
<h2 data-id="heading-14">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化]]></title>    <link>https://juejin.cn/post/7581437632855015464</link>    <guid>https://juejin.cn/post/7581437632855015464</guid>    <pubDate>2025-12-09T06:40:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581437632855015464" data-draft-id="7581545175508598836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化"/> <meta itemprop="keywords" content="前端,Vue.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-09T06:40:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T06:40:54.000Z" title="Tue Dec 09 2025 06:40:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>传统方式搭建前端项目：查文档、试错、调试，耗时 1 天起步。AI 辅助：对话式配置，1 小时搞定。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第二篇文章，带你用 AI 快速搭建专业级前端项目架构。</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：为什么项目初始化这么让人头疼？</h2>
<p>还记得上一篇文章里提到的小何吗？他在"心动恋聊"项目中遇到的第一个挑战，就是前端项目初始化。</p>
<h3 data-id="heading-1">1.1 传统方式的痛点</h3>
<p>如果你做过前端项目，一定深有体会：</p>
<p><strong>技术选型迷茫</strong>：</p>
<pre><code class="hljs">UniApp vs Taro vs 原生？
Vue3 还是 React？
Vite 还是 Webpack？
UnoCSS 还是 Tailwind CSS？
</code></pre>
<p>每个选择背后都是无数的文档、博客、踩坑记录。光是技术选型，就能让人纠结半天。</p>
<p><strong>配置地狱</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">vite.config.ts
tsconfig.json
uno.config.ts
.eslintrc.js
.prettierrc
pages.json
manifest.json
...
</code></pre>
<p>每一个配置文件都有自己的语法、规则、坑点。配置完一个，还有下一个在等着你。</p>
<p><strong>时间黑洞</strong>：</p>
<p>小何最初的估算：</p>

















































<table><thead><tr><th>任务</th><th>预计时间</th></tr></thead><tbody><tr><td>技术调研</td><td>2 小时</td></tr><tr><td>项目创建</td><td>0.5 小时</td></tr><tr><td>Vite 配置</td><td>1 小时</td></tr><tr><td>TypeScript 配置</td><td>1 小时</td></tr><tr><td>UI 框架集成</td><td>2 小时</td></tr><tr><td>自动导入配置</td><td>1 小时</td></tr><tr><td>路由配置</td><td>1 小时</td></tr><tr><td>环境变量配置</td><td>0.5 小时</td></tr><tr><td>代码规范配置</td><td>2 小时</td></tr><tr><td><strong>总计</strong></td><td><strong>11 小时</strong></td></tr></tbody></table>
<p>实际上，因为各种问题、版本冲突、配置不兼容，往往需要 <strong>1.5-2 天</strong>。</p>
<h3 data-id="heading-2">1.2 AI 辅助的革命性变化</h3>
<p>有了 TRAE SOLO，一切都不同了。</p>
<p><strong>小何的实际体验</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我创建一个 UniApp + Vue3 + TypeScript 项目，
      使用 Vite 构建，支持微信小程序、H5、App 三端，
      集成 UnoCSS 和 UView Pro 组件库

AI：好的，我来帮你搭建完整的项目架构：

    ✓ 分析需求，确定技术选型
    ✓ 创建 Monorepo 项目结构
    ✓ 配置 Vite 构建工具
    ✓ 集成 TypeScript 严格模式
    ✓ 配置 UnoCSS 原子化 CSS
    ✓ 集成 UView Pro 组件库
    ✓ 设置自动导入
    ✓ 配置多环境变量
    ✓ 添加代码规范工具

    项目结构已生成，请查看...
</code></pre>
<p><strong>一天的工作，不到一小时完成。</strong> 这就是 AI 辅助开发的魔力。</p>
<h2 data-id="heading-3">二、技术选型：让 AI 帮你做决策</h2>
<h3 data-id="heading-4">2.1 框架对比分析</h3>
<p>项目开始前，小何需要确定技术选型。传统做法是搜索各种博客文章、技术对比，然后纠结半天。</p>
<p><strong>TRAE SOLO 的做法</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我对比 UniApp、Taro、原生小程序的优劣，
      项目需求：社交类小程序，需要支持微信小程序、H5、App 三端

AI：（通过 MCP 实时查阅最新文档）

      分析结论：

      1. UniApp 优势：
         - 一套代码，支持微信/H5/App/鸿蒙等多端
         - Vue3 技术栈，学习成本低
         - 生态完善，组件库丰富
         - 文档完善，社区活跃

      2. Taro 优势：
         - React 技术栈友好
         - 适合已有 React 经验的团队

      3. 原生小程序：
         - 性能最优
         - 但只能在单一平台运行

      推荐：UniApp + Vue3

      理由：
      1. 项目需要三端发布，UniApp 跨端能力最强
      2. 社交类应用迭代快，UniApp 开发效率高
      3. 后续还要扩展到鸿蒙、安卓、iOS，UniApp 支持最全
</code></pre>
<p><strong>5 分钟，得到了专业级的技术选型分析报告。</strong></p>
<h3 data-id="heading-5">2.2 构建工具选择</h3>
<pre><code class="hljs language-txt" lang="txt">小何：UniApp 应该用 Vite 还是 Webpack？

AI：强烈推荐 Vite！

      对比分析：
      ┌────────────┬────────────────┬────────────────┐
      │   维度     │     Vite       │    Webpack     │
      ├────────────┼────────────────┼────────────────┤
      │ 冷启动     │ 毫秒级         │ 秒级           │
      │ 热更新     │ 即时           │ 有延迟         │
      │ 配置复杂度 │ 简单           │ 复杂           │
      │ 生态支持   │ 完善           │ 非常完善       │
      │ 构建速度   │ 快             │ 较慢           │
      └────────────┴────────────────┴────────────────┘

      实测数据（心动恋聊项目）：
      - Vite 冷启动：1.2 秒
      - Webpack 冷启动：8.5 秒

      结论：Vite 开发体验完胜，选它！
</code></pre>
<h3 data-id="heading-6">2.3 最终技术栈确定</h3>
<p>通过 AI 辅助分析，"心动恋聊"项目确定了以下技术栈：</p>
<pre><code class="hljs language-txt" lang="txt">前端技术栈：
├── 框架：UniApp + Vue 3.4.21
├── 构建工具：Vite 5.2.8
├── 语言：TypeScript 5.7
├── 状态管理：Pinia 2.0.36 + 持久化
├── 原子化 CSS：UnoCSS 66.0
├── UI 组件库：UView Pro
├── HTTP 请求：自定义封装（基于 uni.request）
├── 列表优化：z-paging 2.8.7
└── 数据请求：@tanstack/vue-query
</code></pre>
<h2 data-id="heading-7">三、项目初始化：AI 一键生成</h2>
<h3 data-id="heading-8">3.1 Monorepo 项目结构</h3>
<p>"心动恋聊"采用 Monorepo 架构，这是现代前端项目的最佳实践。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我创建一个 Monorepo 项目结构，包含：
1. apps/unibest-mp - UniApp 小程序端
2. apps/xindong-server - Next.js 服务端
3. packages/shared-types - 共享类型定义
使用 pnpm 管理依赖，Turborepo 编排任务
</code></pre>
<p><strong>AI 生成的项目结构</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">xingdong/
├── apps/
│   ├── unibest-mp/              # UniApp 多端应用
│   │   ├── src/
│   │   │   ├── api/             # API 接口定义
│   │   │   ├── components/      # 公共组件
│   │   │   ├── composables/     # 组合式函数
│   │   │   ├── config/          # 配置文件
│   │   │   ├── hooks/           # 自定义 Hooks
│   │   │   ├── http/            # HTTP 请求封装
│   │   │   ├── layouts/         # 布局组件
│   │   │   ├── pages/           # 页面文件
│   │   │   ├── store/           # Pinia 状态管理
│   │   │   ├── subPackages/     # 分包页面
│   │   │   │   ├── agreement/   # 协议相关
│   │   │   │   ├── vip/         # 会员相关
│   │   │   │   └── planForm/    # 计划表单
│   │   │   ├── tabbar/          # 底部导航
│   │   │   └── utils/           # 工具函数
│   │   ├── env/                 # 环境变量
│   │   ├── vite.config.ts       # Vite 配置
│   │   └── package.json
│   │
│   └── xingdong-server/         # Next.js 服务端
│       ├── src/
│       │   └── app/             # App Router
│       └── package.json
│
├── packages/
│   └── shared-types/            # 共享类型定义
│       ├── src/
│       │   └── index.ts
│       └── package.json
│
├── pnpm-workspace.yaml          # pnpm 工作区配置
├── turbo.json                   # Turborepo 配置
└── package.json                 # 根配置
</code></pre>
<p><strong>pnpm-workspace.yaml</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">apps/*</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">packages/*</span>
</code></pre>
<p><strong>turbo.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://turbo.build/schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"apps/unibest-mp/dist/**"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"apps/xingdong-server/.next/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"persistent"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个结构的好处：</p>
<ol>
<li><strong>代码复用</strong>：shared-types 包让前后端类型一致</li>
<li><strong>独立开发</strong>：前后端可以独立启动、独立部署</li>
<li><strong>并行构建</strong>：Turborepo 自动并行执行不相关的任务</li>
</ol>
<h3 data-id="heading-9">3.2 配置 Vite</h3>
<p>Vite 配置是前端项目的核心。让我们看看 AI 生成的实际配置：</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我配置 UniApp 的 Vite 配置文件，需要：
1. 自动导入 Vue API
2. 自动导入 uni-app API
3. 自动导入自定义 hooks
4. 配置路径别名
5. 支持多环境变量
6. 集成 UnoCSS
7. 配置分包优化
</code></pre>
<p><strong>生成的 vite.config.ts（实际项目配置）</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts 核心配置片段</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ command, mode }) =&gt; {
  <span class="hljs-comment">// ... 环境变量加载逻辑 ...</span>

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-comment">// 1. 页面路由自动生成</span>
      <span class="hljs-title class_">UniPages</span>({
        <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'**/components/**/**.*'</span>],
        <span class="hljs-attr">subPackages</span>: [
          <span class="hljs-string">'src/subPackages/agreement'</span>,
          <span class="hljs-string">'src/subPackages/vip'</span>,
          <span class="hljs-string">'src/subPackages/planForm'</span>,
        ],
      }),

      <span class="hljs-comment">// 2. 布局系统 &amp; 平台适配</span>
      <span class="hljs-title class_">UniLayouts</span>(),
      <span class="hljs-title class_">UniPlatform</span>(),
      <span class="hljs-title class_">UniManifest</span>(),

      <span class="hljs-comment">// 3. 修复 Vue 编译问题（AI 自动生成的补丁）</span>
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'fix-vite-plugin-vue'</span>,
        <span class="hljs-title function_">configResolved</span>(<span class="hljs-params">config</span>) {
          <span class="hljs-keyword">const</span> plugin = config.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">name</span> === <span class="hljs-string">'vite:vue'</span>);
          <span class="hljs-keyword">if</span> (plugin &amp;&amp; plugin.<span class="hljs-property">api</span> &amp;&amp; plugin.<span class="hljs-property">api</span>.<span class="hljs-property">options</span>) {
            plugin.<span class="hljs-property">api</span>.<span class="hljs-property">options</span>.<span class="hljs-property">devToolsEnabled</span> = <span class="hljs-literal">false</span>;
          }
        },
      },

      <span class="hljs-comment">// 4. UnoCSS 原子化 CSS</span>
      <span class="hljs-title class_">UnoCSS</span>(),

      <span class="hljs-comment">// 5. 自动导入</span>
      <span class="hljs-title class_">AutoImport</span>({
        <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'uni-app'</span>],
        <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'src/hooks'</span>],
        <span class="hljs-attr">vueTemplate</span>: <span class="hljs-literal">true</span>,
      }),

      <span class="hljs-comment">// ... 其他插件</span>
      <span class="hljs-title class_">Uni</span>(),
    ],
    <span class="hljs-comment">// ...</span>
  });
};
</code></pre>
<p><strong>这个配置包含了</strong>：</p>
<ol>
<li><strong>@uni-helper 插件生态</strong>：页面路由、布局、平台、manifest 全自动化</li>
<li><strong>UnoCSS</strong>：原子化 CSS，开发效率翻倍</li>
<li><strong>AutoImport</strong>：Vue API、uni-app API、自定义 hooks 自动导入</li>
<li><strong>Hack 修复</strong>：AI 甚至帮我生成了一个 <code>fix-vite-plugin-vue</code> 插件来解决特定的编译 Bug，这在传统开发中可能要排查半天。</li>
</ol>
<h3 data-id="heading-10">3.3 TypeScript 配置</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我配置 TypeScript 严格模式，确保类型安全，支持 Vue3 和 uni-app
</code></pre>
<p><strong>生成的配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strictNullChecks"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsxImportSource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vue"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@img/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/static/images/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@dcloudio/types"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@uni-helper/uni-types"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"miniprogram-api-typings"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-11">四、UI 框架集成：UnoCSS + UView Pro</h2>
<h3 data-id="heading-12">4.1 UnoCSS 配置：AI 也会"翻车"</h3>
<p>UnoCSS 是原子化 CSS 的最佳选择，但在小程序环境中使用时，AI 一开始给出的配置并不完美。</p>
<p><strong>第一次尝试</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：配置 UnoCSS
AI：生成了标准的 Web 端配置（presetUno）。
结果：小程序端样式完全不生效。
</code></pre>
<p><strong>修正后的交互</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：这个配置在微信小程序里不生效，请检查是否需要专用预设？

AI：抱歉，你是对的。在 UniApp 中需要使用 `@uni-helper/unocss-preset-uni`。
    我已更新配置：
</code></pre>
<p><strong>最终生成的 uno.config.ts</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig, presetIcons } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>;
<span class="hljs-keyword">import</span> { presetUni } <span class="hljs-keyword">from</span> <span class="hljs-string">'@uni-helper/unocss-preset-uni'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-comment">// 使用 UniApp 专用预设，解决小程序兼容性问题</span>
    <span class="hljs-title function_">presetUni</span>({
      <span class="hljs-attr">attributify</span>: {
        <span class="hljs-attr">prefixedOnly</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 避免属性冲突</span>
      },
    }),
    <span class="hljs-title function_">presetIcons</span>({
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.2</span>,
      <span class="hljs-attr">warn</span>: <span class="hljs-literal">true</span>,
    }),
  ],
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">colors</span>: {
      <span class="hljs-comment">// 使用 CSS 变量，支持动态换肤</span>
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'var(--wot-color-theme,#0957DE)'</span>,
    },
  },
});
</code></pre>
<p>这里的重点是 <strong><code>presetUni</code></strong> 和 <strong><code>prefixedOnly</code></strong>，这是 AI 在被指出错误后迅速修正的关键点。</p>
<p><strong>UnoCSS 的优势</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 传统 CSS 写法 --&gt;
&lt;template&gt;
  &lt;view class="container"&gt;
    &lt;text class="title"&gt;心动恋聊&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
}
.title {
  font-size: 24px;
  font-weight: bold;
  color: #ff6b9d;
}
&lt;/style&gt;

&lt;!-- UnoCSS 写法 --&gt;
&lt;template&gt;
  &lt;view class="flex-center p-4"&gt;
    &lt;text class="text-24px font-bold text-primary"&gt;心动恋聊&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>代码量减少 70%，开发效率大幅提升！</strong></p>
<h3 data-id="heading-13">4.2 UView Pro 集成</h3>
<p>UView Pro 是 UniApp 最好用的组件库之一。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我集成 UView Pro 组件库，配置按需导入和主题定制
</code></pre>
<p><strong>package.json 依赖</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uview-pro"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.0.3"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>组件使用示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view class="page"&gt;
    &lt;!-- 导航栏 --&gt;
    &lt;u-navbar title="心动恋聊" :placeholder="true" /&gt;

    &lt;!-- 表单 --&gt;
    &lt;u-form ref="formRef" :model="formData" :rules="rules"&gt;
      &lt;u-form-item label="昵称" prop="nickname"&gt;
        &lt;u-input v-model="formData.nickname" placeholder="请输入昵称" /&gt;
      &lt;/u-form-item&gt;
      &lt;u-form-item label="性别" prop="gender"&gt;
        &lt;u-radio-group v-model="formData.gender"&gt;
          &lt;u-radio label="男" :name="1" /&gt;
          &lt;u-radio label="女" :name="2" /&gt;
        &lt;/u-radio-group&gt;
      &lt;/u-form-item&gt;
    &lt;/u-form&gt;

    &lt;!-- 按钮 --&gt;
    &lt;u-button type="primary" @click="handleSubmit"&gt;提交&lt;/u-button&gt;

    &lt;!-- 弹窗 --&gt;
    &lt;u-popup v-model:show="showPopup" mode="bottom"&gt;
      &lt;view class="p-4"&gt;弹窗内容&lt;/view&gt;
    &lt;/u-popup&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
const formRef = ref();
const showPopup = ref(false);

const formData = reactive({
  nickname: '',
  gender: 1,
});

const rules = {
  nickname: [{ required: true, message: '请输入昵称' }],
  gender: [{ required: true, message: '请选择性别' }],
};

const handleSubmit = async () =&gt; {
  const valid = await formRef.value.validate();
  if (valid) {
    // 提交逻辑
  }
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-14">五、自动导入配置：提升开发体验</h2>
<h3 data-id="heading-15">5.1 Vue API 自动导入</h3>
<p>传统写法每个文件都要导入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统写法</span>
<span class="hljs-keyword">import</span> { ref, reactive, computed, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> });
</code></pre>
<p>配置自动导入后：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自动导入后，直接使用</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> });
<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mounted'</span>);
});
</code></pre>
<p><strong>AutoImport 配置</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">AutoImport</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'uni-app'</span>],
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/auto-import.d.ts'</span>,
  <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'src/hooks'</span>],
  <span class="hljs-attr">vueTemplate</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>这会自动生成类型声明文件 <code>src/types/auto-import.d.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Auto generated by unplugin-auto-import</span>
<span class="hljs-keyword">export</span> {};
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">computed</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'computed'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onMounted</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'onMounted'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onUnmounted</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'onUnmounted'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">reactive</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'reactive'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">ref</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'ref'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">watch</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'watch'</span>];
  <span class="hljs-comment">// uni-app APIs</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onLaunch</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onLaunch'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onShow</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onShow'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onHide</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onHide'</span>];
  <span class="hljs-comment">// ... 更多</span>
}
</code></pre>
<h3 data-id="heading-16">5.2 自定义 Hooks 自动导入</h3>
<p>在 <code>src/hooks/</code> 目录下创建的 hooks 也会自动导入：</p>
<p><strong>src/hooks/useRequest.ts</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseRequestOptions</span>&lt;T&gt; {
  immediate?: <span class="hljs-built_in">boolean</span>;
  onSuccess?: <span class="hljs-function">(<span class="hljs-params">data: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  onError?: <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useRequest&lt;T&gt;(<span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;, <span class="hljs-attr">options</span>: <span class="hljs-title class_">UseRequestOptions</span>&lt;T&gt; = {}) {
  <span class="hljs-keyword">const</span> { immediate = <span class="hljs-literal">false</span>, onSuccess, onError } = options;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Ref</span>&lt;T | <span class="hljs-literal">null</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>();
      onSuccess?.(data.<span class="hljs-property">value</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      onError?.(error.<span class="hljs-property">value</span>);
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">if</span> (immediate) {
    <span class="hljs-title function_">execute</span>();
  }

  <span class="hljs-keyword">return</span> { data, loading, error, execute };
}
</code></pre>
<p><strong>使用时无需导入</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
// 直接使用，无需 import
const { data, loading, execute } = useRequest(() =&gt; apiGetUserInfo(), { immediate: true });
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-17">5.3 组件自动注册</h3>
<p>配置 <code>@uni-helper/vite-plugin-uni-components</code> 后，组件也自动注册：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Components</span>({
  <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'vue'</span>],
  <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">directoryAsNamespace</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/components.d.ts'</span>,
});
</code></pre>
<p><strong>src/components/UserCard.vue</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view class="user-card"&gt;
    &lt;image :src="user.avatar" class="avatar" /&gt;
    &lt;text class="name"&gt;{{ user.name }}&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  user: {
    avatar: string;
    name: string;
  };
}&gt;();
&lt;/script&gt;
</code></pre>
<p><strong>使用时无需注册</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 直接使用，无需 import 和 components 注册 --&gt;
  &lt;UserCard :user="userInfo" /&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-18">六、路由配置：pages.json 优化</h2>
<h3 data-id="heading-19">6.1 页面路由自动生成</h3>
<p>使用 <code>@uni-helper/vite-plugin-uni-pages</code>，页面路由可以自动生成。</p>
<p><strong>在页面文件中配置路由</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/pages/index/index.vue --&gt;
&lt;route lang="json"&gt;
{
  "style": {
    "navigationBarTitleText": "首页"
  }
}
&lt;/route&gt;

&lt;template&gt;
  &lt;view class="page"&gt;
    &lt;!-- 页面内容 --&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>自动生成的 pages.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/my/my"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"subPackages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"root"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subPackages/agreement"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"privacy"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"隐私协议"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user-agreement"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户协议"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"root"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subPackages/vip"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"会员中心"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabBar"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#999999"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"selectedColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FF6B9D"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"iconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/home.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"selectedIconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/home-active.png"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/my/my"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"iconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/my.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"selectedIconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/my-active.png"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"globalStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"navigationBarTextStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"black"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"心动恋聊"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#F5F5F5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-20">6.2 分包配置</h3>
<p>小程序有包体积限制（主包 2MB，总包 20MB），分包是必须的。</p>
<p><strong>配置分包</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-title class_">UniPages</span>({
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'**/components/**/**.*'</span>],
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/uni-pages.d.ts'</span>,
  <span class="hljs-attr">subPackages</span>: [
    <span class="hljs-string">'src/subPackages/agreement'</span>, <span class="hljs-comment">// 协议相关页面</span>
    <span class="hljs-string">'src/subPackages/vip'</span>, <span class="hljs-comment">// 会员相关页面</span>
    <span class="hljs-string">'src/subPackages/planForm'</span>, <span class="hljs-comment">// 计划表单页面</span>
  ],
});
</code></pre>
<p><strong>分包优化插件</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// @uni-ku/bundle-optimizer 自动优化</span>
<span class="hljs-title class_">Optimization</span>({
  <span class="hljs-attr">enable</span>: {
    <span class="hljs-attr">optimization</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启优化</span>
    <span class="hljs-string">'async-import'</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 异步导入</span>
    <span class="hljs-string">'async-component'</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 异步组件</span>
  },
  <span class="hljs-attr">dts</span>: {
    <span class="hljs-attr">base</span>: <span class="hljs-string">'src/types'</span>,
  },
});
</code></pre>
<h2 data-id="heading-21">七、环境变量配置</h2>
<h3 data-id="heading-22">7.1 多环境配置</h3>
<p>"心动恋聊"项目支持多环境、多项目配置：</p>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">env/
├── .env                           # 基础配置
├── .env.development               # 开发环境
└── .env.production                # 生产环境
</code></pre>
<p><strong>.env.development</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 基础配置</span>
 VITE_APP_PORT=5173
 VITE_APP_PUBLIC_BASE=/

 <span class="hljs-comment"># API 配置</span>
 VITE_SERVER_BASEURL=http://localhost:3000
 VITE_APP_PROXY=<span class="hljs-literal">true</span>

 <span class="hljs-comment"># 业务配置</span>
 VITE_APP_SOURCE_ID=your_source_id
 VITE_APP_CHANNEL_ID=weixin
</code></pre>
<h3 data-id="heading-23">7.2 环境变量使用</h3>
<p><strong>在代码中使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 直接使用</span>
<span class="hljs-keyword">const</span> apiBaseUrl = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_SERVER_BASEURL</span>;
<span class="hljs-keyword">const</span> sourceId = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_SOURCE_ID</span>;

<span class="hljs-comment">// 类型安全</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportMetaEnv</span> {
  <span class="hljs-attr">VITE_APP_PORT</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_SERVER_BASEURL</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_SOURCE_ID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_CHANNEL_ID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_BRAND_KEY</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>启动命令</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev:mp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni -p mp-weixin --mode development"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:mp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni build -p mp-weixin --mode production"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-24">八、代码规范配置</h2>
<h3 data-id="heading-25">8.1 ESLint 配置</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">配置 ESLint，适合 Vue3 + TypeScript + UniApp 项目
</code></pre>
<p><strong>使用 @uni-helper/eslint-config</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> uniHelper <span class="hljs-keyword">from</span> <span class="hljs-string">'@uni-helper/eslint-config'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">uniHelper</span>({
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">unocss</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<h3 data-id="heading-26">8.2 Prettier 配置</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .prettierrc</span>
{
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"all"</span>,
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"endOfLine"</span>: <span class="hljs-string">"lf"</span>
}
</code></pre>
<h3 data-id="heading-27">8.3 Git Hooks</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --fix"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-28">九、实战演示：首页核心逻辑开发</h2>
<p>"心动恋聊"的首页并不是一个简单的展示页，它包含了一个复杂的交互逻辑：<strong>文字/图片输入模式切换</strong>。</p>
<h3 data-id="heading-29">9.1 需求描述</h3>
<pre><code class="hljs language-txt" lang="txt">小何：首页需要一个输入区域，支持两种模式：
1. 文字模式：输入对方说的话。
2. 图片模式：上传聊天截图。

切换模式时，输入框和上传区域要互斥显示。
并且需要一个"清除记忆"的功能，但只在文字模式下显示。
</code></pre>
<h3 data-id="heading-30">9.2 AI 的逐步实现</h3>
<p>这是一个涉及状态管理、UI 交互和业务逻辑的复杂需求。AI 是如何一步步实现的呢？</p>
<p><strong>第一步：定义状态</strong></p>
<p>AI 首先定义了核心的响应式状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/index/index.vue</span>
<span class="hljs-keyword">const</span> showUploadArea = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 控制模式切换</span>
<span class="hljs-keyword">const</span> inputText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// 文字输入</span>
<span class="hljs-keyword">const</span> selectedImages = <span class="hljs-title function_">ref</span>([]); <span class="hljs-comment">// 图片列表</span>

<span class="hljs-comment">// 切换模式逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleInputMode</span> = (<span class="hljs-params"/>) =&gt; {
  showUploadArea.<span class="hljs-property">value</span> = !showUploadArea.<span class="hljs-property">value</span>;
  <span class="hljs-comment">// 切换时清空状态，避免数据混淆</span>
  <span class="hljs-keyword">if</span> (showUploadArea.<span class="hljs-property">value</span>) {
    inputText.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">else</span> {
    selectedImages.<span class="hljs-property">value</span> = [];
  }
};
</code></pre>
<p><strong>第二步：构建动态 UI</strong></p>
<p>利用 Vue 的 <code>v-if/v-show</code> 指令处理复杂的显示逻辑：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 模式切换按钮 --&gt;
  &lt;view class="flex justify-between items-center"&gt;
    &lt;text&gt;{{ showUploadArea ? '与Ta的聊天截图：' : 'Ta说：' }}&lt;/text&gt;
    &lt;view @click="toggleInputMode"&gt;
      &lt;text&gt;{{ showUploadArea ? '切换文字' : '切换图片' }}&lt;/text&gt;
    &lt;/view&gt;
  &lt;/view&gt;

  &lt;!-- 上传区域 (图片模式) --&gt;
  &lt;view v-show="showUploadArea" class="upload-area"&gt;
    &lt;ImageGrid :images="selectedImages" @add="addImages" /&gt;
  &lt;/view&gt;

  &lt;!-- 输入框 (文字模式) --&gt;
  &lt;view v-show="!showUploadArea" class="input-wrapper"&gt;
    &lt;u-input type="textarea" v-model="inputText" :autoHeight="true" /&gt;
  &lt;/view&gt;

  &lt;!-- 清除记忆 (仅文字模式) --&gt;
  &lt;view v-if="!showUploadArea" class="clear-memory-btn" @click="handleClearMemory"&gt;
    &lt;text&gt;清除记忆&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>第三步：处理业务逻辑</strong></p>
<p>生成回复时，需要根据当前模式调用不同的接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleGenerate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 鉴权检查</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">await</span> <span class="hljs-title function_">checkAuth</span>())) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 2. 模式判断</span>
  <span class="hljs-keyword">if</span> (showUploadArea.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 图片模式逻辑</span>
    <span class="hljs-keyword">if</span> (selectedImages.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> toast.<span class="hljs-title function_">info</span>(<span class="hljs-string">'请上传截图'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateByImage</span>(selectedImages.<span class="hljs-property">value</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 文字模式逻辑</span>
    <span class="hljs-keyword">if</span> (!inputText.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span> toast.<span class="hljs-title function_">info</span>(<span class="hljs-string">'请输入内容'</span>);
    <span class="hljs-comment">// 调用带记忆的接口</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateByText</span>({
      <span class="hljs-attr">text</span>: inputText.<span class="hljs-property">value</span>,
      <span class="hljs-attr">sessionId</span>: chatSessionStore.<span class="hljs-property">sessionId</span>,
    });
  }
};
</code></pre>
<h3 data-id="heading-31">9.3 真实代码片段</h3>
<p>最终生成的代码不仅逻辑清晰，还处理了很多细节，比如 iOS 的样式适配：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 适配 iOS 的输入框样式</span>
<span class="hljs-keyword">const</span> inputCustomStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> isIOS = systemInfo?.<span class="hljs-property">platform</span> === <span class="hljs-string">'ios'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">padding</span>: isIOS ? <span class="hljs-string">'12rpx'</span> : <span class="hljs-string">'20rpx'</span>,
    <span class="hljs-attr">minHeight</span>: <span class="hljs-string">'240rpx'</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'12px'</span>,
  };
});
</code></pre>
<p>这就是 AI 辅助开发的威力：<strong>它不仅能写出跑通的代码，还能考虑到平台差异和边界情况。</strong></p>
<h3 data-id="heading-32">9.3 运行测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 微信小程序</span>
pnpm --filter unibest-mp dev:mp

<span class="hljs-comment"># H5</span>
pnpm --filter unibest-mp dev:h5

<span class="hljs-comment"># App</span>
pnpm --filter unibest-mp dev:app
</code></pre>
<h2 data-id="heading-33">十、总结与下一步</h2>
<h3 data-id="heading-34">10.1 本篇完成的工作</h3>
<p>通过 AI 辅助，我们在 <strong>不到 1 小时</strong> 内完成了：</p>

















































<table><thead><tr><th>任务</th><th>完成情况</th></tr></thead><tbody><tr><td>✅ Monorepo 项目结构</td><td>标准的 pnpm + Turborepo 架构</td></tr><tr><td>✅ Vite 配置</td><td>完整的插件链和优化配置</td></tr><tr><td>✅ TypeScript 配置</td><td>严格模式，完整类型支持</td></tr><tr><td>✅ UnoCSS 集成</td><td>原子化 CSS，主题定制</td></tr><tr><td>✅ UView Pro 集成</td><td>组件库完整接入</td></tr><tr><td>✅ 自动导入配置</td><td>Vue API、uni-app API、Hooks</td></tr><tr><td>✅ 路由系统</td><td>自动生成，分包优化</td></tr><tr><td>✅ 环境变量</td><td>多环境、多项目支持</td></tr><tr><td>✅ 代码规范</td><td>ESLint + Prettier</td></tr><tr><td>✅ 首页开发</td><td>完整的页面实现</td></tr></tbody></table>
<h3 data-id="heading-35">10.2 核心提示词模板</h3>
<p><strong>项目初始化</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">创建 [框架] + [技术栈] 项目，
包含 [目录结构]，
配置 [构建工具]
</code></pre>
<p><strong>配置文件生成</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">配置 [工具名称]，需要：
1. [功能点 1]
2. [功能点 2]
3. [功能点 3]
</code></pre>
<p><strong>页面生成</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">创建 [页面名称]，包括：
- [功能描述]
使用 [UI 框架] 和 [样式方案]
</code></pre>
<h3 data-id="heading-36">10.4 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 3 篇：AI 辅助后端开发 - Next.js 15 API 快速搭建》</strong></p>
<p>我们将学习：</p>
<ul>
<li>Next.js 15 App Router 架构</li>
<li>Prisma ORM 数据库操作</li>
<li>RESTful API 设计</li>
<li>JWT 认证中间件</li>
<li>前后端类型共享</li>
</ul>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[歼20居然是个框架-基于 Signals 信号的前端框架设计]]></title>    <link>https://juejin.cn/post/7581348660824768512</link>    <guid>https://juejin.cn/post/7581348660824768512</guid>    <pubDate>2025-12-09T01:31:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581348660824768512" data-draft-id="7581251003330134042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="歼20居然是个框架-基于 Signals 信号的前端框架设计"/> <meta itemprop="keywords" content="JavaScript,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-09T01:31:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anuoua"/> <meta itemprop="url" content="https://juejin.cn/user/4415237335295933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            歼20居然是个框架-基于 Signals 信号的前端框架设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4415237335295933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anuoua
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T01:31:50.000Z" title="Tue Dec 09 2025 01:31:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4af4852d384ab9a20ff89eab34a12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW51b3Vh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765848710&amp;x-signature=Tp85S3N8CYamDjPP%2FfiOVBGeq%2FE%3D" alt="logo" loading="lazy"/></p>
<p>大家好，我是 anuoua，今天我们来讲讲基于 Signal 如何构建一个前端框架。</p>
<p>以 Vue 为响应式前端框架的代表，以 React 则是非响应式前端框架的代表，算是目前前端框架的稳定格局。</p>
<p>响应式的优点不言而喻，是高性能前端框架的选择。</p>
<p>而响应式也有不同的设计理念，区别于 Vue 的 reactivity，preact 的作者提出了 Signal 这种响应式的理念，和深度劫持的 reactivity 不同，Signal 更简单直观，其理念传播广泛，目前 Signal 作为 js 语言特性被提出成为 proposal。</p>
<h2 data-id="heading-0">响应式前端框架的现状</h2>
<p>目前一些具有代表性的前端框架，基本都走向了响应式 API + 真实 DOM，例如：svelte、solid、vue，这几个前端框架在性能上有了大幅提升，但是仍然存在一些问题。</p>
<h3 data-id="heading-1">Vue 3</h3>
<p>Vue 作为响应式框架的开创者，Vue3 仍然是虚拟 DOM，而 Vue 3 vapor 转向真实 DOM。Vue 3 版本中遇到最严重的问题是<strong>自动解包</strong>、**解构以及类型，**为了解决这些问题作者试验过很多语法，最终在数个的迭代后，还是上了编译手段，在SFC中使用宏用来解决开发体验以及 Typescript 类型问题。</p>
<pre><code class="hljs language-markup" lang="markup">&lt;script setup&gt;
const props = defineProps({
  foo: String
})
&lt;/script&gt;
</code></pre>
<p>除此之外，Vue 的问题就在于官方没有引导用户到理想的开发模式上去，<strong>组件写法太多</strong>，导致社区力量分散，发力不在一处。如果统一使用 SFC 开发，统一使用 composition api，那么社区就不会陷入使用 jsx 还是 SFC，使用 options 还是 composition api 的纠结，那么社区的生态会好很多。</p>
<h3 data-id="heading-2">Svelte</h3>
<p>Svelte 借助编译手段将视图转换成真实DOM实现，在 Svelte 5 中转向了和 Vue 类似的深度劫持的响应式API。它设计了一种叫 runes 的概念，通过编译技术追踪由特殊函数名创建的变量，将其编译成响应式代码，基本解决了类似 Vue 的困扰，无需手动解包，开发体验不错。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> message = $state(<span class="hljs-string">'hello'</span>);
</code></pre>
<p>我认为 Svelte 的 runes 已经很接近完美了，开发体验很不错。</p>
<p>但 Svelte 本身仍然有以下几点问题：</p>
<p><strong>第一</strong>：它有自己的 DSL <code>.svelte</code>，我认为 JSX 更佳，Typescript 对 JSX 的支持非常好，DSL 支持 TS 总是需要付出更多的代价，而且需要支付更多的学习成本。</p>
<p><strong>第二</strong>：它的响应式仍然是和 Vue 一样的默认深度劫持，如果是复杂嵌套对象，劫持内部对象会被包装带来会有隐晦的debug负担和理解成本。我认为 Signal 信号的浅劫持理念更加简单和直观。</p>
<p><strong>第三</strong>：runes 还不够完美，若在大型应用中使用其创建的变量，会导致和普通变量混淆，编译器可以追踪变量，但是在多文件代码复杂组合的时候，很难区分是普通变量还是响应式变量，给debug带来困难。</p>
<h3 data-id="heading-3">Solid</h3>
<p>Solidjs，它则是视图部分采取编译手段，API部分保持原生，让用户裸使用原生 Signal API，Solidjs 的 API 是符合 Signal 理念的，没有深度劫持。但是原生的 Signal API 看起来使用较为繁琐。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createSignal } <span class="hljs-keyword">from</span> <span class="hljs-string">"solid-js"</span>;
<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">createSignal</span>(<span class="hljs-number">0</span>);
</code></pre>
<p>Solid 性能不错，JSX + TS 的开发体验基本拉满，唯一的问题是裸 Signal API 的使用不够优雅，略显繁琐。</p>
<p>例如它也不能直接解构 props，需要借助帮助函数才能维持响应性。</p>
<h3 data-id="heading-4">通病</h3>
<p>它们在支持 Web Component 这点上，都没有做好无缝的开发体验，有额外的使用成本。</p>
<h3 data-id="heading-5">总结</h3>
<p>以上三个框架都抛弃了虚拟DOM，配合响应式API，性能表现都非常好，但它们都或多或少都有令人在意的问题，很难找到理想中的前端框架。</p>

































<table><thead><tr><th>框架</th><th>真实 DOM</th><th>Signal</th><th>JSX</th><th>Signal API 编译</th></tr></thead><tbody><tr><td>Vue</td><td>支持（Vapor Mode）</td><td>兼容（shallowRef）</td><td>兼容</td><td>混合</td></tr><tr><td>Svelte</td><td>支持</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>Solid</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr></tbody></table>
<h2 data-id="heading-6">理想的前端框架</h2>
<p>如果我们需要一个新的前端框架，那么应该怎么设计？</p>
<p>根据上述总结，我认为 <strong>真实 DOM +</strong> <strong>JSX + Signal API 编译策略 + Web Component 一等支持</strong> 才是最接近完美的方案。</p>
<p>而 Solid 已经接近我们想要的了，给它加上剩下两个特性基本上就满足我们需要了。</p>
<p>所以怎么实现一个“完美”的框架呢？</p>
<h2 data-id="heading-7">从细粒度绑定到组件</h2>
<p>signal 如何细粒度绑定 DOM 更新呢？又是怎么从基本的绑定演化为框架组件呢？</p>
<p>我们先从 Signal 的用法说起。</p>
<h3 data-id="heading-8">Signal 的基本用方法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 声明信号</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 派生信号</span>
<span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
<span class="hljs-comment">// 副作用绑定</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 当 name.value = "hello2";</span>
  <span class="hljs-comment">// console =&gt; 1. "hello world" 2. "hello2 world"</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(displayName);
});
</code></pre>
<h3 data-id="heading-9">绑定DOM元素</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 声明信号</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 派生信号</span>
<span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);

<span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);

<span class="hljs-comment">// 副作用绑定</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
});
</code></pre>
<h3 data-id="heading-10">演化成组件</h3>
<p>一个只有 text 节点的组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);
    <span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
      text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
    });
    <span class="hljs-keyword">return</span> text;
  })();
}
</code></pre>
<h3 data-id="heading-11">更复杂的组件</h3>
<p>在 div 中添加 text 节点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> el1 = (<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);
      <span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
        text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
      });
      <span class="hljs-keyword">return</span> text;
    })();
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);
    div.<span class="hljs-title function_">append</span>(el1);
    <span class="hljs-keyword">return</span> div;
  })();
}
</code></pre>
<h3 data-id="heading-12">演化成 JSX</h3>
<p>Solid 的编译策略和上述是类似的，视图的编译是有规律的，创建 - 绑定 - 挂载，只要是有规律的，那就可以通过 DSL 来描述，JSX 正好可以表达这个过程。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{displayName.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>可以看到复杂的视图创建流程通过 DSL 的使用配合编译手段，开发体验可以大幅提升。</p>
<p>同时需要指出 Solid 的编译方式未必是最好的，编译后的代码量挺大，还有各种闭包嵌套，可以稍微改进一下，编译成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { jsx, template } <span class="hljs-keyword">from</span> <span class="hljs-string">"some/jsx-runtime"</span>

<span class="hljs-keyword">const</span> temp1 = <span class="hljs-title function_">template</span>(<span class="hljs-string">"&lt;div&gt;"</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title function_">temp1</span>(), {
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">children</span>() {
      <span class="hljs-keyword">return</span> displayName.<span class="hljs-property">value</span>;
    }
  });
}
</code></pre>
<p>Solid 把一部分 DOM 操作过程也编译出来了，事实上创建真实 DOM 的过程很大一部分是通用的，我们把创建元素的方法抽出来 <code>jsx</code>，用于创建和组装元素，这样编译出来的代码也会相对直观。</p>
<p>同时需要注意到 template 方法，它做了一件事，内部使用 cloneNode 去创建静态节点，这样可以提升性能。</p>
<h3 data-id="heading-13">总结</h3>
<p>这套编译策略，从演化中总结编译策略，然后完成 JSX AST 转换实现，确实是有创新思维和难度的，属于框架的创新点核心。</p>
<p>最先搞视图转真实 DOM 编译的是 Svelte，而 Solid 完成了更高效的实现，又最终促进了 Svelte 5 的诞生，使 Web 框架在性能得到了上大幅升级。</p>
<h2 data-id="heading-14">完整的框架要考虑的更多</h2>
<p>只靠上面的编译策略显然是不够的，需要考虑很多细节问题。</p>
<p>组件的创建，事实上挺复杂的，组件是有实例的，初始化实例的过程中需要做很多工作。</p>
<p>比如：利用插桩来定位组件组件的边界，假设组件直接返回 <code>&lt;&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/&gt;</code> ，如果没有插桩框架将无法识别边界，在做列表 diff 的时候，组件内元素集合的移除、添加、移动等操作将错乱。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
  <span class="hljs-keyword">const</span> instance = {
    <span class="hljs-attr">range</span>: [
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>),
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>),
    ]
  }
  <span class="hljs-keyword">const</span> span1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);
  <span class="hljs-keyword">const</span> span2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);
  fragment.<span class="hljs-title function_">append</span>(instance.<span class="hljs-property">range</span>[<span class="hljs-number">0</span>]);
  fragment.<span class="hljs-title function_">append</span>(span1);
  fragment.<span class="hljs-title function_">append</span>(span2);
  fragment.<span class="hljs-title function_">append</span>(instance.<span class="hljs-property">range</span>[<span class="hljs-number">1</span>]);
  <span class="hljs-keyword">return</span> fragment;
}
</code></pre>
<h2 data-id="heading-15"><strong>界面突变和 diff 算法</strong></h2>
<p>和 React 和 Vue 一样，这类编译型的前端框架仍然有 diff 过程。</p>
<p>界面突变的根本逻辑就是<strong>列表渲染</strong>，而列表渲染一定会涉及 diff，而 Vue 高效的 diff 算法也是可以使用的，算法和实现分离，不同的框架有不同的实现。</p>
<h3 data-id="heading-16"><strong>为什么说界面突变的根本逻辑是列表渲染？</strong></h3>
<p>条件渲染本质也是列表渲染，我们来看一个三目逻辑 ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">List</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [toggle, setToggle] = <span class="hljs-number">0</span>;
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setToggle</span>((toggle[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span>);
  });
  
  <span class="hljs-keyword">return</span> [toggle].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{i}<span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>))
}
</code></pre>
<p>实际上就是列表 <code>[0]</code> 和 <code>[1]</code> 之间相互切换。</p>
<p>Switch Case 逻辑也类似：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">List</span> = (<span class="hljs-params">{ value }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [list, setList] = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
  
  <span class="hljs-keyword">const</span> deriveList = list.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i === value).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  
  <span class="hljs-keyword">return</span> [deriveList].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{i}<span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>));
}
</code></pre>
<p>根据 value 的值过滤列表，即可以实现 Switch Case 逻辑。</p>
<h3 data-id="heading-17"><strong>虚拟 DOM 和 真实 DOM 的 diff 实现差异</strong></h3>
<p>虚拟 DOM 的 diff 是从的组件节点（Vue）或者根节点（React）开始，遍历一遍，抽离出 DOM 指令以更新视图。</p>
<p>但是真实 DOM 的框架，列表是细粒度绑定的，当列表变化后，更新视图是在副作用内执行的，所以它需要一个特定的组件或者函数来封装这个副作用的逻辑，在 Solid 中就是 <code>&lt;For&gt;</code> 组件， Vue Vapor 和 Svelte 是在编译的时候编译成了一个特定的函数。</p>
<p>svelte:</p>
<pre><code class="hljs language-html" lang="html">$.each(node, 16, () =&gt; expression, $.index, ($$anchor, name, index, $$array) =&gt; {
    $.next();
    var text_2 = $.text('...');
    $.append($$anchor, text_2);
});
</code></pre>
<p>diff 算法可以借鉴，但是虚拟 DOM 和 真实 DOM 框架在 diff 算法中进行的操作并不一样，理论上 Solid 也可以用 Vue 3 的算法。</p>
<h2 data-id="heading-18">开发体验升级</h2>
<p>上面指出 Solid 体验已经很好的，但是仍有不足，裸 Signal API 的使用不够优雅，getter setter 满屏幕跑，Vue Svelte 为了解决体验问题都通过对应的编译策略来解决这个问题，而 Solid 没有，有点遗憾。</p>
<p>事实上开发体验这块，React 除了需要手动管理依赖这块过于逆天之外，它的开发体验真的不错。</p>
<p>React 的组件状态写法已经很简洁了，不用像 Vue，Solid 那样套 computed。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-string">"Info: "</span> + name
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setName(name + "world")}&gt;{displayName}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>也就是说，如果我们能改进 Solid，给它加上一组编译手段，改进 Signal 的使用体验，是不是会提升开发体验呢？</p>
<p>让我们尝试推演一下。</p>
<h2 data-id="heading-19">理想的组件形态</h2>
<p>我们先提出一个理想中的组件形态，要求足够简洁，开发体验足够好：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {name = name + "world"}}&gt;{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>我们希望改变 name  的时候，视图就会更新，但是这样是做不到的，改变一个变量没有任何作用。</p>
<p>但是如果是信号就不一样了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> name.value = name.value + "xxx"}&gt;{name.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>我们根据上文所说的 JSX 编译手段，创建元素可以绑定副作用，<code>name.value</code>是可以被副作用收集到，并在name.value 更新的时候顺便更新视图。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { jsx, template } <span class="hljs-keyword">from</span> <span class="hljs-string">"some/jsx-runtime"</span>

<span class="hljs-keyword">const</span> temp1 = <span class="hljs-title function_">template</span>(<span class="hljs-string">"&lt;div&gt;"</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title function_">temp1</span>(), {
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">onClick</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        name.<span class="hljs-property">value</span> = name.<span class="hljs-property">value</span> + <span class="hljs-string">"xxx"</span>;
      }
    },
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">children</span>() {
      <span class="hljs-keyword">return</span> name.<span class="hljs-property">value</span>;
    }
  });
}
</code></pre>
<p>这时候就需要编译来完成我们的代码转换，在这里我们把<strong>信号变量使用</strong> <code>**$**</code> <strong>标记</strong>。然后就代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {$name = $name + "world"}}&gt;{$name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>这个代码和我们理想中的组件代码非常接近了，要是真的能这样写代码，那么开发体验就能得到大幅提升。</p>
<h2 data-id="heading-20"><strong>Signal 信号编译策略</strong></h2>
<p>前面提到使用 $ 标记信号，就是一种创新的编译策略，通过<strong>特殊命名标记变量</strong>，将变量编译成响应式信号代码。</p>
<h3 data-id="heading-21">编译策略说明</h3>
<blockquote>
<p>这里我们按照 preact/signals 库的 api 做示例。</p>
</blockquote>
<h3 data-id="heading-22">编译策略一：let 搭配 $ 开头的变量，即为声明信号。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">import</span> { signal } <span class="hljs-keyword">from</span> <span class="hljs-string">"@preact/signal"</span>;
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
</code></pre>
<h3 data-id="heading-23">编译策略二：读取 $ 开头的变量会默认解包</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($name);
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($name.<span class="hljs-property">value</span>);
</code></pre>
<h3 data-id="heading-24">编译策略三：const 搭配 $ 开头的变量，为声明派生信号。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
<span class="hljs-keyword">const</span> $display = $name + <span class="hljs-string">"world"</span>;
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">import</span> { signal, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"@preact/signal"</span>;
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-keyword">const</span> $display = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $name.<span class="hljs-property">value</span> + <span class="hljs-string">"world"</span>);
</code></pre>
<h3 data-id="heading-25">编译策略四：$use 开头的为自定义 hooks 。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: $name
  }
}

<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: $name.<span class="hljs-property">value</span>
  }))
}
</code></pre>
<h3 data-id="heading-26">编译策略五：解构 + 变量传递。</h3>
<p>函数入参，入参的响应传递，解构变量需要设置<code>$</code>前缀</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params">{ name: $name, ...$rest }</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($rest);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{$name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 编译为</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params">$__0</span>) =&gt; {
  <span class="hljs-keyword">const</span> $name = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $__0.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">const</span> $rest = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { name, ...rest } = $__0.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">return</span> rest;
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($rest.<span class="hljs-property">value</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{$name.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>自定义 hook 返回，解构的时候为了不丢失响应，同样也要解构变量设置<code>$</code>前缀，这样就能触发编译。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: $name
  }
}

<span class="hljs-comment">// 解构后的变量也必须是 $ 开头，否则丢失响应，退化为普通变量（原始信号对象，可手动.value使用）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">name</span>: $name } = $useName();
<span class="hljs-comment">// 自定义 hook 返回赋值的变量也必须是 $ 开头，否则丢失响应，退化为普通变量（原始信号对象，可手动.value使用）</span>
<span class="hljs-keyword">const</span> $nameSignal = $useName();

<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span>= (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: $name.<span class="hljs-property">value</span>
  }))
}

<span class="hljs-keyword">const</span> $__0 = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $useName().<span class="hljs-property">value</span>);
<span class="hljs-keyword">const</span> $name = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $__0.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>);
<span class="hljs-keyword">const</span> $nameSignal = $useName();
</code></pre>
<h3 data-id="heading-27">此编译策略的优点</h3>
<ol>
<li>无需手动导入 API，像普通变量一样使用 Signal</li>
<li>和 TS 类型的结合非常好，特别和 JSX 的类型结合非常完美</li>
<li>不怕解构</li>
<li>标记变量和常规变量一起用不会有混淆</li>
</ol>
<h2 data-id="heading-28">一个简单的鼠标位置hook</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$usePosition</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> $y = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">const</span> $pos = {
    <span class="hljs-attr">x</span>: $x,
    <span class="hljs-attr">y</span>: $y
  };
  
  <span class="hljs-title function_">mounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      $x = e.<span class="hljs-property">pageX</span>;
      $y = e.<span class="hljs-property">pageY</span>;
    });
  })
  
  <span class="hljs-keyword">return</span> {
    $pos,
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { $pos } = $usePosition();
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>x: {$pos.x}; y:{$pos.y}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>是不是清爽很多，简单应用的代码量差距不是很明显，但是如果代码量增加，那么代码量的差距还是非常可观的。</p>
<p>同时这样的设计，甚至不需要手动导入 API ，它在编译期间自动导入，让人无需关心 Signal 本身，真正做到了无感，开发体验得到了提升。</p>
<h2 data-id="heading-29">Web Component 支持</h2>
<p>Vue Solid Svelte 都支持封装 Web Component，但是在开发体验上并没有多好，需要额外操作才能集成到框架中使用，做不到在框架内无缝使用，这样也限制了 Web Component 的推广和使用。</p>
<p>所以我们希望框架能够做好以下几点来支持 Web Component：</p>
<ul>
<li>和框架本身可以无缝集成，像普通组件一样方便使用</li>
<li>组件 TS 类型易用且完善</li>
<li>可以按照常规 Web Component 一样可以独立使用</li>
<li>可以供给原生 HTML 或者其他框架使用</li>
</ul>
<h2 data-id="heading-30">有这样的框架吗？</h2>
<p>有啊 J20 框架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanuoua%2Fj20" target="_blank" title="https://github.com/anuoua/j20" ref="nofollow noopener noreferrer">J20</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4af4852d384ab9a20ff89eab34a12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW51b3Vh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765848710&amp;x-signature=Tp85S3N8CYamDjPP%2FfiOVBGeq%2FE%3D" alt="logo" loading="lazy"/></p>
<p>点个 Star 吧。</p>
<h2 data-id="heading-31">说在最后</h2>
<p>这大概是我最后一个前端框架了，也算是完成了之前对前端框架的想法（中间隔了很久才想起来还有个东西没完成）。</p>
<p>歼20框架大量代码都是AI写的，我负责设计，它负责实现，同时帮我写测试，速度大幅提升。</p>
<p>AI 时代，也许框架不再重要了吧。哈哈</p>
<p>谢谢大家！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享下我创业烧了 几十万的 AI Coding 经验]]></title>    <link>https://juejin.cn/post/7581545175509434420</link>    <guid>https://juejin.cn/post/7581545175509434420</guid>    <pubDate>2025-12-09T07:39:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581545175509434420" data-draft-id="7581477397507948578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享下我创业烧了 几十万的 AI Coding 经验"/> <meta itemprop="keywords" content="前端,JavaScript,后端"/> <meta itemprop="datePublished" content="2025-12-09T07:39:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金泥石流"/> <meta itemprop="url" content="https://juejin.cn/user/3421335914034983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享下我创业烧了 几十万的 AI Coding 经验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3421335914034983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金泥石流
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T07:39:38.000Z" title="Tue Dec 09 2025 07:39:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    204
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>差不多 1 年没写了，这两年一直忙着创业，抽个空给大家聊聊，扯扯闲天。</p>
<p>我思来想去能写的东西其实很多，比如</p>
<ul>
<li>一个前端老鸟是如何开始创业不归路的</li>
<li>搞技术的创业要注意哪些是</li>
<li>创业上班有啥不同</li>
<li>怎么融资，投资人都是什么路子</li>
<li>创业 2 年都踩过什么坑</li>
<li>如何找客户</li>
<li>如何做产品</li>
<li>AI 来了改变了什么</li>
</ul>
<p>不过我想了想，掘金毕竟是个开发者社区，还是先聊聊大家比较容易理解的技术侧的内容</p>
<p>首先是给个结论 <strong>传统软件开发基本要嘎了</strong></p>
<p>别的公司不知道，但是我们确实做到了在没有产品，测试，UI，前端，后端传统分工的情况下，完全通过 AI Coding 开发产品，上线，拿钱，交付，增长，迭代。</p>
<p>就是如果你还纠结 AI 原生组织，去掉所有岗位分工角色，只用 AI Coding 到底能不能代替传统软件开发模式，能不能上生产，能不能做出真的产品，那么我直接告诉你</p>
<p><strong>完全可以</strong> 前提是从 0 开始，丢掉所有的历史包袱，所以创业公司可以这么干。</p>
<p>下面的内容分享给那些用过，没用过，想用 AI Coding 组织或者同学们，这一篇我就只聊我的经验，后面有时间我再展开说。</p>
<h2 data-id="heading-0">AI Coding 里的上下文工程怎么做</h2>
<p>如果你翻一些开发团队的公众号，可能会把上下文工程给你说的神乎其神，或者长篇大论，但是对我的理解，我从 AI 作为编码工具到 AI 成为我的同事这个漫长的过程中，我的体验是，上下文工程只解决一个问题。</p>
<p>就是解决 AI 在没有记忆的情况下如何获取最新的结果，比如你发送了个需求让 AI Coding，AI 能不能知道上一次的修改结果，能不能基于最新的代码去推理来满足你的需求。</p>
<p>那么要解决这个问题有几条路径</p>
<ul>
<li>让 AI 读写查询搜索自己去组织上下文，目前主流 AI IDE 的做法，优点是自动化程度高，缺点是慢，费钱，而且准确性和需求的复杂度成反比，需求越复杂，性能越差</li>
<li>结合 RAG 做索引，早期 Cursor 类产品的主流做法，优点是便宜，理论上下文无限，现在用 google 的 api 成本大幅下降，缺点么就是基本没啥用，尤其是推理模型出来后，代码切片就跟盲人摸象差不多，反而增加了 AI 的推理难度，AI 还得想想你这切的支离破碎的代码到底想表达啥？因为大部分的项目都是业务项目，与其说里面是代码，不如说里面就是业务的一个 know how 的表达方式。代码的耦合性是很高的基本切开就玩完。</li>
<li>手工选择 + 自动注入，这是目前我们的做法，简单粗暴，直接将整个项目的代码序列化结构化变成一个 markdown 丢过去，然后允许工程师手工选择，优点就是准确性极佳，推理速度快，生成效果好，完全能满足生成要求，缺点么就是费钱，超级费钱，基本上密集开发周期内，单日消耗可以达到数百美金，还是在手工选择加持的情况下，完全不管的话大几千美金也打不住。</li>
</ul>
<p>然后现在各家 AI Coding 产品其实做的上下文工程就是围绕怎么把所有想让 AI 知道的的东西变成文本丢进去，难点在于很多内容很难文本化，并且丢一次是不够的，如何增量的丢，低成本的丢，快速的丢，都是技术，这方面的工程复杂度完全是一个全新的问题和领域</p>
<p>要做好上下文工程，产品和技术必须合二为一，不能分工，国内很多产品体验做的不好和我们长期的分工模式有关系，现在 AI 产品的设计，角色分工反而成了最大掣肘，从就业角度看，我觉得单独的产品和工程师以后都没啥活路，最好就是变成 <strong>产品工程师</strong> AI 干活你主导设计</p>
<h2 data-id="heading-1">AI Coding  对传统软件开发方式的影响</h2>
<p>先给结论，影响是颠覆性的革命性的，和过去我们经历的低代码/无代码那一波不一样，低代码无代码还是传统开发中针对业务场景的解决方案，是一个子集，人还是那些人，最后又加了一批脚本工程师。</p>
<p>但是 AI Coding 是掀桌子了，今天如果所有的公司是 AI 原生，AI Coding 的那么除了一批架构，转型快的还有活干，90% 的岗位都不存在了，没有任何独立的分工，垂直的工作给你，你想当螺丝钉，AI 比你更适合拧螺丝。</p>
<p>最大的影响是分工没了，AI 的知识结构和基于算力的特点，从资本效率上完全是碾压人类的，AI 欠缺的部分还需要人去补足，但是这个补他不需要一个团队，只需要一个人就够了，这意味着分工的消失。</p>
<p>基于 AI 的研发团队，结构是高度扁平，实现了我们最理想的模式，就是工程师流动的自由性，不像过去你的工作是被绑死在一个项目和代码上的。但是要做到这一点，就必须放手让 AI 去写代码。</p>
<p>必须是 100% 让 AI 写，任何混合式写法最后的结果就是，AI 和 人的能力都发挥不出来，今天还想着给团里的人配个 AI 提升效率的，我就直接告诉你们，短期有效，长期无效，还不如保持原来的传统模式，把 AI 就当成一次性工具，和低代码无代码一样解决一些业务场景的问题，AI 只是更智能而已，但是低代码/无代码解决不了的 AI 一样解决不了，不用指望大力出奇迹，人效飞上天，如果你们老板有这种想法，让他来找我，我免费给他上课，告诉他“别做梦！”。</p>
<p>总结下，影响是多方面的，一个是团队的分工，要想最大化收益，就是全干掉，变成一个工程师 + AI 的模式，其次是协同方式，必须数字化，平台化，依赖 IDE 你效率跑不起来。对 AI 来说，IDE的上下文很不完整，如果要自研一套基于 AI 的效率平台，最好的办法就是从 AI 出发为 AI 打造。</p>
<p>先写这些，1 年没写了，水两句让免得掘金把我给忘了😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter TolyUI 框架#11 | 标签 tolyui_tag]]></title>    <link>https://juejin.cn/post/7581385235964870690</link>    <guid>https://juejin.cn/post/7581385235964870690</guid>    <pubDate>2025-12-09T01:30:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581385235964870690" data-draft-id="7581386627676209192" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter TolyUI 框架#11 | 标签 tolyui_tag  "/> <meta itemprop="keywords" content="前端,Flutter,UI Kit"/> <meta itemprop="datePublished" content="2025-12-09T01:30:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter TolyUI 框架#11 | 标签 tolyui_tag  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T01:30:13.000Z" title="Tue Dec 09 2025 01:30:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1b2f7d2ec8b4ca0ac1b5feadf97637b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=800&amp;h=450&amp;s=33895&amp;e=jpg&amp;b=031126" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">《Flutter TolyUI 框架》系列前言:</h4>
<p><strong>TolyUI</strong> 是 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">张风捷特烈</a> 打造的 Fluter 全平台应用开发 UI 框架。具备 <strong>全平台</strong>、<strong>组件化</strong>、<strong>源码开放</strong>、<strong>响应式</strong> 四大特点。可以帮助开发者迅速构建具有响应式全平台应用软件：</p>
<blockquote>
<p>开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de8c6bed9bfe46b3865accea7d493d4c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1563&amp;h=409&amp;s=62505&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-1">1. 标签组件的设计动机</h4>
<p>在应用开发中，标签是一种常见的界面元素，用于分类标记、状态展示、筛选条件等场景。一个好的标签组件不仅要有美观的视觉效果，更要提供灵活的交互能力。从简单的静态展示到复杂的动态管理，从单一的样式到多样的变体，标签组件承载着丰富的功能需求。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb72f53c2632447581d12f12fa6c890f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=980&amp;h=454&amp;s=66029&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>TolyUI 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Ftolyui_tag" target="_blank" title="https://pub.dev/packages/tolyui_tag" ref="nofollow noopener noreferrer">tolyui_tag</a> 模块正是为此而设计。它不仅提供了基础的标签展示能力，还支持可关闭、可选择、动态添加等高级功能。通过合理的 API 设计和灵活的配置选项，让开发者能够轻松应对各种标签使用场景。其中包含两个核心组件:</p>
<ul>
<li><strong>TolyTag</strong> 展示独立的标签，可以设置标签类型、是否可关闭等。</li>
<li><strong>TolyTagGroup</strong> 展示标签组，可以支持单选、多选等功能。</li>
</ul>
<p>使用者可以独立引入模块包，或者使用 tolyui 全家桶：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 仅使用 tolyui_tag</span>
<span class="hljs-attr">dependencies:</span> 
   <span class="hljs-attr">tolyui_tag:</span> <span class="hljs-string">^last_version</span>

<span class="hljs-comment"># 使用 tolyui 全家桶 </span>
<span class="hljs-attr">dependencies:</span> 
    <span class="hljs-attr">tolyui:</span> <span class="hljs-string">^last_version</span>
</code></pre>
<p>下面来介绍相关组件的具体用法。</p>
<hr/>
<h4 data-id="heading-2">2. 基础标签展示</h4>
<p>最基本的用法是使用 Tag 组件展示静态标签。组件支持不同的颜色和变体样式，通过简单的配置就能实现丰富的视觉效果。</p>
<p>第一行展示了不同颜色的标签效果，通过 <code>color</code> 属性可以快速设置标签的主题色。第二行展示了四种变体样式：填充、边框、实心、虚线。每种样式都有其独特的视觉特征，适用于不同的使用场景。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2532493a16f44e80af150d155aecef49~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=721&amp;h=179&amp;s=14817&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不同颜色的标签</span>
TolyTag(child: Text(<span class="hljs-string">'默认样式'</span>))
TolyTag(color: Colors.red, child: Text(<span class="hljs-string">'红色 red'</span>))
TolyTag(color: Colors.purple, child: Text(<span class="hljs-string">'紫色 purple'</span>))
TolyTag(color: Colors.green, child: Text(<span class="hljs-string">'绿色 green'</span>))

<span class="hljs-comment">// 不同变体的标签</span>
TolyTag(variant: TagVariant.filled, color: Colors.blue, child: Text(<span class="hljs-string">'填充 filled'</span>))
TolyTag(variant: TagVariant.outlined, color: Colors.green, child: Text(<span class="hljs-string">'边框 outlined'</span>))
TolyTag(variant: TagVariant.solid, color: Colors.orange, child: Text(<span class="hljs-string">'实心 TolyTag'</span>))
TolyTag(variant: TagVariant.dashed, color: Colors.grey, child: Text(<span class="hljs-string">'虚线 dashed'</span>))
</code></pre>
<p>通过颜色和样式的组合，可以灵活应用于分类标记、状态展示、标签管理等场景。</p>
<hr/>
<h4 data-id="heading-3">3. 可关闭标签</h4>
<p>在实际应用中，标签往往需要支持动态删除。Tag 组件通过 <code>closable</code> 属性提供了关闭功能，配合 <code>onClose</code> 回调可以实现完整的删除交互。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f38908045974c498fb2738111f9ee3d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=717&amp;h=135&amp;s=9693&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></p>
<p>基于数据驱动的方式，可以轻松实现标签的动态管理。每个标签都可以独立关闭删除，点击关闭按钮后标签从列表中移除并显示提示信息。当有标签被删除时，右侧会出现重置标签，点击可恢复所有已删除的标签。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo2State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo2</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;TagData&gt; _initialTags = [
    TagData(label: <span class="hljs-string">'编程技术'</span>, variant: TagVariant.outlined),
    TagData(label: <span class="hljs-string">'拍摄影像'</span>, icon: Icons.camera, color: Colors.green),
    TagData(label: <span class="hljs-string">'Dart语言'</span>, icon: Icons.code, variant: TagVariant.outlined),
    TagData(label: <span class="hljs-string">'禁用状态'</span>, variant: TagVariant.filled, disabled: <span class="hljs-keyword">true</span>),
  ];

  <span class="hljs-keyword">late</span> <span class="hljs-built_in">List</span>&lt;TagData&gt; tags;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    tags = <span class="hljs-built_in">List</span>.from(_initialTags);
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Wrap(
      spacing: <span class="hljs-number">8</span>,
      runSpacing: <span class="hljs-number">8</span>,
      children: [
        ...tags.map((tag) {
          <span class="hljs-keyword">return</span> TolyTag(
            variant: tag.variant,
            closable: <span class="hljs-keyword">true</span>,
            disabled: tag.disabled,
            color: tag.color,
            icon: tag.icon != <span class="hljs-keyword">null</span> ? Icon(tag.icon, size: <span class="hljs-number">14</span>) : <span class="hljs-keyword">null</span>,
            onClose: () {
              setState(() =&gt; tags.remove(tag));
              $message.success(message: <span class="hljs-string">'已删除: <span class="hljs-subst">${tag.label}</span>'</span>);
            },
            child: Text(tag.label),
          );
        }),
        <span class="hljs-keyword">if</span> (tags.length &lt; _initialTags.length)
          GestureDetector(
            onTap: () {
              setState(() =&gt; tags = <span class="hljs-built_in">List</span>.from(_initialTags));
              $message.success(message: <span class="hljs-string">'已重置所有标签'</span>);
            },
            child: TolyTag(
              variant: TagVariant.filled,
              color: Colors.blue,
              icon: Icon(Icons.refresh, size: <span class="hljs-number">14</span>),
              child: Text(<span class="hljs-string">'重置'</span>),
            ),
          ),
      ],
    );
  }
}
</code></pre>
<p>这种数据驱动的模式让标签管理变得简单而优雅，示例包含了不同样式、颜色、图标的标签组合，以及禁用状态的展示，适用于标签管理、筛选条件、关键词编辑等需要动态增删的交互场景。</p>
<hr/>
<h4 data-id="heading-4">4. 动态添加标签</h4>
<p>除了删除，标签的动态添加也是常见需求。通过结合输入框和标签组件，可以实现完整的标签增删功能。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4eb0daa4c33044638db62e34dfe6d771~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=623&amp;h=419&amp;s=916037&amp;e=gif&amp;f=176&amp;b=fbfbf9" alt="" loading="lazy"/></p>
<p>用户可以通过关闭按钮删除已有标签，也可以点击虚线边框的添加按钮创建新标签。点击添加后会出现输入框，输入内容并回车或失焦即可完成添加。新标签会自动去重和去除空白，确保标签列表的整洁性。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo3State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo3</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; tags = [<span class="hljs-string">'上进'</span>, <span class="hljs-string">'努力'</span>, <span class="hljs-string">'成功'</span>, <span class="hljs-string">'创新'</span>, <span class="hljs-string">'热情'</span>];
  <span class="hljs-built_in">bool</span> _isAdding = <span class="hljs-keyword">false</span>;
  <span class="hljs-keyword">final</span> TextEditingController _tagInputController = TextEditingController();
  <span class="hljs-keyword">final</span> FocusNode _tagInputFocusNode = FocusNode();

  <span class="hljs-keyword">void</span> _handleSubmitted(<span class="hljs-built_in">String</span> value) {
    setState(() {
      <span class="hljs-keyword">final</span> newTag = value.trim();
      <span class="hljs-keyword">if</span> (newTag.isNotEmpty &amp;&amp; !tags.contains(newTag)) {
        tags.add(newTag);
      }
      _isAdding = <span class="hljs-keyword">false</span>;
      _tagInputController.clear();
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Wrap(
      spacing: <span class="hljs-number">8</span>,
      runSpacing: <span class="hljs-number">8</span>,
      children: [
        ...tags.map((tag) {
          <span class="hljs-keyword">return</span> TolyTag(
            closable: <span class="hljs-keyword">true</span>,
            color: Colors.blue,
            onClose: () =&gt; setState(() =&gt; tags.remove(tag)),
            child: Text(tag),
          );
        }),
        <span class="hljs-keyword">if</span> (_isAdding)
          SizedBox(
            width: <span class="hljs-number">90</span>,
            height: <span class="hljs-number">24</span>,
            child: TextField(
              controller: _tagInputController,
              focusNode: _tagInputFocusNode,
              onSubmitted: _handleSubmitted,
            ),
          )
        <span class="hljs-keyword">else</span>
          Tag(
            variant: TagVariant.dashed,
            onTap: () {
              setState(() =&gt; _isAdding = <span class="hljs-keyword">true</span>);
              _tagInputFocusNode.requestFocus();
            },
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(Icons.add, size: <span class="hljs-number">14</span>),
                SizedBox(width: <span class="hljs-number">4</span>),
                Text(<span class="hljs-string">'添加标签'</span>),
              ],
            ),
          ),
      ],
    );
  }
}
</code></pre>
<p>这种交互模式常用于个人信息编辑、兴趣标签管理、技能标签设置等需要用户自定义标签内容的场景。</p>
<hr/>
<h4 data-id="heading-5">5. 可选择标签</h4>
<p>对于筛选和分类场景，标签需要支持选择功能。TolyUI 提供了 TolyTagGroup 组件，支持单选和多选两种模式。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e73d7bc4dc04bebad27e867ed29b895~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=623&amp;h=419&amp;s=369664&amp;e=gif&amp;f=84&amp;b=fcfcfa" alt="" loading="lazy"/></p>
<p>单选模式下，点击标签会取消其他标签的选中状态，只保留当前选中项。多选模式下，可以同时选中多个标签。每个模式都实时显示当前选中的内容，提供直观的视觉反馈。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo4State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo4</span>&gt; </span>{
  <span class="hljs-built_in">String?</span> selectedCategory;
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; selectedTags = [];

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">const</span> TextStyle style = TextStyle(fontSize: <span class="hljs-number">14</span>,fontWeight: FontWeight.bold);
    <span class="hljs-keyword">const</span> TextStyle greyStyle = TextStyle(fontSize: <span class="hljs-number">12</span>,color: Colors.grey);
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Wrap(
          children: [
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'单选模式：'</span>,style: style),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            Text(<span class="hljs-string">'已选择：<span class="hljs-subst">${selectedCategory ?? <span class="hljs-string">"无"</span>}</span>'</span>,style: greyStyle),
          ],
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
        TolyTagGroup&lt;<span class="hljs-built_in">String</span>&gt;(
          options: <span class="hljs-keyword">const</span> [
            TagOption(value: <span class="hljs-string">'frontend'</span>, label: Text(<span class="hljs-string">'前端'</span>)),
            TagOption(value: <span class="hljs-string">'backend'</span>, label: Text(<span class="hljs-string">'后端'</span>)),
            TagOption(value: <span class="hljs-string">'mobile'</span>, label: Text(<span class="hljs-string">'移动端'</span>)),
            TagOption(value: <span class="hljs-string">'ai'</span>, label: Text(<span class="hljs-string">'人工智能'</span>)),
          ],
          value: selectedCategory,
          onChange: (value) =&gt; setState(() =&gt; selectedCategory = value),
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">24</span>),
        Wrap(
          children: [
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'多选模式：'</span>,style: style),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            Text(<span class="hljs-string">'已选择：<span class="hljs-subst">${selectedTags.isEmpty ? <span class="hljs-string">"无"</span> : selectedTags.join(<span class="hljs-string">", "</span>)}</span>'</span>,style: greyStyle),

          ],
        ),

        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
        TolyTagGroup&lt;<span class="hljs-built_in">String</span>&gt;(
          multiple: <span class="hljs-keyword">true</span>,
          options: <span class="hljs-keyword">const</span> [
            TagOption(value: <span class="hljs-string">'flutter'</span>, label: Text(<span class="hljs-string">'Flutter'</span>)),
            TagOption(value: <span class="hljs-string">'react'</span>, label: Text(<span class="hljs-string">'React'</span>)),
            TagOption(value: <span class="hljs-string">'vue'</span>, label: Text(<span class="hljs-string">'Vue'</span>)),
            TagOption(value: <span class="hljs-string">'angular'</span>, label: Text(<span class="hljs-string">'Angular'</span>)),
            TagOption(value: <span class="hljs-string">'nodejs'</span>, label: Text(<span class="hljs-string">'Node.js'</span>)),
          ],
          values: selectedTags,
          onChangeMultiple: (values) =&gt; setState(() =&gt; selectedTags = values),
        ),
      ],
    );
  }
}
</code></pre>
<p>示例中单选用于技术方向选择，多选用于技术栈选择。这种交互模式广泛应用于筛选器、分类选择、问卷调查、偏好设置等需要用户选择的场景。</p>
<hr/>
<h4 data-id="heading-6">6. 状态标签</h4>
<p>在系统中，标签常用于展示各种状态信息。通过不同的颜色和图标组合，可以直观地传达状态含义。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa87719ba9114dcc8ea95de35c2873f6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=721&amp;h=141&amp;s=9142&amp;e=png&amp;b=fffefe" alt="" loading="lazy"/></p>
<p>TolyUI 的 TolyTag 组件支持自定义图标，配合合适的颜色，可以创建出语义明确的状态标签。示例包含六种常见状态：成功、错误、警告、信息、等待中、处理中。每个状态都采用了符合直觉的颜色和图标搭配，特别是处理中状态使用了动态的加载指示器，提供更生动的视觉反馈。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.check_circle, size: <span class="hljs-number">12</span>, color: Colors.green),
  color: Colors.green,
  child: Text(<span class="hljs-string">'成功'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.error, size: <span class="hljs-number">12</span>, color: Colors.red),
  color: Colors.red,
  child: Text(<span class="hljs-string">'错误'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.warning, size: <span class="hljs-number">12</span>, color: Colors.orange),
  color: Colors.orange,
  child: Text(<span class="hljs-string">'警告'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.info, size: <span class="hljs-number">12</span>, color: Colors.blue),
  color: Colors.blue,
  child: Text(<span class="hljs-string">'信息'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.schedule, size: <span class="hljs-number">12</span>, color: Colors.grey),
  color: Colors.grey,
  child: Text(<span class="hljs-string">'等待中'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: CupertinoActivityIndicator(color: Colors.purple, radius: <span class="hljs-number">6</span>),
  color: Colors.purple,
  child: Text(<span class="hljs-string">'处理中'</span>),
)
</code></pre>
<p>这种模式广泛应用于任务状态跟踪、审批流程、订单状态、系统通知等需要明确状态表达的场景。</p>
<hr/>
<h4 data-id="heading-7">尾声</h4>
<p>toly_tag 模块为 Flutter 应用提供了完整的标签展示和交互能力。从基础的静态展示到动态的增删管理，从单一的样式配置到丰富的状态表达，它都能够胜任。无论你是在构建内容管理系统，还是开发社交应用，这个组件都能帮助你创建出既美观又实用的标签界面。</p>
<p>随着 tolyui 的逐步迭代，越来越多的新功能将会支持。感谢你关注 tolyui 的成长，如果喜欢，也希望你能在 github 中点赞支持~</p>
<blockquote>
<p>github 开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔]]></title>    <link>https://juejin.cn/post/7581385235964510242</link>    <guid>https://juejin.cn/post/7581385235964510242</guid>    <pubDate>2025-12-08T23:47:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581385235964510242" data-draft-id="7581385235964395554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-08T23:47:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T23:47:48.000Z" title="Mon Dec 08 2025 23:47:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，一个完整的 AI 全栈协同文档项目。这个项目涵盖了前端富文本编辑器（基于 Tiptap）、后端服务、AI 集成、实时协作等多个技术栈。在开发过程中，我积累了丰富的实战经验，包括 Tiptap 的深度定制、性能优化、协作功能实现等核心难点。如果你对 AI 全栈开发、Tiptap 富文本编辑器定制、或者 DocFlow 项目的完整技术方案感兴趣，想系统学习相关技术栈和最佳实践，欢迎加我微信 <code>yunmz777</code> 私聊咨询。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf437a5ed804b62b407246cbbfd9574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765842468&amp;x-signature=H6pEszCPtXo3pprOvi6u4Ur2YwQ%3D" alt="20251209053826" loading="lazy"/></p>
<p>用 Tiptap 做富文本编辑器，听起来挺美好，实际上却让不少人头疼。虽然它比从零开始写编辑器要友好得多，但真正上手后你会发现，想要做出一个能用的编辑器，难度远超预期。</p>
<p>这篇文章想聊聊，为什么 Tiptap 对很多人来说这么难，以及在实际项目中会遇到哪些坑。</p>
<h2 data-id="heading-0">为什么很多人选择 Tiptap</h2>
<p>先说说 Tiptap 吸引人的地方。</p>
<p><code>基于 ProseMirror 的稳健基础</code> 是它最大的卖点。ProseMirror 这个底层框架被 Notion、Linear 这些产品验证过，稳定性没问题。Tiptap 在它上面做了封装，提供了 starter-kit、基础扩展、getHTML、getJSON 这些常用 API，让你不用直接面对 ProseMirror 的复杂性。</p>
<p><code>模块化设计</code> 也很讨喜。按需加载，基础功能可以保持 bundle 很小，需要的时候再扩展。这种设计符合现代前端开发习惯，你可以根据项目需求灵活选择功能。</p>
<p><code>框架集成</code> 做得不错。React、Vue、Svelte 都有官方包，可以在熟悉的框架生态里工作，不用重新学习一套东西。</p>
<p><code>社区活跃度</code> 也还行。GitHub 上 star 不少，issue 讨论也很多，遇到问题至少能找到一些线索。</p>
<p>所以 Tiptap 确实降低了门槛，但降低门槛不等于消除复杂性。这是理解它为什么仍然困难的关键。</p>
<h2 data-id="heading-1">然而，"难"的原因很多</h2>
<p>"降低门槛" ≠ "变成容易"。下面这些挑战，往往在项目推进过程中才会逐渐暴露。</p>
<h3 data-id="heading-2">1. 底层复杂：ProseMirror 的抽象与复杂性</h3>
<p>Tiptap 虽然封装了 ProseMirror，但本质上还是基于它。有文章提到：</p>
<blockquote>
<p>"Tiptap is built on top of ProseMirror, a robust yet difficult to master editor."</p>
</blockquote>
<p>这话不假。一旦你需要做高级定制，比如自定义节点、插件、命令、协作同步，你就得深入 ProseMirror。那些抽象概念对很多前端工程师来说并不直观。</p>
<h4 data-id="heading-3">抽象概念的学习曲线</h4>
<p><code>Document Model</code> 是第一个坎。ProseMirror 用自己的一套文档模型，不是直接操作 DOM。这是个树状结构，每个节点有类型、属性、内容。理解这个模型需要思维转换，习惯了 DOM 操作的人一开始会不适应。</p>
<p><code>Schema</code> 设计也不简单。它定义了文档里能有哪些节点和标记，以及它们之间的关系。设计一个合理的 schema 需要深入理解文档结构，遇到表格嵌套、列表嵌套这些复杂情况时尤其头疼。</p>
<p><code>Transaction</code> 系统是另一个难点。ProseMirror 用 transaction 处理所有文档变更，每个编辑操作都会创建一个 transaction，描述从旧状态到新状态的变化。要实现撤销、重做、协作这些功能，必须理解 transaction 的工作原理。</p>
<p><code>Selection</code> 管理比想象中复杂。不同浏览器对 selection 的处理不一致，文档结构复杂时（比如表格、列表），selection 的行为经常不符合预期。你以为选中了，实际上可能选中的是别的东西。</p>
<p><code>Node View</code> 更麻烦。当你需要自定义节点渲染和交互时（比如代码块、表格、嵌入内容），你得同时理解 React、Vue 组件系统和 ProseMirror 的节点系统，两者之间的桥接并不总是直观。</p>
<h4 data-id="heading-4">实际开发中的具体困难</h4>
<p>很多人一开始觉得"写个富文本编辑器不就是个 textarea + toolbar 吗"，等真正要兼容多个格式、插入图片表格、撤销重做、协作、粘贴处理、HTML 和 JSON 转换时，才发现坑深如海。</p>
<p>举个例子，实现一个简单的图片上传功能，你需要：</p>
<ol>
<li>创建自定义 Image 节点类型</li>
<li>实现 Node View 来渲染图片</li>
<li>处理图片上传逻辑（拖拽、粘贴、URL 输入等多种方式）</li>
<li>处理图片加载失败的情况</li>
<li>实现图片大小调整、对齐等功能</li>
<li>处理响应式布局</li>
<li>处理图片的序列化和反序列化</li>
</ol>
<p>这还只是图片功能。如果再加上表格、代码块、嵌入内容，复杂度会成倍增加。</p>
<h3 data-id="heading-5">2. 功能多样，需求场景差异极大</h3>
<p>富文本编辑器不是"一个按钮能解决所有问题"。不同应用对文档编辑的需求千差万别，这种多样性让"万能"解决方案变得不现实。</p>
<h4 data-id="heading-6">从 Word、Google Docs 复制粘贴的噩梦</h4>
<p>从 Word 复制内容到编辑器，听起来简单，实际上是个噩梦。</p>
<p>浏览器接收到的是一堆内联样式、嵌套的 div 和 span、字体信息、颜色信息。这些内容需要被"清洗"和转换为你编辑器中的节点结构。你得识别和转换段落、标题、列表，处理表格（包括合并单元格、嵌套表格），处理图片和嵌入内容，清理不必要的样式和标签，处理特殊字符和编码问题。</p>
<p>很多编辑器（包括 Tiptap）对此处理并不理想。你往往需要自己实现或扩展粘贴处理逻辑，这需要深入理解 ProseMirror 的 paste rules 和 clipboard 处理机制。</p>
<h4 data-id="heading-7">媒体与复杂内容支持的工作量被低估</h4>
<p>你可能需要支持图片、视频、embed、附件、表格、表单，还要支持拖拽、上传、调整、重排、自定义样式、响应式、兼容多端。这意味着不仅是文本，还要管理复杂结构。</p>
<p>以表格为例，实现一个功能完整的表格编辑器需要：</p>
<ul>
<li>表格的创建、删除、行列的增删</li>
<li>单元格的合并和拆分</li>
<li>表格样式的自定义（边框、背景色、对齐方式等）</li>
<li>表格内容的编辑（包括嵌套其他节点类型）</li>
<li>表格的响应式处理（在小屏幕上如何显示）</li>
<li>表格的序列化和反序列化</li>
<li>表格的复制粘贴处理</li>
</ul>
<p>这还只是表格。如果再加上图片的拖拽调整大小、视频的播放控制、嵌入内容的交互，工作量会急剧增加。很多人低估了这部分工作量，以为"用个扩展就行"，实际上往往需要大量的定制开发。</p>
<h4 data-id="heading-8">协作功能的指数级复杂度</h4>
<p>如果还要加协作（多人实时编辑）、版本历史、评论、建议编辑、合并、冲突解决，那就更复杂了。有文章指出："无论你选择哪种富文本编辑器，把协作功能加进去都是一件非常具有挑战性的事情。"</p>
<p>协作编辑涉及：</p>
<ul>
<li><code>实时同步</code>：需要 WebSocket 或类似技术来实时同步编辑操作</li>
<li><code>冲突解决</code>：当多个用户同时编辑同一部分时，如何解决冲突</li>
<li><code>操作转换（OT）或 CRDT</code>：需要算法来保证最终一致性</li>
<li><code>版本历史</code>：需要记录每次变更，支持回滚和查看历史</li>
<li><code>权限管理</code>：不同用户可能有不同的编辑权限</li>
<li><code>评论系统</code>：需要在文档中插入评论，并管理评论的生命周期</li>
<li><code>建议编辑</code>：允许用户提出编辑建议，而不是直接修改</li>
</ul>
<p>即使使用 Y.js 这样的协作框架，你仍然需要处理很多细节，比如如何将 ProseMirror 的 transaction 转换为 Y.js 的操作，如何处理网络延迟和断线重连，如何处理冲突等。</p>
<p><code>通用 + 万能 + 高可定制 + 多功能</code>，是个"理想"与"魔鬼"并存的组合。很多团队和个人在最初没评估清楚就上了车，最后才发现问题。</p>
<h3 data-id="heading-9">3. 性能、UX、浏览器兼容的复杂度</h3>
<h4 data-id="heading-10">性能问题的真实存在</h4>
<p>有人反映，当文档很长（上百、几百条目、复杂结构）且含多种格式、嵌入、样式、块时，Tiptap 的响应会变慢。有使用者说：</p>
<blockquote>
<p>"One of the big gotchas I've had with TipTap is that it's extremely sluggish once you get to more than 300 words or so and you're using different formatting options."</p>
</blockquote>
<p>这个问题的根源在于：</p>
<ul>
<li><code>DOM 操作的开销</code>：每次编辑操作都可能触发 DOM 的更新，当文档很大时，这些更新会变得很慢</li>
<li><code>重渲染的成本</code>：React、Vue 组件的重渲染可能不够优化，导致不必要的更新</li>
<li><code>内存占用</code>：大文档会占用大量内存，特别是在移动设备上</li>
</ul>
<p>解决性能问题需要按需渲染、虚拟滚动、优化更新策略、垃圾回收优化、防抖和节流。这些优化都需要深入理解 ProseMirror 和框架的工作原理，不是简单的配置就能解决的。</p>
<h4 data-id="heading-11">跨浏览器兼容性的挑战</h4>
<p>不同浏览器对 content-editable、selection、复制粘贴行为的处理并不一致。兼容性问题、剪贴板行为差异、样式冲突、默认样式覆盖、CSS reset、响应式布局等等，都容易让人头疼。</p>
<p>具体问题包括：</p>
<ul>
<li><code>Selection API 的差异</code>：不同浏览器对 selection 的处理方式不同，特别是在处理复杂节点（如表格、列表）时</li>
<li><code>Clipboard API 的差异</code>：复制粘贴的行为在不同浏览器中可能不同</li>
<li><code>ContentEditable 的行为差异</code>：不同浏览器对 content-editable 元素的处理方式不同</li>
<li><code>移动端的特殊问题</code>：移动端的键盘、触摸事件、输入法等都会影响编辑体验</li>
<li><code>样式兼容性</code>：不同浏览器的默认样式不同，需要大量的 CSS reset 和兼容性处理</li>
</ul>
<p>这正是很多人不想"从头搞一个富文本编辑器"的原因。</p>
<h4 data-id="heading-12">生产环境的额外复杂度</h4>
<p>如果你的编辑器用于生产系统，还可能涉及数据持久化、存储格式选择、解析和回显、版本控制、迁移、与后端兼容、安全（XSS）、国际化、多语言、字体、排版、方向（RTL）等。</p>
<p>当这些积累起来，远超"几行代码 + 一个 toolbar + 一个富文本输入框"的复杂度。</p>
<h3 data-id="heading-13">4. 社区与文档 ≠ "覆盖所有场景"</h3>
<p>虽然 Tiptap 本身文档、示例、社区不错，但对于特定复杂场景（比如"带表格 + 嵌入 + 自定义 node + 协作 + Undo、Redo + 导出 + 插件系统 + 自定义样式、主题、布局、响应式、多端"），几乎不存在一个"现成解决方案"。</p>
<h4 data-id="heading-14">文档的局限性</h4>
<p>Tiptap 的官方文档主要覆盖了基础用法和常见场景，但对于复杂场景，文档往往只能提供方向性的指导，具体的实现细节需要你自己去探索。</p>
<p>比如如何实现一个自定义的表格编辑器，支持合并单元格、调整列宽等功能？如何实现一个代码块编辑器，支持语法高亮、行号、代码折叠？如何实现一个协作编辑系统，处理冲突和同步？如何实现一个导出系统，将编辑器内容导出为 PDF、Word 等格式？</p>
<p>这些场景的文档往往不够详细，或者根本没有文档。你需要阅读源码来理解工作原理，在 GitHub 上搜索相关的 issue 和讨论，在社区中提问（但可能得不到及时回复），自己实验和调试。</p>
<h4 data-id="heading-15">需要自己设计的部分</h4>
<p>多数时候你得自己设计 Schema、Node View、Commands、插件体系、交互逻辑、前端-后端同步、数据库存储方案等。</p>
<p><code>复杂度被隐藏在"源码 + 配置 + 扩展 + 兼容性 + 性能调优 + 测试 + 边界 case 处理"</code> 后面。</p>
<h4 data-id="heading-16">从"用个库就好"到"坑太多"的转变</h4>
<p>很多人在刚开始抱着"用个库就好"的想法，但不到真正要满足复杂需求的时候，就发现坑太多。</p>
<p>你以为插入图片很简单，结果发现需要处理上传、加载失败、响应式、拖拽调整大小等多个问题。你以为实现表格很简单，结果发现需要处理合并单元格、嵌套表格、复制粘贴等复杂情况。你以为实现协作很简单，结果发现需要处理冲突、同步、权限等多个问题。</p>
<p>有人甚至建议，如果你的需求很基础（只是简单文字 + 粗体斜体 + 列表 + 少量图片），用 Markdown 编辑器 + 轻量富文本或简易配置反而更稳。</p>
<h3 data-id="heading-17">5. 心理预期 vs 现实落地</h3>
<p>很多产品经理或不熟悉富文本底层的人，会把富文本编辑器当成"轻量版 Word、Google Docs、所见即所得编辑器"。但事实是，浏览器里的 contenteditable + 富文本编辑器，受限于 DOM、Selection、样式、多端差异、复制粘贴行为、HTML → Model → HTML 的 round-trip、标准兼容性、性能、插件生态等等。</p>
<h4 data-id="heading-18">Word 级别的功能需要 Word 级别的投入</h4>
<p>要做到"像 Word 那么强大又稳定"，就算用了 Tiptap，也至少要投入非常多开发 + 测试 + 兼容 + 优化 + 维护成本。</p>
<p>Word 的表格编辑器是几十年的积累，而 Web 编辑器要实现类似功能需要从零开始。Word 的协作功能是 Microsoft 团队多年研发的结果，而 Web 编辑器要实现类似功能需要自己实现或集成第三方服务。Word 的导出功能支持多种格式，而 Web 编辑器要实现类似功能需要集成多个库或自己实现。</p>
<h4 data-id="heading-19">"跳进兔子洞"的风险</h4>
<p>这是为什么很多从头搞的人（尤其业务方、非编辑器专注团队）最终放弃的原因。甚至有开发者在讨论里直言：构建富文本编辑器"像跳进 rabbit hole"（兔子洞），风险太大，不靠谱。</p>
<p>这个比喻很形象：你以为只是挖一个小洞，结果发现下面是一个深不见底的兔子洞，越挖越深，越挖越复杂，最终发现自己投入的时间和精力远超预期。</p>
<h2 data-id="heading-20">对开发者、项目经理、内容生产者来说：为什么依旧容易被难住</h2>
<p>对于不同类型的角色，Tiptap 的困难点可能有所不同，但都会面临一些共同的挑战。</p>
<h3 data-id="heading-21">内容存储格式的复杂性</h3>
<p>你需要考虑 HTML、JSON、markdown、自定义格式。Tiptap 支持 JSON、HTML 输出、回显，但如果你要自定义节点（例如 embed、图文混排、特殊 block、meta 数据、AI-辅助内容），那就需要你设计 schema，处理序列化、反序列化逻辑，以及前后端如何统一处理这些内容结构。</p>
<h4 data-id="heading-22">格式选择的权衡</h4>
<p>每种格式都有其优缺点：</p>
<ul>
<li><code>HTML</code>：最直观，但可能包含大量冗余信息，不利于存储和传输</li>
<li><code>JSON</code>：结构化好，易于处理，但需要自定义解析逻辑</li>
<li><code>Markdown</code>：简洁，但表达能力有限，不适合复杂内容</li>
<li><code>自定义格式</code>：最灵活，但需要自己实现所有逻辑</li>
</ul>
<p>选择哪种格式需要根据你的具体需求来决定，这个决定会影响整个系统的架构。</p>
<h4 data-id="heading-23">Schema 设计的挑战</h4>
<p>设计一个好的 schema 需要考虑哪些节点类型是必需的、节点之间的包含关系、节点的属性、节点的默认样式和行为、如何扩展 schema 以支持未来需求。这需要深入理解你的内容模型和业务需求。</p>
<p>Tiptap 文档中虽有基础 API，但自定义越深，你要写的东西就越多。</p>
<h3 data-id="heading-24">可视化与发布的多个层面</h3>
<p>如果你希望支持可视化、可发布（类似公众号、社交媒体、Markdown 转 HTML、文章导出、静态页面），你还可能涉及样式渲染、响应式、兼容性、多端适配、HTML sanitation、安全（XSS）、图片、资源管理、SEO、导出与预览等。</p>
<p>每个层面都需要深入的工作，不是简单的配置就能解决的。</p>
<h3 data-id="heading-25">协作功能的指数级复杂度</h3>
<p>若你还想加协作（多人编辑、实时、历史、评论、AI 辅助、版本、导出、回滚），那复杂度呈指数级增长。</p>
<h4 data-id="heading-26">基础框架只是开始</h4>
<p>即便 Tiptap + Y.js + WebSocket、后端，也只是基础框架。你可能还需要额外处理冲突解决、数据同步、权限管理、undo、redo、版本存储、合并逻辑、并发控制、UI、UX 体验、多端协作（桌面、移动）等。</p>
<h4 data-id="heading-27">"要么你自己写，要么妥协"</h4>
<p>很多细节是"要么你自己写，要么妥协"。如果你需要显示其他用户的光标位置，你需要自己实现这个功能。如果你需要支持评论和建议编辑，你需要自己实现这些功能。如果你需要支持版本历史，你需要自己实现版本管理系统。</p>
<p>事实证明，哪怕是经验丰富的团队也要花费相当多时间。</p>
<h3 data-id="heading-28">性能与用户体验的持续挑战</h3>
<p>当文档较大、格式复杂、包含多种节点、嵌入、图片、表格、样式时，要保证编辑体验流畅、不卡顿、不闪烁、不延迟，是个挑战。</p>
<p>性能问题可能出现在输入延迟、滚动卡顿、渲染延迟、内存占用、CPU 占用等多个维度。</p>
<p>尤其对移动端、低性能设备，或者需要即时渲染、同步、预览时，卡顿体验对用户友好度伤害很大。移动端的挑战包括性能更有限、触摸交互与鼠标交互不同、键盘输入体验不同、网络可能不稳定、电池续航需要考虑等。</p>
<h3 data-id="heading-29">这些挑战是核心需求，不是边缘用例</h3>
<p>如果你未来可能会做"复杂内容 + 社交、公众号、文章、AI 辅助、可能多人协作、排版导出"的系统，这些挑战并不是边缘用例，而可能是核心需求。这意味着你不能简单地"先做一个简单版本，以后再优化"，而是需要在设计阶段就考虑这些挑战。</p>
<h2 data-id="heading-30">总结：为什么"对很多人来说，Tiptap 很难"</h2>
<h3 data-id="heading-31">富文本编辑本身是高度复杂的问题</h3>
<p>格式多样（文本、段落、列表、样式、嵌入、媒体、表格...）+ 用户期望高（像 Word、Google Docs、CMS 编辑那样自然）+ 浏览器、DOM、标准、兼容性、性能各类限制，这些因素叠加在一起，使得富文本编辑成为一个高度复杂的问题。</p>
<h3 data-id="heading-32">底层复杂度依然存在</h3>
<p>虽然 Tiptap 封装了一些基础，但底层仍是复杂，高度定制、复杂功能、实用级需求基本都需要"深入 ProseMirror + 自己实现"。Tiptap 降低了入门门槛，但没有消除复杂性。</p>
<h3 data-id="heading-33">成本压力大</h3>
<p>对大多数中小团队、个人开发者、希望快速上线的人来说，真正把富文本编辑器"做好、做稳、做可维护"，工时、测试、兼容性、性能、维护、边缘 case 全都压得人喘不过气。这个成本往往被低估。</p>
<h3 data-id="heading-34">维护成本持续累积</h3>
<p>当需求不断变化（新功能、新格式、新媒体、新协作、新导出、新兼容）的时候，维护成本会不断累积，很多人最终发现"再也不想碰富文本编辑器"。这是一个持续的过程，不是一次性的投入。</p>
<h3 data-id="heading-35">心理预期与现实的差距</h3>
<p>很多人对富文本编辑器的期望是"像 Word 那样强大"，但现实是 Web 编辑器的能力有限，要实现类似功能需要大量投入。这个差距导致了很多项目的失败。</p>
<h2 data-id="heading-36">建议：基于实际需求的实践路径</h2>
<p>虽然 Tiptap 很难，但这并不意味着你不应该使用它。关键是要有正确的预期和合理的规划。</p>
<h3 data-id="heading-37">1. 先做 Minimal Viable Editor (MVE)</h3>
<p>用 Tiptap + StarterKit 做基础（段落、标题、粗体、斜体、列表、链接、图片）。如果你主要是发文、写文章、有一定样式要求，这足够。不要一开始就试图实现所有功能。</p>
<h3 data-id="heading-38">2. 根据需要逐步扩展</h3>
<p>只当确实需要"嵌入、表格、特殊布局、导出、协作、AI 插件、自定义 node"时，再考虑扩展，而不是一开始就设计"万能 + 所有可能功能"。每个功能的添加都需要评估其成本和收益。</p>
<h3 data-id="heading-39">3. 把 Schema、数据结构设计做好</h3>
<p>选好内容存储格式（JSON、HTML、自定义 + metadata），并确保前后端、导入导出、兼容、未来扩展都考虑进去。一个好的数据结构设计可以避免很多后续问题。</p>
<h3 data-id="heading-40">4. 权衡收益 vs 成本</h3>
<p>对于一些不常用或复杂功能（比如复杂表格、拖拽布局、多人协作、版本控制、复杂导出...）要评估清楚，是不是值得投入，或者可以通过 Markdown + 插件 + 后处理导出来替代。不是所有功能都需要在编辑器中实现。</p>
<h3 data-id="heading-41">5. 做好测试与回退、兼容策略</h3>
<p>包括浏览器兼容、移动端、自定义样式、theme、内容导出、清洗（sanitize）、未来迁移、升级。这些工作虽然繁琐，但对于生产环境是必需的。</p>
<h3 data-id="heading-42">6. 考虑替代方案</h3>
<p>如果你的需求相对简单，考虑使用 Markdown 编辑器 + 后处理的方式，可能比直接使用富文本编辑器更简单、更稳定。Markdown 虽然表达能力有限，但对于很多场景已经足够，而且实现和维护成本要低得多。</p>
<h3 data-id="heading-43">7. 寻求专业帮助</h3>
<p>如果项目预算允许，考虑寻求专业的编辑器开发团队或咨询服务的帮助。富文本编辑器是一个专业领域，有经验的人可以帮你避免很多坑。</p>
<h2 data-id="heading-44">总结</h2>
<p>Tiptap 是一个优秀的富文本编辑器框架，它确实降低了开发门槛，但这并不意味着它简单。理解其复杂性，有正确的预期，做好规划，是成功使用 Tiptap 的关键。</p>
<p>如果你正在考虑使用 Tiptap，希望这篇文章能帮助你更好地评估项目的复杂度和成本，做出明智的决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[检测开发者工具是否打开？这几种方法让黑客无处遁形🤣]]></title>    <link>https://juejin.cn/post/7581619505584128051</link>    <guid>https://juejin.cn/post/7581619505584128051</guid>    <pubDate>2025-12-09T02:54:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581619505584128051" data-draft-id="7581374664327315507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="检测开发者工具是否打开？这几种方法让黑客无处遁形🤣"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2025-12-09T02:54:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            检测开发者工具是否打开？这几种方法让黑客无处遁形🤣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:54:42.000Z" title="Tue Dec 09 2025 02:54:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be74d43fd534de5a4dd96ea18a2075a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=OiOSXoPShXsr5SztLkLwb%2Fh3A4I%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我来了😁。</p>
<p><strong>前端代码在浏览器里是裸奔的。</strong>——这几乎是所有开发者的共识。</p>
<p>只要用户按一下 <code>F12</code>，你的源码、你的接口、你的数据结构，全部一览无余。黑客可以修改你的变量，脚本小子可以刷你的接口，竞品可以分析你的逻辑。</p>
<p>很多老板会问：能不能禁止用户打开控制台？</p>
<p>通常我们的回答是：不能。浏览器是用户的地盘，我们无权干涉。</p>
<p>但是， <strong>禁止不了，不代表我们检测不到。</strong></p>
<p>如果在检测到用户打开 DevTools 的那一瞬间，我们立马<strong>清空敏感数据</strong>、<strong>停止视频播放</strong>、或者<strong>无限 debugger 卡死页面</strong>，是不是就能极大地提高攻击者的门槛？🤔</p>
<p>今天，我就来分享几种利用浏览器API技巧实现的 <strong>DevTools 检测技术</strong>。</p>
<hr/>
<h4 data-id="heading-0"><strong>1.利用 <code>debugger</code> 的时间差</strong></h4>
<p>这是最古老、最暴力，但也最有效的方法之一。</p>
<p>原理：</p>
<p>当 DevTools 打开，并且开启了断点调试功能时，代码执行到 debugger 语句会暂停。</p>
<p>而不打开 DevTools 时，debugger 语句会被浏览器忽略，代码瞬间执行过去。</p>
<p>我们可以记录 <code>debugger</code> 语句前后的<strong>时间戳</strong>。如果差值过大，说明代码被暂停了——也就是说，DevTools 肯定是开着的。</p>
<p><strong>具体代码👇：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkDevTools</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-comment">// 核心：这就好比在路上设个卡</span>
  <span class="hljs-keyword">debugger</span>; 
  
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-comment">// 如果暂停时间超过 100ms，判定为有人在调试</span>
  <span class="hljs-keyword">if</span> (end - start &gt; <span class="hljs-number">100</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"警告：检测到开发者工具已打开！"</span>);
    <span class="hljs-comment">// 这里可以执行你的防御逻辑：</span>
    <span class="hljs-comment">// window.location.reload(); </span>
    <span class="hljs-comment">// clearSensitiveData();</span>
  }
}

<span class="hljs-comment">// 搞个定时器，每秒查岗一次</span>
<span class="hljs-built_in">setInterval</span>(checkDevTools, <span class="hljs-number">1000</span>);
</code></pre>
<p>优点是简单粗暴，对付小白有效。</p>
<p>缺点的话 有点扰民😖。如果攻击者禁用了断点功能（Deactivate breakpoints），或者设置⚙中配置了Never pause here，这招就废了。</p>
<hr/>
<h4 data-id="heading-1"><strong>2.利用 <code>console.log</code> 的对象懒加载</strong></h4>
<p>这是一个非常骚的检测方法，利用了 Chrome 控制台的一个特性：<strong>对象求值（Object Evaluation）</strong> 。</p>
<p>原理：</p>
<p>当你执行 console.log(obj) 时，浏览器为了性能，并不会立刻把 obj 的所有属性打印出来。它只打印一个引用。</p>
<p>只有当控制台真的是打开状态，并且需要显示内容时，浏览器才会去读取这个对象的属性（getters）。</p>
<p>我们可以给一个对象定义一个 <code>getter</code>（读取器）。如果这个 <code>getter</code> 被触发了，就说明<strong>有一个观察者（DevTools）正在看它</strong>。</p>
<p><strong>直接上代码👇：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> element = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(element, <span class="hljs-string">'id'</span>, {
  <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// 只有当 DevTools 打开时，浏览器尝试获取 element.id 来显示详情</span>
    <span class="hljs-comment">// 这个 getter 才会执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'抓到你了！DevTools 是开着的！'</span>);
    
    <span class="hljs-comment">// 执行防御逻辑</span>
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请关闭开发者工具继续浏览！'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'detected'</span>;
  }
});

<span class="hljs-comment">// 定时打印这个 element</span>
<span class="hljs-comment">// 如果控制台没开，log 只是静默执行，不会触发 getter</span>
<span class="hljs-comment">// 如果控制台开了，log 为了显示 element 的详情，会触发 getter</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(element);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 刷屏清空，防止用户发现</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
<hr/>
<p>优点是隐蔽性极强，不需要 <code>debugger</code>，不会打断代码执行。缺点呢？严重依赖浏览器实现。Chrome 上效果最好，Firefox/Safari 的行为可能不同。</p>
<hr/>
<h4 data-id="heading-2"><strong>3.无限 Debugger (防调试)</strong></h4>
<p>这其实不是检测，而是劝退。</p>
<p>很多网站（比如某些视频站、加密小说站），会用一种让黑客极其恶心的手段：<strong>只要你敢开控制台，我就让你卡死。</strong></p>
<p>原理：</p>
<p>利用 Function.constructor 或 eval，在一个高频循环里不断生成新的 debugger。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 放在一个立即执行函数里</span>
(<span class="hljs-keyword">function</span> <span class="hljs-title function_">anonymous</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 定义一个生成 debugger 的函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">debuggerLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 通过构造函数生成 debugger，防止源码被静态搜索到</span>
      (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">"debugger"</span>))(); 
    } <span class="hljs-keyword">catch</span> (e) {}
  }

  <span class="hljs-comment">// 只要没被拦截，我就一直递归调用</span>
  <span class="hljs-comment">// 也可以配合 setInterval</span>
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">debuggerLoop</span>();
  }, <span class="hljs-number">50</span>); <span class="hljs-comment">// 每 50ms 炸你一次🤣</span>
})();
</code></pre>
<p>效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95b25ac655bc43f3b46e61f5047b6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=W2t%2FIZzyiwQLlfrTGmqzhbPxZMI%3D" alt="image.png" loading="lazy"/></p>
<p>一旦你打开 F12，你的浏览器就会立刻被无数个断点暂停。点击继续运行？没用，50ms 后下一个断点又来了。你的页面基本处于假死状态，根本没法操作 DOM 或发请求。</p>
<p>这也是为什么你在调试某些网站时，会发现 <code>Sources</code> 面板里全是 <code>VMxxxx</code> 开头的匿名脚本，而且一直卡在 <code>debugger</code> 上。</p>
<hr/>
<h4 data-id="heading-3"><strong>如何绕过呢？🤔</strong></h4>
<p>作为补充，我必须告诉你，这些防御<strong>都不是无敌的</strong>。</p>
<p><strong>对于无限 Debugger：</strong></p>
<ol>
<li><strong>禁用断点</strong>：在 Chrome DevTools 里点击那个禁用所有断点的图标，世界瞬间清净了。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eb18ae20bbb452f9ac906bb4fa0c82b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=JP0Vx2iUWpG7igBV971gsR%2FC7WY%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li><strong>条件断点</strong>：在那个 <code>debugger</code> 行右键 -&gt; 停用断点。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17b75a3b47e340a0bb1f118572367334~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=Q0qCbHYJlla8dBibXIy3XHSfSjc%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>本地替换</strong>：用 Chrome 的 本地替换功能，把那段 JS 代码替换成本地空文件。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f16fb8bcdf4bb092e764b0aabcc5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=inXbW7V5BQUA7XBACLC08Bg%2Btk8%3D" alt="image.png" loading="lazy"/></p>
<p>对于Getter 检测呢？🤔</p>
<p>黑客可以直接 Hook console.log，让它失效😖。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 你的检测逻辑就废了</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">console</span>.<span class="hljs-property">log</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}; 
</code></pre>
<hr/>
<p>任何前端安全手段，本质上都是 <strong>防君子，防不了小人</strong>，或者说是<strong>提高攻击门槛</strong>。</p>
<p>在浏览器这个完全开放的环境里，没有什么秘密能真正藏得住。</p>
<p><strong>不要把核心业务逻辑（比如金额计算、权限校验）放在前端。</strong></p>
<p>这些检测手段，更多是用来保护<strong>知识产权</strong>（防止小白扒代码）或者<strong>反爬虫</strong>（检测到调试就停止渲染数据）。</p>
<p><strong>学会这几招，起码能挡住 90% 的脚本小子。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83eae55c2df64ab283a86d5162441714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=1xxNUyL4wG5IZ6cg7xW3%2FcA%2FqHI%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀]]></title>    <link>https://juejin.cn/post/7581428845683179563</link>    <guid>https://juejin.cn/post/7581428845683179563</guid>    <pubDate>2025-12-09T07:35:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581428845683179563" data-draft-id="7581408984415977491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-09T07:35:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐诗"/> <meta itemprop="url" content="https://juejin.cn/user/712139266339694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139266339694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐诗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T07:35:54.000Z" title="Tue Dec 09 2025 07:35:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>发现了一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 的仓库，目前 1.1k 🌟</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f1fe86aff7244a5976971c5b4a25b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=dEm312DTNp7b4bPZr3TUdf2l0y0%3D" alt="image.png" loading="lazy"/></p>
<p>可以使用 ai 来重写已经提交的 git commit 信息，<strong>修改后需要强制提交</strong></p>
<p>这对于之前 git commit 信息写的乱七八糟的项目，又不想手动改，现在一行命令就能解决这个问题！</p>
<p>写这个文章的原因是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 我觉得她这个使用说明写的不是很好懂，但还是建议阅读下！</p>
<h2 data-id="heading-0">准备工作</h2>
<p>可以使用 OpenAI GPT 或本地 Ollama 模型进行 AI 驱动的提交信息生成</p>
<p>这里我们使用 Ollama 模型进行 AI 驱动的提交信息生成</p>
<p>首先你需要安装 Ollama <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ollama.com%2Fquickstart" target="_blank" title="https://docs.ollama.com/quickstart" ref="nofollow noopener noreferrer">猛击参考官方文档安装</a></p>
<p>然后 Ollama 现在有一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ollama.com%2Fcloud" target="_blank" title="https://docs.ollama.com/cloud" ref="nofollow noopener noreferrer">Cloud 云模型</a>，大概就是使用 Ollama 调用云端模型达成和本地运行一样的效果。</p>
<p>运行云模型需要一个 ollama.com 上的账户，执行 <code>ollama signin</code> 登录或创建账户，登录完成后点击头像-&gt;设置，可以看到限额情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bef29bd75d6405087e6680eb64b49df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=KGLdfIx3JUCf6ijWXol%2FSoq1Dd0%3D" alt="image.png" loading="lazy"/></p>
<p>云模型后边会有标识</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5320cb60121d42c4a0a7404aabb329cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=NxIFShBmFVUgf4G3t7i70KvvtgE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">开始使用</h2>
<pre><code class="hljs language-bash" lang="bash">npx git-rewrite-commits --provider ollama --model qwen3-coder:480b-cloud --min-quality-score 10 --language zh --verbose
</code></pre>









































<table><thead><tr><th>参数</th><th>简写</th><th>值</th><th>作用说明</th></tr></thead><tbody><tr><td><code>--provider</code></td><td>无</td><td><code>ollama</code></td><td>指定 AI 服务提供商，选择使用本地运行的 Ollama 服务处理请求</td></tr><tr><td><code>--model</code></td><td><code>-m</code></td><td><code>qwen3-coder:480b-cloud</code></td><td>指定使用的 AI 模型名称，此处为 Qwen3 Coder 云端版本</td></tr><tr><td><code>--min-quality-score</code></td><td>无</td><td><code>10</code></td><td>设置质量评分阈值，提交评分低于此值的将被重写，设置为 10 表示强制重写所有提交</td></tr><tr><td><code>--language</code></td><td><code>-l</code></td><td><code>zh</code></td><td>设置生成提交信息的语言，此处为中文（简体）</td></tr><tr><td><code>--verbose</code></td><td><code>-v</code></td><td>无（标志参数）</td><td>启用详细输出模式，显示处理过程中的详细信息、评分结果、AI 响应内容等</td></tr></tbody></table>
<p>其他还有一个参数可以执行 <code>npx git-rewrite-commits --help</code> 查看</p>
<p>以我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvaebe%2Fblog" target="_blank" title="https://github.com/vaebe/blog" ref="nofollow noopener noreferrer">blog</a> 项目为例</p>
<ol>
<li>
<p>输入 y 确认
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02bc06fdb5c45939b6beb7c5b91bb3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=DSOSifQdc3W0xqDsaJYwk8SnZWM%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>开始执行
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7be3fa573a042248833163032f7d776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=gDmWANALt7m4Kb5FU06XnZr2oaU%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>执行结束会让你确认是否重写 git commit 记录，输入 y 确认后开始执行
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e733dc70ad0468c911359f3bdb42091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=G5vkQh1fpiOhqWfduk82RCB059I%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>重写完成后会提示你需要强制推送
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f35931f22c49cfb60c4fe10be67017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=lcA1pQLZxnUfmyq5LiTApB2p%2Bq0%3D" alt="image.png" loading="lazy"/>
翻译一下：</p>
<ol>
<li>查看更改：git log --oneline</li>
<li>如果满意，强制推送：git push --force-with-lease</li>
<li>如果出现问题，恢复：git reset --hard backup-main-1765263878856</li>
<li>完成后清理备份：git branch -D backup-main-176526387885</li>
</ol>
</li>
<li>
<p>执行 <code>git push --force-with-lease</code> 开始强制推送
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eae3c13e6c14d8abe5b9bc375546b37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=BHZAo%2BOYn6vTbMGezZGj31bLYqM%3D" alt="image.png" loading="lazy"/>
没有权限会有这种提示，修改仓库推送权限后重新推送即可</p>
</li>
</ol>
<h2 data-id="heading-2">总结</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 是一个可以使用 ai 来重写已经提交的 git commit 信息的工具，对于之前项目中 git 提交信息不规范又不想手动去修改时，可以通过一行命令解决，十分方便！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？]]></title>    <link>https://juejin.cn/post/7581437632855081000</link>    <guid>https://juejin.cn/post/7581437632855081000</guid>    <pubDate>2025-12-09T06:42:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581437632855081000" data-draft-id="7581437632854458408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？"/> <meta itemprop="keywords" content="前端,Java,ORM"/> <meta itemprop="datePublished" content="2025-12-09T06:42:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="遇见代码"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709235800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709235800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    遇见代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T06:42:21.000Z" title="Tue Dec 09 2025 06:42:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    107
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一行代码实现复杂查询的优雅背后，藏着 SQL 语义的严格守卫者。当你不了解它的规则时，它就会用看似诡异的行为提醒你。</p>
</blockquote>
<h2 data-id="heading-0">1. 优雅框架的意外难题</h2>
<p>Bean Searcher 在 Java 开发者中正获得越来越多的关注。它被描述为 “比 MyBatis 开发效率 <strong>快 100 倍</strong> 的只读 ORM，天生支持联表”，只需要一行代码就能实现多表联查、分页搜索、组合过滤等复杂功能。</p>
<p>我很快就在项目中应用了这个框架，处理那些常规的列表查询确实得心应手。直到我遇到了需要分组统计的场景。</p>
<h2 data-id="heading-1">2. 问题的显现</h2>
<blockquote>
<p>为了业务脱敏，我将业务表简化为学校里常用的 课程、教师、分数 模型表</p>
</blockquote>
<p>我的需求很明确：统计每门课程的平均分，同时只关注特定教师教授的课程。我设计了如下 SearchBean（检索实体类）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    where = "c.teacher_id = t.id and c.id = s.course_id",
    groupBy = "c.id"   // 按课程 ID 分组
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AvgScoreVO</span> {

    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Integer courseId;

    <span class="hljs-meta">@DbField("avg(s.score)")</span>
    <span class="hljs-keyword">private</span> Float averageScore;

    <span class="hljs-meta">@DbField("t.id")</span>  <span class="hljs-comment">// 我想用这个字段筛选特定教师的课程</span>
    <span class="hljs-keyword">private</span> Integer teacherId;

    <span class="hljs-comment">// 省略getter/setter</span>
}
</code></pre>
<p>在控制器中，我像往常一样使用一行代码进行查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/avgScores")</span>
<span class="hljs-keyword">public</span> List&lt;AvgScoreVO&gt; <span class="hljs-title function_">getAvgScores</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> beanSearcher.searchAll(AvgScoreVO.class);
}
</code></pre>
<blockquote>
<p>这里我使用了 Bean Searcher 官方文档中推荐的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2Fguide%2Fusage%2Fothers.html" target="_blank" title="https://bs.zhxu.cn/guide/usage/others.html" ref="nofollow noopener noreferrer"><strong>自动接收前端请求参数</strong></a> 的机制。所以这里真的只剩一行代码了。</p>
</blockquote>
<p>逻辑看起来无懈可击：按课程分组，计算平均分，同时筛选出指定教师的课程。我用 HTTP 客户端发起请求：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f944b95db04b52912302caaa512773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YGH6KeB5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765873186&amp;x-signature=KzIFUF6w0ij6%2FfrwaSu5VdckJ9U%3D" alt="image.png" loading="lazy"/></p>
<p>然而请求发起后，我却得到了这样的错误：</p>
<pre><code class="hljs language-sql" lang="sql">SQLSyntaxErrorException: <span class="hljs-literal">Unknown</span> <span class="hljs-keyword">column</span> <span class="hljs-string">'t.id'</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'having clause'</span>
</code></pre>
<p>生成的 SQL 大致如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">select</span> c.id c_0, <span class="hljs-built_in">avg</span>(s.score) c_1, t.id c_2
<span class="hljs-keyword">from</span> course c, teacher t, score s
<span class="hljs-keyword">where</span> c.teacher_id <span class="hljs-operator">=</span> t.id <span class="hljs-keyword">and</span> c.id <span class="hljs-operator">=</span> s.course_id
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> c.id
<span class="hljs-keyword">HAVING</span> c_2 <span class="hljs-operator">=</span> ?  <span class="hljs-comment">-- 问题在这里！</span>
</code></pre>
<p>为什么？为什么我的 <code>teacherId</code> 条件被放在 <code>HAVING</code> 子句而不是 <code>WHERE</code> 子句？按照 SQL 执行顺序，<code>WHERE</code> 在分组前执行，<code>HAVING</code> 在分组后执行。将教师筛选条件放在 <code>HAVING</code> 中不仅逻辑错误，而且是 SQL 语法错误！</p>
<h2 data-id="heading-2">3. 深入探索：官方文档的线索</h2>
<p>面对这个看似诡异的问题，我开始仔细查阅 Bean Searcher 的官方文档。在其 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2Fguide%2Fbean%2Ffields.html" target="_blank" title="https://bs.zhxu.cn/guide/bean/fields.html" ref="nofollow noopener noreferrer"><strong>条件属性</strong></a> 章节，我发现了关于 <code>@DbField</code> 注解的 <code>cluster</code> 属性的关键说明。</p>
<p><code>cluster</code> 属性有三种取值：</p>

























<table><thead><tr><th>取值</th><th>含义</th><th>GroupBy 时条件生成位置</th></tr></thead><tbody><tr><td><code>Cluster.TRUE</code></td><td>表明该属性是聚合字段</td><td>只会生成 <code>HAVING</code> 条件</td></tr><tr><td><code>Cluster.FALSE</code></td><td>表明该属性是非聚合字段</td><td>只会生成 <code>WHERE</code> 条件</td></tr><tr><td><code>Cluster.AUTO</code></td><td>默认值，自动推断</td><td>根据规则推断</td></tr></tbody></table>
<p>文档进一步解释了 <code>Cluster.AUTO</code> 的推断逻辑：</p>
<ul>
<li>当条件属性 <strong>在 <code>groupBy</code> 列表中时</strong>，自动推断为 <code>FALSE</code>（生成 <code>WHERE</code> 条件）</li>
<li>当条件属性 <strong>不在 <code>groupBy</code> 列表中</strong>，并且 <strong>该属性同时是 Java 类中的字段</strong> 时，自动推断为 <code>TRUE</code>（生成 <code>HAVING</code> 条件）</li>
<li>其他情况都推断为 <code>FALSE</code></li>
</ul>
<p>这就是关键！我的 <code>teacherId</code> 字段不在 <code>groupBy</code> 列表中，但它是 Java 类中的字段，因此被自动推断为 <code>Cluster.TRUE</code>，条件被生成在 <code>HAVING</code> 子句中。</p>
<h2 data-id="heading-3">4. 设计者的精妙考量</h2>
<p>为什么 Bean Searcher 的作者要这样设计？起初我觉得这是反直觉的，但深入思考后，我发现这背后有着严谨的逻辑。</p>
<p>首先，需要理解 Bean Searcher 中两种不同类型 条件属性 的区别：</p>
<ul>
<li><strong>字段属性</strong>：声明在 Java 类 (<code>@SearchBean</code>) 中的字段，既可以根据参数生成条件，又用于 <strong>承载查询结果</strong>，会出现在 <code>SELECT</code> 列表中</li>
<li><strong>附加属性</strong>：通过 <code>@SearchBean.fields</code> 定义的属性，不承载查询结果，<strong>不会</strong>出现在 <code>SELECT</code> 列表中，仅作为动态查询条件使用</li>
</ul>
<p>当执行带有 <code>GROUP BY</code> 的查询时，<strong>SQL-92</strong> 和 <strong>SQL:1999</strong> 规范里都有一个严格的语义规则：<strong><code>SELECT</code> 列表中的任何非聚合列，必须出现在 <code>GROUP BY</code> 子句中</strong>。</p>
<p>Bean Searcher 的设计者面临一个抉择：当框架检测到一个"普通Java字段"出现在分组查询中，但又不参与分组时，该如何处理？</p>
<p>如果框架将其条件生成在 <code>WHERE</code> 子句，这在语义上是正确的，但如果开发者本意是想用这个字段过滤分组后的结果，框架将其放在 <code>WHERE</code> 就会导致逻辑错误。</p>
<p><code>Cluster.AUTO</code> 选择推断为 <code>TRUE</code>，实际上是一种"安全侧"设计。这种推断很大概率会导致运行时数据库报错，但这个<strong>错误会强制开发者停下来思考</strong>："我到底想用这个字段做什么？"</p>
<p>然后开发者必须做出明确的决定：</p>
<ul>
<li>如果这个字段只是用于动态生成条件，不承载检索结果，就应该将其声明再附加属性中</li>
<li>如果确实想基于该字段的聚合结果过滤：则需要改写 SQL，例如使用 <code>avg(s.score)</code> 等聚合函数</li>
<li>如果确实用不了聚合函数，但既想承载检索结果，又想在分组前过滤：那是否考虑将其声明到 <code>groupBy</code> 列表中去（遵守 SQL 规范）</li>
<li>如果就 <strong>不想遵守 SQL 规范</strong>，就应显式设置为 <code>@DbField(cluster = Cluster.FALSE)</code></li>
</ul>
<h2 data-id="heading-4">5. 问题的本质与解决方案</h2>
<p>基于上述理解，我意识到我的问题本质是：<code>teacherId</code> 是一个<strong>字段属性</strong>（Java类中的字段），它会出现在 <code>SELECT</code> 列表中，但在 <code>GROUP BY</code> 查询中，它既不在分组列表中，也不是聚合函数。</p>
<p>根据 SQL 语义，这样的字段在 <code>SELECT</code> 中是非法的。Bean Searcher 的 <code>Cluster.AUTO</code> 推断逻辑在这种情况下选择将其视为聚合字段（<code>TRUE</code>），因此将过滤条件放在 <code>HAVING</code> 中。</p>
<p>解决这个问题有两种方法：</p>
<h3 data-id="heading-5">方法一：将字段改为附加属性</h3>
<p>如果这个字段不需要出现在查询结果中，只作为过滤条件，可以将其定义为附加属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    joinCond = "c.teacher_id = t.id and c.id = s.course_id",
    groupBy = "c.id",
    fields = {
        @DbField(name = "teacherId", value = "t.id")    // 定义附加属性
    }
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScoreVO</span> {

    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Long courseId;

    <span class="hljs-meta">@DbField("AVG(s.score)")</span>
    <span class="hljs-keyword">private</span> Double averageScore;

    <span class="hljs-comment">// teacherId 现在是附加属性，不会出现在SELECT中</span>
    <span class="hljs-comment">// 它将被自动推断为 Cluster.FALSE，条件生成在WHERE中</span>

    <span class="hljs-comment">// 省略其他字段和getter/setter</span>
}
</code></pre>
<h3 data-id="heading-6">方法二：显式指定 cluster 属性</h3>
<p>如果确实 <strong>不想遵守 SQL 规范</strong>，并且也确定我的数据库支持运行这种不规范的 SQL，那么只需指定 <code>cluster</code> 属性为 <code>FALSE</code> 即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@DbField(value = "t.id", cluster = Cluster.FALSE)</span>
<span class="hljs-keyword">private</span> Long teacherId;
</code></pre>
<p>这样明确告诉框架，这个字段是非聚合字段，条件应该放在 <code>WHERE</code> 子句中。</p>
<h2 data-id="heading-7">6. 作者的设计哲学："好类" 与 "坏类"</h2>
<p>与 Bean Searcher 作者沟通后，我获得了更深层次的理解。作者将分组查询场景下的 <code>@SearchBean</code> 类分为两种：</p>
<h3 data-id="heading-8">什么是"好类"？</h3>
<p>一个被开发者深思熟虑的"好类"，在分组查询中，其每个字段都严格遵守 SQL 语义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "student_course sc",
    groupBy = "sc.course_id"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScore</span> {

    <span class="hljs-comment">// 这个字段在 groupBy 列表中，合法</span>
    <span class="hljs-meta">@DbField("sc.course_id")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> courseId;

    <span class="hljs-comment">// 这个字段是聚合函数，合法</span>
    <span class="hljs-meta">@DbField("sum(sc.score)")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> totalScore;

    <span class="hljs-comment">// 这是一个"好类"，无需手动指定 cluster 属性</span>
}
</code></pre>
<p>"好类" 的特点：</p>
<ol>
<li>每个字段要么在 <code>groupBy</code> 列表中</li>
<li>要么使用了聚合函数（如 <code>SUM</code>, <code>AVG</code>, <code>COUNT</code> 等）</li>
<li>框架的 <strong>自动推断</strong> 能完美工作，无需手动干预</li>
</ol>
<h3 data-id="heading-9">什么是"坏类"？</h3>
<p>一个未被开发者深思熟虑的"坏类"，包含不符合分组查询语义的字段：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    joinCond = "c.teacher_id = t.id AND c.id = s.course_id",
    groupBy = "c.id"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScoreVO</span> {

    <span class="hljs-comment">// 这个字段在 groupBy 列表中，合法</span>
    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Long courseId;

    <span class="hljs-comment">// 这个字段是聚合函数，合法</span>
    <span class="hljs-meta">@DbField("AVG(s.score)")</span>
    <span class="hljs-keyword">private</span> Double averageScore;

    <span class="hljs-comment">// 这个字段既不在 groupBy 列表中，也不是聚合函数</span>
    <span class="hljs-comment">// 这是一个 "坏类" 的典型表现</span>
    <span class="hljs-meta">@DbField("t.id")</span>
    <span class="hljs-keyword">private</span> Long teacherId;
}
</code></pre>
<p>"坏类"的问题：</p>
<ol>
<li>包含既不在 <code>groupBy</code> 列表中，也不是聚合函数的字段</li>
<li>这些字段在分组查询的 <code>SELECT</code> 子句中是不合法的，没有遵循 SQL 规范</li>
<li>框架无法自动确定如何处理这些字段的过滤条件</li>
</ol>
<h3 data-id="heading-10">作者的意图</h3>
<p>作者的设计哲学是：<strong>引导开发者设计 "好类"，而不是迁就 "坏类"</strong> 。</p>
<p>当一个类被框架标记为"坏类"（通过条件被错误放入 <code>HAVING</code> 来提示）时，框架实际上在说：</p>
<blockquote>
<p>"你的类设计可能存在问题。请重新思考：这个字段真的应该在分组查询的结果中出现吗？"</p>
</blockquote>
<p>如果开发者经过思考后，认为这个字段确实需要，那么就应该明确告诉框架：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 经过思考，我确实需要这个字段，但它应该作为分组前过滤条件</span>
<span class="hljs-meta">@DbField(value = "t.id", cluster = Cluster.FALSE)</span>
<span class="hljs-keyword">private</span> Long teacherId;
</code></pre>
<p>通过这种方式，框架既保证了 SQL 的语义正确性，又给了开发者灵活处理特殊情况的空间。</p>
<h2 data-id="heading-11">7. 最佳实践与总结</h2>
<p>通过这次经历，我总结了在使用 Bean Searcher 进行分组查询时的最佳实践：</p>
<ol>
<li><strong>设计"好类"优先</strong>：在设计分组查询的实体类时，优先确保每个字段要么在 <code>groupBy</code> 列表中，要么是聚合函数。这样的"好类"能让框架的自动推断完美工作。</li>
<li><strong>理解"坏类"的代价</strong>：如果确实需要包含非分组、非聚合的字段，理解这是"坏类"，并接受需要手动指定 <code>cluster</code> 属性的代价。</li>
<li><strong>理解框架设计哲学</strong>：Bean Searcher 的设计者在"便利性"和"语义正确性"之间选择了后者。这可能导致初期的学习曲线，但长期来看，它 <strong>避免了更隐蔽的逻辑错误</strong>。</li>
<li><strong>区分字段用途</strong>：明确区分哪些字段用于展示结果（需要在 <code>SELECT</code> 中），哪些仅用于过滤（可以定义为附加属性）。</li>
</ol>
<p>回顾整个探索过程，那个看似"诡异"的错误实际上是指引我深入理解 SQL 语义和框架设计理念的路标。Bean Searcher 通过这种 <strong>"快速失败"</strong> 的设计，确保开发者在早期就能发现并修复潜在的逻辑问题。</p>
<p>这个框架不仅仅是一个简化代码的工具，它更是一个引导开发者写出更严谨 SQL 的良师益友。下次当你的查询条件"偷偷"跑进 <code>HAVING</code> 子句时，不要惊慌，这是框架在提醒你：是时候仔细思考你的查询逻辑了。</p>
<p>毕竟，在编程的世界里，没有无缘无故的"诡异"，只有尚未理解的精妙设计！</p>
<blockquote>
<p><strong>开源代码：</strong></p>
<ul>
<li>Gitee: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftroyzhxu%2Fbean-searcher" target="_blank" title="https://gitee.com/troyzhxu/bean-searcher" ref="nofollow noopener noreferrer">gitee.com/troyzhxu/be…</a></li>
<li>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftroyzhxu%2Fbean-searcher" target="_blank" title="https://github.com/troyzhxu/bean-searcher" ref="nofollow noopener noreferrer">github.com/troyzhxu/be…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2F" target="_blank" title="https://bs.zhxu.cn/" ref="nofollow noopener noreferrer">bs.zhxu.cn/</a></li>
</ul>
<p><strong>往期阅读：</strong></p>
<ul>
<li><a href="https://juejin.cn/post/7027733039299952676" target="_blank" title="https://juejin.cn/post/7027733039299952676">我这样写代码，比直接使用 MyBatis 效率提高了 100 倍</a></li>
<li><a href="https://juejin.cn/post/7092411551507808264" target="_blank" title="https://juejin.cn/post/7092411551507808264">最近火起的 Bean Searcher 与 MyBatis Plus 倒底有啥区别？</a></li>
<li><a href="https://juejin.cn/post/7116736773065343012" target="_blank" title="https://juejin.cn/post/7116736773065343012">Bean Searcher v3.8.0 一大波新特性来袭</a></li>
<li><a href="https://juejin.cn/post/7379667550504517643" target="_blank" title="https://juejin.cn/post/7379667550504517643">你知道只读 ORM 吗，Bean Searcher v4.3.0 来啦！</a></li>
</ul>
</blockquote>
<p>如果觉得文本不错，动手点个赞吧 ^_^</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Context 知多少，组件通联有门道]]></title>    <link>https://juejin.cn/post/7581348660824506368</link>    <guid>https://juejin.cn/post/7581348660824506368</guid>    <pubDate>2025-12-09T00:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581348660824506368" data-draft-id="7577345758036066304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Context 知多少，组件通联有门道"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-09T00:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Context 知多少，组件通联有门道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T00:29:48.000Z" title="Tue Dec 09 2025 00:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/844bf0f4350a4e488ceae20d66f4dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765844987&amp;x-signature=hqjJxjm%2B1%2FnQsG0jEQxcQOYQDww%3D" alt="0.png" loading="lazy"/></p>
<h2 data-id="heading-0">四）Context 知多少，组件通联有门道</h2>
<p>上次面试的失败像盆冷水，彻底浇醒了浑浑噩噩的林卓。面试官随意抛出的Android相关问题，他答得支支吾吾，那一刻他才明白，只靠改UI、调接口的表面功夫，根本撑不起职业道路。</p>
<p>回到组里，他收起了摸鱼的心思，开始沉下心钻研核心技术。恰逢组里启动“用户中心模块重构”，老杨见他态度转变，便把“全局通知工具类开发”这个基础子任务交给他练手。林卓磕磕绊绊干了快一周，刚把基础功能跑通，麻烦就找上门了。</p>
<p>“林卓，你负责的通知模块测出问题了！”小安抱着测试机急匆匆跑过来，高马尾随着脚步晃得厉害，“常规操作都没问题，但我做后台保活测试时发现，退到后台等待一会儿再触发推送，APP直接内存泄漏，时间长了还会崩溃，日志里全是 <strong>LeakCanary</strong> 检测到内存泄漏的警告。”</p>
<p>林卓赶紧接过测试机，屏幕上“应用已停止运行”的提示格外刺眼。他打开日志，<code>Activity Context leaked</code> 的红色字样像根刺扎在眼前。这个通知工具类他用了单例模式，为了方便调用 <code>Toast</code>，直接把 <code>Activity</code> 的 <code>this</code> 传了进去。</p>
<p>“我明明在工具类里加了判空啊。”林卓皱着眉翻代码，“<code>if (context != null) { Toast.makeText(context, msg, Toast.LENGTH_SHORT).show() }</code>，怎么还会泄漏？”</p>
<p>“你这是把 <code>Activity</code> 的命门攥手里了。”老杨端着搪瓷杯路过，杯沿还沾着点茶叶。</p>
<p>他直指问题核心：“单例是全局生命周期，<code>Activity</code> 一销毁，它还抱着 <code>Activity</code> 的 <code>Context</code> 不放，垃圾回收器收不了，可不就泄漏了？”</p>
<p>林卓顺着老杨的话往下想，眉头拧得更紧：“那要是有些场景确实绕不开，非得在单例这种长生命周期对象里用到 <code>Activity Context</code>，就没别的办法了吗？”</p>
<p>“也不是完全不能用，核心是别让长生命周期对象‘死抓着’<code>Activity Context</code> 不放。”老杨拉过椅子坐下，顺势接过林卓的代码本。</p>
<p>他给出解决方案：“真碰到这种需求，就得用 <code>WeakReference</code> 把 <code>Context</code> 包起来。它就像个‘临时抓手’，只在需要的时候关联 <code>Activity</code>，垃圾回收器要清理 <code>Activity</code> 时，它不会拦着，这样就能从根上减少泄漏风险。”</p>
<p>听着老杨的讲解，林卓突然想起之前看过老杨给的《Android核心知识点》，赶紧追问：“您这么一说我就明白了！那结合你的文档里讲的 <code>Context</code> 类型，我这个单例工具类，是不是直接用 <code>Application Context</code> 最稳妥？”</p>
<p>“先别急着下结论。”老杨拉过椅子坐下，点开工具类代码，“你这工具类又弹 <code>Toast</code> 又显示 <code>Dialog</code>，得先搞清楚不同场景该用啥 <code>Context</code>。”</p>
<p>他指着屏幕，给出关键区分：“像 <code>Toast</code> 这种轻量级提示，用 <code>Application Context</code> 完全没问题，系统会自动处理窗口关联。”</p>
<p>“但像 <code>AlertDialog</code>、自定义主题的 <code>TextView</code> 这类和界面主题强相关的组件，就必须用 <code>Activity Context</code>。”</p>
<p>老杨强调核心原因：“<code>Application Context</code> 没有承载界面主题的能力，这才是新手常踩的坑。”</p>
<p>小安在旁边连连点头：“对对，我上次测个弹窗功能，按钮字体和颜色全不对，跟设计图差老远。开发改了改调用方式，换成跟页面绑定的那种，立马就正常了。”她撇撇嘴吐槽，“这Android也太奇怪了，同样是弹个东西，换个地方触发就出幺蛾子。”</p>
<p>“嗯，这也是很多新手踩坑的地方。”</p>
<p>老杨接过话头，抛出一个隐藏知识点：“就说 <code>Dialog</code> 这个类，构造函数明晃晃写着要 <code>Context</code>，但你去翻源码就知道，它要求的是 <code>@UIContext</code>。”</p>
<p>他进一步解释：“这种上下文一般只有 <code>Activity</code> 才有，<code>Application</code> 和 <code>Service</code> 根本不具备。”</p>
<p>他接着打开林卓的单例代码，用鼠标圈出 <code>private var mContext: Context? = null</code>：“你把 <code>Activity</code> 传进来，单例就成了 <code>Activity</code> 的‘寄生虫’。”</p>
<p>“就算 <code>Activity</code> <code>finish</code> 了，单例还拿着它的引用，内存能不泄漏吗？”</p>
<p>老杨顿了顿，给出明确解决方案：“改成就用 <code>getApplicationContext()</code>。”</p>
<p>他特意强调注意事项：“但要记死，这个 <code>Context</code> 不能做UI相关的操作，比如弹对话框、加载布局，刚好避开它的短板。”</p>
<p>林卓恍然大悟，赶紧翻回工具类代码，手指在屏幕上划着逻辑：“我明白您的意思了！<code>Toast</code> 用 <code>Application Context</code> 就行，但工具类里还留着弹 <code>AlertDialog</code> 的功能，这总不能跟 <code>Toast</code> 共用一套上下文吧？是不是得让调用方每次传 <code>Activity Context</code> 过来？”</p>
<p>“分场景处理。”老杨拿起笔在林卓的笔记本上画起来，给出清晰的使用准则。</p>
<p>适用 <code>Application Context</code> 的场景：“工具类里存 <code>Application Context</code>，用于初始化通知管理器、访问全局资源，还有 <code>Toast</code> 这种通用提示。”</p>
<p>必须用 <code>Activity Context</code> 的场景：“<code>AlertDialog</code>、带自定义主题的UI组件这些和界面强绑定的操作，必须让调用方传 <code>Activity</code> 里的 <code>Context</code>，并且每次用的时候实时传，别存起来。”</p>
<p>他顿了顿，补充一个 <code>Service</code> 专属知识点：“还有个 <code>Service</code> 里常踩的硬坑——<code>Service</code> 本身没有独立的任务栈，它跑在后台，不属于任何界面的任务栈。”</p>
<p>核心要求：“所以在 <code>Service</code> 里启动 <code>Activity</code> 时，必须给 <code>Intent</code> 加<code>Intent.FLAG_ACTIVITY_NEW_TASK</code>这个标记。”</p>
<p>标记作用与异常后果：“这个标记的作用是帮新启动的 <code>Activity</code> 创建一个独立的任务栈来承载它，要是不加，系统找不到放 <code>Activity</code> 的地方，就会抛出<code>AndroidRuntimeException</code>。”</p>
<p>他看向小安：“这个小安测试的时候肯定碰到过。”</p>
<p>小安立刻点头摆手，有点不好意思地笑：“反正就是这么个理儿！我之前测过类似的后台功能，开发没加东西就崩了，我把崩的情况报上去，他们改了个标记就好了。具体啥原理我也记不太清，你们说的这些 <code>Context</code> 相关的，我听着都头大。”</p>
<p>林卓立刻按这个思路重构代码：单例初始化时通过 <code>context.applicationContext</code> 存全局上下文，弹 <code>AlertDialog</code> 的方法则新增 <code>Activity Context</code> 参数，要求调用方实时传入。改完后小安当场测试——前台弹通知、弹窗都正常，后台触发推送也没再出现内存泄漏，<strong>LeakCanary</strong> 的警告彻底消失了。</p>
<p>林卓把老杨的话记在笔记本上，特意用红笔标注：“单例存 <code>Application Context</code>，UI操作传 <code>Activity Context</code>，实时调用不缓存”。接下来的几天，他不仅重构了通知工具类，还主动把组里几个老模块的<code>Context</code>使用逻辑都排查了一遍——之前总被忽略的“内存泄漏隐患”“主题错乱”等小问题，如今都成了他重点关注的对象。</p>
<p>林卓排查完最后一个老模块，揉着脖子跟老杨反馈：“杨工，我发现好多旧代码里，<code>Activity</code> 里既用 <code>this</code> 又用 <code>baseContext</code>，看得我有点乱，这俩到底啥关系啊？”</p>
<p>老杨正收拾着文档，闻言停下动作，干脆把林卓的代码本拉到自己面前：“正好你问到点子上了，光会用还不够，得知道底层逻辑才不容易踩坑。”</p>
<p>他打开 <code>ContextWrapper</code> 的源码，用指尖点着屏幕：“你看，<code>ContextWrapper</code> 里有个 <code>mBase</code> 字段，这就是真正的上下文实现，不管是 <code>Activity</code> 还是 <code>Service</code>，最终都要委托给它。<code>Activity</code> 的 <code>mBase</code> 是 <code>ContextImpl</code>，还附加了主题信息；但 <code>Service</code> 的 <code>mBase</code> 也是 <code>ContextImpl</code>，却没有主题扩展——这就是为啥 <code>Service</code> 不能弹弹窗。”</p>
<p>林卓盯着源码若有所思，突然指着 <code>baseContext</code> 相关的注释问：“那 <code>Activity</code> 里的 <code>this</code> 和 <code>baseContext</code> 具体有啥区别？”</p>
<p>“这问题问得好，正好结合代码给你讲明白。”老杨干脆拉过林卓的工位椅，打开他的IDE，调出两段代码——正是组里前辈写过的主题包装类代码。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThemeContextWrapper</span>(base: Context) : ContextWrapper(base) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTheme</span><span class="hljs-params">()</span></span>: Resources.Theme {
        <span class="hljs-keyword">val</span> theme = <span class="hljs-keyword">super</span>.getTheme()
        theme.applyStyle(R.style.CustomTheme, <span class="hljs-literal">true</span>) <span class="hljs-comment">// Apply a custom theme</span>
        <span class="hljs-keyword">return</span> theme
    }
}
</code></pre>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-keyword">super</span>.attachBaseContext(CustomThemeContextWrapper(newBase))
    }
}
</code></pre>
<p>老杨逐行解析代码：“你先看这段 <code>CustomThemeContextWrapper</code>，它继承了 <code>ContextWrapper</code>，核心是重写 <code>getTheme()</code> 方法，给上下文附加了自定义主题样式。”</p>
<p>“再看 <code>MyActivity</code>，通过 <code>attachBaseContext</code> 方法，把 <code>newBase</code> 包装成了这个自定义上下文。”</p>
<p>林卓盯着代码里的 <code>newBase</code> 关键词，眉头拧了起来：“这个 <code>newBase</code> 就是 <code>baseContext</code> 吧？那 <code>Activity</code> 的 <code>this</code> 拿到的上下文，是不是在它基础上包装出来的？”</p>
<p>“可以这么理解，但 <code>this</code> 是比 <code>baseContext</code> 更完整的存在。”老杨指着代码解释。</p>
<p>“<code>baseContext</code> 是 <code>Activity</code> 的‘底层上下文’，负责和系统底层交互，比如获取资源、启动服务这些基础操作，你看到的 <code>newBase</code> 就是系统给 <code>Activity</code> 分配的初始 <code>baseContext</code>。”</p>
<p>他顿了顿，敲了敲 <code>attachBaseContext</code> 方法，讲解 <code>this</code> 的作用：“而 <code>Activity</code> 的 <code>this</code>，是在 <code>baseContext</code> 的基础上做了‘增强’——它封装了生命周期管理、界面主题、窗口绘制这些核心能力。”</p>
<p>结合代码举例：“就像这段代码，我们给 <code>baseContext</code> 包了一层自定义主题，最终 <code>this</code> 拿到的上下文，就带着这个主题样式了。”</p>
<p>为了让林卓更直观，老杨举了个对比例子。</p>
<p><code>this</code> 的优势：“你用 <code>this</code> 去创建 <code>AlertDialog</code>，它能自动适配 <code>Activity</code> 的主题，因为 <code>this</code> 里包含了主题信息。”</p>
<p><code>baseContext</code> 的局限：“但你要是用 <code>baseContext</code> 去创建，它只会用系统默认主题——甚至在某些版本里会崩溃，因为 <code>baseContext</code> 没有 <code>Activity</code> 那种窗口关联能力。”</p>
<p>“那什么时候该用 <code>baseContext</code> 啊？”林卓追问，顺手把老杨的话记在笔记本上，特意留出补充案例的空白。</p>
<p>“用在不需要界面主题和生命周期的场景。”老杨补充道。</p>
<p>他给出一句总结，还举了个具体例子：“简单说，<code>this</code> 是‘全能选手’，带界面属性；<code>baseContext</code> 是‘基础工具人’，只干底层活。比如你在 <code>Activity</code> 里注册静态广播，用 <code>baseContext</code> 就够了”</p>
<p>小安凑过来看热闹，听完恍然大悟：“怪不得我上次测一个自定义按钮，开发的样式总出问题，换个调用方式就好了，原来问题在这！”</p>
<p>老杨笑着看向小安，又转头对林卓说：“其实测试和开发排查问题的思路是相通的，都能从场景反推。”</p>
<p>核心排查场景：“你就盯着那些关键场景测：比如启动新页面、弹弹窗的样式，后台操作等等，如果出问题，大概率是 <code>Context</code> 用错了。”</p>
<p>他补充测试要点：“还有那些全局都能用的工具，要是在后台用就出问题，也可能是这个原因。你多换几种机型、多测几个前后台切换的场景，问题自然就露出来了。”</p>
<p>带着这些收获，林卓在接下来的一周里，把项目里所有涉及 <code>Context</code> 的地方都系统梳理了一遍。</p>
<p>他甚至总结出三条规范记在团队共享文档里：“1. 全局工具类存 <code>Application Context</code>；2. 界面相关操作必须传 <code>Activity Context</code> 且实时调用；3. 后台程序禁用界面类 <code>Context</code>。”</p>
<p>小安则发挥测试优势，设计了一套“全场景覆盖用例”，从前台操作、后台驻留、进程重启到低电量模式，反复测试，确保 <code>Context</code> 相关的崩溃和泄漏问题彻底绝迹。</p>
<p>周五傍晚的研发区渐渐安静，工位灯一盏盏熄灭，只剩林卓、老杨和小安的座位还亮着。小安一边收拾测试机一边随口说道：“林卓，张组长今天Review你提交的代码，跟我说‘这小子现在写的东西越来越稳了’，还追问是谁带的你呢。”</p>
<p>林卓刚改完最后一行注释，闻言抬头看向正在整理文档的老杨，脸上带着点不好意思的笑，从抽屉里摸出一瓶可乐递过去：“全靠杨工指点，不然我现在还在 <code>Context</code> 的迷雾里打转呢。”</p>
<p>老杨没直接喝，顺手把可乐塞进了口袋：“我不爱喝甜的。”</p>
<p>他端起搪瓷杯继续喝，褐色液体在杯壁上留下淡淡的渍痕。</p>
<p>“不是我指点得好，是你肯钻。”老杨放下杯子，杯底与桌面碰撞发出轻响，一股混杂着焦香和茶香的味道飘了过来，“技术这东西，光看理论没用，得自己试错才知道啥适合自己。”</p>
<p>小安正收拾到一半，抽着鼻子凑过来：“杨工，你这杯子里泡的啥呀？闻着不像纯茶。”</p>
<p>林卓也好奇地瞥了眼杯子里深褐色的液体，质地比茶水浓稠些。</p>
<p>老杨有点不好意思地挠挠头：“前几天赶版本熬大夜，困得慌就瞎兑的——绿茶加咖啡，提神劲儿翻倍。”</p>
<p>“啊？茶和咖啡混着喝？”小安眼睛瞪圆了，“那是什么奇怪味道？又苦又涩吗？”</p>
<p>“还行，喝惯了就好，比纯咖啡少点酸味儿，比浓茶多股劲儿。”老杨笑着摆手，把话题拉回技术。</p>
<p>他用这个例子打比方：“就像 <code>Context</code> 这知识点，背一万遍理论不如踩一次坑，踩一次坑不如解决一次问题。”</p>
<p>“就像 <code>Context</code> 这知识点，背一万遍理论不如踩一次坑，踩一次坑不如解决一次问题。”</p>
<p>他话锋一转说起正事，眼神里带着点期许：“对了，下周组里会来几个实习生，基础有点薄弱，我跟张组长合计过，让你带带它们。你趁这两天把Android四大组件的知识点过一遍，尤其是 <code>Activity</code> 和 <code>Service</code> 的生命周期——正好把你这段时间踩的坑，都转化成经验教给他们。”</p>
<p>林卓眼睛一亮，用力点头，手指无意识地摩挲着手机里的 <code>Context</code> 笔记——从前连 <code>Context</code> 类型都分不清的自己，如今居然能指导新人了，这种成长的踏实感格外真切。</p>
<p>他低头看向手机里刚整理的 <code>Context</code> 笔记，上面老杨的批注格外醒目：“<code>Context</code> 是应用的根，用对了是桥梁，用错了是陷阱。”</p>
<p>西二旗的研发区灯光透过玻璃窗洒下来，照亮了笔记上的字迹，也照亮了他从“踩坑者”到“引路人”的逆袭方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest.js / hono.js 一起学！开发前必备！]]></title>    <link>https://juejin.cn/post/7581448482544713754</link>    <guid>https://juejin.cn/post/7581448482544713754</guid>    <pubDate>2025-12-09T02:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581448482544713754" data-draft-id="7580197740963151898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！开发前必备！"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2025-12-09T02:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！开发前必备！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:56:16.000Z" title="Tue Dec 09 2025 02:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>欢迎到我们的交流群一起交流各种前端技术，同时欢迎访问我的 headless 组件库，同时感谢你的 star：</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.frontlight.tech%2F" title="https://link.juejin.cn/?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank">国内官网</a></li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank">感谢 github star</a></li>
</ul>
<hr/>
<p>nest.js / hono.js 一起学系列，最终会封装一个通用的架子，例如有鉴权，日志收集，多环境配置等等功能，用两种框架去实现。
之前写了两篇关于这两个框架编程思想相关的</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">nest.js / hono.js 一起…</a></li>
</ul>
<p>这一篇主要是涉及到我们马上开发前需要具备的一些基础知识，包含：</p>
<ul>
<li>命令行工具使用</li>
<li>最佳工程实践（目录规划篇）</li>
<li>如何调试</li>
<li>docker 入门 + 深入 docker 基本原理</li>
</ul>
<h2 data-id="heading-1">命令行上手</h2>
<h3 data-id="heading-2">全局安装 CLI</h3>
<p>建议，全局安装 CLI， 然后试着创建一个项目试试：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> -g <span class="hljs-keyword">@nestjs</span>/cli
nest new project-name
</code></pre>
<p>后续，你按照命令行提示即可完成项目初始化，然后安装完包，最后看一下 package.json 中 scripts 中的启动命令是什么，启动项目即可。</p>
<p>hono.js 初始化项目是采用：</p>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> hono<span class="hljs-variable">@latest</span> project<span class="hljs-operator">-</span>name
</code></pre>
<p>同样，你按照命令行提示即可完成项目初始化，然后安装对应的包即可，最后看一下 package.json 中 scripts 中的启动命令是什么，启动项目即可。</p>
<p>但是 hono.js 并没有类似 nest 的 cli 管理工具，毕竟 nest 的写法要繁琐很多，所以官方提供了一些快速创建模板的命令。可以通过以下命令查看：</p>
<pre><code class="hljs language-bash" lang="bash">nest --<span class="hljs-built_in">help</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3e3c9b3dd31474a853e6b51c3365065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=wYeiPJuoEG94qx8PJq0%2F1sQmZ4M%3D" alt="image.png" loading="lazy"/></p>
<p>最常见的使用 generate 或者 g 来生成模板, 我们可以用 -d 命令，来让 cli 告诉你，你的 generate 或者 g 命令会生成什么文件，咱们来试试，假设我们要创建一个 名字为 user 的 class</p>
<pre><code class="hljs language-kotlin" lang="kotlin">nest g <span class="hljs-keyword">class</span> <span class="hljs-title class_">user</span> -<span class="hljs-title">d</span> 
</code></pre>
<p>显示：</p>
<pre><code class="hljs language-scss" lang="scss">CREATE <span class="hljs-attribute">src</span>/user/user<span class="hljs-selector-class">.spec</span><span class="hljs-selector-class">.ts</span> (<span class="hljs-number">139</span> bytes)
CREATE <span class="hljs-attribute">src</span>/user/user<span class="hljs-selector-class">.ts</span> (<span class="hljs-number">21</span> bytes)
Dry run enabled. No files written to disk.
</code></pre>
<p>注意最后一行： No files written to disk. 也就是没有真的把文件写入，而是提示如果你使用<code>nest g class user</code> 可能创建的文件有哪些。</p>
<p>还有，我们有时候不太喜欢测试，可以使用</p>
<pre><code class="hljs language-kotlin" lang="kotlin">nest g <span class="hljs-keyword">class</span> <span class="hljs-title class_">user</span> --<span class="hljs-title">no</span>-<span class="hljs-title">spec</span>
</code></pre>
<p>来省去测试文件的创建。</p>
<h2 data-id="heading-3">最佳工程实践</h2>
<p>我们这里列举一些比较好的工程实践的点，欢迎大家一起讨论。</p>
<h3 data-id="heading-4">工程目录</h3>
<p>我们采用”约定大于配置“的思想，无论使用什么 node.js 后端框架，我们的目录名尽可能一致。</p>
<p>nest.js 的建议，如果以下目录名意思不清楚没关系，后续学到控制器，service 等等章节的时候，就会明白了：</p>
<pre><code class="hljs language-ruby" lang="ruby">src/
├── modules/              <span class="hljs-comment"># 核心：按业务领域划分的模块</span>
│   ├── users/            <span class="hljs-comment"># 用户模块</span>
│   │   ├── dto/          <span class="hljs-comment"># 数据传输对象（请求/响应结构）</span>
│   │   ├── entities/     <span class="hljs-comment"># 数据库实体</span>
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.<span class="hljs-keyword">module</span>.ts
│   └── products/         <span class="hljs-comment"># 产品模块（结构类似用户模块）</span>
├── common/               <span class="hljs-comment"># 共享资源</span>
│   ├── filters/          <span class="hljs-comment"># 全局异常过滤器</span>
│   ├── interceptors/     <span class="hljs-comment"># 拦截器</span>
│   └── guards/           <span class="hljs-comment"># 守卫</span>
├── config/               <span class="hljs-comment"># 全局配置</span>
├── database/             <span class="hljs-comment"># 数据库连接配置        </span>
└── app.<span class="hljs-keyword">module</span>.ts         <span class="hljs-comment"># 应用根模块</span>
</code></pre>
<p>核心设计原则：</p>
<ul>
<li>功能内聚：与“用户”相关的所有文件（控制器、服务、实体、DTO）都应放在 users 目录下。</li>
<li>分层管理：使用 common、core 等目录管理跨模块共享的组件和全局配置。</li>
</ul>
<p>hono.js 的建议如下，当然 config ,utils 这些比较常见的全局模块也可以提到第一层级，也就是 src 目录下：</p>
<pre><code class="hljs language-csharp" lang="csharp">src/
├── modules/                <span class="hljs-meta"># 每个模块独立</span>
│   ├── user/
│   │   ├── routes.ts       <span class="hljs-meta"># 只放路由注册（薄层）</span>
│   │   ├── controller/     <span class="hljs-meta"># handlers 控制器层</span>
│   │   │   ├── <span class="hljs-keyword">get</span>-user.ts
│   │   │   ├── list-users.ts
│   │   │   ├── create-user.ts
│   │   │   └── update-user.ts
│   │   ├── service/        <span class="hljs-meta"># 业务逻辑</span>
│   │   │   └── user.service.ts
│   │   ├── repository/     <span class="hljs-meta"># DB / 外部API</span>
│   │   │   └── user.repo.ts
│   │   ├── middleware/     <span class="hljs-meta"># 与 user 模块强相关的中间件</span>
│   │   │   └── user-auth.middleware.ts
│   │   ├── validators/     <span class="hljs-meta"># DTO / 校验器（zod / valibot）</span>
│   │   │   ├── create-user.validator.ts
│   │   │   └── update-user.validator.ts
│   │   ├── dto/            <span class="hljs-meta"># 请求 / 响应类型</span>
│   │   │   ├── user.dto.ts
│   │   │   └── index.ts
│   │   ├── constants.ts    <span class="hljs-meta"># 与 user 相关的常量</span>
│   │   ├── index.ts        <span class="hljs-meta"># 模块总出口</span>
│   │   └── types.ts        <span class="hljs-meta"># 模块相关类型</span>
│   │
│   ├── product/
│   │   ├── routes.ts
│   │   ├── controller/
│   │   ├── service/
│   │   ├── repository/
│   │   ├── middleware/
│   │   ├── validators/
│   │   └── dto/
│   │
│   └── auth/
│       └── ...
│
├── common/                 <span class="hljs-meta"># 全局复用层（不属于任何模块）</span>
│   ├── app.ts              <span class="hljs-meta"># app 初始化（全局中间件、错误处理）</span>
│   ├── router.ts           <span class="hljs-meta"># 合并 modules 的 routes</span>
│   ├── middlewares/        <span class="hljs-meta"># 全局中间件</span>
│   ├── config/             <span class="hljs-meta"># 配置（DB、ENV等）</span>
│   ├── utils/              <span class="hljs-meta"># 工具</span>
│   ├── errors/             <span class="hljs-meta"># 全局错误类</span>
│   ├── types/              <span class="hljs-meta"># 全局类型</span>
│   └── logging/            <span class="hljs-meta"># 日志系统</span>
|    <span class="hljs-meta"># 也可以把一些重要模块单独放在根目录，例如 config ， log</span>
│
└── index.ts                <span class="hljs-meta"># 启动文件</span>
</code></pre>
<p>注意：也可以把一些重要模块单独放在根目录，例如 config ， log等等，看业务需要。</p>
<p>最后，我们可以借鉴一下 angular 团队的一些代码风格指南。例如</p>
<ul>
<li>
<p>总则</p>
<ul>
<li>坚持每个文件只定义一样东西（例如服务或者组件）</li>
<li>考虑把文件大小限制在 400 行代码以内</li>
<li>坚持定义简单函数来组装复杂函数</li>
</ul>
</li>
<li>
<p>命名</p>
<ul>
<li>使用点和横杠来风格文件名，不建议驼峰</li>
<li>坚持在描述性名字中，用横杠分割单词</li>
<li>坚持遵守先描述组件特性，再描述它的类型的模式，例如 <code>feature.type.ts</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">调试</h2>
<p>接下来介绍一下，如何借助 vscode(其它编辑器，cursor，trae 是同样的方式)，来调试 nest.js 和 hono.js 代码</p>
<p>首先我们简单介绍一下如何调试单文件 node.js 文件，这个对于我们 demo 也算比较有用。</p>
<p>首先，随便在跟目录建一个 index.js</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c45d47e0ad943d790c6d0a8139d3c44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=yOeuyBtLV8icdUet5MkUMcBGtGs%3D" alt="image.png" loading="lazy"/></p>
<p>然后我们在第 6 行，打了一个断点，可以看到红色标记。然后再根目录，建立一个 .vscode 文件夹，文件夹内建立一个 launch.json</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2479c2b99bcf4a659b9474a83bc76302~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=KknRi82WS8CjI46HtBnJhc3ho7s%3D" alt="image.png" loading="lazy"/></p>
<p>接着点击 如下的 bug 按钮，就可以调试了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dd4671a138a4eff9be825e236830162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FvNBsGJMUCkWds6vY4ykzaodzBc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">调试 nest</h3>
<p>调试 nest 和 hono 都很相似，只是 launch.json 的配置不一样，</p>
<p>我们 launch.json 的配置如下（调试 nest 的）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 配置文件的版本号，遵循VSCode调试协议。0.2.0是当前常用版本。</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 定义调试配置的数组，一个文件可以包含多个独立的调试配置。</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-comment">// 指定调试器类型。`node` 表示使用Node.js调试适配器，用于调试JavaScript/TypeScript。</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 调试请求类型。`launch` 表示启动一个新程序进行调试；另一种是`attach`（附加到已运行进程， 这个不纠结，我们都用 launch）。</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 在VSCode调试下拉菜单中显示的名称，随便起个就行。</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch Program"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 指定实际用来运行程序的命令。这里使用`pnpm`包管理器作为启动器。</span>
      <span class="hljs-comment">// 如果不设置此项，默认值为`node`。</span>
      <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 传递给`runtimeExecutable`（pnpm）的命令行参数。</span>
      <span class="hljs-comment">// 等同于在终端执行：`pnpm run start:dev`</span>
      <span class="hljs-attr">"runtimeArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"start:dev"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// `runtimeVersion`主要用于通过`nvm`等版本管理器切换Node版本。</span>
      <span class="hljs-attr">"runtimeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20.16.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 调试时跳过（不进入）的文件。</span>
      <span class="hljs-comment">// `&lt;node_internals&gt;/**` 表示跳过所有Node.js内置核心模块代码，使调试更聚焦于应用自身。</span>
      <span class="hljs-attr">"skipFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"&lt;node_internals&gt;/**"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里的关键是什么呢，就是 runtimeExecutable + runtimeArgs， runtimeExecutable 代表我们执行的命令使用 pnpm, 你可以改为 yarn， npm，都行，然后执行的命令参数runtimeArgs，合起来就是</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run start:dev
</code></pre>
<p>为什么这样呢，因为 start:dev 是 nest.js 的 package.json 中注明的启动开发环境的命令,如下：</p>
<pre><code class="hljs language-sql" lang="sql">"scripts": {
    "build": "nest build",
    "format": "prettier --write \"src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\" \"test<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
</code></pre>
<p>当然，你可以用 start 命令，start:debug 命令都行，假设就用</p>
<pre><code class="hljs language-perl" lang="perl"> // 指定实际用来运行程序的命令。这里使用<span class="hljs-string">`pnpm`</span>包管理器作为启动器。
      // 如果不设置此项，默认值为<span class="hljs-string">`node`</span>。
      <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
      <span class="hljs-regexp">//</span> 传递给<span class="hljs-string">`runtimeExecutable`</span>（pnpm）的命令行参数。
      // 等同于在终端执行：<span class="hljs-string">`pnpm run start:dev`</span>
      <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"run"</span>, <span class="hljs-string">"start:dev"</span>],
</code></pre>
<p>然后我们在 app.controller.ts 上打个断点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e4a980696b4ae8a32969ac00d971e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=BPXY5c9i2v2IuwJKzxFvL6yNvTQ%3D" alt="image.png" loading="lazy"/></p>
<p>然后启动调试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac8175fe89d64b72ac1d012bf2de2cd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=yAXY6G2hgJeDVkCshKlu1aOKOfs%3D" alt="image.png" loading="lazy"/></p>
<p>点击后，相当于在命令行输入：</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run start:dev
</code></pre>
<p>接着你浏览器访问 <code>http://localhost:3000</code> 就能触发断点了！</p>
<h3 data-id="heading-7">调试 hono</h3>
<p>所以根据上面的理论，我们来创建一个 launch.json，用来调试 hono</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch Program"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心：告诉调试器用pnpm来运行</span>
      <span class="hljs-attr">"runtimeArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dev"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 传给pnpm的参数：运行“dev”脚本</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>同理，其实就是触发了：</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run dev
</code></pre>
<p>命令， dev 这个命令其实就是 hono 项目 package.json 中的内容：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsx watch src/index.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node dist/index.js"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">容器部署</h2>
<p>接下来是很长的关于 docker 和我们前端全栈相关的知识，有深入的原理介绍，有兴趣的同学可以一起交流。</p>
<h3 data-id="heading-9">为什么需要 Docker？</h3>
<p>即便是纯前端开发者，不涉及 Node.js、Nginx 或数据库等服务器相关软件，在中小企业部署应用时，后端团队或项目经理常常会要求前端团队提供一个 Dockerfile，以便将前端应用部署到 Nginx 上。这种要求在容器化时代变得越来越普遍。所以是有必要了解容器的知识的。</p>
<h3 data-id="heading-10">容器化的基本概念</h3>
<p>在容器化时代，通常通过 Dockerfile（用于描述如何构建 Docker 容器的配置文件）构建开发或生产环境的 Docker 镜像，然后启动这些镜像，使外部网络可以访问对应的应用。</p>
<p>在 Docker 流行之前，前端应用的部署方式一般是直接在服务器上下载相关软件（如 Nginx、MySQL 或 PostgreSQL），配置并启动服务，再将打包后的前端内容放入 Nginx 的指定目录，以便外部访问。这种方式被称为物理机直接部署。</p>
<h3 data-id="heading-11">为何转向容器化部署？</h3>
<p>容器化部署的优势主要体现在以下两个方面，我们用前端的视角去理解：</p>
<ol>
<li><strong>环境一致性</strong>：</li>
</ol>
<ul>
<li>前端常见的问题，为什么在 Chrome 中功能正常，但在其他浏览器中却无法运行？</li>
</ul>
<ol start="2">
<li><strong>简化环境配置</strong>：</li>
</ol>
<ul>
<li>前端项目通常需要配置 ESLint、Prettier、TSConfig、Vite/Webpack 等工具。这些配置繁琐，且需要一定的知识才能定制适合项目的配置。为了解决这些问题，前端社区提供了许多 CLI 工具，如 React 的 create-react-app、Vue 的 Vue CLI、Next.js 的 @nextjs/cli 等，这些工具为项目提供了现成的模板，并在 Babel/SWC 和 Browserslist 的配置中解决了兼容性问题。</li>
</ul>
<p>同样，服务器端也面临环境一致性和配置繁琐的问题，并且这些问题相当棘手。为什么会这样呢？我们可以回顾一下 Docker 流行之前的 PaaS 项目。</p>
<h3 data-id="heading-12">PaaS 的背景</h3>
<p>PaaS（Platform as a Service）是云计算的重要服务模型，旨在提供一个完整的应用开发、运行和管理环境，使开发者能够专注于编写代码，而无需担心底层基础设施或操作系统。</p>
<h3 data-id="heading-13">PaaS 受欢迎的原因</h3>
<p>PaaS 项目受到广泛接纳的一个主要原因是它提供了“应用托管”能力。如今，许多人使用阿里云、腾讯云、AWS 等云服务，实际上就是将本地应用托管到云端。然而，这一部署过程常常会遇到云端虚拟机与本地环境不一致的问题。因此，当时的云计算服务竞争的焦点在于谁能更好地模拟本地服务器环境，从而提供更优质的“上云”体验。而开源 PaaS 项目的出现，正是为了有效解决这一问题。</p>
<h3 data-id="heading-14">docker 的出现</h3>
<p>正当大家比谁能更好模拟本地服务器环境的时候，docker 跳出来说，对不起，在做的各位都是垃圾。。。我能完全模拟本地服务器环境，嘿嘿！</p>
<p><strong>并且 docker 提供了非常便捷的打包机制，</strong> 并且这个压缩包包含了完整的操作系统文件和目录，也就是包含了这个应用运行所需要的所有依赖。只需：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker build 打包自己的服务
docker run 启动自己的服务
</code></pre>
<p>如此，docker 轻松击败了 pass 本身的打包机制，后来逐渐使容器技术成为云服务的基础设施之一。</p>
<p>你可以想象，就跟前端使用 vite 和 webpack 一样，一键 <code>npm run build xxx</code> 打包后，你的前端应用能在各个浏览器上运行，并帮助我们解决了浏览器兼容性问题，如此便捷，谁能不喜欢这样的技术呢？</p>
<p>所以这个小节我们可以回答常见的面试题：</p>
<ul>
<li>为什么需要容器化 （docker）？</li>
</ul>
<p>既然 docker 这么好用，那 docker 镜像，docker 容器，docker 镜像仓库等等常见概念是什么意思呢？我们拿前端的 npm 包管理来帮助我们理解。</p>
<h2 data-id="heading-15">Docker 必需了解的基础概念</h2>
<h3 data-id="heading-16">1. Docker 镜像和 Docker 容器</h3>
<p>镜像（<code>Image</code>）和容器（<code>Container</code>）的关系，就像是面向对象程序设计中的 <code>类</code> 和 <code>实例</code> 一样，镜像是静态的定义，容器是镜像运行时的实体。</p>
<ul>
<li><strong>Docker 镜像</strong> 是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。</li>
<li><strong>Docker 容器</strong>的实质就是一个进程，但是跟普通进程不一样的是，因此容器可以拥有自己的 <code>root</code> 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。</li>
</ul>
<h3 data-id="heading-17">2. Dockerfile</h3>
<p>dockerfile 是一个文本文件，包含了一系列指令，一般我们都是用这个文件配合 docker build 命令来构建 docker 镜像。</p>
<h3 data-id="heading-18">3. Docker Client、Docker hub、Docker Daemon</h3>
<p>关系如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a570165d395b4ae7927cb22d8824e443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=Jkiiqfu%2BDqq%2F89BYaaYnBznEq5A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7885b08b51d74326a891fbaf1776b273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FLhngk35eljrOBOBGdauK%2FvhUSA%3D" alt="" loading="lazy"/></p>
<p>上图中涉及 3 个重要的概念</p>
<ul>
<li>Docker Hub：Docker Hub 是一个云端托管的Docker镜像库，用户可以在其中存储和共享 docker 镜像。它类似于 npm 仓库。</li>
<li>Docker Daemon：守护进程是一个后台服务，负责管理 docker 容器和镜像。它监听来自的 docker 客户端的命令，并执行相应操作。</li>
<li>Docker Client：允许用户与守护进程交互的命令行工具。</li>
</ul>
<h2 data-id="heading-19">【延伸补充】深入原理1：一定要理解 Docker 镜像的分层的原理</h2>
<p>上面我们说了，<strong>Docker 镜像</strong> 是一个特殊的文件系统，其中有一个特别重要的特性，称之为文件系统分层。为了说明这个原理，我们需要从 linux 本身的文件系统讲起。</p>
<p>首先 linux 启动的时候，首先加载的是 bootfs 文件系统，它包含了 boot 加载器和 kernel 内核。kernel 内核作用是什么呢？我们知道计算机是由硬件构成的，例如 cpu、主板、外设、内存等等，最终这些硬件会被操作系统接手管理，例如，将在硬盘的程序映射为一个个动态的进程，然后增加 cpu 调度算法，让每个进程按照特定的规则不断运行，还需要管理内存，不断的读取内存指令给 cpu 运行。。。</p>
<p>然后 linux 会挂在 rootfs 文件系统，什么是 rootfs 呢？作用是什么呢？我们知道在玩 windows 操作系统的时候，C 盘一般都是用来存储操作系统相关的文件的，例如 C 盘下的 Program Files 一般用来存放操作系统相关的配置文件。</p>
<p>而 linux 中的 rootfs 在初始化的时候，也是把操作系统相关的文件放入其中。linux 有很多不同的发行版本，例如 centos，ubantu 等等，他们都有自己的 rootfs，规则有所不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/460a739ec5904cf49ccf1ef798882f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=O65Hc%2F%2F%2FaD9Lg2MZZ0F8yyhiLSo%3D" alt="" loading="lazy"/></p>
<p>而上面说的两个文件系统，在 docker 中，并不是混在一起的，而是如上图分层了的，这意味着，如果正在使用不同的 docker 镜像，他们最底层的 bootfs 很可能是一样的（相同的 linux 版本），那么这些镜像就可以共享这一层，而不是每个镜像都分别有一个 bootfs。</p>
<p>同理 rootfs 也是一样，如果我们使用的镜像都是基于 ubantu 的 linux 发行版本，版本号也是一样的话，那么 rootfs 也是可以共享的。</p>
<p>这样就会大大降低 docker 的体积，这也是为什么大家说 docker 轻量的原因。</p>
<p>docker 镜像本身提供的这些数据层是只读的，我们后续用 dockerfile 去自定义我们自己的镜像时，实在可读层上面加一个读写层，但是修改 docker 的，所以共享底层的数据层也不会影响我们定制化的 docker 镜像。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15b4b8bedf384df983393bdfe87b3b4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=KAp6f5ZN1Rw6QuAFT%2FEfTCb0Fac%3D" alt="" loading="lazy"/></p>
<p>为什么理解分层如此重要呢？我们举个例子（以下 dockerfile 文件每个命令是什么意思会详细讲解，现在不用在意），以下 docker file 中，我们注意 RUN 命令：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span>

RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> <span class="hljs-keyword">update</span>
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3<span class="hljs-operator">-</span>pip
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> clean
</code></pre>
<p>这里执行了 4 个 RUN 命令，而每个 RUN 命令都会单独在 docker 镜像上建立一个单独的读写层，这样会增大构建后的 docker 镜像体积，我们可以将其合并：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span>

RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> <span class="hljs-keyword">update</span> <span class="hljs-operator">&amp;&amp;</span> \
    apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3 python3<span class="hljs-operator">-</span>pip <span class="hljs-operator">&amp;&amp;</span> \
    apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> clean <span class="hljs-operator">&amp;&amp;</span> \
    rm <span class="hljs-operator">-</span>rf <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>lib<span class="hljs-operator">/</span>apt<span class="hljs-operator">/</span>lists<span class="hljs-comment">/*
</span></code></pre>
<p>同样的，如果分层中，分层的内容没有变，docker 会重复利用这些已经打包好的层，什么意思呢？我们前端应用打包的时候，往往 package.json/package.lock.json 的依赖是没有变化的，所以我们如果能利用之前已经下载好的 npm 包的层，就不用重复下载了。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 Node.js 作为基础镜像</span>
FROM node:<span class="hljs-number">22</span>-slim

<span class="hljs-comment"># 将 package.json 和 package-lock.json 复制到容器中</span>
COPY <span class="hljs-keyword">package</span>*.json ./

<span class="hljs-comment"># 安装依赖（会在此层缓存 node_modules）</span>
RUN npm install

<span class="hljs-comment"># 复制应用程序的其他源代码到容器中</span>
COPY . .

<span class="hljs-comment"># 暴露应用程序运行的端口</span>
EXPOSE <span class="hljs-number">3000</span>

<span class="hljs-comment"># 启动应用程序</span>
CMD [<span class="hljs-string">"npm"</span>, <span class="hljs-string">"start"</span>]
</code></pre>
<p>以上我们会看到 <code>RUN npm install</code> 这一步，如果命令跟以前一样，会利用缓存，不会下载 npm 包，具体缓存规则，官方叙述如下（建议后续看完 dockerfile 章节后再回来看这部分，非常重要）：</p>
<p>在镜像的构建过程中，Docker 会遍历 <code>Dockerfile</code> 文件中的指令，然后按顺序执行。在执行每条指令之前，Docker 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 <code>docker build</code> 命令中使用 <code>--no-cache=true</code> 选项。 但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p>
<ul>
<li>从一个基础镜像开始（<code>FROM</code> 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li>
<li>在大多数情况下，只需要简单地对比 <code>Dockerfile</code> 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li>
<li>对于 <code>ADD</code> 和 <code>COPY</code> 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li>
<li>除了 <code>ADD</code> 和 <code>COPY</code> 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code>RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li>
</ul>
<p>一旦缓存失效，所有后续的 Dockerfile 指令都将产生新的镜像，缓存不会被使用。</p>
<h2 data-id="heading-20">【延伸补充】深入原理2：一定要理解什么是构建上下文</h2>
<p>上面有一个很容易混淆的路径问题，<code>COPY package*.json ./</code> 中 package*.json 指的并不是 docker build 命令的目录，也不是 <code>Dockerfile</code> 所在的目录，而是执行上下文的目录。执行上下文目录我们是在 docker build 的时候指定的，这里我们指定的 <code>.</code>，表示执行 docker build 命令时的目录。</p>
<p>为什么这个概念如此重要，很有可能你你设置的不对，根本找不到 package*.json，例如你这样</p>
<pre><code class="hljs language-bash" lang="bash">COPY ../package*.json ./
</code></pre>
<p><code>../package*.json</code>，指的是构建上下文上一层目录的 package*.json，其实是找不到的，因为我们将构建上下文复制到 docker host 的时候，docker 只会复制构建上下文内的内容（并且除开 .dockerignore file 指定的排除的内容）。</p>
<p>所以你在构建上下文之外找 package*.json，肯定是找不到的。</p>
<p>并且有相当多网上的人误以为 <code>.</code> 是指定 <code>Dockerfile</code> 所在目录呢？这是因为在默认情况下，如果不额外指定 <code>Dockerfile</code> 的话，会将上下文目录下的名为 <code>Dockerfile</code> 的文件作为 Dockerfile。</p>
<p>这只是默认行为，实际上 <code>Dockerfile</code> 的文件名并不要求必须为 <code>Dockerfile</code>，而且并不要求必须位于上下文目录中，比如可以用 <code>-f ../Dockerfile.php</code> 参数指定某个文件作为 <code>Dockerfile</code>。</p>
<p>当然，一般大家习惯性的会使用默认的文件名 <code>Dockerfile</code>，以及会将其置于镜像构建上下文目录中。</p>
<p>最后最最重要的就是需要写一份 .dockerignore 文件，例如，我们前端项目往往都有 node_modules 目录，而且体积相当大，所以没必要将其复制到 docker host。</p>
<ul>
<li>这会显著增加镜像的体积，从而影响镜像构建时间和传输效率。</li>
<li><code>node_modules</code> 中的某些依赖可能是平台相关的（例如，使用了原生代码或编译步骤），在不同的操作系统（如 Windows 和 Linux）上会有所不同。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751edbf1964d4253a777394992781d8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=Kno%2FN33OujwUu5h4MQTmHus7seQ%3D" alt="" loading="lazy"/></p>
<p>好了，我们接着编写完 dockerfile 文件继续说。</p>
<p>然后，就可以运行 docker 镜像</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d -p <span class="hljs-number">3000</span>:<span class="hljs-number">80</span> react-app
</code></pre>
<ul>
<li><code>-d</code>：以后台模式运行容器。</li>
<li><code>-p 3000:80</code>：将本地的 8080 端口映射到容器的 80 端口。</li>
</ul>
<p>然后本地访问 localhost: 3000，或者你的机器有外网地址，使用 &lt;外网地址&gt;: 3000，访问即可。</p>
<p>这里还会牵扯到一个需要深入讨论的内容，就是容器网络的原理，我们后续再谈。</p>
<p>这里我们总结一下一些常用的 docker 命令，帮助大家快速用起来 docker。</p>
<h3 data-id="heading-21">常用命令总结</h3>
<p><strong>下载镜像</strong>：docker pull &lt;镜像名&gt;，例如下载 node.js 22 版本的镜像</p>
<pre><code class="hljs">docker pull node:22-slim
</code></pre>
<p>注：可以用 docker hub 来搜索支持的版本。方法如下：</p>
<ul>
<li>进入docker hub的官网，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2F" target="_blank" title="https://hub.docker.com/" ref="nofollow noopener noreferrer">hub.docker.com</a></li>
<li>然后搜索需要的镜像：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3988f9ef8e46490ab302e31d3871e483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FD2TnK6Lpe1Bne3QaP8KKcKh0vA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>查看镜像支持的版本：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eac86c6febf940ce994e34bd32a0f5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=dxY5IlqwXvRbaKbeAl8j%2F5%2BqX%2Fs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p><strong>列出镜像：</strong></p>
<pre><code class="hljs">docker images 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38688a35f24a4f9b92c81398c2ba463d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=IafRLnpcdUvZBbkcYRHmrYb6cno%3D" alt="" loading="lazy"/></p>
<p><strong>删除镜像</strong>：docker rmi -f &lt;镜像名&gt;，例如：</p>
<pre><code class="hljs">docker rmi -f nginx
</code></pre>
<p><strong>新建并启动容器：docker run -d -p &lt;本地端口&gt;:&lt;容器端口&gt; &lt;镜像名&gt;，例如</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> --name nginx nginx:<span class="hljs-number">1.17</span><span class="hljs-number">.0</span>
</code></pre>
<ul>
<li>
<p>-d 选项：表示后台运行</p>
</li>
<li>
<p>--name 选项：指定运行后容器的名字为nginx,之后可以通过名字来操作容器</p>
</li>
<li>
<p>-p 选项：指定端口映射，格式为：hostPort:containerPort</p>
</li>
</ul>
<p><strong>列出容器：</strong></p>
<pre><code class="hljs">docker ps
</code></pre>
<p><strong>查看运行中的容器</strong>：</p>
<pre><code class="hljs">docker ps
</code></pre>
<p>如果加入 -a 参数，即使暂停的容器也会被列出来。</p>
<p><strong>停止容器</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker stop &lt;容器ID | 容器名字&gt;
</code></pre>
<hr/>
<p><strong>删除容器</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">rm</span> &lt;容器ID | 容器名字&gt;
</code></pre>
<p><strong>在宿主机查看docker使用cpu、内存、网络、io情况：</strong></p>
<pre><code class="hljs language-xml" lang="xml">docker stats <span class="hljs-tag">&lt;<span class="hljs-name">容器ID</span> | <span class="hljs-attr">容器名字</span>&gt;</span>
</code></pre>
<p><strong>进入Docker容器内部的bash</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it &lt;容器名字&gt; /bin/bash
</code></pre>
<p>注意，有的镜像里面没有 bash 命令，例如 nginx，可以将 /bin/bash 改为 /bin/sh</p>
<p>以上的知识，足够前端应付常见的场景了，遇到问题搜索一下，看懂也不是难事。其实容器的网络，是比较特殊的，因为容器实际上看起来是有自己独立的文件系统，独立的网络，独立的进程的（也就是在容器中，你会看懂容器进程的 id 是 1）等等。</p>
<p>既然有自己独立的网络，那么容器的网络如何跟外界打通，原理又是什么呢？（这个问题特别重要，无论对于你自己本地调试，还是生产环境解决容器无法访问的问题）</p>
<p>既然有自己独立的文件系统，那么容器销毁，容器里面的文件也随之销毁，那么容器如何做到将文件跟物理机上的文件系统共享的呢？</p>
<h2 data-id="heading-22">【延伸补充】深入原理3：docker 容器的底层三大核心技术</h2>
<p>三大核心技术分别是 namespace、Cgroup 以及联合文件系统，联合文件系统上面已经讲了，现在就剩下 namespace 和 Cgroup 了。我们先来看看 pid namespace 是什么。</p>
<p>首先再次强调，容器就是一个进程。举个例子</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9caf1f5712394135bd6b369da0e82fdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=IUHJUSoVcTJf%2FK2%2FPPFFPFMXH0A%3D" alt="" loading="lazy"/></p>
<p>我们首先使用以下命令来获取到容器的进程 id 为 2526</p>
<pre><code class="hljs language-bash" lang="bash">docker inspect &lt;容器 <span class="hljs-built_in">id</span>&gt; | grep Pid 
</code></pre>
<p>然后使用 ps 命令来过滤出 2526 进程</p>
<pre><code class="hljs language-perl" lang="perl">ps -ef | <span class="hljs-keyword">grep</span> <span class="hljs-number">2526</span>
</code></pre>
<p>发现确实有对应的进程。</p>
<p>但是跟普通进程不一样的是，容器的进程利用 namespace 技术，让我们进入容器后，发现容器主进程的 pid 是 1 ，而不是 2526。也就是容器使用了"障眼法"，来让自己跟别的容器都隔离开。就拿进程隔离来说，容器是如何修改进程视图的呢？如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0ce66bf43fd47d09fe3052a5b27d14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=9tkQXP8lYTyx9Wi9GjGU5CD4vCU%3D" alt="" loading="lazy"/></p>
<p>如上图，1、2、3、4、5、6、7、8、9、10，都是在物理机操作系统上的进程号（PID），而进入容器后，PID 8 是容器的主进程，linux 将其修改为进程号（PID）为 1，子进程也同样修改 PID，这样你在容器里，看到主进程是 PID 1，但是你退出容器，查看这个容器的进程号，就是 8。</p>
<p>namespace 不仅仅隔离了进程的 pid，还包括网络、用户、IPC 等等。接着我们看看 Cgroup 是什么。</p>
<p>你想想，虽然视图可以改变，但是却没法限制这个容器对 cpu 的使用，所以是有可能单个容器把 cpu 跑满的。所以如果能限制 cpu、内存的使用就更好了，Cgroup 就是做这个事的。</p>
<p>Cgroup 的原理如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a2e69605244305bc66a7e45fb5b267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=9y8Zn7iHzfraJpWX37bPGDJoWfQ%3D" alt="" loading="lazy"/></p>
<p>Cgroup 对不同资源进行了分组，例如 cpu 总共是 100%，假设分配给某个容器是 25%，当你进入容器中，你看到的自己 cpu 总共是 100% ，也就是这个容器里的 100% 是假的，其实是从真实的 25% 里面去分的。</p>
<p>Cgroup 如何操作是有对应的 linux 命令的，这里我们就不深入了，因为性价比并不高，用好 docker 就可以了。</p>
<h2 data-id="heading-23">【延伸补充】深入原理4：docker 容器网络的秘密</h2>
<p>为了更通俗的解释 docker 的桥接网络，我们先从计算机网络基本的知识讲起：</p>
<p>如下图，只需要一根网线相互连接，然后在计算机上配置一下自己的 ip 地址（在一个网段里），两台计算机就可以相互通信了。例如 A 计算机的 ip 我们写死 ip 到网卡，地址为 192.168.1.1/24，B 计算机是 192.168.1.2/24 ，他们都是 192.168.1.xxx 网段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d93afb2a4e41fcaab4fc1775deb8ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=sDm3sjgDlsFnfCwugXRdy%2B8RmjE%3D" alt="" loading="lazy"/></p>
<p>有些同学可能不理解，为啥要分配 ip 地址？因为我们很多通信协议是基于 ip 协议的，例如 http，tcp。所以必须分配 ip 地址，才能让数据包走出网卡。我们接着聊:</p>
<p>现在我们多加一些电脑，这时候一根网线肯定就不够了，我们就加入一个交换机（虚拟交换机是有 ip 的，但是现实生活中的交换机是没有 ip），如下图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8329e75a78ee43bd83f814a96565e1e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=%2B7BU4vfRoF7tpIT3h7fF8fwW2OE%3D" alt="" loading="lazy"/></p>
<p>假设交换机的 ip 是 192.168.1.1/24，这个交换机还可以自动分配 ip（dhcp协议），只要计算机连接交换机，就会自动分配一个不重复的 ip 地址，那么多台计算机互相通信就解决了。</p>
<p>其实 docker 内部默认有一个叫做 docker0 的网桥，这个网桥工作机制就跟我们上面说的交换机类似。而容器默认情况下，会连接 docker 0 网桥。如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32d6362471ac450492a7a8be0f5f9368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=HHoBlHiBNSVLrarn8RgpPDg8AmE%3D" alt="" loading="lazy"/></p>
<p><strong>这样容器之间互通的问题我们就解决了。</strong></p>
<p>那么如何解决容器跟外部网络通信的问题，例如某个容器去访问微信登录。</p>
<p>如下图，其实 docker0 是连接到我们真实物理机的网卡 eth0 来转发数据，从而让容器的数据通过 -&gt; docker0 -&gt; eth0 发送到计算机外部</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/619e592a6b874215b0bcb41f17da744f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=PZPhQEYZ91jX7fsMbKKyTY4fADw%3D" alt="" loading="lazy"/></p>
<p>这里又有问题了，容器内部的 ip 往往是一个内部地址，什么是内部地址？你会看到，我们前端启动前端应用，经常看到启动的 ip 地址是 192.168.x.x，你回到家启动前端应用分配的地址居然是一样的 192.168.x.x。我们知道 ip 地址必须全网唯一，为啥在家里分配的 ip 和在公司分配的 ip 一样呢？</p>
<p>这是因为 ip 地址规定了一些只能在内网通讯的地址，不能用在外网，例如 192.168.x.x 就是不会用在外部网络访问的 ip 地址。</p>
<p>这对于 docker 容器访问外部网络就有问题了，你想想 docker容器 -&gt; docker0 -&gt; eth0 将数据包传给了微信服务器，微信服务不能说我回传的 ip 地址是 docker容器的 ip，因为 docker容器的 ip 是内部地址，不能在网络上传输。</p>
<p>这里又涉及一个概念，叫 nat 转换，也就是 docker 容器将数据包传给 eth0 的时候，会改写自己数据包发送端的 ip 地址为 eth0 的公网地址。</p>
<p><strong>这样就解决了容器访问外部网络的问题了。</strong></p>
<p>问题又来了哦，那返回给 eth0 的数据，如何知道这个数据包最终转发给哪个容器呢？这里涉及到一个叫做 iptables 的工具（NAT 转换也是依赖它），它可以记录转发规则，例如如果这个数据是从 80 端口出去的，那么返回的时候，就返回给 A 容对应的内部 ip。</p>
<h2 data-id="heading-24">【延伸补充】深入原理5：docker 容器文件隔离和共享的秘密</h2>
<p><strong>文件隔离</strong></p>
<p>docker 容器的文件系统是跟宿主机隔离的，在 docker 里，我们能看到一份独立的文件系统。linux 如何实现的呢？</p>
<p>实际上 linux 也是用了障眼法做到的，如下图，首先假设下图是正常的某台 linux 机器的目录结构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ba4a7f3e82450689860ceac12ac9a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=lVn%2Fidbfvt6nXwvpv6%2BgosHvcVs%3D" alt="" loading="lazy"/></p>
<p>然后我们希望 docker 容器跟 joe 目录（最右边最后一个目录）拿来作为容器的根目录，使用 linux 的 Mount Namespac 功能 + chroot 命令，结果如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/224342bce84c4d8f808c3cdcf12aa387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=mzAa52GcFrI1Yv92LJOZUEVqALw%3D" alt="" loading="lazy"/></p>
<p>容器的根目录，挂载到了宿主机的 joe 目录。由于 Mount Namespace 技术的特性，这个容器的根目录对于宿主机是看不见的。</p>
<p>而这在某些情况下不是我们想要的。比如数据库文件，我们想留在宿主机上，这样重启容器的时候，依然保留了数据库的数据。</p>
<p>而这里要使用到的挂载技术，就是Linux的<strong>绑定挂载（bind mount）机制</strong>。它的主要作用就是，允许你将一个目录或者文件，而不是整个设备，挂载到一个指定的目录上。并且，这时你在该挂载点上进行的任何操作，只是发生在被挂载的目录或者文件上，而原挂载点的内容则会被隐藏起来且不受影响。</p>
<p><strong>文件共享</strong></p>
<p>由于容器的特性，如果容器删除，那么容器里的数据也会删除，之前的挂载功能也会解除。可是在某些情况下，我们希望保留容器里的数据，例如数据库，方便再下一次启动镜像的时候能共享之前容器的数据。</p>
<p>这个功能在 docker 叫做绑定 <strong>Volume 功能。</strong> 这个功能的实现其实很简单，之间我们讲的绑定挂载，其实需要分为两步，第一步开启 Mount Namespace，此时容器内部仍然可以看到宿主机的目录，但是宿主机看不到容器的目录，第二步执行类似 chroot 命令，可以简单理解为执行后，容器就看不到宿主机目录了。</p>
<p>所以我们可以在第一步之前，把 Volume 指定的宿主机目录（比如/home目录），挂载到指定的容器目录（比如/test目录）在宿主机上对应的目录上，这个 Volume 的挂载工作就完成了。</p>
<h2 data-id="heading-25">最后补充</h2>
<p>补充，之前前端部署的 dockerfile 一般都会用分阶段构建的方法，首先借助 node.js 镜像打包前端应用，然后将打包好的内容放入 nginx 镜像中，最后借助 nginx 作为 web 服务器，来让外网访问。我们简单实现一下，可用在生产环境：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Use the official Node.js runtime as the base image</span>
FROM node:20-slim as build

<span class="hljs-comment"># Set the working directory in the container</span>
WORKDIR /app

<span class="hljs-comment"># Copy package.json and package-lock.json to the working directory</span>
COPY package*.json ./

<span class="hljs-comment"># Install dependencies</span>
RUN npm install

<span class="hljs-comment"># Copy the entire application code to the container</span>
COPY . .

<span class="hljs-comment"># Build the React app for production</span>
RUN npm run build

<span class="hljs-comment"># Use Nginx as the production server</span>
FROM nginx:alpine

<span class="hljs-comment"># Copy the built React app to Nginx's web server directory</span>
COPY --from=build /app/build /usr/share/nginx/html

<span class="hljs-comment"># Expose port 80 for the Nginx server</span>
EXPOSE 80

<span class="hljs-comment"># Start Nginx when the container runs</span>
CMD [<span class="hljs-string">"nginx"</span>, <span class="hljs-string">"-g"</span>, <span class="hljs-string">"daemon off;"</span>]
</code></pre>
<p>需要注意的是</p>
<pre><code class="hljs language-bash" lang="bash">COPY --from=build /app/build /usr/share/nginx/html
</code></pre>
<p>--from build , 这个 build 就是 <code>FROM node:20-slim as build</code> 中，node.js 镜像的别名。意思是把这个镜像中 /app/build 目录下的文件复制到 nginx:alpine 镜像的 /usr/share/nginx/html 文件夹下。</p>
<h2 data-id="heading-26">欢迎加入交流群</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库AI方向探索-MCP原理解析&DB方向实战｜得物技术]]></title>    <link>https://juejin.cn/post/7581670270844174376</link>    <guid>https://juejin.cn/post/7581670270844174376</guid>    <pubDate>2025-12-09T08:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581670270844174376" data-draft-id="7581415427516661802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-09T08:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:55:49.000Z" title="Tue Dec 09 2025 08:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读40分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP设计理念</h2>
<p>在浅析 MCP 原理之前，有必要搞清楚两个问题：<strong>MCP 是什么？为什么会出现？</strong> 以此明晰它存在的价值和意义。</p>
<p>首先，MCP（Model Context Protocol，模型上下文协议）是由人工智能公司 Anthropic 主导推出的一种<strong>开放标准协议，旨在统一大型语言模型（LLM）与外部数据源、工具及服务之间的交互方式</strong>。该协议<strong>通过JSON-RPC 2.0 标准消息格式</strong>定义通信规则，使模型能像使用"万能接口"（类比 Type-C 接口）一样即插即用地连接异构资源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f31e19dded49d8b56103dc2523e504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=qXKKS6mABMUC3yGTTRPZnCB5s%2Fc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F598749792" target="_blank" title="https://zhuanlan.zhihu.com/p/598749792" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/598749792</a></p>
<p>其架构采用<strong>客户端-服务器模式，包含三个关键组件</strong>： </p>
<ul>
<li><strong>MCP Host</strong>：运行大模型应用（如 Cursor、Cline、Cherry Studio、Claude Desktop 等），负责发起任务请求。</li>
<li><strong>MCP Client</strong>：集成在 Host 中的协议客户端，解析任务需求并与服务器协调资源调用。</li>
<li><strong>MCP Server</strong>：<strong>轻量级</strong>服务程序，动态注册与暴露本地资源（例如文件、数据库）或远程服务（如云API），处理客户端请求并返回结构化数据，同时提供安全控制，包括访问权限管理和资源隔离。</li>
</ul>
<p>简单概括为 MCP 是一种开放标准，本质是应用层协议（Protocal），跟我们熟知的 TCP/IP，HTTP 协议类似。借助它开发者可以安全地在数据源和 AI 工具之间建立双向连接。其架构概括起来就是：</p>
<ul>
<li><strong>开发者可以通过 MCP 服务器公开他们的数据；</strong></li>
<li><strong>AI 应用（MCP 客户端） 可以连接到 MCP 服务器，获取所需数据，LLMs 再分析投喂的数据。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2a345ca9dbd4ff9851b7b321178f042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=TRBAEFK%2B%2BCasoc7fVFlxszzXMK8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那为什么会出现呢？这就要说到<strong>RAG和Function Calling</strong> 技术了。</p>
<p><strong>RAG（检索增强生成）</strong> 通过检索外部知识库获取与问题相关的实时信息并将其注入模型提示词，生成更精准、时效性更强的回答。 <strong>其工作原理为</strong>：当用户发出提问时，AI 应用通过向量检索、关键词匹配等方式，从外部知识库或数据源中搜索相关信息，再把检索到的信息作为上下文提供给大模型，让大模型基于补充的信息进行回答。<strong>技术流程：</strong> 用户提问→问题向量化→向量数据库相似度检索→拼接上下文提示词→模型生成答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c83eef56bd64d45b58a24f1d8e244f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=O21RxrzyhDSnSU8%2B8t4wFp%2BuKhs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：ailydoseofds</p>
<p>而<strong>Function Calling（函数调用）</strong> 拓展了模型执行动作的能力，解决纯文本交互的局限性，即模型解析用户意图后生成结构化指令，调用预定义外部函数或 API（如发送邮件、查询天气）。<strong>其工作原理为</strong>：当用户发出提问时，应用会将集成的函数列表作为上下文发送给大模型。<strong>大模型根据用户输入判断应调用的函数，并生成相应的调用参数。随后，应用执行该函数并将结果发送给大模型，作为补充信息供其生成最终的总结或回答。技术流程</strong>：用户指令→ 模型识别需调用的函数→ 生成参数化调用指令→ 外部系统执行→ 返回结果至模型→ 生成用户响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27ecb8622774e31a9d55f343b2cf835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=IOrPuYT00cXNEtB76jxJ8puWxUs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：ailydoseofds</p>
<p>但不同的 API 需要封装成不同的方法，且参数确定后，后期变更困难，很难在不同的平台灵活复用。  而我们可以认为，MCP 是在 Function Calling 的基础上做了进一步的抽象，目的是让应用更加简单、高效、安全地对接外部资源，更好地为大模型补充上下文信息。总结起来就是，MCP 把大模型运行环境称作 MCP Client，也就是 MCP 客户端，同时，把外部函数运行环境称作 MCP Server，也就是 MCP 服务器，然后，统一 MCP 客户端和服务器的运行规范，并且要求 MCP 客户端和服务器之间，也统一按照某个既定的提示词模板进行通信。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59cb5bafe20c4e9789aec4cf53229b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=BDXwn2lvg1fRwAuCKYEQ2PK0Mxc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>MCP vs Function Calling 对比：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec37bae08374502b247877f4b91eced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=5xv0r5R54HDaJDRztnE1EGaFzoM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>综上，RAG与Function Calling 互补，前者用于知识检索，后者用于执行操作，二者均可提升模型实用性，但目标维度不同，且存在难集成，扩展性差的问题，开发者往往需为不同模型重复实现工具调用逻辑。</p>
<p><strong>MCP 则是对两者的整合与标准的规范化：</strong></p>
<ul>
<li><strong>标准化接口</strong>：MCP 为 RAG 的检索源接入（如数据库、文档库）和 Function Calling 的工具调用（如 API 服务）提供统一接入规范，避免为每个工具开发定制化适配。 比如 MCP 工具的inputSchema可定义多个参数，通过required标记必传参数。大模型在解析用户提问时，会根据工具的描述和参数定义，自动解析并提供相应参数值来调用工具。这种参数化设计方式提高了工具调用的灵活性，降低了 Function Calling 的开发复杂度。</li>
</ul>

<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">return</span> Tool(
    name=<span class="hljs-built_in">self</span>.name,
    description=<span class="hljs-built_in">self</span>.description,
    inputSchema={
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"host"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库主机地址"</span>},
            <span class="hljs-string">"port"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库端口"</span>},
            <span class="hljs-string">"user"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库用户名"</span>},
            <span class="hljs-string">"password"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库密码"</span>},
            <span class="hljs-string">"database"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库名称"</span>}
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"host"</span>, <span class="hljs-string">"port"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>, <span class="hljs-string">"database"</span>]
    }
)
</code></pre>
<ul>
<li><strong>能力扩展</strong>：</li>
<li>
<ul>
<li>RAG 通过 MCP 接入实时数据流（如证券行情），突破静态知识库限制；</li>
<li>Function Calling通过 MCP 调用异构工具（如 IoT 设备），无需依赖特定模型的支持。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>系统效率</strong>：MCP 降低开发复杂度（如开发者无需为不同模型重复实现工具调用逻辑），促进工具生态共享。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f6b876f522f42c6a42ea7fda515ca11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fwfts7tQjWrE4gncBcspiVDLKao%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>技术演进总结</strong>：</p>
<ul>
<li>RAG → Function Calling → MCP 代表了 AI 能力的三个重要维度：从静态知识检索到动态行动执行，再到标准化生态构建，标志着 AI 从知识增强到行动扩展再到生态标准化的发展趋势。</li>
<li>在 AI Agent 架构中：RAG 充当知识中枢，Function Calling 为执行手段，MCP 则是连接内外的“神经枢纽”。</li>
<li><strong>未来意义</strong>：MCP 的开放性将加速工具互操作性，推动复杂任务（如多 Agent 协作）的规模化落地，成为 AI 基础设施的关键组件。</li>
</ul>
<h2 data-id="heading-1">二、MCP 架构详解</h2>
<p>了解 MCP 存在的价值后，我们还需要定位 MCP 在整个 AI 体系中所处的位置，如以 Agent 为例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03f1b22573640d89fe8bab08ebeb377~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=JhtFb7mDb7CgmWyyAlDocaqbolU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>了解完其在生态中所处的位置后，本节将结合 Python 版 SDK 源码和开源 MCP for DB 项目解读如何运用 MCP 以此了解其架构原理及使用方法。MCP Python SDK 提供了一个分层架构，通过多种传输协议将 LLM 应用程序连接到 MCP 服务器，同时具有高级和低级开发 API。</p>
<p>参考项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEliot-Shen%2FMCP-DB-GPT" target="_blank" title="https://github.com/Eliot-Shen/MCP-DB-GPT" ref="nofollow noopener noreferrer">github.com/Eliot-Shen/…</a></p>
<p>Python SDK：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fpython-sdk" target="_blank" title="https://github.com/modelcontextprotocol/python-sdk" ref="nofollow noopener noreferrer">github.com/modelcontex…</a></p>
<h3 data-id="heading-2">2.1MCP运行过程</h3>
<p>在此之前，有必要对 MCP 整体运行有个宏观上的认知，如下图所示，首先，需用户在主机上配置 MCP 服务，比如借助 VSCode 插件 Cline，根据使用的协议配置好 JSON文件即可。然后，用户输入问题，客户端让大语言模型选择 MCP 工具，大模型选择好工具后，客户端寻求用户同意，然后再请求 MCP 服务器， MCP 服务器调用工具并将工具的结果返回给客户端，客户端将模型调用结果和用户的查询发送给大语言模型，大语言模型组织答案给用户。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb752df059f6441cad887e2257e6820b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=b7GUZlDlmC0DX8XCILVr4CseCZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>可见，整个流程中最核心的部分就是<strong>Client 和 Server的交互</strong>，而在使用像 Cline 这种主机端软件时，整体感知如下图，Client 已经被嵌在 MCP Host 中，只需开发出对应的 MCP Server，在主机中配置好 JSON即可使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9013370e13eb4d62a5c47895d684da5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=7oqjho3E1IUGnUW771YPC4guyoU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来将结合项目和 SDK 源码详细解读 MCP 架构原理。</p>
<h3 data-id="heading-3">2.2MCP运行原理</h3>
<p>MCP Server作为 MCP 架构的核心部分，在提升AI应用性能方面发挥着不可替代的关键作用。其 Python 版 SDK 提供的框架图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94d71e641dde4fc2b8087a79642f4e9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=InGZ%2FYZuwlRBZmpQucE3l21LfPc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>我们着重关注其提供的三大核心功能</strong>：资源@mcp.resource、工具@mcp.tool、提示词@mcp.prompt。而这三大核心功能之间的协作逻辑大致如下：</p>
<ul>
<li><strong>资源为工具提供上下文</strong>：手动注入资源可增强模型对任务的理解（如提供参考文档）辅助其更准确调用工具。</li>
<li><strong>工具执行依赖资源输入</strong>：当工具操作外部数据时，如文件处理工具，可将指定文件 URI 作为工具参数输入。</li>
<li><strong>提示词封装工具与资源调用</strong>：复杂 Prompt 可预设工具调用顺序或资源使用规则，形成自动化工作流。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 在工具中封装提示词模版存在的问题是该工具不一定能被LLM调用，导致不一定能达到预期效果，但使用cline这中客户端，服务端的提示词又不能被加载调用</span>
async def run_tool(self, arguments: Dict<span class="hljs-section">[str, Any]</span>) -&gt; Sequence<span class="hljs-section">[TextContent]</span>:
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
            - Workflow:
              1. 解析用户输入的自然语言指令，提取关键信息，如表描述和查询条件。
              2. 判断是否跨库查询、是否明确指定了目标表名（例如是中文的描述、英文的描述，偏向语义化的描述则判断为未明确表名）
              3. 未明确指定目标表名则调用“get_table_name”工具，获取对应的表名。
              4. 调用“get_table_desc”工具，获取表的结构信息。
              5. 根据表结构信息和用户输入的查询条件，生成SQL查询语句并调用“execute_sql”工具，返回查询结果。
            - Examples:
              - 例子1：用户输入“查询用户表张三的数据”
                解析结果：表描述为“用户表”，查询条件为“张三”。
                判断结果：1.没有出现跨库的情况 2.未明确指定表名，当前为表的描述，需调用工具获取表名
                调用工具“get_table_name”：根据“用户表”描述获取表名，假设返回表名为“user_table”。
                调用工具“get_table_desc”：根据“user_table”获取表结构，假设表结构包含字段“id”、“name”、“age”。
                生成SQL查询语句：`SELECT * FROM user_table WHERE name = '张三';`
                调用工具“execute_sql”：根据生成的SQL,获取结果。
                查询结果：返回张三的相关数据。
            - task: 
              - 调用工具“get_table_name”，
              - 调用工具“get_table_desc”，
              - 调用工具“execute_sql”
              - 以markdown格式返回执行结果
            """</span>
    
    return <span class="hljs-section">[TextContent(type="text", text=prompt)]</span>
</code></pre>
<p><strong>但出于安全考虑，大模型对资源/工具的访问能力受到限制：</strong></p>
<ul>
<li><strong>工具：支持自主调用</strong>。大模型通过解析服务端公开的工具描述，能主动发起工具调用请求 ，无需用户逐条指令干预。此能力依赖模型的 Function Calling 支持，否则需通过提示词工程实现。</li>
<li><strong>资源：禁止自主访问</strong>。资源始终由应用层或用户管控 ，模型仅能使用已注入的资源内容。避免模型随意访问敏感数据，保障安全性。</li>
</ul>
<p><strong>资源（Resources）</strong></p>
<p>资源是指由 MCP Server 向客户端提供的数据实体，这些实体作为统一的信息载体，旨在扩展 AI 模型的数据访问边界，并支撑其对动态、结构化与非结构化数据的实时处理能力。<strong>类似于 REST API中的 GET 端点</strong>——提供数据，但不应执行大量计算或产生副作用。</p>
<p>资源代表任何可供 AI 模型读取的数据形式，是你向LLM 暴露数据的方式，涵盖：</p>
<ul>
<li><strong>文件内容</strong>：包括文本文件、JSON、XML 等结构化文档，以及源代码、配置文件等文本数据（UTF-8 编码）。</li>
<li><strong>数据库记录</strong>：关系型或非关系型数据库查询结果（e.g. PostgreSQL或MySQL）。</li>
<li><strong>动态系统数据</strong>：包括实时日志、屏幕截图、多媒体（图像、视频）、传感器输出等二进制数据。</li>
</ul>
<p><strong>如 MCP-DB-GPT 项目中定义的访问本地 JSON 格式的日志数据资源接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.resource(<span class="hljs-params"><span class="hljs-string">"logs://{session_id}/{limit}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_query_logs</span>(<span class="hljs-params">limit: <span class="hljs-built_in">str</span> = <span class="hljs-string">"5"</span>, session_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">"anonymous"</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""获取查询日志
    
    Args:
        limit: 可选参数，指定返回的日志数量，默认为5
        session_id: 可选参数，指定要获取的会话ID
    """</span>
    <span class="hljs-keyword">try</span>:
        limit_val = <span class="hljs-built_in">int</span>(limit)
        <span class="hljs-keyword">if</span> limit_val &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-string">"Limit must be a positive integer"</span>}
        
        logs = query_logger.get_logs(session_id=session_id, limit=limit_val)
        total = query_logger.total_query_count(session_id=session_id)
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"logs"</span>: logs, <span class="hljs-string">"total_queries"</span>: total}
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}
</code></pre>
<ul>
<li><strong>装饰器中资源类型以统一资源标识符（URI）为唯一寻址机制</strong>，格式为[协议]://[主机]/[路径]（如 file://home/user/report.pdf 或 postgres://database/customers/schema）。此设计允许资源协议、主机与路径的灵活定制，支持跨本地与远程环境的无缝集成。</li>
</ul>
<p><strong>通过整合多模态数据（文本与二进制）资源使 AI 模型能访问私有或专属知识库（如企业内部文档）、实时外部 API 及系统动态信息，有效突破单一大模型数据孤岛。</strong></p>
<p><strong>工具（Tools）</strong></p>
<p>工具是服务器向客户端暴露的可执行函数集合，用于拓展大型语言模型（LLM）的操作能力，使其突破纯文本生成的局限，实现对外部系统的主动交互。<strong>其本质就是函数抽象</strong>，通过JSON Schema 严格定义输入/输出参数结构（如天气查询需输入位置参数，输出结构化天气数据）。</p>
<p><strong>如 MCP-DB-GPT 项目中定义的只读 SQL 查询工具接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_data</span>(<span class="hljs-params">sql: <span class="hljs-built_in">str</span>, session_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">"anonymous"</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""Execute read-only SQL queries"""</span>
    logger.info(<span class="hljs-string">f"Executing query: <span class="hljs-subst">{sql}</span>"</span>)
    conn = get_connection()
    cursor = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Create dictionary cursor</span>
        cursor = conn.cursor(pymysql.cursors.DictCursor)
        
        <span class="hljs-comment"># Start read-only transaction</span>
        cursor.execute(<span class="hljs-string">"SET TRANSACTION READ ONLY"</span>)
        cursor.execute(<span class="hljs-string">"START TRANSACTION"</span>)
        
        <span class="hljs-keyword">try</span>:
            cursor.execute(sql)
            results = cursor.fetchall()
            conn.commit()
            
            <span class="hljs-comment"># 记录成功查询</span>
            log_query(operation=sql, success=<span class="hljs-literal">True</span>, session_id=session_id)
            
            <span class="hljs-comment"># Convert results to serializable format</span>
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"results"</span>: results,
                <span class="hljs-string">"rowCount"</span>: <span class="hljs-built_in">len</span>(results)
            }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            conn.rollback()
            log_query(operation=sql, success=<span class="hljs-literal">False</span>, error=<span class="hljs-built_in">str</span>(e), session_id=session_id)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)
            }
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">if</span> cursor:
            cursor.close()
        conn.close()
</code></pre>
<p>客户端通过标准协议接口（tools/list发现工具、tools/call 调用工具）与服务器交互，形成机器可读的自动化操作链路。<strong>其安全控制机制采用 “模型控制 + 人类监督” 双轨制：</strong></p>
<ul>
<li>LLM 自主决定工具调用的必要性（如识别用户请求中的查询数据库表信息意图）；</li>
<li>每次执行需用户显式授权（如弹出确认框），确保数据隐私与操作合规。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29b0c8dcc03e43eb906fc79577185c3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=dI6UP%2Bd9qxOLZvazhAwqjWQ7a8E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>提示词（Prompts）</strong></p>
<p>提示词是服务器端预定义的可重用交互模板，用于标准化和引导大型语言模型（LLM）的任务执行。这些模板通过<strong>动态参数化设计</strong>，允许传入特定值（如任务变量或上下文数据）生成定制化指令，从而实现高效、一致的模型交互。其核心机制如下：</p>
<ul>
<li><strong>结构化要素</strong>：每个提示模板包含唯一标识符、任务描述、参数列表（如输入变量）以及可选的资源引用（如外部文件或API数据）。这种结构确保指令的明确性和可扩展性，减少模型输出歧义。例如，在文本生成任务中，模板可能定义输出格式要求（如字数限制或响应风格），并动态整合用户输入数据。</li>
<li><strong>上下文引导</strong>：提示词嵌入上下文关联机制（如历史对话片段或外部资源引用），帮助模型理解任务背景。例如，在问答场景中，模板可引入相关数据源（如知识库），提升响应准确性和相关性。</li>
<li><strong>工作流支持</strong>：支持链式交互设计，允许多个提示模板组合以处理复杂任务（如多步骤分析或迭代优化）。同时，模板常作为用户界面元素（如斜杠命令）集成，增强可用性。</li>
<li>⚠️：提示词模版需要与客户端联动，即服务端定义好之后，在与客户端交互时，客户端获取服务器端动态填充好的提示词模版再发给大模型，大模型按照提示词要求进行回答。<strong>如果嵌在工具中触发条件往往是被动的</strong>。</li>
</ul>
<p><strong>如MCP-DB-GPT 项目中服务端定义好的提示词接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.prompt()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_db_gpt_prompt</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Generate a prompt for LLM to interact with database."""</span>
    <span class="hljs-comment"># 获取数据库表列表</span>
    tables_info = get_tables()
    database_name = tables_info[<span class="hljs-string">"database"</span>]
    tables = tables_info[<span class="hljs-string">"tables"</span>]
    
    <span class="hljs-comment"># 获取所有表的描述信息</span>
    table_definitions = []
    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
        table_desc = get_table_description(table)
        <span class="hljs-keyword">if</span> table_desc.get(<span class="hljs-string">"success"</span>):
            table_definitions.append(table_desc[<span class="hljs-string">"table_definition"</span>])
    <span class="hljs-keyword">return</span> DB_GPT_SYSTEM_PROMPT.<span class="hljs-built_in">format</span>(
        database_name=database_name,
        table_definitions=<span class="hljs-string">"\n"</span>.join(table_definitions),
    )
</code></pre>
<p>DB_GPT_SYSTEM_PROMPT 即是预先编写好的提示词模板，当你动态的获取参数后进行替换即可。一个简易的提示词模板如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Baseline_SYSTEM_PROMPT</span> = <span class="hljs-string">"""
请根据用户选择的数据库和该库的所有可用表结构定义来回答用户问题.
数据库名:
    {database_name}
表结构定义:
    {table_definitions}


约束:
    1. 请根据用户问题理解用户意图，使用给出表结构定义创建一个语法正确的mysql sql。
    2. 将查询限制为最多10000个结果。
    3. 只能使用表结构信息中提供的表来生成 sql。
    4. 请检查SQL的正确性。
    5. 分析基于现有表结构和元数据信息，估算用户提供的 DQL 语句的索引推荐策略,并返回给用户explain执行结果


用户问题:
    {user_question}


请按照以下JSON格式回复：
{{
    "thoughts": "分析思路",
    "sql": "SQL查询语句",
    "explain": "优化后的DQL语句执行结果"
}}
"""</span>
</code></pre>
<p>然后客户端建立通信连接后获取相关的资源、工具和提示词模版：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-comment"># methods will go here</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_server</span>(<span class="hljs-params">self, server_script_path: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""Connect to an MCP server
        
        Args:
            server_script_path: Path to the server script (.py or .js)
        """</span>
        <span class="hljs-comment"># try:</span>
        is_python = server_script_path.endswith(<span class="hljs-string">'.py'</span>)
        is_js = server_script_path.endswith(<span class="hljs-string">'.js'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (is_python <span class="hljs-keyword">or</span> is_js):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Server script must be a .py or .js file"</span>)
        
        command = <span class="hljs-string">"python"</span> <span class="hljs-keyword">if</span> is_python <span class="hljs-keyword">else</span> <span class="hljs-string">"node"</span>
        server_params = StdioServerParameters(
            command=command,
            args=[server_script_path],
            env=<span class="hljs-literal">None</span>
        )
        stdio_transport = <span class="hljs-keyword">await</span> self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = <span class="hljs-keyword">await</span> self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))
        <span class="hljs-keyword">await</span> self.session.initialize()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Session_id: <span class="hljs-subst">{self.session_id}</span>"</span>)
        
        <span class="hljs-comment"># List available tools</span>
        response = <span class="hljs-keyword">await</span> self.session.list_tools()
        tools = response.tools
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nConnected to server with tools:"</span>, [tool.name <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools])
        
        <span class="hljs-comment"># List available resources</span>
        resources_response = <span class="hljs-keyword">await</span> self.session.list_resources()
        <span class="hljs-keyword">if</span> resources_response <span class="hljs-keyword">and</span> resources_response.resources:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available resources:"</span>, [resource.uri <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> resources_response.resources])
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available resources templates: ['logs']"</span>)


        prompts = <span class="hljs-keyword">await</span> self.session.list_prompts()
        <span class="hljs-keyword">if</span> prompts <span class="hljs-keyword">and</span> prompts.prompts:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available prompts:"</span>, [prompt.name <span class="hljs-keyword">for</span> prompt <span class="hljs-keyword">in</span> prompts.prompts])
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"No available prompts found."</span>)
</code></pre>
<p><strong>MCP Client</strong></p>
<p>MCP Client 在整个模型交互过程中则起着至关重要的桥梁作用，连接着 LLM 与 MCP Server。其Python版 SDK 提供的框架图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe301a6e62f546e59ec19f92b2be6b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=kGn7fMjngzWsTYelfewwR48QOmQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>此处，我们先不看他的通信机制，结合 MCP-DB-GPT 项目仅关注 ClientSession 是如何与服务器层交互的。从宏观上看，客户端与服务器端的消息流大致如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4e561364b142b4be20a9632cf40714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=AaP6H8LbbUF5ibw7n75dhLQ%2BSSQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>而在 MCP-DB-GPT项目中定义了一个集成阿里通义千问大模型接口的 MCPClient类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># Initialize session and client objects</span>
        self.session: <span class="hljs-type">Optional</span>[ClientSession] = <span class="hljs-literal">None</span>
        self.exit_stack = AsyncExitStack()
        self.llm = TongYiAPI()
        self.session_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        self.use_few_shot = <span class="hljs-literal">True</span>
        self.conversation_history = FEW_SHOT_EXAMPLES <span class="hljs-keyword">if</span> self.use_few_shot <span class="hljs-keyword">else</span> []
    
    <span class="hljs-comment"># methods will go here</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_server</span>(<span class="hljs-params">self, server_script_path: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""Connect to an MCP server
    
    async def get_query_logs(self, limit: int = 5) -&gt; str:
        """</span>获取查询日志<span class="hljs-string">"""
    
    async def get_schema(self, table_names: Optional[List[str]] = None) -&gt; str:
        """</span>获取数据库结构信息<span class="hljs-string">"""


    async def process_query(self, query: str) -&gt; str:
        """</span>使用通义千问处理数据库相关查询<span class="hljs-string">"""
</span></code></pre>
<p>客户端就是通过ClientSession对象与服务器交互，主要包括初始化连接、工具调用和资源访问：</p>
<ul>
<li><strong>连接建立</strong>：</li>
<li>
<ul>
<li>在connect_to_server方法中，客户端基于服务器脚本路径（如 Python 或 Node.js 脚本）初始化StdioServerParameters。</li>
<li>使用stdio_client建立标准输入输出（Stdio）传输通道，创建ClientSession对象。调用session.initialize()初始会话，生成唯一会话 ID（session_id），用于加密通信和日志跟踪。</li>
<li>随后通过session.list_tools()获取可用工具列表（如query_data、get_schema），并通过session.list_resources()列出可访问资源（如日志）。此阶段实现协议中的“工具发现”阶段，确保客户端了解服务器功能。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>工具调用过程</strong>：</li>
<li>
<ul>
<li>当执行具体操作时（如执行 SQL 或获取 Schema），客户端使用session.call_tool(tool_name, params)方法发送 JSON-RPC 请求。 </li>
<li>
<ul>
<li><strong>请求结构</strong>：以get_schema为例，参数包括session_id和可选table_names，序列化为 JSON 格式。</li>
<li><strong>服务器响应</strong>：服务器执行工具（如查询数据库结构），返回JSON-RPC响应。响应包含content字段（如数据库结构信息），客户端解析 JSON 以提取结果。</li>
</ul>
</li>
<li><strong>错误处理</strong>：若响应包含success: false或error字段（如无法获取Schema），客户端返回错误信息。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>资源访问机制</strong>：</li>
<li>
<ul>
<li>通过session.read_resource(uri)访问资源（如日志）。日志 URI 格式为logs://{session_id}/{limit}，服务器返回结构化的日志数据（JSON 格式）。</li>
<li><strong>安全性</strong>：所有交互依赖会话级加密（session_id），并通过权限验证（用户需显式授权敏感操作）。</li>
</ul>
</li>
</ul>
<p><strong>典型案例运用</strong></p>
<p>MCP-DB-GPT 项目的一大亮点在于，其实现了结合提示词后，如何借助大模型解析自然语言生成 SQL 语句再与服务器进行交互并返回查询结果的完整过程。该功能能让初学者一步感知到 MCP 的工作流程以及它的灵活与强大。</p>
<p><strong>通过LLM解析自然语言生成SQL语句的流程</strong>：在process_query方法中，LLM（通义千问 API）用于生成结构化工具调用（如 SQL 语句）。核心代码实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""使用通义千问处理数据库相关查询"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 调用服务器层的提示词方法</span>
        prompt = <span class="hljs-keyword">await</span> self.session.get_prompt(<span class="hljs-string">"generate_db_gpt_prompt"</span>)
        prompt = prompt.messages[<span class="hljs-number">0</span>].content.text
        <span class="hljs-comment"># 将封装好的提示词投喂给大模型</span>
        llm_response = self.llm.chat(system_prompt=prompt, content=query, response_format=<span class="hljs-string">"json_object"</span>,
                                     conversation_history=self.conversation_history)
        response_data = json.loads(llm_response)
</code></pre>
<ul>
<li>客户端通过session.get_prompt("generate_db_gpt_prompt")获取预定义提示模板（prompt），该模板描述可用工具（如query_data）和任务规范，优化 LLM 对查询的理解和工具的调用。</li>
<li><strong>LLM 基于提示和对话历史，执行“意图解析”</strong> ：</li>
<li>
<ul>
<li>分析自然语言，匹配工具（如自动选择query_data工具）。</li>
<li>输出 JSON 包含sql字段（生成的 SQL 语句）、direct_response（当无需 SQL）或thoughts（推理过程）。</li>
<li>示例：查询“金额最高的订单”可能生成"sql": "SELECT * FROM orders ORDER BY amount DESC LIMIT 1"。</li>
</ul>
</li>
<li><strong>对话更新</strong>：用户查询和 LLM 响应添加到conversation_history，保持上下文一致性。</li>
</ul>
<p><strong>生成 SQL 后与服务器层的二次交互</strong>：在process_query中，如果 LLM 响应包含sql字段（如"sql":"SELECT * FROM users"），客户端自动调用session.call_tool("query_data", params)。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 如果有SQL查询，执行它</span>
<span class="hljs-keyword">if</span> response_data.get(<span class="hljs-string">"sql"</span>):
    <span class="hljs-comment"># 执行SQL查询</span>
    query_result = <span class="hljs-keyword">await</span> self.session.call_tool(<span class="hljs-string">"query_data"</span>, {
        <span class="hljs-string">"sql"</span>: response_data[<span class="hljs-string">"sql"</span>],
        <span class="hljs-string">"session_id"</span>: self.session_id
    })
    <span class="hljs-comment"># 构建最终响应</span>
    final_response = {
        <span class="hljs-string">"thoughts"</span>: response_data[<span class="hljs-string">"thoughts"</span>],
        <span class="hljs-string">"sql"</span>: response_data[<span class="hljs-string">"sql"</span>],
        <span class="hljs-string">"display_type"</span>: response_data.get(<span class="hljs-string">"display_type"</span>, <span class="hljs-string">"Table"</span>),
        <span class="hljs-string">"results"</span>: json.loads(query_result.content[<span class="hljs-number">0</span>].text) <span class="hljs-keyword">if</span> query_result.content[<span class="hljs-number">0</span>].text <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
    }
    
    <span class="hljs-keyword">return</span> json.dumps(final_response, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
</code></pre>
<ul>
<li>所有查询（包括 LLM 生成的 SQL）通过write_resource记录到日志资源，URI 为logs://{session_id}/{limit}，支持后续审计。</li>
</ul>
<p><strong>此交互完成 MCP 的“执行-响应”闭环：SQL 作为工具调用的参数，服务器执行后返回结构化数据，客户端整合为最终响应。</strong></p>
<h2 data-id="heading-4">三、底层通信原理</h2>
<h3 data-id="heading-5">3.1协议层：JSON-RPC 2.0基础</h3>
<p>MCP 的核心消息格式采用 JSON-RPC 2.0 协议，这是一个轻量级的 RPC 框架，用于结构化请求、响应和通知。在 Python SDK 中：</p>
<ul>
<li><strong>消息结构</strong>：每条消息都是 JSON 对象，包含 method（方法名，如 tool_execute）、params（参数）和 id（请求 ID）。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSONRPCRequest</span>(Request[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>, <span class="hljs-built_in">str</span>]):
    <span class="hljs-string">"""A request that expects a response."""</span>
    jsonrpc: <span class="hljs-type">Literal</span>[<span class="hljs-string">"2.0"</span>]
    <span class="hljs-built_in">id</span>: RequestId
    method: <span class="hljs-built_in">str</span>
    params: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
</code></pre>
<ul>
<li><strong>交互类型</strong>：</li>
<li>
<ul>
<li>请求（JSONRPCRequest） ：客户端（如 AI 应用）发送操作指令（如执行工具）。</li>
<li>响应（JSONRPCResponse） ：服务器返回结果。</li>
<li>错误响应（JSONRPCError）：服务器返回错误信息。</li>
<li>通知（JSONRPCNotification） ：用于异步事件（如服务器主动推送上下文更新），无需响应。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>优势</strong>：JSON-RPC 2.0 的标准化确保跨平台兼容性，源码中通过 JsonRPCRequest和JsonRPCResponse 类实现解析和验证，减少消息解析开销。如在 STDIO 传输中，消息的序列化和反序列化过程如下：</li>
</ul>
<p><strong>发送消息时</strong>：消息被序列化为 JSON 并添加换行符。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> write_stream_reader:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> session_message <span class="hljs-keyword">in</span> write_stream_reader:
            json = session_message.message.model_dump_json(by_alias=<span class="hljs-literal">True</span>, exclude_none=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">await</span> process.stdin.send(
                (json + <span class="hljs-string">"\n"</span>).encode(
                    encoding=server.encoding,
                    errors=server.encoding_error_handler,
                )
            )
<span class="hljs-keyword">except</span> anyio.ClosedResourceError:
    <span class="hljs-keyword">await</span> anyio.lowlevel.checkpoint()
</code></pre>
<p><strong>接收消息时</strong>：从输入流读取行，解析为JSON-RPC消息 。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    message = types.JSONRPCMessage.model_validate_json(line)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
    <span class="hljs-keyword">await</span> read_stream_writer.send(exc)
    <span class="hljs-keyword">continue</span>


session_message = SessionMessage(message)
<span class="hljs-keyword">await</span> read_stream_writer.send(session_message)
</code></pre>
<h3 data-id="heading-6">3.2传输层：双向通信实现</h3>
<p>MCP Python SDK 提供了多种传输机制，每种机制都针对不同的部署场景和通信模式进行了优化。所有传输机制都抽象为一个基于流的通用接口，同时支持特定于协议的功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18278ce7850a4df0910a8a34573852b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Yxs3GvFFNbluVWIqwcAj3ZucujQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>Stdio传输</strong></p>
<p>通过标准输入/输出（stdin/stdout）流进行同步或异步通信。源码中读取和写入流由如下函数实现：</p>
<ul>
<li><strong>读取流</strong>：MemoryObjectReceiveStream[SessionMessage | Exception]-从服务器标准输出接收消息</li>
<li><strong>写入流</strong>：MemoryObjectSendStream[SessionMessage]- 将消息发送到服务器标准输入</li>
</ul>
<p><strong>其适用于本地进程间通信（如 IDE 插件），低延迟但仅限单机。</strong> 关键代码包括stdin_reader()和stdout_writer方法，负责后台处理双向通信。<strong>其通信流程大致为以下七步</strong>：</p>
<ol>
<li>客户端以子进程的方式启动服务器</li>
<li>客户端往服务器的 stdin 写入消息</li>
<li>服务器从自身的 stdin 读取消息</li>
<li>服务端往自身的 stdout 写入消息</li>
<li>客户端从服务器的 stdout 读取消息</li>
<li>客户端终止子进程，关闭服务器的 stdin</li>
<li>服务器关闭自身的 stdout</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f613241f67b64e839f79f78785ba82c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=qKCcegowaJOiuJBGki3AacYWAs0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>⚠️⚠️⚠️：<strong>当客户端调用mcp.tool() 装饰的函数时，SDK 内部封装请求为 JSON-RPC，通过 stdio 发送给服务器进程，服务端通过装饰器装饰的函数在建立连接后被调用时，会自动进行注入并转换成 JSON格式的数据与客户端进行自动交互。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/699be87066ba4ae682db893131642374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=JcwFyrtnIzFRmzkUUfqwdLgQTSc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>服务端代码参考：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_stdio</span>():
    <span class="hljs-string">"""运行标准输入输出模式的服务器
    
    使用标准输入输出流(stdio)运行服务器，主要用于命令行交互模式
    
    Raises:
        Exception: 当服务器运行出错时抛出异常
    """</span>
    <span class="hljs-keyword">from</span> mcp.server.stdio <span class="hljs-keyword">import</span> stdio_server
    
    logger.info(<span class="hljs-string">"启动标准输入输出(stdio)模式服务器"</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 初始化资源</span>
        <span class="hljs-keyword">await</span> initialize_global_resources()
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_server() <span class="hljs-keyword">as</span> (read_stream, write_stream):
            <span class="hljs-keyword">try</span>:
                logger.debug(<span class="hljs-string">"初始化流式传输接口"</span>)
                <span class="hljs-keyword">await</span> app.run(
                    read_stream,
                    write_stream,
                    app.create_initialization_options()
                )
                logger.info(<span class="hljs-string">"标准输入输出模式服务结束"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.critical(<span class="hljs-string">f"标准输入输出模式服务器错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                logger.exception(<span class="hljs-string">"服务异常终止"</span>)
                <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 关闭资源</span>
        <span class="hljs-keyword">await</span> close_global_resources()
</code></pre>
<p><strong>Main 函数中调用：</strong></p>
<pre><code class="hljs language-css" lang="css">try:
    if mode == <span class="hljs-string">"stdio"</span>:
        asyncio.<span class="hljs-built_in">run</span>(<span class="hljs-built_in">run_stdio</span>())
</code></pre>
<p><strong>配置 Cline 的JSON文件即可访问：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mcp_db"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"--directory"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/Users/admin/Downloads/Codes/MCP/mcp_for_db/src/"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"server.mcp.server_mysql"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--mode"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"stdio"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"MYSQL_HOST"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"localhost"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_PORT"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3306"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_USER"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"root"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_PASSWORD"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"password"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_DATABASE"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp_db"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_ROLE"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"PYTHONPATH"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/admin/Downloads/Codes/MCP/MCP-DB/"</span>
      <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>SSE 传输</strong></p>
<p>SSE 传输使用服务器发送事件 (SSE) 传输服务器到客户端的消息，并使用 HTTP POST 请求传输客户端到服务器的消息，提供基于 HTTP 的通信。其本质是双向模拟，即 SSE 本质为单向，SDK 通过“请求/响应”对模拟双向通信（客户端发送 HTTP POST 请求携带JSON-RPC，服务器返回 SSE 流）。其通信流程也可概括为七步：</p>
<ol>
<li>客户端向服务器的 /sse 端点发送请求（一般是 GET 请求），建立 SSE 连接；</li>
<li>服务器给客户端返回一个包含消息端点地址的事件消息；</li>
<li>客户端给消息端点发送消息；</li>
<li>服务器给客户端响应消息已接收状态码；</li>
<li>服务器给双方建立的 SSE 连接推送事件消息；</li>
<li>客户端从 SSE 连接读取服务器发送的事件消息；</li>
<li>客户端关闭 SSE 连接。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e93fb80a910e4cdabb1f6c1bd3d95938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=mpBSd0tWXQcjHBzRJ3WvA4%2BJ6to%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>服务器端</strong>：SseServerTransport为服务器端 SSE 传输实现提供了两个主要的 ASGI 应用程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b831d81cec6d4d4e81d44555874bb264~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=nYwNrpa0iwp%2F22Vr929kkbKTXP4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>客户端</strong>：sse_client函数提供客户端 SSE 传输实现。</p>
<p><strong>二者通信的消息格式如下</strong>：每条 SSE 消息以 data: 前缀携带 JSON-RPC 负载，客户端监听事件流。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务端</span>
logger.debug(<span class="hljs-string">"Starting SSE writer"</span>)
<span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> sse_stream_writer, write_stream_reader:
    <span class="hljs-keyword">await</span> sse_stream_writer.send({<span class="hljs-string">"event"</span>: <span class="hljs-string">"endpoint"</span>, <span class="hljs-string">"data"</span>: client_post_uri_data})
    logger.debug(<span class="hljs-string">f"Sent endpoint event: <span class="hljs-subst">{client_post_uri_data}</span>"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> session_message <span class="hljs-keyword">in</span> write_stream_reader:
        logger.debug(<span class="hljs-string">f"Sending message via SSE: <span class="hljs-subst">{session_message}</span>"</span>)
        <span class="hljs-keyword">await</span> sse_stream_writer.send(
            {
                <span class="hljs-string">"event"</span>: <span class="hljs-string">"message"</span>,
                <span class="hljs-string">"data"</span>: session_message.message.model_dump_json(by_alias=<span class="hljs-literal">True</span>, exclude_none=<span class="hljs-literal">True</span>),
            }
        )
</code></pre>
<p><strong>其中涉及两种主要事件类型：</strong></p>
<ul>
<li><strong>endpoint事件</strong>：在连接建立时发送，告知客户端 POST 消息的端点 URL。</li>
<li><strong>message事件</strong>：传输实际的 JSON-RPC 消息。</li>
</ul>
<p><strong>客户端通过 sse_reader 函数处理接收到的 SSE 事件：</strong></p>
<ul>
<li><strong>endpoint事件处理</strong>：验证端点 URL 的安全性，确保与连接源匹配。</li>
</ul>

<pre><code class="hljs language-css" lang="css">match sse<span class="hljs-selector-class">.event</span>:
    case <span class="hljs-string">"endpoint"</span>:
        endpoint_url = <span class="hljs-built_in">urljoin</span>(url, sse.data)
        logger.<span class="hljs-built_in">debug</span>(f<span class="hljs-string">"Received endpoint URL: {endpoint_url}"</span>)
        
        url_parsed = <span class="hljs-built_in">urlparse</span>(url)
        endpoint_parsed = <span class="hljs-built_in">urlparse</span>(endpoint_url)
        if (
            url_parsed.netloc != endpoint_parsed.netloc
            or url_parsed.scheme != endpoint_parsed.scheme
        ):
            error_msg = (
                <span class="hljs-string">"Endpoint origin does not match "</span> f<span class="hljs-string">"connection origin: {endpoint_url}"</span>
            )
            logger.<span class="hljs-built_in">error</span>(error_msg)
            raise <span class="hljs-built_in">ValueError</span>(error_msg)
        
        task_status.<span class="hljs-built_in">started</span>(endpoint_url)
</code></pre>
<ul>
<li><strong>message事件处理</strong>：解析 JSON-RPC 消息并转换为 SessionMessage。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">case</span> <span class="hljs-string">"message"</span>:
    <span class="hljs-keyword">try</span>:
        message = types.JSONRPCMessage.model_validate_json(  <span class="hljs-comment"># noqa: E501</span>
            sse.data
        )
        logger.debug(<span class="hljs-string">f"Received server message: <span class="hljs-subst">{message}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
        logger.error(<span class="hljs-string">f"Error parsing server message: <span class="hljs-subst">{exc}</span>"</span>)
        <span class="hljs-keyword">await</span> read_stream_writer.send(exc)
        <span class="hljs-keyword">continue</span>
    
    session_message = SessionMessage(message)
    <span class="hljs-keyword">await</span> read_stream_writer.send(session_message)
</code></pre>
<p><strong>适用场景</strong>：远程或云端部署，支持高并发和实时更新（如工具调用的结果推送）。错误处理包括连接超时重试（源码中 retry 机制）。</p>
<p><strong>服务端代码参考</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_sse</span>():
    <span class="hljs-string">"""运行SSE(Server-Sent Events)模式的服务器
    
    启动一个支持SSE的Web服务器，允许客户端通过HTTP长连接接收服务器推送的消息
    服务器默认监听0.0.0.0:9000
    """</span>
    logger.info(<span class="hljs-string">"启动SSE(Server-Sent Events)模式服务器"</span>)
    sse = SseServerTransport(<span class="hljs-string">"/messages/"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_sse</span>(<span class="hljs-params">request</span>):
        <span class="hljs-string">"""处理SSE连接请求
        
        Args:
            request: HTTP请求对象
        """</span>
        logger.info(<span class="hljs-string">f"新的SSE连接 [client=<span class="hljs-subst">{request.client}</span>]"</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> sse.connect_sse(
                request.scope, request.receive, request.send
        ) <span class="hljs-keyword">as</span> streams:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">await</span> app.run(streams[<span class="hljs-number">0</span>], streams[<span class="hljs-number">1</span>], app.create_initialization_options())
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.error(<span class="hljs-string">f"SSE连接处理异常: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                <span class="hljs-keyword">raise</span>
        logger.info(<span class="hljs-string">f"SSE连接断开 [client=<span class="hljs-subst">{request.client}</span>]"</span>)
        <span class="hljs-keyword">return</span> Response(status_code=<span class="hljs-number">204</span>)
    
    @contextlib.asynccontextmanager
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: Starlette</span>) -&gt; AsyncIterator[<span class="hljs-literal">None</span>]:
        <span class="hljs-string">"""SSE应用的生命周期管理"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 初始化资源</span>
            <span class="hljs-keyword">await</span> initialize_global_resources()
            <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># 关闭资源</span>
            <span class="hljs-keyword">await</span> close_global_resources()
    
    starlette_app = Starlette(
        debug=<span class="hljs-literal">True</span>,
        routes=[
            Route(<span class="hljs-string">"/sse"</span>, endpoint=handle_sse),
            Mount(<span class="hljs-string">"/messages/"</span>, app=sse.handle_post_message)
        ],
        lifespan=lifespan
    )
    
    logger.info(<span class="hljs-string">"SSE服务器启动中 [host=0.0.0.0, port=9000]"</span>)
    <span class="hljs-comment"># 创建配置并运行</span>
    config = uvicorn.Config(
        app=starlette_app,
        host=<span class="hljs-string">"0.0.0.0"</span>,
        port=<span class="hljs-number">9000</span>,
        loop=<span class="hljs-string">"asyncio"</span>,
        log_config=<span class="hljs-literal">None</span>  <span class="hljs-comment"># 禁用uvicorn默认日志配置</span>
    )
    
    server = uvicorn.Server(config)
    server.run()
</code></pre>
<p><strong>Main函数中调用</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">try:
    if <span class="hljs-attr">mode</span> == <span class="hljs-string">"sse"</span>:
        run_sse()
</code></pre>
<p><strong>配置 Cline 的 JSON文件即可访问：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mysql_mcp_server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sse"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:9000/sse"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-7">3.3通信工作流程</h3>
<p>MCP通信遵循 JSON-RPC 2.0模式，主要包含三个消息类别：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15cc40200832463294bb9305e8877ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=6srulcbfkV3b7%2FvzWo3yaI%2BBQW4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>同时，理解 MCP 连接生命周期可以帮助我们更好地开发 MCP 服务器和 AI 应用。MCP 连接生命周期跟 TCP 的三次握手、四次挥手有点类似，也要经历建立连接、交换消息、断开连接等阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa1a26d463440ae9583b47c283ecd3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=ImgXpfMxLIGbDvuYHFY8jbD2HAs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来，以 StreamableHTTP 机制为例，分析通信工作流程。StreamableHTTP 传输机制实现了基于 HTTP 的双向通信，结合了 HTTP POST 请求和 Server-Sent Events (SSE) 流来提供完整的客户端-服务器通信解决方案。</p>
<p><strong>整体架构流程</strong></p>
<p>StreamableHTTP 通信机制包含会话管理、双向消息传输和可选的事件重放功能：</p>
<ul>
<li>客户端传输初始化</li>
<li>
<ul>
<li>客户端通过 streamablehttp_client 函数建立连接。</li>
<li>核心组件 StreamableHTTPTransport 负责管理会话状态和消息路由。</li>
<li/>
</ul>
</li>
<li>服务器端会话管理</li>
<li>
<ul>
<li>服务器端使用 StreamableHTTPSessionManager 管理多个并发会话。支持有状态和无状态两种模式：</li>
<li><strong>有状态模式</strong>：维护会话状态，支持连接恢复。</li>
<li><strong>无状态模式</strong>：每个请求创建新的传输实例。</li>
</ul>
</li>
</ul>
<p><strong>通信工作流程详解</strong></p>
<p><strong>初始化和会话建立</strong></p>
<ul>
<li>初始化请求：客户端发送 initialize 方法的 POST 请求。</li>
<li>会话 ID 分配：服务器生成唯一会话 ID 并通过 mcp-session-id 头返回。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_maybe_extract_session_id_from_response</span>(<span class="hljs-params">
    self,
    response: httpx.Response,
</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Extract and store session ID from response headers."""</span>
    new_session_id = response.headers.get(MCP_SESSION_ID)
    <span class="hljs-keyword">if</span> new_session_id:
        self.session_id = new_session_id
        logger.info(<span class="hljs-string">f"Received session ID: <span class="hljs-subst">{self.session_id}</span>"</span>)
</code></pre>
<p><strong>双向消息传输</strong></p>
<p>客户端到服务器（POST 请求）：客户端的post_writer 方法处理出站消息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">post_writer</span>(<span class="hljs-params">
    self,
    client: httpx.AsyncClient,
    write_stream_reader: StreamReader,
    read_stream_writer: StreamWriter,
    write_stream: MemoryObjectSendStream[SessionMessage],
    start_get_stream: <span class="hljs-type">Callable</span>[[], <span class="hljs-literal">None</span>],
    tg: TaskGroup,
</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Handle writing requests to the server."""</span>
</code></pre>
<ul>
<li><strong>消息序列化</strong>：将 JSON-RPC 消息序列化为 HTTP POST 请求体。</li>
<li><strong>请求处理</strong>：根据消息类型选择处理方式 - 普通请求或恢复请求。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_request_async</span>():
    <span class="hljs-keyword">if</span> is_resumption:
        <span class="hljs-keyword">await</span> self._handle_resumption_request(ctx)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">await</span> self._handle_post_request(ctx)
<span class="hljs-comment"># If this is a request, start a new task to handle it</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(message.root, JSONRPCRequest):
    tg.start_soon(handle_request_async)
<span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">await</span> handle_request_async()
</code></pre>
<ul>
<li><strong>响应处理</strong>：支持 JSON 响应和 SSE 流响应两种模式。</li>
</ul>
<p><strong>服务器到客户端（SSE 流）</strong></p>
<p>服务器端通过不同的 HTTP 方法处理消息：</p>
<ul>
<li><strong>POST 请求处理</strong>：接收客户端消息并通过 SSE 或 JSON 响应</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.is_json_response_enabled:
    <span class="hljs-comment"># Process the message</span>
    metadata = ServerMessageMetadata(request_context=request)
    session_message = SessionMessage(message, metadata=metadata)
    <span class="hljs-keyword">await</span> writer.send(session_message)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Process messages from the request-specific stream</span>
        <span class="hljs-comment"># We need to collect all messages until we get a response</span>
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> self._clean_up_memory_streams(request_id)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># Create SSE stream</span>
    sse_stream_writer, sse_stream_reader = anyio.create_memory_object_stream[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]](<span class="hljs-number">0</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">sse_writer</span>():
        <span class="hljs-comment"># Get the request ID from the incoming request message</span>
</code></pre>
<ul>
<li><strong>GET 请求处理</strong>：建立独立的 SSE 流用于服务器主动推送 streamable_http.py:511-601</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_get_request</span>(<span class="hljs-params">self, request: Request, send: Send</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    Handle GET request to establish SSE.
    
    This allows the server to communicate to the client without the client
    first sending data via HTTP POST. The server can send JSON-RPC requests
    and notifications on this stream.
    """</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p>从测试代码中可以看到完整的使用流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@pytest.mark.anyio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_streamablehttp_client_basic_connection</span>(<span class="hljs-params">basic_server, basic_server_url</span>):
    <span class="hljs-string">"""Test basic client connection with initialization."""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> streamablehttp_client(<span class="hljs-string">f"<span class="hljs-subst">{basic_server_url}</span>/mcp"</span>) <span class="hljs-keyword">as</span> (
        read_stream,
        write_stream,
        _,
    ):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(
            read_stream,
            write_stream,
        ) <span class="hljs-keyword">as</span> session:
            <span class="hljs-comment"># Test initialization</span>
            result = <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(result, InitializeResult)
            <span class="hljs-keyword">assert</span> result.serverInfo.name == SERVER_NAME
</code></pre>
<ol>
<li>使用 streamablehttp_client 建立连接</li>
<li>通过 ClientSession 进行初始化</li>
<li>执行各种 MCP 操作（工具调用、资源访问等）</li>
</ol>
<h3 data-id="heading-8">3.4各协议对比分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785e811b64234854bfa08f6c5c04ccc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=anWdBMNmIdWTD7raJ1Z%2B1OStFA8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>MCP vs REST API</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46a32a3d7ca4fffbf19fadf0137b464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Es2s2DTqEmfvx47xFKsSfizhius%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>MCP vs WebSocket</p>
<h2 data-id="heading-9">四、项目初始化&amp;实战解析</h2>
<p>本节，将使用 uv 快速搭建 MCP 服务，然后结合 DW-DBA-MCP 实战项目进行介绍。</p>
<h3 data-id="heading-10">4.1环境安装</h3>
<p>官方推荐使用 uv 进行虚拟环境及依赖的管理。uv 的安装可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F%23highlights%25E3%2580%2582%25E5%2585%25B6%25E4%25BB%2596%25E5%25AE%2589%25E8%25A3%2585%25E6%2596%25B9%25E5%25BC%258F%25E5%258F%25AF%25E5%258F%2582%25E8%2580%2583%25EF%25BC%259Ahttps%3A%2F%2Fdocs.astral.sh%2Fuv%2Fgetting-started%2Finstallation%2F%23standalone-installer%25E3%2580%2582" target="_blank" title="https://docs.astral.sh/uv/#highlights%E3%80%82%E5%85%B6%E4%BB%96%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E5%8F%AF%E5%8F%82%E8%80%83%EF%BC%9Ahttps://docs.astral.sh/uv/getting-started/installation/#standalone-installer%E3%80%82" ref="nofollow noopener noreferrer">docs.astral.sh/uv/#highlig…</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macos</span>
curl -LsSf https://astral.sh/uv/install.sh | sh
<span class="hljs-built_in">source</span> <span class="hljs-variable">$HOME</span>/.local/bin/env


(base) Dewu-GK234XWXCT:~ admin$ uv --version
uv 0.7.13 (62ed17b23 2025-06-12)
</code></pre>
<p>同时，需要注意⚠️：SDK 需要 Python 3.10 或更高版本，支持 Python 3.10 至 3.13。</p>
<ul>
<li><strong>创建虚拟环境：</strong></li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化虚拟环境</span>
uv init MCP-DB


<span class="hljs-comment"># 切换目录</span>
<span class="hljs-built_in">cd</span> MCP-DB


<span class="hljs-comment"># 安装mcp client依赖</span>
uv add <span class="hljs-string">"mcp[cli]"</span>


<span class="hljs-comment"># 使用 uv 运行 mcp 命令</span>
uv run mcp -<span class="hljs-built_in">help</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28668b7469de44c2ba8874402248c92f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=g8SWYGvQxG%2BOUN0T6nxvfX8wTc0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-11">4.2DW-DBA-MCP实战解析</h3>
<p>本项目旨在为数据库侧开发 MCP Server。同时，考虑到高可扩展性，项目采用微服务架构进行设计开发，这也便于与 Nacos MCP Server 进行集成，客户端配置Nacos MCP Server 服务，LLM 即可通过该网关高效路由到合适工具；考虑到易用性，通过封装 MCP Client 和 MCP Server，提供 FastAPI 接口处理用户的提问。项目目录结构如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">DW-DBA-MCP/
├── Dockerfile
├── LICENSE
├── README.md   
├── datas                          <span class="hljs-meta"># 存放项目日志文件</span>
│   ├── files                           <span class="hljs-meta"># 存放工具执行的 SQL 语句</span>
│   ├── logs                            <span class="hljs-meta"># 存放日志文件</span>
│   └── version   
├── mcp_for_db
│   ├── __init__.py
│   ├── client                    <span class="hljs-meta"># 自建客户端</span>
│   │   ├── __init__.py
│   │   ├── api.py                     <span class="hljs-meta"># FastAPI 服务</span>
│   │   └── client.py                  <span class="hljs-meta"># MCP Client</span>
│   ├── debug
│   │   ├── __init__.py
│   │   └── mcp_logger.py              <span class="hljs-meta"># 记录 MCP Client 与 MCP Server 通信数据，用于白盒解析 MCP 通信协议</span>
│   ├── envs
│   │   ├── common.env           <span class="hljs-meta"># 多服务环境变量配置文件</span>
│   │   ├── dify.env
│   │   └── mysql.env
│   ├── server
│   │   ├── __init__.py
│   │   ├── cli
│   │   │   ├── __init__.py
│   │   │   ├── dify_cli.py     <span class="hljs-meta"># cli 方式启动 dify 服务</span>
│   │   │   ├── mysql_cli.py    <span class="hljs-meta"># cli 方式启动 mysql 服务</span>
│   │   │   └── server.py
│   │   ├── common
│   │   │   ├── __init__.py
│   │   │   ├── <span class="hljs-keyword">base</span>            <span class="hljs-meta"># 公共的资源、工具和提示词自动注册和发现的基类包</span>
│   │   │   ├── prompts.py      <span class="hljs-meta"># 存放提示词模版</span>
│   │   │   └── tools.py        <span class="hljs-meta"># 存放工具描述</span>
│   │   ├── core
│   │   │   ├── __init__.py
│   │   │   ├── base_server.py       <span class="hljs-meta"># 微服务基类</span>
│   │   │   ├── config_manager.py    <span class="hljs-meta"># 环境变量配置器</span>
│   │   │   ├── env_distribute.py    <span class="hljs-meta"># stdio通信机制下多服务环境变量分发器</span>
│   │   │   └── service_manager.py   <span class="hljs-meta"># 多服务管理器</span>
│   │   ├── server_dify              <span class="hljs-meta"># dify 服务实现包</span>
│   │   │   ├── __init__.py
│   │   │   ├── config
│   │   │   ├── dify_server.py      <span class="hljs-meta"># dify 服务实现类</span>
│   │   │   └── tools
│   │   ├── server_mysql             <span class="hljs-meta"># mysql 服务实现包</span>
│   │   │   ├── __init__.py
│   │   │   ├── config
│   │   │   ├── mysql_server.py     <span class="hljs-meta"># mysql 服务实现类</span>
│   │   │   ├── prompts
│   │   │   ├── resources
│   │   │   └── tools
│   │   └── shared
│   │       ├── __init__.py
│   │       ├── oauth
│   │       ├── security    <span class="hljs-meta"># SQL鉴权</span>
│   │       ├── templates
│   │       └── utils
│   └── test
├── pyproject.toml
├── requirements.txt
└── uv.<span class="hljs-keyword">lock</span>
</code></pre>
<p><strong>项目设计思路</strong></p>
<p>本项目原先参考于开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwenb1n-dev%2Fmysql_mcp_server_pro%25EF%25BC%258C%25E4%25BD%2586%25E9%2592%2588%25E5%25AF%25B9%25E5%25BE%25AE%25E6%259C%258D%25E5%258A%25A1%25E5%25BC%258F%25E7%259A%2584%25E6%259E%25B6%25E6%259E%2584%25E8%25AE%25BE%25E8%25AE%25A1%25EF%25BC%258C%25E5%258F%2588%25E5%2581%259A%25E4%25BA%2586%25E8%25BF%259B%25E4%25B8%2580%25E6%25AD%25A5%25E6%2594%25B9%25E8%25BF%259B%25EF%25BC%258C%25E7%258E%25B0%25E9%2598%25B6%25E6%25AE%25B5%25E4%25BA%258C%25E8%2580%2585%25E7%259A%2584%25E5%25B7%25AE%25E5%25BC%2582%25E5%25A6%2582%25E4%25B8%258B%25EF%25BC%259A" target="_blank" title="https://github.com/wenb1n-dev/mysql_mcp_server_pro%EF%BC%8C%E4%BD%86%E9%92%88%E5%AF%B9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%8F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%8C%E5%8F%88%E5%81%9A%E4%BA%86%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%94%B9%E8%BF%9B%EF%BC%8C%E7%8E%B0%E9%98%B6%E6%AE%B5%E4%BA%8C%E8%80%85%E7%9A%84%E5%B7%AE%E5%BC%82%E5%A6%82%E4%B8%8B%EF%BC%9A" ref="nofollow noopener noreferrer">github.com/wenb1n-dev/…</a></p>
<p>针对如何借助 Low-Level 接口自动注册和发现资源、工具和提示词，接下来则以我们扩展封装的资源为例进行介绍。</p>
<p>在多服务基类脚本base_server.py中只需展示和读取资源即可，对应的类会自动将资源进行注册和读取。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_server</span>(<span class="hljs-params">self</span>):
    <span class="hljs-string">"""设置服务器路由"""</span>
    <span class="hljs-keyword">if</span> self.server_setup_completed:
        self.logger.debug(<span class="hljs-string">"服务器路由已设置，跳过重复设置"</span>)
        <span class="hljs-keyword">return</span>
    
    self.logger.info(<span class="hljs-string">"开始设置服务器路由"</span>)
    
    <span class="hljs-comment"># 注册资源处理器</span>
    @self.server.list_resources()
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_list_resources</span>() -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-keyword">try</span>:
            registry = self.get_resource_registry()
            <span class="hljs-keyword">if</span> registry <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                self.logger.warning(<span class="hljs-string">"资源注册表未初始化，返回空列表"</span>)
                <span class="hljs-keyword">return</span> []
            
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(registry, <span class="hljs-string">'get_all_resources'</span>):
                <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(registry.get_all_resources):
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> registry.get_all_resources()
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> registry.get_all_resources()
            <span class="hljs-keyword">return</span> []
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"获取资源列表失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> []
    
    @self.server.read_resource()
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_read_resource</span>(<span class="hljs-params">uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            self.logger.info(<span class="hljs-string">f"开始读取资源: <span class="hljs-subst">{uri}</span>"</span>)
            registry = self.get_resource_registry()
            <span class="hljs-keyword">if</span> registry <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"资源注册表未初始化"</span>)
            
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(registry, <span class="hljs-string">'get_resource'</span>):
                <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(registry.get_resource):
                    content = <span class="hljs-keyword">await</span> registry.get_resource(uri)
                <span class="hljs-keyword">else</span>:
                    content = registry.get_resource(uri)
            <span class="hljs-keyword">else</span>:
                content = <span class="hljs-literal">None</span>
            
            <span class="hljs-keyword">if</span> content <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                content = <span class="hljs-string">"null"</span>
            self.logger.info(<span class="hljs-string">f"资源 <span class="hljs-subst">{uri}</span> 读取成功，内容长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span>"</span>)
            <span class="hljs-keyword">return</span> content
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"读取资源失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">raise</span>
</code></pre>
<p><strong>资源注册类：</strong></p>
<pre><code class="hljs language-python" lang="python">

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceRegistry</span>:
    <span class="hljs-string">"""资源注册表，用于管理所有资源实例"""</span>
    _resources: ClassVar[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-string">'BaseResource'</span>]] = {}
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">cls, resource_class: <span class="hljs-type">Type</span>[<span class="hljs-string">'BaseResource'</span>]</span>):
        <span class="hljs-string">"""注册资源实例"""</span>
        resource = resource_class()
        logger.info(<span class="hljs-string">f"注册资源: <span class="hljs-subst">{resource.name}</span> (URI: <span class="hljs-subst">{resource.uri}</span>)"</span>)
        cls._resources[<span class="hljs-built_in">str</span>(resource.uri)] = resource
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_instance</span>(<span class="hljs-params">cls, resource: <span class="hljs-string">'BaseResource'</span></span>):
        <span class="hljs-string">"""手动注册资源实例"""</span>
        uri_str = <span class="hljs-built_in">str</span>(resource.uri)
        logger.info(<span class="hljs-string">f"注册资源实例: <span class="hljs-subst">{resource.name}</span> (URI: <span class="hljs-subst">{uri_str}</span>)"</span>)
        cls._resources[uri_str] = resource
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource</span>(<span class="hljs-params">cls, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取资源内容"""</span>
        logger.info(<span class="hljs-string">f"请求资源: <span class="hljs-subst">{uri}</span>"</span>)
        parsed = urlparse(<span class="hljs-built_in">str</span>(uri))
        uri_str = <span class="hljs-string">f"<span class="hljs-subst">{parsed.scheme}</span>://<span class="hljs-subst">{parsed.netloc}</span>/<span class="hljs-subst">{parsed.path}</span>"</span>
        path_parts = parsed.path.strip(<span class="hljs-string">'/'</span>).split(<span class="hljs-string">'/'</span>)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> path_parts <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> path_parts[<span class="hljs-number">0</span>]:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"无效的URI格式: <span class="hljs-subst">{uri_str}</span>，未指定表名"</span>)
        
        <span class="hljs-comment"># 优先尝试精确匹配</span>
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> cls._resources.values():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(resource.uri) == uri_str:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resource.read_resource(uri)
        
        <span class="hljs-comment"># 尝试后缀匹配</span>
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> cls._resources.values():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(resource.uri).endswith(path_parts[<span class="hljs-number">0</span>]):
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resource.read_resource(uri)
        
        logger.error(<span class="hljs-string">f"未找到资源: <span class="hljs-subst">{uri}</span>，已注册资源: <span class="hljs-subst">{[r.uri <span class="hljs-keyword">for</span> k, r <span class="hljs-keyword">in</span> cls._resources.items()]}</span>"</span>)
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"未注册的资源: <span class="hljs-subst">{uri}</span>"</span>)
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_resources</span>(<span class="hljs-params">cls</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取所有资源的描述"""</span>
        result = []
        <span class="hljs-comment"># 创建资源副本避免在迭代过程中修改原字典:扫描库时还会注册表资源</span>
        resources_copy = <span class="hljs-built_in">list</span>(cls._resources.values())
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> resources_copy:
            <span class="hljs-keyword">try</span>:
                logger.info(<span class="hljs-string">f"获取 <span class="hljs-subst">{resource.name}</span> 的资源描述"</span>)
                descriptions = <span class="hljs-keyword">await</span> resource.get_resource_descriptions()
                result.extend(descriptions)
                logger.debug(<span class="hljs-string">f"<span class="hljs-subst">{resource.name}</span> 提供了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(descriptions)}</span> 个资源描述"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.error(<span class="hljs-string">f"获取 <span class="hljs-subst">{resource.name}</span> 的描述失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> result
</code></pre>
<p><strong>封装后的资源基类：主要是借助__init_subclass__方法自动注册</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseResource</span>:
    <span class="hljs-string">"""资源基类"""</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    uri: AnyUrl
    mimeType: <span class="hljs-built_in">str</span> = <span class="hljs-string">"text/plain"</span>
    auto_register: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init_subclass__</span>(<span class="hljs-params">cls, **kwargs</span>):
        <span class="hljs-string">"""子类初始化时自动注册到资源注册表"""</span>
        <span class="hljs-built_in">super</span>().__init_subclass__(**kwargs)
        <span class="hljs-keyword">if</span> cls.auto_register <span class="hljs-keyword">and</span> cls.uri <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 只注册有 uri 的资源</span>
            ResourceRegistry.register(cls)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取资源描述，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""读取资源内容，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError
</code></pre>
<p><strong>实现 MySQL 资源类：值得注意的是此处我们在设计时迫于上面的机制又设计了表资源类TableResource</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TableResource</span>(<span class="hljs-title class_ inherited__">BaseResource</span>):
    <span class="hljs-string">"""代表具体表资源的类"""</span>
    auto_register: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    
    TABLE_EXISTS_QUERY = <span class="hljs-string">"""
        SELECT COUNT(*) AS table_exists
        FROM information_schema.tables
        WHERE table_schema = %s AND table_name = %s
    """</span>
    
    COLUMN_METADATA_QUERY = <span class="hljs-string">"""
        SELECT COLUMN_NAME, DATA_TYPE
        FROM information_schema.columns
        WHERE table_schema = %s AND table_name = %s
        ORDER BY ORDINAL_POSITION
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, db_name: <span class="hljs-built_in">str</span>, table_name: <span class="hljs-built_in">str</span>, description: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.db_name = db_name
        self.table_name = table_name
        self.name = <span class="hljs-string">f"table: <span class="hljs-subst">{table_name}</span>"</span>
        self.uri = AnyUrl(<span class="hljs-string">f"mysql://<span class="hljs-subst">{db_name}</span>/<span class="hljs-subst">{table_name}</span>"</span>)
        self.description = description
        self.mimeType = <span class="hljs-string">"text/csv"</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""返回数据库表资源的描述:已返回"""</span>
        <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""安全读取数据库表数据为CSV格式（带列类型信息）"""</span>
        logger.info(<span class="hljs-string">f"开始读取资源: <span class="hljs-subst">{uri}</span>"</span>)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 安全解析表名</span>
            table_name = extract_table_name(uri)
            logger.info(<span class="hljs-string">f"准备查询表: <span class="hljs-subst">{table_name}</span>"</span>)
            
            <span class="hljs-comment"># 获取列元数据（用于优化CSV生成）</span>
            column_metadata = <span class="hljs-keyword">await</span> self.get_table_metadata(table_name)
            
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_current_database_manager().get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                    <span class="hljs-comment"># 使用参数化查询避免SQL注入</span>
                    safe_query = _build_safe_query(table_name)
                    <span class="hljs-keyword">await</span> cursor.execute(safe_query)
                    
                    <span class="hljs-comment"># 直接获取列名</span>
                    columns = [col[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cursor.description]
                    rows = <span class="hljs-keyword">await</span> cursor.fetchall()
                    
                    logger.info(<span class="hljs-string">f"获取到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(rows)}</span> 行数据"</span>)
                    
                    <span class="hljs-comment"># 使用优化的CSV生成</span>
                    <span class="hljs-keyword">return</span> generate_csv(columns, rows, column_metadata)
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"读取资源失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_metadata</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">tuple</span>]:
        <span class="hljs-string">"""获取表列名和数据类型"""</span>
        db_name = get_current_database_manager().get_current_config()[<span class="hljs-string">"database"</span>]
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_current_database_manager().get_connection() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                <span class="hljs-comment"># 首先验证表存在</span>
                <span class="hljs-keyword">await</span> cursor.execute(self.TABLE_EXISTS_QUERY, (db_name, table_name))
                exists = <span class="hljs-keyword">await</span> cursor.fetchone()
                
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> exists <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> exists[<span class="hljs-string">'table_exists'</span>]:
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 在数据库 '<span class="hljs-subst">{db_name}</span>' 中不存在"</span>)
                
                <span class="hljs-comment"># 获取列元数据</span>
                <span class="hljs-keyword">await</span> cursor.execute(self.COLUMN_METADATA_QUERY, (db_name, table_name))
                metadata = [(row[<span class="hljs-string">'COLUMN_NAME'</span>], row[<span class="hljs-string">'DATA_TYPE'</span>]) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-keyword">await</span> cursor.fetchall()]
                
                <span class="hljs-keyword">return</span> metadata




<span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLResource</span>(<span class="hljs-title class_ inherited__">BaseResource</span>):
    <span class="hljs-string">"""MySQL数据库资源实现"""</span>
    name = <span class="hljs-string">"MySQL数据库"</span>
    uri = AnyUrl(<span class="hljs-string">f"mysql://localhost/default"</span>)
    description = <span class="hljs-string">"提供对MySQL数据库表的访问与查询"</span>
    mimeType = <span class="hljs-string">"text/csv"</span>
    auto_register = <span class="hljs-literal">True</span>
    
    <span class="hljs-comment"># 重用这些常量查询</span>
    TABLE_QUERY = <span class="hljs-string">"""
        SELECT TABLE_NAME AS table_name,
               TABLE_COMMENT AS table_comment,
               TABLE_ROWS AS estimated_rows
        FROM information_schema.tables
        WHERE table_schema = %s
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""初始化资源管理"""</span>
        <span class="hljs-built_in">super</span>().__init__()
        self.cache = {}  <span class="hljs-comment"># 查询结果缓存</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取数据库表资源描述（带缓存机制）"""</span>
        logger.info(<span class="hljs-string">"获取数据库资源描述"</span>)
        
        db_manager = get_current_database_manager()
        <span class="hljs-keyword">if</span> db_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            logger.error(<span class="hljs-string">"无法获取数据库管理器，上下文未设置？"</span>)
            <span class="hljs-keyword">return</span> []
        
        db_name = db_manager.get_current_config().get(<span class="hljs-string">"database"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db_name:
            logger.error(<span class="hljs-string">"数据库配置中未指定数据库名称"</span>)
            <span class="hljs-keyword">return</span> []
        
        <span class="hljs-comment"># 使用缓存避免重复查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'table_descriptions'</span> <span class="hljs-keyword">in</span> self.cache:
            logger.debug(<span class="hljs-string">"使用缓存的表描述"</span>)
            <span class="hljs-keyword">return</span> self.cache[<span class="hljs-string">'table_descriptions'</span>]
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db_manager.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                    <span class="hljs-keyword">await</span> cursor.execute(self.TABLE_QUERY, (db_name,))
                    tables = <span class="hljs-keyword">await</span> cursor.fetchall()
                    logger.info(<span class="hljs-string">f"发现 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个数据库表"</span>)
                    
                    resources = []
                    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
                        table_name = table[<span class="hljs-string">'table_name'</span>]
                        
                        <span class="hljs-comment"># 添加表行数统计</span>
                        description = table[<span class="hljs-string">'table_comment'</span>] <span class="hljs-keyword">or</span> <span class="hljs-string">f"<span class="hljs-subst">{table_name}</span> 表"</span>
                        <span class="hljs-keyword">if</span> table[<span class="hljs-string">'estimated_rows'</span>]:
                            description += <span class="hljs-string">f" (~<span class="hljs-subst">{table[<span class="hljs-string">'estimated_rows'</span>]}</span>行)"</span>
                        
                        <span class="hljs-comment"># 创建表资源</span>
                        table_resource = TableResource(db_name, table_name, description)
                        
                        <span class="hljs-comment"># 手动注册表资源实例</span>
                        ResourceRegistry.register_instance(table_resource)
                        
                        <span class="hljs-comment"># 创建资源描述对象</span>
                        resource_desc = Resource(
                            uri=table_resource.uri,
                            name=table_resource.name,
                            mimeType=table_resource.mimeType,
                            description=table_resource.description
                        )
                        resources.append(resource_desc)
                    
                    <span class="hljs-comment"># 缓存结果</span>
                    self.cache[<span class="hljs-string">'table_descriptions'</span>] = resources
                    logger.info(<span class="hljs-string">f"创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources)}</span> 个表资源描述"</span>)
                    <span class="hljs-keyword">return</span> resources
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取资源描述失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""读取根资源内容 - 返回数据库信息"""</span>
        <span class="hljs-keyword">return</span> json.dumps({
            <span class="hljs-string">"name"</span>: self.name,
            <span class="hljs-string">"uri"</span>: self.uri,
            <span class="hljs-string">"description"</span>: self.description,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"database_root"</span>
        })
</code></pre>
<p>想实现其他资源，就编写对应的脚本，然后将包加入到对应的__init__.py脚本中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">from</span> <span class="hljs-selector-class">.db_resource</span> import MySQLResource, TableResource


__all__ = <span class="hljs-selector-attr">[    <span class="hljs-string">"MySQLResource"</span>,    <span class="hljs-string">"TableResource"</span>,]</span>
</code></pre>
<p>这样代码具有较高可扩展性，组织结构也很清晰。当然，也会有其他更好的实现方式。</p>
<p><strong>效果展示</strong></p>
<p>MCP Server 主要是通过工具暴露数据给LLMs，故基于上述的设计思路，实现起来相对简单且专一，主要就是实现工具所对应的 SQL 语句编写和对应的提示词即可，鉴于篇幅和代码量，此处不再展示源码，仅提供历史测试效果图。</p>
<p><strong>查询表中数据</strong></p>
<p>在 Cline 中配置好阿里通义千问大模型 API-KEY 后，进行提问： </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82b11e5bc2c7454b82729de5c276b7d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=c6Hgf0s9SC0M2FC%2BZ1oc4naFxzs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>⚠️：阿里通义千问大模型配置可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Fcline" target="_blank" title="https://help.aliyun.com/zh/model-studio/cline" ref="nofollow noopener noreferrer">help.aliyun.com/zh/model-st…</a></p>
<p>随后，大模型开始解析执行任务：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23489474801042e5988413b59ef3ec08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Gqh9f%2By5j2mjKnT4RblRt7rukaQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>发现解析错了，开始自动矫正： </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b50aee3b8af426990c420eaed7fe63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=oCSNDPEUdOBsHAikBZydqm8gNdQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>OK，现在看起来就对多了，开始执行工具运行指令并返回结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a30e51011094d87933fa45a04439b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fJeROGH%2F7ZK7EWsisdHcLTfLUU4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终执行结果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ad13ea574344aba8bc40dd57c26f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=k8sIx3h8zjwQ7hxhaoLEZ4sGU88%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>其他的比如：查询某表中告警信息。此处给出了明确的库表信息，回答的就很精准。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7713b0a8cfc94bb7938dc5917e85c9b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=KrQg3AfNZkd8eNSB4sQtVetaOvo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>慢SQL优化</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4164be51a7496891a351ff091b844e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=4TUEajo1PYSTiTb%2BNl2KpHnigpA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>大模型在执行一些工具之后，给出了回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1fbb3b0cef84d83a63f9635591cf56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=%2FzcZB7jnSQhwZysnreVp66cSjnc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>并最终给出了如下预期效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63453dbb4324438abe4f5aa7dca1e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=UtPdSA7KLY%2B1Z63L00SQ8r32cC4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>高危操作验证</strong></p>
<p>在执行高危 SQL 语句前，会拦截并作解析，判断是否与预先允许的操作一致，不一致则不放行，模型无法操作数据库，报错终止任务。<strong>目前权限限定为查询操作 DQL</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ddbb08c32c416f977c3142833563da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fLUSeumR2B6Sml5uzJfezzd7LBk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当想更新表中数据时：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16b9b5ddb3ad47f49d346f17057bebea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=jGDuPa%2F5Kat2qP%2FWn4uKnrSAhl8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d535c51b76304dc5a652278af834f9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Uh5uvUicf4%2B4ToQoMI2P%2Bvic%2Fek%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>自建客户端提问</strong></p>
<p>实现自定义客户端时可调用服务端提示词进行任务编排，提高工具调用准确度和规避一连串的客户端continue操作，通过请求实现的FastAPI接口可直接运行出结果。</p>
<pre><code class="hljs">当前数据库基本信息，以及包含哪些表，同时用户表有哪些字段。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d798e78e854a4594b455b7bd1166c4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=pfvotBHzn44Jl8EsAMNyD5QeD6w%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f043da60d74dfc9f33127198c09f53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=yy%2F7JITZaN3V2%2FX8q89I17NZTRM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>线上部署测试效果</strong></p>
<p>我们在 MCP 应用市场中上架了一个版本的 DW-DBA-MCP 服务，在 VSCode 中安装 EP-Copilot 插件即可安装使用该服务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c9791bcc29d45a6abc5c91807fe470d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=jIjYiw6O4WnADzXic%2B7abAG%2F%2FWE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>然后在聊天界面中选择agent模式即可让 LLMs 选择合适的工具处理您的提问（注意为服务配置环境变量）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e08c232d8d24503950d0c2a62c2a294~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=wdkJYOzj9BjdanrAPmDAHgpMEQY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972c44c730ba4100bb96417007464ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Q4sCax34ZrykWl%2FjHBp3vwfGYd0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-12">五、未来规划</h2>
<p>在<strong>AI4DB</strong>（AI for Database）领域，AI 技术正颠覆传统数据库的运维与调优逻辑，推动其从依赖人工介入的被动响应模式，全面迈向可自主诊断、智能调优、故障自愈的全链路智能自治新阶段，大幅降低运维成本的同时提升了数据库系统的稳定性与运行效率。</p>
<p>而在<strong>DB4AI</strong>（Database for AI）方向，适配 AI 场景的数据库解决方案已实现关键突破：不仅具备高性能向量检索、复杂分析计算及强事务一致性等核心能力，还能原生支持文本、图像等多模态数据的一体化存储与管理，为 AI 模型训练与推理提供了高效、可靠的数据基座。</p>
<p>在技术格局剧变的背景下，DBA 的角色定位也迎来重构。传统意义上，DBA 即 Database Administrator（数据库管理员），核心聚焦于数据库的日常运维与技术保障；但随着 AI 技术的井喷式发展，DBA 已突破单一运维属性，可进阶为<strong>Data Business Architect（数据业务架构师</strong>）—— 借助 AI 工具与能力，DBA 能从海量数据中挖掘潜藏价值，打通数据与业务的链路，实现技术能力向业务价值的转化。</p>
<p>面向未来，DBA 团队将持续强化两大核心能力：一是筑牢数据安全防线，构建全周期数据安全治理体系；二是夯实工程化落地能力，推动智能技术与业务场景的深度融合。以此为基础，充分释放 DBA 在数据库 “智能自治运维” 与 “全域数据价值挖掘” 领域的双重价值，为企业数字化与智能化转型提供坚实的数据支撑。</p>
<h2 data-id="heading-13">六、资源推荐</h2>

























<table><thead><tr><th><strong>资源</strong></th><th><strong>内容</strong></th></tr></thead><tbody><tr><td><strong>MCP Server 社区仓库推荐</strong></td><td>-   <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fservers" target="_blank" title="https://github.com/modelcontextprotocol/servers" ref="nofollow noopener noreferrer">github.com/modelcontex…</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpunkpeye%2Fawesome-mcp-servers" target="_blank" title="https://github.com/punkpeye/awesome-mcp-servers" ref="nofollow noopener noreferrer">github.com/punkpeye/aw…</a></td></tr><tr><td><strong>当前支持 MCP 协议的客户端应用</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fclients" target="_blank" title="https://modelcontextprotocol.io/clients" ref="nofollow noopener noreferrer">modelcontextprotocol.io/clients</a></td></tr><tr><td><strong>MCP 市场</strong></td><td>-   <strong>ModelScope：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmcp" target="_blank" title="https://modelscope.cn/mcp" ref="nofollow noopener noreferrer">modelscope.cn/mcp</a></td></tr><tr><td><strong>百炼 MCP 市场：</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F%3Ftab%3Dmcp%23%2Fmcp-market" target="_blank" title="https://bailian.console.aliyun.com/?tab=mcp#/mcp-market" ref="nofollow noopener noreferrer">bailian.console.aliyun.com/?tab=mcp#/m…</a></td></tr></tbody></table>
<p><strong>参考资料：</strong></p>
<p>[1] 一文带你 "看见" MCP 的过程，彻底理解 MCP 的概念（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1665090%25EF%25BC%2589" target="_blank" title="https://developer.aliyun.com/article/1665090%EF%BC%89" ref="nofollow noopener noreferrer">developer.aliyun.com/article/166…</a></p>
<p>[2] 100行代码讲透MCP原理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.programnotes.cn%2Fp%2F100%25E8%25A1%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25AE%25B2%25E9%2580%258Fmcp%25E5%258E%259F%25E7%2590%2586%2F%25EF%25BC%2589" target="_blank" title="https://ai.programnotes.cn/p/100%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%AE%B2%E9%80%8Fmcp%E5%8E%9F%E7%90%86/%EF%BC%89" ref="nofollow noopener noreferrer">ai.programnotes.cn/p/100%E8%A1…</a></p>
<h3 data-id="heading-14">往期回顾</h3>
<p>1. 项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
<p>2. Dragonboat统一存储LogDB实现分析｜得物技术</p>
<p>3. 从数字到版面：得物数据产品里数字格式化的那些事</p>
<p>4. 一文解析得物自建 Redis 最新技术演进</p>
<p>5. Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</p>
<h3 data-id="heading-15">文 /少晖、洪兆</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识库创业复盘：从闭源到开源，这3个教训价值百万]]></title>    <link>https://juejin.cn/post/7581872532363755529</link>    <guid>https://juejin.cn/post/7581872532363755529</guid>    <pubDate>2025-12-10T10:33:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581872532363755529" data-draft-id="7582041304654512174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识库创业复盘：从闭源到开源，这3个教训价值百万"/> <meta itemprop="keywords" content="JavaScript,GitHub,前端"/> <meta itemprop="datePublished" content="2025-12-10T10:33:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐小夕"/> <meta itemprop="url" content="https://juejin.cn/user/3808363978429613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识库创业复盘：从闭源到开源，这3个教训价值百万
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363978429613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐小夕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T10:33:48.000Z" title="Wed Dec 10 2025 10:33:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"把知识库代码公开到 github 上的那天，我失眠到凌晨四点。</p>
<p>不是因为激动，是害怕——害怕一年心血被一键复制，害怕客户部署了就没有采购的欲望了。</p>
<p>120 天后再回头看，正是那次'裸奔'，才救活了公司，也重塑了我对商业护城河的所有认知。</p>
<p>今天把决策前后最痛的 3 个教训掏出来，能帮你省下至少 100 万试错成本。"</p>
</blockquote>
<p>关注我的朋友也许了解，我们24年年初，上线了一款知识库产品——橙子轻文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9710aa201d0e482792e40d2f1df3cf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=poXiskH2ppEm70OaAKQLGVsJmds%3D" alt="图片" loading="lazy"/></p>
<p>github地址：</p>
<p>我一直觉得「在线办公工具」是个矛盾体：要么功能全但收费贵（比如某钉、某飞），要么免费但功能零散（比如单独的在线文档、独立的思维导图工具）。所以我们决定花半年时间打造 <strong>OfficeHub</strong> 这个项目，把「文档 + 表格 + 思维导图 + AI + 知识库」完美的融合成一个办公智能体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7de8d946214c1b903d6f30f53495cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=u5ow0Nttm4T1JZfHsAW94OIRcJU%3D" alt="图片" loading="lazy"/></p>
<p><strong>核心定位：基于 Web 的开源在线办公协作平台，集成文档编辑、思维导图、电子表格、AI 创作、模板管理和知识库功能。</strong> <strong>简单说，OfficeHub 想做的是「办公工具界的瑞士军刀」：不用切换多个平台，一个系统搞定从内容创作到知识沉淀的全流程。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627e4a066e2c4971825cd9841f87e489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=TZVDKeYXyGgz98oVREksTS%2B1iMo%3D" alt="图片" loading="lazy"/></p>
<p>但是上线运营了3个月之后，虽然积累了上千的用户使用，但是也发现了很多商业上的问题。接下来我会系统复盘一下，橙子轻文档创业的一些经验和教训。</p>
<h2 data-id="heading-0">01 教训一：把"闭源"当护城河，其实是给自己挖坟</h2>
<h3 data-id="heading-1">1. 自嗨式壁垒</h3>
<ul>
<li>我们曾花 2 个月自研「文档搭建引擎」，体验类比 Notion，PPT 里写满"技术壁垒"。</li>
<li>闭源 6 个月，GitHub 只有 12 个 star，其中 3 个还是团队成员小号。</li>
</ul>
<h3 data-id="heading-2">2. 客户用脚投票</h3>
<ul>
<li>企业版客单价 3 万，成交周期 60 天，我天天被客户问："有没有 API？能不能二开？"</li>
<li>一次 POC，客户 IT 总监直接甩出飞书知识库组件："你们不开放，我就不买。"</li>
</ul>
<h3 data-id="heading-3">3. 致命瞬间</h3>
<p>去年 9 月，账上现金只剩 2 个月，一位也在创业的朋友问我：</p>
<blockquote>
<p>"如果 Notion 明天开源，你们还剩什么？" 我答不上来，那一刻我知道：闭源不是墙，是牢笼。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">02 教训二：开源不是"做慈善"，是"放鱼饵"</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a44e91fc154610a38690d58bf3ecd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=NgKxzcJEcsWSVtfaJ1ieY%2BkzqQU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">上面是我们开源了编译版之后的 github 截图。</h2>
<h3 data-id="heading-6">1. 120 天数据对比</h3>

























<table><thead><tr><th align="left">指标</th><th align="left">闭源末期</th><th align="left">开源 +120 天</th></tr></thead><tbody><tr><td align="left">新增线索</td><td align="left">68 条</td><td align="left">300 条</td></tr><tr><td align="left">企业版演示</td><td align="left">1-3 次/月</td><td align="left">10 次/月</td></tr><tr><td align="left"/><td align="left"/><td align="left"/></tr></tbody></table>
<h3 data-id="heading-7">2. 鱼饵配方</h3>
<p>我们把知识库编译版代码开源了，让用户可以直接本地安装和部署，保证数据的绝对安全，同时还能在本地环境体验，测试。</p>
<ul>
<li><strong>Apache 模块</strong> → 审计日志、合规，企业刚需；</li>
<li><strong>云原生插件</strong> → 只给二进制，订阅解锁。</li>
</ul>
<blockquote>
<p>开发者爽了，企业慌了，我们笑了。开源第 7 天，一家头部券商主动约演示："我们发现本地体验不错，想二次开发，买商业源码授权多少钱？"</p>
</blockquote>
<h3 data-id="heading-8">这个时候我才发现，让客户能用起来，比说产品亮点说1万遍都有用。</h3>
<p>虽然开源后，很多没有二次开发需求的企业，直接用我们的源码部署到自己服务器上作为私有知识库使用，但是这间接的提高了我们产品的影响力，进而带来了真正有二次开发需求的潜在客户。</p>
<h2 data-id="heading-9">03 教训三：开源节奏错了，同样会死</h2>
<h3 data-id="heading-10">1. 一步错，全盘输</h3>
<p>同期友商 B 直接把 100% 代码 GPL 开源，结果：</p>
<ul>
<li>企业客户担心"被传染"，不敢用；</li>
<li>社区开发者发现没"高级功能"，star 数暴涨却无人续费；</li>
<li>3 个月后资金链断裂，核心团队被大厂打包挖走。</li>
</ul>
<h3 data-id="heading-11">2. 三把尺子，决定"先开哪块"</h3>

























<table><thead><tr><th align="left">尺子</th><th align="left">先开源</th><th align="left">后闭源</th></tr></thead><tbody><tr><td align="left">技术壁垒低</td><td align="left">✓ 编辑器 UI</td><td align="left">✗ 协同算法</td></tr><tr><td align="left">获客需求强</td><td align="left">✓ 导入工具</td><td align="left">✗ 审计日志</td></tr><tr><td align="left">合规风险高</td><td align="left">✗ 国密加密</td><td align="left">✓ 私有部署脚本</td></tr></tbody></table>
<blockquote>
<p>一句话：<strong>让开发者爽在先，让企业怕在后。</strong></p>
</blockquote>
<h3 data-id="heading-12">3. 节奏表</h3>
<ul>
<li><strong>0-3 个月</strong>：放编辑器 + 基础 API，拉 star、拉社群；</li>
<li><strong>3-6 个月</strong>：放权限框架 50%，留 GPL 暗钩，销售跟进；</li>
<li><strong>6 个月后</strong>：逐步闭源高阶合规模块，推出订阅制。</li>
</ul>
<h2 data-id="heading-13">04 彩蛋：开源那晚，我们在代码里藏了一句 joke</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// If you find this line, call cxzk_168,// we will send you a crate of oranges.</span>
</code></pre>
<p>结果真有 3 个开发者联系我，我们按约寄出橙子，其中一人后来成了橙子轻文档的客户。</p>
<p><strong>你看，诚意永远是最便宜的 PR。</strong></p>
<h2 data-id="heading-14">05 如果你只能记住三句话</h2>
<ol>
<li>闭源不是护城河，是拦路墙，越早推倒越省钱。</li>
<li>开源不是全裸，是"比基尼"——露得恰到好处，才让人想花钱看里面。</li>
<li>节奏 &gt; 决心，先让社区爽，再让客户怕，最后让公司活下来。</li>
</ol>
<p>把代码公开那天，我以为会失去一切；<br/>
120 天后才发现，<strong>真正的护城河，是与客户一起进化和成长。</strong></p>
<p>愿这 3 条价值百万的教训，帮你少失眠 180 个夜晚。</p>
<p>橙子已熟，等你来摘。</p>
<p>github地址：</p>
<p>目 橙子轻文档 由于用户量过多，目前只做为演示使用，切勿传个人敏感数据。</p>
<p>如果大家想线上管理知识笔记，大家可以移步我们的新产品——<strong>FlowmixAI</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案]]></title>    <link>https://juejin.cn/post/7581412054903128073</link>    <guid>https://juejin.cn/post/7581412054903128073</guid>    <pubDate>2025-12-09T03:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581412054903128073" data-draft-id="7581412607060951086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-09T03:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:57:40.000Z" title="Tue Dec 09 2025 03:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    37
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在组件化开发中，插槽（Slot）是实现组件内容分发与灵活扩展的核心技术。Vue、Angular 等框架原生支持插槽语法，而 React 虽未提供内置的 <code>&lt;slot&gt;</code> 标签，但通过 <code>props</code>、组件组合等原生能力，能实现更灵活、更强大的插槽效果。本文将系统拆解 React 插槽的实现方案，辨析常见用法的合理性，结合全新实例详解从基础到高级的应用场景，帮助开发者掌握组件复用与扩展的核心技巧。</p>
<h2 data-id="heading-0">一、React 插槽的核心原理与合理性辨析</h2>
<p>React 插槽的本质是<strong>组件间的内容传递与渲染控制</strong>，核心依赖 React 的 <code>children</code> 属性、props 传递机制以及组件组合思想。在分析常见实现方案前，先明确核心原则：</p>
<ul>
<li>正确方向：利用 React 原生特性（<code>children</code>、props、Context 等）实现内容分发，不依赖非标准 API，保证组件复用性与可维护性；</li>
<li>常见误区：过度封装复杂逻辑（如不必要的 Context 嵌套）、忽略性能优化（如每次渲染创建新组件）、混淆插槽与普通 props 的使用场景。</li>
</ul>
<p>下面将通过「基础→进阶→高级」的顺序，详解各类插槽的正确实现方式，并补充全新实例说明。</p>
<h2 data-id="heading-1">二、基础插槽：<code>children</code> prop （默认插槽）</h2>
<p><code>children</code> 是 React 组件的内置 prop，用于接收组件标签包裹的所有内容，是实现「默认插槽」的最简方案，适用于无需分区的简单内容传递场景。</p>
<h3 data-id="heading-2">核心特性与正确用法</h3>
<ul>
<li>自动接收组件包裹的所有节点（元素、文本、组件等）；</li>
<li>支持设置默认内容，处理无传入内容的边界情况；</li>
<li>无需额外配置，原生支持，性能最优。</li>
<li>
<h3 data-id="heading-3">实例 1：基础卡片组件（默认插槽）</h3>
</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：基础卡片（支持默认内容）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BasicCard</span>(<span class="hljs-params">{ children, className }</span>) {
  <span class="hljs-comment">// 边界处理：无传入内容时显示默认提示</span>
  <span class="hljs-keyword">const</span> defaultContent = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card-default"</span>&gt;</span>暂无内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span> || ''}`} <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', 
      <span class="hljs-attr">maxWidth:</span> '<span class="hljs-attr">300px</span>' 
    }}&gt;</span>
      {children || defaultContent}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：使用卡片组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      {/* 传入自定义内容 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BasicCard</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
          <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/80"</span> 
          <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span> 
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">50</span>%', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">10px</span>' }}
        /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span> <span class="hljs-attr">0</span> <span class="hljs-attr">8px</span> <span class="hljs-attr">0</span>' }}&gt;</span>李华<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">666</span>' }}&gt;</span>前端开发工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">BasicCard</span>&gt;</span>

      {/* 未传入内容（显示默认值） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BasicCard</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty-card"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-4">实例 2：带条件渲染的默认插槽</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：通知组件（根据类型显示不同默认图标）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Notification</span>(<span class="hljs-params">{ children, type = <span class="hljs-string">'info'</span> }</span>) {
  <span class="hljs-comment">// 根据类型生成默认图标</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultIcon</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">switch</span>(type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'success'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">green</span>' }}&gt;</span>✅<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'error'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>❌<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'warning'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">orange</span>' }}&gt;</span>⚠️<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">blue</span>' }}&gt;</span>ℹ️<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', 
      <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>', 
      <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">12px</span>', 
      <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">f5f5f5</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' 
    }}&gt;</span>
      {getDefaultIcon()}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span>&gt;</span>操作成功！<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span>&gt;</span>提交失败，请重试<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span>&gt;</span>这是一条普通通知<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-5">三、命名插槽：多区域内容精准分发</h2>
<p>当组件需要划分多个固定区域（如头部、主体、底部）时，使用「命名插槽」实现精准内容分发。React 中无原生「命名插槽」语法，但通过「多 props 传递」或「children 对象」两种方案均可实现，适用于布局组件、复杂卡片等场景。</p>
<h3 data-id="heading-6">方案 1：多 props 传递（推荐，简洁直观）</h3>
<p>通过不同名称的 props 接收不同区域的内容，是最常用的命名插槽实现方式，可读性强，易于维护。</p>
<h4 data-id="heading-7">实例：页面布局组件（头部、侧边栏、主体、底部）</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：布局组件（定义 4 个命名插槽）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PageLayout</span>(<span class="hljs-params">{ header, sidebar, content, footer, isSidebarLeft = <span class="hljs-literal">true</span> }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">minHeight:</span> '<span class="hljs-attr">100vh</span>' }}&gt;</span>
      {/* 头部插槽 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">2c3e50</span>', 
        <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', 
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
        <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' 
      }}&gt;</span>
        {header}
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      {/* 主体+侧边栏容器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flex:</span> <span class="hljs-attr">1</span> }}&gt;</span>
        {/* 侧边栏插槽（支持左右切换） */}
        {isSidebarLeft &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">200px</span>', 
            <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">ecf0f1</span>', 
            <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
            <span class="hljs-attr">borderRight:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>' 
          }}&gt;</span>
            {sidebar}
          <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
        )}

        {/* 主体内容插槽 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">flex:</span> <span class="hljs-attr">1</span>, <span class="hljs-attr">padding:</span> '<span class="hljs-attr">24px</span>' }}&gt;</span>
          {content}
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

        {!isSidebarLeft &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">200px</span>', 
            <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">ecf0f1</span>', 
            <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
            <span class="hljs-attr">borderLeft:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>' 
          }}&gt;</span>
            {sidebar}
          <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 底部插槽 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">2c3e50</span>', 
        <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', 
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', 
        <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' 
      }}&gt;</span>
        {footer}
      <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PageLayout</span>
      // <span class="hljs-attr">头部插槽内容</span>
      <span class="hljs-attr">header</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">h1</span>&gt;</span>我的博客<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>}
      // 侧边栏插槽内容
      sidebar={
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">12px</span>' }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/article"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>文章列表<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>关于我<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      }
      // 主体插槽内容
      content={
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>React 插槽详解<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>本文介绍 React 中插槽的多种实现方式，帮助开发者灵活扩展组件...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      }
      // 底部插槽内容
      footer={<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>© 2025 我的博客 版权所有<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      // 侧边栏在右侧
      isSidebarLeft={false}
    /&gt;</span>
  );
}
</code></pre>
<h3 data-id="heading-8">方案 2：children 对象（模拟 Vue 具名插槽语法）</h3>
<p>将 <code>children</code> 设计为对象，键名为插槽名称，键值为插槽内容，语法更接近 Vue 的具名插槽，适用于习惯 Vue 语法的开发者， 不推荐使用，不直观多此一举</p>
<h4 data-id="heading-9">实例：商品卡片组件（标题、描述、价格、操作区）</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：商品卡片（接收 children 对象作为命名插槽）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductCard</span>(<span class="hljs-params">{ children, style }</span>) {
  <span class="hljs-comment">// 解构插槽内容，设置默认值</span>
  <span class="hljs-keyword">const</span> { 
    title = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>默认商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>,
    description = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>暂无商品描述<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>,
    price = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥0.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>,
    action = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  } = children || {};

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
      <span class="hljs-attr">width:</span> '<span class="hljs-attr">280px</span>',
      <span class="hljs-attr">...style</span>
    }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">12px</span>' }}&gt;</span>{title}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">12px</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">666</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>{description}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">16px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>', <span class="hljs-attr">fontWeight:</span> '<span class="hljs-attr">bold</span>' }}&gt;</span>{price}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>{action}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>
        {{
          title: <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>无线蓝牙耳机<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>,
          description: <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>降噪功能 | 续航24小时 | 防水防汗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>,
          price: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥399.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>,
          action: (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">6px</span> <span class="hljs-attr">12px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}&gt;</span>
                加入购物车
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">6px</span> <span class="hljs-attr">12px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">fff</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">42b983</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}&gt;</span>
                立即购买
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )
        }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>
        {{
          title: <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>智能手表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>,
          price: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥899.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          // 未传入 description 和 action，使用默认值
        }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-10">四、作用域插槽：子组件向父组件传递数据</h2>
<p>作用域插槽（Scoped Slot）的核心是「子组件提供数据，父组件决定如何渲染」，适用于子组件持有数据但渲染逻辑需灵活定制的场景（如列表渲染、数据展示格式化）。React 中通过「render props」或「函数作为 children」实现，两者本质一致，均是将数据通过函数参数传递给父组件。</p>
<h3 data-id="heading-11">方案 1：函数作为 children（更简洁，推荐）</h3>
<p>直接将 <code>children</code> 设计为函数，子组件调用该函数时传入数据，父组件通过函数参数接收数据并渲染。</p>
<h4 data-id="heading-12">实例：用户列表组件（子组件提供用户数据，父组件定制渲染）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 子组件：用户列表（提供数据，暴露给父组件渲染）</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">UserList</span>({ <span class="hljs-selector-tag">data</span>, <span class="hljs-selector-tag">children</span> }) {
  <span class="hljs-selector-tag">if</span> (!data || data.length === <span class="hljs-number">0</span>) {
    <span class="hljs-selector-tag">return</span> &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span>, <span class="hljs-attribute">textAlign</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;暂无用户数据&lt;/div&gt;;
  }

  return (
    &lt;div style={{ <span class="hljs-attribute">border</span>: <span class="hljs-string">'1px solid #eee'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attribute">overflow</span>: <span class="hljs-string">'hidden'</span> }}&gt;
      {data.<span class="hljs-built_in">map</span>((user, index) =&gt; (
        <span class="hljs-comment">// 调用 children 函数，传递用户数据和索引</span>
        &lt;div 
          key={user.id} 
          style={{ 
            <span class="hljs-attribute">padding</span>: <span class="hljs-string">'16px'</span>, 
            <span class="hljs-attribute">borderBottom</span>: index &lt; data.length - <span class="hljs-number">1</span> ? <span class="hljs-string">'1px solid #eee'</span> : <span class="hljs-string">'none'</span>,
            <span class="hljs-attribute">backgroundColor</span>: index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'#fff'</span> : <span class="hljs-string">'#f9f9f9'</span>
          }}
        &gt;
          {<span class="hljs-built_in">children</span>(user, index)}
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}

<span class="hljs-comment">// 父组件使用：定制不同的渲染逻辑</span>
function <span class="hljs-built_in">App</span>() {
  <span class="hljs-comment">// 模拟用户数据</span>
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">userData</span> = <span class="hljs-selector-attr">[    { id: 1, name: <span class="hljs-string">'张三'</span>, age: 28, role: <span class="hljs-string">'管理员'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> },    { id: 2, name: <span class="hljs-string">'李四'</span>, age: 24, role: <span class="hljs-string">'普通用户'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> },    { id: 3, name: <span class="hljs-string">'王五'</span>, age: 32, role: <span class="hljs-string">'VIP用户'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> }  ]</span>;

  <span class="hljs-selector-tag">return</span> (
    &lt;div style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span>, <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'20px'</span> }}&gt;
      {<span class="hljs-comment">/* 渲染方式 1：简洁卡片式 */</span>}
      &lt;UserList data={<span class="hljs-selector-tag">userData</span>}&gt;
        {(<span class="hljs-selector-tag">user</span>) =&gt; (
          &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'12px'</span> }}&gt;
            &lt;img src={<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.avatar</span>} <span class="hljs-selector-tag">alt</span>={<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>} <span class="hljs-selector-tag">style</span>={{ borderRadius: '50%' }} /&gt;
            &lt;div&gt;
              &lt;div style={{ fontWeight: 'bold' }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '12px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.role</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
      &lt;/<span class="hljs-selector-tag">UserList</span>&gt;

      {<span class="hljs-comment">/* 渲染方式 2：详细信息式 */</span>}
      &lt;UserList data={<span class="hljs-selector-tag">userData</span>}&gt;
        {(<span class="hljs-selector-tag">user</span>, <span class="hljs-selector-tag">index</span>) =&gt; (
          &lt;div&gt;
            &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attribute">marginBottom</span>: <span class="hljs-string">'8px'</span> }}&gt;
              &lt;span style={{ backgroundColor: '#42b983', <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">padding</span>: <span class="hljs-string">'2px 8px'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'12px'</span>, <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'12px'</span> }}&gt;
                {<span class="hljs-selector-tag">index</span> + <span class="hljs-number">1</span>}
              &lt;/<span class="hljs-selector-tag">span</span>&gt;
              &lt;<span class="hljs-selector-tag">h4</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">margin</span>: <span class="hljs-string">'0'</span> }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">h4</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '14px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;年龄：{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.age</span>}岁&lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '14px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;身份：{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.role</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
      &lt;/<span class="hljs-selector-tag">UserList</span>&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<h3 data-id="heading-13">方案 2：render props（显式声明渲染函数）</h3>
<p>通过专门的 props（如 <code>renderItem</code>）传递渲染函数，语义更明确，适用于需要多个渲染函数的复杂组件。</p>
<h4 data-id="heading-14">实例：数据表格组件（支持表头和行渲染定制）</h4>
<pre><code class="hljs language-css" lang="css">// 子组件：数据表格（通过 render props 暴露表头和行数据）
function DataTable({ <span class="hljs-attribute">columns</span>, data, renderHeader, renderRow }) {
  return (
    &lt;<span class="hljs-selector-tag">table</span> style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">'100%'</span>, borderCollapse: <span class="hljs-string">'collapse'</span>, border: <span class="hljs-string">'1px solid #eee'</span> }}&gt;
      {<span class="hljs-comment">/* 表头渲染：调用 renderHeader 传递列配置 */</span>}
      &lt;<span class="hljs-selector-tag">thead</span>&gt;
        &lt;<span class="hljs-selector-tag">tr</span> style={{ backgroundColor: <span class="hljs-string">'#f5f5f5'</span> }}&gt;
          {<span class="hljs-attribute">columns</span><span class="hljs-selector-class">.map</span>((col) =&gt; (
            &lt;&lt;<span class="hljs-selector-tag">th</span> key={col<span class="hljs-selector-class">.key</span>} style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'12px'</span>, border: <span class="hljs-string">'1px solid #eee'</span>, textAlign: <span class="hljs-string">'left'</span> }}&gt;
              {renderHeader(col)}
            &lt;/&lt;/<span class="hljs-selector-tag">th</span>&gt;
          ))}
        &lt;/<span class="hljs-selector-tag">tr</span>&gt;
      &lt;/<span class="hljs-selector-tag">thead</span>&gt;
      {<span class="hljs-comment">/* 表体渲染：调用 renderRow 传递行数据 */</span>}
      &lt;<span class="hljs-selector-tag">tbody</span>&gt;
        {data<span class="hljs-selector-class">.map</span>((row) =&gt; (
          &lt;<span class="hljs-selector-tag">tr</span> key={row<span class="hljs-selector-class">.id</span>} style={{ backgroundColor: <span class="hljs-string">'#fff'</span> }}&gt;
            {<span class="hljs-attribute">columns</span><span class="hljs-selector-class">.map</span>((col) =&gt; (
              &lt;<span class="hljs-selector-tag">td</span> key={col<span class="hljs-selector-class">.key</span>} style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'12px'</span>, border: <span class="hljs-string">'1px solid #eee'</span> }}&gt;
                {renderRow(row, col)}
              &lt;/<span class="hljs-selector-tag">td</span>&gt;
            ))}
          &lt;/<span class="hljs-selector-tag">tr</span>&gt;
        ))}
      &lt;/<span class="hljs-selector-tag">tbody</span>&gt;
    &lt;/<span class="hljs-selector-tag">table</span>&gt;
  );
}

// 父组件使用
function App() {
  const tableColumns = <span class="hljs-selector-attr">[    { key: <span class="hljs-string">'name'</span>, label: <span class="hljs-string">'商品名称'</span> },    { key: <span class="hljs-string">'price'</span>, label: <span class="hljs-string">'价格'</span> },    { key: <span class="hljs-string">'stock'</span>, label: <span class="hljs-string">'库存'</span> },    { key: <span class="hljs-string">'action'</span>, label: <span class="hljs-string">'操作'</span> }  ]</span>;

  const tableData = <span class="hljs-selector-attr">[    { id: 1, name: <span class="hljs-string">'无线鼠标'</span>, price: 99, stock: 120 },    { id: 2, name: <span class="hljs-string">'机械键盘'</span>, price: 299, stock: 86 },    { id: 3, name: <span class="hljs-string">'显示器'</span>, price: 1299, stock: 34 }  ]</span>;

  return (
    &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span> }}&gt;
      &lt;DataTable
        <span class="hljs-attribute">columns</span>={tableColumns}
        data={tableData}
        // 定制表头渲染（添加图标）
        renderHeader={(col) =&gt; (
          &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, alignItems: <span class="hljs-string">'center'</span>, gap: <span class="hljs-string">'6px'</span> }}&gt;
            &lt;<span class="hljs-selector-tag">span</span>&gt;📋&lt;/<span class="hljs-selector-tag">span</span>&gt;
            {col<span class="hljs-selector-class">.label</span>}
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
        // 定制行渲染（价格高亮、库存状态显示）
        renderRow={(row, col) =&gt; {
          switch (col<span class="hljs-selector-class">.key</span>) {
            case 'price':
              return &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'red'</span>, fontWeight: <span class="hljs-string">'bold'</span> }}&gt;¥{row<span class="hljs-selector-class">.price</span>}&lt;/<span class="hljs-selector-tag">span</span>&gt;;
            case 'stock':
              return row.stock &gt; <span class="hljs-number">50</span> ? (
                &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'green'</span> }}&gt;充足&lt;/<span class="hljs-selector-tag">span</span>&gt;
              ) : (
                &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'orange'</span> }}&gt;紧张&lt;/<span class="hljs-selector-tag">span</span>&gt;
              );
            case 'action':
              return (
                &lt;button style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'4px 8px'</span>, backgroundColor: <span class="hljs-string">'#42b983'</span>, color: <span class="hljs-string">'white'</span>, border: <span class="hljs-string">'none'</span>, borderRadius: <span class="hljs-string">'4px'</span> }}&gt;
                  编辑
                &lt;/<span class="hljs-selector-tag">button</span>&gt;
              );
            default:
              return row[col.key];
          }
        }}
      /&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<h2 data-id="heading-15">五、高级插槽：组件组合 + Context</h2>
<p>对于复杂组件（如弹窗、表单），需要多个分散的插槽且插槽内容可能嵌套较深时，可通过「专用插槽组件 + Context」实现，适用于大型组件库开发。</p>
<h3 data-id="heading-16">核心思路</h3>
<ol>
<li>定义容器组件（如 <code>Modal</code>），创建 Context 用于传递插槽注册函数；</li>
<li>定义专用插槽组件（如 <code>ModalHeader</code>、<code>ModalBody</code>），通过 Context 注册自身内容到容器组件；</li>
<li>容器组件收集所有插槽内容，按固定结构渲染。</li>
</ol>
<h3 data-id="heading-17">实例：多功能弹窗组件（支持头部、主体、底部、右上角插槽）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { createContext, useContext, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 创建 Context 用于传递插槽注册函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ModalContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 2. 定义容器组件：Modal</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ isOpen, onClose, children }</span>) {
  <span class="hljs-comment">// 存储所有插槽内容</span>
  <span class="hljs-keyword">const</span> [slots, setSlots] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">header</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">footer</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">closeBtn</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">background:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>', <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">pointer</span>' }}&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  });

  <span class="hljs-comment">// 注册插槽的函数：接收插槽名称和内容，合并到 slots 中</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">registerSlot</span> = (<span class="hljs-params">name, content</span>) =&gt; {
    <span class="hljs-title function_">setSlots</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, [name]: content }));
  };

  <span class="hljs-comment">// 未打开时不渲染</span>
  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 提供 Context，让子插槽组件能访问 registerSlot</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ModalContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">registerSlot</span> }}&gt;</span>
      {/* 遮罩层 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">position:</span> '<span class="hljs-attr">fixed</span>', 
        <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">right:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">backgroundColor:</span> '<span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0.5</span>)', 
        <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', 
        <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>', 
        <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>' 
      }} <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span>&gt;</span>
        {/* 弹窗容器 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
          <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">fff</span>', 
          <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
          <span class="hljs-attr">width:</span> '<span class="hljs-attr">500px</span>', 
          <span class="hljs-attr">maxWidth:</span> '<span class="hljs-attr">90vw</span>', 
          <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>',
          <span class="hljs-attr">onClick:</span> (<span class="hljs-attr">e</span>) =&gt;</span> e.stopPropagation() // 阻止冒泡关闭弹窗
        }}&gt;
          {/* 右上角插槽（默认关闭按钮） */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>', <span class="hljs-attr">top:</span> '<span class="hljs-attr">16px</span>', <span class="hljs-attr">right:</span> '<span class="hljs-attr">16px</span>' }}&gt;</span>
            {slots.closeBtn}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* 头部插槽 */}
          {slots.header &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span> <span class="hljs-attr">24px</span>', <span class="hljs-attr">borderBottom:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>' }}&gt;</span>
              {slots.header}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}

          {/* 主体插槽 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">24px</span>' }}&gt;</span>
            {slots.body || children} {/* 兼容默认插槽 */}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* 底部插槽 */}
          {slots.footer &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span> <span class="hljs-attr">24px</span>', <span class="hljs-attr">borderTop:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">right</span>' }}&gt;</span>
              {slots.footer}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ModalContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 定义专用插槽组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalHeader</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-comment">// 组件挂载时注册插槽，卸载时清除</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'header'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'header'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 自身不渲染，仅注册内容</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalBody</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'body'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'body'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalFooter</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'footer'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'footer'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalCloseBtn</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'closeBtn'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'closeBtn'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 4. 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)}
        style={{ padding: '8px 16px', backgroundColor: '#42b983', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
      &gt;
        打开弹窗
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}&gt;
        {/* 专用插槽组件 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">ModalHeader</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>' }}&gt;</span>修改个人信息<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalHeader</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalBody</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">16px</span>' }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">block</span>', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">4px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
                <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
                <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"张三"</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">block</span>', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">4px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>邮箱<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
                <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> 
                <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"zhangsan@example.com"</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalBody</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalFooter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">flex-end</span>' }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
              style={{ padding: '8px 16px', backgroundColor: '#fff', color: '#333', border: '1px solid #ddd', borderRadius: '4px' }}
            &gt;
              取消
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
              <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">16px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
            &gt;</span>
              保存修改
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalFooter</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalCloseBtn</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
            style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: '#666' }}
          &gt;
            关闭
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalCloseBtn</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-18">六、第三方库辅助：react-slot（简化命名插槽）</h2>
<p>如果项目中需要大量使用命名插槽，可借助第三方库 <code>react-slot</code> 简化代码，其提供了 <code>&lt;Slot&gt;</code> 和 <code>&lt;Fill&gt;</code> 组件，语法更接近原生插槽，适用于追求简洁语法的场景。</p>
<h3 data-id="heading-19">用法示例：导航栏组件</h3>
<p>jsx</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 安装依赖</span>
<span class="hljs-comment">// npm install react-slot</span>

<span class="hljs-comment">// 2. 导入组件</span>
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Slot</span>, <span class="hljs-selector-tag">Fill</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">react-slot</span>';

<span class="hljs-comment">// 3. 子组件：导航栏（定义插槽）</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">Navbar</span>() {
  <span class="hljs-selector-tag">return</span> (
    &lt;nav style={{ 
      backgroundColor: '#2c3e50', 
      <span class="hljs-attribute">padding</span>: <span class="hljs-string">'16px 24px'</span>, 
      <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, 
      <span class="hljs-attribute">justifyContent</span>: <span class="hljs-string">'space-between'</span>, 
      <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> 
    }}&gt;
      {<span class="hljs-comment">/* 左侧插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"logo"</span> /&gt;
      &lt;/div&gt;

      {<span class="hljs-comment">/* 中间插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'24px'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"menu"</span> /&gt;
      &lt;/div&gt;

      {<span class="hljs-comment">/* 右侧插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"user"</span> /&gt;
      &lt;/div&gt;
    &lt;/nav&gt;
  );
}

<span class="hljs-comment">// 4. 父组件使用：填充插槽</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">App</span>() {
  <span class="hljs-selector-tag">return</span> (
    &lt;Navbar&gt;
      {<span class="hljs-comment">/* 填充 logo 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"logo"</span>&gt;
        &lt;h1 style={{ <span class="hljs-attribute">margin</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'20px'</span> }}&gt;Logo&lt;/h1&gt;
      &lt;/Fill&gt;

      {<span class="hljs-comment">/* 填充 menu 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"menu"</span>&gt;
        &lt;a href=<span class="hljs-string">"/"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;首页&lt;/a&gt;
        &lt;a href=<span class="hljs-string">"/products"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;产品&lt;/a&gt;
        &lt;a href=<span class="hljs-string">"/contact"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;联系我们&lt;/a&gt;
      &lt;/Fill&gt;

      {<span class="hljs-comment">/* 填充 user 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"user"</span>&gt;
        &lt;button style={{ 
          <span class="hljs-attribute">padding</span>: <span class="hljs-string">'6px 12px'</span>, 
          <span class="hljs-attribute">backgroundColor</span>: <span class="hljs-string">'#42b983'</span>, 
          <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, 
          <span class="hljs-attribute">border</span>: <span class="hljs-string">'none'</span>, 
          <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'4px'</span> 
        }}&gt;
          登录
        &lt;/button&gt;
      &lt;/Fill&gt;
    &lt;/Navbar&gt;
  );
}
</code></pre>
<h2 data-id="heading-20">七、最佳实践与性能优化</h2>
<h3 data-id="heading-21">1. 插槽方案选择指南</h3>
<ul>
<li>简单内容传递（无分区）→ <code>children</code> prop（默认插槽）；</li>
<li>固定多区域（如布局、卡片）→ 多 props 命名插槽（简洁高效）；</li>
<li>子组件传数据 + 父组件定制渲染 → 函数作为 children（作用域插槽）；</li>
<li>复杂组件（多插槽、深嵌套）→ 组件组合 + Context；</li>
<li>追求 Vue 式简洁语法 → react-slot 第三方库。</li>
</ul>
<h3 data-id="heading-22">2. 性能优化关键要点</h3>
<ul>
<li>避免每次渲染创建新组件：将插槽内容提取到组件外部或使用 <code>useMemo</code> 缓存；</li>
</ul>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例：每次渲染创建新对象/组件</span>
&lt;<span class="hljs-title class_">ProductCard</span>&gt;
  {{
    <span class="hljs-attr">title</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>, <span class="hljs-comment">// 每次渲染都是新元素</span>
    <span class="hljs-attr">action</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>购买<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  }}
&lt;/<span class="hljs-title class_">ProductCard</span>&gt;

<span class="hljs-comment">// 正确示例：缓存插槽内容</span>
<span class="hljs-keyword">const</span> productSlots = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">title</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>,
  <span class="hljs-attr">action</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>购买<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}), []); <span class="hljs-comment">// 无依赖项，仅渲染一次</span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>{productSlots}<span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span></span>
</code></pre>
<ul>
<li>避免不必要的 Context 嵌套：Context 会增加组件渲染开销，简单场景优先使用 props；</li>
<li>边界处理：为所有插槽设置默认值，避免空渲染导致的布局错乱；</li>
<li>减少插槽内容的重渲染：通过 <code>React.memo</code> 包装插槽组件，避免无关更新。</li>
</ul>
<h2 data-id="heading-23">八、总结</h2>
<p>React 虽无原生插槽语法，但通过 <code>children</code> prop、多 props、函数作为 children、组件组合 + Context 等原生能力，能实现比 Vue 更灵活的插槽效果。核心在于理解「插槽是组件间内容与数据的双向传递」—— 简单场景用 <code>children</code>，多区域用命名插槽，需传数据用作用域插槽，复杂场景用组件组合 + Context。</p>
<p>掌握 React 插槽的核心是「根据场景选择合适的实现方案」，并注重性能优化，避免过度封装。合理使用插槽能大幅提升组件的复用性与扩展性，是 React 组件化开发中的必备技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程]]></title>    <link>https://juejin.cn/post/7581423932612706344</link>    <guid>https://juejin.cn/post/7581423932612706344</guid>    <pubDate>2025-12-09T02:25:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581423932612706344" data-draft-id="7581386627676602408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-09T02:25:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:25:32.000Z" title="Tue Dec 09 2025 02:25:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e7c23621bd4723945c72f1c5488e6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=vILflovwPv7UQU7KryZ%2BNnru%2Fnw%3D" alt="" loading="lazy"/></p>
<p><strong>Flashback 是一款模拟复古即时相机（Polaroid）体验的 Web 应用。</strong></p>
<p>作品来自越南的 TRAE 用户 <strong>The Vibe Coders</strong>（成员：Mai Nguyen &amp; Son Le），他们是两位后端开发者，在参与 11/22 TRAE 越南 Vibe Coding 体验活动时，用 TRAE SOLO 实现了这款基于网页的应用。这款相机可以将你的普通摄像头变成一台虚拟的复古拍立得，完整还原从按下快门到照片显影的整个过程。用户只需一个带摄像头的设备，就可以拍摄带有复古滤镜的照片，并通过动画效果观看照片“显影”的过程，仿佛回到了胶片年代。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feff18ef033b4d65a505a5d04950771a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=6FseLeTNRO9w5E6KcFC7Vdzg61E%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb515381fe9040f6bf6adf0696bef401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=ioLvH9T6FnTn26azA1I9tocc7bc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>作者：Mai Nguyen &amp; Son Le，TRAE 开发者用户</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b668f893d0fb468b9af411bed2dea758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=NdirerMaUz9MBw2N2qqgoXJV3Dc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>为什么做这个项目</strong></h2>
<h3 data-id="heading-1"><strong>项目起源</strong></h3>
<p>起初，这只是一个源于朋友的拍立得相机带来的灵感。团队成员之一说：</p>
<blockquote>
<p>“我们有个朋友拥有一台真正的复古拍立得，我们非常喜欢它拍照的过程和感觉。但现实是，这种相机价格不低，我们也买不起。所以我们决定，自己动手，用代码造一台。”</p>
</blockquote>
<p>于是，Flashback 应运而生。它不仅解决了昂贵设备门槛的问题，还带来了如下几点价值：</p>
<ul>
<li>
<p><strong>让复古摄影零门槛：</strong> 只要有摄像头，人人都能免费体验拍立得的乐趣。</p>
</li>
<li>
<p><strong>模拟真实交互：</strong> 用户需要手动开机、取景、按快门，仿佛真的在用一台物理相机。</p>
</li>
<li>
<p><strong>还原显影过程：</strong> 照片从黑屏逐渐清晰，仅需短短 3 秒，却让人感受到等待的仪式感。</p>
</li>
<li>
<p><strong>提升情绪价值：</strong> 慢下来的一拍一显，比滤镜一键生成更值得珍藏。</p>
</li>
<li>
<p><strong>保留复古美感：</strong> 多种滤镜让照片更具“老照片”的质感。</p>
</li>
</ul>
<h3 data-id="heading-2"><strong>用到 TRAE 的能力</strong></h3>
<ul>
<li>
<p><strong>TRAE IDE 的 SOLO 模式：</strong> AI 辅助开发，帮助快速完成原型、生成代码，解决开发过程中遇到的各种问题。</p>
</li>
<li>
<p><strong>一键部署到 Vercel：</strong> 简化了部署流程，让应用快速上线。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e257b8a180374540a8284b971480b39c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=dIm1jsBeXzL57vzTO01cKybbODs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>架构设计：简单技术，完整体验</strong></h2>
<h3 data-id="heading-4"><strong>应用架构</strong></h3>
<p>Flashback 是一个纯前端构建的单页应用（SPA），技术栈非常轻量：</p>
<ul>
<li><strong>HTML + CSS + JavaScript：</strong> 不依赖大型框架，兼容性强，加载迅速。</li>
</ul>
<h3 data-id="heading-5"><strong>核心流程</strong></h3>
<ol>
<li>
<p><strong>权限获取</strong> - 用户点击电源按钮，授权使用摄像头</p>
</li>
<li>
<p><strong>实时预览</strong> - 视频流实时显示，可预览选中的滤镜效果</p>
</li>
<li>
<p><strong>图像捕获</strong> - 点击快门，将当前画面捕获到画布</p>
</li>
<li>
<p><strong>滤镜处理</strong> - 对图像应用滤镜并进行处理</p>
</li>
<li>
<p><strong>显影动画</strong> - 照片带着动画效果“弹出”，然后逐渐“显影”</p>
</li>
<li>
<p><strong>照片收藏</strong> - 用户可以把照片拖到钉板上收藏</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e275473036c440cda25d2b544cd114aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=8MhqrcWPNDoEg6jw2PV1NF1G2PU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>效果展示</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3af0ea6537844c38ec130b4e9644952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=xKDhZYOCdCEgtmpkkdm%2By5oSA7g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>在线体验</strong></h3>
<p><strong>在线演示地址：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fflashbackcamera.vercel.app%2F" target="_blank" title="https://flashbackcamera.vercel.app/" ref="nofollow noopener noreferrer">flashbackcamera.vercel.app/</a></p>
<h3 data-id="heading-8"><strong>主要功能展示</strong></h3>
<ul>
<li>
<p>相机开机动画和实时预览</p>
</li>
<li>
<p>四种复古滤镜：正常、柯达彩色、褪色哑光、8mm 胶片</p>
</li>
<li>
<p>照片弹出和显影动画效果</p>
</li>
<li>
<p>拖放式照片钉板</p>
</li>
<li>
<p>移动端响应式适配</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46c0a8b50434e5cb4910fe54c738f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=v5d7xM%2BGoJz%2BO6O5iGiyTqfW68Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>挑战与经验总结</strong></h2>
<h3 data-id="heading-10"><strong>遇到的技术难题</strong></h3>
<p><strong>1. 跨浏览器的摄像头权限问题</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> Chrome、Firefox 和 Safari 处理媒体权限的方式各不相同，很难做到统一体验。</p>
</li>
<li>
<p><strong>解决方案：</strong> 针对不同浏览器做了大量测试，并实现了多套后备方案来确保兼容性。</p>
</li>
</ul>
<p><strong>2. 实时滤镜的性能优化</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 需要在视频流上实时应用滤镜，同时保持 60fps 的流畅度，这对性能要求很高。</p>
</li>
<li>
<p><strong>解决方案：</strong> 经过测试发现，CSS 滤镜在实时预览场景下比 Canvas 滤镜性能更好，最终采用了 CSS 方案。</p>
</li>
</ul>
<p><strong>3. 拖放功能的实现</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 要让拖放功能在桌面端和移动端都能流畅使用，需要处理多种事件类型，还要阻止浏览器的默认行为。</p>
</li>
<li>
<p><strong>解决方案：</strong> 开发了自定义的拖放系统，统一处理不同设备的交互逻辑。</p>
</li>
</ul>
<h3 data-id="heading-11"><strong>遇到的设计难题</strong></h3>
<p><strong>4. 如何做出真实的复古感</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 既要有复古美学，又要保证现代用户的使用习惯，这两者之间很难平衡。</p>
</li>
<li>
<p><strong>解决方案：</strong> 在相机设计、动画效果和交互方式上反复打磨，最终找到了合适的平衡点。</p>
</li>
</ul>
<p><strong>5. 响应式 3D 效果的适配</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 3D 相机的视差效果需要在各种屏幕尺寸上都看起来自然，从小手机到大显示器都要兼顾。</p>
</li>
<li>
<p><strong>解决方案：</strong> 针对不同屏幕尺寸调整了 3D 效果参数，确保在各种设备上都有好的视觉体验。</p>
</li>
</ul>
<h3 data-id="heading-12"><strong>核心经验总结</strong></h3>
<h4 data-id="heading-13"><strong>用户体验永远是第一位的</strong></h4>
<p>比起实现多么高级的图像处理技术，让用户感受到怀旧氛围和流畅交互更重要</p>
<h4 data-id="heading-14"><strong>音效能大幅提升真实感</strong></h4>
<p>简单的音效就能让整个体验的真实度提升一大截</p>
<h3 data-id="heading-15"/>
<p>Flashback Camera 不只是一个玩具项目，它是一次关于“数字怀旧”的实验，也是对 Web 技术可玩性的一次精彩演绎。The Vibe Coders 团队用最朴素的技术，创造了最富情感的体验，令人眼前一亮。</p>
<p>在这个人人追求“效率最大化”的世界，这种带点仪式感和浪漫气息的小工具，反而更值得被记住。</p>
<p>期待未来，他们还能用代码带来更多“有温度”的创意项目。</p>
<h5 data-id="heading-16"><strong>更多项目展示：</strong></h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/881d17522ab24d1984883250c17dd350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=%2B58Jnx4pcX0K8xkoD2uvigu9LNk%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3792d10814094bab8148f0e1373c9948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=9gCLUmS%2BMQYzpJOpKls3XXwA%2BnY%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b827f3faf97140909172d44ed85aedab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=sW%2FGYj1XS2R0h5Ez0bgP6FC9wfE%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5490b380a8b4884bd316434d448e3c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=wg7VlmQElGYyGFJwDBxRzwxmcPM%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc7766b471d4049bde849fece7ae194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=d3pttTxQyIwcpRdZZtK8DZBjyyQ%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a557870b8c304aefab53bef75e4bc072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=dRqvfTDVLeKN75EoGnaw253iwBw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[gemini3手势互动圣诞树保姆级教程来了！附提示词]]></title>    <link>https://juejin.cn/post/7581545175508762676</link>    <guid>https://juejin.cn/post/7581545175508762676</guid>    <pubDate>2025-12-09T06:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581545175508762676" data-draft-id="7581486065996169251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="gemini3手势互动圣诞树保姆级教程来了！附提示词"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-09T06:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            gemini3手势互动圣诞树保姆级教程来了！附提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T06:31:29.000Z" title="Tue Dec 09 2025 06:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d0b888c054489cab9d69619cfc65e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=O8ZyRMXmGWkSDuPxtzU17mIet1Q%3D" alt="图片" loading="lazy"/></p>
<p>哈喽，大家好</p>
<p>我是阿星👋</p>
<p>破防了！谁还在画二维圣诞树？</p>
<p>Gemini3直接让大家用手势隔空操控3D世界！👇（提示词2000字完整版pinglun区我分享给大家）点击播放看效果👀</p>
<p>它主要实现的效果如下👇🏻</p>
<p>🌌隔空捏合，粒子瞬间聚焦到你上传的节日照片上</p>
<p>👋张开手掌 - 1500个金色粒子“砰”地炸开成星云</p>
<p>✊轻松握拳 - 粒子螺旋汇聚</p>
<p>🛰手部追踪 - 整个3D场景跟着你的手旋转！</p>
<h2 data-id="heading-0">第一步：复制这段提示词</h2>
<p>提示词放在这里了</p>
<p>发给gemini3的builder就可以啦</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ba7feafa4984ae191c15a4ec27f5651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=hJ5jT8080XPBbHq0M9BpVklXqnA%3D" alt="图片" loading="lazy"/></p>
<p>（提示词2000字完整版，pinglun区我分享给大家）</p>
<pre><code class="hljs language-typescript" lang="typescript">🚀 <span class="hljs-title class_">Prompt</span>:
角色设定： 
你是一位世界级的 <span class="hljs-title class_">Creative</span> <span class="hljs-title class_">Technologist</span>，精通 <span class="hljs-title class_">Three</span>.<span class="hljs-property">js</span> (<span class="hljs-title class_">WebGL</span>)、<span class="hljs-variable constant_">GLSL</span> 着色器逻辑以及 <span class="hljs-title class_">Google</span> <span class="hljs-title class_">MediaPipe</span> 计算机视觉集成。
任务目标： 
请编写一个单文件 ( <span class="hljs-title class_">Single</span>-<span class="hljs-title class_">File</span> )  的 <span class="hljs-variable constant_">HTML</span> 项目，文件名为圣诞树。该项目必须包含完整的 <span class="hljs-variable constant_">HTML</span> 结构、<span class="hljs-variable constant_">CSS</span> 样式和基于 <span class="hljs-variable constant_">ES</span> <span class="hljs-title class_">Module</span> 的 <span class="hljs-title class_">JavaScript</span> 代码。
核心技术栈约束 (必须严格遵守)： 
依赖管理：  使用 &lt;script <span class="hljs-keyword">type</span>=<span class="hljs-string">"importmap"</span>&gt; 引入：
<span class="hljs-attr">three</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js</span>
three/addons/: <span class="hljs-attr">https</span>:<span class="hljs-comment">//cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/</span>
<span class="hljs-meta">@mediapipe</span>/tasks-<span class="hljs-attr">vision</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm</span>
代码风格：  使用现代 <span class="hljs-title class_">ES6</span>+ 语法，类 (<span class="hljs-title class_">Class</span>) 结构管理粒子，异步/等待 (<span class="hljs-title class_">Async</span>/<span class="hljs-title class_">Await</span>) 处理加载。
📝 详细开发规格说明书
<span class="hljs-number">1.</span> <span class="hljs-variable constant_">UI</span> 设计与 <span class="hljs-variable constant_">CSS</span> 样式 (<span class="hljs-title class_">Visual</span> <span class="hljs-title class_">Identity</span>)
字体：  引入 <span class="hljs-title class_">Google</span> <span class="hljs-title class_">Fonts</span> <span class="hljs-string">'Cinzel'</span> (标题) 和 <span class="hljs-string">'Times New Roman'</span> (正文)。
配色：  背景 #<span class="hljs-number">000000</span>。主色调：香槟金 #d4af37，奶油白 #fceea7。
<span class="hljs-variable constant_">UI</span> 组件： 
<span class="hljs-title class_">Loader</span> ：  黑色全屏遮罩，中间为 40px 的金色旋转 <span class="hljs-title class_">Spinner</span> (border-<span class="hljs-attr">top</span>: 1px solid #d4af37)，下方文字 <span class="hljs-string">"LOADING HOLIDAY MAGIC"</span>。初始化完成后淡出。
标题：  顶部居中 &lt;h1&gt; <span class="hljs-string">"Merry Christmas"</span>，字号 56px，使用 <span class="hljs-variable constant_">CSS</span> linear-gradient (白到金) 实现文字渐变色，并加辉光阴影。
上传控件：  一个带有 .<span class="hljs-property">upload</span>-wrapper 类的容器。按钮样式为半透明磨砂玻璃 (backdrop-<span class="hljs-attr">filter</span>: blur)，边框金色，文字 <span class="hljs-string">"ADD MEMORIES"</span>。
提示文本：  按钮下方显示 <span class="hljs-string">"Press 'H' to Hide Controls"</span>。
隐藏逻辑：  定义 <span class="hljs-variable constant_">CSS</span> 类 .<span class="hljs-property">ui</span>-hidden (<span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>; pointer-<span class="hljs-attr">events</span>: none)。监听键盘 H 键切换此状态。
<span class="hljs-title class_">Webcam</span> ：  在右下角创建一个不可见的容器 (<span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>)，包含 &lt;video&gt; 和 160x120 的 &lt;canvas&gt; 用于 <span class="hljs-variable constant_">CV</span> 推理。
<span class="hljs-number">2.</span> <span class="hljs-title class_">Three</span>.<span class="hljs-property">js</span> 场景构建 (<span class="hljs-title class_">Scene</span> <span class="hljs-title class_">Setup</span>)
渲染器：  <span class="hljs-title class_">WebGLRenderer</span> (<span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>)，toneMapping 设置为 <span class="hljs-title class_">ReinhardToneMapping</span> (曝光 <span class="hljs-number">2.2</span>)。
相机：  透视相机，位置 (<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">50</span>)。
环境 ( <span class="hljs-title class_">Environment</span> )：  使用 <span class="hljs-title class_">RoomEnvironment</span> 配合 <span class="hljs-title class_">PMREMGenerator</span> 生成高反射金属环境贴图。
后期处理 ( <span class="hljs-title class_">Post</span>-<span class="hljs-title class_">Processing</span> )： 
使用 <span class="hljs-title class_">EffectComposer</span>。
添加 <span class="hljs-title class_">UnrealBloomPass</span> (辉光特效)。参数必须为：  resolution (<span class="hljs-variable language_">window</span> size), <span class="hljs-attr">strength</span>: <span class="hljs-number">0.45</span>, <span class="hljs-attr">radius</span>: <span class="hljs-number">0.4</span>, <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.7</span>。
灯光系统： 
<span class="hljs-title class_">AmbientLight</span> (<span class="hljs-number">0.6</span>)。
内部 <span class="hljs-title class_">PointLight</span> (橙色, 强度 <span class="hljs-number">2</span>)。
<span class="hljs-title class_">SpotLight</span> (金色, 强度 <span class="hljs-number">1200</span>, 位置 <span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">40</span>)。
<span class="hljs-title class_">SpotLight</span> (蓝色, 强度 <span class="hljs-number">600</span>, 位置 -<span class="hljs-number">30</span>,<span class="hljs-number">20</span>,-<span class="hljs-number">30</span>) 用于冷暖对比。
<span class="hljs-number">3.</span> 粒子系统与内容 (<span class="hljs-title class_">Content</span> <span class="hljs-title class_">Generation</span>)
粒子总数：  约 <span class="hljs-number">1500</span> 个主体粒子 + <span class="hljs-number">2500</span> 个尘埃粒子。
几何体混合： 
<span class="hljs-title class_">BoxGeometry</span> :  材质为金色和深绿色 <span class="hljs-title class_">MeshStandardMaterial</span>。
<span class="hljs-title class_">SphereGeometry</span> :  材质为金色和红色 <span class="hljs-title class_">MeshPhysicalMaterial</span> (红色带 clearcoat)。
<span class="hljs-title class_">Candy</span> <span class="hljs-title class_">Cane</span> (糖果手杖):  使用 <span class="hljs-title class_">CatmullRomCurve3</span> 生成弯钩路径，配合 <span class="hljs-title class_">TubeGeometry</span>。必须程序化生成纹理：使用 <span class="hljs-title class_">Canvas</span> 2D <span class="hljs-variable constant_">API</span> 绘制白底红斜纹，创建 <span class="hljs-title class_">CanvasTexture</span>。
照片墙功能： 
默认生成一张写有 <span class="hljs-string">"JOYEUX NOEL"</span> 的 <span class="hljs-title class_">Canvas</span> 纹理照片。
照片必须包裹在金色的相框 (<span class="hljs-title class_">BoxGeometry</span>) 中。
图片上传实现（必须精确复现以下代码逻辑）： 
codeJavaScript
<span class="hljs-comment">// 监听 input change 事件</span>
reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">ev</span>) =&gt;</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>().<span class="hljs-title function_">load</span>(ev.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>, <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> {
        t.<span class="hljs-property">colorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">SRGBColorSpace</span>; <span class="hljs-comment">// 关键：指定色彩空间</span>
        <span class="hljs-title function_">addPhotoToScene</span>(t);
    });
}
reader.<span class="hljs-title function_">readAsDataURL</span>(f);
<span class="hljs-number">4.</span> 状态机与动画逻辑 (<span class="hljs-title class_">State</span> <span class="hljs-title class_">Machine</span> &amp; <span class="hljs-title class_">Logic</span>)
定义全局 <span class="hljs-variable constant_">STATE</span> 对象，包含模式 (mode) 和手势数据。在 animate 循环中根据模式计算目标位置并使用 lerp 平滑过渡。
<span class="hljs-title class_">Mode</span> <span class="hljs-number">1</span> : <span class="hljs-variable constant_">TREE</span> (树模式) 
粒子排列成螺旋圆锥体。公式参考：radius = maxRadius * (<span class="hljs-number">1</span> - t), angle = t * <span class="hljs-number">50</span> * <span class="hljs-variable constant_">PI</span>.
<span class="hljs-title class_">Mode</span> <span class="hljs-number">2</span> : <span class="hljs-variable constant_">SCATTER</span> (散落模式) 
粒子分布在半径 <span class="hljs-number">8</span>~<span class="hljs-number">20</span> 的球体范围内。
重要：  在此模式下，粒子必须根据自身的随机速度向量进行自转 (<span class="hljs-title class_">Rotation</span>)。
<span class="hljs-title class_">Mode</span> <span class="hljs-number">3</span> : <span class="hljs-variable constant_">FOCUS</span> (聚焦模式) 
随机选中一张照片 (<span class="hljs-keyword">type</span> === <span class="hljs-string">'PHOTO'</span>) 作为目标。
目标照片移动到相机前方 (<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">35</span>) 并放大 (<span class="hljs-title class_">Scale</span> <span class="hljs-number">4.5</span>)。
其他粒子作为背景散开。
<span class="hljs-number">5.</span> <span class="hljs-title class_">MediaPipe</span> 计算机视觉集成 (<span class="hljs-title class_">Computer</span> <span class="hljs-title class_">Vision</span>)
模型加载：  使用 <span class="hljs-title class_">FilesetResolver</span> 和 <span class="hljs-title class_">HandLandmarker</span>。设置 <span class="hljs-attr">delegate</span>: <span class="hljs-string">"GPU"</span>。
手势识别算法 ( <span class="hljs-title class_">Process</span> <span class="hljs-title class_">Gestures</span> )： 
获取关键点：拇指(<span class="hljs-number">4</span>), 食指(<span class="hljs-number">8</span>), 手腕(<span class="hljs-number">0</span>), 其他指尖(<span class="hljs-number">12</span>,<span class="hljs-number">16</span>,<span class="hljs-number">20</span>)。
<span class="hljs-title class_">Pinch</span> (捏合)：  <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(thumb - index) &lt; <span class="hljs-number">0.05</span> -&gt; 触发 <span class="hljs-variable constant_">FOCUS</span> 模式。
<span class="hljs-title class_">Fist</span> (握拳)：  四指尖到手腕平均距离 &lt; <span class="hljs-number">0.25</span> -&gt; 触发 <span class="hljs-variable constant_">TREE</span> 模式。
<span class="hljs-title class_">Open</span> <span class="hljs-title class_">Hand</span> (张开)：  四指尖到手腕平均距离 &gt; <span class="hljs-number">0.4</span> -&gt; 触发 <span class="hljs-variable constant_">SCATTER</span> 模式。
交互映射： 
将手掌中心 (<span class="hljs-title class_">Landmark</span> <span class="hljs-number">9</span>) 的标准化 X/Y 坐标，映射为 3D 场景根容器 (mainGroup) 的 rotation.<span class="hljs-property">y</span> 和 rotation.<span class="hljs-property">x</span>。
请输出完整的、包含所有这些细节的单文件 <span class="hljs-variable constant_">HTML</span> 代码。 
</code></pre>

<pre><code class="hljs language-ruby" lang="ruby">🚀 <span class="hljs-title class_">Prompt</span>:  <span class="hljs-string">"  Christmas Tree"</span> <span class="hljs-title class_">Web</span>GL 互动项目角色设定：你是一位世界级的 <span class="hljs-title class_">Creative</span> <span class="hljs-title class_">Technologist</span>，精通 <span class="hljs-title class_">Three</span>.js (<span class="hljs-title class_">Web</span>GL)、<span class="hljs-variable constant_">GLSL</span> 着色器逻辑以及 <span class="hljs-title class_">Google</span> <span class="hljs-title class_">MediaPipe</span> 计算机视觉集成。任务目标：请编写一个单文件 (<span class="hljs-title class_">Single</span>-<span class="hljs-title class_">File</span>) 的 <span class="hljs-variable constant_">HTML</span> 项目，文件名为  <span class="hljs-title class_">Christmas</span>   <span class="hljs-title class_">Tree</span>   代码。该项目必须包含完整的 <span class="hljs-variable constant_">HTML</span> 结构、<span class="hljs-variable constant_">CSS</span> 样式和基于 <span class="hljs-variable constant_">ES</span> <span class="hljs-title class_">Module</span> 的 <span class="hljs-title class_">JavaScript</span> 代码。核心技术栈约束 (必须严格遵守)：依赖管理： 使用 &lt;script type=<span class="hljs-string">"importmap"</span>&gt; 引入：<span class="hljs-symbol">three:</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/cdn.jsdelivr.net/npm</span><span class="hljs-regexp">/three@0.160.0/build</span><span class="hljs-regexp">/three.module.jsthree/addons</span><span class="hljs-regexp">/: https:/</span><span class="hljs-regexp">/cdn.jsdelivr.net/npm</span><span class="hljs-regexp">/three@0.160.0/examples</span><span class="hljs-regexp">/jsm/</span><span class="hljs-variable">@mediapipe</span>/tasks-<span class="hljs-symbol">vision:</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/cdn.jsdelivr.net/npm</span><span class="hljs-regexp">/@mediapipe/tasks</span>-vision<span class="hljs-variable">@0</span>.<span class="hljs-number">10.3</span>/+esm代码风格： 使用现代 <span class="hljs-variable constant_">ES6</span>+ 语法，类 (<span class="hljs-title class_">Class</span>) 结构管理粒子，异步/等待 (<span class="hljs-title class_">Async</span>/<span class="hljs-title class_">Await</span>) 处理加载。📝 详细开发规格说明书<span class="hljs-number">1</span>. <span class="hljs-variable constant_">UI</span> 设计与 <span class="hljs-variable constant_">CSS</span> 样式 (<span class="hljs-title class_">Visual</span> <span class="hljs-title class_">Identity</span>)字体： 引入 <span class="hljs-title class_">Google</span> <span class="hljs-title class_">Fonts</span> <span class="hljs-string">'Cinzel'</span> (标题) 和 <span class="hljs-string">'Times New Roman'</span> (正文)。配色： 背景 <span class="hljs-comment">#000000。主色调：香槟金 #d4af37，奶油白 #fceea7。UI 组件：Loader： 黑色全屏遮罩，中间为 40px 的金色旋转 Spinner (border-top: 1px solid #d4af37)，下方文字 "LOADING HOLIDAY MAGIC"。初始化完成后淡出。标题： 顶部居中 &lt;h1&gt; "Merry Christmas"，字号 56px，使用 CSS linear-gradient (白到金) 实现文字渐变色，并加辉光阴影。隐藏逻辑： 定义 CSS 类…………</span>
</code></pre>
<p>注意：这些要素一定要保留提示词里的精华给AI看，这些不要删👇🏻</p>
<p>角色：你是精通Three.js和MediaPipe的前端专家</p>
<p>视觉：极简奢华，用Cinzel和Times New Roman字体</p>
<p>核心：一定要用@mediapipe/tasks-vision做手势识别</p>
<p>功能：捏合→聚焦照片，张开→散开，握拳→聚合成树</p>
<p>这些是一定要保留的不能从提示词里删除</p>
<h2 data-id="heading-1">第二步：在chrome中执行</h2>
<p>打开Gemini3（或其他支持长文本的AI）</p>
<p>粘贴完整的提示词</p>
<p>等待AI生成一个完整的HTML文件代码</p>
<p>将AI生成的代码保存为 christmas_tree.html</p>
<p>（你可以自己命名）</p>
<p>在浏览器中双击打开</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7784016e3eb34bfaa0740a044d309d61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=KqLWFZHbFIq2k%2FkUTBnie75aHDo%3D" alt="图片" loading="lazy"/></p>
<p>允许网页使用你的摄像头✅才能进行手势识别</p>
<p>见证奇迹：你的手现在就是遥控器！</p>
<h2 data-id="heading-2">第三步：手势圣诞树原理揭秘</h2>
<h4 data-id="heading-3">视觉核心：Three.js + PBR 材质系统</h4>
<blockquote>
<p><strong>“不是画出来的，是算出来的奢华感。”</strong></p>
</blockquote>
<ul>
<li><strong>技术点：</strong>  使用 WebGL 的封装库 <strong>Three.js (r160)</strong>  。</li>
<li><strong>亮点：</strong>   <strong>PBR (Physically Based Rendering) 物理材质全线使用</strong> </li>
<li>通过 <code>MeshStandard</code> 和 <code>MeshPhysical</code>，让“金子”拥有真实的金属反射率（Metalness）和粗糙度（Roughness）。</li>
<li><strong>环境光照：</strong>  利用—— <code>RoomEnvironment</code> 和 <code>PMREMGenerator</code> 生成高动态范围的环境贴图，让每一颗粒子都能反射出周围并不存在的“虚拟豪宅”光影。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b957ac62703948e486c376404a286dab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=1G1JQluKaCdLy0FP1naO6R7CYA0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-4">氛围营造：后期处理 (Post-Processing)</h4>
<blockquote>
<p><strong>“给代码加一层好莱坞滤镜。”</strong></p>
</blockquote>
<ul>
<li>• <strong>技术点：</strong>  Three.js 的特效合成器 <strong>EffectComposer</strong> 。</li>
<li>• <strong>核心特效：</strong> <strong>UnrealBloomPass (虚幻辉光)</strong>  。</li>
<li>• <strong>原理：</strong>  这不仅仅是简单的发光，而是模拟摄像机镜头的过曝效果。提取场景中的高亮阈值（Threshold），进行高斯模糊后叠加，才有了那层梦幻的“香槟金光晕”。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df517078b0b943fd96b8fda822abf296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=hV9w%2FJ0Uc4CuY5e%2F0LeALzP1inc%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-5">交互大脑：Google MediaPipe (Edge AI)</h4>
<blockquote>
<p><strong>“把浏览器变成《少数派报告》。”</strong></p>
</blockquote>
<ul>
<li>• <strong>技术点：</strong>  Google 的 <strong>MediaPipe Tasks Vision (@0.10.3)</strong>  。</li>
<li>• <strong>亮点：</strong> <strong>纯前端推理</strong> 。不需要任何后端服务器，直接利用 WebAssembly (WASM) 调用本地 GPU，在浏览器里实时进行手部 21 个关键点的 3D 追踪。</li>
<li>• <strong>逻辑：</strong>  计算指尖距离，将“捏合”、“张开”、“握拳”等手势映射为粒子系统的状态机触发器。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b991e4455c0948a990c3d101d124357a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=R7R4garGK3y925X5QpF3EOCjdGI%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-6">数学之美：粒子系统与插值算法</h4>
<blockquote>
<p><strong>“秩序与混沌的数学表达。”</strong></p>
</blockquote>
<ul>
<li>• <strong>技术点：</strong>  自定义粒子类与 <strong>Lerp (线性插值)</strong>  。</li>
<li>• <strong>实现：</strong>  1500 个粒子并不是生硬地瞬移。我们为每个粒子定义了“树形态”和“星云形态”两套坐标系。在状态切换时，通过 <code>Vector3.lerp()</code> 函数，让粒子在每一帧之间平滑过渡，实现了如同流体般的变形效果。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34c0541f64d4e58b2350dc97a399dfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=tOIhlNHRYsk8fLKOCJxrKKC7Ajw%3D" alt="图片" loading="lazy"/></p>
<p>快去试试吧～给对象做一个～🌝🌝绝对是好感度拉满～</p>
<p>没对象的给自己做一个～😂</p>
<p>我是阿星！更多AI应用</p>
<p>我们下期再见👋</p>
<p> </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26232a26b484b32a9c3b80426327eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765866689&amp;x-signature=%2FJ5rrqOt4pMxiUZ5p4er0lkSAwg%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Grab实践 ｜ 记一次与Cursor的有趣对话]]></title>    <link>https://juejin.cn/post/7581314241410990115</link>    <guid>https://juejin.cn/post/7581314241410990115</guid>    <pubDate>2025-12-08T16:47:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581314241410990115" data-draft-id="7581297335315365940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Grab实践 ｜ 记一次与Cursor的有趣对话"/> <meta itemprop="keywords" content="Cursor,前端"/> <meta itemprop="datePublished" content="2025-12-08T16:47:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SakuraOnTheWay"/> <meta itemprop="url" content="https://juejin.cn/user/3035112839343709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Grab实践 ｜ 记一次与Cursor的有趣对话
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035112839343709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SakuraOnTheWay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T16:47:12.000Z" title="Mon Dec 08 2025 16:47:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>被社区中的大佬推荐React Grab，于是今天上班赶紧在项目中实践了一下！总结来说，这个工具还是很好用的！但最值得记录的还是和cursor的对话过程！</p>
</blockquote>
<h2 data-id="heading-0">1. What is react-grab?</h2>
<p>React Grab是一个开发工具，用于在React应用中为AI助手（如Cursor、Claude Code）提供上下文。</p>
<p><strong>核心功能：</strong></p>
<ol>
<li>元素抓取：按住 ⌘C（Mac）或 Ctrl+C（Windows/Linux）并点击页面元素</li>
<li>视觉上下文：自动捕获该元素的截图和相关信息</li>
<li>AI 集成：将上下文直接提供给 Cursor 或其他 AI 助手</li>
</ol>
<h2 data-id="heading-1">2. 参考文档</h2>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.react-grab.com%2F" target="_blank" title="https://www.react-grab.com/" ref="nofollow noopener noreferrer">www.react-grab.com/</a></li>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidenybai%2Freact-grab" target="_blank" title="https://github.com/aidenybai/react-grab" ref="nofollow noopener noreferrer">github.com/aidenybai/r…</a></li>
<li>掘金博客：<a href="https://juejin.cn/post/7576843726011908122" target="_blank" title="https://juejin.cn/post/7576843726011908122">别再当 AI 的"人肉定位器"了：一个工具让 React/Vue组件秒定位</a></li>
</ul>
<h2 data-id="heading-2">3. 安装</h2>
<h3 data-id="heading-3">3.1 Cursor install</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2498c29307644cc9bc6ba4510f437c46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=hkUn0PC5fnQiqRn5Lqeng2pqRp0%3D" alt="截屏2025-12-08 23.40.31.png" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 脚本注入</h3>
<p>因为我是<code>Next.js</code>项目，所以写在<code>_document.js</code>里面</p>
<pre><code class="hljs language-js" lang="js">&lt;script
  src=<span class="hljs-string">"//unpkg.com/react-grab/dist/index.global.js"</span>
  crossorigin=<span class="hljs-string">"anonymous"</span>
  data-enabled=<span class="hljs-string">"true"</span>
&gt;&lt;/script&gt;

</code></pre>
<p>控制台和network有<code>react grab</code>的内容就表示可以了，就是这么简单。</p>
<h2 data-id="heading-5">4. 实践开始</h2>
<h3 data-id="heading-6">4.1 一个UI简单的项目 --- Next.js项目</h3>
<p>这个项目的UI组成比较简单，两部分组成：1. 搜索bar；2. 长列表。长列表里面有不定高的卡片（代表商品信息），卡片上有商品标题，商品标题是我本次grab的内容。</p>
<p>我copy的内容长这样：</p>
<pre><code class="hljs language-js" lang="js">&lt;span&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">...</span>&gt;</span>
    比奇堡呆呆鱼玩偶挂件(现货出售）
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">ProductCard</span> (at /.<span class="hljs-property">components</span>/<span class="hljs-title class_">ProductCard</span>.<span class="hljs-property">js</span>:<span class="hljs-number">92</span>:<span class="hljs-number">35</span>)
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">ProductList</span> (at /.<span class="hljs-property">components</span>/<span class="hljs-title class_">ProductList</span>.<span class="hljs-property">js</span>:<span class="hljs-number">41</span>:<span class="hljs-number">26</span>)
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">ProductPage</span> (at /.<span class="hljs-property">page</span>/index.<span class="hljs-property">js</span>: <span class="hljs-number">136</span>:<span class="hljs-number">207</span>)
</code></pre>
<h4 data-id="heading-7">对话1：通过我Copy的内容，你能获取到哪些信息？</h4>
<p>Cursor回答：</p>
<pre><code class="hljs language-js" lang="js">从你复制的内容，我可以得到以下信息：

<span class="hljs-number">1.</span> 元素信息
元素类型：产品名称链接
显示内容：<span class="hljs-string">"比奇堡呆呆鱼玩偶挂件(现货出售）"</span>
<span class="hljs-variable constant_">HTML</span> 结构：&lt;span&gt; 包裹的 &lt;a&gt; 标签

<span class="hljs-number">2.</span> 组件调用链（<span class="hljs-title class_">React</span> 组件层级）
<span class="hljs-title class_">ProductPage</span> (商品列表页面)
  └── <span class="hljs-title class_">ProductList</span> (商品列表组件)
      └── <span class="hljs-title class_">ProductCard</span> (商品卡片组件)
          └── 你选中的元素 (商品名称)

<span class="hljs-number">3.</span> 代码位置
文件：components/<span class="hljs-title class_">ProductCard</span>.<span class="hljs-property">js</span>
行号：第 <span class="hljs-number">92</span> 行，第 <span class="hljs-number">25</span> 列
具体代码：
&lt;div className=<span class="hljs-string">'product-name'</span>&gt;
    &lt;span&gt;
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/${<span class="hljs-attr">productId</span>}<span class="hljs-attr">.html</span>`}
            <span class="hljs-attr">className</span>=<span class="hljs-string">'js_a_seo'</span>
            <span class="hljs-attr">title</span>=<span class="hljs-string">{productName}</span>
        &gt;</span>
 {productName}  // ← 这就是你选中的内

 4. 功能推断
这是商品列表页中的商品名称链接
点击会跳转到商品详情页：/${productId}.html
使用了 SEO 相关的 class：js_a_seo
数据来源：productName 属性

5. 可以帮你做什么
- 修改商品名称的样式
- 调整链接跳转逻辑
- 修改商品名称的显示格式
- 添加点击事件处理
- 调试商品名称相关的 bug

需要我帮你修改这个元素吗？比如样式、跳转逻辑或其他功能？
</span></code></pre>
<p>本来我想问：你获取了这些信息能帮我做什么？没想到它直接抢答了...nice!</p>
<h4 data-id="heading-8">对话2：我希望你能我修改商品名称的颜色为红色</h4>
<p>cursor是这么做的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ea1f8c5fe641cab1d9797ec91506cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=j808nSG5MFjTi7zeksahqyF5CMc%3D" alt="image.png" loading="lazy"/></p>
<p>确实也实现了我想要的效果。公司项目，所以不放图了。</p>
<h3 data-id="heading-9">4.2 一个复杂的项目 --- Taro多端项目 &amp; 组件层级多且深</h3>
<p>我找了一个比较复杂的元素进行grab：商品详情卡片上面的商品描述信息，描述的信息像是退货政策</p>
<p>copy出来的信息是这样的：</p>
<p>注意：<code>ProductDetailList</code>并不是渲染该元素的组件，渲染该元素的组件实际是<code>ProductDetailList/ProductDetailCard/TagList</code></p>
<pre><code class="hljs language-js" lang="js">&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">'page-view list-view'</span>&gt;
<span class="hljs-number">7</span>天无理由退货
&lt;/div&gt;
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">ProductDetailList</span> (at ./detail/modules/<span class="hljs-title class_">Firstscreen</span>/<span class="hljs-title class_">ProductDetailModule</span>/<span class="hljs-title class_">Components</span>/<span class="hljs-title class_">ProductDetailList</span>.<span class="hljs-property">js</span>)
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">DetailList</span> (at ./detail/modules/<span class="hljs-title class_">Firstscreen</span>/<span class="hljs-title class_">ProductDetailModule</span>/<span class="hljs-title class_">Components</span>/<span class="hljs-title class_">DetailList</span>.<span class="hljs-property">js</span>)
    <span class="hljs-keyword">in</span> <span class="hljs-title class_">ScrollTargetInner</span> (at ./detail/<span class="hljs-title class_">Components</span>/<span class="hljs-title class_">ScrollTargetInner</span>.<span class="hljs-property">js</span>)
</code></pre>
<p>根据copy出来的信息，不难预见：<strong>Cursour分析错了！</strong>，它定位到了<code>ProductDetailList</code>组件的子组件<code>ReturnPolicy</code>组件的位置。</p>
<p>我告诉Cursor正确的位置并询问：你分析错了，正确的位置是：xxx.tsx</p>
<h4 data-id="heading-10">对话3: 我想知道是什么干扰了你？</h4>
<p>cursor回答我说：</p>
<ul>
<li>根本原因：1. grab的层级太少了，只有3层；2. 没有明确的className，无法直接定位</li>
<li>其余原因：1. 文案有误导，看到了“七天无理由退货”的字样，就联想到了<code>ReturnPolicy</code>组件；2. 没有仔细看代码，没有深入追踪数据处理逻辑。</li>
</ul>
<p>看了这些原因，我能理解它，哈哈。</p>
<p><strong>解决方案1: 能否修改配置，拿到完整的组件层级？</strong></p>
<p>实际在grab时，能够读到grab元素对应的组件，但是copy的内容却不是最后一层，这个还需要继续研究原因。</p>
<p><strong>解决方案2: 增加额外的描述信息，增强Cursor的判断？</strong></p>
<p>于是我问Cursor，我是一个刚接触这个项目的新手，面对复杂项目，</p>
<h4 data-id="heading-11">对话4: 除了react-grab抓取的信息，你还希望我提供哪些有效信息来增强你的判断？</h4>
<p>Cursor给出以下回答：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5cdc59dea6b4d86a576e974421b673f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=Hh4UZhdRQL0yU297hD4cfs2jAq8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbcedc7522884df0b549eee5512f17c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=qHyzx1TvlTgpzTtvyXkmzwnYXJM%3D" alt="image.png" loading="lazy"/></p>
<p>我看到提到了className，这确实是定位元素的一个最好的方法之一。But...</p>
<h4 data-id="heading-12">对话5: 项目中缺失className是不是会影响你的判断？因为项目目前采用的是css in js，所以非必要没有className了</h4>
<p>针对这个问题，Cursor是这么说的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/535bf769ade6484c98d3d34e5a6bbdc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=asB0NC5IqeBu793gItXSLEmDvAY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5005ad53ed246a3824a3aa93d8bb1c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765817232&amp;x-signature=dmHz9gdqPj84gPNRE0WNt55sssE%3D" alt="image.png" loading="lazy"/></p>
<p>真的很会反思了。</p>
<p>在此基础之上，我又找了几个层级比较深的元素，它都能顺利找到。我要求它把标签的背景色改为红色，它也做到了！表现不错～</p>
<h2 data-id="heading-13">5. 总结</h2>
<p>与AI对话是一门艺术，也是一门学问。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[验证码对抗史]]></title>    <link>https://juejin.cn/post/7582016579857678370</link>    <guid>https://juejin.cn/post/7582016579857678370</guid>    <pubDate>2025-12-10T10:38:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579857678370" data-draft-id="7582016579857645602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="验证码对抗史"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T10:38:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            验证码对抗史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T10:38:26.000Z" title="Wed Dec 10 2025 10:38:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">验证码对抗史：从"识别扭曲文字"到"证明你不是机器人"——一场人类与机器人的"猜谜大赛"</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fm.ithome.com%2Fhtml%2F799148.htm" target="_blank" title="https://m.ithome.com/html/799148.htm" ref="nofollow noopener noreferrer">2024年，苏黎世联邦理工学院的AI团队宣布了一个让互联网安全界震惊的消息：他们开发的系统能以100%的成功率破解谷歌的传统验证码。</a><a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7460820230969819648%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7460820230969819648/?upstream_biz=doubao" ref="nofollow noopener noreferrer">与此同时，桂林某景区票务系统被AI攻击，黑客利用AI破解验证码的成功率高达83.4%，导致数千张门票被恶意抢购。</a>这两个事件再次证明，网络世界的"门卫"——验证码，正面临前所未有的挑战🛡️。验证码就像互联网界的婆媳关系——永远在互相试探底线。</p>
<p><a href="https://juejin.cn/post/7430724129051230227" target="_blank" title="https://juejin.cn/post/7430724129051230227">从2000年Luis von Ahn发明字符验证码至今，这场"人机攻防战"已经持续了25年。如今，全球验证码市场规模已达30.79亿美元。</a>而<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.shturl.cc%2F22e2c06a38d9a28f9533507a60165a66" target="_blank" title="http://www.shturl.cc/22e2c06a38d9a28f9533507a60165a66" ref="nofollow noopener noreferrer">谷歌的reCAPTCHA占据了99.92%的份额。</a>但随着AI技术的飞速发展，验证码这个"网络世界的相亲介绍"——证明"你是个有趣的人类"而非冰冷的机器——正在经历前所未有的进化。</p>
<h3 data-id="heading-1">老花镜门卫的叛逆期👓（2000-2010）：字符验证码的黄金时代</h3>
<p>2000年，当Luis von Ahn发明第一代字符验证码时，他可能没想到这个小小的发明会成为互联网安全的基石。当时的验证码很简单：把几个扭曲的字母数字放在一起，让用户识别。就像小区门口那位总把快递员认成亲戚的老花镜门卫，虽然视力不太好，但总能分辨出熟人和陌生人🔍。</p>
<p>第一代验证码的原理很简单：计算机可以轻松生成扭曲的字符（仿佛被猫踩过的键盘输出），但当时的AI很难识别它们。这种"机器难，人类易"的设计理念，成为了验证码的黄金法则。就像让你在模糊的照片中认出老朋友，虽然有点费劲，但还是能做到；而对机器来说，这简直比在雾霾天找快递单号还难。（虚构对比：人类识别成功率82% vs 猫识别成功率95%（猫：这很简单））</p>
<p>然而，好景不长。随着AI技术的发展，特别是机器学习算法的进步，字符验证码开始变得不再安全。2014年，谷歌宣布将reCAPTCHA升级到v2版本，标志着字符验证码时代的终结。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fm.qikan.cqvip.com%2FArticle%2FArticleDetail%3Fid%3D7111337073" target="_blank" title="http://m.qikan.cqvip.com/Article/ArticleDetail?id=7111337073" ref="nofollow noopener noreferrer">根据网络安全实验室2025年报告，AI破解传统字符验证码的成功率已达98.7%。</a>而<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F906259516_121956424" target="_blank" title="https://www.sohu.com/a/906259516_121956424" ref="nofollow noopener noreferrer">人类平均需要15.3秒才能完成识别。</a></p>
<h3 data-id="heading-2">行为观察哨：从"你瞅啥"到"我瞅你咋地"🕵️‍♂️（2010-2020）</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_68994939%2Farticle%2Fdetails%2F131476509" target="_blank" title="https://blog.csdn.net/weixin_68994939/article/details/131476509" ref="nofollow noopener noreferrer">2014年，谷歌推出reCAPTCHA v2，彻底改变了验证码的形态。新的验证码不再仅仅让用户识别扭曲的字符，而是引入了"我不是机器人"的复选框——这就像薛定谔的验证——不点不知道自己是不是机器人，点了更怀疑人生。这就像小区门卫不再只看脸，而是开始观察你的行为举止——走路姿势、说话方式，以此判断你是否属于这个社区🔍。以极验验证的滑动拼图为例，用户需拖动滑块将残缺部分补全，这种"动作验证"将破解成本从0.1美元/千次提升至5美元/千次。</a></p>
<p>reCAPTCHA v2的工作原理是分析用户的行为特征：鼠标移动轨迹、点击位置、页面滚动速度等。这些细微的行为差异，对人类来说微不足道，但对AI来说却是难以模仿的。就像相亲时，对方不仅看你的外貌，还会观察你的言谈举止，以此判断你是否是"合适的人类"。</p>
<p>2018年，谷歌再次升级reCAPTCHA到v3版本，完全取消了用户交互。这个版本就像小区里的隐形保安，像侦探小说里的卧底一样默默观察你的一举一动，给你打分却不打扰你——你甚至不知道自己正在接受验证。reCAPTCHA v3会给每个用户一个0.0到1.0的分数，根据你的行为特征判断你是人类还是机器人🤖。</p>
<p>reCAPTCHA v3通过5个维度评分：鼠标轨迹混沌度（0.2权重）、页面停留时间（0.3权重）、点击热区分布（0.2权重）、浏览器指纹完整性（0.15权重）、历史行为一致性（0.15权重），综合生成0.0-1.0的风险分数</p>
<h3 data-id="heading-3">AI指纹识别🔬（2020-2025）：生物特征的时代</h3>
<p>随着AI技术的不断进步，传统的行为验证也开始面临挑战。2025年，生物特征融合方案成为验证码的新趋势。</p>
<p>这种方案就像科幻电影中的身份识别系统，通过分析你的生物特征来确认你的"人类身份"🔐。</p>
<p>生物特征验证码利用了人类独一无二的生理特征，如指纹、面部识别、声纹等。这些特征对AI来说很难模仿，因为它们包含了大量细微的生理细节。就像人类可以通过面部特征轻松识别他人，生物特征验证码也能通过这些"生物指纹"来区分人类和AI。当系统要求你"微笑验证"时，终于明白为什么演员都去考验证码认证了。</p>
<p>除了生理特征，行为生物特征也成为验证码的新宠。例如，打字节奏、鼠标移动模式、甚至是手机握持方式，都能成为识别人类的"指纹"。这些特征不仅难以被AI模仿，而且每个人都独一无二，就像人类的签名一样。</p>
<h3 data-id="heading-4">未来门禁系统：脑电波验证与无密码认证</h3>
<p>展望未来，验证码技术还将继续进化。一些前沿研究正在探索脑电波验证、眼动追踪等更先进的技术。这些技术就像直接读取你的"思想指纹"，让AI几乎不可能伪造你的身份🧠。</p>
<p>与此同时，无密码认证也成为一种趋势。通过分析你的各种设备和行为特征，系统可以自动确认你的身份，无需你输入任何密码。这种方式不仅更安全，而且更便捷，就像你家的智能门锁，只要你靠近就会自动识别并开门。</p>
<p>然而，随着验证码技术的不断进步，AI破解技术也在同步发展。这场"人机攻防战"就像一场永无止境的军备竞赛，双方都在不断推出新的"武器"和"战术"。</p>
<h3 data-id="heading-5">三代验证码攻防对比表</h3>
<p>看完了验证码的进化史，我们来看看这场攻防战的成本账单👇</p>

































<table><thead><tr><th>验证码类型</th><th>破解成本</th><th>用户体验</th><th>安全等级</th><th>典型应用场景</th></tr></thead><tbody><tr><td>字符验证码</td><td>$0.1/千次</td><td>❌ 较差（需要调用老花镜+放大镜+运气Buff）</td><td>⭐⭐😅</td><td>早期论坛、博客</td></tr><tr><td>行为验证码</td><td>$5/千次</td><td>✅ 良好（滑动拼图时怀疑自己手抖症晚期）</td><td>⭐⭐⭐⭐😐</td><td>电商网站、社交媒体</td></tr><tr><td>生物特征验证码</td><td>$50/千次</td><td>✅ 优秀</td><td>⭐⭐⭐⭐⭐🤖</td><td>金融服务、政府网站</td></tr></tbody></table>
<h3 data-id="heading-6">结语：人机对抗的永恒博弈🤖💻🔐</h3>
<p>验证码技术的发展史，就是一部人机对抗的进化史。从最初的字符识别，到现在的生物特征验证，每一次技术进步都伴随着新的破解方法的出现。这场"军备竞赛"不仅推动了验证码技术的发展，也促进了AI识别技术的进步。</p>
<p>在未来，随着量子计算、脑机接口等新技术的出现，验证码可能会进入一个全新的时代。但无论技术如何进步，验证码的核心使命始终不变：证明"你是你"，保护网络世界的安全。</p>
<p>正如网络安全专家Bruce Schneier所说："安全不是产品，而是过程。"验证码技术的发展永远不会停止，因为只要有网络安全的需求，就需要不断创新来应对新的威胁。</p>
<p>在这场永无止境的"人机攻防战"中，我们每个人都是参与者。无论是作为用户还是开发者，我们都在不断适应和推动这场技术进化。而最终，这场博弈将塑造我们未来的数字生活，让网络世界变得更安全、更便捷。</p>
<p>所以，下次当你遇到验证码时，不妨想一想：这个小小的"网络门卫"背后，是一场持续了25年的"人机战争"。而你，就是这场战争的见证者和参与者。未来验证码可能要求你唱首歌——五音不全的人类终于有了用武之地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无服务器计算架构的优势]]></title>    <link>https://juejin.cn/post/7582036070158974976</link>    <guid>https://juejin.cn/post/7582036070158974976</guid>    <pubDate>2025-12-10T09:40:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070158974976" data-draft-id="7582036070158942208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无服务器计算架构的优势"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-12-10T09:40:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无服务器计算架构的优势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:40:39.000Z" title="Wed Dec 10 2025 09:40:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>云计算是一个快速发展的领域。云计算的各类创新方面层出不穷，其中一些获得了比其他更多的关注和采用。在广泛采用的创新中，无服务器计算架构已成为一种颠覆性的改变。</p>
<p>但“无服务器”究竟意味着什么？与名称可能暗示的相反，“无服务器”并不意味着没有服务器。相反，它代表了服务器管理复杂性责任的转移——从开发者转移到云提供商。通过抽象化这些复杂性，无服务器架构使开发者能够专注于构建强大的应用程序。</p>
<p>无服务器架构植根于传统的基于服务器的模型，但它彻底改变了软件开发团队对部署和扩展应用程序的思考方式。无服务器提供了成本效益、可扩展性和开发者便利性的独特结合。因此，无服务器架构能成为对软件企业和开发者颇具吸引力的选择，也就不足为奇了。</p>
<p>在这篇博客文章中，我们将深入探讨无服务器计算架构的世界——了解其工作原理，考量其优势与局限，并简要介绍如何开始使用无服务器。</p>
<p>我们将特别关注Akamai的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-serverless-computing%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251210_external1_blogarticles234" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-serverless-computing?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251210_external1_blogarticles234" ref="nofollow noopener noreferrer">无服务器计算产品</a>，例如创新的Akamai EdgeWorkers。</p>
<p>在我们开始探索之际，让我们首先考量无服务器架构与之前的传统服务器架构相比如何。</p>
<h4 data-id="heading-0"><strong><strong>与传统架构的比较</strong></strong></h4>
<p>传统的基于服务器的架构围绕着服务器的手动管理和操作展开。采用这种方法，开发者必须积极参与，为应用程序托管和工作负载管理寻找解决方案。这种传统架构需要持续（通常由人工主导）的监控和管理，以确保服务器环境安全、高效且能够处理负载需求。</p>
<p>将这种传统方法与无服务器架构的方法并列比较时，我们可以非常清楚地看到云原生计算的进步如何带来显著优势。</p>
<p><strong><strong>维护与管理</strong></strong></p>
<p>在传统服务器架构中，管理整个服务器生命周期的负担落在企业身上——具体来说，是其工程师身上。这些管理职责包括：</p>
<ul>
<li>配置硬件，例如物理服务器、虚拟机或API网关</li>
<li>处理操作系统和软件更新</li>
<li>应用安全补丁</li>
</ul>
<p>无服务器架构将这些责任转移给云平台提供商（例如 Google Cloud Platform、Amazon Web Services 或 Akamai）。开发者不再需要关注这些问题；他们可以专注于自己的代码。</p>
<p><strong><strong>扩展性与灵活性</strong></strong></p>
<p>传统服务器架构通常需要手动扩展。手动扩展要求组织预测需求。这可能意味着预配置资源以应对预期的负载增加。也可能意味着在过载导致可用性问题后快速配置更多资源。</p>
<p>无论哪种方式，结果对企业来说都不是最优的。过度配置资源会导致浪费和成本高昂的资源利用不足。配置不足则会导致性能不佳和用户体验下降。</p>
<p>相比之下，无服务器计算提供自动扩展。云提供商具备自动化措施，能够熟练地实时调整资源以匹配需求。这确保了资源的最佳利用，而无需手动干预。对于工作负载波动或负载需求不稳定的应用程序，无服务器的灵活性带来了显著优势。</p>
<p><strong><strong>成本影响</strong></strong></p>
<p>传统服务器的定价结构大多是固定的；企业为其注册的服务器付费，无论这些服务器是否被完全使用。要降低传统服务器的成本，用户需要监控资源使用情况，以确保他们没有为不必要的资源付费。</p>
<p>另一方面，无服务器模型提供按实际使用量付费的方式。当应用程序没有用户活动时，为该应用程序提供服务的硬件会缩减。计费基于实际资源使用量，这可以显著降低成本。</p>
<p><strong><strong>部署速度与敏捷性</strong></strong></p>
<p>将应用程序部署到传统服务器架构可能是一个繁琐的过程。设置和配置服务器是一项复杂的任务，许多专注于代码的开发者可能没有执行此任务的专业知识。因此，他们转向无服务器架构，这种架构简化了部署，并能显著加速开发和部署周期。</p>
<p><strong><strong>运营开销</strong></strong></p>
<p>管理传统服务器可能需要大量的运营开销。需要监控服务器的可用性、安全性和合规性。许多企业没有额外的资源来处理这个问题。无服务器架构将此负担转移给云服务提供商。通过减少这些运营挑战，无服务器架构使企业能够专注于创新和增长。</p>
<p>传统的基于服务器的架构提供了控制力和熟悉感，但这可能需要组织不愿意或无法投入的资源和专业知识。无服务器计算的方法带来了许多企业看重的效率和敏捷性。组织可以通过向无服务器架构过渡来减少其运营任务，并释放其开发者的精力，使其专注于创造价值和促进创新。</p>
<h4 data-id="heading-1"><strong><strong>无服务器架构如何工作</strong></strong></h4>
<p>为了更好地理解无服务器计算带来的效率和多功能性，让我们关注其内部工作原理。在本节中，我们将探讨无服务器架构的关键方面和组件。</p>
<p><strong><strong>函数即服务</strong></strong></p>
<p>无服务器架构的一个常见用途是函数即服务（FaaS），由大多数云提供商提供（例如 Google Cloud Functions、Microsoft Azure Functions、Akamai EdgeWorkers 或 Amazon 的 AWS Lambda）。FaaS 无服务器技术允许开发者编写和部署单个函数——一个小的、单一用途的代码块——该函数按需执行以响应特定事件。该函数被部署到无服务器架构中，等待某个事件触发。</p>
<p>事件触发器几乎可以是任何东西——从 HTTP 请求到 Web 表单提交，再到接收 SMS 消息。在 FaaS 模型中，云提供商托管和管理函数。开发者只需编写函数代码并配置导致函数调用的运行时触发器。</p>
<p>在 FaaS 用例中，资源使用是最小的，这使得 FaaS 对企业非常有吸引力。计算资源仅在函数被调用和执行时使用（在许多情况下，可能只有几秒钟）。除了这些最小化使用的计算资源外，还会使用少量云存储来存储函数代码。</p>
<p>由于 FaaS 是使用无服务器计算架构最著名的方式，“无服务器架构”和“无服务器函数”这两个术语实际上已成为同义词。</p>
<p><strong><strong>事件驱动执行</strong></strong></p>
<p>无服务器架构本质上是事件驱动的。无服务器函数被设计为响应事件队列中的特定触发器或活动。这意味着函数保持空闲状态，直到事件发生，即刻运行。执行函数所需的计算资源仅在必要时使用。这比传统服务器模型高效得多，在传统模型中，服务器持续运行，即使对其计算资源没有需求。</p>
<p><strong><strong>幕后机制</strong></strong></p>
<p>当调用无服务器函数时，云提供商动态分配资源来执行该函数，管理包括以下方面的问题：</p>
<ul>
<li>扩展资源以满足需求</li>
<li>负载均衡</li>
<li>容错</li>
</ul>
<p>云提供商可能使用虚拟机、容器化和容器编排技术（例如 Docker 和 Kubernetes）或其他资源。然而，所有这些与基础设施相关的细节都在无服务器框架中被抽象化了。</p>
<p>开发者只需专注于他们的编码和调试工作流程。通常，他们的应用程序代码不需要太多修改即可适应无服务器执行。适用于大多数主要编程框架和语言（包括 Node.js、Python、JavaScript、WebAssembly 和 Ruby）的开源库使得通过无服务器进行部署变得简单直接。DevOps 团队可以使用其 CI/CD 流水线来部署无服务器函数代码的更新版本。</p>
<p><strong><strong>典型用例</strong></strong></p>
<p>无服务器架构有各种应用。常见的用例包括：</p>
<ul>
<li>促进 API 或后端即服务（BaaS）</li>
<li>微服务</li>
<li>任务自动化</li>
<li>处理实时数据流</li>
<li>Web 应用程序（前端和后端 Web 应用）</li>
<li>处理零星或不可预测的工作负载</li>
</ul>
<p>自动扩展的能力以及仅为使用的资源付费的特点，使得无服务器架构对初创公司和企业都同样理想。</p>
<h4 data-id="heading-2"><strong><strong>无服务器架构的优势</strong></strong></h4>
<p>我们已经提到了无服务器计算架构的许多好处。回顾一下，无服务器架构提供：</p>
<ul>
<li><strong><strong>成本效益</strong></strong>：按实际使用量付费的定价模式（只需为无服务器函数实际消耗的资源付费）对许多组织具有吸引力。</li>
<li><strong><strong>可扩展性和灵活性</strong></strong>：无服务器架构自动调整计算资源以匹配需求，在高峰时段扩展，在低使用期缩减。这种自动扩展和灵活性带来了持续的性能，无论使用情况如何波动，都无需手动干预。</li>
<li><strong><strong>提高开发者生产力</strong></strong>：软件开发人员不再需要处理与基础设施相关的管理任务。他们可以专注于编写代码和开发新功能。这提高了他们的生产力，加速了开发，并改善了产品上市时间。</li>
<li><strong><strong>减少运营开销</strong></strong>：无服务器架构将运营问题（如服务器维护、打补丁和安全性）转移给第三方服务提供商。组织可以将其时间、人力资源和专业知识投入到更关键的业务事务上。</li>
</ul>
<h4 data-id="heading-3"><strong><strong>无服务器计算与边缘计算结合的优势</strong></strong></h4>
<p>边缘计算是一种分布式计算方法，将计算和数据存储带到更靠近需要的地方（通常在地理上靠近最终用户）。边缘计算旨在提高响应时间并节省带宽。边缘计算可以使用无服务器环境，在靠近最终用户的资源上执行无服务器函数。</p>
<p>将边缘计算与无服务器计算架构相结合——例如使用 Akamai EdgeWorkers——为处理高容量、实时数据处理和提供增强的用户体验提供了更高的效率。</p>
<h4 data-id="heading-4"><strong><strong>无服务器架构的局限性</strong></strong></h4>
<p>尽管无服务器计算架构提供了众多好处，组织也应意识到其局限性，包括：</p>
<ul>
<li><strong><strong>冷启动问题</strong></strong>：“冷启动”问题指的是在一段不活动期后调用无服务器函数时遇到的延迟，通常是由于初始化执行函数所需的计算资源造成的。尽管许多无服务器应用程序可能不会受到明显影响，但对于需要极快响应时间的函数，冷启动可能会影响性能。</li>
<li><strong><strong>供应商锁定</strong></strong>：采用无服务器架构通常意味着将自己与特定云提供商的生态系统绑定。转移到不同的提供商可能需要更改应用程序，导致可移植性挑战。</li>
<li><strong><strong>有限的控制和自定义</strong></strong>：在云提供商管理底层基础设施的无服务器计算中，用户对环境和硬件的控制较少。对于需要特定配置或自定义的组织或应用程序，这种限制可能是一个缺点。</li>
<li><strong><strong>安全问题</strong></strong>：云提供商通常提供非常强大的安全性。然而，无服务器计算中的责任共担模型要求清晰理解无服务器提供商管理哪些安全方面，以及无服务器客户需要管理哪些方面。</li>
</ul>
<p>无服务器架构提供了众多好处，但组织必须权衡这些好处与潜在的局限性，例如冷启动、供应商锁定、有限的控制和安全隐患。理解这些方面将帮助组织就采用无服务器解决方案做出明智的决策。</p>
<h4 data-id="heading-5"><strong><strong>开始使用边缘计算解决方案</strong></strong></h4>
<p>当企业确定无服务器方法符合业务需求时，是时候考虑像 Akamai 这样的特定无服务器平台如何简化入门过程了。踏上无服务器之旅可能看似令人望而生畏，但采用合适的平台将帮助迅速启动并运行。</p>
<p>Akamai 的无服务器计算核心在于 Akamai 的边缘计算解决方案，其允许用户在一个边缘计算平台上运行无服务器函数，该平台将计算和存储在地理上转移到更靠近客户的位置。通过这种方式，用户可以优化无服务器应用程序的交付，实现低延迟、更快的响应时间、改进的性能和增强的用户体验。</p>
<p>Akamai EdgeWorkers 允许开发者专注于编写业务逻辑和代码，而 Akamai 则负责在其全球分布的无服务器网络边缘执行函数，最终用户享受到位于离他们最近的无服务器计算服务。组织获得自动扩展、灵活性、更快的冷启动以及一个经济高效的平台来运行所有这一切。</p>
<h4 data-id="heading-6"><strong><strong>结论</strong></strong></h4>
<p>无服务器计算架构是云计算的一个方面，它彻底改变了我们处理应用程序开发和部署的方式。通过抽象化基础设施管理的复杂性，无服务器方法提供了一种简单且可扩展的解决方案，以具有成本效益的、按使用量付费的定价模式来启动基础设施。开发者可以专注于编写代码——组织则避免了管理服务器的运营开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学而时习之：C++中的异常处理2]]></title>    <link>https://juejin.cn/post/7581751726506377259</link>    <guid>https://juejin.cn/post/7581751726506377259</guid>    <pubDate>2025-12-10T06:14:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581751726506377259" data-draft-id="7581664885862318090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学而时习之：C++中的异常处理2"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-10T06:14:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学而时习之：C++中的异常处理2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:14:11.000Z" title="Wed Dec 10 2025 06:14:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C++ 利用“类”实现异常处理</h2>
<p>程序运行时常会遇到“除以 0、文件不存在、数据无效”等突发状况，统称为<strong>异常</strong>。若放任不管，进程会异常终止。<br/>
C++ 提供 <code>try-catch</code> 机制：在 <code>try</code> 块里用 <code>throw</code> 抛出一个<strong>对象</strong>，该对象通常是某个<strong>异常类</strong>的实例；<code>catch</code> 块根据对象类型捕获并处理。</p>
<p>标准库已预置的异常类， 所有内置异常都以 <code>std::exception</code> 为公共基类，其接口如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">exception</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">exception</span>() <span class="hljs-keyword">noexcept</span>;
    <span class="hljs-built_in">exception</span>(<span class="hljs-type">const</span> exception&amp;) <span class="hljs-keyword">noexcept</span>;
    exception&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> exception&amp;) <span class="hljs-keyword">noexcept</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">exception</span>();
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span>;  <span class="hljs-comment">// 返回描述字符串</span>
};
</code></pre>
<p><code>what()</code> 为虚函数，派生类可重写以给出更精确的诊断信息。 最常用的一众内置异常类见下表（均位于 <code>&lt;stdexcept&gt;</code>）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e16bcb8f1e3f4adf81dbb186be404b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765952051&amp;x-signature=aiNK2DKK4KHyMty9NrnIigZ7Gs4%3D" alt="image.png" loading="lazy"/></p>
<p>这些异常通常由 <strong>C++ 标准库组件</strong>抛出，程序员必须主动去捕获它们。</p>
<p>示例 1：捕获标准库抛出的异常</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试分配一个极大的数组</span>
        <span class="hljs-type">int</span>* bigArray = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100000000000000</span>];
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> bad_alloc&amp; e) {          <span class="hljs-comment">// 内存分配失败时库抛 bad_alloc</span>
        cout &lt;&lt; <span class="hljs-string">"捕获 bad_alloc: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
    }
    <span class="hljs-comment">// 程序继续往下执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-c" lang="c">捕获 bad_alloc: <span class="hljs-built_in">std</span>::bad_alloc
</code></pre>
<p>示例 2：在自己的代码里主动使用标准异常</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> num = <span class="hljs-number">10</span>, den = <span class="hljs-number">0</span>, res;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (!den)                       <span class="hljs-comment">// 检测除 0</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Division by Zero"</span>);  <span class="hljs-comment">// 主动抛异常</span>
        res = num / den;
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> runtime_error&amp; e) {    <span class="hljs-comment">// 按引用捕获</span>
        cout &lt;&lt; <span class="hljs-string">"捕获: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp">捕获: Division <span class="hljs-keyword">by</span> Zero
</code></pre>
<blockquote>
<p>注意：除 <code>std::exception</code> 基类外，其余标准异常类都支持在构造函数里传入<strong>自定义描述字符串</strong>，方便我们给出具体错误信息。</p>
</blockquote>
<h3 data-id="heading-1">创建自定义异常类</h3>
<p>如果标准异常不满足需求，我们可以<strong>自己写异常类</strong>。常见有三种做法，第一种最简单：</p>
<h4 data-id="heading-2">1. 继承 <code>std::exception</code></h4>
<p>直接继承标准基类，即可与现有 <code>catch (const exception&amp;)</code> 体系无缝衔接；通过<strong>重写虚函数</strong>定制行为。</p>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 自定义异常类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomExcept</span> : <span class="hljs-keyword">public</span> exception {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 重写 what() 返回描述信息</span>
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"This is a custom exception!"</span>;
    }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">CustomExcept</span>();   <span class="hljs-comment">// 抛出自定义异常对象</span>
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> CustomExcept&amp; e) {          <span class="hljs-comment">// 按引用捕获</span>
        cout &lt;&lt; <span class="hljs-string">"Caught an exception: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet">Caught an an exception: This <span class="hljs-built_in">is</span> a <span class="hljs-keyword">custom</span> exception!
</code></pre>
<p>解释：我们定义了 <code>CustomExcept</code> 并改写 <code>what()</code>。当 <code>throw CustomExcept()</code> 时，匹配到的 <code>catch</code> 会调用其 <code>what()</code> 打印自定义错误信息。</p>
<h4 data-id="heading-3">2. 继承其他标准异常</h4>
<p>除了直接从 <code>std::exception</code> 派生，我们还可以继承 <code>std::runtime_error</code>、<code>std::logic_error</code> 等<strong>具体异常类</strong>。<br/>
这样既能沿用它们已有的<strong>自定义消息机制</strong>（构造函数接收 <code>string</code>），又能让异常类型更精细，与标准库风格保持一致。</p>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomExcept</span> : <span class="hljs-keyword">public</span> runtime_error {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 把自定义描述传给父类构造函数</span>
    <span class="hljs-built_in">CustomExcept</span>(<span class="hljs-type">const</span> string&amp; message)
        : <span class="hljs-built_in">runtime_error</span>(message) {}
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">CustomExcept</span>(<span class="hljs-string">"This is a custom runtime_exception!"</span>);
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> CustomExcept&amp; e) {
        cout &lt;&lt; e.<span class="hljs-built_in">what</span>();   <span class="hljs-comment">// 输出父类保存的描述</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet">This <span class="hljs-built_in">is</span> a <span class="hljs-keyword">custom</span> runtime_exception!
</code></pre>
<p>解释：  <code>CustomExcept</code> 继承自 <code>runtime_error</code>，因此自带 <code>what()</code> 功能；<br/>
我们只需在构造函数里把自定义信息转发给基类即可使用。</p>
<h4 data-id="heading-4">3. 创建非标准异常</h4>
<p>我们也可以<strong>完全不继承</strong>任何标准异常类，自己写一个“独立”的异常类。 这样做最灵活，但代价是：</p>
<ul>
<li>不再能与 <code>catch (const std::exception&amp;)</code> 之类的外层处理器兼容；</li>
<li>必须自己实现所有接口（例如 <code>what()</code>）。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomExcept</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">CustomExcept</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; msg)</span> : message(msg) {</span>}
    
    <span class="hljs-comment">// 自定义 what()，返回 C-style 字符串</span>
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> message.<span class="hljs-built_in">c_str</span>();
    }

<span class="hljs-keyword">private</span>:
    string message;
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">CustomExcept</span>(<span class="hljs-string">"This is a custom exception!"</span>);
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> CustomExcept&amp; e) {   <span class="hljs-comment">// 必须精确匹配类型</span>
        cout &lt;&lt; e.<span class="hljs-built_in">what</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet">This <span class="hljs-built_in">is</span> a <span class="hljs-keyword">custom</span> exception!
</code></pre>
<p>要点</p>
<ul>
<li>完全自定义，想怎么写都行；</li>
<li><strong>无法</strong>被 <code>catch (const exception&amp;)</code> 接住，使用时务必保证 <code>catch</code> 类型与抛出类型<strong>严格一致</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 altool 退出历史舞台，iOS 上传链路的演变与替代方案的工程实践]]></title>    <link>https://juejin.cn/post/7582003642191314986</link>    <guid>https://juejin.cn/post/7582003642191314986</guid>    <pubDate>2025-12-10T09:22:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582003642191314986" data-draft-id="7582003642191298602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 altool 退出历史舞台，iOS 上传链路的演变与替代方案的工程实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T09:22:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 altool 退出历史舞台，iOS 上传链路的演变与替代方案的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:22:31.000Z" title="Wed Dec 10 2025 09:22:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在过去相当长的一段时间里，altool 是 iOS 工程师上传 IPA、验证签名、处理 App Store 发布流程的关键工具。它以命令行方式运行，适合脚本化与 CI 集成，是许多自动化发布体系的底层组件。然而，自苹果逐步淘汰 Application Loader，并将 Transporter 作为主力上传方式后，altool 的角色开始弱化，并在新版 Xcode 命令行工具中逐步被移除。</p>
<p>问题也随之而来：
– 曾经依赖 altool 的 CI 不再可用。
– 跨平台团队无法执行 “macOS only” 的替代方式。
– 自动化脚本链路因 altool 被弃用而集体失效。
– 没有 Mac 的成员无法继续上传 IPA。</p>
<p>于是，“altool 消失后该怎么办？” 成为许多团队在升级 Xcode、迁移 CI、或更换机器时不得不面对的问题。</p>
<p>本文将从工程视角解读 altool 的历史定位、弱化原因，并讨论如何在多平台团队中重建更稳定的上传体系。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、altool 曾经解决了什么问题？</strong></h2>
<p>在它最活跃的时期，altool 提供了几个核心能力：</p>
<ol>
<li><strong>验证签名</strong>（altool --validate-app）</li>
<li><strong>上传 IPA 至 App Store Connect</strong>（altool --upload-app）</li>
<li><strong>脚本化 / CI 友好</strong></li>
<li><strong>无需打开 GUI 工具</strong></li>
</ol>
<p>相比 Transporter 的图形界面，altool 更适合团队内部自动化处理。</p>
<p>正因如此，它曾被集成在：</p>
<ul>
<li>fastlane deliver</li>
<li>自定义 Shell 构建脚本</li>
<li>Jenkins Pipeline</li>
<li>企业内自动化发布系统</li>
</ul>
<p>可以说，在 iOS 自动化发布史上，altool 占据了一个非常关键的位置。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、为什么 altool 会被淘汰？</strong></h2>
<p>苹果的策略调整有两个关键方向：</p>
<h3 data-id="heading-2"><strong>1. 上传入口必须统一</strong></h3>
<p>苹果希望所有上传最终经过 App Store Connect API + Transporter 链路，使审核规范、元数据结构、加密校验、日志处理更一致。</p>
<p>altool 不再符合这一统一策略。</p>
<h3 data-id="heading-3"><strong>2. altool 的维护成本高</strong></h3>
<p>它依赖旧逻辑，与后台 API 的更新节奏不一致，逐渐成为兼容性风险点。</p>
<h3 data-id="heading-4"><strong>3. 与新的应用签名验证方式不完全兼容</strong></h3>
<p>一些新的加密校验方式不再由 altool 负责。</p>
<p>最终结论是：</p>
<blockquote>
<p>altool 并不是“坏了”，而是“被架构升级淘汰了”。</p>
</blockquote>
<p>但它的退出，让长期依赖它的团队必须重新设计上传流程。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、altool 被淘汰后的典型问题：工程链路断开</strong></h2>
<p>以下是我在实际团队中遇到的典型现象：</p>
<h3 data-id="heading-6"><strong>1. CI 构建没问题，但无法上传 IPA</strong></h3>
<p>因为 CI 节点不是 macOS，无法运行 Transporter。</p>
<h3 data-id="heading-7"><strong>2. Windows / Linux 环境完全失去上传能力</strong></h3>
<p>altool 过去允许从这些环境间接调用，现在不行了。</p>
<h3 data-id="heading-8"><strong>3. 自动化脚本废弃</strong></h3>
<p>许多团队的自动化脚本是围绕 altool 编写的，迁移成本高。</p>
<h3 data-id="heading-9"><strong>4. 只能使用 Transporter，但它不适合自动化</strong></h3>
<p>Transporter GUI 完全不适合集成到发布链路。</p>
<p>在这些背景下，团队需要一种 <strong>跨平台、可脚本化、能替代 altool 的上传方式</strong>。</p>
<hr/>
<h2 data-id="heading-10"><strong>四、重建上传能力：跨平台工具成为关键因素</strong></h2>
<p>altool 的优势在于脚本化与自动化，而 Transporter 的问题在于必须 macOS。
因此在实际工程中，我寻找的是：</p>
<ul>
<li>能在 Windows、Linux、macOS 上运行</li>
<li>能执行 IPA 上传</li>
<li>能通过命令行集成至 CI</li>
<li>不依赖 Xcode</li>
<li>不依赖 macOS 设备信息</li>
</ul>
<p>在这些要求下，最常见的替代路径是：</p>
<h3 data-id="heading-11"><strong>使用开心上架（Appuploader）的命令行工具进行 IPA 上传</strong></h3>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">appuploader_cli -u dev<span class="hljs-keyword">@icloud</span>.com -p xxx-xxx-xxx -c <span class="hljs-number">1</span> -f app.ipa
</code></pre>
<p>它支持：</p>
<ul>
<li><strong>跨平台上传 IPA</strong>（Windows / Linux / macOS）</li>
<li><strong>上传前检查 IPA 文件结构</strong></li>
<li><strong>无需依赖 Transporter 或 Xcode Command Line Tools</strong></li>
<li><strong>可放入自动化脚本中使用</strong></li>
</ul>
<p>在 altool 不再可用后，这类工具能有效补齐团队在非 macOS 环境中的上传能力。</p>
<hr/>
<h2 data-id="heading-12"><strong>五、上传前的签名验证：altool 没了，如何确保 IPA 结构正确？</strong></h2>
<p>altool 曾经能帮开发者提前验证签名，而现在 Transporter 会在上传后才提示错误，导致等待时间变长。</p>
<p>为避免上传失败，我通常会利用工具检查以下文件：</p>
<ul>
<li>IPA 内部的 Info.plist</li>
<li>mobileprovision（描述文件）内容</li>
<li>描述文件绑定的证书</li>
<li>是否使用发布证书签名</li>
<li>Bundle ID 是否正确</li>
</ul>
<p>这些检查可通过 <strong>Appuploader 的文件查看能力</strong> 在任意系统中完成。</p>
<p>团队不必等 Transporter 拒绝上传，才能知道配置错了。</p>
<hr/>
<h2 data-id="heading-13"><strong>六、工程体系中替代 altool 的实际落地方式</strong></h2>
<p>以下流程已在多个项目中实践落地：</p>
<h3 data-id="heading-14"><strong>步骤 1：CI 生成 IPA（仍需 macOS Runner）</strong></h3>
<p>例如：</p>
<ul>
<li>GitHub Actions（macos-latest）</li>
<li>自建 Mac Mini 集群</li>
<li>Codemagic 云构建</li>
</ul>
<p>构建动作不变。</p>
<h3 data-id="heading-15"><strong>步骤 2：将 IPA 产物推送至服务器或制品仓库</strong></h3>
<p>供其他系统拉取上传。</p>
<h3 data-id="heading-16"><strong>步骤 3：使用 Appuploader CLI 执行上传（任意系统）</strong></h3>
<pre><code class="hljs language-css" lang="css">appuploader_cli -u xxx -<span class="hljs-selector-tag">p</span> xxx -c <span class="hljs-number">1</span> -f build<span class="hljs-selector-class">.ipa</span>
</code></pre>
<p>特点：</p>
<ul>
<li>无需 macOS</li>
<li>可作为脚本步骤</li>
<li>失败可自动重试</li>
<li>多团队都能参与上传流程</li>
</ul>
<h3 data-id="heading-17"><strong>步骤 4：在 App Store Connect 查看 TF / 审核处理情况</strong></h3>
<p>最终替代了 Transporter 与 altool 的“唯一入口”角色。</p>
<hr/>
<h2 data-id="heading-18"><strong>七、altool 时代的结束意味着什么？</strong></h2>
<p>实际上，它代表 iOS 发布体系进入了新阶段：</p>
<ul>
<li>从本地上传 → 云端与脚本化上传</li>
<li>从 macOS 单设备 → 多平台协作</li>
<li>从个人流程 → 团队级 CI/CD</li>
<li>从 Xcode 生态内部 → 更开放的发布路径</li>
</ul>
<p>开发者的发布思维也由“工具决定方式”转向“流程决定工具”。</p>
<p>换句话说，<strong>上传 IPA 不再是必须在 Mac 上做的工作</strong>。</p>
<hr/>
<h2 data-id="heading-19"><strong>altool 退出后，团队需要的是“更可控的上传链路”</strong></h2>
<p>altool 曾是 iOS 上传的核心工具，但并不适配现代协作模式。它退出后，许多团队反而意识到：
<strong>上传 IPA 不应该成为依赖单个操作系统的行为。</strong></p>
<p>通过使用跨平台工具（如 Appuploader CLI）处理上传、文件查看与描述文件检查，可以在 altool 不再存在的时代，建立更灵活、更稳定、更符合自动化需求的上传体系。</p>
<p>真正重要的不是替代某个工具，而是建立：</p>
<blockquote>
<p><strong>一个不依赖单点、不依赖系统、不依赖个人电脑的工程级上传流程。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯云 RocketMQ 5.x：如何兼容 Remoting 全系列客户端]]></title>    <link>https://juejin.cn/post/7581828086020849679</link>    <guid>https://juejin.cn/post/7581828086020849679</guid>    <pubDate>2025-12-10T09:26:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581828086020849679" data-draft-id="7582016579857514530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯云 RocketMQ 5.x：如何兼容 Remoting 全系列客户端"/> <meta itemprop="keywords" content="RocketMQ,消息队列,架构"/> <meta itemprop="datePublished" content="2025-12-10T09:26:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云中间件"/> <meta itemprop="url" content="https://juejin.cn/user/2330620382414296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯云 RocketMQ 5.x：如何兼容 Remoting 全系列客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620382414296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云中间件
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:26:23.000Z" title="Wed Dec 10 2025 09:26:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Apache RocketMQ 社区新发布的 5.x 版本是其云原生架构演进的重要里程碑，其中包括两项重大更新：</p>
<ol>
<li> 实现了存储与计算的解耦，进一步提升了系统的可扩展性和云原生适配能力。</li>
<li> 引入了 POP 消费模式，将负载均衡逻辑从客户端迁移到了 Broker 端。</li>
</ol>
<p>为适配这些新特性，开源社区推出了全新的基于 gRPC 协议的轻量化客户端。不过，现有的仍通过 Remoting 协议接入的用户，如果不更新代码并替换客户端 SDK，就无法享受到这些新能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/663f6720b76f4036859c97081697cd72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=5VgdGGPdH0%2BmClBw%2F%2B3k6Mk%2FLgU%3D" alt="图片" loading="lazy"/></p>
<p><strong>为了解决这个问题，腾讯云消息队列 RocketMQ 版通过基于虚拟队列的兼容性增强方案，实现了对 Remoting 协议客户端的完整支持，使现有用户在无需修改代码的情况下也能平滑使用 5.x 版本。</strong> 本文将从整体架构、关键设计思路以及核心能力等方面详细介绍腾讯云虚拟队列方案。</p>
<h2 data-id="heading-1">RocketMQ 5.x 版本对 Remoting 客户端的限制</h2>
<h3 data-id="heading-2"><strong>SDK 版本依赖</strong></h3>
<p>在 RocketMQ 4.x 架构中，客户端与后端 Broker 之间采用直连模式，即每个客户端与队列路由表中的所有 Broker 建立长连接。而在 5.x 版本升级为存算分离架构后，通信方式变更为转发模式：Proxy 负责接收客户端的连接请求，并将其转发到相应的 Broker。与直连模式相比，转发模式简化了客户端侧的逻辑，同时避免了多网络环境下复杂的网络打通问题。</p>
<p>为了适配 5.x 架构，Remoting SDK 在 v4.9.5 版本中对协议进行了扩展，增加了 Broker Name 字段，Proxy 通过该字段获取客户端请求的目标 Broker 身份。</p>
<p>因此，<strong>Remoting 客户端用户接入 RocketMQ 5.x 的前提是将 SDK 升级至 v4.9.5 或更高版本。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4943534f17b4feb90f01bfa3fa2a55f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=fHfn50ye6tj3oRUnMHqhSjVSETY%3D" alt="图片" loading="lazy"/></p>
<p>然而，升级 SDK 版本对现有业务来说是一个挑战，它不仅要求进行额外的测试验证以确保兼容性与稳定性，而且对于那些场景复杂、上下游链路交织的业务团队来说，梳理和推动版本升级的整个周期可能会相当漫长。更值得关注的是，使用较低版本 Remoting 客户端在 RocketMQ 用户中仍是主流，以腾讯云消息队列 RocketMQ 版的数据来看，超过 90% 的用户在使用版本低于 v4.9.5 的 Remoting 客户端。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60017c8a8e2f4e3cb3d8c2b1da810de6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=JJZuAdzzmsI9%2FD4UQAVpGusH3%2BA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3"><strong>消费者绑定队列</strong></h3>
<p>在 RocketMQ 4.x 架构中，消费者采用 PULL 模式进行消费：SDK 周期性地获取全量队列和全量消费者，并根据既定算法算出队列与消费者的分配绑定关系，然后轮询拉取分配给自己的队列。</p>
<p>这种基于队列粒度的负载均衡机制有一个核心痛点：一旦某个消费者实例由于单机问题导致消费能力下降，绑定到该消费者上的所有队列都会被阻塞，而其他正常的消费者实例即使处于空闲状态也无法介入接管。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/804822a26f6b4b43a1a7d45561315836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=Hz6KEuohYBCfIPYPIaku3rW%2FntY%3D" alt="图片" loading="lazy"/></p>
<p>为此，RocketMQ 5.x 引入了 POP 消费模式，将负载均衡和队列位点管理等逻辑从客户端迁移到了服务端，并在全新推出的基于 gRPC 协议的轻量化 SDK 中对 POP 模式做了适配，实现了消息粒度的消费负载均衡。<strong>Remoting 客户端由于采用的是 PULL 模式，接入 RocketMQ 5.x 后仍然是消费者绑定队列的均衡机制。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b463677f768045eaaf5f8ca8c89efd18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=jtOsHWsY8C7mTxv8QoLoCePSfyg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>腾讯云虚拟队列方案</strong></h2>
<p>为了解决 RocketMQ 5.x 对 Remoting 客户端的限制，腾讯云消息队列 RocketMQ 版提出了虚拟队列方案，核心能力包括：</p>
<ul>
<li>服务端层面主动兼容低版本 Remoting 客户端，大幅降低现有业务平滑过渡到 RocketMQ 5.x 的成本和风险。</li>
<li>将适配 POP 消费模式的逻辑上移到了服务端，使得 Remoting 客户端也能实现消息粒度的消费负载均衡。</li>
</ul>
<p>虚拟队列方案的核心思想是在客户端和 Broker 之间建立一层抽象，然后在抽象层实现 Remoting 协议的向下兼容和消费模式的透明转换。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c93fbd17e29d4fa0a40834fea88a77dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=KUck%2FK5aySVyzCvhA1sXEyw1%2BU4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>虚拟队列定义</strong></h3>
<p>RocketMQ 中的一个主题由分布在多个 Broker 上的多个队列组成，客户端通过路由查询接口获取主题的队列列表来进行消息收发。<strong>虚拟队列指的是将返回给客户端的队列虚拟化，即存储层真实队列不再对客户端可见。</strong></p>
<p>如下图所示，主题在 Broker-0、 Broker-1 和 Broker-2 上各有 N 个队列，而 Remoting 客户端查询到的是 vBroker 上 M 个队列。虚拟化后的队列与真实队列的映射关系由服务端管理，因此 Remoting 客户端无需在请求中标识目标 Broker 身份，即解除了 5.x 对 Remoting SDK 版本的依赖。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/272d212cef9a45099328b1e03ce6675a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=ZSjfeMvXAV8Pi6ImwTUsd1nfLtU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6"><strong>消费模式透明转换</strong></h3>
<p>服务端通过将 Remoting 客户端的 PULL 模式无感转换为 POP 模式来实现消息粒度的消费负载均衡。</p>
<p>Remoting 消费者与服务端的交互主要包括两部分：</p>
<ul>
<li>
<p>通过虚拟队列向服务端发送 PULL 请求，拉取队列中待消费的消息。</p>
</li>
<li>
<p>消费完成后向服务端提交虚拟队列消费位点，采用累积确认的定时同步机制。</p>
</li>
</ul>
<p>首先，服务端会将 Remoting 客户端对虚拟队列的 PULL 请求转换为对存储层真实队列的 POP 请求。请求转换过程中的队列映射关系由队列选择器决策，并且支持动态调整策略，这样能够做到在保证消息时延的前提下尽可能降低 POP 轮询对 Broker 的负载压力。</p>
<p>此外，服务端还会为每个客户端虚拟队列维护一个内存队列，以适配 POP 模式的不可见时间机制和选择确认机制：</p>
<ul>
<li>
<p>将 Remoting 客户端对 Offset 的累积确认转换为对 POP ReceiptHandle 的选择确认。</p>
</li>
<li>
<p>自动续期已拉取未确认消息的不可见时间，直至客户端确认或消费超时。</p>
</li>
</ul>
<p>消费模式转换在服务端计算层 Proxy 上实现，对 Remoting 客户端和存储层 Broker 而言是完全透明、无感知的。整个过程不依赖任何持久化的状态数据，对 Proxy 的部署架构和水平扩展性没有任何影响。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/065e7174bd1e417abd3e97191ef0ebed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=nsKpbExTssXF%2FemRBJRFV1YYFT8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>消除客户端重平衡</strong></h3>
<p>当 Remoting 客户端检测到消费组发生变化（队列数量变化、消费者列表变化）时会执行重平衡（Rebalance）过程：重新计算队列分配结果 -&gt; 转移队列消费所有权。</p>
<p>在大规模集群或频繁部署的业务场景中，消费者的上下线会导致 Rebalance 频繁触发，对系统稳定性有不可忽视的影响。实际上，开启虚拟队列后，真实队列的数量变化已经对客户端屏蔽了，而且也不再需要客户端侧的 Rebalance 机制了，因为消费的负载均衡完全由服务端控制。</p>
<p>于是，腾讯云消息队列 RocketMQ 版通过精准控制消费者列表查询接口的响应实现了 Remoting 消费者之间的相互不可见，即屏蔽了消费者列表变化，从而完全消除了客户端重平衡，显著提高了系统稳定性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6216f2d341c847b293b6c72fbea55ae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=aaCp3rw7woNuDSxIUs%2FZQdbdKPI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>队列顺序消费</strong></h3>
<p>RocketMQ 支持队列顺序消费以满足部分业务场景。开启虚拟队列后，Remoting 客户端顺序消费由两部分保证：</p>
<ul>
<li>服务端计算层负责将队列分配给在线客户端，并且确保每个队列的消息只会被一个客户端拉取。</li>
<li>Remoting SDK 拉取到消息后，负责将消息有序地、串行地投递给业务消费。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ff6db4b19514a349f1dcc545c561a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963583&amp;x-signature=Mz%2F97B28U5XZ69984nh%2FowAFVPg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>结语</strong></h2>
<p>本文系统阐述了 Apache RocketMQ 5.x 在存算分离架构与 POP 消费模式下的演进，并重点分析了 Remoting 协议客户端面临的两大兼容性挑战：SDK 版本依赖以及消费者队列绑定机制的限制。</p>
<p>针对上述挑战，腾讯云消息队列 RocketMQ 版提出了虚拟队列兼容方案，通过队列虚拟化和消费模式的无感切换，实现了对 Remoting 协议客户端的完整支持，为大规模存量用户快速获取新架构带来的技术红利提供了高效路径。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka 集群上云新突破：腾讯云 CKafka 联邦迁移方案]]></title>    <link>https://juejin.cn/post/7581999251367755828</link>    <guid>https://juejin.cn/post/7581999251367755828</guid>    <pubDate>2025-12-10T09:30:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581999251367755828" data-draft-id="7581999251367739444" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka 集群上云新突破：腾讯云 CKafka 联邦迁移方案"/> <meta itemprop="keywords" content="Kafka,云原生,消息队列"/> <meta itemprop="datePublished" content="2025-12-10T09:30:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云中间件"/> <meta itemprop="url" content="https://juejin.cn/user/2330620382414296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka 集群上云新突破：腾讯云 CKafka 联邦迁移方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620382414296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云中间件
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:30:16.000Z" title="Wed Dec 10 2025 09:30:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>企业自建 Kafka 集群上云的核心挑战</strong></h2>
<p>随着企业数字化进程加速，Kafka 集群上云成为提升系统弹性与数据可靠性的关键路径。传统迁移方案如单写双消费、先切写再切读、Mirrormaker 同步等，虽然在某些场景下能够满足基本需求，但普遍存在以下共性问题：</p>
<ol>
<li>迁移难度高。</li>
<li>高阶特性兼容性差。</li>
<li>数据一致性和业务连续性难以保证。</li>
</ol>
<p>针对上述迁移难题，<strong>腾讯云 CKafka 首次发布集群联邦迁移方案，该方案通过多集群联邦架构与精细化同步机制，实现自建 Kafka 集群无损上云。</strong> 为上下游依赖复杂、对数据一致性与业务连续性有极高要求的场景提供“平滑过渡、无感切换”的全流程支撑。</p>
<h2 data-id="heading-1"><strong>方案对比：为什么选择 CKafka 联邦迁移？</strong></h2>
<h3 data-id="heading-2"><strong>传统迁移方案的局限性</strong></h3>
<h4 data-id="heading-3"><strong>方案一：单写双消费</strong></h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc42d2fef67a4e69aca9e2608a1f79d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963816&amp;x-signature=%2BiDr7KF0bGJvo6iIPRpDaeqnNck%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 资源准备：</strong> 创建 CKafka 集群，在腾讯云 CKafka 中创建 Topic、ACL 等资源（可通过 Connect/Mirrormaker 同步）。</p>
<p><strong>2. 新消费者接入：</strong> 启动新消费者加入 CKafka 集群，此时 CKafka 集群暂无消息，新集群和新消费者处于空置状态。</p>
<p><strong>3. 生产者切换：</strong> 将生产者切换到 CKafka 集群，此时新增流量写入 CKafka 集群，历史数据保留在自建 Kafka 集群。</p>
<p><strong>4. 旧消费者处理：</strong> 旧消费者继续消费，直至历史数据全部消费完成。</p>
<p><strong>5. 自建集群下线：</strong> 观察一段时间（自建集群消息过期后），下线自建 Kafka 集群。</p>
<h4 data-id="heading-4"><strong>方案二：先切写再切读</strong></h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b954c346ea04ea5a8fdeb5cf2d463a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963816&amp;x-signature=GAjC%2B4ap4KG%2BPE913ch7EigVHME%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 资源准备：</strong> 创建 CKafka 集群，在腾讯云 CKafka 中创建 Topic、ACL 等资源（可通过 Connect/Mirrormaker 同步）。</p>
<p><strong>2. 生产者切换：</strong> 将生产者切换到 CKafka 集群，CKafka 集群开始承载新增流量。</p>
<p><strong>3. 旧数据处理：</strong> 旧消费者持续消费自建 Kafka 集群数据，直到数据全部消费完毕，此时可下线旧消费者。</p>
<p><strong>4. 新消费者接入：</strong> 启动新消费者加入 CKafka 集群，开始消费新数据。</p>
<p><strong>5. 自建集群下线：</strong> 观察一段时间（自建集群消息过期后），下线自建 Kafka 集群。</p>
<h4 data-id="heading-5"><strong>方案三：Mirrormaker 迁移</strong></h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a760848e230d447e8ec24c83a63e4fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963816&amp;x-signature=X5MCbhHM6zh0BlAaZqkHDdjGi38%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 资源准备：</strong> 创建 CKafka 集群，在腾讯云 CKafka 中创建 Topic、ACL 等资源（可通过 Connect/Mirrormaker 同步）。</p>
<p><strong>2. 数据同步：</strong> 建立 Mirrormaker 数据同步链路，从自建 Kafka 集群同步数据到 CKafka 集群，支持同步消息和消费组位点数据。</p>
<p><strong>3. 消费者切换：</strong> 关闭旧消费者，并启动新消费者加入 CKafka 集群（新数据通过 Mirrormaker 同步到 CKafka 集群）。</p>
<p><strong>4. 生产者切换：</strong> 将生产者切换到 CKafka 集群。</p>
<p><strong>5. 资源清理：</strong> 观察一段时间（Mirrormaker 无同步流量后），下线自建 Kafka 集群和 Mirrormaker 集群。</p>
<h4 data-id="heading-6"><strong>传统迁移方案痛点总结</strong></h4>









































<table><thead><tr><th><strong>对比项目</strong></th><th><strong>单写双消费</strong></th><th><strong>先切写再切读</strong></th><th><strong>Mirrormaker 迁移</strong></th></tr></thead><tbody><tr><td>CKafka 集群数据完整性</td><td>无历史数据</td><td>无历史数据</td><td>数据完整</td></tr><tr><td>消费乱序</td><td>存在乱序</td><td>不乱序</td><td>存在乱序</td></tr><tr><td>消息实时性</td><td>高</td><td>低</td><td>高</td></tr><tr><td>高阶特性兼容</td><td>幂等/事务不兼容</td><td>幂等/事务不兼容</td><td>幂等/事务不兼容</td></tr><tr><td>迁移复杂度</td><td>较高</td><td>高</td><td>较高</td></tr></tbody></table>
<p>对比各类迁移方式后可见，每种方案都有其独特的优劣势，客户可根据具体业务场景进行选择，如：</p>
<ul>
<li>部分业务场景不要求消费有序，那么可以选择<strong>先切写再切读的</strong>方式；</li>
<li>部分业务场景需要数据完整性，那么可以选择 <strong>Mirrormaker 迁移</strong>方案。</li>
</ul>
<p>然而，常规迁移方案虽然在某些场景下能够满足基本需求，但普遍存在迁移成本高、高阶特性兼容性差、数据一致性、业务连续性难以保证等共性问题。</p>
<h3 data-id="heading-7"><strong>腾讯云 CKafka 联邦迁移方案优势</strong></h3>
<p>腾讯云 CKafka 联邦集群迁移方案解决了传统方案的痛点问题，其对比优势具体体现在以下几点：</p>
<p>✅ <strong>迁移复杂度：从"人工梳理"到"自动适配"</strong></p>
<ul>
<li>
<p>传统方案在迁移前，需要盘点生产者、消费者应用等上下游依赖，并进行影响范围评估，一旦评估不到位可能会出现生产/消费异常。</p>
</li>
<li>
<p><strong>腾讯云 CKafka 联邦方案不需要梳理上下游依赖项，人力投入降低，迁移周期明显缩短。</strong></p>
</li>
</ul>
<p><strong>✅ 迁移风险：从"高风险回滚"到"安全可逆"</strong></p>
<ul>
<li>
<p>传统方案回滚风险高，可能导致数据延迟或丢失。</p>
</li>
<li>
<p><strong>腾讯云 CKafka 联邦方案回滚时不会丢失业务数据，并支持灰度策略，可渐进式完成流量切换。</strong></p>
</li>
</ul>
<p><strong>✅ 业务改动：从"功能妥协"到"完全兼容"</strong></p>
<ul>
<li>
<p>传统迁移方案会导致幂等性、事务等高级功能失效，需要先关闭，迁移完成后重新开启。</p>
</li>
<li>
<p>腾讯云 CKafka 联邦方案无需修改现有业务逻辑，关键业务功能不受影响，避免功能重新开发。</p>
</li>
</ul>
<p><strong>✅ 决策成本：从"多方案权衡"到"统一解决"</strong></p>
<ul>
<li>
<p>传统方案需要评估各个业务场景对消息顺序、消息实时性、数据一致性的要求，方案选择复杂。</p>
</li>
<li>
<p>腾讯云 CKafka 联邦方案兼顾消息顺序与数据一致性，无需权衡取舍，实现无损切换。</p>
</li>
</ul>
<p><strong>✅</strong> <strong>业务连续性：从"生产/消费暂停"到"数据层面零中断"</strong></p>
<ul>
<li>
<p>传统方案可能导致业务生产/消费暂停或数据乱序</p>
</li>
<li>
<p>腾讯云 CKafka 联邦方案生产、消费可以持续进行，数据层面无中断，连接层面存在分钟级别的短暂切换。而正在规划中的接入点 IP 复用功能将真正实现业务零中断。</p>
</li>
</ul>
<h2 data-id="heading-8"><strong>腾讯云 CKafka 联邦迁移方案详解</strong></h2>
<p>集群联邦是腾讯云研发的，能够将多套 Kafka 集群构成完整联邦集群的核心能力。该方案为客户提供以下价值：</p>
<p><strong>1. 自建 Kafka 集群平滑无损上云</strong></p>
<ol start="2">
<li>
<p>集群级别容灾（支持同地域/跨地域多集群容灾）</p>
</li>
<li>
<p>超大集群拆分（大集群拆分为若干个小集群）</p>
</li>
</ol>
<p>本文主要介绍自建 Kafka 集群平滑无损上云的场景，腾讯云 CKafka 联邦集群迁移方案支持通过将自建 Kafka 集群与云上 CKafka 集群构建成一个逻辑统一的联邦集群，实现平滑无损的集群迁移。</p>
<h3 data-id="heading-9"><strong>技术架构与原理</strong></h3>
<p>腾讯云 CKafka 联邦迁移工具基于开源 Kafka 的副本 ISR 机制实现数据和元数据一致性保障，该机制已在大规模生产环境中得到充分验证。通过复用这一成熟的迁移逻辑，联邦迁移能够提供与日常 Kafka 集群扩缩容相同的操作体验，确保技术可靠性与易用性的统一。</p>
<p><strong>1. 联邦集群构建：</strong> 通过自建 Kafka 集群的信息，腾讯云联邦工具会将 CKafka 集群与自建集群构建成联邦集群，同一个联邦集群内的节点可互相通讯。</p>
<p><strong>2. 联邦迁移：</strong> 联邦工具会获取 Partition 数据以及原信息，并通过 Kafka ISR 逻辑将状态从自建 Kafka 节点同步到 CKafka 节点中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acac8d22d9f34a299444caacd6f32ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963816&amp;x-signature=UwNpUJ%2BYDAeSRa6zJy0KWBA4Da0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10"><strong>迁移流程</strong></h3>
<h4 data-id="heading-11"><strong>迁移前</strong></h4>
<p><strong>1. 集群选型：</strong> 客户根据当前自建集群流量、Topic 数、分区数、Group 规模进行 CKafka 集群选型，建议在目标规格基础上上浮 30%，以应对突发情况。</p>
<p><strong>2. 自建集群状态校验：</strong> 确认自建集群状态、流量是否正常，检查是否存在未同步副本等问题。</p>
<p><strong>3. 配置调整：</strong> 客户按要求进行自建集群配置微调，如：独立一个迁移端口、开放对应权限。</p>
<p><strong>4. 提供自建集群信息：</strong> 如自建集群 Broker IP、VPC ID，自建集群 ZK IP、VPC ID、权限信息等。</p>
<h4 data-id="heading-12"><strong>迁移中</strong></h4>
<p><strong>1. 构建联邦集群：</strong> 使用腾讯云联邦工具，将自建 Kafka 集群与 CKafka 集群组成一个联邦集群。</p>
<p><strong>2. 状态同步：</strong> 联邦集群组件完成后，联邦工具会同步自建 Kafka 集群的数据/元数据。</p>
<p>a. 数据/元数据可以保证强一致性</p>
<p>b. 同步过程中需避免新建 Topic、ACL 等。</p>
<h4 data-id="heading-13"><strong>迁移后</strong></h4>
<p><strong>1. 下线验证：</strong> 客户确认接入点是否完成变更、流量是否符合预期、CKafka 实例负载是否正常，迁移完成后观察至少10分钟。</p>
<p><strong>2. 下线自建集群：</strong> 第一步验证无误后，可操作自建 Kafka 集群的节点下线。</p>
<p><strong>3. 集群标准化：</strong> 迁移完成后，腾讯云 CKafka 实例会进行一轮升级，进行通讯协议、消息协议等配置的标准化。</p>
<h3 data-id="heading-14"><strong>未来规划</strong></h3>
<p>未来，我们将持续优化迁移体验。当前版本方案在迁移完成后，仍需客户手动切换接入点，对于部分全量切换的客户而言，盘点 Kafka 集群的上下游的接入情况，修改接入点并重启是异常困难的。因此，腾讯云计划在后续版本中支持<strong>接入点 IP 复用</strong>功能。只要客户环境满足以下条件：</p>
<ol>
<li>
<p>自建 Kafka 集群部署在腾讯云上；</p>
</li>
<li>
<p>自建 Kafka 集群 Broker 节点下线后，对应的子网 IP 能提供给腾讯云 CKafka 侧。</p>
</li>
</ol>
<p>客户便无需修改任何客户端配置或重启应用，真正实现代码零改动的透明迁移，进一步降低用户的操作成本与迁移风险。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4080e60a1584bba869cc8944a52091b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5Lit6Ze05Lu2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765963816&amp;x-signature=56acON0lOgV3N0VMUVuNm8zBZdo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-15"><strong>腾讯云 CKafka 联邦迁移客户价值</strong></h2>
<p>通过联邦集群迁移方案，客户能够以更平滑、更低成本、更低风险的方式实现自建 Kafka 集群上云，真正做到"业务无感知"的平滑迁移。</p>
<p><strong>成本效益优化</strong></p>
<ol>
<li>
<p>显著降低迁移复杂度与成本，无需梳理复杂的业务上下游依赖关系，降低人力成本。</p>
</li>
<li>
<p>避免业务重构成本，业务逻辑零改动。</p>
</li>
<li>
<p>避免因迁移产生的额外技术改造成本，兼容事务、幂等等高阶特性，关键业务功能不受影响，避免功能重新开发。</p>
</li>
</ol>
<p><strong>风险控制</strong></p>
<ol>
<li>
<p>降低迁移决策风险与成本，兼顾消息顺序与数据一致性，实现真正的无损切换。</p>
</li>
<li>
<p>支持更安全的回滚机制，回滚时不会丢失业务数据。</p>
</li>
<li>
<p>支持灰度策略，可渐进式完成流量切换。</p>
</li>
</ol>
<p><strong>业务连续性保障</strong></p>
<ol>
<li>
<p>当前版本的联邦迁移方案，迁移过程中可正常生产消费，数据层面无中断，连接层面仅存在短暂连接切换。</p>
</li>
<li>
<p>规划中的接入点 IP 复用能力，可让连接层面零感知，真正实现代码零改动的透明迁移。</p>
</li>
</ol>
<h2 data-id="heading-16"><strong>总结</strong></h2>
<p>在日常客户交流中，我们深切感受到客户对 Kafka 上云的价值普遍认同，然而，如何实现平滑无感的迁移成为上云过程中的主要挑战。</p>
<p>目前，腾讯云 CKafka 首发的集群联邦迁移方案已进入灰度阶段，已完成多个大型客户上云场景的支持。对于上下游依赖链路复杂、数据一致性、业务连续性要求有极高要求的客户，可以联系腾讯云 CKafka 团队，我们将通过集群联邦的方式为您提供 Kafka 集群无感无损上云支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Anthropic 收购 Bun：当 AI 巨头决定掌控底层代码基建]]></title>    <link>https://juejin.cn/post/7581888578538373158</link>    <guid>https://juejin.cn/post/7581888578538373158</guid>    <pubDate>2025-12-10T09:40:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581888578538373158" data-draft-id="7582048028392161330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Anthropic 收购 Bun：当 AI 巨头决定掌控底层代码基建"/> <meta itemprop="keywords" content="Bun,Claude"/> <meta itemprop="datePublished" content="2025-12-10T09:40:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Anthropic 收购 Bun：当 AI 巨头决定掌控底层代码基建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:40:24.000Z" title="Wed Dec 10 2025 09:40:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>硅谷的 AI 竞赛已经进入 next level 了，原本卷模型参数，现在开始卷应用生态和底层基建。</p>
<p>当地时间 12 月 2 日，Anthropic 宣布收购热门 JavaScript 运行时工具 Bun。这并非一次简单的人才收购（Acqui-hire），而是一场经过深思熟虑的战略布局。对于刚刚宣布 Claude Code 年化营收突破 10 亿美元的 Anthropic 而言，拿下 Bun，他们不再满足于仅仅提供 AI 模型，而是要将 AI 编程的底层发动机握在自己手中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f49a545dba0469fadcd95e83a13ba30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765964424&amp;x-signature=WuTevKF%2FHZlE8H0JKR6yY5qdECk%3D" alt="" loading="lazy"/></p>
<p>这场收购不仅关乎两家公司的命运，更预示着在 AI 编程时代，开发工具链将发生本质性的变化。</p>
<h3 data-id="heading-0">为什么是 Bun？</h3>
<p>在外界看来，Bun 是一个以快著称的 Node.js 替代品；但在 Anthropic 眼中，Bun 是 AI Agent最佳的载体。</p>
<p>Claude Code、FactoryAI、OpenCode 等新一代 AI 编程工具，其核心运行逻辑与传统的 Web 开发截然不同。传统的 Web 开发依赖服务器环境，而 AI 编程工具往往需要以 CLI 的形式分发到用户的本地环境中运行。</p>
<p>那问题就来了。如果用 Node.js 编写工具，用户必须先安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Fnodejs" target="_blank" title="https://www.servbay.com/nodejs" ref="nofollow noopener noreferrer">Node 环境</a>，且面临依赖管理的混乱。</p>
<p>Bun 完美解决了这个问题。它支持将 JavaScript 项目编译成单文件可执行程序（Single-file Executables）。那开发者可以把一个复杂的 AI 智能体打包成一个独立的二进制文件，用户无需安装任何环境即可直接运行。加上 Bun 原生支持 TypeScript 且启动速度极快，它天然契合了 AI 智能体随处运行、快速响应的需求。</p>
<p>实际上，Claude Code 的底层正是由 Bun 构建。在过去几个月中，Bun 团队与 Anthropic 保持了紧密合作，甚至 Bun 代码库中贡献代码最多的用户之一，就是 Claude Code 的自动修复机器人。这种深度的技术依赖，让收购变得顺理成章——Anthropic 不希望自己核心产品的地基掌握在一家不确定的初创公司手中。</p>
<h3 data-id="heading-1">告别云托管焦虑，回归技术本源</h3>
<p>对于 Bun 的创始人 Jarred Sumner 及其团队来说，加入 Anthropic 或许是最好的归宿。</p>
<p>众所周知，Bun是开源工具，所以其商业化始终是一个难题。按照传统的剧本，Bun 最终不得不走上 Deno 或 Vercel 的老路，那就是通过售卖云托管服务来变现。</p>
<p>Jarred 敏锐地意识到，这条路已经过时了。他在采访中坦言，当 AI 编程工具正在重塑软件生产方式时，强迫自己去通过云托管变现感觉是“不对的”。</p>
<p>加入 Anthropic 解决了 Bun 最大的后顾之忧，那就是生存。Bun 不再需要为了取悦投资人而从开源项目中榨取利润，也不必为了商业化而强行捆绑云服务。Anthropic 拥有充足的资金，他们需要的只是 Bun 变得更快、更稳、更好用。</p>
<p>这不仅让 Bun 获得了长期的稳定性，也让 JavaScript 社区吃下了一颗定心丸，Bun 将继续保持开源，维持 MIT 协议，并拥有更多的资源来挑战 Node.js 的地位。</p>
<h3 data-id="heading-2">AI 编程时代的垂直整合</h3>
<p>这次收购释放了一个明确的信号，未来的软件工程，代码将主要由 AI 编写、测试和部署。</p>
<p>在人类主导编程的时代，我们容忍复杂的配置和缓慢的构建速度。但在 AI 主导的时代，代码生成的数量和速度将呈指数级增长。当 Agent 在几秒钟内生成并测试数千行代码时，底层的运行时环境必须具备极高的吞吐量和极低的延迟。</p>
<p>Anthropic 收购 Bun，实则是为了打造一个垂直整合的 AI 编程栈：</p>
<ul>
<li>
<p><strong>顶层：</strong> Claude 模型提供智力支持。</p>
</li>
<li>
<p><strong>应用层：</strong> Claude Code 提供交互界面。</p>
</li>
<li>
<p><strong>底层：</strong> Bun 提供高效的执行环境和分发机制。</p>
</li>
</ul>
<p>这种整合将产生巨大的协同效应。Claude Code 团队可以更早地洞察 AI 编程对基础设施的需求，直接反哺 Bun 的开发；而 Bun 的性能提升，又将直接转化为 Claude Code 的用户体验优势。</p>
<h3 data-id="heading-3">结语：更低的门槛，更快的未来</h3>
<p>有评论认为，随着 AI 智能体的爆发，JavaScript（及其超集 TypeScript）正在成为最适合智能体的语言。它拥有 V8 和 JavaScriptCore 这样成熟且高性能的沙箱引擎，能在任何设备上安全运行。</p>
<p>Anthropic 对 Bun 的押注，某种程度上也是对 JavaScript 生态未来的押注。对于开发者而言，未来的图景正在变得清晰：我们可能不再需要关注繁琐的 Webpack 配置或 Node 版本管理，AI 将通过基于 Bun 的高效工具链，帮我们处理掉所有脏活累活。</p>
<p>这种“去配置化、高效率”的趋势，在当下的开发工具中已初见端倪。对于现在就想体验 Bun 极致性能，但又不想陷入繁琐环境配置的开发者来说，工具链的进化带来了极大的便利。</p>
<p>例如 <strong>ServBay</strong> 这样的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">本地开发环境管理</a>工具，已经支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures" target="_blank" title="https://www.servbay.com/features" ref="nofollow noopener noreferrer">一键安装 Bun</a>。它免去了复杂的环境变量设置和版本冲突烦恼，让开发者能够跳过枯燥的准备工作，直接进入高性能开发的世界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f1b878aeb72480ab746e73c28bd3408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765964424&amp;x-signature=5mZFw9Z4GHwGqSKRDlMIUOBDOMY%3D" alt="" loading="lazy"/></p>
<p>无论是 Anthropic 收购 Bun，还是 ServBay 这样工具的出现，都在指向同一个方向，让技术回归服务于创造，让基础设施变得隐形且强大。Bun 的故事没有结束，它只是换了一个更广阔的舞台。正如 Jarred 所说，这让他能够亲眼见证并参与塑造 AI 编程的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 核心概念]]></title>    <link>https://juejin.cn/post/7581876069608964139</link>    <guid>https://juejin.cn/post/7581876069608964139</guid>    <pubDate>2025-12-10T09:36:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581876069608964139" data-draft-id="7581858890607968292" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Node.js 核心概念"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T09:36:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梨子同志"/> <meta itemprop="url" content="https://juejin.cn/user/2084329779627965"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Node.js 核心概念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329779627965/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梨子同志
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:36:30.000Z" title="Wed Dec 10 2025 09:36:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Node.js 简介</h2>
<h3 data-id="heading-1">1.1 什么是 Node.js？</h3>
<p><strong>Node.js</strong> 是一个免费、开源的跨平台 JavaScript 运行时环境，它允许开发者在浏览器之外运行 JavaScript 代码。</p>
<h4 data-id="heading-2">通俗理解</h4>
<p>想象一下：</p>
<ul>
<li><strong>浏览器中的 JavaScript</strong>：只能在网页中运行，受浏览器限制</li>
<li><strong>Node.js</strong>：让 JavaScript 可以在服务器、命令行、桌面应用等任何地方运行</li>
</ul>
<p><strong>Node.js 的本质</strong>：</p>
<ul>
<li>❌ <strong>不是</strong>一门编程语言（JavaScript 才是语言）</li>
<li>❌ <strong>不是</strong>一个框架或库（Express、Koa 才是框架）</li>
<li>✅ <strong>是</strong>一个运行时（Runtime）环境，就像浏览器是 JavaScript 在网页中的运行环境一样</li>
</ul>
<h4 data-id="heading-3">技术定义</h4>
<p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行时，它使用事件驱动、非阻塞 I/O 模型，使其轻量且高效。</p>
<h3 data-id="heading-4">1.2 核心特点</h3>
<h4 data-id="heading-5">1.2.1 事件驱动（Event-driven）</h4>
<p><strong>通俗理解</strong>：就像餐厅的服务模式</p>
<ul>
<li>传统方式：一个服务员服务一桌客人，必须等这桌客人吃完才能服务下一桌</li>
<li>事件驱动：一个服务员可以同时服务多桌，哪桌需要服务就去哪桌</li>
</ul>
<p><strong>技术说明</strong>：采用事件驱动架构，程序的执行流程由事件的发生来决定，能够高效处理并发操作。</p>
<h4 data-id="heading-6">1.2.2 非阻塞（Non-blocking）</h4>
<p><strong>通俗理解</strong>：就像多任务处理</p>
<ul>
<li>阻塞方式：做一件事时必须等它完成才能做下一件事</li>
<li>非阻塞方式：可以同时处理多件事，不需要等待</li>
</ul>
<p><strong>技术说明</strong>：使用非阻塞 I/O 模型，不会因为等待一个操作完成而阻塞其他操作。</p>
<h4 data-id="heading-7">1.2.3 高性能</h4>
<p><strong>通俗理解</strong>：能够同时处理大量连接，就像一家高效的餐厅，一个服务员可以同时服务很多桌客人。</p>
<p><strong>技术说明</strong>：非常适合构建实时应用和高流量网站。</p>
<h3 data-id="heading-8">1.3 应用场景</h3>
<p>Node.js 可以用于构建各种类型的应用：</p>
<h4 data-id="heading-9">Web 开发</h4>
<ul>
<li><strong>Web 服务器和网站</strong>：构建高性能的 HTTP 服务器</li>
<li><strong>REST API</strong>：开发后端 API 服务</li>
<li><strong>实时应用</strong>：聊天应用、在线游戏服务器、协作工具</li>
</ul>
<h4 data-id="heading-10">工具开发</h4>
<ul>
<li><strong>命令行工具（CLI）</strong>：开发各种开发工具和脚本（如 npm、webpack）</li>
<li><strong>构建工具</strong>：前端构建工具、打包工具</li>
</ul>
<h4 data-id="heading-11">系统应用</h4>
<ul>
<li><strong>文件操作和数据库操作</strong>：处理文件系统和数据库交互</li>
<li><strong>IoT 和硬件控制</strong>：物联网应用开发</li>
<li><strong>桌面应用</strong>：使用 Electron 框架开发桌面应用（如 VS Code）</li>
</ul>
<h3 data-id="heading-12">1.4 如何运行 Node.js 代码</h3>
<h4 data-id="heading-13">基本运行方式</h4>
<p>将代码保存到文件中（例如 <code>app.js</code>），然后在终端或命令提示符中运行：</p>
<pre><code class="hljs language-bash" lang="bash">node app.js
</code></pre>
<h4 data-id="heading-14">第一个 Node.js 程序</h4>
<p><strong>示例：创建一个简单的 Web 服务器</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>});
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Hello World!'</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'服务器运行在 http://localhost:8080'</span>);
});
</code></pre>
<p>运行后，访问 <code>http://localhost:8080</code> 即可看到 "Hello World!"。</p>
<h4 data-id="heading-15">REPL 交互模式</h4>
<p>Node.js 还提供了交互式环境（REPL - Read-Eval-Print Loop）：</p>
<pre><code class="hljs language-bash" lang="bash">node
&gt; console.log(<span class="hljs-string">'Hello Node.js'</span>)
Hello Node.js
undefined
&gt; 1 + 1
2
</code></pre>
<h4 data-id="heading-16">检查 Node.js 版本</h4>
<pre><code class="hljs language-bash" lang="bash">node --version
<span class="hljs-comment"># 或</span>
node -v
</code></pre>
<hr/>
<h2 data-id="heading-17">二、V8 引擎</h2>
<h3 data-id="heading-18">2.1 什么是 V8 引擎？</h3>
<p><strong>V8 引擎</strong>就像是 JavaScript 代码的"翻译官"和"执行器"。想象一下：</p>
<ul>
<li><strong>JavaScript 代码</strong>：你写的代码是人类可读的文本</li>
<li><strong>计算机</strong>：只能理解 0 和 1 的机器码</li>
<li><strong>V8 引擎</strong>：中间的翻译官，把 JavaScript 代码转换成计算机能理解的机器码</li>
</ul>
<p><strong>V8</strong> 是由 Google 开发的高性能 JavaScript 引擎，最初用于 Chrome 浏览器。Node.js 的核心依赖于 V8 引擎来执行 JavaScript 代码。</p>
<h3 data-id="heading-19">2.2 为什么需要 V8 引擎？</h3>
<h4 data-id="heading-20">2.2.1 计算机不能直接理解 JavaScript</h4>
<p>计算机的 CPU 只能执行机器码（由 0 和 1 组成的二进制代码），而 JavaScript 是人类可读的高级语言。因此需要一个"翻译器"来转换：</p>
<pre><code class="hljs">JavaScript 代码 → V8 引擎 → 机器码 → CPU 执行
</code></pre>
<h4 data-id="heading-21">2.2.2 两种执行方式的对比</h4>
<p><strong>方式一：解释执行（慢）</strong></p>
<pre><code class="hljs">JavaScript 代码 → 逐行解释 → 执行
</code></pre>
<ul>
<li>就像同声传译，说一句翻译一句</li>
<li>每次运行都要重新翻译</li>
<li>速度较慢</li>
</ul>
<p><strong>方式二：编译执行（快）</strong></p>
<pre><code class="hljs">JavaScript 代码 → 编译成机器码 → 直接执行
</code></pre>
<ul>
<li>就像提前翻译好整本书，然后直接阅读</li>
<li>编译一次，可以多次快速执行</li>
<li>速度更快</li>
</ul>
<p><strong>V8 引擎采用编译执行</strong>，这就是为什么 Node.js 能够快速运行 JavaScript 代码的原因。</p>
<h3 data-id="heading-22">2.3 V8 引擎的工作原理</h3>
<h4 data-id="heading-23">第一步：解析代码</h4>
<pre><code class="hljs">你的 JavaScript 代码 → V8 解析 → 抽象语法树（AST）
</code></pre>
<p>就像把一篇文章分解成句子和词语，理解代码的结构。</p>
<h4 data-id="heading-24">第二步：编译为机器码</h4>
<pre><code class="hljs">抽象语法树 → V8 编译 → 机器码
</code></pre>
<p>把理解后的代码转换成计算机能直接执行的机器码。</p>
<h4 data-id="heading-25">第三步：即时编译（JIT）优化</h4>
<p>V8 使用 <strong>即时编译（Just-In-Time, JIT）</strong> 技术：</p>
<ol>
<li><strong>首次执行</strong>：快速编译，先让代码能运行起来</li>
<li><strong>运行监控</strong>：观察哪些代码执行频繁</li>
<li><strong>优化编译</strong>：对热点代码进行深度优化</li>
<li><strong>替换执行</strong>：用优化后的代码替换原来的代码</li>
</ol>
<p><strong>类比</strong>：就像学习一门新技能，先快速上手，然后针对常用部分反复练习优化。</p>
<h4 data-id="heading-26">第四步：执行机器码</h4>
<p>编译好的机器码直接在 CPU 上执行，速度接近原生代码。</p>
<h3 data-id="heading-27">2.4 V8 引擎如何让 JavaScript 变快？</h3>
<h4 data-id="heading-28">2.4.1 编译优化技术</h4>
<p>V8 使用多种优化技术提升性能：</p>
<ul>
<li><strong>内联缓存（Inline Cache）</strong>：记住对象的属性位置，下次访问更快</li>
<li><strong>隐藏类（Hidden Classes）</strong>：优化对象属性的访问速度</li>
<li><strong>垃圾回收优化</strong>：高效管理内存，自动清理不用的对象</li>
</ul>
<h4 data-id="heading-29">2.4.2 性能对比示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这段代码会被 V8 优化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 第一次调用：编译并执行（稍慢）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// 后续调用：使用优化后的机器码（很快）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
  <span class="hljs-title function_">add</span>(i, i + <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-30">2.5 V8 在 Node.js 中的作用</h3>
<p>V8 引擎在 Node.js 中扮演着核心角色：</p>
<ol>
<li>
<p><strong>JavaScript 执行器</strong></p>
<ul>
<li>负责解析和执行你写的 JavaScript 代码</li>
<li>没有 V8，Node.js 就无法运行 JavaScript</li>
</ul>
</li>
<li>
<p><strong>性能加速器</strong></p>
<ul>
<li>通过编译优化，让 JavaScript 代码运行得更快</li>
<li>使得 Node.js 能够处理高并发请求</li>
</ul>
</li>
<li>
<p><strong>内存管理员</strong></p>
<ul>
<li>自动管理内存分配和回收</li>
<li>当对象不再使用时，自动清理内存（垃圾回收）</li>
</ul>
</li>
<li>
<p><strong>跨平台支持</strong></p>
<ul>
<li>V8 支持 Windows、macOS、Linux 等多个平台</li>
<li>使 Node.js 能够在不同操作系统上运行</li>
</ul>
</li>
</ol>
<h3 data-id="heading-31">2.6 总结：V8 引擎的重要性</h3>
<ul>
<li><strong>V8 是 Node.js 的心脏</strong>：没有 V8，Node.js 就无法运行 JavaScript</li>
<li><strong>V8 让 JavaScript 变快</strong>：通过编译优化，性能接近原生代码</li>
<li><strong>V8 简化了开发</strong>：开发者只需写 JavaScript，V8 负责底层优化</li>
<li><strong>V8 是开源的</strong>：由 Google 维护，持续优化和改进</li>
</ul>
<hr/>
<h2 data-id="heading-32">三、单线程模型</h2>
<h3 data-id="heading-33">3.1 什么是单线程？</h3>
<p><strong>单线程模型</strong>是 Node.js 的核心特性之一，理解它对于掌握 Node.js 至关重要。</p>
<h4 data-id="heading-34">通俗理解</h4>
<p>想象一个餐厅的服务模式：</p>
<p><strong>多线程模式（传统服务器）</strong>：</p>
<ul>
<li>每个客人分配一个服务员</li>
<li>100 个客人需要 100 个服务员</li>
<li>成本高，管理复杂</li>
</ul>
<p><strong>单线程模式（Node.js）</strong>：</p>
<ul>
<li>只有一个主服务员（主线程）</li>
<li>但这个服务员非常高效，可以同时处理很多客人的需求</li>
<li>成本低，管理简单</li>
</ul>
<h4 data-id="heading-35">技术定义</h4>
<p>Node.js 采用<strong>单线程模型</strong>，这意味着：</p>
<ul>
<li><strong>主线程单一</strong>：JavaScript 代码运行在单一的主线程中</li>
<li><strong>避免锁竞争</strong>：单线程避免了传统多线程编程中的锁和竞态条件问题</li>
<li><strong>简化编程模型</strong>：开发者不需要担心线程同步和死锁问题</li>
</ul>
<h3 data-id="heading-36">3.2 单线程的误区澄清</h3>
<h4 data-id="heading-37">常见误解</h4>
<p>❌ <strong>误解</strong>：Node.js 只有一个线程，所以性能很差
✅ <strong>真相</strong>：虽然 JavaScript 代码在单线程中运行，但 Node.js 在后台使用了多线程</p>
<h4 data-id="heading-38">真相说明</h4>
<p>虽然 JavaScript 在 Node.js 中是单线程的，但需要注意：</p>
<ol>
<li>
<p><strong>后台线程池</strong></p>
<ul>
<li>libuv 库在后台使用线程池处理某些操作（如文件系统操作）</li>
<li>默认线程池大小为 4，可以通过 <code>UV_THREADPOOL_SIZE</code> 环境变量调整</li>
</ul>
</li>
<li>
<p><strong>系统内核多线程</strong></p>
<ul>
<li>现代操作系统内核是多线程的，能够在后台处理多个操作</li>
<li>I/O 操作由操作系统内核处理，不占用 JavaScript 主线程</li>
</ul>
</li>
<li>
<p><strong>非阻塞操作</strong></p>
<ul>
<li>通过非阻塞 I/O，单线程也能高效处理并发</li>
<li>主线程只负责协调和调度，实际工作由系统完成</li>
</ul>
</li>
</ol>
<h4 data-id="heading-39">架构示意</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────┐
│    JavaScript 主线程（单线程）       │
│    - 执行你的代码                    │
│    - 协调异步操作                    │
├─────────────────────────────────────┤
│    libuv 线程池（多线程）            │
│    - 文件系统操作                    │
│    - DNS 查询                        │
│    - CPU 密集型任务                  │
├─────────────────────────────────────┤
│    操作系统内核（多线程）            │
│    - 网络 <span class="hljs-selector-tag">I</span>/O                        │
│    - 磁盘 <span class="hljs-selector-tag">I</span>/O                        │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-40">3.3 单线程的优势</h3>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Flearn%2Fasynchronous-work%2Fevent-loop-timers-and-nexttick" target="_blank" title="https://nodejs.org/zh-cn/learn/asynchronous-work/event-loop-timers-and-nexttick" ref="nofollow noopener noreferrer">Node.js 官方文档</a>：</p>
<h4 data-id="heading-41">3.3.1 避免上下文切换开销</h4>
<p><strong>通俗理解</strong>：就像一个人专心做一件事，不需要在不同任务间切换，效率更高。</p>
<p><strong>技术说明</strong>：不需要在线程间切换，减少系统开销。</p>
<h4 data-id="heading-42">3.3.2 简化并发编程</h4>
<p><strong>通俗理解</strong>：不需要担心"两个人同时修改同一个东西"的问题。</p>
<p><strong>技术说明</strong>：不需要处理线程同步问题，避免了死锁、竞态条件等复杂问题。</p>
<h4 data-id="heading-43">3.3.3 内存效率</h4>
<p><strong>通俗理解</strong>：一个人工作比多个人工作占用更少的资源。</p>
<p><strong>技术说明</strong>：单线程模型内存占用更少，每个线程都需要独立的内存空间。</p>
<h3 data-id="heading-44">3.4 单线程的挑战与解决方案</h3>
<h4 data-id="heading-45">3.4.1 CPU 密集型任务的问题</h4>
<p><strong>问题示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 这会阻塞事件循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">heavyComputation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000000</span>; i++) {
    sum += i;
  }
  <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 执行这个函数会阻塞所有其他操作</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heavyComputation</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算完成'</span>);
</code></pre>
<p><strong>影响</strong>：单线程不适合 CPU 密集型任务，会阻塞事件循环，导致其他请求无法处理。</p>
<h4 data-id="heading-46">3.4.2 解决方案</h4>
<p><strong>方案一：Worker Threads（工作线程）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">Worker</span>, isMainThread, parentPort } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'worker_threads'</span>);

<span class="hljs-keyword">if</span> (isMainThread) {
  <span class="hljs-comment">// 主线程：创建工作线程</span>
  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(__filename);
  worker.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果:'</span>, result);
  });
  worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">end</span>: <span class="hljs-number">10000000000</span> });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 工作线程：执行计算</span>
  parentPort.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">{ start, end }</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
      sum += i;
    }
    parentPort.<span class="hljs-title function_">postMessage</span>(sum);
  });
}
</code></pre>
<p><strong>方案二：Cluster 模块（多进程）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);

<span class="hljs-keyword">if</span> (cluster.<span class="hljs-property">isMaster</span>) {
  <span class="hljs-comment">// 主进程：创建工作进程</span>
  <span class="hljs-keyword">const</span> numCPUs = os.<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numCPUs; i++) {
    cluster.<span class="hljs-title function_">fork</span>();
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 工作进程：处理请求</span>
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app.js'</span>);
}
</code></pre>
<h3 data-id="heading-47">3.5 总结：单线程的重要性</h3>
<ul>
<li><strong>单线程简化了编程</strong>：不需要处理复杂的线程同步问题</li>
<li><strong>单线程提高了效率</strong>：避免了上下文切换的开销</li>
<li><strong>单线程不是限制</strong>：通过异步 I/O 和事件驱动，单线程也能高效处理并发</li>
<li><strong>需要时可以使用多线程</strong>：Worker Threads 和 Cluster 提供了多线程/多进程的能力</li>
</ul>
<hr/>
<h2 data-id="heading-48">四、非阻塞 I/O</h2>
<h3 data-id="heading-49">4.1 什么是非阻塞 I/O？</h3>
<p><strong>非阻塞 I/O（Non-blocking I/O）</strong> 是 Node.js 的核心特性之一，也是 Node.js 高性能的关键。</p>
<h4 data-id="heading-50">通俗理解</h4>
<p>想象你在餐厅点餐：</p>
<p><strong>阻塞方式（同步）</strong>：</p>
<ul>
<li>你点完餐后，必须坐在座位上等待</li>
<li>菜没上来之前，你不能做任何其他事情</li>
<li>如果等 10 分钟，你就浪费了 10 分钟</li>
</ul>
<p><strong>非阻塞方式（异步）</strong>：</p>
<ul>
<li>你点完餐后，可以去做其他事情（看书、打电话）</li>
<li>菜好了，服务员会通知你</li>
<li>等待的时间没有被浪费，你可以处理其他事情</li>
</ul>
<h4 data-id="heading-51">技术定义</h4>
<p>非阻塞 I/O 允许 Node.js 在等待 I/O 操作（如文件读取、网络请求）完成时，继续处理其他任务，而不是阻塞等待。</p>
<h3 data-id="heading-52">4.2 阻塞 vs 非阻塞对比</h3>
<h4 data-id="heading-53">4.2.1 阻塞方式（同步）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始读取文件...'</span>);

<span class="hljs-comment">// ❌ 阻塞：程序会等待文件读取完成才继续执行</span>
<span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件内容:'</span>, data);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会在文件读取完成后才执行'</span>);
</code></pre>
<p><strong>执行顺序</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 开始读取文件...
<span class="hljs-bullet">2.</span> [等待文件读取...] ← 阻塞在这里
<span class="hljs-bullet">3.</span> 文件内容: ...
<span class="hljs-bullet">4.</span> 这行代码会在文件读取完成后才执行
</code></pre>
<p><strong>问题</strong>：如果文件很大或网络很慢，程序会一直等待，无法处理其他请求。</p>
<h4 data-id="heading-54">4.2.2 非阻塞方式（异步）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始读取文件...'</span>);

<span class="hljs-comment">// ✅ 非阻塞：程序立即继续执行，不等待文件读取完成</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取错误:'</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件内容:'</span>, data);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会立即执行，不等待文件读取'</span>);
</code></pre>
<p><strong>执行顺序</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 开始读取文件...
<span class="hljs-bullet">2.</span> 这行代码会立即执行，不等待文件读取 ← 立即执行
<span class="hljs-bullet">3.</span> [文件在后台读取中...]
<span class="hljs-bullet">4.</span> 文件内容: ... ← 读取完成后执行回调
</code></pre>
<p><strong>优势</strong>：程序可以立即处理其他任务，不会因为等待 I/O 而阻塞。</p>
<h3 data-id="heading-55">4.3 非阻塞 I/O 的工作原理</h3>
<p>根据 Node.js 官方文档，非阻塞 I/O 的工作流程如下：</p>
<h4 data-id="heading-56">详细流程</h4>
<pre><code class="hljs language-less" lang="less">┌─────────────────────────────────────────┐
│  <span class="hljs-number">1</span>. 发起 <span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span> 请求                        │
│     <span class="hljs-selector-tag">fs</span><span class="hljs-selector-class">.readFile</span>(<span class="hljs-string">'file.txt'</span>, callback)   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">2</span>. <span class="hljs-selector-tag">Node</span><span class="hljs-selector-class">.js</span> 将操作交给系统内核           │
│     <span class="hljs-selector-tag">-</span> 不等待，立即返回                   │
│     <span class="hljs-selector-tag">-</span> 继续执行后续代码                   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">3</span>. 系统内核（多线程）处理 <span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span>           │
│     <span class="hljs-selector-tag">-</span> 文件系统操作                       │
│     <span class="hljs-selector-tag">-</span> 网络请求                           │
│     <span class="hljs-selector-tag">-</span> 数据库查询                         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">4</span>. <span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span> 操作完成                         │
│     <span class="hljs-selector-tag">-</span> 内核通知 <span class="hljs-selector-tag">Node</span><span class="hljs-selector-class">.js</span>                  │
│     <span class="hljs-selector-tag">-</span> 回调函数被添加到事件队列           │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">5</span>. 事件循环执行回调                     │
│     <span class="hljs-selector-tag">-</span> 从队列中取出回调                   │
│     <span class="hljs-selector-tag">-</span> 在主线程中执行                     │
└─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-57">实际例子</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 开始'</span>);

<span class="hljs-comment">// 发起三个文件读取请求</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 文件1读取完成'</span>);
});

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 文件2读取完成'</span>);
});

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. 文件3读取完成'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 所有请求已发起，继续执行其他代码'</span>);

<span class="hljs-comment">// 输出顺序可能是：</span>
<span class="hljs-comment">// 1. 开始</span>
<span class="hljs-comment">// 2. 所有请求已发起，继续执行其他代码</span>
<span class="hljs-comment">// 3. 文件1读取完成（哪个先完成先输出）</span>
<span class="hljs-comment">// 4. 文件2读取完成</span>
<span class="hljs-comment">// 5. 文件3读取完成</span>
</code></pre>
<h3 data-id="heading-58">4.4 非阻塞 I/O 的优势</h3>
<h4 data-id="heading-59">4.4.1 高并发处理</h4>
<p><strong>对比示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 阻塞方式：一次只能处理一个请求</span>
<span class="hljs-keyword">const</span> data1 = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'file1.txt'</span>); <span class="hljs-comment">// 等待 100ms</span>
<span class="hljs-keyword">const</span> data2 = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'file2.txt'</span>); <span class="hljs-comment">// 等待 100ms</span>
<span class="hljs-keyword">const</span> data3 = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'file3.txt'</span>); <span class="hljs-comment">// 等待 100ms</span>
<span class="hljs-comment">// 总时间：300ms</span>

<span class="hljs-comment">// ✅ 非阻塞方式：可以同时处理多个请求</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, callback1); <span class="hljs-comment">// 立即返回</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, callback2); <span class="hljs-comment">// 立即返回</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, callback3); <span class="hljs-comment">// 立即返回</span>
<span class="hljs-comment">// 总时间：约 100ms（三个文件并行读取）</span>
</code></pre>
<h4 data-id="heading-60">4.4.2 资源高效利用</h4>
<ul>
<li><strong>CPU 时间不被浪费</strong>：等待 I/O 时可以处理其他任务</li>
<li><strong>内存使用更高效</strong>：不需要为每个请求创建线程</li>
<li><strong>系统资源充分利用</strong>：操作系统内核处理 I/O，Node.js 处理业务逻辑</li>
</ul>
<h4 data-id="heading-61">4.4.3 适合 I/O 密集型应用</h4>
<p>非常适合处理：</p>
<ul>
<li>大量网络请求（API 服务）</li>
<li>文件操作（文件服务器）</li>
<li>数据库查询（数据密集型应用）</li>
</ul>
<h3 data-id="heading-62">4.5 现代异步编程方式</h3>
<h4 data-id="heading-63">4.5.1 回调函数（Callback）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'内容:'</span>, data);
});
</code></pre>
<p><strong>问题</strong>：回调嵌套（回调地狱）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 回调地狱</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data1</span>) =&gt;</span> {
  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data2</span>) =&gt;</span> {
    fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data3</span>) =&gt;</span> {
      <span class="hljs-comment">// 嵌套太深，难以维护</span>
    });
  });
});
</code></pre>
<h4 data-id="heading-64">4.5.2 Promise</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).<span class="hljs-property">promises</span>;

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'内容:'</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, err);
  });

<span class="hljs-comment">// 链式调用，解决回调地狱</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, <span class="hljs-string">'utf8'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data1</span> =&gt;</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, <span class="hljs-string">'utf8'</span>))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data2</span> =&gt;</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, <span class="hljs-string">'utf8'</span>))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data3</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有文件读取完成'</span>);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, err));
</code></pre>
<h4 data-id="heading-65">4.5.3 Async/Await（推荐）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).<span class="hljs-property">promises</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFiles</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, <span class="hljs-string">'utf8'</span>);
    <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, <span class="hljs-string">'utf8'</span>);
    <span class="hljs-keyword">const</span> data3 = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, <span class="hljs-string">'utf8'</span>);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有文件读取完成'</span>);
    <span class="hljs-keyword">return</span> { data1, data2, data3 };
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
}

<span class="hljs-comment">// 并行读取（更高效）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFilesParallel</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> [data1, data2, data3] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file1.txt'</span>, <span class="hljs-string">'utf8'</span>),
      fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file2.txt'</span>, <span class="hljs-string">'utf8'</span>),
      fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file3.txt'</span>, <span class="hljs-string">'utf8'</span>)
    ]);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有文件并行读取完成'</span>);
    <span class="hljs-keyword">return</span> { data1, data2, data3 };
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
}
</code></pre>
<h3 data-id="heading-66">4.6 总结：非阻塞 I/O 的重要性</h3>
<ul>
<li><strong>非阻塞是 Node.js 高性能的基础</strong>：允许同时处理大量 I/O 操作</li>
<li><strong>充分利用系统资源</strong>：操作系统内核处理 I/O，Node.js 处理业务逻辑</li>
<li><strong>适合现代应用</strong>：现代应用大多是 I/O 密集型的（网络请求、数据库查询）</li>
<li><strong>使用现代语法</strong>：推荐使用 async/await，代码更清晰易读</li>
</ul>
<hr/>
<h2 data-id="heading-67">五、事件驱动架构</h2>
<h3 data-id="heading-68">5.1 什么是事件驱动？</h3>
<p><strong>事件驱动（Event-driven）</strong> 是一种编程范式，程序的执行流程由事件的发生来决定。</p>
<h4 data-id="heading-69">通俗理解</h4>
<p>想象一个餐厅的服务模式：</p>
<p><strong>传统方式（轮询）</strong>：</p>
<ul>
<li>服务员每隔一段时间就去每桌问："需要服务吗？"</li>
<li>即使客人不需要服务，也要不停地问</li>
<li>浪费时间和精力</li>
</ul>
<p><strong>事件驱动方式</strong>：</p>
<ul>
<li>客人需要服务时，按铃或举手</li>
<li>服务员听到铃声后，立即去服务</li>
<li>不需要服务时，服务员可以休息</li>
<li>高效且节省资源</li>
</ul>
<h4 data-id="heading-70">技术定义</h4>
<p>Node.js 采用事件驱动架构，程序的执行流程由事件的发生来决定。当事件发生时，执行相应的回调函数，而不是主动轮询检查。</p>
<h3 data-id="heading-71">5.2 事件驱动的核心概念</h3>
<h4 data-id="heading-72">5.2.1 事件循环（Event Loop）</h4>
<p><strong>通俗理解</strong>：事件循环就像一个"待办事项管理器"</p>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────┐
│        事件循环（<span class="hljs-keyword">Event</span> <span class="hljs-keyword">Loop</span>）        │
├─────────────────────────────────────┤
│  <span class="hljs-number">1</span>. 检查是否有待处理的事件            │
│  <span class="hljs-number">2</span>. 如果有，取出一个事件               │
│  <span class="hljs-number">3</span>. 执行该事件的回调函数              │
│  <span class="hljs-number">4</span>. 重复步骤 <span class="hljs-number">1</span>-<span class="hljs-number">3</span>                     │
│  <span class="hljs-number">5</span>. 如果没有事件，进入休眠状态        │
└─────────────────────────────────────┘
</code></pre>
<p><strong>技术说明</strong>：</p>
<ul>
<li>Node.js 使用事件循环来管理异步操作</li>
<li>事件循环不断检查是否有待处理的事件</li>
<li>当事件发生时，执行相应的回调函数</li>
<li>如果没有事件，Node.js 进入休眠状态，等待新事件</li>
</ul>
<h4 data-id="heading-73">5.2.2 事件发射器（Event Emitter）</h4>
<p><strong>通俗理解</strong>：就像广播电台</p>
<ul>
<li><strong>发射器（Emitter）</strong>：广播电台，可以发送信号</li>
<li><strong>监听器（Listener）</strong>：收音机，可以接收信号</li>
<li><strong>事件（Event）</strong>：广播的内容</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">EventEmitter</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);
<span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventEmitter</span>();

<span class="hljs-comment">// 监听事件（就像打开收音机，调到某个频道）</span>
emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到数据:'</span>, data);
});

emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'发生错误:'</span>, error);
});

<span class="hljs-comment">// 触发事件（就像广播电台发送信号）</span>
emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'data'</span>, <span class="hljs-string">'Hello World'</span>);
emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Something went wrong'</span>));

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 收到数据: Hello World</span>
<span class="hljs-comment">// 发生错误: Error: Something went wrong</span>
</code></pre>
<h4 data-id="heading-74">5.2.3 事件队列（Event Queue）</h4>
<p><strong>通俗理解</strong>：就像银行的排队系统</p>
<ul>
<li>事件按照发生的顺序排队</li>
<li>事件循环按顺序处理队列中的事件</li>
<li>先到先处理</li>
</ul>
<h3 data-id="heading-75">5.3 事件驱动的工作流程</h3>
<h4 data-id="heading-76">详细流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────┐
│  1. 接收请求/事件                        │
│     - HTTP 请求到达                      │
│     - 文件读取完成                        │
│     - 定时器到期                          │
└──────────────┬──────────────────────────┘
<span class="hljs-code">               │
               ▼
┌─────────────────────────────────────────┐
│  2. 事件被添加到事件队列                  │
│     - 按照发生的顺序排队                  │
│     - 等待处理                            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. 事件循环检查队列                      │
│     - 如果队列不为空，取出一个事件         │
│     - 如果队列为空，进入休眠状态          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  4. 执行事件的回调函数                    │
│     - 在主线程中执行                      │
│     - 执行完成后继续检查队列              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  5. 重复步骤 3-4，持续处理事件            │
└─────────────────────────────────────────┘
</span></code></pre>
<h4 data-id="heading-77">实际例子</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理请求:'</span>, req.<span class="hljs-property">url</span>);
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>});
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Hello World!'</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'服务器启动，等待事件...'</span>);
});

<span class="hljs-comment">// 工作流程：</span>
<span class="hljs-comment">// 1. 服务器启动，进入事件循环，等待事件</span>
<span class="hljs-comment">// 2. 客户端发送请求 → 触发 'request' 事件</span>
<span class="hljs-comment">// 3. 事件被添加到队列</span>
<span class="hljs-comment">// 4. 事件循环取出事件，执行回调函数</span>
<span class="hljs-comment">// 5. 处理完成后，继续等待下一个事件</span>
</code></pre>
<h3 data-id="heading-78">5.4 事件驱动的优势</h3>
<h4 data-id="heading-79">5.4.1 高效处理并发</h4>
<p><strong>对比示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 传统方式：轮询检查</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">checkForNewRequests</span>(); <span class="hljs-comment">// 即使没有请求也要检查</span>
}, <span class="hljs-number">100</span>);

<span class="hljs-comment">// ✅ 事件驱动：事件发生时才处理</span>
server.<span class="hljs-title function_">on</span>(<span class="hljs-string">'request'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-title function_">handleRequest</span>(req, res); <span class="hljs-comment">// 只在有请求时执行</span>
});
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>能够同时处理大量连接，而不会阻塞主线程</li>
<li>不需要为每个连接创建线程</li>
<li>资源使用更高效</li>
</ul>
<h4 data-id="heading-80">5.4.2 资源节约</h4>
<p><strong>通俗理解</strong>：就像智能家居系统</p>
<ul>
<li>传统方式：不停地检查所有设备的状态（浪费电）</li>
<li>事件驱动：设备状态改变时才通知（节省电）</li>
</ul>
<p><strong>技术说明</strong>：</p>
<ul>
<li>只在有事件时才消耗资源</li>
<li>没有事件时进入休眠状态</li>
<li>CPU 和内存使用更高效</li>
</ul>
<h4 data-id="heading-81">5.4.3 实时响应</h4>
<p>非常适合构建：</p>
<ul>
<li><strong>聊天应用</strong>：消息到达时立即处理</li>
<li><strong>在线游戏</strong>：玩家操作时立即响应</li>
<li><strong>协作工具</strong>：文档修改时实时同步</li>
<li><strong>监控系统</strong>：系统事件发生时立即处理</li>
</ul>
<h4 data-id="heading-82">5.4.4 可扩展性</h4>
<ul>
<li>能够轻松扩展到处理大量并发连接</li>
<li>单进程可以处理数万个并发连接</li>
<li>通过 Cluster 模块可以扩展到多进程</li>
</ul>
<h3 data-id="heading-83">5.5 事件驱动的实际应用</h3>
<h4 data-id="heading-84">5.5.1 文件监听</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-comment">// 监听文件变化事件</span>
fs.<span class="hljs-title function_">watch</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-function">(<span class="hljs-params">eventType, filename</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`文件 <span class="hljs-subst">${filename}</span> 发生了 <span class="hljs-subst">${eventType}</span> 事件`</span>);
  
  <span class="hljs-keyword">if</span> (eventType === <span class="hljs-string">'change'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件内容已修改'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eventType === <span class="hljs-string">'rename'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件被重命名或删除'</span>);
  }
});
</code></pre>
<h4 data-id="heading-85">5.5.2 流（Stream）事件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-comment">// 创建可读流</span>
<span class="hljs-keyword">const</span> readStream = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">'large-file.txt'</span>);

<span class="hljs-comment">// 监听 'data' 事件（数据块到达时触发）</span>
readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到数据块，大小:'</span>, chunk.<span class="hljs-property">length</span>);
});

<span class="hljs-comment">// 监听 'end' 事件（文件读取完成时触发）</span>
readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件读取完成'</span>);
});

<span class="hljs-comment">// 监听 'error' 事件（发生错误时触发）</span>
readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取错误:'</span>, err);
});
</code></pre>
<h3 data-id="heading-86">5.6 事件循环的优先级</h3>
<p>Node.js 事件循环有不同的阶段，按优先级处理：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────┐
│  <span class="hljs-number">1.</span> 定时器（Timers）                 │
│     <span class="hljs-operator">-</span> setTimeout, setInterval        │
├─────────────────────────────────────┤
│  <span class="hljs-number">2.</span> 待处理的回调（Pending Callbacks）│
│     <span class="hljs-operator">-</span> I<span class="hljs-operator">/</span>O 回调                       │
├─────────────────────────────────────┤
│  <span class="hljs-number">3.</span> 空闲<span class="hljs-operator">/</span>准备（Idle<span class="hljs-operator">/</span><span class="hljs-keyword">Prepare</span>）        │
│     <span class="hljs-operator">-</span> 内部使用                       │
├─────────────────────────────────────┤
│  <span class="hljs-number">4.</span> 轮询（Poll）                     │
│     <span class="hljs-operator">-</span> 获取新的 I<span class="hljs-operator">/</span>O 事件              │
├─────────────────────────────────────┤
│  <span class="hljs-number">5.</span> 检查（<span class="hljs-keyword">Check</span>）                    │
│     <span class="hljs-operator">-</span> setImmediate 回调              │
├─────────────────────────────────────┤
│  <span class="hljs-number">6.</span> 关闭回调（<span class="hljs-keyword">Close</span> Callbacks）      │
│     <span class="hljs-operator">-</span> socket.on(<span class="hljs-string">'close'</span>)            │
└─────────────────────────────────────┘
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>), <span class="hljs-number">0</span>);
<span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setImmediate'</span>));

<span class="hljs-comment">// 输出顺序可能不同，取决于执行上下文</span>
<span class="hljs-comment">// 但在 I/O 回调中，setImmediate 总是先于 setTimeout 执行</span>
</code></pre>
<h3 data-id="heading-87">5.7 总结：事件驱动的重要性</h3>
<ul>
<li><strong>事件驱动是 Node.js 的核心</strong>：所有异步操作都基于事件驱动</li>
<li><strong>高效且资源友好</strong>：只在需要时处理，不需要时休眠</li>
<li><strong>适合现代应用</strong>：实时应用、高并发应用的首选</li>
<li><strong>简化编程模型</strong>：通过事件和回调，代码更清晰易维护</li>
</ul>
<hr/>
<h2 data-id="heading-88">六、核心概念之间的关系</h2>
<h3 data-id="heading-89">6.1 协同工作：四个核心特性的配合</h3>
<p>Node.js 的核心特性不是独立工作的，它们相互配合，共同构成了高效的运行时环境。</p>
<h4 data-id="heading-90">6.1.1 整体协作流程</h4>
<pre><code class="hljs language-css" lang="css">用户请求/事件
    ↓
┌─────────────────────────────────────┐
│  事件驱动架构                        │
│  - 接收事件                          │
│  - 添加到事件队列                    │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  非阻塞 <span class="hljs-selector-tag">I</span>/O                          │
│  - 发起 <span class="hljs-selector-tag">I</span>/O 操作                     │
│  - 不等待，立即返回                  │
│  - 交给系统内核处理                  │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  单线程模型                          │
│  - 主线程继续处理其他任务             │
│  - 不阻塞，保持响应                   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  V8 引擎                             │
│  - 执行 JavaScript 代码              │
│  - 优化性能                          │
│  - 管理内存                          │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-91">6.1.2 各特性的作用</h4>
<p><strong>V8 引擎</strong>：</p>
<ul>
<li>提供高性能的 JavaScript 执行能力</li>
<li>将 JavaScript 代码编译为机器码</li>
<li>优化代码执行，管理内存</li>
</ul>
<p><strong>单线程模型</strong>：</p>
<ul>
<li>简化编程模型，避免线程同步问题</li>
<li>主线程负责协调和调度</li>
<li>通过异步操作实现并发</li>
</ul>
<p><strong>非阻塞 I/O</strong>：</p>
<ul>
<li>允许高效处理大量并发 I/O 操作</li>
<li>将 I/O 操作交给系统内核处理</li>
<li>不阻塞主线程，保持响应性</li>
</ul>
<p><strong>事件驱动</strong>：</p>
<ul>
<li>通过事件循环管理异步操作和回调</li>
<li>协调所有异步操作</li>
<li>实现高效的并发处理</li>
</ul>
<h3 data-id="heading-92">6.2 整体架构与数据流向</h3>
<h4 data-id="heading-93">6.2.1 完整架构图</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────────────┐
│        你的 JavaScript 应用代码              │
│        (业务逻辑、API 路由等)                │
├─────────────────────────────────────────────┤
│           V8 JavaScript 引擎                 │
│        - 解析和执行 JavaScript               │
│        - JIT 编译优化                        │
│        - 垃圾回收                            │
├─────────────────────────────────────────────┤
│         Node.js 核心模块                     │
│    fs, http, https, events, stream,          │
│    path, os, crypto, buffer, ...            │
├─────────────────────────────────────────────┤
│           libuv 库 (C++)                     │
│    - 事件循环（<span class="hljs-keyword">Event</span> <span class="hljs-keyword">Loop</span>）                  │
│    - 线程池（Thread Pool）                   │
│    - 异步 I/O（<span class="hljs-keyword">Async</span> I/O）                   │
│    - 定时器（Timers）                        │
├─────────────────────────────────────────────┤
│           操作系统内核                       │
│    - 文件系统                                │
│    - 网络协议栈                              │
│    - 进程管理                                │
└─────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-94">6.2.2 数据流向示例</h4>
<p><strong>HTTP 请求处理流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 客户端发送 HTTP 请求
   ↓
<span class="hljs-bullet">2.</span> 操作系统内核接收网络数据包
   ↓
<span class="hljs-bullet">3.</span> libuv 检测到网络事件，添加到事件队列
   ↓
<span class="hljs-bullet">4.</span> 事件循环取出事件，调用 Node.js HTTP 模块
   ↓
<span class="hljs-bullet">5.</span> HTTP 模块触发 'request' 事件
   ↓
<span class="hljs-bullet">6.</span> 你的代码（事件监听器）处理请求
   ↓
<span class="hljs-bullet">7.</span> V8 引擎执行你的 JavaScript 代码
   ↓
<span class="hljs-bullet">8.</span> 如果需要读取文件，发起非阻塞 I/O
   ↓
<span class="hljs-bullet">9.</span> libuv 将文件操作交给线程池
   ↓
<span class="hljs-bullet">10.</span> 文件读取完成，触发回调事件
   ↓
<span class="hljs-bullet">11.</span> 事件循环执行回调，返回响应给客户端
</code></pre>
<h3 data-id="heading-95">6.3 性能对比：传统 vs Node.js</h3>
<p><strong>传统多线程服务器（如 Apache）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">1000 个并发请求
  ↓
需要 1000 个线程（每个请求一个线程）
  ↓
内存占用：1000 × <span class="hljs-attr">2MB</span> = <span class="hljs-number">2</span>GB
CPU 开销：大量上下文切换
</code></pre>
<p><strong>Node.js 单线程服务器</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">1000</span> <span class="hljs-string">个并发请求</span>
  <span class="hljs-string">↓</span>
<span class="hljs-string">只需要</span> <span class="hljs-number">1</span> <span class="hljs-string">个主线程</span> <span class="hljs-string">+</span> <span class="hljs-string">少量工作线程</span>
  <span class="hljs-string">↓</span>
<span class="hljs-string">内存占用：约</span> <span class="hljs-string">50MB</span>
<span class="hljs-string">CPU</span> <span class="hljs-string">开销：最小化，无上下文切换</span>
</code></pre>
<h3 data-id="heading-96">6.4 最佳实践建议</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 好的做法：并行处理多个 I/O 操作</span>
<span class="hljs-keyword">const</span> [user, posts, comments] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  db.<span class="hljs-title function_">getUser</span>(userId),
  db.<span class="hljs-title function_">getPosts</span>(userId),
  db.<span class="hljs-title function_">getComments</span>(userId)
]);

<span class="hljs-comment">// ❌ 避免：同步阻塞操作</span>
<span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'large-file.txt'</span>);
<span class="hljs-comment">// ✅ 好的做法：异步非阻塞操作</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'large-file.txt'</span>, <span class="hljs-string">'utf8'</span>);
</code></pre>
<h3 data-id="heading-97">6.5 总结：核心特性的协同</h3>
<p>Node.js 的四个核心特性（V8 引擎、单线程、非阻塞 I/O、事件驱动）不是独立工作的，而是相互配合：</p>
<ul>
<li><strong>V8 引擎</strong>提供执行能力</li>
<li><strong>单线程</strong>简化编程模型</li>
<li><strong>非阻塞 I/O</strong>实现高效并发</li>
<li><strong>事件驱动</strong>协调所有操作</li>
</ul>
<p>这种设计使得 Node.js 能够：</p>
<ul>
<li>高效处理大量并发连接</li>
<li>资源使用更高效</li>
<li>编程模型更简单</li>
<li>适合现代 Web 应用的需求</li>
</ul>
<hr/>
<h2 data-id="heading-98">七、总结</h2>
<h3 data-id="heading-99">7.1 核心特性回顾</h3>
<p>Node.js 通过结合以下四个核心特性，提供了一个高效、可扩展的服务器端 JavaScript 运行时环境：</p>
<h4 data-id="heading-100">1. V8 引擎</h4>
<ul>
<li><strong>作用</strong>：提供高性能的 JavaScript 执行能力</li>
<li><strong>特点</strong>：JIT 编译、代码优化、内存管理</li>
<li><strong>价值</strong>：让 JavaScript 在服务器端也能高效运行</li>
</ul>
<h4 data-id="heading-101">2. 单线程模型</h4>
<ul>
<li><strong>作用</strong>：简化并发编程，避免线程同步问题</li>
<li><strong>特点</strong>：主线程单一、后台线程池、系统内核多线程</li>
<li><strong>价值</strong>：编程简单、资源高效、无锁竞争</li>
</ul>
<h4 data-id="heading-102">3. 非阻塞 I/O</h4>
<ul>
<li><strong>作用</strong>：高效处理大量并发 I/O 操作</li>
<li><strong>特点</strong>：异步执行、不阻塞主线程、充分利用系统资源</li>
<li><strong>价值</strong>：高并发、低延迟、资源高效</li>
</ul>
<h4 data-id="heading-103">4. 事件驱动架构</h4>
<ul>
<li><strong>作用</strong>：通过事件循环管理异步操作和回调</li>
<li><strong>特点</strong>：事件队列、回调机制、高效调度</li>
<li><strong>价值</strong>：实时响应、资源节约、可扩展</li>
</ul>
<h3 data-id="heading-104">7.2 Node.js 的价值</h3>
<ul>
<li><strong>统一技术栈</strong>：前后端都使用 JavaScript，降低学习成本</li>
<li><strong>高性能</strong>：事件驱动和非阻塞 I/O 带来出色的性能</li>
<li><strong>生态丰富</strong>：npm 拥有数百万个包，生态非常丰富</li>
<li><strong>开发效率高</strong>：代码简洁、开发快速</li>
<li><strong>易于维护</strong>：代码简洁，易于理解和维护</li>
</ul>
<hr/>
<p><strong>记住</strong>：Node.js 的核心是<strong>事件驱动</strong>和<strong>非阻塞 I/O</strong>，理解这两个概念是掌握 Node.js 的关键。</p>
<hr/>
<h2 data-id="heading-105">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官方网站</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3schools.com%2Fnodejs%2Fdefault.asp" target="_blank" title="https://www.w3schools.com/nodejs/default.asp" ref="nofollow noopener noreferrer">W3Schools Node.js 教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fv8.dev%2F" target="_blank" title="https://v8.dev/" ref="nofollow noopener noreferrer">V8 JavaScript 引擎</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包、栈堆与类型之谜：JS 内存机制全解密，面试官都惊了！]]></title>    <link>https://juejin.cn/post/7581872532363362313</link>    <guid>https://juejin.cn/post/7581872532363362313</guid>    <pubDate>2025-12-10T09:31:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581872532363362313" data-draft-id="7581888578538176550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包、栈堆与类型之谜：JS 内存机制全解密，面试官都惊了！"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T09:31:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陳陈陳"/> <meta itemprop="url" content="https://juejin.cn/user/3942169763381875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包、栈堆与类型之谜：JS 内存机制全解密，面试官都惊了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3942169763381875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陳陈陳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:31:05.000Z" title="Wed Dec 10 2025 09:31:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>“闭包、栈堆与类型之谜：JS 内存机制全解密，面试官都惊了！”</strong></h2>
<hr/>
<h3 data-id="heading-1">引子：为什么你的 JS 代码在“偷偷”操作内存？</h3>
<p>你有没有想过，当你写下 <code>var a = { name: '极客时间' }</code> 的时候，JavaScript 引擎其实在背后悄悄地做了两件事：</p>
<ol>
<li>在 <strong>栈内存</strong> 中存了一个地址；</li>
<li>在 <strong>堆内存</strong> 中真正创建了对象。</li>
</ol>
<p>而当你执行 <code>a.name = '极客邦'</code>，不仅改变了对象内容，还可能让另一个变量 <code>b</code> 同步更新——这一切的背后，是 JavaScript 内存模型在默默运作。</p>
<p>今天，我们就从一段看似简单的代码出发，深入剖析 JS 的 <strong>内存机制、闭包原理、类型系统</strong>，并结合 V8 引擎的底层逻辑，彻底搞懂这些前端工程师必须掌握的核心知识。准备好了吗？这可能是你离字节/阿里/腾讯前端岗最近的一篇文章！</p>
<hr/>
<h3 data-id="heading-2">一、问题引入：为什么 <code>a = 2</code> 不影响 <code>b</code>，但 <code>a.name = '极客邦'</code> 却影响了 <code>b</code>？</h3>
<p>先看这段经典代码：</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
    var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    var <span class="hljs-attr">b</span> = a<span class="hljs-comment">; // 拷贝</span>
    <span class="hljs-attr">a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    console.log(a)<span class="hljs-comment">; // 2</span>
    console.log(b)<span class="hljs-comment">; // 1</span>
}
foo()<span class="hljs-comment">;</span>

function foo() {
    var <span class="hljs-attr">a</span> = {name:&amp;<span class="hljs-comment">#34;极客时间&amp;#34;};</span>
    var <span class="hljs-attr">b</span> = a<span class="hljs-comment">; // 引用式拷贝</span>
    <span class="hljs-attr">a.name</span> = <span class="hljs-string">'极客邦'</span><span class="hljs-comment">;</span>
    console.log(a)<span class="hljs-comment">; // {name:&amp;#34;极客邦&amp;#34;}</span>
    console.log(b)<span class="hljs-comment">; // {name:&amp;#34;极客邦&amp;#34;}</span>
}
foo()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-3">🔍 为什么行为不同？</h3>
<ul>
<li>
<p><strong>第一段（原始类型）</strong>：<br/>
<code>a</code> 和 <code>b</code> 是两个独立的栈变量，各自保存了数值 <code>1</code> 的副本。JavaScript 中的原始类型（如 number、string、boolean 等）具有 <strong>值语义（value semantics）</strong> —— 赋值操作会将当前值完整地复制给新变量。因此，后续修改 <code>a</code> 不会影响 <code>b</code>。</p>
</li>
<li>
<p><strong>第二段（对象类型）</strong>：<br/>
<code>a</code> 和 <code>b</code> 都是栈中的变量，但它们的值并不是对象本身，而是<strong>指向堆中同一个对象的引用（即内存地址）</strong>。赋值 <code>b = a</code> 只是把引用地址复制给了 <code>b</code>，两者仍指向堆中的同一块对象内存。因此，通过任一变量修改对象属性，都会反映到同一个对象上。</p>
</li>
</ul>
<h4 data-id="heading-4">🧠 补充图示辅助理解（文字版）：</h4>
<h5 data-id="heading-5">原始类型：</h5>
<pre><code class="hljs language-css" lang="css">栈内存：
┌─────┐     ┌─────┐
│ <span class="hljs-selector-tag">a</span>=<span class="hljs-number">1</span> │     │ <span class="hljs-selector-tag">b</span>=<span class="hljs-number">1</span> │   ← 两个独立的值
└─────┘     └─────┘
</code></pre>
<h5 data-id="heading-6">引用类型：</h5>
<pre><code class="hljs language-css" lang="css">栈内存：            堆内存：
┌─────┐           ┌───────────────────┐
│ <span class="hljs-selector-tag">a</span> ──┼──────────▶│ { name: &amp;#<span class="hljs-number">34</span>;极客邦&amp;<span class="hljs-selector-id">#34</span>; }│
└─────┘           └───────────────────┘
┌─────┐                   ▲
│ <span class="hljs-selector-tag">b</span> ──┼───────────────────┘
└─────┘
</code></pre>
<blockquote>
<p>💡 关键点：<strong>变量 ≠ 对象</strong>。变量只是“持有”值或引用的容器。</p>
</blockquote>
<blockquote>
<p>✅ <strong>关键点</strong> 在函数作用域中声明的<strong>局部原始类型变量</strong>，通常存储在栈内存中；但如果被闭包引用，或作为全局变量，则可能存在于堆中；<strong>复杂类型（Object, Array, Function 等）</strong> 实际存储在 <strong>堆内存</strong>，栈中只存引用地址。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">二、JS 内存模型：栈 vs 堆，谁主沉浮？</h3>
<h4 data-id="heading-8">🧠 为什么要有栈和堆？——性能与生命周期的权衡</h4>
<p>JavaScript 引擎（如 V8）在执行代码时，需要高效管理内存。为了兼顾<strong>访问速度</strong>、<strong>内存安全</strong>和<strong>资源回收效率</strong>，它将内存划分为两个主要区域：<strong>栈内存（Stack）</strong> 和 <strong>堆内存（Heap）</strong> 。这种设计并非 JS 独有，而是源于计算机体系结构的经典范式。</p>
<h5 data-id="heading-9">✅ 栈内存（Stack）</h5>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>容量小但访问极快</strong>：由 CPU 直接支持，通过栈指针（stack pointer）进行压栈/弹栈操作。</li>
<li><strong>内存连续</strong>：分配和释放只需移动栈顶指针，无需复杂寻址。</li>
<li><strong>自动管理</strong>：无需手动释放，随函数调用自动入栈/出栈。</li>
</ul>
</li>
<li>
<p><strong>关键机制：栈顶指针偏移</strong><br/>
每当一个函数被调用，JS 引擎会为其创建一个<strong>执行上下文</strong>，并将该上下文“压入”调用栈。这个过程<strong>并不涉及内存复制或动态分配</strong>，<strong>引擎只需调整栈顶指针的位置（通常向低地址方向移动），划出一块连续空间……函数返回时，指针恢复原位。</strong>，划出一块连续空间用于存放局部变量和控制信息。<br/>
函数执行完毕后，引擎只需将栈顶指针<strong>向上回移相同长度</strong>，即可“释放”该上下文——整个过程是 O(1) 的，极其高效。</p>
</li>
<li>
<p><strong>存放内容</strong>：</p>
<ul>
<li>函数调用形成的<strong>执行上下文</strong>（Execution Context）</li>
<li>局部变量中的<strong>原始类型值</strong></li>
<li>指向堆中对象的<strong>引用地址</strong></li>
</ul>
</li>
<li>
<p><strong>生命周期</strong>：<br/>
严格绑定于函数调用周期。由于释放仅靠指针回退，<strong>栈内存的回收是即时且零成本的</strong>。</p>
</li>
</ul>
<blockquote>
<p>📌 正因为这种基于指针偏移的机制，栈才能支撑 JavaScript 高频的函数调用（比如递归、事件回调），而不会成为性能瓶颈。</p>
</blockquote>
<blockquote>
<p>📌 举个例子：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">foo</span>()</span> {
  <span class="hljs-keyword">var</span> x = <span class="hljs-number">42</span>;           <span class="hljs-comment">// x 的值 42 存在栈中</span>
  <span class="hljs-keyword">var</span> obj = { a: <span class="hljs-number">1</span> };   <span class="hljs-comment">// obj 变量本身（引用）在栈中，{ a: 1 } 在堆中</span>
}
</code></pre>
<p>当 <code>foo()</code> 返回，<code>x</code> 和 <code>obj</code> 的栈帧被清空，但堆中的 <code>{ a: 1 }</code> 是否回收，取决于是否有其他引用指向它。</p>
</blockquote>
<hr/>
<h5 data-id="heading-10">✅ 堆内存（Heap）</h5>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>容量大但访问较慢</strong>：内存分配不连续，需通过指针间接访问。</li>
<li><strong>动态分配</strong>：对象大小不确定，无法预知生命周期。</li>
<li><strong>依赖垃圾回收（GC）</strong> ：引擎需定期扫描堆内存，回收“不可达”对象。</li>
</ul>
</li>
<li>
<p><strong>存放内容</strong>：</p>
<ul>
<li>所有<strong>复杂数据类型</strong>：对象（Object）、数组（Array）、函数（Function）等</li>
<li><strong>闭包捕获的自由变量</strong>（当内部函数引用外部变量时，这些变量会被“提升”到堆中，形成 closure 对象）</li>
<li>字符串（在某些引擎实现中，长字符串也可能存于堆）</li>
</ul>
</li>
<li>
<p><strong>生命周期</strong>：</p>
<ul>
<li>不由函数调用决定，而由<strong>引用可达性</strong>决定。只要还有变量或作用域链能访问到该对象，它就存活；否则，在下一次 GC 时被回收。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-11">💡 V8 引擎的设计哲学：为什么不能全放栈里？</h4>
<p>想象一下：如果每次调用函数都要把整个对象（比如一个 10MB 的图片数据结构）完整拷贝进栈，会发生什么？</p>
<ul>
<li><strong>上下文切换成本剧增</strong>：函数调用/返回时需复制大量数据，严重拖慢执行速度。</li>
<li><strong>栈溢出风险高</strong>：栈空间通常只有几 MB（如 Node.js 默认约 1–2MB），大对象极易撑爆。</li>
<li><strong>内存浪费</strong>：多个函数若共享同一对象，各自拷贝一份，既冗余又低效。</li>
</ul>
<p>因此，V8 采用“<strong>轻量放栈，重量扔堆</strong>”的策略：</p>
<ul>
<li>栈只保留<strong>快速访问的小数据</strong>和<strong>对象引用</strong>；</li>
<li>堆负责托管<strong>真正的数据实体</strong>，并通过高效的 GC 机制（如 Scavenger + Mark-Compact）管理生命周期。</li>
</ul>
<blockquote>
<p>🔥 这不仅是工程妥协，更是对<strong>时间复杂度</strong>与<strong>空间复杂度</strong>的精妙平衡——也是现代高性能 JS 引擎的核心思想之一。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">三、动态弱类型？别被“弱”字骗了！</h3>
<pre><code class="hljs language-ini" lang="ini">var bar<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // &amp;#34;undefined&amp;#34;</span>
<span class="hljs-attr">bar</span> = <span class="hljs-number">12</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // &amp;#34;number&amp;#34;</span>
<span class="hljs-attr">bar</span> = &amp;<span class="hljs-comment">#34;极客时间&amp;#34;;</span>
console.log(typeof bar)<span class="hljs-comment">; // &amp;#34;string&amp;#34;</span>
<span class="hljs-attr">bar</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // &amp;#34;boolean&amp;#34;</span>
<span class="hljs-attr">bar</span> = null<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // &amp;#34;object&amp;#34; ← 历史 bug！</span>
</code></pre>
<h4 data-id="heading-13">🤯 为什么 <code>typeof null === 'object'</code>？</h4>
<p>这是 JavaScript 诞生初期的一个 <strong>历史性 bug</strong>：<br/>
在底层实现中，值的类型通过低位标记，而 <code>null</code> 的机器码全为 0，被误判为对象类型。<strong>Brendan Eich 后来承认这是个错误，但为了兼容性一直保留至今。</strong></p>
<blockquote>
<p>✅ 正确判断 <code>null</code> 的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// &amp;#34;[object Null]&amp;#34;</span>
</code></pre>
</blockquote>
<h4 data-id="heading-14">📌 JS 是动态弱类型语言，意味着：</h4>
<ul>
<li><strong>动态</strong>：类型在运行时确定，无需声明</li>
<li><strong>弱类型</strong>：隐式类型转换频繁（如 <code>&amp;#34;1&amp;#34; + 2 === &amp;#34;12&amp;#34;</code>）</li>
</ul>
<p>但注意： <strong>“弱” ≠ “随意”</strong> 。现代 JS（尤其是 TypeScript）正朝着更强的类型约束演进。</p>
<hr/>
<h3 data-id="heading-15">四、闭包：不只是“能访问外层变量”，而是“内存的魔法”</h3>
<p>来看这个闭包示例：</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
    var <span class="hljs-attr">myName</span> = &amp;<span class="hljs-comment">#34;极客时间&amp;#34;;</span>
    let <span class="hljs-attr">test1</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">test2</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    var <span class="hljs-attr">innerBar</span> = { 
        setName: function(newName) { <span class="hljs-attr">myName</span> = newName<span class="hljs-comment">; },</span>
        getName: function() {
            console.log(test1)<span class="hljs-comment">;</span>
            return myName<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>
    return innerBar<span class="hljs-comment">;</span>
}

var <span class="hljs-attr">bar</span> = foo()<span class="hljs-comment">;</span>
bar.setName(&amp;<span class="hljs-comment">#34;极客邦&amp;#34;);</span>
console.log(bar.getName())<span class="hljs-comment">; // &amp;#34;极客邦&amp;#34;</span>
</code></pre>
<h4 data-id="heading-16">🔥 闭包的本质是什么？</h4>
<p>很多人说：“闭包就是内部函数访问外部变量”。但这只是表象。</p>
<p><strong>真正的核心是：当内部函数被返回或传递出去后，外部函数的执行上下文本应销毁，但因为内部函数仍引用了其中的变量，V8 引擎会将这些变量从栈“提升”到堆中，形成一个叫 <code>closure(foo)</code> 的特殊对象。</strong></p>
<blockquote>
<p>✅ <strong>V8 中的闭包实现</strong>：</p>
<ul>
<li>编译阶段扫描内部函数，识别“自由变量”（如 <code>myName</code>, <code>test1</code>）</li>
<li>若存在闭包，就在堆中创建 <code>closure</code> 对象</li>
<li>内部函数的 <code>[[Scope]]</code> 链指向该 <code>closure</code></li>
</ul>
<p>注意：只有被内部函数<strong>实际使用</strong>的外部变量才会被闭包捕获，未使用的变量（如 <code>test2</code>）不会进入堆，避免不必要的内存占用</p>
</blockquote>
<p>因此，即使 <code>foo()</code> 执行完毕，<code>myName</code> 也不会被栈回收，而是由堆中的闭包持有——这就是 <strong>内存泄漏的潜在源头</strong>！</p>
<hr/>
<h3 data-id="heading-17">五、延伸思考：这些知识点如何关联高频面试题？</h3>





























<table><thead><tr><th>面试题</th><th>关联知识点</th></tr></thead><tbody><tr><td><strong>JS 数据类型有哪些？<code>null</code> 为什么是 object？</strong></td><td>类型系统、历史 bug</td></tr><tr><td><strong>基本类型和引用类型的区别？</strong></td><td>栈 vs 堆内存模型</td></tr><tr><td><strong>什么是闭包？闭包会导致内存泄漏吗？</strong></td><td>闭包的内存实现、GC 机制</td></tr><tr><td><strong><code>let</code>/<code>const</code> 和 <code>var</code> 在内存中有区别吗？</strong></td><td>词法环境 vs 变量环境（ES6 后 <code>let/const</code> 存于词法环境，不提升）</td></tr><tr><td><strong>如何判断一个变量是否为数组？</strong></td><td><code>Object.prototype.toString.call(arr)</code> —— 因 <code>typeof [] === 'object'</code></td></tr></tbody></table>
<blockquote>
<p>💡 <strong>加分项</strong>：提到 V8 的 <strong>Orinoco 垃圾回收器</strong>、<strong>Scavenger（新生代）</strong> 与 <strong>Mark-Compact（老生代）</strong> 算法，说明你对引擎有深度理解。</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">六、代码优化建议：有没有更好的写法？</h3>
<p>原闭包代码没问题，但可改进：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 更清晰的模块化写法（避免暴露内部状态）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createNameManager</span>(<span class="hljs-params">initialName</span>) {
    <span class="hljs-keyword">let</span> name = initialName;
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">setName</span>: <span class="hljs-function">(<span class="hljs-params">newName</span>) =&gt;</span> { name = newName; },
        <span class="hljs-attr">getName</span>: <span class="hljs-function">() =&gt;</span> name,
        <span class="hljs-comment">// 不暴露 test1/test2，除非必要</span>
    };
}
</code></pre>
<p>或者使用 <strong>WeakMap</strong> 避免内存泄漏（高级技巧）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> privateData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NameManager</span>(<span class="hljs-params">name</span>) {
    privateData.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>, { name });
}
<span class="hljs-title class_">NameManager</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> privateData.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">name</span>;
};
</code></pre>
<hr/>
<h3 data-id="heading-19">结语：掌握内存，才能掌控性能</h3>
<p>JavaScript 虽然屏蔽了直接内存操作，但 <strong>理解栈与堆、闭包与 GC、类型与引用</strong>，是你写出高性能、低内存占用应用的关键。</p>
<p>下次面试官问：“JS 是怎么管理内存的？”<br/>
你可以微微一笑，从栈帧讲到 V8 的 Orinoco，从闭包讲到 WeakMap——那一刻，offer 已经在路上了。</p>
<blockquote>
<p>🚀 <strong>记住</strong>：前端不止是写页面，更是与引擎共舞的艺术。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET8 实时通信秘籍：WebSocket 全双工通信 + 分布式推送，代码实操全解析]]></title>    <link>https://juejin.cn/post/7582036070158958592</link>    <guid>https://juejin.cn/post/7582036070158958592</guid>    <pubDate>2025-12-10T09:40:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070158958592" data-draft-id="7582021506189623342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET8 实时通信秘籍：WebSocket 全双工通信 + 分布式推送，代码实操全解析"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-10T09:40:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幌才_loong"/> <meta itemprop="url" content="https://juejin.cn/user/4256947657515320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET8 实时通信秘籍：WebSocket 全双工通信 + 分布式推送，代码实操全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4256947657515320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幌才_loong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:40:03.000Z" title="Wed Dec 10 2025 09:40:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在当今实时交互日益成为核心需求的网络应用生态中，传统的 HTTP 请求-响应模式已难以满足即时通讯、在线协作、实时数据推送等高互动性场景。为突破这一瓶颈，<strong>WebSocket</strong> 协议应运而生。<br/>
作为一种建立在 TCP 基础上的全双工通信协议，WebSocket 通过在客户端与服务器之间建立持久化的单一连接，实现了高效、低延迟的双向实时数据传输。它不仅克服了轮询与长轮询带来的延迟高、头部开销大、服务器负载重等固有缺陷，更以轻量级的帧结构取代了繁复的 HTTP 请求，真正让实时交互变得简洁而强大。从即时聊天、金融看板到协同编辑、在线游戏，WebSocket 已成为支撑现代实时 Web 应用的基石技术，持续推动着交互体验迈向真正的“实时”时代。</p>
<h2 data-id="heading-1">WebSocket是什么</h2>
<ul>
<li>它是一种持久化连接协议：一旦客户端与服务器建立 WebSocket 连接，该连接将保持打开状态，直到显式关闭。</li>
<li>基于 TCP，但与传统的 HTTP 不同，它不需要每次通信都重新建立连接。</li>
<li>使用简单的握手过程（基于 HTTP 升级机制）从 HTTP 切换到 WebSocket 协议。</li>
<li>数据可以以“消息”形式双向传输，支持文本（如 JSON）和二进制数据。</li>
</ul>
<h3 data-id="heading-2">解决了什么问题</h3>
<p>在 WebSocket 出现之前，Web 应用若想实现“实时通信”，通常使用以下技术：</p>
<ol>
<li>轮询（Polling）：客户端定时向服务器发送请求，询问是否有新数据。</li>
<li>长轮询（Long Polling）：客户端发送请求后，服务器保持连接直到有数据才返回。</li>
<li>SSE（Server-Sent Events）：仅支持服务器向客户端单向推送。</li>
</ol>
<h3 data-id="heading-3">这些方法存在明显缺点</h3>
<ul>
<li>延迟高：轮询无法做到真正实时</li>
<li>资源浪费：频繁建立 HTTP 请求，开销大（头部信息多、连接反复创建）</li>
<li>无法双向通信：SSE 仅支持服务器推；轮询仍是“请求-响应”模式。</li>
</ul>
<h3 data-id="heading-4">优势与解决的问题</h3>

























<table><thead><tr><th>问题</th><th>WebSocket 如何解决</th></tr></thead><tbody><tr><td>实时性差</td><td>建立持久连接，数据可即时推送，延迟极低</td></tr><tr><td>通信单向</td><td>支持客户端和服务器任意一方主动发送数据（全双工）</td></tr><tr><td>高开销</td><td>握手后通信头部极小，节省带宽和服务器资源</td></tr><tr><td>多次连接消耗</td><td>一个连接长期复用，减少 TCP 握手和 HTTP 开销</td></tr></tbody></table>
<h3 data-id="heading-5">典型应用场景</h3>
<ul>
<li>聊天应用（如微信网页版）</li>
<li>在线协作文档编辑</li>
<li>实时游戏</li>
<li>股票行情、实时数据仪表盘</li>
<li>视频弹幕系统</li>
</ul>
<h2 data-id="heading-6">代码实践</h2>
<p>创建websocket的中间件 <code>WebSocketMiddleware</code></p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span>  `<span class="hljs-title">WebSocketMiddleware</span>`
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> RequestDelegate _next;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> WebSocketHandler _webSocketHandler;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WebSocketMiddleware</span>(<span class="hljs-params">RequestDelegate next, WebSocketHandler webSocketHandler</span>)</span>
    {
        _next = next;
        _webSocketHandler = webSocketHandler;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        <span class="hljs-keyword">if</span> (context.Request.Path == &amp;<span class="hljs-meta">#34;/ws&amp;#34;)</span>
        {
            <span class="hljs-keyword">if</span> (context.WebSockets.IsWebSocketRequest)
            {
                <span class="hljs-keyword">await</span> _webSocketHandler.HandleWebSocketAsync(context);
            }
            <span class="hljs-keyword">else</span>
            {
                context.Response.StatusCode = <span class="hljs-number">400</span>;
            }
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">await</span> _next(context);
        }
    }
}
</code></pre>
<p>websocket处理类<code>WebSocketHandler</code>，从<code>cookie</code>中获取用户的登录信息来鉴权（预留代码）</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebSocketHandler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> WebSocketConnectionManager _connectionManager;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WebSocketHandler</span>(<span class="hljs-params">WebSocketConnectionManager connectionManager</span>)</span>
    {
        _connectionManager = connectionManager;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleWebSocketAsync</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        <span class="hljs-comment">// 从 Cookie 中获取身份信息</span>
        <span class="hljs-keyword">var</span> userInfo = <span class="hljs-keyword">await</span> ValidateAndExtractUserInfo(context);
        <span class="hljs-keyword">if</span> (userInfo == <span class="hljs-literal">null</span>)
        {
            context.Response.StatusCode = <span class="hljs-number">401</span>;
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> webSocket = <span class="hljs-keyword">await</span> context.WebSockets.AcceptWebSocketAsync();
        <span class="hljs-keyword">var</span> connectionId = Guid.NewGuid().ToString();

        <span class="hljs-comment">// 将连接与用户信息关联并存储</span>
        _connectionManager.AddConnection(connectionId, webSocket, userInfo);

        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">await</span> ProcessWebSocketMessages(connectionId, webSocket);
        }
        <span class="hljs-keyword">finally</span>
        {
            <span class="hljs-comment">// 确保连接断开时清理资源</span>
            _connectionManager.RemoveConnection(connectionId);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ValidateAndExtractUserInfo</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        <span class="hljs-comment">// 从请求中提取 Cookie</span>
        <span class="hljs-comment">//if (!context.Request.Cookies.TryGetValue(&amp;#34;auth_token&amp;#34;, out var authToken))</span>
        <span class="hljs-comment">//{</span>
        <span class="hljs-comment">//    return null;</span>
        <span class="hljs-comment">//}</span>

        <span class="hljs-comment">// 验证身份信息（此处为预留实现）</span>
        <span class="hljs-keyword">var</span> userInfo = <span class="hljs-keyword">await</span> ValidateAuthTokenAsync(&amp;<span class="hljs-meta">#34;authToken&amp;#34;);</span>
        <span class="hljs-keyword">return</span> userInfo;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ValidateAuthTokenAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> authToken</span>)</span>
    {
        <span class="hljs-comment">// 身份验证逻辑预留</span>
        <span class="hljs-comment">// 实际实现可能包括 JWT 解析、数据库查询等</span>
        <span class="hljs-keyword">await</span> Task.CompletedTask;

        <span class="hljs-comment">// 示例返回，实际应根据验证结果返回</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserInfo
        {
            Id = &amp;<span class="hljs-meta">#34;user123&amp;#34;,</span>
            UserName = &amp;<span class="hljs-meta">#34;zhangsan&amp;#34;,</span>
            ConnectedAt = DateTime.UtcNow
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ProcessWebSocketMessages</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> connectionId, WebSocket webSocket</span>)</span>
    {
        <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">4</span>];

        <span class="hljs-keyword">while</span> (webSocket.State == WebSocketState.Open)
        {
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> webSocket.ReceiveAsync(
                <span class="hljs-keyword">new</span> ArraySegment(buffer), CancellationToken.None);

            <span class="hljs-keyword">if</span> (result.MessageType == WebSocketMessageType.Close)
            {
                <span class="hljs-keyword">await</span> webSocket.CloseAsync(
                    WebSocketCloseStatus.NormalClosure,
                    &amp;<span class="hljs-meta">#34;Connection closed by client&amp;#34;,</span>
                    CancellationToken.None);
                <span class="hljs-keyword">break</span>;
            }

            <span class="hljs-comment">// 处理收到的消息</span>
            <span class="hljs-keyword">await</span> HandleReceivedMessage(connectionId, buffer, result);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleReceivedMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> connectionId, <span class="hljs-built_in">byte</span>[] buffer, WebSocketReceiveResult result</span>)</span>
    {
        <span class="hljs-keyword">if</span> (result.MessageType == WebSocketMessageType.Text)
        {
            <span class="hljs-built_in">string</span> message = Encoding.UTF8.GetString(buffer, <span class="hljs-number">0</span>, result.Count);
            Console.WriteLine($&amp;<span class="hljs-meta">#34;Received message from {connectionId}: {message}&amp;#34;);</span>
        }
        <span class="hljs-comment">// 消息处理逻辑</span>
        <span class="hljs-keyword">await</span> Task.CompletedTask;
    }
}
</code></pre>
<p><code>WebSocketConnectionManager</code>存储用户的websocket连接信息</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebSocketConnectionManager</span>
{
    <span class="hljs-comment">// 使用线程安全的字典存储用户连接</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ConcurrentDictionary&gt; _connections = <span class="hljs-keyword">new</span>();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddConnection</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> connectionId, WebSocket webSocket, UserInfo user</span>)</span>
    {

        <span class="hljs-keyword">if</span> (_connections.ContainsKey(connectionId))
        {
            _connections[connectionId].Add(webSocket);
        }
        <span class="hljs-keyword">else</span>
        {
            _connections.TryAdd(connectionId, <span class="hljs-keyword">new</span> List() { webSocket });
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveConnection</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> connectionId</span>)</span>
    {
        _connections.TryRemove(connectionId, <span class="hljs-keyword">out</span> _);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> List <span class="hljs-title">GetWebSocket</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> connectionId</span>)</span>
    {
        <span class="hljs-keyword">if</span> (!_connections.ContainsKey(connectionId))
        {
            <span class="hljs-keyword">return</span> [];
        }
        <span class="hljs-keyword">return</span> _connections.TryGetValue(connectionId, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> socket) ? socket : [];
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable <span class="hljs-title">GetAllSockets</span>()</span>
    {
        <span class="hljs-keyword">return</span> _connections.Values.SelectMany(list =&gt; list).ToList();
    }
}
</code></pre>
<p>program 配置</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-keyword">var</span> builder = WebApplication.CreateBuilder(args);

        <span class="hljs-comment">// Add services to the container.</span>

        builder.Services.AddControllers();
        <span class="hljs-comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span>
        builder.Services.AddEndpointsApiExplorer();
        builder.Services.AddSwaggerGen();

        <span class="hljs-comment">// 注册WebSocketHandler与WebSocketConnectionManager到DI</span>
        builder.Services.AddTransient();
        <span class="hljs-comment">// WebSocketConnectionManager要使用单例模式，因为WebSocketConnectionManager中存储了所有WebSocket连接</span>
        builder.Services.AddSingleton();

        <span class="hljs-keyword">var</span> app = builder.Build();

        <span class="hljs-comment">// Configure the HTTP request pipeline.</span>
        <span class="hljs-keyword">if</span> (app.Environment.IsDevelopment())
        {
            app.UseSwagger();
            app.UseSwaggerUI();
        }

        app.UseHttpsRedirection();

        app.UseAuthorization();

        app.MapControllers();
        <span class="hljs-comment">// 启用websocket</span>
        app.UseWebSockets();
        <span class="hljs-comment">// 注册websocket中间件</span>
        app.UseMiddleware();

        app.Run();
    }
}
</code></pre>
<p>前端调用</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 创建 WebSocket 连接</span>
    <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'wss://localhost:7233/ws'</span>);

    <span class="hljs-comment">// 连接打开时的处理</span>
    socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket 连接已建立'</span>);
    };

    <span class="hljs-comment">// 接收消息时的处理</span>
    socket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, event.<span class="hljs-property">data</span>);
    };

    <span class="hljs-comment">// 连接关闭时的处理</span>
    socket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket 连接已关闭'</span>);
    };

    <span class="hljs-comment">// 发生错误时的处理</span>
    socket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket 错误:'</span>, error);
    };

    <span class="hljs-comment">// 发送消息到服务器</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage1</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> message = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message'</span>).<span class="hljs-property">value</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'发送消息:'</span>, message);
        <span class="hljs-keyword">if</span> (socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
            socket.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(message));
        }
    }

    <span class="hljs-comment">// 关闭连接</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeConnection</span>(<span class="hljs-params"/>) {
        socket.<span class="hljs-title function_">close</span>();
    }
    
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"text-center"</span>&gt;
   
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"display-4"</span>&gt;</span>webSocket<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        
        
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-7">实际效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbe3956bbbc64306b05f17594ebaf3f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmM5omNX2xvb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765964587&amp;x-signature=g4ljxcYNBVtk89VNtWQr5dyoym4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50d652a36f1d47b78d9cd089c18582a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmM5omNX2xvb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765964587&amp;x-signature=OKSWC5elA8zHBSgLCyN%2Bk3Ce%2BqI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">分布式系统中使用</h2>
<p>在分布式系统架构中，为实现高效、可扩展的实时消息推送，结合 <strong>WebSocket</strong> 与 <strong>Redis Pub/Sub</strong> 是一种经典且强大的设计模式。该模式的核心思路是通过 Redis 的发布订阅机制，解耦 WebSocket 连接所在的业务服务器与触发消息的事件源，从而实现跨进程、跨服务器的实时消息广播。</p>
<p>其工作流程可精炼为以下几个关键步骤：</p>
<ol>
<li><strong>连接建立与订阅</strong>：当用户客户端与某台业务服务器成功建立 WebSocket 连接后，该服务器会立即以用户唯一标识（如 UserID）为频道名，向 Redis 发起订阅（<code>SUBSCRIBE</code>）。</li>
<li><strong>统一的事件发布</strong>：系统中任何服务（如业务逻辑服务、数据库变更监听器）在检测到与该用户相关的数据变化时，无需感知该用户实际连接在哪台服务器，只需向 Redis 对应的用户频道发布（<code>PUBLISH</code>）一条变更消息。</li>
<li><strong>精准的消息路由与推送</strong>：Redis 会将该消息推送至所有订阅了该频道的业务服务器。每台服务器在收到消息后，通过其内部维护的 <strong>用户-WebSocket 连接映射表</strong>，精准定位到当前连接在本机的该用户所有 WebSocket 会话，并即时将消息下发至对应的客户端。</li>
</ol>
<p>这种架构的优势在于：</p>
<ul>
<li><strong>解耦与扩展性</strong>：发布者与订阅者（WebSocket 服务器）完全解耦，便于系统水平扩展。</li>
<li><strong>精准推送</strong>：消息仅被推送给关联用户当前所在的服务节点，避免广播风暴。</li>
<li><strong>状态分散</strong>：各WebSocket服务器仅维护连接到自身的会话，无需全局中央存储，架构更清晰。</li>
</ul>
<p>综上所述，通过 <strong>WebSocket 维持实时连接</strong>，并借助 <strong>Redis Pub/Sub 进行高效的消息分发</strong>，共同构建了一个适合分布式环境的实时通信基础设施，有力支撑了聊天、通知、实时数据同步等高并发实时场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openEuler集群 Chrony 时间同步实战：从零构建高精度分布式时钟体系]]></title>    <link>https://juejin.cn/post/7581314241410924579</link>    <guid>https://juejin.cn/post/7581314241410924579</guid>    <pubDate>2025-12-08T16:14:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581314241410924579" data-draft-id="7581348660823801856" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openEuler集群 Chrony 时间同步实战：从零构建高精度分布式时钟体系"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-08T16:14:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chian_ocean"/> <meta itemprop="url" content="https://juejin.cn/user/969096773255898"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openEuler集群 Chrony 时间同步实战：从零构建高精度分布式时钟体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/969096773255898/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chian_ocean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T16:14:46.000Z" title="Mon Dec 08 2025 16:14:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">集群环境与基础架构说明</h2>
<p>集群拓扑架构</p>
<p>实验环境为三节点欧拉集群，包含 1 个主控节点与 2 个从节点，具体角色分配如下：</p>
<ul>
<li>Euler01（主控节点）：兼任时间服务器</li>
<li>Euler02（从节点）：作为时间同步客户端</li>
<li>Euler03（从节点）：作为时间同步客户端</li>
</ul>
<p>该架构通过层次化设计，为从式时间同步搭建了稳定基础。分布式系统中，时间同步是节点协调工作的核心前提，尤其适用于分布式数据库、大数据处理、AI 训练集群等对时序要求严格的场景。</p>
<p>主机名配置验证</p>
<p>为确保集群节点间能够正确识别和通信，首先需要验证各节点的主机名配置：</p>
<p><strong>Euler01节点主机名验证：</strong></p>
<pre><code class="hljs">hostname
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a671b8700f94f9ab413316ce4f01ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=kQpe1D%2FyQYk6b5xhG4JTL%2F0S4Ds%3D" alt="" loading="lazy"/></p>
<p><strong>Euler02节点主机名验证：</strong></p>
<pre><code class="hljs">hostname
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6a79fab11a48ab92deb6833304c071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=%2BrH%2FL9Vl%2FxlaeHMpaFrV%2FAG%2FowY%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03节点主机名验证：</strong></p>
<pre><code class="hljs">hostname
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b6ee964068f4583aa7c911ed446fb58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=e6Mz7tdryMsaBdiep32vrpuJGRU%3D" alt="" loading="lazy"/></p>
<p>主机名配置的正确性直接影响到后续的服务发现和节点间通信。在大型集群环境中，规范的主机名命名规则有助于自动化管理和故障排查。</p>
<p>网络地址配置检查</p>
<p>网络连通性是时间同步服务的基础，需要确认各节点的IP地址配置：</p>
<p><strong>Euler01节点IP地址：</strong></p>
<pre><code class="hljs">ip addr
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c81e1f4ae68e4b4b8fc9edce306963a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=F5r2%2F1bmTOUYm0sFZ7XgnGKvVUk%3D" alt="" loading="lazy"/></p>
<p><strong>Euler02节点IP地址：</strong></p>
<pre><code class="hljs">ip addr
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c04634de2a422a9ae25f293726443a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=pWCB%2FTvdEF4x%2FmSH4Rclr8d%2FD1s%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03节点IP地址：</strong></p>
<pre><code class="hljs">ip addr
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f97ee662854e90a99125e7f01c7553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=oAJazf1uS9jIA34bc%2FNyDekFpSw%3D" alt="" loading="lazy"/></p>
<p>IP地址的规划应当遵循集群网络设计规范，确保同一网段内的节点能够直接通信。在生产环境中，建议为管理网络、存储网络和数据网络分别配置不同的网段。</p>
<p>主机映射文件配置</p>
<p>正确的主机名解析是集群通信的前提，需要检查各节点的/etc/hosts文件配置：</p>
<p><strong>Euler01节点主机映射：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /etc/hosts
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f326a73e71646c8a4385b17be175959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=r8LBWsDH7EjcVCINOhVmxGXpuEA%3D" alt="" loading="lazy"/></p>
<p><strong>Euler02节点主机映射：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /etc/hosts
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e179204a9ffa41d5861487e454e2383e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=OROBKqjpqcf4nttCR%2BXW0fGjJEM%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03节点主机映射：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /etc/hosts
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4146e5f60d004249a8e1a57d1b037370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=SpNOolFvprTyetxPfWXgMyNB8b8%3D" alt="" loading="lazy"/></p>
<p>主机映射文件的统一配置确保了集群内部节点能够通过主机名相互访问，避免了DNS解析可能带来的延迟和不确定性。在大型集群中，可以考虑使用DNS服务器或配置管理工具来自动维护主机名解析</p>
<p>防火墙状态确认</p>
<p>为确保时间同步服务正常通信，需要检查各节点的防火墙状态：</p>
<p><strong>Euler01防火墙状态：</strong></p>
<pre><code class="hljs language-lua" lang="lua">systemctl <span class="hljs-built_in">status</span> firewalld
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afaa6567febf45a688b93f7cf87ac076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=c9ej4U3EOLf%2FnjI7bSBoYhH6DBQ%3D" alt="" loading="lazy"/></p>
<p><strong>Euler02防火墙状态：</strong></p>
<pre><code class="hljs language-lua" lang="lua">systemctl <span class="hljs-built_in">status</span> firewalld
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea531717fad4c8e89e118ce11c8351a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=HzHoy26OXYVdJjm%2FS5QoGvZvTg8%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03防火墙状态：</strong></p>
<pre><code class="hljs language-lua" lang="lua">systemctl <span class="hljs-built_in">status</span> firewalld
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0886a7e04bfa42b8ae9f9505b00a8214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=ZlbKkfsdBpcvS%2FuZWgCrMfSo%2BP8%3D" alt="" loading="lazy"/></p>
<p>如果防火墙处于开启状态，需要确保NTP服务端口（UDP 123）在集群内部是开放的。在生产环境中，应根据安全策略合理配置防火墙规则，既要保证服务正常通信，又要防止未授权访问。</p>
<p>集群网络连通性测试</p>
<p>全面的网络连通性测试是部署时间同步服务前的必要步骤：</p>
<p><strong>Euler01节点连通性测试：</strong></p>
<pre><code class="hljs">ping euler01
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/282a82a09d134aea9a03b839ab50a675~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=6KUNUR4tzX1yPuHOv9mbjhzgZp8%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler02
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb17eb4eba042de9f6376612218e37c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=x9CZMHV69ofPr51k0RT%2FaXQXGhk%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler03
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db64fb6d6e4141cdb58870403397aee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=PkBkxfangyjpZOWUl0dRUuOtvh4%3D" alt="" loading="lazy"/></p>
<p><strong>Euler02节点连通性测试：</strong></p>
<pre><code class="hljs">ping euler01
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c9d6f3fbb88434ab968ac39eb0221f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=508pkC2d5fqIm7JZYFlFCCVP%2BRU%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler02
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1699b7b7cf1a489a9b6870fc54b0a8f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=sJiZYEn9DyMAUFtbG8Ge%2FLNyA4c%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler03
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d140b669dc4342208d35eef07b28215a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=r9IuReIvXl94IRZPjLm0F8jrcmQ%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03节点连通性测试：</strong></p>
<pre><code class="hljs">ping euler01
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e53d8a18d054896af00939219da9d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=kjk%2FdPWWwN1F8zbTMXzZNL0xkk0%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler02
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/026a7d725ad4401a8f2301b579dedb5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=sFrmO%2BBydtpTHDQFo7EpyF%2F5r7Y%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">ping euler03
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a3c10fba6834441b0f0a6e6f54322cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=q%2F5U01ErXRjgYeqLFAVj1N24e%2Fk%3D" alt="" loading="lazy"/></p>
<p>网络连通性测试应当包括双向测试，确保任意两个节点之间都能够正常通信。在测试过程中，还需要关注网络延迟和丢包率，这些因素会直接影响时间同步的精度。</p>
<h3 data-id="heading-1">时间同步的重要性与实施目标</h3>
<p>时间同步是分布式集群稳定运行的核心前提，节点间的时间偏差会引发多重关键问题：</p>
<ol>
<li>日志时间戳错乱，增加故障排查与系统监控难度</li>
<li>干扰分布式事务执行，破坏数据库一致性</li>
<li>导致定时任务调度异常，无法按预期触发</li>
<li>使基于时间戳的认证授权机制失效</li>
<li>影响数据备份、复制等操作的可靠性，引发数据一致性风险</li>
</ol>
<h3 data-id="heading-2">Chrony 时间同步技术方案设计</h3>
<p>选用 Chrony 作为时间同步解决方案，核心优势如下：</p>
<ul>
<li>高精度同步：理想条件下可达微秒级</li>
<li>快速收敛：能快速完成系统时钟校准</li>
<li>强网络适应性：对网络延迟和抖动容忍度高</li>
<li>高灵活性：支持多种时间源与复杂网络拓扑</li>
</ul>
<p>方案采用分层架构设计：主控节点 Euler01 作为时间服务器，同步外部可靠时间源；从节点 Euler02、Euler03 以客户端身份，从主节点同步时间。该架构既保障了时间准确性，又降低了对外部网络的依赖。</p>
<h3 data-id="heading-3">Chrony 时间同步服务部署实施</h3>
<p>主节点时间服务器配置</p>
<p><strong>服务状态检查：</strong></p>
<p>首先确认Chrony服务的当前状态：</p>
<pre><code class="hljs language-lua" lang="lua">systemctl <span class="hljs-built_in">status</span> chronyd
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5ea225baad40b18a95b17f429c3425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=OPIIEuvQhyrV4RPKggDaRR7i%2B3w%3D" alt="" loading="lazy"/></p>
<p><strong>配置文件编辑：</strong></p>
<p>编辑主节点的Chrony配置文件，配置时间同步策略：</p>
<pre><code class="hljs language-bash" lang="bash">vim /etc/chrony.conf
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b982832673be4e55b701491a99102633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=gfhwda8TKUzP8XEIV2ZfyoZI%2BBE%3D" alt="" loading="lazy"/></p>
<p>配置内容详解：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用公共NTP时间服务器池，iburst选项加速初始同步</span>
pool pool.ntp.org iburst

<span class="hljs-comment"># 配置国内可靠的NTP服务器，提高同步成功率</span>
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst
server ntp3.aliyun.com iburst

<span class="hljs-comment"># 允许集群内部网络通过本机同步时间</span>
allow 192.168.1.0/24

<span class="hljs-comment"># 在外网不可用时，使用本地时钟作为备用时间源</span>
<span class="hljs-built_in">local</span> stratum 1
</code></pre>
<p><strong>配置参数技术说明：</strong></p>
<ul>
<li><code>iburst</code>参数：在服务启动时发送多个数据包，加速初始时间同步过程</li>
<li><code>allow</code>指令：限制可访问本NTP服务的网络范围，增强安全性</li>
<li><code>local stratum 1</code>：设置本地时钟层级，当外部时间源不可用时，本机可作为时间源</li>
<li>层级(Stratum)概念：Stratum 1表示直接连接到原子钟等高精度时间源，每经过一层网络设备，层级数加1</li>
</ul>
<p><strong>服务重启与生效：</strong></p>
<p>配置完成后需要重启服务使配置生效：</p>
<pre><code class="hljs">systemctl restart chronyd
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/395cd26b6a8b4620a7913d69bc4ac265~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=%2FnRHjMet0%2F7iTI4dk7cVGPJ0wys%3D" alt="" loading="lazy"/></p>
<p>从节点时间客户端配置</p>
<p><strong>Euler02节点配置：</strong></p>
<p>编辑从节点的Chrony配置文件，指向主节点作为时间源：</p>
<pre><code class="hljs language-bash" lang="bash">vim /etc/chrony.conf
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95539d60ddcf46bdba7dd2d433ceee26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=vSA%2Bkz%2BGEqApItfT%2BnwfHrIlADc%3D" alt="" loading="lazy"/></p>
<p>配置核心内容：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 指定主节点作为时间同步源</span>
server euler01 iburst

<span class="hljs-comment"># 可选：配置备用时间服务器</span>
<span class="hljs-comment"># server ntp1.aliyun.com iburst</span>
</code></pre>
<p>重启时间同步服务：</p>
<pre><code class="hljs">systemctl restart chronyd
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11281f8aa5f54112b9dfce9acb7bc9ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=7ghTKgGUqSAW6l2uKpJSAY%2BQXo0%3D" alt="" loading="lazy"/></p>
<p><strong>Euler03节点配置：</strong></p>
<p>采用相同的配置模式，确保配置一致性：</p>
<pre><code class="hljs language-bash" lang="bash">vim /etc/chrony.conf
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b7621fa2304979aaeb1c70afed3cd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=qQ%2B5Wh0qydDButPlZ4lz4wGk0LI%3D" alt="" loading="lazy"/></p>
<p>重启时间同步服务：</p>
<pre><code class="hljs">systemctl restart chronyd
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c03ee3adfec420396fcb5a2db1b41cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=RaYdltS9stypvi1mrd4a1noo45s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">时间同步状态验证与监控</h3>
<p>Chronyc监控工具介绍</p>
<p>chronyc是Chrony服务的命令行控制工具，提供丰富的监控和管理功能：</p>
<ul>
<li><strong>实时状态查询</strong>：监控时间同步状态和性能指标</li>
<li><strong>动态配置</strong>：支持运行时调整同步参数</li>
<li><strong>故障诊断</strong>：提供详细的调试和诊断信息</li>
<li><strong>性能统计</strong>：记录历史同步性能和精度数据</li>
</ul>
<p>从节点同步状态检查</p>
<p><strong>Euler02节点同步状态：</strong></p>
<pre><code class="hljs">chronyc sources
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ab726ec7784ff6a41a06e5ac52fe00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=tZEphgp%2FMQCkTCakKSLl1r3HEwI%3D" alt="" loading="lazy"/></p>
<p>Chrony 时间同步核心状态参数说明</p>
<ul>
<li><strong>MS 状态标志</strong>：<code>^</code> 表示该源为当前主时间源；<code>*</code> 表示该源是当前最佳参考源，正用于时间同步。</li>
<li><strong>Stratum 层级</strong>：数值 3 代表时间源距离权威时间源有两跳，符合内部网络环境的合理层级配置。</li>
<li><strong>Poll 轮询间隔</strong>：值 6 对应 (2^6=64) 秒轮询周期，同步稳定后数值会逐步增大，以降低网络负载。</li>
<li><strong>Reach 可达性</strong>：八进制 377（二进制 11111111）表示最近 8 次轮询全部成功，网络连接状态稳定。</li>
<li><strong>LastRx 最后接收</strong>：39 分钟前接收最后一次响应，属于稳定同步状态下的正常情况。</li>
<li><strong>Last sample 时间偏差</strong>：+389us 表示上次同步时本地时钟比服务器慢 389 微秒；±24ms 代表同步精度控制在 24 毫秒范围内。</li>
</ul>
<p><strong>Euler03节点同步状态：</strong></p>
<pre><code class="hljs">chronyc sources
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce3107316370483588b13b732c660437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hpYW5fb2NlYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765815286&amp;x-signature=LUignj2rOOjtzRQsWdxN75%2Bp5%2Bw%3D" alt="" loading="lazy"/></p>
<p>Euler03节点的同步状态显示：</p>
<ul>
<li>成功与Euler01建立同步关系</li>
<li>时间偏差仅为+144微秒，同步精度良好</li>
<li>网络连接稳定，可达性指标最优</li>
<li>同步精度达到±23毫秒，满足大多数应用场景需求</li>
</ul>
<p>高级监控与诊断</p>
<p>除了基本的<code>sources</code>命令，还可以使用以下命令进行深入诊断：</p>
<p><strong>检查跟踪状态：</strong></p>
<pre><code class="hljs">chronyc tracking
</code></pre>
<p><strong>验证时间源准确性：</strong></p>
<pre><code class="hljs">chronyc sourcestats
</code></pre>
<p><strong>手动时间调整：</strong></p>
<pre><code class="hljs">chronyc makestep
</code></pre>
<h3 data-id="heading-5">时间同步服务性能优化与高可用建议</h3>
<p>性能调优参数</p>
<p>根据实际网络环境和精度要求，可以调整以下参数：</p>
<p><strong>网络延迟补偿：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在chrony.conf中添加</span>
driftfile /var/lib/chrony/drift
makestep 1.0 3
</code></pre>
<p><strong>服务器选择策略：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 优先选择低延迟服务器</span>
minsources 2
</code></pre>
<p>高可用性配置</p>
<p>对于生产环境，建议配置多个时间服务器：</p>
<p><strong>多主节点配置：</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-built_in">server</span> ntp-server1 iburst
<span class="hljs-built_in">server</span> ntp-server2 iburst
<span class="hljs-built_in">server</span> ntp-server3 iburst
</code></pre>
<p><strong>监控告警集成：</strong></p>
<ul>
<li>配置时间偏差监控告警</li>
<li>集成到现有的监控系统中</li>
<li>设置自动故障转移机制</li>
</ul>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler" ref="nofollow noopener noreferrer"><strong>https://distrowatch.com/table-mobile.php?distribution=openeuler</strong></a>，一个由开放原子开源基金会孵化、支持“超节点”场景的Linux 发行版。 openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer"><strong>https://www.openeuler.openatom.cn/zh/</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTTPS和HTTP的区别及自定义证书使用教程]]></title>    <link>https://juejin.cn/post/7582048028392194098</link>    <guid>https://juejin.cn/post/7582048028392194098</guid>    <pubDate>2025-12-10T09:45:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582048028392194098" data-draft-id="7581872532363493385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTTPS和HTTP的区别及自定义证书使用教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T09:45:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTTPS和HTTP的区别及自定义证书使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:45:13.000Z" title="Wed Dec 10 2025 09:45:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>HTTPS(全称:Hyper Text Transfer Protocol over Secure Socket Layer)，是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。 它是一个URI scheme(抽象标识符体系)，句法类同http:体系。用于安全的HTTP数据传输。https:URL表明它使用了HTTP，但HTTPS存在不同于HTTP的默认 端口 及一个加密/身份验证层(在HTTP与TCP之间)。这个系统的最初研发由网景公司(Netscape)进行，并内置于其浏览器Netscape Navigator中，提供了身份验证与加密 通讯 方法。现在它被广泛用于 万维网 上安全敏感的通讯，例如交易支付方面。</p>
<p>HTTPS和HTTP的区别</p>
<p>一、https协议需要到 ca 申请证书，一般免费 证书 很少，需要交费。</p>
<p>二、http是超文本传输协议，信息是明文传输，https 则是具有安全性的ssl加密传输协议。</p>
<p>三、http和https使用的是完全不同的连接方式，用的 端口 也不一样，前者是80，后者是443。</p>
<p>四、http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。</p>
<p>对于网络抓包和分析，工具如 Sniffmaster 可以简化 HTTPS 流量的解密过程，它支持全平台抓包，无需代理或越狱。</p>
<p>第一种使用自定义证书</p>
<pre><code class="hljs language-scss" lang="scss">SSLSocketFactory<span class="hljs-selector-class">.getSocketFactory</span>() 使用自定义证书不被系统承认
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">GetNetWork</span><span class="hljs-params">()</span> {
<span class="hljs-keyword">try</span> {
<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> &amp;#<span class="hljs-number">34</span>;https:<span class="hljs-comment">//192.168.0.102:8443/123.html&amp;#34;;</span>
<span class="hljs-type">BasicHttpParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicHttpParams</span>();
			HttpProtocolParams.setVersion(params, HttpVersion.HTTP_1_1);
			HttpProtocolParams.setContentCharset(params,
					HTTP.DEFAULT_CONTENT_CHARSET);
			HttpProtocolParams.setUseExpectContinue(params, <span class="hljs-literal">true</span>);
			SSLSocketFactory.getSocketFactory().setHostnameVerifier(
<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllowAllHostnameVerifier</span>());
<span class="hljs-type">SchemeRegistry</span> <span class="hljs-variable">schReg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchemeRegistry</span>();
			schReg.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scheme</span>(&amp;#<span class="hljs-number">34</span>;http&amp;#<span class="hljs-number">34</span>;, PlainSocketFactory
					.getSocketFactory(), <span class="hljs-number">80</span>));
			schReg.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scheme</span>(&amp;#<span class="hljs-number">34</span>;https&amp;#<span class="hljs-number">34</span>;, SSLTrustAllSocketFactory
					.getSocketFactory(), <span class="hljs-number">443</span>));
<span class="hljs-type">ClientConnectionManager</span> <span class="hljs-variable">connMgr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadSafeClientConnManager</span>(
					params, schReg);
<span class="hljs-type">DefaultHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultHttpClient</span>(connMgr, params);
<span class="hljs-type">HttpGet</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(path);
<span class="hljs-type">HttpResponse</span> <span class="hljs-variable">httpResponse</span> <span class="hljs-operator">=</span> client.execute(request);
<span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> httpResponse.getStatusLine().getStatusCode();
<span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> httpResponse.getStatusLine().getReasonPhrase();
<span class="hljs-type">HttpEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> httpResponse.getEntity();
<span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">200</span> &amp;&amp; entity != <span class="hljs-literal">null</span>) {
				Log.e(&amp;#<span class="hljs-number">34</span>;log&amp;#<span class="hljs-number">34</span>;, entity.toString());
			}
		} <span class="hljs-keyword">catch</span> (MalformedURLException e) {
			e.printStackTrace();
		} <span class="hljs-keyword">catch</span> (ClientProtocolException e) {
			e.printStackTrace();
		} <span class="hljs-keyword">catch</span> (IOException e) {
			e.printStackTrace();
		}
	}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SSLTrustAllSocketFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SSLSocketFactory</span> {
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> &amp;#<span class="hljs-number">34</span>;SSLTrustAllSocketFactory&amp;#<span class="hljs-number">34</span>;;
<span class="hljs-keyword">private</span> SSLContext mCtx;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SSLTrustAllManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">X509TrustManager</span> {
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkClientTrusted</span><span class="hljs-params">(X509Certificate[] arg0, String arg1)</span>
<span class="hljs-keyword">throws</span> CertificateException {
			}
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkServerTrusted</span><span class="hljs-params">(X509Certificate[] arg0, String arg1)</span>
<span class="hljs-keyword">throws</span> CertificateException {
			}
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> X509Certificate[] getAcceptedIssuers() {
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
			}
		}
<span class="hljs-keyword">public</span> <span class="hljs-title function_">SSLTrustAllSocketFactory</span><span class="hljs-params">(KeyStore truststore)</span> <span class="hljs-keyword">throws</span> Throwable {
<span class="hljs-built_in">super</span>(truststore);
<span class="hljs-keyword">try</span> {
				mCtx = SSLContext.getInstance(&amp;#<span class="hljs-number">34</span>;TLS&amp;#<span class="hljs-number">34</span>;);
				mCtx.init(<span class="hljs-literal">null</span>,
<span class="hljs-keyword">new</span> <span class="hljs-title class_">TrustManager</span>[] { <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSLTrustAllManager</span>() }, <span class="hljs-literal">null</span>);
				setHostnameVerifier(SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER);
			} <span class="hljs-keyword">catch</span> (Exception ex) {
			}
		}
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">(Socket socket, String host, <span class="hljs-type">int</span> port,
<span class="hljs-type">boolean</span> autoClose)</span> <span class="hljs-keyword">throws</span> IOException, UnknownHostException {
<span class="hljs-keyword">return</span> mCtx.getSocketFactory().createSocket(socket, host, port,
					autoClose);
		}
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
<span class="hljs-keyword">return</span> mCtx.getSocketFactory().createSocket();
		}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SSLSocketFactory <span class="hljs-title function_">getSocketFactory</span><span class="hljs-params">()</span> {
<span class="hljs-keyword">try</span> {
<span class="hljs-type">KeyStore</span> <span class="hljs-variable">trustStore</span> <span class="hljs-operator">=</span> KeyStore.getInstance(KeyStore
						.getDefaultType());
				trustStore.load(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
<span class="hljs-type">SSLSocketFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSLTrustAllSocketFactory</span>(
						trustStore);
<span class="hljs-keyword">return</span> factory;
			} <span class="hljs-keyword">catch</span> (Throwable e) {
				Log.d(TAG, e.getMessage());
				e.printStackTrace();
			}
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
		}
	}
</code></pre>
<p>第二种  直接从
<a href="https://link.juejin.cn?target=https%3A%2F%2Fkyfw.12306.cn%2Fotn%2F" target="_blank" title="https://kyfw.12306.cn/otn/" ref="nofollow noopener noreferrer">kyfw.12306.cn/otn/</a> 下载根证书 导入应用中 验证</p>
<pre><code class="hljs language-ini" lang="ini">
public static void GetNetWork2(Context context) {
try {
String <span class="hljs-attr">path</span> = &amp;<span class="hljs-comment">#34;https://kyfw.12306.cn/otn/&amp;#34;;</span>
BasicHttpParams <span class="hljs-attr">params</span> = new BasicHttpParams()<span class="hljs-comment">;</span>
			HttpProtocolParams.setVersion(params, HttpVersion.HTTP_1_1)<span class="hljs-comment">;</span>
			HttpProtocolParams.setContentCharset(params,
					HTTP.DEFAULT_CONTENT_CHARSET)<span class="hljs-comment">;</span>
			HttpProtocolParams.setUseExpectContinue(params, true)<span class="hljs-comment">;</span>
			SSLSocketFactory.getSocketFactory().setHostnameVerifier(
new AllowAllHostnameVerifier())<span class="hljs-comment">;</span>
SchemeRegistry <span class="hljs-attr">schReg</span> = new SchemeRegistry()<span class="hljs-comment">;</span>
			schReg.register(new Scheme(&amp;<span class="hljs-comment">#34;http&amp;#34;, PlainSocketFactory</span>
					.getSocketFactory(), 80))<span class="hljs-comment">;</span>
			schReg.register(new Scheme(&amp;<span class="hljs-comment">#34;https&amp;#34;, SSLCustomSocketFactory</span>
					.getSocketFactory(context), 443))<span class="hljs-comment">;</span>
ClientConnectionManager <span class="hljs-attr">connMgr</span> = new ThreadSafeClientConnManager(
					params, schReg)<span class="hljs-comment">;</span>
DefaultHttpClient <span class="hljs-attr">client</span> = new DefaultHttpClient(connMgr, params)<span class="hljs-comment">;</span>
HttpGet <span class="hljs-attr">request</span> = new HttpGet(path)<span class="hljs-comment">;</span>
HttpResponse <span class="hljs-attr">httpResponse</span> = client.execute(request)<span class="hljs-comment">;</span>
int <span class="hljs-attr">responseCode</span> = httpResponse.getStatusLine().getStatusCode()<span class="hljs-comment">;</span>
String <span class="hljs-attr">message</span> = httpResponse.getStatusLine().getReasonPhrase()<span class="hljs-comment">;</span>
HttpEntity <span class="hljs-attr">entity</span> = httpResponse.getEntity()<span class="hljs-comment">;</span>
if (<span class="hljs-attr">responseCode</span> == <span class="hljs-number">200</span> &amp;&amp; entity != null) {
				Log.e(&amp;<span class="hljs-comment">#34;log&amp;#34;, entity.toString());</span>
			}
		} catch (MalformedURLException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		} catch (ClientProtocolException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		} catch (IOException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		}
	}
public static class SSLCustomSocketFactory extends SSLSocketFactory {
private static final String <span class="hljs-attr">TAG</span> = &amp;<span class="hljs-comment">#34;SSLCustomSocketFactory&amp;#34;;</span>
private static final String <span class="hljs-attr">KEY_PASS</span> = &amp;<span class="hljs-comment">#34;123456&amp;#34;;</span>
public SSLCustomSocketFactory(KeyStore trustStore) throws Throwable {
super(trustStore)<span class="hljs-comment">;</span>
		}
public static SSLCustomSocketFactory getSocketFactory(Context context) {
InputStream <span class="hljs-attr">ins</span> = null<span class="hljs-comment">;</span>
			KeyStore trustStore<span class="hljs-comment">;</span>
try {
				<span class="hljs-attr">ins</span> = context.getResources().openRawResource(R.raw.srca)<span class="hljs-comment">;</span>
				<span class="hljs-attr">trustStore</span> = KeyStore.getInstance(KeyStore.getDefaultType())<span class="hljs-comment">;</span>
				trustStore.load(null)<span class="hljs-comment">;</span>
CertificateFactory <span class="hljs-attr">certificateFactory</span> = CertificateFactory
						.getInstance(&amp;<span class="hljs-comment">#34;X.509&amp;#34;);</span>
String <span class="hljs-attr">certificateAlias</span> = Integer.toString(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
				trustStore.setCertificateEntry(certificateAlias,
						certificateFactory.generateCertificate(ins))<span class="hljs-comment">;</span>
				ins.close()<span class="hljs-comment">;</span>
SSLCustomSocketFactory <span class="hljs-attr">factory</span> = new SSLCustomSocketFactory(
						trustStore)<span class="hljs-comment">;</span>
return factory<span class="hljs-comment">;</span>
			} catch (KeyStoreException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (IOException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (CertificateException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (NoSuchAlgorithmException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (Throwable e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			}finally{
if(ins!=null){
try {
						ins.close()<span class="hljs-comment">;</span>
					} catch (IOException e) {
						e.printStackTrace()<span class="hljs-comment">;</span>
					}
				}
			}
return null<span class="hljs-comment">;</span>
		}
	}
</code></pre>
<p>不论是浏览器导出，还是服务器端获得，都是公钥证书，有两种格式：纯文本的.crt格式或是二进制的.cer格式。两种都可以用。</p>
<p>然后，你如果需要一个特定版本的JCE Provider，然后在这个目录下运行以下命令： keytool -importcert -v -trustcacerts -alias cert12306 -file srca.cer -keystore cert12306.bks -storetype BKS -providerclass org.bouncycastle.jce.provider.BouncyCastleProvider -providerpath bcprov-jdk15on-148.jarr -storepass 123456</p>
<p>生成cert12306.bks文件 导入应用中</p>
<pre><code class="hljs language-ini" lang="ini">
public static void GetNetWork3(Context context) {
try {
String <span class="hljs-attr">path</span> = &amp;<span class="hljs-comment">#34;https://kyfw.12306.cn/otn/&amp;#34;;</span>
BasicHttpParams <span class="hljs-attr">params</span> = new BasicHttpParams()<span class="hljs-comment">;</span>
			HttpProtocolParams.setVersion(params, HttpVersion.HTTP_1_1)<span class="hljs-comment">;</span>
			HttpProtocolParams.setContentCharset(params,
					HTTP.DEFAULT_CONTENT_CHARSET)<span class="hljs-comment">;</span>
			HttpProtocolParams.setUseExpectContinue(params, true)<span class="hljs-comment">;</span>
			SSLSocketFactory.getSocketFactory().setHostnameVerifier(
new AllowAllHostnameVerifier())<span class="hljs-comment">;</span>
SchemeRegistry <span class="hljs-attr">schReg</span> = new SchemeRegistry()<span class="hljs-comment">;</span>
			schReg.register(new Scheme(&amp;<span class="hljs-comment">#34;http&amp;#34;, PlainSocketFactory</span>
					.getSocketFactory(), 80))<span class="hljs-comment">;</span>
			schReg.register(new Scheme(&amp;<span class="hljs-comment">#34;https&amp;#34;, SSLCustomSocketFactory2</span>
					.getSocketFactory(context), 443))<span class="hljs-comment">;</span>
ClientConnectionManager <span class="hljs-attr">connMgr</span> = new ThreadSafeClientConnManager(
					params, schReg)<span class="hljs-comment">;</span>
DefaultHttpClient <span class="hljs-attr">client</span> = new DefaultHttpClient(connMgr, params)<span class="hljs-comment">;</span>
HttpGet <span class="hljs-attr">request</span> = new HttpGet(path)<span class="hljs-comment">;</span>
HttpResponse <span class="hljs-attr">httpResponse</span> = client.execute(request)<span class="hljs-comment">;</span>
int <span class="hljs-attr">responseCode</span> = httpResponse.getStatusLine().getStatusCode()<span class="hljs-comment">;</span>
String <span class="hljs-attr">message</span> = httpResponse.getStatusLine().getReasonPhrase()<span class="hljs-comment">;</span>
HttpEntity <span class="hljs-attr">entity</span> = httpResponse.getEntity()<span class="hljs-comment">;</span>
if (<span class="hljs-attr">responseCode</span> == <span class="hljs-number">200</span> &amp;&amp; entity != null) {
				Log.e(&amp;<span class="hljs-comment">#34;log&amp;#34;, entity.toString());</span>
			}
		} catch (MalformedURLException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		} catch (ClientProtocolException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		} catch (IOException e) {
			e.printStackTrace()<span class="hljs-comment">;</span>
		}
	}
public static class SSLCustomSocketFactory2 extends SSLSocketFactory {
private static final String <span class="hljs-attr">TAG</span> = &amp;<span class="hljs-comment">#34;SSLCustomSocketFactory&amp;#34;;</span>
private static final String <span class="hljs-attr">KEY_PASS</span> = &amp;<span class="hljs-comment">#34;123456&amp;#34;;</span>
public SSLCustomSocketFactory2(KeyStore trustStore) throws Throwable {
super(trustStore)<span class="hljs-comment">;</span>
		}
public static SSLCustomSocketFactory2 getSocketFactory(Context context) {
InputStream <span class="hljs-attr">ins</span> = null<span class="hljs-comment">;</span>
			KeyStore trustStore<span class="hljs-comment">;</span>
try {
				<span class="hljs-attr">ins</span> = context.getResources().openRawResource(R.raw.cert12306)<span class="hljs-comment">;</span>
				<span class="hljs-attr">trustStore</span> = KeyStore.getInstance(KeyStore.getDefaultType())<span class="hljs-comment">;</span>
				trustStore.load(ins, KEY_PASS.toCharArray())<span class="hljs-comment">;</span>
SSLCustomSocketFactory2 <span class="hljs-attr">factory</span> = new SSLCustomSocketFactory2(
						trustStore)<span class="hljs-comment">;</span>
return factory<span class="hljs-comment">;</span>
			} catch (KeyStoreException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (IOException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (CertificateException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (NoSuchAlgorithmException e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			} catch (Throwable e) {
				e.printStackTrace()<span class="hljs-comment">;</span>
			}finally{
if(ins!=null){
try {
						ins.close()<span class="hljs-comment">;</span>
					} catch (IOException e) {
						e.printStackTrace()<span class="hljs-comment">;</span>
					}
				}
			}
return null<span class="hljs-comment">;</span>
		}
	}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS应用发布：App Store上架完整步骤与销售范围管理]]></title>    <link>https://juejin.cn/post/7582016579857580066</link>    <guid>https://juejin.cn/post/7582016579857580066</guid>    <pubDate>2025-12-10T09:47:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579857580066" data-draft-id="7581828086020898831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS应用发布：App Store上架完整步骤与销售范围管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T09:47:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS应用发布：App Store上架完整步骤与销售范围管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:47:56.000Z" title="Wed Dec 10 2025 09:47:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>管理 App 的销售范围</p>
<p>在 App Store 上发布 App 的一般流程如下。</p>
<h2 data-id="heading-0">第 1 步：选择构建版本</h2>
<p>每个 App 可以有多个版本，每个版本也可以包含多个构建版本。若要发布 App，请 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-builds%2Fchoose-a-build-to-submit" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-builds/choose-a-build-to-submit" ref="nofollow noopener noreferrer">选择一个构建版本并提交至审核</a>。</p>
<p>使用AppUploader工具，开发者可以轻松上传IPA文件到App Store，支持Windows、Linux和Mac系统，无需Xcode，简化构建版本的选择和提交过程。</p>
<h2 data-id="heading-1">第 2 步：设置 App Store 价格与销售范围</h2>
<p>请设定 App 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-app-pricing%2Fset-a-price" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-app-pricing/set-a-price" ref="nofollow noopener noreferrer">价格</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-app-information%2Fset-a-tax-category" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-app-information/set-a-tax-category" ref="nofollow noopener noreferrer">税务类别</a>。默认情况下，App 的销售范围为所有 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Freference%2Fapp-store-localizations" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/reference/app-store-localizations" ref="nofollow noopener noreferrer">App Store 国家或地区</a>，但你可以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-your-apps-availability%2Fmanage-availability-for-your-app-on-the-app-store" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-your-apps-availability/manage-availability-for-your-app-on-the-app-store" ref="nofollow noopener noreferrer">修改此范围</a>。你还可以选择 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-your-apps-availability%2Fpublish-for-pre-order" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-your-apps-availability/publish-for-pre-order" ref="nofollow noopener noreferrer">以预购形式发布 App</a>。</p>
<p>AppUploader提供了批量上传应用截图和本地化信息的功能，帮助快速设置多语言版本的销售范围和元数据，提升效率。</p>
<h2 data-id="heading-2">第 3 步：提交 App 以供审核</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-submissions-to-app-review%2Foverview-of-submitting-for-review" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-submissions-to-app-review/overview-of-submitting-for-review" ref="nofollow noopener noreferrer">提交 App 至审核</a>，开启“App 审核”流程。App 通过审核后才能在 App Store 上架。在提交 App 之前，请 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Freference%2Frequired-localizable-and-editable-properties" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/reference/required-localizable-and-editable-properties" ref="nofollow noopener noreferrer">输入所有必填的元数据</a> 并选择 App 的发布方式，包括 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-your-apps-availability%2Fselect-an-app-store-version-release-option" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-your-apps-availability/select-an-app-store-version-release-option" ref="nofollow noopener noreferrer">手动发布、自动发布</a> 以及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fupdate-your-app%2Frelease-a-version-update-in-phases" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/update-your-app/release-a-version-update-in-phases" ref="nofollow noopener noreferrer">分阶段发布</a>。</p>
<p>通过AppUploader，可以高效提交应用至App Store审核，支持在多种操作系统上操作，比传统方式更便捷，加速上架流程。</p>
<h2 data-id="heading-3">第 4 步：查看 App 状态并解决审核问题</h2>
<p>提交 App 后，其状态会变为“正在等待审核”。如果 App 存在任何问题，请 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Fmanage-submissions-to-app-review%2Freply-to-app-review-messages" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/manage-submissions-to-app-review/reply-to-app-review-messages" ref="nofollow noopener noreferrer">阅读并回复“App 审核”消息</a>。App 通过审核后，将于 24 小时内上架至 App Store。</p>
<h2 data-id="heading-4">第 5 步：申请 App Store 促销代码</h2>
<p>App 通过审核后，你可以在 App 上架 App Store 之前 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Foffer-promo-codes%2Frequest-and-manage-promo-codes" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/offer-promo-codes/request-and-manage-promo-codes" ref="nofollow noopener noreferrer">申请促销代码</a>，然后通过电子邮件等方式分享给用户。用户在 App Store 中购买你的 App 时输入促销代码即可兑换。</p>
<p><strong>相关内容</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Freference%2Fin-app-purchase-and-subscriptions-pricing-and-availability" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/reference/in-app-purchase-and-subscriptions-pricing-and-availability" ref="nofollow noopener noreferrer">App 内购买项目和订阅的价格与销售范围</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fcn%2Fhelp%2Fapp-store-connect%2Freference%2Fapp-store-localizations" target="_blank" title="https://developer.apple.com/cn/help/app-store-connect/reference/app-store-localizations" ref="nofollow noopener noreferrer">App Store 本地化</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：DNS 解析过程你能说清吗？DNS 解析全流程深度剖析]]></title>    <link>https://juejin.cn/post/7581876069609062443</link>    <guid>https://juejin.cn/post/7581876069609062443</guid>    <pubDate>2025-12-10T09:47:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581876069609062443" data-draft-id="7581876069609046059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：DNS 解析过程你能说清吗？DNS 解析全流程深度剖析"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T09:47:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：DNS 解析过程你能说清吗？DNS 解析全流程深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T09:47:37.000Z" title="Wed Dec 10 2025 09:47:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这篇文章可以当成一次「DNS 复盘」：从浏览器敲下回车，到真正拿到 IP，中间每一步都摊开讲清楚。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>翻面试记录的时候，这道题几乎是常客："讲讲 DNS 解析的过程"。能讲到尾的人，其实不多。</p>
<p>大多数回答听起来都差不多：</p>
<ul>
<li>"就是把域名转换成 IP 地址"</li>
<li>"先查本地缓存，然后查 DNS 服务器"</li>
<li>"有个递归查询的过程..."</li>
</ul>
<p>方向都对，但更像是背诵版答案——面试官听完，大概知道你学过这块，但很难判断你是真的想明白了。</p>
<p>这篇文章想做的事是：把 DNS 解析这件事拆开、讲透。我们不只把完整流程过一遍，还顺带把背后的设计思路、缓存策略和常见面试追问一并理一遍。看完之后，你在面试里不只“答得出来”，而是能顺着面试官的追问继续往下聊。</p>
<h2 data-id="heading-1">目录</h2>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81dns%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6%E8%A7%A3%E6%9E%90" title="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81dns%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6%E8%A7%A3%E6%9E%90">为什么需要DNS？设计哲学解析</a></li>
<li><a href="#dns%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3" title="#dns%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3">DNS解析完整流程详解</a></li>
<li><a href="#%E9%AB%98%E9%A2%91%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90" title="#%E9%AB%98%E9%A2%91%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90">高频面试题深度剖析</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8" title="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8">性能优化与实际应用</a></li>
<li><a href="#%E9%9D%A2%E8%AF%95%E5%AE%98%E4%BC%9A%E8%BF%BD%E9%97%AE%E7%9A%84%E8%BF%9B%E9%98%B6%E9%97%AE%E9%A2%98" title="#%E9%9D%A2%E8%AF%95%E5%AE%98%E4%BC%9A%E8%BF%BD%E9%97%AE%E7%9A%84%E8%BF%9B%E9%98%B6%E9%97%AE%E9%A2%98">面试官会追问的进阶问题</a></li>
</ul>
<h2 data-id="heading-2">为什么需要DNS？设计哲学解析</h2>
<h3 data-id="heading-3">为什么需要域名系统？</h3>
<p>在 DNS 出现之前，网络中的主机识别依赖于 hosts 文件：</p>
<p><strong>早期的 hosts 文件方案</strong>：</p>
<ul>
<li>每台机器维护一个本地的名字-地址映射文件</li>
<li>需要手动同步更新</li>
<li>无法扩展到大规模网络</li>
</ul>
<p><strong>问题显而易见</strong>：</p>
<ul>
<li>管理复杂：每台机器都要更新</li>
<li>冲突频繁：没有统一的命名规范</li>
<li>扩展困难：无法支持互联网规模</li>
</ul>
<h3 data-id="heading-4">DNS 的分层设计哲学</h3>
<p>DNS 采用了<strong>分层分布</strong>的设计：</p>
<p><strong>层次化命名空间</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">.                    (根域)
├── com.             (顶级域)
│   ├── google.com.  (二级域)
│   └── github.com.
├── org.
└── cn.
    └── baidu.cn.
</code></pre>
<p><strong>分布式管理</strong>：</p>
<ul>
<li>每一层由不同的机构管理</li>
<li>根域由 ICANN 管理</li>
<li>顶级域由各国政府或商业机构管理</li>
<li>二级域由域名注册商和用户管理</li>
</ul>
<p>这就像现实世界的地址系统：国家→省份→城市→街道→门牌号。</p>
<h2 data-id="heading-5">DNS解析完整流程详解</h2>
<h3 data-id="heading-6">面试标准答案：8步完整流程</h3>
<p>当你在浏览器输入 <code>www.example.com</code> 并按下回车，背后发生了什么？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以访问 www.example.com 为例</span>
<span class="hljs-comment">// 完整的DNS解析流程如下：</span>

<span class="hljs-keyword">const</span> dnsResolution = {
    <span class="hljs-attr">step1</span>: &amp;#<span class="hljs-number">34</span>;检查浏览器<span class="hljs-variable constant_">DNS</span>缓存&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step2</span>: &amp;#<span class="hljs-number">34</span>;检查操作系统<span class="hljs-variable constant_">DNS</span>缓存&amp;#<span class="hljs-number">34</span>;,  
    <span class="hljs-attr">step3</span>: &amp;#<span class="hljs-number">34</span>;检查路由器缓存&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step4</span>: &amp;#<span class="hljs-number">34</span>;查询本地<span class="hljs-variable constant_">DNS</span>服务器（通常是<span class="hljs-variable constant_">ISP</span>提供）&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step5</span>: &amp;#<span class="hljs-number">34</span>;本地<span class="hljs-variable constant_">DNS</span>服务器查询根域名服务器&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step6</span>: &amp;#<span class="hljs-number">34</span>;查询顶级域名服务器（.<span class="hljs-property">com</span>）&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step7</span>: &amp;#<span class="hljs-number">34</span>;查询权威域名服务器（example.<span class="hljs-property">com</span>）&amp;#<span class="hljs-number">34</span>;, 
    <span class="hljs-attr">step8</span>: &amp;#<span class="hljs-number">34</span>;返回<span class="hljs-variable constant_">IP</span>地址并缓存&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<h3 data-id="heading-7">详细流程图解</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户输入 www.example.com] --&gt; B{浏览器缓存?}
    B --&gt;|命中| I[返回IP地址]
    B --&gt;|未命中| C{操作系统缓存?}
    C --&gt;|命中| I
    C --&gt;|未命中| D{路由器缓存?}
    D --&gt;|命中| I
    D --&gt;|未命中| E[查询本地DNS服务器]
    E --&gt; F[查询根域名服务器]
    F --&gt; G[查询.com顶级域服务器]
    G --&gt; H[查询example.com权威服务器]
    H --&gt; I
    I --&gt; J[建立TCP连接]
</code></pre>
<h3 data-id="heading-8">缓存层次深度解析</h3>
<p>DNS 系统的另一个核心设计是<strong>多级缓存</strong>：</p>
<p><strong>为什么需要缓存？</strong></p>
<ul>
<li>减少网络请求：避免每次都查询权威服务器</li>
<li>提高响应速度：本地缓存几乎是瞬时响应</li>
<li>降低系统负载：减少根服务器和权威服务器的压力</li>
</ul>
<p><strong>缓存的层次</strong>：</p>
<ol>
<li>浏览器缓存：最快的响应</li>
<li>操作系统缓存：系统级别的缓存</li>
<li>路由器缓存：网络设备的缓存</li>
<li>ISP 缓存：运营商的递归服务器</li>
<li>权威服务器：最终的数据源</li>
</ol>
<h2 data-id="heading-9">高频面试题深度剖析</h2>
<h3 data-id="heading-10">面试题1：递归查询 vs 迭代查询的区别</h3>
<p>这是面试官最爱问的问题！</p>
<p><strong>递归查询</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 客户端的视角：我只问一次，你帮我搞定一切</span>
<span class="hljs-keyword">const</span> recursiveQuery = {
    <span class="hljs-attr">client</span>: &amp;#<span class="hljs-number">34</span>;本地<span class="hljs-variable constant_">DNS</span>服务器，帮我查 www.<span class="hljs-property">example</span>.<span class="hljs-property">com</span> 的<span class="hljs-variable constant_">IP</span>&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">localDNS</span>: &amp;#<span class="hljs-number">34</span>;好的，我来帮你搞定，稍等...&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-comment">// 本地DNS服务器代替客户端完成所有查询</span>
    <span class="hljs-attr">process</span>: &amp;#<span class="hljs-number">34</span>;本地<span class="hljs-variable constant_">DNS</span> → 根服务器 → .<span class="hljs-property">com</span>服务器 → example.<span class="hljs-property">com</span>服务器&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">response</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span>&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<p><strong>迭代查询</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 客户端的视角：每一步都要自己问</span>
<span class="hljs-keyword">const</span> iterativeQuery = {
    <span class="hljs-attr">step1</span>: &amp;#<span class="hljs-number">34</span>;客户端问根服务器：www.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>在哪？&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step1Response</span>: &amp;#<span class="hljs-number">34</span>;我不知道，但是.<span class="hljs-property">com</span>域的服务器在这里&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step2</span>: &amp;#<span class="hljs-number">34</span>;客户端问.<span class="hljs-property">com</span>服务器：www.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>在哪？&amp;#<span class="hljs-number">34</span>;, 
    <span class="hljs-attr">step2Response</span>: &amp;#<span class="hljs-number">34</span>;我不知道，但是example.<span class="hljs-property">com</span>的服务器在这里&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step3</span>: &amp;#<span class="hljs-number">34</span>;客户端问example.<span class="hljs-property">com</span>服务器：www.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>的<span class="hljs-variable constant_">IP</span>是？&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">step3Response</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span>&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<p><strong>面试加分点</strong>：现实中，客户端到本地DNS是递归查询，本地DNS到其他服务器是迭代查询。</p>
<h3 data-id="heading-11">面试题2：为什么需要13个根服务器？</h3>
<p><strong>标准答案</strong>：</p>
<ul>
<li><strong>技术限制</strong>：UDP包大小限制为512字节，只能容纳13个根服务器的IP地址</li>
<li><strong>足够冗余</strong>：13个已经提供了充分的冗余和负载分散</li>
<li><strong>全球分布</strong>：通过任播技术，实际有数百个根服务器节点</li>
</ul>
<p><strong>加分回答</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rootServers = {
    <span class="hljs-attr">technical</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">UDP</span>包<span class="hljs-number">512</span>字节限制，<span class="hljs-number">13</span>个<span class="hljs-title class_">IPv4</span>地址刚好装得下&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">practical</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">13</span>个已经足够实现全球负载均衡和容错&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">evolution</span>: &amp;#<span class="hljs-number">34</span>;现代通过<span class="hljs-title class_">IPv6</span>和<span class="hljs-variable constant_">EDNS</span>可以支持更多，但历史包袱&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<h3 data-id="heading-12">面试题3：DNS解析失败的常见原因</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dnsFailureReasons = {
    <span class="hljs-comment">// 网络层面</span>
    <span class="hljs-attr">networkIssues</span>: {
        &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>服务器宕机&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;使用备用<span class="hljs-variable constant_">DNS</span>服务器<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>&amp;#<span class="hljs-number">34</span>;,
        &amp;#<span class="hljs-number">34</span>;网络不通&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;检查网络连接&amp;#<span class="hljs-number">34</span>;,
        &amp;#<span class="hljs-number">34</span>;防火墙拦截&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;检查<span class="hljs-number">53</span>端口是否开放&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 配置层面  </span>
    <span class="hljs-attr">configIssues</span>: {
        &amp;#<span class="hljs-number">34</span>;域名过期&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;及时续费域名&amp;#<span class="hljs-number">34</span>;,
        &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>记录配置错误&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;检查A记录、<span class="hljs-variable constant_">CNAME</span>记录&amp;#<span class="hljs-number">34</span>;,
        &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">TTL</span>设置过长&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;更新后需要等待<span class="hljs-variable constant_">TTL</span>过期&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 缓存层面</span>
    <span class="hljs-attr">cacheIssues</span>: {
        &amp;#<span class="hljs-number">34</span>;缓存污染&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;清空<span class="hljs-variable constant_">DNS</span>缓存&amp;#<span class="hljs-number">34</span>;,
        &amp;#<span class="hljs-number">34</span>;缓存过期&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;等待自动更新或手动刷新&amp;#<span class="hljs-number">34</span>;
    }
};
</code></pre>
<h3 data-id="heading-13">记录类型的设计意图</h3>
<p>DNS 不只是简单的名字到 IP 的映射，它支持多种记录类型：</p>
<p><strong>A 记录</strong>：域名到 IPv4 地址</p>
<ul>
<li><code>www.example.com → 192.168.1.1</code></li>
<li>最基础的映射关系</li>
</ul>
<p><strong>AAAA 记录</strong>：域名到 IPv6 地址</p>
<ul>
<li>为了支持 IPv6 而设计</li>
<li>未来网络的基础</li>
</ul>
<p><strong>CNAME 记录</strong>：域名到域名的别名</p>
<ul>
<li><code>blog.example.com → www.example.com</code></li>
<li>便于管理和重定向</li>
</ul>
<p><strong>MX 记录</strong>：邮件服务器指向</p>
<ul>
<li>指定域名的邮件服务器</li>
<li>支持优先级设置</li>
</ul>
<p><strong>TXT 记录</strong>：任意文本信息</p>
<ul>
<li>域名验证、SPF 记录等</li>
<li>扩展性很强的设计</li>
</ul>
<h3 data-id="heading-14">TTL 的缓存策略</h3>
<p>TTL（Time To Live）体现了缓存策略的精妙设计：</p>
<p><strong>TTL 的作用</strong>：</p>
<ul>
<li>控制缓存时间：平衡性能和一致性</li>
<li>权威服务器可以控制缓存策略</li>
<li>不同记录可以有不同的 TTL</li>
</ul>
<p><strong>TTL 设置的权衡</strong>：</p>
<ul>
<li><strong>短 TTL</strong>：更新快，但查询频繁</li>
<li><strong>长 TTL</strong>：性能好，但更新慢</li>
<li><strong>动态调整</strong>：根据业务需求灵活设置</li>
</ul>
<h2 data-id="heading-15">性能优化与实际应用</h2>
<h3 data-id="heading-16">前端DNS优化策略</h3>
<p><strong>1. DNS预解析</strong>：</p>
<pre><code class="hljs language-html" lang="html">






</code></pre>
<p><strong>2. JavaScript DNS预热</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态预解析</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">prefetchDNS</span>(<span class="hljs-params">hostname</span>) {
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>);
    link.<span class="hljs-property">rel</span> = <span class="hljs-string">'dns-prefetch'</span>;
    link.<span class="hljs-property">href</span> = <span class="hljs-string">`//<span class="hljs-subst">${hostname}</span>`</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link);
}

<span class="hljs-comment">// 在用户可能访问前预热</span>
<span class="hljs-title function_">prefetchDNS</span>(<span class="hljs-string">'next-page-api.com'</span>);
</code></pre>
<p><strong>3. 智能DNS配置</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dnsOptimization = {
    <span class="hljs-comment">// 减少DNS查询次数</span>
    <span class="hljs-attr">domainSharding</span>: &amp;#<span class="hljs-number">34</span>;避免过多子域名，减少<span class="hljs-variable constant_">DNS</span>查询&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 选择快速DNS服务器  </span>
    <span class="hljs-attr">publicDNS</span>: [&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>&amp;#<span class="hljs-number">34</span>;],
    
    <span class="hljs-comment">// 本地DNS缓存</span>
    <span class="hljs-attr">localCache</span>: &amp;#<span class="hljs-number">34</span>;合理设置浏览器<span class="hljs-variable constant_">DNS</span>缓存时间&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<h3 data-id="heading-17">安全考虑</h3>
<p><strong>DNS 劫持防护</strong>：</p>
<ul>
<li>使用可信的 DNS 服务器（如 8.8.8.8、1.1.1.1）</li>
<li>启用 DNS over HTTPS (DoH) 或 DNS over TLS (DoT)</li>
<li>监控 DNS 解析结果的异常</li>
</ul>
<p><strong>域名安全策略</strong>：</p>
<ul>
<li>及时续费域名，避免被恶意抢注</li>
<li>使用域名锁定服务</li>
<li>监控域名解析变化</li>
</ul>
<h3 data-id="heading-18">性能监控</h3>
<p><strong>DNS 解析时间监控</strong>：</p>
<ul>
<li>监控不同地区的 DNS 解析速度</li>
<li>识别 DNS 解析瓶颈</li>
<li>优化 DNS 配置</li>
</ul>
<p><strong>缓存命中率分析</strong>：</p>
<ul>
<li>分析缓存效果</li>
<li>调整 TTL 设置</li>
<li>优化缓存策略</li>
</ul>
<h2 data-id="heading-19">面试官会追问的进阶问题</h2>
<h3 data-id="heading-20">追问1：如果DNS服务器全部挂了怎么办？</h3>
<p><strong>层层递进的回答</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dnsFailureHandling = {
    <span class="hljs-attr">level1</span>: &amp;#<span class="hljs-number">34</span>;浏览器缓存兜底&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">level2</span>: &amp;#<span class="hljs-number">34</span>;操作系统缓存兜底&amp;#<span class="hljs-number">34</span>;, 
    <span class="hljs-attr">level3</span>: &amp;#<span class="hljs-number">34</span>;路由器缓存兜底&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">level4</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">ISP</span>多个<span class="hljs-variable constant_">DNS</span>服务器轮询&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">level5</span>: &amp;#<span class="hljs-number">34</span>;使用备用公共<span class="hljs-variable constant_">DNS</span>服务器&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">level6</span>: &amp;#<span class="hljs-number">34</span>;最坏情况：直接使用<span class="hljs-variable constant_">IP</span>地址访问&amp;#<span class="hljs-number">34</span>;
};

<span class="hljs-comment">// 实际处理策略</span>
<span class="hljs-keyword">const</span> fallbackStrategy = {
    <span class="hljs-attr">primary</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">119.29</span><span class="hljs-number">.29</span><span class="hljs-number">.29</span>&amp;#<span class="hljs-number">34</span>;,    <span class="hljs-comment">// 腾讯DNS</span>
    <span class="hljs-attr">secondary</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>&amp;#<span class="hljs-number">34</span>;,       <span class="hljs-comment">// Google DNS  </span>
    <span class="hljs-attr">tertiary</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>&amp;#<span class="hljs-number">34</span>;,       <span class="hljs-comment">// Cloudflare DNS</span>
    <span class="hljs-attr">emergency</span>: &amp;#<span class="hljs-number">34</span>;直接<span class="hljs-variable constant_">IP</span>访问或离线页面&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<p><strong>加分点</strong>：提到DNS的分布式设计和任播技术让整体服务很难完全挂掉。</p>
<h3 data-id="heading-21">追问2：为什么有些网站打开很慢，DNS解析需要多长时间？</h3>
<p><strong>性能数据分析</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dnsPerformanceData = {
    <span class="hljs-comment">// 各阶段耗时（典型值）</span>
    <span class="hljs-attr">browserCache</span>: &amp;#<span class="hljs-number">34</span>;0ms（如果命中）&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">osCache</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">1</span>-5ms（如果命中）&amp;#<span class="hljs-number">34</span>;,
    <span class="hljs-attr">localDNSQuery</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">10</span>-50ms（中国大陆）&amp;#<span class="hljs-number">34</span>;, 
    <span class="hljs-attr">recursiveQuery</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">50</span>-200ms（首次查询）&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 影响因素</span>
    <span class="hljs-attr">factors</span>: {
        <span class="hljs-attr">networkLatency</span>: &amp;#<span class="hljs-number">34</span>;网络延迟是主要因素&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">dnsServerLocation</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>服务器地理位置&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">cacheHitRate</span>: &amp;#<span class="hljs-number">34</span>;缓存命中率&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">queryType</span>: &amp;#<span class="hljs-number">34</span>;查询类型（A/<span class="hljs-variable constant_">AAAA</span>/<span class="hljs-variable constant_">CNAME</span>）&amp;#<span class="hljs-number">34</span>;
    }
};
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>使用CDN减少DNS查询链长度</li>
<li>选择地理位置更近的DNS服务器</li>
<li>合理设置TTL平衡更新速度和性能</li>
</ul>
<h3 data-id="heading-22">追问3：HTTPS网站的DNS解析有什么特殊之处？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> httpsSpecialHandling = {
    <span class="hljs-comment">// DNS解析阶段相同</span>
    <span class="hljs-attr">dnsPhase</span>: &amp;#<span class="hljs-number">34</span>;与<span class="hljs-variable constant_">HTTP</span>完全一样，都是解析域名到<span class="hljs-variable constant_">IP</span>&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 但后续步骤不同</span>
    <span class="hljs-attr">afterDNS</span>: {
        <span class="hljs-attr">tlsHandshake</span>: &amp;#<span class="hljs-number">34</span>;需要额外的<span class="hljs-variable constant_">TLS</span>握手过程&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">certificateValidation</span>: &amp;#<span class="hljs-number">34</span>;需要验证<span class="hljs-variable constant_">SSL</span>证书&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">sni</span>: &amp;#<span class="hljs-number">34</span>;可能需要<span class="hljs-variable constant_">SNI</span>（<span class="hljs-title class_">Server</span> <span class="hljs-title class_">Name</span> <span class="hljs-title class_">Indication</span>）&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 性能影响</span>
    <span class="hljs-attr">performance</span>: {
        <span class="hljs-attr">additionalRoundTrips</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">TLS</span>握手增加<span class="hljs-number">1</span>-<span class="hljs-number">2</span>个<span class="hljs-variable constant_">RTT</span>&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">certificateChain</span>: &amp;#<span class="hljs-number">34</span>;下载和验证证书链&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">ocspStapling</span>: &amp;#<span class="hljs-number">34</span>;可能的<span class="hljs-variable constant_">OCSP</span>检查&amp;#<span class="hljs-number">34</span>;
    }
};
</code></pre>
<h3 data-id="heading-23">追问4：CDN是如何通过DNS实现智能调度的？</h3>
<p><strong>智能DNS调度原理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cdnDnsStrategy = {
    <span class="hljs-comment">// 用户请求过程</span>
    <span class="hljs-attr">userRequest</span>: &amp;#<span class="hljs-number">34</span>;用户请求 www.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// DNS智能响应</span>
    <span class="hljs-attr">dnsResponse</span>: {
        <span class="hljs-attr">step1</span>: &amp;#<span class="hljs-number">34</span>;检测用户<span class="hljs-variable constant_">IP</span>地理位置&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">step2</span>: &amp;#<span class="hljs-number">34</span>;检查各<span class="hljs-variable constant_">CDN</span>节点健康状态&amp;#<span class="hljs-number">34</span>;, 
        <span class="hljs-attr">step3</span>: &amp;#<span class="hljs-number">34</span>;计算最优节点（延迟+负载）&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">step4</span>: &amp;#<span class="hljs-number">34</span>;返回最优节点<span class="hljs-variable constant_">IP</span>地址&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 实现技术</span>
    <span class="hljs-attr">implementation</span>: {
        <span class="hljs-attr">geoDNS</span>: &amp;#<span class="hljs-number">34</span>;基于地理位置的<span class="hljs-variable constant_">DNS</span>解析&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">healthCheck</span>: &amp;#<span class="hljs-number">34</span>;实时监控节点状态&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">loadBalancing</span>: &amp;#<span class="hljs-number">34</span>;根据负载动态调整&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">anycast</span>: &amp;#<span class="hljs-number">34</span>;任播技术优化路由&amp;#<span class="hljs-number">34</span>;
    }
};
</code></pre>
<h2 data-id="heading-24">DNS设计权衡分析</h2>
<h3 data-id="heading-25">一致性 vs 性能</h3>
<p>DNS 系统体现了分布式系统的经典权衡：</p>
<p><strong>最终一致性</strong>：</p>
<ul>
<li>DNS 更新不是实时的</li>
<li>不同地区可能看到不同的结果</li>
<li>通过 TTL 控制一致性窗口</li>
</ul>
<p><strong>性能优化</strong>：</p>
<ul>
<li>多级缓存提升响应速度</li>
<li>分布式架构提高可用性</li>
<li>就近访问减少网络延迟</li>
</ul>
<h3 data-id="heading-26">可用性 vs 安全性</h3>
<p><strong>高可用设计</strong>：</p>
<ul>
<li>13 个根服务器分布全球</li>
<li>任播技术实现就近访问</li>
<li>冗余设计避免单点故障</li>
</ul>
<p><strong>安全挑战</strong>：</p>
<ul>
<li>DNS 查询默认是明文的</li>
<li>容易被监听和篡改</li>
<li>需要额外的安全机制</li>
</ul>
<h3 data-id="heading-27">扩展性 vs 复杂性</h3>
<p><strong>扩展性设计</strong>：</p>
<ul>
<li>分层架构支持无限扩展</li>
<li>新的记录类型可以随时添加</li>
<li>支持国际化域名</li>
</ul>
<p><strong>复杂性管理</strong>：</p>
<ul>
<li>多级查询增加了复杂度</li>
<li>缓存一致性问题</li>
<li>故障排查困难</li>
</ul>
<h2 data-id="heading-28">面试总结：如何获得高分</h2>
<h3 data-id="heading-29">90分答案的结构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> perfectAnswer = {
    <span class="hljs-comment">// 第一层：基础流程（60分）</span>
    <span class="hljs-attr">basicFlow</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">8</span>步完整流程，从浏览器缓存到权威服务器&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 第二层：技术细节（75分）</span>
    <span class="hljs-attr">technicalDetails</span>: {
        <span class="hljs-attr">recursiveVsIterative</span>: &amp;#<span class="hljs-number">34</span>;递归查询vs迭代查询的区别&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">cacheStrategy</span>: &amp;#<span class="hljs-number">34</span>;多级缓存机制和<span class="hljs-variable constant_">TTL</span>策略&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">recordTypes</span>: &amp;#<span class="hljs-number">34</span>;A/<span class="hljs-variable constant_">AAAA</span>/<span class="hljs-variable constant_">CNAME</span>/<span class="hljs-variable constant_">MX</span>记录的作用&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 第三层：设计思考（85分）</span>
    <span class="hljs-attr">designThinking</span>: {
        <span class="hljs-attr">distributedSystem</span>: &amp;#<span class="hljs-number">34</span>;分布式系统的一致性权衡&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">performanceOptimization</span>: &amp;#<span class="hljs-number">34</span>;缓存与实时性的平衡&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">securityConsideration</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>劫持和安全防护&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 第四层：实际应用（90分+）</span>
    <span class="hljs-attr">practicalApplication</span>: {
        <span class="hljs-attr">frontendOptimization</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>预解析和性能优化&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">troubleshooting</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-variable constant_">DNS</span>解析失败的排查思路&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">modernTechnology</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-title class_">DoH</span>/<span class="hljs-title class_">DoT</span>等新技术趋势&amp;#<span class="hljs-number">34</span>;
    }
};
</code></pre>
<h3 data-id="heading-30">常见扣分点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> commonMistakes = {
    <span class="hljs-comment">// 流程不完整</span>
    <span class="hljs-attr">incompleteFlow</span>: &amp;#<span class="hljs-number">34</span>;只说了<span class="hljs-string">'查缓存然后查DNS服务器'</span>&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 概念混淆</span>
    <span class="hljs-attr">conceptConfusion</span>: {
        <span class="hljs-attr">mistake1</span>: &amp;#<span class="hljs-number">34</span>;分不清递归查询和迭代查询&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">mistake2</span>: &amp;#<span class="hljs-number">34</span>;不知道本地<span class="hljs-variable constant_">DNS</span>服务器的作用&amp;#<span class="hljs-number">34</span>;,
        <span class="hljs-attr">mistake3</span>: &amp;#<span class="hljs-number">34</span>;混淆<span class="hljs-variable constant_">DNS</span>记录类型&amp;#<span class="hljs-number">34</span>;
    },
    
    <span class="hljs-comment">// 缺乏深度</span>
    <span class="hljs-attr">lackDepth</span>: &amp;#<span class="hljs-number">34</span>;只停留在表面，没有分析设计原理&amp;#<span class="hljs-number">34</span>;,
    
    <span class="hljs-comment">// 脱离实际</span>
    <span class="hljs-attr">lackPractical</span>: &amp;#<span class="hljs-number">34</span>;不知道如何在实际项目中优化<span class="hljs-variable constant_">DNS</span>性能&amp;#<span class="hljs-number">34</span>;
};
</code></pre>
<h3 data-id="heading-31">面试加分技巧</h3>
<ol>
<li><strong>用数据说话</strong>：提到具体的延迟数据和优化效果</li>
<li><strong>结合实际项目</strong>：说说你在项目中如何优化DNS解析</li>
<li><strong>展示系统思维</strong>：从设计权衡的角度分析DNS系统</li>
<li><strong>关注新技术</strong>：了解DoH、DoT等新兴技术</li>
</ol>
<h2 data-id="heading-32">总结</h2>
<p>DNS解析不仅仅是"把域名转换成IP地址"这么简单，它是一个复杂的分布式系统，体现了网络架构设计的智慧。</p>
<h3 data-id="heading-33">核心要点回顾</h3>
<ol>
<li><strong>8步完整流程</strong>：从浏览器缓存到权威服务器的完整链路</li>
<li><strong>分层缓存机制</strong>：多级缓存提升性能的同时保证一致性</li>
<li><strong>递归vs迭代</strong>：理解两种查询方式的区别和应用场景</li>
<li><strong>性能优化策略</strong>：前端DNS预解析、智能DNS选择等</li>
<li><strong>安全考虑</strong>：DNS劫持防护和新兴安全技术</li>
</ol>
<h3 data-id="heading-34">实际应用建议</h3>
<ul>
<li><strong>开发阶段</strong>：合理使用DNS预解析，减少不必要的域名查询</li>
<li><strong>部署阶段</strong>：选择合适的TTL值，平衡性能和更新速度</li>
<li><strong>监控阶段</strong>：关注DNS解析时间，及时发现性能瓶颈</li>
<li><strong>优化阶段</strong>：结合CDN和智能DNS，提升用户体验</li>
</ul>
<p>掌握了这些知识点，你就能在面试中游刃有余，展现出深厚的技术功底和系统性思维。</p>
<hr/>
<h2 data-id="heading-35">相关资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc1035" target="_blank" title="https://tools.ietf.org/html/rfc1035" ref="nofollow noopener noreferrer">RFC 1035 - DNS 协议规范</a>：DNS 协议的基础定义</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc4033" target="_blank" title="https://tools.ietf.org/html/rfc4033" ref="nofollow noopener noreferrer">DNS 安全扩展 (DNSSEC)</a>：DNS 安全机制</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudflare.com%2Flearning%2Fdns%2F" target="_blank" title="https://www.cloudflare.com/learning/dns/" ref="nofollow noopener noreferrer">Cloudflare DNS 学习中心</a>：DNS 概念的通俗解释</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fspeed%2Fpublic-dns" target="_blank" title="https://developers.google.com/speed/public-dns" ref="nofollow noopener noreferrer">Google Public DNS</a>：公共DNS服务详解</li>
</ul>
<hr/>
<p>如果这篇文章帮你在面试中拿到了高分，欢迎点赞收藏！有任何DNS相关的问题，也欢迎在评论区交流讨论。</p>
<blockquote>
<p>💡 <strong>面试技巧</strong>：准备面试时不要只背答案，要理解原理。面试官更看重你的思考过程和解决问题的能力。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>