<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%]]></title>    <link>https://juejin.cn/post/7586182451598082094</link>    <guid>https://juejin.cn/post/7586182451598082094</guid>    <pubDate>2025-12-22T04:30:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586182451598082094" data-draft-id="7586167377381965850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-22T04:30:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:30:28.000Z" title="Mon Dec 22 2025 04:30:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>从30分钟到5分钟：一个企业级RAG架构的全链路设计思考</p>
</blockquote>
<h2 data-id="heading-0">前言：制造业的文档之痛</h2>
<p>在大型制造业企业，一线维保人员每天都要面对海量的技术文档：设备手册、故障代码表、维修记录、图纸变更通知...这些文档格式各异（PDF、Excel、HTML），专业术语密集，且分散在各个系统中。</p>
<p>传统的关键词搜索在“螺杆泵G35-2R故障代码E207”这样的专业查询面前显得力不从心。要么搜不到，要么搜不准——一个看似简单的资料查询，平均要<strong>耗费30分钟</strong>。</p>
<p>这正是我们为某大型制造企业定制开发RAG知识库智能助手的背景。今天，我将详细拆解这个项目的架构设计与实战经验，希望能给正在或计划构建企业级AI应用的开发者一些启发。</p>
<h2 data-id="heading-1">一、业务挑战与技术选型</h2>
<h3 data-id="heading-2">1.1 核心痛点</h3>
<ul>
<li><strong>语义鸿沟</strong>：设备型号、故障代码等专有名词传统搜索难以理解</li>
<li><strong>响应延迟</strong>：海量文档索引慢，问答响应时间长</li>
<li><strong>成本控制</strong>：大模型调用成本高昂，且容易产生“幻觉回答”</li>
<li><strong>生态封闭</strong>：知识库能力难以复用到其他AI场景</li>
</ul>
<h3 data-id="heading-3">1.2 技术栈全景</h3>
<pre><code class="hljs language-markdown" lang="markdown">后端框架：Golang + GoFrame (GF)  // 高性能Web服务
AI编排层：CloudWeGo/Eino Graph   // 复杂流程编排
存储层：
<span class="hljs-bullet">  -</span> MySQL（元数据）
<span class="hljs-bullet">  -</span> Elasticsearch（关键词检索）
<span class="hljs-bullet">  -</span> Qdrant（向量检索）
基础设施：
<span class="hljs-bullet">  -</span> Docker容器化
<span class="hljs-bullet">  -</span> Prometheus监控
<span class="hljs-bullet">  -</span> MCP协议（AI能力标准化）
</code></pre>
<p>选择Go语言的核心考量：在高并发文档处理、流式响应等场景下，Go的协程模型能提供卓越的吞吐性能，且部署资源消耗远低于Python方案。</p>
<h2 data-id="heading-4">二、架构设计：四级过滤的RAG流水线</h2>
<p>我们摒弃了简单的“检索-生成”两步走方案，设计了<strong>四级精炼流水线</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户查询 → Hybrid <span class="hljs-keyword">Search</span> → Rerank重排 → Grader评分 → LLM生成 → 流式输出
</code></pre>
<h3 data-id="heading-5">2.1 第一关：混合检索（Hybrid Search）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 简化的混合检索逻辑示意</span>
func <span class="hljs-built_in">hybridSearch</span>(query string, topK int) ([]Document, error) {
    <span class="hljs-comment">// 并行执行关键词和向量检索</span>
    <span class="hljs-selector-tag">var</span> keywordResults, vectorResults <span class="hljs-selector-attr">[]</span>Document
    
    wg := sync.WaitGroup{}
    wg<span class="hljs-selector-class">.Add</span>(<span class="hljs-number">2</span>)
    
    go <span class="hljs-built_in">func</span>() {
        defer wg<span class="hljs-selector-class">.Done</span>()
        keywordResults = <span class="hljs-built_in">elasticsearchSearch</span>(query, topK*<span class="hljs-number">2</span>)
    }()
    
    go <span class="hljs-built_in">func</span>() {
        defer wg<span class="hljs-selector-class">.Done</span>() 
        vectorResults = <span class="hljs-built_in">qdrantSearch</span>(query, topK*<span class="hljs-number">2</span>)
    }()
    
    wg<span class="hljs-selector-class">.Wait</span>()
    
    <span class="hljs-comment">// RRF融合排序</span>
    return <span class="hljs-built_in">reciprocalRankFusion</span>(keywordResults, vectorResults, topK), nil
}
</code></pre>
<p><strong>设计思考</strong>：为什么不是纯向量搜索？</p>
<ul>
<li>关键词搜索：保证<strong>查全率</strong>，对精确术语（如“E207”）命中率高</li>
<li>向量搜索：保证<strong>语义理解</strong>，对“设备不转了怎么办”这类描述有效</li>
<li>RRF融合：结合两者优势，1+1&gt;2</li>
</ul>
<h3 data-id="heading-6">2.2 第二关：语义重排（Rerank）</h3>
<p>混合检索返回的Top-20文档，通过专门的Rerank模型（如bge-reranker）进行<strong>精细化相关性排序</strong>。</p>
<p>这个环节将“大致相关”变成“精准相关”。在我们的测试中，经过Rerank后，Top-5文档的相关性评分<strong>从60%提升至85%</strong>。</p>
<h3 data-id="heading-7">2.3 第三关：置信评分（Grader）- 我们的核心创新</h3>
<p>这是我们从实践中提炼出的<strong>关键安全阀</strong>。即便经过前两关，仍可能检索到低质量内容，如果直接喂给LLM，会导致：</p>
<ol>
<li>生成幻觉答案</li>
<li>消耗无效Token（成本浪费）</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Grader中间件核心逻辑</span>
<span class="hljs-keyword">type</span> GraderMiddleware <span class="hljs-keyword">struct</span> {
    confidenceThreshold <span class="hljs-type">float64</span> <span class="hljs-comment">// 例如0.7</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *GraderMiddleware)</span></span> Check(query <span class="hljs-type">string</span>, documents []Document) (<span class="hljs-type">bool</span>, <span class="hljs-type">string</span>) {
    <span class="hljs-comment">// 调用轻量级分类模型评估“文档集是否足以回答问题”</span>
    confidence := evaluateRelevance(query, documents)
    
    <span class="hljs-keyword">if</span> confidence &lt; g.confidenceThreshold {
        <span class="hljs-comment">// 触发熔断，返回兜底回复</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-string">"当前知识库中暂无此问题的准确信息，建议联系技术专家确认。"</span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-string">""</span>
}
</code></pre>
<p><strong>效果数据</strong>：</p>
<ul>
<li>拦截约15%的低质量检索</li>
<li>每月节省<strong>20%的大模型调用成本</strong></li>
<li>从源头减少80%的幻觉回答</li>
</ul>
<h3 data-id="heading-8">2.4 第四关：流式生成（Streaming）</h3>
<p>用户体验的最后一公里优化：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 基于SSE的流式输出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">streamResponse</span><span class="hljs-params">(c *gf.Request, answerChan &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> {
    c.Response.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>)
    
    <span class="hljs-keyword">for</span> chunk := <span class="hljs-keyword">range</span> answerChan {
        fmt.Fprintf(c.Response, <span class="hljs-string">"data: %s\n\n"</span>, chunk)
        c.Response.Flush() <span class="hljs-comment">// 立即发送到客户端</span>
    }
}
</code></pre>
<p><strong>关键指标</strong>：</p>
<ul>
<li>首字响应时间（TTFT）&lt; 200ms</li>
<li>用户感知流畅度提升显著</li>
</ul>
<h2 data-id="heading-9">三、Eino Graph：可视化编排复杂AI工作流</h2>
<p>传统AI应用代码像“意大利面条”，各种if-else和回调嵌套。我们采用Eino的Graph（DAG）模式，将整个RAG流程可视化编排：</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[用户查询]</span> --&gt; <span class="hljs-selector-tag">B</span>{Query Understanding}
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[Hybrid Search]</span>
    C --&gt; D<span class="hljs-selector-attr">[Rerank排序]</span>
    D --&gt; E{Grader检查}
    E --&gt;|置信度高| F<span class="hljs-selector-attr">[LLM生成]</span>
    E --&gt;|置信度低| G<span class="hljs-selector-attr">[返回兜底]</span>
    F --&gt; H<span class="hljs-selector-attr">[流式输出]</span>
    G --&gt; H
</code></pre>
<p><strong>Graph编排的优势</strong>：</p>
<ol>
<li><strong>可观测性</strong>：每个节点的执行状态、耗时一目了然</li>
<li><strong>可调试性</strong>：可以单独mock某个节点进行测试</li>
<li><strong>可复用性</strong>：子图可以快速复用到其他场景</li>
</ol>
<h2 data-id="heading-10">四、性能优化实战</h2>
<h3 data-id="heading-11">4.1 索引性能：从串行到并行</h3>
<p>文档索引原本是性能瓶颈，尤其是万页PDF处理。</p>
<p><strong>优化前</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">解析 → 分块 → 向量化 → 存储 (串行，耗时约<span class="hljs-number">40</span>分钟/GB)
</code></pre>
<p><strong>优化后</strong>（利用Eino的Async节点）：</p>
<pre><code class="hljs language-scss" lang="scss">解析 → <span class="hljs-selector-attr">[分块 → 向量化]</span>×N → 存储
         (并行管道)
</code></pre>
<p><strong>成果</strong>：平均处理耗时<strong>降低40%</strong></p>
<h3 data-id="heading-12">4.2 成本优化：Token管理的艺术</h3>
<p>除了Grader拦截外，我们还做了：</p>
<ol>
<li><strong>对话历史摘要</strong>：将长对话历史摘要为关键点，而非全文传递</li>
<li><strong>分块策略优化</strong>：按语义而非固定长度分块，减少冗余</li>
<li><strong>缓存层设计</strong>：高频问题答案缓存，直接返回</li>
</ol>
<h2 data-id="heading-13">五、MCP协议：打开AI生态的钥匙</h2>
<p>这是我们最自豪的设计之一。通过实现Model Context Protocol（MCP），我们将知识库封装成了标准化的AI工具。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// MCP协议配置示例</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_manufacturing_kb"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查询制造业知识库"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>这意味着</strong>：</p>
<ul>
<li>开发人员可以在Cursor中直接调用知识库</li>
<li>可以在Claude Desktop中一键查询设备资料</li>
<li>任何支持MCP的AI客户端都能接入</li>
</ul>
<p>从“又一个内部系统”变成了“AI原生基础设施”。</p>
<h2 data-id="heading-14">六、全链路监控：AI应用的可观测性</h2>
<p>AI应用不是黑盒子，我们建立了完整的监控体系：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Prometheus埋点示例</span>
<span class="hljs-keyword">var</span> (
    retrievalDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: <span class="hljs-string">"rag_retrieval_duration_seconds"</span>,
            Help: <span class="hljs-string">"检索阶段耗时分布"</span>,
        },
        []<span class="hljs-type">string</span>{<span class="hljs-string">"stage"</span>}, <span class="hljs-comment">// hybrid_search, rerank, grader</span>
    )
    
    tokenUsage = promauto.NewCounterVec(
        prometheus.HistogramOpts{
            Name: <span class="hljs-string">"rag_token_usage_total"</span>,
            Help: <span class="hljs-string">"LLM Token消耗统计"</span>,
        },
        []<span class="hljs-type">string</span>{<span class="hljs-string">"model"</span>, <span class="hljs-string">"type"</span>}, <span class="hljs-comment">// 按模型和输入/输出分别统计</span>
    )
)
</code></pre>
<p>监控看板涵盖：</p>
<ul>
<li>各阶段耗时P95/P99</li>
<li>检索成功率/失败率</li>
<li>Token消耗趋势</li>
<li>用户满意度（通过反馈按钮）</li>
</ul>
<h2 data-id="heading-15">七、业务价值与思考</h2>
<h3 data-id="heading-16">7.1 直接价值</h3>
<ul>
<li><strong>效率提升</strong>：设备故障查询从30分钟→5分钟，<strong>效率提升600%</strong></li>
<li><strong>成本节约</strong>：月均节省20%大模型调用成本</li>
<li><strong>准确率</strong>：专业问题回答准确率&gt;95%</li>
</ul>
<h3 data-id="heading-17">7.2 架构思考：什么是“企业级”RAG？</h3>
<p>通过这个项目，我们总结出企业级RAG的四个核心特征：</p>
<ol>
<li><strong>精准而非泛化</strong>：专有名词理解是生命线</li>
<li><strong>可靠而非炫技</strong>：Grader这样的安全机制必不可少</li>
<li><strong>开放而非封闭</strong>：MCP协议让能力可复用</li>
<li><strong>可控而非黑盒</strong>：全链路监控是运营基础</li>
</ol>
<h3 data-id="heading-18">7.3 给开发者的建议</h3>
<p>如果你正在规划RAG项目：</p>
<p>✅ <strong>一定要做</strong>：</p>
<ul>
<li>设计多级检索过滤机制</li>
<li>实现流式响应提升体验</li>
<li>建立成本监控体系</li>
</ul>
<p>❌ <strong>避免踩坑</strong>：</p>
<ul>
<li>不要相信“纯向量检索解决一切”</li>
<li>不要忽视低质量检索的连锁反应</li>
<li>不要只考虑准确率不考虑响应速度</li>
</ul>
<h2 data-id="heading-19">结语：AI时代的架构师思维</h2>
<p>这个项目给我最深的启示是：在AI时代，架构师的角色正在从“资源管理者”转变为“工作流设计师”。</p>
<p>我们不再只是调API，而是需要：</p>
<ol>
<li><strong>理解业务场景的独特性</strong>（制造业专有名词）</li>
<li><strong>设计复合型AI工作流</strong>（四级过滤）</li>
<li><strong>平衡效果、性能与成本</strong>（Grader机制）</li>
<li><strong>构建开放可观测的系统</strong>（MCP+监控）</li>
</ol>
<p>目前，我们已经将这套架构抽象为可复用的框架，正在帮助更多企业解决他们的知识管理难题。如果你对Go+AI构建企业级应用感兴趣，或者正在面临类似的技术挑战，欢迎交流讨论。</p>
<hr/>
<blockquote>
<p><strong>关于作者</strong>：王中阳，Go/AI全栈开发者，专注帮助开发者用AI提升研发效能与职业竞争力。持续分享Go与AI结合的企业级实战经验。</p>
</blockquote>
<hr/>
<p><strong>一些开放问题供讨论</strong>：</p>
<ol>
<li>在你的业务场景中，RAG最大的技术挑战是什么？</li>
<li>如何平衡检索精度与响应延迟？</li>
<li>你们是如何监控和管理大模型调用成本的？</li>
</ol>
<p>欢迎在评论区分享你的实践与思考！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四、Node-OPCUA 进阶(2)-OPCUA服务器(一)]]></title>    <link>https://juejin.cn/post/7586167377382064154</link>    <guid>https://juejin.cn/post/7586167377382064154</guid>    <pubDate>2025-12-22T05:09:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382064154" data-draft-id="7585920796100755483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四、Node-OPCUA 进阶(2)-OPCUA服务器(一) "/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-22T05:09:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李广山Samuel"/> <meta itemprop="url" content="https://juejin.cn/user/4266544138563288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四、Node-OPCUA 进阶(2)-OPCUA服务器(一) 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266544138563288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李广山Samuel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:09:29.000Z" title="Mon Dec 22 2025 05:09:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0"><strong>1.0 写一个简单的node-opcua服务器</strong></h5>
<p>在这个示例中，我们在默认端口上创建了一个空的OPCUA Server。  端点URL是opc.tcp://HOSTNAME:26543，其中HOSTNAME是计算机的名称。</p>
<p><strong>程序结构：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
(<span class="hljs-keyword">async</span> () =&gt; {
<span class="hljs-keyword">try</span> {
_<span class="hljs-string">"服务器代码"</span>
}
<span class="hljs-keyword">catch</span>(err) {
}
})();
</code></pre>
<p><strong>服务器代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
<span class="hljs-string">"  服务器启动成功,可以通过 url访问端点:  "</span>,
endpointUrl
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
</code></pre>
<p><strong>完整的程序代码 my_</strong><em><strong>first</strong></em>**_server.js：**</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
        <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
        <span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
            <span class="hljs-string">" 服务器启动成功,可以通过 url访问端点: "</span>,
            endpointUrl
        );
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
    }
    <span class="hljs-keyword">catch</span> (err) {
    }
})();
</code></pre>
<h5 data-id="heading-1"><strong>2.0 用Typescript创建一个opcua服务器</strong></h5>
<p>让我们添加chalk模块，它将允许我们在控制台上生成彩色信息。</p>
<pre><code class="hljs language-javascript" lang="javascript">npm install chalk
</code></pre>
<p>下面是代码，程序的框架如下:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// my_first_server_step-1_typescript.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">ServerState</span>, coerceLocalizedText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node-opcua"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> chalk <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;
(<span class="hljs-keyword">async</span> () =&gt; {
<span class="hljs-keyword">try</span> {
_<span class="hljs-string">"服务器代码"</span>
_<span class="hljs-string">"关闭管理"</span>
}
<span class="hljs-keyword">catch</span>(err) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"error"</span>, err);
process.<span class="hljs-title function_">exit</span>(-<span class="hljs-number">1</span>);
}
})();
</code></pre>
<p><strong>服务器代码</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 服务器已运行在 "</span>, endpointUrl);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
</code></pre>
<p><strong>关闭管理</strong></p>
<p>让我们添加一些代码来优雅地关闭服务器。当用户按下CTRL+C启动服务器的关闭过程时，我们将进行拦截。</p>
<pre><code class="hljs language-javascript" lang="javascript">process.<span class="hljs-title function_">on</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-function">() =&gt;</span> {
_<span class="hljs-string">"防止重新输入"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 收到来自用户的服务器中断 "</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 关闭 ..."</span>);
server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">shutdownReason</span> = <span class="hljs-title function_">coerceLocalizedText</span>(<span class="hljs-string">"被管理员关闭"</span>);
server.<span class="hljs-title function_">shutdown</span>(<span class="hljs-number">10000</span>, <span class="hljs-function">() =&gt;</span> {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 关闭结束 "</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 完成 "</span>);
process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
});
});
</code></pre>
<p><strong>防止重新输入</strong></p>
<p>用户可能重复按CTRL+C，我们不希望多次调用shutdown。我们可以通过检查服务器状态来防止这种情况。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">state</span> === <span class="hljs-title class_">ServerState</span>.<span class="hljs-property">Shutdown</span>) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
<span class="hljs-string">"服务器关闭已经请求…关闭将发生在 "</span>,
server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">secondsTillShutdown</span>,
<span class="hljs-string">"秒"</span>
);
<span class="hljs-keyword">return</span>;
}
</code></pre>
<p><strong>运行服务器</strong></p>
<p>my_first_server_step-1_typescript.ts</p>
<pre><code class="hljs language-javascript" lang="javascript">npx ts-node-script my_first_server_step-1_typescript.<span class="hljs-property">ts</span>
</code></pre>
<h5 data-id="heading-2"><strong>2.1 指定buildInfo</strong></h5>
<p>在这个示例中，我们在一个自定义端口上创建了一个空的OPCUA服务器，我们还在buildInfo中设置了一些额外的参数。</p>
<p>端点URL是opc.tcp://HOSTNAME:26543，其中HOSTNAME是计算机的名称。</p>
<p><strong>my_first_server_step2.ts</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//my_first_server_step2.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OPCUAServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node-opcua"</span>;
(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">try</span> {
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
<span class="hljs-attr">port</span>: <span class="hljs-number">26543</span>,
<span class="hljs-attr">buildInfo</span>: {
<span class="hljs-attr">manufacturerName</span>: <span class="hljs-string">"公司名"</span>,
<span class="hljs-attr">productName</span>: <span class="hljs-string">"我的第一个OPCUA服务器"</span>,
<span class="hljs-attr">softwareVersion</span>: <span class="hljs-string">"1.0.0"</span>
},
});
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>!;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 服务器已运行在 "</span>, endpointUrl);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
} <span class="hljs-keyword">catch</span> (err) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"error"</span>, err);
process.<span class="hljs-title function_">exit</span>(-<span class="hljs-number">1</span>);
}
})();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot接口防抖大作战，拒绝“手抖”重复提交！]]></title>    <link>https://juejin.cn/post/7586208617603661858</link>    <guid>https://juejin.cn/post/7586208617603661858</guid>    <pubDate>2025-12-22T04:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603661858" data-draft-id="7586482851098542120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot接口防抖大作战，拒绝“手抖”重复提交！"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T04:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot接口防抖大作战，拒绝“手抖”重复提交！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:11:51.000Z" title="Mon Dec 22 2025 04:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">一、什么是接口防抖？（又名：救救那个手抖的程序员）</h2>
<p>想象一下这个场景：用户小张在提交订单时，因为网络延迟，他以为没点中那个“提交”按钮，于是疯狂连击了10次！结果...10个一模一样的订单诞生了！</p>
<p><strong>接口防抖</strong> 就像是给按钮加上了一层“冷静期”——“兄弟，你点太快了，先冷静3秒再说！”</p>
<p><strong>防止重复提交</strong> 则是更严格的保安大哥——“同样的身份证（请求）只能进一次，想蒙混过关？没门！”</p>
<p>下面我来教你在SpringBoot中布下天罗地网，拦截这些“手抖攻击”！</p>
<hr/>
<h2 data-id="heading-1">二、实战方案大集合</h2>
<h3 data-id="heading-2">方案1：前端防抖 + 后端令牌锁（双保险）</h3>
<h4 data-id="heading-3">前端防抖代码（JavaScript版）：</h4>
<pre><code class="hljs language-ini" lang="ini">// 给按钮加个“冷静debuff”
let <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

function submitOrder() {
    if (isSubmitting) {
        alert("客官您点得太快了，喝口茶歇歇~")<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    // 提交请求...
    
    // 3秒后才能再次点击
    setTimeout(() =&gt; {
        <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }, 3000)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-4">后端令牌锁实现：</h4>
<p><strong>步骤1：创建防抖注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.METHOD)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
public <span class="hljs-variable">@interface</span> PreventDuplicateSubmit {
    <span class="hljs-comment">/**
     * 防抖时间（秒），默认3秒
     */</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">lockTime</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">/**
     * 锁的key，支持SpEL表达式
     */</span>
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span>() <span class="hljs-selector-tag">default</span> "";
    
    <span class="hljs-comment">/**
     * 提示信息
     */</span>
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">message</span>() <span class="hljs-selector-tag">default</span> "请勿重复提交";
}
</code></pre>
<p><strong>步骤2：实现AOP切面</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DuplicateSubmitAspect {
    
    <span class="hljs-variable">@Autowired</span>
    private RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-variable">@Autowired</span>
    private HttpServletRequest request;
    
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(preventDuplicateSubmit)"</span>)
    public void <span class="hljs-built_in">pointcut</span>(PreventDuplicateSubmit preventDuplicateSubmit) {
    }
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"pointcut(preventDuplicateSubmit)"</span>)
    public Object <span class="hljs-built_in">around</span>(ProceedingJoinPoint joinPoint, 
                        PreventDuplicateSubmit preventDuplicateSubmit) throws Throwable {
        
        <span class="hljs-comment">// 1. 构造锁的key</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">lockKey</span> = <span class="hljs-selector-tag">buildLockKey</span>(joinPoint, preventDuplicateSubmit);
        
        <span class="hljs-comment">// 2. 尝试加锁（setnx操作）</span>
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()
                <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, <span class="hljs-string">"LOCKED"</span>, 
                           preventDuplicateSubmit.<span class="hljs-built_in">lockTime</span>(), TimeUnit.SECONDS);
        
        <span class="hljs-selector-tag">if</span> (Boolean.TRUE.<span class="hljs-built_in">equals</span>(success)) {
            <span class="hljs-comment">// 加锁成功，执行方法</span>
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.proceed</span>();
            } <span class="hljs-selector-tag">finally</span> {
                <span class="hljs-comment">// 可以根据业务决定是否立即删除锁</span>
                <span class="hljs-comment">// redisTemplate.delete(lockKey);</span>
            }
        } else {
            <span class="hljs-comment">// 加锁失败，说明重复提交了</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(preventDuplicateSubmit.<span class="hljs-built_in">message</span>());
        }
    }
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">buildLockKey</span>(ProceedingJoinPoint joinPoint, 
                               PreventDuplicateSubmit annotation) {
        <span class="hljs-selector-tag">StringBuilder</span> <span class="hljs-selector-tag">keyBuilder</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">StringBuilder</span>(<span class="hljs-string">"SUBMIT:LOCK:"</span>);
        
        <span class="hljs-comment">// 如果有自定义key</span>
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isNotBlank</span>(annotation.<span class="hljs-built_in">key</span>())) {
            <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-built_in">parseKey</span>(joinPoint, annotation.<span class="hljs-built_in">key</span>()));
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">// 默认使用：方法名 + 用户ID + 参数hash</span>
            <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(joinPoint.<span class="hljs-built_in">getSignature</span>().<span class="hljs-built_in">toShortString</span>());
            
            <span class="hljs-comment">// 加上用户ID（如果有登录）</span>
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">userId</span> = <span class="hljs-selector-tag">getCurrentUserId</span>();
            <span class="hljs-selector-tag">if</span> (userId != null) {
                <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">":"</span>)<span class="hljs-selector-class">.append</span>(userId);
            }
            
            <span class="hljs-comment">// 加上参数摘要</span>
            <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">args</span> = <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.getArgs</span>();
            <span class="hljs-selector-tag">if</span> (args.length &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">argsHash</span> = <span class="hljs-selector-tag">DigestUtils</span><span class="hljs-selector-class">.md5DigestAsHex</span>(
                    Arrays.<span class="hljs-built_in">deepToString</span>(args).<span class="hljs-built_in">getBytes</span>()
                )<span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
                <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">":"</span>)<span class="hljs-selector-class">.append</span>(argsHash);
            }
        }
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.toString</span>();
    }
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getCurrentUserId</span>() {
        <span class="hljs-comment">// 从Token或Session中获取用户ID</span>
        <span class="hljs-comment">// 这里简化处理</span>
        <span class="hljs-selector-tag">return</span> (String) <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getSession</span>()<span class="hljs-selector-class">.getAttribute</span>(<span class="hljs-string">"userId"</span>);
    }
}
</code></pre>
<p><strong>步骤3：使用示例</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
public class OrderController {
    
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    <span class="hljs-variable">@PreventDuplicateSubmit</span>(lockTime = <span class="hljs-number">5</span>, message = <span class="hljs-string">"订单正在处理中，请勿重复提交"</span>)
    public ApiResult <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestBody</span> OrderDTO orderDTO) {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.create</span>(orderDTO);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>(<span class="hljs-string">"下单成功"</span>);
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/pay"</span>)
    @<span class="hljs-selector-tag">PreventDuplicateSubmit</span>(
        key = <span class="hljs-string">"'PAY:' + #orderNo + ':' + T(com.example.util.UserUtil).getCurrentUserId()"</span>,
        lockTime = <span class="hljs-number">10</span>,
        message = <span class="hljs-string">"支付请求已提交，请勿重复操作"</span>
    )
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ApiResult</span> <span class="hljs-selector-tag">payOrder</span>(String orderNo) {
        <span class="hljs-comment">// 支付逻辑</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>(<span class="hljs-string">"支付成功"</span>);
    }
}
</code></pre>
<h3 data-id="heading-5">方案2：数据库唯一约束（最硬核的方案）</h3>
<p>有时候，最简单的最有效！</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entity</span>
<span class="hljs-variable">@Table</span>(name = <span class="hljs-string">"orders"</span>)
public class Order {
    <span class="hljs-variable">@Id</span>
    <span class="hljs-variable">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    private Long id;
    
    <span class="hljs-comment">// 业务唯一号：时间戳 + 用户ID + 随机数</span>
    <span class="hljs-variable">@Column</span>(name = <span class="hljs-string">"order_no"</span>, unique = true, nullable = false)
    private String orderNo;
    
    <span class="hljs-comment">// 或者使用请求ID作为防重</span>
    <span class="hljs-variable">@Column</span>(name = <span class="hljs-string">"request_id"</span>, unique = true)
    private String requestId;
    
    <span class="hljs-comment">// ...其他字段</span>
}

<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class OrderService {
    
    <span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)
    public void <span class="hljs-built_in">createOrder</span>(OrderDTO dto) {
        <span class="hljs-comment">// 生成唯一请求ID（前端传递或后端生成）</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">requestId</span> = <span class="hljs-selector-tag">dto</span><span class="hljs-selector-class">.getRequestId</span>();
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isBlank</span>(requestId)) {
            <span class="hljs-selector-tag">requestId</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();
        }
        
        <span class="hljs-comment">// 检查是否已处理过该请求</span>
        <span class="hljs-selector-tag">if</span> (orderRepository.<span class="hljs-built_in">existsByRequestId</span>(requestId)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"重复请求被拦截：{}"</span>, requestId);
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"订单已提交，请勿重复操作"</span>);
        }
        
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setRequestId</span>(requestId);
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setOrderNo</span>(<span class="hljs-built_in">generateOrderNo</span>());
        <span class="hljs-comment">// ...设置其他字段</span>
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">orderRepository</span><span class="hljs-selector-class">.save</span>(order);
        } <span class="hljs-selector-tag">catch</span> (DataIntegrityViolationException e) {
            <span class="hljs-comment">// 捕获唯一约束异常</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"订单已存在，请勿重复提交"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-6">方案3：本地Guava缓存（轻量级方案）</h3>
<p>适合单机部署，简单快捷！</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalDuplicateChecker</span> {
    
    <span class="hljs-comment">// Guava缓存，3秒自动过期</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Boolean</span>&gt; submitCache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">3</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>)
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-title function_">build</span>();
    
    <span class="hljs-comment">/**
     * 检查是否重复提交
     * <span class="hljs-doctag">@param</span> key 请求唯一标识
     * <span class="hljs-doctag">@return</span> true=重复提交, false=首次提交
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDuplicate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 如果key不存在，则放入缓存并返回null</span>
            <span class="hljs-comment">// 如果key存在，则返回缓存的值</span>
            <span class="hljs-keyword">return</span> submitCache.<span class="hljs-title function_">get</span>(key, () -&gt; {
                <span class="hljs-comment">// 这个lambda只在key不存在时执行</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            });
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ExecutionException</span> e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 手动放入缓存（用于防止并发时多次通过检查）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">markAsSubmitted</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        submitCache.<span class="hljs-title function_">put</span>(key, <span class="hljs-literal">true</span>);
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalDuplicateChecker</span> duplicateChecker;
    
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/api/submit"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ApiResult</span> <span class="hljs-title function_">submitData</span>(<span class="hljs-params"><span class="hljs-meta">@RequestBody</span> SubmitData data, 
                               HttpServletRequest request</span>) {
        
        <span class="hljs-comment">// 构造唯一key：IP + 用户ID + 数据摘要</span>
        <span class="hljs-title class_">String</span> clientIp = request.<span class="hljs-title function_">getRemoteAddr</span>();
        <span class="hljs-title class_">String</span> userId = <span class="hljs-title function_">getCurrentUserId</span>();
        <span class="hljs-title class_">String</span> dataHash = <span class="hljs-title class_">DigestUtils</span>.<span class="hljs-title function_">md5DigestAsHex</span>(
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(data).<span class="hljs-title function_">getBytes</span>()
        ).<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
        
        <span class="hljs-title class_">String</span> lockKey = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"SUBMIT:%s:%s:%s"</span>, 
                                      clientIp, userId, dataHash);
        
        <span class="hljs-keyword">if</span> (duplicateChecker.<span class="hljs-title function_">isDuplicate</span>(lockKey)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">ApiResult</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }
        
        <span class="hljs-comment">// 标记为已提交</span>
        duplicateChecker.<span class="hljs-title function_">markAsSubmitted</span>(lockKey);
        
        <span class="hljs-comment">// 执行业务逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">processData</span>(data);
    }
}
</code></pre>
<h3 data-id="heading-7">方案4：Token令牌机制（最经典的方案）</h3>
<p>这个方案就像发门票，一张票只能进一个人！</p>
<p><strong>步骤1：生成Token</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenController</span> {
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/api/getToken"</span>)</span>
    <span class="hljs-keyword">public</span> ApiResult getToken() {
        String token = UUID.randomUUID().toString();
        
        <span class="hljs-comment">// 存入Redis，有效期5分钟</span>
        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(
            <span class="hljs-string">"SUBMIT_TOKEN:"</span> + token, 
            <span class="hljs-string">"VALID"</span>, 
            <span class="hljs-number">5</span>, TimeUnit.MINUTES
        );
        
        <span class="hljs-keyword">return</span> ApiResult.success(token);
    }
}
</code></pre>
<p><strong>步骤2：验证Token</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
public class TokenCheckAspect {
    
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(needTokenCheck)"</span>)
    public void <span class="hljs-built_in">pointcut</span>(NeedTokenCheck needTokenCheck) {
    }
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"pointcut(needTokenCheck)"</span>)
    public Object <span class="hljs-built_in">checkToken</span>(ProceedingJoinPoint joinPoint, 
                            NeedTokenCheck needTokenCheck) throws Throwable {
        
        <span class="hljs-selector-tag">HttpServletRequest</span> <span class="hljs-selector-tag">request</span> = ((ServletRequestAttributes) 
            RequestContextHolder.<span class="hljs-built_in">getRequestAttributes</span>())<span class="hljs-selector-class">.getRequest</span>();
        
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getHeader</span>(<span class="hljs-string">"X-Submit-Token"</span>);
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isBlank</span>(token)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"提交令牌缺失"</span>);
        }
        
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">redisKey</span> = "<span class="hljs-selector-tag">SUBMIT_TOKEN</span>:" + <span class="hljs-selector-tag">token</span>;
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span> = (String) <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.get</span>(redisKey);
        
        <span class="hljs-selector-tag">if</span> (!<span class="hljs-string">"VALID"</span>.<span class="hljs-built_in">equals</span>(value)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"无效的提交令牌"</span>);
        }
        
        <span class="hljs-comment">// 删除令牌（一次性使用）</span>
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(redisKey);
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
<p><strong>步骤3：前端配合</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 提交前先获取令牌</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitWithToken</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-comment">// 1. 获取令牌</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/getToken'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>());
    
    <span class="hljs-comment">// 2. 携带令牌提交</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/submit'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
            <span class="hljs-string">'X-Submit-Token'</span>: token
        },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    });
    
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-8">三、方案对比总结</h2>



































<table><thead><tr><th align="left">方案</th><th align="left">优点</th><th align="left">缺点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong>AOP + Redis锁</strong></td><td align="left">灵活可控，支持复杂规则</td><td align="left">依赖Redis，增加系统复杂度</td><td align="left">分布式系统，需要精细控制</td></tr><tr><td align="left"><strong>数据库唯一约束</strong></td><td align="left">绝对可靠，永不漏网</td><td align="left">对数据库有压力，需要设计唯一键</td><td align="left">核心业务（如支付、订单）</td></tr><tr><td align="left"><strong>本地缓存</strong></td><td align="left">性能极高，零延迟</td><td align="left">仅限单机，集群无效</td><td align="left">单体应用，高频但非核心接口</td></tr><tr><td align="left"><strong>Token机制</strong></td><td align="left">安全性高，前端可控</td><td align="left">需要两次请求，增加交互</td><td align="left">表单提交，需要严格防重</td></tr></tbody></table>
<h2 data-id="heading-9">四、防抖策略选择指南</h2>
<ol>
<li>
<p><strong>根据业务重要性选择</strong>：</p>
<ul>
<li>金融支付 → 数据库唯一约束 + Redis锁（双重保险）</li>
<li>普通表单 → Token机制或AOP锁</li>
<li>查询接口 → 本地缓存防抖</li>
</ul>
</li>
<li>
<p><strong>根据系统架构选择</strong>：</p>
<ul>
<li>单机应用 → 本地缓存最香</li>
<li>分布式集群 → Redis是王道</li>
<li>微服务 → 考虑分布式锁服务</li>
</ul>
</li>
<li>
<p><strong>实用小贴士</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 最佳实践：组合拳！</span>
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/important/submit"</span>)
<span class="hljs-variable">@PreventDuplicateSubmit</span>(lockTime = <span class="hljs-number">5</span>)
<span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)
public ApiResult <span class="hljs-built_in">importantSubmit</span>(<span class="hljs-variable">@RequestBody</span> <span class="hljs-variable">@Valid</span> RequestDTO dto) {
    <span class="hljs-comment">// 1. 检查请求ID是否重复</span>
    <span class="hljs-selector-tag">checkRequestId</span>(dto.<span class="hljs-built_in">getRequestId</span>());
    
    <span class="hljs-comment">// 2. 执行业务</span>
    <span class="hljs-comment">// 3. 数据库唯一约束兜底</span>
    
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>();
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">五、最后</h2>
<ol>
<li><strong>不要过度设计</strong>：简单的业务用简单的方案，杀鸡不要用牛刀</li>
<li><strong>用户体验很重要</strong>：防抖提示要友好，别让用户一脸懵逼</li>
<li><strong>监控不能少</strong>：记录被拦截的请求，分析用户行为</li>
<li><strong>前端也要防</strong>：前后端双重防护才是王道</li>
</ol>
<p>防抖的目的不是为难用户，而是<strong>保护系统和数据的安全</strong>。就像给你的接口穿上防弹衣，既能抵挡"手抖攻击"，又能让正常请求畅通无阻！</p>
<hr/>
<p><strong>程序员防抖口诀</strong>：</p>
<blockquote>
<p>前端防抖先出手，后端加锁不能少。</p>
<p>令牌机制来帮忙，唯一约束最可靠。</p>
<p>根据场景选方案，系统稳定没烦恼。</p>
<p>用户手抖不可怕，我有妙招来护驾！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e3690d4dfdb481c856f9f5bab62b72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981511&amp;x-signature=C8aouKSb1dKZyxd%2BAsuOTcK32%2Bg%3D" alt="SpringBoot接口防抖大作战，拒绝“手抖”重复提交！.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python项目部署之pytandic与.env的使用教程]]></title>    <link>https://juejin.cn/post/7586136543954944038</link>    <guid>https://juejin.cn/post/7586136543954944038</guid>    <pubDate>2025-12-22T05:14:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954944038" data-draft-id="7585897699603251226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python项目部署之pytandic与.env的使用教程"/> <meta itemprop="keywords" content="Docker,Python"/> <meta itemprop="datePublished" content="2025-12-22T05:14:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python项目部署之pytandic与.env的使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:14:17.000Z" title="Mon Dec 22 2025 05:14:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Pydantic是什么？为什么这么好用？</h2>
<p>Pydantic是一个基于Python类型提示的<strong>数据验证和设置管理工具库</strong>，它能自动检查数据类型、进行类型转换，还能从.env文件中读取环境变量，让你的配置管理变得简单又安全。</p>
<p>✨ <strong>Pydantic 2.x的优势</strong>：</p>
<ul>
<li>基于标准Python类型注解</li>
<li>自动类型转换与错误提示</li>
<li>支持嵌套模型和复杂校验</li>
<li>通过<code>pydantic-settings</code>支持环境变量</li>
<li><strong>性能提升</strong>：2.x内核部分用Rust重写，比1.x快2倍</li>
</ul>
<h2 data-id="heading-1">二、安装Pydantic和相关依赖</h2>
<pre><code class="hljs language-ini" lang="ini">Bash
编辑
1<span class="hljs-comment"># 安装Pydantic 2.x和pydantic-settings</span>
2pip install pydantic <span class="hljs-attr">pydantic-settings</span>==<span class="hljs-number">2.8</span>.<span class="hljs-number">1</span>
</code></pre>
<blockquote>
<p>💡 提示：<code>pydantic-settings</code>是Pydantic 2.x的环境管理专用包，会自动安装<code>pydantic</code>和<code>python-dotenv</code>。</p>
</blockquote>
<h2 data-id="heading-2">三、创建.env文件</h2>
<p>在项目根目录创建<code>.env</code>文件，添加你的环境变量：</p>
<pre><code class="hljs language-ini" lang="ini">Ini
编辑
1<span class="hljs-comment"># .env 文件示例</span>
<span class="hljs-attr">2DATABASE_URL</span>=postgres://user:password@localhost:<span class="hljs-number">5432</span>/mydb
<span class="hljs-attr">3API_KEY</span>=your_api_key_here
<span class="hljs-attr">4DEBUG_MODE</span>=<span class="hljs-literal">True</span>
</code></pre>
<blockquote>
<p>⚠️ 重要：记得将<code>.env</code>添加到<code>.gitignore</code>中，避免敏感信息泄露！</p>
</blockquote>
<h2 data-id="heading-3">四、使用Pydantic加载.env配置</h2>
<h3 data-id="heading-4">1. 创建配置文件</h3>
<p>在项目中创建<code>config.py</code>：</p>
<pre><code class="hljs language-ini" lang="ini">Python
编辑
1from pydantic_settings import BaseSettings, SettingsConfigDict
2
3class Settings(BaseSettings):
4    DATABASE_URL: str
5    API_KEY: str
6    DEBUG_MODE: <span class="hljs-attr">bool</span> = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 提供默认值</span>
7    
8    <span class="hljs-attr">model_config</span> = SettingsConfigDict(
9        <span class="hljs-attr">env_file</span>=<span class="hljs-string">".env"</span>,  <span class="hljs-comment"># 指定.env文件位置</span>
10        <span class="hljs-attr">env_file_encoding</span>=<span class="hljs-string">'utf-8'</span>,  <span class="hljs-comment"># 编码</span>
11        <span class="hljs-attr">extra</span>=<span class="hljs-string">'ignore'</span>  <span class="hljs-comment"># 忽略未在配置中定义的环境变量</span>
12    )
13
14<span class="hljs-comment"># 实例化配置</span>
<span class="hljs-attr">15settings</span> = Settings()
</code></pre>
<h3 data-id="heading-5">2. 在项目中使用配置</h3>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-comment"># 使用示例</span>
<span class="hljs-number">2</span><span class="hljs-keyword">def</span> connect_db():
<span class="hljs-number">3</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Connecting to <span class="hljs-subst">{settings.DATABASE_URL}</span> with debug mode: <span class="hljs-subst">{settings.DEBUG_MODE}</span>"</span>)
<span class="hljs-number">4</span>    
<span class="hljs-number">5</span><span class="hljs-comment"># 调用</span>
6connect_db()
</code></pre>
<h2 data-id="heading-6">五、在普通Python虚拟环境中使用</h2>
<h3 data-id="heading-7">1. 创建虚拟环境（venv）</h3>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 创建虚拟环境</span>
2python -m venv venv
3
4<span class="hljs-comment"># 激活虚拟环境</span>
5<span class="hljs-comment"># Windows</span>
6venv\Scripts\activate
7<span class="hljs-comment"># macOS/Linux</span>
8source venv/bin/activate
9
10<span class="hljs-comment"># 安装依赖</span>
11pip install pydantic pydantic-settings
</code></pre>
<h3 data-id="heading-8">2. 验证配置</h3>
<p>在虚拟环境中运行一个简单的测试脚本：</p>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-comment"># test_config.py</span>
<span class="hljs-number">2</span><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">3</span>
4<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Database URL: <span class="hljs-subst">{settings.DATABASE_URL}</span>"</span>)
5<span class="hljs-built_in">print</span>(<span class="hljs-string">f"API Key: <span class="hljs-subst">{settings.API_KEY}</span>"</span>)
6<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Debug Mode: <span class="hljs-subst">{settings.DEBUG_MODE}</span>"</span>)
</code></pre>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 运行测试</span>
2python test_config.py
</code></pre>
<p>如果一切正常，你会看到从<code>.env</code>中读取的配置信息。</p>
<h2 data-id="heading-9">六、在Docker中使用Pydantic和.env</h2>
<p>Docker部署时，我们通常会将.env文件作为配置的一部分，但要注意<strong>不要将.env文件添加到Docker镜像中</strong>（避免泄露敏感信息）。</p>
<h3 data-id="heading-10">1. Docker部署方案</h3>
<h4 data-id="heading-11">方案一：通过命令行参数<code>-e</code>传递环境变量</h4>
<pre><code class="hljs language-bash" lang="bash">Dockerfile
编辑
1<span class="hljs-comment"># Dockerfile</span>
2FROM python:3.10-slim
3
4WORKDIR /app
5
6<span class="hljs-comment"># 复制依赖文件</span>
7COPY requirements.txt .
8RUN pip install --no-cache-dir -r requirements.txt
9
10<span class="hljs-comment"># 复制应用代码</span>
11COPY . .
12
13<span class="hljs-comment"># 设置环境变量（推荐方式）</span>
14<span class="hljs-comment"># 通过docker run -e传递，或使用.env文件</span>
15<span class="hljs-comment"># EXPOSE 5000</span>
16CMD [<span class="hljs-string">"python"</span>, <span class="hljs-string">"app.py"</span>]
</code></pre>
<pre><code class="hljs language-ini" lang="ini">Bash
编辑
1<span class="hljs-comment"># 运行容器（通过命令行传递环境变量）</span>
2docker run -p 5000:5000 \
3  -e <span class="hljs-attr">DATABASE_URL</span>=<span class="hljs-string">"postgres://user:password@db:5432/mydb"</span> \
4  -e <span class="hljs-attr">API_KEY</span>=<span class="hljs-string">"your_api_key"</span> \
5  -e <span class="hljs-attr">DEBUG_MODE</span>=<span class="hljs-string">"True"</span> \
6  my-python-app
</code></pre>
<h4 data-id="heading-12">方案二：使用.env文件（Docker Compose推荐）</h4>
<h5 data-id="heading-13">在Docker compose中使用(env_file)</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Yaml</span>
<span class="hljs-string">编辑</span>
<span class="hljs-number">1</span><span class="hljs-comment"># docker-compose.yml</span>
<span class="hljs-attr">2version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">3services:</span>
<span class="hljs-attr">4  app:</span>
<span class="hljs-attr">5    build:</span> <span class="hljs-string">.</span>
<span class="hljs-attr">6    ports:</span>
<span class="hljs-number">7</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">"5000:5000"</span>
<span class="hljs-attr">8    env_file:</span>
<span class="hljs-number">9</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">.env</span>
</code></pre>
<blockquote>
<p>💡 提示：在<code>docker-compose.yml</code>中指定<code>env_file</code>，Docker会自动读取该文件中的环境变量。</p>
</blockquote>
<h5 data-id="heading-14">在docker中使用(--env_file)</h5>
<pre><code class="hljs language-ini" lang="ini">1<span class="hljs-comment"># 运行容器（通过命令行传递环境变量）</span>
2docker run -p 5000:5000 \
3  --env-file $(pwd)/.env.prod  \
4  -e <span class="hljs-attr">API_KEY</span>=<span class="hljs-string">"your_api_key"</span> \
5  -e <span class="hljs-attr">DEBUG_MODE</span>=<span class="hljs-string">"True"</span> \
6  my-python-app

</code></pre>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-15">2. Docker部署完整示例</h3>
<ol>
<li>创建项目结构：</li>
</ol>
<pre><code class="hljs language-Text" lang="Text">编辑
1project/
2├── app.py
3├── config.py
4├── .env
5├── requirements.txt
6└── Dockerfile
</code></pre>
<ol start="2">
<li><code>config.py</code>（已包含在前面部分）</li>
<li><code>app.py</code>：</li>
</ol>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">2</span>
<span class="hljs-number">3</span><span class="hljs-keyword">def</span> main():
<span class="hljs-number">4</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Application starting with DB: <span class="hljs-subst">{settings.DATABASE_URL}</span>"</span>)
<span class="hljs-number">5</span>    <span class="hljs-comment"># 你的应用逻辑</span>
<span class="hljs-number">6</span>
<span class="hljs-number">7</span><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
<span class="hljs-number">8</span>    main()
</code></pre>
<ol start="4">
<li><code>Dockerfile</code>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">Dockerfile
编辑
<span class="hljs-number">1</span><span class="hljs-keyword">FROM</span> python:<span class="hljs-number">3.10</span><span class="hljs-operator">-</span>slim
<span class="hljs-number">2</span>
<span class="hljs-number">3</span>WORKDIR <span class="hljs-operator">/</span>app
<span class="hljs-number">4</span>
<span class="hljs-number">5</span><span class="hljs-keyword">COPY</span> requirements.txt .
<span class="hljs-number">6</span>RUN pip install <span class="hljs-comment">--no-cache-dir -r requirements.txt</span>
<span class="hljs-number">7</span>
<span class="hljs-number">8</span><span class="hljs-keyword">COPY</span> . .
<span class="hljs-number">9</span>
<span class="hljs-number">10</span>EXPOSE <span class="hljs-number">5000</span>
<span class="hljs-number">11</span>CMD ["python", "app.py"]
</code></pre>
<ol start="5">
<li><code>requirements.txt</code>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">Text
编辑
1pydantic
<span class="hljs-attr">2pydantic-settings</span>==<span class="hljs-number">2.8</span>.<span class="hljs-number">1</span>
</code></pre>
<ol start="6">
<li>构建并运行：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 构建镜像</span>
2docker build -t my-app .
3
4<span class="hljs-comment"># 运行容器（使用.env文件）</span>
5docker run -p 5000:5000 -v $(<span class="hljs-built_in">pwd</span>)/.env:/app/.env my-app  <span class="hljs-comment"># 直接将环境变量映射到容器中，不可取</span>
</code></pre>
<blockquote>
<p>💡 重要：<code>-v $(pwd)/.env:/app/.env</code> 将本地的.env文件挂载到容器中，确保配置正确读取。</p>
</blockquote>
<h2 data-id="heading-16">七、常见问题解决</h2>
<h3 data-id="heading-17">1. 无法读取.env文件</h3>
<ul>
<li>确认文件名是<code>.env</code>（注意开头的点）</li>
<li>确认文件路径正确（在Docker中，确保.env在镜像构建上下文中）</li>
<li>检查<code>model_config</code>中<code>env_file</code>的路径</li>
</ul>
<h3 data-id="heading-18">2. 环境变量类型转换问题</h3>
<p>Pydantic会自动将环境变量转换为指定类型，但要注意：</p>
<ul>
<li><code>DEBUG_MODE</code>在.env中是<code>True</code>，在Python中会是字符串，需要在配置中指定为<code>bool</code></li>
<li>解决方法：在<code>Settings</code>类中明确指定类型，如<code>DEBUG_MODE: bool = False</code></li>
</ul>
<h3 data-id="heading-19">3. 敏感信息泄露</h3>
<ul>
<li><strong>永远不要</strong>将.env文件提交到Git</li>
<li>在Docker中，使用<code>docker secret</code>或云服务的密钥管理</li>
<li>使用<code>env_file</code>时，确保.env文件不在Git中</li>
</ul>
<h2 data-id="heading-20">八、高级技巧</h2>
<h3 data-id="heading-21">1. 多环境配置</h3>
<pre><code class="hljs language-ini" lang="ini">Python
编辑
1<span class="hljs-comment"># config.py</span>
2class Settings(BaseSettings):
3    ENVIRONMENT: <span class="hljs-attr">str</span> = <span class="hljs-string">"dev"</span>
4    
5    class Config:
6        <span class="hljs-attr">env_file</span> = f<span class="hljs-string">".env.{ENVIRONMENT}"</span>
7        <span class="hljs-attr">env_file_encoding</span> = <span class="hljs-string">'utf-8'</span>
</code></pre>
<p>然后创建<code>.env.dev</code>、<code>.env.prod</code>等文件，通过设置<code>ENVIRONMENT</code>环境变量切换。</p>
<h3 data-id="heading-22">2. 使用@env()函数（Data API Builder）</h3>
<p>如果你在使用Data API Builder，可以这样使用：</p>
<pre><code class="hljs language-perl" lang="perl">Json
编辑
<span class="hljs-number">1</span>{
<span class="hljs-number">2</span>  <span class="hljs-string">"data-source"</span>: {
<span class="hljs-number">3</span>    <span class="hljs-string">"connection-string"</span>: <span class="hljs-string">"@env('DATABASE_URL')"</span>
<span class="hljs-number">4</span>  }
<span class="hljs-number">5</span>}
</code></pre>
<h3 data-id="heading-23">3. 与FastAPI集成</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Python
编辑
1from fastapi <span class="hljs-keyword">import</span> FastAPI
2from config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">3</span>
4app = FastAPI()
<span class="hljs-number">5</span>
<span class="hljs-number">6</span><span class="hljs-meta">@app</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">"/"</span>)
7def read_root():
<span class="hljs-number">8</span>    <span class="hljs-keyword">return</span> {<span class="hljs-string">"database"</span>: settings.DATABASE_URL}
</code></pre>
<h2 data-id="heading-24">总结</h2>
<p>Pydantic + .env的组合是Python配置管理的黄金搭档！它让你的项目配置变得清晰、安全、可维护。</p>
<ul>
<li>在<strong>普通Python环境</strong>中，用venv隔离环境，用Pydantic读取.env</li>
<li>在<strong>Docker部署</strong>中，通过<code>env_file</code>或命令行传递环境变量</li>
<li>保持<code>.env</code>文件在<code>.gitignore</code>中，保护敏感信息</li>
</ul>
<h2 data-id="heading-25">九、实际使用遇到的问题汇总</h2>
<h4 data-id="heading-26">1. 带空格的字符串</h4>
<p>原本以为，带空格的值，可能需要加单引号或者双引号，以避免解析不全的问题。然而这样实际反而会出问题。
带空格的字符串不需要加单引号或者双引号，否则引号会被解析为值的一部分，且<code>pydantic</code>的值为<code>=</code>右侧的值，故不会受值中间的空格影响</p>
<pre><code class="hljs language-.env" lang=".env">a=a b  //解析为a="a b"
a="a b" //解析为a='"a b"'

</code></pre>
<h4 data-id="heading-27">2. 列表元素</h4>
<p>我的使用场景是需要传入两个字符串，且字符串的取值是固定的。
例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

</code></pre>
<pre><code class="hljs language-text" lang="text"># .env
LANG=python,java # 解析失败，未解析为列表
LANG="python","java"  # 也解析失败
LANG=["python","java"] # 可行
</code></pre>
<h4 data-id="heading-28">3. <code>.env</code>文件命名</h4>
<p>实际上，并非只可使用<code>.env</code>命名，加其他后缀也可以，比如<code>.env.test</code>，<code>.env.prod</code>等
但是必须显式声明</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env.prod"</span> <span class="hljs-comment"># 声明env文件名称</span>
</code></pre>
<pre><code class="hljs language-docker" lang="docker">docker run -p 5000:5000 \
  --env-file $(pwd)/.env.prod  \
  -e API_KEY="your_api_key" \
  -e DEBUG_MODE="True" \
  my-python-app

</code></pre>
<h4 data-id="heading-29">4. 环境变量前缀<code>env_prefix</code></h4>
<p><code>env_prefix</code>非必选项，可用不做设置，但是如果有有个环境，或者服务需要做区分时，可以设置用作区分。
<code>.env</code>中的环境变量去掉<code>env_prefix</code>后，即为配置文件中的环境变量
例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env.prod"</span> <span class="hljs-comment"># 声明env文件名称</span>
        env_prefix=test
</code></pre>
<pre><code class="hljs language-text" lang="text"># .env
TEST_LANG=["python","java"] # 可行
</code></pre>
<h4 data-id="heading-30">5. <code>.env</code>文件中变量名为对应的python配置类中的环境变量全部字母大写</h4>
<h4 data-id="heading-31">6. <code>.env</code>文件中只存放不敏感的环境变量，敏感环境变量可以使用<code>-e</code>参数在docker运行时设置</h4>
<h4 data-id="heading-32">7. <code>pydantic-settings</code>接受默认值，但是如果是必填项，则不设默认值</h4>
<h4 data-id="heading-33">8. <code>pydantic</code>支持参数类型校验，与python的类型声明用法完全一致</h4>
<h4 data-id="heading-34">9. 同一个环境变量，不同设置方式的优先顺序</h4>
<p><code>pydantic-settings</code> 完全支持为从 <code>.env</code> 文件读取的环境变量<strong>设置默认值</strong>，但<strong>仅在未找到环境变量时才会使用这些默认值</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43499921%2Farticle%2Fdetails%2F153728040" target="_blank" title="https://blog.csdn.net/qq_43499921/article/details/153728040" ref="nofollow noopener noreferrer">-1</a><a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_41783424%2Farticle%2Fdetails%2F149642013" target="_blank" title="https://blog.csdn.net/weixin_41783424/article/details/149642013" ref="nofollow noopener noreferrer">-10</a>。</p>
<p>理解其工作原理和最佳实践至关重要，这能帮你构建健壮的配置系统。</p>
<h3 data-id="heading-35">⚙️ 默认值的工作原理与优先级</h3>
<p><code>pydantic-settings</code> 的配置加载遵循一个固定的优先级顺序。核心原则是：<strong>优先级高的来源会覆盖优先级低的来源</strong>。</p>
<p>其四层加载优先级如下（从高到低）：</p>



































<table><thead><tr><th>优先级</th><th>配置来源</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>1. 最高</strong></td><td><strong>初始化参数</strong></td><td>实例化模型时直接传入的值。</td><td><code>Settings(api_key="直接传入的值")</code></td></tr><tr><td><strong>2. 次高</strong></td><td><strong>系统环境变量</strong></td><td>操作系统中的环境变量。</td><td>在终端设置 <code>export APP_API_KEY=env_value</code></td></tr><tr><td><strong>3. 中</strong></td><td><strong><code>.env</code> 文件变量</strong></td><td>项目目录下的 <code>.env</code> 文件中定义的值<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43499921%2Farticle%2Fdetails%2F153728040" target="_blank" title="https://blog.csdn.net/qq_43499921/article/details/153728040" ref="nofollow noopener noreferrer">-1</a><a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a>。</td><td>在 <code>.env</code> 中写 <code>APP_API_KEY=dotenv_value</code></td></tr><tr><td><strong>4. 最低</strong></td><td><strong>模型字段默认值</strong></td><td>在 <code>Settings</code> 类中为字段定义的默认值。</td><td><code>api_key: str = “default_value”</code></td></tr></tbody></table>
<h3 data-id="heading-36">📝 如何设置默认值</h3>
<p>设置默认值非常简单，主要有以下两种方式：</p>
<ol>
<li>
<p><strong>直接赋值</strong>：这是最直接的方法，在字段类型注解后直接赋值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    database_host: <span class="hljs-built_in">str</span> = <span class="hljs-string">"localhost"</span>  <span class="hljs-comment"># 默认值</span>
    api_key: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 没有默认值，必须从环境变量或.env文件提供</span>
    port: <span class="hljs-built_in">int</span> = <span class="hljs-number">8000</span>  <span class="hljs-comment"># 默认值，并自动完成类型转换</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>Field</code> 函数</strong>：当需要更复杂的配置（如设置别名、添加描述）时，可以使用 <code>Field</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> Field

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    db_host: <span class="hljs-built_in">str</span> = Field(
        default=<span class="hljs-string">"127.0.0.1"</span>,  <span class="hljs-comment"># 默认值</span>
        validation_alias=<span class="hljs-string">"DB_HOST"</span>  <span class="hljs-comment"># 指定从 DB_HOST 环境变量读取</span>
    )
</code></pre>
</li>
</ol>
<h3 data-id="heading-37">✅ 是否建议设置默认值？分情况讨论</h3>
<p>这取决于配置项的性质和项目的运行环境。</p>
<h4 data-id="heading-38"><strong>建议设置默认值的情况</strong></h4>
<ul>
<li><strong>本地开发/测试环境</strong>：为非敏感配置（如数据库端口、日志级别）设置本地默认值，可以简化开发流程。</li>
<li><strong>非关键且有合理后备值的配置</strong>：例如，应用名称、超时时间、可选功能的开关。</li>
<li><strong>提供清晰的配置示例</strong>：默认值可以作为一种配置格式的文档，让其他开发者快速理解。</li>
</ul>
<h4 data-id="heading-39"><strong>不建议设置默认值（或应设置为空值）的情况</strong></h4>
<ul>
<li><strong>敏感信息</strong>：<strong>绝对不要</strong>为 <code>API密钥</code>、<code>数据库密码</code>、<code>加密盐</code> 等敏感信息设置硬编码的默认值，尤其是生产环境的。应强制从外部环境变量或保密管理服务加载<a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a>。</li>
<li><strong>环境差异性大的配置</strong>：如数据库连接字符串，在不同环境（开发、测试、生产）中必然不同，应由环境变量或 <code>.env</code> 文件明确指定。</li>
<li><strong>防止本地配置泄漏到生产环境</strong>：如果本地开发使用了带默认值的配置，可能会无意中让生产环境应用运行在不正确的配置下。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[享元模式深度解析：看Java如何优雅节省内存]]></title>    <link>https://juejin.cn/post/7585897699603759130</link>    <guid>https://juejin.cn/post/7585897699603759130</guid>    <pubDate>2025-12-22T04:34:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603759130" data-draft-id="7586136543954829350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="享元模式深度解析：看Java如何优雅节省内存"/> <meta itemprop="keywords" content="设计模式,Java"/> <meta itemprop="datePublished" content="2025-12-22T04:34:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            享元模式深度解析：看Java如何优雅节省内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:34:41.000Z" title="Mon Dec 22 2025 04:34:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">享元模式深度解析：从原理到实战，看Java如何优雅节省内存</h2>
<h3 data-id="heading-1">前言</h3>
<p>在当今互联网高并发场景下，系统性能优化已成为每个开发者必须面对的挑战。你是否遇到过这样的问题：创建大量相似对象导致内存暴涨？频繁创建销毁对象引发GC频繁？今天，我们将深入探讨一个经典而强大的设计模式——<strong>享元模式（Flyweight Pattern）</strong> ，看它如何在JDK源码、各大开源框架中大显身手，帮助我们优雅地解决这些难题。</p>
<h3 data-id="heading-2">一、什么是享元模式？</h3>
<h3 data-id="heading-3">1.1 核心概念</h3>
<p>享元模式是一种结构型设计模式，其核心思想是：<strong>通过共享技术有效支持大量细粒度对象的复用</strong>。简单来说，就是将对象的状态分为<strong>内部状态</strong>和<strong>外部状态</strong>：</p>
<pre><code class="hljs">内部状态（Intrinsic State）：存储在享元对象内部，不会随环境改变而改变，可以共享
外部状态（Extrinsic State）：随环境改变而改变，不可共享，由客户端保存并在需要时传入
</code></pre>
<h3 data-id="heading-4">1.2 适用场景</h3>
<p>享元模式特别适合以下场景：</p>
<pre><code class="hljs">系统中存在大量相似对象，这些对象占用大量内存
对象的大部分状态可以外部化，可以将这些外部状态传入对象中
使用享元模式需要维护一个享元池，且这种额外开销能被节省的内存抵消
需要缓冲池的场景，如数据库连接池、线程池等
</code></pre>
<h3 data-id="heading-5">1.3 模式结构</h3>
<p>享元模式主要包含以下角色：</p>
<pre><code class="hljs">Flyweight（抽象享元）：定义享元对象的接口，通过该接口可以接受并作用于外部状态
ConcreteFlyweight（具体享元）：实现抽象享元接口，为内部状态增加存储空间
UnsharedConcreteFlyweight（非共享享元）：不需要共享的享元子类
FlyweightFactory（享元工厂）：负责创建和管理享元对象，确保合理地共享享元
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a20cbb78272e43cc9293607352d9c9cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=7chF3afsEN5denCH51ZGD106uAU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">二、经典案例：五子棋游戏中的棋子管理</h3>
<h3 data-id="heading-7">2.1 问题场景</h3>
<p>想象一个五子棋游戏，棋盘有15×15=225个位置，每个位置可能放置黑棋或白棋。如果为每个棋子都创建一个对象，内存消耗巨大。但实际上，所有黑棋的颜色、形状都相同，只有位置不同。</p>
<h3 data-id="heading-8">2.2 代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 抽象享元：棋子接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChessPiece</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>;
}

<span class="hljs-comment">// 具体享元：具体棋子</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteChessPiece</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChessPiece</span> {
    <span class="hljs-keyword">private</span> String color; <span class="hljs-comment">// 内部状态：颜色</span>
    <span class="hljs-keyword">private</span> String shape; <span class="hljs-comment">// 内部状态：形状</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcreteChessPiece</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-built_in">this</span>.color = color;
        <span class="hljs-built_in">this</span>.shape = <span class="hljs-string">"圆形"</span>;
        System.out.println(<span class="hljs-string">"创建了一个"</span> + color + <span class="hljs-string">"棋子对象"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        System.out.println(<span class="hljs-string">"在位置["</span> + x + <span class="hljs-string">","</span> + y + <span class="hljs-string">"]放置"</span> + color + shape + <span class="hljs-string">"棋子"</span>);
    }
}

<span class="hljs-comment">// 享元工厂</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChessPieceFactory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, ChessPiece&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ChessPiece <span class="hljs-title function_">getChessPiece</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">piece</span> <span class="hljs-operator">=</span> pool.get(color);
        <span class="hljs-keyword">if</span> (piece == <span class="hljs-literal">null</span>) {
            piece = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteChessPiece</span>(color);
            pool.put(color, piece);
        }
        <span class="hljs-keyword">return</span> piece;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTotalPieces</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> pool.size();
    }
}

<span class="hljs-comment">// 客户端测试</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChessGame</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 放置10个棋子</span>
        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">black1</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"黑色"</span>);
        black1.display(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">white1</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"白色"</span>);
        white1.display(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">black2</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"黑色"</span>);
        black2.display(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">white2</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"白色"</span>);
        white2.display(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);

        System.out.println(<span class="hljs-string">"\n实际创建的棋子对象数量："</span> + ChessPieceFactory.getTotalPieces());
        System.out.println(<span class="hljs-string">"black1 == black2: "</span> + (black1 == black2)); <span class="hljs-comment">// true</span>
    }
}
</code></pre>
<p><strong>输出结果：</strong></p>
<pre><code class="hljs language-ini" lang="ini">创建了一个黑色棋子对象
在位置<span class="hljs-section">[1,1]</span>放置黑色圆形棋子
创建了一个白色棋子对象
在位置<span class="hljs-section">[1,2]</span>放置白色圆形棋子
在位置<span class="hljs-section">[2,1]</span>放置黑色圆形棋子
在位置<span class="hljs-section">[2,2]</span>放置白色圆形棋子

实际创建的棋子对象数量：2
<span class="hljs-attr">black1</span> == black2: <span class="hljs-literal">true</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59fe6ad78a04b78a1c07503c8d5437a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=oi2U%2FwyOkO2Wl4WVl4nhfUFQW4M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">三、JDK中的享元模式应用</h3>
<h3 data-id="heading-10">3.1 String常量池</h3>
<p>Java的String常量池是享元模式的典型应用。当我们使用字符串字面量时，JVM会自动将其放入常量池中实现共享。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 字符串字面量，存储在常量池中</span>
        <span class="hljs-title class_">String</span> s1 = <span class="hljs-string">"Hello"</span>;
        <span class="hljs-title class_">String</span> s2 = <span class="hljs-string">"Hello"</span>;
        <span class="hljs-title class_">String</span> s3 = <span class="hljs-string">"Hello"</span>;

        <span class="hljs-comment">// 使用new关键字，创建新对象</span>
        <span class="hljs-title class_">String</span> s4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"Hello"</span>);

        <span class="hljs-comment">// 手动调用intern()，将字符串加入常量池</span>
        <span class="hljs-title class_">String</span> s5 = s4.<span class="hljs-title function_">intern</span>();

        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s2: "</span> + (s1 == s2)); <span class="hljs-comment">// true</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s3: "</span> + (s1 == s3)); <span class="hljs-comment">// true</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s4: "</span> + (s1 == s4)); <span class="hljs-comment">// false</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s5: "</span> + (s1 == s5)); <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// 查看对象地址</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"\n对象地址："</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s1));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s2: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s2));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s4: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s4));
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c055edc8ad52479882fd5bb81fe75981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=4brV0LmrTSFeED6R0X9gwpRIHXs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">四、生产级应用：数据库连接池</h3>
<h3 data-id="heading-12">4.1 为什么需要连接池？</h3>
<p>数据库连接是一种重量级资源，创建和销毁连接的开销非常大：</p>
<ul>
<li>TCP三次握手建立连接：耗时10-50ms</li>
<li>数据库认证过程：耗时5-20ms</li>
<li>资源分配（内存、文件描述符等）
如果每次数据库操作都创建新连接，在高并发场景下系统性能将严重下降。</li>
</ul>
<h3 data-id="heading-13">4.2 简化版连接池实现</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 数据库连接（享元对象）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span> {
    <span class="hljs-keyword">private</span> String connectionId;
    <span class="hljs-keyword">private</span> boolean inUse;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DatabaseConnection</span>(<span class="hljs-params">String id</span>)</span> {
        <span class="hljs-keyword">this</span>.connectionId = id;
        <span class="hljs-keyword">this</span>.inUse = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 模拟创建连接的耗时操作</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建数据库连接："</span> + id);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeQuery</span>(<span class="hljs-params">String sql</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"["</span> + connectionId + <span class="hljs-string">"] 执行SQL: "</span> + sql);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">isInUse</span>()</span> {
        <span class="hljs-keyword">return</span> inUse;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setInUse</span>(<span class="hljs-params">boolean inUse</span>)</span> {
        <span class="hljs-keyword">this</span>.inUse = inUse;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getConnectionId</span>()</span> {
        <span class="hljs-keyword">return</span> connectionId;
    }
}

<span class="hljs-comment">// 连接池工厂（享元工厂）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-built_in">int</span> POOL_SIZE = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> List&lt;DatabaseConnection&gt; connections = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConnectionPool</span>()</span> {
        <span class="hljs-comment">// 初始化连接池</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {
            connections.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> DatabaseConnection(<span class="hljs-string">"CONN-"</span> + (i + <span class="hljs-number">1</span>)));
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized DatabaseConnection <span class="hljs-title">getConnection</span>()</span> {
        <span class="hljs-keyword">for</span> (DatabaseConnection conn : connections) {
            <span class="hljs-keyword">if</span> (!conn.isInUse()) {
                conn.setInUse(<span class="hljs-literal">true</span>);
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从连接池获取连接："</span> + conn.getConnectionId());
                <span class="hljs-keyword">return</span> conn;
            }
        }
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"连接池已满，等待中..."</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">releaseConnection</span>(<span class="hljs-params">DatabaseConnection conn</span>)</span> {
        conn.setInUse(<span class="hljs-literal">false</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"释放连接回连接池："</span> + conn.getConnectionId());
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getAvailableCount</span>()</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">int</span>) connections.stream().filter(c -&gt; !c.isInUse()).count();
    }
}

<span class="hljs-comment">// 测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionPoolTest</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-built_in">long</span> startTime = System.currentTimeMillis();

        ConnectionPool pool = <span class="hljs-keyword">new</span> ConnectionPool();
        <span class="hljs-built_in">long</span> initTime = System.currentTimeMillis() - startTime;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"连接池初始化耗时："</span> + initTime + <span class="hljs-string">"ms\n"</span>);

        <span class="hljs-comment">// 模拟10次数据库操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            DatabaseConnection conn = pool.getConnection();
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                conn.executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = "</span> + i);
                pool.releaseConnection(conn);
            }
        }

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n可用连接数："</span> + pool.getAvailableCount());
    }
}
</code></pre>
<h3 data-id="heading-14">4.3 对比：使用vs不使用连接池</h3>



































<table><thead><tr><th>指标</th><th>不使用连接池</th><th>使用连接池</th><th>性能提升</th></tr></thead><tbody><tr><td>每次操作耗时</td><td>~150ms</td><td>~5ms</td><td>30倍</td></tr><tr><td>1000次操作总耗时</td><td>~150秒</td><td>~5秒</td><td>30倍</td></tr><tr><td>内存占用</td><td>不稳定（频繁GC）</td><td>稳定</td><td>减少70%</td></tr><tr><td>并发能力</td><td>低</td><td>高</td><td>提升80%</td></tr></tbody></table>
<h3 data-id="heading-15"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac4bbe7708d4878913fc615075708be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=TYSuS6K9T5gPJoLREzo0QKzShm4%3D" alt="" loading="lazy"/></h3>
<h3 data-id="heading-16">五、开源框架中的享元模式</h3>
<h3 data-id="heading-17">5.1 Apache Commons Pool</h3>
<p>Apache Commons Pool是一个通用的对象池化框架，广泛应用于各种池化场景。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.apache.commons.pool2.BasePooledObjectFactory;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.PooledObject;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.DefaultPooledObject;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.GenericObjectPool;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.GenericObjectPoolConfig;

<span class="hljs-comment">// 定义可池化的对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpensiveObject</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> id;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ExpensiveObject</span><span class="hljs-params">(<span class="hljs-type">String</span> id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-comment">// 模拟耗时的创建过程</span>
        <span class="hljs-keyword">try</span> {
            Thread.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">50</span>);
        } <span class="hljs-built_in">catch</span> (InterruptedException e) {
            e.<span class="hljs-built_in">printStackTrace</span>();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">doWork</span><span class="hljs-params">(<span class="hljs-type">String</span> task)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"["</span> + id + <span class="hljs-string">"] 执行任务: "</span> + task);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }
}

<span class="hljs-comment">// 对象工厂</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpensiveObjectFactory</span> extends BasePooledObjectFactory&lt;ExpensiveObject&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ExpensiveObject</span>(<span class="hljs-string">"OBJ-"</span> + (++counter));
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> PooledObject&lt;ExpensiveObject&gt; <span class="hljs-title">wrap</span><span class="hljs-params">(ExpensiveObject obj)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultPooledObject&lt;&gt;(obj);
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">destroyObject</span><span class="hljs-params">(PooledObject&lt;ExpensiveObject&gt; p)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"销毁对象: "</span> + p.<span class="hljs-built_in">getObject</span>().<span class="hljs-built_in">getId</span>());
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsPoolExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> throws Exception </span>{
        <span class="hljs-comment">// 配置对象池</span>
        GenericObjectPoolConfig&lt;ExpensiveObject&gt; config = <span class="hljs-keyword">new</span> GenericObjectPoolConfig&lt;&gt;();
        config.<span class="hljs-built_in">setMaxTotal</span>(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 最大对象数</span>
        config.<span class="hljs-built_in">setMaxIdle</span>(<span class="hljs-number">3</span>);   <span class="hljs-comment">// 最大空闲对象数</span>
        config.<span class="hljs-built_in">setMinIdle</span>(<span class="hljs-number">1</span>);   <span class="hljs-comment">// 最小空闲对象数</span>

        <span class="hljs-comment">// 创建对象池</span>
        GenericObjectPool&lt;ExpensiveObject&gt; pool =
            <span class="hljs-keyword">new</span> GenericObjectPool&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ExpensiveObjectFactory</span>(), config);

        <span class="hljs-comment">// 使用对象池</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            ExpensiveObject obj = pool.<span class="hljs-built_in">borrowObject</span>();
            obj.<span class="hljs-built_in">doWork</span>(<span class="hljs-string">"任务-"</span> + i);
            pool.<span class="hljs-built_in">returnObject</span>(obj);
        }

        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n池化统计："</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"创建对象数："</span> + pool.<span class="hljs-built_in">getCreatedCount</span>());
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"当前活跃对象数："</span> + pool.<span class="hljs-built_in">getNumActive</span>());
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"当前空闲对象数："</span> + pool.<span class="hljs-built_in">getNumIdle</span>());

        pool.<span class="hljs-built_in">close</span>();
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 线程池（ThreadPoolExecutor）</h3>
<p>Java的线程池也是享元模式的典型应用，通过复用线程避免频繁创建销毁的开销。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建固定大小的线程池</span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);

        <span class="hljs-comment">// 提交10个任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;
            executor.submit(() -&gt; {
                System.out.println(<span class="hljs-string">"任务 "</span> + taskId +
                    <span class="hljs-string">" 由线程 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 执行"</span>);
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
            });
        }

        executor.shutdown();
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a82e3cfb3a0f4c7a847225bdccddca48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=qWbgkFrYEXCg7Bk8t7cj%2FcvhhJs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">六、享元模式的优缺点</h3>
<h3 data-id="heading-20">6.1 优点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  大幅减少对象创建数量，降低内存占用
<span class="hljs-bullet">2.</span>  提高系统性能，避免频繁GC
<span class="hljs-bullet">3.</span>  提高对象复用率，减少创建销毁开销
<span class="hljs-bullet">4.</span>  外部状态独立，不会影响内部状态
</code></pre>
<h3 data-id="heading-21">6.2 缺点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  增加系统复杂度，需要分离内部和外部状态
<span class="hljs-bullet">2.</span>  读取外部状态的开销，可能抵消部分性能提升
<span class="hljs-bullet">3.</span>  线程安全问题，共享对象需要考虑并发访问
<span class="hljs-bullet">4.</span>  不适合状态经常变化的对象
</code></pre>
<h3 data-id="heading-22">七、最佳实践</h3>
<h3 data-id="heading-23">7.1 何时使用享元模式？</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  对象数量巨大：系统中存在大量相似对象
<span class="hljs-bullet">2.</span>  内存压力大：对象占用内存导致频繁GC
<span class="hljs-bullet">3.</span>  对象可共享：大部分状态可以外部化
<span class="hljs-bullet">4.</span>  创建开销大：对象创建消耗大量资源
</code></pre>
<h3 data-id="heading-24">7.2 实现要点</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlyweightBestPractice</span> {
    <span class="hljs-comment">// 1. 使用线程安全的容器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; pool =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 2. 使用双重检查锁确保线程安全</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getFlyweight</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-title class_">Object</span> obj = pool.<span class="hljs-title function_">get</span>(key);
        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) {
            synchronized (pool) {
                obj = pool.<span class="hljs-title function_">get</span>(key);
                <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) {
                    obj = <span class="hljs-title function_">createObject</span>(key);
                    pool.<span class="hljs-title function_">put</span>(key, obj);
                }
            }
        }
        <span class="hljs-keyword">return</span> obj;
    }

    <span class="hljs-comment">// 3. 设置池的大小上限</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final int <span class="hljs-variable constant_">MAX_POOL_SIZE</span> = <span class="hljs-number">100</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getFlyweightWithLimit</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">if</span> (pool.<span class="hljs-title function_">size</span>() &gt;= <span class="hljs-variable constant_">MAX_POOL_SIZE</span>) {
            <span class="hljs-comment">// 可以使用LRU策略移除最少使用的对象</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">createObject</span>(key);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getFlyweight</span>(key);
    }

    <span class="hljs-comment">// 4. 提供清理机制</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
        pool.<span class="hljs-title function_">clear</span>();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">createObject</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    }
}
</code></pre>
<h3 data-id="heading-25">7.3 与其他模式的协作</h3>
<pre><code class="hljs">与工厂模式结合：享元工厂负责创建和管理享元对象
与单例模式结合：享元工厂通常设计为单例
与状态模式结合：享元对象的状态变化可以用状态模式管理
与组合模式结合：可以将享元对象组合成更复杂的结构
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a4512e088642e8aa1ac42d3c74a3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=CHdtcG2qBLctpmHNirdW%2FmkWgU4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">八、性能对比</h3>
<h3 data-id="heading-27">8.1 内存对比测试</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MemoryComparisonTest</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HeavyObject</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 1KB</span>
        <span class="hljs-keyword">private</span> String type;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HeavyObject</span>(<span class="hljs-params">String type</span>)</span> {
            <span class="hljs-keyword">this</span>.type = type;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        Runtime runtime = Runtime.getRuntime();

        <span class="hljs-comment">// 测试1：不使用享元模式</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 不使用享元模式 ==="</span>);
        <span class="hljs-built_in">long</span> memBefore1 = runtime.totalMemory() - runtime.freeMemory();

        List&lt;HeavyObject&gt; list1 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            list1.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> HeavyObject(i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span> ? <span class="hljs-string">"TypeA"</span> : <span class="hljs-string">"TypeB"</span>));
        }

        <span class="hljs-built_in">long</span> memAfter1 = runtime.totalMemory() - runtime.freeMemory();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建对象数：10000"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"内存占用："</span> + (memAfter1 - memBefore1) / <span class="hljs-number">1024</span> + <span class="hljs-string">" KB\n"</span>);

        <span class="hljs-comment">// 测试2：使用享元模式</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 使用享元模式 ==="</span>);
        Map&lt;String, HeavyObject&gt; pool = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        pool.put(<span class="hljs-string">"TypeA"</span>, <span class="hljs-keyword">new</span> HeavyObject(<span class="hljs-string">"TypeA"</span>));
        pool.put(<span class="hljs-string">"TypeB"</span>, <span class="hljs-keyword">new</span> HeavyObject(<span class="hljs-string">"TypeB"</span>));

        <span class="hljs-built_in">long</span> memBefore2 = runtime.totalMemory() - runtime.freeMemory();

        List&lt;HeavyObject&gt; list2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            String type = i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span> ? <span class="hljs-string">"TypeA"</span> : <span class="hljs-string">"TypeB"</span>;
            list2.<span class="hljs-keyword">add</span>(pool.<span class="hljs-keyword">get</span>(type));
        }

        <span class="hljs-built_in">long</span> memAfter2 = runtime.totalMemory() - runtime.freeMemory();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建对象数：2"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"内存占用："</span> + (memAfter2 - memBefore2) / <span class="hljs-number">1024</span> + <span class="hljs-string">" KB"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n内存节省："</span> +
            ((memAfter1 - memBefore1 - (memAfter2 - memBefore2)) * <span class="hljs-number">100</span> /
            (memAfter1 - memBefore1)) + <span class="hljs-string">"%"</span>);
    }
}
</code></pre>
<h3 data-id="heading-28">九、总结</h3>
<p>享元模式是一个强大的性能优化工具，通过对象共享实现内存和性能的双重优化。在实际开发中，我们已经在使用它：</p>
<ol>
<li><strong>JDK自带</strong>：String常量池、包装类缓存池</li>
<li><strong>数据库领域</strong>：连接池（HikariCP、Druid）</li>
<li><strong>并发编程</strong>：线程池（ThreadPoolExecutor）</li>
<li><strong>缓存框架</strong>：Redis连接池、对象池。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[006_prompt]]></title>    <link>https://juejin.cn/post/7585969437032792106</link>    <guid>https://juejin.cn/post/7585969437032792106</guid>    <pubDate>2025-12-22T05:20:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585969437032792106" data-draft-id="7586481379589816339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="006_prompt"/> <meta itemprop="keywords" content="后端,OpenAI"/> <meta itemprop="datePublished" content="2025-12-22T05:20:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="游浪踏"/> <meta itemprop="url" content="https://juejin.cn/user/4103803477695373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            006_prompt
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4103803477695373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    游浪踏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:20:29.000Z" title="Mon Dec 22 2025 05:20:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">prompt 是什么</h2>
<p><strong>提示词</strong>的核心价值是<strong>标准化大模型的输入指令</strong></p>
<ul>
<li>通过自然语言或结构化语言（如 JSON、XML）告诉模型 “要做什么、输入是什么、输出格式是什么”。</li>
<li>例如：<code>“请将以下文本翻译成英文，输入：‘你好世界’，输出格式为纯英文句子”</code>。</li>
<li>使用者和大模型只要遵守提示词的约定，就能减少模型的 “幻觉”，得到预期结果。</li>
</ul>
<h2 data-id="heading-1">prompt 提示词类型</h2>
<p>提示词消息分成了多种角色。每个消息都被分配了特定的角色。 这些角色负责对信息进行分类，明确提示中每个部分的上下文和目的，供AI模型使用。 这种结构化的方法增强了与AI沟通的细腻度和有效性，因为提示的每个部分在互动中都扮演着独特且明确的角色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306a56bcade447399df99bf6db89f0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ri45rWq6LiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766985628&amp;x-signature=0nLdRejBMg%2F%2FkxTZJauZSJwAlUI%3D" alt="image.png" loading="lazy"/></p>
<p>主要职责包括：</p>
<ul>
<li>系统角色：指导AI的行为和响应风格，设定AI如何解释和响应输入的参数或规则。这就像在发起对话前先给AI提供指令。</li>
<li>用户角色：代表用户的输入——他们对AI的问题、命令或陈述。这一角色至关重要，因为它构成了人工智能应对的基础。</li>
<li>助理角色：AI对用户输入的回应。 这不仅仅是一个回答或反应，更对于保持对话的流畅性至关重要。 通过追踪AI之前的回复（其“助理角色”消息），系统确保互动连贯且符合上下文。 助手消息也可能包含功能工具调用请求信息。 它就像AI中的一个特殊功能，用于执行特定功能，比如计算、获取数据或其他不仅仅是说话的任务。</li>
<li>工具/功能角色：工具/功能角色专注于回复工具呼叫助手消息时返回更多信息。</li>
</ul>
<h4 data-id="heading-2">1. <code>SYSTEM</code>（系统角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：定义大模型的<strong>行为准则、角色定位、能力边界和全局约束</strong>，相当于给模型设定 “工作手册”，贯穿整个对话流程。</p>
</li>
<li>
<p><strong>特点</strong>：优先级较高，会影响模型后续所有回复的风格、逻辑和范围，通常在对话开头传入，无需频繁修改。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 系统消息：定义模型为Java技术助手，指定回答约束</span>
<span class="hljs-type">SystemMessage</span> <span class="hljs-variable">systemMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"你是一名资深Java开发顾问，回答需简洁专业，仅围绕技术问题，不涉及无关内容"</span>);
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">2. <code>USER</code>（用户角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：代表<strong>用户的输入、问题、指令或需求</strong>，是触发模型回复的核心消息类型。</p>
</li>
<li>
<p><strong>特点</strong>：在多轮对话中可多次出现，每一条用户消息通常对应一条助手回复，携带用户的具体诉求。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户消息：提出具体技术问题</span>
<span class="hljs-type">UserMessage</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(<span class="hljs-string">"请解释Spring AI中PromptTemplate的作用"</span>);
</code></pre>
</li>
</ul>
<h4 data-id="heading-4">3. <code>ASSISTANT</code>（助手角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：代表<strong>大模型返回的回答、生成结果或反馈</strong>，主要用于<strong>携带对话上下文</strong>，让模型记住之前的交互内容，实现多轮连贯对话。</p>
</li>
<li>
<p><strong>特点</strong>：通常由模型生成后存储，在后续对话中随用户新消息一起传入，供模型参考历史交互。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 助手消息：模拟模型之前的回复（作为上下文）</span>
<span class="hljs-type">AssistantMessage</span> <span class="hljs-variable">assistantMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(<span class="hljs-string">"PromptTemplate用于封装可复用的提示词模板，通过占位符填充参数，提升
</span></code></pre>
</li>
</ul>
<h4 data-id="heading-5">4. <code>FUNCTION</code> / <code>TOOL</code>（函数 / 工具角色，两者功能一致，命名略有差异）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：有两个核心场景：</p>
<ol>
<li>模型向外部系统<strong>发送工具调用请求</strong>：携带函数名称、参数等结构化信息，告知应用程序需要调用哪个工具完成任务。</li>
<li>外部系统向模型<strong>返回工具调用结果</strong>：将工具执行后的返回数据传递给模型，供模型基于该结果生成最终回复。</li>
</ol>
</li>
<li>
<p><strong>特点</strong>：需要配合结构化参数传递，是实现 “AI + 工具” 能力的关键角色（Spring AI 中常用<code>FunctionMessage</code>实现）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 模型发送工具调用请求（函数角色：指定要调用的天气查询工具及参数）</span>
Map&lt;String, Object&gt; funcParams = Map.of(<span class="hljs-string">"city"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"date"</span>, <span class="hljs-string">"2025-12-22"</span>);
<span class="hljs-type">FunctionMessage</span> <span class="hljs-variable">funcCallMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctionMessage</span>(<span class="hljs-string">"get_weather_info"</span>, funcParams);

<span class="hljs-comment">// 2. 外部工具执行后，返回结果给模型（同样用FunctionMessage承载）</span>
<span class="hljs-type">FunctionMessage</span> <span class="hljs-variable">funcResultMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctionMessage</span>(<span class="hljs-string">"get_weather_info"</span>, Map.of(<span class="hljs-string">"temperature"</span>, <span class="hljs-string">"10℃"</span>, <span class="hljs-string">"weather"</span>, <span class="hljs-string">"多云"</span>));
</code></pre>
</li>
</ul>
<h4 data-id="heading-6">补充：<code>TOOL_CALL</code>（工具调用请求）与<code>TOOL_RESULT</code>（工具调用结果）</h4>
<p>部分大模型适配场景中，Spring AI 会细分这两个角色，职责更明确：</p>
<ul>
<li><code>TOOL_CALL</code>：仅用于模型发起工具调用请求，不承载结果。</li>
<li><code>TOOL_RESULT</code>：仅用于返回工具执行结果，与<code>TOOL_CALL</code>一一对应，结构更清晰。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot+Spring AI 构建企业知识库]]></title>    <link>https://juejin.cn/post/7586157459972374580</link>    <guid>https://juejin.cn/post/7586157459972374580</guid>    <pubDate>2025-12-22T05:21:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972374580" data-draft-id="7586482851098787880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot+Spring AI 构建企业知识库"/> <meta itemprop="keywords" content="OpenAI"/> <meta itemprop="datePublished" content="2025-12-22T05:21:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户90832460273"/> <meta itemprop="url" content="https://juejin.cn/user/307518986530984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot+Spring AI 构建企业知识库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518986530984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户90832460273
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:21:38.000Z" title="Mon Dec 22 2025 05:21:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在之前的文章中我们使用 SpringBoot 配合 DeepSeek 构建了一个拥有聊天记忆的问答机器人，如果没有看过的可以翻下我之前的帖子。这次构建企业知识库将基于之前的内容来添砖加瓦。</p>
<h2 data-id="heading-1">构建知识库</h2>
<p>在开始之前，我们需要了解 2 个概念：<strong>向量数据库</strong>和<strong>检索增强生成（RAG）</strong></p>
<ul>
<li>**向量数据库：**顾名思义，存储向量的数据库。什么是向量？可以简单理解为，文本、图片、视频等数据在空间中的坐标，语义相似的词在向量空间中距离更近，AI 根据距离来判断相似度。</li>
<li>**检索增强生成（RAG）：**当需要将用户查询发送到 AI 模型时，首先检索一组相似的文档。这些文档随后作为用户问题的上下文，与用户查询一起发送给 AI 模型。这种技术被称为检索增强生成（RAG）。</li>
</ul>
<h3 data-id="heading-2">添加依赖</h3>
<p>之前我们是直接使用的 DeepSeek 的依赖包，但是由于在<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2F5I4ebAG9" target="_blank" title="https://cloud.siliconflow.cn/i/5I4ebAG9" ref="nofollow noopener noreferrer">硅基流动</a>中没找到 DeepSeek 的嵌入模型，这里使用的千问的嵌入模型， Open AI 都能兼容。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-advisors-vector-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-rag<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">配置嵌入模型</h3>
<p><strong>为什么要配置嵌入模型？</strong></p>
<p>前面提到 AI 通过向量可以判断相似度，而嵌入模型就是用于生成向量。嵌入模型可以到<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2F5I4ebAG9" target="_blank" title="https://cloud.siliconflow.cn/i/5I4ebAG9" ref="nofollow noopener noreferrer">硅基流动</a>搜索 Embedding 关键字，这里就直接使用的千问模型。</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">xxxx</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">https://api.siliconflow.cn</span>
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">Qwen/Qwen3-Embedding-0.6B</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-ai/DeepSeek-R1-0528-Qwen3-8B</span>
          <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.7</span>
</code></pre>
<h3 data-id="heading-4">聊天客户端配置</h3>
<p>之前是直接在控制器中使用构造器的方式进行注入：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/chat")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatBotController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatBotController</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder)</span> {
        <span class="hljs-built_in">this</span>.chatClient = chatClientBuilder.build();
    }
}
</code></pre>
<p>现在我们直接抽取成配置。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClient <span class="hljs-title function_">chatClient</span><span class="hljs-params">(ChatModel chatModel, EmbeddingModel embeddingModel, ChatMemory chatMemory)</span> {
        <span class="hljs-keyword">return</span> ChatClient.builder(chatModel)
                .defaultSystem(<span class="hljs-string">"你是一个客服人员，针对用户的问题总是能以友好愉悦的方式去进行交流，希望带给客户很好的体验。"</span>)
                .defaultAdvisors(MessageChatMemoryAdvisor.builder(chatMemory).build())
                .defaultAdvisors(VectorStoreChatMemoryAdvisor.builder(SimpleVectorStore.builder(embeddingModel).build()).build())
                .build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> VectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(EmbeddingModel embeddingModel)</span> {
        <span class="hljs-keyword">return</span> SimpleVectorStore.builder(embeddingModel).build();

    }

}
</code></pre>
<p>我们可以看到 <code>ChatClient</code>​ 的 bean 配置了 <code>defaultSystem</code>​和 <code>defaultAdvisors</code>​，<code>defaultSystem</code>​用来生成默认的提示词，这里我给了个提示让它作为一名客服人员去回答问题。<code>defaultAdvisors</code>​则是添加顾问，可以理解为一种拦截器，在请求 AI 前的一些操作，这里告诉 AI 使用内存作为记忆，并且使用内存作为向量数据库。</p>
<p>当然，实际企业不会直接使用内存作为记忆和向量数据库，我们可以直接基于自身的项目的架构选择合适的向量数据库和记忆会话历史。比如使用 mysql 存储会话历史，使用 redis-stack 做为向量数据库都是不错的选择。</p>
<p>到目前为止已经解决了之前思考问题：”我们怎么给 AI 预置一个角色？比如让它作为一个智能客服或者作为一个营养师。“</p>
<h3 data-id="heading-5">添加知识库</h3>
<p>这里为了方便，直接使用了 <code>PostConstruct</code>​模拟了知识库初始化，真实数据可以从数据库中获取，使用 <code>CommandLineRunner</code>​接口加载数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> VectorStore vectorStore;

<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadStore</span><span class="hljs-params">()</span> {
    List&lt;Document&gt; documents = List.of(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"lanjii是开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus\u200B 和 WebSocket\u200B 等核心技术。前端使用了 Vue3 +Vite + Element Plus + Pinia 构建。它是一个简洁、高效、无过多依赖的项目，支持按钮级别的权限控制，使用简单，开箱即用。"</span>)
    );
    vectorStore.add(documents);
}
</code></pre>
<h3 data-id="heading-6">挂载知识库</h3>
<p>在聊天客户端中直接添加 <code>QuestionAnswerAdvisor</code>​就可以让我们在问 AI 时先从知识库中获取数据，然后经过 AI 整合后回答我们。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/chat")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatBotController_demo</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
	<span class="hljs-meta">@Autowired</span>
	<span class="hljs-keyword">private</span> VectorStore vectorStore;

	<span class="hljs-meta">@PostConstruct</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadStore</span><span class="hljs-params">()</span> {
	    List&lt;Document&gt; documents = List.of(
	            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"lanjii是开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus\u200B 和 WebSocket\u200B 等核心技术。前端使用了 Vue3 +Vite + Element Plus + Pinia 构建。它是一个简洁、高效、无过多依赖的项目，支持按钮级别的权限控制，使用简单，开箱即用。"</span>)
	    );
	    vectorStore.add(documents);
	}

    <span class="hljs-meta">@GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chatStream</span><span class="hljs-params">(String message, String conversationId)</span> {
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .advisors(
                        a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId)
                )
                .advisors(QuestionAnswerAdvisor.builder(vectorStore).build())
                .user(message)
                .stream()
                .content();
    }

}
</code></pre>
<p>不知大家有没有注意到这里使用到了 <code>ChatMemory.CONVERSATION_ID</code>​，这是将聊天数据的上下文进行关联。上篇文章留下的思考中：如果用户 A 和用户 B 同时对 AI 进行对话，怎么让对话进行隔离？这里直接让不同的会话使用不同的 conversationId 即可。</p>
<p>至此，一个简单的知识库就构建好了，看下效果吧：
​<img src="http://openwrite.cn/uploads/20173/57679/99aa6dbd-ea84-4d8d-9194-841be7063502.png" alt="image.png" loading="lazy"/></p>
<p>更可以达到这样的效果：
​<img src="http://openwrite.cn/uploads/20173/57679/8e12b4f0-16a5-47ef-b1bd-c0e9815564f1.png" alt="image.png" loading="lazy"/>​</p>
<p>这样一个即有记忆功能，又能对话隔离，并且能直接关联知识库的问答系统就构建好了。</p>
<h3 data-id="heading-7">思考</h3>
<p>又到了思考环节，按理说 AI 的场景运用到这里已经结束了，但是！！！</p>
<ul>
<li>如果通过对话直接让 AI 跟我们完成业务操作，比如跟我下单，或者说取消机票？</li>
</ul>
<h2 data-id="heading-8">完整代码</h2>
<p>后续我会整理后将代码放在 Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleven2018%2Flanjii" target="_blank" title="https://gitee.com/leven2018/lanjii" ref="nofollow noopener noreferrer">lanjii: 开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus</a></p>
<p>这是一款 MIT 协议可商用的 SpringBoot 脚手架，拥有完整的权限控制和常用的基础功能。希望大家给个 Star，后面有新的功能和一些 BUG 的修复也会提交到 Gitee。
<img src="http://openwrite.cn/uploads/20173/57679/da7e025d-f4d6-4a7f-93d6-e9c89c5fb855.png" alt="image.png" loading="lazy"/>
<img src="http://openwrite.cn/uploads/20173/57679/34583a43-a1b4-469c-b020-78876337a69b.png" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<p>没得小结~~~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验]]></title>    <link>https://juejin.cn/post/7586139603691094035</link>    <guid>https://juejin.cn/post/7586139603691094035</guid>    <pubDate>2025-12-22T05:04:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586139603691094035" data-draft-id="7586540799219793961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-22T05:04:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CC码码"/> <meta itemprop="url" content="https://juejin.cn/user/3800389147179720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3800389147179720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CC码码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:04:48.000Z" title="Mon Dec 22 2025 05:04:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是CC，在这里欢迎大家的到来～</p>
<h2 data-id="heading-0">开场</h2>
<p>书接上文，<strong>Intl</strong> 下的 <strong>Segmenter</strong> 对象可以实现对文本的分割，<strong>Collator</strong> 对象可以处理字符串的比较，除此之外，还有数字格式化、日期格式化等其他功能。</p>
<p>这篇文章先来看看数字格式化，现在来理论加实践一下。</p>
<h2 data-id="heading-1">数字格式化</h2>
<p><code>Intl.NumberFormat</code>使数字在特定语言环境下格式化。</p>
<h3 data-id="heading-2">配置项</h3>
<p>为了方便阅读，属性列表根据用途划分为多个部分，包括区域选项、样式选项、数字选项和其他选项。</p>
<p><strong>区域选项</strong></p>
<ul>
<li>localeMatcher</li>
</ul>

<ul>
<li>
<ul>
<li>使用的区域匹配算法，可能的值包括：</li>
<li>默认值为 best fit，还有 lookup</li>
</ul>
</li>
</ul>

<ul>
<li>numberingSystem</li>
</ul>

<ul>
<li>
<ul>
<li>数字格式化的数字系统，像阿拉伯数字 arab、简体中文数字 hans、无衬线数字 mathsans</li>
<li>默认值取决于区域</li>
<li>同 locales 的 Unicode 扩展键 nu 设置，但优先级高于他</li>
</ul>
</li>
</ul>
<p><strong>样式选项</strong></p>
<ul>
<li>style</li>
</ul>

<ul>
<li>
<ul>
<li>使用的格式化样式，可选的值包括：</li>
<li>decimal: 普通数字格式化</li>
<li>currency: 货币格式化</li>
<li>percent: 百分比格式化</li>
<li>unit: 单位格式化</li>
<li>默认值是 decimal</li>
</ul>
</li>
</ul>

<ul>
<li>currency</li>
</ul>

<ul>
<li>
<ul>
<li>货币格式化中使用的货币，像美元 USD、欧元 EUR 和人民币 CNY。</li>
<li>没有默认值，style 为 currency 时必须提供，内容会被转换为大写。</li>
</ul>
</li>
</ul>

<ul>
<li>currencyDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>货币格式化中如何显示货币，可选的值包括：</li>
<li>code: 使用 ISO 货币代码</li>
<li>symbol: 使用本地化货币符号</li>
<li>narrowSymbol: 使用窄格式符号，像 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mtext>而不是</mtext><mi>U</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">100 而不是 US</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">100</span><span class="mord cjk_fallback">而不是</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>100</li>
<li>name: 使用本地化货币名称，像 dollar</li>
</ul>
</li>
</ul>

<ul>
<li>currencySign</li>
</ul>

<ul>
<li>
<ul>
<li>使用括号将数字括起来，而不是添加负号，可选的值包括：</li>
<li>standard: 默认值</li>
<li>accounting: 会计</li>
</ul>
</li>
</ul>

<ul>
<li>unit</li>
</ul>

<ul>
<li>
<ul>
<li>格式化的单位</li>
<li>style 为 unit 时必填</li>
</ul>
</li>
</ul>

<ul>
<li>unitDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>unit 格式化时使用的格式化风格，可选的值包括：</li>
<li>short: 默认值，例如 16 l</li>
<li>narrow: 例如 16l</li>
<li>long: 例如 16 litres</li>
</ul>
</li>
</ul>
<p><strong>数字选项，由</strong> <code>Intl.PluralRules</code> <strong>支持</strong></p>
<ul>
<li>minimumIntegerDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最小整数位数，默认值为 1，范围是 1~21</li>
<li>若实际整数位数不足会在左侧用 0 补足，比如对于数字 5 该值设置为 3 则显示为“005”</li>
</ul>
</li>
</ul>

<ul>
<li>minimumFractionDigits</li>
</ul>

<ul>
<li>
<ul>
<li>小数部分的最小位数，范围是 0~100</li>
<li>若小数位数不足时会在右侧补 0，超过时会按四舍五入截断</li>
<li>默认值对于普通数字和百分比是 0，对于 currency 是 2（ISO 4217 标准小数位数）</li>
</ul>
</li>
</ul>

<ul>
<li>maximumFractionDigits</li>
</ul>

<ul>
<li>
<ul>
<li>小数部分的最大位数，范围是 0~100</li>
<li>若小数位数不足时会在右侧补 0，超过时会按四舍五入截断</li>
<li>默认值对于普通数字和百分比是 3，对于 currency 是 2（ISO 4217 标准小数位数）</li>
</ul>
</li>
</ul>

<ul>
<li>minimumSignificanntDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最小有效数字，默认值为 1。范围是 1~21。</li>
<li>优先级高于 minimumFractionDigits</li>
</ul>
</li>
</ul>

<ul>
<li>maximumSignificanntDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最大有效数字，默认值为 21。范围是 1~21。</li>
<li>优先级高于 maximumFractionDigits</li>
</ul>
</li>
</ul>

<ul>
<li>roundingPriority</li>
</ul>

<ul>
<li>
<ul>
<li>当同时使用 FractionDigits 和 SignificantDigits 时指定如何解决四舍五入冲突，可选的值包括：</li>
<li>auto: 默认值，使用有效数字属性</li>
<li>morePrecision: 使用精度更高的属性</li>
<li>lessPrecision: 使用精度更低的属性</li>
<li>auto 属性会在 natation 为 compact 时且未设置任何四个 FractionDigits/SignificantDigits 时会被设置为 morePrecision</li>
<li>除 auto 属性以外的值会根据 maximumSignificanntDigits 和 maximumFractionDigits 计算出更高精度，忽略最小小数位和有效数字位</li>
</ul>
</li>
</ul>

<ul>
<li>roundingIncrement</li>
</ul>

<ul>
<li>
<ul>
<li>相对于计算出的舍入单位的舍入增量</li>
<li>默认值为 1，其他值包括 1、2、5、10、20、25、50、100、200、250、500、1000、2000、5000</li>
<li>不能与有效数字位舍入或任何 roundingPriority（除了 auto） 混合使用</li>
</ul>
</li>
</ul>

<ul>
<li>roundingMode</li>
</ul>

<ul>
<li>
<ul>
<li>对小数进行舍入，可选的值包括：</li>
<li>ceil: 向正无穷舍入，正数向上，负数“向正”</li>
<li>floor: 向负无穷舍入，正数向下，负数“向负”</li>
<li>expand: 四舍五入远离 0，绝对值增大</li>
<li>trunc: 四舍五入朝向 0，绝对值减小</li>
<li>halfCeil: 趋向于正无穷舍入，包括半值</li>
<li>halfFloor: 趋向于负无穷舍入，包括半值</li>
<li>halfExpand: 默认值，半值远离 0 舍入</li>
<li>halfTrunc: 向 0 取整，包括半值</li>
<li>halfEven: 半值向最接近的偶数整数舍入，常用于统计，减少片差</li>
</ul>
</li>
</ul>

<ul>
<li>trailingZeroDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>整数末尾 0 的显示策略，可选的值包括：</li>
<li>auto: 默认值，根据 minimumFractionDigits 和 minimumSignificanntDigits 保持末尾 0</li>
<li>stripIfInteger: 如果小数部分全为 0 则删除小数部分，如果小数部分有任何非零数则与 auto 相同</li>
</ul>
</li>
</ul>
<p><strong>其他选项</strong></p>
<ul>
<li>notation</li>
</ul>

<ul>
<li>
<ul>
<li>数字的显示格式，可选的值包括：</li>
<li>standard: 默认值，纯数字格式</li>
<li>scientific: 返回格式化数字的数量级</li>
<li>engineering: 返回能被 3 整除的 10 的指数</li>
<li>compact: 表示指数的字符串，默认使用 short 形式</li>
</ul>
</li>
</ul>

<ul>
<li>compactDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>仅当 notation 为 compact 时使用，可选的值包括：</li>
<li>short: 默认值</li>
<li>long</li>
</ul>
</li>
</ul>

<ul>
<li>useGrouping</li>
</ul>

<ul>
<li>
<ul>
<li>是否使用分组分隔符，像千位分隔符或者千/十万/千万分隔符，可选的值包括：</li>
<li>always: 即使 locale 偏好不同也展示分组分隔符</li>
<li>auto: 根据 locale 偏好显示分组分隔符，也取决于货币</li>
<li>min2: 当一组数字至少有 2 位数字时显示分组分隔符</li>
<li>true: 同 always</li>
<li>false: 不展示分组分隔符</li>
<li>当 notation 为 compact 时默认值为 min2，否则默认值为 auto</li>
<li>字符串 true 和 false 会被转化为默认值</li>
</ul>
</li>
</ul>

<ul>
<li>signDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>何时显示数字符号，可选的值包括：</li>
<li>auto: 默认值</li>
<li>always: 总是显示</li>
<li>exceptZero: 正数和负数显示符号，但 0 不显示</li>
<li>negative: 仅显示负数的符号，不包括负零</li>
<li>never: 从不展示</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">格式化</h3>
<p><code>format()</code>方法会基于区域和格式化选项进行数字格式化。支持数字、大数和字符串。</p>
<p>数字可能因为太大或太小而丢失精度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-number">987654321987654321</span>));
<span class="hljs-comment">// 987,654,321,987,654,300</span>
</code></pre>
<p>但是使用大数就不会有问题</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-number">987654321987654321n</span>));
<span class="hljs-comment">// 987,654,321,987,654,321</span>
</code></pre>
<p>字符串也不会丢失精度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-string">"987654321987654321"</span>));
<span class="hljs-comment">// 987,654,321,987,654,321</span>
</code></pre>
<p>使用指数表示</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-keyword">const</span> bigNum = <span class="hljs-number">987654321987654321n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-string">`<span class="hljs-subst">${bigNum}</span>E-6`</span>));
<span class="hljs-comment">// 987,654,321,987.654</span>
</code></pre>
<h3 data-id="heading-4">格式化分割成多部分</h3>
<p><code>formatToParts()</code>将会返回一个对象数组，包含格式化后的每一部分，适合用来自定义字符串格式化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> number = <span class="hljs-number">3500</span>;

<span class="hljs-keyword">const</span> formatter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"EUR"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">format</span>(number));
<span class="hljs-comment">// "3.500,00 €"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatToParts</span>(number));
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { type: "integer", value: "3" },</span>
<span class="hljs-comment">//   { type: "group", value: "." },</span>
<span class="hljs-comment">//   { type: "integer", value: "500" },</span>
<span class="hljs-comment">//   { type: "decimal", value: "," },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00" },</span>
<span class="hljs-comment">//   { type: "literal", value: " " },</span>
<span class="hljs-comment">//   { type: "currency", value: "€" },</span>
<span class="hljs-comment">// ];</span>
</code></pre>
<h3 data-id="heading-5">格式化数字范围</h3>
<p><code>formatRange()</code>返回一个字符串表示数字范围格式化后的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"USD"</span>,
  <span class="hljs-attr">maximumFractionDigits</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nf.<span class="hljs-title function_">formatRange</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>));
<span class="hljs-comment">// "$3 – $5"</span>
</code></pre>
<p>如果<strong>开始值和结束值四舍五入值相同或者完全相同</strong>时则会添加<strong>近似等于</strong>符号。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nf.<span class="hljs-title function_">formatRange</span>(<span class="hljs-number">2.9</span>, <span class="hljs-number">3.1</span>));
<span class="hljs-comment">// "~$3"</span>
</code></pre>
<h3 data-id="heading-6">格式化数字范围分割成多部分</h3>
<p><code>formatRangeToParts()</code>返回一个对象数组，包含格式化后的每一部分，适合用来自定义数字字符串的格式化范围。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> startRange = <span class="hljs-number">3500</span>;
<span class="hljs-keyword">const</span> endRange = <span class="hljs-number">9500</span>;

<span class="hljs-keyword">const</span> formatter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"EUR"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatRange</span>(startRange, endRange));
<span class="hljs-comment">// "3.500,00–9.500,00 €"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatRangeToParts</span>(startRange, endRange));
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { type: "integer", value: "3", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "group", value: ".", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "integer", value: "500", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "decimal", value: ",", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "literal", value: "–", source: "shared" },</span>
<span class="hljs-comment">//   { type: "integer", value: "9", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "group", value: ".", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "integer", value: "500", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "decimal", value: ",", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "literal", value: " ", source: "shared" },</span>
<span class="hljs-comment">//   { type: "currency", value: "€", source: "shared" },</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<h3 data-id="heading-7">获取配置项</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> de = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"USD"</span>,
  <span class="hljs-attr">maximumFractionDigits</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">roundingIncrement</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">roundingMode</span>: <span class="hljs-string">"halfCeil"</span>,
});

<span class="hljs-keyword">const</span> usedOptions = de.<span class="hljs-title function_">resolvedOptions</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">locale</span>); <span class="hljs-comment">// "de-DE"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">numberingSystem</span>); <span class="hljs-comment">// "latn"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">compactDisplay</span>); <span class="hljs-comment">// undefined ("notation" not set to "compact")</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currency</span>); <span class="hljs-comment">// "USD"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currencyDisplay</span>); <span class="hljs-comment">// "symbol"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currencySign</span>); <span class="hljs-comment">// "standard"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumIntegerDigits</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumFractionDigits</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">maximumFractionDigits</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumSignificantDigits</span>); <span class="hljs-comment">// undefined (maximumFractionDigits is set)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">maximumSignificantDigits</span>); <span class="hljs-comment">// undefined (maximumFractionDigits is set)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">notation</span>); <span class="hljs-comment">// "standard"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingIncrement</span>); <span class="hljs-comment">// 5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingMode</span>); <span class="hljs-comment">// halfCeil</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingPriority</span>); <span class="hljs-comment">// auto</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">signDisplay</span>); <span class="hljs-comment">// "auto"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">style</span>); <span class="hljs-comment">// "currency"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">trailingZeroDisplay</span>); <span class="hljs-comment">// auto</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">useGrouping</span>); <span class="hljs-comment">// auto</span>
</code></pre>
<h3 data-id="heading-8">判断返回支持的 locale</h3>
<p>在给定的 <strong>locales</strong> 数组中判断出 <code>NumberFormat</code> 支持的 <code>locales</code>。但是可能每个浏览器支持的不大一样。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> locales = [<span class="hljs-string">"ban"</span>, <span class="hljs-string">"id-u-co-pinyin"</span>, <span class="hljs-string">"de-ID"</span>];
<span class="hljs-keyword">const</span> options = { <span class="hljs-attr">localeMatcher</span>: <span class="hljs-string">"lookup"</span> };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Intl</span>.<span class="hljs-property">NumberFormat</span>.<span class="hljs-title function_">supportedLocalesOf</span>(locales, options));
<span class="hljs-comment">// ["id-u-co-pinyin", "de-ID"]</span>
</code></pre>
<h2 data-id="heading-9">总结</h2>
<p><code>Intl.NumberFormat</code>用于根据语言和地区格式化数字内容，像把数字格式化为货币、百分比或带单位的本地化字符串，精确控制数字的小数位数、有效数字和整数部分的最小位数，设置丰富的舍入模式像四舍五入、向零舍入或银行家舍入法这些场景下都十分适用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙Next —— 状态管理实践]]></title>    <link>https://juejin.cn/post/7585920796100673563</link>    <guid>https://juejin.cn/post/7585920796100673563</guid>    <pubDate>2025-12-22T04:05:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100673563" data-draft-id="7585866811717664795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙Next —— 状态管理实践"/> <meta itemprop="keywords" content="HarmonyOS,MVVM,客户端"/> <meta itemprop="datePublished" content="2025-12-22T04:05:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊少工作室_CTO"/> <meta itemprop="url" content="https://juejin.cn/user/3034307821836200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙Next —— 状态管理实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307821836200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊少工作室_CTO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:05:42.000Z" title="Mon Dec 22 2025 04:05:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MVVM模式</h2>
<p>MVVM模式是一种软件架构模式，由三个部分组成：Model（数据模型层），View（视图层），ViewModel（视图模型层）。核心是分离应用程序的视图和业务逻辑，通过数据绑定实现视图和业务逻辑的解耦。</p>
<p>以下是ArkUI MVVM模式示意图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abefea2671114d55b91a9741cbf0f1f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=Tg4hMybK2VF9GjcCmVYlL7%2FAfRc%3D" alt="" loading="lazy"/></p>
<ul>
<li>Model层：存储数据和相关逻辑的模型。它表示组件或其他相关业务逻辑之间传输的数据。Model是对原始数据的进一步处理。</li>
<li>View层：在ArkUI中通常是@Component装饰组件渲染的UI。</li>
<li>ViewModel层：在ArkUI中，ViewModel是存储在自定义组件的状态变量（如@State @Prop等装饰器修饰的变量）、LocalStorage和AppStorage中的数据。</li>
</ul>

<ul>
<li>
<ul>
<li>自定义组件通过执行其build()方法或者@Builder装饰的方法来渲染UI，即ViewModel可以渲染View。</li>
<li>View可以通过相应event handler来改变ViewModel，即事件驱动ViewModel的改变，另外ViewModel提供了@Watch回调方法用于监听状态数据的改变。</li>
<li>在ViewModel被改变时，需要同步回Model层，这样才能保证ViewModel和Model的一致性，即应用自身数据的一致性。</li>
<li>ViewModel结构设计应始终为了适配自定义组件的构建和更新，这也是将Model和ViewModel分开的原因。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">二、组件内状态管理(V1)</h2>
<p>V1状态管理中装饰器有：@State, @Prop, @Link, @Observerd, @ObjectLink, @Provide, @Consume, @LocalStorageLink, @LocalStorageProp, @StorageLink, @StorageProp, @Watch，我们下面一一分析这些装饰器的作用。</p>
<h3 data-id="heading-2">@State 组件内状态</h3>
<p>@State修饰的变量称之为状态变量，它是组件内状态装饰器，当状态变量改变时对应的UI也会发生相应的变化，大部分时候和其他装饰器联用时@State修饰的变量往往是作为数据源。</p>
<p>@State支持修饰基础类型、class、数组、map、set等类型，现在先来感受下组件内状态管理的基本用法：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">count</span>: number = <span class="hljs-number">0</span>
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`${this.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
          })
      }
    }
  }
}
</code></pre>
<p>以上示例中点击按钮后count计数会+1，这个时候因为组件Button和count变量有数据绑定的关系，所以Button组件会重新渲染内容改变。这就是@State最基础的用法，实际项目中有很多情况是复杂组件之间的变量传递，下面这张图体现了 哪些装饰器修饰的变量可以传递给@State 以及 @State装饰的变量可以传递给哪些装饰器修饰的变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8088d82b8c74e02a2c3708150675689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=OJwFXLGFoIjnJ6rD75k%2BLJoA1SI%3D" alt="" loading="lazy"/></p>
<p>@State状态变量是不会根据父组件或子组件传递变量的改变而改变，所以他是组件内状态，接下来看下他是如何与其他装饰器联动的。</p>
<h3 data-id="heading-3">@Prop 父子单向同步</h3>
<p>@Prop 装饰的变量可以和父组件建立单向同步的关系，@Prop状态变量是可变的，但是它的变化是不会同步给父组件，父组件变量变化会同步给该@Prop状态变量。</p>
<p>@Prop支持装饰基础类型、class、数组、map、set等类型，大多数情况下父组件传递变量是@State修饰的。下图体现了 @Prop状态变量可以接收哪些父组件装饰器的状态变量 以及 @Prop状态变量可以传递哪些装饰器修饰的子组件状态变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74352fb819e649659eaf02a9b6c5e928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=8nAs5LebozXE5SC07xjtKDNgca8%3D" alt="" loading="lazy"/></p>
<p>看起来基本和@State支持情况一致。ps: @Prop是深度拷贝变量，所以会有一定的性能损耗，大对象建议用Link代替。</p>
<h3 data-id="heading-4">@Link 父子双向同步</h3>
<p>@Link 装饰的变量可以和父组件建立单向同步的关系，@Link状态变量是可变的，但是它的变化会同步给父组件，父组件变量变化会同步给该@Link状态变量。</p>
<p>@Link支持装饰基础类型、class、数组、map、set等类型。其实总结就一句话，@Link除了能父子双向同步之外和@Prop基本一致。</p>
<p>我们直接看下实际代码应用中@Link和@Prop的差异：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">count</span>: number = <span class="hljs-number">0</span>
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`关联子组件的计数器: ${this.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
          })
        <span class="hljs-selector-tag">ChildComponent1</span>({
          count: this.count,
        })
      }
    }
  }
}

<span class="hljs-variable">@Component</span>
struct ChildComponent1 {
  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">count</span>: number
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`子组件1的计数器（Prop）: ${this.count}`</span>, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">12</span>)
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
        })
    }
  }
}

@<span class="hljs-selector-tag">Component</span>
<span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">ChildComponent2</span> {
  <span class="hljs-variable">@Link</span> <span class="hljs-attribute">count</span>: number
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`子组件2的计数器（Link）: ${this.count}`</span>, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">12</span>)
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
        })
    }
  }
}
</code></pre>
<p>父组件有一个@State装饰的count状态变量，分别传递给两个子组件，子组件1的count是用@Prop装饰，子组件2的count是用@Link装饰。当代码运行时：</p>
<ul>
<li>点击父组件的Button，无论是父组件自身的Button内容会+1，还是其他两个子组件的Button都会+1。</li>
<li>点击子组件1的Button，仅仅只有子组件1的Button内容会+1，父组件和子组件2的Button内容不变。</li>
<li>点击子组件2的Button，父组件和子组件2Button内容会+1，子组件1的Button内容变成和父组件和子组件2一致。</li>
</ul>
<p>以上几种装饰器已经能实现大部分组件状态管理的需求，但实际项目中还是有很多更复杂的场景，比如跨代组件状态同步。</p>
<h3 data-id="heading-5">@Provide和@Consume：后代组件双向同步</h3>
<p>@Provider和@Consume两者配合应用于跨代组件双向同步（不仅仅是爷孙组件），所以他们不需要传递变量，而是采用别名绑定的方式。</p>
<p>@Provider和@Consume支持装饰基础类型、class、数组、map、set、Date等类型。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct EntryIndex {
  <span class="hljs-keyword">@Provide</span>(<span class="hljs-string">'desCount'</span>) <span class="hljs-attribute">desCount</span>: number = <span class="hljs-number">0</span>
  build() {
    Scroll() {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(`关联后代组件的计数器: ${this.desCount}`, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            this<span class="hljs-selector-class">.desCount</span>++
          })
        <span class="hljs-comment">// 伪代码表示组件层级嵌套</span>
        <span class="hljs-built_in">Child</span>(){
          <span class="hljs-built_in">DeDescendComponent1</span>()
        }
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct DescendComponent1 {
  <span class="hljs-keyword">@Consume</span>(<span class="hljs-string">'desCount'</span>) <span class="hljs-attribute">desCount</span>: number
  build() {
    <span class="hljs-built_in">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(`后代组件<span class="hljs-number">1</span>的计数器: ${this.desCount}`, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
          this<span class="hljs-selector-class">.desCount</span>++
        })
    }
  }
}
</code></pre>
<p>以上用@Provider和@Consume装饰的且别名为"desCount"的变量数据会双向同步。</p>
<p>@Provider装饰的变量当然也可以传递，只是这个变量不会同步数据，它只有和@Consume配合才能双向同步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c3d8dffaaf42e296ce1e3515439e30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=5symrNcy2iCihiBfyf4xtHcqMY8%3D" alt="" loading="lazy"/></p>
<p>@Consume会特殊一些，它是禁止父组件传递变量给@Consume装饰的变量，因此它只有传递给子组件的权力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab482b41ec1d4eeb83a45420633cea6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=0aQMpba8AuwggnBaRd42IEEpmPY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">@Observed 和 @ObjectLink：嵌套类对象属性变化</h3>
<p>在实际应用开发中，对象传递可能比基础类型传递要更加常见，以上已经提及的装饰器只能观察到第一层，也就是说如果对象内部属性的变化是无法被观察到的。举个例子：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 定义一个类</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CountObj</span> {
  name: string = ''
  count: number = 0
}

<span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">countObj</span>: CountObj = new <span class="hljs-built_in">CountObj</span>()
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`${this.countObj.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.countObj</span><span class="hljs-selector-class">.count</span>++
          })
      }
    }
  }
}
</code></pre>
<p>在这个示例里，this.countObj.count++是不会让Button重新渲染的，因为@State只能监听 countObj 本身，而不能监听到内部属性，所以我们要做的第一步是用@Observed装饰这个类，使这个类具备了内部属性被观察的能力，但这也仅仅是第一层属性，如果内部属性是对象，我们还是要给这个对象类用@Observed装饰。</p>
<p>@ObjectLink装饰的对象实例必须是已经用@Observed装饰的类，@ObjectLink仅支持装饰 class 对象类型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41e5ec49c28a4391a17f26abd771dde6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=v7VETj1%2FxWv94zZHMk08NdYh9R8%3D" alt="" loading="lazy"/></p>
<p>下面是一个使用示例，涉及到父组件 -&gt; 子组件 -&gt; 孙子组件的状态管理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct EntryIndex {
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">countArr</span>: CountObj[] = []
  build() {
    Scroll() {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(`增加对象计数器`, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            let countObj = new <span class="hljs-built_in">CountObj</span>()
            countObj<span class="hljs-selector-class">.name</span> = '测试'
            countObj<span class="hljs-selector-class">.count</span> = <span class="hljs-number">1</span>
            this<span class="hljs-selector-class">.countArr</span><span class="hljs-selector-class">.push</span>(countObj)
          })
        <span class="hljs-built_in">ChildComponent2</span>({
          countArr: this.countArr
        })
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct ChildComponent2 {
  <span class="hljs-keyword">@Link</span> <span class="hljs-attribute">countArr</span>: CountObj[]
  build() {
    <span class="hljs-built_in">Column</span>() {
      <span class="hljs-built_in">List</span>(){
        <span class="hljs-built_in">ForEach</span>(this.countArr, (item: CountObj) =&gt; {
          <span class="hljs-built_in">ListItem</span>(){
            <span class="hljs-built_in">DescendComponentList2</span>({
              desCountObj: item
            })
          }
        })
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct DescendComponentList2 {
  <span class="hljs-keyword">@ObjectLink</span> <span class="hljs-attribute">desCountObj</span>: CountObj
  build() {
    Text(`对象计数器(ObjectLink)${this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.name</span>}：${this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.count</span>}`)
      <span class="hljs-selector-class">.onClick</span>(() =&gt; {
        this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.count</span>++
      })
  }
}
</code></pre>
<ol>
<li>父组件里@State装饰countArr数组对象，把countArr变量传递给了子组件，子组件用@Link装饰变量接收，这样保证父子是双向同步的，父组件和子组件都能观察到内数组的增删改查。</li>
<li>点击Button给countArr增加一个countObj对象，子组件观察到数组增加了，于是列表项增加了一个孙子组件。</li>
<li>孙子组件用@ObjectLink装饰了desCountObj变量，同时CountObj已经被@Observed装饰了，这个时候孙子组件内对desCountObj对象内属性的操作都会同步给子组件和父组件。</li>
</ol>
<p>通过这样的方式，未来增加其他兄弟组件都能观察到属性的变化，从而实现各组件UI联动。</p>
<h2 data-id="heading-7">三、管理应用内状态</h2>
<p>在第二章已经介绍了组件树上共享状态变量，从而实现UI和数据的绑定和联动。那么实际项目遇到的情况可能更加复杂，不同页面之间甚至是不同UIAbility之间都存在数据共享的情况。</p>
<h3 data-id="heading-8">页面间状态存储</h3>
<p>LocalStorage是ArkTS提供的页面级别的状态存储，可以从应用逻辑里使用LocalStorage，也可以从UI内部使用LocalStorage。</p>
<p>应用逻辑中使用简单看下示例代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">para</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">number</span>&gt; = { <span class="hljs-string">'PropA'</span>: <span class="hljs-number">47</span> };
<span class="hljs-keyword">let</span> <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>(para); <span class="hljs-comment">// 创建新实例并使用给定对象初始化</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">propA</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = storage.<span class="hljs-title function_">get</span>(<span class="hljs-string">'PropA'</span>) <span class="hljs-comment">// propA == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">link1</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">link</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// link1.get() == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">link2</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">link</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// link2.get() == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">prop</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">prop</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// prop.get() == 47</span>
link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">48</span>); <span class="hljs-comment">// two-way sync: link1.get() == link2.get() == prop.get() == 48</span>
prop.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// one-way sync: prop.get() == 1; but link1.get() == link2.get() == 48</span>
link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">49</span>); <span class="hljs-comment">// two-way sync: link1.get() == link2.get() == prop.get() == 49</span>
</code></pre>
<p>这样在LocalStorage对象内保存了 'PropA' 属性，由link方法获取的变量支持双向同步，prop方法获取的变量支持单向同步。我们重点看下UI内部的使用方式。</p>
<p>首先有两个装饰器@LocalStorageLink和@LocalStorageProp，一看名字我们就大致明白了这两个装饰器的作用，@LocalStorageLink支持双向同步，@LocalStorageProp支持单向同步，他们都是用别名的方式来绑定关系，接下来看一个示例来理解下：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">let</span> <span class="hljs-variable language_">localStorage</span> = <span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>()
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"count"</span>, <span class="hljs-number">0</span>)

<span class="hljs-meta">@Entry</span>(<span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>())
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">EntryIndex</span> {
  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Scroll</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联其他页面的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
          <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
        }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
          })
      }
    }
  }
}

<span class="hljs-meta">@Entry</span>(<span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>())
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">EntryNextPage</span> {
  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>(){
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`单向关联上个页面的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
      }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
        })
    }
  }
}
</code></pre>
<ul>
<li>首先第一步要绑定LocalStorage和页面，两个页面的@Entry都绑定LocalStorage.getShared()，这代表他们共用一个LocalStorage对象，然后创建一个key为count的共享属性。</li>
<li>接着我们在组件内就可以通过定义相同的别名'count'来观察到属性变化，在第一个页面用的是@LocalStorageLink双向同步，所以当点击按钮后count++，其他所有被@LocalStorageLink和@LocalStorageProp装饰的变量都会观察到+1，从而重新渲染组件内容。</li>
<li>在第二个页面采用@LocalStorageProp观察count，所以点击Button使count++，这只能让自身页面的Button内容改变，而不能让其他页面同步变化。</li>
</ul>
<h3 data-id="heading-9">应用全局状态存储</h3>
<p>AppStorage是应用全局的UI状态存储，是和应用的进程绑定的。其实它的用法和LocalStorage基本上一模一样，装饰器@StorageLink双向同步和@StorageProp单向同步。使用示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"count"</span>, <span class="hljs-number">0</span>)
<span class="hljs-comment">// EntryIndex是EntryAbility的页面</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">EntryIndex</span> {
  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Scroll</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联全局的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
          <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
        }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
          })
      }
    }
  }
}

<span class="hljs-comment">// SecondIndex是SecondAbility的页面</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">SecondIndex</span> {
  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>(){

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联全局的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
      }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
        })
    }
  }
}
</code></pre>
<p>AppStorage.setOrCreate("count", 0)创建了一个共享属性，其他页面通过@StorageLink和@StorageProp就能联动了，</p>
<p>以上存储属于运行时内存存储，如果想要持久化存储，可以使用PersistentStorage，而且ArkTS已经把PersistentStorage和AppStorage关联起来可以共享同一属性，我们在UI内部使用时依然只需要关心@StorageLink和@StorageProp装饰器，在某处创建好需要持久化的属性即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4672987373a4a79b682f112e280cd56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=oy3jgyZEhPJ2p4L4Yj5d15rm2PM%3D" alt="" loading="lazy"/></p>
<p><strong>参考资料</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fapplication-dev-guide-V5%3FcatalogVersion%3DV5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/application-dev-guide-V5?catalogVersion=V5" ref="nofollow noopener noreferrer">状态管理概述</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性]]></title>    <link>https://juejin.cn/post/7585897699603611674</link>    <guid>https://juejin.cn/post/7585897699603611674</guid>    <pubDate>2025-12-22T03:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603611674" data-draft-id="7585920796100591643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性"/> <meta itemprop="keywords" content="人工智能,AI编程,Gemini"/> <meta itemprop="datePublished" content="2025-12-22T03:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有痣青年"/> <meta itemprop="url" content="https://juejin.cn/user/905653309947037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309947037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有痣青年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:55:36.000Z" title="Mon Dec 22 2025 03:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入剖析 Google 最新 AI 模型 Gemini 3 Flash 的技术架构，了解它如何在保持极速响应的同时，实现 Pro 级别的推理能力。</p>
</blockquote>
<h2 data-id="heading-0">一、技术定位：打破速度与智能的对立</h2>
<p>传统观念认为，AI模型要么快但笨，要么强但慢。Gemini 3 Flash 的设计哲学是：<strong>用更聪明的架构设计，而非简单的参数堆砌，来同时实现速度和智能</strong>。</p>
<p>Google DeepMind 将其定位为：</p>
<blockquote>
<p>"Pro-grade reasoning with Flash-level latency, efficiency, and cost."
（Pro级推理能力 + Flash级延迟、效率和成本）</p>
</blockquote>
<p>这不是一句营销口号。从技术实现上看，Gemini 3 Flash 引入了多项创新机制来实现这一目标。</p>
<h2 data-id="heading-1">二、多模态架构详解</h2>
<h3 data-id="heading-2">2.1 原生多模态 vs 后融合多模态</h3>
<p>许多所谓的"多模态"模型实际上是在文本模型基础上拼接视觉/音频编码器。Gemini 3 Flash 采用的是<strong>原生多模态架构</strong>——从训练阶段就同时处理多种模态数据。</p>
<p><strong>支持的输入类型</strong>：</p>





























<table><thead><tr><th>模态</th><th>详情</th></tr></thead><tbody><tr><td>文本</td><td>自然语言、代码、结构化数据</td></tr><tr><td>图像</td><td>PNG, JPEG, WebP, GIF 等</td></tr><tr><td>音频</td><td>最长8.4小时，支持多格式</td></tr><tr><td>视频</td><td>帧级别分析能力</td></tr><tr><td>文档</td><td>PDF原生支持，无需OCR预处理</td></tr></tbody></table>
<h3 data-id="heading-3">2.2 视觉推理能力</h3>
<p>Gemini 3 Flash 在视觉理解上实现了重要突破：</p>
<ol>
<li><strong>空间推理</strong>：能够理解图像中元素的位置关系</li>
<li><strong>视觉代码执行</strong>：支持基于视觉输入执行代码</li>
<li><strong>复杂数据提取</strong>：从扫描文档、复杂布局中提取数据，准确率比上一代提升 <strong>15%</strong></li>
</ol>
<p>在 MMMU-Pro（多模态理解基准）测试中，Gemini 3 Flash 拿下 <strong>81.2%</strong> 的最高分，超越了 GPT-5.2 的 79.5%。</p>
<h3 data-id="heading-4">2.3 音频处理能力</h3>

























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>音频摘要</td><td>自动生成音频内容摘要</td></tr><tr><td>转录</td><td>高精度语音转文字</td></tr><tr><td>翻译</td><td>跨语言音频理解</td></tr><tr><td>容量</td><td>单次请求最长约8.4小时</td></tr></tbody></table>
<h2 data-id="heading-5">三、Thinking Level：可控的推理深度</h2>
<h3 data-id="heading-6">3.1 为什么需要可控推理？</h3>
<p>不同任务对推理深度的要求不同：</p>
<ul>
<li>简单问答 → 快速响应更重要</li>
<li>数学证明 → 深度推理更重要</li>
<li>代码调试 → 需要平衡</li>
</ul>
<p>Gemini 3 Flash 引入了 <code>thinking_level</code> 参数，让开发者可以<strong>显式控制模型的推理深度</strong>。</p>
<h3 data-id="heading-7">3.2 四个推理等级</h3>






























<table><thead><tr><th>等级</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>minimal</code></td><td>最快速度，最低延迟</td><td>简单问答、快速响应</td></tr><tr><td><code>low</code></td><td>轻度推理</td><td>日常对话、信息检索</td></tr><tr><td><code>medium</code></td><td>平衡选择</td><td>一般分析、内容生成</td></tr><tr><td><code>high</code></td><td>深度推理</td><td>复杂问题、数学推导</td></tr></tbody></table>
<h3 data-id="heading-8">3.3 与 Gemini 2.5 的对比</h3>




















<table><thead><tr><th>版本</th><th>控制方式</th><th>灵活性</th></tr></thead><tbody><tr><td>Gemini 2.5 Flash</td><td><code>thinking_budget</code>（token预算）</td><td>数值控制</td></tr><tr><td>Gemini 3 Flash</td><td><code>thinking_level</code>（推理等级）</td><td>语义控制，更直观</td></tr></tbody></table>
<p><strong>关键提示</strong>：在 <code>minimal</code> 级别下，Gemini 3 Flash 可以达到与 Gemini 2.5 Flash（thinking_budget=0）相似的延迟和成本。</p>
<h2 data-id="heading-9">四、Thought Signatures：推理连续性的秘密</h2>
<h3 data-id="heading-10">4.1 什么是 Thought Signatures？</h3>
<p>Thought Signatures（思维签名）是 Gemini 3 引入的一项关键技术创新。它是模型内部推理过程的<strong>加密表示</strong>，用于在多轮API调用间保持推理的连贯性。</p>
<p>类比理解：如果把 AI 的推理过程比作一个人解数学题，Thought Signatures 就像是他的"草稿纸"——虽然最终答案写在答题纸上，但没有草稿纸就无法保持解题思路的连贯性。</p>
<h3 data-id="heading-11">4.2 工作机制</h3>
<pre><code class="hljs language-markdown" lang="markdown">请求1 → 模型推理 → 响应1 + Thought Signature
<span class="hljs-code">                            ↓
请求2 + Thought Signature → 模型推理（继承上下文）→ 响应2 + 新的 Thought Signature
</span></code></pre>
<h3 data-id="heading-12">4.3 开发者注意事项</h3>
<p>⚠️ <strong>关键规则</strong>：</p>
<ol>
<li>必须原样返回收到的 Thought Signatures</li>
<li>即使 <code>thinking_level</code> 设为 <code>minimal</code>，也需要传递 Thought Signatures</li>
<li>特别是在多轮函数调用场景中，这一点至关重要</li>
</ol>
<h2 data-id="heading-13">五、Media Resolution：精细化视觉控制</h2>
<h3 data-id="heading-14">5.1 参数说明</h3>
<p><code>media_resolution</code> 参数允许开发者控制视觉输入的处理精度：</p>






























<table><thead><tr><th>级别</th><th>Token消耗</th><th>适用场景</th></tr></thead><tbody><tr><td><code>low</code></td><td>最少</td><td>快速预览、简单识别</td></tr><tr><td><code>medium</code></td><td>中等</td><td>一般图像分析</td></tr><tr><td><code>high</code></td><td>较多</td><td>细节识别、文字提取</td></tr><tr><td><code>ultra-high</code></td><td>最多</td><td>精密分析、小字体识别</td></tr></tbody></table>
<h3 data-id="heading-15">5.2 使用建议</h3>
<ul>
<li><strong>需要识别图像中的小字体</strong> → 使用 <code>high</code> 或 <code>ultra-high</code></li>
<li><strong>只需了解图像大意</strong> → 使用 <code>low</code> 节省成本</li>
<li><strong>不确定时</strong> → 从 <code>medium</code> 开始，根据效果调整</li>
</ul>
<h2 data-id="heading-16">六、开发者 API 新特性</h2>
<h3 data-id="heading-17">6.1 Streaming Function Calling</h3>
<p>Gemini 3 Flash 支持<strong>流式函数调用</strong>——在函数执行过程中就开始返回部分参数，而不是等待完整结果。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">传统方式: 等待完整参数 → 一次性返回</span>
<span class="hljs-section">流式方式: 参数1 → 参数2 → 参数3 → ... (逐步返回)</span>
</code></pre>
<p>应用价值：用户可以更早看到响应开始，提升交互体验。</p>
<h3 data-id="heading-18">6.2 多模态函数响应</h3>
<p>函数调用的响应不再局限于文本，现在可以包含：</p>
<ul>
<li>图像</li>
<li>PDF</li>
<li>其他多模态对象</li>
</ul>
<p>这为构建复杂的视觉工作流提供了可能。</p>
<h3 data-id="heading-19">6.3 Tool Use 能力</h3>





























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>Google Search Grounding</td><td>使用搜索增强回答</td></tr><tr><td>Code Execution</td><td>执行代码验证结果</td></tr><tr><td>System Instructions</td><td>系统级指令控制</td></tr><tr><td>Structured Output</td><td>强制输出JSON等结构化数据</td></tr><tr><td>Function Calling</td><td>调用外部函数/API</td></tr></tbody></table>
<h2 data-id="heading-20">七、与 Gemini 2.5 Flash 技术对比</h2>























































<table><thead><tr><th>技术特性</th><th>Gemini 2.5 Flash</th><th>Gemini 3 Flash</th></tr></thead><tbody><tr><td>推理控制</td><td>thinking_budget</td><td>thinking_level</td></tr><tr><td>推理连续性</td><td>无</td><td>Thought Signatures</td></tr><tr><td>视觉控制</td><td>基础</td><td>media_resolution参数</td></tr><tr><td>函数调用</td><td>同步</td><td>支持流式</td></tr><tr><td>函数响应</td><td>仅文本</td><td>多模态对象</td></tr><tr><td>代码执行</td><td>仅文本输入</td><td>支持视觉输入</td></tr><tr><td>图像分割</td><td>✅ 支持</td><td>❌ 不支持</td></tr><tr><td>整体准确性</td><td>基准</td><td>+15%</td></tr><tr><td>Token效率</td><td>基准</td><td>-30%</td></tr></tbody></table>
<h2 data-id="heading-21">八、底层优化推测</h2>
<p>虽然 Google 没有公开完整的技术细节，但从公开信息可以推测一些优化方向：</p>
<h3 data-id="heading-22">8.1 Token 效率优化</h3>
<p>相同任务减少30%的token使用量，可能涉及：</p>
<ul>
<li>更高效的tokenizer</li>
<li>更紧凑的内部表示</li>
<li>智能的上下文压缩</li>
</ul>
<h3 data-id="heading-23">8.2 推理加速</h3>
<p>3倍速度提升，可能来自：</p>
<ul>
<li>模型架构优化（稀疏化、知识蒸馏等）</li>
<li>推理引擎优化（更好的batching策略）</li>
<li>硬件协同优化（TPU深度定制）</li>
</ul>
<h3 data-id="heading-24">8.3 多模态融合</h3>
<p>原生多模态带来的好处：</p>
<ul>
<li>减少模态转换开销</li>
<li>更好的跨模态理解</li>
<li>统一的表示空间</li>
</ul>
<h2 data-id="heading-25">九、开发者快速上手</h2>
<h3 data-id="heading-26">9.1 获取 API Key</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：Google AI Studio（推荐新手）</span>
访问 https://aistudio.google.com
登录 → 选择 Gemini 3 Flash → 生成 API Key

<span class="hljs-comment"># 方式2：Vertex AI（推荐生产环境）</span>
gcloud auth application-default login
</code></pre>
<h3 data-id="heading-27">9.2 基础调用示例（概念）</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">POST /v1beta/models/gemini-<span class="hljs-number">3</span>-flash-preview:generateContent
<span class="hljs-symbol">Header:</span> x-goog-api-<span class="hljs-keyword">key</span>: YOUR_API_KEY

<span class="hljs-symbol">Body:</span>
{
  <span class="hljs-string">"contents"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"parts"</span>: [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"你的问题"</span>}]}],
  <span class="hljs-string">"generationConfig"</span>: {
    <span class="hljs-string">"thinking_level"</span>: <span class="hljs-string">"medium"</span>
  }
}
</code></pre>
<h3 data-id="heading-28">9.3 最佳实践</h3>
<ol>
<li><strong>保持 temperature 为 1.0</strong> —— 偏离默认值可能影响推理性能</li>
<li><strong>实现重试逻辑</strong> —— 使用指数退避处理临时错误</li>
<li><strong>监控 token 使用</strong> —— 记录每次请求的输入/输出token</li>
<li><strong>使用 Context Caching</strong> —— 重复上下文可节省90%成本</li>
<li><strong>关注官方更新</strong> —— 预览版本会持续迭代</li>
</ol>
<h2 data-id="heading-29">十、总结</h2>
<p>Gemini 3 Flash 的技术创新体现在多个层面：</p>
<ol>
<li><strong>可控推理</strong>：thinking_level让开发者可以根据场景灵活调整</li>
<li><strong>推理连续性</strong>：Thought Signatures确保多轮对话的连贯性</li>
<li><strong>精细视觉控制</strong>：media_resolution平衡精度与成本</li>
<li><strong>增强的工具使用</strong>：流式函数调用、多模态响应</li>
<li><strong>效率突破</strong>：3倍速度提升，30%token节省</li>
</ol>
<p>对于需要在<strong>生产环境中大规模部署AI能力</strong>的团队来说，这些技术创新意味着：更低的成本、更快的响应、更好的用户体验，以及更强的可控性——这正是Gemini 3 Flash的核心价值所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程数突增！领导：谁再这么写就滚蛋！]]></title>    <link>https://juejin.cn/post/7586157459972423732</link>    <guid>https://juejin.cn/post/7586157459972423732</guid>    <pubDate>2025-12-22T05:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972423732" data-draft-id="7586157459972390964" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程数突增！领导：谁再这么写就滚蛋！"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-12-22T05:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程数突增！领导：谁再这么写就滚蛋！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:39:01.000Z" title="Mon Dec 22 2025 05:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>分享一个线上问题引出的一次思考，过程比较长，但是挺有意思。</p>
<p>下面是正文。</p>
<p>今天上班把需求写完，出于学习（摸鱼）的心理上 skywalking 看看，突然发现我们的一个应用，应用内线程数超过 900 条，接近 1000 条，但是 cpu 并没有高涨，内存也不算高峰。</p>
<p>但是敏锐的我还是立刻意识到这个应用有不妥，因为线程数太多了，不符合我们一个正常健康的应用数量。熟练的打出 cpu dump 观察，首先看线程组名的概览。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f925bc7dabb5492586ec6fbc55ce5f77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=buIKXpI2Mda03hmzLCQW8RIRqgA%3D" alt="" loading="lazy"/></p>
<p>从线程分组看，pool 名开头线程占 616 条，而且 waiting 状态也是 616 条，这个点就非常可疑了，我断定就是这个 pool 开头线程池导致的问题。我们先排查为何这个线程池中会有 600+的线程处于 waiting 状态并且无法释放，记接下来我们找几条线程的堆栈观察具体堆栈：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92a108536394548beb7ed029f61be74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=BR6vFbTFZsSPMA1xi%2FKOC0Cg2aY%3D" alt="" loading="lazy"/></p>
<p>这个堆栈看上去很合理，线程在线程池中不断的循环获取任务，因为获取不到任务所以进入了 waiting 状态，等待着有任务后被唤醒。</p>
<p>看上去不只一个线程池，并且这些线程池的名字居然是一样的，我大胆的猜测一下，是不断的创建同样的线程池，但是线程池无法被回收导致的线程数，所以接下来我们要分析两个问题，首先这个线程池在代码里是哪个线程池，第二这个线程池是怎么被创建的？为啥释放不了？</p>
<p>我在 idea 搜索<code>new ThreadPoolExecutor()</code>得到的结果是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32d2cbce57745b1abb0e723caae21ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=hAFJTEt%2FZ2qJXwgBy3s%2FiaDBNPQ%3D" alt="" loading="lazy"/></p>
<p>于是我陷入懵逼的状态，难道还有其他骚操作？</p>
<p>正在这时，一位不知名的郑网友发来一张截图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de58d5e910e142ba98808976dd4c2aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=hJHQ4l0fV%2BoIDt%2Fag%2BQ4DaZbyl8%3D" alt="" loading="lazy"/></p>
<p>好家伙！竟然是用<code>new FixedTreadPool()</code>整出来的。难怪我完全搜不到，因为用的<code>new FixedTreadPool()</code>，所以线程池中的线程名是默认的 pool（又多了一个不使用 Executors 来创建线程池的理由）。</p>
<p>然后我迫不及 die 的打开代码，试图找到罪魁祸首，结果发现作者居然是我自己。这是另一个惊喜，惊吓的惊。</p>
<p>冷静下来后我梳理一遍代码，这个接口是我两年前写的，主要是功能是统计用户的钱包每个月的流水，因为担心统计比较慢，所以使用了线程池，做了批量的处理，没想到居然导致了线程数过高，虽然没有导致事故，但是确实是潜在的隐患，现在没出事不代表以后不会出事。</p>
<p>去掉多余业务逻辑，我简单的还原一个代码给大家看，还原现场：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">threadDontGcDemo</span>()</span>{
    ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    executorService.submit(() -&gt; {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"111"</span>);
    });
}
</code></pre>
<h2 data-id="heading-0">那么为啥线程池里面的线程和线程池都没释放呢</h2>
<p>难道是因为没有调用 shutdown？我大概能理解我两年前当时为啥不调用 shutdown，是因为当初我觉得接口跑完，方法走到结束，理论上栈帧出栈，局部变量应该都销毁了，按理说<code>executorService</code>这个变量应该直接 GG 了，那么按理说我是不用调用 shutdown 方法的。</p>
<p>我简单的跑了个 demo，循环的去 new 线程池，不调用 shutdown 方法，看看线程池能不能被回收</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22702809273c472fb4598c3de6fdf026~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=jGg4f77YvEmKG7E5G32k%2BDF7YFw%3D" alt="" loading="lazy"/></p>
<p>打开<code>java visual vm</code>查看实时线程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9433b90bbc461ab694d123e0d71765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=UPmRp7xb3FI788AsOa33bInb47w%3D" alt="" loading="lazy"/></p>
<p>可以看到线程数和线程池都一直在增加，但是一直没有被回收，确实符合发生的问题状况，那么假如我在方法结束前调用 shutdown 方法呢，会不会回收线程池和线程呢？</p>
<p>简单写个 demo 结合 jvisualvm 验证下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e13d76131834d8396874a8596fac242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=2n%2FWVKmr2ZOPVhpMhN%2F%2B5YbyOL8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b621501a385d4f86ac1d2e91e8ed8734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=ZcUbcy4%2BubwOlVthqe5%2BiGpqsDc%3D" alt="" loading="lazy"/></p>
<p><strong>结果是线程和线程池都被回收了。也就是说，执行了 shutdown 的线程池最后会回收线程池和线程对象。</strong></p>
<p>我们知道，一个对象能不能回收，是看它到 gc root 之间有没有可达路径，线程池不能回收说明到达线程池的 gc root 还是有可达路径的。这里讲个冷知识，这里的线程池的 gc root 是线程，具体的 gc 路径是<code>thread-&gt;workers-&gt;线程池</code>。</p>
<p>线程对象是线程池的 gc root，假如线程对象能被 gc，那么线程池对象肯定也能被 gc 掉（因为线程池对象已经没有到 gc root 的可达路径了）。</p>
<h2 data-id="heading-1">那么现在问题就转为线程对象是在什么时候 gc</h2>
<p>郑网友给了一个粗浅但是合理的解释，线程对象肯定不是在运行中的时候被回收的，因为 jvm 肯定不可能去回收一条在运行中的线程，至少 runnalbe 状态的线程 jvm 不可能去回收。</p>
<p>在 stackoverflow 上我找到了更准确的答案：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f6387372d7149a89d61d0a02f10fbae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=nYk1B749hAmjO9AT2aLTNvxZT3U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>A running thread is considered a so called garbage collection root and is one of those things keeping stuff from being garbage collected</p>
</blockquote>
<p>这句话的意思是，一条正在运行的线程是 gc root，注意，是正在运行，这个正在运行我先透露下，即使是 waiting 状态，也算正在运行。这个回答的整体的意思是，运行的线程是 gc root，但是非运行的线程不是 gc root（可以被回收）。</p>
<p>现在比较清楚了，线程池和线程被回收的关键就在于线程能不能被回收，那么回到原来的起点，为何调用线程池的 shutdown 方法能够导致线程和线程池被回收呢？难道是 shutdown 方法把线程变成了非运行状态吗？</p>
<blockquote>
<p>talk is cheap,show me the code</p>
</blockquote>
<p>我们直接看看线程池的 shutdown 方法的源码</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">shutdown</span>() {
    final ReentrantLock mainLock = this<span class="hljs-selector-class">.mainLock</span>;
    mainLock<span class="hljs-selector-class">.lock</span>();
    try {
        <span class="hljs-built_in">checkShutdownAccess</span>();
        <span class="hljs-built_in">advanceRunState</span>(SHUTDOWN);
        <span class="hljs-built_in">interruptIdleWorkers</span>();
        <span class="hljs-built_in">onShutdown</span>(); <span class="hljs-comment">// hook for ScheduledThreadPoolExecutor</span>
    } finally {
        mainLock<span class="hljs-selector-class">.unlock</span>();
    }
    <span class="hljs-built_in">tryTerminate</span>();
}

private void <span class="hljs-built_in">interruptIdleWorkers</span>() {
    <span class="hljs-built_in">interruptIdleWorkers</span>(false);
}

private void <span class="hljs-built_in">interruptIdleWorkers</span>(boolean onlyOne) {
    final ReentrantLock mainLock = this<span class="hljs-selector-class">.mainLock</span>;
    mainLock<span class="hljs-selector-class">.lock</span>();
    try {
        for (Worker w : workers) {
            Thread t = w<span class="hljs-selector-class">.thread</span>;
            if (!t.isInterrupted() &amp;&amp; w<span class="hljs-selector-class">.tryLock</span>()) {
                try {
                    t<span class="hljs-selector-class">.interrupt</span>();
                } catch (SecurityException ignore) {
                } finally {
                    w<span class="hljs-selector-class">.unlock</span>();
                }
            }
            if (onlyOne)
                break;
        }
    } finally {
        mainLock<span class="hljs-selector-class">.unlock</span>();
    }
}
</code></pre>
<p>我们从<code>interruptIdleWorkers</code>方法入手，这方法看上去最可疑，看到<code>interruptIdleWorkers</code>方法，这个方法里面主要就做了一件事，遍历当前线程池中的线程，并且调用线程的<code>interrupt()</code>方法，通知线程中断，也就是说 shutdown 方法只是去遍历所有线程池中的线程，然后通知线程中断。所以我们需要了解线程池里的线程是怎么处理中断的通知的。</p>
<p>我们点开 worker 对象，这个 worker 对象是线程池中实际运行的线程，所以我们直接看 worker 的 run 方法，中断通知肯定是在里面被处理了</p>
<pre><code class="hljs language-ini" lang="ini">//WOrker的run方法里面直接调用的是这个方法
final void runWorker(Worker w) {
    Thread <span class="hljs-attr">wt</span> = Thread.currentThread()<span class="hljs-comment">;</span>
    Runnable <span class="hljs-attr">task</span> = w.firstTask<span class="hljs-comment">;</span>
    <span class="hljs-attr">w.firstTask</span> = null<span class="hljs-comment">;</span>
    w.unlock()<span class="hljs-comment">; // allow interrupts</span>
    boolean <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    try {
        while (task != null || (<span class="hljs-attr">task</span> = getTask()) != null) {
            w.lock()<span class="hljs-comment">;</span>
            // If pool is stopping, ensure thread is interrupted<span class="hljs-comment">;</span>
            // if not, ensure thread is not interrupted.  This
            // requires a recheck in second case to deal with
            // shutdownNow race while clearing interrupt
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp;
                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt()<span class="hljs-comment">;</span>
            try {
                beforeExecute(wt, task)<span class="hljs-comment">;</span>
                Throwable <span class="hljs-attr">thrown</span> = null<span class="hljs-comment">;</span>
                try {
                    task.run()<span class="hljs-comment">;</span>
                } catch (RuntimeException x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; throw x;</span>
                } catch (Error x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; throw x;</span>
                } catch (Throwable x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; thrownew Error(x);</span>
                } finally {
                    afterExecute(task, thrown)<span class="hljs-comment">;</span>
                }
            } finally {
                <span class="hljs-attr">task</span> = null<span class="hljs-comment">;</span>
                w.completedTasks++<span class="hljs-comment">;</span>
                w.unlock()<span class="hljs-comment">;</span>
            }
        }
        <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    } finally {
        processWorkerExit(w, completedAbruptly)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个 runwoker 属于是线程池的核心方法了，相当的有意思，线程池能不断运作的原理就是这里，我们一点点看。</p>
<p>首先最外层用一个 while 循环套住，然后不断的调用<code>gettask()</code>方法不断从队列中取任务，假如拿不到任务或者任务执行发生异常（抛出异常了）那就属于异常情况，直接将<code>completedAbruptly</code> 设置为 true，并且进入异常的<code>processWorkerExit</code>流程。</p>
<p>我们看看<code>gettask()</code>方法，了解下啥时候可能会抛出异常：</p>
<pre><code class="hljs language-ini" lang="ini">private Runnable getTask() {
    boolean <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">false</span><span class="hljs-comment">; // Did the last poll() time out?</span>

    for (<span class="hljs-comment">;;) {</span>
        int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">rs</span> = runStateOf(c)<span class="hljs-comment">;</span>

        // Check if queue empty only if necessary.
        if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {
            decrementWorkerCount()<span class="hljs-comment">;</span>
            returnnull<span class="hljs-comment">;</span>
        }

        int <span class="hljs-attr">wc</span> = workerCountOf(c)<span class="hljs-comment">;</span>

        // Are workers subject to culling?
        boolean <span class="hljs-attr">timed</span> = allowCoreThreadTimeOut || wc &gt; corePoolSize<span class="hljs-comment">;</span>

        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                returnnull<span class="hljs-comment">;</span>
            continue<span class="hljs-comment">;</span>
        }

        try {
            Runnable <span class="hljs-attr">r</span> = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
            workQueue.take()<span class="hljs-comment">;</span>
            if (r != null)
                return r<span class="hljs-comment">;</span>
            <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        } catch (InterruptedException retry) {
            <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p>这样很清楚了，抛去前面的大部分代码不看，这句代码解释了 gettask 的作用：</p>
<pre><code class="hljs language-ini" lang="ini">Runnable <span class="hljs-attr">r</span> = timed ?
    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
workQueue.take()
</code></pre>
<p>gettask 就是从工作队列中取任务，但是前面还有个 timed，这个 timed 的语义是这样的：如果<code>allowCoreThreadTimeOut</code>参数为 true（一般为 false）或者当前工作线程数超过核心线程数，那么使用队列的 poll 方法取任务，反之使用 take 方法。</p>
<p>这两个方法不是重点，重点是 poll 方法和 take 方法都会让当前线程进入<code>time_waiting</code>或者 waiting 状态。而当线程处于在等待状态的时候，我们调用线程的 interrupt 方法，毫无疑问会使线程当场抛出异常！</p>
<p><strong>也就是说线程池的<code>shutdownnow</code>方法调用<code>interruptIdleWorkers</code>去对线程对象 interrupt 是为了让处于 waiting 或者是<code>time_waiting</code>的线程抛出异常。</strong></p>
<p>那么线程池是在哪里处理这个异常的呢？我们看<code>runwoker</code>中的调用的<code>processWorkerExit</code>方法，说实话这个方法看着就像处理抛出异常的方法：</p>
<pre><code class="hljs language-ini" lang="ini">private void processWorkerExit(Worker w, boolean completedAbruptly) {
    if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted
        decrementWorkerCount()<span class="hljs-comment">;</span>

    final ReentrantLock <span class="hljs-attr">mainLock</span> = this.mainLock<span class="hljs-comment">;</span>
    mainLock.lock()<span class="hljs-comment">;</span>
    try {
        completedTaskCount += w.completedTasks<span class="hljs-comment">;</span>
        workers.remove(w)<span class="hljs-comment">;</span>
    } finally {
        mainLock.unlock()<span class="hljs-comment">;</span>
    }

    tryTerminate()<span class="hljs-comment">;</span>

    int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;</span>
    if (runStateLessThan(c, STOP)) {
        if (!completedAbruptly) {
            int <span class="hljs-attr">min</span> = allowCoreThreadTimeOut ? <span class="hljs-number">0</span> : corePoolSize<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">min</span> == <span class="hljs-number">0</span> &amp;&amp; ! workQueue.isEmpty())
                <span class="hljs-attr">min</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            if (workerCountOf(c) &gt;= min)
                return<span class="hljs-comment">; // replacement not needed</span>
        }
        addWorker(null, false)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>我们可以看到，在这个方法里有一个很明显的<code>workers.remove(w)</code>方法，也就是在这里，这个 w 的变量，被移出了 workers 这个集合，导致 worker 对象不能到达 gc root，于是 workder 对象顺理成章的变成了一个垃圾对象，被回收掉了。</p>
<p>然后等到 worker 中所有的 worker 都被移出 works 后，并且当前请求线程也完成后，线程池对象也成为了一个孤儿对象，没办法到达<code>gc root</code>，于是线程池对象也被 gc 掉了。写了挺长的篇幅，我小结一下：</p>
<ul>
<li>线程池调用<code>shutdownnow</code>方法是为了调用 worker 对象的 interrupt 方法，来打断那些沉睡中的线程（waiting 或者<code>time_waiting</code>状态），使其抛出异常</li>
<li>线程池会把抛出异常的 worker 对象从 workers 集合中移除引用，此时被移除的 worker 对象因为没有到达<code>gc root</code>的路径已经可以被 gc 掉了</li>
<li>等到 workers 对象空了，并且当前 tomcat 线程也结束，此时线程池对象也可以被 gc 掉，整个线程池对象成功释放</li>
</ul>
<h2 data-id="heading-2">总结</h2>
<p>如果只是在局部方法中使用线程池，线程池对象不是 bean 的情况时，记得要合理的使用<code>shutdown</code>或者<code>shutdownnow</code>方法来释放线程和线程池对象，如果不使用，会造成线程池和线程对象的堆积。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐 6 个近期火火火的 GitHub 项目]]></title>    <link>https://juejin.cn/post/7585928504949702692</link>    <guid>https://juejin.cn/post/7585928504949702692</guid>    <pubDate>2025-12-22T05:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504949702692" data-draft-id="7586540799219892265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐 6 个近期火火火的 GitHub 项目"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-22T05:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐 6 个近期火火火的 GitHub 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:48:04.000Z" title="Mon Dec 22 2025 05:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、AI 对冲基金团队</h2>
<p>AI Hedge Fund 搞了一个由多个 AI 智能体组成的虚拟对冲基金团队。</p>
<p>现在在 GitHub 上都 43K 的 Star 了。</p>
<p>核心理念就是用大模型分别扮演不同的投资专家角色：比如巴菲特（价值投资）、凯瑟琳·伍德（成长型投资）、Bill Ackman（激进投资）等。</p>
<p>这些 AI 智能体会协同工作，通过分析数据来制定交易决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c573dbccf8457b82d4b0938ac05614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=RoExG4JyKFfL1zV48OOG%2FEORWcI%3D" alt="图片" loading="lazy"/></p>
<p>而且这些智能体分工很明确，有的负责估值、有的分析市场情绪、研究基本面、技术分析。</p>
<p>所有的分析结果最终汇总给投资组合经理进行综合权衡，并由风险控制模块把关，最终模拟出买入或卖出的指令。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9efc4f894604bc0b5e13a573128a263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=V%2B9%2B6DgiOm7a1SVQ1%2BPGWYgufAM%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目仅仅用于教育和研究目的哈，别用于真实的真金白银交易哦。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/virattt/ai-hedge-fund</span>
</code></pre>
<h2 data-id="heading-1">02、AI Agent 搭建平替</h2>
<p>Sim 是一个 22K  Star 的开源 AI  Agent工作流构建与部署平台，通过可视化的拖拽界面降低 AI 应用的开发门槛。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af1f811ed9f8446f90e6d44d32d46a25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=XcHmu8ijCSVgUnK3Evn6K3uLo0c%3D" alt="图片" loading="lazy"/></p>
<p><strong>这个开源项目的核心是</strong> Agent 可视化编排，就像下面视频演示的，像画流程图一样设计 AI 复杂的思考逻辑，比如如循环推理、反思。比较适合搭建一个深度定制的 AI 应用。</p>
<p><strong>之前提到的 n8n</strong> 更多是自动化工作流 <strong>，它的强项是</strong>连接，主要用于把不同的应用节点串联起来自动执行任务，AI 只是一个节点。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/simstudioai/sim</span>
</code></pre>
<h2 data-id="heading-2">03、浙大开源的大模型基础书籍</h2>
<p>这是一本浙江大学开源的大模型书籍，系统地介绍了大模型的基础知识和前沿技术。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95160ad390bb415c9483ca4b94686f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=yvAMXSPJNeQXvvTGi7Em5Xxnu0w%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这本书内容挺详实的，从传统统计语言模型到现代 Transformer 架构的演进过程。</p>
<p>而且还有 Prompt 工程、参数高效微调（PEFT）、模型编辑以及 RAG 等主题，是学习 LLM 理论与实践的绝佳资料。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ef1cb189d6425e913beaa970eb1a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=0p%2B9GWaCrYRyOHvkWQVeL9nOaO8%3D" alt="图片" loading="lazy"/></p>
<p>重点是每一章都配备了详细的论文列表，帮助你追踪相关领域的最新研究进展。</p>
<p>作者团队还说会进行月度更新，并积极听取开源社区的反馈修正谬误和补充新内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f44e0dc3488c4b5c98a95a80ef9a9937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=B%2BqbXGRitL7Ip7zWzGUrfJgomTw%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目很适合计算机相关专业的学生作为入门教材，也可以作为科研人员和工程师的参考手册。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/ZJU-LLMs/Foundations-of-LLMs</span>
</code></pre>
<h2 data-id="heading-3">04、claude-mem</h2>
<p>Claude-Mem 是一个 Claude Code 插件，解决长对话中失忆的问题。</p>
<p>随着编程会话的深入，上下文窗口往往会耗尽，导致 AI 忘记之前的决策或代码变更。</p>
<p>Claude-Mem 通过自动捕获所有的工具使用记录、生成语义摘要，并将关键上下文注入到未来的会话中，赋予了 Claude 持久的记忆力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ad0e4344e3445579a23d5e35fb6587b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=52Emh6eZq8GBNw7vbEZkR1DbgHY%3D" alt="图片" loading="lazy"/></p>
<p>这个项目的技术实现非常精妙，它结合了 SQLite 数据库和向量搜索（ChromaDB）。</p>
<p>你进行开发时，插件会在后台默默工作，将交互过程压缩并存储。当你开启新会话或询问过去的工作时，它能通过 mem-search 技能，利用关键词和语义检索快速找回相关的背景信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0012ef2691ca44f5ad713252056a8eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=u85PqoB7cYTIlETvi%2FFSIwd%2Bax0%3D" alt="图片" loading="lazy"/></p>
<p>这意味着即使你关闭终端甚至重启电脑，Claude 依然能记得上一次你们修了哪个 Bug 或讨论了哪种架构。</p>
<p>Claude-Mem 还引入了一个 Endless Mode，试图打破上下文长度的限制。</p>
<p>它通过实时压缩历史记录，将庞大的对话历史转化为精简的 Observations，从而在理论上支持无限长的编程会话。</p>
<p>这不仅节省了大量的 Token 成本，也极大地提升了处理大型重构任务时的连续性和准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3652b9a838b4f4bbe2850a82959ada4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=IVdTHKbkOwZy6nDdIMijyxvPHUE%3D" alt="图片" loading="lazy"/></p>
<p>如果想用一用，可以在终端中启动一个新的 Claude Code 会话，并输入以下命令就行了： </p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt;</span><span class="bash"> /plugin marketplace add thedotmack/claude-mem &gt; /plugin install claude-mem</span> 
</code></pre>
<p>重新启动 Claude Code。之前会话的上下文将会自动出现在新会话中。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/thedotmack/claude-mem</span>
</code></pre>
<h2 data-id="heading-4">05、ConvertX</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c81540b9fdb14f25a3349e757e556761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=MCEYkDWp1CfREhT%2BKwFxEwktoVY%3D" alt="图片" loading="lazy"/></p>
<p>ConvertX 是一个功能强大的在线文件转换工具，支持超过 1000 种不同格式之间的相互转换。</p>
<p>它的特点就是：私有、安全、免费开源。无论是图片、文档、电子书、音频还是视频，它都能处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002d61d02aae4a7587dcc4d0ee4242f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=h7TweEFDJjfjNiX29kKmpCXkYRI%3D" alt="图片" loading="lazy"/></p>
<p>基于 TypeScript 开发，使用了高效的 Bun 运行时和 Elysia 框架，后端集成了 FFmpeg、ImageMagick、LibreOffice 等众多工业级开源转换工具。</p>
<p>它的转换能力非常硬核，甚至支持矢量图处理、LaTeX 编译以及复杂的视频转码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ee17f122f84244bc99ee94c773bdec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=TpWJ3Z%2FYTb%2BMb1QoSRBes5bJ7fs%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>用户可以通过 Docker 轻松部署，且界面简洁现代，支持拖拽上传和批量处理。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/C4illin/ConvertX</span>
</code></pre>
<h2 data-id="heading-5">06、PowerShell 脚本</h2>
<p>Win11Debloat 是一个简单易用且轻量级的 PowerShell 脚本，帮助你净化和优化 Windows 10 及 Windows 11 系统。</p>
<p>GitHub 上已经斩获 36K 的 Star 了。</p>
<p>该脚本提供了一键式的解决方案，帮助用户移除臃肿软件，提升系统的运行速度和隐私安全性。</p>
<p>解决 Windows 预装大量推广应用、遥测追踪和广告的烦恼。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/032985f090c545f0a42844be6974e338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=kxMDTEiS9VmS9J4ggacgl7rsS4M%3D" alt="图片" loading="lazy"/></p>
<p>而且不需要记复杂的命令，只需运行脚本后根据屏幕提示选择相应的选项就行了。</p>
<p>它不仅能卸载预装的各种 App（如 Xbox、天气、新闻等），还能禁用遥测、移除 Bing 搜索集成、隐藏任务栏上的 Copilot 图标，甚至调整文件资源管理器的默认视图。</p>
<p>它有一个默认模式，可以根据大多数人的需求自动执行推荐的优化操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa5a46ce6c74a0486f8e3a899cdb0ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=B9ABo27wSbCLn6CU7402enAu%2BCk%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/Raphire/Win11Debloat</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）]]></title>    <link>https://juejin.cn/post/7586157459972472884</link>    <guid>https://juejin.cn/post/7586157459972472884</guid>    <pubDate>2025-12-22T05:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972472884" data-draft-id="7585410547337543730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-22T05:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:43:49.000Z" title="Mon Dec 22 2025 05:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面是一份 <strong>“可直接复制进项目用”的通用 Token 管理工具</strong>，<strong>逐行详细注释 + 完整使用示例 + 设计说明</strong>。<br/>
不依赖企业微信，<strong>任何第三方 Token 都能用</strong>。</p>
<p>我会按 <strong>「是什么 → 怎么用 → 为什么这样设计」</strong> 的顺序来讲，保证你以后回头看也能秒懂。</p>
<hr/>
<h2 data-id="heading-0">一、整体使用方式（先给你一个全景）</h2>
<p>你最终在业务代码里只需要这样用：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"wx:login"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(<span class="hljs-built_in">fetchTokenFromRemote</span>(), <span class="hljs-number">7200</span>)
);
</code></pre>
<p>你只关心两件事：</p>
<ol>
<li><strong>key 是什么</strong></li>
<li><strong>怎么获取新 token</strong></li>
</ol>
<p>其余全部交给 <code>TokenManager</code></p>
<hr/>
<h2 data-id="heading-1">二、核心接口与类（逐个讲）</h2>
<hr/>
<h3 data-id="heading-2">1️⃣ AccessToken 接口（Token 抽象）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 通用 AccessToken 抽象
 *
 * 代表“一个有生命周期的 token”
 * 不关心 token 从哪里来
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">AccessToken</span> {

    <span class="hljs-comment">/**
     * @return 实际可用于请求的 token 字符串
     */</span>
    <span class="hljs-function">String <span class="hljs-title">getToken</span>()</span>;

    <span class="hljs-comment">/**
     * @return 当前 token 是否已过期
     */</span>
    <span class="hljs-function">boolean <span class="hljs-title">isExpired</span>()</span>;
}
</code></pre>
<h4 data-id="heading-3">设计目的</h4>
<ul>
<li>解耦平台</li>
<li>JWT / OAuth / 内部 token 都可以实现它</li>
</ul>
<hr/>
<h3 data-id="heading-4">2️⃣ DefaultAccessToken（默认实现）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 默认 Token 实现
 *
 * 使用“绝对过期时间”判断是否失效
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultAccessToken</span> implements AccessToken {

    <span class="hljs-comment">/** token 字符串 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> token;

    <span class="hljs-comment">/** token 过期时间点（毫秒时间戳） */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> expireAt;

    <span class="hljs-comment">/**
     * @param token              token 字符串
     * @param expiresInSeconds   过期秒数（通常接口返回）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultAccessToken</span><span class="hljs-params">(<span class="hljs-type">String</span> token, <span class="hljs-type">long</span> expiresInSeconds)</span> </span>{
        <span class="hljs-keyword">this</span>.token = token;
        <span class="hljs-comment">// 提前 5 分钟过期，避免临界失效</span>
        <span class="hljs-keyword">this</span>.expireAt = System.<span class="hljs-built_in">currentTimeMillis</span>()
                + (expiresInSeconds - <span class="hljs-number">300</span>) * <span class="hljs-number">1000</span>;
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getToken</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> token;
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">isExpired</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> System.<span class="hljs-built_in">currentTimeMillis</span>() &gt;= expireAt;
    }
}
</code></pre>
<h4 data-id="heading-5">为什么要提前 5 分钟过期？</h4>
<ul>
<li>
<p>防止：</p>
<ul>
<li>网络延迟</li>
<li>服务器时间偏差</li>
<li>请求刚发出 token 就失效</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">3️⃣ TokenProvider（获取 Token 的策略）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * Token 提供器
 *
 * 由业务方实现“如何获取一个新的 token”
 */</span>
@FunctionalInterface
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">TokenProvider</span> {

    <span class="hljs-comment">/**
     * 获取新的 token
     *
     * @return 新的 AccessToken
     */</span>
    <span class="hljs-function">AccessToken <span class="hljs-title">refresh</span>()</span>;
}
</code></pre>
<h4 data-id="heading-7">为什么用接口？</h4>
<ul>
<li>
<p>TokenManager 不依赖任何 SDK / HTTP / 平台</p>
</li>
<li>
<p>你可以：</p>
<ul>
<li>HTTP 调用</li>
<li>SDK 调用</li>
<li>数据库</li>
<li>本地生成</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">4️⃣ TokenManager（核心）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenManager</span> {

    <span class="hljs-comment">/** token 缓存池 */</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">AccessToken</span>&gt; tokenCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/** 每个 key 一把锁，避免并发刷新 */</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; lockMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取 token（通用方法）
     *
     * <span class="hljs-doctag">@param</span> key           token 唯一标识（非常重要）
     * <span class="hljs-doctag">@param</span> tokenProvider token 刷新逻辑
     * <span class="hljs-doctag">@return</span> 可用 token 字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, TokenProvider tokenProvider</span>) {
        <span class="hljs-title class_">AccessToken</span> token = tokenCache.<span class="hljs-title function_">get</span>(key);

        <span class="hljs-comment">// token 不存在 或 已过期</span>
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || token.<span class="hljs-title function_">isExpired</span>()) {

            <span class="hljs-comment">// 每个 key 独立一把锁</span>
            <span class="hljs-title class_">Object</span> lock = lockMap.<span class="hljs-title function_">computeIfAbsent</span>(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>());

            synchronized (lock) {
                <span class="hljs-comment">// 双重检查，防止重复刷新</span>
                token = tokenCache.<span class="hljs-title function_">get</span>(key);
                <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || token.<span class="hljs-title function_">isExpired</span>()) {
                    token = tokenProvider.<span class="hljs-title function_">refresh</span>();
                    tokenCache.<span class="hljs-title function_">put</span>(key, token);
                }
            }
        }
        <span class="hljs-keyword">return</span> token.<span class="hljs-title function_">getToken</span>();
    }

    <span class="hljs-comment">/**
     * 主动清除 token（例如配置变更）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">invalidate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        tokenCache.<span class="hljs-title function_">remove</span>(key);
        lockMap.<span class="hljs-title function_">remove</span>(key);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-9">三、详细使用示例（你照抄就能用）</h2>
<hr/>
<h3 data-id="heading-10">示例 1️⃣：第三方 OAuth Token（通用）</h3>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">token</span> = tokenManager.getToken(
    "oauth:system",
    () -&gt; {
        OAuthDTO <span class="hljs-attr">dto</span> = oauthClient.getToken()<span class="hljs-comment">;</span>
        return new DefaultAccessToken(dto.getToken(), dto.getExpireIn())<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">示例 2️⃣：企业微信 / 钉钉 / 飞书（完全通用）</h3>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">token</span> = tokenManager.getToken(
    "wx:addressBook",
    () -&gt; {
        WxTokenDTO <span class="hljs-attr">dto</span> = callWxTokenApi()<span class="hljs-comment">;</span>
        return new DefaultAccessToken(dto.getAccess_token(), dto.getExpires_in())<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">示例 3️⃣：JWT（本地生成）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"jwt:internal"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(jwtService.<span class="hljs-built_in">generate</span>(), <span class="hljs-number">3600</span>)
);
</code></pre>
<hr/>
<h3 data-id="heading-13">示例 4️⃣：自研系统登录</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"internal:api"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(<span class="hljs-built_in">loginAndGetToken</span>(), <span class="hljs-number">7200</span>)
);
</code></pre>
<hr/>
<h2 data-id="heading-14">四、key 的设计规范（非常重要）</h2>
<h4 data-id="heading-15">推荐格式：</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">平台:用途</span>
</code></pre>
<p>例如：</p>
<ul>
<li><code>wx:login</code></li>
<li><code>wx:user</code></li>
<li><code>ding:token</code></li>
<li><code>aliyun:ram</code></li>
<li><code>internal:api</code></li>
</ul>
<p>❌ 不推荐：</p>
<ul>
<li>使用 corpSecret</li>
<li>使用 URL</li>
<li>使用随机字符串</li>
</ul>
<hr/>
<h2 data-id="heading-16">五、常见问题（你以后一定会遇到）</h2>
<h4 data-id="heading-17">Q1：多个线程同时获取 token 会不会重复请求？</h4>
<p>👉 不会</p>
<ul>
<li>每个 key 独立锁</li>
<li>双重检查</li>
</ul>
<hr/>
<h4 data-id="heading-18">Q2：token 过期了会不会阻塞请求？</h4>
<p>👉 只会阻塞 <strong>第一次刷新</strong></p>
<ul>
<li>其余线程复用新 token</li>
</ul>
<hr/>
<h4 data-id="heading-19">Q3：能不能换成 Redis？</h4>
<p>👉 可以，而且 <strong>不用改使用方式</strong></p>
<p>只需替换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">AccessToken</span>&gt; tokenCache
</code></pre>
<hr/>
<h2 data-id="heading-20">六、推荐的项目结构</h2>
<pre><code class="hljs language-markdown" lang="markdown">infrastructure/
 └── token/
<span class="hljs-code">     ├── AccessToken.java
     ├── DefaultAccessToken.java
     ├── TokenProvider.java
     └── TokenManager.java
</span></code></pre>
<hr/>
<h2 data-id="heading-21">七、设计总结（你可以写进技术文档）</h2>
<blockquote>
<p>TokenManager 负责：</p>
<ul>
<li>缓存</li>
<li>过期判断</li>
<li>并发控制</li>
</ul>
<p>TokenProvider 负责：</p>
<ul>
<li>如何获取 token</li>
</ul>
<p>二者解耦，支持任意平台、任意 Token 类型。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发编程里的"堵车"与"红绿灯"：死锁、活锁与两种锁策略（乐观锁、悲观锁）]]></title>    <link>https://juejin.cn/post/7585866811717976091</link>    <guid>https://juejin.cn/post/7585866811717976091</guid>    <pubDate>2025-12-22T05:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585866811717976091" data-draft-id="7585920796100886555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发编程里的&quot;堵车&quot;与&quot;红绿灯&quot;：死锁、活锁与两种锁策略（乐观锁、悲观锁）"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-22T05:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发编程里的"堵车"与"红绿灯"：死锁、活锁与两种锁策略（乐观锁、悲观锁）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:59:13.000Z" title="Mon Dec 22 2025 05:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>搞后端或者数据库开发，永远绕不开"资源争抢"这个问题。</p>
<p>今天把这几个老生常谈的概念——<strong>死锁、活锁、悲观锁、乐观锁</strong>，放在一起捋一捋。前两个是"事故现场"，后两个是"交通规则"。一起学习一下</p>
<hr/>
<h2 data-id="heading-0">一、 事故现场：当线程打起来了</h2>
<h3 data-id="heading-1">1. 死锁 (Deadlock)：互不相让</h3>
<p>这是最常见的"事故"。说白了就是：<strong>也就是你也动不了，我也动不了，大家都耗着。</strong></p>
<p><strong>真实场景</strong>： 你有两个资源：<code>OrderTable</code>（订单表）和 <code>StockTable</code>（库存表）。</p>
<ul>
<li>线程 A：锁住了 <code>OrderTable</code>，准备去扣减 <code>StockTable</code>。</li>
<li>线程 B：锁住了 <code>StockTable</code>，准备去写入 <code>OrderTable</code>。</li>
</ul>
<p>结果就是：A 拿着 B 想要的东西，B 拿着 A 想要的东西，谁都不撒手。</p>
<p><strong>代码模拟（伪代码）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误的加锁顺序导致死锁</span>
​
<span class="hljs-comment">// 线程 1</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">transactionA</span>()</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Order'</span>); <span class="hljs-comment">// 拿到了 Order 锁</span>
  <span class="hljs-keyword">await</span> sleep(<span class="hljs-number">100</span>);    <span class="hljs-comment">// 稍微慢一点，等线程 2 锁住 Stock</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Stock'</span>); <span class="hljs-comment">// 此时卡住，因为 Stock 被线程 2 锁了</span>
}
​
<span class="hljs-comment">// 线程 2</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">transactionB</span>()</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Stock'</span>); <span class="hljs-comment">// 拿到了 Stock 锁</span>
  <span class="hljs-keyword">await</span> sleep(<span class="hljs-number">100</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Order'</span>); <span class="hljs-comment">// 此时卡住，因为 Order 被线程 1 锁了</span>
}
</code></pre>
<p><strong>怎么解？</strong> 最简单的解法是<strong>定规矩</strong>：所有人必须按照<strong>相同的顺序</strong>拿锁。比如规定"必须先拿 Order 再拿 Stock"，死锁瞬间就解了。</p>
<h3 data-id="heading-2">2. 活锁 (Livelock)：过分礼让</h3>
<p>活锁比较隐蔽，它不会卡死，但就是干不成事。</p>
<p><strong>真实场景</strong>： 两人在走廊迎面相遇。</p>
<ul>
<li>你往左躲，他也往左躲（撞）。</li>
<li>你赶紧往右躲，他也往右躲（又撞）。</li>
<li>你们俩一直在动，CPU 也就是一直在忙（出汗了），但谁也没过去。</li>
</ul>
<p><strong>代码里的表现</strong>： 通常发生在处理消息队列或者重试机制里。 比如一个任务处理失败了，系统立刻重试，又失败，又立刻重试... 资源一直在消耗，日志一直在打，但任务永远处于"处理中"。</p>
<p><strong>怎么解？</strong> 引入<strong>随机性</strong>。以太网的"指数退避算法"就是这个原理：撞了之后，不要立刻重试，你等 10ms，我等 50ms，错峰出行。</p>
<hr/>
<h2 data-id="heading-3">二、 交通规则：怎么防止出事故？</h2>
<p>为了防止上面那种乱套的情况，我们需要锁。根据"心态"的不同，分成了<strong>悲观</strong>和<strong>乐观</strong>两派。</p>
<h3 data-id="heading-4">1. 悲观锁 (Pessimistic Locking)</h3>
<p><strong>心态</strong>："这世界坏人多，总有人想抢我的数据。也就是我操作的时候，谁也别想动！"</p>
<p><strong>做法</strong>： 在查数据的时候，直接把数据锁死，直到我提交事务，别人才能查或改。</p>
<h3 data-id="heading-5">2. 乐观锁 (Optimistic Locking)</h3>
<p><strong>心态</strong>："这世界还是好人多，大部分时候没人跟我抢。我就先跑着，最后检查一下就行。"</p>
<p><strong>做法</strong>： 我不锁数据，大家都随便读、随便改。但是！我在更新的那一瞬间，会检查一下： <strong>"这数据自从我读走之后，有没有被人改过？"</strong></p>
<p><strong>实现方式（CAS / 版本号）</strong> ： 给表加一个 <code>version</code> 字段。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 先查出来，假设拿到 <span class="hljs-attr">version</span> = <span class="hljs-number">1</span>
SELECT id, stock, version FROM goods WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
​
-- 2. 内存里计算 stock - 1
​
-- 3. 更新时，带上版本号做条件
UPDATE goods 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span> AND version = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
-- 关键在这里！如果 version 已经被别人改成 2 了，这条 SQL 影响行数就是 0，更新失败。
</code></pre>
<ul>
<li><strong>优点</strong>：快！没有锁等待，大家都能读，并发能力强。</li>
<li><strong>缺点</strong>：如果竞争真的很激烈（比如抢火车票），会一直失败重试，CPU 可能会飙高。</li>
</ul>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！]]></title>    <link>https://juejin.cn/post/7586301866910416947</link>    <guid>https://juejin.cn/post/7586301866910416947</guid>    <pubDate>2025-12-22T05:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586301866910416947" data-draft-id="7585897699603775514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！"/> <meta itemprop="keywords" content="Gemini,AIGC,Google"/> <meta itemprop="datePublished" content="2025-12-22T05:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:59:45.000Z" title="Mon Dec 22 2025 05:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽大家好，我是后端小肥肠！<strong>谷歌憋了大半年的大招终于藏不住了！</strong> 今天带大家揭秘这个被低估的神器——<strong>Opal</strong>。别再纠结复杂的 Python 脚本了，看我如何调用 <strong>Gemini 3 Pro</strong>，用<strong>5分钟</strong>、<strong>一句话</strong>，把枯燥的小说文本直接变成可视化的漫剧分镜图片！</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>上周六我基于 Coze 编程发布了文章<a href="https://juejin.cn/post/7585463258690600969" target="_blank" title="https://juejin.cn/post/7585463258690600969">Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！</a>，后台反响特别热烈，看来大家对<strong>小说可视化</strong>这个方向真的刚需。<strong>昨天逛 B 站的时候</strong>，偶然刷到一位技术圈大佬分享了谷歌的神器——<strong>Opal</strong>。大佬在视频里演示的效果直接给我看愣了：居然也可以<strong>一句话生成</strong> <strong>工作流</strong>？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a8b0320d0c4e9db24963f657100841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=ZNIBPcJyP%2FwzDbAKwkQ%2Fr4KmtwU%3D" alt="" loading="lazy"/></p>
<p><strong>出于技术人的敏感，我立马去扒了一下它的背景：原来这玩意儿 Google 早在今年 7 月就发布了，只是当时比较低调。 但最近随着 AI 能力的迭代，它又在开发者圈子里火了一把。什么是 Opal？ 简单来说，Opal 是谷歌推出的可视化应用构建平台。它最大的噱头就是 "Prompt to App" ——你不需要拖拽复杂的节点，只需像聊天一样说出需求，它就能自动生成包含后端逻辑和前端界面的完整应用。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/249f817b1b6844a9916c66d912833e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=ecumRDo%2B8plbWsA1yW%2FACgZPuT0%3D" alt="" loading="lazy"/></p>
<p>更厉害的是，Opal 可以调用谷歌家一众神仙模型，包括语言模型 <strong>Gemini 2.5 Flash、Gemini 2.5 Pro、Gemini 3 Pro</strong>，图像生成模型 <strong>Imagen 4、Gemini 2.5 Flash Image (Nano Banana)、Gemini 3 Pro Image (Nano Banana)</strong> ，还有音频模型 <strong>AudioLM</strong>，视频模型 <strong>Veo</strong>，以及音乐模型 <strong>Lyria 2</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6335e3c05d52419eb1457b42f52e7773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=nu50xvZWw7cgWSrJYALV5yYiR3I%3D" alt="" loading="lazy"/></p>
<p><strong>今天，我就用opal，把周六的小说转漫剧分镜图流程重新跑一遍，看看它到底有多强！文章结尾送</strong> <strong>工作流</strong> <strong>还送原件哦~</strong></p>
<h2 data-id="heading-1">2. 工作流构建</h2>
<p>工作流的构建非常简单，全程只需要5分钟。输入网址<a href="https://link.juejin.cn?target=https%3A%2F%2Fopal.google%2F" target="_blank" title="https://opal.google/" ref="nofollow noopener noreferrer">opal.google/</a> ，来到opal界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff39bba35c3b416ea16457bbb0a3fd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=E3L0lLzALgmGnEa7qKiAZr4C0Ho%3D" alt="" loading="lazy"/></p>
<p>点击右上角的【+Create New】按钮，跳转至构造工作流界面，在下方对话会输入你的构建需求点击【发送】按钮，等等几分钟就能完成工作流构建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51ac9d2a3a54bd49497b2e6fc30f657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=S1g%2F6jw6s4V%2B7rJMCi8gQE%2F2pC8%3D" alt="" loading="lazy"/></p>
<p>我输入的构建需求：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 理解小说内容转换为短剧剧本
<span class="hljs-bullet">2.</span> 提取短剧剧本中的角色信息，生成角色构造信息
<span class="hljs-bullet">3.</span> 基于短剧剧本进行分镜，生成每个分镜的文生图提示词
<span class="hljs-bullet">4.</span> 基于分镜文生图提示词和角色信息调用生图工具进行生图
<span class="hljs-bullet">5.</span> 基于html界面展示图片与分镜信息
</code></pre>
<p>等待几分钟完整工作流就完整呈现在了面板中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2cb0179bdd841daa9a4d2cf6feba184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=FCWm4pbfDch688qWGJU1KArGguI%3D" alt="" loading="lazy"/></p>
<p>点击【Preview】来到工作流试运行界面，点击【Start】按钮后在底部的对话框输出小说内容，建议按照章节输入。我输入的是之前工作流生产的末日系列小说的第一章：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/315be7fe24544491a2e8f5d278bbb66c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=Q3wL6%2Fn3W9QX%2Fe%2BJ8zLXk%2BChJmU%3D" alt="" loading="lazy"/></p>
<p><strong>工作流</strong> <strong>文章指引：</strong> <a href="https://juejin.cn/post/7582561515816484927" target="_blank" title="https://juejin.cn/post/7582561515816484927">突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b633cc710edf4d6585772a545463ba45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=EdTFGc%2FzXaSnF6DDXt%2B6uVVIpgo%3D" alt="" loading="lazy"/></p>
<p>等待几分钟就可以看到分镜图片的结果展示在了右边工具栏中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96c0a807608a4eacad0ec79d2d798499~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=PZRTtiMwObJgUOH59qq5hVUxA0U%3D" alt="" loading="lazy"/></p>
<p><strong>需要了解我分镜图片细节和查看</strong> <strong>工作流</strong> <strong>原件的朋友可以访问链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fopal.google%2F%3Fflow%3Ddrive%3A%2F1w_SSuWfwSz7UG4fPWiwS9x4GDGQIX9nf%26shared%26results%3D1nO3cFHVYWNp7Wxqk5jRMJEAg4s3nwzVu%26mode%3Dapp" target="_blank" title="https://opal.google/?flow=drive:/1w_SSuWfwSz7UG4fPWiwS9x4GDGQIX9nf&amp;shared&amp;results=1nO3cFHVYWNp7Wxqk5jRMJEAg4s3nwzVu&amp;mode=app" ref="nofollow noopener noreferrer">opal.google/?flow=drive…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f04d29fa1d04b4bb1655b9b9aed70ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=pn5ajCNouR6SyXtvMpMdC0ki%2Fmg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 结语</h2>
<p>今天的实战就到这里。通过 Google Opal，我们只用了几分钟的时间，仅仅通过自然语言的描述，就构建出了一个包含<strong>剧情理解-角色提取-分镜绘制-网页展示</strong>的完整应用。</p>
<p>看着文字小说在网页上实时变身成一幅幅生动的分镜图，这种<strong>所想即所得</strong>的体验确实令人印象深刻。对于我们创作者而言，这意味着技术门槛正在无限降低——你不需要懂代码，也不需要精通复杂的各种软件，只要你有好的故事和创意，现在的 AI 工具就能帮你把想象变成现实。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede5875ec7464b7d94b2c0ec4aa5c4b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=8rUcouqzG60nz67nYFqA1Ay5vNc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️]]></title>    <link>https://juejin.cn/post/7585897699603693594</link>    <guid>https://juejin.cn/post/7585897699603693594</guid>    <pubDate>2025-12-22T04:03:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603693594" data-draft-id="7586136543954632742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2025-12-22T04:03:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:03:34.000Z" title="Mon Dec 22 2025 04:03:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好😁。</p>
<p>上上周，我们在例会上送别了团队里的一位技术大牛，阿K。</p>
<p>说实话，阿K 的技术底子很强。他能手写 Webpack 插件，熟读 ECMA 规范，对 Chrome 的渲染管线了如指掌。</p>
<p>但最终，CTO 还是决定劝退他了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7672acbb864ef1ae09c60dd7b20838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981014&amp;x-signature=054la%2BeYJnC0QPIt8VTi%2FOqNCfs%3D" alt="Suggestion.gif" loading="lazy"/></p>
<p>理由很残酷，只有一句话： <strong>你的代码，团队里没人敢接手。🤷‍♂️</strong></p>
<p><strong>为了所谓的极致性能，牺牲代码的可读性，到底值不值？</strong></p>
<hr/>
<h4 data-id="heading-0"><strong>事件的开始</strong></h4>
<p>我们有一个很普通的后台管理系统重构。</p>
<p>阿K 负责最核心的权限校验模块。这本是一个很简单的逻辑：后端返回一个权限列表，前端判断一下用户有没有某个按钮的权限。</p>
<p>普通人（比如我）大概会这么写：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 一眼就能看懂</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">hasPermission</span> = (<span class="hljs-params">userPermissions, requiredPermission</span>) =&gt; {
  <span class="hljs-keyword">return</span> userPermissions.<span class="hljs-title function_">includes</span>(requiredPermission);
};

<span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasPermission</span>(currentUser.<span class="hljs-property">permissions</span>, <span class="hljs-string">'DELETE_USER'</span>)) {
  <span class="hljs-title function_">showDeleteButton</span>();
}
</code></pre>
<p>但是，阿K 看到这段代码时，露出了鄙夷的神情😒。</p>
<p><strong>includes 这种遍历操作太慢了！我们要处理的是十万级的用户并发（并没有），必须优化！</strong></p>
<p>于是，他闭关三天，重写了整个模块。</p>
<p>Code Review 的时候，我们所有人都傻了。屏幕上出现了一堆我们看不懂的天书😖：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 全程位运算，没有任何注释</span>
<span class="hljs-keyword">const</span> P = { <span class="hljs-attr">r</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">e</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">8</span> }; 
<span class="hljs-keyword">const</span> <span class="hljs-title function_">_c</span> = (<span class="hljs-params">u, p</span>) =&gt; (u &amp; p) === p;

<span class="hljs-comment">// 这里甚至用了一个位移掩码生成的哈希表</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">_m</span> = (<span class="hljs-params">l</span>) =&gt; l.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, c</span>) =&gt;</span> a | (P[c] || <span class="hljs-number">0</span>), <span class="hljs-number">0</span>);

<span class="hljs-comment">// 像不像一段乱码？</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">chk</span> = (<span class="hljs-params">u, r</span>) =&gt; <span class="hljs-title function_">_c</span>(<span class="hljs-title function_">_m</span>(u.<span class="hljs-property">r</span>), P[r]);
</code></pre>
<p>我问他：阿K，这 <code>_c</code> 和 <code>_m</code> 是啥意思？能加个注释吗？</p>
<p>阿K 振振有词： <strong>好的代码不需要注释！位运算是计算机执行最快的操作，比字符串比对快几百倍！这不仅仅是代码，这是对 CPU 的尊重，是艺术！</strong></p>
<p>我： <strong>。 。 。 。🤣</strong></p>
<p>在那个没有性能瓶颈的后台管理系统里，他为了那肉眼不可见的 0.0001 毫秒提升，制造了一个维护麻烦。</p>
<hr/>
<h4 data-id="heading-1"><strong>屎山💩崩溃的那一天</strong></h4>
<p>灾难发生在两个月后。</p>
<p>业务方突然提了一个需求： <strong>权限逻辑要改，现在支持‘反向排除’权限，而且权限字段要从数字改成字符串组。</strong></p>
<p>那天，阿K 正好去年假了，手机关机😒。</p>
<p>任务落到了刚入职的实习生小李头上。</p>
<p>小李打开 <code>permission.js</code>，看着满屏的 <code>&gt;&gt;</code>、<code>&amp;</code>、<code>|</code> 和单字母变量，整个人僵在了工位上。</p>
<p>他试图去理解那个位移掩码的逻辑，但他发现，只要改动一个字符，整个系统的权限就全乱套了——管理员突然看不了页面，实习生突然能删库了🤔。</p>
<p><strong>这代码有毒吧……</strong> 小李在第 10 次尝试修复失败后，差点哭出来😭。</p>
<p>因为这个模块的逻辑过于晦涩，且和其他模块高度耦合（阿K 为了复用，把这些位运算逻辑注入到了全局原型链里），我们根本不敢动。</p>
<p>结果是：<strong>那个简单的需求，被硬生生拖了一周。</strong> 业务方投诉到了 CTO 那里。</p>
<p>CTO 看了眼代码，沉默了三分钟，然后问了一句：</p>
<p>写这玩意儿的人，是觉得以后都不用维护了吗？😥</p>
<hr/>
<h4 data-id="heading-2"><strong>过早优化是万恶之源 !</strong></h4>
<p>阿K 回来后，很不服气。他觉得是我们技术太菜，看不懂他的高级操作。</p>
<p>他拿出了 Chrome Profiler 的截图，指着那微乎其微的差距说：看！我的写法比你们快了 40%！</p>
<p>但他忽略了软件工程中最重要的一条公式：</p>
<blockquote>
<p><strong>代码价值 = (实现功能 + 可维护性) / 复杂度</strong></p>
</blockquote>
<p><strong>过早优化是万恶之源 ! ! !</strong></p>
<p>在 99% 的业务场景下，V8 引擎已经足够快了。</p>
<ul>
<li>你把 <code>forEach</code> 改成 <code>while</code> 倒序循环，性能确实提升了，但代码变得难读了。</li>
<li>你把清晰的 <code>switch-case</code> 改成了晦涩的 <code>lookup table</code> 还没有类型提示，Bug 率上升了。</li>
<li>你为了省几个字节的内存，用各种黑魔法操作对象，导致后来的人根本不敢碰😖。</li>
</ul>
<p><strong>这种所谓的性能优化，其实是程序员的自嗨。</strong></p>
<p>它是用<strong>团队的维护成本</strong>，去换取<strong>机器那一瞬间的快感</strong>。它不是优化，它是给项目埋雷。</p>
<hr/>
<h4 data-id="heading-3"><strong>什么样的代码才是好代码？</strong></h4>
<p>后来，我们将阿K 的那坨代码 通过 chatGPT 全部推倒重写。</p>
<p>1️⃣ 权限定义（语义清晰）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// permissions.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Permission</span> {
  <span class="hljs-variable constant_">READ</span> = <span class="hljs-string">'read'</span>,
  <span class="hljs-variable constant_">WRITE</span> = <span class="hljs-string">'write'</span>,
  <span class="hljs-variable constant_">EDIT</span> = <span class="hljs-string">'edit'</span>,
  <span class="hljs-variable constant_">DELETE</span> = <span class="hljs-string">'delete'</span>,
}
</code></pre>
<p>2️⃣ 用户模型</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// user.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Permission</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./permissions'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">permissions</span>: <span class="hljs-title class_">Permission</span>[];
}

</code></pre>
<p>3️⃣ 权限校验函数（核心）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// auth.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Permission</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./permissions'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasPermission</span>(<span class="hljs-params">
  user: User,
  required: Permission
</span>): boolean {
  <span class="hljs-keyword">return</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(required);
}

</code></pre>
<p>4️⃣ 批量权限校验</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAllPermissions</span>(<span class="hljs-params">
  user: User,
  required: Permission[]
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> required.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(p));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAnyPermission</span>(<span class="hljs-params">
  user: User,
  required: Permission[]
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> required.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(p));
}

</code></pre>
<p>5️⃣ 判断方法</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasPermission</span>(user, <span class="hljs-title class_">Permission</span>.<span class="hljs-property">DELETE</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'No permission to delete'</span>);
}
</code></pre>
<p>用回了用户权限结构清晰可见的，权限判断，一眼就懂。甚至都不需要注释🤷‍♂️</p>
<p>虽然跑分慢了那么一丁点（用户根本无感知），但任何一个新来的同事，只要 5 分钟就能看懂并上手修改。</p>
<p>这件事给我留下了深刻的教训：</p>
<ol>
<li>
<p>代码是写给人看的，顺便给机器运行。</p>
<p>如果一段代码只有你现在能看懂，那它就是垃圾代码；如果一段代码连你一个月后都看不懂，那它就是有害代码。</p>
</li>
<li>
<p>不要在非瓶颈处炫技。</p>
<p>如果页面卡顿是因为 DOM 节点太多，你去优化 JS 的变量赋值速度，那就是隔靴搔痒。找到真正的瓶颈（Network, Layout, Paint），再对症下药。</p>
</li>
<li>
<p>可读性 &gt; 巧技。</p>
<p>简单的逻辑，是对同事最大的善意。</p>
</li>
</ol>
<hr/>
<p>阿K 走的时候，还是觉得自己怀才不遇，觉得这家公司配不上他的技术🤣。</p>
<p>我祝他未来前程似锦。</p>
<p>但我更希望看到这篇文章的你，下次在想要按下键盘写一段绝妙的、只有你看懂的单行代码时，能停下来想一想：</p>
<p><strong>如果明天我离职了，接手的人会不会骂娘？</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/946390729f864eefab5bc9c87661f25a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981014&amp;x-signature=ZW21Xm6N1gqLt9uV5DQARa2U1XQ%3D" alt="你是脑残么.gif" loading="lazy"/></p>
<p><strong>毕竟，我们不想让亲妈都不认识代码，我们更不想让同事在那骂娘。</strong></p>
<p>谢谢大家👏</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[canvas.rotate(rotation); 到底是往哪个方向转动]]></title>    <link>https://juejin.cn/post/7586509410567733289</link>    <guid>https://juejin.cn/post/7586509410567733289</guid>    <pubDate>2025-12-22T04:09:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567733289" data-draft-id="7586136543954780198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" canvas.rotate(rotation); 到底是往哪个方向转动"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T04:09:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             canvas.rotate(rotation); 到底是往哪个方向转动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:09:03.000Z" title="Mon Dec 22 2025 04:09:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1d157c31b243bca94a14ccdfb24ab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=WES6egmMg0OPkJR7b519kOgFgCQ%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748f551b923f4cbea15db69632e5fc7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=mipmL62Xy%2BAOlz%2FwEqyL0mnqnoQ%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2109f15d2b44b65835f654bc8509dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=TFCV4NKDU9CCJw91ihwMfzvy1Bs%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00456e3c3c054db18633506fe29b2ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=ynsvmkj7GID6i542CRSgfz3CCGw%3D" alt="image.png" width="30%" loading="lazy"/>
<p>上面的四张图 就是x y轴在不同方向的时候 旋转方向的示意图。我们可以发现都是x轴向y轴方向旋转。</p>
<p>这个有什么用？主要就是为了纠正有时候 我们认为旋转总应该是顺时针的错觉。比如第一张图是正常的画布的坐标系,我们正常旋转画布也是按这个方向旋转，但是如果我们执行了 scale(1,-1),画布就会变成第三张图，再旋转 pi/4，就是反方向旋转了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f47c39a65e647369340c126e22c0ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=FiIZoFfkG6MF7kQ4Z2%2FtXWadJtw%3D" alt="image.png" loading="lazy"/></p>
<p>这是一个旋转了指定角度的矩形，我现在想绘制一个跟这个矩形在水平方向对称的图形，应该怎么画?。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术]]></title>    <link>https://juejin.cn/post/7586237019987902464</link>    <guid>https://juejin.cn/post/7586237019987902464</guid>    <pubDate>2025-12-22T04:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586237019987902464" data-draft-id="7586208617603694626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-22T04:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:20:09.000Z" title="Mon Dec 22 2025 04:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为一款高性能的内存数据库，已成为现代分布式系统中的核心组件。其丰富的数据结构、超高的吞吐量以及灵活的扩展能力，使其在缓存、会话管理、排行榜等场景中表现出色。然而，在实际应用中，许多开发者仅停留在基础使用层面，未能充分发挥Redis的潜力。本文将深入剖析Redis的5种高频使用场景，并结合得物技术的实战经验，从架构设计到性能优化进行全面解析。</p>
<hr/>
<h2 data-id="heading-2">一、Redis核心优势回顾</h2>
<p>在深入具体场景之前，我们先简要回顾Redis的核心特性：</p>
<ol>
<li><strong>亚毫秒级响应</strong>：内存存储+单线程模型带来极致性能</li>
<li><strong>丰富的数据结构</strong>：String/Hash/List/Set/ZSet等多样化选择</li>
<li><strong>持久化机制</strong>：RDB快照与AOF日志双重保障</li>
<li><strong>高可用架构</strong>：Sentinel和Cluster方案成熟</li>
<li><strong>原子操作</strong>：Lua脚本支持复杂事务</li>
</ol>
<p>这些特性使Redis能在特定场景下替代传统关系型数据库的部分功能。</p>
<hr/>
<h2 data-id="heading-3">二、五大高频使用场景深度解析</h2>
<h3 data-id="heading-4">场景1：缓存加速——电商商品详情页实践</h3>
<h4 data-id="heading-5">典型架构</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 客户端请求 → Nginx → 
<span class="hljs-bullet">2.</span> 查询Redis → 
<span class="hljs-bullet">3.</span> 未命中时回源数据库 →
<span class="hljs-bullet">4.</span> 异步更新缓存（Cache-Aside模式）
</code></pre>
<h4 data-id="heading-6">得物技术实践：</h4>
<ul>
<li><strong>多级Key设计</strong>：<code>product:{id}:base_info</code> + <code>product:{id}:ext_info</code></li>
<li><strong>热点探测</strong>：通过<code>redis-cli --hotkeys</code>识别并特殊处理热Key</li>
<li><strong>一致性保障</strong>：
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本保证原子性删除</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"get"</span>,KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">"del"</span>,KEYS[<span class="hljs-number">1</span>])
<span class="hljs-keyword">end</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-7">性能优化点：</h4>
<ul>
<li>Value大小控制在10KB以内（避免网络传输瓶颈）</li>
<li>Pipeline批量读取降低RTT影响</li>
<li>TTL采用随机过期防止缓存雪崩</li>
</ul>
<h3 data-id="heading-8">场景2：分布式锁——秒杀系统实现方案</h3>
<h4 data-id="heading-9">Redlock算法要点：</h4>
<ol>
<li>获取当前毫秒时间戳T1</li>
<li>顺序向N个节点请求加锁（SET key random_value NX PX）</li>
<li>当获得(N/2)+1个成功响应时计算耗时T2-T1</li>
<li>T2-T1 &lt; 锁有效期时才视为成功</li>
</ol>
<h4 data-id="heading-10">Java实现示例：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(JedisPool[] pools, String lockName, <span class="hljs-type">long</span> expireTime)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">identifier</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
    <span class="hljs-type">int</span> <span class="hljs-variable">lockedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (JedisPool pool : pools) {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource()) {
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"OK"</span>.equals(jedis.set(lockName, identifier, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"PX"</span>, expireTime))) {
                lockedCount++;
            }
        }
    }
    <span class="hljs-keyword">return</span> lockedCount &gt;= pools.length/<span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
}
</code></pre>
<h4 data-id="heading-11">CAP权衡建议：</h4>
<ul>
<li>CP系统首选Redlock（如库存扣减）</li>
<li>AP系统可考虑乐观锁（如点赞计数）</li>
</ul>
<h3 data-id="heading-12">场景3：实时排行榜——运动社区榜单设计</h3>
<h4 data-id="heading-13">ZSet最佳实践：</h4>
<pre><code class="hljs language-bash" lang="bash">ZADD leaderboard timestamp_score user_id   <span class="hljs-comment"># timestamp保证同分有序性</span>
ZREVRANGE leaderboard 0 topN WITHSCORES     <span class="hljs-comment"># TOPN查询</span>
ZSCORE leaderboard user_id                  <span class="hljs-comment">#个人排名查询  </span>
</code></pre>
<h4 data-id="heading-14">GC压力优化：</h4>
<p>对于海量用户（如&gt;1000万）：</p>
<ol>
<li>Sharding策略：按uid哈希分片存储</li>
<li>Cold-Hot分离：活跃用户单独ZSet存储</li>
</ol>
<h3 data-id="heading-15">场景4：消息队列——物流状态变更通知</h3>
<h4 data-id="heading-16">Stream方案对比传统MQ：</h4>






























<table><thead><tr><th>特性</th><th>Redis Stream</th><th>Kafka</th></tr></thead><tbody><tr><td>延迟</td><td>&lt;10ms</td><td>~50ms</td></tr><tr><td>持久化</td><td>AOF+RDB</td><td>Segment文件</td></tr><tr><td>消费组</td><td>≥6.x支持</td><td>原生支持</td></tr><tr><td>回溯消费</td><td>XREAD支持</td><td>原生支持</td></tr></tbody></table>
<h4 data-id="heading-17">ACK机制实现：</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本处理消费确认和重试队列  </span>
<span class="hljs-keyword">local</span> msg = redis.call(<span class="hljs-string">"XREADGROUP"</span>, <span class="hljs-string">"GROUP"</span>, ARGV[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-string">"COUNT"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"STREAMS"</span>, KEYS[<span class="hljs-number">1</span>], <span class="hljs-string">"&gt;"</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
    
redis.call(<span class="hljs-string">"XACK"</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], msg[<span class="hljs-number">0</span>])
<span class="hljs-keyword">return</span> msg 
</code></pre>
<h3 data-id="heading-18">场景5：社交关系图谱——关注粉丝列表存储</h3>
<h4 data-id="heading-19">Hybrid存储方案：</h4>
<pre><code class="hljs language-markdown" lang="markdown">String:  存储用户基础信息（JSON格式）
Set:     存双向关系(userA<span class="hljs-emphasis">_followers/userA_</span>following)
Hash:    存关系元数据(关注时间等)
</code></pre>
<h4 data-id="heading-20">Gears模块应用：</h4>
<p>利用RedisGears实现异步处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python函数注册为后台任务  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_new_follower</span>(<span class="hljs-params">record</span>):
    execute(<span class="hljs-string">'HINCRBY'</span>, <span class="hljs-string">'user:%s'</span>%record[<span class="hljs-string">'key'</span>], <span class="hljs-string">'follower_count'</span>, <span class="hljs-number">1</span>)

gb.register(<span class="hljs-string">'*'</span>, event_types=[<span class="hljs-string">'hset'</span>], callback=process_new_follower)
</code></pre>
<hr/>
<p>##三、高级性能优化策略</p>
<p>###内存管理三板斧：</p>
<p>1.<strong>jemalloc调参</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">修改redis.conf:</span>
<span class="hljs-section">jemalloc_bg_thread: yes  </span>
<span class="hljs-section">arena_max:16 # CPU核心数×4 </span>
</code></pre>
<p>2.<strong>主动碎片整理</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">#运行时配置动态调整  
config set activedefrag yes  
config set active-defrag-threshold-lower <span class="hljs-number">20</span> 
</code></pre>
<p>3.<strong>Value压缩</strong>
对于超过8KB的Value启用LZF压缩:</p>
<pre><code class="hljs language-arduino" lang="arduino">config set hash-max-ziplist-value <span class="hljs-number">8000</span> 
</code></pre>
<p>###网络优化Checklist：</p>
<p>✓ Linux内核参数调优:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">net.core.somaxconn</span> = <span class="hljs-number">2048</span>  
<span class="hljs-attr">vm.swappiness</span>=<span class="hljs-number">10</span>  
</code></pre>
<p>✓ TCP快速打开:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/net/ipv4/tcp_fastopen 
</code></pre>
<p>✓ Client连接池配置:
最大连接数=QPS×平均RT(ms)/1000 × 冗余系数(建议≥3)</p>
<hr/>
<p>##四、故障排查工具箱</p>
<p>###慢查询分析三步法:</p>
<p>Step①开启监控:</p>
<pre><code class="hljs language-lua" lang="lua">slowlog-<span class="hljs-built_in">log</span>-slower-than <span class="hljs-number">5000</span> #微秒单位  
slowlog-<span class="hljs-built_in">max</span>-<span class="hljs-built_in">len</span> <span class="hljs-number">1024</span>  
</code></pre>
<p>Step②关键指标关联分析:</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli --latency-history -i5   <span class="hljs-comment">#每5秒采样一次P99延迟   </span>
info commandstats                 <span class="hljs-comment">#命令调用统计TOP20   </span>
</code></pre>
<p>Step③热点Key定位:</p>
<pre><code class="hljs language-perl" lang="perl">redis-cli --bigkeys --memkeys     <span class="hljs-comment">#内存占用TOP分析    </span>
monitor | <span class="hljs-keyword">grep</span> -E <span class="hljs-string">'GETSET|HSET'</span>   <span class="hljs-comment">#实时流量观测   </span>
</code></pre>
<hr/>
<p>##五、总结展望</p>
<p>随着Redis7推出Function数据结构和多线程IO等新特性，其在实时计算领域的潜力将进一步释放。建议开发者重点关注以下方向：</p>
<p>• RedisGraph在图数据查询中的表现提升<br/>
• Serverless模式下自动扩缩容方案<br/>
• WASM运行时对Lua脚本的替代可能性</p>
<p>通过本文的场景分析和优化建议，希望能帮助开发者在实际业务中构建更高性能的Redis体系架构。记住："没有银弹"，所有技术选型都应基于真实业务诉求和数据特征做出权衡决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 证书如何创建，从能生成到能长期使用]]></title>    <link>https://juejin.cn/post/7586182451598065710</link>    <guid>https://juejin.cn/post/7586182451598065710</guid>    <pubDate>2025-12-22T04:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586182451598065710" data-draft-id="7586182451598049326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 证书如何创建，从能生成到能长期使用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T04:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 证书如何创建，从能生成到能长期使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:20:05.000Z" title="Mon Dec 22 2025 04:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 开发中，证书几乎是所有流程的起点。
但在实际项目里，证书往往不是“不会创建”，而是 <strong>创建方式并不适合当前的工程状态</strong>。</p>
<p>我见过不少项目，证书生成时一切顺利，却在后续阶段反复出问题：
构建机无法使用、成员之间无法复用、证书到期没人注意，甚至在上架当天才发现私钥只存在于某一台 Mac 上。</p>
<p>这些问题并不是技术难度造成的，而是 <strong>证书创建方式与工程协作方式不匹配</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>证书的本质，并不是一个步骤，而是一个工程资源</strong></h2>
<p>在官方文档里，证书通常被描述为一次性的配置。但在真实项目中，证书更像一种长期存在的工程资源：</p>
<ul>
<li>会被构建系统反复使用</li>
<li>会被多个应用共享</li>
<li>会跨设备、跨人员流转</li>
<li>会在一年后过期</li>
</ul>
<p>如果证书在创建之初就被绑定在某一台 Mac 或某一个人身上，后续问题几乎是必然的。</p>
<hr/>
<h2 data-id="heading-1"><strong>常见的几种证书创建方式，各自都有边界</strong></h2>
<p>在项目中，我接触过几种常见的证书创建路径：</p>
<ul>
<li><strong>Xcode 自动管理</strong>
适合单人开发或原型阶段，但证书和私钥高度依赖钥匙串，迁移成本高。</li>
<li><strong>Apple Developer 后台 + Keychain</strong>
可控性更强，但操作步骤繁琐，对新成员不友好。</li>
<li><strong>Fastlane match</strong>
适合成熟 CI 团队，但对流程理解要求较高，一旦出问题排查成本不低。</li>
</ul>
<p>这些方式本身没有问题，问题在于：
当项目成员不全使用 macOS，或者构建、发布节点开始拆分时，证书就需要一种 <strong>更中性的管理方式</strong>。</p>
<hr/>
<h2 data-id="heading-2"><strong>为什么在一些项目中会引入 Appuploader 创建证书</strong></h2>
<p>在部分跨平台或 CI 驱动的项目中，我们开始使用 <strong>开心上架（Appuploader）</strong> 来创建和管理 iOS 证书，并不是为了替代官方流程，而是为了满足几个现实需求：</p>
<ul>
<li>不依赖 Mac 或钥匙串</li>
<li>证书文件可以直接落地保存</li>
<li>同一证书可在多台机器上使用</li>
<li>证书状态更容易被确认和复查</li>
</ul>
<p>尤其在 Windows / Linux 成员参与发布的项目中，这种方式可以显著降低沟通和迁移成本。</p>
<hr/>
<h2 data-id="heading-3"><strong>开发证书与发布证书，在工程里的角色差异</strong></h2>
<p>在实际工程中，区分证书类型非常重要，但很多问题并不是“选错类型”，而是 <strong>使用场景混淆</strong>。</p>
<ul>
<li><strong>开发证书（iOS App Development / Apple Development）</strong>
更适合本地调试、测试设备安装，生命周期短，变动频繁。</li>
<li><strong>发布证书（iOS Distribution）</strong>
直接关系到 App Store 上传，应尽量保持稳定、可复用。</li>
</ul>
<p>在一些项目里，发布证书会被严格限制创建次数，甚至只保留一到两份。这种策略本身没问题，但前提是：
证书的创建、保存和同步方式足够清晰。</p>
<hr/>
<h2 data-id="heading-4"><strong>证书创建完成之后，真正重要的是能否被正确使用</strong></h2>
<p>证书生成并不等于流程结束。
在真实项目中，证书至少还会经历这些阶段：</p>
<ul>
<li>被描述文件引用</li>
<li>被构建工具使用</li>
<li>被 CI 节点加载</li>
<li>被上传流程验证</li>
</ul>
<p>如果证书文件本身不可复用、密码不清楚、来源不明确，后续每一步都会增加风险。</p>
<p>这也是为什么在一些项目中，会选择使用 <strong>Appuploader 的证书同步能力</strong>，让证书不再依赖某一台电脑的本地状态。</p>
<hr/>
<h2 data-id="heading-5"><strong>关于免费账号与证书有效期的现实限制</strong></h2>
<p>需要特别说明的是：
使用 Apple 免费开发者账号生成的证书，本身就存在明确限制，例如：</p>
<ul>
<li>有效期较短（7 天）</li>
<li>无法用于 App Store 上架</li>
</ul>
<p>这并不是工具限制，而是苹果账号体系的规则。
在实际项目中，如果目标是发布应用，这一点必须在证书创建阶段就考虑清楚。</p>
<hr/>
<h2 data-id="heading-6"><strong>证书管理并不是“创建一次就结束”</strong></h2>
<p>在经历过多次证书问题之后，我逐渐形成一个共识：
证书创建只是开始，管理方式才决定它是否会成为隐患。</p>
<p>一些实践经验包括：</p>
<ul>
<li>证书名称具有可读性</li>
<li>密码统一规则并妥善保存</li>
<li>避免重复创建同类型证书</li>
<li>明确证书与项目的使用关系</li>
</ul>
<p>这些并不依赖某一个工具，但工具是否支持这些行为，会直接影响执行成本。</p>
<hr/>
<p>下面这部分，是 <strong>使用 开心上架（Appuploader）制作 Apple 证书的完整实操流程</strong>。
它是对应前面讨论的一个具体实现方式，适合：</p>
<ul>
<li>不想依赖 Mac</li>
<li>需要证书跨设备使用</li>
<li>希望快速生成可用证书</li>
</ul>
<hr/>
<h2 data-id="heading-7">如何使用 AppUploader 制作 Apple 证书</h2>
<p>本文将介绍如何使用 AppUploader 工具制作 iOS 开发与发布所需的证书，帮助初学者快速掌握证书的生成流程，并在实际工程中正确使用证书。</p>
<hr/>
<p>在 iOS 开发中，证书是应用打包、调试和上架的必备条件。
苹果要求开发者为应用创建相应的证书，但对于初学者来说，相关步骤往往较为复杂，且容易与钥匙串、Xcode 流程混在一起。
下面将通过 AppUploader，逐步完成证书的创建过程。</p>
<hr/>
<h2 data-id="heading-8"><strong>第一步：进入证书管理界面</strong></h2>
<ol>
<li>打开 <strong>AppUploader</strong> 工具</li>
<li>在主页面点击 <strong>证书管理</strong></li>
<li>进入证书管理界面
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c920562e056748f89b7ef6db5d295387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982005&amp;x-signature=zc%2BvEoRvJX1lQr6C8IwZN43udLw%3D" alt="进入" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-9"><strong>第二步：新建证书</strong></h2>
<ol>
<li>在证书管理界面点击 <strong>添加</strong></li>
<li>新建证书</li>
</ol>
<p>在弹出的对话框中选择证书类型：</p>
<ul>
<li><strong>开发证书（iOS App Development）</strong>
用于安装和调试测试 App</li>
<li><strong>发布证书（iOS Distribution）</strong>
用于上传到 App Store（需 Apple 开发者年费账号）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a05390dfc38341d78c394d82c9a4eed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982005&amp;x-signature=FqtlyKCkO%2FKS3CjkDEgbjf2AQVs%3D" alt="新建" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>第三步：设置证书信息</strong></h2>
<p>在证书生成界面填写以下内容：</p>
<ul>
<li><strong>类型</strong>
<ul>
<li><code>development</code> → 开发证书</li>
<li><code>distribution</code> → 发布证书</li>
</ul>
</li>
<li><strong>名称</strong>
用于区分证书，建议使用字母与数字组合，便于后续管理和识别</li>
<li><strong>密码</strong>
这是生成的 <code>.p12</code> 文件密码（不是 Apple 账号密码）
<ul>
<li>建议使用字母数字组合</li>
<li>密码遗忘后无法修改，只能重新生成证书</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：
免费账号生成的证书有效期仅 7 天，且无法上传至 App Store。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11"><strong>第四步：使用 AppUploader 服务同步证书</strong></h2>
<p>如果勾选 <strong>使用 AppUploader 服务同步证书</strong>：</p>
<ul>
<li>可在不同电脑上下载并使用该证书</li>
<li>无需依赖 Mac 或 Xcode</li>
<li>方便在 Windows、Linux 环境中上传 IPA 至 App Store</li>
</ul>
<hr/>
<h2 data-id="heading-12"><strong>证书完成</strong></h2>
<ul>
<li>生成的证书文件为 <code>.p12</code> 格式</li>
<li>可直接使用，无需额外转换</li>
<li>证书生成成功后即可用于后续流程</li>
</ul>
<hr/>
<h2 data-id="heading-13"><strong>补充说明</strong></h2>
<ul>
<li>一个证书可以对应多个 App，并非一一绑定</li>
<li>建议统一管理证书，避免重复创建</li>
<li>清晰的证书策略，往往比“会不会生成”更重要</li>
</ul>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F4%2F4.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/4/4.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？]]></title>    <link>https://juejin.cn/post/7586136543954878502</link>    <guid>https://juejin.cn/post/7586136543954878502</guid>    <pubDate>2025-12-22T04:39:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954878502" data-draft-id="7585866811717697563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？"/> <meta itemprop="keywords" content="算法,架构,前端"/> <meta itemprop="datePublished" content="2025-12-22T04:39:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:39:25.000Z" title="Mon Dec 22 2025 04:39:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>吃个瓜，近期热点事件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F1981623306370180619%2Fanswer%2F1982117455234089374" target="_blank" title="https://www.zhihu.com/question/1981623306370180619/answer/1982117455234089374" ref="nofollow noopener noreferrer">26岁文科博导引争议</a>，22岁数学教授实至名归。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fbilibili.com%2Fvideo%2FBV1PPqjBLEst%2F%3Fspm_id_from%3D333.1007.top_right_bar_window_custom_collection.content.click%26vd_source%3D0bcafb665fe6140f5a86a181137e5c7d" target="_blank" title="http://bilibili.com/video/BV1PPqjBLEst/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&amp;vd_source=0bcafb665fe6140f5a86a181137e5c7d" ref="nofollow noopener noreferrer">bilibili.com/video/BV1PP…</a></p>
</blockquote>
<p>最近高强度使用 AI 协助工作，让我不禁有些恍惚：眼下的 Gemini 3 Pro 通识水平已然媲美博士，那距离传说中的<code>超人类智能</code>究竟还有多远？ 带着这份好奇，我重读了那段波澜壮阔的数学史，试着将人类的智力征途与当下顶尖 AI 的能力版图做了一次对照。</p>
<p>这篇科普小文算是一次粗浅的探索，若有疏漏，期待大家指正。</p>
<h2 data-id="heading-0">1. 两个世界的碰撞：当碳基天才遇上硅基神明</h2>
<p>时间倒回 <strong>2010 年</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e9f738c908d4771bc326151c7ab04c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=KcPfUzk0bMuh0Ly5gBtm6Bgx5HI%3D" alt="截屏2025-12-22 12.33.16.png" loading="lazy"/></p>
<p>中南大学的大三学生刘路，在寝室里百无聊赖地翻着书。窗外是喧嚣的校园，但他脑海里却是一片死寂的深海。 他面对的是 <strong>“西塔潘猜想”</strong> ——这是一个关于<strong>反推数学</strong>的逻辑陷阱。简单来说，国际数学界苦战了十几年，试图找到一种特定的逻辑路径来证明它成立。无数专家都在这迷宫里撞了南墙。</p>
<p>突然，灵感像一道闪电划破了寂静。刘路意识到：<strong>既然找不到路，也许是因为路根本就不存在？</strong></p>
<p>他连夜写出了一篇论文，不再试图去证明它是对的，而是反其道而行之。他利用<strong>组合数学中的染色法</strong>，构造了一个极其特殊的数学模型——<strong>这个模型虽然完美符合了“拉姆齐定理”的规则，却唯独推导不出那个预期的“引理”</strong> 。</p>
<p>这就像是所有人都试图证明“A 必然导致 B”，而刘路直接造出了一个“有 A 却没有 B”的数学世界。他用这个无懈可击的反例，像手术刀一样切断了两个公理之间被人们误以为存在的逻辑链条，彻底终结了这个猜想。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e86357f67de04928b893994a8fe31da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=B0myHvpvdTIsIvV6JBZ%2FtdO49wA%3D" alt="截屏2025-12-22 12.31.33.png" loading="lazy"/></p>
<p><strong>结果我们都知道了</strong>：22 岁，破格晋升正教授，百万奖金，一夜封神。 刘路靠的不是超级计算机，不是海量数据，仅仅是一颗 1.4 公斤重的人脑，和那一瞬间极其优美、不可复制的“逻辑闭环”。</p>
<p>时间来到 <strong>2025 年 12 月</strong>的今天。</p>
<p>我们手里的工具已经进化到了“博士”的级别：</p>
<ul>
<li><strong>GPT-5.2</strong> 能在几秒钟内写出以假乱真的诺贝尔文学奖风格小说；</li>
<li><strong>Claude 4.5 Opus</strong> 能独自重构数百万行的企业级代码库；</li>
<li><strong>Gemini 3 Pro</strong> 结合 AlphaProof 2.0，甚至刚刚拿下了国际奥数（IMO）的满分金牌。</li>
</ul>
<p><strong>这里就出现了一个巨大的认知冲突：</strong></p>
<p>按理说，AI 的智商和知识储备已经碾压了人类。</p>
<p>但如果我告诉你，面对数学皇冠上的明珠——<strong>哥德巴赫猜想</strong>，这三位“硅基大神”目前的表现，可能还不如当年的那个本科生刘路。</p>
<p>为什么？是 AI 在装傻，还是在数学那深不见底的深渊里，藏着某种连硅基生命都无法逾越的 <strong>“叹息之墙”</strong> ？</p>
<hr/>
<h2 data-id="heading-1">2. 凡人的弑神之路：从欧拉到陈景润的 200 年血泪</h2>
<p>为了理解 AI 为什么“吃瘪”，我们必须先回头看看，人类为了攻克这座堡垒，付出了怎样惨烈的代价。这绝不是简单的算术题，而是一场跨越三个世纪的智力接力。</p>
<p><strong>真正的定义（1742年提出）：</strong></p>
<p><strong>“任一大于 2 的偶数，都可以写成两个质数之和。”</strong></p>
<ul>
<li><strong>举个栗子</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>=</mo><mn>2</mn><mo>+</mo></mrow><annotation encoding="application/x-tex">4 = 2 + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord">+</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mo>=</mo><mn>3</mn><mo>+</mo></mrow><annotation encoding="application/x-tex">10 = 3 + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mord">+</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>=</mo><mn>3</mn><mo>+</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">100 = 3 + 9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span></span></span></span></span></li>
<li>...</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn><mo>=</mo><mn>53</mn><mo>+</mo><mn>99</mn><mo separator="true">,</mo><mn>999</mn><mo separator="true">,</mo><mn>94</mn></mrow><annotation encoding="application/x-tex">100,000,000 = 53 + 99,999,94</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">100</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">53</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">99</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">999</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">94</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>看起来人畜无害，对吧？只要你有一个计算器，似乎就能无限验证下去。</p>
<p><strong>但这就是陷阱。</strong></p>
<p>数学家面对的是 <strong>“无穷”</strong> 。偶数是无穷无尽的，而质数在数轴上的分布却是无序且混沌的。</p>
<p>这就好比让你在无限延伸的沙滩上，保证<strong>每一粒沙子</strong>（偶数）都能被完美拆解成<strong>两颗特定的珍珠</strong>（质数）。</p>
<p>只要宇宙尽头存在<strong>一个</strong>反例，整个猜想就会崩塌。</p>
<h3 data-id="heading-2">第一棒：巨人的叹息（1742-1900）</h3>
<p>一切始于哥德巴赫给欧拉的一封信。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a6fd286ba0542d3b9a3fa248365d18c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=HSJLEViP9a7sw26%2B5xtbjz4SRqc%3D" alt="截屏2025-12-22 12.35.56.png" loading="lazy"/></p>
<p>当时的数学之神<strong>欧拉</strong>，穷尽毕生精力后无奈回复：“虽然我无法证明，但我确信它是真的。”</p>
<p>连欧拉都缴械投降，这道题沉睡了 160 年。这期间，人类绝望地意识到：面对无穷尽的偶数，靠“算”是没用的，必须找到通用的逻辑武器。</p>
<h3 data-id="heading-3">第二棒：重武器登场（1920s - 圆法与筛法）</h3>
<p>20 世纪初，数学家们终于造出了两把神兵：</p>
<ul>
<li><strong>圆法 (Circle Method)</strong> ：哈代和李特尔伍德引入了复变函数，把数论问题转化成了积分问题。这就像是用大炮轰蚊子，威力巨大但精度不够，只能解决“三个质数之和”。</li>
<li><strong>筛法 (Sieve Method)</strong> ：这是后来的主战场。挪威数学家布朗把它进化成了精密的手术刀。简单说，就是把不符合条件的数像过筛子一样滤掉。</li>
</ul>
<h3 data-id="heading-4">第三棒：悲壮的包围战（1920-1962）</h3>
<p>既然直接证明“1+1”（一个质数+一个质数）太难，人类决定采用 <strong>“迂回包围战术”</strong> ：</p>
<p>先证明“大偶数 = 一个质数 + 一个<strong>由不超过 N 个质数乘积组成的合数</strong>”。</p>
<ul>
<li>1920年，布朗证明了“9+9”。</li>
<li>1948年，雷尼证明了“1+c”。</li>
<li>1962年，中国的潘承洞证明了“1+5”。</li>
</ul>
<p><strong>包围圈越来越小，人类离真理越来越近，空气也越来越稀薄。</strong></p>
<h3 data-id="heading-5">最后一棒：陈景润的孤勇（1966）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886ca48ae0814da9977e62fbe2225945~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=Ix4ANJ3Eb4GB1EfHEogMTSmDvgM%3D" alt="截屏2025-12-22 12.35.00.png" loading="lazy"/></p>
<p><strong>这是中国数学史上最耀眼的时刻，也是最令人心碎的时刻。</strong></p>
<p>在只有 6 平方米的斗室里，借着煤油灯微弱的光，陈景润把“筛法”运用到了极致。他消耗了几麻袋的草稿纸，甚至消耗了自己的生命，成功证明了：</p>
<p><strong>“任何充分大的偶数，都可以表示为一个质数和一个‘由不超过两个质数乘积’的数之和。”</strong></p>
<p>这就是著名的 <strong>“1+2”</strong> 。</p>
<p>我们终于站在了海拔 8800 米的地方，距离 8848 米的顶峰（1+1），只差最后一步。</p>
<p><strong>但这最后一步，我们卡了整整 60 年，人类卡了整整60年。</strong></p>
<p>因为数学界悲哀地发现，传统的筛法已经用尽了潜力，我们撞上了一堵叫 <strong>“奇偶性障碍（Parity Problem）</strong> ”的墙。要翻过这堵墙，必须发明全新的数学工具。</p>
<hr/>
<h2 data-id="heading-6">3. 2025年的 AI 战况：为什么跨不过这最后一步？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e42096c6624fa1bfe584d498402734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=XLDwn2u7deBDusCztRlfusugGw4%3D" alt="nthme-1766376500477.png" loading="lazy"/></p>
<p>现在你明白了，要解决这个问题，不能靠暴力的“算”，而是要发明像“筛法”或“圆法”这样 <strong>全新的数学工具</strong>。</p>
<p>让我们看看 2025 年的三大 AI 模型在做什么。</p>
<h3 data-id="heading-7">OpenAI GPT-5.2：有灵感，无逻辑的“文科生”</h3>
<p>GPT-5.2 是目前最强的直觉机器。</p>
<p>如果你问它如何证明，它会模仿陈景润的论文风格，写得头头是道。它甚至会建议你：“试着结合椭圆曲线和模形式...”</p>
<p><strong>但它有一个致命伤：幻觉。</strong></p>
<p>它不懂什么是严谨的推导。它是在用概率预测下一个字，而不是在构建逻辑链。它给出的证明，往往在第 5-10 步就引用了一个根本不存在的定理。</p>
<p><strong>它像一个喝醉了的天才，满嘴金句，但走不成直线。</strong></p>
<h3 data-id="heading-8">Anthropic Claude 4.5 Opus：有逻辑，无方向的“做题家”</h3>
<p>Claude 4.5 接入了 Lean 4（形式化验证语言）。它是最严谨的。</p>
<p>它能完美地复现陈景润当年的“1+2”证明过程，每一步都无懈可击。</p>
<p><strong>但它卡在了“创造性”上。</strong></p>
<p>目前的 AI 只能在<strong>已有的公理体系</strong>内进行搜索。而要从“1+2”跨越到“1+1”，数学界公认现有的“筛法”已经用到了极限，必须有颠覆性的新方法。</p>
<p><strong>Claude 4.5 就像一个完美的工匠，它能把旧地图画得无比精细，但它无法画出地图上没有的新大陆。</strong></p>
<h3 data-id="heading-9">Google Gemini 3 Pro：暴力美学的极限</h3>
<p>Google 试图用 DeepMind 的 AlphaProof 2.0 暴力破解。</p>
<p>它把数学证明变成了一个<strong>搜索树</strong>问题。在奥数题里，搜索深度可能只有几十层，它能算出最优解。</p>
<p>但在哥德巴赫猜想面前，搜索空间是<strong>指数级爆炸</strong>的。即使是 2025 年的量子辅助算力，面对这种量级，也像是在太平洋里捞一根针。</p>
<p><strong>它就像西西弗斯，拥有推得动巨石的算力，却被困在了“无穷”这座永远推不到顶的山脚下。</strong></p>
<p>这三个 AI 就分别代表了：<strong>混乱的直觉</strong>、<strong>僵化的守成</strong>、<strong>徒劳的暴力</strong>。更衬托出人类“灵感”的珍贵。</p>
<hr/>
<h2 data-id="heading-10">4. AI 的高维困境：为什么“暴力计算”失效了？</h2>
<p>看完历史，你就明白了：<strong>哥德巴赫猜想不是计算量的问题，而是逻辑架构的问题。</strong></p>
<p>目前的 AI（GPT-5.2, Gemini 3 Pro, Claude 4.5）虽然强大，但本质上还是 <strong>“超级模仿者”</strong> 。它们在做的是：</p>
<ol>
<li><strong>概率预测</strong>：根据已有的数学论文，猜下一个词。</li>
<li><strong>搜索优化</strong>：在已知的解题路径里找最优解。</li>
</ol>
<p>但要证明哥德巴赫猜想，AI 必须从 <strong>“模仿者”</strong> 进化为 <strong>“概念创造者”</strong> 。</p>
<p>这需要 AI 跨越三个具体的进化阶段：</p>
<h3 data-id="heading-11">阶段一：翻译官——从“自然语言”到“形式化数学”（当前阶段）</h3>
<p>目前的 AI 经常一本正经地胡说八道（幻觉）。要解决数学难题，第一步是 <strong>“去模糊化”</strong> 。</p>
<ul>
<li><strong>目标</strong>：AI 需要把陈景润、陶哲轩等人的论文，完美无误地翻译成计算机能绝对理解的严谨语言（如 Lean 或 Coq）。</li>
<li><strong>现状</strong>：Claude 4.5 Opus 已经能做得很好了，但这只是打好了地基。</li>
</ul>
<h3 data-id="heading-12">阶段二：逻辑大师——掌握“长链条推理”（AlphaProof 阶段）</h3>
<p>奥数题的证明通常只有几十步，而哥德巴赫猜想可能需要<strong>数万步</strong>极其严密的逻辑跳跃。</p>
<ul>
<li><strong>目标</strong>：神经符号系统的成熟。</li>
</ul>

<ul>
<li>
<ul>
<li><strong>左脑（符号逻辑）</strong> ：保证每一步推导绝对正确，像计算器一样严谨。</li>
<li><strong>右脑（神经网络）</strong> ：像人类大师一样拥有“直觉”，在茫茫的逻辑迷宫中，瞬间判断出哪条路通向终点。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>现状</strong>：Google DeepMind 在这方面刚起步，拿到了 IMO 银牌，但距离“万步推理”还有数量级的差距。</li>
</ul>
<h3 data-id="heading-13">阶段三：造物主——具备“概念创造”能力（关键转折点）</h3>
<p>这是最难的一步，也是目前 AI 的<strong>绝对盲区</strong>。</p>
<p>回顾历史，陈景润之所以能做到“1+2”，是因为他<strong>改进</strong>了筛法。</p>
<p>要解决“1+1”，AI 不能只在旧规则里玩游戏（像下围棋那样），<strong>它必须修改规则！！</strong></p>
<ul>
<li><strong>目标</strong>：突破“奇偶性障碍”。AI 需要凭空发明出人类未曾设想过的数学对象（比如定义一种“广义素数”或“高维筛法”）。</li>
<li><strong>本质</strong>：这不仅仅是解题，这是<strong>爱因斯坦提出相对论级别的思维飞跃</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-14">5. 终极预测：我们距离那一天还有多远？</h2>
<p>如果未来某天你看到以下新闻，说明 AI 距离摘下皇冠不远了。我们可以把这个进度条量化为四个里程碑：</p>



































<table><thead><tr><th><strong>发展阶段</strong></th><th><strong>标志性事件</strong></th><th><strong>预计实现时间</strong></th><th><strong>距离终极真理</strong></th></tr></thead><tbody><tr><td><strong>L1: 辅助者</strong></td><td>AI 无错误地检查顶尖论文，查漏补缺。</td><td><strong>当前已实现</strong></td><td>遥远 (依然是工具)</td></tr><tr><td><strong>L2: 竞赛者</strong></td><td>AI 在国际奥数 (IMO) 拿满分金牌，解法比人类优美。</td><td><strong>1-2 年内</strong></td><td>还有距离 (只会做题，不会出题)</td></tr><tr><td><strong>L3: 发现者</strong></td><td>AI 独立发现并证明一个人类未知的、有意义的新定理。</td><td><strong>5-10 年</strong></td><td>接近 (具备了初步创造力)</td></tr><tr><td><strong>L4: 创造者</strong></td><td><strong>AI 发明全新的数学定义或框架 (如新筛法)。</strong></td><td><strong>未知 / 奇点</strong></td><td>临门一脚 (打破叹息之墙)</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">6. 结语</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf054906a7de45f58c9d430da0ccccc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=FKR5J7N5LL0yScoU2y%2FtpOJC4kM%3D" alt="e891b3de8bbd391592c279c7186a1491_1766376928.png" loading="lazy"/>
回到最初的故事。22 岁的刘路之所以能震撼世界，是因为他在旧有的知识体系上，捅破了一层窗户纸。</p>
<p>而哥德巴赫猜想，是一堵厚重的墙。</p>
<p>2025 年的 AI，依然是最好的<strong>副驾驶</strong>。它能帮我们把车开得飞快，能帮我们避开路上的坑，但它还不知道如何<strong>飞越</strong>这堵墙。</p>
<p><strong>哥德巴赫猜想的皇冠，最终可能不会戴在 AI 的头上。</strong></p>
<p>它大概率会戴在下一位人类天才的头上——而这位天才的手里，一定紧紧握着通往 AI 算力深处的钥匙。</p>
<p><strong>不是 AI 战胜了数学，而是人类利用 AI，再一次战胜了自己。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体基础概念笔记]]></title>    <link>https://juejin.cn/post/7586192313635520546</link>    <guid>https://juejin.cn/post/7586192313635520546</guid>    <pubDate>2025-12-22T04:41:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635520546" data-draft-id="7586192313635487778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体基础概念笔记"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-22T04:41:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体基础概念笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:41:34.000Z" title="Mon Dec 22 2025 04:41:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI核心技术体系笔记：大模型、智能体与关键支撑技术</h2>
<p>本文系统梳理AI领域核心技术模块——大模型（LLM）、智能体（Agent）、提示词（Prompt）、检索增强生成（RAG）、工具调用（Function Calling）的定义、核心能力、应用场景及内在关联，构建完整的技术认知框架，助力理解AI技术的落地逻辑与价值边界。</p>
<h2 data-id="heading-1">一、基础核心：大模型（LLM）——AI能力的“原生引擎”</h2>
<p>大模型是整个AI技术体系的基础组件，提供核心的自然语言理解与生成等基础智能能力，是后续技术延伸（如智能体、RAG等）的前提。</p>
<h3 data-id="heading-2">1.1 核心定义</h3>
<p>基于Transformer架构、海量文本/多模态数据预训练的通用深度学习模型，通常具备数十亿至数万亿级参数，通过自监督学习掌握语言统计规律与语义逻辑，核心优势集中于自然语言理解与生成、代码补全、信息抽取、逻辑推理等基础智能能力，是人工智能的核心基础组件。</p>
<ul>
<li>补充要点：强调Transformer架构与自监督学习的核心地位，明确参数规模与训练范式是大模型能力涌现的关键。</li>
</ul>
<h3 data-id="heading-3">1.2 核心特征</h3>
<ol>
<li>无原生长期记忆：仅支持短期上下文记忆，依赖当前会话的上下文窗口（Token数量限制）存储临时信息，会话结束后记忆自动清空，无法跨会话复用数据；仅能通过外部工具（如向量数据库）实现长期记忆模拟。</li>
<li>被动响应模式：需依赖外部指令（Prompt）驱动运行，无自主设定目标、规划任务的意识，仅能针对输入指令输出对应结果，不具备主动感知与决策能力。</li>
<li>能力涌现特性：参数、数据规模达到阈值后，会涌现出小模型不具备的复杂推理、小样本学习等能力，这是大模型区别于传统AI的核心标志。</li>
</ol>
<h3 data-id="heading-4">1.3 能力边界（核心短板）</h3>
<ol>
<li>上下文窗口有限：处理长文本时需分段输入，或结合检索工具辅助补充信息，窗口外信息难以有效关联。</li>
<li>实时数据获取受限：训练数据存在时间截止点，无法原生联网获取最新动态数据，需通过插件/API等工具扩展。</li>
<li>专业领域深度不足：通用模型在医疗、法律、工业等垂直领域的专业精度不足，需通过微调、RAG等方式提升适配度。</li>
<li>私域知识无法原生应答：未纳入训练数据的企业内部文档、专属客户数据等私域信息，模型无法原生应答，需通过知识注入解决。</li>
<li>存在“幻觉”风险：生成内容可能与事实不符，核心诱因是依赖参数记忆+短期上下文记忆，缺乏长期事实校验机制，在复杂推理与模糊信息场景中更易出现。</li>
<li>缺乏任务闭环能力：无法自主拆解复杂多步任务，也不能根据执行结果调整策略，需外部框架（如智能体）实现任务规划与反馈迭代。</li>
</ol>
<h3 data-id="heading-5">1.4 适用场景</h3>
<p>问答互动、文本摘要、内容改写、数据分类、语言翻译、代码草稿生成等单一、短流程任务。</p>
<ul>
<li>
<p>场景示例：</p>
</li>
<li>
<p>内容创作：公众号文章初稿、产品文案生成；</p>
</li>
<li>
<p>办公效率：会议纪要自动整理、邮件智能回复；</p>
</li>
<li>
<p>研发辅助：代码片段补全、简单Bug排查；</p>
</li>
<li>
<p>数据处理：结构化数据分类、非结构化信息抽取。</p>
</li>
</ul>
<h2 data-id="heading-6">二、能力升级：智能体（Agent）——大模型的“主动执行载体”</h2>
<p>智能体以大模型为核心“大脑”，通过整合多模块能力，解决大模型的被动响应和任务闭环短板，实现从“工具”到“系统”的升级。</p>
<h3 data-id="heading-7">2.1 核心定义</h3>
<p>以大模型为核心“大脑”，整合感知模块、决策规划模块、工具调用模块、记忆管理模块的完整智能系统，具备自主感知环境、设定目标、拆解任务并执行闭环的能力。</p>
<h3 data-id="heading-8">2.2 核心特征</h3>
<ol>
<li>具备长期记忆与状态管理：可通过外部数据库/向量库，维护任务全流程的关键信息与执行状态，支持跨步骤、跨场景复用记忆，从源头减少“脑补”需求，弥补大模型长期记忆缺失短板。</li>
<li>主动闭环能力：形成“感知→规划→执行→反思优化”的自主循环，无需人类持续干预，解决大模型被动响应与任务闭环缺失问题。</li>
</ol>
<h3 data-id="heading-9">2.3 核心能力</h3>
<ol>
<li>任务拆解与规划：将复杂目标拆分为可执行的多步子任务，明确各步骤优先级与执行路径，适配复杂任务需求。</li>
<li>工具调用扩展：灵活调用外部工具（API、数据库、浏览器、RAG系统等），弥补大模型原生短板（如实时数据获取、专业领域精度不足等）。</li>
<li>动态调整策略：基于工具反馈与执行结果反思优化，应对任务中的变量与突发情况，保障任务推进的稳定性。</li>
</ol>
<h3 data-id="heading-10">2.4 适用场景</h3>
<p>自动化工作流搭建、数据采集与分析处理、长链路复杂任务（如项目开发辅助、活动策划）、智能运维、个性化助理等需自主闭环的场景。</p>
<ul>
<li>
<p>场景示例：</p>
</li>
<li>
<p>项目开发辅助：自动拆解开发任务、分配模块、调用代码检查工具、生成开发进度报告；</p>
</li>
<li>
<p>智能运维：实时监测系统状态、识别异常、调用修复工具执行应急处理、记录运维日志；</p>
</li>
<li>
<p>个性化助理：根据用户日程规划每日行程、调用票务API预订交通、推送相关行程提醒。</p>
</li>
</ul>
<h3 data-id="heading-11">2.5 与大模型的核心关联</h3>
<ol>
<li>大模型是智能体的“核心组件”：为智能体提供基础的理解、推理能力，是决策规划模块的核心支撑，决定智能体的基础智能上限。</li>
<li>智能体是大模型的“落地载体”：通过补充记忆管理、工具调用、任务闭环能力，让大模型从“被动响应工具”升级为“主动执行系统”，适配复杂实际场景。</li>
<li>关键联动：智能体通过优化“记忆机制”（外部长期记忆）和“事实校验机制”（工具调用+RAG），针对性解决大模型的“记忆短板”与“幻觉风险”，实现1+1&gt;2的应用效果。</li>
</ol>
<h2 data-id="heading-12">三、交互桥梁：提示词（Prompt）——驱动智能的“精准指令系统”</h2>
<p>提示词是用户与大模型/智能体交互的核心媒介，通过结构化指令对齐双方预期，同时弥补大模型的部分原生短板（如幻觉、输出不规范等）。</p>
<h3 data-id="heading-13">3.1 核心定义</h3>
<p>向大模型输入的结构化指令、问题或上下文信息的集合，用于精准引导模型理解任务目标、约束条件与输出要求，进而生成符合预期的结果。</p>
<h3 data-id="heading-14">3.2 核心作用</h3>
<ol>
<li>弥补大模型原生短板：明确任务边界与事实约束，减少“幻觉”风险；限定输出范式，降低后续内容加工成本。</li>
<li>对齐用户与模型预期：将模糊需求（如“写一篇好的文案”）转化为模型可理解的明确指令（如“写一篇面向年轻女性的护肤品推广文案，风格活泼，突出保湿功效，300字以内”），避免生成内容偏离核心目标。</li>
<li>适配专业场景需求：通过角色与规则定义，让模型输出贴合特定领域（如前端开发、数据分析、医疗诊断）的专业内容，提升输出精准度。</li>
</ol>
<h3 data-id="heading-15">3.3 核心组成（结构化Prompt六要素）</h3>
<ol>
<li>角色定位：明确模型的任务身份（如“资深Vue前端工程师”“智能体任务规划师”“医疗文案审核专家”），引导模型匹配对应角色的专业用语与思维逻辑。</li>
<li>任务描述：清晰阐述核心需求与达成标准，避免模糊表述，例如“生成Vue3商品列表组件代码，需支持下拉刷新与上拉加载，兼容移动端”。</li>
<li>工具调用要求（可选）：针对智能体专属场景，明确需要调用的外部工具及调用规则，例如“调用浏览器检索Vue官方最新API文档，优先参考Composition API用法”。</li>
<li>工作流要求（可选）：明确任务执行的步骤顺序与衔接规则，例如“先梳理组件核心功能点，再编写代码，最后添加详细注释”，适用于多步骤、有先后顺序的复杂任务。</li>
<li>输出格式：指定内容的呈现类型与规范细节，例如“带详细注释的JavaScript代码”“Markdown表格”“分点式报告”，同时明确排版、篇幅、版本兼容等要求。</li>
<li>参考示例（可选）：提供1-2组输入输出范例，帮助模型快速理解任务标准，适用于复杂或定制化需求（如“按以下示例格式生成数据分类结果：输入：苹果；输出：水果-常见鲜果”）。</li>
<li>约束条件：划定内容的边界与禁忌，例如“禁止编造未经验证的Vue API用法”“回答长度控制在300字以内”“避免使用专业术语，采用通俗表达”。</li>
</ol>
<h3 data-id="heading-16">3.4 编写关键原则</h3>
<ol>
<li>结构化优先：避免大段无条理文本，采用分段、编号、分点形式明确逻辑关系，降低模型理解成本。</li>
<li>指令精准化：减少模糊表述，用具体、量化要求替代抽象描述，例如将“写一个组件”优化为“写一个基于Composition API的Vue3商品列表组件，支持分页功能”。</li>
<li>上下文适配性：多轮对话场景下，嵌入历史会话关键信息，利用模型短期上下文记忆提升回答连贯性，例如“基于上一轮生成的组件框架，补充搜索功能模块代码”。</li>
</ol>
<h3 data-id="heading-17">3.5 使用场景</h3>
<ol>
<li>系统提示词：会话初始化时注入的全局指令，定义模型基础角色、通用规则与响应范式，贯穿整个对话，适用于长期稳定的交互场景（如企业智能客服的角色定义）。</li>
<li>用户提示词：针对具体需求输入的即时指令，补充任务细节、约束与输出偏好，适配单次/单轮任务（如临时生成一份会议纪要）。</li>
</ol>
<h2 data-id="heading-18">四、知识增强：检索增强生成（RAG）——大模型的“开卷考试工具”</h2>
<p>RAG通过融合外部知识库检索与大模型生成能力，针对性解决大模型的幻觉、私域知识缺失、知识滞后等核心短板，是大模型知识补充的核心技术框架。</p>
<h3 data-id="heading-19">4.1 核心定义</h3>
<p>检索增强生成（Retrieval-Augmented Generation，RAG）是融合检索器（获取相关文档）与生成器（大模型）的技术框架，核心是生成答案前先从权威外部知识库（含私域文档、专业资料、实时数据等）检索相关事实信息，将其作为参考补充到提示词中，再驱动大模型生成准确、可追溯的结果，本质是为大模型提供“开卷考试”能力。</p>
<h3 data-id="heading-20">4.2 核心价值（精准解决大模型四大痛点）</h3>
<ol>
<li>对抗幻觉风险：回答基于检索到的真实权威内容，确保信息有依据且可溯源，显著降低编造错误信息的概率。</li>
<li>补充私域知识：通过检索企业内部文档、专属客户数据等私域资源，解决大模型“私域知识无法回答”的问题，无需对大模型进行全量微调。</li>
<li>保持知识新鲜：无需重新训练模型，仅更新外部知识库即可纳入最新信息（如行业新规、热点事件），突破训练数据时间局限。</li>
<li>提升专业精度：依托垂直领域权威资料（如医疗文献、行业规范、法律条文），让输出更贴合专业场景需求，提升垂直领域应用价值。</li>
</ol>
<h3 data-id="heading-21">4.3 核心工作流程（五阶段闭环）</h3>
<ol>
<li>文档分块：将长文本（如PDF、企业手册、学术论文）拆解为语义完整的小块，平衡上下文完整性与检索精准度，避免因文本过长导致的检索偏差。</li>
<li>索引构建：通过嵌入模型（如BERT、Sentence-BERT）将文本块转换为高维向量，存入向量数据库（如FAISS、Chroma、Milvus），形成可快速检索的向量索引。</li>
<li>目标检索：将用户问题向量化后，在向量数据库中通过语义相似度匹配，召回语义最相关的Top-K文本块（K值可根据场景调整，通常为3-5），精准筛选有用信息。</li>
<li>提示增强：将检索到的文本片段与用户问题、任务要求、约束条件整合，构建结构化提示词，为大模型提供明确的事实参考。</li>
<li>生成输出：大模型基于增强提示词，整合参考信息生成流畅、准确的回答，同时可关联原始文档来源（如文档名称、页码），方便验证信息真实性。</li>
</ol>
<h3 data-id="heading-22">4.4 关键技术细节</h3>
<ol>
<li>分块策略：常用固定尺寸分块（按Token数量拆分，设10%-20%重叠部分，保障语义连贯性）和递归分块（按段落、句子自适应拆分，适配结构化文档）。</li>
<li>检索核心：由嵌入模型（负责语义转换，决定向量表征的精准度）和向量数据库（负责快速近似匹配，决定检索效率）组成，二者共同影响检索质量。</li>
<li>溯源能力：生成结果时关联原始文档来源，实现“答案-依据”的一一对应，便于后续事实校验与责任追溯，适用于医疗、法律等严谨场景。</li>
<li>优化技巧：通过重排序模型（如Cross-BERT）过滤低相关度文本；通过上下文压缩减少Token占用，适配大模型上下文窗口限制；采用多轮检索补充遗漏信息，提升检索全面性。</li>
</ol>
<h3 data-id="heading-23">4.5 主流应用场景</h3>
<ol>
<li>企业知识管理：如银泰商业通过RAG构建内部知识库，实现员工手册、业务流程、产品资料的快速查询，提升内部协作效率。</li>
<li>智能客服/问答：如伯俊科技“AI通识小助手”，通过检索企业商品数据库，实现商品标签映射、库存调度等场景的秒级响应，提升客户服务体验。</li>
<li>专业领域支持：医疗诊断建议（检索临床指南、病例文献）、法律条文解读（检索法律法规、判例资料）、金融风险评估（检索行业政策、市场报告）。</li>
<li>长文本处理：论文辅助写作（检索参考文献、学术观点）、合同审核（检索法律条款、行业标准）、书籍摘要（检索核心章节内容）。</li>
<li>事实校验：对大模型生成内容的关键数据（如统计数据、政策条款）进行检索验证，修正过时或错误信息，保障内容准确性。</li>
</ol>
<h3 data-id="heading-24">4.6 局限性与优化方向</h3>
<ol>
<li>现存局限：检索精度受嵌入模型性能与分块策略影响，易出现“漏检”“误检”；长知识库场景下（如百万级文档）存在检索效率瓶颈；无法直接处理非文本数据（如图片、音频、表格）。</li>
<li>优化方向：结合多模态嵌入模型支持跨媒体检索（如图片+文本混合检索）；引入知识图谱提升结构化知识检索能力，解决文本检索的歧义问题；通过强化学习优化检索-生成联动逻辑，提升整体效果。</li>
</ol>
<h3 data-id="heading-25">4.7 与其他技术的关联</h3>
<ol>
<li>与大模型：RAG是大模型的“能力延伸工具”，无需改变大模型参数，通过外部知识补充的方式，低成本弥补其私域知识缺失、幻觉、知识滞后等短板。</li>
<li>与智能体：RAG是智能体的核心组成部分，为智能体提供稳定的外部知识检索能力，配合工具调用模块支撑复杂任务闭环（如智能体规划任务时，通过RAG检索相关流程规范）。</li>
<li>与提示词：RAG检索到的事实信息是提示词的重要组成部分，通过“问题+事实参考”的增强提示词，让大模型生成的内容更精准、有依据。</li>
</ol>
<h2 data-id="heading-26">五、交互延伸：工具调用（Function Calling）——智能体的“现实交互接口”</h2>
<p>Function Calling是大模型/智能体与外部系统交互的核心技术，让模型突破“纯文本生成”的局限，具备获取实时数据、执行专业操作的能力，是连接AI与现实世界的关键桥梁。</p>
<h3 data-id="heading-27">5.1 核心定义</h3>
<p>Function Calling是大模型/智能体与外部系统、工具、API交互的核心技术，指模型根据任务需求自主识别并调用预设函数/接口，获取外部数据或执行特定操作，再将结果整合到生成内容中，本质是让模型具备与现实世界交互的能力。</p>
<h3 data-id="heading-28">5.2 核心价值（弥补大模型三大核心短板）</h3>
<ol>
<li>获取实时动态数据：调用浏览器、股票行情API、天气API等，解决大模型训练数据“时间截止点”问题，支持查询最新新闻、实时股价、当日天气等动态信息。</li>
<li>执行专业计算/操作：调用代码编译器、数据库查询接口、Excel工具等，完成复杂运算（如数学建模、统计分析）、数据读写（如查询企业销售数据库、修改表格数据）等任务。</li>
<li>联动第三方工具链：对接行业专属工具（如CAD设计接口、医疗影像分析工具、财务报销系统）、自动化工作流（如钉钉消息推送、邮件发送），拓展垂直领域落地场景。</li>
</ol>
<h3 data-id="heading-29">5.3 核心工作流程（四步执行闭环）</h3>
<ol>
<li>任务解析与函数匹配：大模型接收指令后，分析任务所需的外部能力，从预设函数列表中匹配最合适的函数（明确函数名、入参格式、功能描述），判断是否需要调用工具。</li>
<li>参数生成与格式校验：模型根据任务需求生成函数所需的标准化入参（如调用“天气查询”函数时生成<code>city: 上海, date: 2025-12-19</code>），并严格遵循预设格式（如JSON、XML），避免调用失败。</li>
<li>函数执行与结果返回：外部执行环境（如LangChain、AgentBuilder）调用目标函数/API，执行具体操作并获取结果（如返回上海当日天气“晴，10-18℃”），同时处理调用异常（如参数错误、接口超时）。</li>
<li>结果整合与生成输出：模型将外部工具执行结果与自身推理能力结合，生成自然语言回答，可标注数据来源（如“数据来源：XX天气API”），提升结果可信度。</li>
</ol>
<h3 data-id="heading-30">5.4 关键技术细节</h3>
<ol>
<li>函数定义规范：需提供清晰的函数描述文档，包含功能说明、入参要求（名称、类型、必填项、取值范围）、出参格式、错误码说明，帮助模型准确理解函数功能。</li>
<li>格式约束与容错机制：通过Prompt强制模型输出标准化调用格式（如“所有函数调用必须采用JSON格式，示例：{"name":"get_weather","parameters":{"city":"上海","date":"2025-12-19"}}”）；设置容错逻辑，当参数缺失或格式错误时，主动追问用户补充信息，或重新生成参数。</li>
<li>安全管控策略：对调用权限分级管理（区分“只读接口”如数据查询、“读写接口”如数据修改、“执行接口”如系统操作），避免误操作风险；设置操作超时与异常处理机制（如接口调用超时后重试3次，失败则提示用户），避免任务中断。</li>
</ol>
<h3 data-id="heading-31">5.5 与RAG的区别与协同</h3>






























<table><thead><tr><th>特性</th><th>Function Calling（工具调用）</th><th>RAG（检索增强生成）</th></tr></thead><tbody><tr><td>核心目标</td><td>与外部工具交互，执行动态操作、获取实时数据</td><td>从静态知识库检索事实信息，补充模型知识</td></tr><tr><td>数据类型</td><td>实时动态数据、可执行操作结果</td><td>静态结构化/非结构化文档知识</td></tr><tr><td>核心优势</td><td>动态交互、实时性强、可执行操作</td><td>知识补充成本低、可溯源、稳定性高</td></tr><tr><td>应用场景</td><td>实时查询、专业计算、工具联动、自动化操作</td><td>私域知识问答、文档解读、事实校验、专业资料查询</td></tr></tbody></table>
<p>协同模式：在智能体架构中，Function Calling与RAG形成互补——当RAG检索的静态知识不足以完成任务时，模型可调用工具获取实时数据；当工具调用需要专业知识支撑时，可通过RAG检索相关规范。例如“先从企业知识库（RAG）检索产品基础参数，再调用电商平台API（Function Calling）获取最新销量数据，最终生成销售分析报告”，实现静态知识与动态数据的深度融合。</p>
<h3 data-id="heading-32">5.6 与大模型/智能体的关联</h3>
<ol>
<li>与大模型：Function Calling是大模型从“被动生成”转向“主动交互”的关键能力，但单独大模型的工具调用需依赖人工定义函数列表和格式约束，无法自主规划调用逻辑。</li>
<li>与智能体：Function Calling是智能体工具模块的核心技术，与任务规划模块、记忆模块深度联动——智能体可自主决定“何时调用工具、调用哪种工具、如何处理调用结果”，并将执行结果存入长期记忆，用于后续决策优化，实现端到端的任务闭环。</li>
</ol>
<h3 data-id="heading-33">5.7 典型应用场景</h3>
<ol>
<li>智能数据分析：调用企业数据库接口提取销售数据→调用Python编译器进行趋势建模→生成可视化分析报告→推送至管理层邮箱。</li>
<li>自动化办公助手：识别用户需求“整理本周会议纪要”→调用企业邮箱API获取会议邮件→调用语音转文字工具处理会议录音→生成纪要并推送至钉钉群。</li>
<li>实时信息查询助手：回答用户问题“今日上证指数收盘情况”→调用股票行情API获取实时数据→整合数据生成自然语言回答，标注数据来源与查询时间。</li>
<li>垂直领域工具联动：医疗智能体调用影像分析API处理CT影像→通过RAG检索相关病例文献→结合两者结果生成诊断建议；工业智能体调用设备传感器API获取运行数据→调用故障诊断工具识别异常→生成运维方案。</li>
</ol>
<h2 data-id="heading-34">六、工作流——AI技术落地的“流程化载体”</h2>
<p>工作流是AI技术从“零散能力”走向“规模化落地”的关键支撑，通过定义标准化的任务执行步骤、角色分工与衔接规则，将大模型、智能体、RAG、工具调用等技术模块串联起来，实现复杂业务需求的端到端闭环处理。其核心价值在于降低技术落地的复杂度，提升任务执行的稳定性与可复用性。</p>
<h3 data-id="heading-35">6.1 核心定义</h3>
<p>AI领域的工作流是指为完成特定业务目标，对多步任务进行结构化拆解，明确各步骤的执行主体（大模型/智能体）、依赖资源（外部工具/知识库）、输入输出标准及衔接条件的流程框架。它并非独立技术，而是整合各类AI技术的“串联器”，让分散的技术能力形成协同效应。</p>
<h3 data-id="heading-36">6.2 与核心技术模块的关联</h3>
<ol>
<li>与智能体：工作流是智能体任务规划的具象化呈现，智能体的“任务拆解与规划”能力需依托工作流定义的步骤逻辑，确保任务推进的有序性；同时，智能体的动态调整策略可反哺工作流优化，实现流程的柔性适配。</li>
<li>与提示词：提示词中的“工作流要求”是工作流在交互层的具体体现，通过向大模型/智能体传递步骤规则，引导其按预设流程执行任务；而工作流则为提示词提供了标准化的流程框架，避免步骤描述的模糊性。</li>
<li>与RAG+工具调用：工作流明确了RAG（静态知识补充）与工具调用（动态操作执行）的触发时机与衔接逻辑，例如“先通过RAG检索业务规范→再调用数据查询工具获取实操数据→最后由大模型生成分析报告”，确保两类技术精准配合。</li>
<li>与大模型：大模型是工作流各步骤的核心执行单元，负责理解任务需求、处理文本信息、生成中间结果；工作流则为大模型限定了执行边界，避免其因缺乏流程约束而偏离任务目标。</li>
</ol>
<h3 data-id="heading-37">6.3 核心类型与应用场景</h3>
<ol>
<li>固定流程型工作流：适用于步骤明确、规则固定的标准化任务，核心是通过流程固化提升效率。 - 场景示例：企业发票审核（步骤：调用OCR工具识别发票信息→通过RAG检索报销规范→调用财务系统校验金额→生成审核结果并推送）、客户咨询应答（步骤：接收用户问题→RAG检索知识库→大模型生成标准化回答→人工复核（可选）→推送结果）。</li>
<li>柔性适配型工作流：适用于需求多变、步骤存在不确定性的复杂任务，核心是结合智能体的动态调整能力实现流程适配。 - 场景示例：项目方案策划（步骤：明确策划目标→智能体拆解子任务（市场调研、需求分析、方案撰写等）→调用浏览器获取行业数据（工具调用）→RAG检索同类方案参考→大模型生成初稿→智能体反思优化→输出终稿）、个性化诊疗辅助（步骤：获取患者病历→调用影像分析工具处理检查结果→RAG检索临床指南→大模型生成初步诊疗建议→智能体结合医生反馈调整→形成最终方案）。</li>
</ol>
<h3 data-id="heading-38">6.4 落地关键要点</h3>
<ol>
<li>步骤拆解颗粒度：平衡“精细化”与“高效性”，过细的步骤会增加交互成本，过粗的步骤则会降低可控性；建议按“单一职责原则”拆解，确保每个步骤仅完成一项核心任务。</li>
<li>输入输出标准化：为每个步骤定义清晰的输入格式（如数据类型、参数要求）与输出标准（如结果格式、错误码规范），避免因数据不兼容导致流程中断。</li>
<li>异常处理机制：预设流程中断的应对策略，例如工具调用失败时的重试逻辑、RAG检索无结果时的兜底方案（如转人工处理）、大模型生成内容不符合要求时的重新生成规则。</li>
<li>可追溯性设计：记录工作流各步骤的执行日志（如执行时间、调用工具、生成结果、操作主体），便于后续问题排查、流程优化与责任追溯。</li>
</ol>
<h3 data-id="heading-39">6.5 主流实现工具</h3>
<p>落地工作流需依托专门的框架工具，实现流程的可视化搭建、执行与管理： - 通用框架：LangChain（支持与大模型、工具、RAG的深度集成，适合快速搭建简单工作流）、Airflow（侧重任务调度与监控，适合复杂定时工作流）； - 低代码平台：Make（原Integromat）、Zapier（支持无代码拖拽搭建工作流，适配非技术人员使用）； - 垂直领域工具：医疗领域的DrChrono（集成诊疗工作流与AI辅助能力）、企业办公领域的飞书多维表格（通过AI插件联动工作流）。</p>
<h2 data-id="heading-40">七、数据双引擎：数据库——智能体的业务操作与语义记忆载体</h2>
<p>智能体的运行依赖两类数据库的协同支撑，二者分工明确，分别承载“业务数据操作”和“语义记忆检索”两大核心需求，是智能体实现“业务落地+记忆进化”的基础。其中，结构化数据库的功能提供了一种简单、高效的方式来管理和处理结构化数据，开发者和用户可通过自然语言插入、查询、修改或删除数据库中的数据。</p>
<h3 data-id="heading-41">7.1 核心分类与定位</h3>


























<table><thead><tr><th>数据库类型</th><th>核心定位</th><th>关联技术</th><th>操作方式</th><th>典型工具</th></tr></thead><tbody><tr><td>结构化数据库</td><td>智能体操作真实业务数据的核心载体</td><td>工具调用（Function Calling）</td><td>大模型生成SQL语句，直接增删改查；支持自然语言驱动的数操作</td><td>MySQL、PostgreSQL、MongoDB（半结构化）</td></tr><tr><td>向量数据库</td><td>智能体RAG与长期记忆的专属语义载体</td><td>RAG、智能体长期记忆</td><td>嵌入模型生成向量+语义相似度检索，无SQL操作</td><td>FAISS、Chroma、Milvus、Pinecone</td></tr></tbody></table>
<h3 data-id="heading-42">7.2 结构化数据库：智能体的“业务操作中枢”</h3>
<h4 data-id="heading-43">7.2.1 核心定义</h4>
<p>存储企业结构化业务数据（客户信息、销售订单、库存台账、任务日志等）的载体，其功能提供了一种简单、高效的方式来管理和处理结构化数据。智能体可通过大模型将用户自然语言指令转换为标准化SQL语句，直接对数据进行插入、查询、修改或删除，无需用户手动编写SQL，是连接AI与现实业务系统的唯一接口。</p>
<h4 data-id="heading-44">7.2.2 智能体操作流程（SQL驱动闭环）</h4>
<ol>
<li>需求解析：智能体接收自然语言指令（如“查询2025年12月北京地区的空调销量”），依托大模型提取核心条件（时间、地区、品类）。</li>
<li>SQL生成与校验：大模型根据指令生成符合数据库语法的SQL语句，同时校验字段合法性与权限范围，示例： <code> SELECT product_model, sales_volume  `` FROM sales_data  ``WHERE sale_month = '2025-12' AND region = '北京' AND product_type = '空调';</code></li>
<li>权限管控与执行：智能体通过工具调用接口执行SQL，仅赋予“最小必要权限”（如查询类任务仅开放<code>SELECT</code>权限，禁止<code>DROP/ALTER</code>等高危操作），避免误操作风险。</li>
<li>结果转化与反馈：将数据库返回的结构化结果，通过大模型转换为自然语言回答，同时可生成可视化图表（如柱状图）辅助呈现。</li>
</ol>
<h4 data-id="heading-45">7.2.3 典型应用场景</h4>
<ul>
<li>销售业务：生成SQL查询客户历史订单、录入新订单数据、更新客户回款状态；</li>
<li>仓储管理：生成SQL扣减已发货商品库存、查询库存预警商品、新增入库记录；</li>
<li>任务日志：生成SQL记录智能体执行任务的时间、步骤、结果，用于后续流程追溯。</li>
</ul>
<h3 data-id="heading-46">7.3 向量数据库：智能体的“语义记忆中枢”</h3>
<h4 data-id="heading-47">7.3.1 核心定义</h4>
<p>存储非结构化数据向量表征（用户对话历史、私域文档片段、任务经验总结等）的载体，不支持SQL操作，仅通过“嵌入模型+语义检索”为RAG和长期记忆提供支撑，是智能体实现“语义级记忆”的核心工具。</p>
<h4 data-id="heading-48">7.3.2 核心工作流程（语义检索闭环）</h4>
<ol>
<li>向量生成：通过嵌入模型（如Sentence-BERT、text-embedding-ada-002）将非结构化数据转换为高维向量，向量距离越近，代表语义相似度越高；</li>
<li>向量存储：将生成的向量存入向量数据库，通过近似最近邻（ANN）算法构建索引，提升检索效率；</li>
<li>语义检索：将用户新指令转为向量，在数据库中检索相似度最高的Top-K向量，映射回原始文本数据（如用户上周提到的“偏好简洁报告”）；</li>
<li>结果应用：将检索到的语义信息整合到提示词中，指导智能体生成个性化、上下文连贯的输出。</li>
</ol>
<h4 data-id="heading-49">7.3.3 典型应用场景</h4>
<ul>
<li>RAG知识检索：检索企业产品手册、技术文档的向量片段，为大模型提供精准事实参考，对抗幻觉；</li>
<li>用户记忆检索：检索用户历史对话向量，记住用户偏好（如“不喜欢专业术语”）、需求（如“需要每周生成销售报告”）；</li>
<li>任务经验检索：检索同类任务的执行经验向量，复用成功策略（如“某类数据分析需调用特定API”）。</li>
</ul>
<h3 data-id="heading-50">7.4 两类数据库的协同逻辑（智能体视角）</h3>
<p>以“生成客户个性化跟进报告”为例，看两类数据库的联动流程：</p>
<ol>
<li>智能体接收指令：“生成客户李总的跟进报告，包含他的历史订单和上次提到的需求”；</li>
<li>调用结构化数据库：大模型生成SQL，查询<code>customer_order</code>表中李总的历史订单数据（订单号、金额、产品类型）；</li>
<li>调用向量数据库：将指令转为向量，检索与“李总上次需求”相关的对话向量，获取“需要定制化售后方案”的语义信息；</li>
<li>整合生成报告：大模型结合结构化订单数据和向量检索的需求信息，生成个性化跟进报告；</li>
<li>数据存储闭环：将报告内容转为向量存入向量数据库（更新长期记忆），同时将报告生成记录存入结构化数据库（更新任务日志）。</li>
</ol>
<h2 data-id="heading-51">八、能力沉淀：长期记忆——智能体的“语义经验库”</h2>
<p>智能体的长期记忆是基于向量数据库构建的语义级记忆系统，专注存储非结构化的交互经验与知识，支持跨会话复用，是智能体从“单次执行者”升级为“可进化伙伴”的核心能力。</p>
<h3 data-id="heading-52">8.1 核心定义</h3>
<p>智能体依托向量数据库，对用户交互历史、任务执行经验、RAG检索知识进行语义化存储与复用的能力，核心特征是“语义关联检索”，而非结构化数据的增删改查。</p>
<h3 data-id="heading-53">8.2 核心分类与存储载体</h3>
<p>长期记忆的所有内容均以向量形式存储在向量数据库中，按用途分为三类：</p>





























<table><thead><tr><th>记忆类型</th><th>存储内容</th><th>核心作用</th><th>检索触发条件</th></tr></thead><tbody><tr><td>用户记忆</td><td>用户身份信息、沟通偏好（如“喜欢简洁表达”）、历史需求（如“需要月度库存报告”）</td><td>实现个性化交互，避免重复提问，提升用户体验</td><td>接收到同一用户的新指令时</td></tr><tr><td>任务记忆</td><td>任务拆解步骤、工具调用策略、执行成功/失败经验（如“某API调用需传入region参数”）</td><td>复用同类任务经验，优化执行效率，减少试错成本</td><td>接收到同类任务指令时</td></tr><tr><td>知识记忆</td><td>RAG检索到的权威知识（如产品参数、行业规范）、外部工具获取的关键信息</td><td>补充智能体专业知识储备，提升复杂任务的决策精度</td><td>接收到涉及专业领域的指令时</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 核心工作流程（向量驱动的记忆闭环）</h3>
<h4 data-id="heading-55">8.3.1 记忆存储</h4>
<p>智能体在任务执行过程中，将三类非结构化数据转换为向量，存入向量数据库：</p>
<ol>
<li>用户交互数据：将用户对话内容（如“报告不要超过3页”）通过嵌入模型转为向量；</li>
<li>任务执行数据：将任务拆解步骤、工具调用结果（如“调用天气API失败，因参数格式错误”）转为向量；</li>
<li>知识数据：将RAG检索到的文档片段（如“产品A的保修期为2年”）转为向量。</li>
</ol>
<h4 data-id="heading-56">8.3.2 记忆检索</h4>
<p>智能体接收新指令后，通过“语义匹配”检索相关记忆：</p>
<ol>
<li>将新指令转为向量，在向量数据库中检索相似度最高的Top-K向量；</li>
<li>过滤冗余信息（如已失效的任务经验），优先检索高价值记忆（如用户长期偏好）；</li>
<li>将检索到的记忆内容整合到提示词中，指导任务执行。</li>
</ol>
<h4 data-id="heading-57">8.3.3 记忆更新与进化</h4>
<p>任务完成后，智能体根据执行反馈更新记忆：</p>
<ol>
<li>新增有效记忆：将成功的任务策略（如“查询销量需同时筛选时间和地区”）转为向量存入；</li>
<li>标记无效记忆：将失败经验（如“某API已停用”）标注为低优先级，避免后续复用；</li>
<li>记忆压缩：定期清理重复、过时的向量数据，提升检索效率。</li>
</ol>
<h3 data-id="heading-58">8.4 关键技术挑战与优化方向</h3>
<h4 data-id="heading-59">8.4.1 核心挑战</h4>
<ol>
<li>记忆冗余：长期积累的海量向量数据可能包含无效信息，导致检索效率下降；</li>
<li>语义歧义：相似表述可能被误判为不同语义（如“简洁报告”和“简短报告”）；</li>
<li>隐私风险：用户记忆包含敏感信息（如联系方式、业务需求），存在泄露风险。</li>
</ol>
<h4 data-id="heading-60">8.4.2 优化方向</h4>
<ol>
<li>记忆清洗：基于使用频率和有效性，自动清理低价值向量数据；</li>
<li>语义增强：采用更先进的嵌入模型（如多模态嵌入），提升语义检索的精准度；</li>
<li>隐私保护：对用户敏感信息向量进行加密存储，设置检索权限分级。</li>
</ol>
<h3 data-id="heading-61">8.5 与核心技术的关联</h3>
<ol>
<li>与向量数据库：向量数据库是长期记忆的唯一存储载体，没有向量数据库，智能体无法实现语义级的记忆与检索；</li>
<li>与RAG：RAG检索的知识是长期记忆的重要来源，而长期记忆中的知识可反哺RAG，提升后续检索的精准度；</li>
<li>与智能体：长期记忆是智能体“自主进化”的核心支撑，让智能体能够从历史经验中学习，而非每次从零开始。</li>
</ol>
<h2 data-id="heading-62">九、技术体系核心逻辑总结</h2>
<p>整个AI核心技术体系围绕“大模型能力延伸+智能体闭环落地”展开，形成“基础层-交互层-增强层-数据层-应用层”的五层协同架构，各模块分工明确、相互支撑，共同推动AI从“基础智能工具”走向“复杂业务系统”。</p>
<ol>
<li><strong>基础层：大模型（LLM）—— 原生智能引擎</strong>提供自然语言理解、生成、逻辑推理的核心能力，是整个技术体系的底层基础。其原生短板（被动响应、无长期记忆、易幻觉）是所有上层技术需要解决的核心目标，决定了体系的基础智能上限。</li>
<li><strong>交互层：提示词（Prompt）—— 精准指令桥梁</strong>作为用户与AI系统的交互媒介，通过结构化指令对齐用户需求与模型能力，约束输出边界、减少幻觉风险。同时为智能体的任务规划、RAG的检索增强、工具调用的参数生成提供明确指引，是提升AI输出精准度的“低成本杠杆”。</li>
<li><strong>增强层：RAG + 工具调用（Function Calling）—— 能力延伸双抓手</strong>从两个维度弥补大模型的核心短板，实现“静态知识+动态操作”的双重增强：</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索]]></title>    <link>https://juejin.cn/post/7585808181240102963</link>    <guid>https://juejin.cn/post/7585808181240102963</guid>    <pubDate>2025-12-22T02:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181240102963" data-draft-id="7585839411123191854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-22T02:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:47:59.000Z" title="Mon Dec 22 2025 02:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 JavaScript 编程的世界里，<code>this</code> 是一个既基础又令人困惑的概念。它看似简单，却常常在不经意间“背叛”我们的预期；它灵活多变，却又遵循着一套严格的规则。尤其当与 <code>call</code>、<code>apply</code>、<code>bind</code> 以及 ES6 引入的<strong>箭头函数</strong>结合时，<code>this</code> 的行为变得更加微妙而强大。</p>
<p>本文将结合代码，对 <code>this</code> 的机制进行一次全面、深入且生动的剖析。我们将逐字引用原始代码片段，还原其技术含义，并通过大量示例揭示背后的原理。无论你是初学者还是资深开发者，相信都能从中获得新的洞见。</p>
<hr/>
<h2 data-id="heading-1">一、核心内容</h2>
<p>我们可以将this问题拆解为几个核心命题：</p>
<ol>
<li><strong><code>this</code> 可以被覆盖</strong></li>
<li><strong><code>bind</code> 用于定时器中绑定 <code>this</code>，延迟执行</strong></li>
<li><strong><code>call</code> / <code>apply</code> 可指定 <code>this</code> 指向，并立即运行</strong></li>
<li><strong><code>that = this</code> 利用作用域链保存 <code>this</code></strong></li>
<li><strong>箭头函数没有自己的 <code>this</code>，而是继承父级作用域的 <code>this</code></strong></li>
</ol>
<p>接下来，我们将围绕这五点展开详细论述。</p>
<p>源代码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fbatjtmd%2Fthis" title="https://gitee.com/giaoZou/lesson_zp/tree/master/batjtmd/this" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/batjtmd/this: AI + 全栈学习仓库</a></p>
<hr/>
<h2 data-id="heading-2">二、this 的默认行为：谁调用，就属于谁</h2>
<p>在深入高级技巧前，必须先理解 <code>this</code> 的<strong>默认绑定规则</strong>。</p>
<h3 data-id="heading-3">1. 全局上下文中的 this</h3>
<p>在非严格模式下，全局作用域中的 <code>this</code> 指向全局对象（浏览器中是 <code>window</code>，Node.js 中是 <code>global</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === <span class="hljs-variable language_">window</span>); <span class="hljs-comment">// true (浏览器)</span>
</code></pre>
<p>在严格模式下，全局函数中的 <code>this</code> 为 <code>undefined</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); }
<span class="hljs-title function_">f</span>(); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-4">2. 对象方法中的 this</h3>
<p>当函数作为对象的方法被调用时，<code>this</code> 指向该对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
};
obj.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// "Alice"</span>
</code></pre>
<p>但注意：<strong>函数一旦脱离对象调用，this 就会丢失</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = obj.greet<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">; // 非严格模式下输出 undefined（this 指向 window）</span>
</code></pre>
<p>这就是为什么我们需要 <code>call</code>、<code>bind</code> 等工具来“拯救”迷失的 <code>this</code>。</p>
<hr/>
<h2 data-id="heading-5">三、call 与 apply：强制指定 this，立即执行！</h2>
<h3 data-id="heading-6">原理与语法</h3>
<ul>
<li><code>func.call(thisArg, arg1, arg2, ...)</code></li>
<li><code>func.apply(thisArg, [arg1, arg2, ...])</code></li>
</ul>
<p>两者功能相同，区别仅在于参数传递方式。</p>
<blockquote>
<p>“call apply 指定this 指向 立即运行”</p>
</blockquote>
<p><code>call</code> 和 <code>apply</code> 的核心作用就是在<strong>调用函数的同时</strong>，显式指定 <code>this</code> 的值，并<strong>立刻执行</strong>该函数。</p>
<h3 data-id="heading-7">示例演示</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">introduce</span>(<span class="hljs-params">age</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${age}</span> years old.`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> };

introduce.<span class="hljs-title function_">call</span>(person, <span class="hljs-number">25</span>);   <span class="hljs-comment">// I'm Bob, 25 years old.</span>
introduce.<span class="hljs-title function_">apply</span>(person, [<span class="hljs-number">30</span>]); <span class="hljs-comment">// I'm Bob, 30 years old.</span>
</code></pre>
<p>即使 <code>introduce</code> 不是 <code>person</code> 的方法，我们也能让它“假装”是——这就是 <code>this</code> 的灵活性。</p>
<h3 data-id="heading-8">实际应用场景</h3>
<ul>
<li>
<p>数组方法借用（如将类数组转为真数组）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
</code></pre>
</li>
<li>
<p>通用工具函数适配不同上下文。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、bind：永久绑定 this，延迟执行</h2>
<h3 data-id="heading-10">原理与语法</h3>
<p><code>func.bind(thisArg, arg1, arg2, ...)</code> 返回一个<strong>新函数</strong>，该函数的 <code>this</code> 被永久绑定到 <code>thisArg</code>，且可预设部分参数（柯里化）。</p>
<blockquote>
<p>“bind 定时器this绑定(a) 以后再执行”</p>
</blockquote>
<p>这句话精准指出了 <code>bind</code> 的两大特点：</p>
<ol>
<li><strong>常用于定时器等异步回调中绑定 <code>this</code></strong></li>
<li><strong>不立即执行，而是返回一个可稍后调用的函数</strong></li>
</ol>
<h3 data-id="heading-11">经典问题：setTimeout 中的 this 丢失</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// ❌ this 指向 global/window</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 输出 NaN（因为 window.seconds 未定义）</span>
</code></pre>
<h3 data-id="heading-12">解决方案一：使用 bind</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// ✅ 绑定外层 this</span>
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 1, 2, 3...</span>
</code></pre>
<p>这里，<code>.bind(this)</code> 创建了一个新函数，其 <code>this</code> 永久指向 <code>timer</code> 对象，无论何时被调用都不会改变。</p>
<h3 data-id="heading-13">解决方案二：that = this（闭包保存）</h3>
<blockquote>
<p>“that = this; 作用域链保存this且指向”</p>
</blockquote>
<p>这是 ES5 时代的经典写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存 this 到变量</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      that.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// 通过闭包访问</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(that.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
</code></pre>
<p>虽然有效，但需要额外变量，且在深层嵌套中容易混乱。<code>bind</code> 更加声明式和安全。</p>
<hr/>
<h2 data-id="heading-14">五、箭头函数：没有 this 的“佛系”函数</h2>
<h3 data-id="heading-15">核心特性</h3>
<p>箭头函数（Arrow Function）<strong>没有自己的 <code>this</code></strong>。它不会创建新的 <code>this</code> 上下文，而是<strong>词法地继承外层作用域的 <code>this</code></strong>。</p>
<blockquote>
<p>“Cherry箭头函数放弃了自己的this，没有this 指向指向 父级作用域的this”</p>
</blockquote>
<p>这句话堪称对箭头函数 <code>this</code> 行为的完美概括！</p>
<ul>
<li>“放弃了自己的 this” → 箭头函数内部不存在 <code>this</code> 绑定。</li>
<li>“指向父级作用域的 this” → 它的 <code>this</code> 由定义时的外层作用域决定，与调用方式无关。</li>
</ul>
<h3 data-id="heading-16">示例对比</h3>
<h4 data-id="heading-17">普通函数（this 丢失）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'David'</span>,
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ❌ undefined</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<h4 data-id="heading-18">箭头函数（自动继承）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Cherry'</span>, <span class="hljs-comment">// 注意：原文特意用了 "Cherry"</span>
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ✅ "Cherry"</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<p>为什么能成功？因为箭头函数的 <code>this</code> 继承自 <code>delayedLog</code> 方法，而 <code>delayedLog</code> 的 <code>this</code> 指向 <code>obj</code>。</p>
<h3 data-id="heading-19">箭头函数的不可变性</h3>
<p>由于箭头函数没有 <code>this</code>，所以以下操作无效：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = () =&gt; console.log(this.name)<span class="hljs-comment">;</span>
const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">'Eve'</span> }<span class="hljs-comment">;</span>

fn.call(obj)<span class="hljs-comment">;   // 仍输出全局作用域的 name（或 undefined）</span>
fn.bind(obj)()<span class="hljs-comment">; // 同上</span>
</code></pre>
<p><code>call</code>、<code>apply</code>、<code>bind</code> 对箭头函数的 <code>this</code> <strong>毫无影响</strong>。</p>
<h3 data-id="heading-20">适用场景 vs 陷阱</h3>
<p>✅ <strong>适合</strong>：</p>
<ul>
<li>回调函数（如 <code>map</code>, <code>filter</code>, <code>setTimeout</code>）</li>
<li>避免 <code>that = this</code> 的样板代码</li>
</ul>
<p>❌ <strong>不适合</strong>：</p>
<ul>
<li>对象方法（会继承外层 this，可能不是对象本身）</li>
<li>构造函数（箭头函数不能用 <code>new</code> 调用）</li>
<li>需要动态 <code>this</code> 的场景</li>
</ul>
<hr/>
<h2 data-id="heading-21">六、综合案例：四种方式对比</h2>
<p>假设我们有一个计数器对象，需要在 1 秒后打印当前值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> counter = {
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  
  <span class="hljs-comment">// 方式1：普通函数 + that = this</span>
  <span class="hljs-title function_">method1</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method1:'</span>, self.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式2：bind</span>
  <span class="hljs-title function_">method2</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method2:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式3：箭头函数</span>
  <span class="hljs-title function_">method3</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method3:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式4：call（需立即执行，不适合定时器，但可模拟）</span>
  <span class="hljs-title function_">method4</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method4:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>); };
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// 结合箭头+call</span>
  }
};

counter.<span class="hljs-title function_">method1</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method2</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method3</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method4</span>(); <span class="hljs-comment">// 0</span>
</code></pre>
<p>四种方式都能正确输出，但<strong>箭头函数最简洁</strong>，<strong>bind 最显式</strong>，<strong>that = this 最传统</strong>。</p>
<hr/>
<h2 data-id="heading-22">七、this 绑定优先级总结</h2>
<p>当多个规则同时存在时，JavaScript 按以下优先级确定 <code>this</code>：</p>
<ol>
<li><strong>new 绑定</strong>（构造函数）→ 最高</li>
<li><strong>显式绑定</strong>（<code>call</code> / <code>apply</code> / <code>bind</code>）</li>
<li><strong>隐式绑定</strong>（对象方法调用，如 <code>obj.fn()</code>）</li>
<li><strong>默认绑定</strong>（独立函数调用）</li>
</ol>
<blockquote>
<p>箭头函数不参与此规则，因为它根本没有 <code>this</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">八、常见误区与最佳实践</h2>
<h3 data-id="heading-24">误区1：认为箭头函数总是更好</h3>
<p>错！箭头函数在对象方法中会导致 <code>this</code> 指向外层（可能是全局）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> badObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Bad'</span>,
  <span class="hljs-attr">getName</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> <span class="hljs-comment">// ❌ this 指向全局</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(badObj.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// undefined</span>
</code></pre>
<p>应使用普通函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> goodObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Good'</span>,
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; } <span class="hljs-comment">// ✅</span>
};
</code></pre>
<h3 data-id="heading-25">误区2：bind 后还能被 call 覆盖</h3>
<p>不能！<code>bind</code> 创建的函数其 <code>this</code> 是<strong>永久锁定</strong>的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>); }
<span class="hljs-keyword">const</span> bound = f.<span class="hljs-title function_">bind</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>});
bound.<span class="hljs-title function_">call</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">2</span>}); <span class="hljs-comment">// 输出 1，不是 2！</span>
</code></pre>
<h3 data-id="heading-26">最佳实践</h3>
<ul>
<li>在类方法或对象方法中，使用普通函数。</li>
<li>在回调、事件监听、定时器中，优先考虑箭头函数。</li>
<li>若需兼容旧环境或需要预设参数，使用 <code>bind</code>。</li>
<li>避免过度使用 <code>that = this</code>，除非在不支持箭头函数的环境中。</li>
</ul>
<hr/>
<h2 data-id="heading-27">九、结语：掌握 this，就是掌握 JavaScript 的灵魂</h2>
<p>现在，我们不仅读懂了它，更理解了其背后的技术哲学：</p>
<ul>
<li><strong><code>call</code>/<code>apply</code></strong> 是“命令式”的干预——我要你现在就用这个 <code>this</code>！</li>
<li><strong><code>bind</code></strong> 是“防御式”的设计——无论何时调用，都必须用这个 <code>this</code>！</li>
<li><strong><code>that = this</code></strong> 是“妥协式”的智慧——既然你靠不住，我就自己存一份！</li>
<li><strong>箭头函数</strong> 是“声明式”的优雅——我不需要 <code>this</code>，我信任我的上下文！</li>
</ul>
<p>JavaScript 的魅力，正在于这种灵活性与规则性的统一。当你能自如地在这些工具之间切换，你就不再是 <code>this</code> 的奴隶，而是它的主人。</p>
<p>愿你在未来的代码中，不再对 <code>this</code> 感到迷茫，而是微笑着说：</p>
<blockquote>
<p>“我知道你是谁，也知道你该去哪。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验]]></title>    <link>https://juejin.cn/post/7586208617603366946</link>    <guid>https://juejin.cn/post/7586208617603366946</guid>    <pubDate>2025-12-22T03:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603366946" data-draft-id="7585888537642450959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T03:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gohchunlin"/> <meta itemprop="url" content="https://juejin.cn/user/3491704660036302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704660036302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gohchunlin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:23:47.000Z" title="Mon Dec 22 2025 03:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近我处理了一个离散事件仿真（Discrete Event Simulation，DES）的项目，面临一个经典难题：代码逻辑完全正确，但运行速度慢到令人绝望。</p>
<p>如果按照传统的单机思路，完成一次可靠的蒙特卡洛（Monte Carlo）实验需要到 2026 年才能跑出结果。本文将分享我如何打利用 Kubernetes （K8s） 和 Argo Workflows 构建一套“仿真实验室”，实现算力跃升。</p>
<h2 data-id="heading-1">核心痛点：为什么“加 CPU”解决不了问题？</h2>
<p>在离散事件仿真中，系统的完整性依赖于一个<strong>统一的虚拟时钟</strong>和<strong>中央未来事件列表（Future Event List, FEL）</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/197ecf5cebc8414185371a5a5139fb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=9FuJE1Ep44sZTIiI3o6yRJMnhIg%3D" alt="" loading="lazy"/></p>
<p>DES 的核心逻辑是严格按时间顺序处理事件。这意味着：</p>
<ul>
<li>你无法将单个仿真任务拆分到多个 Pod 上跑。</li>
<li>各节点间的网络延迟会彻底摧毁事件的因果链。</li>
<li><strong>结论：</strong> 单次仿真任务在架构上是<strong>天然单线程</strong>的。</li>
</ul>
<p>虽然我们无法并行化“单个仿真”，但我们可以并行化“整个实验”。这是一个典型的 <strong>“尴尬并行”（Embarrassingly Parallel）</strong> 场景。</p>
<h2 data-id="heading-2">架构设计：从“服务器”转向“实验室”</h2>
<p>为了解决 5,000 次参数扫频（Parameter Sweeps）的需求，我将 Kubernetes 从一个“托管网站的平台”转化为一台“按需使用的超级计算机”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d10789b1b24dde827de9d864ee11ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=zm80z4Mqx9u6FbuSlCnVbaydhxw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">执行引擎：Headless .NET 10</h3>
<p>底层基于 .NET Console 程序，关键点在于利用 System.CommandLine 建立容器与编排器之间的<strong>严格契约</strong>。</p>
<p>我们将仿真变量设置为 CLI 参数。</p>
<pre><code class="hljs language-dart" lang="dart">using System.CommandLine;

<span class="hljs-comment">// 定义根命令</span>
<span class="hljs-keyword">var</span> rootCommand = <span class="hljs-keyword">new</span> RootCommand { Description = <span class="hljs-string">"离散事件仿真 CLI 工具"</span> };

<span class="hljs-comment">// 核心参数：平均到达时间</span>
<span class="hljs-keyword">var</span> meanArrivalSecondsOption = <span class="hljs-keyword">new</span> Option&lt;<span class="hljs-built_in">double</span>&gt;(
    name: <span class="hljs-string">"--arrival-secs"</span>,
    description: <span class="hljs-string">"Mean arrival time in seconds."</span>,
    getDefaultValue: () =&gt; <span class="hljs-number">5.0</span>
);

<span class="hljs-keyword">var</span> simpleServerCommand = <span class="hljs-keyword">new</span> Command(<span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"运行仿真演示"</span>);
simpleServerCommand.AddOption(meanArrivalSecondsOption);

simpleServerCommand.SetHandler((<span class="hljs-built_in">double</span> meanArrivalSeconds) =&gt;
{
    <span class="hljs-comment">// 这里的逻辑是单线程的，但它是可配置的</span>
    SimpleServerAndGenerator.RunDemo(loggerFactory, meanArrivalSeconds);
}, meanArrivalSecondsOption);
</code></pre>
<h3 data-id="heading-4">任务编排：Argo Workflows</h3>
<p>很多人第一反应是使用原生 K8s Job。但在大规模场景下，原生 Job 太过简陋，难以可视化，且异常处理成本极高。</p>
<p>我选择了 <strong>Argo Workflows</strong>。它的杀手锏是 withItems（或 withParam），可以轻松实现<strong>扇出（Fan-out）</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Workflow</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">generateName:</span> <span class="hljs-string">sna-parallel-experiment-</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">entrypoint:</span> <span class="hljs-string">sna-demo</span>
  <span class="hljs-attr">templates:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sna-demo</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run-simulation</span>
        <span class="hljs-attr">template:</span> <span class="hljs-string">simulation-job</span>
        <span class="hljs-attr">arguments:</span>
          <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{item}}</span>"</span>}]
        <span class="hljs-comment"># 核心：定义参数池，Argo 会自动调度成百上千的 Pod 并发执行</span>
        <span class="hljs-attr">withItems:</span> [<span class="hljs-string">"5"</span>, <span class="hljs-string">"10"</span>, <span class="hljs-string">"15"</span>, <span class="hljs-string">"20"</span>, <span class="hljs-string">"25"</span>] 

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">simulation-job</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>}]
    <span class="hljs-attr">container:</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">my-registry/sna-demo:latest</span>
      <span class="hljs-attr">args:</span> [<span class="hljs-string">"demo"</span>, <span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"--arrival-secs"</span>, <span class="hljs-string">"<span class="hljs-template-variable">{{inputs.parameters.arrival-secs}}</span>"</span>]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276d08d3e8df4167811067428bc28dd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=V21tZI4TjxDMLIK6KcqmGE0Tce4%3D" alt="" loading="lazy"/></p>
<p>Argo 帮我们处理了节流（Throttling）、并发控制和失败重试，我们只需声明实验目标。</p>
<h3 data-id="heading-5">结构化日志</h3>
<p>当一千个 Pod 同时运行时，kubectl logs 毫无意义。我们所要面对的是每分钟数大量的文本流。</p>
<p>因此，我们必须弃用纯文本日志，改用 <strong>结构化日志 (Structured Logging)</strong>。通过 Serilog 将参数和结果绑定为 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-05-20T10:00:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Information"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Simulation Completed"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"WorkerCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ServiceTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12.5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Throughput"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.98</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c7724ded21d4b06873313af21e0473e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=HllnWYa%2FFXwdWVDHWfE1caaaHJk%3D" alt="" loading="lazy"/></p>
<p>配合 <strong>Seq</strong> 或 <strong>ELK</strong>，我们就可以直接通过 SQL 语句在几万份实验结果中精准定位异常点。</p>
<h2 data-id="heading-6">实战复盘</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a022624743dc46329e69c114b26353d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=286usV3R9RNVSKwDuvb%2BFWBya2Q%3D" alt="" loading="lazy"/></p>
<p>在最近的台北 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fhwdc.ithome.com.tw%2F2025%2Fsession-page%2F4063" target="_blank" title="https://hwdc.ithome.com.tw/2025/session-page/4063" ref="nofollow noopener noreferrer">Hello World Developer Conference 2025</a></strong> 上，我也分享了这一模型。通过这套架构：</p>
<ol>
<li><strong>开发效率：</strong> C# 核心逻辑无需任何分布式改造。</li>
<li><strong>算力利用：</strong> 以前单机跑一周的实验，现在在 K8s 集群上 10 分钟内跑完。</li>
<li><strong>可维护性：</strong> 所有的实验参数都是声明式的，可追溯、可重现。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p>Kubernetes 的强大不仅在于托管微服务，更在于它处理<strong>大规模并发计算</strong>的能力。通过将“执行引擎”与“编排大脑”解耦，我们能让老旧的单线程程序在云原生时代焕发新生。</p>
<p><strong>项目开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgcl-team%2FSNA**" target="_blank" title="https://github.com/gcl-team/SNA**" ref="nofollow noopener noreferrer">github.com/gcl-team/SN…</a> (欢迎交流指正)</p>
<p>--------</p>
<p><em>作者简介：坐标新加坡，20年架构/SRE经验。专注可观测性 (O11y) 与系统稳定性。Grafana &amp; Friends SG 社区主理人。 业余项目：正在开发 SNA。试图用算法模拟高并发场景下的排队论与系统瓶颈（用 AI 辅助构建）。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[利用 WebMKS 和 Java 实现前端访问虚拟机网页]]></title>    <link>https://juejin.cn/post/7586157459971538996</link>    <guid>https://juejin.cn/post/7586157459971538996</guid>    <pubDate>2025-12-22T02:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971538996" data-draft-id="7585850609017110543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="利用 WebMKS 和 Java 实现前端访问虚拟机网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T02:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="404NotFound305"/> <meta itemprop="url" content="https://juejin.cn/user/270910253182796"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            利用 WebMKS 和 Java 实现前端访问虚拟机网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/270910253182796/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    404NotFound305
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:55:56.000Z" title="Mon Dec 22 2025 02:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实战干货：手把手教你用 WebMKS 和 Java 搞定 ESXi 虚拟机网页控制台</h2>
<p>最近在折腾虚拟机网页控制台，发现用 VMware 原生的 WebMKS SDK 配合 ESXi 的 API 效果最好。这套方案不用装插件，直接在浏览器里就能操作。把中间踩过的坑和实现逻辑整理出来，希望能帮到大家。</p>
<hr/>
<h3 data-id="heading-1">1. 准备工作：依赖得放本地</h3>
<p>WebMKS 这个 SDK 比较老派，它离不开 <strong>jQuery</strong>。为了稳妥，别用 CDN，直接把这几个文件下载下来放到你项目的 <code>public/static/wmks</code> 目录下。</p>
<h4 data-id="heading-2">怎么引入？</h4>
<p>在 <code>index.html</code> 里按这个顺序排好，jQuery 必须在最前面，不然 SDK 报错。</p>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/wmks/css/wmks-all.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 后端：Java 怎么拿 Ticket</h3>
<p>控制台连接前得先要个“门票”（Ticket）。后端用 Java 调用官方的 <code>vijava</code> 库，去 ESXi 那里申请一个。</p>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>连上 ESXi。</li>
<li>靠 UUID 找到那台虚拟机。</li>
<li>申请一个类型叫 <code>webmks</code> 的票据。</li>
</ol>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> TicketInfo <span class="hljs-title function_">getVmTicket</span><span class="hljs-params">(String host, String user, String pwd, String vmUuid)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 建立连接</span>
    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://"</span> + host + <span class="hljs-string">"/sdk"</span>), user, pwd, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">InventoryNavigator</span> <span class="hljs-variable">nav</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryNavigator</span>(si.getRootFolder());
        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> (VirtualMachine) nav.searchManagedEntity(<span class="hljs-string">"VirtualMachine"</span>, vmUuid);
        
        <span class="hljs-comment">// 关键：拿 webmks 票据</span>
        <span class="hljs-type">VirtualMachineTicket</span> <span class="hljs-variable">vmt</span> <span class="hljs-operator">=</span> vm.acquireTicket(<span class="hljs-string">"webmks"</span>);
        
        <span class="hljs-comment">// 把票据、主机IP、端口发给前端</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TicketInfo</span>(vmt.getTicket(), vmt.getHost(), <span class="hljs-number">443</span>);
    } <span class="hljs-keyword">finally</span> {
        si.getServerConnection().logout(); <span class="hljs-comment">// 记得退出登录，不然会话堆积</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 前端：Vue 3 里的核心控制</h3>
<h4 data-id="heading-5">初始化连接</h4>
<p>在 Vue 里的思路是：拿到票据后，立刻初始化 SDK 并连上 WebSocket。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">startWMKS</span> = (<span class="hljs-params">ticket: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WMKS_LIB</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">WMKS</span>;
  
  <span class="hljs-comment">// 初始化配置</span>
  wmksInstance.<span class="hljs-property">value</span> = <span class="hljs-variable constant_">WMKS_LIB</span>.<span class="hljs-title function_">createWMKS</span>(<span class="hljs-string">"wmks-container"</span>, {
    <span class="hljs-attr">enableHints</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">changeResolutionOnResizing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 窗口变了，分辨率也跟着变</span>
    <span class="hljs-attr">rescaleOnParentResize</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 自动缩放</span>
    <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>
  });

  <span class="hljs-comment">// 连上 ESXi 的 443 端口</span>
  wmksInstance.<span class="hljs-property">value</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-string">`wss://<span class="hljs-subst">${activeVM.value.host}</span>:443/ticket/<span class="hljs-subst">${ticket}</span>`</span>);
};
</code></pre>
<h4 data-id="heading-6">全屏怎么变清晰？</h4>
<p>全屏时如果直接拉伸，画面会糊。我的办法是：<strong>先断开，变全屏，再重连</strong>。虽然多等了半秒，但画面会根据全屏后的尺寸重新协商，清晰度瞬间提升。</p>
<hr/>
<h3 data-id="heading-7">4. Windows 虚拟机的专项关照</h3>
<p>搞 Linux 基本没啥事，但 Windows 挺挑剔，这几点没做到肯定出问题：</p>
<ol>
<li><strong>必装 VMware Tools</strong>：不装的话，显卡驱动不行，画面传输慢甚至直接黑屏。</li>
<li><strong>显存给够</strong>：Windows 10 这种系统，显存起码给到 <strong>128MB</strong>。</li>
<li><strong>CAD 按钮</strong>：Windows 登录得按 <code>Ctrl+Alt+Del</code>。网页里按没用，必须给用户做个按钮调用 <code>wmksInstance.sendCAD()</code>。</li>
</ol>
<hr/>
<h3 data-id="heading-8">5. 样式：别留白边</h3>
<p>为了让黑色背景铺满整个弹窗，CSS 得这么写：</p>
<p>SCSS</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 弹窗样式 */</span>
:<span class="hljs-built_in">deep</span>(.vnc-session-dialog) {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span> <span class="hljs-meta">!important</span>;

  <span class="hljs-comment">/* 全屏模式强行占满 */</span>
  &amp;<span class="hljs-selector-class">.is-fullscreen</span> { 
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-selector-class">.el-dialog__body</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">flex-direction</span>: column; }
  }

  <span class="hljs-comment">/* 核心：让 body 自动撑开 */</span>
  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">总结一下</h3>
<p>做这玩意儿逻辑其实不难，关键在于细节：</p>
<ul>
<li><strong>顺序</strong>：jQuery 必须先引。</li>
<li><strong>时机</strong>：全屏重连能解决画面糊的问题。</li>
<li><strong>补丁</strong>：给 Windows 留个 CAD 按钮，装好 VMware Tools。</li>
</ul>
<p>只要这几点对齐了，剩下的就是调 UI 让它看着更顺手的事儿了。
最后放上图片和源码</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-app-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"brand"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"28"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#409eff"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Monitor</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>VMware 虚拟化资源管理<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-grid"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(vm, index) in vmList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-mini-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-status-bar"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"vm.status"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-card-body"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-icon"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Platform</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"vm.os === 'windows'"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Cpu</span> <span class="hljs-attr">v-else</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-details"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-name"</span>&gt;</span>{{ vm.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-ip"</span>&gt;</span>{{ vm.host }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-actions"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"openConsole(vm)"</span>&gt;</span>
              连接控制台
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>UUID: {{ vm.vmUuid.substring(0, 14) }}...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"vncDialogVisible"</span> 
      <span class="hljs-attr">:fullscreen</span>=<span class="hljs-string">"isFullscreen"</span>
      <span class="hljs-attr">:width</span>=<span class="hljs-string">"isFullscreen ? '100%' : '1100px'"</span> 
      <span class="hljs-attr">top</span>=<span class="hljs-string">"5vh"</span>
      <span class="hljs-attr">:draggable</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">:show-close</span>=<span class="hljs-string">"false"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-session-dialog"</span>
      <span class="hljs-attr">:before-close</span>=<span class="hljs-string">"handleCloseVNC"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-header drag-area"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-info"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"connectionClass"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-name"</span>&gt;</span>
              {{ activeVM?.name }} | {{ activeVM?.host }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendCAD"</span>&gt;</span>CAD<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleFullscreen"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">FullScreen</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isFullscreen"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CopyDocument</span> <span class="hljs-attr">v-else</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleCloseVNC"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Close</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"session-stage"</span> 
        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"reloading"</span> 
        <span class="hljs-attr">element-loading-background</span>=<span class="hljs-string">"rgba(0, 0, 0, 0.9)"</span>
        <span class="hljs-attr">element-loading-text</span>=<span class="hljs-string">"正在重构画面..."</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wmks-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, nextTick, computed, onBeforeUnmount } from 'vue'
import { ElMessage } from 'element-plus'
import { Monitor, FullScreen, Close, CopyDocument, Platform, Cpu } from '@element-plus/icons-vue'
import { getVmConsoleTicket } from '@/api/taskManagement/vmConsole'


const vmList = ref([
  { 
    name: 'Windows-测试机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'windows',
    status: 'online'
  },
  { 
    name: 'Linux-生产机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'linux',
    status: 'online'
  }
])

const activeVM = ref&lt;any&gt;(null)
const vncDialogVisible = ref(false)
const isFullscreen = ref(false)
const reloading = ref(false)
const vncStatus = ref('disconnected')
const wmksInstance = ref&lt;any&gt;(null)

const connectionClass = computed(() =&gt; ({
  'is-connecting': vncStatus.value === 'connecting',
  'is-connected': vncStatus.value === 'connected'
}))


const openConsole = (vm: any) =&gt; {
  activeVM.value = vm;
  handleConnect(false);
}

const toggleFullscreen = async () =&gt; {
  reloading.value = true;
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  isFullscreen.value = !isFullscreen.value;
  await nextTick();
  setTimeout(async () =&gt; {
    try { await handleConnect(true); } finally { reloading.value = false; }
  }, 500);
}

const handleConnect = async (isRetry = false) =&gt; {
  const win = window as any;
  if (!win.WMKS) return ElMessage.error("SDK 未加载");

  try {
    vncStatus.value = 'connecting';
    if (!isRetry) vncDialogVisible.value = true;

    const res = await getVmConsoleTicket({
      host: activeVM.value.host,
      username: activeVM.value.username,
      password: activeVM.value.password,
      vmUuid: activeVM.value.vmUuid
    });
    
    const ticket = res.data?.ticket || res.ticket || res;
    await nextTick();
    startWMKS(ticket);
  } catch (err) {
    ElMessage.error("Ticket 申请失败，请检查机房连接");
    vncStatus.value = 'disconnected';
  }
}

const startWMKS = (ticket: string) =&gt; {
  const WMKS_LIB = (window as any).WMKS;
  wmksInstance.value = WMKS_LIB.createWMKS("wmks-container", {
    enableHints: true,
    useVNCHandshake: false,
    changeResolutionOnResizing: true,
    rescaleOnParentResize: true,
    position: 'absolute'
  });
  
  wmksInstance.value.register(WMKS_LIB.CONST.Events.CONNECTION_STATE_CHANGE, (evt: any, data: any) =&gt; {
    if (data.state === WMKS_LIB.CONST.ConnectionState.CONNECTED) {
      vncStatus.value = 'connected';
    }
  });

  wmksInstance.value.connect(`wss://${activeVM.value.host}:443/ticket/${ticket}`);
}

const sendCAD = () =&gt; wmksInstance.value?.sendCAD();
const handleCloseVNC = () =&gt; {
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  vncDialogVisible.value = false;
  isFullscreen.value = false;
  vncStatus.value = 'disconnected';
}

onBeforeUnmount(handleCloseVNC);
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.vnc-app-wrapper {
  padding: 40px;
  background-color: #f8fafc;
  min-height: 100vh;
}

.page-header {
  max-width: 1200px;
  margin: 0 auto 40px;
  .brand {
    display: flex; align-items: center; gap: 12px;
    h1 { font-size: 22px; color: #334155; margin: 0; }
  }
}

.vm-grid {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
}

.vm-mini-card {
  background: #fff; border-radius: 12px; overflow: hidden;
  border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  transition: transform 0.2s;
  &amp;:hover { transform: translateY(-4px); }

  .vm-status-bar { 
    height: 4px; background: #cbd5e1;
    &amp;.online { background: #10b981; }
  }
  
  .vm-card-body {
    padding: 24px; display: flex; flex-direction: column; align-items: center;
    .vm-icon {
      font-size: 32px; color: #3b82f6; margin-bottom: 16px;
      padding: 12px; background: #eff6ff; border-radius: 12px;
    }
    .vm-name { font-size: 17px; font-weight: 600; color: #1e293b; margin: 0 0 4px; }
    .vm-ip { font-size: 13px; color: #64748b; margin-bottom: 24px; }
    .vm-actions { width: 100%; .el-button { width: 100%; } }
  }

  .vm-footer {
    padding: 12px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9;
    font-size: 11px; color: #94a3b8; font-family: ui-monospace, SFMono-Regular;
  }
}

:deep(.vnc-session-dialog) {
  display: flex; flex-direction: column;
  background: #000 !important; border-radius: 12px; overflow: hidden;
  
  .el-dialog__header {
    padding: 0 !important;
    margin: 0 !important;
    height: 50px;
    cursor: move; 
  }

  .el-dialog__body {
    flex: 1; display: flex; flex-direction: column;
    padding: 0 !important;
  }
  
  &amp;.is-fullscreen { border-radius: 0; }
}

.session-header {
  height: 50px; background: #1e293b; padding: 0 20px;
  display: flex; justify-content: space-between; align-items: center;
  
  .session-info {
    display: flex; align-items: center; gap: 10px;
    pointer-events: none; 
    .status-indicator { 
      width: 8px; height: 8px; border-radius: 50%; background: #64748b;
      &amp;.is-connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
    }
    .session-name { color: #f1f5f9; font-size: 14px; font-weight: 500; }
  }
  
  .session-controls {
    pointer-events: auto;
    display: flex; align-items: center; gap: 10px;
    .divider { width: 1px; height: 16px; background: #334155; }
    .el-button { color: #94a3b8; &amp;:hover { color: #fff; } }
  }
}

.session-stage {
  flex: 1; width: 100%; min-height: 600px;
  background: #000; position: relative;
  #wmks-container { width: 100% !important; height: 100% !important; position: absolute; }
}

:deep(.el-dialog__headerbtn) { display: none; }
&lt;/style&gt;
</code></pre>
<p>这是index.html下面需要引入的内容</p>
<pre><code class="hljs language-js" lang="js">    &lt;link rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"/WebMKS_SDK_2.2.0/css/wmks-all.css"</span>&gt;

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.6.0.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
    
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'JQuery Check:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">fn</span>.<span class="hljs-property">jquery</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/WebMKS_SDK_2.2.0/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> &amp;&amp; (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">ui</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">widget</span>)) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result: jQuery UI is fully loaded and attached to jQuery.'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Result: jQuery UI failed to attach to window.jQuery!'</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaddee8e7016447088ca752d2d4960da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNDA0Tm90Rm91bmQzMDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976955&amp;x-signature=4yNg4PNckCnrq4fr35duMAE5rx4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪]]></title>    <link>https://juejin.cn/post/7586482851098165288</link>    <guid>https://juejin.cn/post/7586482851098165288</guid>    <pubDate>2025-12-22T03:25:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851098165288" data-draft-id="7585948869844795427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪"/> <meta itemprop="keywords" content="前端,后端,前端框架"/> <meta itemprop="datePublished" content="2025-12-22T03:25:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:25:58.000Z" title="Mon Dec 22 2025 03:25:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年的第一场雪，我是在报错日志里度过的😭</p>
<p>朋友圈在晒雪景，我在盯着 VS Code 万年不变的界面发呆。</p>
<p>既然错过了现实里的初雪，那我为什么不能在我的 IDE 里下一场雪？</p>
<p>于是，一个极其离谱又带感的脑洞诞生了——我想做一个VS Code插件，实现：</p>
<ul>
<li>落雪：当我停下来思考或者单纯摸鱼时，让屏幕飘落初雪，积雪慢慢覆盖代码，假装我也在过冬。</li>
<li>燃火：一旦我开始狂修 Bug，指尖的每一次敲击都要在屏幕底部点燃烈火。手速越快，火势越旺，甚至要让火星子溅满整个屏幕，主打一个物理取暖和辛劳可视化。</li>
<li>互动：圣诞节快到了，在没有操作的时候，跳出NPC和我互动，增添圣诞氛围。</li>
</ul>
<p>想法很丰满，现实很骨感。</p>
<p>要在 VS Code 极其受限的 Webview 环境里，同时跑通物理积雪堆叠算法和 Doom Fire 火焰渲染，还要保证不卡顿，这对我这个只有碎片时间的开发者来说，简直是降维打击。</p>
<p>好在，这个冬天，虽然没有女朋友暖手，但我有随叫随到的 文心快码（Comate） 暖心🐶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f6018bc8df3430d9ea0a86424d2cf2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=qsGAUFFmMbRqdHUD16zveDlvSdE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">01 智能规划：从一句话需求到 MVP落地</h2>
<p>﻿项目启动阶段，我面临的最大挑战是架构设计。VS Code 插件开发涉及 Extension 主进程与 Webview 渲染进程的通信，配置繁琐且容易出错。这次我没有直接写代码，而是使用了 Comate 的 Spec 模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d85396cb8fcc40cd8fc933d50ca1d759~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=RwlFV%2B3qe7DhHPyB4e9vLnO2fjE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我向 Comate 抛出了我的核心构想：</p>
<blockquote>
<p>“我要做一个 VS Code 插件，核心逻辑是监听键盘输入。输入频率高时底部渲染火焰，闲置时顶部下雪并积雪。请帮我设计架构并生成代码。”</p>
</blockquote>
<p>Comate 迅速进入了需求分析模式，几秒钟后，它返还了一份结构完整的 FrostFire 插件需求文档。我仔细审视了这份文档，发现大框架非常完美，逻辑层和渲染层分得清清楚楚。</p>
<p>插件需求文档见文章末尾【附录1】</p>
<p>为了把错误拦截在开发之前，我基于这份文档进行了一些微调：</p>
<ul>
<li>package.json：我补充了 activationEvents 配置，确保插件在打开任何文件时都能自动激活，而不仅仅是特定语言。</li>
<li>src/webview/index.html：我特别强调了要配置 CSP 策略，并将背景强制设为纯黑，以配合 Canvas 的渲染效果。</li>
</ul>
<p>确认修改后，Comate 自动根据需求文档拆解出了具体的开发任务列表（Tasks），从环境配置到核心算法实现，条理清晰。</p>
<p>插件开发任务计划见文章末尾【附录2】</p>
<p>随着一个个 Task 被自动执行，仅仅10分钟，FrostFire 的 V1.0 版本（MVP）诞生了。</p>
<p>生成完毕后，Comate还给出了贴心的下一步引导，清晰地告诉了我们如何迁移到VS Code里使用插件⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df89bc9d45c24cb2b71654509a4e2e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=5iu8bNfYhcCEmbUt2eEbyEMeofg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我打开VS Code，按照它说的一步步做，屏幕上真的燃起了火焰！</p>
<p>👉观看燃起火焰效果视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p>对了，VS Code里也支持文心快码插件～插件市场搜索文心快码，即可下载～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7813a94ce9f4c96b9190fbda78d6255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=GntUHX9i3D%2BWa2vu7qOZE9G6Q18%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>文心快码插件下载下来后，会自动出生在左边，有点和文件目录重合了。没关系，我们可以点击左侧项目栏中文心快码标识，把它拖到右边</p>
<p>👉观看具体操作视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<h2 data-id="heading-1">02 核心维稳：用“记忆”根除鬼火Bug</h2>
<p>然而，V1 版本很快暴露出了严重的稳定性问题——幽灵火。</p>
<p>症状非常诡异：</p>
<ol>
<li>有时候我明明双手离开了键盘，屏幕上的火却突然烧了起来。</li>
<li>刚打开 VS Code，还没开始工作，火焰就直接铺满了屏幕。</li>
</ol>
<p>经过排查，原来是后端的心跳包和自动保存机制干扰了 idleTime 的计算，导致系统误判我有输入。</p>
<p>为了解决这个问题，我与 Comate 进行了多次深度的 Debug 交互。最终，我们共同制定了一套基于趋势判定的“安全栓”逻辑：只有当监测到闲置时间出现骤降（时间倒流）时，才认定为有效输入，绝不能仅依赖数值大小来判断。</p>
<p>这段逻辑非常关键，为了防止在未来的迭代中 Comate 忘记这个核心规则，我使用了 Comate 的 Memory（记忆） 功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32661a4995e4cf6abbbbbb72ccabdb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=aMzE9hexqU1vd7DooVSmpCp266A%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我在 Memory 设置中手动录入了一条核心指令：</p>
<blockquote>
<p>“在 FrostFire 项目中，必须始终保留基于‘安全栓’（如 hasWitnessedDrop 变量）的逻辑：只有当检测到 idleTime 确实发生下降（current &lt; prev）时才允许解锁点火功能，绝对不能仅依赖 idleTime的绝对数值来判定打字状态，以防止‘刚打开或静止时自动起火’的 Bug 复发。”</p>
</blockquote>
<p>这一步操作至关重要。 从此之后，无论我要求 Comate 如何重构代码，它都会死死守住这条“安全底线”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89006bc7dbc4376b7defcdd09d114af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=mfalusOizTnIuGjgy1mIXl4mnZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当 Comate 生成了最终修复版的代码后，我点击了对话框下方的 “赞” 按钮反馈了满意度，并使用了 “全文复制”功能，一键将这段复杂的逻辑同步到了我的项目中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5200c18e0d4d49a8a198abe647182c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=iHTCJqaboYuHTAJ0L9AhxhNuMsA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">03 迭代开发：从“能用”到“惊艳”</h2>
<p>搞定了稳定性之后，FrostFire 虽然能跑了，但看起来还很廉价。我决定给它注入灵魂，开启了三次关键的迭代。</p>
<h3 data-id="heading-3">迭代一：挑战“物理积雪”算法</h3>
<p>我希望雪花落下时，能像真实的沙堆一样，形成中间高、两边低的自然坡度，而不是像水一样平铺。但这需要编写复杂的“休止角”算法，涉及大量的数据结构计算。</p>
<p>我向 Comate 描述了需求：</p>
<blockquote>
<p>“我需要积雪堆叠的感觉，最高堆叠到屏幕最上方。”</p>
</blockquote>
<p>Comate 完美执行了我的指令。它在 snowEffect.js 中重构了数据结构，引入了一个双向平滑算法。 现在的积雪，不仅有自然的起伏，甚至能把代码编辑器底部的状态栏慢慢“埋”起来，那种沉浸感简直绝了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/457d367cd28e45b58ba3895ec021962b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=lvkEZk3x9Ufxk9c7N66JMFoaMi8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-4">迭代二：手感调优与温和模式</h3>
<p>V1 的火焰太暴躁了，稍微打几个字就满屏火光。我希望它能更优雅一些，引入一种温和模式：平时只是小火苗，只有在疯狂输出时才会有火星四溅的效果。而且，单纯的“不打字下雪，打字起火”太生硬了。我想要一种线性的对抗感。</p>
<p>怕智能体乱改改错，我换成了Ask智能体，觉得AI说的有道理，就点插入，代码就自动插入到了我的光标位置，体验感十分丝滑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62213cd3f4fe4cda8f256dfa4c2a6fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=m8qfuWaj27K%2BZbmOJ7B3Q732460%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-5">迭代三：节日限定的浪漫</h3>
<p>既然是圣诞特供，怎么能少了节日气氛？</p>
<p>我给 Comate 下达了新的增量需求：</p>
<blockquote>
<p>“我需要增加两个彩蛋。第一，当积雪变厚时，雪地里要钻出一个雪人；一旦我开始打字起火，雪人要表现得很惊恐并逃跑。第二，在火势旺盛时，偶尔要有圣诞老人坐雪橇飞过，投递礼物。”</p>
</blockquote>
<p>Comate 的表现令人惊喜：</p>
<ul>
<li>怕热的雪人：它设计了一个简易的状态机。雪人平时在发呆，检测到热量上升时，会绘制出流汗和颤抖的动画，并加速移出屏幕。</li>
<li>圣诞空投：它完美实现了雪橇的飞行轨迹和礼物盒的物理抛物线。</li>
</ul>
<p>最让我感动的是，Comate 还记得我之前的 Memory。在实现这些新功能时，它依然严格遵守了“安全栓”逻辑，确保雪人和圣诞老人不会因为误触而乱跑。</p>
<p>最后，让我们一起来看看最终版本视频🤩：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce901f063c1843b2ad31cbc12418556c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=tvXwEXmdcTtd4zzbWJOJ8sCSOG4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-6">04 总结：AI 时代的开发新范式</h2>
<p>回看 FrostFire 的开发历程，从解决底层的“幽灵火”逻辑漏洞，到实现细腻的物理积雪，再到充满创意的圣诞彩蛋，文心快码（Comate） 展现出的能力远超一个代码补全工具。</p>
<ul>
<li>Spec 模式 让架构设计不再是难题，将我的抽象想法快速转化为可执行的代码框架。</li>
<li>Memory 机制 解决了 AI 容易“遗忘上下文”的痛点，让它成为了一个越用越懂我的专属工程师。</li>
<li>流畅的交互体验（如可编辑输入、一键复制）则极大地降低了沟通成本，让开发过程如丝般顺滑。</li>
</ul>
<p>现在的 FrostFire，已经不仅仅是一个插件，它是我在 Comate 协助下，送给自己和所有开发者的一份冬日礼物。</p>
<p>在这个项目中，我只需负责构想和决策，而那些繁琐的实现细节，全部交给了 AI。</p>
<p>如果你也想体验这种心想事成的开发快感，不妨试试让文心快码成为你的AI编程助手。或许你的下一个脑洞，就是下一个爆款。</p>
<h2 data-id="heading-7">【附录1】插件需求文档</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># FrostFire VS Code 插件需求文档</span>

<span class="hljs-comment">## 1. 项目概述</span>

**FrostFire** 是一个增加编程趣味性的 VS Code 视觉增强插件，通过在编辑器中渲染动态视觉效果（火焰和雪花），让编程体验更加生动有趣。

<span class="hljs-comment">## 2. 核心功能</span>

<span class="hljs-comment">### 2.1 Fire 状态（火焰效果）</span>
- **触发条件**：用户键盘输入频率（Keystrokes per minute, KPM）较高时触发
- **视觉效果**：编辑器底部渲染像素风格火焰（基于 Doom Fire Algorithm）
- **动态响应**：输入越快，火焰越高越旺盛
- **热度计算**：根据最近一段时间内的按键频率计算"热度值"

<span class="hljs-comment">### 2.2 Ice 状态（雪花效果）</span>
- **触发条件**：用户停止输入超过 15 秒
- **视觉效果**：编辑器顶部开始下雪
- **积雪机制**：停止输入超过 60 秒后，雪花在底部积累形成积雪层
- **遮挡效果**：积雪可轻微遮挡代码区域，增强沉浸感

<span class="hljs-comment">### 2.3 状态切换</span>
- Fire 和 Ice 状态互斥，不会同时出现
- 用户开始输入时，雪花效果逐渐消失，火焰效果逐渐出现
- 状态切换有平滑过渡动画

<span class="hljs-comment">## 3. 技术架构</span>

<span class="hljs-comment">### 3.1 技术栈</span>
- **语言**：TypeScript
- **API**：VS Code Extension API
- **渲染**：HTML5 Canvas（在 Webview 中运行）

<span class="hljs-comment">### 3.2 项目目录结构</span>
```
frostfire/
├── .vscode/
│   └── launch.json              <span class="hljs-comment"># 调试配置</span>
├── src/
│   ├── extension.ts             <span class="hljs-comment"># 插件入口，注册命令和监听器</span>
│   ├── activityTracker.ts       <span class="hljs-comment"># 用户活跃度追踪器</span>
│   ├── webviewProvider.ts       <span class="hljs-comment"># Webview 面板管理</span>
│   └── webview/
│       ├── index.html           <span class="hljs-comment"># Webview HTML 模板</span>
│       ├── main.js              <span class="hljs-comment"># Webview 主逻辑</span>
│       ├── fireEffect.js        <span class="hljs-comment"># Doom Fire 火焰算法实现</span>
│       └── snowEffect.js        <span class="hljs-comment"># 雪花和积雪效果实现</span>
├── package.json                 <span class="hljs-comment"># 插件配置清单</span>
├── tsconfig.json                <span class="hljs-comment"># TypeScript 配置</span>
└── README.md                    <span class="hljs-comment"># 项目说明</span>
```

<span class="hljs-comment">### 3.3 架构设计</span>

```
┌─────────────────────────────────────────────────────────────┐
│                     VS Code Extension Host                   │
├─────────────────────────────────────────────────────────────┤
│  extension.ts                                                │
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │ ActivityTracker │───▶│ WebviewProvider  │                │
│  │ - 监听文档变化   │    │ - 管理 Webview   │                │
│  │ - 计算热度值     │    │ - 发送状态消息    │                │
│  │ - 判断状态切换   │    │                  │                │
│  └─────────────────┘    └────────┬─────────┘                │
│                                  │ postMessage               │
└──────────────────────────────────┼──────────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                        Webview (Canvas)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │   FireEffect    │    │   SnowEffect     │                │
│  │ - Doom Fire算法  │    │ - 雪花粒子系统   │                │
│  │ - 火焰高度控制   │    │ - 积雪累积逻辑   │                │
│  └─────────────────┘    └──────────────────┘                │
│                    main.js (消息调度)                        │
└─────────────────────────────────────────────────────────────┘
```

<span class="hljs-comment">## 4. 实现细节</span>

<span class="hljs-comment">### 4.1 ActivityTracker（活跃度追踪器）</span>

```typescript
// src/activityTracker.ts
export class ActivityTracker {
    private keystrokeTimestamps: number<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;  // 记录按键时间戳</span>
    private readonly <span class="hljs-attr">WINDOW_SIZE</span> = <span class="hljs-number">60000</span><span class="hljs-comment">;         // 统计窗口：60秒</span>
    private readonly <span class="hljs-attr">IDLE_THRESHOLD</span> = <span class="hljs-number">15000</span><span class="hljs-comment">;      // 空闲阈值：15秒</span>
    private readonly <span class="hljs-attr">SNOW_ACCUMULATE_THRESHOLD</span> = <span class="hljs-number">60000</span><span class="hljs-comment">; // 积雪阈值：60秒</span>
    
    // 记录一次按键
    public recordKeystroke(): void {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.keystrokeTimestamps.push(now)<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
    }
    
    // 清理过期的时间戳
    private cleanOldTimestamps(now: number): void {
        <span class="hljs-attr">this.keystrokeTimestamps</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; this.WINDOW_SIZE
        )<span class="hljs-comment">;</span>
    }
    
    // 计算当前热度值 (0-100)
    public getHeatLevel(): number {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
        // 基于最近10秒的按键数计算热度
        const <span class="hljs-attr">recentKeystrokes</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; <span class="hljs-number">10000</span>
        ).length<span class="hljs-comment">;</span>
        // 假设每秒6次按键为满热度
        return Math.min(100, (recentKeystrokes / 60) * 100)<span class="hljs-comment">;</span>
    }
    
    // 获取空闲时间（毫秒）
    public getIdleTime(): number {
        if (<span class="hljs-attr">this.keystrokeTimestamps.length</span> === <span class="hljs-number">0</span>) return Infinity<span class="hljs-comment">;</span>
        const <span class="hljs-attr">lastKeystroke</span> = Math.max(...this.keystrokeTimestamps)<span class="hljs-comment">;</span>
        return Date.now() - lastKeystroke<span class="hljs-comment">;</span>
    }
    
    // 判断当前状态
    public getCurrentState(): 'fire' | 'idle' | 'snow' | 'snow_accumulate' {
        const <span class="hljs-attr">idleTime</span> = this.getIdleTime()<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.SNOW_ACCUMULATE_THRESHOLD) return 'snow_accumulate'<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.IDLE_THRESHOLD) return 'snow'<span class="hljs-comment">;</span>
        if (this.getHeatLevel() &gt; 10) return 'fire'<span class="hljs-comment">;</span>
        return 'idle'<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.2 Extension 核心逻辑</span>

```typescript
// src/extension.ts
import * as vscode from 'vscode'<span class="hljs-comment">;</span>
import { ActivityTracker } from './activityTracker'<span class="hljs-comment">;</span>
import { FrostFireWebviewProvider } from './webviewProvider'<span class="hljs-comment">;</span>

let activityTracker: ActivityTracker<span class="hljs-comment">;</span>
let webviewProvider: FrostFireWebviewProvider<span class="hljs-comment">;</span>
let updateInterval: NodeJS.Timeout<span class="hljs-comment">;</span>

export function activate(context: vscode.ExtensionContext) {
    <span class="hljs-attr">activityTracker</span> = new ActivityTracker()<span class="hljs-comment">;</span>
    <span class="hljs-attr">webviewProvider</span> = new FrostFireWebviewProvider(context.extensionUri)<span class="hljs-comment">;</span>
    
    // 注册 Webview 视图
    context.subscriptions.push(
        vscode.window.registerWebviewViewProvider(
            'frostfire.effectView',
            webviewProvider
        )
    )<span class="hljs-comment">;</span>
    
    // 注册启动命令
    context.subscriptions.push(
        vscode.commands.registerCommand('frostfire.start', () =&gt; {
            vscode.commands.executeCommand('frostfire.effectView.focus')<span class="hljs-comment">;</span>
        })
    )<span class="hljs-comment">;</span>
    
    // 监听文档变化（用户输入）
    context.subscriptions.push(
        vscode.workspace.onDidChangeTextDocument((event) =&gt; {
            // 只统计实际的文本变化
            if (event.contentChanges.length &gt; 0) {
                activityTracker.recordKeystroke()<span class="hljs-comment">;</span>
            }
        })
    )<span class="hljs-comment">;</span>
    
    // 定时更新状态到 Webview
    <span class="hljs-attr">updateInterval</span> = setInterval(() =&gt; {
        const <span class="hljs-attr">state</span> = activityTracker.getCurrentState()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">heatLevel</span> = activityTracker.getHeatLevel()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">idleTime</span> = activityTracker.getIdleTime()<span class="hljs-comment">;</span>
        
        webviewProvider.postMessage({
            type: 'stateUpdate',
            state: state,
            heatLevel: heatLevel,
            idleTime: idleTime
        })<span class="hljs-comment">;</span>
    }, 100)<span class="hljs-comment">; // 每100ms更新一次</span>
    
    context.subscriptions.push({
        dispose: () =&gt; clearInterval(updateInterval)
    })<span class="hljs-comment">;</span>
}

export function deactivate() {
    if (updateInterval) {
        clearInterval(updateInterval)<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.3 Doom Fire 火焰算法</span>

```javascript
// src/webview/fireEffect.js
class FireEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireWidth</span> = <span class="hljs-number">80</span><span class="hljs-comment">;  // 火焰像素宽度</span>
        <span class="hljs-attr">this.fireHeight</span> = <span class="hljs-number">50</span><span class="hljs-comment">; // 火焰像素高度</span>
        <span class="hljs-attr">this.firePixels</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireColorPalette</span> = this.createPalette()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.intensity</span> = <span class="hljs-number">0</span><span class="hljs-comment">;   // 火焰强度 0-100</span>
        this.initFire()<span class="hljs-comment">;</span>
    }
    
    // 创建火焰颜色调色板（36色）
    createPalette() {
        return <span class="hljs-section">[
            {r:7,g:7,b:7}, {r:31,g:7,b:7}, {r:47,g:15,b:7}, {r:71,g:15,b:7},
            {r:87,g:23,b:7}, {r:103,g:31,b:7}, {r:119,g:31,b:7}, {r:143,g:39,b:7},
            {r:159,g:47,b:7}, {r:175,g:63,b:7}, {r:191,g:71,b:7}, {r:199,g:71,b:7},
            {r:223,g:79,b:7}, {r:223,g:87,b:7}, {r:223,g:87,b:7}, {r:215,g:95,b:7},
            {r:215,g:103,b:15}, {r:207,g:111,b:15}, {r:207,g:119,b:15}, {r:207,g:127,b:15},
            {r:207,g:135,b:23}, {r:199,g:135,b:23}, {r:199,g:143,b:23}, {r:199,g:151,b:31},
            {r:191,g:159,b:31}, {r:191,g:159,b:31}, {r:191,g:167,b:39}, {r:191,g:167,b:39},
            {r:191,g:175,b:47}, {r:183,g:175,b:47}, {r:183,g:183,b:47}, {r:183,g:183,b:55},
            {r:207,g:207,b:111}, {r:223,g:223,b:159}, {r:239,g:239,b:199}, {r:255,g:255,b:255}
        ]</span><span class="hljs-comment">;</span>
    }
    
    // 初始化火焰数组
    initFire() {
        const <span class="hljs-attr">totalPixels</span> = this.fireWidth * this.fireHeight<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.firePixels</span> = new Array(totalPixels).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 设置火焰强度
    setIntensity(level) {
        <span class="hljs-attr">this.intensity</span> = Math.max(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">100</span>, level))<span class="hljs-comment">;</span>
        // 根据强度设置底部火源
        const <span class="hljs-attr">maxColorIndex</span> = Math.floor((this.intensity / <span class="hljs-number">100</span>) * <span class="hljs-number">35</span>)<span class="hljs-comment">;</span>
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            const <span class="hljs-attr">bottomIndex</span> = (this.fireHeight - <span class="hljs-number">1</span>) * this.fireWidth + x<span class="hljs-comment">;</span>
            this.firePixels<span class="hljs-section">[bottomIndex]</span> = this.intensity &gt; 5 ? maxColorIndex : 0<span class="hljs-comment">;</span>
        }
    }
    
    // 火焰传播算法
    spreadFire() {
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            for (let <span class="hljs-attr">y</span> = <span class="hljs-number">1</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
                const <span class="hljs-attr">srcIndex</span> = y * this.fireWidth + x<span class="hljs-comment">;</span>
                const <span class="hljs-attr">pixel</span> = this.firePixels[srcIndex]<span class="hljs-comment">;</span>
                
                if (<span class="hljs-attr">pixel</span> === <span class="hljs-number">0</span>) {
                    this.firePixels<span class="hljs-section">[(y - 1) * this.fireWidth + x]</span> = 0<span class="hljs-comment">;</span>
                } else {
                    // 随机偏移产生飘动效果
                    const <span class="hljs-attr">randIdx</span> = Math.floor(Math.random() * <span class="hljs-number">3</span>)<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstX</span> = Math.min(this.fireWidth - <span class="hljs-number">1</span>, Math.max(<span class="hljs-number">0</span>, x - randIdx + <span class="hljs-number">1</span>))<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstIndex</span> = (y - <span class="hljs-number">1</span>) * this.fireWidth + dstX<span class="hljs-comment">;</span>
                    this.firePixels<span class="hljs-section">[dstIndex]</span> = Math.max(0, pixel - (randIdx &amp; 1))<span class="hljs-comment">;</span>
                }
            }
        }
    }
    
    // 渲染火焰
    render() {
        this.spreadFire()<span class="hljs-comment">;</span>
        
        const <span class="hljs-attr">pixelWidth</span> = this.canvas.width / this.fireWidth<span class="hljs-comment">;</span>
        const <span class="hljs-attr">pixelHeight</span> = this.canvas.height / this.fireHeight<span class="hljs-comment">;</span>
        
        for (let <span class="hljs-attr">y</span> = <span class="hljs-number">0</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
            for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
                const <span class="hljs-attr">colorIndex</span> = this.firePixels[y * this.fireWidth + x]<span class="hljs-comment">;</span>
                const <span class="hljs-attr">color</span> = this.fireColorPalette[colorIndex]<span class="hljs-comment">;</span>
                
                if (colorIndex &gt; 0) {
                    <span class="hljs-attr">this.ctx.fillStyle</span> = `rgba(<span class="hljs-variable">${color.r}</span>,<span class="hljs-variable">${color.g}</span>,<span class="hljs-variable">${color.b}</span>,<span class="hljs-number">0.9</span>)`<span class="hljs-comment">;</span>
                    this.ctx.fillRect(
                        x * pixelWidth,
                        y * pixelHeight,
                        pixelWidth + 1,
                        pixelHeight + 1
                    )<span class="hljs-comment">;</span>
                }
            }
        }
    }
}
```

<span class="hljs-comment">### 4.4 雪花效果</span>

```javascript
// src/webview/snowEffect.js
class SnowEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = []<span class="hljs-comment">; // 积雪层高度数组</span>
        <span class="hljs-attr">this.maxSnowflakes</span> = <span class="hljs-number">200</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
    }
    
    // 初始化积雪层
    initAccumulation() {
        const <span class="hljs-attr">segments</span> = Math.floor(this.canvas.width / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = new Array(segments).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 创建雪花
    createSnowflake() {
        return {
            x: Math.random() * this.canvas.width,
            y: -10,
            radius: Math.random() * 3 + 1,
            speed: Math.random() * 1 + 0.5,
            wind: Math.random() * 0.5 - 0.25,
            opacity: Math.random() * 0.5 + 0.5
        }<span class="hljs-comment">;</span>
    }
    
    // 开始下雪
    startSnow(<span class="hljs-attr">accumulate</span> = <span class="hljs-literal">false</span>) {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = accumulate<span class="hljs-comment">;</span>
    }
    
    // 停止下雪
    stopSnow() {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 清除效果
    clear() {
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 更新雪花位置
    update() {
        // 添加新雪花
        if (this.isSnowing &amp;&amp; this.snowflakes.length &lt; this.maxSnowflakes) {
            if (Math.random() &lt; 0.3) {
                this.snowflakes.push(this.createSnowflake())<span class="hljs-comment">;</span>
            }
        }
        
        // 更新雪花位置
        for (let <span class="hljs-attr">i</span> = this.snowflakes.length - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
            const <span class="hljs-attr">flake</span> = this.snowflakes[i]<span class="hljs-comment">;</span>
            flake.y += flake.speed<span class="hljs-comment">;</span>
            flake.x += flake.wind<span class="hljs-comment">;</span>
            
            // 检查是否落到底部或积雪上
            const <span class="hljs-attr">segmentIndex</span> = Math.floor(flake.x / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">groundLevel</span> = this.canvas.height - (this.snowAccumulation[segmentIndex] || <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
            
            if (flake.y &gt;= groundLevel) {
                // 积雪
                if (this.isAccumulating &amp;&amp; segmentIndex &gt;= 0 &amp;&amp; segmentIndex &lt; this.snowAccumulation.length) {
                    this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> = Math.min(
                        this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> + 0.2,
                        this.canvas.height * 0.3 // 最大积雪高度30%
                    )<span class="hljs-comment">;</span>
                }
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            } else if (flake.x &lt; 0 || flake.x &gt; this.canvas.width) {
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            }
        }
    }
    
    // 渲染雪花和积雪
    render() {
        this.update()<span class="hljs-comment">;</span>
        
        // 绘制雪花
        <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'white'</span><span class="hljs-comment">;</span>
        for (const flake of this.snowflakes) {
            <span class="hljs-attr">this.ctx.globalAlpha</span> = flake.opacity<span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2)<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">this.ctx.globalAlpha</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        
        // 绘制积雪
        if (this.isAccumulating) {
            <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.8)'</span><span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.moveTo(0, this.canvas.height)<span class="hljs-comment">;</span>
            
            for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; this.snowAccumulation.length; i++) {</span>
                const <span class="hljs-attr">x</span> = i * <span class="hljs-number">5</span><span class="hljs-comment">;</span>
                const <span class="hljs-attr">y</span> = this.canvas.height - this.snowAccumulation[i]<span class="hljs-comment">;</span>
                this.ctx.lineTo(x, y)<span class="hljs-comment">;</span>
            }
            
            this.ctx.lineTo(this.canvas.width, this.canvas.height)<span class="hljs-comment">;</span>
            this.ctx.closePath()<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
    }
}
```

<span class="hljs-comment">### 4.5 Webview 主逻辑</span>

```javascript
// src/webview/main.js
(function() {
    const <span class="hljs-attr">vscode</span> = acquireVsCodeApi()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'effectCanvas'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
    
    let fireEffect, snowEffect<span class="hljs-comment">;</span>
    let <span class="hljs-attr">currentState</span> = <span class="hljs-string">'idle'</span><span class="hljs-comment">;</span>
    let animationId<span class="hljs-comment">;</span>
    
    // 初始化
    function init() {
        resizeCanvas()<span class="hljs-comment">;</span>
        <span class="hljs-attr">fireEffect</span> = new FireEffect(canvas)<span class="hljs-comment">;</span>
        <span class="hljs-attr">snowEffect</span> = new SnowEffect(canvas)<span class="hljs-comment">;</span>
        animate()<span class="hljs-comment">;</span>
    }
    
    // 调整画布大小
    function resizeCanvas() {
        <span class="hljs-attr">canvas.width</span> = window.innerWidth<span class="hljs-comment">;</span>
        <span class="hljs-attr">canvas.height</span> = window.innerHeight<span class="hljs-comment">;</span>
    }
    
    // 动画循环
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.render()<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span> || currentState === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.render()<span class="hljs-comment">;</span>
        }
        
        <span class="hljs-attr">animationId</span> = requestAnimationFrame(animate)<span class="hljs-comment">;</span>
    }
    
    // 处理来自扩展的消息
    window.addEventListener('message', <span class="hljs-attr">event</span> =&gt; {
        const <span class="hljs-attr">message</span> = event.data<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">message.type</span> === <span class="hljs-string">'stateUpdate'</span>) {
            handleStateUpdate(message)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    
    // 处理状态更新
    function handleStateUpdate(message) {
        const <span class="hljs-attr">newState</span> = message.state<span class="hljs-comment">;</span>
        
        if (newState !== currentState) {
            // 状态切换
            if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'fire'</span>) {
                snowEffect.clear()<span class="hljs-comment">;</span>
            } else if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'snow'</span> || newState === <span class="hljs-string">'snow_accumulate'</span>) {
                fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">currentState</span> = newState<span class="hljs-comment">;</span>
        }
        
        // 更新效果参数
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.setIntensity(message.heatLevel)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span>) {
            snowEffect.startSnow(false)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.startSnow(true)<span class="hljs-comment">;</span>
        } else {
            fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            snowEffect.stopSnow()<span class="hljs-comment">;</span>
        }
    }
    
    // 窗口大小改变时重新调整
    window.addEventListener('resize', () =&gt; {
        resizeCanvas()<span class="hljs-comment">;</span>
        if (snowEffect) snowEffect.initAccumulation()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    
    // 启动
    init()<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 5. 边界条件与异常处理</span>

<span class="hljs-comment">### 5.1 输入边界</span>
- 热度值范围：0-100，超出范围自动截断
- 空闲时间：使用 Infinity 表示从未输入
- 按键时间戳数组：定期清理过期数据，避免内存泄漏

<span class="hljs-comment">### 5.2 状态切换</span>
- 状态切换时清理前一状态的视觉残留
- 使用平滑过渡避免突兀感

<span class="hljs-comment">### 5.3 性能优化</span>
- 火焰像素矩阵使用固定大小（80x50），通过缩放渲染到实际尺寸
- 雪花数量上限 200 个，避免性能问题
- 使用 requestAnimationFrame 保证动画流畅

<span class="hljs-comment">### 5.4 Webview 生命周期</span>
- Webview 隐藏时暂停动画
- Webview 销毁时清理资源
- 重新显示时恢复状态

<span class="hljs-comment">## 6. 数据流动路径</span>

```
用户输入 → onDidChangeTextDocument → ActivityTracker.recordKeystroke()
                                            ↓
                                    计算热度值/空闲时间
                                            ↓
                              定时器(100ms) → getCurrentState()
                                            ↓
                              WebviewProvider.postMessage()
                                            ↓
                              Webview 接收消息 → handleStateUpdate()
                                            ↓
                              更新 FireEffect/SnowEffect 参数
                                            ↓
                              requestAnimationFrame → render()
```

<span class="hljs-comment">## 7. 预期成果</span>

完成后的 MVP 应具备：
1. ✅ 一键启动视觉效果面板
2. ✅ 实时响应用户输入，渲染火焰效果
3. ✅ 空闲时自动切换到雪花效果
4. ✅ 长时间空闲产生积雪效果
5. ✅ 流畅的动画和状态切换
6. ✅ 详细的代码注释，便于理解和扩展
</code></pre>
<h2 data-id="heading-8">【附录2】插件开发任务计划</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># FrostFire VS Code 插件开发任务计划</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">1</span><span class="hljs-string">：初始化项目结构与配置文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`package.json`，配置插件元信息、activationEvents、commands</span> <span class="hljs-string">和</span> <span class="hljs-string">views（侧边栏注册）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.2:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`tsconfig.json`，配置</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">编译选项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.3:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/launch.json`，配置调试启动项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/tasks.json`，配置</span> <span class="hljs-string">watch</span> <span class="hljs-string">编译任务</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.5:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`README.md`，说明项目用途和使用方法</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">2</span><span class="hljs-string">：实现</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">活跃度追踪模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/activityTracker.ts`，定义</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`recordKeystroke()`</span> <span class="hljs-string">方法，记录按键时间戳</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHeatLevel()`</span> <span class="hljs-string">方法，计算热度值（0-100）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getIdleTime()`</span> <span class="hljs-string">方法，计算空闲时间</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getCurrentState()`</span> <span class="hljs-string">方法，判断当前状态（fire/idle/snow/snow_accumulate）</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">3</span><span class="hljs-string">：实现</span> <span class="hljs-string">WebviewProvider</span> <span class="hljs-string">面板管理模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webviewProvider.ts`，定义</span> <span class="hljs-string">FrostFireWebviewProvider</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`resolveWebviewView()`</span> <span class="hljs-string">方法，创建并配置</span> <span class="hljs-string">Webview</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHtmlContent()`</span> <span class="hljs-string">方法，生成包含</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">和脚本的</span> <span class="hljs-string">HTML</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`postMessage()`</span> <span class="hljs-string">方法，向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新消息</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">4</span><span class="hljs-string">：实现插件主入口</span> <span class="hljs-string">extension.ts</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/extension.ts`，实现</span> <span class="hljs-string">`activate()`</span> <span class="hljs-string">函数</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.2:</span> <span class="hljs-string">注册</span> <span class="hljs-string">WebviewViewProvider</span> <span class="hljs-string">到</span> <span class="hljs-string">frostfire.effectView</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.3:</span> <span class="hljs-string">注册</span> <span class="hljs-string">frostfire.start</span> <span class="hljs-string">和</span> <span class="hljs-string">frostfire.stop</span> <span class="hljs-string">命令</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.4:</span> <span class="hljs-string">添加</span> <span class="hljs-string">`onDidChangeTextDocument`</span> <span class="hljs-string">监听器，记录用户输入</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.5:</span> <span class="hljs-string">设置定时器（100ms），定期向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.6:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`deactivate()`</span> <span class="hljs-string">函数，清理资源</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">5</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（火焰效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/fireEffect.js`，定义</span> <span class="hljs-string">FireEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createPalette()`</span> <span class="hljs-string">方法，创建</span> <span class="hljs-number">36</span> <span class="hljs-string">色火焰调色板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`setIntensity()`</span> <span class="hljs-string">方法，根据热度设置火焰强度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`spreadFire()`</span> <span class="hljs-string">方法，Doom</span> <span class="hljs-string">Fire</span> <span class="hljs-string">传播算法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染火焰到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">6</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（雪花效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/snowEffect.js`，定义</span> <span class="hljs-string">SnowEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createSnowflake()`</span> <span class="hljs-string">方法，生成随机雪花粒子</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`startSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`stopSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`clear()`</span> <span class="hljs-string">控制方法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`update()`</span> <span class="hljs-string">方法，更新雪花位置和积雪层</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染雪花和积雪到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">7</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">主逻辑与</span> <span class="hljs-string">HTML</span> <span class="hljs-string">模板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/main.js`，实现消息监听和状态调度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`handleStateUpdate()`</span> <span class="hljs-string">方法，根据状态切换效果</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.3:</span> <span class="hljs-string">实现动画循环</span> <span class="hljs-string">`animate()`，使用</span> <span class="hljs-string">requestAnimationFrame</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/index.html`，纯黑背景</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">模板</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">8</span><span class="hljs-string">：安装依赖并编译验证</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.1:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">install`</span> <span class="hljs-string">安装</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">和</span> <span class="hljs-string">VS</span> <span class="hljs-string">Code</span> <span class="hljs-string">类型定义</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.2:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">run</span> <span class="hljs-string">compile`</span> <span class="hljs-string">编译</span> <span class="hljs-string">TypeScript</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.3:</span> <span class="hljs-string">检查编译输出，确保无报错</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.4:</span> <span class="hljs-string">提供调试启动指南，确认</span> <span class="hljs-string">MVP</span> <span class="hljs-string">可运行</span>
<span class="hljs-string">有问题吗</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术]]></title>    <link>https://juejin.cn/post/7586482851097968680</link>    <guid>https://juejin.cn/post/7586482851097968680</guid>    <pubDate>2025-12-22T03:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097968680" data-draft-id="7585850609015914511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件通讯全攻略：拒绝 &quot;Props&quot; 焦虑，掌握数据流动的艺术"/> <meta itemprop="keywords" content="React.js,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫天黄叶远飞"/> <meta itemprop="url" content="https://juejin.cn/user/2948205649344634"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948205649344634/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫天黄叶远飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:06:38.000Z" title="Mon Dec 22 2025 03:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在 <strong>React</strong> 的开发旅程中，组件就像是乐高积木，我们把它们一个个搭起来构建出复杂的页面。但光搭起来还不够，这些积木之间必须有“电流”流通——这就是数据。<br/>
<strong>React</strong> 的设计哲学是单向数据流，就像瀑布一样，水流默认只能从高处流向低处。但在实际业务中，我们经常需要逆流而上，或者在两个平行的水池间交换水流。今天我们就来盘点 <strong>React</strong> 中最主流的四种“引水”方式，打通你的组件经脉。</p>
<hr/>
<h2 data-id="heading-1">1. 父传子：顺流而下的 Props</h2>
<p>这是 <strong>React</strong> 中最自然、最基础的通信方式。想象一下，父亲给孩子零花钱，父亲（父组件）只需要要把钱（数据）递过去，孩子（子组件）伸手接着就行。<br/>
在代码层面，父组件通过在子组件标签上写上自定义属性（msg）来传递数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'小饶'</span>
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 父亲把 '小饶' 这个名字打包进 msg 属性传给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">msg</span>=<span class="hljs-string">{state.name}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>孩子组件这边，所有接收到的礼物都装在一个叫 <code>props</code> 的盒子里。不过要注意，<code>Props</code> 是只读的——这意味着孩子只能使用这些数据，不能直接修改它。就像孩子不能自己修改父亲银行卡的余额一样，如果要改，必须请求父亲操作。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 打开盒子看看收到了什么</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件 -- {props.msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-2">2. 子传父：给孩子一个“遥控器”</h2>
<p>既然水流默认向下，那子组件想要改变父组件的数据该怎么办？比如，孩子想告诉父亲：“我考了 100 分，请更新一下你的心情状态”。<br/>
这时候，父组件需要提前准备一个“遥控器”——也就是一个函数。父组件把这个函数通过 <code>props</code> 传给子组件，当子组件需要通信时，就按下这个遥控器（调用函数），并把数据作为参数传回去。
**父组件： 准备好 <code>getNum</code> 函数，用来接收数据并更新自己的 <code>count</code>。 **</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>)  

  <span class="hljs-comment">// 这就是那个“遥控器”函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getNum</span> = (<span class="hljs-params">n</span>) =&gt; {
    <span class="hljs-title function_">setCount</span>(n)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件二 -- {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 把遥控器交给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">getNum</span>=<span class="hljs-string">{getNum}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>子组件： 在合适的时机（比如点击按钮时），通过 props 拿到并按下这个“遥控器”。</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">num</span>: <span class="hljs-number">100</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 此时调用的是父组件里的函数，把 100 传了回去</span>
    props.<span class="hljs-title function_">getNum</span>(state.<span class="hljs-property">num</span>)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件二<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-3">3. 兄弟组件：找个共同的“家长”</h2>
<p>兄弟组件之间没有直接的连线，就像你和你的表弟住在不同的屋子里，想聊天得通过大厅里的长辈传话。
这种模式在 <strong>React</strong> 中通常被称为状态提升。既然 <strong>Brother1</strong> 想要给 <strong>Brother2</strong> 传值，那我们就把这个值保存在他们共同的父亲身上。</p>
<ul>
<li>Brother1 -&gt; Parent：Brother1 先把数据传给父亲（利用上面的子传父技巧）。</li>
<li>Parent -&gt; Brother2：父亲拿到数据后，更新自己的状态，再把这个新状态顺手传给 Brother2（利用父传子技巧）。</li>
</ul>
<p><strong>父组件（中间枢纽）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child1</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child1"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child2</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child2"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [message, setMessage] = <span class="hljs-title function_">useState</span>()

  <span class="hljs-comment">// 接收老大传来的消息</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMsg</span> = (<span class="hljs-params">msg</span>) =&gt; {
    <span class="hljs-title function_">setMessage</span>(msg)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 父组件三 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 接收者：从 Child1 收信 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child1</span> <span class="hljs-attr">getMsg</span>=<span class="hljs-string">{getMsg}</span> /&gt;</span>
      {/* 发送者：把信转交给 Child2 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child2</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child1（消息发送方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child1</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">'1 中的数据'</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    props.<span class="hljs-title function_">getMsg</span>(state.<span class="hljs-property">msg</span>)
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件1<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child2（消息接收方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child2</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 坐等父亲把兄弟的消息送过来 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件2 --- {props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4. 跨代组件通信：Context 传送门</h2>
<p>如果组件层级很深，比如“爷爷 -&gt; 爸爸 -&gt; 儿子 -&gt; 孙子”，如果还用 <strong>Props</strong> 一层层传，那中间的爸爸和儿子就成了无辜的“搬运工”，代码会变得非常臃肿麻烦。<br/>
为了解决这个问题，<strong>React</strong> 提供了一个 <strong>Context</strong>（上下文）机制。这就像在家族里设立了一个“广播站”，爷爷在顶层广播，底下的任何一代子孙，只要想听，就可以直接接收信号，完全不需要中间人转手。<br/>
<strong>爷组件（数据源头）：</strong><br/>
我们需要先 <code>createContext</code> 创建一个信号塔，然后用 <code>&lt;Context.Provider&gt;</code> 把所有后代包起来，<code>value</code> 就是我们要广播的数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Parent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Parent"</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Context</span> = <span class="hljs-title function_">createContext</span>()  <span class="hljs-comment">// 1. 建立信号塔</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Grand</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 爷组件 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 2. 发射信号，内容是 value 中的数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>= <span class="hljs-string">{</span>'<span class="hljs-attr">爷组件的数据</span>'}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>父组件（路人甲）：</strong><br/>
你看，父组件完全不需要碰这些数据，它只需要安静地渲染它的子组件即可。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>孙子组件（数据接收者）：</strong><br/>
孙子组件不需要管它离爷爷隔了多少代，直接用 <code>useContext</code> 这个钩子函数，就能连上信号塔拿到数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Grand'</span>  <span class="hljs-comment">// 3. 引入信号塔定义</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 4. 接收信号</span>
  <span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Context</span>)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>孙子组件 --- {msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-5">结语</h2>
<p>组件通信是 <strong>React</strong> 开发中最基本也最重要的内功。</p>
<ul>
<li>简单的父子关系，<strong>Props</strong> 和 <strong>Callback</strong> 是最轻量的选择；</li>
<li>兄弟组件，记得找共同的父级帮忙周转；</li>
<li>当层级太深感到繁琐时，<strong>Context</strong> 就是你的救星。</li>
</ul>
<p>掌握了这四招，你就能从容应对绝大多数的组件交互场景，让数据在你的应用中流动得井井有条。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包 => 放弃了，样式会丢]]></title>    <link>https://juejin.cn/post/7586509410567405609</link>    <guid>https://juejin.cn/post/7586509410567405609</guid>    <pubDate>2025-12-22T03:15:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567405609" data-draft-id="7585789195869388836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:15:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:15:40.000Z" title="Mon Dec 22 2025 03:15:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>vite-plugin-obfuscator</code> 可以将你的代码进行混淆，一个依赖</p>
<hr/>
<p>安装</p>
<p>npm install vite-plugin-obfuscator --save-dev</p>
<p>配置文件引入和配置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { viteObfuscateFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-obfuscator'</span>;

<span class="hljs-comment">// https://vitejs.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
      <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>
    }),
    <span class="hljs-title function_">viteObfuscateFile</span>({
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">true</span>
      }
    })
  ],
</code></pre>
<p>报错：</p>
<p>无法找到模块“vite-plugin-obfuscator”的声明文件。</p>
<p>没有具体步骤，这个依赖缺少类型声明，ts进行报错，给它一个声明就行，例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 添加 vite-plugin-obfuscator 的类型声明</span>
declare <span class="hljs-variable language_">module</span> <span class="hljs-string">'vite-plugin-obfuscator'</span> {
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

  interface <span class="hljs-title class_">ViteObfuscateFileOptions</span> {
    options?: any;
  }

  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">viteObfuscateFile</span>(<span class="hljs-params">options?: ViteObfuscateFileOptions</span>): <span class="hljs-title class_">Plugin</span>;
}
</code></pre>
<p>具体的混淆配置：</p>








































<table><thead><tr><th><code>compact</code></th><th><code>boolean</code></th><th><code>true</code></th><th>压缩代码，移除空格和换行符。</th><th>样式丢失</th></tr></thead><tbody><tr><td><code>debugProtection</code></td><td><code>boolean</code></td><td><code>false</code></td><td>防止在开发者工具中调试代码。</td><td/></tr><tr><td>-----------------</td><td>---------</td><td>-------</td><td>--------------</td><td/></tr><tr><td><code>renameGlobals</code></td><td><code>boolean</code></td><td><code>false</code></td><td>重命名全局变量和函数名。</td><td>接口路径失效</td></tr><tr><td>---------------</td><td>---------</td><td>-------</td><td>------------</td><td>---</td></tr></tbody></table>










<table><thead><tr><th><code>renameProperties</code></th><th><code>boolean</code></th><th><code>false</code></th><th>重命名对象的属性名。</th><th>样式丢失？</th></tr></thead></table>










<table><thead><tr><th><code>transformObjectKeys</code></th><th><code>boolean</code></th><th><code>false</code></th><th>转换对象的键名，增加代码的复杂性。</th><th>样式丢失？</th></tr></thead></table>
<p>难搞啊，样式会丢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高德地图-物流路线]]></title>    <link>https://juejin.cn/post/7586208617603285026</link>    <guid>https://juejin.cn/post/7586208617603285026</guid>    <pubDate>2025-12-22T03:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603285026" data-draft-id="7585920796100395035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高德地图-物流路线"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星_离"/> <meta itemprop="url" content="https://juejin.cn/user/2652464856962254"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高德地图-物流路线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2652464856962254/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星_离
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:13:59.000Z" title="Mon Dec 22 2025 03:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些时候我们的项目只使用原生一些内容是无法实现一些功能的，所以今天我带来了一个大家都熟悉的，也是生活中常见的一个功能，也就是大家在网购的时候，下单成功后就可以看到自己的订单，当然也可以查看物流信息，那么物流信息中有一个部分就是地图部分，这部分可以让用户看到自己购买的商品到了哪里。那这个功能我们使用原生大概率是无法完成的，这就需要我们使用高德地图、百度地图或者腾讯之类的开放地图类 API 的功能，那么今天我就来和大家分享一下如何去使用高德地图实现这一功能。</p>
<h2 data-id="heading-0">1. 准备工作</h2>
<h3 data-id="heading-1">1.1. 官方文档</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Fabc%2Famap-vue" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/abc/amap-vue" ref="nofollow noopener noreferrer">lbs.amap.com/api/javascr…</a></p>
<h3 data-id="heading-2">1.2. 需要安装的依赖</h3>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">@amap</span>/amap-jsapi-loader --save
</code></pre>
<h2 data-id="heading-3">2. 开始</h2>
<p>首先我们需要给地图设置一个容器，命名为<code>container</code></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>设置样式</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>  <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-id">#container</span>{
      <span class="hljs-attribute">padding</span>:<span class="hljs-number">0px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2.1. 创建地图组件</h3>
<p>首先我们需要去扩展 window 接口类型的定义，如果不配置就会出现错误：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0385debae646ab83e710854d3b0ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=O8Y5ucWsYVL8ETeID06i8MZzUGk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117de5c26e2a46d782e2e04bf551cbcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=ymA2M1Ncx6aRcZ%2BWVgVHYCIGpLA%3D" alt="" loading="lazy"/></p>
<p>核心原因：</p>
<p>TypeScript 对 <code>window</code> 的类型有严格定义，默认的 <code>Window</code> 接口里没有 <code>_AMapSecurityConfig</code>，所以会提示 “该属性不存在”。但是高德地图又需要这个属性来配置安全密钥，所以我们就需要来扩展一下 window 类型。</p>
<p>那么我们就需要先来配置一下：按照以下路径创建 global.d.ts 文件</p>
<p>src--&gt;types--&gt;global.d.ts</p>
<p>进入文件配置以下内容：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">interface</span> <span class="hljs-title">Window</span> {
  _AMapSecurityConfig: {
      securityJsCode: <span class="hljs-built_in">string</span>
  }
}
</code></pre>
<h3 data-id="heading-5">2.2. 初始化地图组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span>  {onMounted,onUnmounted} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>;

<span class="hljs-keyword">let</span> map = <span class="hljs-literal">null</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">()=&gt;</span>{
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
    <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">"379c75538f6ae27ee95c983a6feaf358"</span>,
  };
  <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>:<span class="hljs-string">"3d0735cef9dc47489452066b7dbe2510"</span>,
    <span class="hljs-attr">version</span>:<span class="hljs-string">"2.0"</span>,
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.scale"</span>]
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">AMap</span>)=&gt;</span>{
      map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"container"</span>,{
        <span class="hljs-comment">//设置地图容器的Id</span>
        <span class="hljs-attr">viewMode</span>:<span class="hljs-string">"3D"</span>,<span class="hljs-comment">//是否为3D地图模式</span>
        <span class="hljs-attr">zoom</span>:<span class="hljs-number">11</span>,<span class="hljs-comment">//初始化地图级别</span>
        <span class="hljs-attr">center</span>:[<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>]
      })
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>)=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e)
    })
})
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">()=&gt;</span>{
  map?.<span class="hljs-title function_">destroy</span>();
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">3. 路线规划</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fdemo%2Fjavascript-api-v2%2Fexample%2Fdriving-route%2Fplan-route-according-to-lnglat" target="_blank" title="https://lbs.amap.com/demo/javascript-api-v2/example/driving-route/plan-route-according-to-lnglat" ref="nofollow noopener noreferrer">lbs.amap.com/demo/javasc…</a></p>
<p>通过数据处理出起始点和途径点的坐标：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">logisticsInfo</span> = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-type">const</span> start = logisticsInfo.<span class="hljs-built_in">shift</span>()<span class="hljs-comment">//起点</span>
  <span class="hljs-type">const</span> end = logisticsInfo.<span class="hljs-built_in">pop</span>()<span class="hljs-comment">//终点</span>
  <span class="hljs-type">const</span> ways = logisticsInfo.<span class="hljs-built_in">map</span>(item =&gt; [item.longitude, item.latitude])<span class="hljs-comment">//途径点数组</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino">AMap.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, () =&gt; {
  <span class="hljs-comment">//构造路线导航类</span>
  var driving = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Driving</span>({
    map: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
    showTraffic: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
    hideMarkers: <span class="hljs-literal">false</span> <span class="hljs-comment">// 隐藏默认的图标</span>
  });
  <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
  driving.<span class="hljs-built_in">search</span>(<span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(start.longitude, start.latitude), <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(end.longitude, end.latitude), {
    waypoints:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
  },<span class="hljs-built_in">function</span> (status: string, result: object) {

    <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
      <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
      map.<span class="hljs-built_in">setFitView</span>([ startMarker, endMarker, currentMarker ])
    } <span class="hljs-keyword">else</span> {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
    }
  })
})
</code></pre>
<h2 data-id="heading-7">4. 自定义图标</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6dc325047142c19f81746b5cb14ba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=xhm3Jn3jEWk4eZt2q9BImk%2FzHmQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a63a855fae740b7ae3907546cc372bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=%2FFhHSgxw4JKWXH%2Fk7ea3Dv%2BtvCs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8322b3e6b50a459196d3e85bd56e3b3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=CAVa0FgeYxN%2Fw9ERK8m9RarXZPg%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
</code></pre>
<p>自定义图标需要使用到 marker 类</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自定义开始坐标图片</span>
<span class="hljs-type">const</span> startMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [start.longitude, start.latitude], <span class="hljs-comment">// 自定义图标位置</span>
  icon:startImg,
  map: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
})
<span class="hljs-comment">// 自定义终点坐标图片</span>
<span class="hljs-type">const</span> endMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [end.longitude, end.latitude],
  icon:endImg,
  map: map
})
<span class="hljs-comment">// 自定义当前坐标图片</span>
<span class="hljs-type">const</span> currentMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [currentLocationInfo.longitude, currentLocationInfo.latitude],
  icon:carImg,
  map: map
})
</code></pre>
<h2 data-id="heading-8">5. 完整代码实现</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>地图组件<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100%; height: 500px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>
<span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
<span class="hljs-comment">// 接口返回的数据</span>
<span class="hljs-keyword">const</span> logisticsInfo = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
<span class="hljs-comment">// 当前坐标</span>
<span class="hljs-keyword">const</span> currentLocationInfo = {
  <span class="hljs-attr">latitude</span>: <span class="hljs-string">"31.93182"</span>,
  <span class="hljs-attr">longitude</span>: <span class="hljs-string">"118.633415"</span>
}
<span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
  <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">'2af1e64a8f6b16d6d79bfa8162c46755'</span>
}
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">AMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>: <span class="hljs-string">'9ac7a2671565e21bc21aca6df07eb5cb'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0'</span>
  })
  <span class="hljs-comment">// 地图的创建</span>
  <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'container'</span>, {
    <span class="hljs-attr">viewMode</span>: <span class="hljs-string">'2D'</span>, <span class="hljs-comment">// 默认使用 2D 模式，如果希望使用带有俯仰角的 3D 模式，请设置 viewMode: '3D'</span>
    <span class="hljs-attr">zoom</span>:<span class="hljs-number">16</span>, <span class="hljs-comment">// 初始化地图层级</span>
    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.209804</span>,<span class="hljs-number">40.149393</span>], <span class="hljs-comment">// 初始化地图中心点</span>
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.Driving"</span>]
  });


  <span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-keyword">const</span> start = logisticsInfo.<span class="hljs-title function_">shift</span>()
  <span class="hljs-keyword">const</span> end = logisticsInfo.<span class="hljs-title function_">pop</span>()
  <span class="hljs-keyword">const</span> ways = logisticsInfo.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> [item.<span class="hljs-property">longitude</span>, item.<span class="hljs-property">latitude</span>])
  <span class="hljs-comment">// 自定义开始坐标图片</span>
  <span class="hljs-keyword">const</span> startMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>], <span class="hljs-comment">// 自定义图标位置</span>
    <span class="hljs-attr">icon</span>:startImg,
    <span class="hljs-attr">map</span>: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
  })
  <span class="hljs-comment">// 自定义终点坐标图片</span>
  <span class="hljs-keyword">const</span> endMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:endImg,
    <span class="hljs-attr">map</span>: map
  })
<span class="hljs-comment">// 自定义当前坐标图片</span>
  <span class="hljs-keyword">const</span> currentMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [currentLocationInfo.<span class="hljs-property">longitude</span>, currentLocationInfo.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:carImg,
    <span class="hljs-attr">map</span>: map
  })

  <span class="hljs-comment">// 绘制物流轨迹</span>
  <span class="hljs-title class_">AMap</span>.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">//构造路线导航类</span>
    <span class="hljs-keyword">var</span> driving = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Driving</span>({
      <span class="hljs-attr">map</span>: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
      <span class="hljs-attr">showTraffic</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
      <span class="hljs-attr">hideMarkers</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 隐藏默认的图标</span>
    });
    <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
    driving.<span class="hljs-title function_">search</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>), {
      <span class="hljs-attr">waypoints</span>:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
    },<span class="hljs-keyword">function</span> (<span class="hljs-params">status: string, result: object</span>) {

      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
        <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
        map.<span class="hljs-title function_">setFitView</span>([ startMarker, endMarker, currentMarker ])
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
      }
    })
  })

})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lexical 富文本编辑器组件详解]]></title>    <link>https://juejin.cn/post/7586509410567438377</link>    <guid>https://juejin.cn/post/7586509410567438377</guid>    <pubDate>2025-12-22T03:18:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567438377" data-draft-id="7586136543954354214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lexical 富文本编辑器组件详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T03:18:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细心细心再细心"/> <meta itemprop="url" content="https://juejin.cn/user/721738373803879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lexical 富文本编辑器组件详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/721738373803879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细心细心再细心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:18:04.000Z" title="Mon Dec 22 2025 03:18:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">📚 Lexical 简介</h3>
<p><strong>Lexical</strong> 是 Meta 开源的基于 React 的富文本编辑器框架，用于替代 Draft.js，具有更好的性能、扩展性和稳定性。</p>
<h3 data-id="heading-1">🎯 核心特性</h3>
<ul>
<li>✅ 高性能、可扩展</li>
<li>✅ 无依赖、轻量级</li>
<li>✅ 完整的 TypeScript 支持</li>
<li>✅ 插件化架构</li>
<li>✅ 嵌套编辑器支持</li>
</ul>
<h3 data-id="heading-2">🔧 基础组件</h3>
<h4 data-id="heading-3">1. <strong>LexicalComposer</strong> - 编辑器容器</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
    <span class="hljs-attr">theme</span>: theme,
    <span class="hljs-attr">nodes</span>: [],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      {/* 其他插件组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-4">2. <strong>RichTextPlugin</strong> - 富文本核心</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Editor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
          &lt;<span class="hljs-attr">ContentEditable</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">minHeight:</span> '<span class="hljs-attr">150px</span>',
              <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>',
              <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span>',
            }}
          /&gt;</span>
        }
        placeholder={
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>输入内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        }
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-5">3. <strong>完整的基础编辑器</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">LexicalComposer</span>, 
  <span class="hljs-title class_">RichTextPlugin</span>,
  <span class="hljs-title class_">ContentEditable</span>,
  <span class="hljs-title class_">HistoryPlugin</span>,
  <span class="hljs-title class_">AutoFocusPlugin</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HeadingNode</span>, <span class="hljs-title class_">QuoteNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/rich-text'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TableCellNode</span>, <span class="hljs-title class_">TableNode</span>, <span class="hljs-title class_">TableRowNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/table'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ListNode</span>, <span class="hljs-title class_">ListItemNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/list'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CodeHighlightNode</span>, <span class="hljs-title class_">CodeNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/code'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AutoLinkNode</span>, <span class="hljs-title class_">LinkNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TRANSFORMERS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/markdown'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownShortcutPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalMarkdownShortcutPlugin'</span>;

<span class="hljs-keyword">const</span> theme = {
  <span class="hljs-comment">// 自定义样式</span>
  <span class="hljs-attr">text</span>: {
    <span class="hljs-attr">bold</span>: <span class="hljs-string">'editor-text-bold'</span>,
    <span class="hljs-attr">italic</span>: <span class="hljs-string">'editor-text-italic'</span>,
    <span class="hljs-attr">underline</span>: <span class="hljs-string">'editor-text-underline'</span>,
    <span class="hljs-attr">strikethrough</span>: <span class="hljs-string">'editor-text-strikethrough'</span>,
  }
};

<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
  theme,
  <span class="hljs-attr">nodes</span>: [
    <span class="hljs-title class_">HeadingNode</span>,
    <span class="hljs-title class_">QuoteNode</span>,
    <span class="hljs-title class_">TableNode</span>,
    <span class="hljs-title class_">TableCellNode</span>,
    <span class="hljs-title class_">TableRowNode</span>,
    <span class="hljs-title class_">ListNode</span>,
    <span class="hljs-title class_">ListItemNode</span>,
    <span class="hljs-title class_">CodeNode</span>,
    <span class="hljs-title class_">CodeHighlightNode</span>,
    <span class="hljs-title class_">AutoLinkNode</span>,
    <span class="hljs-title class_">LinkNode</span>
  ],
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyEditor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
          <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
            &lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span> /&gt;</span>
          }
          placeholder={
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>开始写作...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          }
        /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">AutoFocusPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownShortcutPlugin</span> <span class="hljs-attr">transformers</span>=<span class="hljs-string">{TRANSFORMERS}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-6">🔌 常用插件组件</h3>
<h4 data-id="heading-7">1. <strong>ToolbarPlugin</strong> - 工具栏组件</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { 
  $getSelection, 
  $isRangeSelection, 
  FORMAT_TEXT_COMMAND 
} from 'lexical'<span class="hljs-comment">;</span>

function ToolbarPlugin() {
  const <span class="hljs-section">[isBold, setIsBold]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[isItalic, setIsItalic]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">editor</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">updateToolbar</span> = useCallback(() =&gt; {
    const <span class="hljs-attr">selection</span> = <span class="hljs-variable">$getSelection</span>()<span class="hljs-comment">;</span>
    if ($isRangeSelection(selection)) {
      setIsBold(selection.hasFormat('bold'))<span class="hljs-comment">;</span>
      setIsItalic(selection.hasFormat('italic'))<span class="hljs-comment">;</span>
    }
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 监听编辑器状态变化
  useEffect(() =&gt; {
    return editor.registerUpdateListener(({ editorState }) =&gt; {
      editorState.read(() =&gt; {
        updateToolbar()<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor, updateToolbar]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isBold ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'bold'</span>)}
      &gt;
        加粗
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isItalic ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'italic'</span>)}
      &gt;
        斜体
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'underline'</span>)}
      &gt;
        下划线
      &lt;/button&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">2. <strong>ImagePlugin</strong> - 图片上传</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { INSERT_IMAGE_COMMAND } from './ImagePlugin'<span class="hljs-comment">;</span>

function ImagePlugin() {
  const <span class="hljs-section">[editor]</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleImageUpload</span> = useCallback((files: FileList) =&gt; {
    const <span class="hljs-attr">reader</span> = new FileReader()<span class="hljs-comment">;</span>
    <span class="hljs-attr">reader.onload</span> = function () {
      if (typeof <span class="hljs-attr">reader.result</span> === <span class="hljs-string">'string'</span>) {
        editor.dispatchCommand(INSERT_IMAGE_COMMAND, {
          altText: '图片',
          src: reader.result,
        })<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    reader.readAsDataURL(files<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;input
      <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
      <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
      <span class="hljs-attr">onChange</span>={(e) =&gt; handleImageUpload(e.target.files)}
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-9">3. <strong>LinkPlugin</strong> - 链接处理</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkPlugin</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">LexicalLinkPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalLinkPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkNode</span>, <span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LinkPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();
  <span class="hljs-keyword">const</span> [isLink, setIsLink] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> insertLink = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!isLink) {
      <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">'输入链接地址:'</span>, <span class="hljs-string">'https://'</span>);
      <span class="hljs-keyword">if</span> (url) {
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, url);
      }
    } <span class="hljs-keyword">else</span> {
      editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, <span class="hljs-literal">null</span>);
    }
  }, [editor, isLink]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{insertLink}</span>&gt;</span>
        {isLink ? '取消链接' : '添加链接'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LexicalLinkPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">📋 自定义节点组件</h3>
<h4 data-id="heading-11">1. <strong>自定义节点定义</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CustomNode.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DecoratorNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lexical'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DecoratorNode</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'custom'</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">node</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomNode</span>(node.<span class="hljs-property">__key</span>);
  }

  <span class="hljs-title function_">createDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">'custom-node'</span>;
    <span class="hljs-keyword">return</span> div;
  }

  <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">decorate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CustomComponent</span> <span class="hljs-attr">nodeKey</span>=<span class="hljs-string">{this.__key}</span> /&gt;</span></span>;
  }
}

<span class="hljs-comment">// 自定义组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomComponent</span>(<span class="hljs-params">{ nodeKey }</span>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'自定义内容'</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"custom-component"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setValue(e.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在配置中注册</span>
<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">CustomNode</span>, ...其他节点],
};
</code></pre>
<h4 data-id="heading-12">2. <strong>自定义插件示例</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;


<span class="hljs-comment">// 自定义键盘快捷键插件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardShortcutPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-comment">// Ctrl + S 保存</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'s'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        <span class="hljs-comment">// 保存逻辑</span>
        editor.<span class="hljs-title function_">update</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> editorState = editor.<span class="hljs-title function_">getEditorState</span>();
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存内容:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(editorState.<span class="hljs-title function_">toJSON</span>()));
        });
      }
      
      <span class="hljs-comment">// Ctrl + B 加粗</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'b'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">FORMAT_TEXT_COMMAND</span>, <span class="hljs-string">'bold'</span>);
      }
    };

    <span class="hljs-keyword">return</span> editor.<span class="hljs-title function_">registerRootListener</span>(<span class="hljs-function">(<span class="hljs-params">rootElement</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (rootElement) {
        rootElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
          rootElement.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        };
      }
    });
  }, [editor]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-13">实际使用</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalErrorBoundary</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalErrorBoundary'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OnChangePlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalOnChangePlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;


<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VariableTextNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./node'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./style.module.css'</span>;

  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'prompt-composer'</span>,
    <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">VariableTextNode</span>],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    },
    <span class="hljs-attr">theme</span>: {
      <span class="hljs-attr">paragraph</span>: styles.<span class="hljs-property">editorParagraph</span>,
    },
  };



<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.editorWrapper}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{cx(styles.editor,</span> <span class="hljs-attr">readOnly</span> &amp;&amp; <span class="hljs-attr">styles.editorReadonly</span>)}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height</span>, <span class="hljs-attr">minHeight</span> }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.contentEditable}</span> /&gt;</span>}
        placeholder={<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.placeholder}</span>&gt;</span>{placeholder || ''}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">OnChangePlugin</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleEditorChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariablePlugin</span> <span class="hljs-attr">variables</span>=<span class="hljs-string">{variables}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariableTransformerPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EditorUpdatePlugin</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">OnBlurPlugin</span> <span class="hljs-attr">onBlur</span>=<span class="hljs-string">{onBlur}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
  {!readOnly &amp;&amp; (
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeHandle}</span> <span class="hljs-attr">onMouseDown</span>=<span class="hljs-string">{beginResize}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeIcon}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  )}
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-style.module.css" lang="style.module.css">//样式文件
.editorParagraph {
  margin: 0;
  position: relative;
}
</code></pre>
<pre><code class="hljs language-node.ts" lang="node.ts">//自定义节点
import { TextNode, SerializedTextNode, Spread, NodeKey, $applyNodeReplacement } from 'lexical';

import styles from './style.module.css';

export type SerializedVariableTextNode = Spread&lt;
  {
    variableName: string;
  },
  SerializedTextNode
&gt;;

// Custom Text Node to handle variable highlighting
export class VariableTextNode extends TextNode {
  __variableName: string;

  constructor(text: string, variableName: string, key?: NodeKey) {
    super(text, key);
    this.__variableName = variableName;
  }

  static getType(): string {
    return 'variable-text';
  }

  isSimpleText(): boolean {
    return false;
  }

  // Make this node behave as a single unit - cannot be partially selected or edited
  isTextEntity(): boolean {
    return true;
  }

  static clone(node: VariableTextNode): VariableTextNode {
    return new VariableTextNode(node.getTextContent(), node.__variableName, node.getKey());
  }

  createDOM(config: any): HTMLElement {
    const element = super.createDOM(config);
    element.className = styles.variableToken;
    element.dataset.variable = this.__variableName;
    return element;
  }

  updateDOM(prevNode: VariableTextNode, dom: HTMLElement, config: any): boolean {
    const isUpdated = super.updateDOM(prevNode as any, dom, config);
    if (prevNode.__variableName !== this.__variableName) {
      dom.dataset.variable = this.__variableName;
      return true;
    }
    return isUpdated;
  }

  exportJSON(): SerializedVariableTextNode {
    return {
      ...super.exportJSON(),
      variableName: this.__variableName,
      type: 'variable-text',
    };
  }

  static importJSON(serializedNode: SerializedVariableTextNode): VariableTextNode {
    const node = new VariableTextNode(serializedNode.text, serializedNode.variableName);
    node.setFormat(serializedNode.format);
    node.setDetail(serializedNode.detail);
    node.setMode(serializedNode.mode);
    node.setStyle(serializedNode.style);
    return node;
  }
}

export function $createVariableTextNode(text: string, variableName: string): VariableTextNode {
  return $applyNodeReplacement(new VariableTextNode(text, variableName));
}//创建并注册一个VariableTextNode节点实例



</code></pre>
<ul>
<li>$applyNodeReplacement的作用</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"/></pre>
<p>// 这是 Lexical 的内部工具函数
import { $applyNodeReplacement } from 'lexical';</p>
<p>// 它主要做三件事：
function $applyNodeReplacement(newNode) {
// 1. ✅ 检查节点是否已存在（通过 key）
// 2. ✅ 如果存在，返回已存在的节点（避免重复）
// 3. ✅ 如果不存在，注册新节点到编辑器状态
// 4. ✅ 确保节点在编辑器中被正确追踪
}</p>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-14">📝 总结</h3>
<p>Lexical 提供了：</p>
<ol>
<li><strong>模块化架构</strong> - 按需加载插件</li>
<li><strong>完全控制</strong> - 自定义节点和命令</li>
<li><strong>高性能</strong> - 基于不可变数据</li>
<li><strong>扩展性强</strong> - 支持复杂需求</li>
</ol>
<p>推荐使用模式：</p>
<p>jsx</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EssentialPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CustomPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UtilityPlugins</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
</code></pre>
<ul>
<li>"@lexical/code": "^0.38.2"</li>
<li>"@lexical/link": "^0.38.2"</li>
<li>"@lexical/list": "^0.38.2"</li>
<li>"@lexical/react": "^0.16.0"</li>
<li>"@lexical/selection": "^0.38.2"</li>
<li>"@lexical/text": "^0.38.2"</li>
<li>"@lexical/utils": "^0.38.2"</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)]]></title>    <link>https://juejin.cn/post/7586157459971506228</link>    <guid>https://juejin.cn/post/7586157459971506228</guid>    <pubDate>2025-12-22T02:54:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971506228" data-draft-id="7585888537642270735" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:54:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我有与与症"/> <meta itemprop="url" content="https://juejin.cn/user/4466629837071787"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466629837071787/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我有与与症
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:54:08.000Z" title="Mon Dec 22 2025 02:54:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent-TDS%2FKuiklyUI%2Ftree%2Fmain%2Fdemo%2Fsrc%2FcommonMain%2Fkotlin%2Fcom%2Ftencent%2Fkuikly%2Fdemo%2Fpages%2Fcompose%2FchatDemo" target="_blank" title="https://github.com/Tencent-TDS/KuiklyUI/tree/main/demo/src/commonMain/kotlin/com/tencent/kuikly/demo/pages/compose/chatDemo" ref="nofollow noopener noreferrer">GitHub</a></p>
<p> </p>
<p>在这个 AI 大模型满天飞的时代，谁不想拥有一个属于自己的 AI 助手呢？今天，我们就以 ChatDemo 为例，看看如何用一套 Kotlin 代码，在 Android、iOS 和 HarmonyOS 三端上通过 Kuikly Compose 完美复刻 ChatGPT 的流式对话体验。</p>
<p> </p>
<p>别被 AI 的高大上吓跑了，其实拆解下来，核心逻辑就像搭积木一样简单。准备好了吗？发车！</p>
<p> </p>
<h2 data-id="heading-0">页面结构分析</h2>
<p>打开 <code>ChatDemo.kt</code>，我们仿佛看到了一位身材曼妙的“美女”——哦不，是一段结构清晰的代码。整个聊天页面 (<code>ChatScreen</code>) 主要由三部分组成：</p>
<p> </p>
<ol>
<li>
<p>顶部导航栏 (NavBar)：展示标题和返回按钮，雷打不动的“天灵盖”。</p>
</li>
<li>
<p>聊天内容区 (MessageList)：显示对话流，这是核心的“躯干”。</p>
</li>
<li>
<p>底部输入区 (InputArea)：输入框和发送按钮，负责交互的“四肢”。</p>
</li>
</ol>
<p> </p>
<p>这种结构在 Kuikly Compose 中实现起来异常清爽，简直就是“所见即所得”：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 伪代码结构演示</span>

Box(modifier = Modifier.fillMaxSize()) {

    Column {

        NavBar() <span class="hljs-comment">// 1. 天灵盖</span>

        ChatList() <span class="hljs-comment">// 2. 躯干</span>

        InputArea() <span class="hljs-comment">// 3. 四肢</span>
    }
}

</code></pre>
<p> </p>
<h2 data-id="heading-1">Kuikly Compose 写法</h2>
<p> </p>
<h3 data-id="heading-2">页面定义</h3>
<p>不同于之前的 <code>BasePager</code> + DSL，Compose 风格的页面继承自 <code>ComposeContainer</code>，通过 <code>setContent</code> 开启 Compose 的世界：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-meta">@Page(<span class="hljs-string">"ChatDemo"</span>)</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatDemo</span> : <span class="hljs-type">ComposeContainer</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">willInit</span><span class="hljs-params">()</span></span> {

        <span class="hljs-keyword">super</span>.willInit()

        setContent {

            ChatScreen() <span class="hljs-comment">// 进入 Compose 的声明式 UI 世界</span>

        }
    }
}

</code></pre>
<p>简单粗暴，直接入题！</p>
<p> </p>
<h3 data-id="heading-3">组件与布局</h3>
<p>Kuikly Compose 完美复刻了 Jetpack Compose 的开发体验，让习惯了 Android 开发的同学们倍感亲切。</p>
<p> </p>
<h4 data-id="heading-4">1. 列表组件 (LazyColumn)</h4>
<p>聊天记录怎么展示？<code>LazyColumn</code> 也就是我们常说的 RecyclerView 的“升级版”。</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
LazyColumn(

    state = listState,

    modifier = Modifier.weight(<span class="hljs-number">1f</span>)

) {

    itemsIndexed(chatList) { index, message -&gt;

        <span class="hljs-comment">// 根据 index 判断是用户还是 AI，渲染不同的气泡</span>

        ChatMessageItem(message, isUser = (index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>))

    }
}

</code></pre>
<p>看到没？没有 Adapter，没有 ViewHolder，就是一个简单的 Lambda，数据驱动 UI，清爽！</p>
<p> </p>
<h4 data-id="heading-5">2. 输入框 (TextField)</h4>
<p>底部的输入框使用了 <code>TextField</code>，这里有一个亮点——键盘避让。Kuikly 贴心地提供了 <code>keyboardHeightChange</code> 修饰符：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
TextField(

    modifier = Modifier

    .keyboardHeightChange {

        <span class="hljs-comment">// 键盘弹起时，自动调整高度，避免遮挡输入框</span>

        keyboardHeight = it.height
    }

)

</code></pre>
<p>这行代码一加，键盘弹起时的页面抖动、遮挡问题统统不见，丝般顺滑。</p>
<p> </p>
<h3 data-id="heading-6">样式与修饰符 (Modifier)</h3>
<p>在 Kuikly Compose 中，<code>attr {}</code> 变成了更强大的 <code>Modifier</code> 链式调用。比如首页那个好看的渐变色卡片：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Box(
    modifier = Modifier

    .clip(RoundedCornerShape(<span class="hljs-number">16.</span>dp)) <span class="hljs-comment">// 裁个圆角</span>

    .background(

        <span class="hljs-comment">// 来个渐变色</span>

        Brush.horizontalGradient(listOf(box.startColor, box.endColor))
    )
    .clickable { ... } <span class="hljs-comment">// 加个点击事件</span>
)

</code></pre>
<p>这就是声明式 UI 的魅力，你要什么效果，直接往上“叠”就行了。</p>
<p> </p>
<h2 data-id="heading-7">核心黑科技：跨平台流式响应</h2>
<p> </p>
<p>界面画好了，怎么让 AI “动”起来？ChatDemo 的核心在于流式响应 (SSE)，也就是那个酷炫的“打字机”效果。这里展示了 Kuikly 强大的跨平台能力。</p>
<p> </p>
<h3 data-id="heading-8">Android &amp; iOS (Ktor 协程)</h3>
<p>这两兄弟关系好，直接用 Kotlin 协程配合 Ktor 网络库，处理起来行云流水：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// ChatDemo.kt</span>

<span class="hljs-keyword">val</span> channel = response.bodyAsChannel()

<span class="hljs-keyword">while</span> (!channel.isClosedForRead) {

    <span class="hljs-keyword">val</span> line = channel.readUTF8Line()

    <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"data:"</span>)) {
        <span class="hljs-comment">// 收到数据，更新 UI</span>
        withContext(Dispatchers.Main) {
            chatList[msgIndex] += delta <span class="hljs-comment">// 界面自动刷新</span>
        }
    }
}

</code></pre>
<p> </p>
<h3 data-id="heading-9">HarmonyOS (Native Module 桥接)</h3>
<p>鸿蒙这位新朋友，Kuikly 也有妙招。在第三方组件Ktor还未完善对鸿蒙的支持情况下，Kuikly提供了Module 桥接机制，99% 的代码用 KMP 共享，剩下 1% 搞不定的平台特性，通过 Module 轻松桥接原生能力。通过 <code>OhosStreamRequestModule</code>，我们能轻松调用鸿蒙原生的 ArkTS 能力：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// OhosStreamRequestModule.kt</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">request</span><span class="hljs-params">(...)</span></span> {

    <span class="hljs-comment">// 呼叫鸿蒙原生层：帮我发个请求！</span>

    toNative(<span class="hljs-literal">true</span>, <span class="hljs-string">"request"</span>, params) { retEvent -&gt;
        <span class="hljs-comment">// 原生层收到 SSE 数据，回传给 Kotlin</span>
        callbackFn.invoke(eventObj)
    }
}

</code></pre>
<p>这就是 Kuikly 的哲学：能通用的通用，不能通用的桥接。一套架构，搞定所有平台。</p>
<p> </p>
<h2 data-id="heading-10">细节打磨：Markdown 渲染</h2>
<p>AI 返回的代码块、加粗字体怎么显示？直接塞进 <code>Text</code> 肯定不行。Kuikly 提供了 <code>Markdown</code> 组件：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Markdown(
    state = markdownState,
    colors = markdownColor(text = Color.Black), <span class="hljs-comment">// 定制颜色</span>
    typography = markdownTypography() <span class="hljs-comment">// 定制排版</span>
)

</code></pre>
<p>它能实时解析流式传输过来的 Markdown 文本，渲染过程毫无闪烁，稳如老狗。</p>
<p> </p>
<h2 data-id="heading-11">总结</h2>
<p>通过 Review <code>ChatDemo</code> 的源码，我们不仅学会了如何画界面，更解锁了 AI 应用开发的核心技能：</p>
<p> </p>
<ol>
<li>
<p>Compose 写法：用 <code>Modifier</code> 和声明式组件构建 UI，效率起飞。</p>
</li>
<li>
<p>状态管理：<code>mutableState</code> 让数据驱动界面更新，告别繁琐的 <code>setText</code>。</p>
</li>
<li>
<p>跨平台架构：Ktor 处理标准平台，Module 桥接新兴平台（鸿蒙），游刃有余。</p>
</li>
</ol>
<p> </p>
<p>Kuikly 已经把“地基”打好了，剩下的就看你们如何在上面盖出万丈高楼了！今天的代码 Review 就到这里，还不快去 Clone 下来跑一跑？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 => 打包报错]]></title>    <link>https://juejin.cn/post/7586509410567585833</link>    <guid>https://juejin.cn/post/7586509410567585833</guid>    <pubDate>2025-12-22T03:33:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567585833" data-draft-id="7585751355593703443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:33:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:26.000Z" title="Mon Dec 22 2025 03:33:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>rollup-plugin-obfuscator</code> 可以在基于 Vite 的 Vue 3 项目中使用，因为 Vite 本身就是基于 Rollup 构建的</p>
<p>npm install --save-dev rollup-plugin-obfuscator javascript-obfuscator</p>
<p>yarn add javascript-obfuscator -D</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> obfuscator <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-obfuscator'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// base: "",</span>
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'esbuild'</span>, <span class="hljs-comment">// 默认</span>
  },
  <span class="hljs-attr">esbuild</span>: {
    <span class="hljs-attr">drop</span>: [<span class="hljs-string">'console'</span>, <span class="hljs-string">'debugger'</span>],<span class="hljs-comment">//打包去除</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">obfuscator</span>({
      <span class="hljs-attr">global</span>:<span class="hljs-literal">false</span>,
      <span class="hljs-comment">// options配置项实际为 javascript-obfuscator 选项，具体可查看https://github.com/javascript-obfuscator/javascript-obfuscator</span>
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">compact</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlattening</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlatteningThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">numbersToExpressions</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">simplify</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayShuffle</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStrings</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStringsChunkLength</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">rotateUnicodeArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjection</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjectionThreshold</span>: <span class="hljs-number">0.4</span>,
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">debugProtectionInterval</span>: <span class="hljs-number">2000</span>,
        <span class="hljs-attr">disableConsoleOutput</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">domainLock</span>: [],
        <span class="hljs-attr">identifierNamesGenerator</span>: <span class="hljs-string">"hexadecimal"</span>,
        <span class="hljs-attr">identifiersPrefix</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">inputFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">renameGlobals</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">reservedNames</span>: [],
        <span class="hljs-attr">reservedStrings</span>: [],
        <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">selfDefending</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">sourceMapBaseUrl</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapMode</span>: <span class="hljs-string">"separate"</span>,
        <span class="hljs-attr">stringArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayEncoding</span>: [<span class="hljs-string">"base64"</span>],
        <span class="hljs-attr">stringArrayThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">target</span>: <span class="hljs-string">"browser"</span>,
        <span class="hljs-attr">transformObjectKeys</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">unicodeEscapeSequence</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-attr">domainLockRedirectUrl</span>: <span class="hljs-string">"about:blank"</span>,
        <span class="hljs-attr">forceTransformStrings</span>: [],
        <span class="hljs-attr">identifierNamesCache</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">identifiersDictionary</span>: [],
        <span class="hljs-attr">ignoreImports</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">optionsPreset</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-attr">renameProperties</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">renamePropertiesMode</span>: <span class="hljs-string">"safe"</span>,
        <span class="hljs-attr">sourceMapSourcesMode</span>: <span class="hljs-string">"sources-content"</span>,
       
        <span class="hljs-attr">stringArrayCallsTransform</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayCallsTransformThreshold</span>: <span class="hljs-number">0.5</span>,
       
        <span class="hljs-attr">stringArrayIndexesType</span>: [<span class="hljs-string">"hexadecimal-number"</span>],
        <span class="hljs-attr">stringArrayIndexShift</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayRotate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersCount</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">stringArrayWrappersChainedCalls</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersParametersMaxCount</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">stringArrayWrappersType</span>: <span class="hljs-string">"variable"</span>,
      }
    })
  ]
})

</code></pre>
<p>打包报错……</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器]]></title>    <link>https://juejin.cn/post/7585751355593834515</link>    <guid>https://juejin.cn/post/7585751355593834515</guid>    <pubDate>2025-12-22T03:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593834515" data-draft-id="7586509410567536681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 "/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-22T03:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="儿歌八万首"/> <meta itemprop="url" content="https://juejin.cn/user/3034307822894333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307822894333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    儿歌八万首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:37.000Z" title="Mon Dec 22 2025 03:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 开发中，我们经常需要为 <code>RecyclerView</code>、<code>ViewPager</code> 或 <code>HorizontalScrollView</code> 添加一个可视化的滚动指示器。虽然系统自带的 ScrollBar 能满足基本需求，但如果 UI 设计要求指示器有固定的宽度、圆角以及特定的颜色，自定义 View 往往是最佳选择。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0c083739fd4b53a2c868c8355b1731~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YS_5q2M5YWr5LiH6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979217&amp;x-signature=YBCuhfCI3YuEJoPIIuQwPwpfeV8%3D" alt="" loading="lazy"/></p>
<p>本文将带你使用 Kotlin 实现一个轻量级、高性能的水平滑动指示器组件 <code>BottomLineView</code>，并详细讲解如何适配主流的滚动控件。</p>
<h2 data-id="heading-0">1. 核心组件实现：BottomLineView</h2>
<p>我们创建一个继承自 <code>View</code> 的类 <code>BottomLineView</code>。它不依赖具体的滚动控件，只接收<strong>指示器宽度</strong>和<strong>滚动比例</strong>两个参数，实现了高度解耦。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BottomLineView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGray: Paint  <span class="hljs-comment">// 背景线画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGreen: Paint <span class="hljs-comment">// 指示器画笔</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> indicatorWidth = <span class="hljs-number">0f</span> <span class="hljs-comment">// 指示器的固定宽度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentOffset = <span class="hljs-number">0f</span>  <span class="hljs-comment">// 当前偏移量</span>

    <span class="hljs-keyword">init</span> {
        initPaint()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initPaint</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 背景线：灰色，圆角</span>
        paintGray = Paint().apply {
            color = -<span class="hljs-number">0x333334</span> <span class="hljs-comment">// 0xFFCCCCCC</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
        <span class="hljs-comment">// 指示器：绿色，圆角</span>
        paintGreen = Paint().apply {
            color = -<span class="hljs-number">0xff0100</span> <span class="hljs-comment">// 0xFF00FF00</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-keyword">val</span> centerY = height / <span class="hljs-number">2f</span>
        <span class="hljs-keyword">val</span> totalWidth = width.toFloat()

        <span class="hljs-comment">// 1. 绘制背景线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, centerY, totalWidth, centerY, paintGray)

        <span class="hljs-comment">// 2. 绘制指示器（确保不越界）</span>
        <span class="hljs-keyword">val</span> start = max(<span class="hljs-number">0f</span>, min(currentOffset, totalWidth - indicatorWidth))
        <span class="hljs-keyword">val</span> end = start + indicatorWidth

        <span class="hljs-keyword">if</span> (indicatorWidth &gt; <span class="hljs-number">0</span>) {
            canvas.drawLine(start, centerY, end, centerY, paintGreen)
        }
    }

    <span class="hljs-comment">/** 设置指示器物理宽度 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setIndicatorWidth</span><span class="hljs-params">(width: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">this</span>.indicatorWidth = width
        invalidate()
    }

    <span class="hljs-comment">/** 更新滚动比例 (0.0 ~ 1.0) */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateScrollRatio</span><span class="hljs-params">(ratio: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">val</span> maxOffset = width - indicatorWidth
        <span class="hljs-keyword">this</span>.currentOffset = maxOffset * ratio
        invalidate()
    }
}
</code></pre>
<h2 data-id="heading-1">2. 场景适配指南</h2>
<p>下面是三种最常见的滚动控件适配方案。</p>
<h3 data-id="heading-2">场景一：与 RecyclerView 联动</h3>
<p>这是最常用的场景。利用 <code>computeHorizontalScrollXXX</code> 系列方法可以精确计算滚动位置。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 设置指示器宽度</span>
bottomLineView.setIndicatorWidth(<span class="hljs-number">100f</span>)

<span class="hljs-comment">// 2. 监听滚动</span>
recyclerView.addOnScrollListener(<span class="hljs-keyword">object</span> : RecyclerView.OnScrollListener() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onScrolled</span><span class="hljs-params">(recyclerView: <span class="hljs-type">RecyclerView</span>, dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 获取滚动参数</span>
        <span class="hljs-keyword">val</span> offset = recyclerView.computeHorizontalScrollOffset() <span class="hljs-comment">// 当前偏移</span>
        <span class="hljs-keyword">val</span> range = recyclerView.computeHorizontalScrollRange()   <span class="hljs-comment">// 内容总宽</span>
        <span class="hljs-keyword">val</span> extent = recyclerView.computeHorizontalScrollExtent() <span class="hljs-comment">// 可见宽度</span>
        
        <span class="hljs-comment">// 计算最大可滚动距离</span>
        <span class="hljs-keyword">val</span> maxScroll = range - extent
        
        <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> ratio = offset.toFloat() / maxScroll
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h3 data-id="heading-3">场景二：与 HorizontalScrollView 联动</h3>
<p><code>HorizontalScrollView</code> 需要 API 23 (Android 6.0) 以上才能通过 <code>setOnScrollChangeListener</code> 监听。如果是低版本，可能需要继承并重写 <code>onScrollChanged</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">horizontalScrollView.setOnScrollChangeListener { _, scrollX, _, _, _ -&gt;
    <span class="hljs-comment">// 1. 获取子 View (内容)</span>
    <span class="hljs-keyword">val</span> contentView = horizontalScrollView.getChildAt(<span class="hljs-number">0</span>) ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnScrollChangeListener</span>
    
    <span class="hljs-comment">// 2. 计算最大可滚动距离 = 内容宽度 - 容器宽度</span>
    <span class="hljs-keyword">val</span> maxScroll = contentView.width - horizontalScrollView.width
    
    <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> ratio = scrollX.toFloat() / maxScroll
        bottomLineView.updateScrollRatio(ratio)
    }
}
</code></pre>
<h3 data-id="heading-4">场景三：与 ViewPager2 联动</h3>
<p><code>ViewPager2</code> 的计算逻辑略有不同，因为它是按“页”滚动的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">viewPager2.registerOnPageChangeCallback(<span class="hljs-keyword">object</span> : ViewPager2.OnPageChangeCallback() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageScrolled</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, positionOffset: <span class="hljs-type">Float</span>, positionOffsetPixels: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onPageScrolled(position, positionOffset, positionOffsetPixels)
        
        <span class="hljs-comment">// 假设 Adapter 中有 itemCount</span>
        <span class="hljs-keyword">val</span> itemCount = adapter.itemCount
        
        <span class="hljs-keyword">if</span> (itemCount &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 计算总进度</span>
            <span class="hljs-comment">// 当前页索引 + 当前页偏移百分比</span>
            <span class="hljs-keyword">val</span> currentProgress = position + positionOffset
            
            <span class="hljs-comment">// 总的可移动页数 = 总页数 - 1</span>
            <span class="hljs-keyword">val</span> totalProgress = (itemCount - <span class="hljs-number">1</span>).toFloat()
            
            <span class="hljs-keyword">val</span> ratio = currentProgress / totalProgress
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h2 data-id="heading-5">3. 总结</h2>
<p>通过将 UI 绘制逻辑封装在 <code>BottomLineView</code> 内部，并将状态更新抽象为 <code>updateScrollRatio(0.0~1.0)</code> 接口，我们成功地让这个指示器适配了 Android 所有的水平滚动组件。无论底层是用 RecyclerView 还是 ViewPager，UI 层的表现都一样丝滑流畅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS code为python文件配置默认模板]]></title>    <link>https://juejin.cn/post/7585948869844942883</link>    <guid>https://juejin.cn/post/7585948869844942883</guid>    <pubDate>2025-12-22T02:53:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844942883" data-draft-id="7585929179319533603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS code为python文件配置默认模板"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-22T02:53:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="波克布林的矩阵633"/> <meta itemprop="url" content="https://juejin.cn/user/3762989890536400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS code为python文件配置默认模板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3762989890536400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    波克布林的矩阵633
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:53:23.000Z" title="Mon Dec 22 2025 02:53:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些大体积的IDE会有自带头部信息的功能，</p>
<p>刚开始学python的我，使用的是VSCode，没有发现有插件可以完成（似乎有C的）</p>
<p>但是也可以通过在VSCode中自定义User Snippets(用户代码段)来实现类似的功能</p>
<h2 data-id="heading-0">1 配置方法</h2>
<p>打开VScode——File——Preference——Configure Snippets
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f2d92ceb8a6435b9dd84cc4f77bf2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=XYmZnjFJKx0isumHyGDpw%2Bmk3JE%3D" alt="image.png" loading="lazy"/></p>
<p>我之前已经配置过了，未配置过，这里需要找到python.json</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dd0878e44fc491a8e61fdedc1bb73b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=FcmdhwUF3JzIp9fMKHboYIQbOvs%3D" alt="image.png" loading="lazy"/></p>
<p>在弹出的python.json文件中注释掉原来的，加入以下自定义的代码段，保存退出</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"HEADER"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"header"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-comment">// "#!/usr/bin/env python",</span>
        <span class="hljs-string">"# -*- encoding: utf-8 -*-"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"'''"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@File    :   $TM_FILENAME"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Time    :   $CURRENT_YEAR/$CURRENT_MONTH/$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Author  :   Jiahao Chen "</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Version :   1.0"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Contact :  244671870@qq.com"</span><span class="hljs-punctuation">,</span>
        
        <span class="hljs-string">"'''"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"# here put the import lib"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"$0"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>
    
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">2 使用方法</h2>
<p>在文档中输入header就可以头部注释 了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c8cd94bfb746dc8b71ea37d329e416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=ElC8Z9giBx0a1RRKUwdRJqTXov4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb93c72046d4b6daa6235d938b0b922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=qceDbXx7ZOHvoBlE6lQ2Xkzt83g%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter UI 设计库解耦重构进度，官方解答未来如何适配]]></title>    <link>https://juejin.cn/post/7585751355593850899</link>    <guid>https://juejin.cn/post/7585751355593850899</guid>    <pubDate>2025-12-22T03:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593850899" data-draft-id="7585969437032267818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter UI 设计库解耦重构进度，官方解答未来如何适配"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-22T03:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter UI 设计库解耦重构进度，官方解答未来如何适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:34:11.000Z" title="Mon Dec 22 2025 03:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在目前的 Flutter 架构中，Material（Android ）和 Cupertino（iOS）的 UI 库是与核心框架捆绑在一起的，也就是常见的 "batteries included" 原则，为的是方便开发者开箱即用，但是也导致了 Widgets、Material 和 Cupertino 这三个 lib 紧密耦合。</p>
<p>而今年提出的 decoupling design 重构，就是<strong>计划将这两个设计库从核心框架中解耦，并调整到独立的 Pub 包</strong>，也就是核心框架将只包含基础的 <code>Widgets</code> 库，而特定的设计风格将变为可选的插件 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7f08af96f354221ab52520890f27380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=r95H8TJV7oMzVG70mcSaJ8gnn8M%3D" alt="" loading="lazy"/></p>
<p>之所以会有这个调整，最主要还是因为在最新的 Material 3 Expressive 和 Liquid Glass 风格发布之后，UI 在 Framework 层的适配成本变高，并且 <strong>Framework 的更新节奏也无法很好适应这种 UI 风格调整</strong>，所以在社区的呼声下，官方正式开始了 decoupling design 计划。</p>
<p>实际上在之前，很多基础组件对特定设计库有不必要的依赖，你以为框架的代码结构是下图 A ，但是在多年维护后，目前已经是下图 B 的情况：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d602fb81d4fe1b65e446997de2572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=6qAsbJsdiaILfSsykRKpbhEQOnQ%3D" alt="" loading="lazy"/></p>
<p>另外，类似 <code>SelectionArea</code> 组件，它看起来是一个纯 Widget 的基础组件，但为了实现跨平台适配，底层却必须依赖 Material 和 Cupertino 库 ，如果没有，你就会发现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5259133efa5c48faa624e75b8dc5dfa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=npmC5nlW3N6ZY9HEKsRLclLt73Q%3D" alt="" loading="lazy"/></p>
<p>因为在之前的 "batteries included" 原则，实际上控件内部会根据使用的风格或者运行的平台，主动为用户采用对应的主题风格，这样的话好处肯定是开箱即用，但是实际上用户很多时候并不理解这一点，并且最重要的是：</p>
<blockquote>
<p><strong>由于设计库与框架发布周期绑定，新设计的跟进趋势会让适应速度变慢很多，同时紧密的耦合也让 PR 变得复杂，每次调整风险更高，容易引发回归错误</strong> 。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2278e0a4c947a0a189036864f45187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=4lT3LjEFHBWBGzGN194n4Ek8ni0%3D" alt="" loading="lazy"/></p>
<p>另外，现阶段开发者如果想构建非 Material/Cupertino 的自定义设计系统，往往不得不从头开始，因为现有的基础组件的定制功能开发不足 ，所以 decoupling design 作为现阶段必须经历的产物，最终提上了日程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f849dc87fb8b4a838b4bb5509b028c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=YaEXHekZKeZOlUgDuC8Ed3zKvuY%3D" alt="" loading="lazy"/></p>
<p>当然，实际上解耦和重构设计库是一个非常大的底层调整，其中核心主要涉及了四个领域：</p>
<ul>
<li><strong>System UI</strong> ：需要重新界定设计库与平台之间的界限（例如文本选择、页面过渡） ，这个是最大的成本之一</li>
<li><strong>代码组织</strong> ：在基础 <code>Widgets</code> 库中创建更多的“原始组件抽象” (raw widget abstractions)，类似现在的 <code>RawRadio</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e79ad1ea8cf4bda87832255ae530e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=OKahAaQVVHvPFPi6LwM6n9oIfZc%3D" alt="" loading="lazy"/></li>
<li><strong>主题</strong>：评估并改进主题系统，解决 Material 和 Cupertino 主题缺乏共同 BASE 的问题 ，因为之前 Widgets 完全没有主题体系，所以需要考虑是否引入更通用的 theme abstraction</li>
<li><strong>基础设施适配</strong>：迁移超过 200 个测试，并将相关的 CI 流程从主仓库迁移出去 ，避免交叉导入，建立独立的 CI 流程，让 PR 更便捷过审</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc792c8a50d4f9a90e6478487e2e0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=nq3LVhvrxJxQD%2BAOWsZUX%2BQw2eU%3D" alt="" loading="lazy"/></p>
<p>而对于解耦完成的是假变，整个项目分三个阶段进行：</p>
<ul>
<li>
<p><strong>阶段一 (2025年12月)</strong> ：</p>
<ul>
<li>基础调整，将 Material/Cupertino 中的通用核心逻辑下沉移动到 <code>widgets</code> 库</li>
<li>搭建 Flutter packages 仓库的基础支持</li>
</ul>
</li>
<li>
<p><strong>阶段二 2026年</strong> ：</p>
<ul>
<li>正式解耦，将代码移至新的包中并发布到 Pub</li>
<li>在主框架中标记旧库为“已弃用” (deprecated)</li>
</ul>
</li>
<li>
<p><strong>阶段三 - 2026年晚些时候</strong> ：</p>
<ul>
<li>从核心框架中彻底移除已弃用的 Material 和 Cupertino 库</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4eda73d66a4a6a84a4bb3385cb4e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=eYX2ZyzSg4ENvbGcvoTvAC9HAWw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>也就是，2026 年我们就可以拥有全新的 Material 3 Expressive 和 Liquid Glass 风格支持，并且是可选 package</p>
</blockquote>
<p>当然，对开发者的影响的使用肯定有影响，这个影响有好有坏：</p>
<ul>
<li><strong>版本管理更灵活</strong>：解耦后，Material 和 Cupertino 将遵循语义化版本控制，开发者可以锁定特定版本，独立于 Flutter 框架的升级节奏 ，更加方便灵活，<strong>不必跟着 Flutter 升级 UI 设计</strong></li>
<li><strong>更容易构建自定义设计</strong>：通过使用底层的“原始组件” (raw widgets，如 <code>RawRadio</code>)，构建完全自定义的 UI 系统将变得更加容易，不再被迫基于 Material 组件修改</li>
<li><strong>破坏性变更 (Breaking Changes)</strong> ：虽然未来会提供快速修复工具 (quick fixes)，但解耦过程不可避免地会带来一些破坏性变更 ，这些是是需要开发者自己适配</li>
<li><strong>设计库更新暂停</strong>：为了减少迁移难度，在解耦完成前， Flutter 会将暂停引入新的重大设计更新（如 Material 3 Expressive 或 Liquid Glass） ，所以这个需要开发耐心等待</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fa99b8f6d842f2acfc7786def5d092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=P7KXXLTGu4fKwzFHOl8%2BkEvYgfs%3D" alt="" loading="lazy"/></p>
<p>当然，解耦之后，<strong>Framework 的 UI break change 会越来越少，而开发者也可以选择自己的 style package 进行 lock</strong> ，整体灵活性和可用度会更好。</p>
<p>不过，对于 Plugin开发者来说，可能会有更高的适配成本，<strong>因为需要考虑 UI 实现里使用的是哪个 version 的 style package ，也需要考虑会不会给用户带来版本冲突等</strong>，在这方面也许未来会出现类似 RN 的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff1a70cf4a9347aba175551957b971b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=NLTo0F37w3rKBu1LOuWLfBf4LxI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">最后</h2>
<p>这次重构虽然是一项巨大的工程，但长远来看会让 Flutter 框架更耐用，也让设计库的迭代更迅速，并更好地支持第三方设计生态系统的发展 ，甚至未来 PC 平台的第三方 UI 风格也可以更好适配，这也引出另一个问题：</p>
<blockquote>
<p>Compose Multiplatform 是否也有类似问题，是否也会跟进？毕竟 CMP 也是以 Material 为主，不过目前看来 Compose 先天具备分层风格 function ，更倾向于平台层 UI 自己独立实现，实际上问题会小很多。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力]]></title>    <link>https://juejin.cn/post/7585969437032349738</link>    <guid>https://juejin.cn/post/7585969437032349738</guid>    <pubDate>2025-12-22T03:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585969437032349738" data-draft-id="7586509410567553065" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从&quot;人工催办&quot;到&quot;AI 规则驱动&quot;：我们如何解放测试团队的生产力"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-12-22T03:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:41:41.000Z" title="Mon Dec 22 2025 03:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力</h2>
<p>很多测试同学除了本职工作，还承担着中小型项目的管理工作，却因此成了项目中的“人工待办清单”。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2145343fb245464ba1034dd25ab8b93e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=qVZD5C37p6hR1n2WA4DowsSn75Q%3D" alt="" loading="lazy"/></p>
<p>“人工待办”依赖记忆的流程节点去推动事情，我们发现：测试团队真正该做的测试工作（深度测试、质量分析、风险挖掘），正被流程管理悄悄偷走。</p>
<p>于是，我们打造了这个<strong>超轻量的项目管理工具</strong>，让规则在项目群“主动说话”，将“<strong>何时、谁、做什么</strong>”标准化，由程序收集信息、提醒推进。</p>
<h3 data-id="heading-1">Part 1. 从“混乱的记忆经验”到“动态的客观规则”</h3>
<p>认识到“依赖人工待办”的痛点只是第一步。核心挑战是：<strong>项目管理本身既有定式又有变化</strong>。</p>
<ul>
<li>3 人 3 天的紧急需求，与跨端日常迭代的管理差异？</li>
<li>内部协作项目，与外部频繁对接项目的节点区别？</li>
</ul>
<p>过去，全凭测试负责人的“个人经验”处理，可能出现的结果：</p>
<ul>
<li>小型项目被<strong>过度管理</strong>，徒增负担；</li>
<li>大型项目又<strong>管理不足</strong>，漏洞百出。</li>
</ul>
<p>我们意识到，项目管理规则不是统一模板，而是能应对不同“项目参数”的<strong>动态规则系统</strong>。</p>
<p>搭建这套系统，需围绕项目管理时的具体问题展开：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/098dd0bfb3844bf89047eb127571b589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=9bqubVZxQfwUiRyRtG69YItsnXo%3D" alt="" loading="lazy"/></p>
<p>据此，我们得出三个解题方向。</p>
<h4 data-id="heading-2">1、按项目规模 控制管理粒度</h4>

























<table><thead><tr><th>项目类型</th><th>管理策略</th><th>关键动作</th></tr></thead><tbody><tr><td><strong>小型需求</strong></td><td>功能独立，迭代要“快”</td><td>只保留确保质量底线的关键检查点</td></tr><tr><td><strong>中型迭代</strong></td><td>保证速度 + 强调“稳”</td><td>加入技术评审、联调日会等节点，确保信息同步和风险前置</td></tr><tr><td><strong>大型项目</strong></td><td>在中型基础上强调“可控”与“对齐”</td><td>增加每日站会、细化联调计划等</td></tr></tbody></table>
<h4 data-id="heading-3">2、 按项目类型 区分差异节点</h4>
<ul>
<li><strong>含客户端项目</strong>：增加集测、上线前物料检查、发版等节点</li>
<li><strong>涉外部门项目</strong>：增加需求串讲、技术方案串讲、测试边界拉齐等节点</li>
</ul>
<h4 data-id="heading-4">3、 四个维度定规则 清晰可落地</h4>






























<table><thead><tr><th>维度</th><th>定义</th><th>示例（测试期每日站会）</th></tr></thead><tbody><tr><td><strong>谁</strong></td><td>负责人</td><td>测试负责人</td></tr><tr><td><strong>什么时间</strong></td><td>触发条件</td><td>测试期间</td></tr><tr><td><strong>干什么事(以什么标准)</strong></td><td>具体动作</td><td>固定时间组织站会<br/>会上发言模板：昨日、今日、风险依赖<br/>站会控制时间</td></tr><tr><td><strong>交付什么结果</strong></td><td>产出内容</td><td>群内发送站会记录</td></tr></tbody></table>
<blockquote>
<p><strong>产出结果举例：站会记录要求</strong></p>
<ul>
<li>清晰阐明整体进度是否正常，风险情况（高、中、低、无）</li>
<li>若不正常，阐明原因和应对解决方案</li>
<li>Todo 事项需包含：事项内容、跟进人、解决时间</li>
</ul>
</blockquote>
<p>我们推出一份详尽的项目管理规范，但<strong>落地不尽人意</strong>。<br/>
比如这份“差点意思”的站会记录：</p>
<blockquote>
<p><strong>会议内容</strong></p>
<ul>
<li>测试 A：昨天测首页，好多 bug，图片加载慢、按钮点不动，环境也卡。</li>
<li>测试 B：支付模块测一半，开发改了代码没说，之前的测试白做了，今天再重新测。</li>
<li>开发 C(临时参会)：A 说的按钮问题不是我写的，没法修，环境卡是运维的事。</li>
<li>待办 1：首页图片加载慢、按钮异常、环境卡顿</li>
<li>待办 2：支付模块需重新测试</li>
</ul>
</blockquote>
<p>深刻体会到：<strong>最难的从来不是“制定规则”，而是“让规则执行”</strong></p>
<p>![](&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fpic4.zhuanstatic.com%2Fzhuanzh%2Fd7317dfb-0708-4c7a-accb-3f4d019e3f11.png%23pic_center%3D128x128" target="_blank" title="https://pic4.zhuanstatic.com/zhuanzh/d7317dfb-0708-4c7a-accb-3f4d019e3f11.png#pic_center=128x128" ref="nofollow noopener noreferrer">pic4.zhuanstatic.com/zhuanzh/d73…</a>)</p>
<h3 data-id="heading-5">Part 2. 如何让规则拥有“执行力”？</h3>
<h4 data-id="heading-6">1、思考：为何落地难？</h4>
<p>我们意识到执行问题可能出在三个“人性弱点”与规则的冲突：</p>
<ul>
<li><strong>记忆负担</strong>：流程节点多，易遗漏</li>
<li><strong>执行成本</strong>：写纪要等需额外思考格式，较麻烦</li>
<li><strong>缺失监督</strong>：无实时客观检查，全靠自觉</li>
</ul>
<p><strong>我们意识到：</strong><br/>
静态文档难以落地，规则必须进化为一个<strong>动态的、能够主动驱动行为的工具</strong>。</p>
<p>核心问题随之而来：<strong>什么样的工具，才能真正具备驱动团队遵守规则的“力”？</strong></p>
<p>![](<a href="https://link.juejin.cn?target=https%3A%2F%2Fpic6.zhuanstatic.com%2Fzhuanzh%2Fb48a93f0-b6e0-40db-b6bf-e0c2d54e4ad5.png%23pic_center" target="_blank" title="https://pic6.zhuanstatic.com/zhuanzh/b48a93f0-b6e0-40db-b6bf-e0c2d54e4ad5.png#pic_center" ref="nofollow noopener noreferrer">pic6.zhuanstatic.com/zhuanzh/b48…</a> =128x128)</p>
<h4 data-id="heading-7">2、 改变：融入而非对抗，赋能而非监控</h4>
<p>核心思路：<strong>必须深度融入大家已经形成习惯的、最自然、最高频的协作场景里</strong>。</p>
<p>在我们团队，这个场景就是 <strong>“项目群”</strong>。几乎所有的项目协作都发生在这里：</p>
<ul>
<li><strong>信息中枢</strong>：需求文档、技术方案、测试用例、项目排期等核心资产，都以群公告的形式沉淀</li>
<li><strong>协作广场</strong>：评审邀约、进度同步、问题讨论、决策拍板，所有沟通都在群聊中实时发生</li>
</ul>
<p>破局路径由此明确：
<strong>以“项目群”为基础，将规则引擎悄无声息地编织进去</strong>。<br/>
我们不再要求大家“看文档”，而是让规则在群里“<strong>主动说话</strong>”、“<strong>主动办事</strong>”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebcc6ac1ff674559a8aa4ca9e7609bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=Js82m6uRTbng60AGKDlGUwQp6MY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">1. 低成本：简单智能交互</h5>
<p>关键信息发送至群内周知时，仅需增加 <strong>@项目管理助手</strong></p>
<ul>
<li>系统<strong>自动识别意图，存储</strong>至项目管理表格</li>
<li><strong>将接入和信息同步成本降到最低</strong></li>
</ul>
<h5 data-id="heading-9">2. 节点推送：变“人找事”为“事找人”</h5>
<p>规则引擎按项目排期自动推送信息：</p>
<ul>
<li><strong>事前提醒</strong>：<br/>
“下个工作日就要进入测试啦，辛苦测试负责人 @xx 申请测试环境，同步至群内并 @项目管理机器人”</li>
<li><strong>过程赋能</strong>：<br/>
“xxx 环境所部署分支覆盖率不足，请测试负责人 @xx 关注”</li>
<li><strong>结果校验</strong>：<br/>
“会议纪要内容风险为高，但无原因和对应解决措施”<br/>
“项目已上线，但存在未关闭缺陷，请及时关注”</li>
</ul>
<h3 data-id="heading-10">Part 3. 我们是如何实现落地的？</h3>
<h4 data-id="heading-11">三层框架</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d3b1cc65d549358a5bfe0ffddf2be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=l2EzqWj8ln88dRoGchMsI4VH96Y%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-12">1. 交互层：企微群机器人</h5>
<ul>
<li><strong>智能机器人</strong>：接收群内消息，理解用户意图</li>
<li><strong>普通机器人</strong>：负责定时消息推送</li>
</ul>
<h5 data-id="heading-13">2. 中间层：转换层</h5>
<ul>
<li>将智能机器人接收到的消息传递给 Coze</li>
<li>封装代码逻辑供 Coze 调用，实现群推送等功能</li>
</ul>
<h5 data-id="heading-14">3. 执行层：基于 Coze 搭建的自动化流程</h5>
<ul>
<li>
<p><strong>接收用户消息</strong></p>
<ul>
<li>使用大模型识别意图、提取关键信息</li>
<li>评估输入是否符合要求</li>
<li>更新至项目管理表格</li>
</ul>
</li>
<li>
<p><strong>定时推送</strong></p>
<ul>
<li>设置触发器定时执行</li>
<li>根据项目管理表 + 当前日期 → 判断节点 → 推送信息</li>
</ul>
</li>
<li>
<p><strong>通用能力</strong></p>
<ul>
<li>覆盖率获取、静态扫描结果获取等</li>
</ul>
</li>
<li>
<p><strong>自定义 Coze 插件</strong></p>
<ul>
<li>飞书官方插件不能实现期望功能 → 开发飞书插件并上架商店（复制工作表、Sheet 页、追加数据）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/504f77c97b4240319dbb883329ab7479~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=%2FmctEiEdl%2BsvjisjZFKMfFBIm0U%3D" alt="" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">简单架构图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ec97a6f51c4db0ba6daf403b69ff14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=M9Lhyb6TXyKDlZLfyDSl8fHUHBE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">核心数据表格</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25bf6d8d47984c5397d884456a28f517~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=hTuGVvlI8JpBFiWcjtYCtptmw7I%3D" alt="" loading="lazy"/></p>

















<table><thead><tr><th>表名</th><th>作用</th></tr></thead><tbody><tr><td><strong>项目总览表</strong></td><td>接入表，记录项目关键信息：<br/>群聊 ID、项目名称、项目管理表格（自动创建）、TAPD 地址、群消息机器人</td></tr><tr><td><strong>项目管理表</strong></td><td>基于 PART1 沉淀的规则，记录项目关键节点与状态</td></tr></tbody></table>
<h4 data-id="heading-17">具体功能说明</h4>
<ol>
<li><strong>自动接入</strong>：基于群内标准化输入，自动写入总览表</li>
<li><strong>自动更新</strong>：用户主动推送信息 → 自动更新项目管理表，无需额外维护</li>
<li><strong>定时提醒</strong>：需执行动作/关注内容 → 自动 @ 具体人员</li>
<li><strong>工具赋能</strong>：联动 TAPD、公司平台，通过接口获取节点信息 → Coze 处理 → 推送</li>
<li><strong>自动闭环</strong>：上线后持续跟进 TAPD 状态和 Bug 情况 → 全部处理后 → 自动标记为“已上线”</li>
</ol>
<h4 data-id="heading-18">落地效果示例</h4>
<blockquote>
<hr/>
<ul>
<li>✅ 输入信息自动接入
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e26c7aada0d64214b79f9b30d5a2dc01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=i47%2BnfkXRfHI2kpPt99BMzuM0QE%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 测试进度上报校验 + Bug 情况总结
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7376f7d936c4871982db4f5e2081bde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=MpNZqiiWWf6evi9J4vUPUAVzDZE%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 分支覆盖率结果推送
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac203d2a79d042919b29f06f51ce6a37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=oY5E6q2oA0TJNI%2FuMXon6OyxEpo%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 提前一天事项提醒｜静态扫描结果提醒
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0106c915d8443369f8b58a589b3af94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=P6eA4HBUm4xBx%2BJVuzGqpWhFROw%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
</blockquote>
<h4 data-id="heading-19">大家可能有的小疑问</h4>
<blockquote>
<p><strong>Q：为什么要用 2 个机器人？</strong><br/>
A：受企业微信限制，智能机器人只能被动响应用户主动 @ 的消息，无法主动推送。普通机器人用于定时任务。</p>
<p><strong>Q：为什么不用企业微信文档？</strong><br/>
A：企微文档能力受限，且与 Coze 集成弱；而<strong>飞书 + Coze 集成成熟</strong>，可自行开发插件，灵活度高。</p>
</blockquote>
<hr/>
<h4 data-id="heading-20">相关资料合集</h4>
<blockquote>
<ul>
<li>
<p>企微智能机器人：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.work.weixin.qq.com%2Fdocument%2Fpath%2F100719" target="_blank" title="https://developer.work.weixin.qq.com/document/path/100719" ref="nofollow noopener noreferrer">developer.work.weixin.qq.com/document/pa…</a></p>
</li>
<li>
<p>企微普通群机器人：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.work.weixin.qq.com%2Fdocument%2Fpath%2F99110" target="_blank" title="https://developer.work.weixin.qq.com/document/path/99110" ref="nofollow noopener noreferrer">developer.work.weixin.qq.com/document/pa…</a></p>
</li>
<li>
<p>飞书电子表格 API：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2Fserver-docs%2Fdocs%2Fsheets-v3%2Foverview" target="_blank" title="https://open.feishu.cn/document/server-docs/docs/sheets-v3/overview" ref="nofollow noopener noreferrer">open.feishu.cn/document/se…</a></p>
</li>
<li>
<p>Coze 基于 API 创建插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2Fopen%2Fdocs%2Fguides%2Fservices" target="_blank" title="https://www.coze.cn/open/docs/guides/services" ref="nofollow noopener noreferrer">www.coze.cn/open/docs/g…</a></p>
</li>
</ul>
</blockquote>
<h4 data-id="heading-21">应用效果</h4>
<h5 data-id="heading-22">实际反馈：</h5>
<blockquote>
<ul>
<li>“事项并行时，会忘记一些节点。接入后，到关键节点自动提醒，不会忘啦！”</li>
<li>“Bug 情况的推送很给力，之前总有人不及时解决，需要一直催。现在每天推送后，解决进度都变快了。”</li>
<li>“各分支的覆盖率是否达标一目了然，再也不用一个个检查了。”</li>
</ul>
</blockquote>
<h5 data-id="heading-23">团队建议：</h5>
<blockquote>
<ul>
<li>对未完成的 Todo 列表进行提醒</li>
<li>根据上线计划，Check 是否执行到位（如定时任务是否配置并开启）</li>
<li>通过冒烟任务执行情况校验联调进度是否正常</li>
</ul>
</blockquote>
<h3 data-id="heading-24">写在最后</h3>
<p>这个工具把我们过去<strong>靠人脑记忆、靠人工催促的规则，交给了程序</strong>。带来切实改变：：</p>
<blockquote>
<ul>
<li>不再费心记忆每个时间节点该做什么</li>
<li>不用自己一个个查覆盖率、人工汇总 Bug</li>
<li>产出内容是否合理，不用组长盯，工具会自动告诉你问题在哪</li>
</ul>
<p><strong>最重要的是：测试团队终于能把主要精力，逐步放回测试本身</strong>。</p>
</blockquote>
<p>我们仍在起步阶段，后续将赋能更多流程节点。让项目过程管理越来越轻松。</p>
<p>如果你也受困于“人工待办”，或也想用 Coze 做一些工具赋能，欢迎一起交流！</p>
<p><code>&gt; 转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。</code></p>
<p><code>&gt; 关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流式计算框架简单综述-第一篇]]></title>    <link>https://juejin.cn/post/7586136543954747430</link>    <guid>https://juejin.cn/post/7586136543954747430</guid>    <pubDate>2025-12-22T03:43:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954747430" data-draft-id="7585920796100509723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流式计算框架简单综述-第一篇"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T03:43:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流式计算框架简单综述-第一篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:43:21.000Z" title="Mon Dec 22 2025 03:43:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文深入剖析流式计算原理、流批一体架构、Lambda与Kappa架构优劣，并结合实际场景，全面阐述实时数据处理的技术演进与工程实践。</p>
<h2 data-id="heading-1">引言</h2>
<h3 data-id="heading-2">流式计算的背景和场景</h3>
<p>在日常生活中，我们通常会先把数据存储在一张表中，然后再进行加工、分析，这里就涉及到一个时效性的问题。如果我们处理以年、月为单位的级别的数据，那么多数据的实时性要求并不高；但如果我们处理的是以天、小时，甚至分钟为单位的数据，那么对数据的时效性要求就比较高。在第二种场景下，如果我们仍旧采用传统的数据处理方式，统一收集数据，存储到数据库中，之后在进行分析，就可能无法满足时效性的要求。</p>
<p>通过大数据处理我们获取了数据的价值，但是数据的价值显然不是恒定不变的。一些数据在事情发生后不久就有了更高的价值，而且这种价值会随着时间的推移而迅速减少。流处理的关键优势在于它能够更快地提供洞察力，通常在毫秒到秒之间。</p>
<p>流式处理可以用于两种不同场景： 事件流和持续计算。</p>
<p>1、事件流</p>
<p>事件流能够持续产生大量的数据，这类数据最早出现与传统的银行和股票交易领域，也在互联网监控、无线通信网等领域出现、<strong>需要以近实时的方式对更新数据流进行复杂分析如趋势分析、预测、监控等</strong>。简单来说，事件流采用的是查询保持静态，语句是固定的，数据不断变化的方式。</p>
<p>2、持续计算</p>
<p>比如对于大型网站的流式数据：网站的访问PV/UV、用户访问了什么内容、搜索了什么内容等，实时的数据计算和分析可以动态实时地刷新用户访问数据，展示网站实时流量的变化情况，<strong>分析每天各小时的流量和用户分布情况</strong>；</p>
<p><strong>比如金融行业，毫秒级延迟的需求至关重要</strong>。一些需要实时处理数据的场景也可以应用Storm，比如根据用户行为产生的日志文件进行实时分析，<strong>对用户进行商品的实时推荐等</strong>。</p>
<p>其实这两种，事件流和持续计算本质上都是事件流。</p>
<h3 data-id="heading-3">流式计算与批量计算</h3>
<p>大数据的计算模式主要分为批量计算(batch computing)、流式计算(stream computing)、交互计算(interactive computing)、图计算(graph computing)等。其中，流式计算和批量计算是两种主要的大数据计算模式，分别适用于不同的大数据应用场景。</p>
<p>流数据（或数据流）是指在时间分布和数量上无限的一系列动态数据集合体，数据的价值随着时间的流逝而降低，因此必须实时计算给出秒级响应。流式计算，顾名思义，就是对数据流进行处理，是实时计算。批量计算则统一收集数据，存储到数据库中，然后对数据进行批量处理的数据计算方式。主要体现在以下几个方面：</p>
<p>1、数据时效性不同：流式计算实时、低延迟， 批量计算非实时、高延迟。</p>
<p>2、数据特征不同：流式计算的数据一般是动态的、没有边界的，而批处理的数据一般则是静态数据。</p>
<p>3、应用场景不同：流式计算应用在实时场景，时效性要求比较高的场景，如实时推荐、业务监控…批量计算一般说批处理，应用在实时性要求不高、离线计算的场景下，数据分析、离线报表等。</p>
<p>4、运行方式不同，流式计算的任务持续进行的，批量计算的任务则一次性完成。</p>
<h3 data-id="heading-4">流式计算框架、平台与相关产品</h3>
<p>第一类，商业级流式计算平台（IBM InfoSphere Streams、IBM StreamBase等）；</p>
<p>第二类，开源流式计算框架（Twitter Storm、S4等）；</p>
<p>第三类，公司为支持自身业务开发的流式计算框架。</p>
<p>Strom：Twitter 开发的第一代流处理系统。1</p>
<p>Heron：Twitter 开发的第二代流处理系统。</p>
<p>Spark streaming：是Spark核心API的一个扩展，可以实现高吞吐量的、具备容错机制的实时流数据的处理。</p>
<p>Flink：是一个针对流数据和批数据的分布式处理引擎。</p>
<p>Apache Kafka：Linkedin开发的大数据消息队列，由Scala写成。该项目的目标是为处理实时数据提供一个统一、高通量、低等待的平台。</p>
<p>Apache Samza, Linkedin开发的大数据流式处理系统， 可以实现流批一体的分布式处理引擎。</p>
<h2 data-id="heading-5">流式计算术语简介</h2>
<p>水位：</p>
<p>连接：</p>
<p>状态：</p>
<p>exactly-once: 在消息队列中，生产者重试发送消息，也只会让消息被发送给消费者一次。[2]</p>
<h2 data-id="heading-6">Lamda计算框架架构</h2>
<p>如何实时地在任意大数据集上进行查询？大数据再加上实时计算，问题的难度比较大。Lambda架构通过分解的三层架构来解决该问题：Batch Layer，Speed Layer和Serving Layer。</p>
<h3 data-id="heading-7">Batch Layer</h3>
<p>理想状态下，任何数据访问都可以从表达式Query= function(all data)开始，但是，若数据达到相当大的一个级别（例如PB），且还需要支持实时查询时，就需要耗费非常庞大的资源。一个解决方式是预运算查询函数（precomputed query function）。书中将这种预运算查询函数称之为Batch View（A），这样当需要执行查询时，可以从Batch View中读取结果。这样一个预先运算好的View是可以建立索引的，因而可以支持随机读取（B）。于是系统就变成：</p>
<p>（A）batch view = function(all data)</p>
<p>（B）query = function(batch view)</p>
<p>在Lambda架构中，实现（A）batch view =function(all data)的部分称之为Batch Layer。Batch Layer的功能主要有两点：</p>
<ul>
<li>存储master dataset, 这是一个不变的持续增长的数据集</li>
<li>在master dataset上预先计算查询函数，构建查询所对应的View</li>
</ul>
<p>View是一个和业务关联性比较大的概念，View的创建需要从业务自身的需求出发。一个通用的数据库查询系统，查询对应的函数千变万化，不可能穷举。但是如果从业务自身的需求出发，可以发现业务所需要的查询常常是有限的。Batch Layer需要做的一件重要的工作就是根据业务的需求，考察可能需要的各种查询，根据查询定义其在数据集上对应的Views。</p>
<p><strong>view可以理解为是等同于关系型数据库中的物化视图的概念。</strong></p>
<h3 data-id="heading-8">Speed Layer</h3>
<p>Batch Layer可以很好的处理离线数据，但有很多场景数据不断实时生成，并且需要实时查询处理。Speed Layer正是用来处理增量的实时数据。</p>
<p>Speed Layer和Batch Layer比较类似，对数据进行计算并生成Realtime View，其主要区别在于：</p>
<ul>
<li>Speed Layer处理的数据是最近的增量数据流，Batch Layer处理的全体数据集</li>
<li>Speed Layer为了效率，接收到新数据时不断更新Realtime View，而Batch Layer根据全体离线数据集直接得到Batch View。Speed Layer是一种增量计算，而非重新计算（recomputation）</li>
<li>Speed Layer因为采用增量计算，所以延迟小，而Batch Layer是全数据集的计算，耗时比较长</li>
</ul>
<p>综上所诉，Speed Layer是Batch Layer在实时性上的一个补充。Speed Layer可总结为：</p>
<p>（C）realtime view＝function(realtime view，new data)</p>
<p>注意，realtime view是基于新数据和已有的realtime view。</p>
<p>Lambda架构将数据处理分解为Batch Layer和Speed Layer有如下优点：</p>
<ul>
<li>容错性。Speed Layer中处理的数据也不断写入Batch Layer，当Batch Layer中重新计算的数据集包含Speed Layer处理的数据集后，当前的Realtime View就可以丢弃，这也就意味着Speed Layer处理中引入的错误，在Batch Layer重新计算时都可以得到修正。这点也可以看成是CAP理论中的最终一致性（Eventual Consistency）的体现。</li>
<li>复杂性隔离。Batch Layer处理的是离线数据，可以很好的掌控。Speed Layer采用增量算法处理实时数据，复杂性比Batch Layer要高很多。通过分开Batch Layer和Speed Layer，把复杂性隔离到Speed Layer，可以很好的提高整个系统的鲁棒性和可靠性。</li>
</ul>
<h3 data-id="heading-9">Serving Layer</h3>
<p>有一类称为Monoid特性的函数应用非常广泛。Monoid的概念来源于范畴学（Category Theory），其一个重要特性是满足结合律。如整数的加法就满足Monoid（结合律）特性：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">(a+b)+c=a+(b+c)
</code></pre>
<p>不满足Monoid特性的函数很多时候可以转化成多个满足Monoid特性的函数的运算。如多个数的平均值Avg函数，多个平均值没法直接通过结合来得到最终的平均值，但是可以拆成分母除以分子，分母和分子都是整数的加法，从而满足Monoid特性。</p>
<p>Monoid的结合律特性在分布式计算中极其重要，满足Monoid特性意味着我们可以将计算分解到多台机器并行运算，然后再结合各自的部分运算结果得到最终结果。同时也意味着部分运算结果可以储存下来被别的运算共享利用（如果该运算也包含相同的部分子运算），从而减少重复运算的工作量。</p>
<p>Lambda架构的Serving Layer用于响应用户的查询请求，合并Batch View和Realtime View中的结果数据集到最终的数据集。</p>
<p>这儿涉及到数据如何合并的问题。前面我们讨论了查询函数的Monoid性质，如果查询函数满足Monoid性质，即满足结合律，只需要简单的合并Batch View和Realtime View中的结果数据集即可。否则的话，可以把查询函数转换成多个满足Monoid性质的查询函数的运算，单独对每个满足Monoid性质的查询函数进行Batch View和Realtime View中的结果数据集合并，然后再计算得到最终的结果数据集。另外也可以根据业务自身的特性，运用业务自身的规则来对Batch View和Realtime View中的结果数据集合并。</p>
<p>综上所诉，Serving Layer采用如下等式表示：</p>
<p>（D）query<strong>＝</strong>function(batch view, realtime view)</p>
<h3 data-id="heading-10">Lambda架构组件选型</h3>
<p>上面分别讨论了Lambda架构的三层：Batch Layer，Speed Layer和Serving Layer。总结下来，Lambda架构就是如下的三个等式：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">batch view = function(all data)
realtime view = function(realtime view, new data)
query = function(batch view, realtime view)
</code></pre>
<p>数据流进入系统后，同时发往Batch Layer和Speed Layer处理。Batch Layer以不可变模型离线存储所有数据集，通过在全体数据集上不断重新计算构建查询所对应的Batch Views。Speed Layer处理增量的实时数据流，不断更新查询所对应的Realtime Views。Serving Layer响应用户的查询请求，合并Batch View和Realtime View中的结果数据集到最终的数据集。</p>
<p>下图给出了Lambda架构中各组件在大数据生态系统中和阿里集团的常用组件。数据流存储选用不可变日志的分布式系统Kafka、TT、Metaq；BatchLayer数据集的存储选用Hadoop的HDFS或者阿里云的ODPS；BatchView的加工采用MapReduce；BatchView数据的存储采用Mysql（查询少量的最近结果数据）、Hbase（查询大量的历史结果数据）。SpeedLayer采用增量数据处理Storm、Flink；RealtimeView增量结果数据集采用内存数据库Redis。</p>
<h4 data-id="heading-11">Lambda架构总结</h4>
<p>数据从底层的数据源开始，经过各种各样的格式进入大数据平台，在大数据平台中经过Kafka、Flume等数据组件进行收集，然后分成两条线进行计算。一条线是进入流式计算平台（例如 Storm、Flink或者Spark Streaming），去计算实时的一些指标；另一条线进入批量数据处理离线计算平台（例如Mapreduce、Hive，Spark SQL），去计算T+1的相关业务指标，这些指标需要隔日才能看见。</p>
<p>Lambda架构经历多年的发展，其优点是稳定，对于实时计算部分的计算成本可控，批量处理可以用晚上的时间来整体批量计算，这样把实时计算和离线计算高峰分开，这种架构支撑了数据行业的早期发展，但是它也有一些致命缺点，并在大数据3.0时代越来越不适应数据分析业务的需求。缺点如下：</p>
<ul>
<li><strong>实时与批量计算结果不一致引起的数据口径问题</strong>：因为批量和实时计算走的是两个计算框架和计算程序，算出的结果往往不同，经常看到一个数字当天看是一个数据，第二天看昨天的数据反而发生了变化。</li>
<li><strong>批量计算在计算窗口内无法完成</strong>：在IOT时代，数据量级越来越大，经常发现夜间只有4、5个小时的时间窗口，已经无法完成白天20多个小时累计的数据，保证早上上班前准时出数据已成为每个大数据团队头疼的问题。</li>
<li><strong>开发和维护的复杂性问题</strong>：Lambda 架构需要在两个不同的 API（application programming interface，应用程序编程接口）中对同样的业务逻辑进行两次编程：一次为批量计算的ETL系统，一次为流式计算的Streaming系统。针对同一个业务问题产生了两个代码库，各有不同的漏洞。这种系统实际上非常难维护</li>
<li><strong>服务器存储大</strong>：数据仓库的典型设计，会产生大量的中间结果表，造成数据急速膨胀，加大服务器存储压力。</li>
</ul>
<p>因此上有了Kappa架构。</p>
<h3 data-id="heading-12">Kappa架构</h3>
<p>Kafka的创始人Jay Kreps认为在很多场景下，维护一套Lambda架构的大数据处理平台耗时耗力，于是提出在某些场景下，没有必要维护一个批处理层，直接使用一个流处理层即可满足需求，Kappa架构。</p>
<p>Kappa架构的兴起主要原因：</p>
<ul>
<li>
<p>批处理被被认为是流式处理的一个子集，所以可以省略掉。</p>
</li>
<li>
<p>Kappa架构相对更简单，实时性更好，所需的计算资源远小于Lambda架构，随着实时处理的需求在不断增长，更多的企业开始使用Kappa架构。</p>
</li>
</ul>
<p>Kappa架构的流行并不意味着不再需要批处理，批处理在一些特定场景上仍然有自己的优势。比如进行一些数据探索、机器学习实验，需要使用批处理来反复验证不同的算法。Kappa架构适用于一些逻辑固定的数据预处理流程，如统计一个时间段内商品的曝光和购买次数、某些关键词的搜索次数等。</p>
<h2 data-id="heading-13">相关工作</h2>
<p>mob604756ebed9f在他的博客[1]里通过问答的形式，讲解了具体的Flink的使用方式和面试常见问题。</p>
<p>阿凡卢在他的博客[2]里详细解释了如何实现exactly-once, at-least once, atmost once等语义和实现原理。</p>
<p>大数据流动在他的博客[3]里详细介绍了Flink的简单历史、环境搭建、测试、编程模型和Flink DataStreaming API的使用。</p>
<p>独孤风在他的公众号文章[4]里介绍了Flink流批一体的实现原理。</p>
<p>kk大数据在腾讯云+社区里发表了文章[5]介绍了Flink水位和窗口的关系，介绍了几种窗口以及水位的概念。</p>
<p>先荐在他的博客[6]里介绍了流式计算的背景.</p>
<p>Heriam在他的博文[7]里详细并且通俗易懂介绍了Lamda架构出现的历史原因，Lambda三层架构的理解。介绍Lambda架构的文章很多，但是通俗易懂的介绍Lambda架构的博客不多，能深入浅出讲明白的更是珍贵。</p>
<p>废物大师兄在他的文章《Flink入门》[9]里，介绍了Flink适配的计算集群资源、介绍了Flink的基本概念，比如状态、时间相关的特性等。</p>
<h2 data-id="heading-14">参考</h2>
<p>[1]mob604756ebed9f, 一网打尽Flink高频面试题,<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.51cto.com%2Fu_15127538%2F2659011" target="_blank" title="https://blog.51cto.com/u_15127538/2659011" ref="nofollow noopener noreferrer">blog.51cto.com/u_15127538/…</a></p>
<p>[2]阿凡卢,Kafka中的exactly-once,<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluxiaoxun%2Fp%2F13048474.html" target="_blank" title="https://www.cnblogs.com/luxiaoxun/p/13048474.html" ref="nofollow noopener noreferrer">www.cnblogs.com/luxiaoxun/p…</a></p>
<p>[3]大数据流动,Flink入门宝典（详细截图版）,<a href="https://juejin.cn/post/684490394427195392" target="_blank" title="https://juejin.cn/post/684490394427195392">juejin.cn/post/684490…</a></p>
<p>[4]独孤风/大数据流动，Flink流批一体实现原理，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fo8ZIinTSeGZvfT19gyU2Eg" target="_blank" title="https://mp.weixin.qq.com/s/o8ZIinTSeGZvfT19gyU2Eg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/o8ZIinTSe…</a></p>
<p>[5]kk大数据，水位和窗口，<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1539213" target="_blank" title="https://cloud.tencent.com/developer/article/1539213" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p>[6]先荐，流式计算简介，<a href="https://link.juejin.cn?target=https%3A%2F%2Faijishu.com%2Fa%2F1060000000009451" target="_blank" title="https://aijishu.com/a/1060000000009451" ref="nofollow noopener noreferrer">aijishu.com/a/106000000…</a></p>
<p>[7]Heriam，深入理解Lamda架构，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fcciejh%2Fp%2Flambda-architecture.html" target="_blank" title="https://www.cnblogs.com/cciejh/p/lambda-architecture.html" ref="nofollow noopener noreferrer">www.cnblogs.com/cciejh/p/la…</a></p>
<p>[8]皮皮鲁的科技星球,大数据处理平台从Lambda到Kappa的演进,<a href="https://juejin.cn/post/6844904013217923086" target="_blank" title="https://juejin.cn/post/6844904013217923086">juejin.cn/post/684490…</a></p>
<p>[9]废物大师兄, Flink 入门, <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fcjsblog%2Fp%2F12905871.html" target="_blank" title="https://www.cnblogs.com/cjsblog/p/12905871.html" ref="nofollow noopener noreferrer">www.cnblogs.com/cjsblog/p/1…</a></p>
<p>[10]zhisheng, Flink从0到1学习—— 分享四本 Flink 国外的书和二十多篇 Paper 论文,<a href="https://link.juejin.cn?target=https%3A%2F%2Faijishu.com%2Fa%2F1060000000002768" target="_blank" title="https://aijishu.com/a/1060000000002768" ref="nofollow noopener noreferrer">aijishu.com/a/106000000…</a></p>
<p>[11]Flink官方，Flink的容错机制，<a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-docs-master%2Fzh%2Fdocs%2Flearn-flink%2Ffault_tolerance%2F" target="_blank" title="https://nightlies.apache.org/flink/flink-docs-master/zh/docs/learn-flink/fault_tolerance/" ref="nofollow noopener noreferrer">nightlies.apache.org/flink/flink…</a></p>
<p>[12]林小铂，Flink容错，<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.whitewood.me%2F2019%2F07%2F28%2F%25E6%25B7%25B1%25E5%2585%25A5%25E7%2590%2586%25E8%25A7%25A3-Flink-%25E5%25AE%25B9%25E9%2594%2599%25E6%259C%25BA%25E5%2588%25B6%2F" target="_blank" title="http://www.whitewood.me/2019/07/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Flink-%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6/" ref="nofollow noopener noreferrer">www.whitewood.me/2019/07/28/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web 抓包在浏览器、代理、设备侧等不同层面的作用]]></title>    <link>https://juejin.cn/post/7585825055437963270</link>    <guid>https://juejin.cn/post/7585825055437963270</guid>    <pubDate>2025-12-22T03:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585825055437963270" data-draft-id="7585789195870224420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web 抓包在浏览器、代理、设备侧等不同层面的作用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T03:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web 抓包在浏览器、代理、设备侧等不同层面的作用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:42:56.000Z" title="Mon Dec 22 2025 03:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 项目里，抓包常常被当作一件理所当然的事情。
打开浏览器开发者工具，看 Network 面板，请求、响应、状态码都在那里，似乎已经足够。</p>
<p>但真正经常会发生前端说请求已经发出，后端说日志里没看到；后端确认已经返回，前端却始终拿不到数据。</p>
<p>这种时候，Web 抓包才真正进入视野。</p>
<hr/>
<h2 data-id="heading-0"><strong>浏览器 Network 面板：最熟悉，也最容易被高估</strong></h2>
<p>对 Web 开发来说，浏览器自带的 Network 面板几乎是默认工具。
它非常适合做一件事：<strong>验证浏览器内部发生了什么</strong>。</p>
<p>你可以清楚看到：</p>
<ul>
<li>请求的发起时机</li>
<li>Header 是否符合预期</li>
<li>返回内容是否被浏览器正确解析</li>
<li>请求是否被缓存或重定向</li>
</ul>
<p>在调试前端逻辑时，这已经解决了大部分问题。</p>
<p>但 Network 面板有一个天然限制：它只能反映<strong>浏览器视角</strong>下的网络行为。</p>
<hr/>
<h2 data-id="heading-1"><strong>当问题不再只发生在浏览器里</strong></h2>
<p>Web 抓包开始变复杂，通常是因为系统结构变复杂了。</p>
<p>比如：</p>
<ul>
<li>Web 页面请求的是中间层接口</li>
<li>同一个接口被多个客户端调用</li>
<li>请求经过了 CDN、网关或安全设备</li>
<li>页面依赖第三方脚本或 SDK</li>
</ul>
<p>这时，仅看浏览器 Network，很难回答一个关键问题：</p>
<blockquote>
<p>请求在离开浏览器之后，究竟发生了什么？</p>
</blockquote>
<hr/>
<h2 data-id="heading-2"><strong>代理抓包：把 Web 请求放到“网络路径”中看</strong></h2>
<p>在这种情况下，我通常会引入代理抓包工具，比如Charles，Fiddler。</p>
<p>代理抓包的意义，不是替代浏览器工具，而是换一个观察位置。
它能看到请求在浏览器之外的表现，比如：</p>
<ul>
<li>实际访问的域名和 IP</li>
<li>Header 是否被中间层修改</li>
<li>请求是否被重试或重定向</li>
<li>HTTPS 解密后的完整内容</li>
</ul>
<p>在 Web 抓包中，代理工具非常适合用来确认：<strong>是不是浏览器之外的某个环节改变了请求。</strong></p>
<hr/>
<h2 data-id="heading-3"><strong>HTTPS 之后，Web 抓包也会遇到“看不清”的问题</strong></h2>
<p>当 Web 项目全面切换到 HTTPS 之后，抓包并不总是那么顺利。</p>
<p>如果页面请求来自 WebView、Hybrid 应用，或者某些请求并不走系统代理路径，代理抓包工具看到的内容就会变得不完整。</p>
<p>这时继续纠结“为什么抓不到”，不如先确认一个事实：请求是否真的按你认为的方式发送了。</p>
<hr/>
<h2 data-id="heading-4"><strong>设备侧抓包，在 Web 场景下也有价值</strong></h2>
<p>在分析 WebView、Hybrid 页面或嵌入式 Web 请求时，我会用 <strong>抓包大师（Sniff Master）</strong> 从设备侧抓取通信数据。</p>
<p>它在 Web 抓包中的作用，并不是替代浏览器或代理工具，而是解决一个特定问题：</p>
<blockquote>
<p>当 Web 请求运行在 App 或设备环境中时，我能否看到它真实发出的网络行为？</p>
</blockquote>
<p>由于不依赖系统代理，也不需要越狱或 root，它更接近真实运行环境。
这在排查“Web 页面在 App 内行为异常”时尤其有用。</p>
<hr/>
<h2 data-id="heading-5"><strong>只抓目标流量，Web 抓包才能继续推进</strong></h2>
<p>在真实环境下抓 Web 流量，很容易被噪音干扰。
后台同步、系统服务、其他页面请求，很快就会让分析变得混乱。</p>
<p>支持只抓取指定 App 或指定流量的工具，在这种情况下价值会非常明显。
当你能把注意力限制在一个 Web 页面或一个接口上，很多模糊的问题反而会变得具体。</p>
<hr/>
<h2 data-id="heading-6"><strong>Web 抓包并不总是 HTTP 层的问题</strong></h2>
<p>在一些复杂场景中，Web 请求只是整个通信过程的一部分。</p>
<p>例如：</p>
<ul>
<li>Web 页面触发接口，接口再建立长连接</li>
<li>Web 配置请求成功，但数据推送失败</li>
<li>Web 行为依赖 TCP 或 WebSocket 通信</li>
</ul>
<p>如果只停留在 HTTP 抓包层面，很容易误判“请求已经完成”。</p>
<p>这时，就需要结合数据流抓包，去确认连接是否建立、是否保持。
抓包大师支持 TCP / UDP 数据流抓取，在分析这类混合通信模型时，能补齐 HTTP 看不到的部分。</p>
<hr/>
<h2 data-id="heading-7"><strong>Wireshark 可以用来解析更细节的请求</strong></h2>
<p>在 Web 抓包分析中，我并不会频繁使用 Wireshark。
它更像是一个在关键节点出现的工具，用来确认一些底层事实，比如：</p>
<ul>
<li>TCP 连接是否被重置</li>
<li>数据是否发生重传</li>
<li>网络层是否存在异常</li>
</ul>
<p>在没有明确方向之前，过早使用 Wireshark，反而容易让人迷失在细节里。</p>
<hr/>
<h2 data-id="heading-8"><strong>拦截和修改，用来验证理解是否正确</strong></h2>
<p>理解 Web 抓包的另一种方式，是主动改变请求。</p>
<p>在排查过程中，我经常会修改 Header、返回状态码或响应内容，观察前端行为变化。
这种做法，比单纯“看数据”更容易验证对系统的理解是否正确。</p>
<p>抓包大师支持通过脚本拦截和修改请求、响应，在这一步更像是一个实验工具，而不是分析工具。</p>
<hr/>
<h2 data-id="heading-9"><strong>对 Web 抓包的一点实际体会</strong></h2>
<p>做过几次复杂排查之后，我对 Web 抓包的看法变得更加谨慎：</p>
<ul>
<li>浏览器工具解决的是“页面内部”的问题</li>
<li>代理抓包解决的是“网络路径”的问题</li>
<li>设备侧抓包解决的是“真实运行环境”的问题</li>
<li>数据流抓包解决的是“连接是否成立”的问题</li>
</ul>
<p>多工具组合，并不是为了显得复杂，而是为了避免在错误层面反复纠结。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力]]></title>    <link>https://juejin.cn/post/7585897699603562522</link>    <guid>https://juejin.cn/post/7585897699603562522</guid>    <pubDate>2025-12-22T03:49:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603562522" data-draft-id="7586167377381818394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力"/> <meta itemprop="keywords" content="Go,JavaScript,Lua"/> <meta itemprop="datePublished" content="2025-12-22T03:49:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:49:37.000Z" title="Mon Dec 22 2025 03:49:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力</h2>
<p>在企业级中后台系统开发领域，「业务规则频繁迭代」与「个性化需求快速响应」始终是困扰开发团队的核心痛点。试想这样的场景：电商平台的促销规则需随节日实时调整， SaaS 系统需为不同行业客户定制专属审批流程，风控系统需根据最新风险模型动态更新校验逻辑…… 传统「代码开发 - 编译打包 - 部署上线」的全流程，往往需要数小时甚至数天才能完成迭代，严重滞后于业务节奏。</p>
<p>脚本引擎的嵌入式集成，为这一困境提供了优雅的破局思路——通过动态执行脚本代码，实现业务逻辑的「热更新、热部署」，无需重启服务即可完成规则迭代与需求适配。GoWind Admin（风行）作为一款主打「开箱即用」的企业级前后端一体中后台框架，精准洞察这一需求，深度整合 <code>kratos-bootstrap</code> 生态中的 <code>script_engine</code> 组件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-bootstrap%2Ftree%2Fmain%2Fscript_engine" target="_blank" title="https://github.com/tx7do/kratos-bootstrap/tree/main/script_engine" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a>），实现了对 JavaScript、Lua 两种主流脚本语言的无缝支持，让开发者能够以极低成本嵌入动态逻辑，为中后台系统注入「随需而变」的灵活基因。</p>
<h3 data-id="heading-1">为什么选择 script_engine？Go 生态下的嵌入式脚本引擎优选</h3>
<p>在 Go 应用中实现动态脚本能力，并非只有<code>script_engine</code> 一种选择，但结合企业级中后台系统「高性能、高可靠、易集成」的核心诉求，它成为了 GoWind Admin 的最优解。这款专为 Go 应用设计的嵌入式脚本引擎组件，核心优势体现在四个维度：</p>
<h4 data-id="heading-2">1. 多语言覆盖，适配全场景动态需求</h4>
<p>原生支持 Lua 与 JavaScript 两种主流脚本语言，精准匹配不同业务场景与开发团队的技术栈：</p>
<ul>
<li><strong>Lua</strong>：以轻量、高效、低资源占用著称，字节码执行速度快，内存开销小，特别适合高频执行的轻量级业务逻辑（如订单金额计算、风控规则校验、数据格式转换等）；</li>
<li><strong>JavaScript</strong>：前端开发者的「母语」，无需额外学习成本即可参与后端动态逻辑开发，完美适配前后端协同场景（如表单校验规则同步、页面交互逻辑复用等）。</li>
</ul>
<p>两种语言的无缝切换，让开发团队可根据业务特性灵活选型，避免「为适配脚本语言而调整技术栈」的尴尬。</p>
<h4 data-id="heading-3">2. 智能池化管理，平衡性能与资源开销</h4>
<p>脚本引擎的创建与销毁是典型的「重操作」，若每次脚本执行都重新初始化引擎，会产生大量性能损耗，尤其在中后台系统高并发场景下，可能成为性能瓶颈。<code>script_engine</code> 提供两种成熟的引擎池实现，通过实例复用彻底解决这一问题：</p>
<ul>
<li><strong>EnginePool（固定大小池）</strong>：初始化时创建固定数量的引擎实例，适用于并发量稳定的场景，资源占用可预测，避免不必要的扩容开销；</li>
<li><strong>AutoGrowEnginePool（自动扩容池）</strong>：支持根据请求量动态扩容，初始创建少量实例节省资源，当并发请求激增时自动新增实例（不超过上限），流量回落时释放空闲实例，完美适配中后台系统「潮汐式流量」特征（如财务结算高峰期、报表导出峰值等）。</li>
</ul>
<p>池化机制的引入，让动态脚本执行的性能损耗降低 80% 以上，同时通过实例上限控制，避免资源耗尽风险，兼顾灵活性与稳定性。</p>
<h4 data-id="heading-4">3. 双向深度交互，打通 Go 与脚本的能力边界</h4>
<p>优秀的嵌入式脚本引擎，核心在于「不孤立」——能够与宿主应用（Go 程序）实现深度协同。<code>script_engine</code> 支持 Go 与脚本语言的双向通信，实现业务逻辑的灵活拆分与组合：</p>
<ul>
<li><strong>Go 向脚本注入能力</strong>：可将 Go 中的全局变量、业务函数、结构体实例注册到脚本环境，让脚本直接调用框架核心能力（如用户认证、数据查询、消息推送等），无需重复开发；</li>
<li><strong>脚本向 Go 反馈结果</strong>：Go 可直接调用脚本中定义的函数，获取返回结果并集成到核心流程中，实现「固定框架 + 动态逻辑」的架构模式。</li>
</ul>
<h4 data-id="heading-5">4. 标准化集成，开箱即用零门槛</h4>
<p>作为 <code>kratos-bootstrap</code> 生态的核心组件，`script_engine遵循标准化的接口设计，与 GoWind Admin 的架构体系无缝融合。开发者无需关注底层引擎实现、内存管理、并发控制等细节，只需通过简单的 API 调用，即可完成脚本引擎的初始化、资源注册、脚本执行等操作，真正实现「开箱即用」。</p>
<h3 data-id="heading-6">核心实践：GoWind Admin 中动态脚本能力的落地步骤</h3>
<p>GoWind Admin 基于 <code>script_engine</code> 实现动态业务扩展的核心流程，可概括为「初始化引擎池 - 注册交互资源 - 执行动态脚本 - 跨语言函数调用」四步闭环。以下结合企业级真实场景，拆解每一步的实现细节与最佳实践：</p>
<h4 data-id="heading-7">1. 引擎池初始化：按需选型，适配并发场景</h4>
<p>中后台系统的并发特征差异较大（如后台管理系统并发低但场景复杂，交易系统并发高且实时性要求高），GoWind Admin 支持根据业务场景选择合适的引擎池类型。以下以最常用的「自动扩容引擎池」为例，展示 JavaScript 引擎的初始化过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>

	conf <span class="hljs-string">"github.com/tx7do/kratos-bootstrap/api/gen/go/conf/v1"</span>
	<span class="hljs-string">"github.com/tx7do/kratos-bootstrap/script_engine"</span>
	_ <span class="hljs-string">"github.com/tx7do/go-scripts/javascript"</span> <span class="hljs-comment">// 注册JavaScript引擎驱动</span>

	<span class="hljs-string">"google.golang.org/protobuf/types/known/wrapperspb"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initScriptEngine</span><span class="hljs-params">()</span></span> (script_engine.ScriptEngine, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 1. 配置引擎参数：指定脚本语言、池化策略</span>
	cfg := &amp;conf.Script{
		Engine: conf.Script_JAVASCRIPT, <span class="hljs-comment">// 选择JavaScript引擎</span>
		Pool: &amp;conf.Script_Pool{
			Initial: &amp;wrapperspb.Int32Value{Value: <span class="hljs-number">2</span>}, <span class="hljs-comment">// 初始实例数：2个</span>
			Max:     &amp;wrapperspb.Int32Value{Value: <span class="hljs-number">10</span>}, <span class="hljs-comment">// 最大实例数：10个（避免资源耗尽）</span>
			IdleTimeout: &amp;wrapperspb.DurationValue{Value: <span class="hljs-number">300</span>}, <span class="hljs-comment">// 空闲实例超时销毁：300秒</span>
		},
	}

	<span class="hljs-comment">// 2. 初始化引擎池</span>
	enginePool, err := script_engine.NewAutoGrowScriptEnginePool(cfg)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Printf(<span class="hljs-string">"引擎池初始化失败：%v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-comment">// 3. 延迟关闭引擎池（程序退出时释放资源）</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">if</span> err := enginePool.Close(); err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"引擎池关闭失败：%v"</span>, err)
		}
	}()

	<span class="hljs-keyword">return</span> enginePool, <span class="hljs-literal">nil</span>
}
</code></pre>
<blockquote>
<p>最佳实践：初始化时建议根据业务峰值预估最大实例数，避免设置过高导致内存溢出；同时配置空闲超时时间，释放长期闲置的引擎实例，节省资源。</p>
</blockquote>
<h4 data-id="heading-8">2. 注册交互资源：打通 Go 与脚本的能力通道</h4>
<p>为让脚本能够复用 GoWind Admin 的核心业务能力，需将框架中的函数、数据结构注册到脚本环境。以下以「用户状态管理」场景为例，展示 Go 函数向 <code>JavaScript</code> 脚本的注册过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义Go中的核心业务函数：更新用户状态（真实场景中会对接数据库、缓存等）</span>
<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> UpdateUserStatus(userId <span class="hljs-type">int64</span>, status <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 模拟业务逻辑：校验用户存在性、更新状态</span>
	<span class="hljs-keyword">if</span> userId &lt;= <span class="hljs-number">0</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"无效用户ID"</span>)
	}
	<span class="hljs-comment">// 实际场景：调用ORM框架更新数据库</span>
	log.Printf(<span class="hljs-string">"用户[%d]状态更新为：%s"</span>, userId, status)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">registerResources</span><span class="hljs-params">(eng script_engine.Engine)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 1. 初始化业务服务实例</span>
	userService := &amp;UserService{}

	<span class="hljs-comment">// 2. 注册业务函数到脚本环境，脚本中可通过"updateUserStatus"直接调用</span>
	err := eng.RegisterFunction(<span class="hljs-string">"updateUserStatus"</span>, userService.UpdateUserStatus)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"注册UpdateUserStatus失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 3. 注册全局变量到脚本环境（如系统配置、常量等）</span>
	err = eng.RegisterVariable(<span class="hljs-string">"SYSTEM_ENV"</span>, <span class="hljs-string">"production"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"注册全局变量失败：%v"</span>, err)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>注册完成后，JavaScript 脚本即可直接调用这些资源，实现与框架核心逻辑的协同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript脚本中调用Go注册的函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUserStatus</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> userId = <span class="hljs-number">10086</span>;
    <span class="hljs-keyword">const</span> targetStatus = <span class="hljs-string">"active"</span>;
    
    <span class="hljs-comment">// 调用Go注册的updateUserStatus函数</span>
    <span class="hljs-keyword">const</span> [success, err] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateUserStatus</span>(userId, targetStatus);
    
    <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户<span class="hljs-subst">${userId}</span>状态更新成功，当前环境：<span class="hljs-subst">${SYSTEM_ENV}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`更新失败：<span class="hljs-subst">${err.message}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h4 data-id="heading-9">3. 执行动态脚本：加载并运行自定义业务逻辑</h4>
<p>GoWind Admin 支持通过「字符串、本地文件、远程流」三种方式加载脚本，适配不同场景的动态逻辑部署需求（如本地调试用字符串、生产环境用远程配置中心加载脚本）。以下以「订单金额计算」场景为例，展示 <code>Lua</code> 脚本的文件加载与执行过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">executeScript</span><span class="hljs-params">(eng script_engine.Engine)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 场景：电商促销活动，订单金额计算规则频繁变更，用Lua脚本动态实现</span>
	<span class="hljs-comment">// 从本地文件加载Lua脚本（生产环境可改为从配置中心、对象存储加载）</span>
	result, err := eng.ExecuteFile(context.Background(), <span class="hljs-string">"./scripts/calculate_order.lua"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"脚本执行失败：%v"</span>, err)
	}
	<span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>Lua 脚本（<code>calculate_order.lua</code>）：实现含阶梯折扣的订单金额计算逻辑（可动态更新）</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 阶梯折扣规则：满3件9折，满5件8折，满10件7折</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateOrderAmount</span><span class="hljs-params">(price, quantity, baseDiscount)</span></span>
    <span class="hljs-keyword">local</span> discount = baseDiscount
    <span class="hljs-comment">-- 动态调整折扣</span>
    <span class="hljs-keyword">if</span> quantity &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.7</span>
    <span class="hljs-keyword">elseif</span> quantity &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.8</span>
    <span class="hljs-keyword">elseif</span> quantity &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.9</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-comment">-- 计算最终金额（保留2位小数）</span>
    <span class="hljs-keyword">local</span> finalAmount = price * quantity * discount
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(finalAmount * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 业务参数：单价99.9元，数量5件，基础折扣0.95</span>
<span class="hljs-keyword">return</span> calculateOrderAmount(<span class="hljs-number">99.9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0.95</span>)
</code></pre>
<p>当促销规则变更时（如新增「会员额外9.5折」），只需修改 Lua 脚本并重新加载，无需重启 GoWind Admin 服务，实现「秒级迭代」。</p>
<h4 data-id="heading-10">4. 函数调用：精细化跨语言逻辑交互</h4>
<p>除了执行完整脚本，<code>script_engine</code> 还支持在 Go 中直接调用脚本中定义的特定函数，实现更精细化的逻辑交互。以下以「权限校验」场景为例，展示 Go 调用 JavaScript 函数的过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callScriptFunction</span><span class="hljs-params">(eng script_engine.Engine)</span></span> (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 场景：用户操作前的权限校验，校验规则动态配置</span>
	userId := <span class="hljs-type">int64</span>(<span class="hljs-number">10086</span>)
	requiredPermission := <span class="hljs-string">"order:edit"</span> <span class="hljs-comment">// 所需权限：编辑订单</span>

	<span class="hljs-comment">// 调用JavaScript脚本中定义的checkPermission函数</span>
	result, err := eng.CallFunction(
		context.Background(),
		<span class="hljs-string">"checkPermission"</span>, <span class="hljs-comment">// 脚本中函数名</span>
		userId,            <span class="hljs-comment">// 参数1：用户ID</span>
		requiredPermission,<span class="hljs-comment">// 参数2：所需权限</span>
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"调用权限校验函数失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 解析返回结果（脚本返回bool类型）</span>
	hasPermission, ok := result.(<span class="hljs-type">bool</span>)
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"权限校验结果格式错误"</span>)
	}

	<span class="hljs-keyword">return</span> hasPermission, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>JavaScript 脚本中定义的权限校验函数（支持动态更新校验规则）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 权限校验函数：支持角色继承、临时权限叠加逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params">userId, requiredPermission</span>) {
    <span class="hljs-comment">// 模拟从缓存获取用户权限（真实场景可调用Go注册的缓存查询函数）</span>
    <span class="hljs-keyword">const</span> userRoles = <span class="hljs-title function_">getUserRoles</span>(userId); <span class="hljs-comment">// 脚本内部函数</span>
    <span class="hljs-keyword">const</span> userPermissions = <span class="hljs-title function_">getPermissionsByRoles</span>(userRoles); <span class="hljs-comment">// 脚本内部函数</span>
    
    <span class="hljs-comment">// 临时权限：为测试账号开放所有权限（动态配置）</span>
    <span class="hljs-keyword">if</span> (userId === <span class="hljs-number">10000</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 校验核心权限</span>
    <span class="hljs-keyword">return</span> userPermissions.<span class="hljs-title function_">includes</span>(requiredPermission);
}

<span class="hljs-comment">// 辅助函数：根据用户ID获取角色</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserRoles</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-comment">// 模拟数据：实际可调用Go注册的用户角色查询函数</span>
    <span class="hljs-keyword">const</span> roleMap = {
        <span class="hljs-number">10086</span>: [<span class="hljs-string">"order_manager"</span>, <span class="hljs-string">"user_manager"</span>],
        <span class="hljs-number">10087</span>: [<span class="hljs-string">"order_viewer"</span>]
    };
    <span class="hljs-keyword">return</span> roleMap[userId] || [];
}

<span class="hljs-comment">// 辅助函数：根据角色获取权限</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPermissionsByRoles</span>(<span class="hljs-params">roles</span>) {
    <span class="hljs-keyword">const</span> permissionMap = {
        <span class="hljs-attr">order_manager</span>: [<span class="hljs-string">"order:view"</span>, <span class="hljs-string">"order:edit"</span>, <span class="hljs-string">"order:delete"</span>],
        <span class="hljs-attr">user_manager</span>: [<span class="hljs-string">"user:view"</span>, <span class="hljs-string">"user:edit"</span>],
        <span class="hljs-attr">order_viewer</span>: [<span class="hljs-string">"order:view"</span>]
    };
    <span class="hljs-keyword">let</span> permissions = [];
    roles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> {
        permissions = [...permissions, ...(permissionMap[role] || [])];
    });
    <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(permissions)]; <span class="hljs-comment">// 去重</span>
}
</code></pre>
<h3 data-id="heading-11">企业级价值：动态扩展能力如何赋能业务增长？</h3>
<p>GoWind Admin 整合 script_engine 后，为企业级中后台系统带来多维度的能力跃升，直接赋能业务增长：</p>
<h4 data-id="heading-12">1. 缩短业务迭代周期，提升市场响应速度</h4>
<p>促销规则、定价策略、审批流程等高频变更的业务逻辑，无需经过「开发 - 测试 - 部署」全流程，只需修改脚本并加载即可生效。以电商平台为例，节日大促期间的规则调整可从「天级」缩短至「秒级」，精准抓住流量峰值的转化机会。</p>
<h4 data-id="heading-13">2. 降低定制化成本，支撑规模化 SaaS 运营</h4>
<p>对于 SaaS 型中后台系统，不同行业、不同规模的客户往往有个性化需求。通过脚本实现差异化逻辑，可避免核心代码分支爆炸（如为每个客户维护一个代码分支），降低开发与维护成本。例如，为金融客户定制「多维度风控校验」，为零售客户定制「进销存专属报表逻辑」，均无需修改框架核心代码。</p>
<h4 data-id="heading-14">3. 打破技术壁垒，提升团队协作效率</h4>
<p>前端开发者可直接使用 JavaScript 编写后端动态逻辑，无需学习 Go 语言；运维人员可通过脚本快速调整系统配置、修复小问题，无需依赖开发团队。技术壁垒的打破，让团队协作更高效，资源调度更灵活。</p>
<h4 data-id="heading-15">4. 保障系统稳定性，平衡灵活与可靠</h4>
<p>引擎池的资源限制与实例复用机制，让动态脚本执行的资源占用可预测、可控制，避免因脚本异常导致整个系统崩溃。同时，脚本执行失败不会影响 Go 核心流程的运行，实现「动态逻辑故障隔离」，平衡了业务灵活性与系统稳定性。</p>
<h3 data-id="heading-16">总结：以动态能力驱动中后台系统进化</h3>
<p>在数字化转型加速的今天，企业对中后台系统的「敏捷性」要求越来越高。GoWind Admin 借助 <code>go-scripts</code> 与 <code>kratos-bootstrap</code> 的 <code>script_engine</code> 组件，成功将「动态脚本扩展能力」融入企业级框架的核心架构，既保留了 Go 语言的高性能、高可靠优势，又弥补了传统编译型语言的灵活性不足。</p>
<p>从高频变更的业务规则，到个性化的客户需求，再到跨团队的协同效率提升，GoWind Admin 的动态扩展能力正在重新定义中后台系统的开发与运营模式。对于开发团队而言，无需再为「快速迭代」与「系统稳定」的矛盾纠结，只需聚焦业务本身，通过简单的脚本交互即可实现需求落地；对于企业而言，这意味着更低的研发成本、更快的市场响应速度，以及更强的业务创新能力。</p>
<p>如需快速上手实践，可直接参考以下资源：</p>
<ul>
<li><code>script_engine</code> 组件文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-bootstrap%2Ftree%2Fmain%2Fscript_engine" target="_blank" title="https://github.com/tx7do/kratos-bootstrap/tree/main/script_engine" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a></li>
<li><code>go-scripts</code> 引擎封装代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-scripts" target="_blank" title="https://github.com/tx7do/go-scripts" ref="nofollow noopener noreferrer">github.com/tx7do/go-sc…</a></li>
<li><code>GoWind Admin</code> 官方代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">github.com/tx7do/go-wi…</a></li>
</ul>
<p>解锁动态业务扩展能力，让你的中后台系统在快速迭代中始终保持「风行」之势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型学习教程：RAG技术全景解析]]></title>    <link>https://juejin.cn/post/7585920796100624411</link>    <guid>https://juejin.cn/post/7585920796100624411</guid>    <pubDate>2025-12-22T03:55:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100624411" data-draft-id="7586182451597918254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型学习教程：RAG技术全景解析"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-22T03:55:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型学习教程：RAG技术全景解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:55:35.000Z" title="Mon Dec 22 2025 03:55:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读52分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>在大语言模型基础知识一文中，检索增强生成（Retrieval-Augmented Generation，简称 RAG）技术作为构建大语言模型（Large Language Model，简称 LLM）应用的一种方式已被简要提及，本文将详细介绍RAG技术的实现流程及其演进趋势。</p>
<p>关于RAG技术更全面更系统的介绍，可以阅读以下论文：</p>
<ul>
<li>Retrieval-Augmented Generation for AI-Generated Content: A Survey[1]</li>
<li>Retrieval-Augmented Generation for Large Language Models: A Survey[2]</li>
</ul>
<h2 data-id="heading-0">1 RAG技术解析</h2>
<h3 data-id="heading-1">1.1 RAG技术的重要性</h3>
<p><strong>仅依赖LLM的局限性</strong></p>
<p>尽管LLM的参数规模与训练数据量显著增长，使其在自然语言处理任务中的能力快速提升，但模型的知识记忆能力仍受限于架构与训练范式。由于通常需要预训练数据对同一知识点进行多次曝光才能实现有效记忆，导致其记忆效率偏低，且难以全面覆盖各领域知识。</p>
<p>更核心的局限在于，LLM的性能高度依赖训练阶段接触的静态数据。这使其在处理实时更新信息（如最新科技、时事新闻）、长尾知识（即罕见或未纳入训练数据的内容）及动态变化内容时表现不佳，可能生成错误、不完整甚至虚构的信息，即出现 “幻觉” 问题。</p>
<p>此外，针对特定领域的复杂专业知识，LLM的处理效率与深度理解能力也显不足。仅依靠模型无法动态访问外部知识库，这在需依赖精确、最新信息的场景（如问答、医疗诊断、法律咨询、实时信息查询等）中尤为受限。因此，如何克服对静态数据的依赖、提升知识获取的效率与实时性、减少幻觉现象并增强领域深度理解能力，已成为当前LLM发展面临的关键挑战。</p>
<p><strong>RAG技术的诞生</strong></p>
<p>为弥补LLM单独使用时的局限性，检索增强生成技术应运而生。其核心原理是融合“检索”与“生成”：在接收用户查询时，系统先从外部大规模知识源（如文档、数据库）中动态检索相关信息片段，再将这些片段作为附加上下文输入生成模型，辅助其完成答案创作。借助这一机制，模型能够生成更精准、可靠且贴合上下文的答案，不仅大幅提升了生成内容的准确性、相关性与实时性，有效缓解了“幻觉”问题，还增强了答案的可追溯性与可信度；同时，通过动态引入最新信息源，RAG技术显著加快了知识更新效率。</p>
<p>此外，RAG技术赋予模型处理复杂任务的能力，例如串联整合多步骤推理、融合不同领域知识等。以“近期哪个品牌的新款手机拍照功能最优”这一问题为例，其可快速调取最新测评文章，并基于这些内容给出详尽解答，因此在需精准且及时信息的场景中优势显著。</p>
<p>简言之，RAG技术是一种通过融入外部知识库优化LLM性能的模式。关于RAG技术的起源可以参考RAG起源、演进与思考[3]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af972421e6954f6790fc2dd9cfaa369b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=KB6m5kfAEVMGQUAxEDfUAaJFu3s%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fazubuike" target="_blank" title="https://dev.to/azubuike" ref="nofollow noopener noreferrer">dev.to/azubuike</a>_alexmmaghiri_9e/revolutionizing-ai-with-retrieval-augmented-generation-rag-architectures-workflows-and-9c4</p>
<p><strong>RAG技术的应用场景</strong></p>
<p>RAG技术的核心优势在于整合信息检索与文本生成能力，有效突破了LLM在时效性与准确性不足等固有局限，凭借这一核心优势，其应用已延伸至智能问答、文本摘要、对话系统、教育培训、知识增强型问答与推理、个性化推荐及决策支持等多个领域。典型如：</p>
<ul>
<li>在企业知识库管理中，可快速定位内部文档中的关键信息并生成结构化解读，提升团队协作效率；</li>
<li>在金融领域，能实时整合市场动态、政策变动等数据，为投资分析提供基于多源信息的趋势预判；</li>
<li>在客服场景中，可结合用户历史交互记录与产品知识库，生成贴合需求的精准回复，优化服务体验；</li>
<li>在科研领域，助力研究者整合跨学科文献、实验数据，生成具有针对性的研究思路与文献综述框架。</li>
</ul>
<p>随着LLM的兴起，以RAG技术为核心驱动力的新一代智能搜索系统迅猛发展，深刻重塑着信息获取模式。与传统搜索引擎不同，微软Bing Chat、百度文心一言等基于RAG的系统，不仅能更智能地理解用户意图，更能提供高度个性化、上下文关联的交互体验，其角色也从单纯的信息检索工具，演进为可直接输出经信息整合与分析的精确答案的智能系统。</p>
<h3 data-id="heading-2">1.2 RAG系统简介</h3>
<p><strong>RAG系统工作流程概览</strong></p>
<p>RAG系统的核心在于检索与生成流程的深度融合，其核心逻辑是通过动态引入外部知识，大幅提升输出内容的准确性与相关性。具体工作流程以用户查询为起点：首先，检索模块借助向量检索等技术，将用户查询转化为向量形式，从文档库、知识图谱或搜索引擎等外部知识源中快速定位、筛选并提取高度相关的信息片段；随后，以LLM为基础的生成模块会整合查询内容与检索到的上下文信息，经推理、整合与重组，最终生成连贯且精准的答案。</p>
<p>例如，当用户询问“2024年夏季奥运会的举办城市是哪里，有哪些特色比赛项目？”时，RAG系统会率先检索2024年奥运会的相关资料，获取举办城市为巴黎，以及新增的冲浪、滑板等特色项目，还有巴黎奥运会在塞纳河举办公开水域比赛等信息。接着，将这些信息整合，生成“2024年夏季奥运会的举办城市是法国巴黎。该届奥运会新增了冲浪、滑板等深受年轻人喜爱的项目”的回答。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088e65d15c39486ca40a67905eab6c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=swsg9ERcLFMzRdVlxK2HgX3aurc%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2402.19473" target="_blank" title="https://arxiv.org/abs/2402.19473" ref="nofollow noopener noreferrer">arxiv.org/abs/2402.19…</a></p>
<p><strong>基础的RAG系统</strong></p>
<p>为清晰阐述RAG系统的基本原理与实现逻辑，本部分聚焦其核心流程（检索+生成）的简化模型展开说明。</p>
<p>RAG系统的核心机制是在生成答案前，先从知识库中检索相关信息，再以这些信息为依据引导生成过程。这一机制带来多重优势：既能显著提升结果的准确性与相关性，有效缓解模型幻觉问题；又能通过仅更新知识库即可纳入新知识（无需重新训练模型），实现快速迭代；同时增强结果可追溯性，大幅提升大模型应用的可靠性与实用性。基础RAG系统更加详细介绍可以参考：RAG到底咋工作的[4]。</p>
<p>一个基础的RAG系统通过以下核心模块协同实现上述流程：</p>
<ol start="0">
<li>文档处理模块：负责加载文章、书籍、对话、代码等各类原始文本，并将其切分为便于处理的片段。切分通常以句子为单位，且会特意保留片段间的部分重叠内容。此举可避免语义被生硬割裂，从而提高后续检索准确性。</li>
<li>向量编码器：借助Embedding模型将文本片段转化为向量。通俗而言，就是将文字“翻译”为计算机可理解的数字向量，使文本语义转化为可计算的数值特征。</li>
<li>向量数据库：作为专门存储文档片段及其对应向量的载体，在文本切分与向量编码完成后，会集中存储这些数据，为后续快速检索奠定基础。</li>
<li>检索器：作为连接用户查询与数据库的“桥梁”，接收用户查询（Query）后，通过计算查询向量与数据库中向量的相似度，快速定位最相关的文档片段。</li>
<li>LLM：以检索到的相关文档片段为上下文，结合自身语言理解能力生成贴合用户需求的自然语言答案，最终实现“基于事实的智能回答”。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692772bd61454d62b607d4168359a5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=EjxSAaYxePSuv7FI4cU1ZoG6M0U%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>上述模块的协作可梳理为RAG的基础流程，即索引、检索、生成三个核心环节，各环节与模块的对应关系如下：</p>
<ol start="0">
<li>索引：借助文档处理模块、向量编码器、向量数据库，将文档库分割为较短片段，再通过编码器构建向量索引。</li>
<li>检索：依托上述三者，根据问题与片段的相似度检索相关文档片段。</li>
<li>生成：由LLM以检索到的上下文为条件，生成问题的回答。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4216f0c88d934d9aa7ddd0fe0f5b5030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=9VFhRxlhfLcDvv2jmqlW0h0YxUg%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2F5-chunking-strategies-for-rag%3Fref%3Ddailydoseofds.com" target="_blank" title="https://blog.dailydoseofds.com/p/5-chunking-strategies-for-rag?ref=dailydoseofds.com" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/5-chunkin…</a></p>
<h3 data-id="heading-3">1.3 RAG系统工作流程详细介绍</h3>
<p>本节主要在1.2节基础上详细介绍RAG系统的工作流程，相关内容更加详细的介绍可以见：16 Techniques to Supercharge and Build Real-world RAG Systems[5]。</p>
<p>1.文本分段</p>
<p>文档处理模块首先将外部文档拆分为文本片段，目的是避免因文档过长导致的检索效率低、语义理解受限、资源浪费、生成质量下降及歧义风险增加等问题。合理分段是保障后续检索上下文有效性的前提。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f784d57cb9624fb2bd02eca14c42b58d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=z0sDqD0gimY37g3g0t10qZ3UGOw%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="2">
<li>文本片段向量化</li>
</ol>
<p>完成文本分段后，借助向量编码器将各文本片段转化为语义向量。目前主流的做法是采用Transformer模型，其强大的上下文理解能力，正是生成高质量语义向量的关键。关于文本向量的提取方法，可参考文章：Bi-encoders and Cross-encoders for Sentence Pair Similarity Scoring[6]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0906e629cb994648883c39ee97e4db9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=UTKcSOCVRQDeD%2FO3BDVEx31QXcw%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="3">
<li>向量存储与知识库构建</li>
</ol>
<p>将文本向量存入向量数据库，数据库通过关联存储原始内容与对应向量构建外部知识文本库。作为RAG的知识存储层，向量数据库聚合各类知识，为查询响应提供精准依据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00b4a6703d09474a9c9e1a9d24b89403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=eRTsXSAZLSA8fvM3Xrch%2BfgjPTQ%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="4">
<li>用户查询向量化</li>
</ol>
<p>用户输入查询文本（query）后，系统使用与构建知识库时一致的向量编码器将其转化为向量，确保语义空间一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00bd8add6a3b44b8bb802724f5add87e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=1b1qLZhfun6qfB3rwb45AlMLqng%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="5">
<li>相似片段检索</li>
</ol>
<p>检索器通过比对查询向量与数据库中存储的文本向量，定位相似度最高的信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb7806ab8fcc4fc99f40b7039bda3483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=ejQzhkE7eCgDnKYFUYrLw1PtYUM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<p>实际应用中，检索器通过近似最近邻搜索返回前k个（topk）最相似片段，这是因为复杂查询常关联多个相关内容，多结果能避免关键信息遗漏，为响应生成提供全面依据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/170337bf91f74913b4ab004dceed526c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=ygIgqz%2FSLgZb%2BOsAw3PQ%2B%2F9VLHo%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="6">
<li>文本片段重排序</li>
</ol>
<p>检索完成后，需进一步处理挑选出的文档片段，将相关性最高的文本段落置于最前，这一过程称为重排序。此步骤通常使用Reranker模型，这类模型多为交叉编码器，会评估查询与各候选段落的相关性并给出精确相关度分数，随后依分数重新排序，将最相关段落置于前列，便于生成模型优先选用。</p>
<p>这样做能提升后续生成内容的准确性和针对性，不过并非所有RAG应用都包含此步骤。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a699ebfdcbb4851bad31f00c52c9113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=xm0MI6pzYFuM4g1y0jHCBjw9tbk%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="7">
<li>生成回答</li>
</ol>
<p>将用户原始查询与检索到的文本片段整合为提示模板，输入至LLM。模型以文本片段为上下文，生成既融合文档信息、又具备连贯性和相关性的回答，直接回应用户查询。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd466cde49414810aca47e65ad2e4720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=yXp%2BCe7jPb%2Febdp1I65UN5vZdHg%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<h2 data-id="heading-4">2 RAG技术演进趋势和常见问题</h2>
<h3 data-id="heading-5">2.1 RAG技术优化与演进趋势</h3>
<h4 data-id="heading-6">2.1.1 RAG技术增强路径</h4>
<p>随着LLM的迅猛发展，RAG技术同步进入快速演进阶段。目前，已有大量研究与实践从多维度切入。下面将从增强阶段、增强来源和增强过程三个方面，介绍现有技术如何通过多样化手段提升RAG的检索精度并优化运行效率。</p>
<p><strong>增强阶段</strong></p>
<p>从技术增强的阶段特性来看，LLM在预训练、微调和推理环节的优化方式具体如下：</p>
<ul>
<li>Pre-training（预训练阶段）：引入检索增强机制，强化模型对外部知识的融合能力</li>
<li>Fine-tuning（微调阶段）：依托检索优化手段，提升模型对特定任务的适配性能</li>
<li>Inference（推理阶段）：通过动态检索知识辅助生成过程，这也是RAG技术最核心的应用场景</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f303b2ac049940dd82060d4967e1d543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=xboNx6WnLbB5grmkOTltbkuVPZM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v4" target="_blank" title="https://arxiv.org/abs/2312.10997v4" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p><strong>增强来源</strong></p>
<p>在RAG技术中，增强来源指通过外部数据弥补模型固有缺陷的信息渠道，主要包括三类：</p>
<ol start="0">
<li>非结构化数据（天然文本形式，如文章、小说）</li>
</ol>
<ul>
<li>定义：无固定格式的文本内容，涵盖新闻、论文、小说、网页段落等。</li>
<li>示例：</li>
</ul>

<ul>
<li>模型预训练时学习的百科“李白生平”纯文字词条；</li>
<li>推理阶段检索的问答网站“如何评价李白”的散文式用户回答。</li>
</ul>

<ul>
<li>特点：人类可直接阅读，但提取关键信息需“大海捞针”（例如从一篇论文中定位某句话）。</li>
</ul>
<ol start="2">
<li>结构化数据（规整格式呈现，如表格、数据库）</li>
</ol>
<ul>
<li>定义：格式明确的数据形态，包括Excel表格、数据库表、知识图谱（含节点与关系）等。</li>
<li>示例：</li>
</ul>

<ul>
<li>模型预训练时学习的“中国诗人朝代表”（表格中包含“姓名-朝代-代表作”字段）；</li>
<li>推理时查询知识图谱中“李白→好友→杜甫”的关联关系。</li>
</ul>

<ul>
<li>特点：数据排列规整，可精准提取信息（如直接获取表格中的“李白生卒年”），但要求模型具备解析格式的能力（如表格解析能力）。</li>
</ul>
<ol start="3">
<li>LLM生成内容（模型实时生成的思考草稿）</li>
</ol>
<ul>
<li>定义：模型在推理过程中临时产生的文本（非外部现成信息，属于思考阶段的动态产物）。</li>
<li>示例：</li>
</ul>

<ul>
<li>回答“李白与杜甫的关系”时，模型先自主生成假设：“他们是好友，杜甫曾作《赠李白》”（此为模型实时构思的内容）；</li>
<li>随后以该假设为线索，检索《杜工部集》中的诗句进行验证。</li>
</ul>

<ul>
<li>特点：具备动态性与灵活性（模型边思考边生成），但可能存在误差（如假设错误需通过检索修正）。</li>
</ul>
<p>一句话总结差异：</p>
<ul>
<li>非结构化数据与结构化数据：借助外部现成的“知识储备”（他人撰写的文章、表格等）；</li>
<li>LLM生成内容：借助自身临时的“脑暴草稿”（模型推理中动态生成的内容，用作检索线索）。</li>
</ul>
<p><strong>增强过程</strong></p>
<p>增强过程指模型通过检索知识辅助生成内容的机制，核心在于检索策略的逻辑设计，具体包括以下几类：</p>
<ol start="0">
<li>一次检索（Once Retrieval）</li>
</ol>
<ul>
<li>定义：针对问题仅执行单次检索，直接用结果生成答案。</li>
<li>类比：查字典时只翻一次页码，不论解释是否准确便直接引用。</li>
<li>特点：操作简单、效率高，但可能因检索结果不全或问题需多维度知识而遗漏信息。</li>
</ul>
<ol start="2">
<li>迭代检索（Iterative Retrieval）</li>
</ol>
<ul>
<li>定义：基于首次生成的内容反复检索补充知识，逐步优化答案。</li>
<li>类比：写作文时先列大纲（首次生成），发现“李白的好友”仅提及杜甫，便再查高适、王昌龄等资料（迭代检索）以补充内容。</li>
<li>特点：形成“生成→反馈→再检索”的循环，类似“游戏中复活后继续闯关”。</li>
</ul>
<ol start="3">
<li>自适应检索（Adaptive Pattern）</li>
</ol>
<ul>
<li>定义：根据任务类型或生成状态动态调整检索策略，例如切换数据库、调整检索范围等。</li>
<li>类比：玩游戏时，遇“历史题”切换至历史数据库，遇“数学题”切换至公式库；或发现生成内容模糊时，扩大检索范围。</li>
<li>特点：灵活性强，如同“智能切换武器”，但需模型具备判断“何时使用何种策略”的能力。</li>
</ul>
<ol start="4">
<li>递归检索（Recursive Retrieval）</li>
</ol>
<ul>
<li>定义：将复杂问题拆解为子问题，逐层递归检索，像“俄罗斯套娃”般深入探究。</li>
<li>类比：破案时，先查“李白的死因”（主问题），拆解为“李白晚年健康状况”（子问题1），再拆解为“唐朝医疗水平”（子问题2），每层均进行检索。</li>
<li>核心逻辑：遵循“问题→拆解→子检索→再拆解→深层检索”的路径，与递归函数思路一致。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e1717c1aad44211851d192db95ded15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=I1%2BkZVGi6ScefsidfLE8SagNfQM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v4" target="_blank" title="https://arxiv.org/abs/2312.10997v4" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>总之，RAG发展的三大关键技术包括增强阶段、数据来源及处理过程，这三大技术能够清晰呈现RAG核心组件的分类体系，同时RAG的实现模式也在不断演变。早期的RAG可能只是 “简单检索+直接生成” 的模式，而随着技术进步，其实现中已融入更复杂的环节，这些具体实现方法始终处于动态变化中，愈发精细且能更好地适配不同场景。</p>
<p>搭建RAG系统时，技术选型的应该以需求适配为导向，兼顾效果的评估与优化，选择能高效支撑目标场景且表现更优的方案。关于RAG系统的构建和技术选型可以参考：文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIyNTA3NDY2NQ%3D%3D%26mid%3D2247487604%26idx%3D1%26sn%3D38ef1ad966a816275f47cf4e28f80d2f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIyNTA3NDY2NQ==&amp;mid=2247487604&amp;idx=1&amp;sn=38ef1ad966a816275f47cf4e28f80d2f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">17种RAG架构实现原理与选型</a>或参考下一节内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff99103122194482a685093d129675b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=FO%2B8d6eEYgooMlp9s2FCu4HVgf0%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.abacus.ai%2Fblog%2F2023%2F08%2F10%2Fcreate-your-custom-chatgpt-pick-the-best-llm-that-works-for-you%2F" target="_blank" title="https://blog.abacus.ai/blog/2023/08/10/create-your-custom-chatgpt-pick-the-best-llm-that-works-for-you/" ref="nofollow noopener noreferrer">blog.abacus.ai/blog/2023/0…</a></p>
<h4 data-id="heading-7">2.1.2 RAG系统实现模式的演化</h4>
<p>实现高效文档检索需要解决三大核心问题：</p>
<ol start="0">
<li>构建精确的语义表示，确保文档和查询的嵌入能准确捕捉其含义。</li>
<li>对齐查询与文档的语义空间，缩小检索模型理解的查询意图与文档实际内容之间的语义鸿沟。</li>
<li>适配检索器输出与LLM偏好，使检索到的上下文信息更符合下游大型语言模型的生成需求。</li>
</ol>
<p>为应对上述挑战，在RAG架构之上引入了检索前优化和检索后优化的策略。</p>
<ol start="0">
<li>检索前优化，提升索引质量如文档切分粒度优化、元数据增强和查询处理如语义转换、关键词扩展，旨在改善检索相关性。</li>
<li>检索后优化，对检索结果进行过滤、去冗余、重排序按重要性和信息压缩整合，确保输入LLM的上下文信息更精炼相关。</li>
</ol>
<p>基于优化策略的应用深度，当前RAG研究形成了三种主要范式：</p>
<ol start="0">
<li>基础RAG（Naive RAG）</li>
</ol>
<ul>
<li>检索质量低，导致检索结果不精准不全面。</li>
<li>生成质量受限，LLM易产生幻觉，难以有效融合检索到的上下文与当前生成任务。</li>
<li>信息冗余与风格冲突，检索结果常包含重复冗余信息，且不同来源文本风格语气不一致，影响生成连贯性。</li>
<li>过度依赖风险，LLM可能过度依赖有时不准确的检索信息。</li>
<li>遵循基础流程索引、检索、生成。</li>
<li>主要痛点：</li>
</ul>
<ol start="2">
<li>进阶RAG（Advanced RAG）</li>
</ol>
<ul>
<li>通过强化检索前和检索后优化的流程，并改进索引如滑动窗口、细粒度分割、元数据利用，以解决基础RAG的缺陷。</li>
<li>检索前优化：包括数据粒度优化、索引结构调整、元数据注入、向量对齐、混合检索如结合稀疏与稠密检索等。</li>
<li>检索核心：依赖嵌入模型计算查询与文档块的相似度。</li>
<li>检索后优化：采用重排序和提示压缩技术，克服上下文窗口限制，提炼关键信息。</li>
<li>潜在挑战：以复杂度换效果，提升了基础RAG性能，但其额外模块的引入也带来了效率、泛化性和可维护性的新挑战。</li>
</ul>
<ol start="3">
<li>模块化RAG（Modular RAG）</li>
</ol>
<ul>
<li>提升信息效率与质量，整合多种检索技术，优化检索步骤如引入认知回溯机制，实施多样化查询策略，有效利用嵌入相似性。</li>
<li>支持复杂交互，模块化设计便于处理迭代检索与多轮生成，如对回溯提示的响应。</li>
<li>强调框架的高度灵活性与适应性，可将RAG流程拆解为可替换可重组的模块，以解决特定问题。</li>
<li>优化方向：</li>
<li>潜在挑战：当LLM对主题知识匮乏时，依赖检索信息可能导致错误率上升。</li>
</ul>
<p>事实上除了这三种RAG范式，还有其他更多的范式，具体可参考：一篇搞明白RAG的几种不同类型[7]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24d6fd434ed1452292cb21288ddc03f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=kw0lmJ67SN4UMcM5XpSErMAffnU%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>总之，RAG技术及其构成体系具有较强的复杂性，涵盖知识获取、数据预处理、索引构建、检索策略优化、生成模型调优等多个环节。对于应用层面者而言，优先聚焦于检索模块的精准性提升（如向量数据库选型、相似度算法优化）与生成模块的语义连贯性构建（如提示词工程、大模型适配）这两大核心基础，是快速掌握技术应用逻辑的有效路径。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2418a5255a147f3925c93f76c72681c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=JNNu3Iv1mUIirQ2wKA3liqFRmMQ%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<h3 data-id="heading-8">2.2 RAG技术典型问题与优化方案</h3>
<h4 data-id="heading-9">2.2.1 RAG技术常见问题及解决办法</h4>
<p>本节主要介绍RAG技术的常见问题及相应解决办法，更详细的内容可参考文章Traditional RAG vs. HyDE[8]。</p>
<ol start="0">
<li>问题与答案语义不匹配</li>
</ol>
<p>检索到的文档可能与问题无关，甚至无关文档的余弦相似度可能高于含答案的文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8593413ba0a545188e6da035d0dbcf8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=9AKfhqbFX2VDZUN1jezEEW5yrzc%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2Ftraditional-rag-vs-hyde" target="_blank" title="https://blog.dailydoseofds.com/p/traditional-rag-vs-hyde" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/tradition…</a></p>
<p>一种优化方案为：先用LLM针对问题生成假设答案，弥补表述模糊以明确语义指向；再将问题与假设答案转化为文本向量，通过向量拼接或加权求和等方式；最后用该文本向量查询向量数据库，提升匹配精度。</p>
<p>例如，对于问题“需要适合新手，考虑学习难度低，入门成本适中，便于携带的入门乐器”，LLM可生成假设答案以明确指向；再结合该问题与假设答案的语义向量查询数据库，就能精准匹配到“尤克里里学习难度低，入门成本低，体积小便于携带，适合新手入门”这类结果。</p>
<p>需注意这种方法只能在一定程度上减轻问题影响，无法完全消除问题本身的局限性。</p>
<ol start="2">
<li>语义相似性可能被弱化</li>
</ol>
<p>部分含重要信息的长文本常夹杂背景描述、细节补充等无关内容，会稀释核心信息。如同糖水加水后味道变淡，导致RAG计算语义相似度时，与搜索内容的匹配度下降。反观短文本，即便内容不重要，若含少量相关词，因干扰少且相关词集中，与搜索内容的相似度反而更高。最终可能导致系统输出无关信息或遗漏关键信息，影响整体效果。</p>
<p>采用文本摘要或关键句抽取技术预处理长文档，同步进行精准分段、冗余清洗与核心内容提取，仅将浓缩后的核心信息存入语义向量库，再结合优化的检索策略精准匹配相关片段，是应对该问题的有效方法。</p>
<ol start="3">
<li>检索文档的关注偏差</li>
</ol>
<p>基于相似性搜索从数据库检索文档时，通常按相似性度量排序，但LLM基于这些文档生成回答时，虽能通过位置编码明确感知输入顺序，其关注重点却不遵循人类“前序优先”的主观倾向，而是由注意力机制与上下文长度共同决定，短上下文时处理更均匀，长上下文则因“注意力稀释”更关注首尾文档。若高相似文档因位置靠后被忽略，会造成“检索优质但利用低效”，最终降低回答质量。</p>
<p>例如问“缓解颈椎痛的好办法”，数据库检索出6篇文档，按相似性从高到低排序，第4篇最相关，写了具体的穴位按摩法，第1篇只说“别久坐”。LLM处理这6篇长上下文时，注意力稀释，主要关注首尾，未太关注第4篇，最终回答只提“别久坐”，遗漏了最有效的穴位按摩法。明明检索到了优质信息却没用好，回答自然不够好。</p>
<p>应对方案可采用“关键文档首尾双曝光”策略：将检索结果中最相关的文档交替置于输入序列的头部和尾部，如复制最关键的1-3篇文档到首尾位置；利用LLM在长上下文中天然关注首尾的“注意力锚点效应”，首尾信息稀释度最低；确保高价值内容不被中间位置淹没，同时辅以文档内容浓缩，通过摘要压缩文本减少冗余干扰，以及显式指令引导，在输入中标注“请重点参考以下高相关文档”。三重措施协同突破注意力稀释瓶颈，显著提升优质检索结果的利用率。</p>
<ol start="4">
<li>需避免询问需整合全局信息的问题</li>
</ol>
<p>使用RAG系统时，需避免需要全局信息汇总的问题，这类问题需整合大量分散数据，而RAG系统依赖的相似性搜索通常只能定位少数最相关文档，难以覆盖全部必要信息源，导致答案常出错。若答案集中在一两份文档中，相似性搜索精准高效，RAG系统表现良好，但若答案需遍历所有文档、聚合分散信息，相似性搜索则力不从心。本质上，RAG系统是检索增强工具，而非全局数据聚合器，处理跨文档汇总和统计类问题时存在天然局限。</p>
<p>在RAG系统中缓解全局汇总问题，核心是结合混合检索向量+关键词提升覆盖度，并通过查询分解让RAG系统分步处理子问题，最后聚合结果。若需强统计能力，需整合传统数据库执行聚合计算。</p>
<h4 data-id="heading-10">2.2.2 RAG系统固有挑战</h4>
<p>除上述问题外，RAG系统还存在以下固有挑战：</p>
<ol start="0">
<li>检索效率与延迟问题：面对百万级文档等大规模知识库时，检索易产生高延迟，难以满足实时交互需求。</li>
<li>对知识库质量的高度依赖：生成结果直接受检索内容影响。若知识库存在数据过时、信息不完整或包含噪声等问题，会导致输出错误；同时，在小众领域等未覆盖场景中，其领域适应性较差。</li>
<li>上下文窗口限制：受生成模型上下文窗口容量所限，检索到的长文档可能被截断，造成关键信息丢失。</li>
<li>生成与检索的协同问题：</li>
</ol>
<ul>
<li>模型可能忽略检索结果，仅依赖自身参数生成错误信息（即"检索无用"）；</li>
<li>或过度依赖检索内容，机械复制片段而缺乏逻辑整合。</li>
</ul>
<ol start="5">
<li>评估体系缺失：目前缺乏统一的量化指标来评估检索与生成的协同效果，人工评估成本高且难以标准化，阻碍了模型迭代优化。</li>
</ol>
<p>RAG的这些固有挑战，源于检索与生成这两个复杂系统的耦合，其中涉及算法、数据及工程等多方面的权衡。由于目前这些挑战尚无法完全解决，因此在使用RAG技术时需要加以考量。关于这些固有挑战的详细介绍，可参考论文：Seven Failure Points When Engineering a Retrieval Augmented Generation System[9]。</p>
<h4 data-id="heading-11">2.2.3 RAG技术与模型指令微调的对比</h4>
<p>在构建LLM应用时，除了RAG技术，模型指令微调也是一种被广泛采用的技术路径。关于这两种技术的详细对比，可以参考文章Full-model Fine-tuning vs. LoRA vs. RAG[10]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b02cfa8628146ecbc37abcc6521348e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=k8ucCA0f85WWN4s2VmBF7o9n8ZU%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2Ffull-model-fine-tuning-vs-lora-vs" target="_blank" title="https://blog.dailydoseofds.com/p/full-model-fine-tuning-vs-lora-vs" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/full-mode…</a></p>
<p>对比内容概览如下：</p>
<ol start="0">
<li>基础机制与数据需求</li>
</ol>
<ul>
<li>RAG ：通过检索外部知识库（文档、数据库等）获取信息，结合生成模型输出答案；无需修改模型参数，依赖知识库质量，无需标注训练数据。</li>
<li>指令微调 ：在特定标注数据集上调整预训练模型参数，适配特定任务/领域；需高质量标注数据，直接修改模型参数。</li>
</ul>
<ol start="2">
<li>更新机制与成本</li>
</ol>
<ul>
<li>RAG ：支持实时更新知识库，模型无需重新训练；仅涉及检索+生成，推理成本低。</li>
<li>指令微调 ：知识更新需重新微调或增量训练，成本高（依赖GPU资源）；无检索步骤，推理速度快。</li>
</ul>
<ol start="3">
<li>优势与局限</li>
</ol>
<ul>
<li>RAG ： ✅ 优势：灵活适应新知识、降低幻觉风险（依赖权威数据源）、无需训练数据。 ❌ 局限：检索延迟可能影响响应速度、依赖知识库质量、生成逻辑受限于检索片段。</li>
<li>指令微调 ： ✅ 优势：输出风格可控、领域内任务性能更优、推理速度快（无检索步骤）。 ❌ 局限：数据不足时易过拟合、知识更新需重新训练、可能产生事实性幻觉。</li>
</ul>
<ol start="4">
<li>适用场景与典型应用</li>
</ol>
<ul>
<li>RAG ：适用于知识密集型任务（需动态/领域外知识），如开放域问答、医疗咨询、产品文档客服。</li>
<li>指令微调 ：适用于需特定输出风格或领域专精的任务，如代码生成、情感分析、法律文本生成、专业术语翻译。</li>
</ul>
<ol start="5">
<li>技术代表</li>
</ol>
<ul>
<li>RAG ：FAISS + GPT、DPR + BART</li>
<li>指令微调 ：LoRA、Adapter、全参数微调</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2f31b2a22240e4a4d71fa4db126a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=2xAWqOTCfkbGwfrx%2B8DV%2BmAqzgs%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<h2 data-id="heading-12">3 实战</h2>
<h3 data-id="heading-13">3.1 RAG系统示例代码</h3>
<p>本文第一章已详细阐述了RAG系统的基本工作流程，其核心环节涵盖：文本分段、文本片段向量化、向量存储与知识库构建、用户查询向量化、相似片段检索、文本片段重排序以及生成回答。 为了更好地解释RAG模型的原理和实现，本章将提供完整的示例代码，系统性地演示如何实现上述各个环节，从而构建一个可运行的最小化RAG应用系统。该部分内容参考自：Happy-LLM[11]。</p>
<p>下面将介绍该示例各部分代码。所有代码需放在同一文件夹中，<strong>最后一个模块，即生成回答的代码为运行入口。请注意，代码中使用的均为基础版模型</strong>。</p>
<p>若回答效果欠佳，可能源于多方面因素：文档分块不合理、向量提取模型对领域语义捕捉不足、检索策略未返回最相关上下文、大语言模型对检索内容利用不充分，或测试文件与问题相关性低、对话历史累积造成干扰等。这些环节都会影响最终回答的准确性和针对性。实际搭建RAG系统可参考本文3.2节内容</p>
<p><strong>0. 生成示例数据</strong></p>
<p>这段代码文件是一个用于生成RAG系统测试文件的Python脚本，主要功能是创建几个包含特定内容的文本文件，注意输出文件都为txt格式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Generate.py  </span>
<span class="hljs-keyword">import</span> os  
  
defgenerate_rag_test_files(folder_name:<span class="hljs-built_in">str</span> =<span class="hljs-string">"rag_test_files"</span>):  
<span class="hljs-string">"""生成RAG测试文件并保存到指定文件夹"""</span>  
<span class="hljs-comment"># 创建存放文件的文件夹  </span>
ifnot os.path.exists(folder_name):  
        os.makedirs(folder_name)  
  
<span class="hljs-comment"># 定义文件内容  </span>
    planets_content = <span class="hljs-string">"""太阳系行星基础知识  
  
1. 水星（Mercury）  
- 位置：距离太阳最近的行星（约0.39天文单位）  
- 特征：表面布满陨石坑，没有大气层保护，昼夜温差极大（白天约430℃，夜晚约-180℃）  
- 自转周期：58.6地球日，公转周期：88地球日  
  
2. 金星（Venus）  
- 位置：距离太阳第二近（约0.72天文单位）  
- 特征：被浓密的二氧化碳大气层覆盖，产生强烈温室效应，表面温度约467℃（太阳系中最热的行星）  
- 特殊点：自转方向与其他行星相反（自东向西），自转周期243地球日，公转周期225地球日  
  
3. 地球（Earth）  
- 位置：距离太阳第三近（约1天文单位）  
- 唯一已知存在液态水和生命的行星，大气层以氮和氧为主  
- 自转周期23小时56分，公转周期365.24天  
  
4. 火星（Mars）  
- 位置：距离太阳第四近（约1.52天文单位）  
- 特征：表面呈红色（因富含氧化铁），有稀薄的二氧化碳大气层，存在极地冰盖（主要是干冰和水冰）  
- 地标：奥林匹斯山（太阳系最高山峰，约21千米）、水手谷（长约4000千米的峡谷）  
  
5. 木星（Jupiter）  
- 位置：距离太阳第五近（约5.2天文单位）  
- 特征：太阳系中最大的行星（质量是其他所有行星总和的2.5倍），由氢和氦组成，表面有明显的条纹和“大红斑”（持续数百年的风暴）  
- 卫星：已知有95颗卫星，其中最大的4颗是“伽利略卫星”（木卫一至木卫四）  
"""</span>  
  
    purifier_content = <span class="hljs-string">"""家用空气净化器（型号：CleanAir X5）使用指南  
  
一、核心功能  
1. 净化范围：适用面积20-30㎡（密闭空间）  
2. 过滤系统：  
   - 初级滤网：拦截毛发、灰尘等大颗粒  
   - HEPA滤网：过滤PM2.5、花粉、细菌（效率99.97%@0.3μm）  
   - 活性炭滤网：吸附甲醛、TVOC等有害气体  
3. 运行模式：  
   - 自动模式：根据内置传感器检测的空气质量自动调节风速  
   - 睡眠模式：风速最低，噪音≤30分贝，适合夜间使用  
  
二、操作步骤  
1. 首次使用：  
   - 拆除滤网外层的塑料包装（否则会影响净化效果）  
   - 连接电源，按机身“电源键”开机（默认进入自动模式）  
2. 更换滤网提示：  
   - 当机身“滤网指示灯”亮起时，需更换对应滤网（HEPA滤网建议6-8个月更换一次，活性炭滤网建议3-4个月更换一次）  
   - 更换方法：打开机器背部面板，取出旧滤网，按标识方向装入新滤网  
  
三、注意事项  
1. 避免在潮湿环境（如浴室）使用，以免滤网受潮发霉  
2. 长期不使用时，需断开电源并清洁机身表面  
3. 若出现异响或净化效果下降，检查是否滤网安装错误或风扇故障  
"""</span>  
  
    reimbursement_content = <span class="hljs-string">"""HelloWorld公司员工报销流程指南（2024版）  
  
一、可报销费用类型  
1. 差旅费用：  
   - 包含：交通（机票/高铁票需提供行程单）、住宿（需提供酒店发票和住宿清单）、市内交通（地铁/打车票，单日上限200元）  
   - 标准：一线城市住宿上限800元/晚，二线城市600元/晚  
2. 办公采购：  
   - 需提前在OA系统提交“采购申请单”，审批通过后凭发票报销（单笔超过5000元需走对公转账）  
3. 业务招待：  
   - 需注明招待对象、事由，单次招待金额超过2000元需部门总监审批  
  
二、报销流程步骤  
1. 收集凭证：保留所有费用的原始发票（电子发票需打印纸质版并签字）  
2. 提交申请：在OA系统“报销模块”填写报销单，上传发票照片并关联对应项目编号  
3. 审批环节：  
   - 单笔≤1000元：部门经理审批→财务审核→打款  
   - 单笔＞1000元：部门经理→财务主管→总经理→财务审核→打款  
4. 到账时间：财务审核通过后3个工作日内，款项将打入员工工资卡  
  
三、常见问题  
1. 发票抬头必须为“XX科技有限公司”，否则不予报销  
2. 差旅报销需在出差结束后15天内提交，逾期视为自动放弃  
3. 虚报费用将扣除当月绩效20%，并记录违规一次  
"""</span>  
  
<span class="hljs-comment"># 定义要创建的文件列表  </span>
    files = [  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"太阳系行星知识.txt"</span>, <span class="hljs-string">"content"</span>: planets_content},  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"家用空气净化器使用指南.txt"</span>, <span class="hljs-string">"content"</span>: purifier_content},  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"公司报销流程指南.txt"</span>, <span class="hljs-string">"content"</span>: reimbursement_content}  
    ]  
  
<span class="hljs-comment"># 将内容写入文件  </span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:  
        file_path = os.path.join(folder_name, file[<span class="hljs-string">"name"</span>])  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:  
            f.write(file[<span class="hljs-string">"content"</span>])  
  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已生成3个RAG测试文件，存放于：<span class="hljs-subst">{os.path.abspath(folder_name)}</span>"</span>)  
<span class="hljs-keyword">return</span> folder_name  
  
<span class="hljs-comment"># 调用函数生成文件  </span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    generate_rag_test_files()
</code></pre>
<p><strong>1. 文本分段</strong></p>
<p>以下代码文件实现了ReadFiles类，用于文档加载与切分：读取指定文件夹中的所有txt文件，以最大token长度为依据，先按换行符初步切分，单行token超限时则进一步按token分割，同时保留相邻片段的重叠内容以提升后续检索准确性。此外，该文件还包含Documents类，用于将数据解析结果存入JSON格式文档，并返回相应接口。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Utils.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">import</span> tiktoken  <span class="hljs-comment"># 导入tiktoken库，用于计算文本的token数量  </span>
  
<span class="hljs-comment"># 初始化编码器，使用cl100k_base编码方式  </span>
enc = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)  
  
classReadFiles:  
<span class="hljs-string">"""  
    读取指定目录下的文本文件，并根据token长度进行分块处理的类  
    主要用于将长文本分割为适合大语言模型处理的小块  
    """</span>  
  
def__init__(self, path: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化ReadFiles实例  
        :param path: 目标文件夹路径，用于读取其中的文本文件  
        """</span>  
        self._path = path  <span class="hljs-comment"># 存储目标文件夹路径  </span>
        self.file_list = self.get_files()  <span class="hljs-comment"># 获取文件夹中所有符合条件的文件路径列表  </span>
  
defget_files(self):  
<span class="hljs-string">"""  
        遍历指定文件夹及其子文件夹，收集所有.txt后缀的文件路径  
        :return: 包含所有txt文件绝对路径的列表  
        """</span>  
        file_list = []  
<span class="hljs-comment"># os.walk递归遍历文件夹：返回当前路径、子文件夹列表、文件列表  </span>
<span class="hljs-keyword">for</span> filepath, dirnames, filenames <span class="hljs-keyword">in</span> os.walk(self._path):  
<span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames:  
<span class="hljs-comment"># 筛选出后缀为.txt的文件  </span>
<span class="hljs-keyword">if</span> filename.endswith(<span class="hljs-string">".txt"</span>):  
<span class="hljs-comment"># 拼接完整文件路径并添加到列表  </span>
                    file_list.append(os.path.join(filepath, filename))  
<span class="hljs-keyword">return</span> file_list  
  
defget_content(self, max_token_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">600</span>, cover_content: <span class="hljs-built_in">int</span> = <span class="hljs-number">150</span>):  
<span class="hljs-string">"""  
        读取所有文件内容，并按指定token长度进行分块处理  
        :param max_token_len: 每个块的最大token长度，默认600  
        :param cover_content: 块之间重叠的内容长度（字符数），用于保持上下文连贯性，默认150  
        :return: 所有文件分块后的内容列表  
        """</span>  
        docs = []  
<span class="hljs-comment"># 遍历每个文件并处理  </span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> self.file_list:  
<span class="hljs-comment"># 读取文件内容  </span>
            content = self.read_file_content(file)  
<span class="hljs-comment"># 对内容进行分块  </span>
            chunk_content = self.get_chunk(  
                content, max_token_len=max_token_len, cover_content=cover_content)  
<span class="hljs-comment"># 将分块结果添加到总列表  </span>
            docs.extend(chunk_content)  
<span class="hljs-keyword">return</span> docs  
  
    @<span class="hljs-built_in">classmethod</span>  
defget_chunk(cls, text: <span class="hljs-built_in">str</span>, max_token_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">600</span>, cover_content: <span class="hljs-built_in">int</span> = <span class="hljs-number">150</span>):  
<span class="hljs-string">"""  
        将文本按token长度分块，处理长文本并保持块之间的重叠  
        :param text: 要分块的原始文本  
        :param max_token_len: 每个块的最大token长度  
        :param cover_content: 块之间重叠的内容长度（字符数）  
        :return: 分块后的文本列表  
        """</span>  
        chunk_text = []  <span class="hljs-comment"># 存储分块结果  </span>
  
        curr_len = <span class="hljs-number">0</span><span class="hljs-comment"># 当前块的token长度  </span>
        curr_chunk = <span class="hljs-string">''</span><span class="hljs-comment"># 当前块的文本内容  </span>
  
<span class="hljs-comment"># 实际可用的token长度 = 最大长度 - 重叠部分（为重叠内容预留空间）  </span>
        token_len = max_token_len - cover_content  
<span class="hljs-comment"># 按行分割文本（假设行是有意义的文本单元）  </span>
        lines = text.splitlines()  
  
<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:  
<span class="hljs-comment"># 去除行首尾空格，但保留行内空格  </span>
            line = line.strip()  
<span class="hljs-comment"># 计算当前行的token长度  </span>
            line_len = <span class="hljs-built_in">len</span>(enc.encode(line))  
  
<span class="hljs-comment"># 情况1：当前行的token长度超过最大限制  </span>
<span class="hljs-keyword">if</span> line_len &gt; max_token_len:  
<span class="hljs-comment"># 如果当前块有内容，先保存  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
                    chunk_text.append(curr_chunk)  
                    curr_chunk = <span class="hljs-string">''</span>  
                    curr_len = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 将超长行按token长度分割成多个块  </span>
                line_tokens = enc.encode(line)  
<span class="hljs-comment"># 计算需要分成多少块  </span>
                num_chunks = (<span class="hljs-built_in">len</span>(line_tokens) + token_len - <span class="hljs-number">1</span>) // token_len  
  
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):  
<span class="hljs-comment"># 计算当前块的token起始和结束位置  </span>
                    start_token = i * token_len  
                    end_token = <span class="hljs-built_in">min</span>(start_token + token_len, <span class="hljs-built_in">len</span>(line_tokens))  
  
<span class="hljs-comment"># 将token片段解码回文本  </span>
                    chunk_tokens = line_tokens[start_token:end_token]  
                    chunk_part = enc.decode(chunk_tokens)  
  
<span class="hljs-comment"># 除了第一个块，其他块都添加前一个块的结尾作为重叠内容  </span>
<span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span><span class="hljs-keyword">and</span> chunk_text:  
                        prev_chunk = chunk_text[-<span class="hljs-number">1</span>]  
<span class="hljs-comment"># 取前一个块的最后cover_content个字符作为重叠内容  </span>
                        cover_part = prev_chunk[-cover_content:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prev_chunk) &gt; cover_content <span class="hljs-keyword">else</span> prev_chunk  
                        chunk_part = cover_part + chunk_part  
  
                    chunk_text.append(chunk_part)  
  
<span class="hljs-comment"># 重置当前块状态  </span>
                curr_chunk = <span class="hljs-string">''</span>  
                curr_len = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 情况2：当前行可以加入当前块（加上换行符的1个token）  </span>
<span class="hljs-keyword">elif</span> curr_len + line_len + <span class="hljs-number">1</span> &lt;= token_len:  <span class="hljs-comment"># +1 是为换行符预留的token  </span>
<span class="hljs-keyword">if</span> curr_chunk:  <span class="hljs-comment"># 如果当前块已有内容，先加换行符  </span>
                    curr_chunk += <span class="hljs-string">'\n'</span>  
                    curr_len += <span class="hljs-number">1</span><span class="hljs-comment"># 换行符算1个token  </span>
                curr_chunk += line  <span class="hljs-comment"># 添加当前行文本  </span>
                curr_len += line_len  <span class="hljs-comment"># 更新当前块的token长度  </span>
<span class="hljs-comment"># 情况3：当前行无法加入当前块，需要开始新块  </span>
<span class="hljs-keyword">else</span>:  
<span class="hljs-comment"># 保存当前块  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
                    chunk_text.append(curr_chunk)  
  
<span class="hljs-comment"># 开始新块，添加与前一块的重叠内容  </span>
<span class="hljs-keyword">if</span> chunk_text:  <span class="hljs-comment"># 如果已有块，添加重叠部分  </span>
                    prev_chunk = chunk_text[-<span class="hljs-number">1</span>]  
                    cover_part = prev_chunk[-cover_content:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prev_chunk) &gt; cover_content <span class="hljs-keyword">else</span> prev_chunk  
                    curr_chunk = cover_part + <span class="hljs-string">'\n'</span> + line  
<span class="hljs-comment"># 计算新块的初始token长度（重叠部分+换行符+当前行）  </span>
                    curr_len = <span class="hljs-built_in">len</span>(enc.encode(cover_part)) + <span class="hljs-number">1</span> + line_len  
<span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 如果是第一个块，直接添加当前行  </span>
                    curr_chunk = line  
                    curr_len = line_len  
  
<span class="hljs-comment"># 添加最后一个未处理的块（如果有内容）  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
            chunk_text.append(curr_chunk)  
  
<span class="hljs-keyword">return</span> chunk_text  
  
    @<span class="hljs-built_in">classmethod</span>  
defread_file_content(cls, file_path: <span class="hljs-built_in">str</span>):  
<span class="hljs-string">"""  
        根据文件类型读取内容（目前仅支持txt文件）  
        :param file_path: 文件路径  
        :return: 文件内容字符串  
        :raises ValueError: 如果文件类型不支持  
        """</span>  
<span class="hljs-keyword">if</span> file_path.endswith(<span class="hljs-string">'.txt'</span>):  
<span class="hljs-keyword">return</span> cls.read_text(file_path)  
<span class="hljs-keyword">else</span>:  
<span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Unsupported file type"</span>)  <span class="hljs-comment"># 抛出不支持文件类型的异常  </span>
  
    @<span class="hljs-built_in">classmethod</span>  
defread_text(cls, file_path: <span class="hljs-built_in">str</span>):  
<span class="hljs-string">"""  
        读取文本文件内容  
        :param file_path: txt文件路径  
        :return: 文件内容字符串  
        """</span>  
<span class="hljs-comment"># 使用utf-8编码打开并读取文件  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> file:  
<span class="hljs-keyword">return</span> file.read()  
  
  
classDocuments:  
<span class="hljs-string">"""  
    读取已分类的JSON格式文档的类  
    用于获取预先处理好的JSON格式内容  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">''</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化Documents实例  
        :param path: JSON文件路径，默认为空字符串  
        """</span>  
        self.path = path  <span class="hljs-comment"># 存储JSON文件路径  </span>
  
defget_content(self):  
<span class="hljs-string">"""  
        读取并解析JSON文件内容  
        :return: 解析后的JSON数据（通常为字典或列表）  
        """</span>  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.path, mode=<span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            content = json.load(f)  <span class="hljs-comment"># 加载并解析JSON数据  </span>
<span class="hljs-keyword">return</span> content
</code></pre>
<p><strong>2. 文本片段向量化</strong></p>
<p>以下代码文件主要实现了文本片段向量化相关功能，核心是将文本转换为数值向量并提供向量相似度计算能力，具体包括：</p>
<ol start="0">
<li>定义了抽象基类<code>BaseEmbeddings</code>，规定了向量提取模型（嵌入模型）的基本接口：</li>
</ol>
<ul>
<li>存储模型路径的初始化方法</li>
<li>抽象方法<code>get_embedding</code>（需子类实现文本到向量的转换）</li>
<li>类方法<code>cosine_similarity</code>（计算两个向量的余弦相似度，衡量文本相似度）</li>
</ul>
<ol start="2">
<li>实现了具体子类<code>SentenceEmbedding</code>：</li>
</ol>
<ul>
<li>基于Sentence-BERT模型实现文本嵌入功能</li>
<li>支持从Hugging Face或ModelScope加载预训练模型</li>
<li>实现<code>get_embedding</code>方法，将文本预处理后转换为向量</li>
</ul>
<ol start="3">
<li>提供了测试代码：</li>
</ol>
<ul>
<li>初始化默认模型（sentence-transformers/all-MiniLM-L6-v2）</li>
<li>演示文本嵌入过程并输出向量维度和示例值</li>
<li>向量输出维度默认为384</li>
</ul>
<p>总之，该代码整体功能是将文本转化为计算机可理解的向量表示，为后续的文本相似度计算、语义搜索等任务提供基础。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Embeddings.py  </span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  
  
classBaseEmbeddings:  
<span class="hljs-string">"""  
    嵌入模型的基类，定义了所有嵌入模型应实现的基本接口  
    作为抽象基类，不能直接实例化，需通过子类实现具体功能  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化嵌入基类，存储模型或数据的路径  
  
        Args:  
            path (str): 模型或数据的路径，可以是本地路径或远程仓库地址  
        """</span>  
        self.path = path  <span class="hljs-comment"># 存储模型路径供后续使用  </span>
  
defget_embedding(self, text: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:  
<span class="hljs-string">"""  
        获取文本的嵌入向量表示的抽象方法  
        子类必须实现此方法以提供具体的嵌入计算逻辑  
  
        Args:  
            text (str): 需要转换为嵌入向量的输入文本  
  
        Returns:  
            List[float]: 文本对应的嵌入向量，以浮点数列表形式返回  
  
        Raises:  
            NotImplementedError: 如果子类未实现此方法则会抛出此异常  
        """</span>  
<span class="hljs-comment"># 抛出未实现异常，强制子类实现该方法  </span>
<span class="hljs-keyword">raise</span> NotImplementedError  
  
    @<span class="hljs-built_in">classmethod</span>  
defcosine_similarity(cls, vector1: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>], vector2: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]) -&gt; <span class="hljs-built_in">float</span>:  
<span class="hljs-string">"""  
        计算两个向量之间的余弦相似度  
        余弦相似度是衡量两个向量方向相似性的指标，值越接近1表示方向越相似  
  
        Args:  
            vector1 (List[float]): 第一个向量  
            vector2 (List[float]): 第二个向量  
  
        Returns:  
            float: 两个向量的余弦相似度，范围在[-1, 1]之间  
                  1表示完全相似，-1表示完全相反，0表示正交  
        """</span>  
<span class="hljs-comment"># 将输入的Python列表转换为numpy数组，并指定数据类型为float32以节省内存  </span>
        v1 = np.array(vector1, dtype=np.float32)  
        v2 = np.array(vector2, dtype=np.float32)  
  
<span class="hljs-comment"># 检查向量中是否包含无穷大或NaN值，这些值会导致计算错误  </span>
ifnot np.<span class="hljs-built_in">all</span>(np.isfinite(v1)) ornot np.<span class="hljs-built_in">all</span>(np.isfinite(v2)):  
return0<span class="hljs-number">.0</span><span class="hljs-comment"># 存在无效值时返回0表示无相似性  </span>
  
<span class="hljs-comment"># 计算两个向量的点积（内积）  </span>
        dot_product = np.dot(v1, v2)  
<span class="hljs-comment"># 计算每个向量的L2范数（欧几里得长度）  </span>
        norm_v1 = np.linalg.norm(v1)  
        norm_v2 = np.linalg.norm(v2)  
  
<span class="hljs-comment"># 计算两个向量范数的乘积作为分母  </span>
        magnitude = norm_v1 * norm_v2  
<span class="hljs-comment"># 处理分母为0的特殊情况（避免除以零错误）  </span>
<span class="hljs-keyword">if</span> magnitude == <span class="hljs-number">0</span>:  
return0<span class="hljs-number">.0</span><span class="hljs-comment"># 零向量之间的相似度定义为0  </span>
  
<span class="hljs-comment"># 返回余弦相似度：点积除以范数乘积  </span>
<span class="hljs-keyword">return</span> dot_product / magnitude  
  
classSentenceEmbedding(BaseEmbeddings):  
<span class="hljs-string">"""  
    基于Sentence-BERT的句子嵌入实现类  
    继承自BaseEmbeddings，实现了具体的句子嵌入计算功能  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化SentenceEmbedding实例，加载指定的句子嵌入模型  
  
        Args:  
            path (str, optional): 模型路径，默认为预训练模型"sentence-transformers/all-MiniLM-L6-v2"  
                                 可以是modelscope模型仓库名称或本地模型路径  
        """</span>  
<span class="hljs-comment"># 调用父类的初始化方法，存储模型路径  </span>
        <span class="hljs-built_in">super</span>().__init__(path)  
<span class="hljs-keyword">try</span>:  
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer  
<span class="hljs-comment"># 利用modelscope加速下载  </span>
<span class="hljs-keyword">from</span> modelscope <span class="hljs-keyword">import</span> snapshot_download  
  
            model_name = path  <span class="hljs-comment"># 模型名称/路径  </span>
<span class="hljs-comment"># 从模型仓库下载模型到本地（如果本地已存在则直接使用）  </span>
            model_dir = snapshot_download(model_name)  
<span class="hljs-comment"># 初始化SentenceTransformer模型实例  </span>
            self.model = SentenceTransformer(model_dir)  
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
<span class="hljs-comment"># 捕获所有可能的异常并包装为运行时错误，提供更明确的错误信息  </span>
<span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"加载SentenceTransformer模型失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)  
  
defget_embedding(self, text: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:  
<span class="hljs-string">"""  
        实现父类的抽象方法，获取文本的嵌入向量  
  
        Args:  
            text (str): 需要转换为嵌入向量的输入文本  
  
        Returns:  
            List[float]: 文本对应的嵌入向量，以浮点数列表形式返回  
        """</span>  
<span class="hljs-comment"># 文本预处理：将换行符替换为空格，避免模型处理换行符可能带来的问题  </span>
        text = text.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>)  
<span class="hljs-comment"># 使用加载的模型对文本进行编码，获取嵌入向量（numpy数组格式）  </span>
        embedding = self.model.encode(text)  
  
<span class="hljs-comment"># 将numpy数组转换为Python列表并返回  </span>
<span class="hljs-keyword">return</span> embedding.tolist()  
  
<span class="hljs-comment"># 当脚本作为主程序运行时执行以下代码  </span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
<span class="hljs-comment"># 创建SentenceEmbedding实例，使用默认模型  </span>
    embedding = SentenceEmbedding()  
  
<span class="hljs-comment"># 定义测试文本  </span>
    text = <span class="hljs-string">"这是一个测试文本"</span>  
<span class="hljs-comment"># 获取文本的嵌入向量  </span>
    vectors = embedding.get_embedding(text)  
  
<span class="hljs-comment"># 打印嵌入向量的维度和前10个元素，验证功能是否正常  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"嵌入向量维度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vectors)}</span>"</span>)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"嵌入向量示例: <span class="hljs-subst">{vectors[:<span class="hljs-number">10</span>]}</span>..."</span>)
</code></pre>
<p><strong>3. 向量存储与知识库构建</strong></p>
<p>完成文档切分与Embedding模型加载后，需构建向量数据库存储文档片段及其向量表示，并设计检索模块实现查询响应。以下代码文件实现了一个向量存储与知识库构建类，主要功能如下：</p>
<ul>
<li>管理文档及其对应的向量：存储文本文档及其对应的向量表示</li>
<li>向量生成：通过文本片段向量化将文档转换为向量</li>
<li>持久化存储：将文档和向量数据保存到本地文件系统，也可从本地加载</li>
<li>相似度计算：提供向量间的余弦相似度计算功能</li>
<li>相似性查询：根据输入的查询文本，找到最相似的前k个文档</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># VectorBase.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">from</span> Embeddings <span class="hljs-keyword">import</span> BaseEmbeddings  
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  
<span class="hljs-comment"># 导入进度条库，用于显示处理进度  </span>
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm  
  
classVectorStore:  
<span class="hljs-string">"""  
    向量存储类，用于管理文档及其对应的向量表示  
    提供向量计算、持久化存储、相似度查询等功能  
    """</span>  
def__init__(self, document: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [<span class="hljs-string">''</span>]) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化向量存储实例  
  
        参数:  
            document: 初始文档列表，默认为包含一个空字符串的列表  
        """</span>  
        self.document = document  <span class="hljs-comment"># 存储文档内容的列表  </span>
        self.vectors = []  <span class="hljs-comment"># 存储文档对应的向量表示  </span>
  
defget_vector(self, EmbeddingModel: BaseEmbeddings) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:  
<span class="hljs-string">"""  
        使用嵌入模型为文档生成向量表示  
  
        参数:  
            EmbeddingModel: 用于生成嵌入向量的模型实例，需继承自BaseEmbeddings  
  
        返回:  
            文档列表对应的向量列表，每个向量是一个浮点数列表  
        """</span>  
        self.vectors = []  
<span class="hljs-comment"># 使用tqdm显示处理进度，desc设置进度条描述  </span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> tqdm(self.document, desc=<span class="hljs-string">"Calculating embeddings"</span>):  
<span class="hljs-comment"># 为每个文档生成嵌入向量并添加到列表  </span>
            self.vectors.append(EmbeddingModel.get_embedding(doc))  
<span class="hljs-keyword">return</span> self.vectors  
  
defpersist(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">'storage'</span>):  
<span class="hljs-string">"""  
        将文档和向量数据持久化存储到文件系统  
  
        参数:  
            path: 存储目录路径，默认为'storage'  
        """</span>  
<span class="hljs-comment"># 如果目录不存在则创建  </span>
ifnot os.path.exists(path):  
            os.makedirs(path)  
<span class="hljs-comment"># 保存文档内容到JSON文件  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/doecment.json"</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            json.dump(self.document, f, ensure_ascii=<span class="hljs-literal">False</span>)  
<span class="hljs-comment"># 如果存在向量数据，则保存向量到JSON文件  </span>
<span class="hljs-keyword">if</span> self.vectors:  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/vectors.json"</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
                json.dump(self.vectors, f)  
  
defload_vector(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">'storage'</span>):  
<span class="hljs-string">"""  
        从文件系统加载已持久化的文档和向量数据  
  
        参数:  
            path: 存储目录路径，默认为'storage'  
        """</span>  
<span class="hljs-comment"># 加载向量数据  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/vectors.json"</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            self.vectors = json.load(f)  
<span class="hljs-comment"># 加载文档内容  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/doecment.json"</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            self.document = json.load(f)  
  
defget_similarity(self, vector1: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>], vector2: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]) -&gt; <span class="hljs-built_in">float</span>:  
<span class="hljs-string">"""  
        计算两个向量之间的余弦相似度  
  
        参数:  
            vector1: 第一个向量  
            vector2: 第二个向量  
  
        返回:  
            两个向量的余弦相似度，值越接近1表示越相似  
        """</span>  
<span class="hljs-keyword">return</span> BaseEmbeddings.cosine_similarity(vector1, vector2)  
  
defquery(self, query: <span class="hljs-built_in">str</span>, EmbeddingModel: BaseEmbeddings, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:  
<span class="hljs-string">"""  
        根据查询文本，返回最相似的k个文档  
  
        参数:  
            query: 查询文本  
            EmbeddingModel: 用于生成嵌入向量的模型实例  
            k: 返回的相似文档数量，默认为1  
  
        返回:  
            与查询文本最相似的k个文档列表  
        """</span>  
<span class="hljs-comment"># 生成查询文本的向量表示  </span>
        query_vector = EmbeddingModel.get_embedding(query)  
<span class="hljs-comment"># 计算查询向量与所有文档向量的相似度  </span>
        result = np.array([self.get_similarity(query_vector, vector)  
<span class="hljs-keyword">for</span> vector <span class="hljs-keyword">in</span> self.vectors])  
<span class="hljs-comment"># 对相似度排序，取前k个最相似的文档并返回  </span>
<span class="hljs-comment"># argsort()[-k:][::-1] 用于获取相似度最高的k个文档的索引  </span>
<span class="hljs-keyword">return</span> np.array(self.document)[result.argsort()[-k:][::-<span class="hljs-number">1</span>]].tolist()
</code></pre>
<p><strong>4. 生成回答</strong></p>
<p>这段代码实现了基于DeepSeek模型的RAG问答助手，可结合上下文按规则生成回答，包含模型加载与对话示例。为便于扩展，定义了含chat和oad_model法的基类BaseModel，本地开源模型需实现load_model方法。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LLM.py  </span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">from</span> unsloth <span class="hljs-keyword">import</span> FastLanguageModel  
<span class="hljs-comment"># torch2.5版本以下防止unsloth加载出问题  </span>
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> modeling_utils  
ifnot <span class="hljs-built_in">hasattr</span>(modeling_utils, <span class="hljs-string">"ALL_PARALLEL_STYLES"</span>) <span class="hljs-keyword">or</span> modeling_utils.ALL_PARALLEL_STYLES isNone:  
    modeling_utils.ALL_PARALLEL_STYLES = [<span class="hljs-string">"tp"</span>, <span class="hljs-string">"none"</span>,<span class="hljs-string">"colwise"</span>,<span class="hljs-string">'rowwise'</span>]  
  
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv, find_dotenv  
_ = load_dotenv(find_dotenv())  
  
RAG_PROMPT_TEMPLATE=<span class="hljs-string">"""  
  
# 你是一个专业的RAG回答助手  
  
## 可参考的上下文：  
  
{context}  
  
## 请严格按以下规则回答：  
  
1. 必须优先使用上下文信息，禁止主动引入外部知识  
2. 必须对问题和上下文进行理解，而不仅仅是凭借字面意思回答。在提供的上下文中，仔细查找与问题核心直接相关的语句。同时，注意查找能支持推理出答案的信息（例如：因果关系、定义、属性描述、时间顺序、比较关系等）  
3. 回答逻辑：  
   - 若上下文直接包含问题答案：输出答案并引用原文  
   - 若上下文否定问题陈述：回答"不对"并引用原文  
   - 若不能通过上下文回答问题： 回答"上下文未提供相关信息"  
   - 注意代词（它、他、他们、这个、那个）在上下文中的具体指代对象  
4. 输出格式：  
   - 仅用中文回答  
   - 答案应简洁直接，聚焦于回答问题本身  
   - 禁止主观解释  
   - 必须标注引用位置（例：据上下文第X段）  
"""</span>  
  
classBaseModel:  
def__init__(self, model_name) -&gt; <span class="hljs-literal">None</span>:  
        self.model_name = model_name  
  
defchat(self, prompt, history, content) -&gt; <span class="hljs-built_in">str</span>:  
<span class="hljs-keyword">pass</span>  
  
defload_model(self):  
<span class="hljs-keyword">pass</span>  
  
classDeepSeekChat(BaseModel):  
def__init__(self, model_name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"</span>) -&gt; <span class="hljs-literal">None</span>:  
        <span class="hljs-built_in">super</span>().__init__(model_name)  
        self.model, self.tokenizer = self.load_model()  
        self.max_length = <span class="hljs-number">2048</span>  
        self.temperature = <span class="hljs-number">0.1</span>  
  
defload_model(self):  
<span class="hljs-keyword">try</span>:  
<span class="hljs-comment"># 原始模型地址：https://huggingface.co/unsloth/DeepSeek-R1-Distill-Qwen-1.5B  </span>
<span class="hljs-comment"># 1. 利用modelscope库下载模型到本地，然后通过unsloth加载模型  </span>
<span class="hljs-keyword">from</span> modelscope <span class="hljs-keyword">import</span> snapshot_download  
<span class="hljs-comment"># 加载预训练模型 ,利用modelscope库  </span>
            model_name = self.model_name  <span class="hljs-comment"># 假设这是支持分词的模型名称  </span>
<span class="hljs-comment"># 下载模型  </span>
            model_dir = snapshot_download(model_name)  
  
<span class="hljs-comment"># 从huggingface的镜像https://hf-mirror.com/中下载模型到本地  </span>
<span class="hljs-comment"># model_dir= "./DeepSeek-R1-Distill-Qwen-1.5B"  </span>
  
<span class="hljs-comment"># 设置最大序列长度，表示模型在一次前向传递中可以处理的最大令牌数量。  </span>
            max_seq_length = <span class="hljs-number">2048</span>  
  
<span class="hljs-comment"># https://hf-mirror.com/  </span>
<span class="hljs-comment"># 调用FastLanguageModel.from_pretrained()方法加载预训练的模型和对应的Tokenizer（分词器）。  </span>
            model, tokenizer = FastLanguageModel.from_pretrained(  
                model_name = model_dir, <span class="hljs-comment"># 从hf中直接调用：model_name = unsloth/DeepSeek-R1-Distill-Qwen-1.5B  </span>
                max_seq_length = max_seq_length,  <span class="hljs-comment"># 最大序列长度，表示模型在一次前向传递中可以处理的最大令牌数量。  </span>
                dtype = <span class="hljs-literal">None</span>,           <span class="hljs-comment"># 自动检测（BF16或FP16）。BF16范围大，FP16精度高  </span>
                local_files_only=<span class="hljs-literal">True</span><span class="hljs-comment"># 只用本地文件  </span>
            )  
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
<span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"加载 DeepSeek 模型失败"</span>)  
<span class="hljs-keyword">return</span> model, tokenizer  
  
defchat(self, prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>], content: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]) -&gt; <span class="hljs-built_in">str</span>:  
<span class="hljs-comment"># 构建上下文（优化格式）  </span>
        formatted_context = <span class="hljs-string">"\n"</span>.join(  
            [<span class="hljs-string">f"【上下文第<span class="hljs-subst">{idx}</span>段】<span class="hljs-subst">{text}</span>"</span>  
<span class="hljs-keyword">for</span> idx, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(content, <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> text.strip()]  
        )  
  
<span class="hljs-comment"># 构建系统提示  </span>
        system_prompt = RAG_PROMPT_TEMPLATE.<span class="hljs-built_in">format</span>(context=formatted_context.strip())  
  
<span class="hljs-comment"># 构建完整消息队列  </span>
        messages = []  
  
<span class="hljs-comment"># 1. 添加当前系统提示  </span>
        messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_prompt})  
  
<span class="hljs-comment"># 2. 添加历史对话（过滤旧系统消息）  </span>
<span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history:  
<span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] != <span class="hljs-string">"system"</span>:  <span class="hljs-comment"># 过滤历史中的系统消息  </span>
                messages.append(msg)  
  
<span class="hljs-comment"># 3. 添加当前用户问题  </span>
        messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})  
  
<span class="hljs-comment"># 应用对话模板，添加生成引导符  </span>
        inputs = self.tokenizer.apply_chat_template(  
            messages,  
            tokenize=<span class="hljs-literal">False</span>,  
            add_generation_prompt=<span class="hljs-literal">True</span>  
        )  
        inputs = self.tokenizer(inputs, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>).to(<span class="hljs-string">"cuda"</span>)  
        input_length = inputs[<span class="hljs-string">"input_ids"</span>].shape[<span class="hljs-number">1</span>]  <span class="hljs-comment"># 记录输入长度用于截取生成内容  </span>
  
        outputs = self.model.generate(  
            **inputs,  
            max_new_tokens=self.max_length,  
            temperature=self.temperature,  
            pad_token_id=self.tokenizer.eos_token_id         
            )  
  
<span class="hljs-comment"># 只返回新生成的文本（去掉输入提示）  </span>
        generated_tokens = outputs[<span class="hljs-number">0</span>][input_length:]  <span class="hljs-comment"># 直接截取生成的token  </span>
        response = self.tokenizer.decode(generated_tokens, skip_special_tokens=<span class="hljs-literal">True</span>).strip()  
  
<span class="hljs-keyword">return</span> response  
  
<span class="hljs-comment"># 示例：使用 DeepSeekChat 进行对话  </span>
defmain():  
<span class="hljs-comment"># 初始化模型  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在加载 DeepSeek 模型..."</span>)  
    chat_model = DeepSeekChat()  <span class="hljs-comment"># 也可以尝试其他 DeepSeek 模型  </span>
  
<span class="hljs-comment"># 示例上下文，内容为假数据  </span>
    context = [<span class="hljs-string">"""  
    DeepSeek 是深度求索公司开发的大语言模型。  
    当前最新版本是 DeepSeek-V3，知识截止日期为2024年7月。  
    该模型支持最大128K上下文长度，擅长中文和英文任务。  
    """</span>]  
  
<span class="hljs-comment"># 示例对话历史  </span>
    history = [  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的AI助手。"</span>},  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请介绍一下你自己"</span>},  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是基于DeepSeek模型构建的AI助手，很高兴为您服务。"</span>}  
    ]  
  
<span class="hljs-comment"># 第一个问题  </span>
    question1 = <span class="hljs-string">"DeepSeek模型最新版本的知识截止日期是什么？"</span>  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n用户提问: <span class="hljs-subst">{question1}</span>"</span>)  
    response1 = chat_model.chat(question1, history, context)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI回答: <span class="hljs-subst">{response1}</span>"</span>)  
  
<span class="hljs-comment"># 将回答添加到历史记录中  </span>
    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question1})  
    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response1})  
  
<span class="hljs-comment"># 第二个问题（测试历史对话+上下文）  </span>
    question2 = <span class="hljs-string">"它支持最大的上下文长度是多少？"</span><span class="hljs-comment"># "它"指代历史对话中的DeepSeek模型  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n用户提问: <span class="hljs-subst">{question2}</span>"</span>)  
    response2 = chat_model.chat(question2, history, context)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI回答: <span class="hljs-subst">{response2}</span>"</span>)  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    main()
</code></pre>
<p><strong>5. 调用代码</strong></p>
<p>以下代码实现了一个简单RAG系统的调用流程：生成测试文件后，智能加载或新建向量数据库，再通过DeepSeek模型结合检索到的相关上下文与对话历史，依次处理预设问题并生成回答，核心是借助向量检索提升回答准确性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">from</span> Generate <span class="hljs-keyword">import</span> generate_rag_test_files  
<span class="hljs-keyword">from</span> VectorBase <span class="hljs-keyword">import</span> VectorStore  
<span class="hljs-keyword">from</span> Utils <span class="hljs-keyword">import</span> ReadFiles  
<span class="hljs-keyword">from</span> LLM <span class="hljs-keyword">import</span> DeepSeekChat  
<span class="hljs-keyword">from</span> Embeddings <span class="hljs-keyword">import</span> SentenceEmbedding  
  
defmain():  
<span class="hljs-comment"># 生成测试文件  </span>
    folder_name = generate_rag_test_files()  
  
<span class="hljs-comment"># 向量存储路径  </span>
    vector_path = <span class="hljs-string">'storage'</span>  
  
<span class="hljs-comment"># 初始化嵌入模型  </span>
    embedding = SentenceEmbedding()  
  
<span class="hljs-comment"># 智能加载向量存储：存在则加载，否则生成并持久化  </span>
<span class="hljs-keyword">if</span> os.path.exists(vector_path):  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"加载本地向量数据库..."</span>)  
        vector = VectorStore([])  <span class="hljs-comment"># 空文档初始化，后续加载本地数据  </span>
        vector.load_vector(vector_path)  
<span class="hljs-keyword">else</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成新的向量数据库..."</span>)  
<span class="hljs-comment"># 读取并分割文档  </span>
        docs = ReadFiles(folder_name).get_content(max_token_len=<span class="hljs-number">600</span>, cover_content=<span class="hljs-number">150</span>)  
        vector = VectorStore(docs)  
<span class="hljs-comment"># 生成并持久化向量  </span>
        vector.get_vector(EmbeddingModel=embedding)  
        vector.persist(path=vector_path)  
  
<span class="hljs-comment"># 初始化对话模型  </span>
    chat = DeepSeekChat()  
  
<span class="hljs-comment"># 初始化对话历史  </span>
    chat_history = []  
  
<span class="hljs-comment"># 待处理的问题列表  </span>
    questions = [  
<span class="hljs-string">"HelloWorld公司三线城市住宿上限是多少？"</span>,  
<span class="hljs-string">"HelloWorld公司差旅报销在出差结束后20天提交，有什么后果？"</span>,  
<span class="hljs-comment"># "CleanAir X5空气净化器若净化效果下降，怎么解决？",  </span>
<span class="hljs-comment"># "地球自转周期是48小时吗？",  </span>
<span class="hljs-comment"># "太阳系行星距离太阳第四近的是哪个？"  </span>
    ]  
  
<span class="hljs-comment"># 依次处理每个问题，维护对话历史  </span>
<span class="hljs-keyword">for</span> idx, question <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(questions, <span class="hljs-number">1</span>):  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n===== 问题 <span class="hljs-subst">{idx}</span> ====="</span>)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户: <span class="hljs-subst">{question}</span>"</span>)  
  
<span class="hljs-comment"># 检索相关上下文  </span>
        content = vector.query(question, EmbeddingModel=embedding, k=<span class="hljs-number">2</span>)  
  
<span class="hljs-comment"># 调用模型生成回答（传入历史记录）  </span>
        response = chat.chat(question, chat_history, content)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI: <span class="hljs-subst">{response}</span>"</span>)  
  
<span class="hljs-comment"># 更新对话历史  </span>
        chat_history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question})  
        chat_history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    main()
</code></pre>
<h3 data-id="heading-14">3.2 主流开源RAG框架概览</h3>
<p>前文介绍的自建RAG系统更适用于学习与演示场景；而在实际开发过程中，基于成熟的开源框架搭建RAG系统则是更优选择。以下为当前主流的15个开源RAG框架排名及核心特性解析：</p>





















































































































































<table><thead><tr><th>排名</th><th>框架</th><th>核心聚焦</th><th>最佳适用场景</th><th>核心功能</th><th>部署复杂度</th><th>GitHub星标数</th></tr></thead><tbody><tr><td>1</td><td>LangChain</td><td>组件链合</td><td>通用RAG应用</td><td>数据连接、模型灵活性</td><td>中</td><td>105k</td></tr><tr><td>2</td><td>Dify</td><td>可视化开发</td><td>非技术用户、企业</td><td>可视化编辑器、多模型支持</td><td>低</td><td>90.5k</td></tr><tr><td>3</td><td>RAGFlow</td><td>文档处理</td><td>复杂文档handling</td><td>深度文档理解、GraphRAG</td><td>中</td><td>48.5k</td></tr><tr><td>4</td><td>LlamaIndex</td><td>数据索引</td><td>自定义知识源</td><td>灵活连接器、自定义索引</td><td>低</td><td>40.8k</td></tr><tr><td>5</td><td>Milvus</td><td>向量存储</td><td>大规模向量搜索</td><td>高级向量搜索、水平扩展</td><td>中</td><td>33.9k</td></tr><tr><td>6</td><td>mem0</td><td>持久记忆</td><td>需上下文保留的助手</td><td>多级记忆、自动处理</td><td>低</td><td>27.3k</td></tr><tr><td>7</td><td>DSPy</td><td>提示优化</td><td>需自我改进的系统</td><td>自动优化、模块化</td><td>中</td><td>23k</td></tr><tr><td>8</td><td>Haystack</td><td>管道编排</td><td>生产应用</td><td>灵活组件、技术无关</td><td>中</td><td>20.2k</td></tr><tr><td>9</td><td>LightRAG</td><td>性能</td><td>速度关键应用</td><td>简单架构、高效检索</td><td>低</td><td>14.6k</td></tr><tr><td>10</td><td>LLMWare</td><td>资源效率</td><td>边缘/CPU部署</td><td>小型模型、并行解析</td><td>低</td><td>12.7k</td></tr><tr><td>11</td><td>txtai</td><td>一体化解决方案</td><td>简化实现</td><td>嵌入数据库、多模态</td><td>低</td><td>10.7k</td></tr><tr><td>12</td><td>RAGAS</td><td>评估</td><td>RAG系统测试</td><td>客观指标、测试生成</td><td>低</td><td>8.7k</td></tr><tr><td>13</td><td>R2R</td><td>代理式RAG</td><td>复杂查询</td><td>多模态摄入、代理推理</td><td>中</td><td>6.3k</td></tr><tr><td>14</td><td>Ragatouille</td><td>高级检索</td><td>高精度搜索</td><td>晚期交互检索、微调</td><td>中</td><td>3.4k</td></tr><tr><td>15</td><td>FlashRAG</td><td>研究</td><td>实验与基准测试</td><td>预处理数据集、多算法</td><td>中</td><td>2.1k</td></tr></tbody></table>
<p>以上内容参考自：15 Best Open-Source RAG Frameworks in 2025[12]。不同开源RAG框架的核心差异主要体现在技术定位与功能特性上，在进行框架选型时，需结合应用规模、性能指标、开发周期等实际需求综合判断。需要特别强调的是，无论选择何种框架，知识库的质量始终是决定RAG系统效果的核心因素。</p>
<p>具体选型建议如下：</p>
<ul>
<li>若以易用性为优先考量：推荐Dify、LlamaIndex、mem0、LightRAG、txtai</li>
<li>针对文档密集型应用：优先考虑RAGFlow、LLMWare</li>
<li>面向大规模生产部署：适合选择Milvus、Haystack、LangChain</li>
<li>硬件资源受限场景：优先选用LLMWare、LightRAG</li>
<li>存在复杂推理需求的场景：建议探索R2R、DSPy</li>
<li>需进行系统评估的场景：推荐使用RAGAS</li>
<li>研究与实验场景：适合选择FlashRAG</li>
</ul>
<hr/>
<h3 data-id="heading-15">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG实践指南：一文搞定大模型RAG过程]]></title>    <link>https://juejin.cn/post/7585920796100657179</link>    <guid>https://juejin.cn/post/7585920796100657179</guid>    <pubDate>2025-12-22T03:58:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100657179" data-draft-id="7585920796100640795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG实践指南：一文搞定大模型RAG过程"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-22T03:58:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG实践指南：一文搞定大模型RAG过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:58:49.000Z" title="Mon Dec 22 2025 03:58:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<h2 data-id="heading-0"><strong>RAG是什么？</strong></h2>
<p><strong>RAG（Retrieval-Augmented Generation，检索增强生成）</strong> , 一种AI框架，将传统的信息检索系统(例如数据库)的优势与生成式大语言模型(LLM)的功能结合在一起。不再依赖LLM训练时的固有知识，而是在回答问题前，先从外部资料库中“翻书”找资料，基于这些资料生成更准确的答案。</p>
<p>RAG技术核心缓解大模型落地应用的几个关键问题：</p>
<ul>
<li><strong>知识新鲜度</strong>：大模型突破模型训练数据的时间限制</li>
<li><strong>幻觉问题</strong>：降低生成答案的虚构概率，提供参照来源</li>
<li><strong>信息安全</strong>：通过外挂知识库而不是内部训练数据，减少隐私泄露</li>
<li><strong>垂直领域知识</strong>：无需训练直接整合垂直领域知识</li>
</ul>
<p><strong>RAG核心流程</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77afaa25fe4943f5927219aef16e3128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=iTkOV3hhkqco7ucMwRVc%2B8abfNI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2.1 知识准备阶段</h2>
<h4 data-id="heading-2">2.1.1 数据预处理</h4>
<h4 data-id="heading-3">a. 文档解析</h4>
<p><strong>输入</strong>：原始文档（如Markdown/PDF/HTML）</p>
<p><strong>操作</strong>：</p>
<ul>
<li>提取纯文本（如解析Markdown标题、段落）</li>
<li>处理特殊格式（如代码块、表格、图片、视频等）</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[标题]</span> 什么是 ROMA？
<span class="hljs-selector-attr">[段落]</span> ROMA 是一个全自主研发的前端开发基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)，一份代码，可在iOS、Android、Harmony、Web四端运行的跨平台解决方案。
<span class="hljs-selector-attr">[段落]</span> ROMA 框架的中文名为罗码。
<span class="hljs-selector-attr">[标题]</span> 今天天气
<span class="hljs-selector-attr">[列表项]</span> 今天的室外温度为<span class="hljs-number">35</span>°C，天气晴朗。
</code></pre>
<h5 data-id="heading-4"><strong>文档的解析过程需要考虑不同文档内容例如文本、图片、表格等场景，以及文档的语言，布局情况，可以考虑使用一些优秀的三方工具或者一些视觉模型，布局分析模型，语义理解模型来辅助解析。</strong></h5>
<h5 data-id="heading-5"><strong>b. 数据清洗与标准化处理</strong></h5>
<p>提升文本质量和一致性，使向量表示更准确，从而增强检索相关性和LLM回答质量；同时消除噪声和不规则格式，确保系统能正确理解和处理文档内容。包括: </p>
<ul>
<li>去除特殊字符、标签、乱码、重复内容。</li>
<li>文本标准化，例如 时间、单位标准化（如“今天” → “2025-07-17”）。</li>
<li>其他处理</li>
</ul>
<p>数据的清洗和标准化过程可以使用一些工具或<strong>NLTK、spaCy</strong>等NLP工具进行处理。</p>
<p>例如: </p>
<pre><code class="hljs language-bash" lang="bash">&lt;p&gt;ROMA框架&lt;/p&gt;
处理：
<span class="hljs-string">"ROMA框架"</span>
今天的室外温度为35°C，天气晴朗。
处理：
<span class="hljs-string">"2025-07-17 的室外温度为35°C，天气晴朗"</span>
</code></pre>
<p>c. 元数据提取</p>
<p>关于数据的数据，用于描述和提供有关数据的附加信息。</p>
<ul>
<li><strong>文档来源</strong>：文档的出处，例如URL、文件名、数据库记录等。</li>
<li><strong>创建时间</strong>：文档的创建或更新时间。</li>
<li><strong>作者信息</strong>：文档的作者或编辑者。</li>
<li><strong>文档类型</strong>：文档的类型，如新闻文章、学术论文、博客等。</li>
</ul>
<p>元数据在RAG中也非常重要，不仅提供了额外的上下文信息，还能提升检索质量：</p>
<ol>
<li><strong>检索增强</strong></li>
</ol>
<ul>
<li>精准过滤：按时间、作者、主题等缩小搜索范围</li>
<li>相关性提升：结合向量相似度和元数据特征提高检索准确性</li>
</ul>
<p>ii. 上下文丰富</p>
<ul>
<li>来源标注：提供文档来源、作者、发布日期等信息</li>
<li>文档关系：展示文档间的层级或引用关系</li>
</ul>
<p>iii. 常见的元数据提取方式:</p>
<ul>
<li>正则/HTML/... 等解析工具，提取标题、作者、日期等</li>
<li>自然语言处理: 使用NLP技术（如命名实体识别、关键词提取）从文档内容中提取元数据，如人名、地名、组织名、关键词等</li>
<li>机器学习模型:  训练机器学习模型来自动提取元数据</li>
<li>通过调用外部API（如Google Scholar API、Wikipedia API）获取文档的元数据</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">complete_metadata_chunk1 = {
<span class="hljs-string">'file_path'</span>: <span class="hljs-string">'/mydocs/roma_intro.md'</span>,
<span class="hljs-string">'file_name'</span>: <span class="hljs-string">'roma_intro.md'</span>,
<span class="hljs-string">'chunk_id'</span>: 0,
<span class="hljs-string">'section_title'</span>: <span class="hljs-string">'# 什么是 ROMA？'</span>,
<span class="hljs-string">'subsection_title'</span>: <span class="hljs-string">''</span>,
<span class="hljs-string">'section_type'</span>: <span class="hljs-string">'section'</span>,
<span class="hljs-string">'chunking_strategy'</span>: 3,
<span class="hljs-string">'content_type'</span>: <span class="hljs-string">'product_description'</span>,
<span class="hljs-string">'main_entity'</span>: <span class="hljs-string">'ROMA'</span>,
<span class="hljs-string">'language'</span>: <span class="hljs-string">'zh-CN'</span>,
<span class="hljs-string">'creation_date'</span>: <span class="hljs-string">'2025-07-02'</span>,  <span class="hljs-comment"># 从文件系统获取</span>
<span class="hljs-string">'word_count'</span>: 42  <span class="hljs-comment"># 计算得出,</span>
<span class="hljs-string">'topics'</span>: [<span class="hljs-string">'ROMA'</span>, <span class="hljs-string">'前端框架'</span>, <span class="hljs-string">'跨平台开发'</span>],
<span class="hljs-string">'entities'</span>: {
<span class="hljs-string">'products'</span>: [<span class="hljs-string">'ROMA'</span>, <span class="hljs-string">'Jue语言'</span>], <span class="hljs-comment"># 实体识别</span>
<span class="hljs-string">'platforms'</span>: [<span class="hljs-string">'iOS'</span>, <span class="hljs-string">'Android'</span>, <span class="hljs-string">'Web'</span>]
},
}
</code></pre>
<h4 data-id="heading-6">2.1.2 内容分块(Chunking)</h4>
<p>在RAG架构中，分块既是核心，也是挑战，它直接影响检索精度、生成质量，需要在检索精度、语境完整性和计算性能之间取得平衡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca9df08e1a047bbb20cd8cf9d5e09e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=%2Ff5qw79v4IgksDvgiSHT82amS8I%3D" alt="" loading="lazy"/></p>
<p>内容分块将长文档切分成小块，可以解决向量模型的token长度限制，使RAG更精确定位相关信息，提升检索精度和计算效率。</p>
<ul>
<li>AutoBots(JoyAgent)功能分块：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2e1bbf0f064702b64ba20593815329~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=aAjaqAE4LGImYEJJPuMDT1XeBHI%3D" alt="" loading="lazy"/></p>
<p>实际RAG框架中按照文档的特性选择合适的分块策略进行分块。</p>
<ul>
<li>
<h5 data-id="heading-7">常见的分块策略：</h5>
</li>
</ul>
<p><strong>a. 按大小分块</strong></p>
<p>按固定字符数进行分块，实现简单但可能切断语义单元。</p>
<p>优点：实现简单且计算开销小，块大小均匀便于管理。</p>
<p><strong>缺点</strong>：可能切断语义单元，如句子或段落被分到不同块中。</p>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">第一段：# ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)。
一份代码，可在iOS、Android、Harmony
第二段：、Web三端运行的跨平台解决方案。ROMA框架的中文名为罗码。
</code></pre>
<p>句子被截断，"一份代码，可在iOS、Android、Harmony" 和 "、Web三端运行的跨平台解决方案" 被分到不同块，影响理解。</p>
<p>b. 按段落分块</p>
<p>以段落为基本单位进行分块，保持段落完整性，但段落长度可能差异很大。</p>
<p><strong>优点</strong>：尊重文档自然结构，保留完整语义单元。</p>
<p><strong>缺点</strong>：段落长度差异大，可能导致块大小不均衡。</p>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">第一段：<span class="hljs-comment"># ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义DSL(Jue语言)。</span>
一份代码，可在iOS、Android、Harmony、Web三端运行的跨平台解决方案。ROMA框架的中文名为罗码。
第二段：<span class="hljs-comment"># 核心特性1. 跨平台：一套代码运行于多端2. 高性能：接近原生的性能表现3. 可扩展：丰富的插件系统</span>
</code></pre>
<p>第一段包含标题和多行内容，而其他段落相对较短，可能导致检索不均衡。</p>
<p><strong>c. 按语义分块</strong></p>
<p>基于文本语义相似度进行动态分块，保持语义连贯性，但计算开销大。</p>
<p><strong>说明</strong>：基于文本语义相似度动态调整分块边界。</p>
<p><strong>优点</strong>：保持语义连贯性，能识别内容主题边界。</p>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">第一段：<span class="hljs-comment"># ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义DSL(Jue语言)。</span>
一份代码，可在iOS、Android、Harmony、Web四端运行的跨平台解决方案。
第二段：ROMA框架的中文名为罗码。
<span class="hljs-comment">## 核心特性1. 跨平台：一套代码运行于多端</span>
</code></pre>
<p>使用依赖模型质量，相同文本在不同运行中可能产生不同分块结果。</p>
<p><strong>d. 分块策略总结</strong></p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d8e50d5b2845f3bb68027ec0270090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=i5q2elWGV7Sr3hxOt1YKwyyFJSY%3D" alt="" loading="lazy"/></strong></p>
<p><strong>e. 优化方式</strong></p>
<ul>
<li><strong>混合分块策略</strong></li>
</ul>
<p>结合多种分块方法的优点，如先按段落分块，再根据块大小调整，做到既保持语义完整性，又能控制块大小均匀</p>
<ul>
<li>优化重叠区域</li>
</ul>
<p>根据内容特性动态调整块之间的重叠区域大小，关键信息出现在多个块中，提高检索召回率</p>
<h5 data-id="heading-8"><strong>f. 常用的分块工具</strong></h5>
<ul>
<li><strong>Lang Chain框架</strong>：提供多种分块策略，包括RecursiveCharacterTextSplitter、MarkdownTextSplitter等</li>
<li><strong>NLTK</strong>：用于基于自然语言句子的分块</li>
<li><strong>spaCy</strong>：提供语言学感知的文本分割</li>
</ul>
<h4 data-id="heading-9">2.1.3 向量化</h4>
<p>将高维文本数据压缩到低维空间，便于处理和存储。将文本转换为计算机可以理解的数值，使得计算机能够理解和处理语义信息，从而在海量数据文本中实现快速、高效的相似度计算和检索。</p>
<p>简单理解：通过一组数字来代表文本内容的“本质”。</p>
<p>例如，“ROMA是一个跨平台解决方案...”这句话可能被转换为一个384维的向量：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[块1]</span> 什么是ROMA？
ROMA是一个全自主研发的前端开发框架，基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)...
<span class="hljs-selector-attr">[{<span class="hljs-string">"chunk_id"</span>: <span class="hljs-string">"doc1_chunk1"</span>,<span class="hljs-string">"text"</span>: <span class="hljs-string">"# 什么是 ROMA？\nROMA 是一个全自主研发的前端开发基于自定义DSL(Jue语言)，一份代码，可在iOS、Android、Harmony、Web端运行的跨平台解决方案。"</span>,<span class="hljs-string">"vector"</span>: [0.041, -0.018, 0.063, ..., 0.027]</span>,
"metadata": {
"source": <span class="hljs-string">"roma_introduction.md"</span>,
<span class="hljs-string">"position"</span>: <span class="hljs-number">0</span>,
<span class="hljs-string">"title"</span>: <span class="hljs-string">"ROMA框架介绍"</span>
}
},
<span class="hljs-comment">// 更多文档块...</span>
]
</code></pre>
<ul>
<li><strong>常用的Embedding模型：</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49b17a48baec40a386bc5e9eddc89dd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=HyRwgbb0Z%2BltqJSPQl7AMv24%2Fg8%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-10"/>
<h4 data-id="heading-11"><strong>2.1.4 向量数据库入库</strong></h4>
<p>将生成的向量数据和元数据进行存储，同时创建索引结构来支持快速相似性搜索。</p>
<ul>
<li><strong>常用的向量数据库包括：</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1e98e85a42240f298306e1e8be66efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=QXr85eJQIrEbQSauR6AJemfnbqY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.2 问答阶段</h3>
<h3 data-id="heading-13">2.2.1 查询预处理</h3>
<ul>
<li>
<h3 data-id="heading-14">意图识别：使用分类模型区分问题类型（事实查询、建议、闲聊等）。</h3>
</li>
<li>
<h3 data-id="heading-15">问题预处理：问题内容清洗和标准化，过程与前面数据预处理类似。</h3>
</li>
<li>
<h3 data-id="heading-16">查询增强：使用知识库或LLM生成同义词（如“动态化” → “Roma”），上下文补全可以结合历史会话总结（例如用户之前问过“Roma是什么”）。</h3>
</li>
</ul>
<h4 data-id="heading-17"><strong>2.2.2 数据检索(召回)</strong></h4>
<h4 data-id="heading-18"><strong>a. 向量化</strong></h4>
<p>使用与入库前数据向量化相同的模型，将处理后的问题内容向量化。</p>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">问题: <span class="hljs-string">"ROMA是什么?"</span>
处理后
{
"vector": [<span class="hljs-number">0.052</span>, -<span class="hljs-number">0.021</span>, <span class="hljs-number">0.075</span>, ..., <span class="hljs-number">0.033</span>],
<span class="hljs-string">"top_k"</span>: <span class="hljs-number">3</span>,
<span class="hljs-string">"score_threshold"</span>: <span class="hljs-number">0.8</span>,
<span class="hljs-string">"filter"</span>: {"doc_type": <span class="hljs-string">"技术文档"</span>}
}
</code></pre>
<h5 data-id="heading-19"><strong>b. 检索</strong></h5>
<ul>
<li>相似度检索：查询向量与所存储的向量最相似(通过余弦相似度匹配)的前 top_k 个文档块。</li>
<li>关键词检索：倒排索引的传统方法,检索包含“Roma”、“优势”等精确关键词的文档。</li>
<li>混合检索：合并上面多种检索结果，效果最优。</li>
</ul>
<p>例如：检索“ROMA是什么?”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8507791f9d7e465baa630696eeaeab63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=XHBPEWzm5Qxfs1Qywlz37aTN1Ys%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-20"><strong>c. 重排序(Reranking)</strong></h5>
<p>初步检索在精度和语义理解上的不足，通过更精细的上下文分析提升结果相关性。它能更好处理同义词替换、一词多义等语义细微差异，使最终结果准确。</p>
<ul>
<li>原理：使用模型对每个检索结果计算相关性分数。</li>
<li>归一化：重排序模型原始输出分数没有固定的范围，它可能是任意实数，将结果归一化处理，将分数映射到 [0, 1] 范围内，使其更容易与向量相似度分数进行比较。</li>
</ul>
<p>例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7edad535c0942678b7403740b1d8876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=AlUML6Pn%2BV1n5p84JW6MtPdrPDk%3D" alt="" loading="lazy"/></p>
<ul>
<li>常用的重排序模型：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bd66d6756f34e6284f39d99a59a4106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=E4nZM4Ry7EfTDxruh8G2SpsPSM0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21"><strong>2.2.3 信息整合</strong></h4>
<p>格式化检索的结果，构建提示词模板，同时将搜索的内容截断或摘要长文本以适应LLM上下文窗口token。</p>
<p>提示词优化：</p>
<ol>
<li>限定回答范围</li>
<li>要求标注来源</li>
<li>设置拒绝回答规则</li>
<li>...</li>
</ol>
<p>例如：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">prompt</span> 模板：
你是一名<span class="hljs-selector-tag">ROMA</span>框架专家，请基于以下上下文回答：
参考信息:
<span class="hljs-selector-attr">[文档1]</span> 什么是 <span class="hljs-selector-tag">ROMA</span>？
<span class="hljs-selector-tag">ROMA</span> 是一个全自主研发的前端开发基于自定义<span class="hljs-selector-tag">DSL</span>(Jue语言)，一份代码，可在<span class="hljs-selector-tag">iOS</span>、<span class="hljs-selector-tag">Android</span>、<span class="hljs-selector-tag">Harmony</span>、<span class="hljs-selector-tag">Web</span>四端运行的跨平台解决方案。
<span class="hljs-selector-tag">ROMA</span> 框架的中文名为罗码。
<span class="hljs-selector-attr">[文档2]</span> <span class="hljs-selector-tag">Roma</span>介绍？
<span class="hljs-selector-attr">[Roma介绍]</span>(docs/guide/guide/introduction.md)
文档地址: <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//roma-design.jd.com/docs/guide/guide/introduction.html</span>
要求：
<span class="hljs-number">1</span>. 分步骤说明，含代码示例
<span class="hljs-number">2</span>. 标注来源文档版本
<span class="hljs-number">3</span>. 如果参考信息中没有相关内容，请直接说明无法回答，不要编造信息
请基于以下参考信息回答用户的问题。如果参考信息中没有相关内容，请直接说明无法回答，不要编造信息。
用户问题: <span class="hljs-selector-tag">ROMA</span>是什么？
回答: {<span class="hljs-selector-tag">answer</span>}
</code></pre>
<h4 data-id="heading-22"><strong>2.2.4 LLM生成</strong></h4>
<p>向LLM（如GPT-4、Claude）发送提示，获取生成结果。</p>
<ul>
<li>AutoBots(JoyAgent)示例：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4a819d3c165478db42301782cdcd42e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=b6dqJn%2FQqhBs00o%2BiQBGlPLzVmM%3D" alt="" loading="lazy"/></p>
<p>以上，实现了最简单的RAG流程。实际的RAG过程会比上述麻烦更多，包括图片、表格等多模态内容的处理，更复杂的文本解析和预处理过程，文档格式的兼容，结构化与非结构化数据的兼容等等。</p>
<p>最后，展示一下RAG各阶段的优化方式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448a68ba3ccf40b1b2cfd0f34880f184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=dycYOqrUNMnDkw9JdDEYlsG9sbc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-23">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生功能狂飙，15 个热门 npm 包要失业了]]></title>    <link>https://juejin.cn/post/7586192313635389474</link>    <guid>https://juejin.cn/post/7586192313635389474</guid>    <pubDate>2025-12-22T04:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635389474" data-draft-id="7586136543954812966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生功能狂飙，15 个热门 npm 包要失业了"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-22T04:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生功能狂飙，15 个热门 npm 包要失业了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:00:10.000Z" title="Mon Dec 22 2025 04:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p>之前装个 Node.js 项目，npm 包能装一大堆。</p>
<p>现在发现很多包其实不用装了，Node.js 自己就支持。</p>
<p>这次整理了 15 个已经被 Node.js 原生功能替代的热门 npm 包。</p>
<p>有些已经稳定了，有些还在实验阶段，但都能用起来了。</p>
<h2 data-id="heading-0">fetch 终于成全局函数了</h2>
<p>以前在 Node.js 里用 fetch，必须装 node-fetch。</p>
<p>现在 Node.js 18 开始，fetch 已经是全局函数了，和浏览器里的用法完全一样。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.github.com/repos/nodejs/node"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">full_name</span>);
</code></pre>
<p>直接就能用，不用装任何包。</p>
<p>Node.js 17.5 开始实验性支持，到 18 就稳定了。</p>
<p>如果你的项目还在用 Node.js 18 之前的版本，那还是得装 node-fetch。</p>
<h2 data-id="heading-1">WebSocket 也原生支持了</h2>
<p>之前做 WebSocket 客户端，基本都用 ws 这个包。</p>
<p>现在 Node.js 有了全局的 WebSocket 类。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">"wss://echo.websocket.org"</span>);

ws.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">"Hello!"</span>);
ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received:"</span>, event.<span class="hljs-property">data</span>);
</code></pre>
<p>Node.js 21 加的，不过还是实验性的。</p>
<p>要注意的是，这只是客户端支持。</p>
<p>如果要做 WebSocket 服务端，还是得用 ws 或者其他库。</p>
<h2 data-id="heading-2">测试框架不用装了</h2>
<p>以前写测试，要装 mocha、jest 这些框架。</p>
<p>现在 Node.js 自带测试模块 node:test。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert"</span>;

<span class="hljs-title function_">test</span>(<span class="hljs-string">"addition works"</span>, <span class="hljs-function">() =&gt;</span> {
  assert.<span class="hljs-title function_">strictEqual</span>(<span class="hljs-number">2</span> + <span class="hljs-number">2</span>, <span class="hljs-number">4</span>);
});
</code></pre>
<p>Node.js 18 加的实验性功能，到 20 就稳定了。</p>
<p>如果需要快照测试、mock 这些高级功能，第三方框架还是更强。</p>
<p>不过对于模块级别的测试，node:test 完全够用了。</p>
<h2 data-id="heading-3">SQLite 也要原生支持了</h2>
<p>之前用 SQLite，要装 sqlite3 或 better-sqlite3。</p>
<p>这俩包都需要编译原生模块，升级 Node.js 版本经常出问题。</p>
<p>现在 Node.js 在开发 node:sqlite 模块。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { open } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:sqlite"</span>;

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">":memory:"</span>);
<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"CREATE TABLE users (id INTEGER, name TEXT)"</span>);
</code></pre>
<p>不过还是实验性的，等稳定了就能彻底告别编译问题了。</p>
<h2 data-id="heading-4">控制台彩色输出不用装 chalk 了</h2>
<p>给控制台输出加颜色，以前都用 chalk 或 kleur。</p>
<p>现在 Node.js 有 util.styleText 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { styleText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>(<span class="hljs-string">"red"</span>, <span class="hljs-string">"Error!"</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>([<span class="hljs-string">"bold"</span>, <span class="hljs-string">"green"</span>], <span class="hljs-string">"Success!"</span>));
</code></pre>
<p>Node.js 20.12 加的，到 22.17 就稳定了。</p>
<p>如果需要复杂的主题配置或链式调用，chalk 还是更好用。</p>
<p>但简单的颜色输出，原生的就够了。</p>
<h2 data-id="heading-5">清理 ANSI 码也不用装包了</h2>
<p>以前要去掉日志里的 ANSI 转义码，得装 strip-ansi。</p>
<p>现在有 util.stripVTControlCharacters 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { stripVTControlCharacters } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">"\u001B[4mUnderlined\u001B[0m"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">stripVTControlCharacters</span>(text));
</code></pre>
<p>原生处理，稳定可靠。</p>
<p>基本不需要再装第三方包了。</p>
<h2 data-id="heading-6">glob 匹配文件也原生了</h2>
<p>匹配文件路径，以前必须用 glob 包。</p>
<p>Node.js 22 开始有 fs.glob 函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"**/*.js"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(files);
</code></pre>
<p>22 版本就稳定了，可以放心用。</p>
<p>老项目还在用旧版本 Node.js 的话，还是得继续用 glob 包。</p>
<h2 data-id="heading-7">递归删除目录不用 rimraf 了</h2>
<p>删除整个目录树，以前都用 rimraf。</p>
<p>现在 fs.rm 直接支持递归删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">"dist"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 12.10 就有了，现在所有 LTS 版本都稳定支持。</p>
<h2 data-id="heading-8">递归创建目录也不用 mkdir 了</h2>
<p>创建多级目录，以前要装 mkdir。</p>
<p>现在 fs.mkdir 原生支持。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">"logs/app"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 10.12 就加了，早就稳定了。</p>
<h2 data-id="heading-9">UUID 生成不用装包了</h2>
<p>生成 UUID v4，以前要装 uuid 包。</p>
<p>现在 crypto 模块自带 randomUUID 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">randomUUID</span>());
</code></pre>
<p>Node.js 14.17 就有了，稳定版本。</p>
<h2 data-id="heading-10">Base64 编解码也原生支持了</h2>
<p>以前要 polyfill atob 和 btoa 函数。</p>
<p>现在这俩已经是全局函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> encoded = <span class="hljs-title function_">btoa</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(encoded);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">atob</span>(encoded));
</code></pre>
<p>Buffer 一直都有，现在加上 atob 和 btoa，浏览器和 Node.js 的代码终于统一了。</p>
<p>Node.js 20 左右加的，现在 LTS 版本都有。</p>
<h2 data-id="heading-11">URL 路由匹配有了 URLPattern</h2>
<p>做路由匹配，以前要装 url-pattern。</p>
<p>现在有全局的 URLPattern API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/users/:id"</span> });
<span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"/users/42"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">pathname</span>.<span class="hljs-property">groups</span>.<span class="hljs-property">id</span>);
</code></pre>
<p>Node.js 20 加的，不过还是实验性的。</p>
<p>但已经能用了，而且和浏览器的 URLPattern 完全一样。</p>
<h2 data-id="heading-12">加载 .env 文件不一定要 dotenv 了</h2>
<p>之前加载环境变量文件，必须装 dotenv。</p>
<p>现在可以用 --env-file 参数。</p>
<pre><code class="hljs language-ini" lang="ini">node <span class="hljs-attr">--env-file</span>=.env app.js
</code></pre>
<p>Node.js 20.10 加的实验性功能。</p>
<p>如果需要变量展开或多文件支持，dotenv 还是更强。</p>
<p>但简单场景下，原生的就够了。</p>
<h2 data-id="heading-13">EventTarget 也是全局的了</h2>
<p>以前 Node.js 只有 EventEmitter，要用 Web 标准的 EventTarget 得装 event-target-shim。</p>
<p>现在 EventTarget 已经是全局的了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventTarget</span>();
target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"ping"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"pong"</span>));
target.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"ping"</span>));
</code></pre>
<p>Node.js 15 加的，15.4 就稳定了。</p>
<p>浏览器和 Node.js 终于可以用同样的事件 API 了。</p>
<h2 data-id="heading-14">运行 TypeScript 不一定要 tsc 了</h2>
<p>以前运行 .ts 文件，要装 TypeScript 编译器或 ts-node。</p>
<p>现在 Node.js 有实验性的 TypeScript 支持。</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--experimental-strip-types</span> app<span class="hljs-selector-class">.ts</span>
</code></pre>
<p>Node.js 21 加的实验性功能。</p>
<p>不过这只是去掉类型标注，不做类型检查。</p>
<p>生产环境还是得用完整的 TypeScript 工具链。</p>
<h2 data-id="heading-15">为啥 Node.js 要把这些功能内置</h2>
<p>看这些变化，能发现一个趋势。</p>
<p>以前需要外部依赖的功能，现在越来越多变成了核心功能。</p>
<p>这样做有几个好处。</p>
<p>减少依赖数量，项目更轻量。</p>
<p>降低供应链攻击风险，不用担心某个包被投毒。</p>
<p>代码在浏览器和服务端之间更容易移植。</p>
<h2 data-id="heading-16">能用就用起来</h2>
<p>这些原生功能，浏览器支持好的就可以直接用了。</p>
<p>实验性的功能可以在开发环境先试试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理]]></title>    <link>https://juejin.cn/post/7585798113547829298</link>    <guid>https://juejin.cn/post/7585798113547829298</guid>    <pubDate>2025-12-22T02:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547829298" data-draft-id="7450771973871091724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理"/> <meta itemprop="keywords" content="Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:42.000Z" title="Mon Dec 22 2025 02:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在继续搭建 <strong>NestJS</strong> 和 <strong>Hono.js</strong> 的通用框架之前，可以先回顾一下前几篇文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 NestJS 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">NestJS / Hono.js 一起学！Hono 的设计思想</a></li>
<li><a href="https://juejin.cn/post/7581448482544713754" target="_blank" title="https://juejin.cn/post/7581448482544713754">NestJS / Hono.js 一起学！开发前必备</a></li>
<li><a href="https://juejin.cn/post/7583727768543199268" target="_blank" title="https://juejin.cn/post/7583727768543199268">NestJS / Hono.js 一起学！字节团队如何配置多环境攻略</a></li>
</ul>
<p>本篇文章主要实现 <strong>NestJS 与 Hono.js</strong> 的以下功能：</p>
<ol>
<li><strong>打印日志 &amp; 收集日志</strong></li>
<li><strong>统一返回前端的数据格式</strong></li>
<li><strong>统一错误处理</strong></li>
</ol>
<p>这些功能在很多 NestJS 教程中都有覆盖，但我们会在此基础上做一些增强：</p>
<ul>
<li>
<p><strong>日志打印增加 <code>traceId</code> 功能</strong></p>
<ul>
<li>在 Node.js 高并发场景下，<strong>每个请求的 traceId 必须独立</strong>，因为它是<strong>单线程异步</strong>模型，如果我们像写传统同步代码那样直接定义一个全局变量来存 <code>traceId</code>，就会发生严重的“串号”现象。</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<p>假设我们有一个 Web 服务，同时收到两个用户请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> traceId; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">user</span>) {
  traceId = <span class="hljs-string">`trace-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>; <span class="hljs-comment">// 给当前请求生成 traceId</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 开始处理 <span class="hljs-subst">${user}</span> 的请求`</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 异步操作，可能晚于其他请求执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 完成处理 <span class="hljs-subst">${user}</span> 的请求`</span>);
  }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟两个用户几乎同时发起请求</span>
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Bob'</span>);
</code></pre>
<p><strong>可能的输出（串号）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">trace-532</span>] 开始处理 Alice 的请求
[<span class="hljs-meta">trace-764</span>] 开始处理 Bob 的请求
[<span class="hljs-meta">trace-764</span>] 完成处理 Alice 的请求   ← 错误，日志 traceId 被覆盖，因为全局目前的 traceId 已经是 trace<span class="hljs-number">-764</span> 了
[<span class="hljs-meta">trace-764</span>] 完成处理 Bob 的请求
</code></pre>
<p>以上的问题有些笨办法可以处理，但我们最终会借助 node.js AsyncLocalStorage（在 nest.js 有对应模块，简单实现，在 hono.js 中我们自己封装一个类似功能的模块。）</p>
<p>还有一个必须了解的，这个 traceId 是服务端必须有的，因为我们的处理一个用户请求会经过很多中间件很多不同的模块处理，如何判断经过这么多模块的某个请求是同一个请求，就要用这个 traceId 来记录。</p>
<ul>
<li>
<p><strong>统一返回前端的数据格式</strong>，例如，我们希望所有接口返回：</p>
<pre><code class="hljs language-css" lang="css">```
{
  "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>,
  <span class="hljs-string">"data"</span>: {...},
  "message": <span class="hljs-string">"success"</span>
}
```
</code></pre>
<ul>
<li><strong>可选配置</strong>：某些路由可以跳过统一格式返回。</li>
</ul>
</li>
</ul>
<hr/>
<p>接下来，我们将先从 nest.js 框架开始，逐步实现这些功能。</p>
<h2 data-id="heading-1">nest.js 配置</h2>
<h3 data-id="heading-2">链路日志追踪功能</h3>
<p>这套系统的灵魂在于 <code>nestjs-cls</code> 和 <code>Winston</code> 的结合。</p>
<p>为什么要这么做？</p>
<p>在 Node.js 异步环境中，传统的全局变量无法区分哪个日志属于哪个用户请求。</p>
<ul>
<li><strong>ClsModule (上下文存储)</strong> ：就像给每个进站的乘客（请求）发一个专属的“透明信封”。这个信封里装着 <code>traceId</code>。</li>
<li><strong>Winston (记录员)</strong> ：当程序需要记录日志时，记录员会从这个“信封”里掏出 <code>traceId</code> 盖在日志条目上。</li>
</ul>
<p>这样，即便服务器同时处理 1000 个请求，你只需要在日志里搜索特定的 <code>traceId</code>，就能看到该请求从“进入”到“报错”的所有心路历程。</p>
<hr/>
<h3 data-id="heading-3">代码功能深度拆解</h3>
<p>我们将代码逻辑分为三个核心模块来理解：</p>
<h4 data-id="heading-4">第一部分：CLS 上下文初始化 (AppModule)</h4>
<p>这是全链路追踪的起点。在根 module 配置，也就是 app.module.ts中增加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 之前文章讲的环境变量配置模块</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局可用，无需在每个模块导入</span>
      <span class="hljs-attr">load</span>: [initConfig], <span class="hljs-comment">// 使用自定义加载器</span>
    }),
    <span class="hljs-comment">// 1. 初始化 CLS 上下文，并自动生成 traceId</span>
    <span class="hljs-title class_">ClsModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">middleware</span>: {
        <span class="hljs-attr">mount</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">generateId</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">idGenerator</span>: <span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span></span>) =&gt;</span>
          (req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) ?? <span class="hljs-title function_">randomUUID</span>(), <span class="hljs-comment">// 优先使用 header 中的 ID</span>
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>这里我们简单说下 ClsModule 实现的基本原理：</p>
<p>我们分三步来实现：</p>
<ul>
<li>第一步：封装 ALS 工具类</li>
</ul>
<p>这是我们的“储物柜”管理器。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'async_hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsService</span> {
  <span class="hljs-comment">// 1. 创建一个物理存储对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;();

  <span class="hljs-comment">// 2. 启动上下文（包裹请求）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">run</span>(store, callback);
  }

  <span class="hljs-comment">// 3. 存储数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (store) store.<span class="hljs-title function_">set</span>(key, value);
  }

  <span class="hljs-comment">// 4. 获取数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">return</span> store?.<span class="hljs-title function_">get</span>(key);
  }
}
</code></pre>
<ul>
<li>编写中间件 (Middleware)</li>
</ul>
<p>在 NestJS 中，中间件是请求进来的第一站，我们在这里“开启”储物柜。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.middleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cls.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-comment">// 关键点：将后续所有的逻辑（next）都运行在 MyClsService.run 的回调里</span>
    <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> traceId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] || <span class="hljs-title function_">randomUUID</span>();
      <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'traceId'</span>, traceId); <span class="hljs-comment">// 存入 traceId</span>
      <span class="hljs-title function_">next</span>();
    });
  }
}
</code></pre>
<p>这个中间件添加之后，意味着所有的请求都会有一个 traceId 值，那在其它地方如何调用呢？请看</p>
<ul>
<li>第三步：在任何地方使用</li>
</ul>
<p>由于 <code>AsyncLocalStorage</code> 跟踪的是异步调用栈，你不再需要通过参数传递 <code>traceId</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// any.service.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyService</span> {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 像变魔术一样，直接拿！</span>
    <span class="hljs-keyword">const</span> traceId = <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'traceId'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[当前任务] TraceID 是: <span class="hljs-subst">${traceId}</span>`</span>);
  }
}
</code></pre>
<p>我们接着讲日志功能，</p>
<h3 data-id="heading-5">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<h3 data-id="heading-6">第三部分：异步注入 (WinstonModule.forRootAsync)</h3>
<p>这是 NestJS 的高级用法，确保日志配置是在获取到系统配置（ConfigService）之后才生成的。</p>
<p>在 app.module.ts 中增加 winston配置</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WinstonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { winstonConfigFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/logger'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
     <span class="hljs-comment">// ... 其它配置</span>
    <span class="hljs-comment">// 2. 注入 Winston</span>
    <span class="hljs-comment">// 3. 使用 forRootAsync 异步加载配置</span>
    <span class="hljs-title class_">WinstonModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>], <span class="hljs-comment">// 导入 ConfigModule 以便使用 ConfigService</span>
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>], <span class="hljs-comment">// 注入 ConfigService</span>
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用我们抽离出去的配置函数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">winstonConfigFactory</span>(configService);
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>其中  winstonConfigFactory 的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> winston, { transports, format } <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { utilities <span class="hljs-keyword">as</span> nestWinstonModuleUtilities } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsServiceManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>, <span class="hljs-variable constant_">DIR_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/config/constants'</span>;

<span class="hljs-comment">// 保持之前的 format 定义不变</span>
<span class="hljs-keyword">const</span> appendRequestId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cls = <span class="hljs-title class_">ClsServiceManager</span>.<span class="hljs-title function_">getClsService</span>();
  <span class="hljs-keyword">const</span> traceId = cls?.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'traceId'</span>);
  <span class="hljs-keyword">if</span> (traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">// 核心修改：导出一个 Factory 函数，而不是静态对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">winstonConfigFactory</span> = (<span class="hljs-params">configService: ConfigService</span>) =&gt; {
  <span class="hljs-comment">// 1. 从 ConfigService 获取配置，提供默认值</span>
  <span class="hljs-keyword">const</span> logDir = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-variable constant_">DIR_NAME</span>, <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>);
  <span class="hljs-keyword">const</span> isProduction = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'NODE_ENV'</span>) === <span class="hljs-string">'production'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">transports</span>: isProduction
      ? [
          <span class="hljs-comment">// 2. 定义 DailyRotateFile (使用动态路径)</span>
          <span class="hljs-comment">// 错误日志按天滚动，保留 14 天，每个文件最大 20MB</span>
          <span class="hljs-comment">// 仍然把错误打印到控制台（k8s / docker 日志）</span>
          <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">info: any</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> trace = info.<span class="hljs-property">traceId</span> ? <span class="hljs-string">` [trace:<span class="hljs-subst">${info.traceId}</span>]`</span> : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${info.timestamp}</span> <span class="hljs-subst">${info.level}</span><span class="hljs-subst">${trace}</span>: <span class="hljs-subst">${info.message}</span>`</span>;
              }),
            ),
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">dirname</span>: logDir, <span class="hljs-comment">// &lt;--- 这里使用了配置中的路径</span>
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              <span class="hljs-title function_">appendRequestId</span>(),
              format.<span class="hljs-title function_">timestamp</span>(),
              format.<span class="hljs-title function_">json</span>(),
            ),
          }),
        ]
      : [
          <span class="hljs-comment">// 3. 定义 Console Transport</span>
          <span class="hljs-comment">// 开发环境通常只需要 Console，也可以按需加 File</span>
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">timestamp</span>(),
              nestWinstonModuleUtilities.<span class="hljs-property">format</span>.<span class="hljs-title function_">nestLike</span>(<span class="hljs-string">'MyApp'</span>, {
                <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">prettyPrint</span>: <span class="hljs-literal">true</span>,
              }),
            ),
          }),
        ],
  };
};
</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<p>为了让这套系统更完美，在实际应用中，你可以这样使用：</p>
<h3 data-id="heading-7">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>这里使用 <code>this.logger.log</code> 的时候，你不需要手动去取 ID，因为我们在 <code>winstonConfigFactory</code> 里的 <code>appendRequestId</code> 已经自动处理了。所以会自带 traceId 属性在日志里。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AppService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一条带有 traceId 的业务日志！'</span>); 
    <span class="hljs-comment">// 输出结果会自动带上: {"traceId":"...", "message":"...", "timestamp":"..."}</span>
  }
}
</code></pre>
<p>接下来实现第二个功能，将返回前端的格式统一</p>
<h3 data-id="heading-8">统一返回格式</h3>
<p>统一格式，在 nest.js 中有拦截器实现（hono.js就没有拦截器的概念），很简单：</p>
<h4 data-id="heading-9">nest.js 统一返回格式：用拦截器实现标准响应结构</h4>
<p>在前后端分离的业务架构中，<strong>统一接口返回格式</strong>已成为标配：<br/>
无论后端返回什么，都应该在一层标准的格式中输出，例如：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {...},
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>这样做有几个直接收益：</p>
<ol>
<li>前端更容易做异常和展示逻辑，不需要每个接口单独处理。</li>
<li>服务端可以统一标记 traceId，方便链路排查问题。</li>
<li>协议一致后，可快速扩展错误码体系。</li>
</ol>
<p>在 nest.js 中，我们可以使用 <strong>Interceptors（拦截器）</strong> 来完成这一目标。下面是一段完整的拦截器代码。</p>
<h4 data-id="heading-10">拦截器核心代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">CallHandler</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorCodes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StandardResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  traceId?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardResponseInterceptor</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span>&lt;
  T,
  <span class="hljs-title class_">StandardResponse</span>&lt;T&gt;
&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cls: ClsService</span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-params">context: ExecutionContext, next: CallHandler</span>) {
    <span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">getType</span>() !== <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'skip_transform'</span>, handler)) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> ({
        <span class="hljs-attr">code</span>: <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SUCCESS</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'OK'</span>,
        data,
        traceId,
      })),
    );
  }
}
</code></pre>
<p>说明：</p>
<ul>
<li>ClsService 用于获取当前请求的 traceId</li>
<li>map() 包裹所有返回内容</li>
<li>拦截器只在 HTTP 请求上执行（GraphQL、Microservice 可以忽略）</li>
<li>可通过自定义 Decorator 跳过包装</li>
</ul>
<h4 data-id="heading-11">如何注册拦截器（全局启用）</h4>
<p>在 <code>main.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardResponseInterceptor</span>(app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>)));
</code></pre>
<p>这样所有路由默认都统一格式输出。</p>
<h4 data-id="heading-12">某些接口不想被统一格式怎么办？</h4>
<p>例如导出文件等特殊接口，不希望包裹。</p>
<p>你可以加自定义装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">SkipTransform</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-string">'skip_transform'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-meta">@SkipTransform</span>()
<span class="hljs-title function_">getCaptcha</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> someRawBinary;
}
</code></pre>
<p>当前路由会跳过统一包裹。</p>
<h4 data-id="heading-13">实际效果展示</h4>
<p>原本控制器返回：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Tom'</span> };
}
</code></pre>
<p>最终前端收到：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h2 data-id="heading-14">通用错误处理</h2>
<p>在后端系统中，错误处理往往经历三个阶段：</p>
<ol>
<li>能跑（框架兜底）</li>
<li>能返回（让前端知道错哪里）</li>
<li>能排障（日志链路、定位效率）</li>
</ol>
<p>nestjs 的 <code>ExceptionFilter</code> 为第三阶段提供了完整治理能力。本节通过自定义 <code>AllExceptionsFilter</code>，从“拦截错误”开始，一层层增强错误输出、业务语义、日志能力和 traceId 支持。</p>
<h3 data-id="heading-15">第一层：拦截所有异常，而不是依赖框架默认行为</h3>
<p>默认情况下，框架会尝试处理异常，但格式、内容和处理方式不可控。<br/>
通过 <code>@Catch()</code> 拦截全场景错误，我们将接管所有异常通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
</code></pre>
<p>借助 <code>ArgumentsHost</code>，我们拿到 HTTP 请求上下文，后续就能构造专属响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
<span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
<span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
</code></pre>
<p>此时的目标是“掌控入口”。</p>
<h3 data-id="heading-16">第二层：区分 HTTP 状态码，让协议正确表达成功或失败</h3>
<p>框架层能力拦截之后，下一层诉求是协议语义正确。<br/>
对客户端返回的 HTTP Status 必须准确，否则代理、浏览器、监控系统均无法判断请求情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> httpStatus =
  exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
    ? exception.<span class="hljs-title function_">getStatus</span>()
    : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;
</code></pre>
<p>简单讲：</p>
<ul>
<li>可预期的业务错误维持 4xx</li>
<li>其它错误不想让前端知道具体错误，直接返回  <code>INTERNAL_SERVER_ERROR</code>。</li>
</ul>
<p>这实现了“系统对外的协议治理”。</p>
<h3 data-id="heading-17">第三层：建立业务错误码体系，与协议语义解耦</h3>
<p>HTTP Status 永远不适合作为业务判断依据。<br/>
因此体系化项目会分离“协议错误码”和“业务错误码”。这一步实现业务语义治理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">businessCode</span>: <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">400</span> &amp;&amp; httpStatus &lt; <span class="hljs-number">500</span>) {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">BUSINESS_ERROR</span>;
} <span class="hljs-keyword">else</span> {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SYSTEM_ERROR</span>;
}
</code></pre>
<p>从此，前端不再需要看 400/500 决策，而是看业务码 1000/5000 做逻辑分支(如果需要有业务错误码的话，一般可以不加业务状态码)。</p>
<h3 data-id="heading-18">第四层：控制返回给用户的 message，不泄漏内部实现</h3>
<p>继续向下走，我们需要控制“用户可见信息”。</p>
<p>对于 <code>HttpException</code>，返回异常信息安全可控；<br/>
而普通异常有堆栈、内部错误，不可直给客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>) {
  <span class="hljs-keyword">const</span> exceptionResponse = exception.<span class="hljs-title function_">getResponse</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  userMessage = exceptionResponse.<span class="hljs-property">message</span> || exception.<span class="hljs-property">message</span>;
} <span class="hljs-keyword">else</span> {
  userMessage = <span class="hljs-string">'Server Internal Error'</span>;
}
</code></pre>
<h3 data-id="heading-19">第五层：注入 traceId，将错误纳入链路追踪体系</h3>
<p>协议治理与安全治理之后，我们需要可观测性。<br/>
依赖 <code>ClsService</code> 获取 traceId，使任意异常都能与一次请求绑定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();
</code></pre>
<p>这让后续日志检索有了线索，从“出错”变为“定位在哪个请求出错”。</p>
<hr/>
<h3 data-id="heading-20">第六层：构造统一错误返回体，让前端接收结构稳定</h3>
<p>业务响应格式统一之后，客户端解析与 UI 逻辑才能标准化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: businessCode,
  <span class="hljs-attr">message</span>: userMessage,
  traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    httpStatus,
  },
};
</code></pre>
<p>这一层，从“不固定字段”变为“返回契约统一”。</p>
<hr/>
<h3 data-id="heading-21">第七层：按严重程度结构化日志，结合 traceId 可查可追</h3>
<p>有了 traceId 后，日志才具备上下文意义。<br/>
对非预期错误记录堆栈并升为 <code>error</code>，对客户端调用错误降级为 <code>warn</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: (exception <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">stack</span>,
    traceId,
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    traceId,
  });
}
</code></pre>
<p>此处是“日志治理 + 可观测性治理”。</p>
<hr/>
<h3 data-id="heading-22">第八层：保持 HTTP 状态原样返回，确保协议链路正常识别</h3>
<p>最终输出必须保留协议语义，否则监控、负载均衡、浏览器都将错误判断请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">response.<span class="hljs-title function_">status</span>(httpStatus).<span class="hljs-title function_">json</span>(finalClientResponse);
</code></pre>
<p>接下来就可以在 main.ts 中使用这个全局错误管理器了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AllExceptionsFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/filters/http-exception.filter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">LoggerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>, {
    <span class="hljs-attr">bufferLogs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 先缓存日志，直到 Logger 替换完成</span>
  });

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);

  <span class="hljs-comment">// 1. 替换 Nest 默认 Logger 为 Winston</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">LoggerService</span> = app.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">WINSTON_MODULE_NEST_PROVIDER</span>);

  app.<span class="hljs-title function_">useLogger</span>(logger);

  <span class="hljs-comment">// 获取 CLS 服务实例</span>
  <span class="hljs-keyword">const</span> clsService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>);

  <span class="hljs-comment">// 4. 注册全局异常过滤器：捕获所有异常并打印日志 + 返回统一结构</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(clsService, logger));

  <span class="hljs-keyword">const</span> port = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'port'</span>) ?? <span class="hljs-number">3000</span>;

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server on :<span class="hljs-subst">${port}</span>`</span>);
  });
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-23">honojs 配置</h2>
<h3 data-id="heading-24">第一部分：链路日志追踪功能</h3>
<p>首先我们封装记录 traceId 的功能，我们通过编写一个中间件来实现，这个中间件是所有请求过来，经过的第一步，这样所有请求就带了 traceId，具体实现如下：</p>
<p>首先我们要创建一个 AsyncLocalStorage 实例，让后续的中间件调用其 run 方法，为每个请求创建独立的上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:async_hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestContext</span> {
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 初始化全局存储</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;();

<span class="hljs-comment">// 封装一个获取 traceId 的快捷方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTraceId = (): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> store = ctx.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">traceId</span>;
};

</code></pre>
<p>以下是 middleware 的实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/factory"</span>;
<span class="hljs-keyword">import</span> { ctx } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>; <span class="hljs-comment">// 导入您的 ctx</span>

<span class="hljs-comment">// 确保在 Node.js 环境下使用</span>
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> traceMiddleware = <span class="hljs-title function_">createMiddleware</span>(<span class="hljs-keyword">async</span> (c, next) =&gt; {
  <span class="hljs-comment">// 1. 生成唯一的 Trace ID</span>
    <span class="hljs-keyword">const</span> traceId = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">"x-request-id"</span>) || <span class="hljs-title function_">randomUUID</span>();

  <span class="hljs-comment">// 2. 将 Trace ID 存储在 AsyncLocalStorage 中，并运行后续的处理链</span>
  <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">run</span>({ traceId }, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 3. (可选) 记录请求开始日志</span>
    <span class="hljs-comment">// logger.info(`Request started: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// 4. 继续处理链</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// 5. (可选) 设置响应头</span>
    c.<span class="hljs-property">res</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Trace-ID"</span>, traceId);

    <span class="hljs-comment">// // 6. (可选) 记录请求结束日志</span>
    <span class="hljs-comment">// logger.info(`Request finished: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">//   status: c.res.status,</span>
    <span class="hljs-comment">// });</span>
  });
});
</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>主要代码就是 ctx.run({ traceId }, async () =&gt; { xxx }), 将后所有内容，包含在 AsyncLocalStorage 上下文中，也就是 traceId 会伴随整个请求的生命周期。</p>
<h3 data-id="heading-25">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<p>以上的功能，我们封装到一个 logger.ts 中，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { format, transports, createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"winston"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"winston-daily-rotate-file"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PROD_ENV</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../constant"</span>;

<span class="hljs-comment">// 1. 自定义 Format：自动从 ALS 获取 Trace ID</span>
<span class="hljs-keyword">const</span> appendTraceId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-comment">// 使用 ctx.getStore() 获得</span>
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
  <span class="hljs-keyword">if</span> (!traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">/// 2. 基础配置</span>
<span class="hljs-keyword">const</span> logFormat = format.<span class="hljs-title function_">combine</span>(
  <span class="hljs-title function_">appendTraceId</span>(),
  format.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> }),
  format.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }), <span class="hljs-comment">// 自动捕获 error stack</span>
  format.<span class="hljs-title function_">json</span>()
);

<span class="hljs-keyword">const</span> devTransport = <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
  <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
    format.<span class="hljs-title function_">colorize</span>(),
    format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
      <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
      <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
    })
  ),
});

<span class="hljs-comment">// 导出 Logger 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>:
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-variable constant_">PROD_ENV</span>
      ? <span class="hljs-comment">// 生产环境 Transports</span>
        [
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">filename</span>: <span class="hljs-string">"logs/error-%DATE%.log"</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">"YYYY-MM-DD"</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">"20m"</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">"14d"</span>,
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">colorize</span>(),
              format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
                <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
                <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
              })
            ),
          }),
        ]
      : <span class="hljs-comment">// 开发环境 Transport</span>
        [devTransport],
});

</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<h3 data-id="heading-26">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>如下，我们就可以在路由中使用 logger 功能，就会自带 traceId 了</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common/logger"</span>;
<span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/users"</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理 /users 请求"</span>);

  <span class="hljs-keyword">const</span> list = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> }];

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`查询用户数量=<span class="hljs-subst">${list.length}</span>`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, { list });
});
</code></pre>
<p>访问结果输出（示例）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">开始处理</span> <span class="hljs-string">/users</span> <span class="hljs-string">请求</span>
<span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">查询用户数量=1</span>
</code></pre>
<h3 data-id="heading-27">在 hono.js 中封装统一返回格式</h3>
<p>与 nest.js 不同，hono.js 没有 <strong>Interceptor</strong> 的概念，因此无法在框架层自动包装所有路由的返回值。hono 更偏向极简设计：框架提供 Context（<code>c</code>）与响应方法（如 <code>c.json()</code>），开发者通过 middleware 或工具函数扩展能力。</p>
<p>在这种模式下，一个常见策略是：<strong>在 utils 层封装一个标准响应函数</strong>，每当路由处理完成业务逻辑后，调用该函数输出标准格式。示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/response.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CODES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/codes"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUCCESS_MESSAGE</span> = <span class="hljs-string">"OK"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> standardResponse = &lt;T&gt;(
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">data</span>: T,
  <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span> = <span class="hljs-number">200</span>
): <span class="hljs-function"><span class="hljs-params">Response</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">CODES</span>.<span class="hljs-property">SUCCESS</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-variable constant_">SUCCESS_MESSAGE</span>,
    data,
    traceId,
  };
  
   <span class="hljs-comment">// 使用 c.json() 返回 Response</span>
  <span class="hljs-comment">// c.json() 负责设置 Content-Type: application/json</span>
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalResponse, httpStatus);
};
</code></pre>
<p>这一函数实现了几个能力：</p>
<ol>
<li><strong>统一业务结构</strong>：code / message / data 统一格式化。</li>
<li><strong>链路可观测性</strong>：自动从 ALS 中获取 traceId，可跨路由跟踪调用链路。</li>
<li><strong>控制协议行为</strong>：可指定 HTTP status，而不影响业务 code。</li>
<li><strong>无框架侵入性</strong>：不需要全局 patch，路由自由决定是否使用。</li>
</ol>
<p>实际使用方式非常直接：在路由处理函数中调用该函数包裹输出即可：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/response"</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/user"</span>, <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> };
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, user);
});
</code></pre>
<p>输出结构：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h3 data-id="heading-28">错误处理</h3>
<p>hono.js 并没有 nest.js 中那样的 exception（异常）处理器，但 hono 官方提供了两个方法来处理全局异常。</p>
<ul>
<li>Error Handling 回调函数</li>
<li>Not Found 回调函数</li>
</ul>
<p>其中 <code>app.onError</code> 允许我们处理未捕获的错误并返回自定义响应。例如</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();
app.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err, c</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err}</span>`</span>);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">text</span>(<span class="hljs-string">"Custom Error Message"</span>, <span class="hljs-number">500</span>);
});
</code></pre>
<p>接下来我们实现一个生产级别的全局错误处理函数，代替上面的 onError 中的函数：</p>
<h4 data-id="heading-29">阶段一：只实现兜底，确保不会爆栈到框架</h4>
<p>目标：任何异常都返回 500，避免框架直接输出默认错误页面。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(
    {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Internal Server Error"</span>,
    },
    <span class="hljs-number">500</span>,
  );
};
</code></pre>
<p>此阶段的函数虽然简陋，但实现了基本“拦截能力”。技术人员可以理解到：不允许异常直接泄漏给框架。</p>
<h4 data-id="heading-30">阶段二：支持错误分类（业务可控错误 vs 系统错误）</h4>
<p>需求出现：业务层需要显式抛出 4xx，不应该全部变成 500。因此我们引入 Hono 的 HTTPException。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> httpStatus = <span class="hljs-number">500</span>;
  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"Internal Server Error"</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    message = exception.<span class="hljs-property">message</span>;
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ message }, httpStatus);
};
</code></pre>
<p>团队到此能看到两个差异：</p>
<ul>
<li>不再一刀切地用 500</li>
<li>支持框架级错误语义</li>
</ul>
<h4 data-id="heading-31">阶段三：支持普通 Error，并提取堆栈</h4>
<p>当后端代码抛出 Error 对象时，我们不希望把内部堆栈暴露给客户端，但日志需要保留：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  httpStatus = <span class="hljs-number">500</span>;
  message = exception.<span class="hljs-property">message</span>;
  stack = exception.<span class="hljs-property">stack</span>;
}
</code></pre>
<p>与第二阶段结合后，代码局部已经具备三类来源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
  <span class="hljs-comment">// 合法业务错误</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  <span class="hljs-comment">// 非预期系统错误</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 字符串或其他类型，兜底转字符串</span>
}
</code></pre>
<p>这一阶段解决“所有类型异常都能进入统一通路”。</p>
<h4 data-id="heading-32">阶段四：对外 Message 安全脱敏</h4>
<p>生产会提出安全要求：500 段错误不能暴露内部 message。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userMessage =
  httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;
</code></pre>
<h4 data-id="heading-33">阶段五：加入 Trace ID，实现可观测能力</h4>
<p>在前几阶段之后，团队开始发现：仅凭日志很难定位请求调用链。因此引入 Trace ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;

<span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
</code></pre>
<p>并将其放入响应，用于 API 与日志上下游联动。</p>
<h4 data-id="heading-34">阶段六：构建统一响应协议</h4>
<p>现在错误信息、trace 信息都有了，我们需要形成一致返回结构，便于前端或 API 网关解析：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">message</span>: userMessage,
  <span class="hljs-attr">traceId</span>: traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
    <span class="hljs-attr">httpStatus</span>: httpStatus,
  },
};
</code></pre>
<p>这样可以回复格式统一的响应。</p>
<h4 data-id="heading-35">阶段七：结构化日志分级输出</h4>
<p>生产要求日志可检索、可告警，因此需要按状态区分 error 与 warn，并携带堆栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: exceptionStack,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
} <span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
}
</code></pre>
<p>团队能看到：</p>
<ul>
<li>500+ 是告警级别</li>
<li>4xx 只是用户请求问题，不污染告警系统</li>
</ul>
<h4 data-id="heading-36">阶段八：最终闭环，按状态返回响应</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
</code></pre>
<p>请求闭环如下：</p>
<ol>
<li>识别异常</li>
<li>分类</li>
<li>安全脱敏</li>
<li>绑定 Trace</li>
<li>构建协议</li>
<li>结构化日志</li>
<li>返回状态码与响应体</li>
</ol>
<p>最终成果（合并段落）即为我们起初提供的完整生产代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"../logger"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Internal Server Error"</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionStack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = <span class="hljs-title class_">String</span>(exception);
  }

  <span class="hljs-keyword">const</span> userMessage =
    httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;

  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalClientResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>: userMessage,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
      <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
      <span class="hljs-attr">httpStatus</span>: httpStatus,
    },
  };

  <span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">stack</span>: exceptionStack,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  } <span class="hljs-keyword">else</span> {
    logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
};
</code></pre>
<p>接下来我们来处理全局捕获的 404 回调，也就是自定义 Not Found Response, 个人感觉生产环境就简单返回 404 状态码就足够了，所以函数定义如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">notFoundHandler</span> = (<span class="hljs-params">c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span> }, <span class="hljs-number">404</span>);
};
</code></pre>
<h2 data-id="heading-37">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析]]></title>    <link>https://juejin.cn/post/7585948869844746275</link>    <guid>https://juejin.cn/post/7585948869844746275</guid>    <pubDate>2025-12-22T02:14:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844746275" data-draft-id="7585888537641762831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-22T02:14:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:31.000Z" title="Mon Dec 22 2025 02:14:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当今视觉追踪领域，一项全新任务正引发学术界和工业界的关注。这项被称为「无人机对抗无人机」的挑战将追踪技术的难度推向了全新高度。</p>
<p>近期，来自香港科技大学（广州）、上海交通大学、中山大学、中国科学院信息工程研究所和云从科技的联合团队发布了题为《How Far are Modern Trackers from UAV-Anti-UAV? A Million-Scale Benchmark and New Baseline》的突破性研究。</p>
<p>这项研究不仅仅提出了新的任务范式，更是构建了<strong>一个百万级规模的基准数据集</strong>，并对现有50种先进追踪器进行了全面测评，结果令人震惊。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68829052a96c4406ae709ada68f3356a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=qZTBVb7uRqPVl4s3s9js0%2BwH0Oo%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2512.07385" target="_blank" title="https://arxiv.org/pdf/2512.07385" ref="nofollow noopener noreferrer">arxiv.org/pdf/2512.07…</a></strong></p>
<p><strong>项目地址：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F983632847%2FAwesome-Multimodal-Object-Tracking" target="_blank" title="https://github.com/983632847/Awesome-Multimodal-Object-Tracking" ref="nofollow noopener noreferrer">github.com/983632847/A…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>无人机追踪新篇章：从“空地对抗”到“空战”</strong></h2>
<p>当前的无人机相关追踪研究主要分为两种模式。第一种是无人机追踪地面目标，如车辆或行人，此时追踪平台动态但目标相对静止。</p>
<p>另一种是地面摄像头追踪空中无人机，目标动态而观测平台静止。</p>
<p>这两种模式都无法模拟真实的空中对抗环境——当一架无人机需要追击另一架无人机时，双方都处于高速、剧烈的运动中。</p>
<p>研究团队将这种双向动态干扰称为“dual-dynamic disturbances”，它导致了视角急剧变化、背景快速移动和目标运动模糊等一系列复杂问题。</p>
<p>这正是UAV-Anti-UAV任务的核心挑战所在。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c97ba5b71846cca733922ad0f2b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=B%2FgfRPS0xuGENo1hkDDavNH9SFs%3D" alt="图片2.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>百万级基准：打造真实世界的空中战</strong></h2>
<p>为了推动这一新兴领域的发展，研究团队从零构建了一个超大规模、高质量标注的数据集。</p>
<p>这个数据集包含 1810个视频序列，总计105万标注帧，涵盖了固定翼、多旋翼、垂直起降、FPV无人机和无人直升机等五种目标无人机类型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9726a836f4d4cfaa902ed92ce116d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=3VTVyf%2F3d%2FugsoDNnhrR%2FUZgQYw%3D" alt="图片3.png" loading="lazy"/></p>
<p>与UAV123、Anti-UAV318等现有基准相比，新数据集不仅在规模上遥遥领先，更在多个维度上实现了突破：</p>
<ul>
<li>多模态创新：首次为每个视频序列提供简洁的自然语言描述，为视觉-语言多模态追踪开辟了新途径；</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62834470f9164395955db8afcc30772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=TkkX0kqy5%2BQzLggJ0i0fmJvUtEI%3D" alt="图片4.png" loading="lazy"/></p>
<ul>
<li>极端挑战性：数据集标注了15种高难度追踪属性，如快速运动、光照变化和相似干扰物等。数据分析显示，新数据集在光照变化范围和目标相对速度上比现有基准更为“极端”，更贴近真实复杂环境；</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52870b36678c411bb6f26f75b7a7716c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=FfSip5BM2Fccn0h8qdLpRf%2BP1xY%3D" alt="图片5.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7652c94003a94beeb44064558f9c6987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Euydw%2FgIvVcIdyvNrQRDxH7K0Yk%3D" alt="图片6.png" loading="lazy"/></p>
<p align="left"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629b28c2f6a541ac8c9f90f2449f82fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=C36bJcHEf2%2F9EFPoZOJwwJ5LnyE%3D" alt="图片7.png" loading="lazy"/></p>
<ul>
<li>真实场景覆盖：数据采集自多样化真实环境，确保算法在实际应用中的鲁棒性。</li>
</ul>
<p><strong>目前Coovally官网已有Vistrone等权威无人机开源数据集免费为用户提供，并且还有可直接部署应用于大疆无人机的算法模型，无需重新修改部署转换</strong>，具体文章可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247490614%26idx%3D2%26sn%3D4cdaf1278f908fc12877d8aa26de6211%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247490614&amp;idx=2&amp;sn=4cdaf1278f908fc12877d8aa26de6211&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">VisDrone数据集，专为无人机视觉任务打造</a></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994fd8b13bf64e88a3790ab8a2b892e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=t6dbHdwgJpKsPPgLMwv4tVVtoh4%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<h2 data-id="heading-2"><strong>MambaSTS：时空语义融合的追踪新框架</strong></h2>
<p>面对这一高难度任务，研究团队提出了MambaSTS——一种专为时空语义集成学习设计的新框架。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ab660f94b5416495b3507836eb1990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=luQKPXckHhVRA3ypU9fTFmobzaI%3D" alt="图片8.png" loading="lazy"/></p>
<p>MambaSTS的核心创新在于巧妙地结合了Transformer和Mamba两大架构的优势：</p>
<ul>
<li>Transformer提供强大的全局空间建模能力，提取丰富的视觉特征；</li>
<li>Mamba以线性复杂度高效处理长序列数据，建立视频帧间的长期上下文关系。</li>
</ul>
<p>具体实现中，模型将模板图像、搜索图像和语言描述作为多模态输入。设计了一个“时间令牌传播”机制，可视为一个“记忆单元”。</p>
<p>这个单元持续收集和压缩过去帧中关于目标的关键信息（如外观、运动状态），然后将这份“记忆”传递给当前帧的处理过程。</p>
<p>即使目标在某一瞬间被完全遮挡或因高速运动而变得模糊，模型依然能依靠长期记忆保持对目标的稳定认知。最终，统一的时空语义网络将这些信息深度融合，通过无锚框追踪头预测目标的精确位置。</p>
<h2 data-id="heading-3"><strong>实验结果：现有追踪器在“空战”中全面溃败</strong></h2>
<p>研究团队对50种当前最先进的追踪器进行了全面评估，结果令人深思：现有方法在UAV-Anti-UAV任务上表现普遍不足。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074358b325904be7934f23d0270efdf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Jfd6DKIs45gU0K7Rqm7WDfEuLqI%3D" alt="图片9.png" loading="lazy"/></p>
<p>从整体性能曲线看，大部分追踪器的成功率（Success/AUC）都处于较低水平。而论文提出的MambaSTS基线模型凭借其出色的时空建模能力，取得了43.7%的AUC得分，显著领先于其他方法。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9510fcea629b4d659d265d2ecc363d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=rxEuHQQS%2BaXcm92gUF5H9OItbt0%3D" alt="图片10.png" loading="lazy"/></p>
<p>分析不同追踪属性下的表现发现，现有追踪器在处理光照剧烈变化、相似物体干扰、运动模糊和完全遮挡等挑战时尤其力不从心。</p>
<p>消融实验充分证明了MambaSTS各个组件的有效性。从强大的基线模型OSTrack（AUC 27.8%）开始，通过逐步加入时间建模、空间建模和语义建模模块，性能最终提升至43.7%，相对涨幅超过57%，效果显著。</p>
<h2 data-id="heading-4"><strong>意义与展望</strong></h2>
<p>这项研究的价值不仅在于技术突破，更在于它为低空经济安全提供了关键技术支撑。随着无人机在物流、巡检、娱乐等领域的广泛应用，如何防止无人机滥用、保障低空安全已成为迫在眉睫的问题。</p>
<p>UAV-Anti-UAV技术有望应用于无人机拦截、禁飞区防护、重要设施保护等场景，成为低空安全的“智能守护者”。</p>
<p>从学术角度看，这项研究开辟了视觉追踪的新方向，挑战了现有算法的极限，推动了多模态、长时序理解等技术的发展。</p>
<p>随着低空经济的蓬勃发展，无人机对抗无人机的技术将成为保障安全的关键屏障。这项研究不仅提出了挑战，更指明了方向——在这个全新的“空战”时代，视觉追踪技术必须迎接更复杂、更动态、更真实的考验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot自动配置：为什么你的应用能“开箱即用]]></title>    <link>https://juejin.cn/post/7585839411122913326</link>    <guid>https://juejin.cn/post/7585839411122913326</guid>    <pubDate>2025-12-22T02:11:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122913326" data-draft-id="7585897699602808858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot自动配置：为什么你的应用能“开箱即用"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:11:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot自动配置：为什么你的应用能“开箱即用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:11:21.000Z" title="Mon Dec 22 2025 02:11:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《SpringBoot自动配置：为什么你的应用能“开箱即用」？》</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小坏。</p>
</blockquote>
<p><strong>可以关注公众号：小坏说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>你是否曾经好奇，为什么创建一个SpringBoot应用只需要几行代码，就能自动获得Web服务器、数据库连接、安全配置等功能？今天我们就来揭开SpringBoot最核心的特性——自动配置的神秘面纱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看一个经典对比：</p>
<p><strong>传统Spring MVC项目</strong>：需要配置web.xml、DispatcherServlet、视图解析器、数据源等数十个配置项。</p>
<p><strong>SpringBoot项目</strong>：只需要一个main方法加上<code>@SpringBootApplication</code>注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 就是这么简单！</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(MyApplication.class, args);
    }
}
</code></pre>
<h3 data-id="heading-2">一、@SpringBootApplication的三重魔法</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>这个看似简单的注解，实际上是一个<strong>复合注解</strong>，包含了三个核心注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@SpringBootConfiguration</span>
<span class="hljs-meta">@EnableAutoConfiguration</span>
<span class="hljs-meta">@ComponentScan(excludeFilters = { 
    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
    @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) 
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootApplication {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>让我们逐一解析这三个核心注解的作用：</p>
<h4 data-id="heading-3">1. @SpringBootConfiguration</h4>
<p>这是<code>@Configuration</code>的特化版本，表明这个类是一个配置类。它允许我们在同一个类中定义Bean。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 等价于传统的@Configuration</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h4 data-id="heading-4">2. @ComponentScan</h4>
<p>这个注解告诉Spring在哪些包下扫描组件（@Component、@Service、@Controller等）。默认扫描的是<strong>当前包及其子包</strong>。</p>
<h4 data-id="heading-5">3. @EnableAutoConfiguration（重点！）</h4>
<p>这是自动配置的<strong>核心开关</strong>。让我们看看它的源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@AutoConfigurationPackage</span>
<span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>关键点在于<code>@Import(AutoConfigurationImportSelector.class)</code>，这个类负责加载所有自动配置类。</p>
<h3 data-id="heading-6">二、自动配置的加载机制</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. spring.factories文件的作用</h4>
<p>SpringBoot启动时，<code>AutoConfigurationImportSelector</code>会读取<code>META-INF/spring.factories</code>文件，这个文件在spring-boot-autoconfigure包中：</p>
<pre><code class="hljs language-properties" lang="properties"># 文件位置: spring-boot-autoconfigure-2.7.x.jar!/META-INF/spring.factories

# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\
org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\
# ... 上百个自动配置类
</code></pre>
<p>目前SpringBoot 2.7.x版本中，这个文件列出了<strong>140多个自动配置类</strong>！这就是SpringBoot"开箱即用"能力的来源。</p>
<h4 data-id="heading-8">2. 按需加载机制</h4>
<p>你可能会担心：加载这么多配置类，不会影响启动速度吗？</p>
<p>实际上，SpringBoot使用了<strong>条件化配置</strong>机制。每个自动配置类都有各种<code>@ConditionalOnXxx</code>注解，只有在条件满足时才会生效。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 条件1：类路径下有DataSource类</span>
<span class="hljs-meta">@ConditionalOnClass(DataSource.class)</span>
<span class="hljs-comment">// 条件2：有DataSource类型的Bean</span>
<span class="hljs-meta">@ConditionalOnBean(DataSource.class)</span>
<span class="hljs-comment">// 条件3：配置了spring.datasource属性</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.datasource", name = "url")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-comment">// 条件4：不存在DataSource类型的Bean时才创建</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(DataSource.class)</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">(DataSourceProperties properties)</span> {
        <span class="hljs-keyword">return</span> properties.initializeDataSourceBuilder().build();
    }
}
</code></pre>
<h3 data-id="heading-9">三、条件注解详解</h3>
<p>SpringBoot提供了一系列条件注解，让我们看看最常用的几个：</p>













































<table><thead><tr><th>条件注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>@ConditionalOnClass</td><td>类路径下存在指定类时生效</td><td><code>@ConditionalOnClass(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnMissingClass</td><td>类路径下不存在指定类时生效</td><td><code>@ConditionalOnMissingClass("javax.servlet.Servlet")</code></td></tr><tr><td>@ConditionalOnBean</td><td>容器中存在指定Bean时生效</td><td><code>@ConditionalOnBean(DataSource.class)</code></td></tr><tr><td>@ConditionalOnMissingBean</td><td>容器中不存在指定Bean时生效</td><td><code>@ConditionalOnMissingBean(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnProperty</td><td>配置文件中存在指定属性时生效</td><td><code>@ConditionalOnProperty(prefix="redis", name="enabled")</code></td></tr><tr><td>@ConditionalOnWebApplication</td><td>是Web应用时生效</td><td><code>@ConditionalOnWebApplication</code></td></tr><tr><td>@ConditionalOnNotWebApplication</td><td>不是Web应用时生效</td><td><code>@ConditionalOnNotWebApplication</code></td></tr></tbody></table>
<h3 data-id="heading-10">四、实战：创建自定义Starter</h3>
<p>理解了原理后，我们来自定义一个Starter，实现一个简单的短信服务。</p>
<h4 data-id="heading-11">步骤1：创建Starter项目结构</h4>
<pre><code class="hljs language-css" lang="css">sms-spring-boot-starter/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/com/example/sms/
│   │   │   ├── SmsAutoConfiguration<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsProperties<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsService<span class="hljs-selector-class">.java</span>
│   │   │   └── SmsServiceImpl<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       └── META-INF/
│   │           └── spring<span class="hljs-selector-class">.factories</span>
│   └── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h4 data-id="heading-12">步骤2：创建配置属性类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsProperties.java</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "sms")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsProperties</span> {
    <span class="hljs-keyword">private</span> String accessKey;
    <span class="hljs-keyword">private</span> String secretKey;
    <span class="hljs-keyword">private</span> String signName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://dysmsapi.aliyuncs.com"</span>;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<h4 data-id="heading-13">步骤3：创建自动配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsAutoConfiguration.java</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties(SmsProperties.class)</span>  <span class="hljs-comment">// 启用配置属性</span>
<span class="hljs-meta">@ConditionalOnClass(SmsService.class)</span>  <span class="hljs-comment">// 当SmsService在类路径时生效</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "sms", value = "enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(SmsService.class)</span>  <span class="hljs-comment">// 容器中没有SmsService时才创建</span>
    <span class="hljs-keyword">public</span> SmsService <span class="hljs-title function_">smsService</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsServiceImpl</span>(properties);
    }
}
</code></pre>
<h4 data-id="heading-14">步骤4：创建服务接口和实现</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span>;
}

<span class="hljs-comment">// SmsServiceImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SmsProperties properties;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SmsServiceImpl</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-built_in">this</span>.properties = properties;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span> {
        System.out.printf(<span class="hljs-string">"发送短信到%s: %s [使用配置: %s]%n"</span>, 
            phone, content, properties.getEndpoint());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-15">步骤5：注册自动配置</h4>
<p>在<code>resources/META-INF/spring.factories</code>中：</p>
<pre><code class="hljs language-properties" lang="properties">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.example.sms.SmsAutoConfiguration
</code></pre>
<h4 data-id="heading-16">步骤6：在其他项目中使用</h4>
<ol>
<li>引入依赖：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sms-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li>添加配置：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">sms:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">access-key:</span> <span class="hljs-string">your-access-key</span>
  <span class="hljs-attr">secret-key:</span> <span class="hljs-string">your-secret-key</span>
  <span class="hljs-attr">sign-name:</span> <span class="hljs-string">阿里云</span>
</code></pre>
<ol start="3">
<li>直接注入使用：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SmsService smsService;  <span class="hljs-comment">// 自动注入</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 注册逻辑...</span>
        smsService.send(user.getPhone(), <span class="hljs-string">"注册验证码: 123456"</span>);
    }
}
</code></pre>
<h3 data-id="heading-17">五、自动配置的调试技巧</h3>
<p>当你遇到配置不生效的问题时，可以使用以下方法调试：</p>
<h4 data-id="heading-18">1. 开启调试日志</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>启动时会打印哪些自动配置类生效了，哪些没有生效及其原因。</p>
<h4 data-id="heading-19">2. 使用ConditionEvaluationReport</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> 
            SpringApplication.run(Application.class, args);
        
        <span class="hljs-comment">// 打印条件评估报告</span>
        <span class="hljs-type">ConditionEvaluationReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> 
            ConditionEvaluationReport.get(context.getBeanFactory());
        report.getConditionAndOutcomesBySource().forEach((source, outcomes) -&gt; {
            System.out.println(source);
            outcomes.forEach(outcome -&gt; {
                System.out.println(<span class="hljs-string">"\t"</span> + outcome.getOutcome());
            });
        });
    }
}
</code></pre>
<h3 data-id="heading-20">六、自动配置的最佳实践</h3>
<ol>
<li><strong>合理使用条件注解</strong>：避免过度配置，只在条件满足时生效</li>
<li><strong>提供合理的默认值</strong>：让用户无需配置就能使用</li>
<li><strong>允许用户覆盖</strong>：使用<code>@ConditionalOnMissingBean</code>让用户能自定义Bean</li>
<li><strong>良好的配置前缀</strong>：使用清晰的前缀，如<code>spring.datasource</code></li>
<li><strong>提供配置提示</strong>：创建<code>spring-configuration-metadata.json</code>提供IDE提示</li>
</ol>
<h3 data-id="heading-21">总结</h3>
<p>SpringBoot的自动配置通过以下机制实现"约定优于配置"：</p>
<ol>
<li><strong>启动注解复合</strong>：<code>@SpringBootApplication</code>集成了配置、扫描和自动配置</li>
<li><strong>工厂加载机制</strong>：通过<code>spring.factories</code>加载所有自动配置类</li>
<li><strong>条件化装配</strong>：根据环境按需加载，避免不必要的配置</li>
<li><strong>合理的默认值</strong>：提供开箱即用的默认配置</li>
</ol>
<h3 data-id="heading-22">今日思考题</h3>
<p>如果我想创建一个数据库连接池的Starter，需要满足以下条件：</p>
<ol>
<li>当类路径下有HikariCP时使用HikariCP</li>
<li>当类路径下有Druid时使用Druid</li>
<li>用户可以通过配置选择使用哪个连接池</li>
</ol>
<p>该如何设计这个自动配置类呢？欢迎在评论区分享你的思路！</p>
<p>可以关注公众号：小坏说Java</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot全局异常处理：别再到处try-catch了！》，学习如何优雅地处理异常，打造健壮的应用。</p>
<p><strong>互动时间</strong>：你在使用SpringBoot自动配置时遇到过哪些有趣的问题或技巧？欢迎留言分享！</p>
<p><strong>资源获取</strong>：关注公众号回复"自动配置源码"，获取本文所有示例代码及自定义Starter完整项目。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS Swift 可选值（Optional）详解]]></title>    <link>https://juejin.cn/post/7586482851097706536</link>    <guid>https://juejin.cn/post/7586482851097706536</guid>    <pubDate>2025-12-22T02:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097706536" data-draft-id="7581036773607800832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS Swift 可选值（Optional）详解"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-12-22T02:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tangbin583085"/> <meta itemprop="url" content="https://juejin.cn/user/95026578465675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS Swift 可选值（Optional）详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/95026578465675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tangbin583085
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:16:22.000Z" title="Mon Dec 22 2025 02:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Swift 与 Objective-C 最大的区别之一，就是 <strong>Optional（可选值）机制</strong>。<br/>
它从语言层面解决了“空指针崩溃”的问题，但如果使用不当，也可能引入新的 Crash。</p>
<p>在日常开发中，我们经常看到下面这些写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>?
<span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>!

<span class="hljs-keyword">let</span> title <span class="hljs-operator">=</span> text <span class="hljs-operator">??</span> <span class="hljs-string">"默认标题"</span>
imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(named: imgName <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<p>本文将<strong>系统讲解 <code>?</code>、<code>!</code>、<code>??</code> 的含义、区别、适用场景与工程级最佳实践</strong>，帮助你在 Swift 项目中写出更安全、更专业的代码。</p>
<hr/>
<h2 data-id="heading-0">什么是 Optional（可选值）</h2>
<p>在 Swift 中，<strong>Optional 表示一个变量「可能有值，也可能为 nil」</strong>。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-string">"Hello World"</span>
name <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
</code></pre>
<p>等价理解为：</p>
<blockquote>
<p>「这个变量可以为空，编译器强制你在使用前处理好为空的情况」</p>
</blockquote>
<p>这与 OC 中的 <code>id</code>、<code>NSString *</code> 完全不同，是 <strong>编译器层面的安全保障</strong>。</p>
<hr/>
<h2 data-id="heading-1">Optional 本质是什么？</h2>
<p>从语言层面来看：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>?
</code></pre>
<p>本质上相当于一个枚举：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">Int</span>&gt; {
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">some</span>(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> none
}
</code></pre>
<p>也正是因为这样，<strong>Swift 不允许你直接使用 Optional 的值</strong>。</p>
<hr/>
<h2 data-id="heading-2">一、<code>?</code> —— 可选类型（Optional）</h2>
<h3 data-id="heading-3">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> username: <span class="hljs-type">String</span>?
</code></pre>
<p>表示：</p>
<ul>
<li>可能有值</li>
<li>也可能为 <code>nil</code></li>
</ul>
<h3 data-id="heading-4">使用限制</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> len <span class="hljs-operator">=</span> username.count <span class="hljs-operator">❌</span> 编译错误
</code></pre>
<p>你必须 <strong>先解包（unwrap）</strong> ，才能使用。</p>
<hr/>
<h3 data-id="heading-5">安全解包方式一：<code>if let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username {
    <span class="hljs-built_in">print</span>(name.count)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"username 为 nil"</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-6">安全解包方式二：<code>guard let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">printName</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">username</span>: <span class="hljs-type">String</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"name 为 nil，提前返回"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-built_in">print</span>(name.count)
}
</code></pre>
<hr/>
<h2 data-id="heading-7">二、<code>!</code> —— 强制解包（Force Unwrap）</h2>
<h3 data-id="heading-8">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>! <span class="hljs-operator">=</span> <span class="hljs-number">18</span>
</code></pre>
<p>表示：</p>
<blockquote>
<p>“我<strong>确信</strong>这个变量在使用时一定不为 nil”</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">使用方式</h3>
<p>swift</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(age + <span class="hljs-number">1</span>)   <span class="hljs-comment">// 看起来像非 Optional</span>
</code></pre>
<p><strong>风险点</strong></p>
<pre><code class="hljs language-swift" lang="swift">age <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
<span class="hljs-built_in">print</span>(age <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">// 运行时崩溃</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">"!"的正确使用场景</h3>
<p>IBOutlet<br/>
生命周期受控变量</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> titleLabel: <span class="hljs-type">UILabel</span>!
</code></pre>
<p>原因：</p>
<ul>
<li>view 加载完成后一定存在</li>
<li>系统保证初始化时机</li>
</ul>
<p>某些依赖注入后一定存在的对象</p>
<hr/>
<h3 data-id="heading-11">不推荐的用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> userName: <span class="hljs-type">String</span>!
<span class="hljs-built_in">print</span>(userName.count) <span class="hljs-comment">// 非常危险 ❌</span>
</code></pre>
<p><strong>总结一句话</strong>：</p>
<blockquote>
<p><code>!</code> 是写给“你未来的自己看的承诺”，一旦违背就会 Crash</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">三、<code>??</code> —— 空值合并运算符（Nil-Coalescing）</h2>
<h3 data-id="heading-13">基本用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> displayName <span class="hljs-operator">=</span> username <span class="hljs-operator">??</span> <span class="hljs-string">"匿名用户"</span>
</code></pre>
<p>含义：</p>
<blockquote>
<p>如果 <code>username</code> 不为 nil，使用它<br/>
否则使用 <code>"匿名用户"</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-14">常见使用场景</h3>
<h4 data-id="heading-15">场景 1：UI 显示兜底</h4>
<pre><code class="hljs language-swift" lang="swift">titleLabel.text <span class="hljs-operator">=</span> model.title <span class="hljs-operator">??</span> <span class="hljs-string">"暂无标题"</span>
</code></pre>
<h4 data-id="heading-16">场景 2：参数默认值</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params">page</span>: <span class="hljs-type">Int</span>?) {
    <span class="hljs-keyword">let</span> currentPage <span class="hljs-operator">=</span> page <span class="hljs-operator">??</span> <span class="hljs-number">1</span>
    <span class="hljs-built_in">print</span>(currentPage)
}
</code></pre>
<h4 data-id="heading-17">场景 3：Data / String 转换兜底</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-type">Data</span>(base64Encoded: base64Str <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<hr/>
<h2 data-id="heading-18"><code>?</code> + <code>?.</code> —— 可选链（Optional Chaining）</h2>
<h3 data-id="heading-19">示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> length <span class="hljs-operator">=</span> username<span class="hljs-operator">?</span>.count
</code></pre>
<p>返回值类型：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Int</span>?
</code></pre>
<p>如果 <code>username == nil</code>：</p>
<ul>
<li>不会执行 <code>.count</code></li>
<li>整个表达式返回 nil</li>
</ul>
<hr/>
<h3 data-id="heading-20">常见链式调用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> city <span class="hljs-operator">=</span> user<span class="hljs-operator">?</span>.profile<span class="hljs-operator">?</span>.address<span class="hljs-operator">?</span>.city
</code></pre>
<h3 data-id="heading-21">从服务器返回数据解析</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>?
    <span class="hljs-keyword">let</span> age: <span class="hljs-type">Int</span>?
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">showUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">User</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> user <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"user 不存在"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> user.name <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>
    <span class="hljs-keyword">let</span> age <span class="hljs-operator">=</span> user.age <span class="hljs-operator">??</span> <span class="hljs-number">0</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"(name)，(age) 岁"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-22">常见错误用法总结</h2>
<p>滥用 <code>!</code></p>
<pre><code class="hljs language-swift" lang="swift">user<span class="hljs-operator">!</span>.name<span class="hljs-operator">!</span>.count <span class="hljs-operator">❌</span>
</code></pre>
<p>嵌套 if let 过深</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> a {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> b {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> c <span class="hljs-operator">=</span> c {
            <span class="hljs-operator">...</span>
        }
    }
}
</code></pre>
<p>更优写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> a, <span class="hljs-keyword">let</span> b, <span class="hljs-keyword">let</span> c <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Swift 的 Optional 不是语法糖，而是 <strong>逼着你在代码层面提前思考风险</strong>。</p>
<p>如有说错的地方，满发指正相互学习，谢谢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十五章(Image)]]></title>    <link>https://juejin.cn/post/7585897699602923546</link>    <guid>https://juejin.cn/post/7585897699602923546</guid>    <pubDate>2025-12-22T02:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602923546" data-draft-id="7585808181239873587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十五章(Image)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十五章(Image)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:09.000Z" title="Mon Dec 22 2025 02:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Image组件</h2>
<p>该组件是Next.js内置的图片组件，是基于原生<code>img</code>标签进行扩展，并不代表原生<code>img</code>标签不能使用。</p>
<ul>
<li>尺寸优化：支持使用现代化图片格式，如<code>webp</code>，<code>avif</code>，<code>apng</code>等,并自动根据设备提供正确的尺寸。</li>
<li>视觉稳定性：防止图片加载时发生布局偏移，具体参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fcls%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/cls?hl=zh-cn" ref="nofollow noopener noreferrer">CLS</a></li>
<li>懒加载：在图片进入视口才会加载，使用浏览器原生懒加载，并可选择添加模糊显示占位符。</li>
<li>灵活性：可按需调整图像大小，即使是存储在远程服务器上的图像也可以调整。</li>
</ul>
<h4 data-id="heading-1">图片引入</h4>
<h5 data-id="heading-2">1. src本地图片引入</h5>
<p>Next.js建议我们把图片放在根目录下的<code>public</code>文件夹中，然后使用<code>/</code>开头访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a73a9cf6e7c4be8b3f3b61e531a778f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=GFjfFcsoNvoSwKUNnkb9VH%2F68kc%3D" alt="public.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"/1.png"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-3">2. import静态引入</h5>
<p>使用<code>import</code>引入图片，是不需要填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"@/public/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./public/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 新增这一行代码，配置图片路径。</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用静态<code>import</code>引入图片，你会发现无需填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">3. 远程图片引入</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>当我们直接使用远程图片引入的时候Next.js会报错，因为Next.js默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>image-loader.ts:86 Uncaught Error: Invalid src prop (<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>) on <code>next/image</code>, hostname "eo-img.521799.xyz" is not configured under images in your <code>next.config.js</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
  },
};
</code></pre>
<h5 data-id="heading-5">4. LCP警告</h5>
<p>如果图片是首屏或者LCP图片，需要添加<code>loading="eager"</code>属性，否则会触发LCP警告,因为Image组件默认是懒加载的。</p>
<ul>
<li>lazy: 懒加载，默认值，在图片进入视口才会加载。</li>
<li>eager: 立即加载，在图片进入视口就会加载。</li>
</ul>
<p>Image with src "<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>" was detected as the Largest Contentful Paint (LCP). Please add the <code>loading="eager"</code> property if this image is above the fold.
Read more: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fcomponents%2Fimage%23loading" target="_blank" title="https://nextjs.org/docs/app/api-reference/components/image#loading" ref="nofollow noopener noreferrer">nextjs.org/docs/app/ap…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> // <span class="hljs-attr">立即加载</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>第二种解决方案使用<code>preload</code>属性加载图片，表示提前预加载图片，不过Next.js还是更加推荐使用<code>loading="eager"</code>属性加载图片。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">preload</span>=<span class="hljs-string">{index</span> &lt; <span class="hljs-attr">10</span>} // <span class="hljs-attr">优先加载策略</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-6">5. 图片格式优化</h5>
<p>Next.js 会通过请求Accept头自动检测浏览器支持的图像格式，以确定最佳输出格式</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Accept</span>:image/avif,image/webp,image/apng,image/svg+xml,image<span class="hljs-comment">/*,*/</span>*;q=<span class="hljs-number">0.8</span>
</code></pre>
<p>我们可以同时启用 AVIF 和 WebP 格式。对于支持 AVIF 的浏览器，系统将优先使用 AVIF 格式，WebP 格式作为备选方案。目前AVIF格式最优。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
  },
};
</code></pre>
<h5 data-id="heading-7">6. 设备适配</h5>
<p>如果你的老板告诉你要兼容哪些设备，你可以使用<code>deviceSizes</code>和<code>imageSizes</code>属性来配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<p>这两个属性结合会最终生成一个<code>srcset</code>属性，用于浏览器选择最佳图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bed6fc34c0a414484df71bcf1dbe922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=vOdeCraZzznSMXE%2FFPdALioNi2Y%3D" alt="srcset.png" loading="lazy"/></p>
<p>那为什么需要两个数组去实现呢？</p>
<p>我们观察上图可以发现，<code>imageSizes</code>用于生成小图片尺寸例如(缩略图，头像等)，而<code>deviceSizes</code>用于生成大图片尺寸例如(横幅图、背景图、全屏展示图)。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-comment">// 头像 - 固定 64px</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/avatar.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"64px"</span>  // ← <span class="hljs-attr">告诉浏览器这张图只需要</span> <span class="hljs-attr">64px</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 横幅图 - 响应式全宽</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/banner.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1920}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"100vw"</span>  // ← <span class="hljs-attr">占满整个视口宽度</span>，<span class="hljs-attr">使用</span> <span class="hljs-attr">deviceSizes</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 响应式内容图</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContentImage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/content.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1200}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{800}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 1200px"</span>
      // ↑ <span class="hljs-attr">手机上</span> <span class="hljs-attr">100</span>% <span class="hljs-attr">宽度</span>，<span class="hljs-attr">平板上</span> <span class="hljs-attr">50</span>%，<span class="hljs-attr">桌面最大</span> <span class="hljs-attr">1200px</span>
    /&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-8">Props</h4>
<p>以下是 Image 组件可用的属性：</p>
<h5 data-id="heading-9">必需属性</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td><code>src="/profile.png"</code></td><td>图片源路径，支持本地路径或远程 URL</td></tr><tr><td>alt</td><td>String</td><td><code>alt="Picture of the author"</code></td><td>图片替代文本，用于无障碍访问和 SEO</td></tr></tbody></table>
<h5 data-id="heading-10">尺寸相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>width</td><td>Integer (px)</td><td><code>width={500}</code></td><td>图片宽度，静态导入时可选</td></tr><tr><td>height</td><td>Integer (px)</td><td><code>height={500}</code></td><td>图片高度，静态导入时可选</td></tr><tr><td>fill</td><td>Boolean</td><td><code>fill={true}</code></td><td>填充父容器，替代 width 和 height</td></tr><tr><td>sizes</td><td>String</td><td><code>sizes="(max-width: 768px) 100vw"</code></td><td>响应式图片尺寸</td></tr></tbody></table>
<h5 data-id="heading-11">优化相关</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>quality</td><td>Integer (1-100)</td><td><code>quality={80}</code></td><td>图片压缩质量，默认为 75</td></tr><tr><td>loader</td><td>Function</td><td><code>loader={imageLoader}</code></td><td>自定义图片加载器函数</td></tr><tr><td>unoptimized</td><td>Boolean</td><td><code>unoptimized={true}</code></td><td>禁用图片优化，使用原图</td></tr></tbody></table>
<h5 data-id="heading-12">加载相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>loading</td><td>String</td><td><code>loading="lazy"</code></td><td>加载策略，"lazy" 或 "eager"</td></tr><tr><td>preload</td><td>Boolean</td><td><code>preload={true}</code></td><td>是否预加载，用于 LCP 元素</td></tr><tr><td>placeholder</td><td>String</td><td><code>placeholder="blur"</code></td><td>占位符类型，"blur" 或 "empty"</td></tr><tr><td>blurDataURL</td><td>String</td><td><code>blurDataURL="data:image/jpeg..."</code></td><td>模糊占位符的 Data URL</td></tr></tbody></table>
<h5 data-id="heading-13">事件回调</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>onLoad</td><td>Function</td><td><code>onLoad={e =&gt; done()}</code></td><td>图片加载完成时的回调</td></tr><tr><td>onError</td><td>Function</td><td><code>onError={e =&gt; fail()}</code></td><td>图片加载失败时的回调</td></tr></tbody></table>
<h5 data-id="heading-14">其他属性</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>style</td><td>Object</td><td><code>style={{objectFit: "contain"}}</code></td><td>内联样式对象</td></tr><tr><td>overrideSrc</td><td>String</td><td><code>overrideSrc="/seo.png"</code></td><td>覆盖 src，用于 SEO 优化</td></tr><tr><td>decoding</td><td>String</td><td><code>decoding="async"</code></td><td>解码方式，"async"/"sync"/"auto"</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd 5 + react 18 + vite 7 升级]]></title>    <link>https://juejin.cn/post/7585948869844762659</link>    <guid>https://juejin.cn/post/7585948869844762659</guid>    <pubDate>2025-12-22T02:17:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844762659" data-draft-id="7584719268044668962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd 5 + react 18 + vite 7 升级"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="holidaypenguin"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194801421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd 5 + react 18 + vite 7 升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194801421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    holidaypenguin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:19.000Z" title="Mon Dec 22 2025 02:17:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一年前react + vite + antd 项目 升级</h2>
<blockquote>
<p>目标升级到 antd 6 、 react 19、vite 8、babel-plugin-react-compiler</p>
<p>还有其他依赖项目 如 echarts</p>
</blockquote>
<h3 data-id="heading-1">升级 antd6 和 vite 8</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://cn.vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">Vite 8 Beta: The Rolldown-powered Vite | Vite 官方中文文档</a></li>
</ul>
<h4 data-id="heading-2">更新相关依赖</h4>
<ul>
<li>手动查看相关依赖版本，修改antd和vite相关依赖版本
<ul>
<li>antd</li>
<li>@ant-design/icons</li>
<li>@vitejs/plugin-react-oxc -&gt; @vitejs/plugin-react</li>
<li>vite</li>
<li>其他一些无关紧要的依赖版本升级</li>
</ul>
</li>
<li><code>antd@6</code> 要求 <code>@ant-design/icons</code> 版本 &gt;= 6.0.0</li>
<li>@vitejs/plugin-react-oxc is deprecated. Please use @vitejs/plugin-react instead. The changes of this plugin is now included in @vitejs/plugin-react.</li>
</ul>
<p>修改相关依赖项版本然后安装依赖</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3deef43a06436dbb7d4fb673986fed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=yWn3N%2F%2FcTv0aoePwoglLwaINhF0%3D" alt="image.png" loading="lazy"/></p>
<p>第一次启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa81367939e140f5bfe49ee0b5b650c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=z0FUwfMVE7rO31XEiRMtBgm35gQ%3D" alt="image.png" loading="lazy"/></p>
<p>@vitejs/plugin-react</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a41ac2e84c149dc97e71d8a787165f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=xCWgBB15u25WX1glTRlpxYYgf0I%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">修改 antd 6 的API调整</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn%23api-%25E8%25B0%2583%25E6%2595%25B4" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn#api-%E8%B0%83%E6%95%B4" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></p>
<h5 data-id="heading-4"><code>Alert</code></h5>
<p>message  属性改成 title</p>
<h5 data-id="heading-5"><code>Card</code></h5>
<p>bodyStyle 属性没有了，组件中 styles 属性中 body 自定义的时候报错
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ef092b66e2d4dad884826b2200990e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=rft%2BS7qR1DEoh1meMlf%2BtE6CoSo%3D" alt="image.png" loading="lazy"/></p>
<p>因为  <code>styles</code> 的类型   Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt; | (info: { props })=&gt; Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt;</p>
<p>增加一个代理属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">stylesProxy</span> = (<span class="hljs-params">info</span>) =&gt; {
    <span class="hljs-keyword">const</span> stylesObj = <span class="hljs-keyword">typeof</span> styles === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">styles</span>(info) : styles
    <span class="hljs-keyword">return</span> {
        ...stylesObj,
        <span class="hljs-attr">body</span>: {
            ...(stylesObj.<span class="hljs-property">body</span> || {}),
            <span class="hljs-attr">height</span>: full ? <span class="hljs-string">'100%'</span> : stylesObj?.<span class="hljs-property">body</span>?.<span class="hljs-property">height</span> || <span class="hljs-string">'auto'</span>,
        }
    }
}

&lt;<span class="hljs-title class_">Card</span> 
    {...args}
    styles={stylesProxy}
/&gt;
</code></pre>
<h5 data-id="heading-6"><code>Dropdown</code> <code>Button</code></h5>
<blockquote>
<p>hover显示的时候点击会消失，再次hover也不显示，等组件库升级好以后，在升级react 19 看看是否能解决。</p>
</blockquote>
<h5 data-id="heading-7"><code>Input</code> 和 <code>InputNumber</code>   <code>addonAfter</code>  <code>addonAfter</code> 属性废弃</h5>
<blockquote>
<p>预留问题：因为暂时还能用，先整体升级完再解决</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87fafaa096fc435a86c70fb68bb450d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=e3xGEsIOXB187Bm1nJlBaAIauTo%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-8"><code>Progress</code></h5>
<p><code>strokeWidth</code> 弃用，变为 <code>size</code>。当  <code>type="circle"</code>  <code>type="dashboard"</code> 的时候 strokeWidth 还是保留的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed8cb8242a404fd38a583a4773f52058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=C9ZiJcpSGeRin94oDYJ%2BiiLjf4U%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-9"><code>Select</code></h5>
<p>filterOption 废弃，使用 showSearch.filterOption</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fef1f97fde94ba7b628e75f2e0cc8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=aTWqmJ%2BOf0AA0LqJGedPDle8dIQ%3D" alt="image.png" loading="lazy"/></p>
<p>通用组件类型定义</p>
<pre><code class="hljs language-java" lang="java">export <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;SelectProps, <span class="hljs-string">'filterOption'</span>&gt; {}
</code></pre>
<p>通用组件制定默认搜索方法</p>
<pre><code class="hljs language-tsx" lang="tsx">
<span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
    ? {
        <span class="hljs-attr">filterOption</span>: filterOptionProxy,
    }
    : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
        ? {
            ...showSearch,
            <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
        }
        : showSearch
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fissues%2F55877" target="_blank" title="https://github.com/ant-design/ant-design/issues/55877" ref="nofollow noopener noreferrer">[Bug 6.0] Select 组件的 options 选项存在 label/value 等它支持的属性外的其他属性时 React 报警告错误 · Issue #55877 · ant-design/ant-design</a></p>
<p>这个警告是因为 Select 的 options 里自定义属性（比如 labelPinyin）被直接传递到 DOM 元素上，React 19 对未知属性检查更严格，所以会报错。Ant Design 6.0.0 没有自动过滤这些非标准属性，导致自定义字段会被当作 DOM 属性渲染，触发警告 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fblob%2F816912441c855a2bc17c06d697299f312d81a4a2%2Fcomponents%2Fselect%2Findex.tsx%23L3-L419" target="_blank" title="https://github.com/ant-design/ant-design/blob/816912441c855a2bc17c06d697299f312d81a4a2/components/select/index.tsx#L3-L419" ref="nofollow noopener noreferrer">源码分析</a>。</p>
<p>Issue 推荐做法是用 <code>optionRender</code>，只在渲染时取出自定义属性，不让它们直接传递到 DOM。例如：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">options</span> = [
  { label: <span class="hljs-string">'苹果'</span>, value: <span class="hljs-string">'apple'</span>, labelPinyin: <span class="hljs-string">'pingguo'</span> },
  { label: <span class="hljs-string">'香蕉'</span>, value: <span class="hljs-string">'banana'</span>, labelPinyin: <span class="hljs-string">'xiangjiao'</span> },
]<span class="hljs-comment">;</span>

&lt;Select
  <span class="hljs-attr">options</span>={options}
  <span class="hljs-attr">optionRender</span>={option =&gt; (
    &lt;span&gt;
      {option.data.label} &lt;span <span class="hljs-attr">style</span>={{ color: <span class="hljs-string">'#aaa'</span> }}&gt;{option.data.labelPinyin}&lt;/span&gt;
    &lt;/span&gt;
  )}
/&gt;
</code></pre>
<p>结果试了下都不行，仍然没有结果警告。但是我发现即使没有 optionRender ，选项出现的时候也没有问题，但是问题出现在选中后的显示上，我虽然加了 labelRender ，也一样会有警告。</p>
<p>所以我最终采用的办法是使用一个统一组件去过滤非必要的属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useContext, useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Select</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SelectProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>

<span class="hljs-keyword">import</span> { isArray, isEmpty, isString } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">SelectProps</span>, 'filterOption'&gt; {
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FISelect</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">FISelectProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
    options,
    placeholder = <span class="hljs-string">'请选择'</span>,
    value,
    onChange = () =&gt; {},
    mode,
    allowClear = <span class="hljs-literal">true</span>,
    showSearch = <span class="hljs-literal">true</span>,
    fieldNames = {},
    optionRender,
    ...args
}</span>) =&gt;</span> {

    <span class="hljs-keyword">const</span> isMultiple = mode === <span class="hljs-string">'multiple'</span>
    <span class="hljs-keyword">const</span> [valueProxy, setValueProxy] = useState&lt;<span class="hljs-built_in">any</span>&gt;(isMultiple ? [] : <span class="hljs-string">''</span>)

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setValueProxy</span>(value)
    }, [value])


    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getOptions</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// console.log('-- getOptions --')</span>
        <span class="hljs-keyword">return</span> (options || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">origin_data</span>: item,
                <span class="hljs-attr">value</span>: item[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>],
                <span class="hljs-attr">label</span>: item[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>],
            }
        })
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onChangeProxy</span> = (<span class="hljs-params">value: <span class="hljs-built_in">any</span>, option: <span class="hljs-built_in">any</span></span>) =&gt; {
        <span class="hljs-comment">// console.log('--onChangeProxy--', value, option, getOuterValue(value))</span>
        <span class="hljs-title function_">onChange</span>(value, option.<span class="hljs-property">origin_data</span>)
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
        ? {
            <span class="hljs-attr">filterOption</span>: filterOptionProxy,
        }
        : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
            ? {
                ...showSearch,
                <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
            }
            : showSearch

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">filterOptionProxy</span> (<span class="hljs-attr">inputValue</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">option</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// console.log('-- filterOptionProxy --',inputValue, option)</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">value</span>: vf, <span class="hljs-attr">label</span>: vl } = fieldNames
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">origin_data</span>[vf || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">origin_data</span>[vl || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">return</span> value?.<span class="hljs-property">toString</span>?.() === inputValue?.<span class="hljs-property">toString</span>?.() || <span class="hljs-title class_">String</span>(label).<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-title class_">String</span>(inputValue).<span class="hljs-title function_">toLowerCase</span>()) &gt; -<span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">optionRenderProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'optionRender'</span>] = <span class="hljs-function">(<span class="hljs-params">option: <span class="hljs-built_in">any</span>, info</span>) =&gt;</span> {
        <span class="hljs-comment">// console.log('-- optionRenderProxy --',option, info)</span>
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">if</span> (!optionRender) {
            <span class="hljs-keyword">return</span> (label)
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">optionRender</span>(option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>, info)
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
            {<span class="hljs-attr">...args</span>}
            <span class="hljs-attr">options</span>=<span class="hljs-string">{getOptions()}</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{placeholder}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">fi-select</span> ${<span class="hljs-attr">args.className</span> || ''}`}
            <span class="hljs-attr">value</span>=<span class="hljs-string">{valueProxy}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChangeProxy}</span>
            <span class="hljs-attr">mode</span>=<span class="hljs-string">{mode}</span>
            <span class="hljs-attr">allowClear</span>=<span class="hljs-string">{allowClear}</span>
            <span class="hljs-attr">showSearch</span>=<span class="hljs-string">{showSearchProxy}</span>
            <span class="hljs-attr">optionRender</span>=<span class="hljs-string">{optionRender</span> ? <span class="hljs-attr">optionRenderProxy</span> <span class="hljs-attr">:</span> <span class="hljs-attr">undefined</span>}
        /&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">memo</span>(<span class="hljs-title class_">FISelect</span>)
</code></pre>
<h3 data-id="heading-10">升级 react 19</h3>
<p>react-activation</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f888a448c4f34a2ebc984a9fe67ab974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=Wi3hVS%2FevhWk4wLfBd1X4%2FxR%2Fog%3D" alt="image.png" loading="lazy"/></p>
<p>使用 <code>keepalive-for-react</code> 替代 <code>react-activation</code></p>
<ol>
<li><strong>React Router v7 架构变更</strong>
<ul>
<li>React Router v7 使用了新的 Data Router 架构</li>
<li>要求所有 hooks 必须在正确的 router 上下文内使用</li>
<li>对组件嵌套和上下文传递有更严格的要求</li>
</ul>
</li>
<li><strong>react-activation 不兼容</strong>
<ul>
<li><code>react-activation</code> (v0.13.4) 还不支持 React 19,但是理论上是支持的</li>
<li>与 React Router v7 的新架构存在冲突</li>
<li><code>KeepAlive</code> 组件破坏了 Router 的上下文传递</li>
<li>查看了下组件的使用方式，发现原来的使用方法可能不正确，待后续解决</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">升级 babel-plugin-react-compiler</h3>
<h3 data-id="heading-12">升级其他组件库</h3>
<h3 data-id="heading-13">遗留问题</h3>
<ul>
<li>Input  InputNumber   addonAfter  addonAfter 属性废弃 解决方案</li>
<li>react-activation 无法运行</li>
<li>升级babel-plugin-react-compiler</li>
<li>升级其他组件库</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再到处try-catch了！SpringBoot全局异常处理这样设计]]></title>    <link>https://juejin.cn/post/7585808181239922739</link>    <guid>https://juejin.cn/post/7585808181239922739</guid>    <pubDate>2025-12-22T02:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239922739" data-draft-id="7585920796100018203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再到处try-catch了！SpringBoot全局异常处理这样设计"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再到处try-catch了！SpringBoot全局异常处理这样设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:26:01.000Z" title="Mon Dec 22 2025 02:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《别再到处try-catch了！SpringBoot全局异常处理这样设计》</h2>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小明。昨天我们讲解了自动配置，今天来聊聊异常处理。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
</blockquote>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>想象一下这样的场景：你的项目有50个Controller，每个Controller方法里都有类似的try-catch代码，而且每个开发者处理异常的方式都不一样。线上出了问题，日志里要么没有记录，要么记录得乱七八糟...</p>
<p>这就是为什么我们需要统一的全局异常处理。今天，我将带你设计一个优雅的全局异常处理方案，让你的代码<strong>干净、统一、易于维护</strong>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看两个对比：</p>
<p><strong>❌ 混乱的异常处理方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; register(<span class="hljs-meta">@RequestBody</span> UserDTO user) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(registered);
        } <span class="hljs-keyword">catch</span> (ValidationException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(<span class="hljs-string">"参数错误："</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (DuplicateException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">409</span>).body(<span class="hljs-string">"用户已存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"注册失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统繁忙"</span>);
        }
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; getUser(<span class="hljs-meta">@PathVariable</span> Long id) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
        } <span class="hljs-keyword">catch</span> (NotFoundException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">404</span>).body(<span class="hljs-string">"用户不存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"查询用户失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统错误"</span>);
        }
    }
    <span class="hljs-comment">// ... 其他方法重复类似的模式</span>
}
</code></pre>
<p><strong>✅ 优雅的全局异常处理</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
        <span class="hljs-keyword">return</span> ResponseResult.success(registered);
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
        <span class="hljs-keyword">return</span> ResponseResult.success(user);
    }
    <span class="hljs-comment">// ... 干净的业务代码，不包含任何异常处理逻辑</span>
}
</code></pre>
<p>所有的异常都在<strong>一个地方统一处理</strong>！下面，让我们一步步实现这个目标。</p>
<h3 data-id="heading-2">一、SpringBoot异常处理核心注解</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-3">1. @ControllerAdvice：全局异常处理的基石</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ControllerAdvice {
    <span class="hljs-comment">// 可以指定要处理的包</span>
    String[] value() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的Controller类型</span>
    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的注解</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;[] annotations() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<p><strong>三种常见用法</strong>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：处理所有Controller的异常（最常用）</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-comment">// 处理逻辑...</span>
}

<span class="hljs-comment">// 方式2：只处理指定包下的Controller</span>
<span class="hljs-meta">@ControllerAdvice("com.example.user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserExceptionHandler</span> {
    <span class="hljs-comment">// 只处理user模块的异常</span>
}

<span class="hljs-comment">// 方式3：只处理带有特定注解的Controller</span>
<span class="hljs-meta">@ControllerAdvice(annotations = RestController.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestExceptionHandler</span> {
    <span class="hljs-comment">// 只处理@RestController注解的类</span>
}
</code></pre>
<h4 data-id="heading-4">2. @RestControllerAdvice：更便捷的选择</h4>
<p><code>@RestControllerAdvice</code> 是 <code>@ControllerAdvice</code> 和 <code>@ResponseBody</code> 的组合，专门用于REST API开发。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RestControllerAdvice {
    <span class="hljs-comment">// 同@ControllerAdvice</span>
}
</code></pre>
<h4 data-id="heading-5">3. @ExceptionHandler：指定处理什么异常</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ExceptionHandler {
    <span class="hljs-comment">// 指定要处理的异常类型</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] value() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<h3 data-id="heading-6">二、设计优雅的异常体系</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. 异常分类策略</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Throwable</span>
├── <span class="hljs-built_in">Error</span>（系统错误，如OutOfMemoryError，通常不捕获）
└── <span class="hljs-built_in">Exception</span>（异常）
    ├── <span class="hljs-built_in">RuntimeException</span>（运行时异常）
    │   ├── BusinessException（自定义业务异常）
    │   │   ├── ValidationException（参数校验异常）
    │   │   ├── DuplicateException（数据重复异常）
    │   │   ├── NotFoundException（数据不存在异常）
    │   │   └── PermissionException（权限异常）
    │   └── SystemException（自定义系统异常）
    └── 其他Checked <span class="hljs-built_in">Exception</span>（已检查异常）
</code></pre>
<h4 data-id="heading-8">2. 基础异常类设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-built_in">super</span>(message);
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-built_in">super</span>(errorCode.getMessage());
        <span class="hljs-built_in">this</span>.code = errorCode.getCode();
        <span class="hljs-built_in">this</span>.message = errorCode.getMessage();
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 错误码枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    <span class="hljs-comment">// 系统错误</span>
    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">"成功"</span>),
    SYSTEM_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">"系统错误"</span>),
    
    <span class="hljs-comment">// 业务错误</span>
    PARAM_VALID_ERROR(<span class="hljs-number">10001</span>, <span class="hljs-string">"参数校验失败"</span>),
    DATA_NOT_FOUND(<span class="hljs-number">10002</span>, <span class="hljs-string">"数据不存在"</span>),
    DATA_DUPLICATE(<span class="hljs-number">10003</span>, <span class="hljs-string">"数据已存在"</span>),
    PERMISSION_DENIED(<span class="hljs-number">10004</span>, <span class="hljs-string">"权限不足"</span>),
    USER_NOT_LOGIN(<span class="hljs-number">10005</span>, <span class="hljs-string">"用户未登录"</span>),
    
    <span class="hljs-comment">// 第三方服务错误</span>
    THIRD_PARTY_ERROR(<span class="hljs-number">20001</span>, <span class="hljs-string">"第三方服务异常"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    ErrorCode(<span class="hljs-type">int</span> code, String message) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 具体的业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ValidationException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NotFoundException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.DATA_NOT_FOUND.getCode(), message);
    }
}
</code></pre>
<h3 data-id="heading-9">三、统一响应体设计</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-10">1. 响应体基础结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 统一响应体</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseResult</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;        <span class="hljs-comment">// 状态码</span>
    <span class="hljs-keyword">private</span> String message;  <span class="hljs-comment">// 消息</span>
    <span class="hljs-keyword">private</span> T data;          <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timestamp;  <span class="hljs-comment">// 时间戳</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> success(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(ErrorCode.SUCCESS.getCode())
                .message(ErrorCode.SUCCESS.getMessage())
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-keyword">return</span> fail(errorCode.getCode(), errorCode.getMessage());
    }
}
</code></pre>
<h3 data-id="heading-11">四、实现全局异常处理器</h3>
<h4 data-id="heading-12">1. 完整异常处理器实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
        log.warn(<span class="hljs-string">"业务异常：code={}, message={}"</span>, e.getCode(), e.getMessage());
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-comment">/**
     * 处理参数校验异常（<span class="hljs-doctag">@Validated</span>触发的异常）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleMethodArgumentNotValidException</span><span class="hljs-params">(
            MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数校验失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理请求参数绑定异常（类型转换错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BindException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBindException</span><span class="hljs-params">(BindException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(ObjectError::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数绑定失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理参数解析异常（JSON解析错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpMessageNotReadableException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpMessageNotReadableException</span><span class="hljs-params">(
            HttpMessageNotReadableException e)</span> {
        log.warn(<span class="hljs-string">"请求参数解析失败"</span>, e);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), <span class="hljs-string">"请求参数格式错误"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理404异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(NoHandlerFoundException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleNoHandlerFoundException</span><span class="hljs-params">(
            NoHandlerFoundException e)</span> {
        log.warn(<span class="hljs-string">"接口不存在：{} {}"</span>, e.getHttpMethod(), e.getRequestURL());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">404</span>, <span class="hljs-string">"接口不存在"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理请求方法不支持异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpRequestMethodNotSupportedException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpRequestMethodNotSupportedException</span><span class="hljs-params">(
            HttpRequestMethodNotSupportedException e)</span> {
        log.warn(<span class="hljs-string">"请求方法不支持：{}，支持的方法：{}"</span>, 
                e.getMethod(), e.getSupportedHttpMethods());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">405</span>, <span class="hljs-string">"请求方法不支持"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理所有未捕获的异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        
        <span class="hljs-comment">// 生产环境返回模糊的错误信息，开发环境返回详细错误</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> isProduction() ? <span class="hljs-string">"系统繁忙，请稍后重试"</span> : e.getMessage();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), message);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProduction</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"spring.profiles.active"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(env);
    }
}
</code></pre>
<h4 data-id="heading-13">2. 增强版：带异常日志记录的处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedGlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 异常信息上下文，用于记录额外信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; exceptionContext = 
            ThreadLocal.withInitial(HashMap::<span class="hljs-keyword">new</span>);
    
    <span class="hljs-comment">/**
     * 添加上下文信息（可在业务代码中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addContext</span><span class="hljs-params">(String key, Object value)</span> {
        exceptionContext.get().put(key, value);
    }
    
    <span class="hljs-comment">/**
     * 清理上下文（在过滤器或拦截器中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> {
        exceptionContext.remove();
    }
    
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(
            BusinessException e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.warn(<span class="hljs-string">"业务异常 | 路径：{} | 参数：{} | 错误码：{} | 消息：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                e.getCode(),
                e.getMessage(),
                context);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(
            Exception e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.error(<span class="hljs-string">"系统异常 | 路径：{} | 参数：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                context,
                e);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), 
                isProduction() ? <span class="hljs-string">"系统繁忙"</span> : e.getMessage());
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRequestParams</span><span class="hljs-params">(HttpServletRequest request)</span> {
        Map&lt;String, String[]&gt; params = request.getParameterMap();
        <span class="hljs-keyword">return</span> params.entrySet().stream()
                .map(entry -&gt; entry.getKey() + <span class="hljs-string">"="</span> + 
                        Arrays.toString(entry.getValue()))
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
    }
    
    <span class="hljs-comment">// ... 其他异常处理方法</span>
}
</code></pre>
<h3 data-id="heading-14">五、最佳实践与高级用法</h3>
<h4 data-id="heading-15">1. 参数校验的优雅处理</h4>
<p><strong>传统方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/user")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-comment">// 需要手动处理BindingResult</span>
        <span class="hljs-comment">// 或者依赖全局异常处理器</span>
    }
}
</code></pre>
<p><strong>增强方式</strong>：自定义校验注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义手机号校验注解</span>
<span class="hljs-meta">@Target({ElementType.FIELD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Constraint(validatedBy = PhoneValidator.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Phone {
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"手机号格式错误"</span>;
    Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> {};
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Payload</span>&gt;[] payload() <span class="hljs-keyword">default</span> {};
}

<span class="hljs-comment">// 实现校验逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConstraintValidator</span>&lt;Phone, String&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">PHONE_PATTERN</span> <span class="hljs-operator">=</span> 
            Pattern.compile(<span class="hljs-string">"^1[3-9]\\d{9}$"</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(String value, ConstraintValidatorContext context)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 由@NotNull处理空值</span>
        }
        <span class="hljs-keyword">return</span> PHONE_PATTERN.matcher(value).matches();
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "用户名不能为空")</span>
    <span class="hljs-meta">@Size(min = 2, max = 20, message = "用户名长度2-20")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Phone</span>  <span class="hljs-comment">// 使用自定义注解</span>
    <span class="hljs-keyword">private</span> String phone;
}
</code></pre>
<h4 data-id="heading-16">2. 多环境差异化处理</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>

<span class="hljs-attr">app:</span>
  <span class="hljs-attr">exception:</span>
    <span class="hljs-comment"># 开发环境返回详细错误</span>
    <span class="hljs-attr">detail-in-dev:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 生产环境屏蔽堆栈</span>
    <span class="hljs-attr">hide-stack-in-prod:</span> <span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.exception")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionProperties</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">detailInDev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideStackInProd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnvironmentAwareExceptionHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExceptionProperties properties;
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e, 
            HttpServletRequest request)</span> {
        
        <span class="hljs-comment">// 记录异常日志（生产环境记录简要，开发环境记录详细）</span>
        <span class="hljs-keyword">if</span> (isProduction()) {
            log.error(<span class="hljs-string">"系统异常 | 路径：{} | 错误：{}"</span>, 
                    request.getRequestURI(), e.getMessage());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"系统异常 | 路径：{}"</span>, request.getRequestURI(), e);
        }
        
        <span class="hljs-comment">// 构建响应</span>
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>();
        error.setCode(ErrorCode.SYSTEM_ERROR.getCode());
        error.setMessage(buildErrorMessage(e));
        
        <span class="hljs-keyword">if</span> (!isProduction() &amp;&amp; properties.isDetailInDev()) {
            error.setDetail(e.getMessage());
            error.setPath(request.getRequestURI());
            error.setException(e.getClass().getName());
        }
        
        <span class="hljs-keyword">if</span> (!isProduction() || !properties.isHideStackInProd()) {
            error.setTrace(getStackTrace(e));
        }
        
        <span class="hljs-keyword">return</span> ResponseResult.fail(error);
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildErrorMessage</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-keyword">if</span> (isProduction()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        }
        <span class="hljs-keyword">return</span> e.getMessage();
    }
}
</code></pre>
<h4 data-id="heading-17">3. 集成Sentinel进行流控异常处理</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler(BlockException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBlockException</span><span class="hljs-params">(BlockException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        
        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> FlowException) {
            message = <span class="hljs-string">"接口限流，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> DegradeException) {
            message = <span class="hljs-string">"接口降级，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ParamFlowException) {
            message = <span class="hljs-string">"热点参数限流"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> SystemBlockException) {
            message = <span class="hljs-string">"系统保护（CPU/负载）"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> AuthorityException) {
            message = <span class="hljs-string">"授权规则不通过"</span>;
        }
        
        log.warn(<span class="hljs-string">"Sentinel流控：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">429</span>, message);
    }
}
</code></pre>
<h3 data-id="heading-18">六、完整示例：电商系统异常处理实战</h3>
<h4 data-id="heading-19">1. 业务异常定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 库存不足异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsufficientStockException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer requested;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer available;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InsufficientStockException</span><span class="hljs-params">(Long productId, 
            Integer requested, Integer available)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.INSUFFICIENT_STOCK);
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.requested = requested;
        <span class="hljs-built_in">this</span>.available = available;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"商品[%d]库存不足，需要%d，可用%d"</span>, 
                productId, requested, available);
    }
}

<span class="hljs-comment">// 订单状态异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStateException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String currentState;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String requiredState;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderStateException</span><span class="hljs-params">(Long orderId, 
            String currentState, String requiredState)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.ORDER_STATE_ERROR);
        <span class="hljs-built_in">this</span>.orderId = orderId;
        <span class="hljs-built_in">this</span>.currentState = currentState;
        <span class="hljs-built_in">this</span>.requiredState = requiredState;
    }
}
</code></pre>
<h4 data-id="heading-20">2. 业务使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-comment">// 参数校验（会自动抛出MethodArgumentNotValidException）</span>
        validateOrder(dto);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查库存</span>
            checkStock(dto);
            
            <span class="hljs-comment">// 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(dto);
            orderRepository.save(order);
            
            <span class="hljs-comment">// 扣减库存</span>
            reduceStock(dto);
            
            <span class="hljs-comment">// 发送创建订单事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(order));
            
            <span class="hljs-keyword">return</span> order;
            
        } <span class="hljs-keyword">catch</span> (InsufficientStockException e) {
            <span class="hljs-comment">// 添加上下文信息，便于日志记录</span>
            EnhancedGlobalExceptionHandler.addContext(<span class="hljs-string">"orderDTO"</span>, dto);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkStock</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        dto.getItems().forEach(item -&gt; {
            <span class="hljs-type">Integer</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> stockService.getAvailableStock(item.getProductId());
            <span class="hljs-keyword">if</span> (available &lt; item.getQuantity()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(
                        item.getProductId(), 
                        item.getQuantity(), 
                        available);
            }
        });
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-keyword">if</span> (dto.getItems() == <span class="hljs-literal">null</span> || dto.getItems().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单商品不能为空"</span>);
        }
        
        <span class="hljs-keyword">if</span> (dto.getTotalAmount() == <span class="hljs-literal">null</span> || dto.getTotalAmount().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单金额必须大于0"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">3. Controller层示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(
            <span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> OrderCreateDTO dto)</span> {
        
        log.info(<span class="hljs-string">"创建订单，用户：{}，商品数量：{}"</span>, 
                dto.getUserId(), dto.getItems().size());
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(dto);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
    
    <span class="hljs-meta">@PostMapping("/{orderId}/cancel")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        orderService.cancelOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success();
    }
    
    <span class="hljs-meta">@GetMapping("/{orderId}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
}
</code></pre>
<h3 data-id="heading-22">七、测试你的异常处理器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-23">1. 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@AutoConfigureMockMvc</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandlerTest</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBusinessException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/business-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"业务异常测试"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testValidationException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(post(<span class="hljs-string">"/api/users"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{\"username\":\"\"}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).contains(<span class="hljs-string">"不能为空"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSystemException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/system-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">500</span>));
    }
}
</code></pre>
<h4 data-id="heading-24">2. 集成测试异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebMvcTest(OrderController.class)</span>
<span class="hljs-meta">@Import(GlobalExceptionHandler.class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderControllerExceptionTest</span> {
    
    <span class="hljs-meta">@MockBean</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder_InsufficientStock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 模拟库存不足异常</span>
        when(orderService.createOrder(any()))
                .thenThrow(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(<span class="hljs-number">1L</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>));
        
        mockMvc.perform(post(<span class="hljs-string">"/orders"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{...}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(ErrorCode.INSUFFICIENT_STOCK.getCode()))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"商品[1]库存不足，需要10，可用5"</span>));
    }
}
</code></pre>
<h3 data-id="heading-25">八、个人建议性能与注意事项</h3>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<h4 data-id="heading-26">1. 性能考虑</h4>
<ul>
<li>异常创建开销：异常对象的创建比普通对象开销大</li>
<li>栈追踪开销：<code>fillInStackTrace()</code>方法比较耗时</li>
<li>建议：对于频繁发生的业务异常，考虑使用错误码而非异常</li>
</ul>
<h3 data-id="heading-27">总结</h3>
<p>今天我们一起构建了一个完整的全局异常处理体系：</p>
<ol>
<li><strong>核心机制</strong>：<code>@RestControllerAdvice</code> + <code>@ExceptionHandler</code></li>
<li><strong>异常体系</strong>：业务异常与系统异常分离</li>
<li><strong>统一响应</strong>：标准化的响应格式</li>
<li><strong>日志记录</strong>：完整的异常上下文信息</li>
<li><strong>多环境适配</strong>：开发/生产环境差异化处理</li>
<li><strong>最佳实践</strong>：参数校验、Sentinel集成等</li>
</ol>
<p>通过全局异常处理，我们实现了：</p>
<ul>
<li>✅ <strong>代码整洁</strong>：Controller层只有业务逻辑</li>
<li>✅ <strong>统一格式</strong>：所有异常响应格式一致</li>
<li>✅ <strong>易于维护</strong>：异常处理逻辑集中管理</li>
<li>✅ <strong>便于监控</strong>：异常日志完整记录</li>
</ul>
<h3 data-id="heading-28">今日思考题</h3>
<p>在你的项目中，有没有遇到过以下情况：</p>
<ol>
<li>某个第三方接口频繁超时，需要特殊处理</li>
<li>不同微服务之间的异常需要统一处理</li>
<li>需要根据用户类型返回不同的错误信息</li>
</ol>
<p>你是如何解决这些问题的？欢迎在评论区分享你的经验！</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot配置文件：一个注解搞定多环境配置！》，学习如何优雅管理不同环境的配置。</p>
<p><strong>互动时间</strong>：你在异常处理中遇到过哪些"坑"？或者有哪些更好的实践建议？</p>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong>     回复"异常处理源码"，获取本文所有示例代码及完整项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义简易日历]]></title>    <link>https://juejin.cn/post/7585897699603071002</link>    <guid>https://juejin.cn/post/7585897699603071002</guid>    <pubDate>2025-12-22T02:25:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603071002" data-draft-id="7585888537641959439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义简易日历"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:25:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风往哪边走"/> <meta itemprop="url" content="https://juejin.cn/user/3433151760706957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义简易日历
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3433151760706957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风往哪边走
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:25:59.000Z" title="Mon Dec 22 2025 02:25:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义简易日历</h2>
<ul>
<li>
<blockquote>
<p>当前月份日期可点击选中</p>
</blockquote>
</li>
<li>
<blockquote>
<p>今天日期有红色圆圈标记</p>
</blockquote>
</li>
<li>
<blockquote>
<p>跨月日期为灰色，不可点击</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可切换上个月/下个月</p>
</blockquote>
</li>
<li>
<blockquote>
<p>支持回到今天</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可以设置红点绿点日期。比如打卡日期</p>
</blockquote>
</li>
</ul>
<h2 data-id="heading-1">自定义日历<code>SimpleCalendarView.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar


<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.graphics.Canvas
<span class="hljs-keyword">import</span> android.graphics.Color
<span class="hljs-keyword">import</span> android.graphics.Paint
<span class="hljs-keyword">import</span> android.graphics.RectF
<span class="hljs-keyword">import</span> android.graphics.Typeface
<span class="hljs-keyword">import</span> android.util.AttributeSet
<span class="hljs-keyword">import</span> android.view.MotionEvent
<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> kotlin.math.min

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCalendarView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>,
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-comment">// 颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayColor = Color.RED
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> normalTextColor = Color.BLACK
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedTextColor = Color.WHITE
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> otherMonthTextColor = Color.parseColor(<span class="hljs-string">"#CCCCCC"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> gridLineColor = Color.parseColor(<span class="hljs-string">"#E0E0E0"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekBackgroundColor = Color.parseColor(<span class="hljs-string">"#F5F5F5"</span>)

    <span class="hljs-comment">// 新增：红点和绿点颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotColor = Color.parseColor(<span class="hljs-string">"#FF4444"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)

    <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentYear: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.YEAR)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentMonth: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> selectedDate: Calendar? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> today: Calendar = Calendar.getInstance()

    <span class="hljs-comment">// 新增：存储需要显示点的日期</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotDates = mutableSetOf&lt;String&gt;() <span class="hljs-comment">// 格式: "2024-01-15"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotDates = mutableSetOf&lt;String&gt;()

    <span class="hljs-comment">// 画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 新增：点画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> weekHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 新增：点相关尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotRadius: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotSpacing: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 监听器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> onDateClickListener: ((year: <span class="hljs-built_in">Int</span>, month: <span class="hljs-built_in">Int</span>, day: <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 星期标题</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekDays = arrayOf(<span class="hljs-string">"日"</span>, <span class="hljs-string">"一"</span>, <span class="hljs-string">"二"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-string">"四"</span>, <span class="hljs-string">"五"</span>, <span class="hljs-string">"六"</span>)

    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 初始化画笔</span>
        paint.color = normalTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        paint.textAlign = Paint.Align.CENTER

        weekPaint.color = normalTextColor
        weekPaint.textSize = spToPx(<span class="hljs-number">18f</span>)
        weekPaint.textAlign = Paint.Align.CENTER
        weekPaint.typeface = Typeface.DEFAULT_BOLD

        selectedPaint.color = selectedColor
        selectedPaint.style = Paint.Style.FILL

        todayPaint.color = todayColor
        todayPaint.style = Paint.Style.STROKE
        todayPaint.strokeWidth = <span class="hljs-number">3f</span>

        <span class="hljs-comment">// 初始化点画笔</span>
        redDotPaint.color = redDotColor
        redDotPaint.style = Paint.Style.FILL

        greenDotPaint.color = greenDotColor
        greenDotPaint.style = Paint.Style.FILL

        <span class="hljs-comment">// 设置初始选中日期为今天</span>
        selectedDate = today.clone() <span class="hljs-keyword">as</span> Calendar
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthMeasureSpec: <span class="hljs-type">Int</span>, heightMeasureSpec: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> width = MeasureSpec.getSize(widthMeasureSpec)
<span class="hljs-comment">//        val height = (width * 6 / 7f).toInt()</span>
        setMeasuredDimension(width, width)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSizeChanged</span><span class="hljs-params">(w: <span class="hljs-type">Int</span>, h: <span class="hljs-type">Int</span>, oldw: <span class="hljs-type">Int</span>, oldh: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onSizeChanged(w, h, oldw, oldh)

        cellWidth = w / <span class="hljs-number">7f</span>
        weekHeight = h * <span class="hljs-number">0.15f</span>
        cellHeight = (h - weekHeight) / <span class="hljs-number">6f</span>

        <span class="hljs-comment">// 计算点的尺寸</span>
        dotRadius = dpToPx(<span class="hljs-number">2f</span>)
        dotSpacing = dpToPx(<span class="hljs-number">1f</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)

        <span class="hljs-comment">// 绘制白色背景</span>
        canvas.drawColor(Color.WHITE)

        <span class="hljs-comment">// 绘制星期栏</span>
        drawWeekBackground(canvas)
        drawWeekDays(canvas)

        <span class="hljs-comment">// 绘制日期</span>
        drawDates(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekBackground</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> rect = RectF(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, width.toFloat(), weekHeight)
        paint.color = weekBackgroundColor
        paint.style = Paint.Style.FILL
        canvas.drawRect(rect, paint)
        paint.style = Paint.Style.FILL
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> baseline = weekHeight * <span class="hljs-number">0.7f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> weekDays.indices) {
            <span class="hljs-keyword">val</span> x = i * cellWidth + cellWidth / <span class="hljs-number">2</span>
            canvas.drawText(weekDays[i], x, baseline, weekPaint)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDates</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-comment">// 设置当前月份第一天</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月实际天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 绘制当前月份日期</span>
        <span class="hljs-keyword">for</span> (day <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            drawDateCell(canvas, day, firstDayOfWeek, daysInMonth, <span class="hljs-literal">true</span>)
        }

        <span class="hljs-comment">// 绘制跨月日期（灰色，不可点击）</span>
        drawOtherMonthDays(canvas, firstDayOfWeek, daysInMonth)

        <span class="hljs-comment">// 绘制网格线</span>
        drawGridLines(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDateCell</span><span class="hljs-params">(
        canvas: <span class="hljs-type">Canvas</span>,
        day: <span class="hljs-type">Int</span>,
        firstDayOfWeek: <span class="hljs-type">Int</span>,
        daysInMonth: <span class="hljs-type">Int</span>,
        isCurrentMonth: <span class="hljs-type">Boolean</span>,
    )</span></span> {
        <span class="hljs-keyword">val</span> position = firstDayOfWeek + (day - <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>

        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 检查是否为选中日期</span>
        <span class="hljs-keyword">val</span> isSelected = selectedDate?.let {
            it.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day
        } ?: <span class="hljs-literal">false</span>

        <span class="hljs-comment">// 检查是否为今天</span>
        <span class="hljs-keyword">val</span> isToday = today.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day

        <span class="hljs-comment">// 绘制选中背景</span>
        <span class="hljs-keyword">if</span> (isSelected &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.3f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, selectedPaint)
        }

        <span class="hljs-comment">// 绘制今天圆圈</span>
        <span class="hljs-keyword">if</span> (isToday &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.35f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, todayPaint)
        }

        <span class="hljs-comment">// 绘制日期文字</span>
        paint.color = <span class="hljs-keyword">when</span> {
            isSelected -&gt; selectedTextColor
            <span class="hljs-keyword">else</span> -&gt; normalTextColor
        }

        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 新增：绘制红点和绿点（仅在当前月份日期显示）</span>
        <span class="hljs-keyword">if</span> (isCurrentMonth) {
            <span class="hljs-keyword">val</span> dateKey = formatDateKey(currentYear, currentMonth, day)

            <span class="hljs-keyword">val</span> redDotExists = redDotDates.contains(dateKey)
            <span class="hljs-keyword">val</span> greenDotExists = greenDotDates.contains(dateKey)

            <span class="hljs-comment">// 计算点的位置</span>
            <span class="hljs-keyword">val</span> dotY = y + paint.textSize / <span class="hljs-number">2</span> + dotSpacing

            <span class="hljs-comment">// 如果只有一种点，居中显示</span>
            <span class="hljs-keyword">when</span> {
                redDotExists &amp;&amp; greenDotExists -&gt; {
                    <span class="hljs-comment">// 两种点都存在，在左右两侧显示</span>
                    <span class="hljs-keyword">val</span> leftX = x - dotRadius * <span class="hljs-number">1.5f</span>
                    <span class="hljs-keyword">val</span> rightX = x + dotRadius * <span class="hljs-number">1.5f</span>
                    canvas.drawCircle(leftX, dotY, dotRadius, redDotPaint)
                    canvas.drawCircle(rightX, dotY, dotRadius, greenDotPaint)
                }

                redDotExists -&gt; {
                    <span class="hljs-comment">// 只有红点</span>
                    canvas.drawCircle(x, dotY, dotRadius, redDotPaint)
                }

                greenDotExists -&gt; {
                    <span class="hljs-comment">// 只有绿点</span>
                    canvas.drawCircle(x, dotY, dotRadius, greenDotPaint)
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, firstDayOfWeek: <span class="hljs-type">Int</span>, daysInMonth: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 绘制上个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">if</span> (firstDayOfWeek &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> prevMonthCalendar = Calendar.getInstance().apply {
                <span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
                add(Calendar.MONTH, -<span class="hljs-number">1</span>)
            }
            <span class="hljs-keyword">val</span> daysInPrevMonth = getMonthDays(
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
            )

            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until firstDayOfWeek) {
                <span class="hljs-keyword">val</span> day = daysInPrevMonth - firstDayOfWeek + i + <span class="hljs-number">1</span>
                <span class="hljs-keyword">val</span> row = <span class="hljs-number">0</span>
                <span class="hljs-keyword">val</span> col = i
                drawOtherMonthDate(canvas, row, col, day)
            }
        }

        <span class="hljs-comment">// 绘制下个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">val</span> totalRows = <span class="hljs-number">6</span>
        <span class="hljs-keyword">val</span> totalCells = totalRows * <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> cellsUsedByCurrentMonth = firstDayOfWeek + daysInMonth
        <span class="hljs-keyword">val</span> remainingCells = totalCells - cellsUsedByCurrentMonth

        <span class="hljs-keyword">if</span> (remainingCells &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> nextMonthDay = <span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until remainingCells) {
                <span class="hljs-keyword">val</span> position = cellsUsedByCurrentMonth + i
                <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
                <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>
                drawOtherMonthDate(canvas, row, col, nextMonthDay)
                nextMonthDay++
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDate</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, row: <span class="hljs-type">Int</span>, col: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 保存当前画笔状态</span>
        <span class="hljs-keyword">val</span> originalColor = paint.color
        <span class="hljs-keyword">val</span> originalTextSize = paint.textSize

        <span class="hljs-comment">// 绘制跨月日期文字（灰色）</span>
        paint.color = otherMonthTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 恢复画笔状态</span>
        paint.color = originalColor
        paint.textSize = originalTextSize
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawGridLines</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        paint.color = gridLineColor
        paint.strokeWidth = <span class="hljs-number">1f</span>

        <span class="hljs-comment">// 绘制星期栏底部分隔线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, weekHeight, width.toFloat(), weekHeight, paint)

        <span class="hljs-comment">// 绘制垂直线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> until <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">val</span> x = i * cellWidth
            canvas.drawLine(x, weekHeight, x, height.toFloat(), paint)
        }

        <span class="hljs-comment">// 绘制水平线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.6</span>) {
            <span class="hljs-keyword">val</span> y = weekHeight + i * cellHeight
            canvas.drawLine(<span class="hljs-number">0f</span>, y, width.toFloat(), y, paint)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTouchEvent</span><span class="hljs-params">(event: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">when</span> (event.action) {
            MotionEvent.ACTION_DOWN -&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            MotionEvent.ACTION_UP -&gt; {
                handleClick(event.x, event.y)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onTouchEvent(event)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleClick</span><span class="hljs-params">(x: <span class="hljs-type">Float</span>, y: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">if</span> (y &lt; weekHeight) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 计算点击的行列</span>
        <span class="hljs-keyword">val</span> row = ((y - weekHeight) / cellHeight).toInt()
        <span class="hljs-keyword">val</span> col = (x / cellWidth).toInt()

        <span class="hljs-keyword">if</span> (row &lt; <span class="hljs-number">0</span> || row &gt;= <span class="hljs-number">6</span> || col &lt; <span class="hljs-number">0</span> || col &gt;= <span class="hljs-number">7</span>) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 获取当前月份第一天是星期几</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 计算点击的日期索引</span>
        <span class="hljs-keyword">val</span> position = row * <span class="hljs-number">7</span> + col
        <span class="hljs-keyword">val</span> dayIndex = position - firstDayOfWeek + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (dayIndex <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            <span class="hljs-comment">// 点击当前月份日期</span>
            selectDate(currentYear, currentMonth, dayIndex)
        }
        <span class="hljs-comment">// 跨月日期不可点击，不做任何处理</span>
    }

    <span class="hljs-comment">/**
     * 获取月份天数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMonthDays</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> isLeapYear = (year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span>) || (year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (month) {
            <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span> -&gt; <span class="hljs-number">31</span>
            <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span> -&gt; <span class="hljs-number">30</span>
            <span class="hljs-number">1</span> -&gt; <span class="hljs-keyword">if</span> (isLeapYear) <span class="hljs-number">29</span> <span class="hljs-keyword">else</span> <span class="hljs-number">28</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">0</span>
        }
    }

    <span class="hljs-comment">/**
     * 选择日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 如果选择的日期不在当前月份，先切换到该月份</span>
        <span class="hljs-keyword">if</span> (year != currentYear || month != currentMonth) {
            currentYear = year
            currentMonth = month
        }

        <span class="hljs-comment">// 设置选中日期</span>
        selectedDate = Calendar.getInstance().apply {
            <span class="hljs-keyword">set</span>(year, month, day)
        }

        <span class="hljs-comment">// 重绘</span>
        invalidate()

        <span class="hljs-comment">// 回调</span>
        onDateClickListener?.invoke(year, month, day)
    }

    <span class="hljs-comment">/**
     * 新增：设置红点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setRedDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        redDotDates.clear()
        redDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：设置绿点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setGreenDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        greenDotDates.clear()
        greenDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有红点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearRedDotDates</span><span class="hljs-params">()</span></span> {
        redDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有绿点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearGreenDotDates</span><span class="hljs-params">()</span></span> {
        greenDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：格式化日期键
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDateKey</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d-%02d-%02d"</span>, year, month + <span class="hljs-number">1</span>, day)
    }

    <span class="hljs-comment">/**
     * 设置当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCurrentMonth</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span> {
        currentYear = year
        currentMonth = month
        invalidate()
    }

    <span class="hljs-comment">/**
     * 获取当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentMonth</span><span class="hljs-params">()</span></span>: Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt; {
        <span class="hljs-keyword">return</span> Pair(currentYear, currentMonth)
    }

    <span class="hljs-comment">/**
     * 获取选中的日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSelectedDate</span><span class="hljs-params">()</span></span>: Triple&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;? {
        <span class="hljs-keyword">return</span> selectedDate?.let {
            Triple(
                it.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                it.<span class="hljs-keyword">get</span>(Calendar.MONTH),
                it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
            )
        }
    }

    <span class="hljs-comment">/**
     * 切换到上个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">previousMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth - <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &lt; <span class="hljs-number">0</span>) {
            newYear--
            newMonth = <span class="hljs-number">11</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 切换到下个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &gt; <span class="hljs-number">11</span>) {
            newYear++
            newMonth = <span class="hljs-number">0</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 回到今天
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goToToday</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> now = Calendar.getInstance()
        currentYear = now.<span class="hljs-keyword">get</span>(Calendar.YEAR)
        currentMonth = now.<span class="hljs-keyword">get</span>(Calendar.MONTH)
        selectedDate = now.clone() <span class="hljs-keyword">as</span> Calendar
        invalidate()

        <span class="hljs-comment">// 回调今天的日期</span>
        onDateClickListener?.invoke(
            currentYear,
            currentMonth,
            now.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
        )
    }

    <span class="hljs-comment">/**
     * 设置日期点击监听器
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnDateClickListener</span><span class="hljs-params">(listener: (<span class="hljs-type">year</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">month</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">day</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">this</span>.onDateClickListener = listener
    }

    <span class="hljs-comment">/**
     * sp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">spToPx</span><span class="hljs-params">(sp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> sp * resources.displayMetrics.scaledDensity
    }

    <span class="hljs-comment">/**
     * 新增：dp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dpToPx</span><span class="hljs-params">(dp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> dp * resources.displayMetrics.density
    }
}
</code></pre>
<h2 data-id="heading-2">样例布局<code>activity_main.xml</code></h2>
<pre><code class="hljs language-ini" lang="ini">&lt;?xml <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/main"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
    tools:<span class="hljs-attr">context</span>=<span class="hljs-string">".MainActivity"</span>&gt;

    &lt;!-- 标题 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"简易日历"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 月份导航 --&gt;
    &lt;LinearLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/prevMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"◀ 上个月"</span> /&gt;

        &lt;TextView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/monthYearTextView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"16dp"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"2024年2月"</span>
            android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
            android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/nextMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"下个月 ▶"</span> /&gt;
    &lt;/LinearLayout&gt;

    &lt;!-- 日历视图 --&gt;
    &lt;cn.nio.calendar.SimpleCalendarView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/calendarView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;

    &lt;!-- 选中的日期 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/selectedDateTextView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"选中: 2024年2月15日"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"13sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 回到今天按钮 --&gt;
    &lt;Button
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/todayButton"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"12dp"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"回到今天"</span> /&gt;


&lt;/LinearLayout&gt;
</code></pre>
<h2 data-id="heading-3">样例<code>MainActivity.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar

<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.widget.Button
<span class="hljs-keyword">import</span> android.widget.TextView
<span class="hljs-keyword">import</span> androidx.activity.enableEdgeToEdge
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity
<span class="hljs-keyword">import</span> androidx.core.view.ViewCompat
<span class="hljs-keyword">import</span> androidx.core.view.WindowInsetsCompat
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> java.util.Locale

<span class="hljs-comment">/**
 * 简易日历
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> calendarView: SimpleCalendarView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> monthYearTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> selectedDateTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> prevMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> nextMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> todayButton: Button

    <span class="hljs-comment">//    private val monthFormat = SimpleDateFormat("yyyy年MM月", Locale.getDefault())</span>
<span class="hljs-comment">//    private val dateFormat = SimpleDateFormat("yyyy年MM月dd日", Locale.getDefault())</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_main)
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets -&gt;
            <span class="hljs-keyword">val</span> systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }

        <span class="hljs-comment">// 初始化视图</span>
        calendarView = findViewById(R.id.calendarView)
        monthYearTextView = findViewById(R.id.monthYearTextView)
        selectedDateTextView = findViewById(R.id.selectedDateTextView)
        prevMonthButton = findViewById(R.id.prevMonthButton)
        nextMonthButton = findViewById(R.id.nextMonthButton)
        todayButton = findViewById(R.id.todayButton)

        <span class="hljs-comment">// 初始化显示</span>
        updateMonthYearText()
        updateSelectedDateText()

        <span class="hljs-comment">// 点击选中日期</span>
        calendarView.setOnDateClickListener { year, month, day -&gt;
            updateSelectedDateText()
        }

        <span class="hljs-comment">// 上个月</span>
        prevMonthButton.setOnClickListener {
            calendarView.previousMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 下个月</span>
        nextMonthButton.setOnClickListener {
            calendarView.nextMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 回到今天</span>
        todayButton.setOnClickListener {
            calendarView.goToToday()
            updateMonthYearText()
            updateSelectedDateText()
        }
        calculatePreviousDaysWithCalendar()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateMonthYearText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> (year, month) = calendarView.getCurrentMonth()
        monthYearTextView.text = <span class="hljs-string">"<span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月"</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateSelectedDateText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> selectedDate = calendarView.getSelectedDate()
        selectedDate?.let { (year, month, day) -&gt;
            selectedDateTextView.text = <span class="hljs-string">"选中: <span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月<span class="hljs-subst">${day}</span>日"</span>
        }
    }

    <span class="hljs-comment">/**
     *  设置红点绿点日期
     *
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculatePreviousDaysWithCalendar</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
        <span class="hljs-keyword">val</span> sdf = SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd"</span>, Locale.getDefault()) <span class="hljs-comment">// 线程不安全，多线程需注意</span>

        <span class="hljs-comment">// 计算前1天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous1DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前2天（在原基础上再减1）</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous2DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前3天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous3DayStr = sdf.format(calendar.time)

        <span class="hljs-comment">// 重置Calendar到当前时间（可选）</span>
        calendar.add(Calendar.DAY_OF_MONTH, <span class="hljs-number">3</span>)

        println(<span class="hljs-string">"当前日期：<span class="hljs-subst">${sdf.format(Calendar.getInstance().time)}</span>"</span>)
        println(<span class="hljs-string">"前1天：<span class="hljs-variable">$previous1DayStr</span>"</span>)
        println(<span class="hljs-string">"前2天：<span class="hljs-variable">$previous2DayStr</span>"</span>)
        println(<span class="hljs-string">"前3天：<span class="hljs-variable">$previous3DayStr</span>"</span>)
        calendarView.setGreenDotDates(listOf(previous1DayStr, previous3DayStr))
        calendarView.setRedDotDates(listOf(previous2DayStr))
    }

}
</code></pre>
<h2 data-id="heading-4">效果展示</h2>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6c727db18440388ec3692f986b832b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5b6A5ZOq6L656LWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975159&amp;x-signature=BcwkkKd7sz9gpiujJpXtA37S1W8%3D" alt="Screen_recording_20251222_100250 00_00_00-00_00_30.gif" width="50%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>