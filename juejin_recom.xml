<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[pxcharts 多维表格开源！一款专为开发者和数据分析师打造的轻量化智能表格]]></title>    <link>https://juejin.cn/post/7586569284551606312</link>    <guid>https://juejin.cn/post/7586569284551606312</guid>    <pubDate>2025-12-23T03:14:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551606312" data-draft-id="7586570254861549608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pxcharts 多维表格开源！一款专为开发者和数据分析师打造的轻量化智能表格"/> <meta itemprop="keywords" content="前端,GitHub,架构"/> <meta itemprop="datePublished" content="2025-12-23T03:14:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐小夕"/> <meta itemprop="url" content="https://juejin.cn/user/3808363978429613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pxcharts 多维表格开源！一款专为开发者和数据分析师打造的轻量化智能表格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363978429613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐小夕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:14:52.000Z" title="Tue Dec 23 2025 03:14:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上期和大家分享了我们精心打磨的协同AI文档 <strong>JitWord</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a36f77042543f7bed4f68d70d2d2e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=xCPT3ZLGsa85moB6ERYNNnU909o%3D" alt="图片" loading="lazy"/></p>
<p>最近一直在迭代 <strong>JitWord</strong> 协同文档和 <strong>Pxcharts</strong> 智能表格，收到了很多粉丝的反馈。为了让更多用户和开发者能了解多维表格的技术实现以及核心的一些技术架构难点，我花了两周时间，做了一款开源版的多维表格：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63374d189f25481fba68a5ce6d53f9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=utWdegWRFxunNR8S2n4sLMfr4nY%3D" alt="图片" loading="lazy"/></p>
<p><strong>Pxcharts</strong> 开源版支持各种复杂表格的功能，比如列拖拽排序，拖拽调整宽度，字段管理，行排序，各种复杂筛选，多视图管理等，还能轻松集成AI功能，实现AI多维表格。话不多说，先上开源地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMrXujiang%2Fpxcharts" target="_blank" title="https://github.com/MrXujiang/pxcharts" ref="nofollow noopener noreferrer">github.com/MrXujiang/p…</a></p>
<p>接下来就和大家详细介绍一下这款开源多维表格。</p>
<h2 data-id="heading-0">为什么要做pxcharts多维表，还开源了？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cede2e590e404b61ada224fc5bd166b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=VE%2FS4%2FoOI53%2F%2BDbukNsMes538kc%3D" alt="图片" loading="lazy"/></p>
<p>多维表格不是传统电子表格的 “升级版”，而是<strong>融合了表格的灵活、数据库的结构化、看板的可视化、表单的采集能力</strong>的一站式协作工具。它的核心价值在于<strong>打破 “数据孤岛”，让非技术人员也能快速搭建个性化业务系统</strong>，适配从个人管理到团队协作的全场景需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2adeba536f884c6eaf4edc9ffc457702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=Ci%2B1xzFka76U4Kamlci4xpzax4s%3D" alt="图片" loading="lazy"/></p>
<p>其实我在3年前就开始研究多维表格的应用场景和技术实现了，之所以要做，是因为目前市面上没有比较好的开源方案，更多的只是对基础表格的封装，并不能达到复杂的业务管理和多视图管理的能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db866687c3b74fe0aac6f1b048c593ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=mGRp7eC%2FbVx969rZ7vkDRAU7cWY%3D" alt="图片" loading="lazy"/></p>
<p>所以分析了大量应用场景和目前的开源方案之后，我觉得有必要做一款拿得出手的多维表格解决方案。pxcharts多维表格开源版的功能亮点接下来和大家分享一下pxcharts多维表格开源版的功能亮点，让大家更好的感受它的价值。</p>
<p>1. <strong>多视图支持</strong> - 表格视图、看板视图、人员分配视图，满足不同场景需求</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de865ea0ca754a238c4cc5567a1e6d4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=IdvyOLPM98N6JfHCMLJwtj3oqow%3D" alt="图片" loading="lazy"/></p>
<ol start="2">
<li> <strong>精美UI设计</strong> - 基于 shadcn/ui + Tailwind CSS，简洁现代的界面风格</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc1081545fc1484fa127dbf224150112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=Nq6h23dYRzEY%2F0jg2pSdB84jZRA%3D" alt="图片" loading="lazy"/></p>
<p>3. <strong>拖拽排序</strong> - 支持任务拖拽排序、列拖拽排序，灵活自定义</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f9c3705b84a412589e01f579a9c44a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=GzjFdnqZkHSfzx%2BdCSGpVm8xwI0%3D" alt="图片" loading="lazy"/><br/>
<strong>4. 数据统计</strong> - 内置任务统计看板，数据可视化展示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f46e210d5f8448db21aa948f29075c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=mugWViheHyQ994rFbLgJ%2Fuc43lg%3D" alt="图片" loading="lazy"/></p>
<p><strong>5. 高级筛选</strong> - 支持条件筛选、排序、分组，快速定位目标数据</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb11dbfb8024f5cae072ee3b4428d24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=Lw1cGaMS5Li%2FjDDsIwRzRdoxShk%3D" alt="图片" loading="lazy"/><br/>
<strong>6. 数据导入导出</strong> - 支持 JSON 格式的数据导入导出</p>
<p><strong>7. 自定义字段</strong> - 支持添加自定义字段，灵活扩展数据结构</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4b30df1048c4751824b87dc4be80739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=o3rqMnWMB63n%2BFSKYuV99XAtRNY%3D" alt="图片" loading="lazy"/></p>
<p><strong>8. 性能优化</strong> - 基于pxcharts独有的渲染引擎，支持高性能渲染(Ultra版)</p>
<p>当然还有很多功能，大家可以本地体验。</p>
<h2 data-id="heading-1">技术实现</h2>
<p>多维表格我采用了分层设计架构，分为如下几个模块：</p>
<ol>
<li><strong>应用层</strong>App Router，处理路由和页面级配置</li>
<li><strong>视图层</strong>独立的视图组件，负责不同功能模块的展示</li>
<li><strong>业务组件层</strong>可复用的业务组件，封装特定业务逻辑</li>
<li><strong>UI组件层</strong>通用UI组件，无业务逻辑</li>
<li><strong>数据层</strong>统一的状态管理和数据操作</li>
<li><strong>工具层</strong>公共工具函数和自定义Hooks</li>
</ol>
<p> 所有的分层模块我都采用了企业级组件架构，下面简单给大家介绍一下：</p>
<ol>
<li>视图层</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5633177bbd1d4619b1eb1a0dfce3cb04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=OfGGvwLS%2F%2FKBEcxP%2BiIULGIPTuM%3D" alt="图片" loading="lazy"/></p>
<ol start="2">
<li>业务层</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7aa1a3ff164bc4bff9c0b9cc9be7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=smYJl3f7I35%2F7qUU1FtSI1wrpJ0%3D" alt="图片" loading="lazy"/></p>
<ol start="3">
<li>UI层</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39d5e2a7be7c42e8823609ec469bcacb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=J%2B0Cg%2BiMOpsnpl7dvfc6HHxYIco%3D" alt="图片" loading="lazy"/></p>
<ol start="4">
<li>数据层</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8c18cc098444753a3717a80dbed8bb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=58wBL%2BbbkUwl3x6max%2BkVHPvAXg%3D" alt="图片" loading="lazy"/></p>
<ol start="5">
<li>工具层</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/059947e0392e46cabe1e27d1352f104a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=5u1wkF1s3OOjxI2xfHP6XFK%2BqBw%3D" alt="图片" loading="lazy"/></p>
<p>这种架构设计可以适配各种企业级复杂系统，如果大家在做架构相关的功能，也可以参考一下。接下来给大家分享一下 pxcharts 开源版的代码组织规范：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eea277b83fa4c30a46617fda50c4c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064491&amp;x-signature=NWDm8y0EXkC7PAl7s7cQ0ujMpO8%3D" alt="image.png" loading="lazy"/></p>
<p>之所以要分享这个模块，是因为我的架构专栏中很多粉丝想学习架构设计和代码规范，这里就和大家分享一下我常用工程组织规则。</p>
<h2 data-id="heading-2">快速开始（本地启动开发指南）</h2>
<p>首先我们先在电脑里准备一下环境，环境推荐：</p>
<ul>
<li>Node.js 18.17 或更高版本</li>
<li>pnpm 8.0 或更高版本（推荐）</li>
</ul>
<p>然后就可以轻松安装启动啦：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/MrXujiang/pxcharts.git
<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> pxcharts
<span class="hljs-comment"># 安装依赖</span>
pnpm install
<span class="hljs-comment"># 启动开发服务器</span>
pnpm dev
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> 就可以查看应用。</p>
<p>如果大家想部署到自己的服务器，可以参考下面的方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建</span>
pnpm build
<span class="hljs-comment"># 启动生产服务器</span>
pnpm start
</code></pre>
<p>如果大家想服务器运行更稳定，可以参考我架构专栏的服务器部署相关的教程。</p>
<p>最后，再发一下开源地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMrXujiang%2Fpxcharts" target="_blank" title="https://github.com/MrXujiang/pxcharts" ref="nofollow noopener noreferrer">github.com/MrXujiang/p…</a></p>
<p>如果项目对大家有帮助，不妨点个 star 支持一下哦～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[循序渐进 —— Flutter GetX 状态管理]]></title>    <link>https://juejin.cn/post/7586559672129568820</link>    <guid>https://juejin.cn/post/7586559672129568820</guid>    <pubDate>2025-12-23T02:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129568820" data-draft-id="7507820125945921590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="循序渐进 —— Flutter GetX 状态管理"/> <meta itemprop="keywords" content="Flutter,面试,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T02:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="人形打码机"/> <meta itemprop="url" content="https://juejin.cn/user/2085122730895063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            循序渐进 —— Flutter GetX 状态管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2085122730895063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    人形打码机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:56:07.000Z" title="Tue Dec 23 2025 02:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Flutter 应用开发中状态管理是重要的一环，目前成熟的状态管理插件有 provider，provider，getx 等，本文基于 getx 的使用及基本原理展开讨论，文末有具体工程示例链接；</p>
<h2 data-id="heading-0">1. GetX 的核心架构</h2>
<p>GetX 是一个轻量级的状态管理、依赖注入和路由管理框架，它的核心目标——&gt;</p>
<blockquote>
<p>减少样板代码，最大化开发效率</p>
</blockquote>
<p>从更新原理及工程整合上与 provider 及 bloc 的差异</p>









































<table><thead><tr><th>维度</th><th>Provider</th><th>BLoC</th><th>GetX</th></tr></thead><tbody><tr><td>是否依赖 context</td><td>强</td><td>中</td><td>❌ 不需要</td></tr><tr><td>状态更新模型</td><td>rebuild</td><td>event → state</td><td>响应式 / 命令式</td></tr><tr><td>样板代码</td><td>少</td><td>多</td><td>极少</td></tr><tr><td>生命周期</td><td>Widget 驱动</td><td>BLoC 显式控制</td><td>Route + SmartManagement</td></tr><tr><td>工程整合度</td><td>低</td><td>中</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-1">1.1 响应式编程模型</h3>
<p>GetX 的响应式编程基于观察者模式（Observer Pattern）实现。当一个被观察的变量（使用<code>.obs</code>标记）发生变化时，所有依赖该变量的 UI 组件都会自动重建。</p>
<p>内部实现上，GetX 使用了一个名为 <code>GetStream</code>的流（Stream）来管理状态变化。当可观察对象的值发生变化时，会触发流中的事件，从而通知所有监听者。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RxImpl</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
 <span class="hljs-keyword">final</span> _subject = GetStream&lt;T&gt;();
 
 T <span class="hljs-keyword">get</span> value =&gt; _subject.value;
 <span class="hljs-keyword">set</span> value(T val) {
   _subject.add(val);  <span class="hljs-comment">// 触发流事件</span>
 }
}
</code></pre>
<h3 data-id="heading-2">1.2 依赖注入系统</h3>
<p>GetX 的依赖注入系统基于服务定位器模式（Service Locator Pattern）。它维护了一个全局的依赖实例映射表，通过类型或标签来查找和注册依赖项。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetInstance</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> _singl = &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;{};
  
  <span class="hljs-keyword">void</span> put&lt;S&gt;(S dependency, {<span class="hljs-built_in">String?</span> tag}) {
    _singl[_getKey(S, tag)] = dependency;
  }
  
  S find&lt;S&gt;({<span class="hljs-built_in">String?</span> tag}) {
    <span class="hljs-keyword">return</span> _singl[_getKey(S, tag)] <span class="hljs-keyword">as</span> S;
  }
  
  <span class="hljs-built_in">String</span> _getKey(<span class="hljs-built_in">Type</span> type, <span class="hljs-built_in">String?</span> tag) =&gt; tag == <span class="hljs-keyword">null</span> ? type.toString() : type.toString() + tag;
}
</code></pre>
<h3 data-id="heading-3">1.3 路由管理系统</h3>
<p>GetX 的路由管理是对 Flutter 原生导航 API 的封装，它维护了一个全局的路由历史栈，并提供了更简洁的 API 来管理页面导航。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetNavigation</span> </span>{
  <span class="hljs-keyword">final</span> _history = &lt;GetPage&gt;[];
  
  Future&lt;T?&gt; to&lt;T&gt;(GetPage page) {
    _history.add(page);
    <span class="hljs-keyword">return</span> Navigator.push(...);  <span class="hljs-comment">// 调用Flutter原生导航</span>
  }
  
  <span class="hljs-keyword">void</span> back() {
    _history.removeLast();
    Navigator.pop(...);  <span class="hljs-comment">// 调用Flutter原生导航</span>
  }
}
</code></pre>
<h2 data-id="heading-4">2. GetX 的工作原理</h2>
<h3 data-id="heading-5">2.1 状态管理原理</h3>
<h4 data-id="heading-6">简单状态管理</h4>
<p>简单状态管理使用 <code>GetBuilder</code>和 <code>update()</code>方法：</p>
<ol>
<li>当调用 <code>update()</code>时，GetX 会通知所有使用<code>GetBuilder</code>构建的与该控制器关联的 UI 组件进行重建</li>
<li>内部使用唯一 ID 来标识每个控制器实例，确保只有相关的 UI 组件会重建</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-keyword">void</span> update([<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? ids]) {
  <span class="hljs-keyword">if</span> (ids == <span class="hljs-keyword">null</span>) {
    <span class="hljs-comment">// 通知所有监听该控制器的UI组件</span>
    _notifyAllListeners();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 只通知特定ID的UI组件</span>
    _notifyListenersById(ids);
  }
}
</code></pre>
<h4 data-id="heading-7">响应式状态管理</h4>
<p>响应式状态管理使用 <code>.obs</code> 与 <code>Obx()</code></p>
<ol>
<li>
<p>当<code>.obs</code>变量的值发生变化时，会触发内部的 <code>GetStream</code></p>
</li>
<li>
<p><code>Obx()</code>组件会监听这些流的变化，并在值变化时自动重建 UI</p>
</li>
<li>
<p>GetX 使用了一个智能的差异算法，只重建依赖变化值的组件，而不是整个页面</p>
</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as Obx声明阶段
    participant B as 数据访问阶段
    participant C as 数据更新阶段
    participant D as UI重建阶段

    A-&gt;&gt;B: 创建_ObxState和RxNotifier
    B-&gt;&gt;C: 通过代理绑定观察者
    C-&gt;&gt;D: 触发setState重建
    Note right of D: 最小范围局部刷新
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Obx</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _ObxState createState() =&gt; _ObxState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ObxState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Obx</span>&gt; </span>{
  <span class="hljs-keyword">late</span> StreamSubscription _subscription;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 订阅可观察变量的变化</span>
    _subscription = _getStream().listen((_) {
      <span class="hljs-keyword">if</span> (mounted) setState(() {});  <span class="hljs-comment">// 触发UI重建</span>
    });
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 构建UI时会访问可观察变量，从而建立依赖关系</span>
    <span class="hljs-keyword">return</span> widget.builder();
  }
}
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant WidgetTree as Widget树
    participant ObxWidget as ObxWidget
    participant _ObxState as _ObxState
    participant RxNotifier as RxNotifier
    participant RxObject as Rx
    participant GetStream as GetStream

    WidgetTree-&gt;&gt;ObxWidget: 插入Obx组件
    ObxWidget-&gt;&gt;_ObxState: createState()
    _ObxState-&gt;&gt;RxNotifier: 创建_observer实例
    _ObxState-&gt;&gt;GetStream: 订阅监听(subs = _observer.listen)
    loop 构建阶段
        _ObxState-&gt;&gt;RxInterface: proxy = _observer
        RxObject--&gt;&gt;GetStream: 访问.value触发addListener
        RxObject-&gt;&gt;RxNotifier: 注册监听关系
        RxInterface--&gt;&gt;_ObxState: 恢复proxy原始值
    end
    Note over RxObject,RxNotifier: 建立双向绑定关系

    par 数据更新时
        RxObject-&gt;&gt;GetStream: 广播变化事件
        GetStream-&gt;&gt;RxNotifier: 通知_observer
        RxNotifier-&gt;&gt;_ObxState: 调用_updateTree
        _ObxState-&gt;&gt;WidgetTree: setState局部重建
    end
</code></pre>
<h3 data-id="heading-8">2.2 依赖注入原理</h3>
<p>GetX 的依赖注入系统支持多种注入方式：</p>
<ol>
<li>
<p><strong>常规注入</strong>（<code>Get.put</code>）：立即创建实例并注册</p>
</li>
<li>
<p><strong>懒加载注入</strong>（<code> Get.lazyPut</code>）：只在首次使用时创建实例</p>
</li>
<li>
<p><strong>异步注入</strong>（<code>Get.putAsync</code>）：异步创建实例</p>
</li>
<li>
<p><strong>一次性注入</strong>（<code>Get.create</code>）：每次获取都创建新实例</p>
</li>
</ol>
<p>内部实现上，GetX 使用工厂模式（Factory Pattern）来管理依赖的创建方式：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
<span class="hljs-keyword">void</span> lazyPut&lt;S&gt;(InstanceBuilderCallback&lt;S&gt; builder) {
  _factories[_getKey(S)] = builder;  <span class="hljs-comment">// 存储工厂函数</span>
}

S find&lt;S&gt;() {
  <span class="hljs-keyword">final</span> key = _getKey(S);
  <span class="hljs-keyword">if</span> (_singl.containsKey(key)) {
    <span class="hljs-keyword">return</span> _singl[key];  <span class="hljs-comment">// 返回已存在的实例</span>
  }
  
  <span class="hljs-keyword">if</span> (_factories.containsKey(key)) {
    <span class="hljs-keyword">final</span> instance = _factories[key]();  <span class="hljs-comment">// 调用工厂函数创建实例</span>
    _singl[key] = instance;  <span class="hljs-comment">// 缓存实例</span>
    <span class="hljs-keyword">return</span> instance;
  }
  
  <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'未找到依赖项'</span>);
}
</code></pre>
<h3 data-id="heading-9">2.3 路由管理原理</h3>
<p>GetX 的路由管理系统在内部维护了一个页面堆栈，并提供了丰富的导航方法：</p>
<ol>
<li>
<p><strong>基本导航</strong>：<code>Get.to()</code>  <code>Get.back()</code></p>
</li>
<li>
<p><strong>命名路由</strong>：<code>Get.toNamed()</code>  <code>Get.offNamed()</code></p>
</li>
<li>
<p><strong>替换导航</strong>：<code>Get.off()</code>   <code>Get.offAll()</code></p>
</li>
</ol>
<p>每个路由操作都会更新内部的页面堆栈，并调用 Flutter 原生的导航 API：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 简化的内部实现原理</span>
Future&lt;T?&gt; toNamed&lt;T&gt;(<span class="hljs-built_in">String</span> routeName, {<span class="hljs-built_in">dynamic</span> arguments}) {
  <span class="hljs-keyword">final</span> route = _findRouteByName(routeName);
  <span class="hljs-keyword">if</span> (route != <span class="hljs-keyword">null</span>) {
    _currentRoute = route;
    <span class="hljs-keyword">return</span> Navigator.of(context).pushNamed(routeName, arguments: arguments);
  }
  <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'未找到路由'</span>);
}
</code></pre>
<h2 data-id="heading-10">3. GetX 的优化机制</h2>
<h3 data-id="heading-11">3.1 内存管理</h3>
<p>GetX 提供了智能的内存管理机制：</p>
<ol>
<li>
<p><strong>自动释放</strong>：当控制器不再被使用时，默认会被自动释放</p>
</li>
<li>
<p><strong>永久实例</strong>：使用 <code>permanent: true</code> 参数可以创建永久实例</p>
</li>
<li>
<p><strong>智能实例</strong>：使用 <code>fenix: true</code> 参数可以在需要时重新创建已释放的实例</p>
</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 自动释放机制简化实现</span>
<span class="hljs-keyword">void</span> _autoRelease() {
  <span class="hljs-keyword">if</span> (!_isPermanent &amp;&amp; _getBuilderCount() == <span class="hljs-number">0</span>) {
    _singl.remove(_getKey(<span class="hljs-keyword">this</span>.runtimeType));
  }
}
</code></pre>
<h3 data-id="heading-12">3.2 性能优化</h3>
<p>GetX 在性能方面做了多项优化：</p>
<ol>
<li>
<p><strong>局部更新</strong>：只重建依赖变化数据的 UI 部分</p>
</li>
<li>
<p><strong>懒加载</strong>：只在需要时创建依赖实例</p>
</li>
<li>
<p><strong>按需构建</strong>：使用 <code>GetBuilder</code> id 参数可以更精确地控制 UI 更新范围</p>
</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 局部更新机制简化实现</span>
<span class="hljs-keyword">void</span> update([<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? ids]) {
  <span class="hljs-keyword">if</span> (ids == <span class="hljs-keyword">null</span>) {
    _notifyAllListeners();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 只通知特定ID的监听器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> id <span class="hljs-keyword">in</span> ids) {
      _notifyListenersById(id);
    }
  }
}
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[main.dart 启动] --&gt; B[AppStoreInternal 单例初始化]
    B --&gt; C[AppStore 构造函数执行]
    C --&gt; D[_connectivity.onConnectivityChanged.listen]
    D --&gt; E[等待网络状态变化]
    
    F[LottieJsonWidget initData] --&gt; G[延迟1秒]
    G --&gt; H[初始化环境配置]
    H --&gt; I[LoginUtils.setLoginRegion]
    I --&gt; J[LoginUtils.getIpCountryCode]
    J --&gt; K[LoginPluginApi.requestIpRegionIfNecessary]
    
    E --&gt; L[_updateConnectionStatus 被调用]
    L --&gt; M[networkChange 执行]
    M --&gt; N{网络状态判断}
    
    N --&gt;|有网络| O[await initUserInfo]
    N --&gt;|无网络| P[设置离线时间]
    
    O --&gt; Q[RESTApis.getUserInfo]
    Q --&gt; R[await getUserPrivilege]
    R --&gt; S[notifyListeners]
    
    K --&gt; T[异步获取IP地区]
    T --&gt; U[AppStoreInternal.store.setIpCountryCode]
    U --&gt; V[notifyListeners]
    
    S --&gt; W[UI更新]
    V --&gt; W
    
    X[App.onMounted] --&gt; Y[AppStoreInternal.store.setMainContext]
    Y --&gt; Z[检查网络状态]
    Z --&gt; AA[AppUpgradeUtils.checkUpgrade]
    
    BB[AppPages useMounted] --&gt; CC[init 函数]
    CC --&gt; DD{网络和登录状态检查}
    DD --&gt;|有网络且已登录| EE[ApplicationController.queryUserConfig]
    DD --&gt;|无网络或未登录| FF[跳过配置加载]
    
    EE --&gt; GG[PrintReportController.uploadIsarToService]
    
    style A fill:#e1f5fe
    style C fill:#fff3e0
    style L fill:#f3e5f5
    style O fill:#e8f5e8
    style T fill:#fff8e1
    style W fill:#fce4ec
</code></pre>
<h2 data-id="heading-13">工程示例</h2>
<pre><code class="hljs language-text" lang="text">lib/
├── app/
│   ├── controllers/       # 控制器（状态管理）
│   ├── modules/           # 各功能模块的UI页面
│   ├── routes/            # 路由管理
│   ├── translations/      # 国际化翻译
│   └── bindings/          # 依赖注入绑定
└── main.dart              # 应用入口
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flizy-coding%2Fgetx_demo" target="_blank" title="https://github.com/lizy-coding/getx_demo" ref="nofollow noopener noreferrer">github.com/lizy-coding…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ollmam+langchain.js实现本地大模型简单记忆对话-内存版]]></title>    <link>https://juejin.cn/post/7586597780640432138</link>    <guid>https://juejin.cn/post/7586597780640432138</guid>    <pubDate>2025-12-23T03:08:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780640432138" data-draft-id="7586505172815839283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ollmam+langchain.js实现本地大模型简单记忆对话-内存版"/> <meta itemprop="keywords" content="前端,LangChain,AIGC"/> <meta itemprop="datePublished" content="2025-12-23T03:08:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="樊小肆"/> <meta itemprop="url" content="https://juejin.cn/user/1257497033719320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ollmam+langchain.js实现本地大模型简单记忆对话-内存版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497033719320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    樊小肆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:08:51.000Z" title="Tue Dec 23 2025 03:08:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用Ollama与LangChain搭建本地大模型对话Demo</h2>
<h3 data-id="heading-1">前言</h3>
<p>本文将详细介绍如何使用Ollama与LangChain搭建一个本地大模型对话Demo，该Demo支持将聊天记录存储在内存中。涉及的依赖工具建议参考官方文档获取安装教程，此处不逐一赘述。</p>
<p>需注意，当前Demo需在Node.js 18+环境下运行，若使用低于该版本的Node环境，需自行寻找适配方案，以免运行失败。</p>
<h3 data-id="heading-2">为何选择Ollama？</h3>
<p>Ollama对本地部署场景支持友好，无需依赖云服务即可在本地运行大模型，且兼容多种开源模型，接口设计简洁易用。对于开发者和企业而言，本地部署在灵活性和成本控制上均优于频繁调用云接口。</p>
<h3 data-id="heading-3">为何选择LangChain？</h3>
<p>LangChain堪称大模型应用开发的“集成框架”，能够将大模型与各类数据、工具进行整合，使模型不仅支持基础对话，还能与外部环境交互。其对Node.js的原生支持对前端开发者尤为友好，可直接使用JavaScript开发大模型应用，降低技术栈切换成本。</p>
<h3 data-id="heading-4">Ollama 快速上手</h3>
<p>下载Ollama后，可前往官网Models页面选择合适的模型部署：需一个语言模型（如本文使用的deepseek-r1:1.5b）和一个文本嵌入模型（如mxbai-embed-large，用于语义搜索，检索效果优于单纯依赖语言模型）。</p>
<p>本地测试建议选择轻量版本以节省内存，生产环境则推荐完整版模型以保证性能。</p>
<h3 data-id="heading-5">代码实现：集成Ollama到应用中</h3>
<p>首先引入<code>@langchain/ollama</code>，通过<code>ChatOllama</code>实例化语言模型。本文使用deepseek-r1:1.5b，连接本地Ollama服务（默认地址为<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A11434" target="_blank" title="http://127.0.0.1:11434" ref="nofollow noopener noreferrer">http://127.0.0.1:11434</a>，若端口已修改需同步调整）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOllama</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/ollama"</span>;
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOllama</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-r1:1.5b'</span>,
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">"http://127.0.0.1:11434"</span>,
  <span class="hljs-attr">topP</span>: <span class="hljs-number">1.0</span>,
  <span class="hljs-attr">topK</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">streaming</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用流式输出，用于实现实时响应</span>
})
</code></pre>
<h3 data-id="heading-6">定义对话角色与提示词模板</h3>
<p>对话中需明确角色分工，通常包括系统（system）、用户（human）、助手（AI）三类角色，可通过<code>@langchain/core/messages</code>中的<code>HumanMessage</code>、<code>AIMessage</code>、<code>SystemMessage</code>实现。</p>
<p>使用<code>ChatPromptTemplate.fromMessages</code>定义提示词模板，便于处理多轮对话：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">const</span> textPrompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个具备记忆功能的智能助手，需结合历史对话内容回答用户问题。"</span>],
  [<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{chat_history}"</span>], <span class="hljs-comment">// 用于注入历史对话记录</span>
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>] <span class="hljs-comment">// 用于注入用户当前输入</span>
]);
</code></pre>
<p>说明：</p>
<ul>
<li><code>system</code>角色用于定义助手行为规则（如“保持专业语气”）；</li>
<li><code>human</code>角色对应用户输入内容；</li>
<li><code>placeholder</code>用于动态插入历史对话记录，确保模型能关联上下文。</li>
</ul>
<h3 data-id="heading-7">敏感词过滤机制</h3>
<p>为规范对话内容，需添加敏感词检查步骤。通过<code>RunnableLambda</code>封装自定义检查函数，在对话流程中拦截含敏感词的输入（如“傻瓜”“白痴”等）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableLambda</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">profanityChecker</span> = (<span class="hljs-params">input: { user_input: <span class="hljs-built_in">string</span> }</span>) =&gt; {
  <span class="hljs-keyword">const</span> sensitiveWords = [<span class="hljs-string">"傻瓜"</span>, <span class="hljs-string">"白痴"</span>, <span class="hljs-string">"不良内容"</span>];
  <span class="hljs-keyword">if</span> (sensitiveWords.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">word</span> =&gt;</span> input.<span class="hljs-property">user_input</span>.<span class="hljs-title function_">includes</span>(word))) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"检测到敏感内容，请使用文明用语。"</span>);
  }
  <span class="hljs-keyword">return</span> input; <span class="hljs-comment">// 检查通过则继续执行后续流程</span>
};
<span class="hljs-keyword">const</span> customCheckStep = <span class="hljs-title class_">RunnableLambda</span>.<span class="hljs-title function_">from</span>(profanityChecker);
</code></pre>
<h3 data-id="heading-8">实现对话历史检索（RAG核心逻辑）</h3>
<p>仅存储历史记录不足以支撑模型关联上下文，需通过RAG（检索增强生成）逻辑检索与当前输入相关的历史对话。将检索逻辑封装为<code>Runnable</code>，集成到LangChain的调用链中：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">retrieveStep</span> = RunnableLambda.<span class="hljs-keyword">from</span>(<span class="hljs-title function_ invoke__">async</span> (<span class="hljs-attr">input</span>: { <span class="hljs-attr">user_input</span>: <span class="hljs-keyword">string</span>; <span class="hljs-attr">sessionId</span>: <span class="hljs-keyword">string</span> }) =&gt; {
  <span class="hljs-keyword">return</span> await <span class="hljs-title function_ invoke__">retrieveRelevantHistory</span>(input.user_input, input.sessionId);
});
</code></pre>
<p>上述<code>retrieveRelevantHistory</code>函数会根据用户输入从内存中检索语义相关的历史对话，供模型生成回复时参考。</p>
<h3 data-id="heading-9">构建链式调用流程</h3>
<p>使用<code>RunnableSequence</code>将敏感词检查、历史检索、提示词模板注入、模型调用等步骤串联，形成完整的处理链路：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableSequence</span>, <span class="hljs-title class_">RunnablePassthrough</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">const</span> ragChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  customCheckStep, <span class="hljs-comment">// 先执行敏感词检查</span>
  <span class="hljs-title class_">RunnablePassthrough</span>.<span class="hljs-title function_">assign</span>({ <span class="hljs-comment">// 注入会话ID和检索结果</span>
    <span class="hljs-attr">sessionId</span>: <span class="hljs-function">(<span class="hljs-params">_, config</span>) =&gt;</span> config.<span class="hljs-property">configurable</span>.<span class="hljs-property">sessionId</span>,
    <span class="hljs-attr">relevant_history</span>: retrieveStep,
  }),
  textPrompt, <span class="hljs-comment">// 应用提示词模板</span>
  llm <span class="hljs-comment">// 调用语言模型生成回复</span>
]);
</code></pre>
<h3 data-id="heading-10">会话管理：隔离不同对话记录</h3>
<p>为避免不同用户的对话记录混淆，使用<code>RunnableWithMessageHistory</code>实现会话隔离，每个<code>sessionId</code>对应独立的历史记录。通过<code>getSessionStore</code>获取会话专属存储实例，确保历史记录不串用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">const</span> textChainWithHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
  <span class="hljs-attr">runnable</span>: ragChain,
  <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span>) =&gt; {
    <span class="hljs-keyword">const</span> sessionStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSessionStore</span>(sessionId);
    <span class="hljs-keyword">return</span> sessionStore.<span class="hljs-property">chatHistory</span>; <span class="hljs-comment">// 复用会话专属的历史记录实例</span>
  },
  <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"user_input"</span>,
  <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"chat_history"</span>,
});
</code></pre>
<h3 data-id="heading-11">getMessageHistory与retrieveRelevantHistory协作流程说明</h3>
<p>前文提及的<code>getMessageHistory</code>（用于RunnableWithMessageHistory）与<code>retrieveRelevantHistory</code>（用于RunnableLambda）并非重复设计，而是通过“会话隔离-完整历史获取-相关历史筛选”的递进逻辑协作，确保对话记忆功能的准确性与高效性。两者的核心协作流程如下：</p>
<ul>
<li><strong>第一步：会话隔离与完整历史获取</strong>：当用户发起新请求时，<code>RunnableWithMessageHistory</code>通过<code>getMessageHistory</code>函数，根据当前<code>sessionId</code>从<code>getSessionStore</code>中获取该会话专属的<code>chatHistory</code>实例，实现不同用户对话记录的隔离，同时拿到该会话的全部历史对话数据。</li>
<li><strong>第二步：注入完整历史到上下文</strong>：<code>getMessageHistory</code>获取的完整历史记录，会自动注入到提示词模板的<code>{chat_history}</code>占位符中，为模型提供“全量上下文背景”。</li>
<li><strong>第三步：语义检索筛选相关历史</strong>：在链式调用流程中，<code>retrieveStep</code>通过<code>retrieveRelevantHistory</code>函数，基于当前用户输入的语义，从会话专属的向量库中检索出最相关的历史对话片段（而非全量历史），并将检索结果作为<code>relevant_history</code>注入到调用链上下文。</li>
<li><strong>第四步：模型结合双维度历史生成回复</strong>：模型最终会同时参考“全量历史上下文”（确保对话连贯性）和“语义相关历史片段”（聚焦核心信息，避免上下文窗口过载），生成精准且贴合上下文的回复。</li>
</ul>
<p>简单来说，<code>getMessageHistory</code>负责“精准找到当前用户的所有历史”，解决“历史归属”问题；<code>retrieveRelevantHistory</code>负责“从所有历史中挑出有用的部分”，解决“长对话效率与精准性”问题，两者协同实现了“安全隔离+高效检索”的记忆功能。</p>
<h3 data-id="heading-12">文本嵌入处理：向量转换与存储</h3>
<p>为实现历史对话的语义检索，需将文本转换为向量表示（嵌入）。使用<code>OllamaEmbeddings</code>加载mxbai-embed-large模型完成这一过程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OllamaEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/ollama"</span>;
<span class="hljs-keyword">const</span> embeddingModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaEmbeddings</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'mxbai-embed-large'</span>,
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">"http://127.0.0.1:11434"</span>,
  <span class="hljs-attr">truncate</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动截断超长文本</span>
})
</code></pre>
<h3 data-id="heading-13">会话存储结构设计</h3>
<p><code>getSessionStore</code>函数为每个会话初始化专属存储，包含三类核心组件：</p>
<ul>
<li>聊天记录（<code>chatHistory</code>）：存储原始对话消息；</li>
<li>向量库（<code>vectorStore</code>）：存储文本嵌入向量；</li>
<li>检索器（<code>retriever</code>）：用于语义检索的工具。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">export const <span class="hljs-attr">getSessionStore</span> = async (sessionId: string) =&gt; {
  if (!sessionStores<span class="hljs-section">[sessionId]</span>) {
    const <span class="hljs-attr">chatHistory</span> = new InMemoryChatMessageHistory()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">vectorStore</span> = new MemoryVectorStore(embeddingModel)<span class="hljs-comment">; // 内存向量库，适用于Demo场景</span>
    // 检索器配置：采用mmr模式（最大边际相关性），每次返回10条最相关结果
    const <span class="hljs-attr">retriever</span> = vectorStore.asRetriever({ searchType: <span class="hljs-string">"mmr"</span>, k: <span class="hljs-number">10</span> })<span class="hljs-comment">;</span>
    sessionStores<span class="hljs-section">[sessionId]</span> = { chatHistory, vectorStore, retriever }<span class="hljs-comment">;</span>
  }
  return sessionStores<span class="hljs-section">[sessionId]</span><span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>注意：<code>searchType: "mmr"</code>可在保证相关性的同时避免结果重复；<code>k:10</code>表示单次检索最多返回10条历史记录。</p>
<h3 data-id="heading-14">存储聊天记录到向量库</h3>
<p>每轮对话结束后，需将“用户输入+助手回复”存入向量库，格式为“用户：xxx\n助手：xxx”，便于模型理解上下文。首次输入无助手回复时，仅存储用户内容：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addMessageToVectorStore</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  sessionId: <span class="hljs-built_in">string</span>,
  humanInput: <span class="hljs-built_in">string</span>,
  aiResponse?: <span class="hljs-built_in">string</span>
</span>) =&gt; {
  <span class="hljs-keyword">const</span> { vectorStore } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSessionStore</span>(sessionId);
  <span class="hljs-keyword">const</span> messageText = aiResponse 
    ? <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>\n助手：<span class="hljs-subst">${aiResponse}</span>`</span> 
    : <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>`</span>;
  <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">addDocuments</span>([{
    <span class="hljs-attr">pageContent</span>: messageText,
    <span class="hljs-attr">metadata</span>: { sessionId, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() } <span class="hljs-comment">// 附加会话ID和时间戳，便于追溯</span>
  }]);
};
</code></pre>
<h3 data-id="heading-15">实时交互体验：流式响应与SSE</h3>
<p>为提升用户体验，通过模型的流式输出（<code>stream</code>方法）实现“边生成边返回”的打字机效果，并使用SSE（服务器发送事件）将结果实时推送给前端：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 服务器端流式处理逻辑</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> textChainWithHistory.<span class="hljs-title function_">stream</span>(
  { user_input },
  { <span class="hljs-attr">configurable</span>: { sessionId } }
);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) { <span class="hljs-comment">// 逐段获取模型生成的内容</span>
  <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>;
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>); <span class="hljs-comment">// 按SSE格式推送</span>
}
</code></pre>
<h3 data-id="heading-16">处理跨域请求</h3>
<p>为避免前端调用接口时出现跨域错误，需在服务器端配置CORS（跨域资源共享）策略，处理预检请求（OPTIONS方法）：</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-function"><span class="hljs-title">if</span> <span class="hljs-params">(req.method === <span class="hljs-string">"OPTIONS"</span>)</span> {
  <span class="hljs-title">res</span>.<span class="hljs-title">setHeader</span><span class="hljs-params">(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>)</span>;
  <span class="hljs-title">res</span>.<span class="hljs-title">setHeader</span><span class="hljs-params">(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, OPTIONS"</span>)</span>;
  <span class="hljs-title">res</span>.<span class="hljs-title">setHeader</span><span class="hljs-params">(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>)</span>;
  <span class="hljs-title">res</span>.<span class="hljs-title">writeHead</span><span class="hljs-params">(<span class="hljs-number">204</span>)</span>;
  <span class="hljs-title">res</span>.<span class="hljs-title">end</span><span class="hljs-params">()</span>;
  <span class="hljs-title">return</span>;
}
</span></code></pre>
<h3 data-id="heading-17">结语</h3>
<p>至此，一个具备记忆功能、支持历史对话检索及实时交互的本地大模型Demo已搭建完成。该方案基于Ollama运行本地模型，通过LangChain整合逻辑，利用内存存储对话数据，兼顾功能性与轻量性。建议实际运行体验，进一步探索其扩展潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis 两个隐蔽深坑实录：Arrays.asList() 与数字 0 的“离奇失踪”]]></title>    <link>https://juejin.cn/post/7586588823905730569</link>    <guid>https://juejin.cn/post/7586588823905730569</guid>    <pubDate>2025-12-23T02:47:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905730569" data-draft-id="7586540799250726966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis 两个隐蔽深坑实录：Arrays.asList() 与数字 0 的“离奇失踪”"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-12-23T02:47:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis 两个隐蔽深坑实录：Arrays.asList() 与数字 0 的“离奇失踪”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:47:33.000Z" title="Tue Dec 23 2025 02:47:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>早上刚到公司，打开电脑，写着需求听着歌。突然钉钉一响，测试发来消息："你那个接口报错了"。打开日志一看，MyBatis又炸了。</p>
</blockquote>
<p>说实话，MyBatis这玩意儿平时挺好用的，但有时候报的错真让人摸不着头脑。尤其是那种<strong>本地跑得好好的，一上线就炸的Bug</strong>，简直让人怀疑人生。今天就记录两个让我debug到深夜的坑，它们都有个共同特点：<strong>代码看起来完全没问题，但运行时就是莫名其妙地报错</strong>。</p>
<p>如果你也被MyBatis折磨过，这篇文章可能会让你会心一笑：原来不是我一个人踩过这些坑😂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad176944fd4d4a52b8bd1dce48cdd750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5peF5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062852&amp;x-signature=5jgXpST%2F6%2FD5nyl7EOm0mCVc%2F7o%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">坑位一：Arrays.asList() 遇上老版本MyBatis（3.2.x版本）</h2>
<h3 data-id="heading-1">事故现场</h3>
<p>周五下午四点半（是的，Bug总是在快下班时出现），测试环境突然报了个令人头大的异常：</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-string">"org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.builder.BuilderException: Error evaluating expression 'userCode.size() &gt; 0'. Cause: org.apache.ibatis.ognl.MethodFailedException: Method "</span>size<span class="hljs-string">" failed for object [aaa, bbb] [java.lang.IllegalAccessException: Class org.apache.ibatis.ognl.OgnlRuntime can not access a member of class java.util.Collections$UnmodifiableCollection with modifiers "</span><span class="hljs-keyword">public</span><span class="hljs-string">"]
     at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:73)
     at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:364)
     at $Proxy15.selectList(Unknown Source)
     at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:194)
     at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:114)
     at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:58)
     at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:43)
     at $Proxy18.fetchOrder(Unknown Source)
     at com.xx.xx.server.impl.XX.fetchOrderByUnitNo(RechargeCardBillServiceImpl.java:351)
     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
     at java.lang.reflect.Method.invoke(Method.java:597)
     at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:317)
     at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:198)
     at $Proxy26.fetchOrderByUnitNo(Unknown Source)
     at com.ofpay.ofdc.task.AbstractRechargeTask.run(AbstractRechargeTask.java:65)
     at java.lang.Thread.run(Thread.java:662)
</span></code></pre>
<p>看到这个异常，我第一反应是：<strong>什么鬼？size()方法还能调用失败？</strong></p>
<p>来看看出问题的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller层</span>
List&lt;String&gt; userCodes = Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>);
orderService.fetchOrderByUserCodes(userCodes);
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchOrder"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.size() &gt; 0"</span>&gt;</span>
        AND user_code IN
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"userCode"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"code"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span>&gt;</span>
            #{code}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>这代码看起来没啥问题啊？userCode不为空，调个size()方法判断长度，天经地义。但它就是报错了，而且是偶现（一般偶现都有大坑）。</p>
<h3 data-id="heading-2">先说解决方案</h3>
<p>一顿<strong>ChatGPT + Google + Stack Overflow搜索</strong>后，找到了三种解决办法：</p>
<p><strong>方案1：改入参类型（最快）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 把Arrays.asList返回的"假ArrayList"转成真正的ArrayList</span>
List&lt;String&gt; userCodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>));
</code></pre>
<p>改完重新发布，问题秒解决。测试验证通过，终于可以下班了。</p>
<p><strong>方案2：改XML表达式（不改Java代码）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用length属性替代size()方法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.length &gt; 0"</span>&gt;</span>
    AND user_code IN ...
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>这个方案也能work，而且不用改业务代码，改完就能用。</p>
<p><strong>方案3：升级MyBatis版本（治本之策）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 从老古董版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 2014年的版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 升级到现代版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>不过这个方案需要做全面的回归测试，周五晚上就算了，留到下周慢慢搞。</p>
<h3 data-id="heading-3">刨根问底：这到底是个啥坑？</h3>
<p>线上问题解决了，但总感觉哪里不对劲。周末闲着没事，决定把这个诡异的异常刨根问底搞清楚。翻了半天资料，终于明白是怎么回事了。</p>
<p><strong>第一层问题：类型不同</strong></p>
<p><code>Arrays.asList()</code> 返回的不是我们熟悉的 <code>java.util.ArrayList</code>，而是 <code>java.util.Arrays</code> 的一个私有静态内部类 <code>Arrays$ArrayList</code>。</p>
<p>写个简单的测试验证一下：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list1 = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
List&lt;String&gt; list2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>));

System.out.println(list1.getClass());  
<span class="hljs-comment">// 输出: class java.util.Arrays$ArrayList</span>

System.out.println(list2.getClass());  
<span class="hljs-comment">// 输出: class java.util.ArrayList</span>
</code></pre>
<p>看到没？一个是<code>Arrays$ArrayList</code>，一个是<code>ArrayList</code>，虽然都实现了List接口，但类型完全不同。</p>
<p><strong>第二层问题：访问权限异常</strong></p>
<p>MyBatis用OGNL表达式引擎来解析XML中的条件判断（比如 <code>userCode.size() &gt; 0</code>）。当OGNL尝试通过反射调用 <code>Arrays$ArrayList</code> 的 <code>size()</code> 方法时，发现这个类是 <code>private static class</code>（私有静态内部类）。</p>
<p>虽然 <code>size()</code> 方法本身是 <code>public</code> 的，但因为类本身是 <code>private</code> 修饰符，OGNL在反射访问时需要调用 <code>setAccessible(true)</code> 来绕过权限检查。问题就出在这里！</p>
<p><strong>第三层问题：并发Bug（重点来了！）</strong></p>
<p>老版本MyBatis在处理反射时有个并发问题：<strong>当需要调用私有类的方法时，会先设置 <code>accessible = true</code>，调用完再设回 <code>false</code>。但这个操作没有加锁！（非原子性）</strong></p>
<p>想象一下这个场景：</p>
<ul>
<li>线程A：设置 <code>accessible = true</code>，准备调用方法</li>
<li>线程B：也设置 <code>accessible = true</code>，然后调用方法，再设回 <code>false</code></li>
<li>线程A：此时去调用方法，发现 <code>accessible</code> 已经被B改成 <code>false</code> 了，boom！💥</li>
</ul>
<p>这就是<strong>为什么这个Bug偶尔才出现，因为它本质上是个并发问题</strong>！只有在高并发场景下，多个线程同时调用这个接口时才会触发。</p>
<p>GitHub上有人早在2014年就提了这个issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmybatis%2Fmybatis-3%2Fpull%2F384" target="_blank" title="https://github.com/mybatis/mybatis-3/pull/384" ref="nofollow noopener noreferrer">mybatis/mybatis-3#384</a></p>
<p>后来MyBatis在3.3.x版本修复了这个问题，对反射操作加了同步控制，确保 <code>accessible</code> 的设置和方法调用是原子操作。</p>
<hr/>
<h2 data-id="heading-4">坑位二：参数传0，SQL条件神秘消失之谜</h2>
<h3 data-id="heading-5">又一个周五的故事</h3>
<p>是的，又是周五下午（墨菲定律：Bug永远在周五出现😭）。需求很简单：查询所有"待支付"状态（status=0）的订单。十分钟写完代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Service层</span>
<span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">queryPendingOrders</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> orderMapper.queryOrderByStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 0表示待支付</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryOrderByStatus"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
        AND status = #{status}
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>本地测试，完美运行。提交代码，合并主干，发布测试环境。心想这次稳了，准备提前收拾东西下班。</p>
<p>结果半小时后，测试同学发来消息："这个接口有问题啊，怎么把所有状态的订单都查出来了？我要的是status=0的订单。"</p>
<p>我一脸懵逼：？？？不可能啊，我刚测过的，明明没问题！</p>
<p>打开测试环境日志，执行的SQL是：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_order <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>
</code></pre>
<p><strong>WHERE后面的status条件呢？被吃了？</strong></p>
<h3 data-id="heading-6">Debug之旅</h3>
<p>我在本地打断点，一步步调试：</p>
<ol>
<li>Controller层传入的参数：<code>status = 0</code> ✅</li>
<li>Service层收到的参数：<code>status = 0</code> ✅</li>
<li>MyBatis执行的SQL：<code>WHERE 1=1</code> ❌</li>
</ol>
<p>问题肯定出在XML的if判断上。盯着这行看了好几分钟：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
</code></pre>
<p>突然灵光一现：<strong>会不会是 0 被判定成了空字符串？</strong></p>
<p>赶紧改成这样试试：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>重新发布，问题解决！测试环境查询status=0的订单，正常返回了。</p>
<h3 data-id="heading-7">原理揭秘：OGNL的类型转换陷阱</h3>
<p>这又是一个MyBatis（准确说是OGNL）的经典坑。<strong>这个坑比第一个还隐蔽，因为它不会报错，而是悄悄地把你的条件吃掉</strong>。</p>
<p><strong>OGNL的求值逻辑</strong></p>
<p>MyBatis的 <code>&lt;if&gt;</code> 标签用的是OGNL表达式引擎。当你写 <code>status != ''</code> 时，OGNL内部会经历这样的判断流程：</p>
<ol>
<li>先通过 <code>OgnlCache.getValue()</code> 获取表达式的值（这里表达式返回了false）</li>
<li>然后在 <code>ExpressionEvaluator.evaluateBoolean()</code> 中判断这个值，根据返回的不同类型作不同判断，最终返回boolean类型结果。</li>
</ol>
<p>先看第二步！OGNL对不同类型有不同的判断逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ExpressionEvaluator.evaluateBoolean()方法 OGNL的判断逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateBoolean</span><span class="hljs-params">(String expression, Object parameterObject)</span> {
  <span class="hljs-comment">// 这里value返回的是false</span>
  <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, parameterObject);
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Boolean) {
    <span class="hljs-comment">// 因此会走到这里，返回false</span>
    <span class="hljs-keyword">return</span> (Boolean) value;
  }
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Number) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(value)).compareTo(BigDecimal.ZERO) != <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>类型转换的坑</strong></p>
<p>当你写 <code>status != ''</code> 时，从<code>OgnlCache.getValue()</code>往下不断追溯，OGNL最终会调用 <code>compareWithConversion</code> 方法做类型转换比较。这个方法会把两边的值都转成同一类型再比较：</p>
<ul>
<li>数值 <code>0</code> 会被转成 <code>double类型：0.0</code></li>
<li>空字符串 <code>""</code> 也会被转成 <code>double类型：0.0</code></li>
</ul>
<p>结果就是 <code>0 == ""</code> 被判定为 <code>true</code>，导致 <code>status != ''</code> 返回 <code>false</code>，你的if条件不成立，SQL条件就没了！</p>
<p><strong>为什么本地测试没问题？</strong></p>
<p>是因为我本地测试时传的参数是 <code>status=1</code> 或其他非0值，而测试环境刚好传了 <code>status=0</code>。这种Bug特别隐蔽，因为它不会报错，只是查询结果不符合预期。</p>
<p><strong>这个坑的适用范围</strong>：</p>
<ul>
<li>参数是<strong>数值类型</strong>（Integer、Long等）的 <strong>0</strong></li>
<li>XML中写了 <code>!= ''</code> 的空字符串判断</li>
<li><strong>字符串"0"不受影响</strong>（<code>"0" != ''</code> 正常判定为true）</li>
</ul>
<p>感兴趣的可以自己去看看MyBatis源码中的 <code>ExpressionEvaluator</code> 类和OGNL的 <code>OgnlOps.compareWithConversion</code> 方法，就能明白整个转换过程了。</p>
<h3 data-id="heading-8">正确姿势大全</h3>
<p>根据不同场景，我总结了几种写法：</p>
<p><strong>场景1：参数是Integer/Long等包装类型</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 推荐：只判null，数值0是有效值 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景2：参数可能是数值也可能是字符串</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 显式包含0的判断 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and (status != '' or status == 0)"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景3：字符串类型参数</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 字符串正常判断，不会有坑 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null and userName != ''"</span>&gt;</span>
    AND user_name = #{userName}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">避坑建议</h3>
<ol>
<li>
<p><strong>数值类型参数，别用空字符串判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null and count != ''"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 正确写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>记住数值类型和字符串类型要区分对待</strong></p>
<ul>
<li>数值类型（Integer、Long）：只判<code>!= null</code></li>
<li>字符串类型：判<code>!= null and != ''</code></li>
</ul>
</li>
<li>
<p><strong>确实需要兼容的场景，明确写出0的判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"value != null and (value != '' or value == 0)"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>升级MyBatis版本并不能解决这个问题</strong>（因为这是OGNL的特性，不是bug）</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">总结与最佳实践</h2>
<p>这两个问题虽然表现形式不同，但都源于<strong>OGNL表达式引擎</strong>的特殊行为。理解这些陷阱背后的机制，能帮助我们写出更健壮的MyBatis代码。</p>
<h3 data-id="heading-11">核心要点</h3>
<ol>
<li>
<p><strong>Arrays.asList()的陷阱</strong></p>
<ul>
<li>
<p><code>Arrays.asList()</code> 返回的不是真正的ArrayList，是Arrays的私有静态内部类</p>
</li>
<li>
<p>老版本MyBatis（3.3.x之前）的OGNL表达式引擎：<strong>反射访问私有静态内部类的public方法时，在设置 <code>accessible = true</code>参数时会有并发问题</strong></p>
</li>
<li>
<p><strong>解决方法</strong>：包装成真正的ArrayList或升级MyBatis版本</p>
</li>
</ul>
</li>
<li>
<p><strong>「if」标签：数值0判空的陷阱</strong></p>
<ul>
<li>
<p>OGNL会将数值0与空字符串做类型转换比较</p>
</li>
<li>
<p><code>status != ''</code> 会返回false，导致「if」表达式条件不满足，数值0的查询条件被过滤</p>
</li>
<li>
<p><strong>解决方法</strong>：数值类型只判断<code>!= null</code>，不要判断空字符串</p>
</li>
</ul>
</li>
</ol>
<p>希望这篇文章能帮你避开这些坑，让周五下班不再是奢望 😄</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 抓包工具在不同场景的实际作用]]></title>    <link>https://juejin.cn/post/7586550947704766474</link>    <guid>https://juejin.cn/post/7586550947704766474</guid>    <pubDate>2025-12-23T03:27:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586550947704766474" data-draft-id="7586550947704750090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 抓包工具在不同场景的实际作用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T03:27:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 抓包工具在不同场景的实际作用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:27:22.000Z" title="Tue Dec 23 2025 03:27:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刚开始做 iOS 开发时，我对抓包工具的理解很简单。
能看到接口请求，参数没问题，返回值符合预期，事情就算结束。</p>
<p>但随着项目变复杂，问题开始只在真机上出现，只在部分用户出现，甚至只在某些网络环境下出现，iOS 抓包工具的意义才真正发生变化。</p>
<p>这时，抓包不再是辅助验证，而是继续排查的唯一入口。</p>
<hr/>
<h2 data-id="heading-0"><strong>代理型 iOS 抓包工具，依然是最先出场的</strong></h2>
<p>在大多数日常开发中，代理抓包工具仍然是首选。</p>
<p>它们很适合做这样几件事：</p>
<ul>
<li>确认请求是否发出</li>
<li>验证参数是否被正确拼装</li>
<li>检查 Header 是否符合预期</li>
<li>对比不同版本接口差异</li>
</ul>
<p>在调试环境、模拟器环境下，这种方式效率非常高，也足够直观。</p>
<p>问题通常出现在场景发生变化的时候。</p>
<hr/>
<h2 data-id="heading-1"><strong>当抓包开始出现不稳定的时候</strong></h2>
<p>如果 iOS 抓包过程中出现以下情况，我一般会暂停继续折腾代理配置：</p>
<ul>
<li>模拟器可以，真机不行</li>
<li>接口偶尔能抓到，偶尔完全消失</li>
<li>HTTPS 连接存在，但内容不可读</li>
<li>证书已经信任，但仍然解不了密</li>
</ul>
<p>这些现象并不一定说明工具有问题，更常见的原因是：<strong>App 在真机环境下并不完全走代理路径。</strong></p>
<hr/>
<h2 data-id="heading-2"><strong>HTTPS 安全策略，是 iOS 抓包工具的分水岭</strong></h2>
<p>在 iOS App 中，引入 HTTPS pin 校验、双向认证已经很常见。
一旦启用这些策略，基于代理的抓包工具能看到的内容就会大幅减少。</p>
<p>这时，如果继续围绕“为什么抓不到包”反复调整配置，很容易陷入无效循环。
更有效的做法，是换一个抓包视角。</p>
<hr/>
<h2 data-id="heading-3"><strong>设备侧抓包，让真机行为变得可见</strong></h2>
<p>在需要确认真实设备网络行为时，我会使用 <strong>抓包大师（Sniff Master）</strong> 这种设备侧抓包工具。</p>
<p>它在整个流程中的作用并不复杂：回答一个最基础的问题——这个 iOS App 在真机上到底发了什么请求。</p>
<p>不依赖系统代理、不需要越狱或 root，只要连接设备就能开始抓取 HTTPS、TCP、UDP 等通信数据。这种方式在以下场景中特别有价值：</p>
<ul>
<li>第三方 SDK 网络行为分析</li>
<li>HTTPS pin 校验导致代理抓包失效</li>
<li>真机与模拟器行为不一致</li>
</ul>
<p>它并不是用来替代代理抓包，而是补齐“真实运行环境”这一层。</p>
<hr/>
<h2 data-id="heading-4"><strong>指定 App 抓包，比功能堆叠更重要</strong></h2>
<p>在真机环境下抓包，一个很现实的问题是噪音。</p>
<p>系统服务、后台同步、其他 App 的请求，很容易让你误以为请求没发出来。
抓包大师（Sniffmaster）工具支持只抓取指定 App，判断会简单得多。</p>
<p>当所有数据都来自同一个 App 时，异常模式往往会自然显现出来，而不是被埋在海量请求中。</p>
<hr/>
<h2 data-id="heading-5"><strong>iOS 抓包，并不总是 HTTPS 的问题</strong></h2>
<p>在一些复杂项目中，我遇到过这样的情况：</p>
<ul>
<li>HTTPS 接口返回正常</li>
<li>但客户端状态没有更新</li>
<li>重启 App 后一切恢复</li>
</ul>
<p>继续盯着接口，其实很难推进。
这时需要考虑，是否存在 HTTP 之外的通信行为。</p>
<hr/>
<h2 data-id="heading-6"><strong>数据流抓包，让连接问题浮出水面</strong></h2>
<p>不少 iOS App 会使用 TCP 长连接或自定义协议完成状态同步、推送或心跳。</p>
<p>这些行为，在代理抓包工具中往往是不可见的。
这也是为什么“接口看起来正常，但功能不正常”的情况并不少见。</p>
<p>抓包大师支持 TCP / UDP 数据流抓取，并可以导出数据进一步分析。在分析这些问题时，它的价值并不在于解析协议，而在于确认：</p>
<ul>
<li>连接是否建立</li>
<li>是否频繁断开</li>
<li>数据是否真的发送和接收</li>
</ul>
<p>这一步，往往能直接改变排查方向。</p>
<hr/>
<h2 data-id="heading-7"><strong>Wireshark 并不是 iOS 抓包的起点</strong></h2>
<p>很多人在讨论 iOS 抓包工具时，会直接提到 Wireshark。</p>
<p>但从工程实践来看，它更适合出现在问题已经被缩小范围之后。
在没有明确方向之前，直接面对大量底层数据，反而会增加理解成本。</p>
<p>我更倾向于把它当作“确认工具”，而不是第一选择。</p>
<hr/>
<h2 data-id="heading-8"><strong>拦截和修改，用来验证而不是猜测</strong></h2>
<p>在定位到问题可能原因后，我通常会通过修改抓到的请求或响应，验证客户端行为。</p>
<p>比如：</p>
<ul>
<li>修改状态码，观察客户端是否重试</li>
<li>删除某些字段，确认是否存在隐含依赖</li>
</ul>
<p>这种方式比反复改代码更直接，也更容易控制变量。</p>
<p>抓包大师支持通过脚本拦截和修改请求、响应，在这一阶段更像是实验工具，而不是单纯的抓包工具。</p>
<hr/>
<h2 data-id="heading-9"><strong>对 iOS 抓包工具的一点看法</strong></h2>
<p>经历过几次真机问题排查之后，我对 iOS 抓包工具的理解变得更务实：</p>
<ul>
<li>没有哪一个工具适合所有场景</li>
<li>抓包失败，往往是在提示你换视角</li>
<li>多工具组合，才能覆盖完整通信路径</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 接入第三方AI模型（MiMo-V2-Flash）]]></title>    <link>https://juejin.cn/post/7586588823906091017</link>    <guid>https://juejin.cn/post/7586588823906091017</guid>    <pubDate>2025-12-23T03:27:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823906091017" data-draft-id="7586588823905943561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 接入第三方AI模型（MiMo-V2-Flash）"/> <meta itemprop="keywords" content="前端,Claude,后端"/> <meta itemprop="datePublished" content="2025-12-23T03:27:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 接入第三方AI模型（MiMo-V2-Flash）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:27:03.000Z" title="Tue Dec 23 2025 03:27:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>这里用前几天新出的小米自研 AI 大模型 MiMo-V2-Flash 举例，进行接入第三方模型 API 的配置</p>
<p>其他第三方模型的接入方式可以作为参考，总体思路是差不多的</p>
<h2 data-id="heading-1">步骤 1：安装 Claude Code CLI</h2>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd10c4c8ccc14607af050ac64b855871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=L2A0%2BRC4n%2FhA1izmbGZ%2FQMQmrSc%3D" alt="1.png" loading="lazy"/></p>
<p>通过 <code>claude -- v</code> 查看版本号，测试是否安装成功</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/794c6fa4acca426cbc5f1cf6e700714b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=qUYGgYPyYnuic0VtuG2Htg0c0EY%3D" alt="2.png" loading="lazy"/></p>
<p>成功打印版本号为 “v2.0.75”</p>
<p>不过同时也提示 Claude Code 在咱的地区不可用</p>
<p>所以我们需要设置让它跳过登录</p>
<h2 data-id="heading-2">步骤 2：跳过登录</h2>
<p>在电脑中全局搜索找到 <code>.claude.json</code> 文件（一般在 C:\Users\用户名目录下）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ca166f5fcd4509af449e01c5053993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=C773ZIoRXkavn8U4M82iLfDVELs%3D" alt="3.png" loading="lazy"/></p>
<p>打开文件添加下面的配置</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"hasCompletedOnboarding"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/583de8c114c249f898bbb9ac12ae26ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=wNu7Q%2BKB0NnDoYdjKFE8ViN3pfs%3D" alt="4.png" loading="lazy"/></p>
<h2 data-id="heading-3">步骤 3：添加小米配置文件</h2>
<p>在<code>.claude.json</code> 文件同级目录下找到 <code>.claude/ </code>文件夹</p>
<p>进入文件夹并新建 <code>settings.json</code> 文件</p>
<p>文件内容如下，其中 <code>ANTHROPIC_AUTH_TOKEN</code> 值为你自己申请的 key</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.xiaomimimo.com/anthropic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在这里填写你自己申请的 key"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_OPUS_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mimo-v2-flash"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_SONNET_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mimo-v2-flash"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_HAIKU_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mimo-v2-flash"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>获取 API Key 步骤：</p>
<p>访问官方链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.xiaomimimo.com%2F%23%2Fconsole%2Fapi-keys" target="_blank" title="https://platform.xiaomimimo.com/#/console/api-keys" ref="nofollow noopener noreferrer">platform.xiaomimimo.com/#/console/a…</a> -&gt; 点击“新建 API key”按钮 -&gt; 输入名称以创建新的 API Key。</p>
<p>注意！API Key 仅在创建时可见可复制，请妥善保存。</p>
<h2 data-id="heading-4">步骤 4：启动 Claude Code</h2>
<p>以上配置完成后，在桌面新建一个文件夹，我这里取名为“claude-xiaomi”，通过 vscode 打开项目，在命令行中输入 <code>claude</code> 并按回车，它会询问你是否允许 Claude Code 读取写入或执行此目录下的文件，上下箭头选择 <code>yes，proceed</code>，并按回车确认</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79ca1599b6ba42f0ae0ae7021129ccb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=ERfP5Xpxg%2FNjuOIGTJQE0Gb65y8%3D" alt="5.png" loading="lazy"/></p>
<p>然后出现这个欢迎界面，至此为止，Claude Code 接入 MiMo-V2-Flash 模型 已经配置完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e43d64c66d8142758f4aa123b988c1f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=H2MiCBlBcLe5cc3Q3eU4RxbuJUw%3D" alt="6.png" loading="lazy"/></p>
<p>下面我就可以直接输入文字和他对话了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1bdfd49d81a4de38aded050b8bfef94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=vktnYXm2nfv92vxTqhZ%2B%2FLhL5KI%3D" alt="7.png" loading="lazy"/></p>
<h2 data-id="heading-5">步骤 5：关闭 Claude Code 思考模式</h2>
<p>MiMo 官网说 MiMo-V2-Flash 模型暂不适配 Claude Code 思考模式，下面是关闭步骤</p>
<p>命令行输入 <code>/config </code> -&gt; 回车 -&gt; 上下箭头选择 <code>Thinking mode</code> 选项，回车切换选项值 true 或者 false（默认为 true）-&gt; 按 ESC 返回</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a93795fa5e514e6db696747f23b62b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=LeTvJyWEK2IyoN8X3g5FeyQIXdM%3D" alt="8.png" loading="lazy"/></p>
<h2 data-id="heading-6">步骤 6：开始 Claude Code 使用吧</h2>
<p>以后每次需要使用 Claude Code 的时候，在命令行输入 <code>claude</code>即可唤醒对话框</p>
<p>也可以在 vscode 中点击右上角的 Claude Code 图标唤醒对话框，<code>Claude Code for VS Code</code> 这个插件好像自动就安装到了 vscode 中（反正我是没注意啥时候出现的）</p>
<p>然后就跟在 cursor 或者 trae 一样进行使用即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d516614db7453a8574b26870afcc5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065223&amp;x-signature=iN6e9AIDYTj1hL0uodNMmiI6ZCk%3D" alt="9.png" loading="lazy"/></p>
<h2 data-id="heading-7">参考链接</h2>
<p>claude 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fquickstart" target="_blank" title="https://code.claude.com/docs/zh-CN/quickstart" ref="nofollow noopener noreferrer">code.claude.com/docs/zh-CN/…</a></p>
<p>xiaomimimo 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.xiaomimimo.com%2F%23%2Fdocs%2Fintegration%2Fclaude-code" target="_blank" title="https://platform.xiaomimimo.com/#/docs/integration/claude-code" ref="nofollow noopener noreferrer">platform.xiaomimimo.com/#/docs/inte…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战]]></title>    <link>https://juejin.cn/post/7586615716905746432</link>    <guid>https://juejin.cn/post/7586615716905746432</guid>    <pubDate>2025-12-23T03:29:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716905746432" data-draft-id="7586570254861778984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-23T03:29:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:29:20.000Z" title="Tue Dec 23 2025 03:29:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在大语言模型（LLM）落地的过程中，“生成效率”始终是绕不开的核心痛点——传统自回归模型像“挤牙膏”一样逐词元（Token）生成文本，不仅推理速度慢，训练效率也难以满足大规模应用需求。而<strong>多标记预测（Multi-Token Prediction, MTP）</strong> 作为解决这一问题的关键技术，正在成为LLM性能优化的核心方向。本文将从技术本质、执行流程、实战示例到落地应用，全方位拆解MTP技术。</p>
<h2 data-id="heading-1">MTP核心定义：不止于“一次生成多个Token”</h2>
<p>多标记预测（MTP）是一种让大语言模型在<strong>单次前向传播中同时预测多个后续词元</strong>的技术，核心目标是打破传统“单Token逐次生成”的效率枷锁。</p>
<p>与传统单标记预测（NTP）的核心差异：</p>
<ul>
<li>传统NTP：输入文本→模型预测第t+1个Token→以t+1为新输入→预测t+2个Token（循环往复）；</li>
<li>MTP：输入文本→模型单次前向传播→同时预测t+1、t+2…t+n个Token，直接完成多步生成。</li>
</ul>
<p>简单来说，MTP让模型从“一步走一格”变成“一步走多格”，既提升训练时的信号密度，又大幅降低推理时的迭代次数。</p>
<h2 data-id="heading-2">MTP核心执行流程</h2>
<p>MTP的执行流程分为<strong>训练阶段</strong>和<strong>推理阶段</strong>，其中推理阶段结合“推测解码（Speculative Decoding）”时效果最优。</p>
<h3 data-id="heading-3">1. 基础MTP训练流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8bdb87ed6d14384bfe67b8ae906a43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=FHOJWkUttJX1tday%2Bfper%2F%2FQVyU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>流程拆解</strong>：</p>
<ol>
<li>输入文本经Token化转为序列<code>X₁,X₂...Xₜ</code>；</li>
<li>共享Transformer编码器将序列编码为上下文表征<code>Hₜ</code>；</li>
<li>多个独立的MTP输出头基于<code>Hₜ</code>，并行预测<code>t+1</code>到<code>t+n</code>个Token；</li>
<li>计算每个MTP头的预测损失（交叉熵），总损失为所有头损失的平均值；</li>
<li>反向传播更新模型参数，直到模型收敛。</li>
</ol>
<h3 data-id="heading-4">2. MTP+推测解码推理流程（主流落地方案）</h3>
<p>单纯的MTP可能存在“多Token预测不连贯”的问题，结合推测解码后，既能保效率又能保质量：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fac2031b92462b86c9ccb07c36a6e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=yBzVOyNIwuotLibktiuEBvZ1pGo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>流程拆解</strong>：</p>
<ol>
<li>轻量级MTP“草稿模型”基于输入上下文，并行生成K个候选Token（比如K=4）；</li>
<li>高精度主模型通过<strong>单次前向传播</strong>，批量验证这K个候选Token的合理性；</li>
<li>若验证通过（DeepSeek实测接受率85%-90%），直接输出这K个Token，模型步数一次性+K；</li>
<li>若部分Token验证失败，仅保留通过的Token，重新生成被拒绝的部分；</li>
<li>重复上述步骤，直到生成满足长度要求的文本。</li>
</ol>
<h3 data-id="heading-5">3. DeepSeek依赖链式MTP架构（保连贯的进阶方案）</h3>
<p>为解决“独立多头MTP生成不连贯”的问题，DeepSeek设计了依赖链式MTP架构：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47f0c2adf901461ea3b724ef06529c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=%2BtT0LazpV1e%2FixwrjSC8xE0tgrI%3D" alt="在这里插入图片描述" loading="lazy"/>
核心逻辑：后一个MTP头的预测依赖前一个头的输出表征，既保留了“多Token预测”的效率，又保证了文本的语义连贯性。</p>
<h2 data-id="heading-6">MTP实战示例：极简PyTorch实现框架</h2>
<p>以下是一个简化版的MTP模型实现，帮助你理解核心代码逻辑（仅保留关键模块，无复杂优化）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim

<span class="hljs-comment"># 超参数设置</span>
VOCAB_SIZE = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 词汇表大小</span>
EMBED_DIM = <span class="hljs-number">256</span>     <span class="hljs-comment"># 嵌入维度</span>
HIDDEN_DIM = <span class="hljs-number">512</span>    <span class="hljs-comment"># Transformer隐藏层维度</span>
NUM_HEADS = <span class="hljs-number">8</span>       <span class="hljs-comment"># 注意力头数</span>
NUM_LAYERS = <span class="hljs-number">2</span>      <span class="hljs-comment"># Transformer层数</span>
MTP_NUM = <span class="hljs-number">3</span>         <span class="hljs-comment"># 一次预测3个Token（t+1/t+2/t+3）</span>

<span class="hljs-comment"># 1. 共享Transformer编码器（基础编码模块）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedEncoder</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.embedding = nn.Embedding(VOCAB_SIZE, EMBED_DIM)
        self.transformer_encoder = nn.TransformerEncoder(
            nn.TransformerEncoderLayer(EMBED_DIM, NUM_HEADS, HIDDEN_DIM),
            num_layers=NUM_LAYERS
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [seq_len, batch_size]</span>
        embed = self.embedding(x)  <span class="hljs-comment"># [seq_len, batch_size, embed_dim]</span>
        enc_out = self.transformer_encoder(embed)  <span class="hljs-comment"># [seq_len, batch_size, embed_dim]</span>
        <span class="hljs-keyword">return</span> enc_out[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># 返回最后一个Token的表征: [batch_size, embed_dim]</span>

<span class="hljs-comment"># 2. MTP多输出头（并行预测多个Token）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MTPModel</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.encoder = SharedEncoder()
        <span class="hljs-comment"># 定义MTP_NUM个独立的输出头</span>
        self.mtp_heads = nn.ModuleList([
            nn.Linear(EMBED_DIM, VOCAB_SIZE) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(MTP_NUM)
        ])
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [seq_len, batch_size]</span>
        context_feat = self.encoder(x)  <span class="hljs-comment"># [batch_size, embed_dim]</span>
        <span class="hljs-comment"># 每个头并行预测一个Token</span>
        mtp_outputs = [head(context_feat) <span class="hljs-keyword">for</span> head <span class="hljs-keyword">in</span> self.mtp_heads]
        <span class="hljs-comment"># 返回t+1/t+2/t+3的预测logits: [MTP_NUM, batch_size, vocab_size]</span>
        <span class="hljs-keyword">return</span> torch.stack(mtp_outputs)

<span class="hljs-comment"># 3. 训练流程示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_mtp_model</span>():
    model = MTPModel()
    criterion = nn.CrossEntropyLoss()  <span class="hljs-comment"># 交叉熵损失</span>
    optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">1e-4</span>)
    
    <span class="hljs-comment"># 模拟训练数据：输入序列[1,2,3,4]，目标Token为[5,6,7]（t+1=5, t+2=6, t+3=7）</span>
    batch_size = <span class="hljs-number">2</span>
    input_seq = torch.tensor([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]]).T  <span class="hljs-comment"># [seq_len=4, batch_size=2]</span>
    target_tokens = torch.tensor([[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>], [<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]]).T    <span class="hljs-comment"># [MTP_NUM=3, batch_size=2]</span>
    
    model.train()
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        optimizer.zero_grad()
        <span class="hljs-comment"># 前向传播：获取3个Token的预测logits</span>
        mtp_logits = model(input_seq)  <span class="hljs-comment"># [3, 2, 10000]</span>
        
        <span class="hljs-comment"># 计算总损失：每个MTP头的损失相加</span>
        total_loss = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(MTP_NUM):
            <span class="hljs-comment"># logits: [2, 10000], target: [2]</span>
            loss = criterion(mtp_logits[i], target_tokens[i])
            total_loss += loss
        
        <span class="hljs-comment"># 反向传播</span>
        total_loss.backward()
        optimizer.step()
        
        <span class="hljs-keyword">if</span> (epoch+<span class="hljs-number">1</span>) % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>, Total Loss: <span class="hljs-subst">{total_loss.item():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 执行训练</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    train_mtp_model()
</code></pre>
<p><strong>代码关键说明</strong>：</p>
<ol>
<li><code>SharedEncoder</code>：共享的Transformer编码器，为所有MTP头提供统一的上下文表征；</li>
<li><code>MTPModel</code>：包含3个独立的线性输出头，并行预测<code>t+1</code>、<code>t+2</code>、<code>t+3</code>三个Token；</li>
<li>训练阶段：计算每个MTP头的交叉熵损失，求和后作为总损失反向传播，让模型学习“一次预测多个Token”的能力；</li>
<li>输出示例：训练100轮后损失会逐步下降，说明模型已学会从输入<code>[1,2,3,4]</code>预测目标<code>[5,6,7]</code>。</li>
</ol>
<h2 data-id="heading-7">MTP vs 传统单标记预测（NTP）核心对比</h2>








































<table><thead><tr><th>特性</th><th>传统单标记预测（NTP）</th><th>多标记预测（MTP）</th></tr></thead><tbody><tr><td>预测方式</td><td>每次生成1个Token</td><td>一次生成n个Token</td></tr><tr><td>推理速度</td><td>基准值（1倍）</td><td>1.8~2.6倍（结合推测解码）</td></tr><tr><td>训练信号密度</td><td>低（每步1个损失）</td><td>高（每步n个损失）</td></tr><tr><td>文本连贯性</td><td>一般（仅依赖前1个Token）</td><td>优秀（依赖链式表征）</td></tr><tr><td>硬件资源利用率</td><td>低（单次前向传播仅用1次）</td><td>高（单次前向传播用n次）</td></tr><tr><td>典型落地场景</td><td>小模型、低延迟要求场景</td><td>大模型、长文本生成、移动端</td></tr></tbody></table>
<h2 data-id="heading-8">MTP的落地应用与核心优势</h2>
<h3 data-id="heading-9">1. 核心优势</h3>
<ol>
<li><strong>效率翻倍</strong>：推理速度提升1.8~2.6倍，训练时信号密度更高，收敛更快；</li>
<li><strong>语义更连贯</strong>：依赖链式架构让多Token生成符合语言逻辑，避免“前言不搭后语”；</li>
<li><strong>硬件适配性好</strong>：联发科天玑9400+等芯片已集成MTP硬件加速，适配移动端部署；</li>
<li><strong>成本降低</strong>：减少推理时的前向传播次数，大幅降低算力消耗（小米MiMo模型仅用1/50算力达到同等性能）。</li>
</ol>
<h3 data-id="heading-10">2. 典型落地案例</h3>
<ul>
<li><strong>DeepSeek-V3</strong>：依赖链式MTP+推测解码，推理速度提升1.8倍，生成质量与原生模型持平；</li>
<li><strong>小米MiMo模型</strong>：MTP+在线策略蒸馏，32并发时推理速度达1146 Tokens/秒；</li>
<li><strong>联发科天玑9400+</strong>：硬件级MTP加速，支持手机端高效运行Qwen3等大模型。</li>
</ul>
<h2 data-id="heading-11">总结</h2>
<p>MTP技术的核心价值，是在不牺牲LLM生成质量的前提下，解决了自回归模型“逐Token生成”的效率瓶颈。从技术演进来看，未来MTP将朝着“更高并行度、更强语义连贯性、更低硬件依赖”方向发展：</p>
<ol>
<li>结合MoE（混合专家模型），进一步提升MTP的并行计算效率；</li>
<li>优化依赖链式架构，平衡“并行度”与“连贯性”；</li>
<li>轻量化MTP模块，让中小模型也能享受效率提升。</li>
</ol>
<p>对于开发者而言，理解MTP的核心逻辑（共享编码+多输出头+损失融合），并掌握“MTP+推测解码”的落地范式，将成为优化LLM应用的核心能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tauri (23)——为什么每台电脑位置显示效果不一致？]]></title>    <link>https://juejin.cn/post/7586555198116085766</link>    <guid>https://juejin.cn/post/7586555198116085766</guid>    <pubDate>2025-12-23T03:01:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198116085766" data-draft-id="7586585498744242230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tauri (23)——为什么每台电脑位置显示效果不一致？"/> <meta itemprop="keywords" content="前端,APP,Rust"/> <meta itemprop="datePublished" content="2025-12-23T03:01:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tauri (23)——为什么每台电脑位置显示效果不一致？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:01:25.000Z" title="Tue Dec 23 2025 03:01:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做跨平台桌面应用（Tauri / Electron / Flutter Desktop）时，<strong>“窗口尺寸/位置在不同电脑上不一致”</strong> 是非常高频、且非常隐蔽的坑：</p>
<ul>
<li>同一份代码，在你电脑上完美居中，在同事电脑上却偏上/偏下；</li>
<li>外接显示器后又变了；</li>
<li>Windows 125% 缩放时尤其明显。</li>
</ul>
<p>本文结合我们 Coco 在 Tauri 里的真实代码（<code>src-tauri/src/lib.rs:320-375</code>）来解释这些关键词背后的“坐标体系”，并总结我们在项目里会遇到的问题与解决方案，帮助以后 <strong>一次性把 DPI/缩放坑填平</strong>。</p>
<hr/>
<h2 data-id="heading-0">1. 先看真实场景：我们在做什么？</h2>
<p>Coco 在显示主窗口时，会把窗口移动到 “当前鼠标所在的显示器”，并做居中：</p>
<ul>
<li><code>show_coco</code> 会调用 <code>move_window_to_active_monitor</code>（<code>src-tauri/src/lib.rs:261-295</code>）</li>
<li><code>move_window_to_active_monitor</code> 核心逻辑在这里（<code>src-tauri/src/lib.rs:320-375</code>）</li>
</ul>
<p>用户选中的关键片段（<code>src-tauri/src/lib.rs:352-357</code>）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 590 是我们主窗口的默认高度</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_height</span> = <span class="hljs-number">590</span> * scale_factor <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>;

<span class="hljs-comment">// Horizontal center uses actual width, vertical center uses 590 baseline</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_x</span> = monitor_position.x + (monitor_size.width <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> - window_width) / <span class="hljs-number">2</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_y</span> = monitor_position.y + (monitor_size.height <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> - window_height) / <span class="hljs-number">2</span>;
</code></pre>
<p>你会看到几个关键字：</p>
<ul>
<li><code>scale_factor</code>：缩放比 / DPI 缩放因子</li>
<li><code>monitor_position</code> / <code>monitor_size</code>：屏幕位置与尺寸</li>
<li><code>window_width</code> / <code>window_height</code>：窗口宽高</li>
<li><code>PhysicalPosition</code>：设置窗口位置时采用 “物理坐标”（<code>src-tauri/src/lib.rs:358-360</code>）</li>
</ul>
<p>问题的根源往往就出在：<strong>这些变量到底属于“物理像素”还是“逻辑像素”？如果单位混了，居中必然错。</strong></p>
<hr/>
<h2 data-id="heading-1">2. 三个像素概念：物理像素、逻辑像素、缩放比</h2>
<h3 data-id="heading-2">2.1 物理像素（Physical Pixel）</h3>
<p>显示器的真实像素点，比如：</p>
<ul>
<li>1920×1080</li>
<li>2560×1440</li>
<li>3840×2160（4K）</li>
</ul>
<p>物理像素是硬件层面的网格，<strong>不会因为系统缩放而改变</strong>。</p>
<h3 data-id="heading-3">2.2 逻辑像素（Logical Pixel / DIP / Point）</h3>
<p>操作系统为了让 UI 在不同 DPI 上看起来 “差不多大”，引入了 “设备无关像素”。</p>
<p>直觉理解：</p>
<ul>
<li>UI 的 <code>590px</code> 更接近“逻辑像素”</li>
<li>操作系统/渲染层会把逻辑像素映射到物理像素</li>
</ul>
<h3 data-id="heading-4">2.3 缩放比（Scale Factor / Device Pixel Ratio）</h3>
<p>缩放比描述两者的关系：</p>
<ul>
<li><code>physical = logical * scale_factor</code></li>
<li><code>logical = physical / scale_factor</code></li>
</ul>
<p>典型取值：</p>
<ul>
<li>macOS Retina：经常是 <code>2.0</code></li>
<li>Windows：可能是 <code>1.0 / 1.25 / 1.5 / 1.75 / 2.0 ...</code>（尤其 125%/150% 非常常见）</li>
<li>多显示器时：不同屏幕可能不同缩放比（<strong>Per-monitor DPI</strong>）</li>
</ul>
<hr/>
<h2 data-id="heading-5">3. 为什么每个人电脑效果不一致？</h2>
<h3 data-id="heading-6">3.1 每个人的缩放设置不同（尤其 Windows）</h3>
<p>同样是 27 寸 2K 屏：</p>
<ul>
<li>A 设置 100%（<code>scale_factor=1.0</code>）</li>
<li>B 设置 125%（<code>scale_factor=1.25</code>）</li>
<li>C 设置 150%（<code>scale_factor=1.5</code>）</li>
</ul>
<p>如果你的代码用 “写死的像素值” 去做位置/大小计算，但没有明确它属于逻辑还是物理，就会导致 <strong>某些机器上偏移量大</strong>。</p>
<h3 data-id="heading-7">3.2 多显示器 + 不同缩放比：坐标系统随屏幕变化</h3>
<p>用户把窗口从内屏（2.0）拖到外接屏（1.0），或者鼠标在外接屏但窗口在内屏，这时：</p>
<ul>
<li>“鼠标所在屏幕” 的坐标空间</li>
<li>“窗口当前 scale_factor”</li>
<li>“你用来计算的 monitor.size/position”</li>
</ul>
<p>可能并不在同一个缩放体系里。</p>
<p>Coco 的做法是用 <code>cursor_position</code> 找鼠标位置，再用 <code>monitor_from_point</code> 找对应屏幕（<code>src-tauri/src/lib.rs:323-340</code>）。方向是对的，但更关键的是：<strong>后续计算必须统一单位。</strong></p>
<h3 data-id="heading-8">3.3 最容易忽略：小数缩放比 + 整数截断导致系统性偏差</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_height</span> = <span class="hljs-number">590</span> * scale_factor <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>;
</code></pre>
<p>这里有两个隐患：</p>
<ol>
<li><code>scale_factor</code> 通常是 <code>f64</code>，比如 <code>1.25</code>、<code>1.5</code></li>
<li>直接 <code>as i32</code> 会<strong>截断</strong>（不是四舍五入）</li>
</ol>
<p>举个例子：</p>
<ul>
<li>当 <code>scale_factor = 1.25</code> 时，<code>scale_factor as i32 = 1</code></li>
<li><code>window_height = 590 * 1 = 590</code></li>
</ul>
<p>这等价于完全忽略了 125% 缩放，必然会出现“纵向居中不准”。</p>
<p>即使你写成：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_height</span> = (<span class="hljs-number">590.0</span> * scale_factor) <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>;
</code></pre>
<p>也会因为 <code>as i32</code> 截断导致 “每次都偏一两像素到几十像素”，在某些显示器上会非常明显（尤其窗口吸附、居中时更敏感）。</p>
<h3 data-id="heading-9">3.4 WebView/CSS 的 px 语义与窗口 API 的 px 语义可能不同</h3>
<p>前端（Web）里 <code>px</code> 基本等同于<strong>逻辑像素</strong>（CSS 像素）。
Tauri 的窗口 API 有时要求你明确是 <code>LogicalPosition/Size</code> 还是 <code>PhysicalPosition/Size</code>。</p>
<p>如果你用“CSS 里看起来是 590 高”的概念，直接塞到 <code>PhysicalPosition</code> 体系里去算位置，就会出现 “同事电脑 UI 高度一样，但窗口居中不一样” 的错觉。</p>
<hr/>
<h2 data-id="heading-10">4. 在实际项目中会遇到哪些典型问题？</h2>
<h3 data-id="heading-11">问题 A：窗口居中在某些机器上偏上/偏下</h3>
<p>常见原因：</p>
<ul>
<li>用逻辑高度（如 590）去减物理屏幕高度（monitor_size 可能是物理），单位混用</li>
<li>或者用物理高度，但 scale_factor 计算/取整不对</li>
</ul>
<h3 data-id="heading-12">问题 B：外接显示器后，窗口出现在错误的屏幕或坐标跑飞</h3>
<p>常见原因：</p>
<ul>
<li>仍然按“主屏幕”缩放来换算</li>
<li><code>cursor_position</code> / <code>monitor_from_point</code> / <code>window.scale_factor</code> 没有统一语义（鼠标在 A 屏，scale_factor 却来自 B 屏）</li>
</ul>
<h3 data-id="heading-13">问题 C：Windows 125% 缩放时错得最离谱</h3>
<p>常
见原因：</p>
<ul>
<li><code>1.25</code> 这类小数缩放最容易被 <code>as i32</code> 截断</li>
<li>还会引入大量“0.5 像素”类的 rounding 差，叠加后误差扩大</li>
</ul>
<hr/>
<h2 data-id="heading-14">5. 解决方案：唯一原则——<strong>全程统一坐标空间</strong></h2>
<p>你可以选两条路线之一：</p>
<h3 data-id="heading-15">路线 1：全程用逻辑坐标计算，最后用 <code>LogicalPosition</code> 设置</h3>
<p>适用于：你的 UI 设计是按“逻辑尺寸”（例如 590 这个 baseline）定义的。</p>
<p>推荐写法（示意）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> tauri::dpi::{LogicalPosition, LogicalSize};

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scale</span> = window.<span class="hljs-title function_ invoke__">scale_factor</span>()?;

<span class="hljs-comment">// 注意：monitor.position/size 多数情况下是 Physical，需要转 logical</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">monitor_pos_l</span> = monitor.<span class="hljs-title function_ invoke__">position</span>().to_logical::&lt;<span class="hljs-type">f64</span>&gt;(scale);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">monitor_size_l</span> = monitor.<span class="hljs-title function_ invoke__">size</span>().to_logical::&lt;<span class="hljs-type">f64</span>&gt;(scale);

<span class="hljs-comment">// window.inner_size() 通常返回 PhysicalSize，也转 logical</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_size_l</span> = window.<span class="hljs-title function_ invoke__">inner_size</span>()?.to_logical::&lt;<span class="hljs-type">f64</span>&gt;(scale);

<span class="hljs-comment">// 你的 baseline 直接用逻辑值</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">baseline_h</span> = <span class="hljs-number">590.0_f64</span>;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = monitor_pos_l.x + (monitor_size_l.width - window_size_l.width) / <span class="hljs-number">2.0</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = monitor_pos_l.y + (monitor_size_l.height - baseline_h) / <span class="hljs-number">2.0</span>;

window.<span class="hljs-title function_ invoke__">set_position</span>(LogicalPosition::<span class="hljs-title function_ invoke__">new</span>(x, y))?;
</code></pre>
<p>核心好处：</p>
<ul>
<li>590 就是你 UI 里的 590（逻辑）</li>
<li>计算更直观，少踩坑</li>
</ul>
<h3 data-id="heading-16">路线 2：全程用物理坐标计算，最后用 <code>PhysicalPosition</code> 设置</h3>
<p>适用于：你已经在使用物理 API，且 monitor/window 的 size/position 都是 physical。</p>
<p>关键点是：<strong>不要把 scale_factor 截断成整数</strong>，要用浮点乘完再 <code>round()</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> tauri::dpi::PhysicalPosition;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scale</span> = window.<span class="hljs-title function_ invoke__">scale_factor</span>()?; <span class="hljs-comment">// f64</span>

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">baseline_h_physical</span> = (<span class="hljs-number">590.0</span> * scale).<span class="hljs-title function_ invoke__">round</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">monitor_position</span> = monitor.<span class="hljs-title function_ invoke__">position</span>(); <span class="hljs-comment">// PhysicalPosition&lt;i32&gt;</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">monitor_size</span> = monitor.<span class="hljs-title function_ invoke__">size</span>();         <span class="hljs-comment">// PhysicalSize&lt;u32&gt;</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_size</span> = window.<span class="hljs-title function_ invoke__">inner_size</span>()?;    <span class="hljs-comment">// PhysicalSize&lt;u32&gt;</span>

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_x</span> =
  monitor_position.x + (monitor_size.width <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> - window_size.width <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>) / <span class="hljs-number">2</span>;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_y</span> =
  monitor_position.y + (monitor_size.height <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> - baseline_h_physical) / <span class="hljs-number">2</span>;

window.<span class="hljs-title function_ invoke__">set_position</span>(PhysicalPosition::<span class="hljs-title function_ invoke__">new</span>(window_x, window_y))?;
</code></pre>
<p>对比 Coco 当前代码（<code>src-tauri/src/lib.rs:351-356</code>），差异点就是：</p>
<ul>
<li><code>scale_factor as i32</code> 改为 <code>round()</code> 后再转整数</li>
<li>明确 <code>590</code> 属于逻辑 baseline，换算成物理高度再参与物理计算</li>
</ul>
<hr/>
<h2 data-id="heading-17">6. 为什么我们会遇到这种问题？（根因总结）</h2>
<p>一句话：<strong>跨平台窗口系统把“像素”拆成了两套坐标，而我们很容易混用。</strong></p>
<p>你看到的 <code>590</code> 可能来自：</p>
<ul>
<li>前端 CSS 的设计尺寸（逻辑）</li>
<li>产品/交互定义的 baseline（逻辑）</li>
<li>但 monitor/window API 返回的却可能是 physical</li>
<li>再加上 Windows 小数缩放与多屏 per-monitor DPI，混用后必然出现“每个人不一样”</li>
</ul>
<hr/>
<h2 data-id="heading-18">7. 防踩坑 Checklist（强烈建议团队约定）</h2>
<ul>
<li>任何涉及窗口的 <code>x/y/width/height</code> 计算，先写清楚：<strong>这段代码使用 Logical 还是 Physical</strong></li>
<li><strong>禁止</strong>写 <code>scale_factor as i32</code> 这种截断式转换（尤其 Windows 125%）</li>
<li>需要整数时：优先 <code>round()</code>，其次 <code>floor/ceil</code>（视 UI 期望决定）</li>
<li>多屏场景：以“目标屏幕”的 scale_factor 做换算（鼠标在哪个屏幕、窗口要移动到哪个屏幕，就用那个屏幕对应的缩放体系）</li>
<li>保持“一段计算”不要混入不同单位：
<ul>
<li>要么都 logical</li>
<li>要么都 physical</li>
<li>中间转换一次，之后不再混用</li>
</ul>
</li>
<li>当你发现“只有部分同事电脑不对”，优先怀疑：
<ul>
<li>Windows 缩放比（125%/150%）</li>
<li>外接屏 DPI 不一致</li>
<li>小数缩放被截断 / rounding 不一致</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-19">8. 回到 Coco：这段代码在做什么？哪里最容易踩雷？</h2>
<p>Coco 当前实现（<code>src-tauri/src/lib.rs:320-375</code>）整体思路是合理的：</p>
<ul>
<li>用鼠标位置找 monitor（<code>src-tauri/src/lib.rs:323-340</code>）</li>
<li>用 monitor 的 position/size 计算居中（<code>src-tauri/src/lib.rs:339-356</code>）</li>
<li>用 <code>PhysicalPosition</code> 设置窗口位置（<code>src-tauri/src/lib.rs:358-360</code>）</li>
</ul>
<p>但最危险的一行就是（<code>src-tauri/src/lib.rs:352</code>）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">window_height</span> = <span class="hljs-number">590</span> * scale_factor <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>;
</code></pre>
<p>它会在 <code>scale_factor=1.25</code> 等情况下直接截断，导致纵向居中在不同缩放比设备上差异巨大。</p>
<hr/>
<h2 data-id="heading-20">9. 结语</h2>
<p>桌面应用 “看起来像网页”，但窗口系统的像素体系远比网页复杂：<strong>DPI、缩放比、多显示器、物理/逻辑坐标</strong>任何一个点处理不一致，都会让 “同一份代码在不同人电脑上不一样”。</p>
<p>最靠谱的工程化做法只有一个：<br/>
<strong>统一坐标空间，明确转换边界，避免截断误差。</strong></p>
<p>只要团队把这套约定固化下来，后续再做窗口居中、吸附、跟随鼠标、跨显示器移动，都会稳定很多。</p>
<h2 data-id="heading-21">开源</h2>
<p>如果你对我们的技术细节感兴趣，或者想体验一下这款全能的生产力工具，欢迎访问我们的开源仓库和官网：</p>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" target="_blank">github.com/infinilabs/…</a></li>
<li><strong>Website</strong>: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fcoco.rs" title="https://link.juejin.cn/?target=https%3A%2F%2Fcoco.rs" target="_blank">coco.rs</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么移动端 safari 用 translate 移动元素卡卡的]]></title>    <link>https://juejin.cn/post/7586584105741402162</link>    <guid>https://juejin.cn/post/7586584105741402162</guid>    <pubDate>2025-12-23T03:33:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586584105741402162" data-draft-id="7586573133349470254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么移动端 safari 用 translate 移动元素卡卡的"/> <meta itemprop="keywords" content="前端,性能优化,CSS"/> <meta itemprop="datePublished" content="2025-12-23T03:33:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ssshooter"/> <meta itemprop="url" content="https://juejin.cn/user/3122268751795101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么移动端 safari 用 translate 移动元素卡卡的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3122268751795101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ssshooter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:33:19.000Z" title="Tue Dec 23 2025 03:33:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 并没有触发真正的“硬件加速”</h3>
<p>虽然 <code>translate</code> 理论上比修改 <code>top/left</code> 快，但在 Safari 中，如果你只使用 <code>translate(x, y)</code>，浏览器可能仍将其视为普通的 2D 变换，不一定会为其分配独立的 <strong>GPU 图层（Compositing Layer）</strong> 。</p>
<ul>
<li>
<p><strong>解决方案：</strong> 强制开启 3D 渲染，诱导浏览器使用 GPU。</p>
<p>CSS</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 推荐写法：使用 3d 位移 */</span>
<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate3d</span>(x, y, <span class="hljs-number">0</span>); 

<span class="hljs-comment">/* 或者配合 will-change 提前告知浏览器 */</span>
<span class="hljs-attribute">will-change</span>: transform;
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">2. 刷新率同步问题 (RequestAnimationFrame)</h3>
<p>原生滚动（Scroll）是由系统的渲染进程直接处理的，通常拥有最高优先级。而如果你是通过 JS 监听 <code>scroll</code> 事件或者 <code>touchmove</code> 来驱动 <code>translate</code>，会存在<strong>延迟</strong>：</p>
<ol>
<li><strong>事件节流：</strong> JS 事件触发频率往往跟不上屏幕刷新率。</li>
<li><strong>主线程阻塞：</strong> 如果你的 JS 执行时间过长，<code>translate</code> 的更新就会掉帧。</li>
</ol>
<ul>
<li><strong>解决方案：</strong> 尽量使用 <strong>CSS Transition</strong> 或 <strong>CSS Animation</strong>。CSS 动画在 Safari 中运行在合成器线程（Compositor Thread），即使主线程卡顿，动画依然可以保持流畅。</li>
</ul>
<h3 data-id="heading-2">3. “隐形的” 重绘开销</h3>
<p>即使使用了 <code>translate</code>，如果你的元素包含以下属性，每一帧移动都会迫使 GPU 重新计算光栅化，导致严重的掉帧：</p>
<ul>
<li>
<p><strong>Box-shadow / Filters (blur):</strong> 阴影和滤镜极其耗费资源。</p>
</li>
<li>
<p><strong>Masks / Clip-path:</strong> 遮罩计算。</p>
</li>
<li>
<p><strong>没有设置 backface-visibility:</strong> 在移动端 Safari 上，有时会出现闪烁。</p>
</li>
<li>
<p><strong>优化技巧：</strong></p>
<p>CSS</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.moving-element</span> {
  <span class="hljs-attribute">backface-visibility</span>: hidden;
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000</span>;
  -webkit-<span class="hljs-attribute">font-smoothing</span>: subpixel-antialiased; <span class="hljs-comment">/* 防止文字在移动时变模糊 */</span>
}
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">快速检查清单</h3>

























<table><thead><tr><th><strong>优化手段</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>使用 <code>translate3d</code></strong></td><td>确保元素拥有独立的显存层</td></tr><tr><td><strong>检查 <code>will-change</code></strong></td><td>告知浏览器提前准备，但不要滥用（会导致内存溢出）</td></tr><tr><td><strong>移除内阴影和滤镜</strong></td><td>这些是性能杀手，建议用图片代替复杂阴影</td></tr><tr><td><strong>检查 JS 逻辑</strong></td><td>如果是用 JS 控制，必须包裹在 <code>requestAnimationFrame</code> 中</td></tr></tbody></table>
<p>亲测推荐添加 <strong>transform: translate3d(0,0,0);</strong>，立即解君愁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AOP 的真相：注解只是声明，代理才是执行]]></title>    <link>https://juejin.cn/post/7586585688005115945</link>    <guid>https://juejin.cn/post/7586585688005115945</guid>    <pubDate>2025-12-23T03:41:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688005115945" data-draft-id="7586585498744684598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AOP 的真相：注解只是声明，代理才是执行"/> <meta itemprop="keywords" content="面试,架构,Spring"/> <meta itemprop="datePublished" content="2025-12-23T03:41:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AOP 的真相：注解只是声明，代理才是执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:41:28.000Z" title="Tue Dec 23 2025 03:41:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>很多人用Spring AOP时，以为只要在方法上加个<code>@Transactional</code>、<code>@Retry</code>，就能自动有事务、重试功能。但当代码出问题时，往往一脸懵逼：为什么注解没生效？为什么代理失败了？</p>
<p>这次我用不到1000行代码，手写了一个Mini-AOP框架，纯JDK实现，0依赖。目的很简单：<strong>看清楚AOP到底是怎么运作的</strong>。</p>
<h2 data-id="heading-1">核心认知：AOP不是你想的那样</h2>
<h3 data-id="heading-2">常见误解</h3>
<p>很多人以为AOP是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-meta">@Before("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"打日志"</span>);
    }
}

<span class="hljs-comment">// 然后写业务代码</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-comment">// 自动就有日志了？</span>
    }
}
</code></pre>
<p>以为加了注解就自动在方法前后插入代码了。<strong>这是错的！</strong></p>
<h3 data-id="heading-3">真实情况</h3>
<p>AOP的本质是<strong>三层结构</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3952679a3a564030a456894b89ca990a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=GuWiuKyLUtXpVgM%2F9v7BnwgT3uQ%3D" alt="115.jpg" loading="lazy"/></p>
<ol>
<li><strong>声明层</strong>：你写的<code>@Before</code>、<code>@Around</code>等注解，只是配置，不执行任何逻辑</li>
<li><strong>触发层</strong>：代理对象在方法调用时，通过表达式匹配决定哪些切面要执行</li>
<li><strong>业务层</strong>：被AOP包裹的真实业务代码</li>
</ol>
<p>用大白话说：<strong>注解不会自动生效，必须有一个代理层来识别注解、匹配表达式、决定执行顺序</strong>。</p>
<h2 data-id="heading-4">Mini-AOP的核心实现</h2>
<h3 data-id="heading-5">整体架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[用户调用] --&gt; B[代理对象]
    B --&gt; C{切点匹配}
    C --&gt;|匹配成功| D[收集通知]
    D --&gt; E[执行Before]
    E --&gt; F[执行Around]
    F --&gt; G[真实方法]
    G --&gt; H[执行After]
    C --&gt;|不匹配| G
</code></pre>
<h3 data-id="heading-6">关键类说明</h3>
<p><strong>1. BeanFactory - 容器和代理创建者</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanFactory</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; beans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;Object&gt; aspects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-comment">// 注册Bean时，识别出切面类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.newInstance();
        <span class="hljs-keyword">if</span> (clazz.isAnnotationPresent(Aspect.class)) {
            aspects.add(instance);  <span class="hljs-comment">// 收集切面</span>
        }
        beans.put(getBeanName(clazz), instance);
    }
    
    <span class="hljs-comment">// 获取Bean时，决定是否创建代理</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;T&gt; type)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> beans.get(name);
        <span class="hljs-keyword">if</span> (needProxy(bean)) {
            <span class="hljs-keyword">return</span> AopProxy.createProxy(bean, aspects);  <span class="hljs-comment">// 创建代理</span>
        }
        <span class="hljs-keyword">return</span> (T) bean;
    }
}
</code></pre>
<p><strong>核心逻辑</strong>：</p>
<ul>
<li>注册时收集所有<code>@Aspect</code>类</li>
<li>获取Bean时判断是否需要代理，如果需要就返回代理对象而不是原始对象</li>
</ul>
<p><strong>2. AopProxy - 代理和切点匹配核心</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> Object target;
    <span class="hljs-keyword">private</span> List&lt;Object&gt; aspects;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> {
        <span class="hljs-comment">// 1. 遍历所有切面</span>
        <span class="hljs-keyword">for</span> (Object aspect : aspects) {
            <span class="hljs-keyword">for</span> (Method aspectMethod : aspect.getClass().getDeclaredMethods()) {
                <span class="hljs-comment">// 2. 检查注解和切点表达式</span>
                <span class="hljs-keyword">if</span> (aspectMethod.isAnnotationPresent(Before.class)) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">pointcut</span> <span class="hljs-operator">=</span> aspectMethod.getAnnotation(Before.class).value();
                    <span class="hljs-comment">// 3. 匹配表达式</span>
                    <span class="hljs-keyword">if</span> (matches(pointcut, method)) {
                        beforeAdvices.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Advice</span>(aspect, aspectMethod));
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 4. 按顺序执行通知链</span>
        <span class="hljs-keyword">return</span> executeAdvices(method, args, beforeAdvices, afterAdvices);
    }
    
    <span class="hljs-comment">// 简单的切点匹配</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String pointcut, Method method)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getSimpleName() 
                        + <span class="hljs-string">"."</span> + method.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> pointcut.replace(<span class="hljs-string">"*"</span>, <span class="hljs-string">".*"</span>);
        <span class="hljs-keyword">return</span> fullName.matches(regex);
    }
}
</code></pre>
<p><strong>核心逻辑</strong>：</p>
<ul>
<li>方法调用时，遍历所有切面类</li>
<li>读取切面方法上的注解和表达式</li>
<li>用表达式匹配当前方法，决定是否执行</li>
<li>收集所有匹配的通知，按顺序执行</li>
</ul>
<h3 data-id="heading-7">完整的调用流程</h3>
<p>以这段代码为例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 注册</span>
factory.register(LogAspect.class);
factory.register(UserServiceImpl.class);

<span class="hljs-comment">// 获取</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> factory.getBean(<span class="hljs-string">"userService"</span>, UserService.class);

<span class="hljs-comment">// 调用</span>
userService.saveUser(<span class="hljs-string">"张三"</span>);
</code></pre>
<p>实际执行流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户代码
    participant P as 代理对象
    participant A as AopProxy.invoke
    participant L as LogAspect
    participant R as RetryAspect
    participant T as 真实对象

    U-&gt;&gt;P: saveUser(&amp;#34;张三&amp;#34;)
    P-&gt;&gt;A: invoke(method, args)
    A-&gt;&gt;A: 匹配切点表达式
    A-&gt;&gt;L: @Before匹配成功
    L--&gt;&gt;A: logBefore()
    A-&gt;&gt;R: @Around匹配成功
    R-&gt;&gt;A: retry { proceed() }
    A-&gt;&gt;T: method.invoke(target, args)
    T--&gt;&gt;A: 返回结果
    A-&gt;&gt;L: @After执行
    L--&gt;&gt;A: logAfter()
    A--&gt;&gt;P: 返回最终结果
    P--&gt;&gt;U: 返回给用户
</code></pre>
<h3 data-id="heading-8">切点表达式的匹配机制</h3>
<p>这是最容易被忽略的部分。很多人以为写了<code>@Before("UserService.*")</code>就自动生效，但实际上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 切面定义</span>
<span class="hljs-meta">@Before("UserService.*")</span>  <span class="hljs-comment">// 只是声明了一个字符串</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(JoinPoint jp)</span> { }

<span class="hljs-comment">// 必须有代码来解析这个字符串</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String pointcut, Method method)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getSimpleName();
    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
    <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> className + <span class="hljs-string">"."</span> + methodName;  <span class="hljs-comment">// 如 "UserService.saveUser"</span>
    
    <span class="hljs-comment">// 把表达式转成正则</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> pointcut.replace(<span class="hljs-string">"*"</span>, <span class="hljs-string">".*"</span>);  <span class="hljs-comment">// "UserService.*" -&gt; "UserService\..*"</span>
    
    <span class="hljs-comment">// 匹配</span>
    <span class="hljs-keyword">return</span> fullName.matches(regex);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li>表达式只是字符串，不会自动匹配</li>
<li>必须在运行时解析表达式并和方法名比对</li>
<li>这个匹配发生在每次方法调用时</li>
</ol>
<h3 data-id="heading-9">通知的执行顺序</h3>
<p>多个切面叠加时，执行顺序是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2454105344494a8a442d28ff982197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=d5Ic2AYQldRmHVRx7BNHWx92Qxs%3D" alt="116.jpg" loading="lazy"/></p>
<p>代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">executeAdvices</span><span class="hljs-params">(Method method, Object[] args, 
                              List&lt;Advice&gt; beforeAdvices,
                              List&lt;Advice&gt; afterAdvices,
                              List&lt;Advice&gt; aroundAdvices)</span> {
    
    <span class="hljs-comment">// 构建调用链</span>
    Supplier&lt;Object&gt; chain = () -&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行@Before</span>
            <span class="hljs-keyword">for</span> (Advice advice : beforeAdvices) {
                advice.method.invoke(advice.aspect, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinPoint</span>(target, method, args));
            }
            
            <span class="hljs-comment">// 执行真实方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
            
            <span class="hljs-comment">// 执行@After</span>
            <span class="hljs-keyword">for</span> (Advice advice : afterAdvices) {
                advice.method.invoke(advice.aspect, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinPoint</span>(target, method, args));
            }
            
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    };
    
    <span class="hljs-comment">// @Around包裹整个链条</span>
    <span class="hljs-keyword">for</span> (Advice around : aroundAdvices) {
        <span class="hljs-type">Object</span> <span class="hljs-variable">finalChain</span> <span class="hljs-operator">=</span> chain;
        chain = () -&gt; around.method.invoke(around.aspect, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProceedingJoinPoint</span>(target, method, args, finalChain));
    }
    
    <span class="hljs-keyword">return</span> chain.get();
}
</code></pre>
<h2 data-id="heading-10">一个完整示例</h2>
<h3 data-id="heading-11">切面定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Order(1)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-meta">@Before("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logBefore</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"[日志] 方法: "</span> + jp.getSignature());
    }
    
    <span class="hljs-meta">@After("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAfter</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"[日志] 方法执行完毕"</span>);
    }
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Order(2)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryAspect</span> {
    <span class="hljs-meta">@Around("UserService.save*")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">retry</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"[重试] 第 "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" 次"</span>);
                <span class="hljs-keyword">return</span> pjp.proceed();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>) <span class="hljs-keyword">throw</span> e;
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">业务代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span>;
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span> {
        count++;
        System.out.println(<span class="hljs-string">"==&gt; 保存用户: "</span> + name);
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"保存失败"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">运行结果</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BeanFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanFactory</span>();
factory.register(LogAspect.class);
factory.register(RetryAspect.class);
factory.register(UserServiceImpl.class);

<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> factory.getBean(<span class="hljs-string">"userService"</span>, UserService.class);
service.saveUser(<span class="hljs-string">"张三"</span>);
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[日志]</span> 方法: UserService.saveUser
<span class="hljs-section">[重试]</span> 第 1 次
==&gt; 保存用户: 张三
<span class="hljs-section">[重试]</span> 第 2 次
==&gt; 保存用户: 张三
<span class="hljs-section">[重试]</span> 第 3 次
==&gt; 保存用户: 张三
<span class="hljs-section">[日志]</span> 方法执行完毕
</code></pre>
<p>可以看到：</p>
<ol>
<li>日志切面先执行（Order=1）</li>
<li>重试切面包裹在外面（Order=2）</li>
<li>失败两次后第三次成功</li>
</ol>
<h2 data-id="heading-14">和Spring AOP的对比</h2>
<h3 data-id="heading-15">相同点</h3>
<ol>
<li>都使用JDK动态代理</li>
<li>都通过切点表达式匹配方法</li>
<li>都支持多种通知类型和优先级</li>
</ol>
<h3 data-id="heading-16">不同点</h3>



































<table><thead><tr><th>特性</th><th>Mini-AOP</th><th>Spring AOP</th></tr></thead><tbody><tr><td>代理方式</td><td>只有JDK代理</td><td>JDK + CGLIB</td></tr><tr><td>切点表达式</td><td>简单通配符</td><td>完整AspectJ语法</td></tr><tr><td>容器</td><td>手动注册</td><td>自动扫描</td></tr><tr><td>依赖注入</td><td>不支持</td><td>完整支持</td></tr><tr><td>代码量</td><td>800行</td><td>10万行+</td></tr></tbody></table>
<h3 data-id="heading-17">本质是一样的</h3>
<p>Spring AOP的核心流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fa4ed1312ad44bea8df2cfbbc312ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=oB45fePje47IQs5MRzWivlqok8w%3D" alt="117.jpg" loading="lazy"/></p>
<p>和Mini-AOP对比：</p>






























<table><thead><tr><th>步骤</th><th>Mini-AOP</th><th>Spring AOP</th></tr></thead><tbody><tr><td>扫描切面</td><td><code>factory.register(LogAspect.class)</code></td><td><code>@ComponentScan + @Aspect</code></td></tr><tr><td>判断是否需要代理</td><td><code>needProxy(bean)</code></td><td><code>AbstractAutoProxyCreator.wrapIfNecessary</code></td></tr><tr><td>创建代理</td><td><code>AopProxy.createProxy</code></td><td><code>ProxyFactory.getProxy</code></td></tr><tr><td>切点匹配</td><td><code>matches(pointcut, method)</code></td><td><code>AspectJExpressionPointcut.matches</code></td></tr></tbody></table>
<p><strong>结论</strong>：Spring只是把这套逻辑做得更通用、更灵活，但底层思想完全一致。</p>
<h2 data-id="heading-18">关键收获</h2>
<h3 data-id="heading-19">1. 注解不是魔法</h3>
<p>写了<code>@Before</code>不会自动执行，必须有代码去：</p>
<ol>
<li>读取注解</li>
<li>解析表达式</li>
<li>匹配方法</li>
<li>执行逻辑</li>
</ol>
<h3 data-id="heading-20">2. 代理是核心</h3>
<p>AOP的本质就是动态代理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户以为调用的是</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

<span class="hljs-comment">// 实际拿到的是</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(...);
</code></pre>
<p>所有AOP逻辑都在这个代理对象的<code>invoke</code>方法里。</p>
<h3 data-id="heading-21">3. 表达式匹配是关键</h3>
<p>切面能不能生效，取决于：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (matches(<span class="hljs-string">"UserService.*"</span>, method)) {
    <span class="hljs-comment">// 执行切面逻辑</span>
}
</code></pre>
<p>这个匹配逻辑才是决定"哪些方法被拦截"的真正原因。</p>
<h3 data-id="heading-22">4. 三层结构</h3>
<p>永远记住：</p>
<pre><code class="hljs">注解（声明） + 代理（触发） + 匹配（决策） = AOP
</code></pre>
<p>缺少任何一层，AOP都不会生效。</p>
<h2 data-id="heading-23">总结</h2>
<p>手写这个Mini-AOP框架后，对Spring AOP的理解彻底通透了：</p>
<ol>
<li>AOP不是注解的魔法，是代理对象在运行时的动态匹配和调用</li>
<li>切点表达式只是字符串，需要有匹配器来解析和判断</li>
<li>通知的执行顺序由代理对象控制，不是注解决定的</li>
<li>Spring AOP只是把这套机制做得更完善，本质和800行代码没区别</li>
</ol>
<p>下次遇到"为什么@Transactional没生效"这种问题，就能快速定位：是不是代理没创建？是不是表达式没匹配上？是不是调用方式不对？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025人工智能最新完整学习路线，AI入门必看，带你快速入门]]></title>    <link>https://juejin.cn/post/7586597780640710666</link>    <guid>https://juejin.cn/post/7586597780640710666</guid>    <pubDate>2025-12-23T03:42:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780640710666" data-draft-id="7586588823906238473" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025人工智能最新完整学习路线，AI入门必看，带你快速入门"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-23T03:42:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025人工智能最新完整学习路线，AI入门必看，带你快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:42:15.000Z" title="Tue Dec 23 2025 03:42:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>在人工智能（AI）飞速发展的今天，掌握AI技术已经成为了许多高效研究者和职场人的必备技能。 从深度学习到强化学习，从大模型训练到实际应用，AI技术的广度和深度不断拓展。</p>
<p>作为一名AI学习者，面对浩瀚的知识海洋，如何有条不紊地学习并应用这些技术呢？ 别担心，今天我为你整理了一份全面的AI学习路线图及资源推荐，带你一步步踏上AI学习之路。</p>
<h2 data-id="heading-0">AI路线图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2aec5ac0f8c4ea3b400a695368111ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066135&amp;x-signature=brP1bHElxFxYfz437lOWOK8Iw3s%3D" alt="" loading="lazy"/></p>
<p>拆分开来其实就四大阶段，层层递进，理论＋实战，非常适合0基</p>
<h2 data-id="heading-1">第一阶段，基础理论</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7f4951f49d466182492ce02698704c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066135&amp;x-signature=txKhQkpJQivPRnEuDyNz1CUd3%2Fw%3D" alt="" loading="lazy"/></p>
<p>Python是首要掌握的语言，其次要掌握数据结构与算法和数学基础，及掌握三方库的安装与使用</p>
<h2 data-id="heading-2">第二阶段，核心课程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d583bd178d4aac8bb6e9fbf3d71585~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066135&amp;x-signature=PlPWHH9JNreHY75hiT13q5CI4vw%3D" alt="" loading="lazy"/></p>
<p>掌握图像认知与Opcv、机器学习、机器视觉</p>
<h2 data-id="heading-3">第三阶段：深度课程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99f18af21eec46f4932d160c1f947616~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066135&amp;x-signature=y8nkc4P7x2jq88%2BvnN0nSghd5W4%3D" alt="" loading="lazy"/></p>
<p>这个里面要掌握深度学习、卷积神经网络CNN、循环神经网络RNN、Transformer及大模型</p>
<h2 data-id="heading-4">第四阶段：实战</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029cd7842cb54b51b073af6a0c7bd934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066135&amp;x-signature=eiTiaODiwZyZx9WrJSmBTLoqAQg%3D" alt="" loading="lazy"/></p>
<p>不管你是提高自己的能力，还是找工作，参与实战项目非常重要</p>
<h2 data-id="heading-5">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[人工智能工程师：初学者的务实学习路线图]]></title>    <link>https://juejin.cn/post/7586588823906271241</link>    <guid>https://juejin.cn/post/7586588823906271241</guid>    <pubDate>2025-12-23T03:46:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823906271241" data-draft-id="7586588823906254857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="人工智能工程师：初学者的务实学习路线图"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-23T03:46:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            人工智能工程师：初学者的务实学习路线图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:46:54.000Z" title="Tue Dec 23 2025 03:46:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>今天，我想和大家聊聊如何成为一名人工智能工程师——但会采用务实的视角，充分考虑大多数人实际的起点。</p>
<p>市面上有无数“人工智能工程师学习路线图”，声称只需几个月就能让你成为人工智能工程师。作为一名在亚马逊（Amazon）从事应用机器学习工作、专注于机器学习基础设施及生成式人工智能内容理解的从业者，我可以负责任地告诉你：要在大型科技公司成为一名人工智能工程师，需要投入大量时间并付出持续的努力。</p>
<p>但好消息是，要开始构建实用的人工智能应用，你并不需要掌握所有那些高级技能！大多数自学成才的开发者并不会从大型科技公司起步；他们通常从个人项目做起，或加入初创公司，亦或是开发自己的人工智能应用，在实践过程中不断学习。</p>
<p>因此，下面我将拆解一份更务实的学习路线图，清晰说明在你学习旅程的每个阶段，真正需要掌握的内容。</p>
<p>顺便提一句，如果你只想了解所需掌握的技能清单，可以在私信作者免费下载。</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>什么是人工智能工程师？</h2>
<p>首先，我们需要明确人工智能工程师的具体工作内容，因为很多学习路线图甚至都没有准确描述这个岗位！它们往往描述的是数据科学或传统机器学习工程师的工作范畴。</p>
<p>人工智能工程师的核心职责并非像数据科学家或机器学习工程师那样从零开始训练模型。相反，人工智能工程师主要负责以下工作：</p>
<ul>
<li>• 基于GPT-4、LLaMA等预训练基础模型构建应用程序</li>
<li>• 专注于通过提示工程、检索增强生成（Retrieval-Augmented Generation，RAG）和微调实现模型适配</li>
<li>• 优先考虑可扩展性、评估、推理优化及实际场景部署</li>
<li>• 处理端到端系统，包括安全性、数据处理和用户反馈</li>
</ul>
<p>这是一个以软件工程技能为基础的专业岗位，根据个人背景不同，有多种入行途径。接下来，我们就来聊聊这一点。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>基础技能</h2>
<p>在深入学习人工智能特定技术之前，你需要掌握一些基础技能：</p>
<ul>
<li>• <strong>数学基础</strong>：统计学、概率论和基础线性代数有助于你理解技术背后的原理。你不需要拥有数学博士学位，但至少要从概念上理解矩阵运算、概率分布等概念。</li>
<li>• <strong>Python编程</strong>：即使是部署自己的人工智能应用，你也需要能够编写生产级别的代码。在该领域，扎实的Python技能几乎是必备条件。</li>
<li>• <strong>基础软件开发概念</strong>：包括使用Git进行版本控制、命令行基础操作，以及理解如何使用API。你需要知道不同服务之间如何通信，以及如何有效管理代码。</li>
<li>• <strong>机器学习基础概念</strong>：尽管人工智能工程师不常从零开始训练模型，但理解监督学习与无监督学习的区别、基础模型评估指标，以及过拟合、欠拟合等概念，能让你掌握理解更高级主题的“通用语言”。</li>
</ul>
<p>这些基础至关重要，因为人工智能工程本质上是在软件工程学科基础上发展起来的专业领域。没有这些基础，你在学习更高级概念时会举步维艰。</p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>构建你的第一个人工智能项目</h2>
<p>掌握上述基础后，你就可以开始接触人工智能工具和模型了。首先，你需要完成以下步骤：</p>
<ol>
<li>
<ol>
<li><strong>学习使用人工智能API</strong>：像OpenAI API这样的服务能让你无需自行构建模型，就能集成强大的模型功能。这是开始构建具备人工智能能力的实际应用最快的方式。</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>理解提示工程</strong>：学习如何与人工智能模型进行有效“沟通”是一项关键技能。设计精良的提示能显著提升模型输出质量，对于获得稳定结果至关重要。</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>构建简单的RAG应用</strong>：这需要通过向量数据库和嵌入技术，将人工智能模型与你自己的数据源连接起来，从而让模型能更有效地回答你的问题。</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>尝试不同的预训练模型</strong>：利用Hugging Face等平台获取他人开发的模型。这能让你在无需自行训练或微调模型的情况下，积累对不同模型架构的经验。</li>
</ol>
</li>
<li>
<ol start="5">
<li><strong>掌握基础应用架构</strong>：你需要开始学习如何构建人工智能应用的结构，包括恰当的输入处理、上下文构建和输出处理。</li>
</ol>
</li>
</ol>
<p>在这个阶段，你的重点是“应用”而非“创造”——即利用现有工具构建实用项目。大多数自学开发者都是从这个阶段起步的！你可以开发聊天机器人、内容生成器、简单分类系统等应用，解决实际问题。</p>
<p>如果你需要帮助来学习构建项目所需的全部技能，DataCamp平台提供了优质课程，助力你打下人工智能工程基础：</p>
<ul>
<li>• 对于希望将人工智能集成到应用中的开发者，其“开发者人工智能工程师助理”（Associate AI Engineer for Developers）学习路径会教你如何使用OpenAI API、Hugging Face、LangChain，以及Pinecone等向量数据库。</li>
<li>• 对于拥有数据科学背景、希望深入学习基础模型应用的人，“数据科学家人工智能工程师助理”（Associate AI Engineer for Data Scientists）学习路径能帮助你向人工智能工程领域转型。</li>
<li>• 如果你是完全的初学者，“人工智能基础”（AI Fundamentals）学习路径会通过无代码方式，为你介绍人工智能核心概念。</li>
</ul>
<p>这些课程的优势在于，它们能为你打下必要的基础，让你：</p>
<ul>
<li>• 开始构建实际项目——这是学习过程中最重要的环节</li>
<li>• 发现人工智能工程领域中最吸引你的方向，以便继续你的学习旅程</li>
</ul>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>迈向专业人工智能工程师</h2>
<p>拥有扎实的基础并完成一些实际项目后，你自然会希望深化自己的知识。</p>
<p>此时，阅读奇普·胡恩（Chip Huyen）所著的《人工智能工程》（AI Engineering）是绝佳选择，该书涵盖了成为一名实战型人工智能工程师所需理解的全部内容。阅读这本书及其参考文献，能让你在学习道路上稳步前行。</p>
<p>顺便说一句——我在自己的YouTube频道上制作了一个76分钟的完整版总结视频，拆解了书中所有关键概念。你可以在阅读前观看该视频进行预习，也可以在阅读后观看以巩固复习。</p>
<p>随着你完成更多项目，并学习诸如奇普所著书籍等资料，你的技能会自然拓展，逐渐涵盖以下领域：</p>
<ul>
<li>• <strong>深度学习</strong>：理解神经网络的复杂细节、训练过程以及基础模型的工作原理。学习Transformer架构、注意力机制，以及嵌入技术如何捕捉语义信息。</li>
<li>• <strong>部署与基础设施</strong>：学习使用Docker进行容器化，以及在AWS、GCP、Azure等平台上进行云部署。理解系统架构、监控和日志管理。</li>
<li>• <strong>高级RAG技术</strong>：实现更复杂的文档分块策略，优化嵌入技术，并理解不同检索方法之间的权衡。</li>
<li>• <strong>基础模型应用</strong>：掌握低秩适应（LoRA）等微调技术，并根据成本、性能和授权许可之间的权衡，做出明智的模型选择决策。</li>
<li>• <strong>构建稳健的评估系统</strong>：建立系统化的模型性能测试方法，衡量幻觉现象与偏差，并实施自动化和人工评估流程。</li>
<li>• <strong>推理优化</strong>：通过量化、蒸馏、优化部署架构等技术，提高模型运行速度和效率。</li>
<li>• <strong>智能体系统</strong>：构建能够分解复杂任务、有效使用工具，并在长时间交互中保持上下文的人工智能应用。</li>
<li>• <strong>安全、隐私与伦理</strong>：实施防范提示注入等攻击的防护措施，确保隐私合规，并考量人工智能系统的伦理影响。</li>
</ul>
<p>在这个阶段，你正从“使用人工智能工具”向“理解工具工作原理并针对特定场景优化工具”转变。中级与高级人工智能工程师的区别，往往就在于是否精通这些高级主题。没有这些技能，你将难以构建具备规模化运营能力或能应对复杂实际场景的系统；而掌握这些技能后，你将有资格应聘顶级公司中从事前沿人工智能应用的岗位——这类岗位的薪资通常可达30万至40万美元。</p>
<p>在这个高级阶段，还有更多专业技能需要学习——从数据集工程到应用架构模式等。</p>
<p>如果你想了解专业人工智能工程师所需的完整技能清单，我制作了一份详尽的检查清单，可私信作者免费下载。</p>
<h2 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>务实的时间规划</h2>
<p>从这份充满技术细节的清单中不难看出，想从完全的初学者在三个月内成长为专业人工智能工程师，是不现实的。以下是更务实的时间规划：</p>
<ul>
<li>• <strong>掌握基础并构建首个人工智能应用</strong>：约6个月（兼职学习）<br/>
这一前提是你能持续学习，且已具备一定编程基础。如果从零基础开始，需额外增加6个月。</li>
<li>• <strong>熟练掌握更高级概念</strong>：再需6至12个月<br/>
在此期间，你应不断构建更复杂的项目，并深化对底层技术的理解。</li>
<li>• <strong>达到专业水平</strong>：再需1至2年<br/>
这一阶段，你将培养在大型公司或高级人工智能应用项目中任职所需的专业技能。</li>
<li>• <strong>成为顶级公司的高级/主管级人工智能工程师（薪资真正达到30万美元以上）</strong> ：再需3至5年<br/>
要精通人工智能工程的全领域技能，并积累领导复杂项目的经验，需要在该领域投入大量时间。</li>
</ul>
<p>总体而言，如果你从零基础开始，且以兼职方式学习，预计需要3至6年才能达成目标。</p>
<p>这看起来时间很长？确实如此，但也符合实际情况。</p>
<p>请记住，你完全可以更早地开始构建项目，甚至进入该领域工作——无需等到掌握所有技能才行动。</p>
<h2 data-id="heading-5">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三款你必须尝试的超棒AI工具]]></title>    <link>https://juejin.cn/post/7586585498744766518</link>    <guid>https://juejin.cn/post/7586585498744766518</guid>    <pubDate>2025-12-23T03:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585498744766518" data-draft-id="7586573133349519406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三款你必须尝试的超棒AI工具"/> <meta itemprop="keywords" content="AIGC,OpenAI"/> <meta itemprop="datePublished" content="2025-12-23T03:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三款你必须尝试的超棒AI工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:45:43.000Z" title="Tue Dec 23 2025 03:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6599bc8f58c9463fbc251172fc64141d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=6PZIPjWQTD%2FpU7LWuHYwdn1wn7M%3D" alt="" loading="lazy"/></p>
<p>作者使用AI生成</p>
<p>快速提醒一下。这些不是赞助内容，它们只是很棒。</p>
<p><strong>让我们直接开始吧！</strong></p>
<h2 data-id="heading-0">1. Google AI Studio应用构建器</h2>
<p>唯一的Vibecoding平台，能让你在几分钟内（免费）获得美观、实用的应用程序。</p>
<p>没错，你没看错。你可以在几分钟内创建自己的应用程序（内部工具或面向公众的应用）。它确实有效，而且效果非常出色。</p>
<p>访问<a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">aistudio.google.com/</a>并注册一个免费账户，然后点击侧边栏中的“构建”开始使用。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8ad248945c4ee48f8024538284428f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=Ad6M0FDaK%2FXxmDsh2qlWQeZrz5k%3D" alt="" loading="lazy"/></p>
<p>构建就像点击和提示一样简单</p>
<p><strong>让我们直接来看一个例子。</strong></p>
<p>最近，我想为我的服装品牌添加一些刺绣产品。然而，我用来刺绣服装的网站只有几种线的颜色。我想创建一个工具，使用</p>
<p>仅</p>
<p>这15种颜色将图像转换为像素画。</p>
<p>我先进行了简要描述，它马上就开始构建了。</p>
<p>经过几个提示和添加了几个功能后，我得到了一个运行效果极佳的东西：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8b5614fbd8430eb5177252c31204f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=IQdEFC7OQt%2FtjYcDj2Ggx9hMVe4%3D" alt="" loading="lazy"/></p>
<p>成功将香蕉转换为特定颜色的像素画！</p>
<p>你甚至可以部署应用程序，以便其他人也能使用它：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5fab72921164219a5265b126a091971~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=MUpDTGoTNnHXPKLEM7oKd00Ih%2FQ%3D" alt="" loading="lazy"/></p>
<p>从Google AI工作室导出选项</p>
<p>这绝对是我用过的最让人上瘾、最有趣的AI工具。</p>
<p>为了好玩，我仅用两个小提示就成功构建了一个完整的Wordle克隆版（只是使用10字母单词）：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0534412cab46a185eb1457c40f7513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=9KrGakLm5x6AiwMXFHGoUN1a22s%3D" alt="" loading="lazy"/></p>
<p>提示词…</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49d7e5b2d2a647b5ba6b0961c904b0b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=wisF2zIA7j4sGjkN%2B8N%2BF%2Bsv1ug%3D" alt="" loading="lazy"/></p>
<p>以及最终呈现的游戏！</p>
<p>是的，它在几分钟内就创建了这个游戏，而且它真的能运行。相当令人惊叹！</p>
<h2 data-id="heading-1">2. 复制</h2>
<p>运行最先进的AI模型，创造一切。</p>
<p>Replicate本质上是一个汇集了所有最佳生成式AI工具的库。Replicate上有数千个AI模型，而且它们都非常容易运行。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0963472483c44761be44176808d4c629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=x%2BtZq5XxG56ooe%2BxKD9cyJLSrVE%3D" alt="" loading="lazy"/></p>
<p>展示一系列模型的Replicate探索页面</p>
<p>访问<a href="https://link.juejin.cn?target=https%3A%2F%2Freplicate.com%2Fexplore" target="_blank" title="https://replicate.com/explore" ref="nofollow noopener noreferrer">replicate.com/explore</a>，即可立即开始。</p>
<p><strong>我将通过一个例子向你展示它的一些功能：</strong></p>
<p>首先，假设我想用语言模型为AI图像生成器生成一个提示词。在研究了所有顶级模型后，我选择了Deepseek：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/810127694d7248f4a2ee0f298979052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=0WS61tf%2BLOiBOwtQt4L7UVRfxxk%3D" alt="" loading="lazy"/></p>
<p>生成图像提示</p>
<p>然后，我可以将这个图像提示输入到目前最新、最好的创意AI图像模型之一——Deepseek 4.5中：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/159d354f174b423c986edb8afcb3952d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=t9Dkx77k%2FdSUlP7QpH3ftt%2FSBP4%3D" alt="" loading="lazy"/></p>
<p>来自Seedream的图像和提示</p>
<p>现在，假设我喜欢它的某一个方面。但如果我放大，它就变得模糊了：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d2398a1f194136ae4232cdd1d54be0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=AeH2FzQJbNIjvhsSqGZchDZOQHo%3D" alt="" loading="lazy"/></p>
<p>图像有点模糊。</p>
<p>该怎么办呢？嗯，我可以使用图像超分辨率工具，将分辨率和细节提升到令人难以置信的程度：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ab38339acf848769459fed84d04c60a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=aGDd%2F7SWXPw5Y2GXCGnC8iDg73A%3D" alt="" loading="lazy"/></p>
<p>轰！瞬间呈现更出色的细节和分辨率。</p>
<p>最后，假设我想把它做成视频。我也能做到：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cd3f6b94168407fa529fd0dfe542ad7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=H5F2usaeqluUbVPOuHpEIT6y1Vw%3D" alt="" loading="lazy"/></p>
<p>使用Veo 3.1制作视频</p>
<p>没错，所以Replicate相当酷。除了这些功能，你还可以：</p>
<ul>
<li>
<p>转录音频</p>
</li>
<li>
<p>检测图像中的形状</p>
</li>
<li>
<p>现实世界视觉感知</p>
</li>
<li>
<p>生成音效</p>
</li>
<li>
<p>OCR图像</p>
</li>
<li>
<p>还有更多！</p>
</li>
</ul>
<p>很难想象所有这些工具都集成在一个简单的平台上。我一直用它来完成更具创意的工作。</p>
<h2 data-id="heading-2">3. Rhyme.ink</h2>
<p>语音写作画布。无需触碰键盘，即可连续写作数小时。</p>
<p>把我最喜欢的留到最后……</p>
<p>作为一名狂热的写作者，我一直在寻找更简单、更快捷、更好的写作方式。<a href="https://link.juejin.cn?target=https%3A%2F%2Frhyme.ink%2F" target="_blank" title="https://rhyme.ink/" ref="nofollow noopener noreferrer">rhyme.ink</a>就是答案。</p>
<p>你只需用语音就能撰写、格式化和编辑整篇文章、论文或其他任何内容。</p>
<p>写作变得像坐在椅子上聊天一样轻松。你甚至可以使用AI语音命令来修正语法错误、去除填充词，以及做任何你能想到的事情。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1826c279523e4e1e82d71020e96b6042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=Nb9anbgGtYHPw05S0qBh%2BsIS%2FJY%3D" alt="" loading="lazy"/></p>
<p>《Rhyme Canvas欢迎文档》</p>
<p>以下是一个使用 Rhyme 写作的示例，以及为何它比打字，甚至更不用说手写，要容易得多。</p>
<p>假设我想写一篇关于我最近最喜欢的新音乐流派之一的小博客文章。</p>
<p>我可以说话，Rhyme会在我说话时插入我的句子。我还可以通过语音命令添加空格、项目符号和各种其他格式：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c8176beb05b4468aeab070ec42308b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=TkbHcnVyvH8bgfDpnlAzVyVEZ0k%3D" alt="" loading="lazy"/></p>
<p>这么快就写完感觉真好！</p>
<p>我用语音写并排版了这个内容，大概只用了一分钟。进入状态需要一点时间，但一旦你让思绪自由流淌，不再担心语法、正确性或犯错，一切就变得真实起来。</p>
<p>你还可以让AI通过语音为你执行命令，只需说“Rhyme”即可。不想学习语音格式命令？你说完后，Rhyme就能帮你完成。</p>
<p>假设我想把这个画布内容转换为散文并修正一些语法错误。在这个例子中，我只是说：“嘿，Rhyme，请把这个画布内容转换为散文并修正所有语法错误”</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94b13cd20954cbd8da841f2b3a530dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066343&amp;x-signature=LYz9445WBt2sA4wSeqHLFUFmduw%3D" alt="" loading="lazy"/></p>
<p>快速编辑，将画布转换为散文。</p>
<p><strong>韵律的一些最佳部分包括：</strong></p>
<ol>
<li>
<p>自定义单词识别——为任何内容插入自定义单词。你甚至可以添加单个单词命令来插入整个段落！</p>
</li>
<li>
<p>完整的Markdown编辑功能（就像Medium一样）。你可以添加标题、粗体文本、列表等等。</p>
</li>
<li>
<p>完全支持语音导航。您可以使用语音命令快速移动光标。实际上，您根本无需触碰鼠标或键盘！</p>
</li>
<li>
<p>所有操作都可撤销。是听错了你的指令吗？还是AI没有按你的要求执行？只需说“撤销”，然后再试一次。</p>
</li>
<li>
<p>可定制的颜色样式。</p>
</li>
<li>
<p>专注模式，提供无干扰的写作画布，0 UI。</p>
</li>
<li>
<p>转录时具备完整的键盘编辑功能。</p>
</li>
<li>
<p>哦，而且它是免费的！</p>
</li>
</ol>
<p>我每天都在用它，希望你们也能像我一样觉得它很有用！我特别激动能和你们分享这个。</p>
<p>这些是我目前最喜欢的AI工具。你有喜欢的吗？在评论里分享一下吧！</p>
<p>感谢阅读。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentRun：60 秒创建第一个 Agent，一键转换为高代码，AI 开发者的“秘密武器”！]]></title>    <link>https://juejin.cn/post/7586579021283934262</link>    <guid>https://juejin.cn/post/7586579021283934262</guid>    <pubDate>2025-12-23T03:06:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586579021283934262" data-draft-id="7586582977707982890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentRun：60 秒创建第一个 Agent，一键转换为高代码，AI 开发者的“秘密武器”！"/> <meta itemprop="keywords" content="Serverless"/> <meta itemprop="datePublished" content="2025-12-23T03:06:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentRun：60 秒创建第一个 Agent，一键转换为高代码，AI 开发者的“秘密武器”！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:06:47.000Z" title="Tue Dec 23 2025 03:06:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：刘宇</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA4NjI4MzM4MQ%3D%3D%26mid%3D2660257517%26idx%3D1%26sn%3D050bc317ac020aec7b848f9531af8da6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA4NjI4MzM4MQ==&amp;mid=2660257517&amp;idx=1&amp;sn=050bc317ac020aec7b848f9531af8da6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云函数计算 AgentRun 全新发布后</a>，我们整理了“探秘 AgentRun”系列文章，本系列将梳理企业落地 Agent 常见难题，给出具体解法，助力 Agentic 快速 AI 走进生产级环境。</p>
<p>当我们谈论 AI Agent 的开发时，常常面临一个两难的选择：<strong>低代码平台上手快但缺乏灵活性，一旦需求复杂就束手无策；高代码开发虽然灵活但门槛高，业务人员无法参与，验证周期长。</strong> 能否鱼与熊掌兼得？</p>
<p>函数计算 AgentRun 给出了答案：<strong>通过无代码快速创建 Agent 验证想法，当业务发展需要更复杂定制时，一键转换为高代码继续演进。</strong> 这不是简单的功能堆砌，而是深刻理解了 Agent 应用从 0 到 1、从 1 到 100 的真实路径。</p>
<h2 data-id="heading-0">从想法到上线：60 秒创建你的第一个 Agent</h2>
<p>很多时候，最了解业务需求的是业务人员而不是技术人员，但传统的 Agent 开发需要编写大量代码，业务人员无法直接参与。函数计算 <strong>AgentRun 的无代码创建能力打破了这个限制。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e680ffbaab456f9efafa82db56453d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=kdiCfrDdKncRH0lOlPYmY3IxybE%3D" alt="图片" loading="lazy"/></p>
<p>如图，创建一个 Agent 只需要三四个步骤：</p>
<p><strong>第一步：在控制台选择创建 Agent</strong></p>
<p>进入函数计算 AgentRun 控制台 <strong>[</strong> <strong>1]</strong> ，点击“创建 Agent”按钮。</p>
<p><strong>第二步：选择快速创建模式</strong></p>
<p>在弹出的窗口中选择“快速创建”，平台会引导你通过简单的配置完成 Agent 创建。</p>
<p><strong>第三步：配置你的 Agent</strong></p>
<p>这是核心步骤，你需要完成几个简单的配置：</p>
<ul>
<li><strong>选择模型：</strong> 从 Qwen、Claude、GPT-4 等主流模型中选择，也可以选择企业自建的私有模型。不知道选哪个？平台会根据你的任务类型智能推荐。</li>
<li><strong>描述你的需求：</strong> 直接用自然语言描述你的需求，比如“我想要一个能帮用户查询订单状态的客服 Agent”。函数计算 AgentRun 的 AI 生成能力会自动理解你的需求，生成合适的 Prompt 和配置。更进一步，平台提供 Prompt AI 优化功能，会自动分析你的提示词，给出优化建议，让 Agent 的效果更好。</li>
<li><strong>选择工具和能力：</strong> 从工具市场选择 Agent 需要的能力。需要执行代码？添加 Code Interpreter。需要操作浏览器？添加 Browser Tool。需要调用企业内部 API？从工具市场搜索或一键创建 MCP。值得注意的是，Agent 本身、Sandbox、其他工具都可以以 MCP 形式提供——这意味着你可以让一个 Agent 调用另一个 Agent 的能力，实现能力的组合和复用。</li>
</ul>
<p><strong>第四步：点击创建</strong></p>
<p>完成配置后，点击“创建”按钮，<strong>60 秒后，你的 Agent 就可以开始工作了。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/069944a36e9741869d9f75664aa84a17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=IWblmRH%2BNu71gbf6JowwHkpxwec%3D" alt="图片" loading="lazy"/></p>
<p>平台还支持<strong>版本管理和灰度发布</strong>，你可以安全地测试新版本，确认没问题后再全量发布。</p>
<blockquote>
<p>除了快速创建，你还可以进行在线测试，并且可以进行多模型测试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd7fc506a8ef44689dd1f6745b3d57fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=mKZDXcxHR49EbigjyZQx%2Ff2NlyM%3D" alt="图片" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-1">业务发展，Agent 也要进化</h2>
<p>快速创建的 Agent 运行了一段时间，业务量不断增长，需求也越来越复杂。你开始遇到这些问题：</p>
<ul>
<li>需要根据用户的历史行为做个性化推荐，但无代码配置无法实现复杂的逻辑判断</li>
<li>需要对接企业内部复杂的业务系统，需要复杂的数据转换和错误处理</li>
<li>需要对 Agent 的行为进行精细化控制，比如在特定条件下调用特定模型</li>
<li>需要优化性能，减少不必要的模型调用以降低成本</li>
</ul>
<p><strong>这时候，你需要的是代码级别的控制能力。</strong> 传统的低代码平台到了这一步就束手无策，你要么忍受功能受限，要么推倒重来用高代码重写整个 Agent。但函数计算 AgentRun 提供了第三条路：<strong>一键转换为高代码。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b143bcd03d41fa9937bd9288a2e949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=y4y8dv1e8nCHAO9I7r7zmNgmeio%3D" alt="图片" loading="lazy"/></p>
<p>如图所示，转换过程非常简单：</p>
<ol>
<li>在 Agent 管理页面点击“转换为高代码”</li>
<li>平台会自动生成高质量的 Python 代码</li>
<li>代码结构清晰，包含完整的注释，易于理解和修改</li>
<li>你可以选择在函数计算 AgentRun 的在线 IDE 中直接编辑，也可以下载到本地使用你喜欢的开发工具</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84f731f6d19b43e6b97a60ee3f4099c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=yOTJ4EfOFuoa%2B%2BuKSugTTzIL%2BQc%3D" alt="图片" loading="lazy"/></p>
<p><strong>转换后的代码不是“垃圾代码”</strong> ，而是遵循最佳实践、结构清晰的高质量代码。它保留了你之前所有的配置（模型选择、Prompt、工具配置），并将它们转换为规范的代码结构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c88492872e894db08f9e8983a3c6b21e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=J6wSitl5TrMQvrRwUFLg1jfB5CA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">高代码的深度定制能力</h2>
<p>转换为高代码后，你进入了一个全新的世界。如图 3 所示，函数计算 AgentRun 提供了完整的高代码开发环境。</p>
<p>让我们看一个真实的例子。假设你的客服 Agent 需要根据用户的 VIP 等级提供不同的服务策略。在无代码阶段，你只能配置统一的模型、Prompt 和工具，所有用户得到的都是相同的服务。但转换为高代码后，你可以实现精细化的个性化策略。</p>
<p><strong>转换为高代码后，你获得了完全的控制能力。</strong> 可以根据用户等级动态调整服务策略——VIP 用户使用更好的模型、更详细的 Prompt、更高优先级的响应速度，而普通用户则使用更经济的配置，在保证体验的前提下降低成本。可以实现智能成本优化，不再对所有请求都使用同一个模型，而是根据查询的复杂度、用户等级、历史行为等因素，动态选择最合适的模型。简单问题用小模型快速响应，复杂问题才使用大模型，实现成本和效果的最优平衡。</p>
<p>当然，可靠性和安全性也能得到全面增强。可以添加自动重试机制、超时控制、异常处理，当模型调用失败时自动切换到备用模型或返回预设的降级响应，确保服务始终可用。在返回结果前自动过滤敏感信息，添加内容审核，记录完整的审计日志。还可以实现多步骤的复杂业务流程，比如先查询用户历史订单，再根据订单状态决定下一步操作，最后整合多个数据源的信息给出综合建议。这些在无代码界面中难以实现的复杂逻辑，在高代码中都可以灵活实现。</p>
<h2 data-id="heading-3">更进一步：与函数计算 AgentRun 基础设施深度集成</h2>
<p>转换为高代码后，你不仅可以编写业务逻辑，还可以深度利用函数计算 AgentRun 提供的各种基础设施能力。<strong>这些能力通过简单的配置和调用就可以使用，你不需要自己实现复杂的基础设施。</strong></p>
<p>利用函数计算 AgentRun 的模型代理能力，你可以配置主模型和多个备用模型，启用熔断机制。当主模型出现问题时，系统会自动切换到备用模型，整个过程对用户透明，确保服务连续性。通过前置 Hook 可以在工具调用前自动注入用户凭证、记录请求日志、校验参数合法性；通过后置 Hook 可以对结果进行转换、记录审计日志、处理异常情况。这些通用逻辑不需要在每个工具中重复实现，只需配置一次即可。</p>
<p>对于耗时较长的操作，比如复杂数据分析、大文件处理，可以使用函数计算 AgentRun 的异步调用能力。Agent 不必阻塞等待，可以继续处理其他请求，当异步任务完成后通过回调通知结果。这种能力在构建高并发、高性能的 Agent 应用时尤为重要。</p>
<h2 data-id="heading-4">真实案例：FunctionQ 的演进之路</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7af6e17b495e401ebd5f0f15345584a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=4zXPr9C9nlCSTTWL4UBo9a9%2FpGA%3D" alt="图片" loading="lazy"/></p>
<p>产品经理在第一天通过无代码界面快速创建了一个基础版本的 Agent，选择了 Qwen-Max 模型，配置了简单的 Prompt，从工具市场选择了“函数列表查询”、“函数详情查询”、“日志查询”等工具。当天下午，这个基础版本就上线了，开始服务内部测试用户。</p>
<p>第三天，测试用户开始反馈问题：Agent 调用工具时报“权限不足”错误，多个用户使用时数据混乱，成本增长很快但不知道花在哪里。这些问题在无代码界面无法解决，因为它们需要更复杂的逻辑控制。</p>
<p><strong>第五天，开发团队将 Agent 转换为高代码，问题迎刃而解。</strong> 通过配置 Hook 实现了动态凭证注入，根据用户 ID 自动获取对应的 AccessKey 和 SecretKey，在工具调用前注入到请求中，用户无感知但权限问题得到解决。利用函数计算 AgentRun 的会话亲和机制，确保同一用户的请求始终路由到同一实例，每个用户拥有独立的记忆存储，彻底隔离不同用户的数据。实现智能模型选择策略后，简单的列表查询使用 Qwen-Turbo，复杂的问题分析使用 Qwen-Max，在保持用户体验的前提下，成本降低了约 40%。</p>
<p>两周后，随着用户增长，团队继续优化。添加了智能缓存机制，相同的查询直接返回缓存结果，响应速度从 2 秒降到 0.1 秒。实现了多轮对话的上下文压缩，减少 Token 消耗。集成了企业内部的工单系统，Agent 可以自动创建和跟踪工单。根据问题类型实现了智能路由，自动分发到不同的专业 Agent。</p>
<p><strong>如果没有“无代码到高代码”的能力，这个项目会面临什么？</strong> 要么一开始就用高代码开发，验证周期从 1 天变成 1 周，错过最佳时间窗口。要么一直用无代码，无法解决权限、成本、性能等关键问题，最终不得不放弃。或者推倒重来，浪费前期所有积累，团队士气受挫。函数计算 <strong>AgentRun 让团队可以从最快的方式开始，随着业务发展平滑演进，没有技术债务，没有推倒重来。</strong></p>
<h2 data-id="heading-5">这不只是功能，更是理念</h2>
<p>从无代码到高代码的演进能力，背后体现的是函数计算 AgentRun 对 Agent 应用开发的深刻理解。</p>
<p><strong>Agent 应用的开发不是线性的。</strong> 它不是从需求分析、设计、开发、测试、上线这样的瀑布流程。更多时候，它是一个快速验证、迭代优化、逐步完善的螺旋式过程。在想法验证阶段，你需要的是速度；在业务成熟阶段，你需要的是灵活性和控制力。没有一种工具能同时满足所有阶段的需求，但函数计算 AgentRun 通过“无缝演进”解决了这个问题。</p>
<p><strong>技术选择不应该是一次性的决定。</strong> 选择低代码就被锁定在低代码的能力边界内，选择高代码就要承受高门槛和漫长的开发周期。函数计算 AgentRun 让你可以从最适合当前阶段的方式开始，随时根据需要演进到下一个阶段。更重要的是，这种演进是“零成本”的——转换为高代码不会丢失任何之前的配置和积累，生成的代码质量高、结构清晰，你可以在此基础上继续开发，而不是推倒重来。</p>
<p>这种设计理念的价值，在于它尊重了产品开发的真实规律。没有人能在第一天就预见所有需求，也没有团队愿意为了未来可能的需求而在初期就承担高昂的开发成本。函数计算 <strong>AgentRun 让你可以轻装上阵快速验证，当需求明确后再深度投入，这才是最符合实际的开发路径。</strong></p>
<h2 data-id="heading-6">立即体验</h2>
<p>函数计算 AgentRun 的无代码到高代码演进能力，现已开放体验：</p>
<ol>
<li>快速创建：访问控制台（ <a href="https://link.juejin.cn?target=https%3A%2F%2Ffunctionai.console.aliyun.com%2Fcn-hangzhou%2Fagent%2Fexplore" target="_blank" title="https://functionai.console.aliyun.com/cn-hangzhou/agent/explore" ref="nofollow noopener noreferrer">functionai.console.aliyun.com/cn-hangzhou…</a> ），60 秒创建你的第一个 Agent</li>
<li><strong>深度定制：</strong> 当需要更复杂功能时，一键转换为高代码</li>
<li><strong>持续演进：</strong> 利用函数计算 AgentRun 的基础设施能力，持续优化你的 Agent</li>
</ol>
<p>从想法到上线，从原型到生产，函数计算 AgentRun 始终是你最好的伙伴。欢迎加入“函数计算 AgentRun 客户群”，钉钉群号：134570017218。</p>
<h3 data-id="heading-7">快速了解函数计算 AgentRun</h3>
<p><strong>一句话介绍：</strong> 函数计算 AgentRun 是一个以高代码为核心的一站式 Agentic AI 基础设施平台。秉持生态开放和灵活组装的理念，为企业级 Agent 应用提供从开发、部署到运维的全生命周期管理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd79c2a830b043ffbb9620f5594e6da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064006&amp;x-signature=EKbeJMYfwKqDhLQwEbiTb3zuXRI%3D" alt="图片" loading="lazy"/></p>
<p><em>函数计算 AgentRun 架构图</em></p>
<p>AgentRun 运行时基于阿里云函数计算 FC 构建，继承了 Serverless 计算极致弹性、按量付费、零运维的核心优势。通过深度集成 AgentScope、Langchain、RAGFlow、Mem0 等主流开源生态。AgentRun 将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，<strong>平均 TCO 降低 60%</strong> 。 </p>
<p>让开发者只需专注于 Agent 的业务逻辑创新，无需关心底层基础设施，让 Agentic AI 真正进入企业生产环境。</p>
<p><strong>相关链接：</strong></p>
<p>[1] AgentRun 控制台</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffunctionai.console.aliyun.com%2Fcn-hangzhou%2Fagent%2Fexplore" target="_blank" title="https://functionai.console.aliyun.com/cn-hangzhou/agent/explore" ref="nofollow noopener noreferrer">functionai.console.aliyun.com/cn-hangzhou…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）]]></title>    <link>https://juejin.cn/post/7586498198149005363</link>    <guid>https://juejin.cn/post/7586498198149005363</guid>    <pubDate>2025-12-22T12:27:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586498198149005363" data-draft-id="7586482860103991323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-22T12:27:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="专业IT"/> <meta itemprop="url" content="https://juejin.cn/user/1118626084823481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1118626084823481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    专业IT
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:27:53.000Z" title="Mon Dec 22 2025 12:27:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）</h2>
<p>随着云原生技术的普及，Kubernetes已成为现代应用部署的事实标准。然而，其复杂性也带来了独特的故障排查挑战。本文将聚焦19个高频故障场景，提供快速定位和解决方案，助您成为Kubernetes故障排除专家。</p>
<h3 data-id="heading-1">一、集群基础问题排查</h3>
<h4 data-id="heading-2">1. 节点状态异常</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查节点状态</span>
kubectl <span class="hljs-keyword">get</span> nodes
kubectl describe node &lt;node-name&gt;

<span class="hljs-meta"># 常见故障：节点NotReady</span>
<span class="hljs-meta"># 解决方案：检查kubelet状态</span>
systemctl status kubelet
journalctl -u kubelet -n <span class="hljs-number">50</span> --no-pager

<span class="hljs-meta"># 重启kubelet（谨慎操作）</span>
sudo systemctl restart kubelet
</code></pre>
<h4 data-id="heading-3">2. 网络插件故障</h4>
<p>Calico/Flannel等CNI插件问题常导致Pod间通信失败：</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 检查网络插件Pod状态</span>
kubectl get pods -n kube-<span class="hljs-keyword">system</span> | <span class="hljs-keyword">grep</span> -E <span class="hljs-string">'calico|flannel|cilium'</span>

<span class="hljs-comment"># 重启网络插件（如果允许）</span>
kubectl <span class="hljs-keyword">delete</span> pods -n kube-<span class="hljs-keyword">system</span> -l k8s-app=calico-node
</code></pre>
<h3 data-id="heading-4">二、Pod与容器层故障</h3>
<h4 data-id="heading-5">3. Pod一直处于Pending状态</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看具体原因</span>
kubectl describe pod &lt;pod-name&gt;

<span class="hljs-comment"># 常见原因及解决方案：</span>
<span class="hljs-comment"># 1. 资源不足：检查节点资源</span>
kubectl describe nodes | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">5</span> -B <span class="hljs-number">5</span> <span class="hljs-string">"Allocatable"</span>

<span class="hljs-comment"># 2. 不满足节点选择器/污点容忍</span>
<span class="hljs-comment"># 调整节点选择器或添加容忍</span>
</code></pre>
<h4 data-id="heading-6">4. Pod崩溃循环（CrashLoopBackOff）</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看Pod日志</span>
kubectl logs &lt;pod-name&gt; --previous

<span class="hljs-comment"># 进入Pod调试（如果Pod能短暂运行）</span>
kubectl <span class="hljs-keyword">exec</span> -it &lt;pod-name&gt; -- <span class="hljs-regexp">/bin/s</span>h

<span class="hljs-comment"># 检查应用启动命令和参数</span>
kubectl describe pod &lt;pod-name&gt; | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">10</span> <span class="hljs-string">"Command"</span>
</code></pre>
<h4 data-id="heading-7">5. 镜像拉取失败（ImagePullBackOff）</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查镜像仓库认证</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">regcred</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/dockerconfigjson</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-string">.dockerconfigjson:</span> <span class="hljs-string">&lt;base64-encoded-docker-config&gt;</span>
</code></pre>
<h3 data-id="heading-8">三、服务与网络问题</h3>
<h4 data-id="heading-9">6. Service无法访问</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查Service端点</span>
kubectl <span class="hljs-keyword">get</span> endpoints &lt;service-name&gt;

<span class="hljs-meta"># 如果没有端点，检查Selector匹配</span>
kubectl <span class="hljs-keyword">get</span> pods --show-labels | grep &lt;selector-label&gt;

<span class="hljs-meta"># 临时端口转发调试</span>
kubectl port-forward svc/&lt;service-name&gt; <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
</code></pre>
<h4 data-id="heading-10">7. Ingress控制器问题</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查Ingress控制器状态</span>
kubectl <span class="hljs-keyword">get</span> pods -n ingress-nginx

<span class="hljs-meta"># 查看Ingress事件</span>
kubectl describe ingress &lt;ingress-name&gt;

<span class="hljs-meta"># 检查IngressClass配置</span>
kubectl <span class="hljs-keyword">get</span> ingressclass
</code></pre>
<h3 data-id="heading-11">四、存储与配置问题</h3>
<h4 data-id="heading-12">8. PVC一直处于Pending状态</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查StorageClass</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">storageclass</span>

<span class="hljs-comment"># 检查PV/PVC详情</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pvc</span> <span class="hljs-string">&lt;pvc-name&gt;</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pv</span> <span class="hljs-string">&lt;pv-name&gt;</span>

<span class="hljs-comment"># 动态供应失败时，可创建静态PV</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">static-pv</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">capacity:</span>
    <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>
  <span class="hljs-attr">hostPath:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">"/mnt/data"</span>
</code></pre>
<h4 data-id="heading-13">9. ConfigMap/Secret更新未生效</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看Pod挂载的配置</span>
kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- <span class="hljs-built_in">cat</span> /etc/config/app.properties

<span class="hljs-comment"># 强制重新部署（触发配置更新）</span>
kubectl rollout restart deployment/&lt;deployment-name&gt;
</code></pre>
<h3 data-id="heading-14">五、资源与调度优化</h3>
<h4 data-id="heading-15">10. 内存/CPU限制导致OOMKilled</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 合理设置资源限制</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>

<span class="hljs-comment"># 监控资源使用</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">top</span> <span class="hljs-string">pods</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pod</span> <span class="hljs-string">&lt;pod-name&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-A</span> <span class="hljs-number">5</span> <span class="hljs-string">"Limits"</span>
</code></pre>
<h4 data-id="heading-16">11. 节点资源压力</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 检查节点资源分配</span>
kubectl describe nodes | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">10</span> <span class="hljs-string">"Allocated resources"</span>

<span class="hljs-comment"># 驱逐低优先级Pod（如有配置）</span>
kubectl get pods --all-namespaces -o wide | <span class="hljs-keyword">grep</span> Evicted
</code></pre>
<h3 data-id="heading-17">六、高级调试技巧</h3>
<h4 data-id="heading-18">12. 使用临时调试容器</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Kubernetes 1.18+ 支持临时容器</span>
kubectl debug &lt;pod-name&gt; -it <span class="hljs-attr">--image</span>=busybox --target=&lt;container-name&gt;
</code></pre>
<h4 data-id="heading-19">13. 网络策略调试</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-css" lang="css"># 检查网络策略影响
kubectl get networkpolicy <span class="hljs-attr">--all-namespaces</span>

# 创建测试Pod验证连通性
kubectl run test-pod <span class="hljs-attr">--image</span>=busybox <span class="hljs-attr">--rm</span> -it <span class="hljs-attr">--restart</span>=Never -- ping &lt;target-pod-ip&gt;
</code></pre>
<h3 data-id="heading-20">七、自动修复与预防</h3>
<h4 data-id="heading-21">14. 配置健康检查</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 添加就绪和存活探针</span>
<span class="hljs-attr">livenessProbe:</span>
  <span class="hljs-attr">httpGet:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>

<span class="hljs-attr">readinessProbe:</span>
  <span class="hljs-attr">tcpSocket:</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
</code></pre>
<h4 data-id="heading-22">15. 使用PodDisruptionBudget保证可用性</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodDisruptionBudget</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-pdb</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
</code></pre>
<h3 data-id="heading-23">八、监控与日志聚合</h3>
<h4 data-id="heading-24">16. 集中日志收集</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 快速查看相关Pod日志</span>
kubectl logs -l <span class="hljs-attr">app</span>=myapp --tail=<span class="hljs-number">50</span>

<span class="hljs-comment"># 多容器Pod日志查看</span>
kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;
</code></pre>
<h4 data-id="heading-25">17. 性能指标监控</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Metrics Server</span>
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

<span class="hljs-comment"># 查看资源使用情况</span>
kubectl top nodes
kubectl top pods -A
</code></pre>
<h3 data-id="heading-26">九、安全与权限问题</h3>
<h4 data-id="heading-27">18. RBAC权限不足</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查用户/服务账户权限</span>
kubectl auth can-i create pods --<span class="hljs-keyword">as</span> system:serviceaccount:<span class="hljs-literal">default</span>:my-sa

<span class="hljs-meta"># 查看详细的RBAC配置</span>
kubectl <span class="hljs-keyword">get</span> rolebindings,clusterrolebindings --all-namespaces
</code></pre>
<h4 data-id="heading-28">19. Pod安全策略违规</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查PodSecurityPolicy</span>
kubectl <span class="hljs-keyword">get</span> psp

<span class="hljs-meta"># 查看被拒绝的Pod事件</span>
kubectl <span class="hljs-keyword">get</span> events --field-selector=reason=FailedCreate
</code></pre>
<h3 data-id="heading-29">总结：构建系统化排障流程</h3>
<ol>
<li><strong>快速诊断</strong>：使用<code>kubectl get</code>和<code>describe</code>获取资源状态</li>
<li><strong>日志分析</strong>：深入容器日志查找错误线索</li>
<li><strong>网络验证</strong>：检查服务发现和网络策略</li>
<li><strong>资源配置</strong>：确认请求和限制设置合理</li>
<li><strong>权限检查</strong>：验证RBAC和PSP配置</li>
<li><strong>集群健康</strong>：监控组件状态和资源使用</li>
</ol>
<p>记住这些命令和技巧，结合自动化监控告警，您将能大幅缩短Kubernetes故障恢复时间。随着Kubernetes生态的演进，保持对新版本特性和最佳实践的了解同样重要。2025年的Kubernetes环境更加智能化，但坚实的故障排查基本功仍然是每个云原生工程师的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发下如何防止重复提交订单？]]></title>    <link>https://juejin.cn/post/7586588823905468425</link>    <guid>https://juejin.cn/post/7586588823905468425</guid>    <pubDate>2025-12-23T02:11:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905468425" data-draft-id="7586573133348782126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发下如何防止重复提交订单？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T02:11:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发下如何防止重复提交订单？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:11:36.000Z" title="Tue Dec 23 2025 02:11:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>当你的用户疯狂点击提交按钮时，你的系统准备好迎接这场“连击风暴”了吗？</p>
<p>在电商系统的实战中，我见过太多因重复提交导致的资损事故——用户一次点击，系统却创建了多个订单，导致库存错乱、用户重复支付、客服投诉爆棚。</p>
<p>有些小伙伴在工作中可能遇到过这样的场景：大促期间，用户反馈“明明只点了一次，为什么扣了两次款？”</p>
<p>开发同学查了半天日志，发现同一个用户请求在毫秒级内真的到达了服务器两次。</p>
<p>今天这篇文章就跟大家聊聊高并发下防止重复提交订单，希望对你会有所帮助。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" title="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank">更多项目实战在我的技术网站：www.susan.net.cn/project</a></p>
<h2 data-id="heading-1">01 为什么会重复提交？</h2>
<p>在深入解决方案前，我们必须搞清楚重复提交是如何发生的。</p>
<p>常见的场景有：</p>
<ol>
<li><strong>用户无意识重复点击</strong>：网络延迟时，用户心急多次点击提交按钮</li>
<li><strong>前端防抖失效</strong>：前端做了防抖处理，但被绕过或配置不当</li>
<li><strong>网络超时重试</strong>：请求超时后，客户端或网关自动重试</li>
<li><strong>恶意攻击</strong>：竞争对手或黑客故意重复提交</li>
<li><strong>后端处理超时</strong>：第一个请求处理慢，客户端以为失败又发一次</li>
</ol>
<p>来看一个典型的用户操作流程，以及其中可能发生重复的各个环节：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51b6ad873d9e48358c9963bf3e114a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=EezGzi0fvGo9YpZfGutG%2Bde0qJQ%3D" alt="" loading="lazy"/></p>
<p>从图中可以看到，从用户点击到订单落库，几乎每个环节都可能成为重复提交的“案发现场”。</p>
<p>下面，我们就针对这些环节，层层布防。</p>
<h2 data-id="heading-2">02 第一道防线：前端防抖与按钮控制</h2>
<p>这是最直观、成本最低的防护措施。</p>
<p>原则是：<strong>在用户交互层面尽量减少无效请求</strong>。</p>
<h3 data-id="heading-3">2.1 按钮状态控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端防抖实现示例（Vue + Element UI）</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> 
    <span class="hljs-attr">:loading</span>=<span class="hljs-string">"submitting"</span> 
    <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"submitting"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSubmitOrder"</span>
  &gt;</span>
    {{ submitting ? '提交中...' : '提交订单' }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">submitting</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">submitToken</span>: <span class="hljs-literal">null</span> <span class="hljs-comment">// 用于标识当前提交的token</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmitOrder</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'正在提交，请勿重复点击'</span>)
        <span class="hljs-keyword">return</span>
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span> = <span class="hljs-literal">true</span>
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 生成唯一token，用于后端幂等性校验</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitToken</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateSubmitToken</span>()
        
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$api</span>.<span class="hljs-property">order</span>.<span class="hljs-title function_">submit</span>({
          <span class="hljs-attr">orderData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderData</span>,
          <span class="hljs-attr">submitToken</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitToken</span>
        })
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'订单提交成功'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`/order/detail/<span class="hljs-subst">${result.orderId}</span>`</span>)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`提交失败: <span class="hljs-subst">${error.message}</span>`</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 失败后重置状态</span>
      }
    },
    
    <span class="hljs-title function_">generateSubmitToken</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 生成唯一标识，可以用UUID或时间戳+随机数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">`order_submit_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-4">2.2 请求防抖与拦截</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用axios拦截器实现请求防抖</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 存储正在进行的请求</span>
<span class="hljs-keyword">const</span> pendingRequests = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()

<span class="hljs-comment">// 生成请求key</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateReqKey</span> = (<span class="hljs-params">config</span>) =&gt; {
  <span class="hljs-keyword">const</span> { method, url, params, data } = config
  <span class="hljs-keyword">return</span> [method, url, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params), <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)].<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>)
}

<span class="hljs-comment">// 请求拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(config)
  
  <span class="hljs-keyword">if</span> (pendingRequests.<span class="hljs-title function_">has</span>(key)) {
    <span class="hljs-comment">// 请求已存在，取消当前请求</span>
    config.<span class="hljs-property">cancelToken</span> = <span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">CancelToken</span>(<span class="hljs-function"><span class="hljs-params">cancel</span> =&gt;</span> {
      <span class="hljs-title function_">cancel</span>(<span class="hljs-string">`重复请求已被拦截: <span class="hljs-subst">${key}</span>`</span>)
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 新请求，添加到pending中</span>
    pendingRequests.<span class="hljs-title function_">set</span>(key, config)
  }
  
  <span class="hljs-keyword">return</span> config
})

<span class="hljs-comment">// 响应拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(response.<span class="hljs-property">config</span>)
    pendingRequests.<span class="hljs-title function_">delete</span>(key)
    <span class="hljs-keyword">return</span> response
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
    }
    
    <span class="hljs-comment">// 错误处理完成后，也要从pending中移除</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">config</span>) {
      <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(error.<span class="hljs-property">config</span>)
      pendingRequests.<span class="hljs-title function_">delete</span>(key)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)
</code></pre>
<p><strong>前端防护小结</strong>：</p>
<ul>
<li><strong>优点</strong>：实现简单，能拦截大部分用户无意识的重复点击</li>
<li><strong>缺点</strong>：可被绕过（如直接调用API、禁用JS、使用Postman等工具）</li>
<li><strong>结论</strong>：前端防护是<strong>必要但不充分</strong>的措施，绝不能作为唯一防线</li>
</ul>
<h2 data-id="heading-5">03 第二道防线：后端接口幂等性设计</h2>
<p>幂等性是解决重复提交的<strong>核心理念</strong>。</p>
<p>所谓幂等，就是<strong>同一个操作执行多次的结果与执行一次的结果相同</strong>。</p>
<h3 data-id="heading-6">3.1 什么是幂等性？</h3>
<p>对于订单提交接口：</p>
<ul>
<li><strong>幂等</strong>：无论调用1次还是N次，都只创建一个订单</li>
<li><strong>非幂等</strong>：调用N次可能创建N个订单</li>
</ul>
<h3 data-id="heading-7">3.2 基于Token的幂等实现</h3>
<p>这是最常用的幂等实现方案，流程如下：</p>
<ol>
<li>客户端在提交前，先向后端申请一个唯一Token</li>
<li>提交订单时携带此Token</li>
<li>服务端检查Token是否已使用过</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 幂等性Token服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentTokenService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IDEMPOTENT_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TOKEN_EXPIRE_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span>; <span class="hljs-comment">// Token有效期5分钟</span>
    
    <span class="hljs-comment">/**
     * 生成幂等性Token
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> IDEMPOTENT_PREFIX + userId + <span class="hljs-string">":"</span> + token;
        
        <span class="hljs-comment">// 存储Token，设置过期时间</span>
        redisTemplate.opsForValue().set(
            redisKey, 
            <span class="hljs-string">"1"</span>, 
            TOKEN_EXPIRE_SECONDS, 
            TimeUnit.SECONDS
        );
        
        <span class="hljs-keyword">return</span> token;
    }
    
    <span class="hljs-comment">/**
     * 检查并消费Token
     * <span class="hljs-doctag">@return</span> true: Token有效且消费成功; false: Token无效或已消费
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAndConsumeToken</span><span class="hljs-params">(String userId, String token)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> IDEMPOTENT_PREFIX + userId + <span class="hljs-string">":"</span> + token;
        
        <span class="hljs-comment">// 使用Lua脚本保证原子性</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            if redis.call('get', KEYS[1]) == '1' then
                redis.call('del', KEYS[1])
                return 1
            else
                return 0
            end
            """</span>;
        
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute(
            redisScript, 
            Collections.singletonList(redisKey)
        );
        
        <span class="hljs-keyword">return</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
    }
}

<span class="hljs-comment">// 使用AOP实现幂等性校验</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Idempotent {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 幂等键，支持SpEL表达式</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">expireTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">300</span>; <span class="hljs-comment">// 过期时间，秒</span>
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-meta">@Around("@annotation(idempotent)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Idempotent idempotent)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 1. 获取方法参数</span>
        Object[] args = joinPoint.getArgs();
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        
        <span class="hljs-comment">// 2. 解析幂等键（支持SpEL）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">keyExpression</span> <span class="hljs-operator">=</span> idempotent.key();
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> parseKey(keyExpression, method, args);
        
        <span class="hljs-comment">// 3. 尝试获取分布式锁（防止并发请求同时通过检查）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> redisKey + <span class="hljs-string">":lock"</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">lockAcquired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试加锁</span>
            lockAcquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);
            
            <span class="hljs-keyword">if</span> (!lockAcquired) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
            }
            
            <span class="hljs-comment">// 4. 检查Token是否已使用</span>
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(exists)) {
                <span class="hljs-comment">// Token已使用，直接返回之前的处理结果（这里需要根据实际业务调整）</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"请勿重复提交订单"</span>);
            }
            
            <span class="hljs-comment">// 5. 执行业务逻辑</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
            
            <span class="hljs-comment">// 6. 标记Token已使用</span>
            redisTemplate.opsForValue().set(
                redisKey, 
                <span class="hljs-string">"processed"</span>, 
                idempotent.expireTime(), 
                TimeUnit.SECONDS
            );
            
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 释放锁</span>
            <span class="hljs-keyword">if</span> (lockAcquired) {
                redisTemplate.delete(lockKey);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseKey</span><span class="hljs-params">(String expression, Method method, Object[] args)</span> {
        <span class="hljs-comment">// 这里实现SpEL表达式解析，获取实际的幂等键</span>
        <span class="hljs-comment">// 例如可以从参数中提取userId+orderToken</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"parsed:key:from:expression"</span>;
    }
}

<span class="hljs-comment">// 在订单提交接口上使用</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@PostMapping("/submit")</span>
    <span class="hljs-meta">@Idempotent(key = "#request.userId + ':' + #request.submitToken", expireTime = 300)</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;OrderSubmitResult&gt; <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 这里是真正的订单创建逻辑</span>
        <span class="hljs-type">OrderSubmitResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder(request);
        <span class="hljs-keyword">return</span> ApiResponse.success(result);
    }
}
</code></pre>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了20多家大厂的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h3 data-id="heading-8">3.3 基于唯一业务标识的幂等</h3>
<p>除了Token方案，还可以利用业务的自然唯一性实现幂等：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 方法1：先查询是否存在</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByUniqueKey(
            request.getUserId(), 
            request.getProductId(), 
            request.getSubmitTime()
        );
        
        <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 订单已存在，直接返回</span>
            <span class="hljs-keyword">return</span> convertToResult(existingOrder);
        }
        
        <span class="hljs-comment">// 方法2：利用数据库唯一约束</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">newOrder</span> <span class="hljs-operator">=</span> buildOrder(request);
            orderMapper.insert(newOrder);
            <span class="hljs-keyword">return</span> convertToResult(newOrder);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 捕获唯一键冲突异常</span>
            log.warn(<span class="hljs-string">"订单重复提交，uniqueKey={}"</span>, request.getUniqueKey());
            
            <span class="hljs-comment">// 查询已创建的订单并返回</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByUniqueKey(
                request.getUserId(), 
                request.getProductId(), 
                request.getSubmitTime()
            );
            
            <span class="hljs-keyword">if</span> (createdOrder == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"订单处理异常，请稍后重试"</span>);
            }
            
            <span class="hljs-keyword">return</span> convertToResult(createdOrder);
        }
    }
    
    <span class="hljs-comment">// 订单表可添加唯一索引</span>
    <span class="hljs-comment">// ALTER TABLE t_order ADD UNIQUE KEY uk_user_product_time (user_id, product_id, submit_time);</span>
}
</code></pre>
<p><strong>幂等性设计小结</strong>：</p>
<ul>
<li><strong>Token方案</strong>：通用性强，适合大多数场景</li>
<li><strong>业务标识方案</strong>：更自然，但依赖业务的天然唯一性</li>
<li><strong>关键点</strong>：所有幂等性检查<strong>必须在事务开始前完成</strong>，否则可能失效</li>
</ul>
<h2 data-id="heading-9">04 第三道防线：数据库层防护</h2>
<p>数据库是数据持久化的最后一道关卡，在这里设置防护至关重要。</p>
<h3 data-id="heading-10">4.1 唯一约束与乐观锁</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表设计示例</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_order` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号，业务唯一'</span>,
  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `product_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `quantity` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'购买数量'</span>,
  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
  `status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'订单状态：1-待支付，2-已支付'</span>,
  `submit_token` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'提交Token，用于幂等'</span>,
  `version` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'版本号，用于乐观锁'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`), <span class="hljs-comment">-- 订单号唯一</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_submit_token` (`user_id`, `submit_token`), <span class="hljs-comment">-- 提交Token唯一</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_product_time` (`user_id`, `product_id`, `create_time`), <span class="hljs-comment">-- 业务维度唯一</span>
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'订单表'</span>;
</code></pre>
<h3 data-id="heading-11">4.2 数据库层面的幂等实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用数据库事务+唯一约束保证最终一致性</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceV2</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> IdempotentTokenService tokenService;
    
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitOrderWithDBProtection</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getUserId();
        <span class="hljs-type">String</span> <span class="hljs-variable">submitToken</span> <span class="hljs-operator">=</span> request.getSubmitToken();
        
        <span class="hljs-comment">// 1. 检查幂等Token（在事务外先检查一次）</span>
        <span class="hljs-keyword">if</span> (!tokenService.checkAndConsumeToken(userId, submitToken)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"请勿重复提交订单"</span>);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 生成订单号（雪花算法等分布式ID生成器）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> generateOrderNo();
            
            <span class="hljs-comment">// 3. 创建订单对象</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setOrderNo(orderNo);
            order.setUserId(userId);
            order.setProductId(request.getProductId());
            order.setQuantity(request.getQuantity());
            order.setAmount(calculateAmount(request));
            order.setSubmitToken(submitToken);
            
            <span class="hljs-comment">// 4. 插入订单（这里依赖数据库唯一约束）</span>
            orderMapper.insert(order);
            
            <span class="hljs-comment">// 5. 更新库存等后续操作...</span>
            updateProductStock(request.getProductId(), request.getQuantity());
            
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(orderNo, <span class="hljs-string">"订单创建成功"</span>);
            
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 6. 处理唯一约束冲突</span>
            log.warn(<span class="hljs-string">"订单重复提交，userId={}, token={}"</span>, userId, submitToken);
            
            <span class="hljs-comment">// 查询已创建的订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectBySubmitToken(userId, submitToken);
            <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(
                    existingOrder.getOrderNo(), 
                    <span class="hljs-string">"订单已创建成功，请勿重复提交"</span>
                );
            }
            
            <span class="hljs-comment">// 理论上不会走到这里，除非有极端情况</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"订单处理异常，请稍后重试"</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-12">05 第四道防线：分布式锁</h2>
<p>在分布式环境下，多个实例可能同时处理同一个请求，需要分布式锁来保证只有一个实例执行核心逻辑。</p>
<h3 data-id="heading-13">5.1 基于Redis的分布式锁</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-comment">/**
     * 尝试获取分布式锁
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> waitTime 等待时间（毫秒）
     * <span class="hljs-doctag">@param</span> leaseTime 持有时间（毫秒）
     * <span class="hljs-doctag">@return</span> 锁对象，获取失败返回null
     */</span>
    <span class="hljs-keyword">public</span> RLock <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(waitTime, leaseTime, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">return</span> acquired ? lock : <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 订单提交分布式锁
     */</span>
    <span class="hljs-keyword">public</span> RLock <span class="hljs-title function_">lockForOrderSubmit</span><span class="hljs-params">(String userId, String submitToken)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"order:submit:lock:%s:%s"</span>, userId, submitToken);
        <span class="hljs-keyword">return</span> tryLock(lockKey, <span class="hljs-number">100</span>, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 等待100ms，锁持有5秒</span>
    }
}

<span class="hljs-comment">// 在订单服务中使用分布式锁</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceV3</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DistributedLockService lockService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitOrderWithDistributedLock</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getUserId();
        <span class="hljs-type">String</span> <span class="hljs-variable">submitToken</span> <span class="hljs-operator">=</span> request.getSubmitToken();
        
        <span class="hljs-comment">// 1. 获取分布式锁</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> lockService.lockForOrderSubmit(userId, submitToken);
        <span class="hljs-keyword">if</span> (lock == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 检查是否已处理</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectBySubmitToken(userId, submitToken);
            <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(
                    existingOrder.getOrderNo(), 
                    <span class="hljs-string">"订单已创建成功，请勿重复提交"</span>
                );
            }
            
            <span class="hljs-comment">// 3. 执行业务逻辑</span>
            <span class="hljs-keyword">return</span> doCreateOrder(request);
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放锁</span>
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    <span class="hljs-keyword">private</span> OrderSubmitResult <span class="hljs-title function_">doCreateOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 实际的订单创建逻辑</span>
        <span class="hljs-comment">// 这里已经保证了同一时刻只有一个线程在处理同一个提交请求</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-14">5.2 分布式锁的注意事项</h3>
<p>使用分布式锁时要注意：</p>
<ol>
<li><strong>锁粒度</strong>：不要太粗（影响性能）也不要太细（增加复杂度）</li>
<li><strong>锁超时</strong>：必须设置合理的超时时间，防止死锁</li>
<li><strong>锁续期</strong>：对于长时间操作，需要实现锁续期机制</li>
<li><strong>可重入性</strong>：同一个线程可以重复获取锁</li>
<li><strong>容错性</strong>：Redis集群故障时要有降级方案</li>
</ol>
<h2 data-id="heading-15">06 第五道防线：异步处理与消息队列</h2>
<p>对于高并发场景，可以采用异步处理模式，将同步请求转为异步任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90fb2463affa440aa8d5fb9e84bd73f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=etKQANGWdTFnRfnHUnFWHdjeWws%3D" alt="" loading="lazy"/></p>
<p>实现代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 异步订单处理实现</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-comment">/**
     * 异步提交订单
     */</span>
    <span class="hljs-keyword">public</span> AsyncSubmitResult <span class="hljs-title function_">asyncSubmitOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 1. 生成唯一请求ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> generateRequestId(request.getUserId());
        
        <span class="hljs-comment">// 2. 快速验证（库存、用户状态等）</span>
        quickValidate(request);
        
        <span class="hljs-comment">// 3. 将请求ID与用户关联（用于查询结果）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">pendingKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:pending:"</span> + request.getUserId() + <span class="hljs-string">":"</span> + requestId;
        redisTemplate.opsForValue().set(pendingKey, <span class="hljs-string">"processing"</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        
        <span class="hljs-comment">// 4. 发送到消息队列</span>
        <span class="hljs-type">OrderMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderMessage</span>();
        message.setRequestId(requestId);
        message.setRequest(request);
        message.setTimestamp(System.currentTimeMillis());
        
        rocketMQTemplate.asyncSend(
            <span class="hljs-string">"ORDER_SUBMIT_TOPIC"</span>, 
            message, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
                    log.info(<span class="hljs-string">"订单消息发送成功: {}"</span>, requestId);
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable throwable)</span> {
                    log.error(<span class="hljs-string">"订单消息发送失败: {}"</span>, requestId, throwable);
                    <span class="hljs-comment">// 发送失败，更新状态</span>
                    redisTemplate.opsForValue().set(
                        pendingKey, 
                        <span class="hljs-string">"failed"</span>, 
                        <span class="hljs-number">5</span>, 
                        TimeUnit.MINUTES
                    );
                }
            }
        );
        
        <span class="hljs-comment">// 5. 立即返回，告知用户处理中</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSubmitResult</span>(requestId, <span class="hljs-string">"订单提交成功，正在处理中"</span>);
    }
}

<span class="hljs-comment">// 消息消费者</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(
    topic = "ORDER_SUBMIT_TOPIC",
    consumerGroup = "order-submit-consumer-group"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSubmitConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;OrderMessage&gt; {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(OrderMessage message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> message.getRequestId();
        <span class="hljs-type">OrderSubmitRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> message.getRequest();
        
        <span class="hljs-comment">// 1. 幂等检查（基于requestId）</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existing</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
        <span class="hljs-keyword">if</span> (existing != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"订单已处理，跳过: {}"</span>, requestId);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 2. 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> createOrder(request, requestId);
        
        <span class="hljs-keyword">try</span> {
            orderMapper.insert(order);
            log.info(<span class="hljs-string">"订单创建成功: {}"</span>, order.getOrderNo());
            
            <span class="hljs-comment">// 3. 更新处理状态</span>
            updateProcessingStatus(request.getUserId(), requestId, <span class="hljs-string">"success"</span>, order.getOrderNo());
            
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            log.warn(<span class="hljs-string">"订单重复，requestId={}"</span>, requestId);
            <span class="hljs-comment">// 查询已创建的订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">created</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
            <span class="hljs-keyword">if</span> (created != <span class="hljs-literal">null</span>) {
                updateProcessingStatus(request.getUserId(), requestId, <span class="hljs-string">"success"</span>, created.getOrderNo());
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-16">07 综合方案：多层次联合防护</h2>
<p>在实际生产环境中，我们通常会采用多层次、立体化的防护策略。</p>
<p>以下是一个完整的综合方案流程图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6a5a4471629405bb76af04a642c9279~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=qM7q5jh8zQOC9Fchq4j0HOaKuw4%3D" alt="" loading="lazy"/></p>
<p>这个多层次方案中，每一层都有其特定作用：</p>
<ul>
<li><strong>前端层</strong>：用户体验优化，拦截大部分无意识重复</li>
<li><strong>网关层</strong>：安全防护，防刷、限流</li>
<li><strong>业务层</strong>：核心幂等逻辑，分布式锁保证并发安全</li>
<li><strong>数据层</strong>：最终保障，唯一约束防止数据不一致</li>
<li><strong>异步层</strong>：削峰填谷，提升系统吞吐量</li>
</ul>
<h2 data-id="heading-17">08 实战：不同场景下的方案选择</h2>
<p>不同的业务场景需要不同的防护策略，这里给出一些实践建议：</p>
<h3 data-id="heading-18">8.1 普通电商订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 普通电商订单推荐方案</span>
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardOrderService</span> {
    
    <span class="hljs-comment">// 综合使用：前端防抖 + Token幂等 + 数据库唯一约束</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitStandardOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 1. 参数校验</span>
        validateRequest(request);
        
        <span class="hljs-comment">// 2. 幂等Token检查（Redis）</span>
        <span class="hljs-keyword">if</span> (!idempotentCheck(request.getUserId(), request.getSubmitToken())) {
            <span class="hljs-keyword">return</span> getExistingOrderResult(request.getUserId(), request.getSubmitToken());
        }
        
        <span class="hljs-comment">// 3. 分布式锁（防并发）</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> acquireOrderLock(request.getUserId(), request.getProductId());
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 4. 库存检查等业务校验</span>
            checkInventory(request.getProductId(), request.getQuantity());
            
            <span class="hljs-comment">// 5. 创建订单（依赖数据库唯一约束）</span>
            <span class="hljs-keyword">return</span> createOrderInTransaction(request);
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-19">8.2 秒杀订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 秒杀订单需要更极致的优化</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlashSaleOrderService</span> {
    
    <span class="hljs-comment">// 秒杀方案：异步处理 + 库存预扣 + 最终一致性</span>
    <span class="hljs-keyword">public</span> FlashSaleSubmitResult <span class="hljs-title function_">submitFlashSaleOrder</span><span class="hljs-params">(FlashSaleRequest request)</span> {
        <span class="hljs-comment">// 1. 验证用户资格和活动状态（缓存中检查）</span>
        <span class="hljs-keyword">if</span> (!checkUserQualification(request.getUserId(), request.getActivityId())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"您不具备参与资格"</span>);
        }
        
        <span class="hljs-comment">// 2. 预扣库存（Redis原子操作）</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">stockDeducted</span> <span class="hljs-operator">=</span> preDeductStock(
            request.getActivityId(), 
            request.getProductId(), 
            request.getUserId()
        );
        
        <span class="hljs-keyword">if</span> (!stockDeducted) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"库存不足"</span>);
        }
        
        <span class="hljs-comment">// 3. 生成唯一请求ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> generateRequestId(request.getUserId(), request.getActivityId());
        
        <span class="hljs-comment">// 4. 发送到消息队列（快速返回）</span>
        sendToMQ(request, requestId);
        
        <span class="hljs-comment">// 5. 立即返回</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlashSaleSubmitResult</span>(requestId, <span class="hljs-string">"秒杀请求已接受，处理中"</span>);
    }
    
    <span class="hljs-comment">// 消费者异步创建订单</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFlashSaleOrder</span><span class="hljs-params">(FlashSaleRequest request, String requestId)</span> {
        <span class="hljs-comment">// 这里只需要处理真正的订单创建</span>
        <span class="hljs-comment">// 因为库存已在Redis中预扣，只需保证最终一致性</span>
        <span class="hljs-keyword">try</span> {
            createOrder(request, requestId);
            <span class="hljs-comment">// 同步库存到数据库</span>
            syncStockToDB(request.getProductId(), request.getActivityId());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 失败时回滚Redis库存</span>
            rollbackStockInRedis(request.getActivityId(), request.getProductId(), request.getUserId());
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h2 data-id="heading-20">10 总结</h2>
<p>防止重复提交订单是一个系统工程，需要从前到后、多层次的防护。</p>
<p>让我们回顾一下关键点：</p>
<ol>
<li><strong>前端防护是体验，不是保障</strong>：按钮防抖、请求拦截能改善用户体验，但不能作为唯一防线。</li>
<li><strong>幂等性是核心理念</strong>：无论是Token方案还是业务唯一标识，都要保证同一操作执行多次的结果一致。</li>
<li><strong>分布式锁解决并发问题</strong>：在分布式环境下，防止多个实例同时处理同一请求。</li>
<li><strong>数据库是最后防线</strong>：唯一约束、乐观锁等机制能在应用层防护失效时保证数据一致性。</li>
<li><strong>异步处理提升吞吐</strong>：对于高并发场景，将同步请求转为异步处理，提高系统整体吞吐量。</li>
<li><strong>监控告警必不可少</strong>：没有监控的系统就像没有仪表的飞机，无法发现问题和优化性能。</li>
</ol>
<p>在实际架构设计中，我通常建议采用 <strong>"前端防抖 + 网关限流 + Token幂等 + 分布式锁 + 数据库唯一约束"</strong> 的综合方案，对于秒杀等极致场景再加入异步处理。</p>
<p>有些小伙伴可能会觉得这些防护措施太复杂，影响开发效率。</p>
<p>但请记住：<strong>预防的成本远低于修复的成本</strong>。</p>
<p>一次重复提交导致的资损事故，可能就需要整个团队加班数周来修复数据和安抚用户。</p>
<p>技术方案没有银弹，只有最适合业务场景的平衡。</p>
<h2 data-id="heading-21">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p>
<p>更多项目实战在我的技术网站：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.susan.net.cn%2Fproject" title="https://link.juejin.cn?target=http%3A%2F%2Fwww.susan.net.cn%2Fproject" target="_blank">www.susan.net.cn/project</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则表达式在 Scala 中的应用]]></title>    <link>https://juejin.cn/post/7586559672129011764</link>    <guid>https://juejin.cn/post/7586559672129011764</guid>    <pubDate>2025-12-23T00:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129011764" data-draft-id="7586559672128978996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则表达式在 Scala 中的应用"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-23T00:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码于老总"/> <meta itemprop="url" content="https://juejin.cn/user/582105100725436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则表达式在 Scala 中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/582105100725436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码于老总
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:44:20.000Z" title="Tue Dec 23 2025 00:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～今天来聊个<strong>通用又实用</strong>的技能：正则表达式在 Scala 中的应用。不管你是处理日志、校验手机号，还是提取字符串里的特定内容，正则都是绕不开的 “效率神器”。</p>
<h2 data-id="heading-0">一、先搞懂：正则到底是个啥？</h2>
<p>很多朋友觉得正则 “难学”，其实核心就一句话：<strong>正则是一套独立于编程语言的 “字符串规则语言”</strong>  —— 不管你用 Scala、Java 还是 Python，只要是写<code>\d</code>就代表匹配数字，写<code>{11}</code>就代表重复 11 次，规则是通用的。</p>
<p>它主要用来干两件事：</p>
<ul>
<li><strong>查找</strong>：从大字符串里揪出符合规则的子串（比如从一段文字里找手机号）</li>
<li><strong>匹配</strong>：验证整个字符串是否符合规则（比如检查输入的是不是合法手机号）</li>
</ul>
<h2 data-id="heading-1">二、实战：用 Scala 找字符串里的 11 位数字</h2>
<p>直接上代码（这是我写的一个 “提取 11 位数字” 的示例），咱们边看边拆：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/*
* 1、处理字符串
* 2、查找：在大字符串里找符合规则的子串
* 3、匹配：验证字符串是否满足规则
* 划重点：正则是通用技术，和编程语言无关！
*/</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg01</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 定义正则规则：匹配11位连续数字</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"\d{11}"</span>.r  
    
    <span class="hljs-comment">// 2. 准备要处理的目标字符串</span>
    <span class="hljs-keyword">val</span> target = <span class="hljs-string">"I like 我喜欢 数13347589473!"</span>
    
    <span class="hljs-comment">// 3. 查找并输出结果</span>
    println(<span class="hljs-string">"找到的11位数字是："</span>)
    reg.findAllIn(target).foreach(println)
  }
}
</code></pre>
<h3 data-id="heading-2">代码拆解：3 步搞定正则匹配</h3>
<h4 data-id="heading-3">1. 定义正则规则：<code>val reg = "\d{11}".r</code></h4>
<p>这里有两个关键点：</p>
<ul>
<li><code>\d{11}</code>：这是<strong>正则语法</strong>——<code>\d</code>代表 “一个数字”（Scala 里要写两个反斜杠<code>\</code>做转义），<code>{11}</code>代表 “连续出现 11 次”，合起来就是 “匹配 11 位连续数字”；</li>
<li><code>.r</code>：这是 Scala 的 “小魔法”—— 把普通字符串转成<code>Regex</code>对象，只有转成这个对象，才能调用正则的专属方法。</li>
</ul>
<h4 data-id="heading-4">2. 准备目标字符串：<code>val target = "I like 我喜欢 数13347589473!"</code></h4>
<p>就是咱们要处理的原始内容，里面混了英文、中文和数字，我们要把 11 位的数字 “揪” 出来。</p>
<h4 data-id="heading-5">3. 执行查找：<code>reg.findAllIn(target).foreach(println)</code></h4>
<ul>
<li><code>findAllIn(target)</code>：<code>Regex</code>对象的核心方法，作用是<strong>把目标字符串里所有符合规则的子串都找出来</strong>，返回一个可迭代的集合；</li>
<li><code>foreach(println)</code>：遍历集合，把找到的结果打印出来。</li>
</ul>
<h3 data-id="heading-6">运行结果</h3>
<p>执行代码后，控制台会直接输出：</p>
<pre><code class="hljs">找到的11位数字是：
13347589473
</code></pre>
<h2 data-id="heading-7">三、进阶：正则在 Scala 里的常用玩法</h2>
<p>光 “查找” 还不够，正则还有很多实用操作，这里补充 3 个高频场景：</p>
<h3 data-id="heading-8">1. 只找第一个匹配的内容</h3>
<p>用<code>findFirstIn</code>方法，适合只需要 “第一个结果” 的场景：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 找第一个11位数字</span>
<span class="hljs-keyword">val</span> firstNum = reg.findFirstIn(target)
firstNum.foreach(res =&gt; println(<span class="hljs-string">s"第一个匹配结果：<span class="hljs-subst">$res</span>"</span>))
</code></pre>
<p>输出：<code>第一个匹配结果：13347589473</code></p>
<h3 data-id="heading-9">2. 验证整个字符串是否符合规则</h3>
<p>用<code>matches</code>方法，比如验证 “输入的是不是纯 11 位数字”：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">val</span> phone1 = <span class="hljs-string">"13347589473"</span>  <span class="hljs-comment">// 合法</span>
<span class="hljs-keyword">val</span> phone2 = <span class="hljs-string">"13347589473abc"</span>  <span class="hljs-comment">// 不合法</span>
println(phone1.matches(<span class="hljs-string">"\d{11}"</span>))  <span class="hljs-comment">// 输出：true</span>
println(phone2.matches(<span class="hljs-string">"\d{11}"</span>))  <span class="hljs-comment">// 输出：false</span>
</code></pre>
<h3 data-id="heading-10">3. 替换匹配的内容</h3>
<p>用<code>replaceAllIn</code>方法，把找到的内容替换成其他字符：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 把11位数字替换成****脱敏</span>
<span class="hljs-keyword">val</span> desensitized = reg.replaceAllIn(target, <span class="hljs-string">"****"</span>)
println(desensitized)  <span class="hljs-comment">// 输出：I like 我喜欢 数****!</span>
</code></pre>
<h2 data-id="heading-11">四、最后总结：正则的 “通用 + 高效”</h2>
<ol>
<li><strong>规则通用</strong>：正则语法是跨语言的，学会<code>\d</code>、<code>{n}</code>、<code>\w</code>这些基础语法，换任何语言都能用；</li>
<li><strong>Scala 调用流程固定</strong>：定义规则（字符串 +.r）→ 调用方法（findAllIn/matches 等）→ 处理结果；</li>
<li><strong>场景广泛</strong>：日志解析、表单校验、数据清洗…… 只要涉及字符串处理，正则都是 “偷懒神器”。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失]]></title>    <link>https://juejin.cn/post/7586505172815888435</link>    <guid>https://juejin.cn/post/7586505172815888435</guid>    <pubDate>2025-12-23T00:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815888435" data-draft-id="7584266920640528435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-23T00:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:36.000Z" title="Tue Dec 23 2025 00:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个基于 Java 的微服务应用中，使用 <code>CompletableFuture</code> 来处理异步任务，以提高系统的并发性能。例如，在处理用户注册流程时，会异步调用多个服务进行数据校验、生成账号等操作。然而，在实际运行过程中，发现当某个异步任务出现异常时，没有得到正确的处理，导致整个注册流程看似正常完成，但实际上部分关键数据没有正确生成，影响了业务的正常进行。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">异步任务类（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟可能出现异常的操作</span>
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-3">测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        CompletableFuture&lt;String&gt; future = AsyncTaskExample.performAsyncTask();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
            System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：当异步任务出现异常时，能够及时捕获并处理异常，确保业务流程的正确性和完整性。例如，在用户注册场景中，如果某个异步校验或生成操作失败，应该回滚整个注册流程，并向用户返回错误信息。</li>
<li><strong>实际行为</strong>：在上述代码中，虽然 <code>CompletableFuture</code> 中的任务可能抛出异常，但在调用 <code>future.get()</code> 时，异常被 <code>ExecutionException</code> 包装，并且在 <code>main</code> 方法中只是简单地打印了堆栈信息。这使得业务层无法对具体的异常进行针对性处理，导致即使异步任务失败，程序也可能继续执行后续逻辑，就好像任务成功完成一样，从而丢失了正确的结果，影响业务功能。此外，异常被 “吞噬” 在 <code>ExecutionException</code> 中，没有被清晰地传递和处理，增加了调试和维护的难度。</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>使用 <code>exceptionally</code> 方法处理异常</strong>：<code>CompletableFuture</code> 提供了 <code>exceptionally</code> 方法，可在异步任务出现异常时，返回一个默认值或执行一些替代操作。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).exceptionally(ex -&gt; {
            System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务失败，返回默认值"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-6">修改后的测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        CompletableFuture&lt;String&gt; future = AsyncTaskExample.performAsyncTask();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.join();
        System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
    }
}
</code></pre>
<ol start="2">
<li><strong>使用 <code>whenComplete</code> 方法</strong>：<code>whenComplete</code> 方法可以在任务完成（无论是正常完成还是异常完成）时执行回调函数，在回调函数中可以根据任务状态进行相应处理。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).whenComplete((result, ex) -&gt; {
            <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
                System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-7">结合 <code>handle</code> 方法获取结果或处理异常</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).handle((result, ex) -&gt; {
            <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
                System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
                <span class="hljs-keyword">return</span> <span class="hljs-string">"任务失败，返回默认值"</span>;
            }
            <span class="hljs-keyword">return</span> result;
        });
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF中的IValueConverter接口（值转换器）]]></title>    <link>https://juejin.cn/post/7586559672129093684</link>    <guid>https://juejin.cn/post/7586559672129093684</guid>    <pubDate>2025-12-23T01:09:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129093684" data-draft-id="7586498198149611571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF中的IValueConverter接口（值转换器）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T01:09:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="seekCat"/> <meta itemprop="url" content="https://juejin.cn/user/925121393197673"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF中的IValueConverter接口（值转换器）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/925121393197673/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    seekCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:09:18.000Z" title="Tue Dec 23 2025 01:09:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.IValueConverter 是什么？解决什么问题？</h3>
<h4 data-id="heading-1">1.1 定义</h4>
<p>IValueConverter是WPF中用于数据绑定时进行值转换的接口。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">namespace</span> <span class="hljs-title">System.Windows.Data</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IValueConverter</span>{
        <span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">Convert</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
        <span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
    }
}
</code></pre>
<p>当需要调用时，实现该接口并重写Convert和ConvertBack，以下分别叙述这两个方法的用途</p>
<h4 data-id="heading-2">1.2 核心作用</h4>
<p>当ViewModle中的数据类型，不能直接用View展示，即ViewModel与View对应的数据类型不一致时，需要使用该接口进行数据类型转换，IValueConverter起到了“翻译官”的角色。</p>
<h3 data-id="heading-3">2.为什么要使用值转换器？</h3>
<p>在 MVVM 模式中：</p>
<ul>
<li>ViewModel 只暴露 <strong>业务含义的数据</strong></li>
<li>View 需要 <strong>UI 能理解的类型</strong></li>
</ul>
<p>典型示例：</p>





















<table><thead><tr><th>ViewModel数据</th><th>View</th></tr></thead><tbody><tr><td>bool</td><td>Visibility</td></tr><tr><td>enum</td><td>Style</td></tr><tr><td>DataTime</td><td>string</td></tr></tbody></table>
<p>为了解决这样的类型不匹配，需要使用值转换器</p>
<h3 data-id="heading-4">3.IValueConverter 的生命周期与执行时机</h3>
<h4 data-id="heading-5">3.1 执行时机</h4>
<p>IValueConverter的实现类对象会在以下情况被调用</p>
<ul>
<li>绑定源属性首次赋值</li>
<li>绑定源属性发生变化（INotifyPropertyChanged）</li>
<li>绑定目标需要重新计算显示值</li>
</ul>
<h4 data-id="heading-6">3.2 执行方向</h4>
<p>ViewModel -&gt; View 调用Convert方法 <br/>
View -&gt; ViewModel 调用ConvertBack方法</p>
<h3 data-id="heading-7">4.Convert 与 ConvertBack 的职责划分</h3>
<h4 data-id="heading-8">4.1 Convert</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">Convert</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType,<span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
</code></pre>

























<table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>value</td><td>当前传递的值，在Concert中来自ViewModel</td></tr><tr><td>targetType</td><td>目标属性类型</td></tr><tr><td>parameter</td><td>XAML传入的附加参数</td></tr><tr><td>culture</td><td>区域信息</td></tr></tbody></table>
<h4 data-id="heading-9">4.2CovertBack</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
</code></pre>

























<table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>value</td><td>当前传递的值，来自View</td></tr><tr><td>targetType</td><td>目标属性类型</td></tr><tr><td>parameter</td><td>XAML传入的附加参数</td></tr><tr><td>culture</td><td>区域信息</td></tr></tbody></table>
<p>一般不具体实现</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>{
    Binding.DoNothing;
}
</code></pre>
<p>在以下两种情况需要具体实现</p>
<ul>
<li>Mode=TwoWay</li>
</ul>
<pre><code class="hljs language-XAML" lang="XAML">{Binding Path=... Mode=TwoWay}
</code></pre>
<ul>
<li>View需要回写到ViewModel中</li>
</ul>
<h3 data-id="heading-10">5.具体实例</h3>
<p>需要实现导航栏按钮被按下后，样式改变以提醒用户界面切换，为了完成该需求，可以在ViewModel中维护一个枚举属性来记录当前的访问界面</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">//枚举</span>
```
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> MainWindowMenuItem
{
    Menu1,
    Menu2,
    Menu3,
    Menu4,
    Menu5,
    Menu6,
    Menu7,
    Menu8,
    Menu9
}
```

<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MainWindowViewModel</span> : <span class="hljs-title">ObservableObject</span>
{
    ...Other...
    [<span class="hljs-meta">ObservableProperty</span>] <span class="hljs-keyword">private</span> MainWindowMenuItem _selectedMenuItem = MainWindowMenuItem.Menu1;
    ...Other...
}
</code></pre>
<pre><code class="hljs language-XAML" lang="XAML">&lt;Button
    Style="{Binding SelectedMenuItem,Converter={StaticResource MenuConverter},ConverterParameter={x:Static local:MainWindowMenuItem.Menu1}}"
    Command="{Binding SelectMenuCommand}"
    CommandParameter="{x:Static local:MainWindowMenuItem.Menu1}"&gt;
    &lt;Button.Content&gt;
        ...
    &lt;/Button.Content&gt;
&lt;/Button&gt;
</code></pre>
<p>可以看到这个按钮绑定了一个传入枚举的命令，当点击它的时候，他会修改ViewModel中的SelectedMenuItem属性，当该属性被修改时，会把对应的枚举值交给值转换器，然后对比按钮上的parameter，将被点击的按钮的样式修改为SelectedButtonStyle。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MenuConverter</span>:<span class="hljs-title">IValueConverter</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span>? Convert(<span class="hljs-built_in">object</span>? <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span>? parameter, CultureInfo culture)
    {
        <span class="hljs-keyword">var</span> normal = (Style)Application.Current.Resources[<span class="hljs-string">"NormalButtonStyle"</span>];
        <span class="hljs-keyword">var</span> selected = (Style)Application.Current.Resources[<span class="hljs-string">"SelectedButtonStyle"</span>];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> == <span class="hljs-literal">null</span> || parameter == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> normal;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>.Equals(parameter) ? selected : normal;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span>? ConvertBack(<span class="hljs-built_in">object</span>? <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span>? parameter, CultureInfo culture)
    {
        <span class="hljs-keyword">return</span> Binding.DoNothing;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 中的 term的查询]]></title>    <link>https://juejin.cn/post/7586582977707933738</link>    <guid>https://juejin.cn/post/7586582977707933738</guid>    <pubDate>2025-12-23T02:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977707933738" data-draft-id="7586585688004345897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 中的 term的查询"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T02:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个大专生的淘汰之路"/> <meta itemprop="url" content="https://juejin.cn/user/1327865775796807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 中的 term的查询
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1327865775796807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个大专生的淘汰之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:13:02.000Z" title="Tue Dec 23 2025 02:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Elasticsearch 中的 term 查询详解（附常见踩坑点）</h2>
<p>在使用 Elasticsearch 进行搜索时，<code>term</code> 查询是一个<strong>非常基础但又非常容易被误用</strong>的查询方式。很多人会疑惑：</p>
<ul>
<li>为什么 <code>term</code> 查不出来数据？</li>
<li><code>term</code> 和 <code>match</code> 到底有什么区别？</li>
<li>什么字段适合用 <code>term</code>？</li>
</ul>
<p>本文将围绕这些问题，系统讲清 <strong><code>term</code> 查询的原理、使用场景和常见坑点</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、什么是 term 查询？</h3>
<p><code>term</code> 查询属于 <strong>精确匹配（Exact Match）查询</strong>。</p>
<blockquote>
<p>它不会对查询条件做分词、分析处理，而是直接拿你给的值，去倒排索引里做精确匹配。</p>
</blockquote>
<p>官方一句话总结：</p>
<blockquote>
<p><strong>term query finds documents that contain the exact term specified in the inverted index</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、term 查询的基本用法</h3>
<h4 data-id="heading-3">1️⃣ 基本示例</h4>
<p>假设我们有如下文档：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1001</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SUCCESS"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对应的查询：</p>
<pre><code class="hljs language-bash" lang="bash">GET test_index/_search
{
  <span class="hljs-string">"query"</span>: {
    <span class="hljs-string">"term"</span>: {
      <span class="hljs-string">"status"</span>: {
        <span class="hljs-string">"value"</span>: <span class="hljs-string">"SUCCESS"</span>
      }
    }
  }
}
</code></pre>
<p>如果 <code>status</code> 字段在索引中是 <strong>未分词字段（keyword）</strong> ，那么这条查询是可以正常命中的。</p>
<hr/>
<h4 data-id="heading-4">2️⃣ 简写形式</h4>
<pre><code class="hljs language-bash" lang="bash">GET test_index/_search
{
  <span class="hljs-string">"query"</span>: {
    <span class="hljs-string">"term"</span>: {
      <span class="hljs-string">"status"</span>: <span class="hljs-string">"SUCCESS"</span>
    }
  }
}
</code></pre>
<p>效果与上面完全一致。</p>
<hr/>
<h3 data-id="heading-5">三、term 查询的核心特性</h3>
<h4 data-id="heading-6">✅ 1. 不会分词</h4>
<p>这是 <strong>最重要的一点</strong>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>Elasticsearch <strong>不会</strong>把“张三”拆成“张”“三”</li>
<li>只会匹配索引中 <strong>完全等于“张三”</strong> 的 term</li>
</ul>
<hr/>
<h4 data-id="heading-7">✅ 2. 区分大小写（取决于字段）</h4>
<p>例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span>
</code></pre>
<p>如果你用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SUCCESS"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>➡ <strong>可能查不到结果</strong></p>
<p>是否区分大小写，<strong>取决于字段是否经过 analyzer 处理</strong>。</p>
<hr/>
<h3 data-id="heading-8">四、term 查询最容易踩的坑 ⚠️</h3>
<h4 data-id="heading-9">❌ 1. 对 text 字段使用 term 查询</h4>
<p>这是新手最常犯的错误。</p>
<h5 data-id="heading-10">示例字段映射：</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>索引内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch is powerful"</span>
</code></pre>
<p>你用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>➡ <strong>大概率查不到数据</strong></p>
<h5 data-id="heading-11">原因是：</h5>
<ul>
<li><code>text</code> 类型字段在写入时已经被 <strong>分词</strong></li>
<li>倒排索引中存的是 <code>elasticsearch</code>、<code>is</code>、<code>powerful</code></li>
<li>而你用 <code>term</code> 查的是<strong>原始字符串</strong></li>
</ul>
<hr/>
<h4 data-id="heading-12">✅ 正确做法 1：使用 <code>.keyword</code> 字段</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message.keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch is powerful"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-13">✅ 正确做法 2：改用 match 查询</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">❌ 2. term 查询不适合“模糊搜索”</h4>
<p>例如你想查：</p>
<ul>
<li>包含某个词</li>
<li>类似 SQL 的 <code>like</code></li>
</ul>
<p>❌ <strong>term 做不了</strong></p>
<p>应该用：</p>
<ul>
<li><code>match</code></li>
<li><code>match_phrase</code></li>
<li><code>wildcard</code></li>
<li><code>regexp</code></li>
</ul>
<hr/>
<h3 data-id="heading-15">五、什么场景适合用 term 查询？</h3>
<h4 data-id="heading-16">✅ 非常适合的场景</h4>

































<table><thead><tr><th>场景</th><th>是否适合</th></tr></thead><tbody><tr><td>状态码（status）</td><td>✅</td></tr><tr><td>枚举值</td><td>✅</td></tr><tr><td>用户ID</td><td>✅</td></tr><tr><td>订单号</td><td>✅</td></tr><tr><td>是否删除（is_deleted）</td><td>✅</td></tr><tr><td>精确标签</td><td>✅</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">"term":</span> {
  <span class="hljs-attr">"userId":</span> <span class="hljs-number">1001</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-17">❌ 不适合的场景</h4>





















<table><thead><tr><th>场景</th><th>原因</th></tr></thead><tbody><tr><td>文章标题</td><td>需要分词</td></tr><tr><td>描述信息</td><td>需要全文搜索</td></tr><tr><td>模糊匹配</td><td>term 不支持</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">六、term vs match，对比总结</h3>






























<table><thead><tr><th>对比项</th><th>term</th><th>match</th></tr></thead><tbody><tr><td>是否分词</td><td>❌ 不分词</td><td>✅ 分词</td></tr><tr><td>是否精确匹配</td><td>✅</td><td>❌</td></tr><tr><td>适合字段类型</td><td>keyword / 数值</td><td>text</td></tr><tr><td>使用难度</td><td>易踩坑</td><td>更友好</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>term 用于“确定你知道索引里长什么样”的场景，match 用于“我想搜这段话”的场景。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-19">七、生产环境中的最佳实践 ⭐</h3>
<p>1️⃣ <strong>明确字段类型</strong></p>
<ul>
<li>精确查询 → <code>keyword</code></li>
<li>搜索文本 → <code>text</code></li>
</ul>
<p>2️⃣ <strong>term 查询只用在确定值上</strong></p>
<ul>
<li>状态、ID、枚举</li>
</ul>
<p>3️⃣ <strong>查不到结果时，先看 mapping</strong></p>
<pre><code class="hljs language-bash" lang="bash">GET index_name/_mapping
</code></pre>
<hr/>
<h3 data-id="heading-20">八、结语</h3>
<p><code>term</code> 查询本身并不复杂，但<strong>复杂的是它对字段类型和索引结构的要求</strong>。</p>
<p>很多“ES 查不出数据”的问题，根本原因只有一句话：</p>
<blockquote>
<p><strong>你以为你在查值，其实你在查分词后的 term。</strong></p>
</blockquote>
<p>如果你能真正理解这一点，<code>term</code> 查询就再也不会踩坑了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React哲学：保持组件纯粹 哈气就要哈得纯粹]]></title>    <link>https://juejin.cn/post/7586518130761416744</link>    <guid>https://juejin.cn/post/7586518130761416744</guid>    <pubDate>2025-12-22T16:29:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586518130761416744" data-draft-id="7585850609015963663" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React哲学：保持组件纯粹  哈气就要哈得纯粹"/> <meta itemprop="keywords" content="前端,React.js,设计"/> <meta itemprop="datePublished" content="2025-12-22T16:29:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若倾"/> <meta itemprop="url" content="https://juejin.cn/user/3270387091383163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React哲学：保持组件纯粹  哈气就要哈得纯粹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3270387091383163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若倾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:29:59.000Z" title="Mon Dec 22 2025 16:29:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="ascetic">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#888}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#ccc}.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">纯粹函数的设计理念</h2>
<h3 data-id="heading-1">什么是纯粹函数</h3>
<blockquote>
<p>纯粹函数的两大核心条件</p>
</blockquote>
<p>条件1： 函数不修改被调用前就存在的变量与对象，只做纯粹的运算。</p>
<p>条件2： 保证函数相同的输入，就会有相同输出。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//定义一个外部变量</span>
<span class="hljs-keyword">let</span>  num=<span class="hljs-number">0</span>;

<span class="hljs-comment">//纯粹函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x</span>)
{<span class="hljs-comment">//满足两大核心条件</span>
 <span class="hljs-comment">//条件1：不修改函数外的任何变量</span>
 <span class="hljs-comment">//条件2： 输入 x 固定，则输出必然是 x+1 </span>
    <span class="hljs-keyword">return</span> x+<span class="hljs-number">1</span>;
}

<span class="hljs-comment">//调用纯粹函数，传入外部的num</span>
<span class="hljs-keyword">let</span> a=<span class="hljs-title function_">add</span>(num);
<span class="hljs-keyword">let</span> b=<span class="hljs-title function_">add</span>(num)

<span class="hljs-comment">// num并未被修改，两次输入相同，得到的结果也相同</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num,a) <span class="hljs-comment">// 输出0 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num,b) <span class="hljs-comment">// 输出0 1</span>
</code></pre>
<h2 data-id="heading-2">纯粹组件：React哲学</h2>
<h3 data-id="heading-3">什么是纯粹的组件</h3>
<blockquote>
<p>纯粹组件的两大核心条件</p>
</blockquote>
<p>react模仿纯粹函数的设计理念，提出纯粹组件的设计理念同样需要满足两个核心条件：</p>
<p>条件1：不修改组件渲染前存在的对象与变量。</p>
<p>条件2：相同的输出，返回相同的jsx</p>
<blockquote>
<p>反例：什么样的组件不纯粹</p>
</blockquote>
<p>条件1：组件内部对外部依赖值进行更改</p>
<p>条件2：多次渲染组件时输入相同，但是返回到jsx却不同</p>
<p>如果满足上诉两个任意一个条件，那么这个组件将不纯粹</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-comment">//定义一个外部变量</span>
<span class="hljs-keyword">let</span> num=<span class="hljs-number">0</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>){
<span class="hljs-comment">// 组件修改外部依赖值</span>
<span class="hljs-comment">// 导致相同的输入下，每次返回的</span>
  num++;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{num}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc27263d0e144a07809a07bef692c4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5YC-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767025967&amp;x-signature=%2Fe02kHgsWmvUAgjLRKA4ISQcoHA%3D" alt="8aabb038e73721ff973ca11dd32f127e.png" loading="lazy"/></p>
<h3 data-id="heading-4">为什么需要保持组件纯粹</h3>
<ol>
<li>保证组件渲染的独立性</li>
</ol>
<blockquote>
<p>所谓独立性：</p>
</blockquote>
<p>如果组件渲染时修改了外部预先存在的变量会导致：</p>
<ul>
<li>
<p>后续依赖这些变量与对象的组件渲染产生不确定性，这就导致依赖同一变量的组件需要保证渲染的顺序。</p>
</li>
<li>
<p>但是组件在浏览器中的渲染时机是不确定的。如果组件渲染结果，依赖组件间渲染的顺序。就会导致既定逻辑失效，从而产生错误。</p>
</li>
</ul>
<p>所以我们要排除这种不确定性，使得react组件使用更加安全，让组件渲染之间的渲染逻辑更加独立</p>
<ol start="2">
<li>保证组件渲染的确定性</li>
</ol>
<blockquote>
<p>所谓确定性</p>
</blockquote>
<p>确定性建立在独立性之上</p>
<ul>
<li>当组件渲染时独立地不影响外部组件的渲染逻辑，由此保证组件外部组件渲染的确定性，能够预先避免许多错误</li>
</ul>
<ol start="3">
<li>没有保持纯粹性的反面案例</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 全局变量（外部状态）</span>
<span class="hljs-keyword">let</span> globalCount = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 组件A：渲染时修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"/>) {
  globalCount += <span class="hljs-number">1</span>; <span class="hljs-comment">// 修改外部变量</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件A：{globalCount}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 组件B：依赖同一个外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件B：{globalCount * 2}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件：同时渲染A和B</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>理想顺序（A先渲染，B后渲染）：globalCount 先变成 1，B渲染2 → 结果:A=1,B=2；</li>
<li>实际可能的顺序（React调度导致B先渲染）：B先读取 globalCount=0渲染0，再A把 globalCount 改成 1→结果：A=1，B=0；</li>
</ul>
<h2 data-id="heading-5">保持纯粹  !=   不可修改</h2>
<h3 data-id="heading-6">局部突变</h3>
<ol>
<li>什么是局部突变</li>
</ol>
<blockquote>
<p>在react官方文档中的定义其实是“局部mutation”，即在渲染时修改组件内部“刚刚创建对象或者变量”。</p>
</blockquote>
<ul>
<li>这样的局部突变不会影响外部组件的渲染逻辑，只影响组件内部的逻辑。</li>
</ul>
<ol start="2">
<li>利用局部突变保持组件的纯粹性</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 全局变量（外部状态）</span>
<span class="hljs-keyword">let</span> globalCount = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 组件A：渲染时不修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Count</span>=globalCount+<span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件A：{Count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 组件B：依赖同一个外部变量，但是不直接修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Count</span>=(globalCount+<span class="hljs-number">1</span>)*<span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件B：{Count * 2}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件：同时渲染A和B</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span> 
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>无论A，B谁先渲染，都改变不了渲染结果：A=1，B=2</li>
<li>最终使组件重新保持“纯粹”</li>
</ul>
<h3 data-id="heading-7">用“更新” 替换 “修改”</h3>
<blockquote>
<p>使用“状态”管理变量</p>
</blockquote>
<ul>
<li>为了保证组件的纯粹性，并不意味着组件渲染依赖的外部变量完全就不能改变了。可以通过“状态”来管理外部变量。</li>
</ul>
<blockquote>
<p>“状态”管理变量的好处</p>
</blockquote>
<ul>
<li>当变量需要被修改时，不再直接对其进行变更。而是等待组件渲染完成后，更新并将修改值传入组件中。由此保持组件渲染时的独立性与确定性</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 显示购物车数量的组件（纯粹组件：只依赖 props，无任何副作用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PureCartCount</span>(<span class="hljs-params">{ count }</span>) {
  <span class="hljs-comment">// 只读取 props，不修改任何外部数据，相同 props 必然渲染相同结果</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>购物车数量：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 控制数量增减的组件（不直接修改数据，只发起更新请求）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PureCountControls</span>(<span class="hljs-params">{ onAdd, onSubtract }</span>) {
  <span class="hljs-comment">// 不触碰任何变量，只通过父组件传入的函数发起“更新请求”</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubtract}</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAdd}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：用状态管理变量，统一控制更新逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 useState 管理购物车数量（状态由 React 管控，初始值 1）</span>
  <span class="hljs-keyword">const</span> [cartCount, setCartCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);

  <span class="hljs-comment">// 数量“更新”逻辑：生成新值，不修改原状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAdd</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 关键：不直接改 cartCount（如 cartCount +=1），而是通过 setCartCount 生成新值</span>
    <span class="hljs-title function_">setCartCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubtract</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 生成新值（原 cartCount 保持不变，直到 React 触发重新渲染）</span>
    <span class="hljs-title function_">setCartCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, prevCount - <span class="hljs-number">1</span>)); <span class="hljs-comment">// 避免数量小于 1</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 新状态通过 props 传入纯粹组件，组件只“读”不“写” */}
      <span class="hljs-tag">&lt;<span class="hljs-name">PureCartCount</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{cartCount}</span> /&gt;</span>
      {/* 传递更新函数，让子组件发起更新请求 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">PureCountControls</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{handleAdd}</span> <span class="hljs-attr">onSubtract</span>=<span class="hljs-string">{handleSubtract}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>; 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从入门到实践：玩转分布式链路追踪利器SkyWalking]]></title>    <link>https://juejin.cn/post/7586569284551393320</link>    <guid>https://juejin.cn/post/7586569284551393320</guid>    <pubDate>2025-12-23T02:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551393320" data-draft-id="7586569284551327784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从入门到实践：玩转分布式链路追踪利器SkyWalking"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2025-12-23T02:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shepherd"/> <meta itemprop="url" content="https://juejin.cn/user/3415500769991869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从入门到实践：玩转分布式链路追踪利器SkyWalking
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3415500769991869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shepherd
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:26:44.000Z" title="Tue Dec 23 2025 02:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.概述</h2>
<p>在当今微服务架构盛行的时代，一个看似简单的前端请求，背后往往涉及数十个甚至上百个服务的协同调用。当系统出现性能问题或异常时，仅靠传统日志监控往往如同“大海捞针”，难以迅速定位问题根源。</p>
<p>正是在这样的背景下，<strong>SkyWalking</strong> —— 一款优秀的国产开源分布式链路追踪与性能监控系统应运而生。该项目最初由吴晟（华为开发者）个人开源，于2017年进入Apache孵化器，并最终成为Apache顶级项目。截至目前，SkyWalking在GitHub上已收获超过25k的Star，足以证明其强大的影响力和广泛的应用前景</p>
<h3 data-id="heading-1">1.1 SkyWalking 是什么？</h3>
<p>SkyWalking 是一个开源的可观测性平台，用于从服务、云原生基础设施中收集、分析、聚合和可视化数据。它提供了清晰的分布式系统观测能力，并支持跨云、跨集群的统一监控。作为现代化的应用性能监控（APM）系统，SkyWalking 尤其适合云原生和基于容器的微服务架构。</p>
<h4 data-id="heading-2">核心优势：</h4>
<ul>
<li><strong>无侵入探针</strong>：通过Java Agent字节码增强实现监控，无需修改业务代码</li>
<li><strong>高性能通信</strong>：采用gRPC进行数据传输，效率高、延迟低</li>
<li><strong>功能全面</strong>：支持链路追踪、JVM监控、服务依赖分析、告警等</li>
<li><strong>生态友好</strong>：完美支持Spring Cloud、Spring Boot等主流微服务框架</li>
</ul>
<h4 data-id="heading-3">典型应用场景：</h4>
<ol start="0">
<li><strong>性能瓶颈诊断</strong>：快速定位慢查询、高延迟接口</li>
<li><strong>全链路追踪</strong>：可视化展示请求在微服务间的完整调用路径</li>
<li><strong>服务依赖分析</strong>：自动绘制服务拓扑，识别关键依赖与瓶颈点</li>
<li><strong>异常根因定位</strong>：结合链路、指标与日志，迅速定位故障源头</li>
<li><strong>容量规划参考</strong>：基于历史性能数据进行资源预测与扩容决策</li>
</ol>
<h3 data-id="heading-4">1.2 主流链路追踪框架对比</h3>
<p>随着微服务架构的普及，分布式链路追踪技术也日趋成熟，目前主流的开源方案包括：</p>
<ul>
<li><strong>Spring Cloud Sleuth + Zipkin</strong>：需代码埋点，侵入性强</li>
<li><strong>大众点评 Cat</strong>：同样需要侵入式埋点，接入成本较高</li>
<li><strong>Pinpoint</strong>：韩国团队开发，同样基于字节码增强，无侵入</li>
<li><strong>SkyWalking</strong>：国产开源，无侵入、性能好、社区活跃</li>
</ul>
<p>SkyWalking 与 Pinpoint 均通过字节码注入实现监控，对业务代码零侵入，是目前企业级APM系统的优选方案。对于国内开发者而言，SkyWalking 具有中文文档丰富、社区响应快、与国内技术栈整合度高等优势，更值得推荐。</p>
<h2 data-id="heading-5">2.SkyWalking 架构与原理</h2>
<p>SkyWalking 核心架构组件逻辑上分为四部分: 探针(Agent)、 平台后端(OAP)，存储(Storage)和用户界面(UI)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca0b92da986436cab298ce75bf47c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=TrOLedJhFLGcXZ48aQFxWyWsQzM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>探针(Agent):</strong> 收集监控数据, 将数据格式化为 SkyWalking 适用的格式，然后传递给中间的OAP服务器。</li>
<li><strong>OAP:</strong> 全称即图上的Observabilitiy Analysis Platform， 完成数据聚合, 数据分析以及驱动数据流从探针到用户界面的流程</li>
<li><strong>存储</strong> 通过开放的插件化的接口存放 SkyWalking 数据. 你可以选择一个既有的存储系统, 如 ElasticSearch, H2 或 MySQL 集群(Sharding-Sphere 管理),也可以选择自己实现一个存储系统. 当然, 我们非常欢迎你贡献新的存储系统实现。</li>
<li><strong>UI</strong> 一个基于接口高度定制化的Web系统，用户可以可视化查看和管理 SkyWalking 数据。</li>
</ul>
<p>SkyWalking 利用Java Agent技术，在类加载阶段动态注入监控逻辑，无需改动源码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Skywalking通过javaagent在类加载时动态注入监控代码</span>
<span class="hljs-comment">// 不需要修改业务代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkywalkingAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">premain</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> args, Instrumentation inst</span>) {
        <span class="hljs-comment">// 1. 注册类文件转换器</span>
        inst.<span class="hljs-title function_">addTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassFileTransformer</span>() {
            <span class="hljs-keyword">public</span> byte[] <span class="hljs-title function_">transform</span>(<span class="hljs-params">...</span>) {
                <span class="hljs-comment">// 2. 使用ByteBuddy/Javassist修改字节码</span>
                <span class="hljs-comment">// 3. 在方法入口/出口插入监控逻辑</span>
            }
        });
    }
}
</code></pre>
<p>这种方式既保证了监控的全面性，又实现了对业务的完全透明。关于javaagent知识点请另外自行查阅资料。</p>
<h2 data-id="heading-6">3.SkyWalking 安装与部署</h2>
<p>基于上面对Skywalking架构原理的介绍，相信大家已经对它已经有了一定的认识了解，接下来我们就来开始搭建一个强大的监控系统。</p>
<h3 data-id="heading-7">3.1 下载安装包</h3>
<p>去官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fskywalking.incubator.apache.org%2Fdownloads%2F" target="_blank" title="https://skywalking.incubator.apache.org/downloads/" ref="nofollow noopener noreferrer">skywalking.incubator.apache.org/downloads/</a> 下载，我这里选择版本是: <code>v9.7.0</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ca0336b94c04e2ca7ea94a69830ef91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=mNSl87FUiKUJCI0PaCMm2xxfhK8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 解压与调整配置</h3>
<pre><code class="hljs"> tar -zxvf apache-skywalking-apm-9.7.0.tar.gz
</code></pre>
<p>解压之后有一个文件夹，文件信息如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15704295d3664275850d7e66bb27fecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=8FLjbp8fm6u40baT5jx%2FBIxAuRo%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>bin</strong>：存放一些可执行的脚本，比如说启动Skywalking OAP服务的脚本</p>
</li>
<li>
<p><strong>config：</strong> 存放配置文件，这里是我们需要关注的，有OAP服务的配置文件<code>applicaiton.yml</code>。配置项太多了所以这里我随便列举两项看看</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">cluster:</span>
  <span class="hljs-comment"># 默认单例部署，也可以集群部署，比如说通过注册中心nacos</span>
  <span class="hljs-symbol">selector:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_CLUSTER</span><span class="hljs-symbol">:standalone</span>}
  
<span class="hljs-symbol">storage:</span>
  <span class="hljs-comment"># 数据存储默认是内存数据库h2，生产环境一般推荐elasticsearch，官方也强烈建议</span>
  <span class="hljs-symbol">selector:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_STORAGE</span><span class="hljs-symbol">:h2</span>}
</code></pre>
<p>由于我是本地搭建演示，就完全按照默认的即可，没有做任何修改</p>
</li>
<li>
<p><strong>webapp：</strong> UI服务，默认端口是<code>8080</code>，但一般这个端口被占用了，所以需要修改一下<code>webapp/application.yml</code>，我这里改成：<code>8181</code></p>
</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">serverPort:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_SERVER_PORT</span><span class="hljs-symbol">:-</span><span class="hljs-number">8181</span>}
​
<span class="hljs-comment"># Comma seperated list of OAP addresses.</span>
<span class="hljs-symbol">oapServices:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_OAP_ADDRESS</span><span class="hljs-symbol">:-http</span><span class="hljs-symbol">://localhost</span><span class="hljs-symbol">:</span><span class="hljs-number">12800</span>}
​
<span class="hljs-symbol">zipkinServices:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_ZIPKIN_ADDRESS</span><span class="hljs-symbol">:-http</span><span class="hljs-symbol">://localhost</span><span class="hljs-symbol">:</span><span class="hljs-number">9412</span>}
</code></pre>
<h3 data-id="heading-9">3.3 启动服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动OAP后端</span>
bin/oapService.sh
​
<span class="hljs-comment"># 启动UI前端</span>
bin/webappService.sh
</code></pre>
<p>启动后访问 <code>http://localhost:8181</code> 即可进入SkyWalking监控控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75d598b437d04cd8b47e0ff28215dcde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=frFgzIGIq9KSkYgQ%2BD7RKgEFzgI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">4.Spring Boot接入指南</h2>
<p>在启动命令中添加Java Agent参数</p>
<pre><code class="hljs language-ini" lang="ini">-javaagent:/Users/shepherdmy/skywalking/skywalking-agent/skywalking-agent.jar
<span class="hljs-attr">-Dskywalking.agent.service_name</span>=shepherd-demo01-service
<span class="hljs-attr">-Dskywalking.collector.backend_service</span>=localhost:<span class="hljs-number">11800</span>
</code></pre>
<p>项目启动成功之后，Skywalking会监控到一个名为<code>shepherd-demo01-service</code>的服务，如上图所示。可看到对应的服务名称、实例、接口调用链路等信息</p>
<ul>
<li><strong>服务概览</strong>：展示服务负载量、接口请求平均响应时间、成功率等关键指标</li>
</ul>
<p>点击<code>服务名</code>进入监控指标概览页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f52029626f24cb2aefa364389a813e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=5IqAJRpysDS%2Barjil%2F3wVwlFM8Q%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>实例详情</strong>：查看实例下的监控指标信息，如JVM内存、CPU、GC等情况</li>
</ul>
<p>点击 <code>Instance</code>，可以查到该服务的<code>实例列表</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e87a39de548a4373be931ff797d5ce48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=kWno9h4AN4211ArBTwazfpaoOFc%3D" alt="" loading="lazy"/></p>
<p>点击<code>实例名</code>进入，可以查看这个实例下的监控信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e927f8052274b9d98fb14fa044fd8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=AMWmU0l%2B9NrtGIDJa1DH4SK0YSk%3D" alt="" loading="lazy"/></p>
<p>查看实例的jvm信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45452dfad25746a7a60e3641d6767ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=Ufm52vQ%2FP5uplbUcZALpclkjZes%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>查看EndPoint端点信息</strong></li>
</ul>
<p>端点可以简单理解为是被监控服务所接收的请求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92e42e56720749d58b6dcec52ad77255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=bKoYWpE6jt4nqeh8m8QVznjmD1U%3D" alt="" loading="lazy"/></p>
<p>点击<code>GET:/user/page</code>端点进去，可以查看这个请求的监控信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/364f1908094a4e8daeac425da38f268a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=Y3DxeEEtD1%2B%2BcxsHkrtgLnAFPr4%3D" alt="" loading="lazy"/></p>
<p>该请求<code>GET:/user/page</code>逻辑是先查询<code>Redis</code>，有缓存数据就直接返回，没有再根据参数去数据库<code>MySQL</code>查询数据存入<code>Redis</code>之后返回，这里详细展示了请求的整个调用链路，非常清晰直观。</p>
<ul>
<li><strong>拓扑图</strong>：可视化服务间依赖关系</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35c2b0462aa04478a11a1e6a7bd7bc67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=1O8tLje6E2iO1LGq3qs4vPEal%2Bg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">5.总结</h2>
<p>SkyWalking 提供多层级的监控指标，助力全方位系统可观测：</p>

























<table><thead><tr><th>层级</th><th>监控指标示例</th></tr></thead><tbody><tr><td>服务级别</td><td>P99/P95延迟、请求量、错误率</td></tr><tr><td>实例级别</td><td>CPU使用率、JVM堆内存、线程数、GC次数</td></tr><tr><td>接口端点</td><td>慢接口TOP10、错误接口TOP5、调用链详情</td></tr><tr><td>数据库</td><td>慢SQL查询、连接池状态、执行时间分布</td></tr></tbody></table>
<p>SkyWalking 作为一款开源APM系统，凭借其<strong>无侵入的设计</strong>、<strong>卓越的性能表现</strong>以及<strong>活跃的中文社区</strong>，已成为众多企业微服务监控的首选方案。无论是开发调试、性能优化，还是线上故障排查，SkyWalking 都能提供强大的数据支持和可视化能力。</p>
<p>合理部署与使用SkyWalking，不仅能提升系统稳定性，还能显著降低运维复杂度，是现代分布式系统可观测性建设中不可或缺的一环。</p>
<hr/>
<blockquote>
<p>本文初步介绍了SkyWalking的核心概念、部署流程与接入实践，关于微服务链路追踪的更深层原理、Trace与Span的组成、以及与Log4j2/Logback等日志框架的整合，我们将在后续文章中继续探讨。欢迎关注交流，共同进步</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 学习：父传子的单项数据流——props]]></title>    <link>https://juejin.cn/post/7586569284550934568</link>    <guid>https://juejin.cn/post/7586569284550934568</guid>    <pubDate>2025-12-23T00:58:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284550934568" data-draft-id="7586550947703275530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 学习：父传子的单项数据流——props"/> <meta itemprop="keywords" content="JavaScript,React.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T00:58:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 学习：父传子的单项数据流——props
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:58:03.000Z" title="Tue Dec 23 2025 00:58:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在学习 React 的 props ，顺手整理了自己的一些学习代码和笔记。props 是 React 组件通信的核心，玩好了它，你写组件就会像搭积木一样顺手。今天这篇文章，就从最基础的用法开始讲起，一步步带你深入，还会结合实际代码例子来说明。顺便聊聊 React 19 前后的小变化、常见的 CSS 写法，以及那个超级好用的 children props。</p>
<p>文章基于我自己的学习项目，代码来自一个简单的 App，包含 Greeting、Card 和 Modal 组件。咱们边看代码边聊，绝对干货满满。</p>
<h2 data-id="heading-1">一、Props 是什么？为什么这么重要？（重点对比 state）</h2>
<p>在 React 里，组件要正常工作，就离不开“数据”。数据主要分两类：<strong>state</strong> 和 <strong>props</strong>。这两兄弟长得有点像，但用途和性格完全不一样，搞清楚它们的关系，你写组件时才会心里有底。</p>
<p>用大白话总结：</p>



































<table><thead><tr><th>对比项</th><th>state（状态）</th><th>props（属性）</th></tr></thead><tbody><tr><td><strong>是谁的？</strong></td><td>组件<strong>自己</strong>的私有数据</td><td>父组件<strong>传给</strong>子组件的数据</td></tr><tr><td><strong>能不能改？</strong></td><td>可以改（用 setState 或 useState）</td><td><strong>只读</strong>！子组件不能直接改</td></tr><tr><td><strong>改了会怎样？</strong></td><td>修改后组件会重新渲染</td><td>只有父组件重新传新值，子组件才会更新</td></tr><tr><td><strong>生命周期</strong></td><td>属于当前组件，组件销毁就没了</td><td>像“快递”一样，从父组件送到子组件</td></tr><tr><td><strong>典型用途</strong></td><td>表单输入值、开关状态、计数器等可变数据</td><td>配置信息、显示内容、回调函数等</td></tr></tbody></table>
<h3 data-id="heading-2">用生活例子比喻最清楚</h3>
<p>想象你家有个儿子（子组件）和老爸（父组件）：</p>
<ul>
<li><strong>state</strong> 就像儿子自己的零花钱：他自己赚的（或爸给的初始值），想怎么花就怎么花（修改），爸管不着。</li>
<li><strong>props</strong> 就像爸给儿子的任务和工具：爸说“今天帮我买瓶酱油，顺便带张电影票回来”，儿子只能按爸给的钱和要求去办，不能自己改任务（“我偏要买可乐”不行）。</li>
</ul>
<p>如果儿子想跟爸说“我买完了”或者“我需要更多钱”，那只能通过爸事先给的“传话方式”（回调函数）来沟通——这就引出了我们上次讲的“子传父”。</p>
<h3 data-id="heading-3">代码对比最直观</h3>
<p>来看同一个需求：显示一个问候语，可以改名字和欢迎词。</p>
<p><strong>用 state 的方式</strong>（数据在组件自己手里）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GreetingSelf</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'陌生人'</span>);
  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'欢迎光临'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      {/* 自己改自己，超级自由 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"改名字"</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setName(e.target.value)} 
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"改欢迎词"</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setMessage(e.target.value)} 
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这个组件完全自给自足，想改啥改啥。</p>
<p><strong>用 props 的方式</strong>（数据从外面传进来）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      {/* 这里不能改！想改得让父组件来 */}
      {/* <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">...</span> /&gt;</span>  // 没用，props 是只读的 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'keji'</span>);
  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'欢迎来到腾讯'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
      
      {/* 只有这里能改，改了会重新传给子组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setName(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setMessage(e.target.value)} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看到区别了吗？</p>
<ul>
<li>用 state：组件内部自己管数据，适合独立的小部件。</li>
<li>用 props：组件变成“纯展示”工具，数据统一由父组件管理，适合复用（同一个 Greeting 可以给不同人用不同欢迎词）。</li>
</ul>
<h2 data-id="heading-4">二、React 19 之前：Props 的经典玩法</h2>
<p>在 React 18 及更早版本，props 用法已经很成熟了：</p>
<ol>
<li>
<p><strong>解构 props</strong>：直接在参数里解构，用起来最爽。</p>
</li>
<li>
<p><strong>默认值</strong>：两种方式</p>
<ul>
<li>ES6 默认参数：message = "默认值"</li>
<li>defaultProps（静态属性，已被废弃）</li>
</ul>
<p>示例（旧方式）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">Greeting</span>.<span class="hljs-property">defaultProps</span> = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎来到字节"</span>
};
</code></pre>
</li>
<li>
<p><strong>类型检查</strong>：用 prop-types 包</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PropTypes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"prop-types"</span>;

<span class="hljs-title class_">Greeting</span>.<span class="hljs-property">propTypes</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>,
};
</code></pre>
<p>开发模式下，如果传错类型会警告，很实用。</p>
</li>
<li>
<p><strong>传任意数据</strong>：字符串、数字、对象、函数、甚至 JSX 都可以。</p>
</li>
</ol>
<h2 data-id="heading-5">三、React 19 之后：Props 的小变化（更简洁了）</h2>
<p>React 19（2024 年 12 月稳定发布）对 props 本身的核心机制没大改，但有一些清理和改进，让代码更现代：</p>
<ul>
<li>
<p><strong>移除 propTypes 和 defaultProps</strong>：这些早在 React 15.5 就被标记废弃了，React 19 直接从 React 包里删掉。以后用的话不会报错，但完全没效果。</p>
<ul>
<li>推荐：用 TypeScript 做静态类型检查，或者继续用独立的 prop-types 包（手动检查）。</li>
<li>默认值统一用 ES6 默认参数，更简洁。</li>
</ul>
</li>
<li>
<p><strong>ref 现在可以直接作为 prop 传</strong>（超级实用！） 以前，函数组件想接收 ref 必须裹一层 forwardRef：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 18</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyInput</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>
));
</code></pre>
<p>React 19 后，函数组件直接收 ref，像 children 一样自然：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 19</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyInput</span>(<span class="hljs-params">{ ref, ...props }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>;
}
</code></pre>
<p>少了好多样板代码，官方还提供了 codemod 自动迁移。</p>
</li>
</ul>
<p>其他 props 相关的小优化：对 Custom Elements（Web Components）的支持更好，props 会优先作为 property 传，而不是 attribute。</p>
<p>总之，React 19 的 props 更干净、更贴近现代 JS。如果你还在用老项目，建议升级时跑一下官方 codemod。</p>
<h2 data-id="heading-6">四、React Props 的各种“边界情况”详解：不传、传了不用、没给值会发生什么？</h2>
<p>在实际写代码时，props 的这些“边缘情况”经常让人摸不着头脑。今天我们就一个个拆开看，结合真实代码和控制台输出，告诉你到底会发生什么，以及怎么避免坑。</p>
<h4 data-id="heading-7">1. 不传某个 prop（完全没写）</h4>
<p><strong>情况</strong>：父组件使用子组件时，压根没写这个 prop。</p>
<p><strong>结果</strong>：子组件收到这个 prop 的值是 <strong>undefined</strong>。</p>
<p><strong>例子</strong>：</p>
<p>子组件 Greeting.jsx：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message, showIcon }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ name, message, showIcon });  <span class="hljs-comment">// 关键看这里</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>父组件这样用：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> /&gt;
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">name</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">message</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">undefined</span> }
</code></pre>
<p>页面显示：</p>
<pre><code class="hljs language-text" lang="text">Hello          // 空
               // 空
</code></pre>
<p><strong>结论</strong>：不传 = undefined，不会报错，但显示会很丑。</p>
<h4 data-id="heading-8">2. 传了 prop 但子组件没用（写了但没解构/使用）</h4>
<p><strong>情况</strong>：父组件传了值，但子组件参数里没接收它。</p>
<p><strong>结果</strong>：传的值会丢失，子组件根本拿不到。</p>
<p><strong>例子</strong>：</p>
<p>父组件：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> name=<span class="hljs-string">"小明"</span> message=<span class="hljs-string">"欢迎"</span> /&gt;
</code></pre>
<p>子组件故意不接收 name：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ message }</span>) {  <span class="hljs-comment">// 只解构了 message，name 被忽略</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ message });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {message}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎"</span> }
</code></pre>
<p>name 的值“小明”直接丢了，子组件完全不知道有这个 prop。</p>
<p><strong>另一种写法</strong>（用 props 对象）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props);  <span class="hljs-comment">// { name: "小明", message: "欢迎" }</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;  <span class="hljs-comment">// 只用了 message</span>
}
</code></pre>
<p>这种情况下 props 对象里是有 name 的，但如果你没用它，就白传了。</p>
<p><strong>结论</strong>：传了但没用 = 白传，浪费性能（轻微），代码易混淆。</p>
<h4 data-id="heading-9">3. 传了 prop 但没给值（）</h4>
<p><strong>情况</strong>：写了 prop 名，但没赋值（布尔类型常见）。</p>
<p><strong>结果</strong>：React 会自动把这个 prop 的值设为 <strong>true</strong>。</p>
<p><strong>例子</strong>：</p>
<p>父组件：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> showIcon /&gt;        <span class="hljs-comment">// 没写 =true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">showIcon</span>=<span class="hljs-string">{true}</span> /&gt;</span></span> <span class="hljs-comment">// 显式写 true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">showIcon</span>=<span class="hljs-string">{false}</span> /&gt;</span></span><span class="hljs-comment">// 显式写 false</span>
</code></pre>
<p>子组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ showIcon }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ showIcon });

  <span class="hljs-keyword">return</span> showIcon &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
}
</code></pre>
<p>三种写法的控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">true</span> }     <span class="hljs-comment">// &lt;Greeting showIcon /&gt;</span>
{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">true</span> }     <span class="hljs-comment">// &lt;Greeting showIcon={true} /&gt;</span>
{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }    <span class="hljs-comment">// &lt;Greeting showIcon={false} /&gt;</span>
</code></pre>
<p><strong>结论</strong>：在 JSX 中， 等价于 。这是 React 的语法糖，超级常见于开关类 prop（如 disabled、checked、selected 等）。</p>
<h4 data-id="heading-10">4. 给了默认值的情况（ES6 默认参数）</h4>
<p><strong>情况</strong>：不传或传 undefined 时，用默认值兜底。</p>
<p><strong>例子</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ 
  name = <span class="hljs-string">"陌生人"</span>, 
  message = <span class="hljs-string">"欢迎光临"</span>, 
  showIcon = <span class="hljs-literal">false</span> 
}</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ name, message, showIcon });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>测试几种调用：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> /&gt;                          <span class="hljs-comment">// 全不传</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{undefined}</span> /&gt;</span></span>         <span class="hljs-comment">// 显式传 undefined</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">""</span> /&gt;</span></span>                  <span class="hljs-comment">// 传空字符串（不会用默认）</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"小明"</span> /&gt;</span></span>
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">name</span>: <span class="hljs-string">"陌生人"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"陌生人"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }  <span class="hljs-comment">// undefined 触发默认</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>,       <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }  <span class="hljs-comment">// 空字符串不会触发默认</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span>,   <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }
</code></pre>
<p><strong>关键点</strong>：只有 <strong>undefined</strong> 才会触发 ES6 默认值。传 null、""、false、0 都不会触发默认值。</p>
<h4 data-id="heading-11">5. 总结表格（一目了然）</h4>





















































<table><thead><tr><th>父组件写法</th><th>子组件收到值</th><th>是否触发默认值</th><th>说明</th></tr></thead><tbody><tr><td>不写 prop</td><td>undefined</td><td>是</td><td>最常见坑</td></tr><tr><td>&lt; Comp flag /&gt;</td><td>true</td><td>-</td><td>布尔 prop 的语法糖</td></tr><tr><td>&lt; Comp flag={true/false} /&gt;</td><td>true / false</td><td>-</td><td>显式控制</td></tr><tr><td>&lt; Comp name={undefined} /&gt;</td><td>undefined</td><td>是</td><td>显式传 undefined 也会触发默认</td></tr><tr><td>&lt; Comp name="" /&gt;</td><td>""（空字符串）</td><td>否</td><td>传了具体值，就不会用默认</td></tr><tr><td>&lt; Comp name={null} /&gt;</td><td>null</td><td>否</td><td>null 是合法值，不会触发默认</td></tr><tr><td>传了 prop 但子组件没接收</td><td>拿不到（丢失）</td><td>-</td><td>代码 bug，建议用 TS 或 PropTypes 检查</td></tr></tbody></table>
<h2 data-id="heading-12">五、children：最强大的 props</h2>
<p>children 是 React 自动传给你的一个特殊 prop，代表组件标签之间的内容。它让组件超级灵活，能“插槽”任意 JSX。</p>
<p><strong>Card 组件</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">App</span>.<span class="hljs-property">jsx</span>
&lt;<span class="hljs-title class_">Card</span> className=<span class="hljs-string">"user-card"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><strong>Card 实现</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//Card.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">""</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p>其中,{children}就是</p>
<pre><code class="hljs language-jsx" lang="jsx">  &lt;h2&gt;张三&lt;/h2&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<p>直接把父组件传的 JSX 原样渲染出来，完美封装卡片样式。</p>
<p><strong>Modal 组件</strong>（更高级的定制）： 我们想让 Modal 支持自定义 header 和 footer：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//App.jsx</span>
&lt;<span class="hljs-title class_">Modal</span> <span class="hljs-title class_">HeaderComponent</span>={<span class="hljs-title class_">MyHeader</span>} <span class="hljs-title class_">FooterComponent</span>={<span class="hljs-title class_">MyFooter</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<p>Modal 实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//Modal.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ HeaderComponent, FooterComponent, children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.modal}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.content}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这里 children 就是弹窗正文内容，而 Header/Footer 是通过 props 传组件，实现高度定制。</p>
<p>children 的威力在于：它让你的组件像“容器”一样，能包裹任意内容。Ant Design、Material UI 的很多组件都靠它实现灵活性。</p>
<h2 data-id="heading-13">六、React 中常见的 CSS 样式写法</h2>
<p>React 是“CSS in JS”的鼻祖，样式写法灵活多变。来看几种常见方式，各有优缺点：</p>
<ol>
<li>
<p><strong>内联样式（style 对象）</strong> —— 最简单，直接在 JSX 里写</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;h2 style={{ <span class="hljs-attr">margin</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"blue"</span> }}&gt;自定义标题&lt;/h2&gt;
</code></pre>
<p>适合快速原型或动态样式（比如根据 props 变色）。缺点：没法用伪类（如 :hover），写多了很乱。</p>
</li>
<li>
<p><strong>单独 CSS 文件 + className</strong> —— 传统方式，最常见 看 Card.jsx 和 Card.css：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-string">"./Card.css"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">""</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p>CSS 文件里写：</p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-comment">/* ... */</span>
}

<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>);
  <span class="hljs-comment">/* 悬停效果 */</span>
}
</code></pre>
<p>优点：支持所有 CSS 特性（伪类、媒体查询），易维护。缺点：类名冲突风险（可以用 CSS Modules 解决）。</p>
</li>
<li>
<p><strong>CSS in JS（对象样式）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> styles = {
  <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"rgba(0,0,0,0.5)"</span>, <span class="hljs-comment">/* ... */</span> },
  <span class="hljs-attr">modal</span>: { <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"white"</span>, <span class="hljs-comment">/* ... */</span> },
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p>优点：样式作用域天然隔离，动态样式超方便。缺点：运行时开销稍大，伪类支持差（需要额外库如 styled-components）。</p>
</li>
<li>
<p><strong>其他流行方案</strong>：</p>
<ul>
<li><strong>styled-components</strong> 或 <strong>emotion</strong>：写模板字符串，兼顾作用域和伪类。</li>
<li><strong>Tailwind CSS</strong>：utility-first，直接在 className 里堆类。</li>
<li><strong>CSS Modules</strong>：自动生成唯一类名，避免冲突。</li>
</ul>
</li>
</ol>
<p>个人建议：小项目内联或单独 CSS 够用，中大型项目推荐 CSS Modules + Tailwind，或者 styled-components。</p>
<h2 data-id="heading-14">最后总结</h2>
<p>props 是 React 的灵魂，掌握它你就掌握了组件通信。默认值、类型检查、children 这些细节用好了，代码会优雅很多。React 19 把一些老古董清理掉，鼓励我们写更现代的代码（ES6 默认 + TS）。</p>
<p>如果你也在学 React，建议自己动手搭几个组件玩玩 props 和 children，感觉完全不一样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」]]></title>    <link>https://juejin.cn/post/7586582977707474986</link>    <guid>https://juejin.cn/post/7586582977707474986</guid>    <pubDate>2025-12-23T00:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977707474986" data-draft-id="7586491717874253843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-23T00:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:57.000Z" title="Tue Dec 23 2025 00:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」</h2>
<blockquote>
<p>关键词：ArkUI、ETS、Lottie、Canvas、生命周期、健壮性</p>
</blockquote>
<p>在多阶段关闭动效中，「从哪儿飞出去」只是前半程；<br/>
<strong>真正让用户觉得自然的，是「飞到哪儿」以及「怎么在终点收尾」。</strong></p>
<p>这一篇我们聚焦三件事：</p>
<ul>
<li>终点区域如何抽象为一个通用的 <code>TargetRect</code>；</li>
<li>从 <code>TargetRect</code> 推导出 icon 的终点坐标和光圈（halo）的大小与偏移；</li>
<li>Lottie/Canvas 在 ArkUI 场景下的生命周期管理与健壮性设计。
<em>TL;DR：用 TargetRect 描述落点 → 算出 icon/halo 参数 → 把 Lottie 生命周期与事件兜底串起来，就能让关闭动画有一个“扎实的落点”。</em></li>
</ul>
<hr/>
<h3 data-id="heading-1">一、终点抽象：TargetRect 而不是「某业务组件」</h3>
<p>在具体业务中，关闭动效的终点可能是：</p>
<ul>
<li>首页某个「入口图标」；</li>
<li>底部 Tab 上的一个按钮；</li>
<li>页面内的某个卡片收纳位。</li>
</ul>
<p>但在动效引擎里，我们不想知道这些细节，只希望拿到一个<strong>抽象的矩形</strong>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TargetRect</span> {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 左上角 x</span>
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 左上角 y</span>
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}
</code></pre>
<p>外部世界（原生层/业务组件）通过某种回调把 <code>TargetRect</code> 提供给动效引擎：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">TargetResolver</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">TargetRect</span> | <span class="hljs-literal">null</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CloseAnimationEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> resolveTarget: TargetResolver</span>) {}

  <span class="hljs-title function_">initTargetArea</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveTarget</span>()
    <span class="hljs-keyword">if</span> (!rect || rect.<span class="hljs-property">width</span> &lt;= <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 非法参数，后续走兜底关闭</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">markTargetInvalid</span>()
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 后续基于 rect 计算终点和光圈</span>
  }
}
</code></pre>
<blockquote>
<p>设计要点：</p>
<ul>
<li>动效引擎只接收 <code>TargetRect</code>，不直接依赖任何具体组件或业务字段；</li>
<li>参数在入口处就做完校验，后续逻辑只处理「合法的矩形」或「无终点（走兜底）」两种情况。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、从 TargetRect 到 icon 终点：中心对齐与缩放后的尺寸</h3>
<p>假设我们最终要让一个缩小后的弹窗内容（或者独立 icon）落在 <code>TargetRect</code> 中央；<br/>
并且这个 icon 本身也会有一个缩放比例 <code>finalScale</code>（例如 0.3），对应某个容器宽高 <code>contentWidth/Height</code>。</p>
<p>我们希望：</p>
<ul>
<li>icon 缩放后的视觉矩形，刚好居中放在 <code>TargetRect</code> 中；</li>
<li>即使 <code>TargetRect</code> 很小，icon 也不会太小看不见（这一点可交给业务配置兜底）。</li>
</ul>
<p>中心对齐的计算可以写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeIconEndPosition</span>(<span class="hljs-params">
  rect: TargetRect,
  contentSize: { width: <span class="hljs-built_in">number</span>; height: <span class="hljs-built_in">number</span> },
  finalScale: <span class="hljs-built_in">number</span>,
</span>): { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> } {
  <span class="hljs-keyword">const</span> scaledWidth = contentSize.<span class="hljs-property">width</span> * finalScale
  <span class="hljs-keyword">const</span> scaledHeight = contentSize.<span class="hljs-property">height</span> * finalScale

  <span class="hljs-keyword">const</span> offsetX = (rect.<span class="hljs-property">width</span> - scaledWidth) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> offsetY = (rect.<span class="hljs-property">height</span> - scaledHeight) / <span class="hljs-number">2</span>

  <span class="hljs-keyword">const</span> endX = rect.<span class="hljs-property">x</span> + offsetX
  <span class="hljs-keyword">const</span> endY = rect.<span class="hljs-property">y</span> + offsetY

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: endX, <span class="hljs-attr">y</span>: endY }
}
</code></pre>
<p>这只解决了「缩放后矩形和目标矩形中心对齐」的问题。<br/>
结合上一篇的缩放偏移修正，我们会进一步把这个 <code>endX/endY</code> 输入到 <code>applyScaleOffset</code> 中，得到最终供 <code>motionPath</code> 使用的终点坐标。</p>
<p>逻辑链条可以用 mermaid 简单表示为：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[TargetRect(x,y,w,h)] --&gt; B[icon缩放尺寸&lt;br/&gt;scaledW,scaledH]
  B --&gt; C[中心对齐&lt;br/&gt;endX = x + (w - scaledW)/2]
  C --&gt; D[缩放偏移修正&lt;br/&gt;feed into motionPath endPoint]
</code></pre>
<blockquote>
<p>若平台不支持 mermaid，可复制到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.live" target="_blank" title="https://mermaid.live" ref="nofollow noopener noreferrer">mermaid.live</a> 查看示意。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、光圈（Halo）：既要包住目标，又不能小得看不见</h3>
<p>在终点，我们希望有一个「光圈收尾」：</p>
<ul>
<li>光圈以 icon 为中心；</li>
<li>光圈的直径至少要覆盖 <code>TargetRect</code>；</li>
<li>同时不能小于一个视觉兜底值（例如 132vp）。</li>
</ul>
<p>因此可以这样计算：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeHalo</span>(<span class="hljs-params">
  rect: TargetRect,
  contentSize: { width: <span class="hljs-built_in">number</span>; height: <span class="hljs-built_in">number</span> },
  finalScale: <span class="hljs-built_in">number</span>,
  minDiameter: <span class="hljs-built_in">number</span>,
</span>) {
  <span class="hljs-keyword">const</span> scaledWidth = contentSize.<span class="hljs-property">width</span> * finalScale
  <span class="hljs-keyword">const</span> scaledHeight = contentSize.<span class="hljs-property">height</span> * finalScale

  <span class="hljs-keyword">const</span> haloDiameter = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rect.<span class="hljs-property">width</span>, rect.<span class="hljs-property">height</span>, minDiameter)

  <span class="hljs-comment">// 为了让halo中心对齐icon，需要在渲染时做一个偏移</span>
  <span class="hljs-keyword">const</span> haloOffsetX = -(haloDiameter - scaledWidth) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> haloOffsetY = -(haloDiameter - scaledHeight) / <span class="hljs-number">2</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">diameter</span>: haloDiameter,
    <span class="hljs-attr">offsetX</span>: haloOffsetX,
    <span class="hljs-attr">offsetY</span>: haloOffsetY,
  }
}
</code></pre>
<p>在渲染层（比如一个 Canvas 容器）中，我们可以这样使用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Canvas</span>(haloCanvasContext)
  .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: halo.<span class="hljs-property">diameter</span>, <span class="hljs-attr">height</span>: halo.<span class="hljs-property">diameter</span> })
  .<span class="hljs-title function_">offset</span>({ <span class="hljs-attr">x</span>: halo.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: halo.<span class="hljs-property">offsetY</span> })
</code></pre>
<p>配合上一节的 icon 终点坐标，整体效果就是：</p>
<ul>
<li>icon 落在 <code>TargetRect</code> 中心；</li>
<li>光圈以 icon 为中心扩散，直径至少覆盖目标区域；</li>
<li>在小目标上仍有足够的视觉存在感。</li>
</ul>
<hr/>
<h3 data-id="heading-4">四、形态切换：dialog → icon → lottie</h3>
<p>在关闭动效过程中，我们通常会有三种形态：</p>
<ul>
<li><code>dialog</code>：原始弹窗形态（矩形卡片）；</li>
<li><code>icon</code>：缩小后的图标形态；</li>
<li><code>lottie</code>：终点光圈形态（由 Lottie 播放）。</li>
</ul>
<p>在 ArkUI 这类声明式 UI 框架中，比较推荐的做法是：</p>
<ul>
<li>在 UI 层用一个 <code>form</code> 状态描述当前形态；</li>
<li>用 <code>if/else</code> 或 <code>switch</code> 决定当前需要渲染哪个子树；</li>
<li>在动效引擎中只修改 <code>form</code>，而不直接操控具体 UI 组件。</li>
</ul>
<p>伪代码示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 状态</span>
<span class="hljs-meta">@State</span> <span class="hljs-attr">form</span>: <span class="hljs-string">'dialog'</span> | <span class="hljs-string">'icon'</span> | <span class="hljs-string">'lottie'</span> = <span class="hljs-string">'dialog'</span>

<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Column</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'dialog'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildDialogContent</span>()
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'icon'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildIcon</span>()
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'lottie'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildHalo</span>()
    }
  }
}
</code></pre>
<p>在动效引擎里，形态切换大致是这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 缩小完成后切换到 icon 形态</span>
stepMap.<span class="hljs-property">switchToIcon</span> = {
  <span class="hljs-attr">change</span>: <span class="hljs-function">() =&gt;</span> {
    state.<span class="hljs-property">form</span> = <span class="hljs-string">'icon'</span>
  },
  <span class="hljs-attr">animateParam</span>: { <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> stepper.<span class="hljs-title function_">start</span>([<span class="hljs-string">'wobbleIcon'</span>]) },
}

<span class="hljs-comment">// 抛掷完成后，如果需要光圈，则切换到 lottie 形态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onThrowFinished</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">enableHalo</span>) {
    state.<span class="hljs-property">form</span> = <span class="hljs-string">'lottie'</span>
    <span class="hljs-comment">// 更新容器尺寸为halo直径，重置scale等</span>
    state.<span class="hljs-property">containerSize</span> = halo.<span class="hljs-property">diameter</span>
    state.<span class="hljs-property">scale</span> = <span class="hljs-number">1</span>
  } <span class="hljs-keyword">else</span> {
    events.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'closeAnimationFinished'</span>)
  }
}
</code></pre>
<p>这样可以确保：</p>
<ul>
<li>UI 结构对形态高度敏感：哪种形态就渲染哪种子树，不会「残留」；</li>
<li>动效引擎只修改状态，UI 渲染由框架接管，符合声明式范式。</li>
</ul>
<hr/>
<h3 data-id="heading-5">五、Lottie + Canvas：在 ArkUI 中管理动画资源</h3>
<p>光圈本身通常是通过 Lottie 实现的，ArkUI 提供了基于 Canvas 渲染 Lottie 的能力。<br/>
一个通用的做法是：</p>
<ul>
<li>在 UI 层用一个 Canvas 组件作为容器；</li>
<li>在 Canvas <code>onReady</code> 时初始化 Lottie 动画；</li>
<li>在 Canvas <code>onDisappear</code> 时销毁 Lottie 实例。</li>
</ul>
<p>伪代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Builder</span>
<span class="hljs-title function_">buildHalo</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Canvas</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">haloCanvasContext</span>)
    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">diameter</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">diameter</span> })
    .<span class="hljs-title function_">offset</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">offsetY</span> })
    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initHaloLottie</span>())
    .<span class="hljs-title function_">onDisAppear</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">destroyHaloLottie</span>())
}
</code></pre>
<p>对应的 Lottie 生命周期管理：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">initHaloLottie</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> sourcePath = <span class="hljs-string">'halo.json'</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">rawContent</span>: <span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">try</span> {
    rawContent = uiContext.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContentSync</span>(sourcePath)
  } <span class="hljs-keyword">catch</span> (error) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load halo lottie file'</span>, error)
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>() <span class="hljs-comment">// 资源异常时直接兜底关闭</span>
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> jsonText = <span class="hljs-title class_">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">decodeToString</span>(rawContent)
  <span class="hljs-keyword">const</span> animationData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonText)

  <span class="hljs-comment">// 避免重复实例</span>
  lottie.<span class="hljs-title function_">destroy</span>(<span class="hljs-string">'halo'</span>)

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span> = lottie.<span class="hljs-title function_">loadAnimation</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'halo'</span>,
    animationData,
    <span class="hljs-attr">container</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">haloCanvasContext</span>,
    <span class="hljs-attr">renderer</span>: <span class="hljs-string">'canvas'</span>,
    <span class="hljs-attr">autoplay</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">loop</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">frameRate</span>: <span class="hljs-number">60</span>,
  })

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
  })
}

<span class="hljs-title function_">destroyHaloLottie</span>(<span class="hljs-params"/>) {
  lottie.<span class="hljs-title function_">destroy</span>(<span class="hljs-string">'halo'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span> = <span class="hljs-literal">undefined</span>
}
</code></pre>
<p>关键点：</p>
<ul>
<li>每次加载前先 <code>destroy</code> 同名实例，避免重复占用资源；</li>
<li>Lottie 生命周期与 Canvas 生命周期严格绑定，Canvas 消失时必须销毁动画；</li>
<li>complete 事件触发关闭完成信号，超时兜底（见下一节）则作为 backup。</li>
</ul>
<hr/>
<h3 data-id="heading-6">六、健壮性设计：一次性事件、非法参数、超时兜底</h3>
<p>复杂动效最怕的不是「不够炫」，而是「出问题时把用户卡死在半路」。<br/>
为了让关闭动效可靠可控，我们在设计时刻意做了几件「防御性编程」的事情：</p>
<h4 data-id="heading-7">1. TargetRect 严格校验</h4>
<p>在 <code>resolveTarget</code> 返回值入口处就做完所有合法性校验：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> rect = <span class="hljs-title function_">resolveTarget</span>()
<span class="hljs-keyword">if</span> (!rect || rect.<span class="hljs-property">width</span> &lt;= <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> &lt;= <span class="hljs-number">0</span>) {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Invalid target rect, fallback to simple close'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWhirlwind</span> = <span class="hljs-literal">false</span>   <span class="hljs-comment">// 或者标记为无终点</span>
}
</code></pre>
<p>这样后续所有计算都可以假定 <code>TargetRect</code> 是合法的，不必在各处重复判空。</p>
<h4 data-id="heading-8">2. 动效开始事件一次性消费</h4>
<p>无论是从原生层还是业务层发出的「开始关闭动效」信号，都建议：</p>
<ul>
<li>用一次性订阅（例如 <code>emitter.once</code>），防止一段生命周期内多次触发；</li>
<li>或者在动效引擎里加一个「运行中」状态标记，忽略后续重复触发。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">emitter.<span class="hljs-title function_">once</span>(<span class="hljs-string">'CLOSE_ANIMATION_START'</span>, <span class="hljs-function">(<span class="hljs-params">payload: CloseAnimPayload</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">canRunWhirlwind</span>(payload)) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startWithPayload</span>(payload)
})
</code></pre>
<h4 data-id="heading-9">3. 超时兜底：永远保证弹窗能被关闭</h4>
<p>即使我们做了完整的 complete 监听，也难以避免以下情况：</p>
<ul>
<li>Lottie 内部异常，complete 不触发；</li>
<li>Canvas 提前销毁；</li>
<li>某个阶段被外部打断。</li>
</ul>
<p>因此在开始关闭动效时，可以同时启动一个「安全定时器」：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">startSafeTimeout</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">closed</span>) {
      logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Close animation timeout, force close'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
    }
  }, <span class="hljs-number">3000</span>) <span class="hljs-comment">// 3秒兜底</span>
}
</code></pre>
<p>这样可以保证：<br/>
<strong>无论发生什么，用户最多等待一个固定的时间窗口，弹窗一定会被关闭。</strong></p>
<hr/>
<h3 data-id="heading-10">七、小结</h3>
<p>这一篇我们讲的都是「收尾工程」：</p>
<ul>
<li>把终点抽象为一个 <code>TargetRect</code>，与具体业务组件解耦；</li>
<li>从 <code>TargetRect</code> 推导出 icon 终点和光圈（halo）的尺寸与偏移，确保视觉上「打得准」且「包得住」；</li>
<li>在 ArkUI 中通过 Canvas + Lottie 实现光圈动画，并使用严格的生命周期管理保证资源可控；</li>
<li>通过一次性事件订阅、参数校验和超时兜底，让复杂动效在异常情况下仍然安全关闭。</li>
</ul>
<p>到这里，Whirlwind 式关闭动效的技术细节基本完整了：<br/>
时间轴上有 AnimationStepper 编排，空间上有双层容器和几何修正，终点有精确的目标映射和光圈收尾。</p>
<p>在最后一篇《性能 &amp; 工程化篇》中，我们会站到更高一层，从性能、埋点、灰度、配置和资源管理等角度，讨论如何把这种复杂动效做成「可以长期演进」的工程能力，而不是一次性的 Demo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest初体验-用nest实现一个简单的CRUD功能]]></title>    <link>https://juejin.cn/post/7586559672129126452</link>    <guid>https://juejin.cn/post/7586559672129126452</guid>    <pubDate>2025-12-23T01:13:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129126452" data-draft-id="7582863493260427316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest初体验-用nest实现一个简单的CRUD功能"/> <meta itemprop="keywords" content="前端,Node.js,全栈"/> <meta itemprop="datePublished" content="2025-12-23T01:13:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jun_不见"/> <meta itemprop="url" content="https://juejin.cn/user/3263006244609502"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest初体验-用nest实现一个简单的CRUD功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006244609502/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jun_不见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:13:37.000Z" title="Tue Dec 23 2025 01:13:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">nest简介</h2>
<p>Nest是一个用于构建高效、可扩展的Node服务器端应用框架。它默认使用Express作为HTTP服务端框架，但是也可以支持Fastify作为替代，使用TypeScript构建并全面支持 TypeScript，同时仍允许开发者使用纯 JavaScript 编码，融合了 OOP（面向对象编程）、FP（函数式编程）和 FRP（函数响应式编程）等元素。它的核心目标是解决传统 Node.js 框架（如 Express/Koa）缺乏统一架构规范、大型项目代码易混乱的问题。</p>
<p>NestJS 采用了一种清晰的<strong>三层结构</strong>来组织应用逻辑，也就是MVC结构。</p>
<h3 data-id="heading-1">1. 模块 (Modules)</h3>
<ul>
<li>
<p><strong>作用：</strong> 模块是 NestJS 应用的<strong>基本组织单元</strong>。它们是具有 <code>@Module()</code> 装饰器的类，用于将应用的不同功能和特性（如用户管理、订单处理等）逻辑上划分为独立的、可重用的部分。</p>
</li>
<li>
<p><strong>职责：</strong> 模块负责<strong>组合</strong>控制器和服务（提供者），并定义一组功能。每个应用至少有一个<strong>根模块（Root Module）</strong> 。</p>
</li>
<li>
<p><strong>关键属性：</strong></p>
<ul>
<li><code>controllers</code>: 属于本模块的<strong>控制器</strong>。</li>
<li><code>providers</code>: 属于本模块的<strong>服务</strong>、仓库、工厂等（统称为<strong>提供者</strong>）。</li>
<li><code>imports</code>: 导入<strong>其他模块</strong>，以便使用它们导出的提供者。</li>
<li><code>exports</code>: 导出本模块的提供者，供<strong>其他模块</strong>导入使用。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. 控制器 (Controllers)</h3>
<ul>
<li><strong>作用：</strong> 控制器负责处理<strong>传入的请求</strong>和返回<strong>响应</strong>。它们作为应用的入口点。</li>
<li><strong>职责：</strong> 它们使用 <code>@Controller()</code> 装饰器定义路由路径，并使用 <code>@Get()</code>, <code>@Post()</code>, <code>@Put()</code>, <code>@Delete()</code> 等装饰器来处理特定的 HTTP 方法。控制器通常只包含路由逻辑，并将复杂的业务逻辑<strong>委托</strong>给服务（提供者）。</li>
</ul>
<h3 data-id="heading-3">3. 提供者 (Providers / Services)</h3>
<ul>
<li><strong>作用：</strong> 提供者是 NestJS 中<strong>最核心</strong>的概念之一，用于处理<strong>业务逻辑</strong>和数据持久化。</li>
<li><strong>职责：</strong> 它们是可注入（Injectable）的类，通常包含复杂的逻辑、数据库交互、外部 API 调用等。它们使用 <code>@Injectable()</code> 装饰器，并由 NestJS 的<strong>依赖注入系统</strong>来管理其生命周期和依赖关系。</li>
<li><strong>常见类型：</strong> 服务（Services）、仓库（Repositories）、工厂（Factories）、辅助函数等。</li>
</ul>
<h2 data-id="heading-4">架构支撑模块（通过装饰器实现）</h2>
<p>这些不是传统意义上的“模块类”，而是 NestJS 用来增强功能和控制应用行为的<strong>架构组件</strong>：</p>








































<table><thead><tr><th><strong>模块/概念</strong></th><th><strong>装饰器</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>依赖注入 (DI)</strong></td><td><code>@Injectable()</code></td><td>管理提供者的生命周期，自动解决组件间的依赖关系，实现<strong>松散耦合</strong>。</td></tr><tr><td><strong>中间件 (Middleware)</strong></td><td>N/A (通过 <code>MiddlewareConsumer</code>)</td><td>在控制器处理请求之前执行的函数，用于身份验证、日志记录等。</td></tr><tr><td><strong>守卫 (Guards)</strong></td><td><code>@Injectable()</code>, <code>@UseGuards()</code></td><td>在请求进入控制器方法<strong>之前</strong>执行，用于授权（判断用户是否有权访问此路由）。</td></tr><tr><td><strong>拦截器 (Interceptors)</strong></td><td><code>@Injectable()</code>, <code>@UseInterceptors()</code></td><td>拦截<strong>请求</strong>和<strong>响应</strong>，用于转换数据、添加缓存、或执行请求/响应日志记录等。</td></tr><tr><td><strong>管道 (Pipes)</strong></td><td><code>@Injectable()</code>, <code>@UsePipes()</code></td><td>在控制器方法被调用<strong>之前</strong>执行，用于数据验证（Validation）和数据转换（Transformation）。</td></tr><tr><td><strong>过滤器 (Exception Filters)</strong></td><td><code>@Catch()</code>, <code>@UseFilters()</code></td><td>捕获并处理应用中未处理的异常，定制化返回给客户端的错误响应格式。</td></tr></tbody></table>
<p>nest从发送请求的响应的流程大致是这样的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a85e08477f4c6cbc37bb13dd0cd235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuX-S4jeingQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767057217&amp;x-signature=6NBqDwxEzU%2FCHLVSrB1w7CUrAEs%3D" alt="exported_image (1).png" loading="lazy"/></p>
<p>总结来说，<strong>模块</strong>是应用的骨架，<strong>控制器</strong>是入口，<strong>提供者</strong>是核心业务逻辑，而 <strong>守卫、管道、拦截器</strong> 等则是 NestJS 提供的强大工具，用于处理请求生命周期中的<strong>授权、验证和转换</strong>等任务。</p>
<p>以上就是nest的一些简单介绍，想详细了解的可以到nest的官网学习：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.cn%2Fintroduction" target="_blank" title="https://docs.nestjs.cn/introduction" ref="nofollow noopener noreferrer"># NestJS 中文文档</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2F" target="_blank" title="https://docs.nestjs.com/" ref="nofollow noopener noreferrer"># NestJS 英文文档</a></p>
<h2 data-id="heading-5">使用nest实现一个简单的URUD功能</h2>
<p>首先nest有一个自己的cli可以让我们快速创建一个nest项目，因此我们需要先安装一下nest Cli</p>
<pre><code class="hljs language-js" lang="js">npm i -g @nestjs/cli
</code></pre>
<p>安装完nest Cli后，就可以创建项目了</p>
<pre><code class="hljs language-js" lang="js">nest <span class="hljs-keyword">new</span> [项目名称]

<span class="hljs-comment">// CLI 会询问你使用哪个包管理器（npm、yarn 或 pnpm），选择后会自动创建项目并安装依赖。</span>

</code></pre>
<p>新建完项目后，可以看到我们的项目结构是这样的：</p>
<pre><code class="hljs language-bash" lang="bash">project-name/
├── src/
│   ├── main.ts              <span class="hljs-comment"># 应用入口文件</span>
│   ├── app.module.ts        <span class="hljs-comment"># 根模块</span>
│   ├── app.controller.ts    <span class="hljs-comment"># 根控制器</span>
│   └── app.service.ts       <span class="hljs-comment"># 根服务</span>
├── <span class="hljs-built_in">test</span>/                    <span class="hljs-comment"># 测试文件</span>
├── dist/                    <span class="hljs-comment"># 编译后的文件</span>
├── node_modules/            <span class="hljs-comment"># 依赖包</span>
├── package.json             <span class="hljs-comment"># 项目配置和依赖</span>
├── tsconfig.json            <span class="hljs-comment"># TypeScript 配置</span>
├── nest-cli.json            <span class="hljs-comment"># NestJS CLI 配置</span>
└── README.md                <span class="hljs-comment"># 项目说明</span>
</code></pre>
<p>主要实现一个用户模块，在项目代码中有较为详细的注解说明。</p>
<p>以下是一个简单的User模块的代码，为了方便理解，先用一个示例来简单说它们的大概流程（创建用户）：</p>
<h3 data-id="heading-6">1. 请求入口</h3>
<pre><code class="hljs language-http" lang="http">POST /api/users
Content-Type: application/json

{
  "name": "张三",
  "email": "zhangsan@example.com",
  "age": 25
}
</code></pre>
<p>发送一个POST类型的接口，地址/api/users，下方的请求体是请求体body。</p>
<h3 data-id="heading-7">2. 路由匹配</h3>
<p>文件： <code>user.controller.ts</code></p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'api/users'</span>)  <span class="hljs-comment">// 路由前缀</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  @<span class="hljs-title class_">Post</span>()  <span class="hljs-comment">// 匹配 POST /api/users</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">@Body() createUserDto: CreateUserDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
  }
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>NestJS 路由系统匹配 <code>POST /api/users</code></li>
<li>找到 <code>UserController</code> 的 <code>create</code> 方法</li>
<li>准备执行方法</li>
</ol>
<h3 data-id="heading-8">3. 数据验证（ValidationPipe）</h3>
<p>文件：<code>main.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalPipes</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>({
    <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 过滤未定义的属性</span>
    <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 禁止未定义的属性</span>
    <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 自动转换类型</span>
  }),
);
</code></pre>
<p><strong>验证流程：</strong></p>
<ol>
<li><code>@Body()</code> 装饰器提取请求体 JSON 数据</li>
<li>ValidationPipe 根据 <code>CreateUserDto</code> 的验证规则进行验证：
<ul>
<li><code>name</code>: 必须是字符串（<code>@IsString()</code>）</li>
<li><code>email</code>: 必须是有效邮箱格式（<code>@IsEmail()</code>）</li>
<li><code>age</code>: 可选，如果提供必须是 0-150 的整数（<code>@IsOptional()</code>, <code>@IsInt()</code>, <code>@Min(0)</code>, <code>@Max(150)</code>）</li>
</ul>
</li>
<li>如果验证失败，返回 <code>400 Bad Request</code>，包含错误详情</li>
<li>如果验证通过，将数据转换为 <code>CreateUserDto</code> 实例</li>
</ol>
<p><strong>验证规则（CreateUserDto）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-meta">@IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsOptional</span>()
  <span class="hljs-meta">@IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })
  <span class="hljs-meta">@Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })
  <span class="hljs-meta">@Max</span>(<span class="hljs-number">150</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于150'</span> })
  age?: <span class="hljs-built_in">number</span>;
}
</code></pre>
<h3 data-id="heading-9">4. 控制器处理</h3>
<p><strong>文件：</strong> <code>user.controller.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-meta">@Body</span>() <span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>接收验证后的 <code>CreateUserDto</code> 对象</li>
<li>调用 <code>userService.create()</code> 方法</li>
<li>等待服务层返回结果</li>
<li>返回 <code>UserResponseDto</code> 类型的数据</li>
</ol>
<h3 data-id="heading-10">5. 服务层处理</h3>
<p><strong>文件：</strong> <code>user.service.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
  <span class="hljs-comment">// 1. 创建实体实例</span>
  <span class="hljs-keyword">const</span> newUser = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">name</span>: createUserDto.<span class="hljs-property">name</span>,
    <span class="hljs-attr">email</span>: createUserDto.<span class="hljs-property">email</span>,
    <span class="hljs-attr">age</span>: createUserDto.<span class="hljs-property">age</span>,
  });

  <span class="hljs-comment">// 2. 保存到数据库</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(newUser);
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>
<p><strong>创建实体实例</strong>：</p>
<ul>
<li><code>repository.create()</code> 创建 <code>User</code> 实体实例</li>
<li>此时实体还未保存到数据库</li>
<li>只设置了基本字段（name, email, age）</li>
</ul>
</li>
<li>
<p><strong>保存到数据库</strong>：</p>
<ul>
<li><code>repository.save()</code> 执行 INSERT 操作</li>
<li>TypeORM 自动处理：
<ul>
<li>生成自增 ID（<code>@PrimaryGeneratedColumn()</code>）</li>
<li>设置 <code>createdAt</code>（<code>@CreateDateColumn()</code>）</li>
<li>设置 <code>updatedAt</code>（<code>@UpdateDateColumn()</code>）</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>主要涉及的文件main.ts，主要入口，用于项目的入口。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ValidationPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-comment">/**
 * 应用程序启动入口
 * bootstrap 函数是 NestJS 应用的入口点
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用 NestFactory 创建 NestJS 应用实例</span>
  <span class="hljs-comment">// NestFactory 是创建应用的核心工厂类</span>
  <span class="hljs-comment">// AppModule 是应用的根模块，包含了所有功能模块的配置</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  
  <span class="hljs-comment">/**
   * 启用跨域资源共享 (CORS)
   * 允许前端应用（运行在 localhost:3000）访问后端 API
   * credentials: true 表示允许携带认证信息（如 cookies）
   */</span>
  app.<span class="hljs-title function_">enableCors</span>({
    <span class="hljs-attr">origin</span>: <span class="hljs-string">'http://localhost:3000'</span>, <span class="hljs-comment">// 允许的前端域名</span>
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许携带凭证</span>
  });

  <span class="hljs-comment">/**
   * 全局验证管道
   * 自动验证所有传入的请求数据，根据 DTO 中的装饰器进行验证
   */</span>
  app.<span class="hljs-title function_">useGlobalPipes</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>({
      <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动过滤掉 DTO 中未定义的属性</span>
      <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 如果请求包含未定义的属性，抛出错误</span>
      <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动将请求数据转换为 DTO 实例</span>
    }),
  );

  <span class="hljs-comment">/**
   * 启动 HTTP 服务器
   * process.env.PORT 从环境变量读取端口，如果未设置则默认使用 3001
   * ?? 是空值合并运算符，当左侧为 null 或 undefined 时使用右侧的值
   */</span>
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3001</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Application is running on: http://localhost:<span class="hljs-subst">${process.env.PORT ?? <span class="hljs-number">3001</span>}</span>`</span>);
}

<span class="hljs-comment">// 执行启动函数</span>
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p>app.module.ts，模块如果需要在当前模块使用那就需要进行导入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user/user.module'</span>;

<span class="hljs-comment">/**
 * AppModule - 应用的根模块
 * 
 * <span class="hljs-doctag">@Module</span> 装饰器用于定义一个模块类
 * 模块是 NestJS 中组织代码的基本单元，类似于 Angular 的模块概念
 * 
 * 模块的三个主要属性：
 * - imports: 导入其他模块，使当前模块可以使用其他模块导出的功能
 * - controllers: 注册控制器，处理 HTTP 请求
 * - providers: 注册提供者（服务），实现业务逻辑，可以在整个模块中注入使用
 */</span>
@<span class="hljs-title class_">Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">/**
     * ConfigModule - 配置模块
     * 
     * 作用：管理应用配置，支持从环境变量、配置文件等读取配置
     * 
     * 参数说明：
     *   - isGlobal: true - 设置为全局模块，所有模块都可以直接使用 ConfigService
     *   - envFilePath: '.env' - 环境变量文件路径
     *   - load: [] - 可以加载额外的配置源
     * 
     * 说明：
     *   - 全局模块意味着不需要在每个模块中导入 ConfigModule
     *   - 可以直接在任何地方注入 ConfigService 使用
     */</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局配置模块</span>
      <span class="hljs-attr">envFilePath</span>: <span class="hljs-string">'.env'</span>, <span class="hljs-comment">// 环境变量文件路径</span>
    }),

    <span class="hljs-comment">/**
     * TypeOrmModule.forRootAsync() - TypeORM 异步配置
     * 
     * 作用：配置 TypeORM 数据库连接
     * 
     * 为什么使用 forRootAsync：
     *   - 可以异步获取配置（如从 ConfigService）
     *   - 支持依赖注入（如注入 ConfigService）
     *   - 更灵活，可以在运行时读取配置
     * 
     * 参数说明：
     *   - imports: [ConfigModule] - 导入 ConfigModule 以使用 ConfigService
     *   - useFactory: 工厂函数，返回 TypeORM 配置对象
     *   - inject: [ConfigService] - 注入 ConfigService 到工厂函数
     */</span>
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>],
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> ({
        <span class="hljs-comment">/**
         * type - 数据库类型
         * 支持：mysql, postgres, sqlite, mssql, mongodb 等
         */</span>
        <span class="hljs-attr">type</span>: <span class="hljs-string">'mysql'</span>,

        <span class="hljs-comment">/**
         * host - 数据库主机地址
         * 从环境变量 DB_HOST 读取，默认 localhost
         */</span>
        <span class="hljs-attr">host</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_HOST'</span>, <span class="hljs-string">'localhost'</span>),

        <span class="hljs-comment">/**
         * port - 数据库端口
         * 从环境变量 DB_PORT 读取，默认 3306（MySQL 默认端口）
         */</span>
        <span class="hljs-attr">port</span>: configService.<span class="hljs-property">get</span>&lt;number&gt;(<span class="hljs-string">'DB_PORT'</span>, <span class="hljs-number">3306</span>),

        <span class="hljs-comment">/**
         * username - 数据库用户名
         * 从环境变量 DB_USERNAME 读取
         */</span>
        <span class="hljs-attr">username</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_USERNAME'</span>, <span class="hljs-string">'root'</span>),

        <span class="hljs-comment">/**
         * password - 数据库密码
         * 从环境变量 DB_PASSWORD 读取
         */</span>
        <span class="hljs-attr">password</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_PASSWORD'</span>, <span class="hljs-string">''</span>),

        <span class="hljs-comment">/**
         * database - 数据库名称
         * 从环境变量 DB_DATABASE 读取
         */</span>
        <span class="hljs-attr">database</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_DATABASE'</span>, <span class="hljs-string">'nest_db'</span>),

        <span class="hljs-comment">/**
         * entities - 实体类数组
         * 指定 TypeORM 要管理的实体类

         */</span>
        <span class="hljs-attr">entities</span>: [__dirname + <span class="hljs-string">'/**/*.entity{.ts,.js}'</span>],

        <span class="hljs-comment">/**
         * synchronize - 自动同步数据库结构
         * 
         * 作用：根据实体类自动创建或更新数据库表结构
         * 
         * 注意：
         *   - true: 开发环境使用，自动同步表结构（方便开发）
         *   - false: 生产环境必须设为 false，使用迁移（migration）管理数据库结构
         *   - 设为 true 时，修改实体类会自动修改数据库表，可能丢失数据
         */</span>
        <span class="hljs-attr">synchronize</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_SYNCHRONIZE'</span>, <span class="hljs-string">'true'</span>) === <span class="hljs-string">'true'</span>,

        <span class="hljs-comment">/**
         * logging - SQL 日志
         * 
         * 作用：是否打印执行的 SQL 语句
         * 
         * 说明：
         *   - true: 开发环境使用，方便调试，可以看到执行的 SQL
         *   - false: 生产环境使用，减少日志输出
         *   - 也可以设置为 ['query', 'error'] 等数组，只记录特定类型的日志
         */</span>
        <span class="hljs-attr">logging</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_LOGGING'</span>, <span class="hljs-string">'true'</span>) === <span class="hljs-string">'true'</span>,

        <span class="hljs-comment">/**
         * 其他常用配置选项：
         * 
         * - charset: 'utf8mb4' - 字符集（支持 emoji）
         * - timezone: '+08:00' - 时区
         * - extra: { connectionLimit: 10 } - 连接池配置
         * - migrations: [] - 数据库迁移文件
         * - subscribers: [] - 订阅者（实体监听器）
         */</span>
      }),
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],
    }),
    <span class="hljs-title class_">UserModule</span>, <span class="hljs-comment">// 导入用户模块，这样才可以使用user模块中导出的方法</span>
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>], <span class="hljs-comment">// 注册应用控制器</span>
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>], <span class="hljs-comment">// 注册应用服务</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<p>user.controller.ts，在user模块中的控制器，用于路由的匹配。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Controller</span>,<span class="hljs-title class_">Get</span>,<span class="hljs-title class_">Post</span>,<span class="hljs-title class_">Body</span>,<span class="hljs-title class_">Patch</span>,<span class="hljs-title class_">Param</span>,<span class="hljs-title class_">Delete</span>,<span class="hljs-title class_">ParseIntPipe</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserResponseDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/user-response.dto'</span>;

<span class="hljs-comment">/**
 * UserController - 用户控制器
 * 
 * 负责处理用户相关的 HTTP 请求
 * 实现完整的 CRUD 操作：Create（创建）、Read（读取）、Update（更新）、Delete（删除）
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Controller</span>('api/users') - 控制器路由装饰器
 * 
 * 作用：定义控制器的路由前缀，所有该控制器下的路由都会自动加上这个前缀
 * 参数：'api/users' - 路由前缀路径
 * 效果：
 *   - 如果方法装饰器是 <span class="hljs-doctag">@Get</span>()，完整路径为 GET /api/users
 *   - 如果方法装饰器是 <span class="hljs-doctag">@Get</span>(':id')，完整路径为 GET /api/users/:id
 */</span>
 
@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'api/users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-comment">/**
   * 依赖注入 - 通过构造函数注入 UserService
   * private readonly 表示这是私有只读属性，只能在类内部使用
   */</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">private readonly userService: UserService</span>) {}
  
  <span class="hljs-comment">/**
   * 创建用户
   * POST /api/users
   */</span>
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Post</span>() - HTTP POST 方法装饰器
   * 
   * 作用：将方法标记为处理 POST 请求的路由处理器
   * 参数：不传参数时，路由路径为空，完整路径为控制器的前缀 + 空路径 = /api/users
   * 说明：POST 请求通常用于创建新资源
   */</span>
  @<span class="hljs-title class_">Post</span>()
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Body</span>() - 请求体参数装饰器
     * 
     * 作用：从 HTTP 请求体中提取数据并注入到方法参数中
     * 说明：
     *   - NestJS 会自动将 JSON 请求体解析为 CreateUserDto 对象
     *   - 结合 ValidationPipe，会自动验证数据是否符合 DTO 中定义的规则
     *   - 如果验证失败，会返回 400 错误
     */</span>
    @<span class="hljs-title class_">Body</span>() <span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
  }

  <span class="hljs-comment">/**
   * 获取所有用户
   * GET /api/users
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Get</span>() - HTTP GET 方法装饰器
   * 
   * 作用：将方法标记为处理 GET 请求的路由处理器
   * 参数：不传参数时，路由路径为空，完整路径为 /api/users
   * 说明：GET 请求用于获取资源
   */</span>
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>[]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">findAll</span>();
  }

  <span class="hljs-comment">/**
   * 根据ID获取单个用户
   * GET /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Get</span>(':id') - HTTP GET 方法装饰器（带路径参数）
   * 
   * 作用：定义带路径参数的 GET 路由
   * 参数：':id' - 路径参数，冒号表示这是一个动态参数
   * 完整路径：GET /api/users/:id
   * 说明：路径参数可以通过 <span class="hljs-doctag">@Param</span>() 装饰器获取
   */</span>
  @<span class="hljs-title class_">Get</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 路径参数装饰器 + 管道转换
     * 
     * 作用：
     *   1. <span class="hljs-doctag">@Param</span>('id') - 从路由路径中提取名为 'id' 的参数
     *   2. ParseIntPipe - 将字符串参数转换为整数类型
     * 
     * 说明：
     *   - HTTP 请求中的路径参数默认是字符串类型
     *   - ParseIntPipe 会自动将字符串转换为数字
     *   - 如果转换失败（如传入非数字），会自动返回 400 错误
     *   - 这是 NestJS 中类型转换和验证的常用方式
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">findOne</span>(id);
  }

  <span class="hljs-comment">/**
   * 更新用户信息
   * PATCH /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Patch</span>(':id') - HTTP PATCH 方法装饰器
   * 
   * 作用：将方法标记为处理 PATCH 请求的路由处理器
   * 参数：':id' - 路径参数，表示要更新的资源ID
   * 说明：
   *   - PATCH 用于部分更新资源（只更新提供的字段）
   *   - 与 PUT 的区别：PUT 通常用于完整替换资源，PATCH 用于部分更新
   *   - RESTful API 中，更新操作通常使用 PATCH
   */</span>
  @<span class="hljs-title class_">Patch</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 提取并转换路径参数 id
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number,
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Body</span>() - 提取请求体数据
     * 
     * 说明：UpdateUserDto 中的字段都是可选的，可以只更新部分字段
     */</span>
    @<span class="hljs-title class_">Body</span>() <span class="hljs-attr">updateUserDto</span>: <span class="hljs-title class_">UpdateUserDto</span>,
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">update</span>(id, updateUserDto);
  }

  <span class="hljs-comment">/**
   * 删除用户
   * DELETE /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Delete</span>(':id') - HTTP DELETE 方法装饰器
   * 
   * 作用：将方法标记为处理 DELETE 请求的路由处理器
   * 参数：':id' - 路径参数，表示要删除的资源ID
   * 说明：DELETE 请求用于删除资源，是 RESTful API 中删除操作的标准方法
   */</span>
  @<span class="hljs-title class_">Delete</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 提取并转换路径参数 id
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">remove</span>(id);
  }
}
</code></pre>
<p>user.service.ts，在user模块中的提供者，用于处理请求的业务逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NotFoundException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectRepository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Repository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./entities/user.entity'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;

<span class="hljs-comment">/**
 * UserService - 用户服务类
 * 
 * 负责处理用户相关的业务逻辑
 * 使用 TypeORM Repository 进行数据库操作
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Injectable</span>() - 可注入装饰器
 * 
 * 作用：标记此类可以被 NestJS 的依赖注入系统管理
 * 
 * 功能说明：
 *   1. 使此类可以被其他类（如控制器）通过构造函数注入使用
 *   2. NestJS 会自动管理其生命周期（默认是单例模式，整个应用只有一个实例）
 *   3. 可以在模块的 providers 数组中注册
 *   4. 支持依赖注入，可以在构造函数中注入其他服务
 * 
 * 生命周期：
 *   - 默认作用域：单例（SINGLETON），应用启动时创建一次，所有地方共享同一个实例
 *   - 可以通过 { scope: Scope.REQUEST } 设置为请求作用域，每个请求创建新实例
 *   - 可以通过 { scope: Scope.TRANSIENT } 设置为瞬态作用域，每次注入都创建新实例
 * 
 * 使用场景：
 *   - 封装业务逻辑
 *   - 数据访问层（如数据库操作）
 *   - 可复用的功能模块
 */</span>
@<span class="hljs-title class_">Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">/**
   * 构造函数 - 依赖注入 Repository
   * 
   * <span class="hljs-doctag">@InjectRepository</span>(User) - Repository 注入装饰器
   * 
   * 作用：注入 TypeORM Repository，用于数据库操作
   * 
   * 参数说明：
   *   - User - 实体类，指定要操作的实体类型
   * 
   * 说明：
   *   - Repository&lt;User&gt; 是 TypeORM 提供的数据库操作接口
   *   - 提供了丰富的数据库操作方法（find, save, delete, update 等）
   *   - 类型安全：TypeScript 会根据 User 实体类提供类型提示
   *   - 需要在 UserModule 中使用 TypeOrmModule.forFeature([User]) 注册
   */</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    @InjectRepository(User)
    private userRepository: Repository&lt;User&gt;,
  </span>) {}

  <span class="hljs-comment">/**
   * 创建用户
   * 
   * <span class="hljs-doctag">@param</span> createUserDto 创建用户的数据
   * <span class="hljs-doctag">@returns</span> 创建的用户对象（Promise）
   * 
   * 说明：
   *   - create() 方法创建实体实例，但不保存到数据库
   *   - save() 方法将实体保存到数据库
   *   - TypeORM 会自动处理 createdAt 和 updatedAt 字段
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-comment">// 创建实体实例</span>
    <span class="hljs-keyword">const</span> newUser = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">name</span>: createUserDto.<span class="hljs-property">name</span>,
      <span class="hljs-attr">email</span>: createUserDto.<span class="hljs-property">email</span>,
      <span class="hljs-attr">age</span>: createUserDto.<span class="hljs-property">age</span>,
    });

    <span class="hljs-comment">// 保存到数据库</span>
    <span class="hljs-comment">// save() 方法会：</span>
    <span class="hljs-comment">// 1. 插入新记录到数据库</span>
    <span class="hljs-comment">// 2. 自动设置 createdAt 和 updatedAt（因为使用了 @CreateDateColumn 和 @UpdateDateColumn）</span>
    <span class="hljs-comment">// 3. 返回保存后的实体（包含自动生成的 id）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(newUser);
  }

  <span class="hljs-comment">/**
   * 获取所有用户
   * 
   * <span class="hljs-doctag">@returns</span> 用户数组（Promise）
   * 
   * 说明：
   *   - find() 方法查询所有记录
   *   - 返回数组，如果没有记录则返回空数组 []
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>[]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">find</span>();
  }

  <span class="hljs-comment">/**
   * 根据ID获取单个用户
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@returns</span> 用户对象（Promise）
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - findOne({ where: { id } }) 根据条件查询单条记录
   *   - 如果找不到记录，返回 null
   *   - 需要手动检查并抛出异常
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(<span class="hljs-attr">id</span>: number): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">where</span>: { id } });

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">`用户 ID <span class="hljs-subst">${id}</span> 不存在`</span>);
    }

    <span class="hljs-keyword">return</span> user;
  }

  <span class="hljs-comment">/**
   * 更新用户信息
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@param</span> updateUserDto 更新的数据
   * <span class="hljs-doctag">@returns</span> 更新后的用户对象（Promise）
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - 先查找用户，如果不存在则抛出异常
   *   - 使用 Object.assign() 或展开运算符更新字段
   *   - save() 方法会：
   *     1. 如果实体有 id，执行 UPDATE 操作
   *     2. 自动更新 updatedAt 字段（因为使用了 <span class="hljs-doctag">@UpdateDateColumn</span>）
   *     3. 返回更新后的实体
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-attr">id</span>: number, <span class="hljs-attr">updateUserDto</span>: <span class="hljs-title class_">UpdateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-comment">// 查找用户，如果不存在会抛出异常</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(id);

    <span class="hljs-comment">// 更新用户信息</span>
    <span class="hljs-comment">// Object.assign() 将 updateUserDto 中的属性复制到 user 对象</span>
    <span class="hljs-comment">// 只更新提供的字段，未提供的字段保持不变</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(user, updateUserDto);

    <span class="hljs-comment">// 保存更新</span>
    <span class="hljs-comment">// save() 方法检测到实体有 id，会执行 UPDATE 而不是 INSERT</span>
    <span class="hljs-comment">// @UpdateDateColumn 装饰的字段会自动更新为当前时间</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user);
  }

  <span class="hljs-comment">/**
   * 删除用户
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - remove() 方法需要传入实体对象
   *   - delete() 方法可以直接传入 id，更高效
   *   - 两种方式都可以，delete() 更简单直接
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(<span class="hljs-attr">id</span>: number): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-comment">// 先检查用户是否存在</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(id); <span class="hljs-comment">// 如果不存在会抛出异常</span>

    <span class="hljs-comment">// 删除用户</span>
    <span class="hljs-comment">// delete() 方法根据 id 删除记录</span>
    <span class="hljs-comment">// 返回 DeleteResult 对象，包含 affected 属性（受影响的行数）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">delete</span>(id);
  }
}
</code></pre>
<p>以上涉及的DTO有三个，代码如下：</p>
<p>create-user.dto.ts:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsString</span>, <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsOptional</span>, <span class="hljs-title class_">IsInt</span>, <span class="hljs-title class_">Min</span>, <span class="hljs-title class_">Max</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;

<span class="hljs-comment">/**
 * CreateUserDto - 创建用户数据传输对象
 * 用于接收创建用户的请求数据
 * 
 * DTO (Data Transfer Object) 的作用：
 *   1. 定义 API 接口的请求数据结构
 *   2. 提供数据验证规则（通过 class-validator 装饰器）
 *   3. 类型安全：TypeScript 类型检查
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsString</span>() - 字符串验证装饰器
   * 
   * 作用：验证该字段必须是字符串类型
   * 
   * 参数说明：
   *   - message: 验证失败时返回的错误消息
   * 
   * 验证规则：
   *   - 如果传入的值不是字符串，验证会失败
   *   - 验证失败时，NestJS 会返回 400 错误，错误信息为 "用户名必须是字符串"
   * 
   * 说明：
   *   - class-validator 提供了丰富的验证装饰器
   *   - 需要配合 ValidationPipe 使用（在 main.ts 中已配置）
   *   - 验证在请求到达控制器方法之前自动执行
   */</span>
  @<span class="hljs-title class_">IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  <span class="hljs-attr">name</span>: string;
  
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsEmail</span>() - 邮箱格式验证装饰器
   * 
   * 作用：验证该字段必须是有效的邮箱格式
   * 
   * 参数说明：
   *   - 第一个参数 {}: 邮箱验证选项（使用默认选项）
   *   - 第二个参数 { message: ... }: 验证失败时的错误消息
   * 
   * 验证规则：
   *   - 必须符合邮箱格式（如：user<span class="hljs-doctag">@example</span>.com）
   *   - 验证失败时返回 "邮箱格式不正确"
   * 
   * 说明：
   *   - 这是数据验证的重要环节，防止无效数据进入系统
   *   - 验证在服务层处理之前完成，提高系统安全性
   */</span>
  @<span class="hljs-title class_">IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  <span class="hljs-attr">email</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 可选字段装饰器
   * 
   * 作用：标记该字段是可选的，如果未提供值，跳过后续验证
   * 
   * 说明：
   *   - 如果字段存在，则执行后续的验证规则
   *   - 如果字段不存在（undefined），则跳过验证
   *   - 必须放在其他验证装饰器之前
   *   - 与 TypeScript 的可选属性（?）配合使用
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsInt</span>() - 整数验证装饰器
   * 
   * 作用：验证该字段必须是整数
   * 
   * 说明：
   *   - 验证值是否为整数类型
   *   - 如果传入小数或非数字，验证会失败
   */</span>
  @<span class="hljs-title class_">IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Min</span>() - 最小值验证装饰器
   * 
   * 作用：验证数值必须大于或等于指定值
   * 
   * 参数：0 - 最小值
   * 说明：年龄不能为负数
   */</span>
  @<span class="hljs-title class_">Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Max</span>() - 最大值验证装饰器
   * 
   * 作用：验证数值必须小于或等于指定值
   * 
   * 参数：200 - 最大值
   * 说明：年龄不能超过 200
   * 
   * 验证链说明：
   *   1. <span class="hljs-doctag">@IsOptional</span>() - 如果字段不存在，跳过后续验证
   *   2. <span class="hljs-doctag">@IsInt</span>() - 如果字段存在，必须是整数
   *   3. <span class="hljs-doctag">@Min</span>(0) - 如果字段存在且是整数，必须 &gt;= 0
   *   4. <span class="hljs-doctag">@Max</span>(150) - 如果字段存在且是整数，必须 &lt;= 150
   * 
   * 验证顺序：从上到下依次执行，任何一个验证失败都会返回错误
   */</span>
  @<span class="hljs-title class_">Max</span>(<span class="hljs-number">200</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于200'</span> })
  age?: number;
}
</code></pre>
<p>update-user.dto.ts：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsString</span>, <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsOptional</span>, <span class="hljs-title class_">IsInt</span>, <span class="hljs-title class_">Min</span>, <span class="hljs-title class_">Max</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;

<span class="hljs-comment">/**
 * UpdateUserDto - 更新用户数据传输对象
 * 用于接收更新用户的请求数据
 * 所有字段都是可选的，因为更新时可能只更新部分字段
 * 
 * 与 CreateUserDto 的区别：
 *   - CreateUserDto: 所有必填字段都不能为空（name、email 必填）
 *   - UpdateUserDto: 所有字段都是可选的，符合 PATCH 部分更新的语义
 * 
 * 设计原则：
 *   - 部分更新：用户可以只更新需要修改的字段
 *   - 灵活性：不需要提供所有字段，只提供要更新的字段即可
 *   - 验证：如果提供了字段，则必须符合验证规则
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateUserDto</span> {

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选字段
   * 
   * 说明：更新操作中，如果客户端不提供此字段，表示不更新该字段
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsString</span>() - 如果提供了 name 字段，则必须是字符串
   * 
   * 验证逻辑：
   *   - 如果 name 未提供（undefined）：跳过验证（因为 <span class="hljs-doctag">@IsOptional</span>）
   *   - 如果 name 提供了：必须是字符串类型
   */</span>
  @<span class="hljs-title class_">IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  name?: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsEmail</span>() - 如果提供了 email 字段，则必须是有效邮箱格式
   * 
   * 说明：更新邮箱时，必须提供有效的邮箱格式
   */</span>
  @<span class="hljs-title class_">IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  email?: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsInt</span>() - 如果提供了 age 字段，则必须是整数
   */</span>
  @<span class="hljs-title class_">IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Min</span>(0) - 如果提供了 age 字段，则必须 &gt;= 0
   */</span>
  @<span class="hljs-title class_">Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Max</span>(200) - 如果提供了 age 字段，则必须 &lt;= 200
   * 
   * 验证链说明（与 CreateUserDto 相同）：
   *   1. <span class="hljs-doctag">@IsOptional</span>() - 字段可选
   *   2. 如果提供了值，则必须通过后续所有验证
   *   3. 验证顺序：IsInt -&gt; Min -&gt; Max
   */</span>
  @<span class="hljs-title class_">Max</span>(<span class="hljs-number">200</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于200'</span> })
  age?: number;
}
</code></pre>
<p>user-response.dto.ts ：</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">/**
 * UserResponseDto - 用户响应数据传输对象
 * 用于 API 响应，包含完整的用户信息
 * 
 * 作用：
 *   1. 定义 API 响应的数据结构
 *   2. 类型安全：确保响应数据的类型正确
 * 
 * 与 User 实体的区别：
 *   - User 实体：内部数据结构，可能包含敏感信息或内部字段
 *   - UserResponseDto：对外暴露的数据结构，只包含需要返回给客户端的字段
 * 
 * 最佳实践：
 *   - 使用 DTO 控制返回给客户端的数据
 *   - 可以隐藏敏感信息（如密码）
 *   - 可以格式化数据（如日期格式）
 *   - 可以添加额外的计算字段
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserResponseDto</span> {
  <span class="hljs-attr">id</span>: number;
  
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-attr">email</span>: string;

  age?: number;

  <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;

  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>;
}
</code></pre>
<p>user.entity.ts是用户实体类（数据库表映射）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Entity</span>,
  <span class="hljs-title class_">Column</span>,
  <span class="hljs-title class_">PrimaryGeneratedColumn</span>,
  <span class="hljs-title class_">CreateDateColumn</span>,
  <span class="hljs-title class_">UpdateDateColumn</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-comment">/**
 * User 实体类 - TypeORM 实体
 * 
 * 作用：
 *   1. 定义数据库表结构
 *   2. 映射数据库表到 TypeScript 类
 *   3. 提供类型安全的数据库操作
 * 
 * <span class="hljs-doctag">@Entity</span>('users') - 实体装饰器
 * 
 * 作用：标记这是一个 TypeORM 实体类
 * 参数：'users' - 数据库表名（如果不指定，默认使用类名的小写形式）
 * 
 * 说明：
 *   - TypeORM 会根据这个实体类自动创建或同步数据库表
 *   - 实体类中的属性会映射到数据库表的列
 */</span>
@<span class="hljs-title class_">Entity</span>(<span class="hljs-string">'users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@PrimaryGeneratedColumn</span>() - 主键自增列装饰器
   * 
   * 作用：定义主键列，自动生成递增的 ID
   * 
   * 说明：
   *   - 这是数据库表的主键
   *   - 自动递增，每次插入新记录时自动生成
   *   - 类型为 number，对应 MySQL 的 INT 或 BIGINT
   */</span>
  @<span class="hljs-title class_">PrimaryGeneratedColumn</span>()
  <span class="hljs-attr">id</span>: number;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 普通列装饰器
   * 
   * 作用：定义数据库表的普通列
   * 
   * 参数说明：
   *   - type: 'varchar' - 数据库列类型，varchar 是可变长度字符串
   *   - length: 255 - 最大长度
   *   - nullable: false - 不允许为空（必填字段）
   * 
   * 说明：
   *   - 如果不指定 type，TypeORM 会根据 TypeScript 类型推断
   *   - string 类型默认映射为 varchar(255)
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'varchar'</span>, <span class="hljs-attr">length</span>: <span class="hljs-number">255</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">false</span> })
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 邮箱列
   * 
   * 参数说明：
   *   - unique: true - 唯一约束，确保邮箱不重复
   *   - nullable: false - 不允许为空
   * 
   * 说明：
   *   - unique: true 会在数据库层面创建唯一索引
   *   - 如果尝试插入重复邮箱，数据库会抛出错误
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'varchar'</span>, <span class="hljs-attr">length</span>: <span class="hljs-number">255</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">false</span> })
  <span class="hljs-attr">email</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 年龄列（可选字段）
   * 
   * 参数说明：
   *   - type: 'int' - 整数类型
   *   - nullable: true - 允许为空（可选字段）
   *   - default: null - 默认值为 null
   * 
   * 说明：
   *   - 可选字段在 TypeScript 中使用 ? 标记
   *   - 数据库列也设置为 nullable: true
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'int'</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> })
  age?: number;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@CreateDateColumn</span>() - 创建时间列装饰器
   * 
   * 作用：自动管理记录的创建时间
   * 
   * 说明：
   *   - TypeORM 会在插入新记录时自动设置当前时间
   *   - 类型为 Date，对应 MySQL 的 DATETIME 或 TIMESTAMP
   *   - 不需要手动设置，TypeORM 会自动处理
   */</span>
  @<span class="hljs-title class_">CreateDateColumn</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'timestamp'</span> })
  <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@UpdateDateColumn</span>() - 更新时间列装饰器
   * 
   * 作用：自动管理记录的更新时间
   * 
   * 说明：
   *   - TypeORM 会在更新记录时自动更新为当前时间
   *   - 每次执行 UPDATE 操作时，此字段会自动更新
   *   - 不需要手动设置，TypeORM 会自动处理
   */</span>
  @<span class="hljs-title class_">UpdateDateColumn</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'timestamp'</span> })
  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>;
}


</code></pre>
<p>user.module.ts，user的模块，导入其他模块的提供者，或者导出自己的提供者给其他的模块导入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./entities/user.entity'</span>;

<span class="hljs-comment">/**
 * UserModule - 用户模块
 * 
 * 封装用户相关的所有功能：
 * - UserController: 处理用户相关的 HTTP 请求
 * - UserService: 处理用户相关的业务逻辑
 * - User Entity: 用户实体类（数据库表映射）
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Module</span>() - 模块装饰器
 * 
 * 作用：定义一个 NestJS 模块，是组织代码的基本单元
 * 
 * 参数说明：
 *   - controllers: 注册该模块中的控制器
 *     * 作用：使控制器可以处理 HTTP 请求
 *     * 说明：只有在此数组中注册的控制器才能被 NestJS 识别和处理
 * 
 *   - providers: 注册该模块中的提供者（服务、工厂等）
 *     * 作用：使服务可以被依赖注入系统管理
 *     * 说明：只有在此数组中注册的服务才能被注入使用
 *     * 注意：服务默认是单例的，整个应用共享一个实例
 * 
 *   - exports: 导出该模块中的提供者
 *     * 作用：使其他模块可以导入并使用这些提供者
 *     * 说明：
 *       - 只有导出的服务才能被其他模块使用
 *       - 如果 UserService 被导出，其他模块导入 UserModule 后就可以使用 UserService
 *       - 这是模块间共享功能的标准方式
 * 
 *   - imports: 导入其他模块
 *     * 作用：使当前模块可以使用其他模块导出的功能
 *     * 说明：例如导入 TypeOrmModule.forFeature() 可以使用数据库 Repository
 * 
 * 模块的作用：
 *   1. 代码组织：将相关功能组织在一起
 *   2. 依赖管理：管理模块内部的依赖关系
 *   3. 封装：隐藏内部实现，只暴露必要的接口
 *   4. 可复用：导出的服务可以在多个模块中复用
 * 
 * 模块的层次结构：
 *   - 根模块（AppModule）：应用的入口模块
 *   - 功能模块（如 UserModule）：封装特定功能的模块
 *   - 共享模块：提供通用功能的模块
 */</span>
@<span class="hljs-title class_">Module</span>({
  <span class="hljs-comment">/**
   * TypeOrmModule.forFeature([User]) - 注册实体到 TypeORM
   * 
   * 作用：在当前模块中注册 TypeORM 实体，使该模块可以使用 Repository
   * 
   * 参数说明：
   *   - [User] - 实体类数组，指定要在该模块中使用的实体
   * 
   * 说明：
   *   - forFeature() 必须在每个需要使用 Repository 的模块中调用
   *   - 注册后，可以在该模块的服务中注入 Repository&lt;User&gt;
   *   - 与 forRoot() 的区别：
   *     * forRoot(): 在根模块中配置数据库连接（全局配置）
   *     * forFeature(): 在功能模块中注册实体（模块级配置）
   * 
   * 使用示例：
   *   // user.service.ts
   *   constructor(
   *     <span class="hljs-doctag">@InjectRepository</span>(User)
   *     private userRepository: Repository&lt;User&gt;,
   *   ) {}
   */</span>
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">User</span>])],

  <span class="hljs-comment">/**
   * controllers - 控制器数组
   * 
   * 作用：注册该模块中的控制器
   * 说明：UserController 会被注册，可以处理 /api/users 相关的请求
   */</span>
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">UserController</span>],

  <span class="hljs-comment">/**
   * providers - 提供者数组
   * 
   * 作用：注册该模块中的服务
   * 说明：UserService 会被注册，可以在 UserController 中注入使用
   */</span>
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>],

  <span class="hljs-comment">/**
   * exports - 导出数组
   * 
   * 作用：导出 UserService，使其他模块可以导入 UserModule 并使用 UserService
   * 使用场景：
   *   - 如果其他模块（如 OrderModule）需要使用 UserService
   *   - 可以在 OrderModule 中导入 UserModule
   *   - 然后在 OrderService 中注入 UserService
   * 
   * 示例：
   *   // order.module.ts
   *   <span class="hljs-doctag">@Module</span>({
   *     imports: [UserModule], // 导入 UserModule
   *     ...
   *   })
   *   
   *   // order.service.ts
   *   constructor(private userService: UserService) {} // 可以注入使用
   */</span>
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> {}
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>以上是 Nest.js 的基础介绍及简易 CRUD 实现，这是我入门 Nest.js 的第一步，也是个人学习记录。</p>
<p>想要深入学习，可优先查阅官方文档，也可参考其他博主的文章与视频。</p>
<p>不必纠结 “学 Nest.js 为何不直接学 Java/Go”：作为前端开发者，我学习 Nest.js 的成本更低，且现阶段并非为了工作业务应用，更多是方便自己偶尔编写一些个人小Demo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么说 String 是 JavaScript 中“最安静却最危险”的类型]]></title>    <link>https://juejin.cn/post/7586587644823191586</link>    <guid>https://juejin.cn/post/7586587644823191586</guid>    <pubDate>2025-12-23T02:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644823191586" data-draft-id="7586559672129437748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么说 String 是 JavaScript 中“最安静却最危险”的类型"/> <meta itemprop="keywords" content="前端,JavaScript,程序员"/> <meta itemprop="datePublished" content="2025-12-23T02:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件求生"/> <meta itemprop="url" content="https://juejin.cn/user/1038379932466263"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么说 String 是 JavaScript 中“最安静却最危险”的类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1038379932466263/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件求生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:25:34.000Z" title="Tue Dec 23 2025 02:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>大家好，我是 31 岁、爱折腾代码、也爱把技术讲成故事的小米。</p>
<p>如果你写 JavaScript 的时间够久，一定会有一种感觉：</p>
<blockquote>
<p>JS 里最熟悉、用得最多、但又最容易被忽略的类型，就是 String。</p>
</blockquote>
<p>我们天天在用它，却很少认真“聊一聊它”。于是有一天，我在敲代码的时候突然脑补了一个画面：</p>
<blockquote>
<p><strong>String 不是字符串，它是一个庞大的“文字王国”。</strong></p>
</blockquote>
<p>今天这篇文章，我就带你跟着我，一起走进 JavaScript 的<strong>文字王国</strong>，看看 String 这个“老朋友”，到底藏了多少你可能没认真想过的秘密。</p>
<h2 data-id="heading-0">字符字面量：文字王国的“入口大门”</h2>
<p>故事要从“进城”说起。在 JavaScript 里，只要你想进入文字王国，就必须从<strong>字符字面量</strong>这几扇大门进去。</p>
<p><strong>1、三种最常见的字符字面量</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17eaef09612543e1ba37052969ae06ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=Hlcb3v%2BAXSMmisRwfF6DpCS3%2Bzw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在 JS 里，字符串可以用：</p>
<ul>
<li>双引号 "</li>
<li>单引号 '</li>
<li>反引号 `（模板字面量）</li>
</ul>
<p>我第一次学 JS 的时候，特别纠结： <strong>“老师，到底用单引号还是双引号？”</strong></p>
<p>后来工作几年才发现：<strong>JavaScript 本身不在乎，项目规范才在乎。</strong></p>
<p><strong>2、转义字符：城门的“暗号”</strong></p>
<p>如果你想在字符串里放一些“特殊角色”，就得用转义字符。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e1d4f73f2cc400683029d53d58dbbfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=T64C%2FkBq8%2FqIN30kgPY11z%2FCv4U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>常见转义字符对照表：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c688cd1eec4fa4b35421b872aecde0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=kc%2FG0nExT4E8jYt%2BT2BNuJZ4LVM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在文字王国里，<strong>反斜杠就像“通行证”，告诉 JS：后面这个字符别按原来的意思理解。</strong></p>
<h2 data-id="heading-1">字符串的特点：文字王国的“基本国法”</h2>
<p>进了城，总要先了解这个国家的基本规则。</p>
<p><strong>1、字符串是“不可变的”</strong></p>
<p>这是 String 最重要、也是最容易被忽略的一点：<strong>字符串一旦创建，就不可被修改。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/facbe3c7df89484aa42d12c80484ca25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=dt3f1MYy9wOBQWbzwydsiqA6f8U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>你以为你在改字符串，实际上 JS 在心里冷冷地对你说了一句：“对不起，本国不支持原地修改。”</p>
<p>你真正能做的，只是<strong>创建一个新字符串</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42f3646a545644f8b9a6ca85ce9a0371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=3hab4wfjHQCKUPUdHYBr2yTaGjg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>字符串就像一块已经烤好的蛋糕，你不能从中间挖一块再塞回去，你只能<strong>重新烤一块新的。</strong></p>
<p><strong>2、字符串有 length，但不是数组</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5472b6befd24af89c0aede528f1bd18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=LhIXUpTxdiNYnSAJT7P4i8QOR5E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>很多新人一看到 str[0]，就误以为字符串是数组。</p>
<p><strong>错。</strong> 字符串只是 <strong>“像数组一样可读”</strong> ，但本质不是数组。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db36915bcf544aa8a319e9ce5c27ec75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=K%2F1JKnQ4zLSh75BeDQKATeoBpec%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">转换为字符串：跨国公民的“身份转换”。</h2>
<p>在文字王国里，经常会有“外来人口”，比如：数字、布尔值、对象……他们想进城，就必须<strong>变成字符串</strong>。</p>
<p><strong>1、使用 String()</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27fd57562330497093f18e1d1d9fdcfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=ZjZIU2Agx%2B4FJjklcEwLgsONq70%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这是最安全、最通用的方式。</p>
<p><strong>2、使用 toString()</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e9a3fee69d486dbd158746cdbac086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=jvL2Acwq6iWnltPifB3GW7Yb4sk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>但要注意：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27855b2d48e4e7d85bc8a4bba9b8fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=lxRnGAuixgxy4C9oVkl%2B00bqh8I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>3、经验总结</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0738ad2d30141c0a1952de289d1ee31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=z1vWKstVQztKCPDzTmA5Cgm6qTE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>4、隐式转换（不推荐但你一定见过）</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f99955d6d3e4650a94df180c134d4ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=O96jGD0aMUqVdlsIz15ipVR%2BYIU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这是 JS 在背后偷偷做的事情。小米的忠告是：<strong>面试可以说，代码里少用。</strong></p>
<h2 data-id="heading-3">模板字面量：文字王国的“高级语法”</h2>
<p>ES6 之后，文字王国迎来了一次“技术革命”。</p>
<p><strong>1、模板字面量登场</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f828d53315640d3b07046a7b8274368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=evX%2F%2FjqcZJZ9M7ioXTnR1oKsakk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>你第一次用模板字面量时，一定会有一种感觉：“以前那堆 + 拼字符串的日子，终于结束了。”</p>
<p><strong>2、支持多行字符串</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e45161932149c5bfe5f47293e6712e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=hXKePtWfoIviFGgi2BXxkklbHCE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>不用 \n，不用拼接，<strong>写什么样，就是什么样。</strong></p>
<h2 data-id="heading-4">字符串插值：让字符串“活起来”</h2>
<p>模板字面量真正的灵魂，是<strong>字符串插值</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa4d1488a28c4dcca18c9a5139a59e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=e0k8BQbTyWGKRIpdxaWZ8JUQFcA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>${} 里：</p>
<ul>
<li>可以写变量</li>
<li>可以写表达式</li>
<li>可以写函数调用</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffba3da2d53f47ecb362535ff317d432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=C0ymmEFGvrujx1Zh5SiHfzDmB%2FE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>本质理解</strong></p>
<p>字符串插值不是“拼接字符串”，而是 <strong>“在字符串里执行 JavaScript 表达式”。</strong></p>
<h2 data-id="heading-5">模板字面量标签函数：文字王国的“翻译官”</h2>
<p>接下来这一部分，是很多人<strong>见过，但没用过，也没搞懂的高级玩法</strong>。</p>
<p><strong>1、什么是标签函数？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b9fa9b50554c31b9ffd210dc39c15f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=9jZHQ0PufzA%2F6HHew9TBGY0S7QY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eba3129b8904562aa716c98d5feeb21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=vC0KAmfTdTZOQ7g1SqmqkwMVwhM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>解释一下</strong></p>
<ul>
<li>strings：被 ${} 分割后的字符串数组</li>
<li>values：插值表达式的值</li>
</ul>
<p><strong>2、标签函数能干嘛？</strong></p>
<p>示例：防止 XSS</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d12c54fa0d54d3fb364a16b639debb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=UMD3BVx5FY6cYDqhYCE5Bqxf7Gk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>现实意义</strong></p>
<ul>
<li>模板引擎</li>
<li>SQL 构建</li>
<li>XSS 防护</li>
<li>国际化文本处理</li>
</ul>
<p>可以理解为：<strong>标签函数 = 字符串的“预处理器”。</strong></p>
<h2 data-id="heading-6">原始字符串：不被转义的“原貌文本”</h2>
<p>最后一个点，非常细，但非常有用。</p>
<p><strong>1、什么是原始字符串？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f587fa5811a940ac81981b291bb2000e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=CjNH66icLhhOWjYlWPVs8F10Qp4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>String.raw 会<strong>保留字符串的原始内容</strong>。</p>
<p><strong>2、使用场景</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a35502ba16eb4b518a5e08f0a2bf9861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=Yqzb1NkkZAk7L0cXtwbkw3J6yWE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>适合：</p>
<ul>
<li>正则表达式</li>
<li>Windows 路径</li>
<li>需要精确字符的场景</li>
</ul>
<p><strong>一句话总结</strong></p>
<p>原始字符串，就是“我写什么，你就给我什么”。</p>
<h2 data-id="heading-7">总结：String 不简单，只是你太熟了</h2>
<p>写到这里，小米想说一句掏心窝子的：</p>
<blockquote>
<p><strong>String 是 JavaScript 里最基础的类型之一，也是最容易被低估的类型之一。</strong></p>
</blockquote>
<p>你天天在用它，但真正理解它的<strong>不可变性、模板能力、标签函数</strong>之后，你会发现：</p>
<ul>
<li>代码更优雅</li>
<li>思路更清晰</li>
<li>面试也更有底气</li>
</ul>
<h2 data-id="heading-8">END</h2>
<p>我是小米，一个喜欢分享技术的31岁程序员。如果你喜欢我的文章，欢迎关注我的微信公众号“<strong>软件求生</strong>”，获取更多技术干货！</p>
<p>好朋友们，我们下篇见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Glide BitmapPool 实现原理笔记]]></title>    <link>https://juejin.cn/post/7586585688004460585</link>    <guid>https://juejin.cn/post/7586585688004460585</guid>    <pubDate>2025-12-23T02:22:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688004460585" data-draft-id="7586579021283541046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Glide BitmapPool 实现原理笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T02:22:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Glide BitmapPool 实现原理笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:22:49.000Z" title="Tue Dec 23 2025 02:22:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Glide 的 BitmapPool 实现原理分析</h2>
<h3 data-id="heading-1">1. 概述</h3>
<p>BitmapPool 是 Glide 内存优化的核心组件之一，主要目的是复用 Bitmap 内存，减少 GC 和内存分配开销，提升应用性能。</p>
<h3 data-id="heading-2">2. 主要作用</h3>
<ul>
<li><strong>减少内存分配</strong>：复用已分配的 Bitmap 内存</li>
<li><strong>降低 GC 频率</strong>：避免频繁创建和回收 Bitmap</li>
<li><strong>提升性能</strong>：减少系统级的内存分配调用</li>
<li><strong>防止 OOM</strong>：通过合理的复用策略管理内存</li>
</ul>
<h3 data-id="heading-3">3. 核心实现类：LruBitmapPool</h3>
<h4 data-id="heading-4">3.1 主要数据结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LruBitmapPool</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BitmapPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LruPoolStrategy strategy;  <span class="hljs-comment">// 存储策略</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Bitmap&gt; allowList;     <span class="hljs-comment">// 白名单（某些Bitmap不放入池）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> initialMaxSize;       <span class="hljs-comment">// 初始最大容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> maxSize;                    <span class="hljs-comment">// 当前最大容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> currentSize;                <span class="hljs-comment">// 当前已使用大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> hits, misses;               <span class="hljs-comment">// 命中统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> puts;                       <span class="hljs-comment">// 放入统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> evictions;                  <span class="hljs-comment">// 驱逐统计</span>
}
</code></pre>
<h4 data-id="heading-5">3.2 存储策略（LruPoolStrategy）</h4>
<p>根据 Android 版本使用不同策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 4.4+ 使用 SizeConfigStrategy</span>
<span class="hljs-keyword">static</span> LruPoolStrategy <span class="hljs-title function_">getDefaultStrategy</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SizeConfigStrategy</span>();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeStrategy</span>();
    }
}
</code></pre>
<p><strong>SizeConfigStrategy（Android 4.4+）：</strong></p>
<ul>
<li>按 Bitmap 配置（ARGB_8888, RGB_565等）和大小分组</li>
<li>使用 <code>GroupedLinkedMap</code> 存储相同配置的 Bitmap</li>
<li>支持复用更大尺寸的 Bitmap（需重新配置）</li>
</ul>
<p><strong>AttributeStrategy（Android 4.4以下）：</strong></p>
<ul>
<li>按 width、height、config 精确匹配</li>
<li>使用简单 HashMap 存储</li>
</ul>
<h3 data-id="heading-6">4. 关键方法实现</h3>
<h4 data-id="heading-7">4.1 get() - 获取 Bitmap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Bitmap <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, Bitmap.Config config)</span> {
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getDirtyOrNull(width, height, config);
    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 清零Bitmap数据</span>
        result.eraseColor(Color.TRANSPARENT);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 池中没有合适的，创建新的</span>
        result = createBitmap(width, height, config);
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">private</span> Bitmap <span class="hljs-title function_">getDirtyOrNull</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, Bitmap.Config config)</span> {
    <span class="hljs-comment">// 1. 参数校验</span>
    Preconditions.checkArgument(width &gt; <span class="hljs-number">0</span> &amp;&amp; height &gt; <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 获取合适的Bitmap</span>
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> strategy.get(width, height, config);
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
        misses++;
    } <span class="hljs-keyword">else</span> {
        hits++;
        currentSize -= strategy.getSize(result);
        <span class="hljs-comment">// 从allowList移除</span>
        allowList.remove(result);
        <span class="hljs-comment">// 重新配置Bitmap</span>
        normalize(result);
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-8">4.2 put() - 放入 Bitmap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Bitmap bitmap)</span> {
    <span class="hljs-comment">// 1. 参数校验</span>
    Preconditions.checkNotNull(bitmap);
    Preconditions.checkArgument(bitmap.isMutable());
    Preconditions.checkArgument(bitmap.getWidth() &gt; <span class="hljs-number">0</span> 
        &amp;&amp; bitmap.getHeight() &gt; <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 计算大小并尝试放入</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> strategy.getSize(bitmap);
    strategy.put(bitmap);
    puts++;
    currentSize += size;
    
    <span class="hljs-comment">// 3. 执行LRU清理</span>
    evict();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">evict</span><span class="hljs-params">()</span> {
    trimToSize(maxSize);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trimToSize</span><span class="hljs-params">(<span class="hljs-type">long</span> size)</span> {
    <span class="hljs-keyword">while</span> (currentSize &gt; size) {
        <span class="hljs-comment">// 移除最近最少使用的Bitmap</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Bitmap</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> strategy.removeLast();
        <span class="hljs-keyword">if</span> (removed == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">break</span>;
        }
        currentSize -= strategy.getSize(removed);
        removed.recycle();
        evictions++;
    }
}
</code></pre>
<h3 data-id="heading-9">5. 内存管理策略</h3>
<h4 data-id="heading-10">5.1 大小计算</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBitmapByteSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, 
                                     Bitmap.Config config)</span> {
    <span class="hljs-keyword">return</span> width * height * getBytesPerPixel(config);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBytesPerPixel</span><span class="hljs-params">(Bitmap.Config config)</span> {
    <span class="hljs-keyword">switch</span> (config) {
        <span class="hljs-keyword">case</span> ARGB_8888:
            <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
        <span class="hljs-keyword">case</span> RGB_565:
        <span class="hljs-keyword">case</span> ARGB_4444:
            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
        <span class="hljs-keyword">case</span> ALPHA_8:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
}
</code></pre>
<h4 data-id="heading-11">5.2 自适应大小调整</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSizeMultiplier</span><span class="hljs-params">(<span class="hljs-type">float</span> sizeMultiplier)</span> {
    maxSize = Math.round(initialMaxSize * sizeMultiplier);
    evict();  <span class="hljs-comment">// 调整后立即清理</span>
}
</code></pre>
<h3 data-id="heading-12">6. 与 Glide 其他组件的协作</h3>
<h4 data-id="heading-13">6.1 与 MemoryCache 的关系</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在Engine中协调使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EngineJobListener</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MemoryCache memoryCache;  <span class="hljs-comment">// 存储解码后的图片</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BitmapPool bitmapPool;    <span class="hljs-comment">// 存储可复用的Bitmap内存</span>
    
    <span class="hljs-comment">// 当从MemoryCache移除时，放入BitmapPool</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResourceReleased</span><span class="hljs-params">(Key key, Resource resource)</span> {
        <span class="hljs-keyword">if</span> (resource.isCacheable()) {
            memoryCache.put(key, resource);
        } <span class="hljs-keyword">else</span> {
            bitmapPool.put(resource.get().getBitmap());
        }
    }
}
</code></pre>
<h4 data-id="heading-14">6.2 与 Downsampler 的协作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Downsampler使用BitmapPool复用内存</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">decodeStream</span><span class="hljs-params">(InputStream is, BitmapPool pool, 
                                   DecodeFormat decodeFormat)</span> {
    <span class="hljs-comment">// 从pool获取Bitmap</span>
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pool.get(options.outWidth, options.outHeight, 
                            options.inPreferredConfig);
    <span class="hljs-comment">// 解码到复用的Bitmap中</span>
    <span class="hljs-keyword">return</span> BitmapFactory.decodeStream(is, <span class="hljs-literal">null</span>, options);
}
</code></pre>
<h3 data-id="heading-15">7. 性能优化技巧</h3>
<h4 data-id="heading-16">7.1 Bitmap 复用条件</h4>
<ol>
<li><strong>Mutable</strong>：必须是可变的 Bitmap</li>
<li><strong>Size &gt;= Requested</strong>：尺寸必须大于等于请求尺寸</li>
<li><strong>Config Compatible</strong>：配置兼容（可向下兼容）</li>
<li><strong>Reusable</strong>：Android 4.4+ 支持复用任意配置的 Bitmap</li>
</ol>
<h4 data-id="heading-17">7.2 配置建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在GlideModule中配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyGlideModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlideModule</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyOptions</span><span class="hljs-params">(Context context, GlideBuilder builder)</span> {
        <span class="hljs-comment">// 根据设备内存动态设置</span>
        <span class="hljs-type">ActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> (ActivityManager) 
            context.getSystemService(Context.ACTIVITY_SERVICE);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLargeHeap</span> <span class="hljs-operator">=</span> (context.getApplicationInfo().flags 
            &amp; ApplicationInfo.FLAG_LARGE_HEAP) != <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">memoryCacheSize</span> <span class="hljs-operator">=</span> isLargeHeap ? <span class="hljs-number">256</span> : <span class="hljs-number">128</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">bitmapPoolSize</span> <span class="hljs-operator">=</span> isLargeHeap ? <span class="hljs-number">128</span> : <span class="hljs-number">64</span>;
        
        builder.setMemoryCache(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruResourceCache</span>(memoryCacheSize * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
        builder.setBitmapPool(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruBitmapPool</span>(bitmapPoolSize * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
    }
}
</code></pre>
<h3 data-id="heading-18">8. 注意事项</h3>
<ol>
<li><strong>线程安全</strong>：<code>LruBitmapPool</code> 使用 <code>synchronized</code> 保证线程安全</li>
<li><strong>内存计算</strong>：精确计算 Bitmap 内存占用</li>
<li><strong>配置兼容</strong>：注意不同 Android 版本的差异</li>
<li><strong>白名单机制</strong>：某些特殊 Bitmap 不放入池中</li>
</ol>
<h3 data-id="heading-19">9. 总结</h3>
<p>Glide 的 BitmapPool 通过精妙的 LRU 策略和版本适配，实现了高效的 Bitmap 内存复用：</p>
<ul>
<li><strong>减少 80%+ 的 Bitmap 分配</strong>：显著降低 GC 压力</li>
<li><strong>智能匹配策略</strong>：根据配置和尺寸灵活复用</li>
<li><strong>动态内存管理</strong>：根据应用状态调整池大小</li>
<li><strong>版本兼容</strong>：适配不同 Android 版本的特性</li>
</ul>
<p>这种设计使得 Glide 在加载大量图片时仍能保持流畅的性能和低内存占用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三步高效拆解顶刊论文]]></title>    <link>https://juejin.cn/post/7586587644823257122</link>    <guid>https://juejin.cn/post/7586587644823257122</guid>    <pubDate>2025-12-23T02:33:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644823257122" data-draft-id="7586569284551409704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三步高效拆解顶刊论文"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-23T02:33:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三步高效拆解顶刊论文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:33:08.000Z" title="Tue Dec 23 2025 02:33:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我在社区发起了一个关于“内容偏好”的投票，结果既在意料之外，又在情理之中。我问大家：是更倾向于“三分钟快速听完论文概要”，还是愿意花“一小时深度解析一篇论文”？</p>
<p>结果<strong>77%的同学选择了后者——深度解析</strong>。但更让我惊喜且感动的，是评论区里大量涌现的另一种声音。许多小伙伴留言说：“其实具体的论文内容只是其次，我真正渴望的是掌握那套‘读论文的方法论’。我希望你能说说你是怎么阅读论文的，让我下一次面对陌生论文时不再迷茫。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26ac874e1a84a199fb75671597951c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061988&amp;x-signature=KnpQ%2FJe9sZGxw1j%2BSAJUFHu0KDY%3D" alt="" loading="lazy"/></p>
<p>这正是人们常说的“授人以鱼不如授人以渔”。既然大家有这样的觉悟和求知欲，今天我就暂缓具体的算法讲解，专门来聊聊**“如何像审稿人一样高效阅读一篇学术论文”**。掌握这项技能，是你从被动接收知识转向主动探索科研边界的关键一步。</p>
<h3 data-id="heading-0"><strong>一、 解构论文：理解学术界的“八股文”范式</strong></h3>
<p>在深入方法论之前，我们必须先理解对手——论文本身的结构。现在的理工科论文，尤其是计算机（CS）领域的顶会论文，几乎都遵循着一套严格的<strong>IMRaD结构</strong>（Introduction, Methods, Results, and Discussion），也就是我们俗称的“学术八股文”。</p>
<p>这并非死板，而是为了科学交流的效率。一篇标准的论文通常包含以下模块：</p>
<ol>
<li><strong>Title（标题）：</strong> 浓缩的核心贡献。</li>
<li><strong>Abstract（摘要）：</strong> 整个故事的“预告片”。</li>
<li><strong>Introduction（介绍）：</strong> 类似电影的“导演阐述”，交代背景、动机和贡献。</li>
<li><strong>Related Work（相关工作）：</strong> 梳理学术坐标系，明确自己在前人基础上的位置。</li>
<li><strong>Method（方法）：</strong> 核心算法与模型构建，这是论文的心脏。</li>
<li><strong>Experiments（实验）：</strong> 用数据证明“心脏”跳动得很有力，这部分包含大量图表。</li>
<li><strong>Conclusion（结论）：</strong> 总结陈词与未来展望。</li>
</ol>
<p>这种结构化写作意味着我们<strong>完全不需要从头读到尾</strong>。如果你像读小说一样逐字阅读，不仅效率低下，更容易陷入细节的泥潭。</p>
<h3 data-id="heading-1"><strong>二、 为什么你需要“过滤”而非“全读”？</strong></h3>
<p>根据arXiv的数据显示，仅在人工智能领域，每天新上传的论文就数以百计。 <strong>“信息过载”是科研人员面临的最大痛点。</strong> 在海量文献中，真正值得你精读的文章可能只是沧海一粟。</p>
<p>因此，我们需要一种“漏斗式”<strong>的阅读策略：通过层层筛选，快速剔除无关信息，将宝贵的精力集中在高价值目标上。这也就是我今天要分享的核心技术——</strong> “三步阅读法”（The Three-Pass Approach）。</p>
<h3 data-id="heading-2"><strong>三、 实战演练：三步法详解</strong></h3>
<h4 data-id="heading-3"><strong>第一步：海选与鸟瞰（The Scanner）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 在10-15分钟内，判断这篇文章是否值得读下去，评估其相关性与质量。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li><strong>审视标题（Title）：</strong> 判断它是否属于你的研究领域。</li>
<li><strong>细读摘要（Abstract）：</strong> 了解作者声称解决了什么问题。</li>
<li><strong>直奔结论（Conclusion）：</strong> 这是一个关键技巧。摘要通常是“画饼”，而结论是“上菜”。结论部分往往会把摘要里提出的问题，用更确凿的实验数据和结果进行呼应。对比首尾，你就能大致判断文章的完成度。</li>
<li><strong>扫描图表（Glance over Figures）：</strong> 快速翻阅实验部分的图表。虽然不需要看懂细节，但通过图表的绘制质量、数据量级，你可以直观感受作者的治学态度和工作量。</li>
</ol>
</li>
<li>
<p>**决策时刻：**读完这几部分，你就要做决定了——<strong>Pass（放弃）还是</strong>Go（继续）？如果不感兴趣或发现质量低劣，直接丢弃，不要浪费时间。如果觉得有点意思，但现在没空，可以先加入文献库。如果觉得很有价值，那就进入第二步。</p>
</li>
</ul>
<h4 data-id="heading-4"><strong>第二步：抓取骨架与逻辑（The Reader）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 掌握文章的核心内容和逻辑流，但暂时忽略繁琐的数学证明和技术细节。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li>**通读全文（不求甚解）：**从头到尾阅读，但遇到复杂的公式推导、晦涩的证明细节时，<strong>请大胆跳过</strong>。这一步的重点是“懂逻辑”，而不是“扣细节”。</li>
<li><strong>图表即真理：</strong> 这是第二步的重中之重。文字可能会有修饰，但图表是诚实的。你要仔细看图表的X轴、Y轴分别代表什么？图中的每个数据点意味着什么？作者的方法（通常是红线或蓝线）相比Baseline（基线）提升了多少？差距是否显著？</li>
<li><strong>标注“知识盲区”：在阅读Introduction和Related Work时，作者会引用大量前人的工作（如“基于Smith等人的方法...”）。如果你发现某些被反复引用的</strong>关键文献你没读过，一定要把它们圈出来。</li>
</ol>
</li>
<li>
<p><strong>决策时刻：</strong> 这一步读完，你可能还是有些懵，这很正常。此时你有三个选择：</p>
<ul>
<li><strong>放弃：</strong> 发现内容虽好，但对自己当前的研究帮助不大。</li>
<li><strong>回溯：发现读不懂是因为基础薄弱。这时你应该</strong>暂停阅读本文，去补读刚才圈出来的那些引用的参考文献（Background Papers）。这叫“磨刀不误砍柴工”，读完前置知识再回来，门槛会低很多。</li>
<li><strong>精读：</strong> 觉得文章太棒了，必须彻底搞懂，那就进入第三步。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5"><strong>第三步：虚拟重现与批判（The Reviewer）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 达到“重构级”理解。不仅知道作者做了什么，还要知道他为什么这么做，以及如果是你，你会怎么做。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li>
<p><strong>虚拟复现（Virtual Re-implementation）：这是最高阶的读法。在读每一段、每一个公式时，强迫大脑进行</strong>“脑补模拟”。</p>
<ul>
<li>看到问题定义，掩卷思考：“如果是我，我会用什么方法解决？”</li>
<li>看到作者的方法，对比思考：“我的方案和他的有什么不同？为什么他选了这个？”</li>
<li>看到实验设置，批判思考：“他的实验有没有漏洞？如果我来做，能不能设计得更严谨？甚至能不能得到更好的结果？”</li>
</ul>
</li>
<li>
<p><strong>挖掘隐藏细节：</strong> 关注作者提到的那些“失败的尝试”或“未来的工作”，这些往往是后续研究的突破口。</p>
</li>
</ol>
</li>
<li>
<p><strong>最终成果：</strong> 经过这炼狱般的第三步，你应该能够做到：</p>
<ul>
<li>在脑海中完整复述文章的细节。</li>
<li>清楚其优缺点（Gap）。</li>
<li>甚至可以直接基于此复现代码或开启新的研究。</li>
</ul>
</li>
</ul>
<hr/>
<p>这套“三步法”的核心在于<strong>时间精力的非线性分配</strong>：</p>
<ul>
<li><strong>第一步是“海选”</strong> ，用最少的时间（~10分钟）筛选掉90%的噪音；</li>
<li><strong>第二步是“精选”</strong> ，梳理逻辑，构建知识网络；</li>
<li><strong>第三步是“研读”</strong> ，只有极少数对你最重要的论文才配得上这个待遇。</li>
</ul>
<p>优秀的读者不是被动接受信息，而是与作者进行深度对话。当你能够自然地在"三步阅读法"间灵活切换时，你就掌握了开启学术宝库的钥匙。正如诺贝尔物理学奖得主Richard Feynman所说："如果你不能向大一学生解释清楚一个概念，说明你自己也没有真正理解它。"而这种理解深度，正是通过结构化的深度阅读获得的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[Filter-Dither节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7586588823905648649</link>    <guid>https://juejin.cn/post/7586588823905648649</guid>    <pubDate>2025-12-23T02:39:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905648649" data-draft-id="7586575372621905929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[Filter-Dither节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-23T02:39:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[Filter-Dither节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:39:51.000Z" title="Tue Dec 23 2025 02:39:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">抖动技术基础概念</h2>
<p>抖动技术是一种通过引入伪随机噪声来优化量化误差的数字图像处理方法。当颜色深度不足时，图像中容易产生明显的色带现象，而抖动技术能够将这些色带分解为更细微的图案，从而获得更加平滑自然的视觉效果。在Unity ShaderGraph中，Dither节点专门用于在屏幕空间应用此类技术，通过特定的算法模式确保噪声均匀分布。</p>
<p>在实时渲染领域，抖动技术不仅用于改善颜色过渡，还广泛应用于透明度处理、阴影渲染和后期处理效果。</p>
<h2 data-id="heading-1">Dither节点核心架构</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/DitherNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">端口配置与数据类型</h3>
<p>Dither节点包含三个主要端口，各自承担特定的功能：</p>
<ul>
<li><strong>In端口</strong>：作为动态矢量输入，接收待处理的数值。该端口通常连接Alpha通道值，也可用于处理颜色矢量或其他需要抖动的数据。</li>
<li><strong>Screen Position端口</strong>：输入Vector 4类型的屏幕空间坐标，是抖动模式定位的关键依据。该端口默认绑定至屏幕位置，确保抖动图案能够基于像素位置正确分布。</li>
<li><strong>Out端口</strong>：输出经过抖动处理后的动态矢量结果，其数据类型与输入保持一致。</li>
</ul>
<h3 data-id="heading-3">算法实现原理</h3>
<p>Dither节点采用16阶Floyd-Steinberg抖动算法，这是一种经典的有序抖动技术。该算法通过预定义的阈值矩阵决定像素的量化方式，在有限颜色深度下实现最佳视觉表现。</p>
<p>核心算法流程如下：首先将屏幕坐标转换为纹理坐标，随后根据像素位置在4x4阈值矩阵中选择对应阈值。该矩阵包含16个均匀分布在0到1范围内的数值，确保抖动图案的周期性与均匀性。</p>
<h2 data-id="heading-4">URP渲染管线中的ShaderGraph环境</h2>
<h3 data-id="heading-5">渲染管线基础</h3>
<p>在深入探讨Dither节点之前，需了解Unity的渲染管线架构。目前Unity主要支持以下三种渲染管线：</p>
<ul>
<li><strong>内置渲染管线</strong>：Unity最早的渲染系统，功能基础但稳定可靠。</li>
<li><strong>可编程渲染管线</strong>：通过C#脚本控制渲染流程的高级技术，为URP和HDRP提供底层支持。</li>
<li><strong>通用渲染管线</strong>：专为多平台优化设计的现代化渲染方案，尤其适用于移动设备及中等性能要求的平台。</li>
</ul>
<h3 data-id="heading-6">ShaderGraph配置要求</h3>
<p>使用Dither节点前需确保项目正确配置URP渲染管线。创建新的ShaderGraph时，应选择URP模板以保证所有节点与功能正常可用。URP不仅提供更优的性能表现，还确保着色器在不同设备上的一致性。</p>
<h2 data-id="heading-7">Dither节点详细参数解析</h2>
<h3 data-id="heading-8">输入参数详解</h3>
<p>In输入端接收的动态矢量可为多种数据类型，具体取决于前续节点的输出。实际应用中，最常见的配置是将Float值连接至In端口，用于控制透明度阈值。</p>
<p>Screen Position输入通常保持默认连接，但在特定情况下可能需要自定义屏幕坐标。例如，当需要基于特定UV坐标或对象空间位置应用抖动时，可断开默认连接并接入自定义位置数据。</p>
<h3 data-id="heading-9">阈值控制与参数调节</h3>
<p>Dither节点的效果主要通过阈值参数控制。在实现半透明效果时，通常会创建Float参数作为Dither值，其显示范围一般设置在剪切阈值至1之间。通过动态调整此参数，可实现基于距离的透明度变化或其他动画效果。</p>
<h2 data-id="heading-10">实践应用：半透明效果实现</h2>
<h3 data-id="heading-11">基础设置流程</h3>
<p>创建基于Dither节点的半透明效果需遵循以下步骤：</p>
<ul>
<li>新建Unlit ShaderGraph并创建对应材质</li>
<li>在Graph Setting中启用Alpha Clipping功能</li>
<li>添加Dither节点并将其输出连接至Alpha Clip Threshold</li>
<li>配置阈值参数与Dither参数以实现期望的透明度范围</li>
</ul>
<h3 data-id="heading-12">菲涅尔效应结合</h3>
<p>将Dither节点与Fresnel节点结合可创建更自然的半透明效果。菲涅尔效应模拟物体边缘与中心反射率的差异，结合抖动技术后，能产生基于视角的透明度变化，特别适用于角色渲染与特效制作。</p>
<p>实现方法：创建Fresnel节点并将其输出与颜色参数相乘，随后将结果连接至Base Color，同时将Dither节点输出连接至Alpha Clip Threshold。</p>
<h3 data-id="heading-13">动态效果控制</h3>
<p>通过脚本控制Dither参数可实现动态半透明效果。例如，根据摄像机与角色的距离动态调整Dither值，当摄像机靠近时角色逐渐变为半透明，有效避免摄像机穿帮现象。</p>
<h2 data-id="heading-14">高级应用场景</h2>
<h3 data-id="heading-15">屏幕空间抖动优化</h3>
<p>Dither节点在屏幕空间的应用确保抖动图案均匀分布，这对避免重复性图案与保持视觉一致性至关重要。理解屏幕坐标与抖动阈值的关系，有助于开发者实现更精细的视觉效果。</p>
<h3 data-id="heading-16">延迟渲染兼容性</h3>
<p>在延迟渲染管线中，传统透明度处理常面临诸多限制。使用Dither节点模拟透明度效果具有显著优势，因为经抖动处理的表面仍作为不透明对象渲染，能够正常写入深度缓冲区并参与延迟光照计算。</p>
<h3 data-id="heading-17">性能优化技术</h3>
<p>相比真正的透明度渲染，Dither节点具备更优的性能表现。它有效规避了透明度排序问题，减少overdraw，同时在视觉上提供相近的体验，特别适合大规模使用半透明效果的场景。</p>
<h2 data-id="heading-18">技术实现深度解析</h2>
<h3 data-id="heading-19">算法代码分析</h3>
<p>生成的HLSL代码揭示了Dither节点的内部工作机制。核心算法包含三个主要部分：坐标转换、阈值矩阵定义与索引计算。这种实现方式确保了高效的运行性能与一致的视觉效果。</p>
<p>阈值矩阵的设计基于数学上的最优分布，16个阈值经过精心计算，确保在各种情况下均能产生自然的抖动效果。每个阈值对应4x4像素块中的特定位置，通过模运算确定当前像素应使用的阈值。</p>
<h3 data-id="heading-20">自定义扩展可能性</h3>
<p>尽管Dither节点提供标准化的抖动功能，开发者仍可通过Custom Function节点实现自定义抖动算法。这为特殊需求的应用场景提供了灵活性，允许根据项目要求调整抖动模式或阈值分布。</p>
<h2 data-id="heading-21">常见问题与解决方案</h2>
<h3 data-id="heading-22">性能瓶颈识别</h3>
<p>使用Dither节点时可能遭遇性能问题，尤其在低端设备上。通过合理配置阈值范围与优化节点连接，可在保持视觉效果的同时最小化性能开销。</p>
<h3 data-id="heading-23">视觉瑕疵处理</h3>
<p>不当的抖动参数设置可能导致视觉瑕疵，如过于明显的噪声图案或不自然的边缘。通过细致调整阈值并测试不同场景下的表现，可找到最佳参数组合。</p>
<h2 data-id="heading-24">实际项目集成指南</h2>
<h3 data-id="heading-25">材质参数配置</h3>
<p>在项目中使用Dither节点时，合理的材质参数配置至关重要。Dither参数的默认值通常设为1，而Threshold参数则用于控制Alpha剪切的具体阈值。</p>
<h3 data-id="heading-26">脚本控制接口</h3>
<p>通过C#脚本动态控制Dither参数可实现更具交互性的视觉效果。典型应用包括基于游戏状态的透明度变化、角色特殊状态指示与环境交互反馈。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Rules & MCP 抄作业（附samples）]]></title>    <link>https://juejin.cn/post/7586582977708097578</link>    <guid>https://juejin.cn/post/7586582977708097578</guid>    <pubDate>2025-12-23T02:30:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977708097578" data-draft-id="7584203412197261338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Rules &amp; MCP 抄作业（附samples）"/> <meta itemprop="keywords" content="前端,OpenAI"/> <meta itemprop="datePublished" content="2025-12-23T02:30:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一颗奇趣蛋"/> <meta itemprop="url" content="https://juejin.cn/user/998776344173454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Rules &amp; MCP 抄作业（附samples）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/998776344173454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一颗奇趣蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:30:57.000Z" title="Tue Dec 23 2025 02:30:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>给“完全零基础”的小伙伴讲清楚两件事：</p>
<ol>
<li>最近很火的 MCP（Model Context Protocol）到底是什么？</li>
<li>经常听说的 “AI Rules” 又是啥？</li>
</ol>
<p>下面用“人话+例子+一步一步可抄的作业”讲明白，最后再来一张对照表，保证看完就能上手。</p>
<hr/>
<p>一、MCP：把 AI 变成“万能瑞士军刀”的插线板</p>
<ol>
<li>
<p>一句话定义<br/>
MCP = 给大模型用的“USB-C 插线板”。只要软件/数据/硬件按这个插线板做一个小接头（MCP Server），任何支持 MCP 的 AI（Claude Desktop、Cursor…）就能即插即用，不用每家单独开发插件 。</p>
</li>
<li>
<p>生活例子<br/>
你男朋友（LLM）会聊天，但不会点外卖。<br/>
过去：你想吃 KFC，得自己写代码教会他下单。<br/>
现在：KFC 官方做了一个“MCP 接头”，男朋友连上后马上知道“哦，原来 get_menu() 可以查菜单，order() 可以下单”，直接帮你点好 。</p>
</li>
<li>
<p>最小可运行 Demo（10 行代码，复制就能跑）<br/>
场景：让 AI 帮你算“打车花了多少钱”。<br/>
① 安装<br/>
npm install -g @modelcontextprotocol/sdk</p>
</li>
</ol>
<p>② 新建 fare.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">FastMCPServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@modelcontextprotocol/sdk'</span>);
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastMCPServer</span>(<span class="hljs-string">'fare-server'</span>, <span class="hljs-string">'1.0.0'</span>);
server.<span class="hljs-title function_">addTool</span>(<span class="hljs-string">'calc_fare'</span>, <span class="hljs-string">'计算打车费'</span>,
  { <span class="hljs-attr">km</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> } },
  <span class="hljs-keyword">async</span> (args) =&gt; {
    <span class="hljs-keyword">const</span> fee = args.<span class="hljs-property">km</span> * <span class="hljs-number">2.3</span> + <span class="hljs-number">10</span>;   <span class="hljs-comment">// 2.3元/公里 + 10元起步价</span>
    <span class="hljs-keyword">return</span> { fee };
  });
server.<span class="hljs-title function_">start</span>();
</code></pre>
<p>③ 给 Claude Desktop 加一条配置（settings → MCP → Add）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"fare"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/fare.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>④ 重启 Claude，聊天框直接说：<br/>
“帮我算 12 公里打车费”<br/>
→ Claude 自动调用 calc_fare，返回答案 37.6 元。<br/>
你就拥有了一个“打车计算器” MCP Server ！</p>
<hr/>
<p>二、AI Rules：给 AI 的“员工手册”</p>
<ol>
<li>
<p>一句话定义<br/>
AI Rules = 存在 GitHub（或本地）的一份“行为守则”，AI 每次开工前先读一遍，保证代码风格、变量命名、安全规范全部统一 。</p>
</li>
<li>
<p>生活例子<br/>
公司新来的实习生（AI）代码风格千奇百怪。<br/>
你把“React 项目规范”写成 rules.md 放到 GitHub，<br/>
AI 每次写组件前自动拉取这份手册，从此 tab 宽度、命名、目录结构全部一致，再也不用手动 code review 低级问题 。</p>
</li>
<li>
<p>最小可运行 Demo（5 分钟搭好）<br/>
① 在 GitHub 建个空仓库，放一条规则文件<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Fai-rules%2Fblob%2Fmain%2Freact.md" target="_blank" title="https://github.com/yourname/ai-rules/blob/main/react.md" ref="nofollow noopener noreferrer">github.com/yourname/ai…</a><br/>
内容示例：</p>
</li>
</ol>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 组件名必须 PascalCase  </span>
<span class="hljs-deletion">- 统一使用 TypeScript 严格模式  </span>
<span class="hljs-deletion">- 禁止 any 类型</span>
</code></pre>
<p>② 本地安装 Agent-Rules MCP Server<br/>
npm install -g agent-rules-mcp</p>
<p>③ 启动（把仓库地址告诉它）<br/>
export RULES_REPO=yourname/ai-rules<br/>
agent-rules-mcp</p>
<p>④ 在 Cursor 的 .cursorrules 里加一句</p>
<pre><code class="hljs language-ini" lang="ini">mcp://agent-rules/get_rules?<span class="hljs-attr">project</span>=react
</code></pre>
<p>⑤ 以后在 Cursor 写代码时输入<br/>
“写一个按钮组件”<br/>
→ AI 会先拉取 react.md，生成的代码自动符合 PascalCase、TypeScript、无 any 类型 。</p>
<hr/>
<p>三、横向对比一张表</p>


















































<table><thead><tr><th>维度</th><th>MCP</th><th>AI Rules</th></tr></thead><tbody><tr><td>本质</td><td>让 AI“能干什么”的插线板协议</td><td>告诉 AI“怎么干”的员工手册</td></tr><tr><td>解决痛点</td><td>不同工具/数据接口碎片化；重复开发插件</td><td>项目间规范不统一；AI 输出风格混乱</td></tr><tr><td>谁提供内容</td><td>第三方服务商/你自己写的 MCP Server</td><td>你自己写的 markdown/txt 规则文件</td></tr><tr><td>存放位置</td><td>本地或远程 MCP Server</td><td>GitHub 仓库、本地文件、Gist 均可</td></tr><tr><td>更新方式</td><td>Server 升级即可，AI 端零改动</td><td>改规则文件，AI 下次自动拉取最新版</td></tr><tr><td>典型操作</td><td>“查天气”“下单”“读数据库”</td><td>“组件命名用 PascalCase”“变量前缀用 $”</td></tr><tr><td>见效速度</td><td>配置好立即多出 N 个新能力</td><td>配置好立即输出符合规范代码</td></tr><tr><td>学习成本</td><td>需写 10~30 行 JS/Python 做 Server</td><td>只需写 markdown，0 代码</td></tr></tbody></table>
<hr/>
<p>四、10 分钟速通清单（直接照做）</p>
<ol>
<li>装 Claude Desktop 或 Cursor（已有可跳过）。</li>
<li>跑一遍“打车费” MCP Server，体会“AI 瞬间多出新技能”。</li>
<li>把公司/项目现有规范 copy 到 GitHub，搭一个 AI Rules 仓库。</li>
<li>在编辑器里引用规则，让 AI 写一段代码，肉眼可见风格统一。</li>
<li>邀请同事：以后谁再手动改 tab 宽度，就请他去写 MCP Server 冷静一下 😉</li>
</ol>
<hr/>
<p>一句话总结<br/>
MCP 负责“让 AI 多长手脚”，AI Rules 负责“让 AI 别乱来”。<br/>
两个都不难，10 分钟就能各跑通一个最小例子；合起来用，AI 既厉害又听话。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentScope Java 核心架构深度解析]]></title>    <link>https://juejin.cn/post/7586504691846119433</link>    <guid>https://juejin.cn/post/7586504691846119433</guid>    <pubDate>2025-12-23T00:35:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586504691846119433" data-draft-id="7586482860104679451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentScope Java 核心架构深度解析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:35:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不被AI替代的BOT"/> <meta itemprop="url" content="https://juejin.cn/user/151049544663532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentScope Java 核心架构深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/151049544663532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不被AI替代的BOT
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:35:09.000Z" title="Tue Dec 23 2025 00:35:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AgentScope Java 核心架构深度解析：从零到生产级的智能体框架</h2>
<h3 data-id="heading-1">摘要</h3>
<p>AgentScope Java 是一个面向生产环境的智能体编程框架，它巧妙地将大语言模型的推理能力、工具调用、记忆管理和多智能体协作整合在一起。本文将从架构设计者的视角，深入剖析这个框架的核心机制，看看它是如何让开发者用几行代码就能构建出具备自主决策能力的 AI 智能体的。我们会从 ReAct 推理循环、工具系统、记忆管理、多智能体协作和生产就绪特性这五个维度，逐一拆解其实现原理。
<img src="http://openwrite.cn/uploads/19881/57635/128a28b9-9816-4dc4-bcc4-4970398497a4.png" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">1. 入口类与核心架构</h3>
<h4 data-id="heading-3">1.1 入口类：ReActAgent</h4>
<p>AgentScope 的核心入口是 <code>ReActAgent</code>，这是框架中最常用的智能体实现。它采用建造者模式，让配置变得非常直观：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Assistant"</span>)
    .sysPrompt(<span class="hljs-string">"You are a helpful assistant."</span>)
    .model(DashScopeChatModel.builder()
        .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .modelName(<span class="hljs-string">"qwen-plus"</span>)
        .build())
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>())
    .maxIters(<span class="hljs-number">10</span>)
    .build();
</code></pre>
<p>从代码结构来看，<code>ReActAgent</code> 继承自 <code>AgentBase</code>，而 <code>AgentBase</code> 又实现了 <code>Agent</code> 接口。这种设计让框架既保证了灵活性，又提供了统一的基础能力。</p>
<h4 data-id="heading-4">1.2 核心类关系图</h4>
<p><img src="http://openwrite.cn/uploads/19881/57635/1bd1c55f-37ca-4ec0-9d7d-72a588a2f311.png" alt="image.png" loading="lazy"/></p>
<p>从类图可以看出，整个框架采用了清晰的层次结构：</p>
<ul>
<li><strong>Agent 接口</strong>：定义了智能体的基本契约</li>
<li><strong>AgentBase</strong>：提供基础设施（Hook、中断、状态管理）</li>
<li><strong>ReActAgent</strong>：实现具体的 ReAct 循环逻辑</li>
<li><strong>Toolkit</strong>：管理工具注册和执行</li>
<li><strong>Memory</strong>：管理对话历史</li>
</ul>
<h3 data-id="heading-5">2. ReAct 推理循环：智能体的"思考-行动"机制</h3>
<h4 data-id="heading-6">2.1 ReAct 循环流程</h4>
<p>ReAct（Reasoning and Acting）是 AgentScope 的核心模式，它让智能体能够在推理和行动之间循环，直到完成任务或达到最大迭代次数。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/327040d3-e51c-4b2d-8841-f8832841604e.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 关键技术点</h4>
<p><strong>Pipeline 模式</strong>：框架将推理和行动阶段分别封装成 <code>ReasoningPipeline</code> 和 <code>ActingPipeline</code>，每个 Pipeline 负责一个阶段的完整流程。这样做的好处是职责清晰，易于扩展和维护。</p>
<p>看一段核心代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Mono&lt;Msg&gt; <span class="hljs-title function_">executeIteration</span><span class="hljs-params">(<span class="hljs-type">int</span> iter, StructuredOutputHandler handler)</span> {
    <span class="hljs-keyword">if</span> (iter &gt;= maxIters) {
        <span class="hljs-keyword">return</span> summarizing(handler);
    }
    
    <span class="hljs-keyword">return</span> checkInterruptedAsync()
        .then(reasoning(handler))
        .then(Mono.defer(<span class="hljs-built_in">this</span>::checkInterruptedAsync))
        .then(Mono.defer(() -&gt; actingOrFinish(iter, handler)));
}
</code></pre>
<p>这里有几个巧妙的设计：</p>
<ol>
<li><strong>响应式编程</strong>：使用 <code>Mono.then()</code> 链式调用，保证执行顺序</li>
<li><strong>中断检查</strong>：在关键节点检查中断标志，支持安全中断</li>
<li><strong>延迟执行</strong>：使用 <code>Mono.defer()</code> 确保每次迭代都重新计算</li>
</ol>
<p><strong>流式处理</strong>：推理阶段使用 <code>Flux&lt;ChatResponse&gt;</code> 进行流式处理，这意味着模型返回的内容是分块到达的，框架会实时处理每个块并触发相应的 Hook，让开发者能够实时看到智能体的"思考过程"。</p>
<h3 data-id="heading-8">3. 工具调用系统：让智能体"动手"的能力</h3>
<h4 data-id="heading-9">3.1 工具注册与调用流程</h4>
<p>工具系统是 AgentScope 的一大亮点，它让智能体能够调用外部功能，比如查询数据库、调用 API、执行计算等。
<img src="http://openwrite.cn/uploads/19881/57635/9c7d348c-5466-4c2c-90f6-4649b3d92183.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">3.2 工具系统的设计亮点</h4>
<p><strong>注解驱动</strong>：工具注册非常简单，只需要在方法上添加 <code>@Tool</code> 注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Tool(name = "get_current_time", description = "Get current time")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentTime</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(name = "timezone")</span> String timezone)</span> {
    <span class="hljs-type">ZoneId</span> <span class="hljs-variable">zoneId</span> <span class="hljs-operator">=</span> ZoneId.of(timezone);
    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now(zoneId);
    <span class="hljs-keyword">return</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>));
}
</code></pre>
<p>框架会自动：</p>
<ol>
<li>解析方法签名</li>
<li>生成 JSON Schema（用于 LLM 理解工具）</li>
<li>处理参数转换（JSON → Java 对象）</li>
<li>执行方法并转换结果</li>
</ol>
<p><strong>工具组管理</strong>：<code>ToolGroupManager</code> 允许将工具分组，动态激活/停用某些工具组。这在复杂场景中非常有用，比如不同阶段需要不同的工具集。</p>
<p><strong>MCP 协议支持</strong>：框架原生支持 Model Context Protocol，这意味着可以轻松集成外部 MCP 服务提供的工具，无需编写额外的集成代码。</p>
<p><strong>并行执行</strong>：<code>ParallelToolExecutor</code> 支持并行执行多个工具调用，提高效率。当模型同时调用多个工具时，它们可以并行执行，而不是串行等待。</p>
<h3 data-id="heading-11">4. 记忆管理：智能体的"记忆"系统</h3>
<h4 data-id="heading-12">4.1 记忆系统架构</h4>
<p>AgentScope 将记忆分为两类：短期记忆（Memory）和长期记忆（LongTermMemory）。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/1ac49987-9da1-4bf8-851f-645b4bb7e5da.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">4.2 记忆管理的实现细节</h4>
<p><strong>短期记忆</strong>：<code>InMemoryMemory</code> 是最简单的实现，它将消息存储在内存中的 <code>List&lt;Msg&gt;</code> 中。每次调用智能体时，用户消息和智能体回复都会被添加到记忆中，形成完整的对话历史。</p>
<p><strong>长期记忆</strong>：长期记忆通过 <code>LongTermMemoryTools</code> 暴露给智能体，智能体可以主动调用 <code>search_memory</code> 和 <code>add_memory</code> 工具。框架还支持自动管理模式，通过 <code>StaticLongTermMemoryHook</code> 在特定时机自动保存重要信息。</p>
<p><strong>状态持久化</strong>：<code>Memory</code> 接口继承自 <code>StateModule</code>，这意味着记忆可以被序列化并持久化到会话存储中。配合 <code>Session</code> 系统，可以实现对话的保存和恢复。</p>
<h3 data-id="heading-14">5. 多智能体协作：MsgHub 的巧妙设计</h3>
<h4 data-id="heading-15">5.1 多智能体通信流程</h4>
<p><code>MsgHub</code> 是 AgentScope 中实现多智能体协作的核心组件，它解决了智能体之间消息传递的繁琐问题。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/a27fa40a-7870-4a70-932a-f86eab6534a5.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-16">5.2 MsgHub 的设计精髓</h4>
<p><strong>自动广播机制</strong>：当智能体加入 <code>MsgHub</code> 后，框架会自动设置订阅关系。每个智能体发送的消息会自动广播给其他参与者，无需手动调用 <code>observe()</code>。</p>
<p><strong>观察者模式</strong>：<code>AgentBase</code> 维护了一个 <code>hubSubscribers</code> 映射，记录每个 Hub 的订阅者列表。当智能体调用 <code>call()</code> 时，框架会自动将消息发送给所有订阅者。</p>
<p>看一段关键代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AgentBase 中的消息广播逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastToSubscribers</span><span class="hljs-params">(String hubName, Msg msg)</span> {
    List&lt;AgentBase&gt; subscribers = hubSubscribers.get(hubName);
    <span class="hljs-keyword">if</span> (subscribers != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (AgentBase subscriber : subscribers) {
            subscriber.observe(msg).subscribe();
        }
    }
}
</code></pre>
<p><strong>生命周期管理</strong>：<code>MsgHub</code> 实现了 <code>AutoCloseable</code> 接口，可以使用 try-with-resources 自动清理订阅关系，避免内存泄漏。</p>
<h3 data-id="heading-17">6. 生产就绪特性：企业级能力</h3>
<h4 data-id="heading-18">6.1 安全中断机制</h4>
<p>AgentScope 提供了完整的中断机制，支持在任意时刻安全地暂停智能体执行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外部中断</span>
agent.interrupt(userMsg);

<span class="hljs-comment">// 智能体内部检查点</span>
<span class="hljs-keyword">return</span> checkInterruptedAsync()
    .then(doWork())
    .flatMap(result -&gt; checkInterruptedAsync().thenReturn(result));
</code></pre>
<p>中断机制使用 <code>AtomicBoolean</code> 标志位和响应式编程模式，确保中断信号能够正确传播到 Mono 链中。</p>
<h4 data-id="heading-19">6.2 Hook 系统：可观测性和扩展性</h4>
<p>Hook 系统允许开发者在智能体执行的关键点注入自定义逻辑：</p>
<pre><code class="hljs language-java" lang="java">agent.addHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;List&lt;Msg&gt;&gt; <span class="hljs-title function_">onPreReasoning</span><span class="hljs-params">(PreReasoningEvent event)</span> {
        <span class="hljs-comment">// 在推理前修改消息</span>
        <span class="hljs-keyword">return</span> Mono.just(modifiedMessages);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">onPostActing</span><span class="hljs-params">(PostActingEvent event)</span> {
        <span class="hljs-comment">// 在工具执行后记录日志</span>
        logger.info(<span class="hljs-string">"Tool executed: {}"</span>, event.getToolCall());
        <span class="hljs-keyword">return</span> Mono.empty();
    }
});
</code></pre>
<p>框架定义了多个 Hook 事件类型，覆盖了智能体执行的各个阶段，这让监控、日志、调试变得非常方便。</p>
<h4 data-id="heading-20">6.3 响应式架构</h4>
<p>整个框架基于 Project Reactor，所有异步操作都返回 <code>Mono&lt;T&gt;</code> 或 <code>Flux&lt;T&gt;</code>。这种设计带来的好处是：</p>
<ul>
<li><strong>非阻塞执行</strong>：不会因为等待 I/O 而阻塞线程</li>
<li><strong>背压处理</strong>：Flux 天然支持背压，避免内存溢出</li>
<li><strong>组合能力</strong>：可以轻松组合多个异步操作</li>
</ul>
<h4 data-id="heading-21">6.4 状态管理与会话持久化</h4>
<p><code>StateModule</code> 接口提供了统一的状态管理能力，任何实现了该接口的组件都可以被序列化和持久化。配合 <code>Session</code> 系统，可以实现：</p>
<ul>
<li>对话历史的保存和恢复</li>
<li>智能体状态的持久化</li>
<li>多租户隔离</li>
</ul>
<h3 data-id="heading-22">7. 使用示例：快速上手</h3>
<h4 data-id="heading-23">7.1 基础对话示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建模型</span>
<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
    .modelName(<span class="hljs-string">"qwen-plus"</span>)
    .build();

<span class="hljs-comment">// 创建智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Assistant"</span>)
    .sysPrompt(<span class="hljs-string">"You are a helpful assistant."</span>)
    .model(model)
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>())
    .build();

<span class="hljs-comment">// 调用智能体</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(Msg.builder()
    .role(MsgRole.USER)
    .textContent(<span class="hljs-string">"Hello!"</span>)
    .build()).block();

System.out.println(response.getTextContent());
</code></pre>
<h4 data-id="heading-24">7.2 工具调用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleTools</span> {
    <span class="hljs-meta">@Tool(name = "calculate", description = "Calculate math expression")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(name = "expression")</span> String expr)</span> {
        <span class="hljs-comment">// 执行计算逻辑</span>
        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">// 注册工具</span>
<span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
toolkit.registerTool(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleTools</span>());

<span class="hljs-comment">// 创建带工具的智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .toolkit(toolkit)
    <span class="hljs-comment">// ... 其他配置</span>
    .build();
</code></pre>
<h4 data-id="heading-25">7.3 多智能体协作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建多个智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">alice</span> <span class="hljs-operator">=</span> ReActAgent.builder().name(<span class="hljs-string">"Alice"</span>).build();
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">bob</span> <span class="hljs-operator">=</span> ReActAgent.builder().name(<span class="hljs-string">"Bob"</span>).build();

<span class="hljs-comment">// 使用 MsgHub 进行协作</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">MsgHub</span> <span class="hljs-variable">hub</span> <span class="hljs-operator">=</span> MsgHub.builder()
        .participants(alice, bob)
        .build()) {
    hub.enter().block();
    
    <span class="hljs-comment">// Alice 的回复会自动广播给 Bob</span>
    alice.call().block();
    
    <span class="hljs-comment">// Bob 的回复会自动广播给 Alice</span>
    bob.call().block();
}
</code></pre>
<h3 data-id="heading-26">8. 总结</h3>
<p>AgentScope Java 是一个设计精良的智能体框架，它在易用性和功能完整性之间找到了很好的平衡。通过本文的分析，我们可以看到：</p>
<ol>
<li><strong>ReAct 循环</strong>：通过 Pipeline 模式实现了清晰的推理-行动循环，支持流式处理和中断</li>
<li><strong>工具系统</strong>：注解驱动的工具注册、工具组管理、MCP 协议支持，让扩展变得简单</li>
<li><strong>记忆管理</strong>：分离的短期和长期记忆，支持多种存储后端和持久化</li>
<li><strong>多智能体协作</strong>：MsgHub 的自动广播机制大大简化了多智能体应用的开发</li>
<li><strong>生产就绪</strong>：安全中断、Hook 系统、响应式架构、状态管理，这些特性让框架能够应对企业级需求</li>
</ol>
<p>框架的架构设计体现了几个重要的软件工程原则：</p>
<ul>
<li><strong>单一职责</strong>：每个组件都有明确的职责</li>
<li><strong>开闭原则</strong>：通过接口和抽象类支持扩展</li>
<li><strong>依赖倒置</strong>：依赖抽象而非具体实现</li>
<li><strong>响应式编程</strong>：充分利用 Reactor 的能力</li>
</ul>
<p>对于开发者来说，AgentScope Java 提供了从简单对话到复杂多智能体系统的完整解决方案，同时保持了代码的简洁性和可维护性。无论是快速原型开发还是生产环境部署，这个框架都能很好地满足需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka 消息积压处理实战：百万级队列清空的优化技巧]]></title>    <link>https://juejin.cn/post/7586585498744324150</link>    <guid>https://juejin.cn/post/7586585498744324150</guid>    <pubDate>2025-12-23T02:45:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585498744324150" data-draft-id="7586579021283803190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka 消息积压处理实战：百万级队列清空的优化技巧"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-23T02:45:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka 消息积压处理实战：百万级队列清空的优化技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:45:14.000Z" title="Tue Dec 23 2025 02:45:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kafka 消息积压处理实战：百万级队列清空的优化技巧</h2>
<p>做Java开发八年，踩过的中间件坑没有一百也有八十，其中最让人头皮发麻的，莫过于生产环境Kafka消息积压——尤其是凌晨三点接到告警，看到监控面板上“未消费消息数”直奔百万，下游业务催着要数据，那种压力至今难忘。</p>
<p>上周团队刚处理完一场百万级消息积压的紧急故障，从定位问题到清空队列只用了4小时，后续通过代码升级彻底杜绝了复发。今天就以这次实战为例，从Java开发者的视角，把消息积压的处理逻辑、优化技巧和兜底方案讲透，希望能帮大家少走弯路。</p>
<h3 data-id="heading-1">一、紧急告警：先搞清楚“为什么积压”（业务+技术双维度分析）</h3>
<p>接到告警先别慌，盲目重启消费者只会让问题更复杂。作为资深Java开发，我的第一反应是“先定位根因”——消息积压本质是“生产速度＞消费速度”，但具体是生产端突增，还是消费端掉链子，必须用数据说话。</p>
<h4 data-id="heading-2">1. 快速排查三步法（Java开发必备）</h4>
<ul>
<li><strong>第一步：查监控数据</strong> 先看Kafka Manager的核心指标：① 生产TPS是否突增（排除突发流量）；② 消费TPS是否骤降（核心排查方向）；③ 消费者组是否正常心跳（避免消费组崩溃）；④ 分区消费进度是否均匀（排除分区分配不均）。</li>
<li><strong>第二步：查消费端日志</strong>登录消费服务节点，用Arthas排查：① 是否有大量异常日志（比如数据库超时、外部接口调用失败）；② 消费线程是否阻塞（jstack查看线程状态，是否有WAITING、BLOCKED）；③ JVM参数是否合理（GC频率、内存使用，避免OOM导致服务重启）。</li>
<li><strong>第三步：查业务依赖</strong> 我们的消费逻辑是“接收消息→解析→调用库存接口→入库”，排查后发现：下游库存服务因数据库主从切换响应超时（从200ms涨到5s），导致消费线程大量阻塞，消费TPS从1000+骤降到50以下，而生产TPS正常（2000+），积压自然越来越严重。</li>
</ul>
<h4 data-id="heading-3">2. 常见积压原因总结（八年经验沉淀）</h4>
<p>结合过往经历，Java项目中Kafka消息积压的核心原因无非三类，大家可以对号入座：</p>
<ul>
<li><strong>消费端问题（占比80%）</strong> ：① 业务逻辑冗余（比如循环调用外部接口、无效数据库查询）；② 依赖服务不稳定（超时、宕机）；③ 线程池配置不合理（核心线程数太少，队列满了不扩容）；④ 代码Bug（死循环、空指针导致消费线程退出）；⑤ 消费者重平衡频繁（分区分配策略不合理）。</li>
<li><strong>生产端问题（占比15%）</strong> ：① 突发流量（比如大促、活动导致生产TPS翻倍）；② 消息体过大（单条消息10MB+，序列化/反序列化耗时）；③ 生产重试机制不合理（失败消息反复发送，占用队列）。</li>
<li><strong>配置问题（占比5%）</strong> ：① Kafka分区数太少（并行消费能力上限低）；② 消费者fetch.min.bytes设置过大（等待数据导致延迟）；③ max.poll.records设置过小（单次拉取消息少，效率低）。</li>
</ul>
<h3 data-id="heading-4">二、快速止血：百万级积压的紧急处理方案（4小时清空实战）</h3>
<p>定位到“下游服务超时导致消费阻塞”后，我们的核心思路是“先兜底消费，再优化细节”，避免因积压时间过长导致消息过期（Kafka默认消息保留7天），具体分三步执行：</p>
<h4 data-id="heading-5">1. 第一步：临时隔离，避免问题扩散</h4>
<p>既然下游库存服务不稳定，继续让原消费者调用只会加剧阻塞。我们先做了两件事：</p>
<ul>
<li>① 暂停原消费服务的消费线程（通过配置中心动态开关，避免重启服务）；</li>
<li>② 部署临时消费服务，核心逻辑简化为“拉取消息→解析→写入临时表（MySQL）”，跳过外部接口调用——这样能快速降低积压速度，同时保留消息数据，避免丢失。</li>
</ul>
<h4 data-id="heading-6">2. 第二步：优化消费参数，提升并行能力</h4>
<p>临时消费服务的核心是“快”，我们针对性调整了Kafka消费者参数和Java线程池配置，这是提升消费速度的关键：</p>
<h5 data-id="heading-7">（1）Kafka消费者核心参数优化（Java代码配置示例）</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 原配置</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">100</span>); <span class="hljs-comment">// 单次拉取100条</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, <span class="hljs-number">10240</span>); <span class="hljs-comment">// 等待10KB数据才拉取</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="hljs-number">10000</span>); <span class="hljs-comment">// 会话超时10s</span>

<span class="hljs-comment">// 优化后配置</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 单次拉取1000条（根据内存调整，避免OOM）</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 降低等待阈值，减少延迟</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="hljs-number">30000</span>); <span class="hljs-comment">// 延长会话超时，避免重平衡</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, <span class="hljs-number">500</span>); <span class="hljs-comment">// 最大等待500ms，没数据也拉取</span>
</code></pre>
<p>说明：调整后，单次拉取消息量提升10倍，等待时间缩短，消费效率直接翻倍。</p>
<h5 data-id="heading-8">（2）Java线程池优化（避免线程阻塞导致的效率低下）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原线程池配置（核心线程5，最大10，队列1000）</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>));

<span class="hljs-comment">// 优化后配置（核心线程20，最大50，队列100，拒绝策略改为丢弃 oldest）</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">20</span>, <span class="hljs-number">50</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy());
</code></pre>
<p>说明：原线程池队列太大，即使核心线程阻塞，新任务也会进入队列等待，无法触发最大线程数扩容；优化后队列缩小，触发最大线程数，同时拒绝策略保证最新消息优先处理（临时场景下可接受）。</p>
<h5 data-id="heading-9">（3）增加分区消费并行度</h5>
<p>Kafka的消费并行度上限是“分区数”，我们原Topic分区数是8，临时扩容到20（通过Kafka命令：kafka-topics.sh --alter --topic xxx --partitions 20），同时让临时消费服务启动20个消费线程（与分区数一致），避免分区分配不均导致的资源浪费。</p>
<h4 data-id="heading-10">3. 第三步：分批处理临时数据，补全业务链路</h4>
<p>临时消费服务运行2小时后，积压消息从120万降到30万，此时下游库存服务恢复正常。我们开始补全业务链路：</p>
<ul>
<li>① 开发分批处理程序，从临时表中批量读取数据（每次1000条），调用库存接口并入库；</li>
<li>② 启用线程池异步处理，同时加入重试机制（使用Guava Retryer，重试3次，间隔1s，失败写入死信表）；</li>
<li>③ 监控补全进度，每小时核对数据一致性，确保无遗漏。</li>
</ul>
<p>最终，剩余30万消息2小时内处理完成，整个积压问题4小时解决，下游业务无数据丢失。</p>
<h3 data-id="heading-11">三、代码升级：从根源避免消息积压的兜底策略</h3>
<p>紧急处理只是“救火”，作为资深Java开发，更要做好“防火”。我们针对这次问题，对原消费服务做了全方位代码升级，形成长期兜底方案：</p>
<h4 data-id="heading-12">1. 消费逻辑优化：异步化+解耦</h4>
<p>原消费逻辑是“同步调用外部接口”，一旦接口超时就会阻塞线程。升级后采用“异步化+消息解耦”：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 升级后消费逻辑</span>
@Override
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">ConsumerRecord&lt;String, String&gt; <span class="hljs-keyword">record</span></span>)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 解析消息（轻量操作，同步执行）</span>
        OrderMessage message = JSON.parseObject(<span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), OrderMessage.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-comment">// 2. 异步处理业务逻辑（提交到线程池）</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用库存接口</span>
                inventoryService.updateStock(message.getOrderId(), message.getProductId(), message.getNum());
                <span class="hljs-comment">// 入库</span>
                orderMapper.insert(message);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 失败写入死信队列</span>
                deadLetterQueue.send(<span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), e.getMessage());
                log.error(<span class="hljs-string">"消费消息失败，message:{}"</span>, <span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), e);
            }
        }, businessExecutor);
        
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"解析消息失败，record:{}"</span>, <span class="hljs-keyword">record</span>, <span class="hljs-title">e</span>);
    }
}
</code></pre>
<p>说明：通过CompletableFuture实现异步处理，消费线程只负责解析消息，不阻塞等待业务结果，即使业务逻辑耗时也不会影响消息拉取效率。</p>
<h4 data-id="heading-13">2. 依赖服务容错：降级+熔断</h4>
<p>针对外部服务不稳定的问题，集成Sentinel实现熔断降级，避免连锁故障：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 库存接口熔断降级配置</span>
@<span class="hljs-built_in">SentinelResource</span>(
    value = <span class="hljs-string">"updateStock"</span>,
    fallback = <span class="hljs-string">"updateStockFallback"</span>, <span class="hljs-comment">// 降级方法</span>
    blockHandler = <span class="hljs-string">"updateStockBlockHandler"</span>, <span class="hljs-comment">// 限流/熔断处理方法</span>
    fallbackClass = InventoryFallback.<span class="hljs-keyword">class</span>,
    blockHandlerClass = InventoryBlockHandler.<span class="hljs-keyword">class</span>
)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">updateStock</span><span class="hljs-params">(<span class="hljs-type">String</span> orderId, <span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> num)</span> </span>{
    <span class="hljs-comment">// 调用外部库存接口</span>
    <span class="hljs-keyword">return</span> inventoryClient.<span class="hljs-built_in">updateStock</span>(orderId, productId, num);
}

<span class="hljs-comment">// 降级方法（本地缓存兜底）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">updateStockFallback</span><span class="hljs-params">(<span class="hljs-type">String</span> orderId, <span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> num, Throwable e)</span> </span>{
    log.<span class="hljs-built_in">warn</span>(<span class="hljs-string">"库存接口降级，orderId:{}"</span>, orderId, e);
    <span class="hljs-comment">// 写入本地缓存，后续定时补偿</span>
    stockCache.<span class="hljs-built_in">put</span>(orderId, <span class="hljs-keyword">new</span> <span class="hljs-built_in">StockDTO</span>(productId, num));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>说明：当库存接口响应超时（设置阈值1s）或失败率超过50%时，触发熔断，调用降级方法用本地缓存兜底，后续通过定时任务补全数据，避免消费线程阻塞。</p>
<h4 data-id="heading-14">3. 线程池监控：可视化+告警</h4>
<p>之前线程池状态不可见，导致阻塞问题发现不及时。升级后集成Spring Boot Actuator，暴露线程池监控指标：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自定义线程池监控</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span> <span class="hljs-title function_">businessExecutor</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">ThreadPoolTaskExecutor</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.<span class="hljs-title function_">setCorePoolSize</span>(<span class="hljs-number">20</span>);
    executor.<span class="hljs-title function_">setMaxPoolSize</span>(<span class="hljs-number">50</span>);
    executor.<span class="hljs-title function_">setQueueCapacity</span>(<span class="hljs-number">500</span>);
    executor.<span class="hljs-title function_">setThreadNamePrefix</span>(<span class="hljs-string">"business-"</span>);
    <span class="hljs-comment">// 初始化</span>
    executor.<span class="hljs-title function_">initialize</span>();
    
    <span class="hljs-comment">// 注册监控指标</span>
    <span class="hljs-title class_">ThreadPoolMonitor</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">"businessExecutor"</span>, executor);
    <span class="hljs-keyword">return</span> executor;
}

<span class="hljs-comment">// 监控类核心逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolMonitor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name, ThreadPoolTaskExecutor executor</span>) {
        <span class="hljs-title class_">MeterRegistry</span> meterRegistry = <span class="hljs-title class_">ApplicationContextHolder</span>.<span class="hljs-title function_">getBean</span>(<span class="hljs-title class_">MeterRegistry</span>.<span class="hljs-property">class</span>);
        <span class="hljs-comment">// 线程池活跃线程数指标</span>
        meterRegistry.<span class="hljs-title function_">gauge</span>(<span class="hljs-string">"thread.pool.active.count"</span>, 
                <span class="hljs-title class_">Tags</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"thread.pool.name"</span>, name), 
                executor, <span class="hljs-title class_">ThreadPoolTaskExecutor</span>::getActiveCount);
        <span class="hljs-comment">// 队列剩余容量指标</span>
        meterRegistry.<span class="hljs-title function_">gauge</span>(<span class="hljs-string">"thread.pool.queue.remaining"</span>, 
                <span class="hljs-title class_">Tags</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"thread.pool.name"</span>, name), 
                executor, e -&gt; e.<span class="hljs-title function_">getQueueCapacity</span>() - e.<span class="hljs-title function_">getQueueSize</span>());
    }
}
</code></pre>
<p>同时在Prometheus+Grafana中配置告警规则：当活跃线程数达到最大线程数的80%，或队列剩余容量小于100时，触发告警，提前发现线程阻塞风险。</p>
<h4 data-id="heading-15">4. 消息可靠性保障：重试+死信队列</h4>
<p>为避免消息丢失，完善重试和死信机制：</p>
<ul>
<li>① 重试机制：使用Guava Retryer，针对暂时性异常（如网络超时）重试3次，间隔1s、2s、3s；</li>
<li>② 死信队列：重试失败的消息写入专门的死信Topic，后续通过后台管理系统手动处理，同时记录失败原因；</li>
<li>③ 消息幂等：通过订单ID做幂等校验（数据库唯一索引），避免重复消费导致数据不一致。</li>
</ul>
<h3 data-id="heading-16">四、复盘与沉淀：资深Java开发的避坑指南</h3>
<p>处理完这次问题，我总结了3条Kafka消息积压的避坑经验，适合所有Java开发者：</p>
<ol>
<li><strong>消费逻辑要“轻”</strong> ：尽量把重操作（外部接口调用、复杂计算）异步化，消费线程只做“解析消息+提交任务”，避免阻塞；</li>
<li><strong>依赖服务要“防”</strong> ：任何外部依赖都要加熔断、降级、超时控制，不能把希望寄托在依赖服务的稳定性上；</li>
<li><strong>监控告警要“全”</strong> ：不仅要监控Kafka的消息积压数，还要监控消费线程池状态、依赖服务响应时间、消息消费成功率，做到提前预警。</li>
</ol>
<h3 data-id="heading-17">结语</h3>
<p>Kafka消息积压不可怕，可怕的是没有清晰的处理思路和完善的兜底方案。作为八年Java开发，我深刻体会到：“紧急处理靠经验，长期稳定靠架构”。这次百万级积压的解决，核心是“先隔离再优化，先止血再根治”，而代码升级后的异步化、容错机制，才是避免问题复发的关键。</p>
<p>希望这篇实战总结能帮到大家，如果你在处理Kafka消息积压时遇到过其他问题，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术]]></title>    <link>https://juejin.cn/post/7586555198115987462</link>    <guid>https://juejin.cn/post/7586555198115987462</guid>    <pubDate>2025-12-23T02:48:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115987462" data-draft-id="7586582977708212266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术"/> <meta itemprop="keywords" content="前端,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-23T02:48:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:48:34.000Z" title="Tue Dec 23 2025 02:48:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,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")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,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");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🏎️ 一、当创新踩下油门，监管还在起步线</h2>
<p>WebAIGC（Web-based AI Generated Content），即基于网络的人工智能内容生成技术，是这个时代的“像素风暴”。<br/>
从 ChatGPT 到 Midjourney，从 Copilot 到 AI网页生成器，它们正在以光速更新版本，逼得监管者一边学习 prompt，一边擦汗。</p>
<h3 data-id="heading-1">🧩 1. 技术迭代的“量子跳跃”</h3>
<p>我们不难发现，WebAIGC 的进化轨迹几乎是“指数曲线式”的。</p>
<ul>
<li>一个季度前发布的模型，到了现在可能已经“上了养老保险”。</li>
<li>数据的扩充、推理架构的优化、算力的狂飙，都在让“智能”变得越来越自然。</li>
</ul>
<p>📊 但这种加速也带来了“技术位移”：</p>
<blockquote>
<p>当我们还在理解上一代 AI 的涌现特性时，下一代模型已经在尝试理解我们。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">⚖️ 二、监管的“慢时针困境”</h2>
<p>监管者的节奏往往是“立法—试点—修正—再立法”。<br/>
而科技圈的节奏是“写代码—上线—用户反馈—迭代—再上线”。<br/>
这两个世界的时钟不同步，于是便有了最经典的场景：</p>
<blockquote>
<p>法条还在讨论“人工智能是否应当承担法律人格”，而AI已经在生成下一份法律草案。</p>
</blockquote>
<h3 data-id="heading-3">📚 举个例子</h3>
<p>一个 WebAIGC 平台可以在几秒钟内生成成千上万的网页、广告、甚至新闻内容。<br/>
但是——<br/>
谁来确定这些内容的所有权？<br/>
谁为生成的虚假信息买单？</p>
<p>监管滞后并非因为懒，而是因为在 AI 的维度下，“边界”本身在流动。</p>
<hr/>
<h2 data-id="heading-4">🧮 三、底层逻辑的简要还原：AI的加速机制</h2>
<p>WebAIGC 的进步，本质上是<strong>三个底层机制的共振</strong>：</p>
<ol>
<li>
<p><strong>数据流的多样性</strong></p>
<ul>
<li>海量的网页交互数据变成了AI的“语料粮仓”；</li>
<li>模型从多模态输入中学会了“类人表达”。</li>
</ul>
</li>
<li>
<p><strong>分布式算力的爆发</strong></p>
<ul>
<li>从单机 GPU 到分布式推理集群；</li>
<li>通过张量切片、模型并行、流水并行等手段，让 AI 以“光速”迭代。</li>
</ul>
</li>
<li>
<p><strong>模型结构的弹性设计</strong></p>
<ul>
<li>动态计算图 + 微调推理策略；</li>
<li>模型不只是“训练出来的”，而是“进化出来的”。</li>
</ul>
</li>
</ol>
<p>用类比来说：</p>
<blockquote>
<p>传统程序像是写死的食谱，而WebAIGC像是一位会自己反复试菜的厨师。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🧱 四、监管的算法思维：用代码看世界</h2>
<p>让监管理解 AI，不妨换一个他们熟悉的语言：<strong>逻辑 + 流程控制</strong>。<br/>
假如我们用 JavaScript 比喻监管机制，它也许是这样的👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebAIGC_Regulation</span>(<span class="hljs-params">technology, law</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (technology.<span class="hljs-title function_">isEvolving</span>()) {
      <span class="hljs-keyword">if</span> (law.<span class="hljs-title function_">isOutdated</span>()) {
        law = law.<span class="hljs-title function_">updateTo</span>(technology.<span class="hljs-title function_">newPattern</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📜 Law updated to adapt AI iteration."</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ Compliance achieved, continue monitoring..."</span>);
      }
      technology.<span class="hljs-title function_">nextIteration</span>();
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ Unexpected AI behavior detected:"</span>, error);
    emergencyProtocol.<span class="hljs-title function_">activate</span>();
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔁 Continuous audit in progress..."</span>);
  }
}

<span class="hljs-title class_">WebAIGC</span>_Regulation(<span class="hljs-title class_">WebAIGC</span>_Model, <span class="hljs-title class_">Legal</span>_System);
</code></pre>
<p>这段代码展示了一种理想的平衡哲学：</p>
<ul>
<li><strong>技术必须循环进化</strong>（<code>technology.nextIteration()</code>）</li>
<li><strong>法律必须自我升级</strong>（<code>law.updateTo()</code>）</li>
<li><strong>出现风险立即处理</strong>（<code>catch(error)</code>）</li>
</ul>
<p>换句话说，监管并不是“对抗”创新，而是“追踪”创新。</p>
<hr/>
<h2 data-id="heading-6">🚦 五、未来的平衡术：速度与秩序共舞</h2>
<p>如何在“迭代速度”与“监管适配”之间找到平衡？<br/>
以下是三条启示性的建议：</p>
<h3 data-id="heading-7">🌱 1. 建立“弹性监管架构”</h3>
<p>监管不必追着每一项技术跑，而是制定通用原则，像编写“接口文档”一样，给创新留出空间。</p>
<h3 data-id="heading-8">🧭 2. 推动“可解释的AI治理”</h3>
<p>AIGC 模型不应只是“黑箱”，而应该能回答：“我为什么生成这个结果？”<br/>
让监管具备可溯源的信息基础。</p>
<h3 data-id="heading-9">🛠️ 3. 借助技术监管技术</h3>
<p>让 AI 参与治理——自动检测违规内容、评估伦理风险、生成监管报告。<br/>
监管可以“AI化”，而不是“反AI化”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏗️ B端架构中的用户归因与埋点最佳实践]]></title>    <link>https://juejin.cn/post/7586582977708343338</link>    <guid>https://juejin.cn/post/7586582977708343338</guid>    <pubDate>2025-12-23T02:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977708343338" data-draft-id="7586582977708277802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏗️ B端架构中的用户归因与埋点最佳实践"/> <meta itemprop="keywords" content="前端,架构,React.js"/> <meta itemprop="datePublished" content="2025-12-23T02:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏗️ B端架构中的用户归因与埋点最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:50:42.000Z" title="Tue Dec 23 2025 02:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,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")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,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");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧠 一、前言：B端数据的“盲点效应”</h2>
<p>在 To B（企业级）产品架构中，用户行为分析往往是“灰色地带”：</p>
<ul>
<li>产品使用路径复杂；</li>
<li>不同角色协同操作；</li>
<li>数据入口分散在多个前后端系统。</li>
</ul>
<p>结果是：<br/>
埋点像“满天星”，日志像“银河系”，但要分析谁是核心用户、谁带来价值，却发现——<br/>
👉 “数据都在，有效信息稀缺。”</p>
<hr/>
<h2 data-id="heading-1">🧭 二、用户归因的底层逻辑</h2>
<p>B端用户归因（Attribution）本质上是要解决：“<strong>谁做了什么、在什么渠道、带来了什么价值</strong>。”</p>
<h3 data-id="heading-2">🧩 1. 三层归因模型</h3>





























<table><thead><tr><th>层级</th><th>目标</th><th>典型问题</th><th>示例</th></tr></thead><tbody><tr><td><strong>渠道归因</strong></td><td>确定流量来源</td><td>用户从哪里来？</td><td>官网➡️注册页➡️内部邀请</td></tr><tr><td><strong>账号归因</strong></td><td>识别行为账号</td><td>谁在用？</td><td>是企业管理员还是成员？</td></tr><tr><td><strong>价值归因</strong></td><td>衡量贡献</td><td>谁让转化发生？</td><td>谁推动了一次成交或激活？</td></tr></tbody></table>
<blockquote>
<p>🔍 “用户行为不是孤立事件，而是多角色协作的轨迹。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">⚙️ 三、B端埋点的特殊挑战</h2>
<p>B端产品的复杂性主要体现在以下三个方面：</p>
<h3 data-id="heading-4">🧱 1. 多身份与多端入口</h3>
<p>同一企业下存在：管理员、运营、财务、多角色协作。<br/>
同时使用 Web、App、SDK、API、甚至嵌入第三方平台。</p>
<p>解决建议：</p>
<ul>
<li>埋点需携带 <strong>TenantID（租户ID） + UserRole（角色） + DeviceType（设备类型）</strong></li>
<li>使用一致的 <strong>UUID</strong> 跨端追踪同一用户行为。</li>
</ul>
<h3 data-id="heading-5">🕸️ 2. 行为链条长且可被中断</h3>
<p>一个业务动作可能跨越多页面、多模块，甚至多天完成。<br/>
例如：“创建一个自动化营销流程”可能涉及 7 个操作节点。</p>
<p>解决建议：</p>
<ul>
<li>关键节点用 <strong>事件ID 串联形成 Session 链路</strong>；</li>
<li>对“延迟行为”设定 <strong>窗口期（例如7天）</strong> ，防止误归因。</li>
</ul>
<h3 data-id="heading-6">🛡️ 3. 数据安全与隐私合规</h3>
<p>企业客户比C端用户更重视数据边界。</p>
<p>解决建议：</p>
<ul>
<li>匿名化处理埋点数据（Hash + Salt）</li>
<li><strong>本地采集 -&gt; 聚合 -&gt; 再上传</strong>，避免直接暴露Key。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧮 四、埋点设计哲学：从“无脑采”到“精准测”</h2>
<blockquote>
<p>“最好的埋点体系，不是埋得多，而是埋得准。”</p>
</blockquote>
<h3 data-id="heading-8">🌿 1. 埋点分层结构</h3>






























<table><thead><tr><th>层级</th><th>目标</th><th>举例</th></tr></thead><tbody><tr><td><strong>基础埋点</strong></td><td>记录关键事件</td><td>登录 / 登出 / 查看报告</td></tr><tr><td><strong>业务埋点</strong></td><td>支撑运营指标</td><td>提交审批 / 添加客户</td></tr><tr><td><strong>增长埋点</strong></td><td>支撑A/B实验</td><td>点击引导按钮 / 完成注册</td></tr><tr><td><strong>异常埋点</strong></td><td>技术指标监控</td><td>请求失败 / 脚本报错</td></tr></tbody></table>
<p>🧩 设计建议：<br/>
所有埋点的命名规范应为：</p>
<pre><code class="hljs language-arduino" lang="arduino">模块名.事件类型.动作
ex: dashboard.click.export_button
</code></pre>
<hr/>
<h3 data-id="heading-9">💬 2. 示例：事件捕获脚本（JS版）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通用埋点 SDK 模拟</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AILog</span> = {
  <span class="hljs-title function_">track</span>(<span class="hljs-params">event, payload = {}</span>) {
    <span class="hljs-keyword">const</span> base = {
      <span class="hljs-attr">tenantId</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">__TENANT_ID__</span> || <span class="hljs-string">"unknown"</span>,
      <span class="hljs-attr">userId</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">__USER_ID__</span> || <span class="hljs-string">"anonymous"</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">source</span>: <span class="hljs-string">"web"</span>,
    };
    <span class="hljs-keyword">const</span> data = { ...base, event, ...payload };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📡 Sent Event:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-title function_">sendToServer</span>(data);
  },
};

<span class="hljs-comment">// 示例：用户点击导出功能</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#exportBtn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">AILog</span>.<span class="hljs-title function_">track</span>(<span class="hljs-string">"dashboard.click.export_button"</span>, {
    <span class="hljs-attr">fileType</span>: <span class="hljs-string">"csv"</span>,
    <span class="hljs-attr">module</span>: <span class="hljs-string">"reporting"</span>,
  });
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToServer</span>(<span class="hljs-params">payload</span>) {
  <span class="hljs-comment">// 简化版上报逻辑</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/track"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload),
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"🚨 埋点上报失败:"</span>, e));
}
</code></pre>
<blockquote>
<p>💬 <em>这一行日志，也许正是产品增长会议的灵魂来源。</em></p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🧠 五、从事件到洞察：归因算法的实战启发</h2>
<p>归因不仅是日志分析，更是一种“推理算法”：</p>
<h3 data-id="heading-11">🔍 1. 时间权重归因</h3>
<p>靠近转化时刻的行为权重大。<br/>
（如：最后一次点击 &gt; 第一次点击）</p>
<h3 data-id="heading-12">🔄 2. 多触点递减模型</h3>
<p>每个行为节点都获得部分贡献值，但按时间递减。</p>
<h3 data-id="heading-13">🎯 3. 团队归因模型（B端特有）</h3>
<p>多用户协作完成一个目标时，为每个人按职能分配权重：</p>
<ul>
<li>销售：意向启动权重</li>
<li>产品：试用完成权重</li>
<li>管理员：最终续约权重</li>
</ul>
<hr/>
<h2 data-id="heading-14">🧩 六、最佳实践清单</h2>
<p>✅ <strong>结构化命名规范</strong>（避免 event1、event2）<br/>
✅ <strong>跨端统一身份体系</strong>（TenantID + UUID）<br/>
✅ <strong>可灰度可配置的埋点策略</strong><br/>
✅ <strong>事件链路可视化埋点管理平台</strong><br/>
✅ <strong>埋点审计机制</strong>（防止“僵尸点”污染指标）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP 面向切面编程完全指南 🚀]]></title>    <link>https://juejin.cn/post/7586559672128127028</link>    <guid>https://juejin.cn/post/7586559672128127028</guid>    <pubDate>2025-12-22T13:11:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672128127028" data-draft-id="7586493936677601320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP 面向切面编程完全指南 🚀"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T13:11:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="总会落叶"/> <meta itemprop="url" content="https://juejin.cn/user/766787307710060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP 面向切面编程完全指南 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/766787307710060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    总会落叶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:11:18.000Z" title="Mon Dec 22 2025 13:11:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AOP 面向切面编程完全指南 🚀</h2>
<h3 data-id="heading-1">一、什么是 AOP？ 🤔</h3>
<p><strong>面向切面编程</strong>（AOP）是 Spring 框架的核心功能之一，它允许开发者将横切关注点（如日志记录、事务管理、安全控制等）从业务逻辑中分离出来，实现代码的模块化和复用。就像电影特效团队🎬，他们专注于特效制作，而不需要关心剧本内容！</p>
<h3 data-id="heading-2">二、快速开始 ⚡</h3>
<h4 data-id="heading-3">1. 导入依赖 📦</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring Boot AOP 依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2. 第一个 AOP 程序：方法执行时间监控 ⏱️</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@Aspect</span>         <span class="hljs-comment">// 声明为切面类 🎯</span>
<span class="hljs-variable">@Component</span>      <span class="hljs-comment">// 交给 IOC 容器管理 🏭</span>
public class RecordTimeAspect {
    
    <span class="hljs-comment">/**
     * 切入点表达式：监控 com.example.service 包下所有类的所有方法
     */</span>
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"execution(* com.example.service.*.*(..))"</span>)
    public Object <span class="hljs-built_in">recordTime</span>(ProceedingJoinPoint pjp) throws Throwable {
        <span class="hljs-comment">// 记录开始时间</span>
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">beginTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-comment">// 执行原始方法 🏃•♂️</span>
        <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.proceed</span>();
        
        <span class="hljs-comment">// 记录结束时间并计算耗时</span>
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">endTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">costTime</span> = <span class="hljs-selector-tag">endTime</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">beginTime</span>;
        
        <span class="hljs-comment">// 获取方法签名信息</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.getName</span>();
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">className</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.getTarget</span>()<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getSimpleName</span>();
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"🎯 [{}] - [{}] 执行耗时: {}ms"</span>, className, methodName, costTime);
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">三、AOP 核心概念详解 🎓</h3>
<h4 data-id="heading-6">1. 核心术语 📚</h4>









































<table><thead><tr><th>概念</th><th>说明</th><th>类比</th><th>表情</th></tr></thead><tbody><tr><td><strong>连接点 (JoinPoint)</strong></td><td>程序执行过程中可以插入切面的点</td><td>电影中的每个场景</td><td>🎬</td></tr><tr><td><strong>通知 (Advice)</strong></td><td>切面在特定连接点执行的动作</td><td>特效团队的工作</td><td>🎨</td></tr><tr><td><strong>切入点 (Pointcut)</strong></td><td>匹配连接点的谓词</td><td>需要加特效的场景</td><td>📍</td></tr><tr><td><strong>切面 (Aspect)</strong></td><td>通知和切入点的组合</td><td>完整的特效设计方案</td><td>📋</td></tr><tr><td><strong>目标对象 (Target)</strong></td><td>被一个或多个切面所通知的对象</td><td>原始电影片段</td><td>🎥</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f12e563f76c942e59abee35719e80c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oC75Lya6JC95Y-2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013878&amp;x-signature=SQMr%2F97IazUsGc%2BeAMZ%2Fter4pvQ%3D" alt="image-20251221183926108.png" loading="lazy"/></p>
<h4 data-id="heading-7">2. AOP 底层原理：动态代理 🧙‍♂️</h4>
<p>Spring AOP 默认使用两种代理方式：</p>
<ul>
<li><strong>JDK 动态代理</strong>：基于接口实现 ✨</li>
<li><strong>CGLIB 代理</strong>：基于继承实现 🔄</li>
</ul>
<h3 data-id="heading-8">四、通知类型详解 🎪</h3>
<h4 data-id="heading-9">1. 五种通知类型 🖐️</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllAdviceExample</span> {
    
    <span class="hljs-comment">/**
     * 1. 环绕通知 - 最强大的通知类型 💪
     */</span>
    <span class="hljs-meta">@Around("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        log.info(<span class="hljs-string">"🔄 @Around - 方法执行前"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pjp.proceed();  <span class="hljs-comment">// 必须显式调用原始方法</span>
            log.info(<span class="hljs-string">"✅ @Around - 方法执行后"</span>);
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"❌ @Around - 方法执行异常"</span>);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">/**
     * 2. 前置通知 - 在目标方法执行前执行 ⬆️
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        log.info(<span class="hljs-string">"⬆️ @Before - 方法执行前"</span>);
    }
    
    <span class="hljs-comment">/**
     * 3. 后置通知 - 在目标方法执行后执行（无论是否异常） ⬇️
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        log.info(<span class="hljs-string">"⬇️ @After - 方法执行后（总执行）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 4. 返回后通知 - 在目标方法正常返回后执行 ✅
     */</span>
    <span class="hljs-meta">@AfterReturning(value = "execution(* com.example.service.*.*(..))", 
                   returning = "result")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturningAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {
        log.info(<span class="hljs-string">"✅ @AfterReturning - 方法正常返回，结果: {}"</span>, result);
    }
    
    <span class="hljs-comment">/**
     * 5. 异常通知 - 在目标方法抛出异常后执行 ❌
     */</span>
    <span class="hljs-meta">@AfterThrowing(value = "execution(* com.example.service.*.*(..))", 
                   throwing = "ex")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowingAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Exception ex)</span> {
        log.error(<span class="hljs-string">"❌ @AfterThrowing - 方法执行异常: {}"</span>, ex.getMessage());
    }
}
</code></pre>
<h4 data-id="heading-10">2. 通知执行顺序 📊</h4>
<p>默认执行顺序（同一切面内）： <strong>🔄 @Around</strong>（前半部分） → <strong>⬆️ @Before</strong> → <strong>🎯 目标方法</strong> → <strong>🔄 @Around</strong>（后半部分） → <strong>✅ @AfterReturning/❌ @AfterThrowing</strong> → <strong>⬇️ @After</strong></p>
<h3 data-id="heading-11">五、切入点表达式 ✨</h3>
<h4 data-id="heading-12">1. execution 表达式 🎯</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
public class PointcutExamples {
    
    <span class="hljs-comment">// 1. 抽取公共切入点表达式 📝</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service.*.*(..))"</span>)
    public void <span class="hljs-built_in">serviceLayer</span>() {}
    
    <span class="hljs-comment">// 2. 精确匹配方法 🎯</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(public String com.example.service.UserService.getUserById(Integer))"</span>)
    public void <span class="hljs-built_in">specificMethod</span>() {}
    
    <span class="hljs-comment">// 3. 匹配包下所有方法 📁</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service..*.*(..))"</span>)  <span class="hljs-comment">// ..表示子包</span>
    public void <span class="hljs-built_in">allServiceMethods</span>() {}
    
    <span class="hljs-comment">// 4. 匹配特定注解的方法 🏷️</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(com.example.annotation.Log)"</span>)
    public void <span class="hljs-built_in">logAnnotation</span>() {}
    
    <span class="hljs-comment">// 5. 组合切入点表达式 🔗</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"serviceLayer() &amp;&amp; !specificMethod()"</span>)
    public void <span class="hljs-built_in">serviceButNotSpecific</span>() {}
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"serviceLayer()"</span>)  <span class="hljs-comment">// 引用切入点表达式</span>
    public Object <span class="hljs-built_in">adviceMethod</span>(ProceedingJoinPoint pjp) throws Throwable {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
<h4 data-id="heading-13">2. @annotation 表达式（基于注解） 🏷️</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 自定义日志注解
 */</span>
<span class="hljs-variable">@Target</span>(ElementType.METHOD)    <span class="hljs-comment">// 只能用在方法上</span>
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)  <span class="hljs-comment">// 运行时生效</span>
public <span class="hljs-variable">@interface</span> Log {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span>() <span class="hljs-selector-tag">default</span> "";
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">recordParams</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">true</span>;
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">recordResult</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">true</span>;
}
</code></pre>
<h3 data-id="heading-14">六、实战：操作日志记录到数据库 💾</h3>
<h4 data-id="heading-15">1. 创建操作日志实体 📋</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"t_operate_log"</span>)</span>  <span class="hljs-comment">// MyBatis-Plus 注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperateLog</span> {
    
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> operateUserId;        <span class="hljs-comment">// 操作人ID 👤</span>
    <span class="hljs-keyword">private</span> String operateUserName;    <span class="hljs-comment">// 操作人姓名</span>
    
    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime operateTime; <span class="hljs-comment">// 操作时间 ⏰</span>
    
    <span class="hljs-keyword">private</span> String className;          <span class="hljs-comment">// 类名</span>
    <span class="hljs-keyword">private</span> String methodName;         <span class="hljs-comment">// 方法名</span>
    
    <span class="hljs-meta">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword">private</span> Object methodParams;       <span class="hljs-comment">// 方法参数（JSON格式） 📄</span>
    
    <span class="hljs-meta">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword">private</span> Object returnValue;        <span class="hljs-comment">// 返回值（JSON格式） 📋</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Boolean</span> success;           <span class="hljs-comment">// 操作是否成功 ✅</span>
    <span class="hljs-keyword">private</span> String errorMessage;       <span class="hljs-comment">// 错误信息 ❌</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> costTime;             <span class="hljs-comment">// 耗时（毫秒） ⏱️</span>
    <span class="hljs-keyword">private</span> String clientIp;           <span class="hljs-comment">// 客户端IP 🌐</span>
    <span class="hljs-keyword">private</span> String requestUri;         <span class="hljs-comment">// 请求URI 🔗</span>
}
</code></pre>
<h4 data-id="heading-16">2. Mapper 接口 🔧</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OperateLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;OperateLog&gt; {
    <span class="hljs-comment">// 这里可以添加自定义查询方法</span>
}
</code></pre>
<h4 data-id="heading-17">3. 用户上下文工具类（ThreadLocal） 🧵</h4>
<pre><code class="hljs language-csharp" lang="csharp">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserContext</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;CurrentUser&gt; USER_CONTEXT = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 设置当前用户信息 👤
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentUser</span>(<span class="hljs-params">CurrentUser user</span>)</span> {
        USER_CONTEXT.<span class="hljs-keyword">set</span>(user);
    }
    
    <span class="hljs-comment">/**
     * 获取当前用户ID 🔑
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title">getCurrentUserId</span>()</span> {
        CurrentUser user = USER_CONTEXT.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">return</span> user != <span class="hljs-literal">null</span> ? user.getId() : <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">/**
     * 获取当前用户信息 📋
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CurrentUser <span class="hljs-title">getCurrentUser</span>()</span> {
        <span class="hljs-keyword">return</span> USER_CONTEXT.<span class="hljs-keyword">get</span>();
    }
    
    <span class="hljs-comment">/**
     * 清除用户信息（防止内存泄漏） 🧹
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span>()</span> {
        USER_CONTEXT.<span class="hljs-keyword">remove</span>();
    }
    
    @Data
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CurrentUser</span> {
        <span class="hljs-keyword">private</span> Long id;
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String role;
    }
}
</code></pre>
<h4 data-id="heading-18">4. 切面类实现 🛡️</h4>
<pre><code class="hljs language-ini" lang="ini">@Slf4j
@Aspect
@Component
public class OperateLogAspect {
    
    @Autowired
    private OperateLogMapper operateLogMapper<span class="hljs-comment">;</span>
    
    @Autowired
    private HttpServletRequest request<span class="hljs-comment">;</span>
    
    /**
     * 基于注解的切入点 🎯
     */
    @Around("@annotation(logAnnotation)")
    public Object logOperate(ProceedingJoinPoint pjp, Log logAnnotation) throws Throwable {
        // 记录开始时间 ⏰
        long <span class="hljs-attr">startTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        
        // 创建日志对象 📝
        OperateLog <span class="hljs-attr">operateLog</span> = new OperateLog()<span class="hljs-comment">;</span>
        operateLog.setOperateTime(LocalDateTime.now())<span class="hljs-comment">;</span>
        operateLog.setSuccess(true)<span class="hljs-comment">;</span>
        
        // 获取方法信息 🔍
        MethodSignature <span class="hljs-attr">signature</span> = (MethodSignature) pjp.getSignature()<span class="hljs-comment">;</span>
        Method <span class="hljs-attr">method</span> = signature.getMethod()<span class="hljs-comment">;</span>
        
        // 设置基本信息
        operateLog.setClassName(pjp.getTarget().getClass().getName())<span class="hljs-comment">;</span>
        operateLog.setMethodName(method.getName())<span class="hljs-comment">;</span>
        
        // 获取当前用户 👤
        Long <span class="hljs-attr">currentUserId</span> = UserContext.getCurrentUserId()<span class="hljs-comment">;</span>
        operateLog.setOperateUserId(currentUserId)<span class="hljs-comment">;</span>
        
        // 获取请求信息 🌐
        if (request != null) {
            operateLog.setClientIp(getClientIp(request))<span class="hljs-comment">;</span>
            operateLog.setRequestUri(request.getRequestURI())<span class="hljs-comment">;</span>
        }
        
        // 记录方法参数（根据配置） 📄
        if (logAnnotation.recordParams()) {
            Object<span class="hljs-section">[]</span> <span class="hljs-attr">args</span> = pjp.getArgs()<span class="hljs-comment">;</span>
            String<span class="hljs-section">[]</span> <span class="hljs-attr">paramNames</span> = signature.getParameterNames()<span class="hljs-comment">;</span>
            Map&lt;String, Object&gt; <span class="hljs-attr">params</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; args.length; i++) {</span>
                // 过滤掉敏感参数 🚫
                if (!isSensitiveParam(paramNames<span class="hljs-section">[i]</span>)) {
                    params.put(paramNames<span class="hljs-section">[i]</span>, args<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
                }
            }
            operateLog.setMethodParams(params)<span class="hljs-comment">;</span>
        }
        
        Object <span class="hljs-attr">result</span> = null<span class="hljs-comment">;</span>
        try {
            // 执行目标方法 🏃‍♂️
            <span class="hljs-attr">result</span> = pjp.proceed()<span class="hljs-comment">;</span>
            
            // 记录返回值（根据配置） ✅
            if (logAnnotation.recordResult()) {
                operateLog.setReturnValue(result)<span class="hljs-comment">;</span>
            }
            
            // 计算耗时 ⏱️
            long <span class="hljs-attr">endTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
            operateLog.setCostTime(endTime - startTime)<span class="hljs-comment">;</span>
            
            log.info("✅ 操作日志记录成功: {}.{}", 
                    operateLog.getClassName(), 
                    operateLog.getMethodName())<span class="hljs-comment">;</span>
            
        } catch (Throwable throwable) {
            // 记录异常信息 ❌
            operateLog.setSuccess(false)<span class="hljs-comment">;</span>
            operateLog.setErrorMessage(throwable.getMessage())<span class="hljs-comment">;</span>
            operateLog.setCostTime(System.currentTimeMillis() - startTime)<span class="hljs-comment">;</span>
            
            log.error("❌ 操作执行失败: {}", throwable.getMessage())<span class="hljs-comment">;</span>
            throw throwable<span class="hljs-comment">;</span>
            
        } finally {
            // 异步保存日志到数据库 💾
            saveLogAsync(operateLog)<span class="hljs-comment">;</span>
        }
        
        return result<span class="hljs-comment">;</span>
    }
    
    /**
     * 异步保存日志 🚀
     */
    private void saveLogAsync(OperateLog operateLog) {
        CompletableFuture.runAsync(() -&gt; {
            try {
                operateLogMapper.insert(operateLog)<span class="hljs-comment">;</span>
                log.debug("💾 操作日志已保存到数据库")<span class="hljs-comment">;</span>
            } catch (Exception e) {
                log.error("❌ 保存操作日志失败: {}", e.getMessage())<span class="hljs-comment">;</span>
            }
        })<span class="hljs-comment">;</span>
    }
    
    /**
     * 获取客户端IP地址 🌐
     */
    private String getClientIp(HttpServletRequest request) {
        String <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"X-Forwarded-For"</span>)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"Proxy-Client-IP"</span>)<span class="hljs-comment">;</span>
        }
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"WL-Proxy-Client-IP"</span>)<span class="hljs-comment">;</span>
        }
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getRemoteAddr()<span class="hljs-comment">;</span>
        }
        return ip<span class="hljs-comment">;</span>
    }
    
    /**
     * 判断是否为敏感参数 🚫
     */
    private boolean isSensitiveParam(String paramName) {
        List&lt;String&gt; <span class="hljs-attr">sensitiveParams</span> = Arrays.asList(<span class="hljs-string">"password"</span>, <span class="hljs-string">"token"</span>, <span class="hljs-string">"secret"</span>)<span class="hljs-comment">;</span>
        return sensitiveParams.stream()
                .anyMatch(paramName::contains)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-19">七、最佳实践与注意事项 ⚠️</h3>
<h4 data-id="heading-20">1. 性能优化建议 🚀</h4>
<ul>
<li><strong>合理使用切入点表达式</strong>：避免过于宽泛的匹配</li>
<li><strong>异步处理耗时操作</strong>：如数据库日志保存</li>
<li><strong>缓存频繁访问的数据</strong>：如方法签名信息</li>
</ul>
<h4 data-id="heading-21">2. 常见陷阱 🕳️</h4>
<ul>
<li><strong>自调用问题</strong>：同一个类中方法互相调用，AOP不会生效</li>
<li><strong>异常处理</strong>：确保异常被正确处理和传播</li>
<li><strong>内存泄漏</strong>：ThreadLocal使用后必须清理</li>
</ul>
<h4 data-id="heading-22">3. 调试技巧 🔧</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 在通知中打印详细信息</span>
<span class="hljs-variable">@Before</span>(<span class="hljs-string">"execution(* com.example..*.*(..))"</span>)
public void <span class="hljs-built_in">debugAdvice</span>(JoinPoint joinPoint) {
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"🎯 目标类: {}"</span>, joinPoint.<span class="hljs-built_in">getTarget</span>().<span class="hljs-built_in">getClass</span>().<span class="hljs-built_in">getName</span>());
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"🔧 方法名: {}"</span>, joinPoint.<span class="hljs-built_in">getSignature</span>().<span class="hljs-built_in">getName</span>());
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"📋 参数: {}"</span>, Arrays.<span class="hljs-built_in">toString</span>(joinPoint.<span class="hljs-built_in">getArgs</span>()));
}
</code></pre>
<h3 data-id="heading-23">八、总结 🎉</h3>
<p>Spring AOP 是一个强大的面向切面编程框架，它通过动态代理机制实现了横切关注点的模块化。掌握 AOP 可以让你的代码更加：</p>
<ul>
<li>✅ <strong>干净整洁</strong> - 分离关注点</li>
<li>✅ <strong>易于维护</strong> - 集中化管理</li>
<li>✅ <strong>高度复用</strong> - 一处定义，多处使用</li>
<li>✅ <strong>灵活扩展</strong> - 非侵入式增强</li>
</ul>
<p>希望这篇指南能帮助你更好地理解和使用 Spring AOP！Happy coding! 😊👨‍💻👩‍💻</p>
<hr/>
<p><strong>小提示</strong>：在实际项目中，建议将AOP配置放在独立的配置类中，便于管理和维护。记得根据具体业务场景选择合适的通知类型和切入点表达式哦！✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列]]></title>    <link>https://juejin.cn/post/7586500093843849258</link>    <guid>https://juejin.cn/post/7586500093843849258</guid>    <pubDate>2025-12-22T13:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093843849258" data-draft-id="7586540799250350134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-22T13:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐浴露z"/> <meta itemprop="url" content="https://juejin.cn/user/1883894812774922"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1883894812774922/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐浴露z
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:34:44.000Z" title="Mon Dec 22 2025 13:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">场景引入</h2>
<p>正如标题所言，ArrayBlockingQueue是一个阻塞队列的数组实现，如果要生动地描述阻塞队列的应用场景，我想还是餐厅取餐、出餐的场景是最合适的（虽然我想这个场景已经被用烂了）。</p>
<p>试想在学校的窗口取餐，一个窗口是预制好的烤肉拌饭，另一个窗口则是现炒的小炒菜，要如何选择？先把目光移向烤肉拌饭，因为出餐太快，预制好的菜已经放满了窗台前，出餐阿姨只能在窗口闲等，等哪个着急的学生过来拿走一份饭，她才能继续向上摆。再看向小炒菜，由于味道美味，很多学生都想吃，但炒菜的出餐量有限，学生没法立即享受到美味，来晚的只能排队等待。哪怕学生再想吃，窗台前都是空的，没得拿，只有出餐了才能拿。</p>
<p>这就是阻塞队列的典型场景，烤肉拌饭的窗台口已经摆满饭了，阿姨只能阻塞等待有空了再放餐（put操作）。小炒菜的窗口太火爆了，学生要想吃只能阻塞等待，等轮到自己了在取餐（take操作）。</p>
<h2 data-id="heading-1">API介绍</h2>
<h3 data-id="heading-2">放餐操作：add、offer、put</h3>
<p>add: 如果队列容量未满，则插入指定元素; 成功时返回 true，若当前无空位则抛出【IllegalStateException】</p>
<p>offer: 如果队列容量未满，则插入指定元素; 成功时返回 true，若当前无空位则抛出 false</p>
<p>put: 如果队列容量未满，则插入指定元素; 如果满了，则阻塞等待有空位。如果等待时被打断，则抛异常</p>
<p>offer(long timeout, TimeUnit unit): 超时等待的put()。如果等着空了返回true，如果超过timeout还是没有空位，返回false</p>
<h3 data-id="heading-3">取餐操作：take、poll</h3>
<p>poll: 如果队列容量不为空，则取出队列头部并返回。如果为空返回null</p>
<p>take: 如果队列容量不为空，则取出队列头部并返回。如果为空则阻塞等待</p>
<p>poll(long timeout, TimeUnit unit): 超时等待的take()，如果队列容量不为空，则取出队列头部并返回。如果为空则阻塞等待指定时间。如果超过时间还为空，则返回null</p>
<h2 data-id="heading-4">源码分析</h2>
<p>ArrayBlockingQueue的精髓之处就是阻塞等待的处理，因此我将详细分析阻塞 take, put 相关的源码，理解“阻塞”的灵魂所在。</p>
<p>在此之前，我们要先理解ArrayBlockingQueue的结构。从名字来看，这个阻塞队列是以Array为基础的，因此有界就很好理解。它是以数组为基础的，数组的分配必须是连续的空间，这段连续的空间就是阻塞队列的容量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a300ccb221b64b428ea8c38ddfee59a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=UEanjM%2B2fxb4NjAabfrJDj4%2FZ1A%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>同时，我开篇也提到了，这样的阻塞队列必须是线程安全的，它底层使用了ReentrantLock来保证线程的安全。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/309f6e1f41354d2aa664222c0d9f3f7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=6fuKu715vSZAcqGcAPJ8BPBlKPQ%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>为什么还要有Condition？等我们下文看源码就能知道了。</p>
<h3 data-id="heading-5">enqueue、dequeue：入队出队的底层</h3>
<pre><code class="hljs language-ini" lang="ini">//入队操作

private void enqueue(E e) {      
  final Object<span class="hljs-section">[]</span> <span class="hljs-attr">items</span> = this.items<span class="hljs-comment">;    </span>
  items<span class="hljs-section">[putIndex]</span> = e<span class="hljs-comment">;    </span>
  if (++<span class="hljs-attr">putIndex</span> == items.length) 
    <span class="hljs-attr">putIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">;    //如果当前元素入队后队列已满，重置索引，下一次再从队末进</span>
  count++<span class="hljs-comment">;    </span>
  notEmpty.signal()<span class="hljs-comment">;//如果元素加入到空队列中，则唤醒阻塞等待的元素</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>为什么不直接操作items，反而要先定义一个局部变量 <code>final Object[] items = this.items</code> 来接收它？</strong></p>
<p><strong>一、避免多次访问堆内存，提升执行效率</strong></p>
<p>首先要明确 Java 的内存访问特性：</p>
<ul>
<li>
<p><code>this.items</code></p>
<p> 是类的成员变量，存储在<strong>堆内存</strong>中，每次访问 <code>this.items</code> 都需要通过 <code>this</code> 引用（堆地址）去寻址，相对耗时；</p>
</li>
<li>
<p>局部变量 <code>items</code> 存储在<strong>栈内存</strong>中，栈内存的访问速度远快于堆内存，而且局部变量的寻址是直接的，无需额外间接引用。</p>
</li>
</ul>
<p><code>enqueue</code> 方法中多次用到了 <code>items</code>（<code>items[putIndex] = e</code>、<code>putIndex == items.length</code>），如果直接用 <code>this.items</code>，会多次触发堆内存寻址；而先把 <code>this.items</code> 赋值给局部变量，后续只需要访问栈上的局部变量即可，减少了堆内存访问次数，提升了执行效率。</p>
<p><strong>二、防止指令重排导致的可见性问题，保证线程安全</strong></p>
<p><code>ArrayBlockingQueue</code> 是线程安全类，<code>items</code> 是共享成员变量，虽然有 <code>ReentrantLock</code> 保证原子性，但 Java 虚拟机的<strong>指令重排</strong>可能会导致潜在的可见性问题</p>
<p>简单说：<code>final</code> 局部变量相当于给 <code>items</code> 数组拍了一张 “快照”，确保整个 <code>enqueue</code> 方法执行期间，使用的是同一个数组引用，不会因为 JVM 优化而读取到错误的数组对象。</p>
<pre><code class="hljs language-ini" lang="ini">//出队操作
private E dequeue() {      
  final Object<span class="hljs-section">[]</span> <span class="hljs-attr">items</span> = this.items<span class="hljs-comment">;    </span>
  @SuppressWarnings("unchecked")    
  E <span class="hljs-attr">e</span> = (E) items[takeIndex]<span class="hljs-comment">;    //取出队列头部元素</span>
  items<span class="hljs-section">[takeIndex]</span> = null<span class="hljs-comment">;    //设为null</span>
  if (++<span class="hljs-attr">takeIndex</span> == items.length) 
    <span class="hljs-attr">takeIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">;    //与入队对应，回到队末</span>
  count--<span class="hljs-comment">;    </span>
  if (itrs != null)        
    itrs.elementDequeued()<span class="hljs-comment">;    </span>
  notFull.signal()<span class="hljs-comment">;   //唤醒因队列满而阻塞等待的队列，队列有空了 </span>
  return e<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-6">itrs是干什么的？</h4>
<p><strong><code>itrs</code> 是 <code>ArrayBlockingQueue</code> 用来管理当前所有活跃迭代器（Iterator）的集合，目的是保证迭代器的弱一致性，避免迭代过程中出现异常或错误的元素引用</strong>。</p>
<p>当队列执行 <code>dequeue</code> 出队操作（删除队首元素）时，会调用 <code>itrs.elementDequeued()</code>，核心目的是<strong>通知所有活跃迭代器：“某个元素被删除了，你们需要更新自己的状态，避免遍历出错”</strong> 。</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">elementDequeued</span>() {    
<span class="hljs-comment">// assert lock.isHeldByCurrentThread();    </span>
if (count == <span class="hljs-number">0</span>)        
  <span class="hljs-built_in">queueIsEmpty</span>();    
else if (takeIndex == <span class="hljs-number">0</span>)        
  <span class="hljs-built_in">takeIndexWrapped</span>();
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>queueIsEmpty() ：在本次出队后队列变空时，重置迭代器状态（``nextIndex=-1</code>、<code>remaining=0</code>），标记迭代器遍历完毕，避免无效遍历；</p>
<p><code>takeIndexWrapped() ：在本次出队后 ``takeIndex</code> 循环回绕到数组开头时，修正迭代器的 <code>nextWrapped</code> 状态，保证迭代器能正确适配队列的循环结构；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca622d016db4a9285b572f442f15f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=jiv%2Bf%2BIzC4VbEKZKy6z4m8O02AM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">put、take：入队出队的实现</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span>(<span class="hljs-params">E e</span>) throws InterruptedException</span> {    
  Objects.requireNonNull(e);    
  final ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">lock</span>;    
  <span class="hljs-keyword">lock</span>.lockInterruptibly();    
  <span class="hljs-keyword">try</span> {        
    <span class="hljs-keyword">while</span> (count == items.length)            
      notFull.<span class="hljs-keyword">await</span>();        <span class="hljs-comment">//如果队列满了，阻塞等待</span>
    enqueue(e);    
  } <span class="hljs-keyword">finally</span> {        
    <span class="hljs-keyword">lock</span>.unlock();    
  }
}
<span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">take</span>() throws InterruptedException</span> {    
  final ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">lock</span>;    
  <span class="hljs-keyword">lock</span>.lockInterruptibly();    
  <span class="hljs-keyword">try</span> {        
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)            
      notEmpty.<span class="hljs-keyword">await</span>();     <span class="hljs-comment">//如果队列是空的，阻塞等待   </span>
    <span class="hljs-keyword">return</span> dequeue();    
  } <span class="hljs-keyword">finally</span> {        
    <span class="hljs-keyword">lock</span>.unlock();    
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>可以看到，ArrayBlockingQueue使用了ReentrantLock保证了入队出队的线程安全，同时使用了条件变量实现了当队列为空/队列满了的情况下的阻塞等待。</p>
<h2 data-id="heading-8">思考</h2>
<ol>
<li>
<p>可以看到，take、put操作使用的都是同一把ReentrantLock，这说明这两个操作是会互相阻塞的。怎么样才能让这两个操作独立起来？</p>
</li>
<li>
<p>这个数组阻塞队列是强制有界的，如果不确定队列大小的情况下，该怎么处理？</p>
</li>
</ol>
<p>这两个问题在 LinkedBlockingQueue 都给出了答复，有兴趣的可以自行了解。</p>
<blockquote>
<p>我是沐浴露zz，将持续更新有趣的技术，欢迎互动交流！</p>
</blockquote>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[化整为零、分而治之、异步编排：一文读懂现代并发的底层心法]]></title>    <link>https://juejin.cn/post/7586491717873483795</link>    <guid>https://juejin.cn/post/7586491717873483795</guid>    <pubDate>2025-12-22T13:35:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717873483795" data-draft-id="7586540799250448438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="化整为零、分而治之、异步编排：一文读懂现代并发的底层心法"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-22T13:35:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="poemyang"/> <meta itemprop="url" content="https://juejin.cn/user/4487542162594953"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            化整为零、分而治之、异步编排：一文读懂现代并发的底层心法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4487542162594953/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    poemyang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:35:40.000Z" title="Mon Dec 22 2025 13:35:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>LongAdder：化整为零，热点分散</strong><br/>
在Java多线程编程中，‌原子变量（如AtomicLong）‌通过CAS操作实现线程安全的累加。然而，在高并发场景下，大量线程争抢同一原子变量会引发严重的‌缓存一致性问题‌。
‌ 1）缓存行伪共享‌：多个线程频繁更新同一缓存行，导致缓存失效和MESI协议频繁触发，处理器性能急剧下降。
‌ 2）CAS冲突开销‌：CAS操作需自旋重试，线程竞争激烈时重试次数增加，进一步拖慢性能。
为解决上述瓶颈，Java 8引入了‌LongAdder‌，其核心思想是‌“分散竞争，延迟求和‌”。
‌ 1）分段累加‌：将单一累加变量拆分为多个‌分段变量（cells）‌，每个线程仅更新其专属的分段，避免全局竞争。
‌ 2）基础值优化‌：在低并发场景下，直接更新基础值（base），减少分段数组的开销。
‌ 3）最终一致性求和‌：通过遍历所有分段和基础值，延迟计算总和，降低实时竞争压力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdfec7c837c647df92f69dbcc0cc5286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=keDgU8L4xG%2F9mcZwyXfMscW%2FU5I%3D" alt="添加图片注释，不超过 140 字（可选）" loading="lazy"/></p>
<p>LongAdder的内部实现原理，可以用下面的伪代码演示。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAdder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong[] cells; <span class="hljs-comment">// 分段数组，每个线程映射到特定分段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong base;    <span class="hljs-comment">// 基础值，低并发时直接更新</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LongAdder</span><span class="hljs-params">()</span> {
        cells = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 假设初始化16个分段</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cells.length; i++) {
            cells[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始化分段值为0</span>
        }
        base = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始化基础值为0</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> x)</span> {
        <span class="hljs-comment">// 1. 计算线程对应的分段索引（简单取模实现）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Thread.currentThread().getId() % cells.length);
        <span class="hljs-comment">// 2. 对专属分段执行CAS累加，避免全局竞争</span>
        cells[index].addAndGet(x);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sum</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 3. 求和：累加基础值和所有分段值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> base.get();
        <span class="hljs-keyword">for</span> (AtomicLong cell : cells) {
            sum += cell.get();
        }
        <span class="hljs-keyword">return</span> sum;
    }
}
</code></pre>
<p>然而，LongAdder 并非万能钥匙。在并发度较低的场景，AtomicLong 的简单直接反而更高效，就好比小型聚会中，大家直接共享一个果盘更方便，而不需要多个果篮。另外，当需要频繁读取累计结果时，LongAdder 的汇总过程就像逐个篮子统计水果数量，略显繁琐，性能会受影响。Fork/Join：分而治之，任务窃取
Java 7 引入的 ‌Fork/Join Framework‌ 是一种强大的并行编程模型，专为解决“分而治之”（Divide and Conquer）类型的问题而设计。它充分利用多核处理器的计算能力，通过分解任务、并行执行和合并结果，显著提升程序的执行效率。
Fork/Join特别适合处理可以被分解成独立子任务的问题，以实现任务的并行执行，如排序、搜索等。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9e936d2dd42466fbf2a41ca4a59b0d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=x9Xs1A72ZeAHp5W88LXNw7fmRAw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (任务足够小) {
    直接计算并返回结果;
} <span class="hljs-keyword">else</span> {
    将任务拆分为N个子任务;
    对每个子任务调用 fork() 进行并行计算;
    调用 join() 合并子任务的结果;
    返回最终结果;
}
</code></pre>
<p>在Java 8中引入的并行流计算（Parallel stream computing），内部就是采用的ForkJoinPool来实现的。例如，下面使用并行流实现数组并行求和计算。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArray</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>);
         <span class="hljs-comment">// map在实际编程中，可以是耗时高，计算量大的任务</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> numbers.parallelStream().map(i -&gt; i * i).reduce(<span class="hljs-number">0</span>, Integer::sum);
    }
}
</code></pre>
<p><strong>并行编程模型</strong><br/>
并行编程模型（Parallel programming model）是一种用于描述和组织并行计算的框架或范式。它提供了一组抽象概念、编程接口和规范，用于指导开发者在多核处理器、分布式系统或并行计算环境中编写并行程序。
常见的并行编程模型包括：数据并行（Data parallelism）、任务并行（Task parallelism）、多线程并行（Multithread parallelism）等。工作窃取
工作窃取（Work Stealing）是一种高效的并行计算调度策略，其主要目标是解决负载不均衡问题，以充分利用所有的处理器核心，从而提升程序的执行效率。
在工作窃取模型中，每个处理器都维护着自己的双端队列（Deque），用于存储分配给自己的任务。当一个处理器完成了所有自己的任务后，它会尝试从其他处理器的任务队列的末尾“窃取”任务来执行。这种策略确保了所有的处理器都能尽可能地保持忙碌状态，从而提高整体的并行性能。
工作窃取策略的一个显著优点是其能够动态地平衡负载。这意味着它能够适应各种不同的任务分布和处理器性能，从而在各种情况下都能提供优秀的性能。
在实际编程实践中，工作窃取调度策略通常由并行编程框架或库来实现。例如，Java的Fork/Join框架就采用了工作窃取策略来动态地分配任务，C++的Intel TBB（Threading Building Blocks）库也使用了类似的策略。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd68ac1c1a1f42cb9272cf72adc85f5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=Y7art1cA70V8L5W3Xsr1uSY6p4k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>CompletableFuture：构建优雅的异步流水线</strong><br/>
CompletableFuture 是 Java 8 引入的一个核心类，它实现了 Future 接口，并在其基础上提供了更强大、更灵活的异步编程能力。与传统的 Future 相比，CompletableFuture 不仅能够表示一个异步计算的结果，还支持丰富的函数式编程特性，使得开发者能够以声明式的方式处理异步任务的执行流程。
CompletableFuture 的核心优势在于其支持链式调用（Chaining），允许在一个 CompletableFuture 上附加多个操作（如转换结果、处理异常、组合多个任务等）。这些操作会在 CompletableFuture 完成时自动触发，从而形成一个流水线式的任务处理流程。
‌ 以下是一个简单的示例，展示了 ‌CompletableFuture‌ 的链式调用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// supplyAsync方法用于启动一个异步任务，thenApply方法用于在任务完成时对结果进行转换</span>
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
     ......
    <span class="hljs-comment">// 异步任务，模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>;
}).thenApply(result -&gt; {
    <span class="hljs-comment">// 对结果进行转换</span>
    <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
});
<span class="hljs-comment">// 主线程等待异步操作完成</span>
future.join();
<span class="hljs-comment">// 获取异步执行结果</span>
future.get();
</code></pre>
<p><strong>异步编程</strong><br/>
异步编程是一种高效的编程范式，旨在优化程序的执行效率和资源利用率。它通过允许程序在等待耗时操作（如网络请求、文件I/O等）完成的同时，继续执行其他任务，从而避免了传统同步编程中的线程阻塞问题。这种非阻塞的执行方式显著提升了程序的响应速度和并发处理能力，尤其适用于I/O密集型任务。
在传统的同步编程模型中，当一个操作需要较长时间完成时，程序会停滞在该操作上，直到操作结束，这种现象称为阻塞。相比之下，异步编程模型允许程序在启动一个耗时操作后，立即转而执行其他任务，而无需等待该操作完成。当操作完成后，程序会通过回调、事件或Future等机制收到通知，并处理操作结果。
异步编程在多种编程语言中都有应用和实现。例如，Java中的CompletableFuture、JavaScript中的Promise，以及Python中的asyncio库等，都提供了强大的异步编程支持。
以下是一个简单的同步与异步读取文件的对比示例（伪代码）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 同步执行读取文件操作</span>
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> read(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-comment">// 同步等待上次一次文件操作完成</span>
<span class="hljs-type">let</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> read(<span class="hljs-string">"b.txt"</span>);
<span class="hljs-comment">// 假设单个文件读取耗时50ms，一共需要耗时100ms</span>
print(a+b)

<span class="hljs-comment">// 异步执行读取文件操作</span>
<span class="hljs-type">let</span> <span class="hljs-variable">op_a</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">op_b</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"b.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> wait_until_get_ready(op_a);
<span class="hljs-type">let</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> wait_until_get_ready(op_b);
<span class="hljs-comment">// 假设单个文件读取耗时50ms， 由于两次读取文件操作同时异步执行，最终耗时50ms</span>
print(a+b);

fn <span class="hljs-title function_">wait_until_get_ready</span><span class="hljs-params">(Operation)</span> -&gt; Response {
  <span class="hljs-comment">// 阻塞任务，挂起线程，直到operation就绪再唤醒线程（唤醒操作，需要操作系统和硬件的底层支撑）</span>
}
</code></pre>
<p>异步编程可以更有效地处理并发问题。当程序需要同时处理多个任务时，异步编程可以让这些任务并发执行，而不是按顺序一个接一个地执行。然而，异步编程的实现离不开操作系统和硬件的底层支持。如果在异步任务执行完之前，处理线程一直对异步任务执行状态进行空轮询，这将会浪费处理器资源。因此，操作系统和硬件的底层支持，如Linux系统支持的select、poll、epoll等技术，对于异步编程的实现至关重要。
以下是一个没有底层支持时，异步编程可能面临的问题的示例（伪代码）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">let</span> <span class="hljs-variable">op_a</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
<span class="hljs-comment">// 如果没有操作系统和硬件的底层支撑，将不断轮询op_a的任务状态</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> {
  <span class="hljs-keyword">if</span> op_a.is_finish() {
    a = op_a.get_content();
    <span class="hljs-keyword">break</span>;
  }
}
print(a);
</code></pre>
<p><strong>链式调用</strong><br/>
“回调地狱”（Callback Hell）是异步编程中常见的一个问题，尤其在 JavaScript 等单线程、事件驱动型语言中尤为突出。当多个异步操作需要按照特定顺序执行时，开发者可能不得不在一个回调函数中嵌套另一个回调函数，导致代码层级过深、可读性差、难以维护。
以下是一个典型的“回调地狱”示例（JavaScript）。</p>
<pre><code class="hljs language-java" lang="java">login(user =&gt; {
    getStatus(status =&gt; {
        getOrder(order =&gt; {
            getPayment(payment =&gt; {
                getRecommendAdvertisements(ads =&gt; {
                    setTimeout(() =&gt; {
                        alert(ads)
                    }, <span class="hljs-number">1000</span>)
                })
            })
        })
    })
})
</code></pre>
<p>链式调用（Chaining）成为一种常用的优化手段。在 JavaScript 中，‌Promise‌ 机制提供了链式调用的能力。每个 ‌Promise‌ 对象都包含一个 ‌then‌ 方法，该方法返回一个新的 ‌Promise‌ 对象，从而允许开发者将多个异步操作串联起来，形成清晰的逻辑流。
以下是一个使用 ‌Promise‌ 链式调用的示例（JavaScript）。</p>
<pre><code class="hljs language-java" lang="java">login(username, password)
    .then(user =&gt; getStatus(user.id))
    .then(status =&gt; getOrder(status.id))
    .then(order =&gt; getPayment(order.id))
    .then(payment =&gt; getRecommendAdvertisements(payment.total_amount))
    .then(ads =&gt; {<span class="hljs-comment">/*...*/</span>});
</code></pre>
<p>需要注意的是，‌Promise‌ 并不是一种可以将同步代码转变为异步代码的魔法工具。它只是一种编程手法，或者说是一种封装方式，并没有借助操作系统的额外能力。‌Promise‌ 的主要作用是提供了一种更优雅的方式来组织和管理异步操作，使得代码更易于阅读和理解。</p>
<p><strong>总结：与硬件共舞，与冲突和解</strong><br/>
Disruptor的环形缓冲、LongAdder的分散热点、Fork/Join的工作窃取、CompletableFuture的异步编排——这些看似迥异的技术，实则殊途同归。它们共同揭示了现代并发设计的核心要义：与其在冲突发生后被动地加锁仲裁，不如在设计之初就主动地消除冲突。
这标志着并发编程的关注点，已从“如何正确加锁”的战术层面，升华为“如何精妙分工、避免锁”的战略高度。
当摩尔定律的红利逐渐消退，真正的性能突破不再依赖于硬件的暴力堆砌，而是源于软件层面与硬件底层机制的“共舞”。无论是利用缓存行特性的内存对齐，还是借助CAS原子指令的乐观更新，每一次技术优化都印证了一个理念：硬件性能的极致发挥，源于对计算本质的深刻理解。这正是并发编程从技术迈向艺术的精髓所在。</p>
<p><strong>很高兴与你相遇！如果你喜欢本文内容，记得关注哦!!!</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS6 接入快手 SDK 指南]]></title>    <link>https://juejin.cn/post/7586559672129355828</link>    <guid>https://juejin.cn/post/7586559672129355828</guid>    <pubDate>2025-12-23T01:52:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129355828" data-draft-id="7586531677721083939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS6 接入快手 SDK 指南"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-23T01:52:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS6 接入快手 SDK 指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:52:05.000Z" title="Tue Dec 23 2025 01:52:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">介绍</h3>
<p>目前快手开放了 授权、发布单图、发布单视频的鸿蒙能力，开发者如果有需要接入，可以按照以下流程操作。</p>
<h3 data-id="heading-2">效果一览</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2efb24bff1c43b98eca37630f81061b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=SCXwcT%2BvwrYJxaf7yjl4Q0Aa2%2Bo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">环境准备</h3>
<p>开发者需要在快手开放平台完成<strong>注册</strong>，新建一个<strong>应用</strong>，并获取<strong>应用标识 appId</strong> ，详细参考申请注册流程，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.kuaishou.com%2Fplatform" target="_blank" title="https://open.kuaishou.com/platform" ref="nofollow noopener noreferrer">open.kuaishou.com/platform</a></p>
<h3 data-id="heading-4">环境要求</h3>
<ul>
<li>快手版本 &gt;= 13.0.10</li>
<li>鸿蒙SDK版本 &gt;= 12</li>
</ul>
<h3 data-id="heading-5">接入步骤</h3>
<ol>
<li>在模块中引入 SDK依赖，如 Entry模块</li>
</ol>

<pre><code class="hljs language-perl" lang="perl">  <span class="hljs-string">"dependencies"</span>: {    <span class="hljs-string">"@kwai_open_platform/opensdk"</span>: <span class="hljs-string">"^1.0.1"</span>
  }
</code></pre>
<p>2.  在 entry 模块下的 module.json5 文件中添加querySchemes配置。</p>
<blockquote>
<p>在鸿蒙应用的<code>module.json5</code>文件中配置<code>querySchemes</code>的作用是<strong>声明应用支持的URL协议（URL Scheme）</strong> ，允许其他应用或网页通过特定格式的URL调起当前应用。具体解析如下：</p>
<ol>
<li>
<p><strong>核心功能实现</strong>示例中配置的<code>"kwai"</code>和<code>"ksnebula"</code>表示该应用可以响应以下两种格式的URL请求：</p>
</li>
</ol>
<ul>
<li>
<p><code>kwai://...</code></p>
</li>
<li>
<p><code>ksnebula://...</code>当其他应用或系统触发这类链接时，鸿蒙系统会尝试启动当前应用并传递参数。</p>
</li>
</ul>
<ol start="3">
<li>
<p><strong>典型应用场景</strong></p>
</li>
</ol>
<ul>
<li>跨应用跳转：其他应用通过<code>startAbility</code>发送包含对应Scheme的Want对象调起本应用</li>
<li>网页跳转：在浏览器中点击<code>&lt;a href="kwai://detail?id=123"&gt;</code>类链接触发应用打开</li>
<li>广告引流：通过短信、二维码等方式引导用户通过特定Scheme打开应用指定页面</li>
</ul>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"querySchemes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"kwai"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"ksnebula"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>3.  同时还需求申请网络权限</p>

<pre><code class="hljs language-json" lang="json">    <span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
</code></pre>
<p>4.  在接受回调的 UIAbility 的 onCreate 和 onNewWant 方法中，调用 kwaiOpenSdk.handleCallback 方法处理回调数据。</p>
<blockquote>
<p><strong>onCreate</strong> 表示应用首次启动</p>
<p><strong>onNewWant</strong> 表示应用已经启动的，然后被重新拉起</p>
</blockquote>
<pre><code class="hljs language-php" lang="php">import { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;

export <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIAbility</span> </span>{
  <span class="hljs-title function_ invoke__">onCreate</span>(<span class="hljs-attr">want</span>: Want, <span class="hljs-attr">launchParam</span>: AbilityConstant.LaunchParam): <span class="hljs-keyword">void</span> {
    kwaiOpenSdk.<span class="hljs-title function_ invoke__">handleCallback</span>(want)
  }

  <span class="hljs-title function_ invoke__">onNewWant</span>(<span class="hljs-attr">want</span>: Want, <span class="hljs-attr">launchParam</span>: AbilityConstant.LaunchParam): <span class="hljs-keyword">void</span> {
    kwaiOpenSdk.<span class="hljs-title function_ invoke__">handleCallback</span>(want)
  }
}
</code></pre>
<p>5.  初始化SDK，如在 Index.ets的aboutToAppear中初始化</p>

<pre><code class="hljs language-csharp" lang="csharp">  aboutToAppear(): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>.context);
  }
</code></pre>
<h3 data-id="heading-6">相关功能</h3>
<p>目前SDK提供有 授权 和 发布单图和发单视频能力，开发者可以根据需求引入使用</p>
<h4 data-id="heading-7">初始化代码数据</h4>
<blockquote>
<p>定义快手应用ID <strong>APPID</strong></p>
<p>定义鸿蒙应用ID  harmonyAppID</p>
<p>定义媒体选择通用方法 <strong>selectMedia</strong></p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导入快手开放平台SDK</span>
<span class="hljs-keyword">import</span> { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;
<span class="hljs-comment">// 导入AbilityKit相关组件</span>
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-comment">// 导入授权请求模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/AuthRequest'</span>;
<span class="hljs-comment">// 导入授权响应模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/response/AuthResponse'</span>;
<span class="hljs-comment">// 导入日志工具</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/utils/Logger'</span>;
<span class="hljs-comment">// 导入分享请求模型创建函数</span>
<span class="hljs-keyword">import</span> {
  createSingleImagePublish,
  createSingleVideoPublish
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/ShareRequest'</span>;
<span class="hljs-comment">// 导入ArkTS集合框架</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrayList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;
<span class="hljs-comment">// 导入媒体库访问助手</span>
<span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-comment">// 导入文件操作相关工具</span>
<span class="hljs-keyword">import</span> { fileIo, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

<span class="hljs-comment">// 定义快手应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APPID</span> = <span class="hljs-string">"ks669910448092164647"</span>

<span class="hljs-comment">// 定义鸿蒙应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">harmonyAppID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"6917560710208292268"</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 获取UIAbility上下文</span>
  context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-comment">// 回调结果状态</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">callbackResult</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 授权码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">authCode</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误信息</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errMsg</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  }


  <span class="hljs-comment">// 媒体选择通用方法</span>
  <span class="hljs-keyword">private</span> selectMedia&lt;T&gt;(
    <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">t: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
    <span class="hljs-attr">type</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span> | photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>,
    <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>
  ) {
    <span class="hljs-comment">// 创建照片选择选项</span>
    <span class="hljs-keyword">let</span> photoOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();
    <span class="hljs-comment">// 设置MIME类型（图片或视频）</span>
    photoOptions.<span class="hljs-property">MIMEType</span> = <span class="hljs-keyword">type</span>;
    <span class="hljs-comment">// 设置最大选择数量</span>
    photoOptions.<span class="hljs-property">maxSelectNumber</span> = num;

    <span class="hljs-comment">// 创建照片选择器</span>
    <span class="hljs-keyword">let</span> picker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();
    <span class="hljs-comment">// 调用选择方法</span>
    picker.<span class="hljs-title function_">select</span>(photoOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {
      <span class="hljs-comment">// 获取选中的URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = photoSelectResult.<span class="hljs-property">photoUris</span>;
      <span class="hljs-keyword">if</span> (uris.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 获取第一个URI</span>
        <span class="hljs-keyword">let</span> str = uris[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 提取文件名</span>
        <span class="hljs-keyword">let</span> fileName = str.<span class="hljs-title function_">substring</span>(str.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
        <span class="hljs-comment">// 构建目标文件路径</span>
        <span class="hljs-keyword">let</span> desFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">tempDir</span> + fileName;
        <span class="hljs-comment">// 打开源文件（只读）</span>
        <span class="hljs-keyword">let</span> srcFile = fileIo.<span class="hljs-title function_">openSync</span>(str, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);
        <span class="hljs-comment">// 打开目标文件（写，如不存在则创建）</span>
        <span class="hljs-keyword">let</span> desFile = fileIo.<span class="hljs-title function_">openSync</span>(desFilePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);
        <span class="hljs-comment">// 复制文件内容</span>
        fileIo.<span class="hljs-title function_">copyFileSync</span>(srcFile.<span class="hljs-property">fd</span>, desFile.<span class="hljs-property">fd</span>)
        <span class="hljs-comment">// 回调处理，传递文件URI</span>
        callback?.(fileUri.<span class="hljs-title function_">getUriFromPath</span>(desFilePath) <span class="hljs-keyword">as</span> T);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未选择资源时显示提示</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">'没有选择资源'</span>
        })
      }
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      <span class="hljs-comment">// 选择出错时显示提示</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">'选择资源error'</span>
      })
    })
  }
}
</code></pre>
<h4 data-id="heading-8">接入快手授权能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d1f69d57684e85ae3b0522390890f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=DHyx5S3XDq9L1R2vqMBsgJu3js0%3D" alt="图片" loading="lazy"/></p>
<p>参数说明:</p>
<p>参数</p>
<p>说明</p>
<p>是否必填</p>
<p>requiredScopes</p>
<p>申请获取用户的那些授权信息，如果需要多个scope，用 “,” 分割。比如：user_info,user_phone</p>
<p>是</p>
<p>optional0Scopes</p>
<p>可选scope，授权页可以取消勾选，默非认勾选态</p>
<p>否</p>
<p>optional1Scopes</p>
<p>可选scope，授权页可以取消勾选，默认勾选态</p>
<p>否</p>
<p>callbackLocalEntry</p>
<p>回调的UIAbility名称，需要在module.json中声明</p>
<p>是</p>
<p>abilityContext</p>
<p>如果没有安装快手，会跳转到应用市场安装。不传则不会跳转到应用市场</p>
<p>否</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 授权功能实现</span>
  fn1 = <span class="hljs-function">() =&gt;</span> {
    {
      <span class="hljs-comment">// 创建授权请求对象</span>
      <span class="hljs-keyword">let</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthRequest</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 设置必需的权限范围</span>
      request.<span class="hljs-property">requiredScopes</span> = <span class="hljs-string">"user_phone,user_info"</span>;
      <span class="hljs-comment">// 设置可选权限范围0</span>
      request.<span class="hljs-property">optional0Scopes</span> = <span class="hljs-string">"user_base,share_media,following,share_message"</span>
      <span class="hljs-comment">// 设置可选权限范围1</span>
      request.<span class="hljs-property">optional1Scopes</span> = <span class="hljs-string">"user_growth_distribution,message,live,relation"</span>
      <span class="hljs-comment">// 设置回调入口</span>
      request.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 设置Ability上下文</span>
      request.<span class="hljs-property">abilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      request.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK授权接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">authorize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, request, {
        <span class="hljs-comment">// 授权成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">"success......."</span>);
          <span class="hljs-comment">// 保存授权码</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">authCode</span> = (res <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthResponse</span>).<span class="hljs-property">code</span>;
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
        },
        <span class="hljs-comment">// 授权失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
        }
      })
    }
  }
</code></pre>
<h4 data-id="heading-9">授权-错误码</h4>
<p>错误码</p>
<p>描述</p>
<p>999</p>
<p>成功</p>
<p>1000</p>
<p>appId is empty</p>
<p>1001</p>
<p>request is error</p>
<p>1002</p>
<p>request is empty</p>
<p>1003</p>
<p>request bundle id is empty</p>
<p>1004</p>
<p>request harmony app id is empty</p>
<p>1005</p>
<p>not install kuaishou app</p>
<p>2000</p>
<p>auth request requiredScopes is empty</p>
<p>2002</p>
<p>无效的授权内容</p>
<p>2101</p>
<p>提交授权信息失败，缺少授权参数</p>
<p>100200100</p>
<p>请求缺少参数或参数类型错误</p>
<p>100200101</p>
<p>无效的client，无效的 app 或 developer，可能是验证参数不正确（回调地址等信息）</p>
<p>100200102</p>
<p>请求被拒绝，可能是无效的 token 等</p>
<p>100200103</p>
<p>请求的 responseType 错误</p>
<p>100200104</p>
<p>请求的 grantType 不支持</p>
<p>100200105</p>
<p>请求的 code 错误</p>
<p>100200106</p>
<p>请求的 scope 错误</p>
<p>100200107</p>
<p>无效的 openid</p>
<p>100200108</p>
<p>access_token过期</p>
<p>100200109</p>
<p>用户取消该 app 授权</p>
<p>100200110</p>
<p>用户授权过期</p>
<p>100200111</p>
<p>用户未授权过</p>
<p>100200112</p>
<p>bundleToken不合法</p>
<p>100200113</p>
<p>refresh_token过期</p>
<p>100200500</p>
<p>服务内部错误</p>
<h4 data-id="heading-10">接入发布单图能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e45648e69f8d4128881e4695df231e5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=JGyeCEueX6yHa39i64aDS9EMY%2Bk%3D" alt="图片" loading="lazy"/></p>
<ol>
<li><strong>分享请求构建</strong>：</li>
<li>使用<code>createSingleImagePublish(APPID)</code>创建单图分享请求对象</li>
<li>初始化<code>ArrayList</code>存储媒体URI列表，并添加选中图片的URI</li>
<li>设置<code>callbackLocalEntry</code>指定回调入口为<strong>EntryAbility</strong></li>
<li><strong>关键参数配置</strong>：</li>
<li>显式设置<code>harmonyAppId</code>参数（注释提示该行代码具有重要性）</li>
<li>通过上下文<code>this.context</code>保持与当前页面的关联</li>
<li><strong>SDK调用与结果处理</strong>：</li>
</ol>
<p>调用<code>kwaiOpenSdk.createApi().share()</code>方法执行实际分享操作</p>
<pre><code class="hljs language-typescript" lang="typescript">  fn2 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定图片类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单图分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleImagePublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的图片URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID

      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>);
  }
</code></pre>
<h4 data-id="heading-11">接入发布单视频能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63f49a52ff4a4256b69c2fd950e84b56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=EFFPl7pdS2xGPvci74YRiep%2BS7g%3D" alt="图片" loading="lazy"/></p>
<ol>
<li><strong>视频分享请求构建</strong></li>
</ol>
<ul>
<li>初始化<code>ArrayList</code>容器</li>
<li>将视频URI添加到容器</li>
<li>设置请求的<code>mediaUri</code>属性为容器对象</li>
</ul>
<ol>
<li>对象创建：<code>createSingleVideoPublish(APPID)</code>生成视频分享请求对象（区别于图片接口）</li>
<li>媒体列表管理：</li>
<li><strong>关键参数配置</strong></li>
<li><code>callbackLocalEntry</code>指定回调入口为"EntryAbility"（需与实际Ability名称一致）</li>
<li><code>harmonyAppId</code>显式赋值（通过独立变量<code>harmonyAppID</code>注入，需确保配置有效性）</li>
<li><strong>SDK调用与响应处理</strong></li>
</ol>
<p>通过<code>kwaiOpenSdk.createApi().share()</code>发起分享请求，传入上下文对象和配置参</p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-comment">// 发布单视频功能实现</span>
  fn3 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定视频类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单视频分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleVideoPublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的视频URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>);
  }
</code></pre>
<h4 data-id="heading-12">发布单图-发布单视频的错误码</h4>
<p>错误码</p>
<p>描述</p>
<p>999</p>
<p>成功</p>
<p>1000</p>
<p>appId is empty</p>
<p>1001</p>
<p>request is error</p>
<p>1002</p>
<p>request is empty</p>
<p>1003</p>
<p>request bundle id is empty</p>
<p>1004</p>
<p>request harmony app id is empty</p>
<p>1005</p>
<p>not install kuaishou app</p>
<p>3000</p>
<p>用户取消</p>
<p>3001</p>
<p>框架出错，请反馈客服</p>
<p>3002</p>
<p>参数错误，包含shareType、appId、harmonyId、mediaUri等相关参数</p>
<p>3003</p>
<p>打开发布页失败</p>
<p>3004</p>
<p>网络错误</p>
<p>3005</p>
<p>发布请求过于频繁（3s内重复调用）</p>
<p>3006</p>
<p>视频size超过最大大小</p>
<p>3007</p>
<p>图片size超过最大大小</p>
<p>3008</p>
<p>拒绝当次分享动作；如果是发布视频:请检查视频长度</p>
<p>3009</p>
<p>鉴权失败</p>
<h3 data-id="heading-13">完整 Index.ets 代码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导入快手开放平台SDK</span>
<span class="hljs-keyword">import</span> { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;
<span class="hljs-comment">// 导入AbilityKit相关组件</span>
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-comment">// 导入授权请求模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/AuthRequest'</span>;
<span class="hljs-comment">// 导入授权响应模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/response/AuthResponse'</span>;
<span class="hljs-comment">// 导入日志工具</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/utils/Logger'</span>;
<span class="hljs-comment">// 导入分享请求模型创建函数</span>
<span class="hljs-keyword">import</span> {
  createSingleImagePublish,
  createSingleVideoPublish
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/ShareRequest'</span>;
<span class="hljs-comment">// 导入ArkTS集合框架</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrayList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;
<span class="hljs-comment">// 导入媒体库访问助手</span>
<span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-comment">// 导入文件操作相关工具</span>
<span class="hljs-keyword">import</span> { fileIo, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

<span class="hljs-comment">// 定义快手应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APPID</span> = <span class="hljs-string">"ks669910448092164647"</span>

<span class="hljs-comment">// 定义鸿蒙应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">harmonyAppID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"6917560710208292268"</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 获取UIAbility上下文</span>
  context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-comment">// 回调结果状态</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">callbackResult</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 授权码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">authCode</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误信息</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errMsg</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  }

  <span class="hljs-comment">// 授权功能实现</span>
  fn1 = <span class="hljs-function">() =&gt;</span> {
    {
      <span class="hljs-comment">// 创建授权请求对象</span>
      <span class="hljs-keyword">let</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthRequest</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 设置必需的权限范围</span>
      request.<span class="hljs-property">requiredScopes</span> = <span class="hljs-string">"user_phone,user_info"</span>;
      <span class="hljs-comment">// 设置可选权限范围0</span>
      request.<span class="hljs-property">optional0Scopes</span> = <span class="hljs-string">"user_base,share_media,following,share_message"</span>
      <span class="hljs-comment">// 设置可选权限范围1</span>
      request.<span class="hljs-property">optional1Scopes</span> = <span class="hljs-string">"user_growth_distribution,message,live,relation"</span>
      <span class="hljs-comment">// 设置回调入口</span>
      request.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 设置Ability上下文</span>
      request.<span class="hljs-property">abilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      request.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK授权接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">authorize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, request, {
        <span class="hljs-comment">// 授权成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">"success......."</span>);
          <span class="hljs-comment">// 保存授权码</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">authCode</span> = (res <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthResponse</span>).<span class="hljs-property">code</span>;
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
        },
        <span class="hljs-comment">// 授权失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
        }
      })
    }
  }
  <span class="hljs-comment">// 发布单图功能实现</span>
  fn2 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定图片类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单图分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleImagePublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的图片URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID

      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>);
  }
  <span class="hljs-comment">// 发布单视频功能实现</span>
  fn3 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定视频类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单视频分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleVideoPublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的视频URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"授权"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn1</span>)
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"发布单图"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn2</span>)
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"发布单视频"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn3</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }

  <span class="hljs-comment">// 媒体选择通用方法</span>
  <span class="hljs-keyword">private</span> selectMedia&lt;T&gt;(
    <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">t: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
    <span class="hljs-attr">type</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span> | photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>,
    <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>
  ) {
    <span class="hljs-comment">// 创建照片选择选项</span>
    <span class="hljs-keyword">let</span> photoOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();
    <span class="hljs-comment">// 设置MIME类型（图片或视频）</span>
    photoOptions.<span class="hljs-property">MIMEType</span> = <span class="hljs-keyword">type</span>;
    <span class="hljs-comment">// 设置最大选择数量</span>
    photoOptions.<span class="hljs-property">maxSelectNumber</span> = num;

    <span class="hljs-comment">// 创建照片选择器</span>
    <span class="hljs-keyword">let</span> picker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();
    <span class="hljs-comment">// 调用选择方法</span>
    picker.<span class="hljs-title function_">select</span>(photoOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {
      <span class="hljs-comment">// 获取选中的URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = photoSelectResult.<span class="hljs-property">photoUris</span>;
      <span class="hljs-keyword">if</span> (uris.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 获取第一个URI</span>
        <span class="hljs-keyword">let</span> str = uris[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 提取文件名</span>
        <span class="hljs-keyword">let</span> fileName = str.<span class="hljs-title function_">substring</span>(str.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
        <span class="hljs-comment">// 构建目标文件路径</span>
        <span class="hljs-keyword">let</span> desFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">tempDir</span> + fileName;
        <span class="hljs-comment">// 打开源文件（只读）</span>
        <span class="hljs-keyword">let</span> srcFile = fileIo.<span class="hljs-title function_">openSync</span>(str, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);
        <span class="hljs-comment">// 打开目标文件（写，如不存在则创建）</span>
        <span class="hljs-keyword">let</span> desFile = fileIo.<span class="hljs-title function_">openSync</span>(desFilePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);
        <span class="hljs-comment">// 复制文件内容</span>
        fileIo.<span class="hljs-title function_">copyFileSync</span>(srcFile.<span class="hljs-property">fd</span>, desFile.<span class="hljs-property">fd</span>)
        <span class="hljs-comment">// 回调处理，传递文件URI</span>
        callback?.(fileUri.<span class="hljs-title function_">getUriFromPath</span>(desFilePath) <span class="hljs-keyword">as</span> T);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未选择资源时显示提示</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">'没有选择资源'</span>
        })
      }
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      <span class="hljs-comment">// 选择出错时显示提示</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">'选择资源error'</span>
      })
    })
  }
}
</code></pre>
<h3 data-id="heading-14">参考文档</h3>
<ol>
<li><strong>@kwai_open_platform/opensdk(V1.0.1)</strong></li>
</ol>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.kuaishou.com%2FplatformDocs%2Fdevelop%2Fmobile-app%2FHarmony-OS.html%23%25E4%25B8%2580%25E3%2580%2581%25E8%25AE%25BE%25E8%25AE%25A1%25E7%259B%25AE%25E6%25A0%2587" target="_blank" title="https://open.kuaishou.com/platformDocs/develop/mobile-app/Harmony-OS.html#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87" ref="nofollow noopener noreferrer">open.kuaishou.com/platformDoc…</a></p>
</blockquote>
<ol start="2">
<li><strong>快手接入鸿蒙应用指南</strong></li>
</ol>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40kwai_open_platform%252Fopensdk" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@kwai_open_platform%2Fopensdk" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust常用集合]]></title>    <link>https://juejin.cn/post/7586482860104073243</link>    <guid>https://juejin.cn/post/7586482860104073243</guid>    <pubDate>2025-12-22T13:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860104073243" data-draft-id="7586504691845578761" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust常用集合"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T13:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust常用集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:44:26.000Z" title="Mon Dec 22 2025 13:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Rust 的标准库（std::collections）提供了多种通用的集合数据结构。与基础的数组和元组不同，这些集合存储在 <strong>堆（Heap）</strong> 上，这意味着它们的大小可以在运行时动态增长或缩小。</p>
<h2 data-id="heading-0">1. 动态数组：<code>Vec&lt;T&gt;</code> (Vector)</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

    <span class="hljs-comment">// 增加元素</span>
    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">4</span>);
    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">5</span>);

    <span class="hljs-comment">// 读取元素 (索引方式)</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">third</span> = &amp;v[<span class="hljs-number">2</span>]; 
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"第三个元素是: {}"</span>, third);

    <span class="hljs-comment">// 安全读取 (get 方法，返回 Option)</span>
    <span class="hljs-keyword">match</span> v.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">10</span>) {
        <span class="hljs-title function_ invoke__">Some</span>(val) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"找到了: {}"</span>, val),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"索引越界，没有第11个元素"</span>),
    }

    <span class="hljs-comment">// 遍历</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;v {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
    }
}
</code></pre>
<h2 data-id="heading-1">2. 字符串：String</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Hello"</span>);

    <span class="hljs-comment">// 更新</span>
    s.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">", Rust!"</span>); <span class="hljs-comment">// 追加字符串切片</span>
    s.<span class="hljs-title function_ invoke__">push</span>('🚀');          <span class="hljs-comment">// 追加单个字符</span>

    <span class="hljs-comment">// 合并字符串</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"tic"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s2</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"tac"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s3</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}-{}-{}"</span>, s1, s2, <span class="hljs-string">"toe"</span>); <span class="hljs-comment">// 使用 format! 宏不获取所有权</span>
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s3); <span class="hljs-comment">// tic-tac-toe</span>
}
</code></pre>
<h2 data-id="heading-2">3. 哈希映射：HashMap&lt;K, V&gt;</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::collections::HashMap;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">scores</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-comment">// 插入数据</span>
    scores.<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Blue"</span>), <span class="hljs-number">10</span>);
    scores.<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Yellow"</span>), <span class="hljs-number">50</span>);

    <span class="hljs-comment">// 查询数据</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">team_name</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Blue"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">score</span> = scores.<span class="hljs-title function_ invoke__">get</span>(&amp;team_name); <span class="hljs-comment">// 返回 Option&lt;&amp;i32&gt;</span>

    <span class="hljs-comment">// 遍历</span>
    <span class="hljs-title function_ invoke__">for</span> (key, value) <span class="hljs-keyword">in</span> &amp;scores {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}: {}"</span>, key, value);
    }

    <span class="hljs-comment">// 只有当键不存在时才插入 (Entry API)</span>
    scores.<span class="hljs-title function_ invoke__">entry</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Red"</span>)).<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-number">30</span>);
}
</code></pre>













































<table><thead><tr><th align="left">集合</th><th align="left">核心逻辑</th><th align="left">典型应用场景</th></tr></thead><tbody><tr><td align="left"><strong><code>Vec&lt;T&gt;</code></strong></td><td align="left">连续内存的动态数组</td><td align="left">存储线性数据、任务清单、缓冲区。这是最通用的集合。</td></tr><tr><td align="left"><strong><code>String</code></strong></td><td align="left">UTF-8 编码的文本</td><td align="left">存储和处理动态文本、用户输入、格式化字符串。</td></tr><tr><td align="left"><strong><code>HashMap&lt;K, V&gt;</code></strong></td><td align="left">哈希键值对映射</td><td align="left">数据库索引模拟、缓存系统、统计（如单词计数）。</td></tr><tr><td align="left"><strong><code>VecDeque&lt;T&gt;</code></strong></td><td align="left">双端队列（环形缓冲区）</td><td align="left">实现先进先出（FIFO）队列、广度优先搜索（BFS）。</td></tr><tr><td align="left"><strong><code>HashSet&lt;T&gt;</code></strong></td><td align="left">唯一值的哈希集合</td><td align="left">数据去重、成员身份快速验证（判断某项是否存在）。</td></tr><tr><td align="left"><strong><code>BTreeMap&lt;K, V&gt;</code></strong></td><td align="left">基于 B 树的有序映射</td><td align="left">需要按键（Key）排序存储数据，或进行范围查询时。</td></tr><tr><td align="left"><strong><code>BinaryHeap&lt;T&gt;</code></strong></td><td align="left">二叉堆（优先队列）</td><td align="left">始终获取最大/最小值的场景，如任务调度、Dijkstra 算法。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[axios 的 withCredentials 到底做了什么？]]></title>    <link>https://juejin.cn/post/7586479864271716358</link>    <guid>https://juejin.cn/post/7586479864271716358</guid>    <pubDate>2025-12-22T10:17:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864271716358" data-draft-id="7586491717872910355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="axios 的 withCredentials 到底做了什么？"/> <meta itemprop="keywords" content="前端,JavaScript,HTTP"/> <meta itemprop="datePublished" content="2025-12-22T10:17:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RichardMiao"/> <meta itemprop="url" content="https://juejin.cn/user/2330620379279950"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            axios 的 withCredentials 到底做了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620379279950/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RichardMiao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:17:02.000Z" title="Mon Dec 22 2025 10:17:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、核心结论</h3>
<p><code>withCredentials</code> 是 axios 中控制<strong>跨域请求是否携带凭证（Cookie、HTTP 认证信息、TLS 客户端证书等）</strong> 的布尔值配置项，本质是对浏览器 <code>XMLHttpRequest.withCredentials</code> 原生属性的封装，默认值为 <code>false</code>。</p>
<p>简单说：</p>
<ul>
<li><code>withCredentials: false</code>（默认）：跨域请求时，浏览器<strong>不会</strong>携带目标域名下的 Cookie/认证信息；</li>
<li><code>withCredentials: true</code>：跨域请求时，浏览器<strong>会</strong>主动携带目标域名下的 Cookie/认证信息，且服务端响应的 Set-Cookie 也会生效。</li>
</ul>
<blockquote>
<p>注意：该配置<strong>仅对跨域请求有效</strong>，同域请求不受影响（默认携带凭证）。</p>
</blockquote>
<h3 data-id="heading-1">二、底层原理：浏览器的同源策略 &amp; CORS 规范</h3>
<p>要理解 <code>withCredentials</code>，必须先明确浏览器的核心规则：</p>
<h4 data-id="heading-2">1. 同源策略的限制</h4>
<p>浏览器默认禁止跨域请求携带凭证（比如 A 域名请求 B 域名接口时，不会带 B 域名的 Cookie），这是为了防止第三方网站盗用用户的认证信息。</p>
<h4 data-id="heading-3">2. CORS 规范对凭证的要求</h4>
<p>当前端设置 <code>withCredentials: true</code> 时，必须满足<strong>服务端+客户端</strong>双向配置，否则请求会被浏览器拦截：</p>

















<table><thead><tr><th>端</th><th>必要配置</th></tr></thead><tbody><tr><td>前端（axios）</td><td><code>withCredentials: true</code></td></tr><tr><td>服务端</td><td>响应头必须包含：<br/>1. <code>Access-Control-Allow-Credentials: true</code><br/>2. <code>Access-Control-Allow-Origin</code> 不能为 <code>*</code>（必须是具体域名，如 <code>https://xxx.com</code>）</td></tr></tbody></table>
<h3 data-id="heading-4">三、<code>withCredentials</code> 具体行为拆解</h3>
<h4 data-id="heading-5">1. 当 <code>withCredentials: false</code>（默认）</h4>
<ul>
<li>请求阶段：浏览器发送跨域请求时，<strong>不会携带</strong>目标域名的 Cookie、Authorization 头等凭证；</li>
<li>响应阶段：即使服务端返回 <code>Set-Cookie</code> 响应头，浏览器也<strong>不会保存</strong>该 Cookie（相当于忽略）；</li>
<li>场景：无需用户认证的跨域请求（如公开接口、静态资源）。</li>
</ul>
<h4 data-id="heading-6">2. 当 <code>withCredentials: true</code></h4>
<ul>
<li>请求阶段：浏览器主动携带目标域名下的 Cookie（仅该域名的 Cookie，非当前域名）、HTTP 认证信息（如 Basic Auth）；</li>
<li>响应阶段：
✅ 若服务端返回 <code>Access-Control-Allow-Credentials: true</code> + 具体的 <code>Access-Control-Allow-Origin</code>：浏览器会保存服务端的 <code>Set-Cookie</code>，且后续请求会自动携带；
❌ 若服务端未满足上述条件：浏览器会触发 CORS 错误，拦截响应（控制台报错：<code>Access to XMLHttpRequest at 'xxx' from origin 'xxx' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'</code>）；</li>
<li>场景：需要用户登录态的跨域请求（如登录后获取用户信息、提交订单）。</li>
</ul>
<h3 data-id="heading-7">四、典型使用场景 &amp; 示例</h3>
<h4 data-id="heading-8">场景：前端（<code>http://localhost:3000</code>）请求后端（<code>http://api.example.com</code>）的登录接口</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// axios 配置（前端）</span>
<span class="hljs-title function_">axios</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://api.example.com/user/info'</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 跨域携带 Cookie（后端域名下的登录 Cookie）</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err));
</code></pre>
<h4 data-id="heading-9">服务端配置（以 Node.js/Express 为例）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 跨域中间件配置</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 允许指定前端域名跨域（不能用 *）</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'http://localhost:3000'</span>);
  <span class="hljs-comment">// 允许携带凭证</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  <span class="hljs-comment">// 允许的请求头</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type'</span>);
  <span class="hljs-title function_">next</span>();
});

<span class="hljs-comment">// 接口返回用户信息（依赖 Cookie 中的登录态）</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user/info'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);
</code></pre>
<h3 data-id="heading-10">五、常见坑点</h3>
<ol>
<li>
<p><strong><code>Access-Control-Allow-Origin</code> 不能为 <code>*</code></strong>：
若服务端设置 <code>*</code>，同时前端开了 <code>withCredentials: true</code>，浏览器会直接拦截请求（因为 <code>*</code> 无法和具体域名的凭证绑定）。</p>
</li>
<li>
<p><strong>跨域 Cookie 的 SameSite 限制</strong>：
若服务端设置的 Cookie 的 <code>SameSite</code> 为 <code>Strict</code>/<code>Lax</code>，跨域请求时即使开了 <code>withCredentials</code>，Cookie 也可能无法携带（需设置 <code>SameSite=None; Secure</code>，且请求必须是 HTTPS）。</p>
</li>
<li>
<p><strong>凭证仅对目标域名生效</strong>：
比如前端 <code>a.com</code> 请求 <code>b.com</code>，<code>withCredentials: true</code> 只会携带 <code>b.com</code> 的 Cookie，而非 <code>a.com</code> 的 Cookie。</p>
</li>
<li>
<p><strong>预检请求（OPTIONS）也需配置</strong>：
复杂请求（如 POST 带 JSON、自定义头）会先发送 OPTIONS 预检请求，服务端必须对 OPTIONS 请求返回相同的 CORS 配置（尤其是 <code>Access-Control-Allow-Credentials</code>）。</p>
</li>
</ol>
<h3 data-id="heading-11">六、总结</h3>
<p><code>withCredentials</code> 的核心作用是<strong>突破浏览器同源策略对跨域凭证的限制</strong>，让跨域请求能携带 Cookie/认证信息，但必须配合服务端的 CORS 配置才能生效。它是实现跨域登录态保持的关键配置，也是处理跨域认证请求的必备项。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React父子组件回调传参避坑指南：从基础到进阶实践]]></title>    <link>https://juejin.cn/post/7586506307726442506</link>    <guid>https://juejin.cn/post/7586506307726442506</guid>    <pubDate>2025-12-22T10:51:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726442506" data-draft-id="7586505172814921779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React父子组件回调传参避坑指南：从基础到进阶实践"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-22T10:51:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React父子组件回调传参避坑指南：从基础到进阶实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:51:29.000Z" title="Mon Dec 22 2025 10:51:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>在React开发中，父子组件间的通信是高频需求，其中通过回调函数传递参数更是核心场景。但很多开发者在实际编码中会遇到诸如“参数传不到”“函数提前执行”“组件无限渲染”等问题。本文结合实际开发案例，拆解回调传参的核心逻辑，剖析常见错误，给出不同场景下的最优实践，帮你彻底搞懂React回调传参。</p>
</blockquote>
<h2 data-id="heading-0">一、场景引入：从实际代码看问题</h2>
<p>先看一段大家可能写过的代码，这是父组件中向子组件传递刷新回调的场景：</p>
<pre><code class="hljs language-ini" lang="ini">// 父组件核心代码
const <span class="hljs-attr">fetchData</span> = async (showLoading = <span class="hljs-literal">true</span>) =&gt; {
  if (!appName) return<span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">res</span> = await getProductDetail({ appName, loading: showLoading })<span class="hljs-comment">;</span>
    setData(res)<span class="hljs-comment">;</span>
  } catch (error) {
    console.error(error)<span class="hljs-comment">;</span>
  } finally {
    setLoading(false)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 向子组件传递回调
if (<span class="hljs-attr">keyway</span> === <span class="hljs-number">200</span> || keyway === <span class="hljs-number">300</span>) {
  return &lt;AuditPending 
    <span class="hljs-attr">data</span>={data} 
    <span class="hljs-attr">onRefresh</span>={(showLoading) =&gt; { fetchData(showLoading) }} 
  /&gt;<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在这个场景中，你可能会有这些疑问：</p>
<ul>
<li>onRefresh里的箭头函数为什么要包裹一层，直接写onRefresh={fetchData}不行吗？</li>
<li>为什么绝对不能写成onRefresh={fetchData()}？</li>
<li>直接传函数引用和用箭头函数包裹，哪种写法更好？</li>
</ul>
<p>要解答这些问题，我们首先要理清一个核心概念：<strong>函数引用 vs 函数执行结果</strong>。</p>
<h2 data-id="heading-1">二、核心概念：搞懂这两个区别，少踩80%的坑</h2>
<p>在React回调传参中，“是否加括号”“是否用箭头函数”的本质，都是在区分“传递函数引用”和“传递函数执行结果”。</p>
<h3 data-id="heading-2">1. 函数引用：传递“函数本身”</h3>
<p>当我们写 <code>onRefresh={fetchData}</code> 时，传递给子组件的是 <code>fetchData</code> 这个函数的“引用”（可以理解为函数的“地址”）。</p>
<p>核心特点：</p>
<ul>
<li>执行时机：<strong>不会立即执行</strong>，只有子组件主动调用这个引用时（比如触发刷新事件），函数才会执行。</li>
<li>参数传递：子组件调用时可以传入参数，这些参数会直接被目标函数接收（前提是目标函数定义了对应形参）。</li>
</ul>
<h3 data-id="heading-3">2. 函数执行结果：传递“函数运行后的返回值”</h3>
<p>当我们写 <code>onRefresh={fetchData()}</code> 时，会先立即执行 <code>fetchData</code>函数，然后把函数的返回值传递给子组件。</p>
<p>核心特点：</p>
<ul>
<li>执行时机：<strong>组件渲染/重渲染时立即执行</strong>，而非子组件触发事件时。</li>
<li>传递内容：取决于函数的返回值。比如本例中 <code>fetchData</code> 是async函数，返回值是Promise对象，子组件拿到的就是Promise，而非可执行的函数。</li>
</ul>
<h2 data-id="heading-4">三、常见回调传参写法对比：优缺点与适用场景</h2>
<p>结合前面的场景，我们梳理三种最常见的回调传参写法，帮你快速选择。</p>
<h3 data-id="heading-5">写法1：直接传递函数引用（<code>onRefresh={fetchData}</code>）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuditPending</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{fetchData}</span> /&gt;</span></span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-6">优点：</h4>
<ul>
<li>性能最优：函数引用稳定，若子组件用了 <code>React.memo</code> 做性能优化，不会导致子组件不必要的重渲染。</li>
<li>代码简洁：无多余包裹，逻辑清晰。</li>
</ul>
<h4 data-id="heading-7">缺点：</h4>
<ul>
<li>灵活性差：无法对参数做加工，也无法额外传递父组件的状态/属性（比如父组件的id、name等）。</li>
<li>类组件需注意this绑定：若在类组件中直接传递类方法（如 <code>this.fetchData</code>），会丢失this上下文（函数组件无此问题）。</li>
</ul>
<h4 data-id="heading-8">适用场景：</h4>
<p>函数组件场景、子组件参数可直接透传给目标函数、无需额外加工参数。</p>
<h3 data-id="heading-9">写法2：箭头函数包裹透传参数（<code>onRefresh={(showLoading) =&gt; fetchData(showLoading)}</code>）</h3>
<pre><code class="hljs language-ini" lang="ini">// 父组件
return &lt;AuditPending 
  <span class="hljs-attr">data</span>={data} 
  <span class="hljs-attr">onRefresh</span>={(showLoading) =&gt; fetchData(showLoading)} 
/&gt;<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-10">优点：</h4>
<ul>
<li>灵活性高：可加工子组件参数（如<code>(data) =&gt; fetchData(data + ' 加工后')</code>），也可传递父组件额外参数（如 <code>(data) =&gt; fetchData(data, parentId)</code>）。</li>
<li>避免类组件this问题：箭头函数的this继承自父作用域，可解决类组件中this丢失问题。</li>
<li>可读性强：直观体现参数传递链路，新手更容易理解。</li>
</ul>
<h4 data-id="heading-11">缺点：</h4>
<ul>
<li>性能损耗：每次父组件渲染都会创建新的箭头函数实例，若子组件用了 <code>React.memo</code>，会导致子组件不必要重渲染。</li>
</ul>
<h4 data-id="heading-12">适用场景：</h4>
<p>需要加工参数、需传递父组件额外数据、类组件中解决this绑定问题。</p>
<h3 data-id="heading-13">写法3：立即执行函数（<code>onRefresh={fetchData()}</code>）</h3>
<p>❌ 不推荐（除非函数返回另一个函数，且有明确业务需求）</p>
<h4 data-id="heading-14">问题：</h4>
<ul>
<li>执行时机错误：组件渲染时就触发函数（如本例中会立即发起接口请求），而非子组件触发刷新时。</li>
<li>导致报错：若函数返回非函数值（如Promise、undefined），子组件调用 <code>onRefresh()</code> 时会抛出“不是函数”的错误。</li>
<li>可能引发无限渲染：若函数内部有修改组件状态的操作（如 <code>setData</code>），会导致组件重新渲染，进而再次执行函数，形成循环。</li>
</ul>
<h4 data-id="heading-15">特殊可行场景：</h4>
<p>函数执行后返回一个新的回调函数（高阶函数场景），例如：</p>
<pre><code class="hljs language-ini" lang="ini">// 高阶函数：返回一个回调函数
const <span class="hljs-attr">createFetchData</span> = (parentId) =&gt; {
  return async (showLoading) =&gt; {
    const <span class="hljs-attr">res</span> = await getProductDetail({ appName, loading: showLoading, parentId })<span class="hljs-comment">;</span>
    setData(res)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 此时可写为（执行createFetchData返回回调函数）
return &lt;AuditPending <span class="hljs-attr">onRefresh</span>={createFetchData(<span class="hljs-number">123</span>)} /&gt;<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-16">四、进阶：性能优化方案（平衡灵活性与性能）</h2>
<p>如果既需要箭头函数的灵活性，又想避免子组件不必要的重渲染，可以结合 <code>useCallback</code> 和 <code>React.memo</code> 实现优化，步骤如下：</p>
<h3 data-id="heading-17">1. 用useCallback保持函数引用稳定</h3>
<p>通过 <code>useCallback</code> 包裹父组件的回调函数，确保函数引用在组件渲染过程中保持不变（仅在依赖项变化时更新）。</p>
<h3 data-id="heading-18">2. 用React.memo优化子组件</h3>
<p>用 <code>React.memo</code> 包裹子组件，使子组件仅在props发生实质性变化时才重新渲染。</p>
<h3 data-id="heading-19">优化后完整示例：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [appName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'test-app'</span>);
  <span class="hljs-keyword">const</span> [parentId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 父组件额外参数</span>

  <span class="hljs-comment">// 用useCallback包裹，保持函数引用稳定</span>
  <span class="hljs-keyword">const</span> fetchData = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (showLoading = <span class="hljs-literal">true</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!appName) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getProductDetail</span>({ 
        appName, 
        <span class="hljs-attr">loading</span>: showLoading,
        parentId <span class="hljs-comment">// 使用父组件额外参数</span>
      });
      <span class="hljs-title function_">setData</span>(res);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  }, [appName, parentId]); <span class="hljs-comment">// 依赖项：仅当appName或parentId变化时，函数引用才更新</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {keyway === 200 || keyway === 300 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">AuditPending</span> 
          <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> 
          // <span class="hljs-attr">箭头函数传递子组件参数</span>+<span class="hljs-attr">父组件额外参数</span>
          <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{(showLoading)</span> =&gt;</span> fetchData(showLoading)} 
        /&gt;
      ) : null}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件用memo包裹，优化渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuditPending</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ data, onRefresh }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRefresh</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 子组件根据业务逻辑决定是否传参（如下拉刷新时已有spinner，传false）</span>
    <span class="hljs-title function_">onRefresh</span>(<span class="hljs-literal">false</span>);
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleRefresh}</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-20">五、总结：不同场景的最优选择指南</h2>
<ol>
<li>简单场景（函数组件、直接透传参数）：优先用 <strong>直接传递函数引用</strong>（性能好、代码简洁）。</li>
<li>复杂场景（加工参数、传递父组件额外数据、类组件）：用 <strong>箭头函数包裹</strong>（灵活性高、解决this问题）。</li>
<li>追求性能优化：结合 <strong>useCallback + React.memo</strong>（平衡灵活性与性能）。</li>
<li>绝对避免：无特殊需求时，不要写 <strong>立即执行函数</strong>（<code>onRefresh={fetchData()}</code>），否则会导致执行时机错误、报错或无限渲染。</li>
</ol>
<p>其实React回调传参的核心就是“搞懂执行时机”和“控制函数引用稳定性”。记住以上原则，就能避开大部分坑，写出高效、清晰的组件通信代码～</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能]]></title>    <link>https://juejin.cn/post/7586540799249940534</link>    <guid>https://juejin.cn/post/7586540799249940534</guid>    <pubDate>2025-12-22T11:01:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799249940534" data-draft-id="7586263211089166362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能"/> <meta itemprop="keywords" content="前端,ECharts,React.js"/> <meta itemprop="datePublished" content="2025-12-22T11:01:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小肥宅仙女"/> <meta itemprop="url" content="https://juejin.cn/user/2124677778769838"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2124677778769838/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小肥宅仙女
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:01:35.000Z" title="Mon Dec 22 2025 11:01:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React + ECharts 进阶：优雅实现“带记忆”的多图联动与 Tooltip 点击锁定</h2>
<h3 data-id="heading-1">前言</h3>
<p>在开发复杂的数据看板时，我们经常会遇到这样的痛点：</p>
<ol>
<li><strong>联动难</strong>：虽然 ECharts 自带 connect，但它只能同步悬停，无法自定义复杂的交互逻辑。</li>
<li><strong>看数难</strong>：鼠标一旦移开，Tooltip 消失。想对比两个相距较远的点？甚至想截图保存当前数据状态？难如登天。</li>
<li><strong>视觉乱</strong>：多图联动时，所有图表同时弹出 Tooltip，画面瞬间被密密麻麻的浮层塞满。</li>
</ol>
<p>今天我将分享一个基于 <strong>React Context + ECharts 手动派发 Action</strong> 的方案，实现<strong>多表同步悬停、点击锁定数据点、智能 Tooltip 显示</strong>等高阶交互功能。</p>
<hr/>
<h3 data-id="heading-2">🚀 核心交互预览</h3>
<ul>
<li><strong>全场同步</strong>：鼠标在 A 图滑过，B、C、D 图的指示线（AxisPointer）精准同步。</li>
<li><strong>点击锁定</strong>：点击某一数据点，所有图表进入“锁定模式”，即便鼠标移走，数据依然停留在那一刻，方便深度对比。</li>
<li><strong>智能激活</strong>：只有当前鼠标所在的图表（Active Chart）才显示详细浮层，其他图表保持简洁，仅保留指示线。</li>
</ul>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fcodesandbox.io%252Fp%252Fsandbox%252Fwild-sea-c8wqx9%253Ffile%253D%25252Fsrc%25252Fcomponents%25252FSyncChart.tsx%25253A1%25252C1-301%25252C1" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Fwild-sea-c8wqx9%3Ffile%3D%252Fsrc%252Fcomponents%252FSyncChart.tsx%253A1%252C1-301%252C1" ref="nofollow noopener noreferrer"><strong>交互 Demo 展示</strong></a></p>
<hr/>
<h3 data-id="heading-3">一、 为什么不直接用 echarts.connect？</h3>
<p>ECharts 官方提供的 connect 能够满足 80% 的联动场景。但剩下的 20%（比如我们要实现的“点击锁定”），官方 API 就显得捉襟见肘了。</p>
<p><strong>本方案的优势：</strong></p>
<ul>
<li><strong>高度受控</strong>：所有图表的状态（选中索引、激活状态）全部收拢在 React State 中。</li>
<li><strong>交互定制</strong>：可以自由定义“解锁”逻辑（如点击空白、鼠标再次进入时自动解锁）。</li>
<li><strong>性能优异</strong>：通过 Ref 和 dispatchAction 精准控制图表更新，避免了因 setOption 导致的频繁重绘。</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、 架构设计：给图表装上“指挥部”</h3>
<p>我们采用 <strong>Context + Provider</strong> 模式。所有图表组件都是“订阅者”，指挥部（Context）负责分发指令。</p>
<h4 data-id="heading-5">1. 逻辑分发图</h4>
<p>这里的核心是<strong>单向数据流</strong>：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e410a8b9d897498ca304729da9ced9c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6IKl5a6F5LuZ5aWz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767006282&amp;x-signature=9UBEsyQPRYTZpzBEq9TrnXaLcqc%3D" alt="image.png" width="50%" loading="lazy"/>
<h4 data-id="heading-6">2. 定义通讯协议</h4>
<p>codeTypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SyncContext</span> {
  <span class="hljs-attr">lockedIndex</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>;   <span class="hljs-comment">// “锁定”的索引：一旦确定，全场静止</span>
  <span class="hljs-attr">hoverIndex</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>;    <span class="hljs-comment">// “悬停”的索引：随鼠标起舞</span>
  <span class="hljs-attr">activeChartId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 谁是当前的“指挥官”：只有它能显示气泡</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、 核心代码实现</h3>
<h4 data-id="heading-8">1. 夺回控制权：禁用自动触发</h4>
<p>要实现手动联动，首先要关掉 ECharts 默认的鼠标响应。</p>
<p>codeJavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino">tooltip: {
  trigger: <span class="hljs-string">"axis"</span>,
  triggerOn: <span class="hljs-string">"none"</span>,      <span class="hljs-comment">// 重点：禁用默认的自动触发，改由代码接管</span>
  showContent: isActive,  <span class="hljs-comment">// 只有被激活的图表才显示气泡内容</span>
},
</code></pre>
<h4 data-id="heading-9">2. 时空转换：像素坐标到数据索引</h4>
<p>如何知道鼠标指在哪个点？我们需要把屏幕上的像素点“翻译”成数据的 index。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用 zr (ZRender) 监听，比普通图表事件更灵敏</span>
zr.<span class="hljs-title function_">on</span>(<span class="hljs-string">"mousemove"</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (lockedIndexRef.<span class="hljs-property">current</span> !== <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 锁定状态下不响应悬停</span>

  <span class="hljs-keyword">const</span> pointInPixel = [params.<span class="hljs-property">offsetX</span>, params.<span class="hljs-property">offsetY</span>];
  <span class="hljs-keyword">if</span> (chart.<span class="hljs-title function_">containPixel</span>(<span class="hljs-string">"grid"</span>, pointInPixel)) {
    <span class="hljs-comment">// 关键：将像素坐标转换为数据坐标</span>
    <span class="hljs-keyword">const</span> pointInGrid = chart.<span class="hljs-title function_">convertFromPixel</span>({ <span class="hljs-attr">seriesIndex</span>: <span class="hljs-number">0</span> }, pointInPixel);
    <span class="hljs-keyword">const</span> xIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(pointInGrid[<span class="hljs-number">0</span>]); <span class="hljs-comment">// 获取数据索引</span>
    
    <span class="hljs-title function_">setHoverIndex</span>(xIndex);
    <span class="hljs-title function_">setActiveChartId</span>(id);
  }
});
</code></pre>
<h4 data-id="heading-10">3. 精准打击：使用 dispatchAction</h4>
<p>这是实现联动的“魔法棒”。我们不通过 setOption 改数据，而是直接向图表发送动作指令。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> chart = instanceRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">if</span> (!chart) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 优先级：锁定索引 &gt; 悬停索引</span>
  <span class="hljs-keyword">const</span> targetIndex = lockedIndex !== <span class="hljs-literal">null</span> ? lockedIndex : hoverIndex;
  <span class="hljs-keyword">const</span> isActive = activeChartId === id;

  <span class="hljs-keyword">if</span> (targetIndex !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 1. 同步坐标轴指示线 (所有图表同步)</span>
    chart.<span class="hljs-title function_">dispatchAction</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">"updateAxisPointer"</span>,
      <span class="hljs-attr">seriesIndex</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">dataIndex</span>: targetIndex,
    });

    <span class="hljs-comment">// 2. 控制气泡显示 (仅激活图表显示)</span>
    <span class="hljs-keyword">if</span> (isActive) {
      chart.<span class="hljs-title function_">dispatchAction</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"showTip"</span>, <span class="hljs-attr">dataIndex</span>: targetIndex });
    } <span class="hljs-keyword">else</span> {
      chart.<span class="hljs-title function_">dispatchAction</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"hideTip"</span> });
    }
  }
}, [lockedIndex, hoverIndex, activeChartId]);
</code></pre>
<hr/>
<h3 data-id="heading-11">四、 进阶优化（避坑指南）</h3>
<h4 data-id="heading-12">1. 解决 React 闭包陷阱</h4>
<p>在 zr.on 的异步回调中，直接访问 lockedIndex 拿到的是组件初次渲染时的旧值。<br/>
<strong>方案</strong>：引入 useRef 实时同步状态，确保回调函数永远能拿到“现在”的值。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> lockedIndexRef = <span class="hljs-title function_">useRef</span>(lockedIndex);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  lockedIndexRef.<span class="hljs-property">current</span> = lockedIndex; <span class="hljs-comment">// 同步 ref</span>
}, [lockedIndex]);
</code></pre>
<h4 data-id="heading-13">2. 极致性能：防止配置重载</h4>
<p>频繁切换 showContent 可能会触发 ECharts 内部的重绘逻辑。<br/>
<strong>方案</strong>：在组件内部维护一个 tooltipStateRef，只有当激活状态<strong>真正发生切换</strong>时，才调用 chart.setOption。</p>
<h4 data-id="heading-14">3. 视觉反馈优化</h4>
<p>为了增强交互感，我在外层容器使用了 Tailwind 动态类名：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当锁定发生时，外层边框发光提醒</span>
className={<span class="hljs-string">`transition-all duration-300 <span class="hljs-subst">${
  lockedIndex !== <span class="hljs-literal">null</span> ? <span class="hljs-string">"border-indigo-500 shadow-indigo-500/20"</span> : <span class="hljs-string">"border-transparent"</span>
}</span>`</span>}
</code></pre>
<hr/>
<h3 data-id="heading-15">五、 总结</h3>
<p>这套方案的核心思想是：<strong>将 ECharts 的内部状态“外部化”</strong> 。</p>
<p>通过 React 控制 ECharts 的 dispatchAction，我们不仅实现了多表联动和点击锁定，更重要的是，我们为数据图表赋予了“记忆”和“主从关系”。</p>
<p>这种“受控图表”的思路可以轻易扩展到：</p>
<ul>
<li><strong>多维数据刷选 (Brush)</strong>  同步</li>
<li><strong>时间轴缩放 (DataZoom)</strong>  同步</li>
<li><strong>多维度对比</strong> 的持久化展示</li>
</ul>
<p>如果你正在开发高性能的可视化大屏，不妨尝试这套方案，它会让你的看板交互瞬间提升一个档次。</p>
<hr/>
<blockquote>
<p><strong>作者注</strong>：文中代码片段为核心逻辑，完整实现需要配合 Context.Provider。如果在开发过程中遇到坐标转换偏移、多图同步延迟等细节问题，欢迎在评论区交流讨论！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS scroll-behavior 与 JS scrollTo 的协同与博弈]]></title>    <link>https://juejin.cn/post/7586490798431469631</link>    <guid>https://juejin.cn/post/7586490798431469631</guid>    <pubDate>2025-12-22T11:08:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586490798431469631" data-draft-id="7586540799249956918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS scroll-behavior 与 JS scrollTo 的协同与博弈"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T11:08:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS scroll-behavior 与 JS scrollTo 的协同与博弈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:08:37.000Z" title="Mon Dec 22 2025 11:08:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代 Web 开发中，平滑滚动已成为提升用户体验的重要细节。CSS 和 JavaScript 都提供了实现滚动动画的方案，但它们之间的交互关系却常被误解。本文将深入探讨 CSS <code>scroll-behavior</code> 与 JavaScript <code>scrollTo()</code> 的用法、优先级规则和实际应用中的注意事项。</p>
<h2 data-id="heading-1">两种滚动动画方案</h2>
<h3 data-id="heading-2">1. CSS scroll-behavior</h3>
<p>CSS 的 <code>scroll-behavior</code> 属性提供了一种声明式的滚动动画控制方式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 启用平滑滚动 */</span>
<span class="hljs-selector-class">.container</span> {
    scroll-behavior: smooth;
}

<span class="hljs-comment">/* 禁用平滑滚动（默认） */</span>
<span class="hljs-selector-class">.container</span> {
    scroll-behavior: auto;
}
</code></pre>
<p><strong>特性：</strong></p>
<ul>
<li>声明式配置，简单直观</li>
<li>影响容器内所有符合条件的滚动行为</li>
<li>包括锚点链接、浏览器默认滚动等</li>
</ul>
<p>MDN 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fscroll-behavior" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/scroll-behavior" ref="nofollow noopener noreferrer">scroll-behavior</a></p>
<h3 data-id="heading-3">2. JavaScript scrollTo()</h3>
<p>JavaScript 的 <code>scrollTo()</code> 方法提供了命令式的滚动控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单用法</span>
element.<span class="hljs-title function_">scrollTo</span>(x, y);

<span class="hljs-comment">// 配置对象形式</span>
element.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> <span class="hljs-comment">// 或 'auto'</span>
});
</code></pre>
<p><strong>特性：</strong></p>
<ul>
<li>程序化控制，灵活性强</li>
<li>可动态决定滚动行为</li>
<li>支持精确的位置控制</li>
</ul>
<p>MDN 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FElement%2FscrollTo" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollTo" ref="nofollow noopener noreferrer">Element.scrollTo()</a></p>
<h2 data-id="heading-4">交互规则与优先级</h2>
<h3 data-id="heading-5">1. 基本原则</h3>
<p>当 CSS <code>scroll-behavior</code> 与 JS <code>scrollTo()</code> 同时存在时，遵循以下规则：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例：假设容器已设置 scroll-behavior: smooth</span>

<span class="hljs-comment">// 情况1：JS 明确指定 behavior，以 JS 为准</span>
element.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'auto'</span> <span class="hljs-comment">// 立即滚动，覆盖 CSS 的 smooth</span>
});

<span class="hljs-comment">// 情况2：JS 未指定 behavior，以 CSS 为准</span>
element.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">500</span> }); <span class="hljs-comment">// 平滑滚动</span>
</code></pre>
<h3 data-id="heading-6">2. 特殊情况：scrollTop 的意外行为</h3>
<p>一个常见的误解是：直接设置 <code>scrollTop</code> 属性不会触发平滑滚动。但实际测试发现，在某些浏览器（特别是 Chrome）中，当 CSS 设置了 <code>scroll-behavior: smooth</code> 时，直接设置 <code>scrollTop</code> 也可能触发平滑效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在某些浏览器中可能触发平滑滚动</span>
element.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">500</span>;

<span class="hljs-comment">// 而使用 scrollTo 明确指定 auto 则不会</span>
element.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'auto'</span> });
</code></pre>
<p>这种行为的不一致性源于浏览器实现的差异，不应作为可靠的功能依赖。</p>
<h2 data-id="heading-7">实际应用指导</h2>
<h3 data-id="heading-8">1. 明确性原则</h3>
<p>为确保滚动行为的一致性，建议始终明确指定滚动方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 推荐：始终明确指定 behavior</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToPosition</span>(<span class="hljs-params">element, position, smooth = <span class="hljs-literal">true</span></span>) {
    element.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: position,
        <span class="hljs-attr">behavior</span>: smooth ? <span class="hljs-string">'smooth'</span> : <span class="hljs-string">'auto'</span>
    });
}
</code></pre>
<h3 data-id="heading-9">2. 首次加载特殊处理</h3>
<p>首次加载页面时，通常需要立即滚动到特定位置，无需动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 首次加载：立即滚动</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.container'</span>);
container.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'auto'</span>;
container.<span class="hljs-property">scrollTop</span> = container.<span class="hljs-property">scrollHeight</span>;

<span class="hljs-comment">// 延迟恢复平滑效果</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    container.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'smooth'</span>;
}, <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-10">3. 中止滚动动画</h3>
<p>浏览器未提供直接中止平滑滚动的 API，但可通过以下方式模拟：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancelSmoothScroll</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> currentScroll = element.<span class="hljs-property">scrollTop</span>;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'auto'</span>;
    element.<span class="hljs-property">scrollTop</span> = currentScroll;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">''</span>;
    }, <span class="hljs-number">0</span>);
}
</code></pre>
<h2 data-id="heading-11">兼容性考量</h2>
<h3 data-id="heading-12">1. 特性检测</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测是否支持平滑滚动</span>
<span class="hljs-keyword">const</span> supportsSmoothScroll = <span class="hljs-string">'scrollBehavior'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeScrollTo</span>(<span class="hljs-params">element, options</span>) {
    <span class="hljs-keyword">if</span> (supportsSmoothScroll) {
        element.<span class="hljs-title function_">scrollTo</span>(options);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 降级方案</span>
        element.<span class="hljs-property">scrollTop</span> = options.<span class="hljs-property">top</span>;
        element.<span class="hljs-property">scrollLeft</span> = options.<span class="hljs-property">left</span> || <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-13">2. 用户偏好尊重</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测用户是否偏好减少动画</span>
<span class="hljs-keyword">const</span> prefersReducedMotion = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(
    <span class="hljs-string">'(prefers-reduced-motion: reduce)'</span>
).<span class="hljs-property">matches</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">respectfulScrollTo</span>(<span class="hljs-params">element, target</span>) {
    element.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: target,
        <span class="hljs-attr">behavior</span>: prefersReducedMotion ? <span class="hljs-string">'auto'</span> : <span class="hljs-string">'smooth'</span>
    });
}
</code></pre>
<h2 data-id="heading-14">最佳实践总结</h2>
<ol>
<li><strong>优先使用 JavaScript 控制</strong>：<code>scrollTo()</code> 方法提供更精确的控制和更好的兼容性</li>
<li><strong>避免依赖不一致行为</strong>：不要依赖 <code>scrollTop</code> 的动画效果，不同浏览器表现不一</li>
<li><strong>明确指定滚动行为</strong>：始终通过 <code>behavior</code> 参数明确指定滚动方式</li>
<li><strong>考虑首次加载场景</strong>：首次加载通常需要无动画的立即滚动</li>
<li><strong>尊重用户偏好</strong>：检测 <code>prefers-reduced-motion</code> 媒体查询</li>
<li><strong>提供降级方案</strong>：为不支持平滑滚动的浏览器提供替代方案</li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p>CSS <code>scroll-behavior</code> 和 JavaScript <code>scrollTo()</code> 共同构成了现代 Web 滚动动画的基础设施。理解它们的交互规则和优先级，能帮助我们创建更稳定、一致的用户体验。在实际开发中，推荐以 JavaScript 的 <code>scrollTo()</code> 方法为主，通过明确的参数配置控制滚动行为，同时兼顾 CSS 的声明式简洁性，达到最佳的实现效果。</p>
<p>记住，良好的滚动体验应该是顺滑自然的，但更重要的是可靠和可控。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层]]></title>    <link>https://juejin.cn/post/7586477908758478883</link>    <guid>https://juejin.cn/post/7586477908758478883</guid>    <pubDate>2025-12-22T10:57:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586477908758478883" data-draft-id="7586518130760810536" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层"/> <meta itemprop="keywords" content="前端,axios,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T10:57:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏北海"/> <meta itemprop="url" content="https://juejin.cn/user/1425415102792237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425415102792237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏北海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:57:25.000Z" title="Mon Dec 22 2025 10:57:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-estuary-light">.hljs-comment,.hljs-quote{color:#6c6b5a}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ba6236}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#ae7313}.hljs-bullet,.hljs-string,.hljs-symbol{color:#7d9726}.hljs-section,.hljs-title{color:#36a166}.hljs-keyword,.hljs-selector-tag{color:#5f9182}.hljs-addition,.hljs-deletion{color:#22221b;display:inline-block;width:100%}.hljs-deletion{background-color:#ba6236}.hljs-addition{background-color:#7d9726}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f4f3ec;color:#5f5e4e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将分享一套经过生产环境验证的 Axios 请求封装方案，涵盖请求拦截、响应处理、Token 管理、多端适配等核心功能，适用于 Vue3 + TypeScript 项目。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在实际的企业级项目中，一个健壮的 HTTP 请求层需要处理很多问题：</p>
<ul>
<li>统一的请求头管理（Token、设备信息、来源追踪等）</li>
<li>灵活的响应拦截（错误处理、消息提示、登录态失效）</li>
<li>多端环境适配（H5、微信浏览器、App WebView）</li>
<li>参数加密与安全传输</li>
<li>营销追踪参数透传</li>
</ul>
<p>本文将逐一拆解这些问题的解决方案。</p>
<hr/>
<h2 data-id="heading-1">一、整体架构设计</h2>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      业务层 (APIs)                           │
│              各业务模块的 API 调用                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    HTTP 实例 (单例)                          │
│              配置 baseURL，导出全局实例                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Axios 封装类                               │
│         请求拦截器 + 响应拦截器 + 参数加密                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      工具层                                  │
│       缓存管理、存储封装、环境判断、Cookie 操作               │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-2">二、核心封装实现</h2>
<h3 data-id="heading-3">2.1 Axios 类封装</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugins/axios/axios.ts</span>
<span class="hljs-keyword">import</span> axios, { <span class="hljs-title class_">AxiosRequestConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Http</span> {
    <span class="hljs-keyword">private</span> instance

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span> = axios.<span class="hljs-title function_">create</span>(config)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptors</span>()
    }

    <span class="hljs-comment">// 通用请求方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> request&lt;T, D = <span class="hljs-title class_">ResponseResult</span>&lt;T&gt;&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">request</span>&lt;D&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encryption</span>(config))
                <span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">data</span>)
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error)
            }
        }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;D&gt;
    }

    <span class="hljs-comment">// 分页请求方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> requestMeta&lt;T, D = <span class="hljs-title class_">ResponsePageResult</span>&lt;T&gt;&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">request</span>&lt;D&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encryption</span>(config))
                <span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">data</span>)
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error)
            }
        }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;D&gt;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">interceptors</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptorsRequest</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptorsResponse</span>()
    }

    <span class="hljs-comment">// 参数加密（下文详解）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-4">2.2 创建全局实例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugins/axios/index.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Http</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./axios'</span>
<span class="hljs-keyword">import</span> env <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/env'</span>

<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Http</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">`<span class="hljs-subst">${env.VITE_API_URL}</span>/<span class="hljs-subst">${env.VITE_API_PREFIX}</span>`</span>
})

<span class="hljs-keyword">export</span> { http }
</code></pre>
<hr/>
<h2 data-id="heading-5">三、请求拦截器：统一注入请求头</h2>
<p>请求拦截器是整个封装的核心，需要处理以下信息：</p>
<h3 data-id="heading-6">3.1 完整实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">interceptorsRequest</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
        <span class="hljs-function">(<span class="hljs-params">config: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-comment">// 1. 来源标识：区分微信浏览器和普通移动端</span>
            <span class="hljs-keyword">const</span> source = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWeiXin</span>() ? <span class="hljs-string">'MP'</span> : <span class="hljs-string">'MB'</span>

            <span class="hljs-comment">// 2. 平台标识</span>
            <span class="hljs-keyword">const</span> platform = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'platform'</span>) || <span class="hljs-string">'h5'</span>

            <span class="hljs-comment">// 3. 组装请求头</span>
            <span class="hljs-keyword">let</span> headers = {
                ...config.<span class="hljs-property">headers</span>,
                platform,
                source,
                <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'application/json'</span>,
            } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>

            <span class="hljs-comment">// 4. 设备ID（用于设备指纹）</span>
            <span class="hljs-keyword">const</span> deviceId = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'deviceId'</span>)
            <span class="hljs-keyword">if</span> (deviceId) {
                headers[<span class="hljs-string">'device-id'</span>] = deviceId
            }

            <span class="hljs-comment">// 5. 营销追踪参数</span>
            <span class="hljs-keyword">const</span> marketLinkUuid = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'market-link-uuid'</span>)
            <span class="hljs-keyword">if</span> (marketLinkUuid) {
                headers[<span class="hljs-string">'market-link-uuid'</span>] = marketLinkUuid
            }

            <span class="hljs-comment">// 6. 认证 Token</span>
            <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
            <span class="hljs-keyword">if</span> (token) {
                headers.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
            }

            <span class="hljs-comment">// 7. 自定义消息头编码（防止中文乱码）</span>
            <span class="hljs-keyword">if</span> (headers.<span class="hljs-property">sucMsg</span>) {
                headers.<span class="hljs-property">sucMsg</span> = <span class="hljs-built_in">encodeURIComponent</span>(headers.<span class="hljs-property">sucMsg</span>)
            }
            <span class="hljs-keyword">if</span> (headers.<span class="hljs-property">errMsg</span>) {
                headers.<span class="hljs-property">errMsg</span> = <span class="hljs-built_in">encodeURIComponent</span>(headers.<span class="hljs-property">errMsg</span>)
            }

            <span class="hljs-comment">// 8. 浏览器信息（用于日志分析）</span>
            <span class="hljs-keyword">const</span> { name, info } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOSAndBrowserName</span>()
            headers[<span class="hljs-string">'browser-name'</span>] = name
            headers[<span class="hljs-string">'browser-info'</span>] = info

            config.<span class="hljs-property">headers</span> = headers
            <span class="hljs-keyword">return</span> config
        },
        <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
    )
}
</code></pre>
<h3 data-id="heading-7">3.2 请求头字段说明</h3>













































<table><thead><tr><th>字段</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>platform</code></td><td>平台标识</td><td><code>h5</code></td></tr><tr><td><code>source</code></td><td>来源标识</td><td><code>MP</code>(微信) / <code>MB</code>(移动端)</td></tr><tr><td><code>device-id</code></td><td>设备唯一标识</td><td><code>uuid-xxx</code></td></tr><tr><td><code>Authorization</code></td><td>认证令牌</td><td><code>Bearer eyJhbG...</code></td></tr><tr><td><code>market-link-uuid</code></td><td>营销链接追踪</td><td><code>link-uuid</code></td></tr><tr><td><code>browser-name</code></td><td>浏览器标识</td><td><code>Android-WeChat</code></td></tr><tr><td><code>sucMsg</code> / <code>errMsg</code></td><td>自定义提示消息</td><td><code>%E6%93%8D%E4%BD%9C%E6%88%90%E5%8A%9F</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">四、响应拦截器：统一错误处理</h2>
<h3 data-id="heading-9">4.1 成功响应处理</h3>
<p>一个亮点设计是<strong>动态消息替换机制</strong>，允许前端自定义提示文案：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应拦截器 - 成功处理</span>
(response) =&gt; {
    <span class="hljs-comment">// 后端返回的消息包含占位符 {#title}</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'{#title}'</span>)) {
        <span class="hljs-comment">// 解码前端传入的自定义消息</span>
        <span class="hljs-keyword">const</span> sucMsg = <span class="hljs-built_in">decodeURIComponent</span>(response.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">sucMsg</span> || <span class="hljs-string">''</span>)
        <span class="hljs-keyword">const</span> errMsg = <span class="hljs-built_in">decodeURIComponent</span>(response.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">errMsg</span> || <span class="hljs-string">''</span>)

        <span class="hljs-comment">// 根据业务码替换消息</span>
        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">20000</span>) {
            response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> = response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'{#title}'</span>, sucMsg)
        } <span class="hljs-keyword">else</span> {
            response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> = response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'{#title}'</span>, errMsg)
        }
    }
    <span class="hljs-keyword">return</span> response
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同一个收藏接口，不同场景显示不同提示</span>
<span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/favorite'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-attr">sucMsg</span>: <span class="hljs-string">'课程收藏成功'</span>,  <span class="hljs-comment">// 前端自定义</span>
        <span class="hljs-attr">errMsg</span>: <span class="hljs-string">'课程收藏失败'</span>
    }
})
</code></pre>
<h3 data-id="heading-10">4.2 错误响应处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应拦截器 - 错误处理</span>
(error) =&gt; {
    <span class="hljs-title function_">closeToast</span>()  <span class="hljs-comment">// 关闭加载提示</span>

    <span class="hljs-keyword">const</span> { status, data } = error.<span class="hljs-property">response</span>

    <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
            <span class="hljs-comment">// 认证失效处理</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handle401Error</span>()
            <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">case</span> <span class="hljs-number">422</span>:
            <span class="hljs-comment">// 参数验证错误：提取第一个错误信息</span>
            <span class="hljs-keyword">const</span> firstErrKey = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data.<span class="hljs-property">errors</span>)[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">const</span> errorMsg = data.<span class="hljs-property">errors</span>[firstErrKey][<span class="hljs-number">0</span>]
            <span class="hljs-title function_">showToast</span>(errorMsg || data.<span class="hljs-property">message</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-attr">default</span>:
            <span class="hljs-title function_">showToast</span>(data.<span class="hljs-property">message</span>)
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
}
</code></pre>
<h3 data-id="heading-11">4.3 401 认证失效的完整处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">handle401Error</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 判断是否在 App WebView 中</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFlutterWebView</span>()) {
        <span class="hljs-comment">// 通知原生 App 处理登录</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">flutter_inappwebview</span>.<span class="hljs-title function_">callHandler</span>(<span class="hljs-string">'flutterHandler'</span>, {
            <span class="hljs-attr">code</span>: <span class="hljs-string">'token_expired'</span>,
            <span class="hljs-attr">msg</span>: <span class="hljs-string">'登录已过期'</span>
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 2. 清除本地登录信息</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearLoginInfo</span>()

    <span class="hljs-comment">// 3. 跳转登录页</span>
    router.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/login'</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-12">五、参数加密机制</h2>
<p>对于敏感参数，可以使用 Base64 编码进行简单加密：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Base64</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'js-base64'</span>

<span class="hljs-comment">// 加密方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">encode</span>(
        <span class="hljs-built_in">encodeURI</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
    ).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">''</span>)  <span class="hljs-comment">// 移除末尾的等号</span>
}

<span class="hljs-comment">// 解密方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decryption</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(
        <span class="hljs-built_in">decodeURIComponent</span>(<span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decode</span>(data))
    )
}

<span class="hljs-comment">// 在请求中使用</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">params</span>?.<span class="hljs-property">f</span>) {
        config.<span class="hljs-property">params</span>.<span class="hljs-property">f</span> = <span class="hljs-title function_">encryption</span>(config.<span class="hljs-property">params</span>.<span class="hljs-property">f</span>)
    }
    <span class="hljs-keyword">return</span> config
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 原始请求</span>
http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/config'</span>,
    <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">f</span>: { <span class="hljs-attr">code</span>: <span class="hljs-string">'website_settings'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'public'</span> }
    }
})

<span class="hljs-comment">// 实际发送</span>
<span class="hljs-comment">// GET /api/config?f=eyJjb2RlIjoid2Vic2l0ZV9zZXR0aW5ncyIsInR5cGUiOiJwdWJsaWMifQ</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">六、本地存储封装</h2>
<h3 data-id="heading-14">6.1 带过期时间的存储工具</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/store.ts</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CacheData</span> {
    <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>
    expire?: <span class="hljs-built_in">number</span>  <span class="hljs-comment">// 过期时间戳</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span>, useLocalStorage = <span class="hljs-literal">true</span>, expireSeconds?: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">cache</span>: <span class="hljs-title class_">CacheData</span> = { data }

        <span class="hljs-keyword">if</span> (expireSeconds) {
            cache.<span class="hljs-property">expire</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + expireSeconds * <span class="hljs-number">1000</span>
        }

        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        storage.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cache))
    },

    <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, useLocalStorage = <span class="hljs-literal">true</span>, defaultValue: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>) {
        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        <span class="hljs-keyword">const</span> cacheStr = storage.<span class="hljs-title function_">getItem</span>(key)

        <span class="hljs-keyword">if</span> (!cacheStr) <span class="hljs-keyword">return</span> defaultValue

        <span class="hljs-keyword">const</span> <span class="hljs-attr">cache</span>: <span class="hljs-title class_">CacheData</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cacheStr)

        <span class="hljs-comment">// 检查是否过期</span>
        <span class="hljs-keyword">if</span> (cache.<span class="hljs-property">expire</span> &amp;&amp; cache.<span class="hljs-property">expire</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) {
            storage.<span class="hljs-title function_">removeItem</span>(key)
            <span class="hljs-keyword">return</span> defaultValue
        }

        <span class="hljs-keyword">return</span> cache.<span class="hljs-property">data</span>
    },

    <span class="hljs-title function_">remove</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, useLocalStorage = <span class="hljs-literal">true</span></span>) {
        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        storage.<span class="hljs-title function_">removeItem</span>(key)
    }
}
</code></pre>
<h3 data-id="heading-15">6.2 登录状态管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/cache.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-comment">// 判断登录状态：同时检查 localStorage 和 Cookie</span>
    <span class="hljs-title function_">getIsLogin</span>(): <span class="hljs-built_in">boolean</span> {
        <span class="hljs-keyword">const</span> token = store.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-keyword">const</span> cookieToken = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCookie</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-keyword">return</span> !!token &amp;&amp; !!cookieToken
    },

    <span class="hljs-comment">// 设置登录信息</span>
    <span class="hljs-title function_">setLoginInfo</span>(<span class="hljs-params">data: { token: <span class="hljs-built_in">string</span> }</span>) {
        store.<span class="hljs-title function_">set</span>(<span class="hljs-string">'token'</span>, data.<span class="hljs-property">token</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCookie</span>(<span class="hljs-string">'token'</span>, data.<span class="hljs-property">token</span>, {
            <span class="hljs-attr">domain</span>: <span class="hljs-string">'.yourdomain.com'</span>,
            <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">expires</span>: <span class="hljs-title class_">Infinity</span>
        })
    },

    <span class="hljs-comment">// 清除登录信息</span>
    <span class="hljs-title function_">clearLoginInfo</span>(<span class="hljs-params"/>) {
        store.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeCookie</span>(<span class="hljs-string">'token'</span>)
        store.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'user_info'</span>)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">七、多端环境判断</h2>
<h3 data-id="heading-17">7.1 微信浏览器判断</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isWeiXin</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> ua = navigator.<span class="hljs-property">userAgent</span>.<span class="hljs-title function_">toLowerCase</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/micromessenger/i</span>.<span class="hljs-title function_">test</span>(ua)
}
</code></pre>
<h3 data-id="heading-18">7.2 操作系统和浏览器识别</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getOSAndBrowserName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> ua = navigator.<span class="hljs-property">userAgent</span>

    <span class="hljs-comment">// 操作系统识别</span>
    <span class="hljs-keyword">const</span> osMap = [
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Android/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Android'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/iPhone|iPad|iPod/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'iOS'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Windows/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Windows'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Macintosh/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Mac'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Linux/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Linux'</span> }
    ]
    <span class="hljs-keyword">const</span> os = osMap.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">regex</span>.<span class="hljs-title function_">test</span>(ua))?.<span class="hljs-property">name</span> || <span class="hljs-string">'Unknown'</span>

    <span class="hljs-comment">// 浏览器识别（注意顺序，微信优先）</span>
    <span class="hljs-keyword">const</span> browserMap = [
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/MicroMessenger/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'WeChat'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/QQBrowser/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'QQBrowser'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Edg/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Edge'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Chrome/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Chrome'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Safari/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Safari'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Firefox/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Firefox'</span> }
    ]
    <span class="hljs-keyword">const</span> browser = browserMap.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">regex</span>.<span class="hljs-title function_">test</span>(ua))?.<span class="hljs-property">name</span> || <span class="hljs-string">'Unknown'</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${os}</span>-<span class="hljs-subst">${browser}</span>`</span>,
        <span class="hljs-attr">info</span>: ua
    }
}
</code></pre>
<h3 data-id="heading-19">7.3 Flutter WebView 判断</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isFlutterWebView</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> !!sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'flutter_flag'</span>)
}

<span class="hljs-comment">// 在 Flutter 中打开 WebView 时设置标识</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setFlutterFlag</span>(<span class="hljs-params"/>) {
    sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'flutter_flag'</span>, <span class="hljs-string">'true'</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-20">八、TypeScript 类型定义</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/response.d.ts</span>

<span class="hljs-comment">// 通用响应结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResponseResult</span>&lt;T&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>
    <span class="hljs-attr">data</span>: T
}

<span class="hljs-comment">// 分页响应结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResponsePageResult</span>&lt;T&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>
    <span class="hljs-attr">data</span>: T[]
    <span class="hljs-attr">meta</span>: {
        <span class="hljs-attr">current_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">last_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">per_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-21">九、实际使用示例</h2>
<h3 data-id="heading-22">9.1 基础请求</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/plugins/axios'</span>

<span class="hljs-comment">// GET 请求</span>
<span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> http.<span class="hljs-property">request</span>&lt;<span class="hljs-title class_">UserInfo</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/user/info'</span>
})

<span class="hljs-comment">// POST 请求</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> http.<span class="hljs-property">request</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/auth/login'</span>,
    <span class="hljs-attr">data</span>: { username, password }
})
</code></pre>
<h3 data-id="heading-23">9.2 分页请求</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> courseList = <span class="hljs-keyword">await</span> http.<span class="hljs-property">requestMeta</span>&lt;<span class="hljs-title class_">Course</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/courses'</span>,
    <span class="hljs-attr">params</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">per_page</span>: <span class="hljs-number">10</span> }
})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(courseList.<span class="hljs-property">data</span>)       <span class="hljs-comment">// Course[]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(courseList.<span class="hljs-property">meta</span>.<span class="hljs-property">total</span>) <span class="hljs-comment">// 总数</span>
</code></pre>
<h3 data-id="heading-24">9.3 带加密参数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/config'</span>,
    <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">f</span>: { <span class="hljs-attr">code</span>: <span class="hljs-string">'site_settings'</span> }  <span class="hljs-comment">// 自动 Base64 加密</span>
    }
})
</code></pre>
<h3 data-id="heading-25">9.4 自定义提示消息</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/favorite'</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">course_id</span>: <span class="hljs-number">123</span> },
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-attr">sucMsg</span>: <span class="hljs-string">'收藏成功，可在"我的收藏"中查看'</span>,
        <span class="hljs-attr">errMsg</span>: <span class="hljs-string">'收藏失败，请稍后重试'</span>
    }
})
</code></pre>
<hr/>
<h2 data-id="heading-26">十、最佳实践总结</h2>
<ol>
<li>
<p><strong>单例模式</strong>：全局只创建一个 HTTP 实例，避免重复配置</p>
</li>
<li>
<p><strong>拦截器分离</strong>：请求拦截和响应拦截逻辑清晰分离，便于维护</p>
</li>
<li>
<p><strong>Token 双重存储</strong>：同时存储在 localStorage 和 Cookie 中，兼容不同场景</p>
</li>
<li>
<p><strong>环境适配</strong>：通过 UA 判断自动适配微信、App WebView 等环境</p>
</li>
<li>
<p><strong>消息定制化</strong>：通过 headers 传递自定义消息，同一接口可显示不同提示</p>
</li>
<li>
<p><strong>类型安全</strong>：充分利用 TypeScript 泛型，保证类型推导正确</p>
</li>
<li>
<p><strong>优雅降级</strong>：401 错误时区分 Web 和 App 环境，分别处理</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-27">结语</h2>
<p>一个好的请求封装层应该是"无感"的——业务开发者只需要关注接口调用，而不用操心 Token 注入、错误处理、环境适配等底层细节。</p>
<p>本文分享的方案已在多个生产项目中稳定运行，希望能给你的项目带来一些启发。</p>
<p>如果你有更好的实践方案，欢迎在评论区交流讨论！</p>
<hr/>
<p><strong>相关技术栈：</strong> Vue 3 + TypeScript + Axios + Vant + Pinia</p>
<p><strong>适用场景：</strong> H5 移动端、微信公众号、App 内嵌 WebView</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在react native中实现短视频平台滑动视频播放组件]]></title>    <link>https://juejin.cn/post/7586505172815265843</link>    <guid>https://juejin.cn/post/7586505172815265843</guid>    <pubDate>2025-12-22T13:56:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815265843" data-draft-id="7586482860104007707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在react native中实现短视频平台滑动视频播放组件"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-22T13:56:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sure282"/> <meta itemprop="url" content="https://juejin.cn/user/1410005296489149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在react native中实现短视频平台滑动视频播放组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410005296489149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sure282
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:56:59.000Z" title="Mon Dec 22 2025 13:56:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>短视频软件现在人人都离不开，最大的特点之一就是可以无限连刷，通常是上下滑动切换视频，划入自动播放，整体的功能看起来简单清晰明了，但是不同技术栈实现放肆肯定不同，今天在expo创建的react native环境中实现</p>
<p>开发环境关键依赖版本：</p>
<ul>
<li>expo:54+</li>
<li>react-native:0.81+</li>
<li>react:19.1+</li>
<li>expo-video</li>
<li>react-native-reanimated：4.1+</li>
<li>@shopify/flash-list:2+</li>
</ul>
<p>版本依赖有必要简单交代一下，版本不同依赖不匹配会有大问题，本功能片段来自本地视频查看功能，列表加播放，可以控制播放进度，并将选中的视频中的音频提取为独立文件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f275076dd9ad472e8430d22cc3f434b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=cQCRNW1S%2FWyU6sMhfJcSLUuKfjM%3D" alt="微信图片_20251222205158_66_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79254410e2ce445eaf44e3094d58d1e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=RyonYVdr0w9Gl5D%2FE%2B3b1j43TfY%3D" alt="微信图片_20251222205159_67_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a937694848e84025bc8b9596ad33710e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=7EUC%2BmoaSUWJzCVUfwu1LGkmoMo%3D" alt="微信图片_20251222205200_68_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842cd99d3ca94b2fb89326ab814c424d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=yUG0BzveM1c0XELG6C0rwiude2k%3D" alt="微信图片_20251222205201_69_23.jpg" loading="lazy"/></p>
<p>核心思路:</p>
<ol>
<li>每条视频占据可视区域的绝大部分(满屏);</li>
<li>上下滑动切换(列表);</li>
<li>滑动切换视频自动播放，隐藏的视频不再播放(处于可视区域播放，不可视区域终止播放，释放内存)</li>
<li>播放暂停进度条控制，播放时间等简易功能</li>
</ol>
<p>用户在查看本地视频时分两步走：先以较小的缩略图查看笼统的视频列表，然后可以点击任意一个视频弹出页面中
上下滑动切换播放视频，因此这是两个列表，在rn中有、FlatList列表组件，如下是图1图2的列表组件:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect, useState, useRef, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span>, useCallback, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { formatTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;
<span class="hljs-keyword">import</span> { getAssetsAsync, <span class="hljs-title class_">MediaType</span>, requestPermissionsAsync, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AssetsOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-media-library'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Text</span>, useWindowDimensions, <span class="hljs-title class_">View</span>, <span class="hljs-title class_">RefreshControl</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/CustomButton'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Empty</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/Empty'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoModalProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/VideoModal'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GlobalLoading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/GloablLoading'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VideoListItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/VideoListItem'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FlashList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@shopify/flash-list"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { useThemeNotification, useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTheme'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ListFooter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/ListFooter'</span>;
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VideoListProps</span> {
    onPress?: <span class="hljs-function">(<span class="hljs-params">video: VideoAsset</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}
<span class="hljs-comment">/**
 * 视频列表页面组件
 * 该组件用于展示设备中的视频文件列表，并支持分页加载、权限申请等功能。
 * 用户可以选择某个视频进行后续操作。
 *
 * <span class="hljs-doctag">@param</span> onVideoSelect 当用户点击某一个视频项时触发的回调函数，接收选中的 Asset 对象作为参数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoList</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoListProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ onPress }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [video, setVideo] = useState&lt;<span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [videos, setVideos] = useState&lt;<span class="hljs-title class_">VideoAsset</span>[]&gt;([]);
    <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [hasPermission, setHasPermission] = useState&lt;<span class="hljs-built_in">boolean</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [after, setAfter] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-literal">undefined</span>);
    <span class="hljs-keyword">const</span> [hasMore, setHasMore] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 防止 FlatList 在首次挂载时触发 onEndReached 导致意外加载,初次加载判定ref的值设置为false</span>
    <span class="hljs-keyword">const</span> initialEndReachedRef = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 计算响应式列数 - 强制3列布局</span>
    <span class="hljs-keyword">const</span> targetColumns = <span class="hljs-number">3</span>; <span class="hljs-comment">// 目标列数</span>
    <span class="hljs-keyword">const</span> padding = <span class="hljs-number">32</span>; <span class="hljs-comment">// 左右边距总和</span>
    <span class="hljs-keyword">const</span> [modalVisible, setModalVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [modalLoading, setModalLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [<span class="hljs-title class_">VideoModal</span>, setVideoModal] = useState&lt;<span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoModalProps</span>&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> { width } = <span class="hljs-title function_">useWindowDimensions</span>();
    <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useTheme</span>();
    <span class="hljs-comment">// 强制使用3列布局（除非屏幕太窄）</span>
    <span class="hljs-keyword">const</span> numColumns = width &gt; <span class="hljs-number">320</span> ? targetColumns : <span class="hljs-number">2</span>;
    <span class="hljs-comment">// 确定每次加载的视频数量，确保能填充3列</span>
    <span class="hljs-keyword">const</span> first = numColumns === <span class="hljs-number">3</span> ? <span class="hljs-number">21</span> : <span class="hljs-number">20</span>;
    <span class="hljs-comment">// 使用margin控制间距，所以这里不考虑spacing</span>
    <span class="hljs-keyword">const</span> itemWidth = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (width - padding - numColumns * <span class="hljs-number">10</span>) / numColumns, [width, numColumns]); <span class="hljs-comment">// 10是左右的margin总和</span>
    <span class="hljs-keyword">const</span> showNotification = <span class="hljs-title function_">useThemeNotification</span>();
    <span class="hljs-comment">/**
     * 请求权限并获取视频列表
     *
     * 此方法会先请求媒体库读取权限，如果授权成功则调用 fetchVideos 方法加载视频数据。
     * 如果未获得权限，则弹出提示框告知用户。
     *
     * <span class="hljs-doctag">@param</span> reset 是否重置当前已有的视频列表，默认为 false
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">requestPermissionAndGetVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">true</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 请求媒体库权限</span>
            <span class="hljs-keyword">const</span> { status } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestPermissionsAsync</span>();
            <span class="hljs-keyword">if</span> (status !== <span class="hljs-string">'granted'</span>) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'需要访问媒体库权限才能获取视频文件，请在设置中开启权限。'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> });
                <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 获取视频文件，重新请求权限时默认重置列表</span>
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchVideos</span>(reset);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'获取视频文件失败，请重试'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
        }
    };
    <span class="hljs-comment">/**
     * 使用expo-media-library 获取视频文件列表
     * 和expo-document-picker 获取视频文件列表结果不太一样，expo-media-library 会返回更多的视频文件
     * 调用系统 API 获取指定范围内的视频资源，并更新状态以渲染到界面。
     * 支持分页加载与刷新功能。
     *
     * <span class="hljs-doctag">@param</span> reset 是否清空已有数据后重新加载，默认为 false
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">false</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">AssetsOptions</span> = {
                <span class="hljs-attr">mediaType</span>: <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">video</span>, <span class="hljs-comment">// 只获取视频文件</span>
                first, <span class="hljs-comment">// 每次加载根据列数动态调整</span>
                <span class="hljs-attr">after</span>: reset ? <span class="hljs-literal">undefined</span> : after, <span class="hljs-comment">// 分页加载</span>
                <span class="hljs-attr">sortBy</span>: [[<span class="hljs-string">'modificationTime'</span>, <span class="hljs-literal">false</span>]], <span class="hljs-comment">// 按修改时间降序排序</span>
            };
            <span class="hljs-keyword">const</span> { assets = [], endCursor, hasNextPage } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAssetsAsync</span>(options);
            <span class="hljs-keyword">const</span> videoList = assets.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">asset</span> =&gt;</span> ({
                ...asset,
                <span class="hljs-attr">durationString</span>: <span class="hljs-title function_">formatTime</span>(asset.<span class="hljs-property">duration</span>),
            }));
            <span class="hljs-keyword">if</span> (reset) {
                <span class="hljs-title function_">setVideos</span>(videoList);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">setVideos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, ...videoList]);
            }
            <span class="hljs-title function_">setAfter</span>(endCursor);
            <span class="hljs-title function_">setHasMore</span>(hasNextPage);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取视频列表失败:'</span>, error);
            <span class="hljs-keyword">throw</span> error;
        }
    };
    <span class="hljs-keyword">const</span> handlePressItem = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">item: VideoAsset</span>) =&gt;</span> {
        <span class="hljs-title function_">setVideo</span>(item);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">VideoModal</span>) {
            <span class="hljs-title function_">setModalLoading</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/VideoModal'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
                <span class="hljs-title function_">setVideoModal</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>);
                <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">true</span>);
            }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setModalLoading</span>(<span class="hljs-literal">false</span>));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">true</span>);
        }
    }, [<span class="hljs-title class_">VideoModal</span>]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConvertPress</span> = (<span class="hljs-params">video: VideoAsset</span>) =&gt; {
        <span class="hljs-title function_">setVideo</span>(video);
        onPress?.(video);
        <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">false</span>);
    };
    <span class="hljs-comment">/**
     * 渲染单个视频项组件
     * 展示缩略图、名称及持续时间等信息。点击可触发选择事件。
     * <span class="hljs-doctag">@param</span> param 包含 item 字段的对象，代表当前要渲染的 Asset 数据
     * <span class="hljs-doctag">@returns</span> JSX 元素
     */</span>
    <span class="hljs-keyword">const</span> renderVideoItem = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">{ item }: { item: VideoAsset }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VideoListItem</span>
            <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span>
            <span class="hljs-attr">itemWidth</span>=<span class="hljs-string">{itemWidth}</span>
            <span class="hljs-attr">isSelected</span>=<span class="hljs-string">{item.id</span> === <span class="hljs-string">video?.id}</span>
            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlePressItem}</span>
        /&gt;</span></span>
    ), [itemWidth, video?.<span class="hljs-property">id</span>, handlePressItem]);

    <span class="hljs-comment">// 初始化时请求权限（调用被注释或由上层控制时，FlatList 的 onEndReached 可能在挂载时触发，导致 fetchVideos 被调用）</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">requestPermissionAndGetVideos</span>();
    }, []);

    <span class="hljs-comment">/**
     * 页面初次加载可能会导致 FlatList 触发 onEndReached 事件，导致意外加载
     * 因此初次执行FlatList 的 onEndReached 时，只标记已触发，修改ref的值为false，
     * 不执行加载，待后续值为false再执行请求
     * 处理列表滚动到底部的事件回调函数
     * 该函数用于实现无限滚动加载功能，在用户滚动到列表底部时自动加载更多数据
     *
     * 暂不触底加载更多视频，点击底部加载更多按钮触发加载，触发不稳定
     * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>} 返回一个空的 Promise，表示异步操作完成
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEndReached</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (!hasMore || loading) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 第一次触发 onEndReached 时只标记已触发，不执行加载（常见于 FlatList 在 mount 时触发）</span>
        <span class="hljs-keyword">if</span> (initialEndReachedRef.<span class="hljs-property">current</span>) {
            initialEndReachedRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchVideos</span>();
    };
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
            {hasPermission === false ? (
                <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.permissionContainer}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.permissionText}</span>&gt;</span>需要媒体库权限才能访问视频文件<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">CustomButton</span> <span class="hljs-attr">text</span>=<span class="hljs-string">"重新请求权限"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> requestPermissionAndGetVideos()} /&gt;
                <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            ) : (
                <span class="hljs-tag">&lt;&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.countText}</span>&gt;</span>
                        {videos.length &gt; 0 ? `共找到 ${videos.length} 个视频文件` : ''}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">FlashList</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width</span> }}
                        <span class="hljs-attr">data</span>=<span class="hljs-string">{videos}</span>
                        <span class="hljs-attr">refreshControl</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">RefreshControl</span>
                            <span class="hljs-attr">tintColor</span>=<span class="hljs-string">"#007aff"</span>
                            <span class="hljs-attr">refreshing</span>=<span class="hljs-string">{loading}</span>
                            <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{()</span> =&gt;</span> fetchVideos(true)}
                            colors={['red']}
                            progressBackgroundColor="transparent"
                        /&gt;}
                        showsVerticalScrollIndicator={false}
                        renderItem={renderVideoItem}
                        keyExtractor={({ id }, index) =&gt; `${id}-${index}`}
                        numColumns={numColumns}
                        ListEmptyComponent={!loading ? <span class="hljs-tag">&lt;<span class="hljs-name">Empty</span>
                            <span class="hljs-attr">tip</span>=<span class="hljs-string">"没有找到视频文件"</span>
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.emptyContainer}</span>
                            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> requestPermissionAndGetVideos()}
                        /&gt; : null}
                        onEndReached={handleEndReached}
                        onEndReachedThreshold={0.1}
                        ListFooterComponent={!loading ? <span class="hljs-tag">&lt;<span class="hljs-name">ListFooter</span>
                            <span class="hljs-attr">hasMore</span>=<span class="hljs-string">{hasMore}</span>
                            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> fetchVideos()}
                        /&gt; : null}
                        contentContainerStyle={styles.gridListContainer}
                    /&gt;
                <span class="hljs-tag">&lt;/&gt;</span></span>
            )}
            {modalLoading &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">GlobalLoading</span> /&gt;</span></span>}
            {
                <span class="hljs-title class_">VideoModal</span> &amp;&amp; (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VideoModal</span>
                    <span class="hljs-attr">visible</span>=<span class="hljs-string">{modalVisible}</span>
                    <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setModalVisible(false)}
                    videoList={videos}
                    currentVideo={video}
                    onPress={handleConvertPress}
                /&gt;</span>)
            }
        &lt;/<span class="hljs-title class_">View</span>&gt;
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    },
    <span class="hljs-attr">gridListContainer</span>: {
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">16</span>,
    },
    <span class="hljs-attr">emptyContainer</span>: {
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">50</span>,
    },
    <span class="hljs-attr">permissionContainer</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">32</span>,
    },
    <span class="hljs-attr">permissionText</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#333333'</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">countText</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#666666'</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">paddingVertical</span>: <span class="hljs-number">5</span>,
    },
});

</code></pre>
<p>以上是三列列表，元素使用ImageBackground渲染，此时还不具备播放功能，当点击任意一项时将打开VideoModal组件，它是用rn的Modal编写的组件，在其中有一个垂直一列的列表，每一项都会渲染expo-video的VideoView组件：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useRef, useState, useCallback, useEffect, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Modal</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Dimensions</span>, <span class="hljs-title class_">TouchableOpacity</span>, <span class="hljs-title class_">Text</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ionicons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@expo/vector-icons'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VideoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VideoItem'</span>;
<span class="hljs-keyword">import</span> { useSafeAreaInsets } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-safe-area-context'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FlashList</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FlashListRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@shopify/flash-list"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-image'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">VideoModalProps</span> = {
    <span class="hljs-attr">videoList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VideoAsset</span>&gt;;
    <span class="hljs-attr">visible</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">currentVideo</span>: <span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>;
    onPress?: <span class="hljs-function">(<span class="hljs-params">video: VideoAsset</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
};
<span class="hljs-keyword">const</span> list = [
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'0'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'heart'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'1.1万'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'1'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'chatbubble-ellipses'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'star'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'3'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'arrow-redo'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'4'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'build'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'转音频'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'orangered'</span>,
    },
]
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoModal</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoModalProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ visible, onClose, onPress, videoList = [], currentVideo = <span class="hljs-literal">null</span> }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [activeVideo, setActiveVideo] = useState&lt;<span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>&gt;(currentVideo);
    <span class="hljs-keyword">const</span> flatListRef = useRef&lt;<span class="hljs-title class_">FlashListRef</span>&lt;<span class="hljs-title class_">VideoAsset</span>&gt;&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> { height } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'screen'</span>);
    <span class="hljs-keyword">const</span> { bottom, top } = <span class="hljs-title function_">useSafeAreaInsets</span>();
    <span class="hljs-keyword">const</span> viewabilityConfig = <span class="hljs-title function_">useRef</span>({
        <span class="hljs-attr">itemVisiblePercentThreshold</span>: <span class="hljs-number">80</span>,
        <span class="hljs-attr">minimumViewTime</span>: <span class="hljs-number">100</span>,
    }).<span class="hljs-property">current</span>;

    <span class="hljs-comment">// 处理可见性变化</span>
    <span class="hljs-keyword">const</span> onViewableItemsChanged = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">{ viewableItems }: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-comment">// 获取所有可见的项目</span>
        <span class="hljs-keyword">if</span> (viewableItems.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 使用第一个可见项目（FlatList确保只有一个项目是主要可见的）</span>
            <span class="hljs-title function_">setActiveVideo</span>(viewableItems[<span class="hljs-number">0</span>].<span class="hljs-property">item</span>);
        }
    }, []);
    <span class="hljs-comment">// 获取初始滚动索引</span>
    <span class="hljs-keyword">const</span> getInitialIndex = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!currentVideo) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> index = videoList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.<span class="hljs-property">id</span> === currentVideo.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">return</span> index &gt;= <span class="hljs-number">0</span> ? index : <span class="hljs-number">0</span>;
    }, [currentVideo, videoList]);

    <span class="hljs-comment">// 当modal打开或视频列表变化时，初始化activeVideoId</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (visible &amp;&amp; currentVideo) {
            <span class="hljs-title function_">setActiveVideo</span>(currentVideo);
        }
    }, [visible, currentVideo]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePress</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">if</span> (id === <span class="hljs-string">'4'</span>) {
            <span class="hljs-keyword">if</span> (activeVideo) {
                onPress?.(activeVideo);
            }
        }
    };
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span>
            <span class="hljs-attr">visible</span>=<span class="hljs-string">{visible}</span>
            <span class="hljs-attr">transparent</span>
            <span class="hljs-attr">animationType</span>=<span class="hljs-string">"slide"</span>
            <span class="hljs-attr">onRequestClose</span>=<span class="hljs-string">{onClose}</span>
        &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.closeButton,</span> { <span class="hljs-attr">top:</span> <span class="hljs-attr">top</span> + <span class="hljs-attr">10</span> }]}
                    <span class="hljs-attr">onPress</span>=<span class="hljs-string">{onClose}</span>
                &gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"close"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{30}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"white"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">FlashList</span>
                    <span class="hljs-attr">data</span>=<span class="hljs-string">{videoList}</span>
                    <span class="hljs-attr">keyExtractor</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">id</span> }) =&gt;</span> id}
                    ref={flatListRef}
                    showsVerticalScrollIndicator={false}
                    pagingEnabled
                    decelerationRate="fast"
                    initialScrollIndex={getInitialIndex()}
                    renderItem={({ item }) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">VideoItem</span>
                            <span class="hljs-attr">top</span>=<span class="hljs-string">{top}</span>
                            <span class="hljs-attr">bottom</span>=<span class="hljs-string">{bottom}</span>
                            <span class="hljs-attr">modalVisible</span>=<span class="hljs-string">{visible}</span>
                            <span class="hljs-attr">video</span>=<span class="hljs-string">{item}</span>
                            <span class="hljs-attr">isActive</span>=<span class="hljs-string">{item.id</span> === <span class="hljs-string">activeVideo?.id}</span>
                            <span class="hljs-attr">height</span>=<span class="hljs-string">{height}</span>
                        /&gt;</span>
                    )}
                    onViewableItemsChanged={onViewableItemsChanged}
                    viewabilityConfig={viewabilityConfig}
                    removeClippedSubviews={false}
                /&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.sideList,</span> { <span class="hljs-attr">bottom:</span> <span class="hljs-attr">bottom</span> + <span class="hljs-attr">70</span> }]}&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.sideItem,</span> { <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">10</span> }]}
                    &gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                            <span class="hljs-attr">source</span>=<span class="hljs-string">{require(</span>'@/<span class="hljs-attr">assets</span>/<span class="hljs-attr">images</span>/<span class="hljs-attr">singer</span>/<span class="hljs-attr">singer2.png</span>')}
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.photo}</span>
                        /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.ItemText,</span> <span class="hljs-attr">styles.plus</span>]}&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                    {
                        list.map(({ id, color, icon, count }) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
                                <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.sideItem}</span>
                                <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> handlePress(id)}
                            &gt;
                                <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span>
                                    <span class="hljs-attr">name</span>=<span class="hljs-string">{icon</span> <span class="hljs-attr">as</span> <span class="hljs-attr">any</span>}
                                    <span class="hljs-attr">size</span>=<span class="hljs-string">{32}</span>
                                    <span class="hljs-attr">color</span>=<span class="hljs-string">{color}</span>
                                /&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.ItemText,</span> { <span class="hljs-attr">color</span> }]}&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                        ))
                    }
                <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    },
    <span class="hljs-attr">photo</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">42</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">42</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">plus</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">34</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">bottom</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#ccc'</span>,
        <span class="hljs-attr">fontWeight</span>: <span class="hljs-number">700</span>,
        <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-string">'50%'</span>,
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateX</span>: -<span class="hljs-number">17</span> }],
    },
    <span class="hljs-attr">closeButton</span>: {
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">zIndex</span>: <span class="hljs-number">10</span>,
    },
    <span class="hljs-attr">sideList</span>: {
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">sideItem</span>: {
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">5</span>,
    },
    <span class="hljs-title class_">ItemText</span>: {
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">12</span>,
    },
});

</code></pre>
<p>如上，可以上下滑动的视频播放列表核心代码在于列表项的每一项应该考虑高度应该是视口高度，列表每次滑动距离应该是视口高度，因此需要获取视口高度和上下的安全距离，将这些传递给视频列表项，如下是列表项组件</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect, useState, useRef, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span>, act } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Pressable</span>, <span class="hljs-title class_">TouchableOpacity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VideoView</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-video'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { useVideoPlayer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useVideoPlayer'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Slider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/slider'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ionicons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@expo/vector-icons'</span>;
<span class="hljs-keyword">import</span> { formatTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, { useSharedValue, withTiming, useAnimatedStyle } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
    <span class="hljs-attr">video</span>: <span class="hljs-title class_">VideoAsset</span>;
    <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">modalVisible</span>: <span class="hljs-built_in">boolean</span>;
    top?: <span class="hljs-built_in">number</span>;
    bottom?: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">/**
 * 视频列表子项多，如果每个item都useVideoPler(uri)会在初始化时创建播放器导致崩溃闪退
 * expo-video的videoView必须接收一个player对象且必须存在，否则报错
 * 因此，使用createVideoPlayer创建一个播放器对象，并保存在组件内部，避免 hooks不能在useEffect中创建播放器对象
 * 1.监听isActive变化，当isActive为true时，创建播放器并播放视频，当isActive为false时，暂停并释放播放器
 * 视频列表子项组件
 * FlatList渲染的视频子项
 * <span class="hljs-doctag">@param</span> video 当前组件应该播放的视频
 * <span class="hljs-doctag">@param</span> isActive 当前视频是否处于屏幕上，是否应该播放
 * <span class="hljs-doctag">@param</span> height 视频组件高度
 * <span class="hljs-doctag">@returns</span> JSX 元素
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoItem</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ video, isActive, height, modalVisible, top, bottom }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { player, isPlayerReady, isPlaying, play, pause } = <span class="hljs-title function_">useVideoPlayer</span>({
        <span class="hljs-attr">uri</span>: video.<span class="hljs-property">uri</span>,
        isActive,
        modalVisible
    });
    <span class="hljs-keyword">const</span> [currentTime, setCurrentTime] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> timerRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setTimeout</span>&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> topTranslateY = <span class="hljs-title function_">useSharedValue</span>(-<span class="hljs-number">50</span>);
    <span class="hljs-keyword">const</span> bottomTranslateY = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> centerOpacity = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> centerDisplay = useSharedValue&lt;<span class="hljs-string">'flex'</span> | <span class="hljs-string">'none'</span>&gt;(<span class="hljs-string">'flex'</span>);
    <span class="hljs-keyword">const</span> topStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateY</span>: topTranslateY.<span class="hljs-property">value</span> }],
    }));
    <span class="hljs-keyword">const</span> centerStye = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">opacity</span>: centerOpacity.<span class="hljs-property">value</span>,
        <span class="hljs-attr">display</span>: centerDisplay.<span class="hljs-property">value</span>,
    }));
    <span class="hljs-keyword">const</span> bottomStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateY</span>: bottomTranslateY.<span class="hljs-property">value</span> }],
    }));
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlleControl</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (isPlaying) {
            <span class="hljs-title function_">pause</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">play</span>();
        }
    };
    <span class="hljs-comment">// 监听播放进度变化</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!player || !isPlayerReady) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 定时更新播放进度</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">progressInterval</span>: <span class="hljs-built_in">any</span>;
        <span class="hljs-keyword">if</span> (isPlaying) {
            progressInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (player &amp;&amp; player.<span class="hljs-property">currentTime</span>) {
                    <span class="hljs-title function_">setCurrentTime</span>(player.<span class="hljs-property">currentTime</span>);
                }
            }, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每100ms更新一次</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (progressInterval) {
                <span class="hljs-built_in">clearInterval</span>(progressInterval);
            }
        };
    }, [player, isPlayerReady, isPlaying]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearTimer</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (timerRef.<span class="hljs-property">current</span>) {
            <span class="hljs-built_in">clearTimeout</span>(timerRef.<span class="hljs-property">current</span>);
            timerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
        }
    };
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (visible) {
            <span class="hljs-title function_">clearTimer</span>();
            topTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            centerOpacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            bottomTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            centerDisplay.<span class="hljs-property">value</span> = <span class="hljs-string">'flex'</span>;
            timerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                topTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(-<span class="hljs-number">50</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                centerOpacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                bottomTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">70</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                centerDisplay.<span class="hljs-property">value</span> = <span class="hljs-string">'none'</span>;
                <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">false</span>)
            }, <span class="hljs-number">3000</span>);
        };
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">clearTimer</span>();
        };
    }, [visible])
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePressBg</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-title function_">setVisible</span>(!visible);
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Pressable</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.container,</span> { <span class="hljs-attr">height</span>, <span class="hljs-attr">paddingTop:</span> <span class="hljs-attr">top</span>, <span class="hljs-attr">paddingBottom:</span> <span class="hljs-attr">bottom</span> }]}
            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlePressBg}</span>
        &gt;</span>
            {/* 只有当播放器存在且准备就绪时才渲染 VideoView */}
            {player &amp;&amp; isPlayerReady &amp;&amp; player.status !== 'idle' &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">VideoView</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[StyleSheet.absoluteFill,</span> { <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">bottom</span>, <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">top</span> }]}
                    <span class="hljs-attr">player</span>=<span class="hljs-string">{player}</span>
                    <span class="hljs-attr">nativeControls</span>=<span class="hljs-string">{false}</span>
                    <span class="hljs-attr">fullscreenOptions</span>=<span class="hljs-string">{{</span>
                        <span class="hljs-attr">enable:</span> <span class="hljs-attr">true</span>, //<span class="hljs-attr">能否全屏</span>
                        <span class="hljs-attr">orientation:</span> '<span class="hljs-attr">landscape</span>', //<span class="hljs-attr">全屏时屏幕方向</span>
                        <span class="hljs-attr">autoExitOnRotate:</span> <span class="hljs-attr">false</span>, //<span class="hljs-attr">屏幕旋转时是否退出全屏</span>
                    }}
                /&gt;</span>
            )}
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.overlay,</span> { <span class="hljs-attr">top</span> }]}&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.Text</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.videoTitle,</span> <span class="hljs-attr">topStyle</span>]}
                    <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>
                &gt;</span>
                    {video.filename ?? '未知视频'}
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.Text</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.center,</span> <span class="hljs-attr">centerStye</span>]}
                &gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlleControl}</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{isPlaying</span> ? "<span class="hljs-attr">pause</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">play</span>"} <span class="hljs-attr">size</span>=<span class="hljs-string">{50}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"white"</span> /&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.bottom,</span> <span class="hljs-attr">bottomStyle</span>]}&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Slider</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.slider}</span>
                        <span class="hljs-attr">minimumValue</span>=<span class="hljs-string">{0}</span>
                        <span class="hljs-attr">maximumValue</span>=<span class="hljs-string">{video.duration</span> || <span class="hljs-attr">0</span>}
                        <span class="hljs-attr">value</span>=<span class="hljs-string">{currentTime}</span>
                        <span class="hljs-attr">onSlidingComplete</span>=<span class="hljs-string">{(value)</span> =&gt;</span> {
                            if (player) {
                                player.currentTime = value; // expo-video 使用秒为单位
                            }
                        }}
                        minimumTrackTintColor="#fff" // 滑块左侧轨道颜色
                        maximumTrackTintColor="#d3d3d3" // 滑块右侧轨道颜色
                        thumbTintColor="#fff" // 滑块颜色
                    /&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.time}</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>
                            <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span>
                        &gt;</span>{formatTime(currentTime)}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span> <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>&gt;</span>{video.durationString}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Pressable</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#000'</span>,
    },
    <span class="hljs-attr">time</span>: {
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">5</span>,
    },
    <span class="hljs-attr">timeText</span>: {
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
    },
    <span class="hljs-attr">slider</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-string">'70%'</span>,
    },
    <span class="hljs-attr">center</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">70</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">overflow</span>: <span class="hljs-string">'hidden'</span>,
    },
    <span class="hljs-attr">bottom</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">70</span>,
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'space-between'</span>,
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">videoTitle</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
        <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'bold'</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">duration</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
});

</code></pre>
<p>视频组件使用的依赖库是expo-video，这个依赖库中的VideoView组件是视频组件，必须接收VideoPlayer类型的player属性，而这么多视频我们不可能都创建出这个player，创建player的方式有两种，</p>
<ol>
<li>
<p>用该依赖库提供的useAudioPlayer hooks创建，不用手动处理卸载加载
这意味着视频列表项目很多，而hooks又不能在条件语句中执行，这将会导致视频列表模态框加载即崩溃，
上面的item项目每一个都初始化加载视频，又无法控制列表项出现在视口时创建player加载视频，所以在这个场景下肯定不行的，因此上面引入的useAudioPlayer组件不是依赖库提供的，而是基于下面的api按需封装的</p>
</li>
<li>
<p>createAudioPlayer，，这个api可以控制创建player时机，以及释放销毁的时机，同样，VideoView仍然需要player，因此只有当播放器存在且准备就绪时才渲染 VideoView</p>
</li>
<li>
<p>正确更新当前播放时间，使用了上面的api就意味着不能再使用expo提供的useEvent和useEventListener监听player的播放情况，同样是因为hooks必须在组件顶层使用，</p>
</li>
</ol>
<p>基于以上问题，播放进度更新，采用监听是否在播放，player是否存在，然后setInterval获取player.currentTime属性值，更新state</p>
<p>视频的播放卸载，按需编写一个hooks：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useRef, useState, useCallback, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { createVideoPlayer, <span class="hljs-keyword">type</span> <span class="hljs-title class_">VideoPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-video'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseVideoPlayerOptions</span> {
    <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>;
    isActive?: <span class="hljs-built_in">boolean</span>;
    modalVisible?: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseVideoPlayerReturn</span> {
    <span class="hljs-attr">player</span>: <span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>;
    <span class="hljs-attr">isPlayerReady</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">isPlaying</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">play</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">pause</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">release</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useVideoPlayer = ({ uri, isActive = <span class="hljs-literal">false</span>, modalVisible = <span class="hljs-literal">false</span> }: <span class="hljs-title class_">UseVideoPlayerOptions</span>): <span class="hljs-function"><span class="hljs-params">UseVideoPlayerReturn</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> playerRef = useRef&lt;<span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [player, setPlayer] = useState&lt;<span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [isPlayerReady, setIsPlayerReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">const</span> initializePlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 清理之前的播放器</span>
            <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
                playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
                playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">release</span>();
                playerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }

            <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
            <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);

            <span class="hljs-comment">// 只有在活跃和模态框可见时才创建新播放器</span>
            <span class="hljs-keyword">if</span> (modalVisible &amp;&amp; isActive &amp;&amp; uri) {
                <span class="hljs-keyword">const</span> newPlayer = <span class="hljs-title function_">createVideoPlayer</span>(uri);
                playerRef.<span class="hljs-property">current</span> = newPlayer;

                <span class="hljs-comment">// 监听播放状态</span>
                <span class="hljs-keyword">const</span> playingListener = newPlayer.<span class="hljs-title function_">addListener</span>(<span class="hljs-string">'playingChange'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                    <span class="hljs-title function_">setIsPlaying</span>(event.<span class="hljs-property">isPlaying</span>);
                });

                <span class="hljs-comment">// 监听播放器状态变化</span>
                <span class="hljs-keyword">const</span> statusListener = newPlayer.<span class="hljs-title function_">addListener</span>(<span class="hljs-string">'statusChange'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">status</span> === <span class="hljs-string">'readyToPlay'</span>) {
                        <span class="hljs-title function_">setPlayer</span>(newPlayer);
                        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">true</span>);
                        <span class="hljs-comment">// 自动开始播放</span>
                        newPlayer.<span class="hljs-title function_">play</span>();
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.<span class="hljs-property">status</span> === <span class="hljs-string">'error'</span>) {
                        <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
                        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
                    }
                });

                <span class="hljs-comment">// 保存监听器引用以便清理</span>
                (newPlayer <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">playingListener</span> = playingListener;
                (newPlayer <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">statusListener</span> = statusListener;
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
            <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);
        }
    }, [modalVisible, isActive, uri]);

    <span class="hljs-keyword">const</span> play = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();
        }
    }, []);

    <span class="hljs-keyword">const</span> pause = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
        }
    }, []);

    <span class="hljs-keyword">const</span> release = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            <span class="hljs-comment">// 清理监听器</span>
            <span class="hljs-keyword">const</span> playingListener = (playerRef.<span class="hljs-property">current</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">playingListener</span>;
            <span class="hljs-keyword">const</span> statusListener = (playerRef.<span class="hljs-property">current</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">statusListener</span>;

            <span class="hljs-keyword">if</span> (playingListener) {
                playingListener.<span class="hljs-title function_">remove</span>();
            }
            <span class="hljs-keyword">if</span> (statusListener) {
                statusListener.<span class="hljs-title function_">remove</span>();
            }

            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">release</span>();
            playerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
        <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);
    }, []);

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">initializePlayer</span>()

        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 组件卸载时清理</span>
            <span class="hljs-title function_">release</span>();
        };
    }, [initializePlayer, release]);

    <span class="hljs-keyword">return</span> {
        player,
        isPlayerReady,
        isPlaying,
        play,
        pause,
        release
    };
}
</code></pre>
<p>看似不复杂的需求(上面的右侧边栏的消息，评论都没有功能，主要是用于演示)，就已经编写了这么多代码，最大的坑来自于expo-audio，也没有去找其他视频相关的组件，大家可以作为参考，可能其他视频依赖库更简单，后续可能会更新一篇 在rn中使用ffmpeg-kit实现，提取视频文件的音频部分为独立文件的功能篇，这个功能已经实现，</p>
<p>有任何疑问见解欢迎评论区交流</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）]]></title>    <link>https://juejin.cn/post/7586482860104204315</link>    <guid>https://juejin.cn/post/7586482860104204315</guid>    <pubDate>2025-12-22T14:15:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860104204315" data-draft-id="7586506307727065098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T14:15:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅哥一天八碗米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4026886813920339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4026886813920339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅哥一天八碗米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:15:18.000Z" title="Mon Dec 22 2025 14:15:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（<code>@AnimatableExtend</code> 方案，能直接抄）</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F4109a3b759684c5386806e1fe6db5988%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/4109a3b759684c5386806e1fe6db5988?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">一起来构建生态吧~</a></p>
<blockquote>
<p>需求场景很典型：阅读器页面一滚动，顶部栏从“有点高、信息完整”逐步收缩成“更薄、更沉浸”；同时背景从透明慢慢变成不透明（避免内容顶到状态栏后看不清）。</p>
<p>这类动效如果用“手动 onScroll 改样式”，很容易出现：跳变、卡顿、代码散。 我这里给你一套更工程化的写法： <strong>用 <code>@AnimatableExtend</code> 把“高度”和“背景透明度”都做成可动画参数</strong>，你只负责给目标值，系统负责补间过渡。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 效果目标（先把体验说清楚）</h3>
<p>我们把顶部栏拆成两个维度：</p>
<h4 data-id="heading-2">1）高度收缩（Height）</h4>
<ul>
<li>初始：比如 <strong>64</strong></li>
<li>收缩后：比如 <strong>44</strong></li>
<li>滚动时随进度线性变化（或你自己换曲线）</li>
</ul>
<h4 data-id="heading-3">2）背景透明度（Alpha）</h4>
<ul>
<li>初始：<strong>0</strong>（完全透明，沉浸）</li>
<li>收缩后：<strong>1</strong>（完全不透明，保证可读性）</li>
<li>同样随滚动进度变化</li>
</ul>
<p>同时再加两个“人写出来的细节”：</p>
<ul>
<li><strong>标题渐隐 / 渐显</strong>：大标题在展开态更明显，收缩后变淡或缩小</li>
<li><strong>阴影出现</strong>：背景变实后加一点阴影，像真实 App 顶部栏一样“压住内容”</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. 整体结构（别急着写动画，先搭骨架）</h3>
<p>我建议阅读器页结构像这样（你之前有 Web 阅读器，照样适用）：</p>
<pre><code class="hljs language-sql" lang="sql"> Stack（全屏）
 ├── 内容层（Web <span class="hljs-operator">/</span> List <span class="hljs-operator">/</span> <span class="hljs-keyword">Scroll</span>）
 └── 顶部栏（<span class="hljs-keyword">Overlay</span>，永远浮在最上）
</code></pre>
<p>顶部栏用 <code>Stack</code>/<code>Row</code> 都行，关键是： <strong>它不参与内容布局</strong>（不然高度变化会挤压内容，体验很怪）。</p>
<hr/>
<h3 data-id="heading-5">3. 核心思路：用 1 个“折叠进度”驱动一切</h3>
<p>我们定义一个折叠进度 <code>collapseT</code>：</p>
<ul>
<li>取值范围：<code>0 ~ 1</code></li>
<li><code>0</code>：完全展开</li>
<li><code>1</code>：完全收缩</li>
</ul>
<p>然后把所有视觉变化都变成数学映射：</p>
<ul>
<li><code>height = lerp(expandedH, collapsedH, collapseT)</code></li>
<li><code>alpha = lerp(0, 1, collapseT)</code></li>
<li><code>titleOpacity = 1 - collapseT</code>（或者更柔一点）</li>
<li><code>shadowOpacity = collapseT</code></li>
</ul>
<p>这样代码会特别干净： <strong>滚动只负责更新 collapseT，其它都是派生出来的。</strong></p>
<hr/>
<h3 data-id="heading-6">4. 关键：<code>@AnimatableExtend</code> 两个扩展方法</h3>
<blockquote>
<p>为什么要用 <code>@AnimatableExtend</code>？ 因为你会发现：有些属性你想“丝滑过渡”，直接写 <code>.height()</code> <code>.backgroundColor()</code> 并不一定能跟你预期一样顺。 用 <code>@AnimatableExtend</code> 的思路是： <strong>让参数可动画，参数每帧变化，你每帧把它应用到组件属性上。</strong></p>
</blockquote>
<h4 data-id="heading-7">4.1 扩展 1：可动画高度</h4>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@AnimatableExtend(Column)</span>
 function <span class="hljs-title function_">animHeight</span><span class="hljs-params">(h: number)</span> {
   <span class="hljs-built_in">this</span>.height(h)
 }
</code></pre>
<blockquote>
<p>这里我扩展在 <code>Column</code> 上，是因为顶部栏我会用 <code>Column/Row/Stack</code> 包一层。 你也可以写 <code>@AnimatableExtend(Stack)</code> 或 <code>@AnimatableExtend(Row)</code>，看你实际结构。</p>
</blockquote>
<h4 data-id="heading-8">4.2 扩展 2：可动画背景透明度（用 alpha 控制）</h4>
<p>背景透明度最稳的做法： <strong>用 <code>rgba</code>（或 Color + alpha 的方式）生成颜色</strong>，把 alpha 作为动画参数。</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@AnimatableExtend</span>(<span class="hljs-title class_">Stack</span>)
 <span class="hljs-keyword">function</span> <span class="hljs-title function_">animBgAlpha</span>(<span class="hljs-params">alpha: <span class="hljs-built_in">number</span></span>) {
   <span class="hljs-comment">// alpha: 0~1</span>
   <span class="hljs-comment">// 用 RGBA 生成颜色（下面是白底示例，你可以换成你的主题色）</span>
   <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">`rgba(255, 255, 255, <span class="hljs-subst">${alpha}</span>)`</span>)
 }
</code></pre>
<blockquote>
<p>注意：有的同学会直接在 stateStyles 里写背景，但我们这里是“连续渐变”，更适合用 animatable 参数驱动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">5. 完整示例：阅读器页（滚动驱动顶部栏动效）</h3>
<blockquote>
<p>这里我用 <code>Scroll</code> + <code>Column</code> 模拟内容滚动。 你如果是 <code>Web</code>，只要把“滚动位置 scrollTop / progress”换成你 Web 上报的值即可（你前面已经做过 onMessage 上报进度，那套能直接接）。</p>
</blockquote>
<h4 data-id="heading-10">5.1 关键工具函数：lerp + clamp</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-keyword">function</span> <span class="hljs-title function_">clamp01</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
   <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
   <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">return</span> x
 }
 ​
 <span class="hljs-keyword">function</span> <span class="hljs-title function_">lerp</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, t: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
   <span class="hljs-keyword">return</span> a + (b - a) * t
 }
</code></pre>
<h4 data-id="heading-11">5.2 页面代码（可直接抄，逻辑尽量写得像真实项目）</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct ReaderPage {
   <span class="hljs-comment">// 顶部栏展开/收缩配置（你可以按设计稿改）</span>
   private readonly expandedH: number = <span class="hljs-number">64</span>
   private readonly collapsedH: number = <span class="hljs-number">44</span>
 ​
   // 这个是“动画目标值”，我们只改它，不直接改 UI
   @State private collapseT: number = <span class="hljs-number">0</span>
 ​
   // 真实滚动高度（示例用 scrollY 近似）
   @State private scrollY: number = <span class="hljs-number">0</span>
 ​
   // 当 scrollY 到达这个阈值时，顶部栏基本收缩完成
   private readonly collapseRange: number = <span class="hljs-number">120</span>
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Stack</span>() {
       <span class="hljs-comment">// ========= 内容层 =========</span>
       Scroll() {
         <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">12</span> }) {
           <span class="hljs-comment">// 模拟内容</span>
           <span class="hljs-built_in">ForEach</span>(new Array(<span class="hljs-number">60</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.map</span>((_, i) =&gt; <span class="hljs-selector-tag">i</span>), (i: number) =&gt; {
             Text(`第 ${i + <span class="hljs-number">1</span>} 段内容：这里模拟阅读器正文...`)
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
               <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">222</span>')
               <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, top: <span class="hljs-number">8</span>, bottom: <span class="hljs-number">8</span> })
           })
         }
         <span class="hljs-selector-class">.padding</span>({ top: this.expandedH + <span class="hljs-number">8</span> }) <span class="hljs-comment">// 给内容让出顶部栏空间（很关键！）</span>
       }
       <span class="hljs-selector-class">.onScroll</span>((xOffset: number, yOffset: number) =&gt; {
         this<span class="hljs-selector-class">.scrollY</span> = yOffset
 ​
         <span class="hljs-comment">// 把滚动距离映射成 0~1</span>
         const t = <span class="hljs-built_in">clamp01</span>(yOffset / this.collapseRange)
 ​
         <span class="hljs-comment">// 只更新目标值，让动画系统去补间</span>
         <span class="hljs-comment">// 这里用 animateTo 更“人写”，可控性更好</span>
         <span class="hljs-built_in">animateTo</span>({ duration: <span class="hljs-number">220</span>, curve: Curve.EaseInOut }, () =&gt; {
           this<span class="hljs-selector-class">.collapseT</span> = t
         })
       })
 ​
       <span class="hljs-comment">// ========= 顶部栏（覆盖层） =========</span>
       this<span class="hljs-selector-class">.TopBar</span>()
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.backgroundColor</span>('#F6F7F9')
   }
 ​
   <span class="hljs-keyword">@Builder</span>
   TopBar() {
     <span class="hljs-comment">// 派生：高度与背景透明度</span>
     const h = <span class="hljs-built_in">lerp</span>(this.expandedH, this.collapsedH, this.collapseT)
     const bgAlpha = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, this.collapseT)
     const titleOpacity = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, this.collapseT)      <span class="hljs-comment">// 大标题渐隐</span>
     const smallTitleOpacity = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, this.collapseT) <span class="hljs-comment">// 小标题渐显</span>
     const shadowAlpha = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.12</span>, this.collapseT)      <span class="hljs-comment">// 阴影随收缩出现</span>
 ​
     <span class="hljs-built_in">Stack</span>() {
       <span class="hljs-comment">// 顶部栏内容</span>
       <span class="hljs-built_in">Row</span>() {
         Text('返回')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">2</span>F7BFF')
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">8</span>)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; {
             <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> router back</span>
           })
 ​
         <span class="hljs-built_in">Blank</span>()
 ​
         <span class="hljs-comment">// 收缩后显示的小标题（更像真实阅读器）</span>
         Text('章节标题')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
           <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">222</span>')
           <span class="hljs-selector-class">.opacity</span>(smallTitleOpacity)
 ​
         <span class="hljs-built_in">Blank</span>()
 ​
         Text('目录')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">2</span>F7BFF')
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">8</span>)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; {
             <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> open chapter list</span>
           })
       }
       <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">12</span>, right: <span class="hljs-number">12</span> })
       <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-selector-class">.alignItems</span>(VerticalAlign.Center)
 ​
       <span class="hljs-comment">// 展开态的大标题（更沉浸、更像“阅读页顶部信息”）</span>
       <span class="hljs-built_in">Column</span>() {
         Text('书名 / 阅读器')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)
           <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">111</span>')
           <span class="hljs-selector-class">.opacity</span>(titleOpacity)
       }
       <span class="hljs-selector-class">.position</span>({ x: <span class="hljs-number">16</span>, y: <span class="hljs-number">10</span> })
     }
     <span class="hljs-comment">// 关键：可动画高度 + 可动画背景透明度</span>
     <span class="hljs-selector-class">.animHeight</span>(h)
     <span class="hljs-selector-class">.animBgAlpha</span>(bgAlpha)
     <span class="hljs-comment">// 轻微阴影：背景变实的时候出现一点压住正文的感觉</span>
     <span class="hljs-selector-class">.shadow</span>({
       radius: <span class="hljs-number">12</span>,
       color: `rgba(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,${shadowAlpha})`,
       offsetX: <span class="hljs-number">0</span>,
       offsetY: <span class="hljs-number">6</span>
     })
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.position</span>({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">0</span> })
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-12">6. 这段代码里最容易忽略的“真实细节”</h3>
<h4 data-id="heading-13">6.1 内容顶部 padding 必须给出来</h4>
<p>你看到我这里写了：</p>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-selector-class">.padding</span>({ <span class="hljs-attribute">top</span>: this.expandedH + <span class="hljs-number">8</span> })
</code></pre>
<p>这是很现实的问题： 顶部栏是 overlay，如果内容不让空间，正文会被盖住，看起来像“顶到状态栏”，体验会很差。</p>
<blockquote>
<p>你也可以做得更精细：padding 跟着顶部栏高度动态变化。 但一般阅读器里为了稳定，直接用展开高度固定 padding 就够用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI帮我搭猫窝：一场空间推理能力的实战测评]]></title>    <link>https://juejin.cn/post/7586579021283409974</link>    <guid>https://juejin.cn/post/7586579021283409974</guid>    <pubDate>2025-12-23T01:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586579021283409974" data-draft-id="7586579021283393590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI帮我搭猫窝：一场空间推理能力的实战测评"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T01:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI帮我搭猫窝：一场空间推理能力的实战测评
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:57:04.000Z" title="Tue Dec 23 2025 01:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我家里有两只“猪咪”，它们的窝被自己压坏了，加上冬天地上有些凉，就想着亲手给它们打造一个坚固、悬空的猫窝/猫架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3f5b9c46b040549b749b252f9ae2cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=lfNB2N6Lx%2Fo2UOD72VyvaW338q4%3D" alt="" loading="lazy"/></p>
<p>X书搜了下，实践的人倒是不少，就是教程的材料购买写的不是那么清楚，还需要我自己计算需要几根管，各是多长的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5df3c341110c44e9933ef6592bd804be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=hm30JyvVxEyf26lHe0edifHhvL4%3D" alt="图侵删" loading="lazy"/></p>
<p>对于我这种“懒”人，肯定要去“压迫” AI 了。</p>
<h2 data-id="heading-0">失败的尝试</h2>
<p>本来，我以为这个问题很简单，图一传，指令简单一写就搞定了。</p>
<p>不出意外地发生了意外。</p>
<p>先来看下提示词，为了更好地对比，后续所有 AI 的提示词都是一致的。</p>
<pre><code class="hljs">我要使用pvc制作如图的猫窝，请帮我编制原材料采购清单，整个猫窝大概50cmx50cmx60cm
</code></pre>
<h3 data-id="heading-1">千问</h3>
<p>竟然只需要<code>4根立柱</code>+<code>4根横梁</code>，这出来的东西，自己都站不住吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffe21cef70094ea98191a842a757c73f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=L8k%2FiqWZbrKoMCx5vJXn6VS61ZY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">豆包</h3>
<p><code>PVC</code> 管倒是分析的还行，就是连接件肯定没法连接上这几根管。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/618358d5aac24665b61ac296a3f77411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=Jv1yOoVNgDH%2Bja8cOuu59fTf9Bw%3D" alt="" loading="lazy"/></p>
<p>国内的不行，我试试国外的。</p>
<h3 data-id="heading-3">GPT-5.2</h3>
<p>正好前几天 <code>OpenAI</code> 发布了 <code>GPT-5.2</code>，我尝试了编程场景还不错，今天试试空间能力如何。</p>
<p>采用的 <code>TRAE</code> 下的 <code>GPT-5.2</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a893b783f624d30a13e8fb2de99a11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=VlOnlxHHhmRX28C9MS5VycFxvLQ%3D" alt="" loading="lazy"/></p>
<p>整体理解没什么太大问题，硬管的分析也比较正确。</p>
<p>但整个结构提出了 2 种方案，可以说是 <code>GPT</code> 比较保守，也可以理解为识别的不是特别准确。</p>
<p>并且，对于接口构件的知识有所欠缺，比如竟然不用专业名词“立体三通”，这让我买东西的时候怎么给商家说。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcd76626a7d048ca9d8b3f4c117dcf27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=YyzTAJ1%2BN1%2Bj0onijMSY2kQro4k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">成功的尝试</h2>
<p>最终，我又尝试了空间感超强的 <code>Gemini 3 Pro</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b01719c11c4468d8608be5226ade974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=lqoAl5rAT%2Ba1oItEoUIP2ETi1F4%3D" alt="" loading="lazy"/></p>
<p>硬管的数量、尺寸，都没什么问题。</p>
<p>立柱采用了两节的方式，并且分别计算出了正确的长度。</p>
<p>甚至，连接头本身的<strong>多余尺寸</strong>都考虑到了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d473ce04ddb64e60beae2a83fe73e773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=BUDwRhsYoWAUT%2B4QPdI0lAMmOpE%3D" alt="" loading="lazy"/></p>
<p>确实厉害。</p>
<h2 data-id="heading-5">更进一步的尝试</h2>
<p>既然，<code>Gemini 3 Pro</code> 这么厉害，那我就忍不住想试试再难一点的了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edcff4160a914d3ba153b6ce72d4efa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=MCdWL%2FrUx%2BPCoaKfl3YzKlivkQk%3D" alt="图侵删" loading="lazy"/></p>
<p>找了个稍微<strong>异形</strong>一点的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76d7a356d7ea4424be503e39b362e6a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=dBWizNnFOzMrgpTdr2XmCuKjCTI%3D" alt="" loading="lazy"/></p>
<p>硬管数量、长度依然正确。</p>
<p>甚至连异形所需的“立体三通”，“45度弯头”都是对的。</p>
<p>唯一一个不太完美的就是“垂直立柱”的上下段拆分长度（20cm+20cm）不太完美。</p>
<p>不过，依然非常惊艳。</p>
<h2 data-id="heading-6">结语</h2>
<p>本来只是想简单的偷点懒，没想到各 <code>AI</code> 的空间理解能力相差竟然如此之大。</p>
<p>还好最终 <code>Gemini 3 Pro</code> 给出了比较完美的结果。不然，今天猫窝的原料采购都搞不完了。</p>
<p>现有 AI 肯定不能完全搞定全部事情，因此，我们需要不断尝试并了解各个 AI 的脾性，这样才能更好地利用 AI 能力帮我们解决问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做]]></title>    <link>https://juejin.cn/post/7586505172815298611</link>    <guid>https://juejin.cn/post/7586505172815298611</guid>    <pubDate>2025-12-22T14:18:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815298611" data-draft-id="7586482860104237083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T14:18:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅哥一天八碗米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4026886813920339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4026886813920339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅哥一天八碗米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:18:23.000Z" title="Mon Dec 22 2025 14:18:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F4109a3b759684c5386806e1fe6db5988%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/4109a3b759684c5386806e1fe6db5988?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">一起来构建生态吧~</a></p>
<blockquote>
<p>先说结论：ArkUI 的 <code>@Reusable</code> <strong>复用池本身不是一个你能直接拿到的对象</strong>，也没有一个官方 API 让你“读出当前池子里有多少个实例”。 所以所谓“监控复用池”，本质上是： ✅ <strong>通过组件生命周期回调 + 统一打点工具</strong>，去<strong>推断</strong>复用发生了多少次、哪些组件在复用、有没有状态没重置导致串数据。</p>
</blockquote>
<p>下面给你一套我在项目里会用的“监控方案”，特点是：</p>
<ul>
<li>侵入性低（加几行就能看到复用情况）</li>
<li>日志清晰（创建 / 复用 / 退出 / 重置）</li>
<li>能按 <code>reuseId</code> 归类统计</li>
<li>能定位“复用导致的脏状态”问题</li>
</ul>
<hr/>
<h3 data-id="heading-1">1）监控目标：我们到底想看到什么？</h3>
<p>我建议至少把这 4 类信息打出来：</p>
<ol start="0">
<li><strong>create</strong>：首次创建（不是复用池拿出来的）</li>
<li><strong>reuse</strong>：从复用池中取出再利用（关键指标）</li>
<li><strong>detach / disappear</strong>：从树上移除/不可见（进入复用池的前置条件）</li>
<li><strong>state reset</strong>：复用时你做了哪些重置（防串数据）</li>
</ol>
<p>然后统计两个核心指标：</p>
<ul>
<li><code>reuseRate = reuseCount / (createCount + reuseCount)</code></li>
<li><code>activeCount</code>：当前在树上的实例数（帮助判断列表滚动时是否稳定）</li>
</ul>
<hr/>
<h3 data-id="heading-2">2）核心思路：做一个全局 ReusePoolMonitor（只管日志和计数）</h3>
<p>新建一个文件：</p>
<pre><code class="hljs language-typescript" lang="typescript"> entry/src/main/ets/utils/<span class="hljs-title class_">ReusePoolMonitor</span>.<span class="hljs-property">ts</span>
 <span class="hljs-comment">// entry/src/main/ets/utils/ReusePoolMonitor.ts</span>
 <span class="hljs-keyword">type</span> <span class="hljs-title class_">ReuseEvent</span> =
   | <span class="hljs-string">'create'</span>
   | <span class="hljs-string">'reuse'</span>
   | <span class="hljs-string">'appear'</span>
   | <span class="hljs-string">'disappear'</span>
   | <span class="hljs-string">'reset'</span>;
 ​
 <span class="hljs-keyword">type</span> <span class="hljs-title class_">MonitorKey</span> = <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 通常用: `${reuseId}:${componentName}`</span>
 ​
 <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InstanceInfo</span> {
   <span class="hljs-attr">instanceId</span>: <span class="hljs-built_in">string</span>;     <span class="hljs-comment">// 你自己生成的 id</span>
   <span class="hljs-attr">firstSeenAt</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">lastEventAt</span>: <span class="hljs-built_in">number</span>;
   lastItemKey?: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// 业务数据 key（例如 item.id）</span>
 }
 ​
 <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GroupStats</span> {
   <span class="hljs-attr">createCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">reuseCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">appearCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">disappearCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">resetCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">activeInstanceIds</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;;
   <span class="hljs-attr">instances</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">InstanceInfo</span>&gt;; <span class="hljs-comment">// instanceId -&gt; info</span>
 }
 ​
 <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReusePoolMonitor</span> {
   <span class="hljs-keyword">private</span> <span class="hljs-attr">groups</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">MonitorKey</span>, <span class="hljs-title class_">GroupStats</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
   <span class="hljs-keyword">private</span> <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;
 ​
   <span class="hljs-title function_">enable</span>(<span class="hljs-params">on: <span class="hljs-built_in">boolean</span></span>) {
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span> = on;
   }
 ​
   <span class="hljs-keyword">private</span> <span class="hljs-title function_">getGroup</span>(<span class="hljs-attr">key</span>: <span class="hljs-title class_">MonitorKey</span>): <span class="hljs-title class_">GroupStats</span> {
     <span class="hljs-keyword">let</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">get</span>(key);
     <span class="hljs-keyword">if</span> (!g) {
       g = {
         <span class="hljs-attr">createCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">reuseCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">appearCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">disappearCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">resetCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">activeInstanceIds</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;(),
         <span class="hljs-attr">instances</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">InstanceInfo</span>&gt;(),
       };
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">set</span>(key, g);
     }
     <span class="hljs-keyword">return</span> g;
   }
 ​
   <span class="hljs-title function_">mark</span>(<span class="hljs-params">
     groupKey: MonitorKey,
     event: ReuseEvent,
     payload: { instanceId: <span class="hljs-built_in">string</span>; itemKey?: <span class="hljs-built_in">string</span>; extra?: <span class="hljs-built_in">string</span> } = { instanceId: <span class="hljs-string">'unknown'</span> }
   </span>) {
     <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span>) <span class="hljs-keyword">return</span>;
 ​
     <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
     <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGroup</span>(groupKey);
 ​
     <span class="hljs-comment">// 维护实例信息</span>
     <span class="hljs-keyword">let</span> info = g.<span class="hljs-property">instances</span>.<span class="hljs-title function_">get</span>(payload.<span class="hljs-property">instanceId</span>);
     <span class="hljs-keyword">if</span> (!info) {
       info = {
         <span class="hljs-attr">instanceId</span>: payload.<span class="hljs-property">instanceId</span>,
         <span class="hljs-attr">firstSeenAt</span>: now,
         <span class="hljs-attr">lastEventAt</span>: now,
         <span class="hljs-attr">lastItemKey</span>: payload.<span class="hljs-property">itemKey</span>,
       };
       g.<span class="hljs-property">instances</span>.<span class="hljs-title function_">set</span>(payload.<span class="hljs-property">instanceId</span>, info);
     } <span class="hljs-keyword">else</span> {
       info.<span class="hljs-property">lastEventAt</span> = now;
       <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">itemKey</span> !== <span class="hljs-literal">undefined</span>) info.<span class="hljs-property">lastItemKey</span> = payload.<span class="hljs-property">itemKey</span>;
     }
 ​
     <span class="hljs-comment">// 统计</span>
     <span class="hljs-keyword">switch</span> (event) {
       <span class="hljs-keyword">case</span> <span class="hljs-string">'create'</span>:
         g.<span class="hljs-property">createCount</span>++;
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'reuse'</span>:
         g.<span class="hljs-property">re_toggleReuseCount</span> ? <span class="hljs-literal">null</span> : <span class="hljs-literal">null</span>; <span class="hljs-comment">// 占位避免你复制后误删结构</span>
         g.<span class="hljs-property">reuseCount</span>++;
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'appear'</span>:
         g.<span class="hljs-property">appearCount</span>++;
         g.<span class="hljs-property">activeInstanceIds</span>.<span class="hljs-title function_">add</span>(payload.<span class="hljs-property">instanceId</span>);
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'disappear'</span>:
         g.<span class="hljs-property">disappearCount</span>++;
         g.<span class="hljs-property">activeInstanceIds</span>.<span class="hljs-title function_">delete</span>(payload.<span class="hljs-property">instanceId</span>);
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'reset'</span>:
         g.<span class="hljs-property">resetCount</span>++;
         <span class="hljs-keyword">break</span>;
     }
 ​
     <span class="hljs-comment">// 日志输出（格式尽量“人能看懂”）</span>
     <span class="hljs-keyword">const</span> itemPart = payload.<span class="hljs-property">itemKey</span> !== <span class="hljs-literal">undefined</span> ? <span class="hljs-string">` itemKey=<span class="hljs-subst">${payload.itemKey}</span>`</span> : <span class="hljs-string">''</span>;
     <span class="hljs-keyword">const</span> extraPart = payload.<span class="hljs-property">extra</span> ? <span class="hljs-string">` <span class="hljs-subst">${payload.extra}</span>`</span> : <span class="hljs-string">''</span>;
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(
       <span class="hljs-string">`[ReusableMonitor] [<span class="hljs-subst">${groupKey}</span>] <span class="hljs-subst">${event}</span> instance=<span class="hljs-subst">${payload.instanceId}</span><span class="hljs-subst">${itemPart}</span> active=<span class="hljs-subst">${g.activeInstanceIds.size}</span><span class="hljs-subst">${extraPart}</span>`</span>
     );
   }
 ​
   <span class="hljs-title function_">snapshot</span>(<span class="hljs-params">groupKey?: MonitorKey</span>) {
     <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span>) <span class="hljs-keyword">return</span>;
 ​
     <span class="hljs-keyword">const</span> keys = groupKey ? [groupKey] : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">keys</span>());
     keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
       <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">get</span>(k);
       <span class="hljs-keyword">if</span> (!g) <span class="hljs-keyword">return</span>;
 ​
       <span class="hljs-keyword">const</span> total = g.<span class="hljs-property">createCount</span> + g.<span class="hljs-property">reuseCount</span>;
       <span class="hljs-keyword">const</span> reuseRate = total === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (g.<span class="hljs-property">reuseCount</span> / total) * <span class="hljs-number">100</span>;
 ​
       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(
         <span class="hljs-string">`[ReusableMonitor] [<span class="hljs-subst">${k}</span>] SNAPSHOT create=<span class="hljs-subst">${g.createCount}</span> reuse=<span class="hljs-subst">${g.reuseCount}</span> reuseRate=<span class="hljs-subst">${reuseRate.toFixed(
           <span class="hljs-number">1</span>
         )}</span>% appear=<span class="hljs-subst">${g.appearCount}</span> disappear=<span class="hljs-subst">${g.disappearCount}</span> reset=<span class="hljs-subst">${g.resetCount}</span> active=<span class="hljs-subst">${g.activeInstanceIds.size}</span> knownInstances=<span class="hljs-subst">${g.instances.size}</span>`</span>
       );
     });
   }
 }
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> reuseMonitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReusePoolMonitor</span>();
</code></pre>
<blockquote>
<p>说明：上面我用的是“推断式监控”。你只要在生命周期里调用 <code>reuseMonitor.mark(...)</code>，就能看到复用是否发生、发生频率如何。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3）在 <code>@Reusable</code> 组件里接入监控（关键：实例 ID + itemKey）</h3>
<h4 data-id="heading-4">3.1 一个可复用的列表项组件（带监控日志）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// entry/src/main/ets/components/BookRow.ets</span>
 ​
 <span class="hljs-keyword">import</span> { reuseMonitor } from <span class="hljs-string">'../utils/ReusePoolMonitor'</span>;
 ​
 <span class="hljs-meta">@Reusable</span>
 <span class="hljs-meta">@Component</span>
 export struct BookRow {
   <span class="hljs-comment">// 业务入参：列表数据</span>
   <span class="hljs-meta">@Prop</span> itemId: string = <span class="hljs-string">''</span>
   <span class="hljs-meta">@Prop</span> title: string = <span class="hljs-string">''</span>
 ​
   <span class="hljs-comment">// 给每个组件实例一个固定的 id（用于追踪同一个实例被复用多少次）</span>
   <span class="hljs-keyword">private</span> instanceId: string = `BookRow#${Math.random().toString(<span class="hljs-number">16</span>).slice(<span class="hljs-number">2</span>)}`;
 ​
   <span class="hljs-comment">// 你组件里可能有 @State，这就是最容易“复用串数据”的地方</span>
   <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> highlight: boolean = <span class="hljs-literal">false</span>;
 ​
   aboutToAppear() {
     <span class="hljs-comment">// 说明：aboutToAppear 更像“进树前”，你可以当作 appear</span>
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'appear'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
     });
   }
 ​
   aboutToDisappear() {
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'disappear'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
     });
   }
 ​
   <span class="hljs-comment">// 复用发生时会走这里（重点）</span>
   aboutToReuse(params: Record&lt;string, <span class="hljs-keyword">object</span>&gt;) {
     <span class="hljs-comment">// params 里通常会带新的入参（不同版本/写法会有差异，你按你项目实际来取）</span>
     <span class="hljs-comment">// 这里我们只演示：复用时重置状态 + 打日志</span>
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'reuse'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
       extra: <span class="hljs-string">'(before reset)'</span>,
     });
 ​
     <span class="hljs-comment">// ✅ 复用最关键的一步：重置本地状态，避免串数据</span>
     <span class="hljs-keyword">this</span>.highlight = <span class="hljs-literal">false</span>;
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'reset'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
       extra: <span class="hljs-string">'highlight=false'</span>,
     });
   }
 ​
   <span class="hljs-comment">// 首次创建时记录 create（你可以放在 aboutToAppear 的第一次触发里，这里简单起见写在构造逻辑附近不太好判断）</span>
   <span class="hljs-comment">// 实际上：我们用一个小技巧 —— instanceId 初次出现时在 monitor 内会新增实例，你也可以把 “firstSeenAt” 当 create</span>
   <span class="hljs-comment">// 如果你一定要明确 create，可以在 aboutToAppear 里判断一个 flag。</span>
   <span class="hljs-keyword">private</span> createdOnce: boolean = <span class="hljs-literal">false</span>;
 ​
   build() {
     <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.createdOnce) {
       <span class="hljs-keyword">this</span>.createdOnce = <span class="hljs-literal">true</span>;
       reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'create'</span>, {
         instanceId: <span class="hljs-keyword">this</span>.instanceId,
         itemKey: <span class="hljs-keyword">this</span>.itemId,
       });
     }
 ​
     Row() {
       Text(<span class="hljs-keyword">this</span>.title)
         .fontSize(<span class="hljs-number">16</span>)
         .fontColor(<span class="hljs-keyword">this</span>.highlight ? <span class="hljs-string">'#2F7BFF'</span> : <span class="hljs-string">'#222'</span>)
       Blank()
       Text(<span class="hljs-keyword">this</span>.itemId)
         .fontSize(<span class="hljs-number">12</span>)
         .fontColor(<span class="hljs-string">'#999'</span>)
     }
     .padding({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, top: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span> })
     .backgroundColor(<span class="hljs-string">'#FFF'</span>)
     .onClick(() =&gt; {
       <span class="hljs-keyword">this</span>.highlight = !<span class="hljs-keyword">this</span>.highlight;
     })
   }
 }
</code></pre>
<blockquote>
<p>你会发现我特别强调 <code>@State</code> 的 reset。 因为复用的 bug，十有八九就是：<strong>上一个 item 的状态残留到了下一个 item</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4）在列表里使用，并且定期打 Snapshot（更像真实排查）</h3>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// entry/src/main/ets/pages/ReuseListDemo.ets</span>
 <span class="hljs-keyword">import</span> { reuseMonitor } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ReusePoolMonitor'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BookRow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/BookRow'</span>;
 ​
 <span class="hljs-meta">@Entry</span>
 <span class="hljs-meta">@Component</span>
 struct <span class="hljs-title class_">ReuseListDemo</span> {
   <span class="hljs-meta">@State</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> }&gt; = []
 ​
   <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
       <span class="hljs-attr">id</span>: <span class="hljs-string">`ID-<span class="hljs-subst">${i}</span>`</span>,
       <span class="hljs-attr">title</span>: <span class="hljs-string">`第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 本书：示例标题`</span>,
     }));
 ​
     <span class="hljs-comment">// 每隔 2 秒输出一次快照（调试用，上线前关掉）</span>
     <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
       reuseMonitor.<span class="hljs-title function_">snapshot</span>(<span class="hljs-string">'BookRow:default'</span>);
     }, <span class="hljs-number">2000</span>);
   }
 ​
   <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
     <span class="hljs-title class_">List</span>() {
       <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>, <span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> {
         <span class="hljs-title class_">ListItem</span>() {
           <span class="hljs-title class_">BookRow</span>({ <span class="hljs-attr">itemId</span>: it.<span class="hljs-property">id</span>, <span class="hljs-attr">title</span>: it.<span class="hljs-property">title</span> })
             .<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'BookRow:default'</span>) <span class="hljs-comment">// 复用分组：同组才能复用</span>
         }
       }, <span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> it.<span class="hljs-property">id</span>) <span class="hljs-comment">// key 很重要：帮助框架稳定识别 item</span>
     }
     .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
     .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
     .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F6F7F9'</span>)
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-6">5）你会看到怎样的日志？怎么读才“有用”？</h3>
<p>你滚动列表时，大致会看到类似：</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> create <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=1</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> appear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=1</span>
 ​
 ...滚动...
 ​
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> disappear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=10</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> reuse <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10 (before reset)</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> reset <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10 highlight=false</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> appear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10</span>
</code></pre>
<p>这行日志的“人话解读”是：</p>
<ul>
<li><code>BookRow#9af3</code> 这个实例原来显示 <code>ID-0</code></li>
<li>滚出屏幕后 <code>disappear</code></li>
<li>再次被拿出来复用显示 <code>ID-20</code></li>
<li>复用时我们重置了 highlight，避免串数据</li>
<li>然后重新 appear</li>
</ul>
<p>快照会输出：</p>
<pre><code class="hljs language-ini" lang="ini"> SNAPSHOT <span class="hljs-attr">create</span>=<span class="hljs-number">12</span> reuse=<span class="hljs-number">180</span> reuseRate=<span class="hljs-number">93.8</span>% appear=... disappear=... reset=<span class="hljs-number">180</span> active=<span class="hljs-number">10</span> knownInstances=<span class="hljs-number">12</span>
</code></pre>
<p>重点看两个数：</p>
<ul>
<li><code>reuseRate</code>：越高说明复用越充分（通常长列表会非常高）</li>
<li><code>knownInstances</code>：基本能近似理解为“池子里曾经创建过多少个实例”（不会无限增长的话，说明复用稳定）</li>
</ul>
<hr/>
<h3 data-id="heading-7">6）最常见的“复用串数据”怎么用日志定位？</h3>
<h4 data-id="heading-8">症状</h4>
<p>你发现某一行高亮了、按钮 disabled 了、进度条停在某个值……但那是上一条数据的状态。</p>
<h4 data-id="heading-9">定位方式（很快）</h4>
<ol start="0">
<li>看日志里同一个 <code>instanceId</code></li>
<li>它从 <code>itemKeyA</code> reuse 到 <code>itemKey=B</code></li>
<li>如果你没看到对应的 <code>reset</code> 日志（或 reset 不完整） → 99% 就是状态没清干净</li>
</ol>
<p>我一般会把 reset 写得很“啰嗦”，调试阶段宁可多打两行：</p>
<ul>
<li>reset highlight</li>
<li>reset progress</li>
<li>reset selected</li>
<li>reset loading</li>
</ul>
<p>调通后再精简。</p>
<hr/>
<h3 data-id="heading-10">7）上线建议：怎么不影响性能？</h3>
<ul>
<li>监控类里加 <code>enable(false)</code> 开关</li>
<li>或者用环境变量控制（Debug 开、Release 关）</li>
<li><code>setInterval(snapshot)</code> 只在调试打开，上线必须关</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"> reuseMonitor.<span class="hljs-built_in">enable</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// release 环境</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">8）一句总结</h3>
<p>复用池监控这件事，说白了就是：<strong>你无法直接看池子，但你能看“复用行为”</strong> 。 只要把 <code>create / reuse / disappear / reset</code> 这条链路跑通，再配上按 <code>reuseId</code> 的统计快照，排查性能和串状态问题会省非常多时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文了解 Cookie、localStorage、sessionStorage的区别与实战案例]]></title>    <link>https://juejin.cn/post/7586498198149365811</link>    <guid>https://juejin.cn/post/7586498198149365811</guid>    <pubDate>2025-12-22T14:24:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586498198149365811" data-draft-id="7586482860104269851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一文了解 Cookie、localStorage、sessionStorage的区别与实战案例"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-22T14:24:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一文了解 Cookie、localStorage、sessionStorage的区别与实战案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:24:05.000Z" title="Mon Dec 22 2025 14:24:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文了解 Cookie、localStorage、sessionStorage的区别与实战案例</h2>
<p>在前端开发中，浏览器存储是不可或缺的核心能力，无论是保存用户登录状态、记住主题偏好，还是暂存表单中间数据，都离不开它。而Cookie、localStorage、sessionStorage作为最常用的三种浏览器存储方案，很多开发者在实际项目中容易混淆它们的使用场景。</p>
<p>本文将从核心特性出发，清晰对比三者的区别，再结合Vue框架给出可直接复用的实战代码案例，帮你彻底搞懂何时用哪种存储方案。</p>
<h3 data-id="heading-1">一、核心区别对比（一张表看懂）</h3>
<p>先通过一张对比表，快速掌握三者的核心差异知识点：</p>















































<table><thead><tr><th>特性</th><th>Cookie</th><th>localStorage</th><th>sessionStorage</th></tr></thead><tbody><tr><td>存储容量</td><td>约 4KB（容量较小，适合存储少量数据）</td><td>约 5MB（容量较大，可存储更多本地数据）</td><td>约 5MB（容量较大）</td></tr><tr><td>生命周期</td><td>可手动设置过期时间，默认随会话结束（关闭浏览器）清除</td><td>永久存储，除非手动清除（清除浏览器缓存、代码删除）</td><td>会话级存储，关闭当前标签页即清除（同一浏览器不同标签页不共享）</td></tr><tr><td>作用域</td><td>同源（协议、域名、端口一致）下共享，且自动随每次HTTP请求发送到服务器</td><td>同源下共享，仅通过JS访问，不主动发送给服务器</td><td>同源且同标签页下共享，不同标签页即使同源也不共享</td></tr><tr><td>是否自动发送给服务器</td><td>是（每次请求都会携带，可能增加请求体积）</td><td>否</td><td>否</td></tr><tr><td>访问方式</td><td>JS和服务器均可访问</td><td>仅JS可访问</td><td>仅JS可访问</td></tr><tr><td>典型用途</td><td>会话管理、身份验证（如登录Token）、记住密码</td><td>长期保存用户偏好（如暗黑模式）、本地缓存不敏感数据</td><td>暂存单次会话数据（如多步骤表单中间值、页面临时状态）</td></tr></tbody></table>
<h3 data-id="heading-2">二、Vue实战案例（可直接复用）</h3>
<p>在Vue项目中，不同存储方案的使用方式略有差异，下面结合实际业务场景，给出完整的代码示例。</p>
<h4 data-id="heading-3">1. Cookie：适合存储登录状态等需要和服务器交互的数据</h4>
<p>Cookie原生API使用起来不够便捷，推荐使用 <code>js-cookie</code> 库（轻量、易用），专门用于管理Cookie。</p>
<h5 data-id="heading-4">步骤1：安装依赖</h5>
<pre><code class="hljs language-css" lang="css">npm install js-cookie <span class="hljs-attr">--save</span>
</code></pre>
<h5 data-id="heading-5">步骤2：实战代码（登录状态管理）</h5>
<p>场景：用户登录后保存Token，退出登录时删除Token，页面刷新后保留登录状态。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>用户登录<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"username"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"password"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogout"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-logout"</span>&gt;</span>退出登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"token"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-status"</span>&gt;</span>当前登录状态：已登录（Token：{{ token }}）<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-status"</span>&gt;</span>当前登录状态：未登录<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入js-cookie库</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Cookies</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'js-cookie'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'LoginPage'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
      <span class="hljs-comment">// 初始化时从Cookie获取Token，无则为空</span>
      <span class="hljs-attr">token</span>: <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'userToken'</span>) || <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleLogin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 模拟接口请求登录（实际项目中替换为真实接口）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>) {
        <span class="hljs-keyword">const</span> mockToken = <span class="hljs-string">'mock_user_token_123456'</span>; <span class="hljs-comment">// 接口返回的Token</span>
        <span class="hljs-comment">// 设置Cookie：key为userToken，值为mockToken，过期时间1天</span>
        <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'userToken'</span>, mockToken, { <span class="hljs-attr">expires</span>: <span class="hljs-number">1</span> });
        <span class="hljs-comment">// 更新本地Token状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = mockToken;
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'登录成功！'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请输入用户名和密码！'</span>);
      }
    },
    <span class="hljs-title function_">handleLogout</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 删除Cookie</span>
      <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'userToken'</span>);
      <span class="hljs-comment">// 重置状态</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = <span class="hljs-string">''</span>;
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'退出登录成功！'</span>);
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


</code></pre>
<h5 data-id="heading-6">核心说明</h5>
<ul>
<li>设置Cookie时，<code>expires: 1</code> 表示1天后过期，也可设置为具体日期（如 <code>new Date('2025-12-31')</code>）；</li>
<li>删除Cookie时，需确保 <code>Cookies.remove()</code> 的key与设置时一致；</li>
<li>适合存储需要和服务器交互的身份信息，因为Cookie会自动随请求发送。</li>
</ul>
<h4 data-id="heading-7">2. localStorage：适合长期保存用户偏好数据</h4>
<p>localStorage原生API已足够简洁，无需额外安装依赖，适合存储长期不失效的本地数据。</p>
<h5 data-id="heading-8">实战代码（主题切换功能）</h5>
<p>场景：用户切换暗黑/亮色主题后，刷新页面依然保留当前主题设置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"theme"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主题切换演示<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前主题：{{ theme === 'light' ? '亮色模式' : '暗黑模式' }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleTheme"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-btn"</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'ThemeSwitch'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 初始化时从localStorage获取主题，无则默认亮色模式</span>
      <span class="hljs-attr">theme</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'appTheme'</span>) || <span class="hljs-string">'light'</span>
    };
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 切换主题状态</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>;
      <span class="hljs-comment">// 保存主题到localStorage（永久有效，除非手动清除）</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'appTheme'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span>);
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<h5 data-id="heading-9">核心说明</h5>
<ul>
<li>使用 <code>localStorage.setItem(key, value)</code> 存储数据，<code>localStorage.getItem(key)</code> 获取数据；</li>
<li>数据永久保存，即使关闭浏览器再重新打开，依然能获取到；</li>
<li>适合存储用户偏好、本地缓存数据等不需要和服务器交互的长期数据。</li>
</ul>
<h4 data-id="heading-10">3. sessionStorage：适合暂存会话级临时数据</h4>
<p>sessionStorage的API和localStorage完全一致，但生命周期是会话级，关闭标签页后数据即丢失。</p>
<h5 data-id="heading-11">实战代码（多步骤表单暂存）</h5>
<p>场景：多步骤表单（如注册表单），用户填写完第一步内容后，切换页面再返回，依然保留已填写的内容（关闭标签页后丢失）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>多步骤注册表单（步骤1）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.username"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"tel"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.phone"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入手机号"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goToNextStep"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-btn"</span>&gt;</span>下一步（暂存数据）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tip"</span>&gt;</span>提示：关闭当前标签页后，已填写内容将丢失<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'MultiStepForm'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 初始化时从sessionStorage获取暂存的表单数据，无则为空对象</span>
      <span class="hljs-attr">formData</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'step1Form'</span>)) || {
        <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">phone</span>: <span class="hljs-string">''</span>
      }
    };
  },
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-comment">// 监听formData变化，实时暂存到sessionStorage</span>
    <span class="hljs-attr">formData</span>: {
      <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 深度监听对象内部属性变化</span>
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">newVal</span>) {
        <span class="hljs-comment">// sessionStorage只能存储字符串，需将对象转为JSON字符串</span>
        sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'step1Form'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newVal));
      }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">goToNextStep</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>.<span class="hljs-property">username</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>.<span class="hljs-property">phone</span>) {
        <span class="hljs-comment">// 模拟跳转到下一步表单（实际项目中用路由跳转）</span>
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'已暂存步骤1数据，跳转到步骤2'</span>);
        <span class="hljs-comment">// 此处可添加路由跳转代码，如：this.$router.push('/register-step2')</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请填写完整用户名和手机号！'</span>);
      }
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<h5 data-id="heading-12">核心说明</h5>
<ul>
<li>API和localStorage一致，但数据仅在当前标签页有效，关闭标签页或打开新标签页均无法获取；</li>
<li>存储对象时，需用 <code>JSON.stringify()</code> 转为字符串，获取时用 <code>JSON.parse()</code> 转回对象；</li>
<li>适合暂存单次会话的临时数据，如多步骤表单、页面临时状态等，无需长期保留的数据。</li>
</ul>
<h3 data-id="heading-13">三、总结：如何选择合适的存储方案？</h3>
<p>最后用一张表快速梳理三种方案的Vue使用场景和核心要点，方便实际开发中快速决策：</p>

























<table><thead><tr><th>存储方式</th><th>Vue中典型使用场景</th><th>核心要点</th></tr></thead><tbody><tr><td>Cookie</td><td>登录状态管理、身份验证（Token）、记住密码</td><td>用js-cookie库简化操作，可设置过期时间，自动随请求发送</td></tr><tr><td>localStorage</td><td>用户主题偏好、本地缓存数据、长期保存的不敏感信息</td><td>原生API简洁，永久存储，需手动清除，不发送给服务器</td></tr><tr><td>sessionStorage</td><td>多步骤表单暂存、页面临时状态、单次会话数据</td><td>API同localStorage，会话级生命周期，关闭标签页即清除</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>