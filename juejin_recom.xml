<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[[Ai Agent] 09 LangGraph 进阶：构建可控、可协作的多智能体系统]]></title>    <link>https://juejin.cn/post/7575090551357669428</link>    <guid>https://juejin.cn/post/7575090551357669428</guid>    <pubDate>2025-11-23T09:28:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357669428" data-draft-id="7575090551357653044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[Ai Agent] 09 LangGraph 进阶：构建可控、可协作的多智能体系统"/> <meta itemprop="keywords" content="LangChain,Agent"/> <meta itemprop="datePublished" content="2025-11-23T09:28:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="再会呀"/> <meta itemprop="url" content="https://juejin.cn/user/446878782598644"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [Ai Agent] 09 LangGraph 进阶：构建可控、可协作的多智能体系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446878782598644/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    再会呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:28:09.000Z" title="Sun Nov 23 2025 09:28:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>博客配套代码发布于<a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3Dgithub%26spm%3D1001.2101.3001.7020" title="https://so.csdn.net/so/search?q=github&amp;spm=1001.2101.3001.7020" target="_blank" ref="nofollow noopener noreferrer">github</a>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAnnyfee%2Fagent-craft" title="https://github.com/Annyfee/agent-craft" target="_blank" ref="nofollow noopener noreferrer">09 LangGraph 进阶</a></p>
<p><strong>本系列所有博客均配套Gihub开源代码，开箱即用，仅需配置API_KEY。</strong></p>
<p>如果该Agent教学系列帮到了你，<strong>欢迎给我个Star⭐</strong>！</p>
<p><strong>知识点</strong>：<strong>Human-in-the-Loop（人工干预）｜ Graph-as-a-Tool（图即工具）| Multi-Agent 多智能体编排</strong></p>
<hr/>
<h2 data-id="heading-0">前言：</h2>
<p>在08篇中，我们亲手用LangGraph实现了一个<strong>透明、可追踪、带记忆</strong>的ReAct。它能思考、调用工具并记住历史，看起来已足够强大。</p>
<p>但是在生产级环境，它立马会撞上三大难题：</p>
<p><strong>其一、安全失控：</strong></p>
<p>Agent可以自动删除数据、发送邮件、转账付款——没有任何确认机制，一旦出错，无可挽回。</p>
<p><strong>其二、工作流臃肿：</strong></p>
<p>为了让Agent处理复杂任务，我们在单个节点里不断堆砌逻辑：“先验证输入&gt;再查数据&gt;然后进行业务计算&gt;最后格式化输出...”</p>
<p>节点函数越来越长，流程臃肿。每次修改业务逻辑都需要重写整个函数，测试难度飙升。</p>
<p><strong>其三、职责混乱：</strong></p>
<p>所有功能都挤在一个Agent里，它既是研究员又是专家还是客服，身兼数职，更别提还要加上不断扩大的记忆。短期尚可，长期必炸。</p>
<p>所以，本篇为这三大痛点分别提供了三种对应解决的进阶能力：</p>
<p><strong>Human-in-the-Loop（人工干预）</strong> ：解决安全失控；</p>
<p><strong>Graph-as-a-tool（图即工具）</strong> ：解决工作流臃肿；</p>
<p><strong>Multi-Agent（多智能体编排）</strong> ：解决职责混乱。</p>
<p>接下来，我们用这三个能力，逐一攻克上述的问题。</p>
<h2 data-id="heading-1">一、Human-in-the-Loop：让Agent学会“请示”</h2>
<h3 data-id="heading-2">为什么需要人工干预</h3>
<p>全自动执行在demo运行中听起来很好，但在实际运行中非常<strong>极其危险</strong>。</p>
<p>比如用户说，“把项目预算邮件发给财务”，Agent自动调用send_email(to="@xx.com",content="xx")，如果内容有误，邮件一旦发出无法撤回。</p>
<p>所以我们需要一种机制：<strong>在执行高风险操作前暂停，等待人类确认</strong>。</p>
<p>Langgraph提供了完美的解决方案：<strong>interrupt_before + MemorySaver。</strong></p>
<ul>
<li><strong>MemorySaver</strong>会将图的当前状态（包括消息历史、中间变量）持久化；</li>
<li><strong>interrupt_before=["node_name"]</strong> 表示“在进入该节点前暂停执行”；</li>
<li>暂停后，程序可以检查即将执行的操作，并询问用户是否继续；</li>
<li>若用户批准，调用<strong>app.stream(None，config)</strong> 即可从断点恢复执行</li>
</ul>
<p>这相当于为Agent加了一道 <strong>“安全锁”</strong> 。</p>
<p>人为审批的思路也很简单，我们假设一个发邮件Agent：</p>
<p>当你发邮件时，该Agent会暂停并显示即将执行的操作，等待你输入yes才继续。</p>
<p>大致步骤如下：</p>
<p><strong>1. 提前确定好哪个节点需要“审批”，在这里停住：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">app</span> = workflow.compile(
    <span class="hljs-comment"># 在内存里做状态持久化</span>
    <span class="hljs-attr">checkpointer</span>=MemorySaver(),
    <span class="hljs-attr">interrupt_before</span>=[<span class="hljs-string">"tools"</span>] <span class="hljs-comment"># 选择要人工审批的节点 -- 负责在哪里停，之后的代码负责停了之后怎么办</span>
)
</code></pre>
<p><strong>2. 触发执行，并自动暂停</strong></p>
<p>注：此处用stream流式，是利用流式API的中断机制，使其能够精准在特定节点前暂停。</p>
<pre><code class="hljs language-ini" lang="ini">    while 1:
        <span class="hljs-comment"># 触发工作流执行，推进到下一个中断点或自然结束</span>
        for _ in app.stream(inputs,config,<span class="hljs-attr">stream_mode</span>=<span class="hljs-string">"values"</span>): <span class="hljs-comment"># 流式执行</span>
        <span class="hljs-comment"># inputs注入事件;config确定回话id;"values":完整记录每步结果</span>
            pass   <span class="hljs-comment"># 必须迭代生成器，才能实际执行工作流</span>
</code></pre>
<p><strong>3. 获取暂停节点的状态：</strong></p>
<pre><code class="hljs language-ini" lang="ini">        <span class="hljs-comment"># 获取当前状态</span>
        <span class="hljs-attr">snapshot</span> = app.get_state(config)
        <span class="hljs-attr">next_tasks</span> = snapshot.next <span class="hljs-comment"># 返回下一步要执行的节点名列表</span>
</code></pre>
<p><strong>4. 如果没有下一步，说明工作流已结束：</strong></p>
<pre><code class="hljs language-python" lang="python">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> next_tasks:
            final_msg = snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n最终回复:<span class="hljs-subst">{final_msg.content}</span>'</span>)
            <span class="hljs-keyword">break</span>
</code></pre>
<p><strong>5. 如果下一步是需要审批的节点，进行审批：</strong></p>
<pre><code class="hljs language-python" lang="python">        <span class="hljs-keyword">if</span> <span class="hljs-string">"tools"</span> <span class="hljs-keyword">in</span> next_tasks:
            last_msg = snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
            tool_call = last_msg.tool_calls[<span class="hljs-number">0</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n⚠️ Agent准备执行操作：'</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'    工具名称：<span class="hljs-subst">{tool_call[<span class="hljs-string">"name"</span>]}</span>'</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'    参数：<span class="hljs-subst">{tool_call[<span class="hljs-string">"args"</span>]}</span>'</span>)

            approval = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\n✅ 是否批准执行？(输入 'yes' 继续，其他取消): "</span>).strip().lower()
            <span class="hljs-keyword">if</span> approval == <span class="hljs-string">"yes"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'\n 继续执行...'</span>)
                inputs = <span class="hljs-literal">None</span> <span class="hljs-comment"># 表示从断点继续，无新输入</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n❌ 操作已取消，流程终止"</span>)
                <span class="hljs-keyword">break</span>
</code></pre>
<p>完整代码如下:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> OPENAI_API_KEY,LANGCHAIN_API_KEY
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, MessagesState, START, END
<span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> ToolNode
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver

<span class="hljs-comment"># langsmith调试</span>
os.environ[<span class="hljs-string">"LANGCHAIN_TRACING_V2"</span>] = <span class="hljs-string">"true"</span> <span class="hljs-comment"># 总开关，决定启用追踪功能</span>
os.environ[<span class="hljs-string">"LANGCHAIN_PROJECT"</span>] = <span class="hljs-string">"human_approval"</span> <span class="hljs-comment"># 自定义项目名</span>
os.environ[<span class="hljs-string">"LANGCHAIN_API_KEY"</span>] = LANGCHAIN_API_KEY

<span class="hljs-comment"># llm配置</span>
llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    api_key=OPENAI_API_KEY,
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>
)

<span class="hljs-comment"># 定义一个敏感工具：发送邮件(模拟)</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_email</span>(<span class="hljs-params">to, content</span>):
    <span class="hljs-string">"""模拟发送邮件"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f'邮件已发送至<span class="hljs-subst">{to}</span>,内容为：<span class="hljs-subst">{content}</span>'</span>


<span class="hljs-comment"># 工具绑定到llm</span>
tools = [send_email]
llm_with_tools = llm.bind_tools(tools)

<span class="hljs-comment"># Node函数与Edge节点</span>
tool_node = ToolNode(tools)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_model</span>(<span class="hljs-params">state: MessagesState</span>):
    response = llm_with_tools.invoke(state[<span class="hljs-string">'messages'</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>:[response]}


<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state: MessagesState</span>):
    last_msg = state[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg, <span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-keyword">return</span> END


<span class="hljs-comment"># 构建基础ReAct图</span>
workflow = StateGraph(MessagesState)

workflow.add_node(<span class="hljs-string">"agent"</span>, call_model)
workflow.add_node(<span class="hljs-string">"tools"</span>, tool_node)
workflow.add_edge(START, <span class="hljs-string">"agent"</span>)

workflow.add_conditional_edges(
    <span class="hljs-string">"agent"</span>,
    should_continue,
    {
        <span class="hljs-string">"tools"</span>: <span class="hljs-string">"tools"</span>,
        END: END
    }
)

workflow.add_edge(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"agent"</span>)

app = workflow.<span class="hljs-built_in">compile</span>(
    checkpointer=MemorySaver(),
    interrupt_before=[<span class="hljs-string">"tools"</span>] <span class="hljs-comment"># 选择要人工审批的节点 -- 负责在哪里停，之后的代码负责停了之后怎么办</span>
)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    config = {
        <span class="hljs-string">"configurable"</span>:{<span class="hljs-string">"thread_id"</span>:<span class="hljs-string">"user123"</span>}
    }
    user_input = <span class="hljs-string">"请帮我给 boss@example.com 发一封邮件，内容是：会议推迟到明天下午3点。"</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户输入:"</span>,user_input)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nAgent正在思考...\n"</span>)

    <span class="hljs-comment"># 初识输入</span>
    inputs = {<span class="hljs-string">"messages"</span>:[HumanMessage(content=user_input)]}

    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
        <span class="hljs-comment"># 触发工作流执行，推进到下一个中断点或自然结束</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> app.stream(inputs,config,stream_mode=<span class="hljs-string">"values"</span>): <span class="hljs-comment"># 流式执行</span>
            <span class="hljs-keyword">pass</span>   <span class="hljs-comment"># 必须迭代生成器，才能实际执行工作流</span>

        <span class="hljs-comment"># 获取当前状态</span>
        snapshot = app.get_state(config)
        next_tasks = snapshot.<span class="hljs-built_in">next</span> <span class="hljs-comment"># 返回下一步要执行的节点名列表</span>

        <span class="hljs-comment"># 如果没有下一步，说明工作流已结束</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> next_tasks:
            final_msg = snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n最终回复:<span class="hljs-subst">{final_msg.content}</span>'</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># 如果下一步是需要审批的节点</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"tools"</span> <span class="hljs-keyword">in</span> next_tasks:
            last_msg = snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
            tool_call = last_msg.tool_calls[<span class="hljs-number">0</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n⚠️ Agent准备执行操作：'</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'    工具名称：<span class="hljs-subst">{tool_call[<span class="hljs-string">"name"</span>]}</span>'</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'    参数：<span class="hljs-subst">{tool_call[<span class="hljs-string">"args"</span>]}</span>'</span>)

            approval = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\n✅ 是否批准执行？(输入 'yes' 继续，其他取消): "</span>).strip().lower()
            <span class="hljs-keyword">if</span> approval == <span class="hljs-string">"yes"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'\n 继续执行...'</span>)
                inputs = <span class="hljs-literal">None</span> <span class="hljs-comment"># 表示从断点继续，无新输入</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n❌ 操作已取消，流程终止"</span>)
                <span class="hljs-keyword">break</span>
</code></pre>
<p>测试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94400e2d4baa4d6d8dde3f72eb583c02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=APMjehxTKg4h8Vy9gWDCsF2jVKw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fp0-xtjj-private.juejin.cn%2Ftos-cn-i-73owjymdk6%2Fd88b72506ee74a88a0247d9ffde7df6a~tplv-73owjymdk6-jj-mark-v1%3A0%3A0%3A0%3A0%3A5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA%3Aq75.awebp%3Fpolicy%3DeyJ2bSI6MywidWlkIjoiNDQ2ODc4NzgyNTk4NjQ0In0%253D%26rk3s%3De9ecf3d6%26x-orig-authkey%3Df32326d3454f2ac7e96d3d06cdbb035152127018%26x-orig-expires%3D1763976315%26x-orig-sign%3DuTg%252B3eWifqZC9AM%252FsazNdzp58lE%253D" target="_blank" title="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/d88b72506ee74a88a0247d9ffde7df6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiNDQ2ODc4NzgyNTk4NjQ0In0%3D&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1763976315&amp;x-orig-sign=uTg%2B3eWifqZC9AM%2FsazNdzp58lE%3D" ref="nofollow noopener noreferrer"/></p>
<p>如果我们把其中的user_input改为boss，不写明邮箱号，再测试一遍：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf36a993059f4565a5a531f8e40da4e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=DW5vkG1ycbZK51rCevoOJn9ZdNk%3D" alt="" loading="lazy"/></p>
<p>此时没有调用发邮件工具，自然也不会需要人工确认了。</p>
<h2 data-id="heading-3">二、Graph-as-a-Tool：把复杂流程封装成“黑盒工具”</h2>
<h3 data-id="heading-4"><strong>为什么需要这种封装？</strong></h3>
<p>回想我们之前的 RAG 实现：一个完整的检索增强生成流程，通常包含<strong>多个步骤</strong>——文档加载与分块、文本向量化、存入向量数据库、执行检索、上下文增强、最终生成答案。这些操作本身已足够繁琐。</p>
<p>如果直接把这些逻辑塞进一个普通函数，并作为 LangChain Tool 注册给 LangGraph 使用，虽然技术上可行，但会带来<strong>明显问题</strong>：  </p>
<ul>
<li><strong>耦合度高</strong>：所有逻辑挤在一起，难以单独测试或替换某一步；</li>
<li><strong>可读性差</strong>：主图节点变成“大泥球”，失去流程清晰性；</li>
<li><strong>扩展困难</strong>：一旦需求变化（比如加入重排、多跳查询、结果校验），代码迅速膨胀，if-else 嵌套失控。</li>
</ul>
<p>更关键的是——<strong>真实世界的智能任务往往不是线性的</strong>。<br/>
例如，RAG 可能需要根据检索质量决定是否重新生成查询、是否引入外部知识、甚至请求人工确认。这类带<strong>状态转移、条件分支、循环反馈</strong>的逻辑，用传统函数难以优雅表达。</p>
<p>这时，<strong>Graph-as-a-Tool</strong> 的价值就凸显出来了。</p>
<p>它允许我们将某个复杂子任务（如 RAG）<strong>自身建模为一个独立的工作流图（sub-graph）</strong> ，再将整个图封装成一个对外透明的 Tool。对主 Graph 而言，它只是一个<strong>语义明确的黑盒接口</strong>；而内部，却是一个结构清晰、节点分明、支持中断恢复的<strong>完整流程</strong>。</p>
<blockquote>
<p>这正是现代智能体架构的核心理念：<strong>分层抽象，嵌套编排</strong>。<br/>
主图负责“决策做什么”，子图（作为 Tool）负责“如何做”。<br/>
而只有“图”这种结构，才能优雅地表达这种<strong>分层、嵌套、带反馈的复杂工作流</strong>。</p>
</blockquote>
<p>假设我们要做一个<strong>可以自动重试的API服务调用</strong>。该服务调用作为一个工具给主工作流。而它自身则是由一个子图构成，里面涵盖了一个完整的子工作流。</p>
<p>主要代码构建如下：（完整部分github中已提供）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ...相关配置</span>
<span class="hljs-comment"># 构建子工作流</span>
<span class="hljs-comment"># 1.子任务状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    query: <span class="hljs-built_in">str</span>
    attempt: <span class="hljs-built_in">int</span>
    result: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 2.子图逻辑 -- 模拟一个可能失败，需重试的API调用</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_unstable_api</span>(<span class="hljs-params">state:RetryState</span>):
    <span class="hljs-string">"""模拟偶发性的外部服务，偶发失败"""</span>
    attempt = state[<span class="hljs-string">"attempt"</span>]
    <span class="hljs-keyword">if</span> attempt == <span class="hljs-number">1</span>:
        <span class="hljs-comment"># 第一次故意失败</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"result"</span>:<span class="hljs-string">"ERROR：服务暂时不可用"</span>,<span class="hljs-string">"attempt"</span>:attempt+<span class="hljs-number">1</span>}
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 第二次成功</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"result"</span>:<span class="hljs-string">f"SUCCESS：成功处理请求：<span class="hljs-subst">{state[<span class="hljs-string">'query'</span>]}</span>"</span>,<span class="hljs-string">"attempt"</span>:attempt+<span class="hljs-number">1</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_retry</span>(<span class="hljs-params">state:RetryState</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-string">"ERROR"</span> <span class="hljs-keyword">in</span> state[<span class="hljs-string">"result"</span>] <span class="hljs-keyword">and</span> state[<span class="hljs-string">"attempt"</span>] &lt;= <span class="hljs-number">2</span>: <span class="hljs-comment"># 出现报错且重试次数小于2，重连</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"call_api"</span>
    <span class="hljs-keyword">return</span> END

<span class="hljs-comment"># 3.构建子图工作流</span>
retry_workflow = StateGraph(RetryState)
retry_workflow.add_node(<span class="hljs-string">"call_api"</span>,call_unstable_api)
retry_workflow.add_edge(START,<span class="hljs-string">"call_api"</span>)
retry_workflow.add_conditional_edges(
    <span class="hljs-string">"call_api"</span>,
    should_retry,
    {<span class="hljs-string">"call_api"</span>:<span class="hljs-string">"call_api"</span>,END:END}
)
retry_app = retry_workflow.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># 4.封装为tool(Graph-as-a-Tool)</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">query:<span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""创建新订单，自动重试保障成功率"""</span>
    result = retry_app.invoke({<span class="hljs-string">"query"</span>:query,<span class="hljs-string">"attempt"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:<span class="hljs-string">""</span>})
    <span class="hljs-keyword">return</span> result[<span class="hljs-string">"result"</span>]


<span class="hljs-comment"># 5.主graph</span>
tools = [create_order]
llm_with_tools = llm.bind_tools(tools)
tool_node = ToolNode(tools)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_node</span>(<span class="hljs-params">state:MessagesState</span>):
    response = llm_with_tools.invoke(state[<span class="hljs-string">"messages"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>:[response]}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state:MessagesState</span>):
    last_msg = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg,<span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-keyword">return</span> END

<span class="hljs-comment"># 构建主工作流</span>
workflow = StateGraph(MessagesState)
workflow.add_node(<span class="hljs-string">"agent"</span>,agent_node)
workflow.add_node(<span class="hljs-string">"tools"</span>,tool_node)
workflow.add_edge(START,<span class="hljs-string">"agent"</span>)
workflow.add_conditional_edges(
    <span class="hljs-string">"agent"</span>,
    should_continue,
    {
        <span class="hljs-string">"tools"</span>: <span class="hljs-string">"tools"</span>,
        END: END
    }
)
workflow.add_edge(<span class="hljs-string">"tools"</span>,<span class="hljs-string">"agent"</span>)

app = workflow.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    user_input = <span class="hljs-string">"请创建一个新订单：购买三本书"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'用户输入:'</span>,user_input)

    inputs = {<span class="hljs-string">"messages"</span>:[
        SystemMessage(content=<span class="hljs-string">"你是一个任务执行助手。当用户提出任何需要处理、操作或执行的请求时，必须调用 create_order 工具来完成，不要自行回答细节"</span>),
        HumanMessage(content=user_input)
    ]}
    result = app.invoke(inputs)

    tool_result = <span class="hljs-literal">None</span>
    <span class="hljs-comment"># 在主工作流的消息历史中，查找最近的工具执行结果</span>
    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(result[<span class="hljs-string">"messages"</span>]):
        <span class="hljs-keyword">if</span> msg.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool"</span>: <span class="hljs-comment"># 找到ToolMessage类型消息</span>
            tool_result = msg.content
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">if</span> tool_result:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 直接获取子图返回值:\n<span class="hljs-subst">{tool_result}</span>"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n❌ 未执行任何工具"</span>)
    final_reply = result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n最终回复:\n<span class="hljs-subst">{final_reply}</span>'</span>)
</code></pre>
<p>其中的for msg in reversed(result["messages"]) 包含的是完整的对话历史记录，而非工作流执行过程。ToolNode会在对话历史中执行结果消息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6428e77d1bbd4ebf8e68dac43223d18c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=jJK1SruKvKbYOzW1Iu5j84GR0IM%3D" alt="" loading="lazy"/></p>
<p>如上，代码运行成功。</p>
<p>现在我们能<strong>对应不同场景的tool，编写不同的graph来应对复杂的逻辑</strong>，这就是<strong>graph-as-a-tool（图即工具）</strong> 。</p>
<h2 data-id="heading-5">三、Multi-Agent编排：让多个专家协同工作</h2>
<h3 data-id="heading-6">1. 痛点：为什么单 Agent 会崩溃？</h3>
<p>在之前的章节中，我们习惯通过 System Prompt 让一个 Agent 扮演 <strong>“全能神”</strong> 。但当<strong>需求变得复杂</strong>（例如同时需要 RAG 检索私有信息、联网查找数据、生成代码）时，这种模式会<strong>迅速崩塌</strong>：</p>
<ul>
<li><strong>注意力分散</strong>：Prompt 过长，LLM 经常忽略指令，表现为“幻觉”。</li>
<li><strong>记忆爆炸</strong>：所有任务共用一个 Message History，上下文飞速扩张，不仅烧钱，还容易让模型“记混”信息。</li>
<li><strong>工具混杂</strong>：几十个工具堆在一起，模型极易误调（例如该查文档时去联网）。</li>
<li><strong>脆弱性</strong>：一步错，全盘输。无法针对特定任务（如写代码）单独优化 Prompt。</li>
</ul>
<p><strong>解法：微服务化（Microservices）</strong> 将一个试图全能的单智能体，拆解为多个<strong>专注、自治、可组合</strong>的子智能体，并通过编排协调完成复杂任务。</p>
<ul>
<li>让 <strong>RAG 专家</strong>只负责查私有知识。</li>
<li>让 <strong>Web 搜索员</strong>只负责查公开信息。</li>
<li>让 <strong>代码生成器</strong>只写 Python。</li>
</ul>
<p>而这一切，都需要一个**总控（Supervisor）**来调度。</p>
<h3 data-id="heading-7">2. 初始化：工具配置与核心状态定义</h3>
<p>首先，我们需要定义工具和状态。这里的核心技术点在于<strong>状态（State）的设计</strong>。</p>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_internal_docs</span>(<span class="hljs-params">query:<span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""搜索公司内部文档获取政策信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"根据公司手册，年假为15天"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">query:<span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""通过搜索引擎获取最新的公开信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"据TechCrunch报道，LangGraph 0.6已支持持久化记忆"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_code</span>(<span class="hljs-params">requirement:<span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""根据需求生成可运行的Python代码"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"python\nprint('Hello from Code writer!')"</span>


<span class="hljs-comment"># 共享状态定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>,add_messages] <span class="hljs-comment"># 自动累积对话历史</span>
    next_speaker: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-8"><strong>深度解读：为什么不用预置的 MessagesState？</strong></h4>
<p>LangGraph 提供了一个<strong>预置类MessagesState</strong>，但它只有一个 messages 字段。在多智能体编排中，我们需要额外的字段 next_speaker 来存储 Supervisor 的决策结果，因此<strong>必须自定义 TypedDict</strong> 。</p>
<p>关于<strong>Annotated[list, add_messages]</strong> ：</p>
<ul>
<li><strong>Annotated 的作用</strong>：在这里它不仅仅是类型提示，它会被 LangGraph 框架读取。</li>
<li><strong>add_messages 的机制</strong>：它的作用是告诉框架，当节点返回新的 messages 时，不要直接覆盖旧列表，而是<strong>追加（Append）</strong> 。这是实现<strong>自动累积对话历史</strong>的关键。</li>
</ul>
<h3 data-id="heading-9">3. 定义节点：专家与总控</h3>
<p>这一步我们需要明确 <strong>“大脑”</strong> 与 <strong>“手脚”</strong> 的分工。</p>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 专家节点</span>
def rag_expert(state:AgentState):
    <span class="hljs-attr">prompt</span> = <span class="hljs-string">"你是公司知识库专家，只基于内部文档回答问题。回答应简洁明了，直接给出最终结论。请在回答的最后一行加上：(任务已完成)"</span>
    <span class="hljs-attr">messages</span> = [SystemMessage(content=prompt)]+state[<span class="hljs-string">'messages'</span>]
    <span class="hljs-attr">tools</span> = [search_internal_docs]
    <span class="hljs-attr">response</span> = llm.bind_tools(tools).invoke(messages)
    return {'messages':<span class="hljs-section">[response]</span>}

def web_research(state:AgentState):
    <span class="hljs-attr">prompt</span> = <span class="hljs-string">"你是互联网研究员，擅长用搜索引擎获取最新公开信息。回答应简洁明了，直接给出最终结论。请在回答的最后一行加上：(任务已完成)"</span>
    <span class="hljs-attr">messages</span> = [SystemMessage(content=prompt)]+state[<span class="hljs-string">'messages'</span>]
    <span class="hljs-attr">tools</span> = [search_web]
    <span class="hljs-attr">response</span> = llm.bind_tools(tools).invoke(messages)
    return {'messages':<span class="hljs-section">[response]</span>}

def code_writer(state:AgentState):
    <span class="hljs-attr">prompt</span> = <span class="hljs-string">"你是python工程师，只生成可运行代码，不解释。回答应简洁明了，直接给出最终结论。请在回答的最后一行加上：(任务已完成)"</span>
    <span class="hljs-attr">messages</span> = [SystemMessage(content=prompt)]+state[<span class="hljs-string">'messages'</span>]
    <span class="hljs-attr">tools</span> = [generate_code]
    <span class="hljs-attr">response</span> = llm.bind_tools(tools).invoke(messages)
    return {'messages':<span class="hljs-section">[response]</span>}

<span class="hljs-comment"># 总控节点</span>
def supervisor(state:AgentState):
    <span class="hljs-attr">supervisor_prompt</span> = <span class="hljs-string">"""
        你是一个任务协调员。你的目标是管理专家来解决用户的问题。

        当前对话需要以下专家参与：
        - rag_expert：涉及公司政策、内部流程
        - web_research：涉及外部新闻、公开数据
        - code_writer：需要生成代码

        【决策逻辑】
        1. **检查历史记录**：先看上一个回复是否已经完整回答了用户的初始问题。
        2. **如果已经回答完毕**：必须输出 'FINISH'。
        3. **如果尚未回答或需要补充**：根据当前缺少的步骤，选择下一个最合适的专家。

        请只输出专家名字或 'FINISH'，不要输出任何其他解释。
        """</span>
    <span class="hljs-attr">messages</span> = [SystemMessage(content=supervisor_prompt)]+state[<span class="hljs-string">'messages'</span>]
    <span class="hljs-attr">response</span> = llm.invoke(messages)
    <span class="hljs-attr">next_speaker</span> = response.content.strip()
    return {"next_speaker":next_speaker}
</code></pre>
<p><strong>逻辑要点：</strong></p>
<ul>
<li><strong>专家节点</strong>：遵循 ReAct 模式。必须使用 bind_tools 将工具绑定给 LLM，否则模型无法触发工具调用。我们还在 Prompt 中加入了“任务已完成”的标记，辅助总控判断。</li>
<li><strong>总控节点</strong>：不执行具体任务，只负责 <strong>“看”</strong> 。它的输出直接决定了 next_speaker 的值，从而控制整个图的流向。</li>
</ul>
<h3 data-id="heading-10">4. 构建协作图：核心架构逻辑</h3>
<p>这是本章最复杂的部分。我们需要通过 StateGraph 将节点织成一张网。</p>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 路由函数定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_supervisor</span>(<span class="hljs-params">state:AgentState</span>):
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"next_speaker"</span>]==<span class="hljs-string">"FINISH"</span>:
        <span class="hljs-keyword">return</span> END
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">"next_speaker"</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state:AgentState</span>):
    last_msg = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg,<span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"supervisor"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_after_tool</span>(<span class="hljs-params">state:AgentState</span>):
    <span class="hljs-comment"># 工具执行完后，通过next_speaker知道是谁调用的，路由回去</span>
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">"next_speaker"</span>]


<span class="hljs-comment"># 添加工具节点</span>
tools = [search_internal_docs,search_web,generate_code]
tool_node = ToolNode(tools)


<span class="hljs-comment"># 构建协作图</span>
workflow = StateGraph(AgentState)

<span class="hljs-comment"># 1. 添加节点</span>
workflow.add_node(<span class="hljs-string">"supervisor"</span>,supervisor)
workflow.add_node(<span class="hljs-string">"rag_expert"</span>,rag_expert)
workflow.add_node(<span class="hljs-string">"web_research"</span>,web_research)
workflow.add_node(<span class="hljs-string">"code_writer"</span>,code_writer)
workflow.add_node(<span class="hljs-string">"tools"</span>,tool_node)


<span class="hljs-comment"># 2. 总控回路</span>
workflow.add_edge(START,<span class="hljs-string">"supervisor"</span>)
workflow.add_conditional_edges(<span class="hljs-string">"supervisor"</span>,route_supervisor)

<span class="hljs-comment"># 3. 专家节点的ReAct循环</span>
<span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> [<span class="hljs-string">"rag_expert"</span>,<span class="hljs-string">"web_research"</span>,<span class="hljs-string">"code_writer"</span>]: <span class="hljs-comment"># 为每个专家添加条件边：决定是去执行工具还是回总控</span>
    workflow.add_conditional_edges(
        member,
        should_continue,
        {<span class="hljs-string">"tools"</span>:<span class="hljs-string">"tools"</span>,<span class="hljs-string">"supervisor"</span>:<span class="hljs-string">"supervisor"</span>}
    )

<span class="hljs-comment"># 4.工具节点闭环</span>
workflow.add_conditional_edges( <span class="hljs-comment"># 工具执行完，根据next_speaker路由回原来的专家</span>
    <span class="hljs-string">"tools"</span>,
    route_after_tool
)

app = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<h4 data-id="heading-11"><strong>技术深挖：理解图构建中的三个关键点</strong></h4>
<p><strong>第一点：条件边的两种写法（动态 vs 静态）</strong></p>
<ul>
<li>
<p><strong>直接返回（动态路由）</strong> ：如 route_supervisor 。<strong>函数直接返回节点名称字符串</strong>。适用于<strong>目标节点不确定</strong>的情况（Supervisor 可能返回任何专家的名字）。</p>
<pre><code class="hljs language-perl" lang="perl">def route_supervisor(<span class="hljs-keyword">state</span>:AgentState):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">state</span>[<span class="hljs-string">"next_speaker"</span>]==<span class="hljs-string">"FINISH"</span>:
        <span class="hljs-keyword">return</span> END
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">state</span>[<span class="hljs-string">"next_speaker"</span>]

<span class="hljs-comment"># ...</span>

workflow.add_conditional_edges(<span class="hljs-string">"supervisor"</span>,route_supervisor)
</code></pre>
</li>
<li>
<p><strong>字典映射（静态结构）</strong> ：如 should_continue 。虽然函数返回的是 "tools"，但我们在 add_conditional_edges 中<strong>显式定义</strong>了 {"tools": "tools"} 的<strong>映射</strong>。这适用于<strong>结构固定</strong>的场景（三选一或二选一）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state:AgentState</span>):
    last_msg = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg,<span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"supervisor"</span>

<span class="hljs-comment"># ...</span>

<span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> [<span class="hljs-string">"rag_expert"</span>,<span class="hljs-string">"web_research"</span>,<span class="hljs-string">"code_writer"</span>]: <span class="hljs-comment"># 为每个专家添加条件边：决定是去执行工具还是回总控</span>
    workflow.add_conditional_edges(
        member,
        should_continue,
        {<span class="hljs-string">"tools"</span>:<span class="hljs-string">"tools"</span>,<span class="hljs-string">"supervisor"</span>:<span class="hljs-string">"supervisor"</span>}
    )
</code></pre>
</li>
</ul>
<p><strong>第二点：For 循环的本质（构建时 vs 运行时）</strong> 代码中的 for member in [...] 并不是让程序运行时轮流跑一遍专家。 这是<strong>构建阶段（Build Time）</strong> 的代码。它的作用是 <strong>“批量注册”</strong> ：我们告诉图，这三个专家节点，它们“出门”后的规则是一模一样的（要么去修工具，要么回总控）。这<strong>避免了重复</strong>写三遍相同的 add_conditional_edges 代码。</p>
<p><strong>第三点：add_conditional_edges 的回环特性</strong> 这一行代码相当于给节点安装了一个永久生效的 <strong>“单向任意门”</strong> 。</p>
<ul>
<li>
<p><strong>回环</strong>：一旦定义了 <strong>Expert -&gt; check -&gt; Tools</strong> ，以后无论流程第几次回到 Expert 节点，离开时都会触发这个检查。</p>
</li>
<li>
<p><strong>单向性</strong>：虽然我们在逻辑上实现了 Expert -&gt; check -&gt; Tools  的闭环，但这个闭环是由两条单向边拼凑的：</p>
<ol>
<li>Expert -&gt; Tools（通过 should_continue  定义）</li>
<li>Tools -&gt; Expert（通过 route_after_tool 定义，必须显式写出来，否则程序会卡死在 Tools 节点）。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-12">5. 测试运行</h3>
<p>最后，通过打印日志来验证多智能体的协作流。</p>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 测试运行</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    user_input = <span class="hljs-string">"公司年假多少天"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户提问:"</span>,user_input)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'\n开始多智能体协作...\n'</span>)

    inputs = {<span class="hljs-string">"messages"</span>:[HumanMessage(content=user_input)]}
    <span class="hljs-comment"># app是编译好的图，stream()会让图开始运转，并返回一个生成器</span>
    <span class="hljs-comment"># 图每执行完一个节点，就会产出一个step字典</span>
    <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> app.stream(inputs):
        <span class="hljs-comment"># 因为step是个字典，所以需要拆包拿到 节点名(Node) 与 输出内容(output)</span>
        <span class="hljs-keyword">for</span> node,output <span class="hljs-keyword">in</span> step.items():
            <span class="hljs-comment"># 有工具/专家回复</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">in</span> output:
                msg = output[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(msg,<span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> msg.tool_calls:
                    call = msg.tool_calls[<span class="hljs-number">0</span>]
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"【<span class="hljs-subst">{node}</span>】调用工具 <span class="hljs-subst">{call[<span class="hljs-string">'name'</span>]}</span>(<span class="hljs-subst">{call[<span class="hljs-string">'args'</span>]}</span>)"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"【<span class="hljs-subst">{node}</span>】回复：<span class="hljs-subst">{msg.content}</span>"</span>)
            <span class="hljs-comment"># supervisor刚做完决策，确定下个发言人</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"next_speaker"</span> <span class="hljs-keyword">in</span> output:
                speaker = output[<span class="hljs-string">"next_speaker"</span>]
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"【Supervisor】指定下一位发言人：<span class="hljs-subst">{speaker}</span>"</span>)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e4265a3b4b04e14b4570b348dbbacab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=BUH5JAHL6n66jv%2FM06zoSKG3EfI%3D" alt="" loading="lazy"/></p>
<p>通过这段日志，我们可以清晰地观测到系统的<strong>运行脉络</strong>：</p>
<blockquote>
<p>Supervisor 识别意图 -&gt; 指派 RAG 专家 -&gt; RAG 专家发现需要查库 -&gt; 调用 Tool -&gt;</p>
<p>Tool 返回结果  -&gt; RAG 专家生成最终回复 -&gt; Supervisor 确认任务完成 (FINISH)。</p>
</blockquote>
<p>其工作流大致如下图所示：</p>
<pre><code class="hljs language-scss" lang="scss">           (开始)
             |
             v
   +--&gt; <span class="hljs-selector-attr">[ 🧠 总控 Supervisor ]</span> <span class="hljs-built_in">--</span>(完成)--&gt; (( END ))
   |         |
   |         | (<span class="hljs-number">1</span>. 指派)
   |         v
   |    <span class="hljs-selector-attr">[ 👷 专家 (Workers) ]</span> &lt;====&gt; <span class="hljs-selector-attr">[ 🛠️ 工具 (Tools) ]</span>
   |         |        ^         (<span class="hljs-number">2</span>. 干活循环)
   |         |        |
   +---------+--------+
      (<span class="hljs-number">3</span>. 汇报结果)
</code></pre>
<p><strong>总结：三种能力如何组合？</strong></p>

























<table><thead><tr><th>能力</th><th>解决的问题</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Human-in-the-Loop</strong></td><td>不可逆操作的安全风险</td><td>发邮件、删数据、审批流</td></tr><tr><td><strong>Graph-as-a-Tool</strong></td><td>复杂内部逻辑的维护难题</td><td>带重试的 API 调用、多步验证</td></tr><tr><td><strong>Multi-Agent 编排</strong></td><td>单 Agent 职责爆炸</td><td>会议纪要、故障排查、需求分析</td></tr></tbody></table>
<h2 data-id="heading-13">四、综合实战</h2>
<p>在前三章中，我们分别掌握了 <strong>安全锁、 黑盒工具、 团队管理</strong>。现在，我们不再纸上谈兵，而是将这三者融为一体，构建一个<strong>生产级架构的IT运维智能体</strong>。</p>
<h3 data-id="heading-14">业务场景设定</h3>
<p>我们模拟一个服务器故障排查场景：</p>
<p><strong>总控(Supervisor)</strong> ：负责接收报警，<strong>调度专家</strong>；</p>
<p><strong>日志专家(Log Expert)</strong> ：负责分析服务器日志。它手中的工具 analyze_logs 是一个<strong>子图</strong>，包含SSH连接重试、日志提取等复杂逻辑（模拟网络不稳定的真实环境）。</p>
<p><strong>运维专家(Ops Expert)</strong> ：负责执行修复。它手中的工具 restart_services 是<strong>敏感操作</strong>，必须经过人工审批（Human-in-the-Loop）。</p>
<h3 data-id="heading-15">代码实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> OPENAI_API_KEY,LANGCHAIN_API_KEY
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage,SystemMessage
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph,MessagesState,START,END
<span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> ToolNode
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict,Annotated
<span class="hljs-keyword">from</span> langgraph.graph.message <span class="hljs-keyword">import</span> add_messages

<span class="hljs-comment"># LangSmith调试</span>
os.environ[<span class="hljs-string">"LANGCHAIN_TRACING_V2"</span>] = <span class="hljs-string">"true"</span> <span class="hljs-comment"># 总开关，决定启用追踪功能</span>
os.environ[<span class="hljs-string">"LANGCHAIN_PROJECT"</span>] = <span class="hljs-string">"supervisor_agent_ops_system"</span> <span class="hljs-comment"># 自定义项目名</span>
os.environ[<span class="hljs-string">"LANGCHAIN_API_KEY"</span>] = LANGCHAIN_API_KEY

llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    api_key=OPENAI_API_KEY,
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>
)

<span class="hljs-comment"># === 一、Graph-as-a-Tool ===</span>
<span class="hljs-comment"># === 模拟一个不稳定的SSH日志查询过程 ===</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SSHState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    target_ip: <span class="hljs-built_in">str</span>
    attempt: <span class="hljs-built_in">int</span>
    logs: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_ssh</span>(<span class="hljs-params">state:SSHState</span>):
    <span class="hljs-string">"""模拟SSH连接，第一次连接必定超时"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'    [子图]正在尝试连接服务器<span class="hljs-subst">{state[<span class="hljs-string">"target_ip"</span>]}</span>(第<span class="hljs-subst">{state[<span class="hljs-string">"attempt"</span>]}</span>次)'</span>)
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">'attempt'</span>] == <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'logs'</span>:<span class="hljs-string">'ERROR:Connection Timed Out'</span>,<span class="hljs-string">'attempt'</span>:state[<span class="hljs-string">'attempt'</span>]+<span class="hljs-number">1</span>}
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'logs'</span>:<span class="hljs-string">'CONNECTED'</span>,<span class="hljs-string">'attempt'</span>:state[<span class="hljs-string">'attempt'</span>]+<span class="hljs-number">1</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">grep_system_logs</span>(<span class="hljs-params">state:SSHState</span>):
    <span class="hljs-string">"""连接成功后读取日志"""</span>
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"logs"</span>] == <span class="hljs-string">"CONNECTED"</span>:
        <span class="hljs-comment"># 打印查到的结果</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'logs'</span>:<span class="hljs-string">f'SUCCESS: Retrieved logs from <span class="hljs-subst">{state[<span class="hljs-string">'target_ip'</span>]}</span>:[ERROR: OutOfMemory at line 4032]'</span>}
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'logs'</span>:state[<span class="hljs-string">'logs'</span>]} <span class="hljs-comment"># 保持错误状态</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">ssh_routing</span>(<span class="hljs-params">state:SSHState</span>):
    <span class="hljs-string">"""路由逻辑：如果连接失败且尝试次数少于3，重试"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"ERROR"</span> <span class="hljs-keyword">in</span> state[<span class="hljs-string">'logs'</span>] <span class="hljs-keyword">and</span> state[<span class="hljs-string">"attempt"</span>] &lt;= <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"connect"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"grep"</span>

<span class="hljs-comment"># 构建子图</span>
ssh_workflow = StateGraph(SSHState)
ssh_workflow.add_node(<span class="hljs-string">"connect"</span>,connect_ssh)
ssh_workflow.add_node(<span class="hljs-string">"grep"</span>,grep_system_logs)

ssh_workflow.add_edge(START,<span class="hljs-string">"connect"</span>)
ssh_workflow.add_conditional_edges(<span class="hljs-string">"connect"</span>,ssh_routing,{<span class="hljs-string">"connect"</span>:<span class="hljs-string">"connect"</span>,<span class="hljs-string">"grep"</span>:<span class="hljs-string">"grep"</span>})
ssh_workflow.add_edge(<span class="hljs-string">"grep"</span>,END)

ssh_app = ssh_workflow.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># 将子图封装为工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_server_logs</span>(<span class="hljs-params">ip_address:<span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""使用SSH连接服务器并分析最近的错误日志（内含自动重连机制）"""</span>
    result = ssh_app.invoke({<span class="hljs-string">"target_ip"</span>:ip_address,<span class="hljs-string">"attempt"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"log"</span>:<span class="hljs-string">""</span>})
    <span class="hljs-keyword">return</span> result[<span class="hljs-string">'logs'</span>]



<span class="hljs-comment"># === 二、Human-in-the-Loop ===</span>
<span class="hljs-comment"># === 重启服务，高危操作，需要审批 ===</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">restart_service</span>(<span class="hljs-params">service_name:<span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""重启指定的服务器服务"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"服务[<span class="hljs-subst">{service_name}</span>]已成功重启，系统负载已恢复正常"</span>



<span class="hljs-comment"># === 三、Multi-Agent 编排 ===</span>
<span class="hljs-comment"># === 总控调度 + 专家分工 ===</span>

<span class="hljs-comment"># 1. 共享状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages:Annotated[<span class="hljs-built_in">list</span>,add_messages]
    next_speaker:<span class="hljs-built_in">str</span>

<span class="hljs-comment"># 2. 专家节点</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_expert</span>(<span class="hljs-params">state:AgentState</span>):
    prompt = <span class="hljs-string">"你是日志分析专家，使用工具分析服务器日志，找出报错原因。回答需简洁。"</span>
    messages = [SystemMessage(content=prompt)] + state[<span class="hljs-string">'messages'</span>]
    <span class="hljs-comment"># 绑定子图工具</span>
    tools = [analyze_server_logs]
    response = llm.bind_tools(tools).invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>:[response]}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">ops_expert</span>(<span class="hljs-params">state:AgentState</span>):
    prompt = <span class="hljs-string">"你是运维专家。当收到修复指令时，请立即调用 'restart_service' 工具进行修复，不要输出任何额外的解释文本。"</span>
    messages = [SystemMessage(content=prompt)] + state[<span class="hljs-string">'messages'</span>]
    tools = [restart_service]
    <span class="hljs-comment"># 绑定敏感工具</span>
    response = llm.bind_tools(tools).invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>:[response]}

<span class="hljs-comment"># 3. 总控节点（supervisor）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">supervisor</span>(<span class="hljs-params">state:AgentState</span>):
    prompt = <span class="hljs-string">"""
    你是 IT 运维总指挥。
    专家列表：
    - log_expert
    - ops_expert

    决策逻辑：
    1. 未知原因 -&gt; log_expert
    2. 已知原因（如OOM、报错） -&gt; ops_expert
    3. 修复完成 -&gt; FINISH

    【输出约束】
    仅输出下一个专家的名字（如 log_expert），不要包含任何其他字符或标点。
    """</span>
    messages = [SystemMessage(content=prompt)] + state[<span class="hljs-string">'messages'</span>]
    response = llm.invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"next_speaker"</span>:response.content.strip()}

<span class="hljs-comment"># 4. 路由逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_supervisor</span>(<span class="hljs-params">state:AgentState</span>):
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">'next_speaker'</span>] == <span class="hljs-string">"FINISH"</span>:
        <span class="hljs-keyword">return</span> END
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">'next_speaker'</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state:AgentState</span>):
    last_msg = state[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg,<span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"supervisor"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_after_tool</span>(<span class="hljs-params">state:AgentState</span>):
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">"next_speaker"</span>]


<span class="hljs-comment"># === 四、构建主图与集成 ===</span>

<span class="hljs-comment"># 工具集合</span>
all_tools = [analyze_server_logs,restart_service]
tool_node = ToolNode(all_tools)

<span class="hljs-comment"># 构建主图</span>
workflow = StateGraph(AgentState)

workflow.add_node(<span class="hljs-string">"supervisor"</span>,supervisor)
workflow.add_node(<span class="hljs-string">"log_expert"</span>,log_expert)
workflow.add_node(<span class="hljs-string">"ops_expert"</span>,ops_expert)
workflow.add_node(<span class="hljs-string">"tools"</span>,tool_node)

workflow.add_edge(START,<span class="hljs-string">"supervisor"</span>)
workflow.add_conditional_edges(<span class="hljs-string">"supervisor"</span>,route_supervisor)
<span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> [<span class="hljs-string">"log_expert"</span>,<span class="hljs-string">"ops_expert"</span>]:
    workflow.add_conditional_edges(
        member,
        should_continue,
        {<span class="hljs-string">"tools"</span>:<span class="hljs-string">"tools"</span>,<span class="hljs-string">"supervisor"</span>:<span class="hljs-string">"supervisor"</span>}
    )
workflow.add_conditional_edges(<span class="hljs-string">"tools"</span>,route_after_tool)

<span class="hljs-comment"># 编译图:加入记忆与中断机制(Human-in-the-Loop)</span>
<span class="hljs-comment"># 注: 我们在所有工具执行前都暂停，但在运行时进行逻辑判断</span>
app = workflow.<span class="hljs-built_in">compile</span>(
    checkpointer=MemorySaver(),
    interrupt_before=[<span class="hljs-string">"tools"</span>]
)

<span class="hljs-comment"># === 五、运行时逻辑(模拟生产环境的交互) ===</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 模拟一次完整的故障处理流程</span>
    user_input = <span class="hljs-string">"服务器 192.168.1.100 报警，响应极慢，请处理。"</span>
    config = {
        <span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"incident_001"</span>}
    }

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'收到报警 : <span class="hljs-subst">{user_input}</span>'</span>)
    inputs = {<span class="hljs-string">"messages"</span>:[HumanMessage(content=user_input)]}

    <span class="hljs-comment"># 循环执行，直到任务结束</span>
    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
        <span class="hljs-comment"># 1. 执行图直到中断或结束</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> app.stream(inputs,config,stream_mode=<span class="hljs-string">"values"</span>):
            <span class="hljs-keyword">pass</span>

        <span class="hljs-comment"># 2. 检查当前状态</span>
        snapshot = app.get_state(config)
        next_tasks = snapshot.<span class="hljs-built_in">next</span>

        <span class="hljs-comment"># 没有下一步，任务结束</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> next_tasks:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    最终报告:<span class="hljs-subst">{snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># 3. 处理中断:判断是哪个工具被调用</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"tools"</span> <span class="hljs-keyword">in</span> next_tasks:
            last_msg = snapshot.values[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
            tool_call = last_msg.tool_calls[<span class="hljs-number">0</span>]
            tool_name = tool_call[<span class="hljs-string">"name"</span>]

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n[系统暂停] 请求调用工具:<span class="hljs-subst">{tool_name}</span>'</span>)

            <span class="hljs-comment"># 策略A: 自动放行安全工具(Graph-as-a-Tool)</span>
            <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"analyze_server_logs"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'     -&gt; 这是一个查询类工具，系统自行批准。'</span>)
                inputs = <span class="hljs-literal">None</span> <span class="hljs-comment"># 继续执行</span>
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># 策略B: 拦截高危工具(Human-in-the-Loop)</span>
            <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"restart_service"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"     -&gt; ⚠️ 警告: 这是一个高危操作!"</span>)
                user_approval = <span class="hljs-built_in">input</span>(<span class="hljs-string">"     -&gt; 请人工审批 (输入 'yes' 允许重启):"</span>)

                <span class="hljs-keyword">if</span> user_approval == <span class="hljs-string">"yes"</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">'    -&gt; ✅ 审批通过，正在执行...'</span>)
                    inputs = <span class="hljs-literal">None</span> <span class="hljs-comment"># 继续执行</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">'    -&gt; ❌️ 审批拒绝，任务终止!'</span>)
                    <span class="hljs-comment"># 实际系统中，应通过 ToolMessage 反馈人工拒绝，使 LLM 能继续响应；</span>
                    <span class="hljs-comment"># 当前demo为简化，直接退出</span>
                    <span class="hljs-keyword">break</span>
</code></pre>
<h3 data-id="heading-16">运行效果</h3>
<p>当你运行这段代码时，你会看到一个非常精彩的<strong>交互过程</strong>：</p>
<ol>
<li>
<p>总控调度：Supervisor收到报警，首先指派log_expert。</p>
</li>
<li>
<p>子图自动重试:</p>
</li>
</ol>
<ul>
<li>log_expert 调用 analyze_server_logs；</li>
<li>系统识别这是安全工具，自动批准；</li>
<li>控制台打印出子图内部逻辑：第一次连接超时 -&gt; 自动重试 -&gt; 连接成功 -&gt; 获取到 OutOfMemory 错误</li>
</ul>
<ol start="3">
<li>二次调度：</li>
</ol>
<ul>
<li>log_expert 汇报：“发现了 OOM 错误”</li>
<li>Supervisor 决策：“这是内存溢出，需要重启，指派ops_expert。”</li>
</ul>
<ol start="4">
<li>人工拦截</li>
</ol>
<ul>
<li>ops_expert 试图调用 restart_services。</li>
<li>系统识别这是高危工具，强制暂停。</li>
<li>控制台提示：⚠️ 警告: 这是一个高危操作!</li>
</ul>
<ol start="5">
<li>最终修复：</li>
</ol>
<ul>
<li>输入yes</li>
<li>服务重启成功，Supervisor 输出 FINISH。</li>
</ul>
<h2 data-id="heading-17"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444f8dac2f934354a28c1c7b63285d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=tgqknT2Ww6bEix33D0ErM14qbRA%3D" alt="" loading="lazy"/></h2>
<p>通过LangSmith看一下详细输出：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/190f5e36d0164a9b985b2bee19d62887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5Lya5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764494889&amp;x-signature=06KJQL%2BryeOHhTnhNuROf7HPXfU%3D" alt="" loading="lazy"/>流程运行完美。</p>
<h2 data-id="heading-18">总结、</h2>
<p><strong>知识点概括</strong>：<strong>Human-in-the-Loop（人工干预）｜ Graph-as-a-Tool（图即工具）| Multi-Agent 多智能体编排</strong></p>
<p>通过这个实战案例，我们证明了 LangGraph 不仅仅是一个简单的 DAG （有向无环图——有方向但不能形成循环），它是一套<strong>构筑复杂系统的骨架</strong>。</p>
<p><strong>Graph-as-a-Tool：</strong> 让我们能把脏活累活藏起来，主流程保持干净。</p>
<p><strong>Human-in-the-Loop：</strong> 让我们敢于把Agent放入生产环境，让人工确认作为最终防线。</p>
<p><strong>Multi-Agent：</strong> 让系统具备了可扩展性，加功能只是加个专家节点而已。</p>
<p>三者结合，即可构建企业级可信 Agent 系统。</p>
<hr/>
<p>预告：<strong>10 篇 《 MCP 基础篇》</strong></p>
<p>09 篇的所有专家都运行在同一Python进程中。但如果：</p>
<ul>
<li>RAG 服务部署在公司内网？</li>
<li>代码生成器是 Java 写的 REST API？</li>
<li>你想直接调用高德地图、12306的官方服务？</li>
</ul>
<p>10篇，我们将引入MCP <strong>（Model Context Protocol）协议，</strong></p>
<p><strong>让任何符合标准的远程服务，都能成为你的工具——无需写一行@tool！</strong></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 开发环境与包管理]]></title>    <link>https://juejin.cn/post/7575119254313992218</link>    <guid>https://juejin.cn/post/7575119254313992218</guid>    <pubDate>2025-11-23T10:08:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575119254313992218" data-draft-id="7575133880436457523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 开发环境与包管理"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-23T10:08:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cadecode"/> <meta itemprop="url" content="https://juejin.cn/user/562546315637662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 开发环境与包管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/562546315637662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cadecode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:08:55.000Z" title="Sun Nov 23 2025 10:08:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python 的安装</h2>
<h3 data-id="heading-1">Windows</h3>
<p>下载安装包，推荐使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fpython%2F3.13.9%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/python/3.13.9/" ref="nofollow noopener noreferrer">清华开源软件镜像站</a>下载</p>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e87bcf93c07f4f4eb7bf7a97026c467f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FkZWNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497335&amp;x-signature=4ZNvqdXEE1mgLhwMqL0y9rnFfZA%3D" alt="image" loading="lazy"/>​</p>
<p>以 python-3.13.9-amd64.exe 为例，Python 版本 3.13.9</p>
<p>安装 tips：</p>
<ul>
<li>勾选最下面 “Add Python 3.x to PATH” 将 Python 配置到环境变量（用户机环境变量）</li>
</ul>

<ul>
<li>然点 “Customize installation”，建议全勾</li>
<li>安装路径选择自己日常存放开发环境 SDK 的目录</li>
</ul>
<p>配置环境变量：</p>
<p>当安装时没有勾选 Add to PATH，则需要将安装目录、安装目录下的 Scripts 目录配置到环境变量。</p>
<p>使用命令检查是否安装成功：</p>
<pre><code class="hljs">python -V
pip -V
</code></pre>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad39b12cb44d4a0ebbfc15526d9dae27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FkZWNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497335&amp;x-signature=8WAh7UK%2FkjsdQa1U6Y%2FEIORmsvw%3D" alt="image" loading="lazy"/>​</p>
<p>配置 pip 国内镜像：</p>
<pre><code class="hljs language-arduino" lang="arduino">pip config set global.index-url https:<span class="hljs-comment">//pypi.tuna.tsinghua.edu.cn/simple</span>
pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
pip config list
</code></pre>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6b2f3dbd8394741b25e0090dd65fbf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FkZWNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497335&amp;x-signature=maV93clw%2FT7sWK%2BCiOjcRvnWH3w%3D" alt="image" loading="lazy"/>​</p>
<h3 data-id="heading-2">Linux</h3>
<p>以 Debian 为例：</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt update
<span class="hljs-comment"># 直接装官方仓库版（可能不是最新）</span>
sudo apt install python3 python3-pip python3-venv
</code></pre>
<p>注意事项：在早前版本的 Ubuntu/Debian 中，禁止使用 sudo pip install​ 而没有禁止用户级的 install（通常安装到 ~/.local/lib/python3.x/site-packages 目录）。</p>
<p>从 Ubuntu 23.04（及 Debian 12）开始强制执执行 PEP 668 保护机制，禁止用户使用系统级 Python 执行 pip install​ 操作，建议通过虚拟环境隔离安装。</p>
<h2 data-id="heading-3">虚拟环境</h2>
<h3 data-id="heading-4">虚拟环境是什么</h3>
<p>在众多编程语言，依赖隔离是一个老生常谈的问题。拿 Java 来说，Java 默认使用本地的全局仓库，需要在项目中使用 maven / gradle 构建工具声明好需要的依赖版本。相比之下，NodeJs 是天生的项目级隔离，除非强行指定全局安装，否则所有依赖都被安装到当前项目的 node_modules​ 目录下，当种处理方式会导致一份依赖在不同项目占用多份空间，因此也催生了一些包管理工具，如 PNPM，利用 全局缓存 + 硬链接​ 实现节约磁盘和避免重复下载的目的。</p>
<p>Python 官方默认提供了虚拟环境工具 venv，在不同场景一些社区也有其他的解决方案，如 conda 等，在纯 Python 开发</p>
<h3 data-id="heading-5">为什么需要虚拟环境</h3>
<p>在一个环境中，一个依赖的安装不同版本，后者会覆盖前者，只会存在一个版本，这会导致一个环境下的多个项目依赖的版本不同而导致冲突，所以需要进行依赖环境的隔离。</p>
<p>其次，一些操作系统默认自带了 Python 环境，且禁止了用户在全局环境中安装包，防止破坏操作系统稳定性，因此必须创建虚拟环境来使用</p>
<h3 data-id="heading-6">使用 venv</h3>
<p>Python 3.3+ 内置了 venv，创建虚拟环境的命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建</span>
python -m venv .venv

<span class="hljs-comment"># 激活（Linux/macOS）</span>
<span class="hljs-built_in">source</span> .venv/bin/activate
<span class="hljs-comment"># Windows</span>
.venv\Scripts\activate

<span class="hljs-comment"># 验证</span>
<span class="hljs-built_in">which</span> python  <span class="hljs-comment"># 指向 .venv/bin/python</span>
pip list      <span class="hljs-comment"># 只有 2 个包：pip setuptools</span>

<span class="hljs-comment"># 退出</span>
deactivate
</code></pre>
<p>在当前项目的 .venv 目录下，使用 Scripts​ 目录下的 activate 脚本激活当前虚拟环境，后续使用 pip​ 安装依赖，都将存放到 Lib/site-packages​ 目录，推荐使用 python -m pip​ 来执行 pip 命令，这样指定 Python 解释器可以防止由于环境变量优先级问题而导致使用其他环境的 pip。</p>
<h2 data-id="heading-7">包管理</h2>
<h3 data-id="heading-8">pip</h3>
<p>Python 自带的 pip 包管理工具，常用命令如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装</span>
pip install <span class="hljs-attr">requests</span>==<span class="hljs-number">2.31</span>.<span class="hljs-number">0</span>

<span class="hljs-comment"># 升级</span>
pip install -U requests

<span class="hljs-comment"># 卸载</span>
pip uninstall requests -y

<span class="hljs-comment"># 查看</span>
pip show requests
</code></pre>
<p>pip 复现依赖的方法：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成</span>
pip freeze &gt; requirements.txt

<span class="hljs-comment"># 恢复</span>
pip install -r requirements.txt
</code></pre>
<p>pip freeze 会列出有已安装的依赖及版本</p>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3c91ab7723f4df284baf3d09ae2ad0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FkZWNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497335&amp;x-signature=C8UVlJaaWv04gMm6kgGUO0Q0pUg%3D" alt="image" loading="lazy"/>​</p>
<p>可以看到安装 requests 库，同时自动安装了它依赖的其他库，所以通过导出的 requirements.txt​ 文件，可以快速复现一个项目的开发场景。</p>
<p>问题是当我们不在需要 requests 库时，执行 pip uninstall requests​ 卸载 requests 库后，发现由它而引入的其他库并没有被移除，也就说 pip 无法正确处理直接依赖和间接依赖。</p>
<p>对于那些由于成为孤儿的间接依赖，官方给出的解决方案是使用 pyproject.toml​。</p>
<p>​pyproject.toml​ 是官方推出的 Python 项目配置表，用于统一各大工具的配置文件，目前很多工具都已经陆续支持。</p>
<p>在 toml 中维护只需要维护好直接依赖版本</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"learn-python"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"Add your description here"</span>
<span class="hljs-attr">readme</span> = <span class="hljs-string">"README.md"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>
<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"requests&gt;=2.32.5"</span>,
]
</code></pre>
<p>pip 23+ 支持从 pyproject.toml​ 安装依赖</p>
<pre><code class="hljs language-bash" lang="bash">pip install .
<span class="hljs-comment"># 或</span>
pip install -e . 
</code></pre>
<blockquote>
<p>需要注意的是 pip install .​ 会执行构建 + 安装​ 两个过程，会把本地代码直接打进 site-packages 目录，对于频繁修改的本地文件来说多有不便。</p>
<p>推荐使用 pip install -e .​ 来安装依赖，会在 site-packages 目录中链接文件，指向本地代码，从而编辑修改能及时生效</p>
</blockquote>
<h3 data-id="heading-9">uv</h3>
<p>pip 命令能从 pyproject.toml​ 中读取依赖，但目前不能方便的将依赖配置到 toml 中，推荐使用更加强大的 uv 命令。</p>
<p>uv 是一个用 Rust 编写的极速 Python 包和项目管理工具。</p>
<p>uv 的安装：</p>
<p>方法 1：官方安装脚本</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -LsSf https:<span class="hljs-comment">//astral.sh/uv/install.sh | sh</span>
</code></pre>
<p>方法 2：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv%2Freleases" target="_blank" title="https://github.com/astral-sh/uv/releases" ref="nofollow noopener noreferrer">Github Releases</a> 下载安装文件</p>
<p>方法 3：直接使用 pip 安装</p>
<pre><code class="hljs">pip install uv
</code></pre>
<p>常用命令：</p>
<p>虚拟环境操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 新建虚拟环境（默认目录 .venv）</span>
uv venv

<span class="hljs-comment"># 指定 Python 版本（自动下载若本地没有）</span>
uv venv --python 3.11
uv venv py38 -p 3.8        <span class="hljs-comment"># 自定义目录名</span>
</code></pre>
<p>依赖管理：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 初始化项目</span>
uv <span class="hljs-keyword">init</span> myproj

<span class="hljs-meta"># 安装全部依赖并生成/更新锁文件</span>
uv sync

<span class="hljs-meta"># 仅更新锁文件（不实际装包，适合 CI 校验）</span>
uv <span class="hljs-keyword">lock</span>

<span class="hljs-meta"># 升级单个包并重新锁定</span>
<span class="hljs-meta"># 锁文件会更新为最新兼容版本，其余包保持不动。</span>
uv <span class="hljs-keyword">lock</span> --upgrade-package pandas

<span class="hljs-meta"># 添加运行时依赖</span>
<span class="hljs-meta"># 自动向 pyproject.toml 的 [project]dependencies 写入版本区间</span>
uv <span class="hljs-keyword">add</span> requests&gt;=<span class="hljs-number">2.31</span>

<span class="hljs-meta"># 添加开发依赖</span>
<span class="hljs-meta"># 在 pyproject.toml 新增 [dependency-groups] dev = ["pytest"]</span>
uv <span class="hljs-keyword">add</span> --<span class="hljs-keyword">group</span> dev pytest

<span class="hljs-meta"># 移除依赖</span>
uv <span class="hljs-keyword">remove</span> requests

<span class="hljs-meta"># 从旧 requirements.txt 批量导入</span>
uv <span class="hljs-keyword">add</span> -r requirements.txt
</code></pre>
<p>运行脚本：</p>
<pre><code class="hljs language-css" lang="css"># 直接执行 py 文件
uv run <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
# 指定解释器
uv run python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
# 指定解释器版本，不存在将下载
uv run <span class="hljs-attr">--python</span> <span class="hljs-number">3.12</span> <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
</code></pre>
<p>兼容 pip 命令(90%+)：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 把 pip 直接换成 uv pip，速度提升 10+ 倍</span>
uv pip install requests
uv pip install -r requirements.txt
uv pip uninstall requests
</code></pre>
<h3 data-id="heading-10">还原依赖环境</h3>
<p>当参与一个已存在的 Python 项目，如何快速还原开发环境？</p>
<p>场景 1：当项目使用 pyproject toml 文件来管理</p>
<ul>
<li>使用 uv，直接 uv sync​</li>
</ul>

<ul>
<li>使用 pip，使用 pip install .​</li>
</ul>
<p>场景 2：当项目使用 requirements.txt 管理</p>
<ul>
<li>​pip install -r​ 或 uv pip install -r​ 直接安装依赖</li>
<li>​uv add -r​ 可以将 requirements 内容配置到 pyproject toml</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[清理 Git 代码库大文件历史记录]]></title>    <link>https://juejin.cn/post/7575425466904870975</link>    <guid>https://juejin.cn/post/7575425466904870975</guid>    <pubDate>2025-11-23T10:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466904870975" data-draft-id="7575442779038973994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="清理 Git 代码库大文件历史记录"/> <meta itemprop="keywords" content="Git,运维"/> <meta itemprop="datePublished" content="2025-11-23T10:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hen3y"/> <meta itemprop="url" content="https://juejin.cn/user/1425416494263021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            清理 Git 代码库大文件历史记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425416494263021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hen3y
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:01:18.000Z" title="Sun Nov 23 2025 10:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="obsidian">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#282b2e}.hljs-keyword,.hljs-literal,.hljs-selector-id,.hljs-selector-tag{color:#93c763}.hljs-number{color:#ffcd22}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#e0e2e4}.hljs-attribute{color:#668bb0}.hljs-class .hljs-title,.hljs-code,.hljs-section{color:#fff}.hljs-link,.hljs-regexp{color:#d39745}.hljs-meta{color:#557182}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-emphasis,.hljs-name,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-subst,.hljs-tag,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable{color:#8cbbad}.hljs-string,.hljs-symbol{color:#ec7600}.hljs-comment,.hljs-deletion,.hljs-quote{color:#818e96}.hljs-selector-class{color:#a082bd}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">清理 Git 代码库大文件历史记录</h2>
<p>在日常开发中，我们可能会不小心将一些大文件（如二进制文件、大型资源文件等）提交到 Git 仓库中。即使后来删除了这些文件，它们依然存在于 Git 的历史记录中，导致 <code>.git</code> 目录变得非常庞大，严重影响 <code>git clone</code> 和 <code>git pull</code> 的速度。</p>
<p>本文将介绍如何分析 Git 仓库的占用情况，并使用工具清理历史记录中的大文件。</p>
<h3 data-id="heading-1">问题分析</h3>
<p>Git 仓库体积过大的主要原因通常是 <code>.git/objects/pack/*.pack</code> 文件过大。Git 将文件历史记录存储在本地的 "database" 中，如果历史记录中包含了大量的二进制文件变动，pack 文件就会迅速膨胀。</p>
<blockquote>
<p>[!info] Git Internals - Packfiles
Git 使用 packfile 来优化存储。详情可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fbook%2Fen%2Fv2%2FGit-Internals-Packfiles" target="_blank" title="https://git-scm.com/book/en/v2/Git-Internals-Packfiles" ref="nofollow noopener noreferrer">Git - Internals - Packfiles</a></p>
</blockquote>
<h3 data-id="heading-2">第一步：找出大文件</h3>
<p>在清理之前，我们需要先找出是哪些文件占用了大量空间。</p>
<h4 data-id="heading-3">1. 查看仓库大小</h4>
<p>使用 <code>git count-objects</code> 命令可以查看仓库的打包对象数量和磁盘占用情况：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># -v: verbose, 显示详细信息</span>
<span class="hljs-comment"># -H: human-readable, 以人类可读的格式显示大小</span>
git count-objects -v -H
</code></pre>
<h4 data-id="heading-4">2. 查找 Packfile 中最大的对象</h4>
<p>我们可以通过 <code>git verify-pack</code> 命令查看 packfile 中的对象详情，并按大小排序找出最大的几个 blob 对象：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 .git/objects/pack/ 下的 .idx 文件</span>
<span class="hljs-comment"># sort -rn -k 3: 按第3列（size）倒序排列</span>
<span class="hljs-comment"># head -10: 取前10个</span>
git verify-pack -v .git/objects/pack/*.idx | <span class="hljs-built_in">sort</span> -rn -k 3 | <span class="hljs-built_in">head</span> -10
</code></pre>
<p>输出结果格式如下：</p>
<pre><code class="hljs language-text" lang="text"># SHA-1 (Blob ID) | type | size | size-in-packfile | offset-in-packfile
9704d6e7c732b07418ffe2c0dd2c2030d0cd5a2e blob   2621847 2622645 235218
2bdb752d86091c343f2f4d3af88f038f6b4c2846 blob   2212925 868876 2918139
...
</code></pre>
<h4 data-id="heading-5">3. 定位具体文件路径</h4>
<p>拿到 Blob ID 后，我们需要知道它对应的是哪个文件。使用 <code>git rev-list</code> 配合 <code>grep</code> 可以查找对应的文件名：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 替换 &lt;blob id&gt; 为上面查到的 SHA-1</span>
git rev-list --objects --all | grep 2bdb752d86091c343f2f4d3af88f038f6b4c2846
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-text" lang="text">2bdb752d86091c343f2f4d3af88f038f6b4c2846 .yarn/cache/playwright-core-npm-1.55.0-1c6d3fab0f-843376a8e2.zip
</code></pre>
<p>这样我们就找到了罪魁祸首，例如上面的 <code>yarn/cache/playwright-core-npm-1.55.0-1c6d3fab0f-843376a8e2.zip</code>。</p>
<h3 data-id="heading-6">第二步：分析问题</h3>
<p>通过上面的步骤，我们发现 <code>.yarn/cache/</code> 目录下的 zip 文件占用了大量空间。</p>
<p><strong>原因分析</strong>：
在使用 Yarn 2+ (Berry) 版本时，默认会将依赖以 zip 形式存储。如果项目没有正确配置 <code>.gitignore</code>，或者开发者误操作，就容易将 <code>.yarn/cache</code> 目录提交到 Git 仓库中。这些二进制缓存文件不仅体积大，而且变动频繁，是导致 Git 仓库膨胀的常见原因。</p>
<p><strong>Yarn 2+ 的 <code>.gitignore</code> 最佳实践</strong>：</p>
<p>根据 Yarn 官方文档，对于大多数非 Zero-Installs 的项目，我们应该忽略以下目录：</p>
<pre><code class="hljs language-gitignore" lang="gitignore"># Yarn 2+
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/sdks
!.yarn/versions

# 关键：忽略缓存目录
.yarn/cache

# 忽略构建状态和安装状态
.yarn/build-state.yml
.yarn/install-state.gz

# PnP 相关
.pnp.*
</code></pre>
<p>既然找到了问题根源是误提交了 <code>.yarn/cache</code>，接下来的目标就是将其从历史记录中彻底清除。</p>
<h3 data-id="heading-7">第三步：清理大文件</h3>
<p>找到大文件后，我们需要将其从所有历史记录中彻底移除。这里推荐使用 <strong>BFG Repo-Cleaner</strong>，它比原生的 <code>git filter-branch</code> 更快、更简单。</p>
<h4 data-id="heading-8">使用 BFG Repo-Cleaner</h4>
<blockquote>
<p>[!info] BFG Repo-Cleaner
BFG 是一个用 Scala 编写的工具，专门用于快速清理 Git 仓库中的大文件或隐私信息。
官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frtyley.github.io%2Fbfg-repo-cleaner%2F" target="_blank" title="https://rtyley.github.io/bfg-repo-cleaner/" ref="nofollow noopener noreferrer">rtyley.github.io/bfg-repo-cl…</a></p>
</blockquote>
<h5 data-id="heading-9">1. 下载并运行</h5>
<p>BFG 提供了一个 <code>.jar</code> 包，需要安装 Java 环境运行。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 bfg-1.14.0.jar 后，在仓库目录的上一级运行</span>
<span class="hljs-comment"># my-repo 为你的仓库目录名称</span>

<span class="hljs-comment"># 方式一：移除超过指定大小的文件 (例如 1M)</span>
java -jar bfg-1.14.0.jar --strip-blobs-bigger-than 1M my-repo

<span class="hljs-comment"># 方式二：移除指定名称的文件 (支持 glob 模式)</span>
java -jar bfg-1.14.0.jar --delete-files <span class="hljs-string">'*.{zip,jar,exe}'</span> my-repo

<span class="hljs-comment"># 方式三：移除指定文件夹</span>
java -jar bfg-1.14.0.jar --delete-folders <span class="hljs-string">'.svn'</span> my-repo
</code></pre>
<p>常用参数说明：</p>
<ul>
<li><code>-b, --strip-blobs-bigger-than &lt;size&gt;</code>: 移除超过指定大小的 blob。</li>
<li><code>-B, --strip-biggest-blobs NUM</code>: 移除最大的前 NUM 个 blob。</li>
<li><code>-D, --delete-files &lt;glob&gt;</code>: 按文件名移除文件。</li>
<li><code>--delete-folders &lt;glob&gt;</code>: 按文件夹名移除文件夹。</li>
<li><code>--no-blob-protection</code>: 允许修改最新提交（默认情况下 BFG 会保护最新的一次 commit 不被修改，以防误删）。</li>
</ul>
<p>这里我们使用命令删除 <code>.yarn/cache</code> 目录下的所有文件：</p>
<pre><code class="hljs language-bash" lang="bash">java -jar bfg-1.14.0.jar --delete-folders <span class="hljs-string">'.yarn/cache'</span> my-repo
</code></pre>
<h5 data-id="heading-10">2. 物理删除与垃圾回收</h5>
<p>BFG 只是更新了 Git 的引用（refs）和历史记录，并没有真正物理删除磁盘上的对象。我们需要运行 Git 的垃圾回收命令来彻底释放空间：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 强制过期所有 reflog，并执行垃圾回收</span>
git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive
</code></pre>
<p>执行完上述步骤后，再次检查仓库大小，应该会发现体积明显减小。最后，需要<strong>强制</strong>推送到远程仓库：</p>
<pre><code class="hljs language-bash" lang="bash">git push origin --force --all
</code></pre>
<blockquote>
<p>[!warning] 警告
这是一个破坏性操作，会重写 Git 历史。在执行之前，请务必<strong>备份</strong>你的仓库！
此外，强制推送后，其他协作者需要重新 clone 仓库或进行 rebase 操作。</p>
</blockquote>
<h3 data-id="heading-11">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fbook%2Fen%2Fv2%2FGit-Internals-Maintenance-and-Data-Recovery" target="_blank" title="https://git-scm.com/book/en/v2/Git-Internals-Maintenance-and-Data-Recovery" ref="nofollow noopener noreferrer">Git - Maintenance and Data Recovery</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frtyley.github.io%2Fbfg-repo-cleaner%2F" target="_blank" title="https://rtyley.github.io/bfg-repo-cleaner/" ref="nofollow noopener noreferrer">BFG Repo-Cleaner</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F18F%2FC2%2Fissues%2F439" target="_blank" title="https://github.com/18F/C2/issues/439" ref="nofollow noopener noreferrer">GitHub Issue: Reduce git repository size</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain v1 重大更新讲解⚠⚠⚠]]></title>    <link>https://juejin.cn/post/7575050949958746148</link>    <guid>https://juejin.cn/post/7575050949958746148</guid>    <pubDate>2025-11-21T17:44:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949958746148" data-draft-id="7575021014032678931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain v1 重大更新讲解⚠⚠⚠"/> <meta itemprop="keywords" content="LangChain,Python,Agent"/> <meta itemprop="datePublished" content="2025-11-21T17:44:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain v1 重大更新讲解⚠⚠⚠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T17:44:36.000Z" title="Fri Nov 21 2025 17:44:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">LangChain v1 重大更新讲解</h2>
<blockquote>
<p>为什么没有先发布demo教学而是先发布一个什么重大更新</p>
<p>因为langchain更新了，更新还挺多的所以建议大家还是从新版本开始学习</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a3016eef8c4ab0933e83e98f1dd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764351876&amp;x-signature=Ni9%2BXYxzHe7feYf8ZfLFx6ldvXM%3D" alt="人工智能的无限可能.png" loading="lazy"/></p>
<p><strong>作者</strong>：吴佳浩</p>
<p><strong>最后更新</strong>：2025-11-22</p>
<p><strong>适用版本</strong>：LangChain v1.0+</p>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2580langchain-v1-%25E4%25B8%25BA%25E4%25BB%2580%25E4%25B9%2588%25E6%2598%25AF%25E4%25B8%2580%25E6%25AC%25A1%25E5%25A4%25A7%25E7%2589%2588%25E6%259C%25AC%25E9%259D%25A9%25E5%2591%25BD" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%80langchain-v1-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%80%E6%AC%A1%E5%A4%A7%E7%89%88%E6%9C%AC%E9%9D%A9%E5%91%BD" ref="nofollow noopener noreferrer">📌 一、LangChain v1 为什么是一次“大版本革命”？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25BA%258Cv01--v10%25E5%25B7%25AE%25E5%25BC%2582%25E5%25AF%25B9%25E7%2585%25A7%25E8%25A1%25A8%25E6%25A0%25B8%25E5%25BF%2583%25E5%25BF%2585%25E8%25AF%25BB" target="_blank" title="https://www.google.com/search?q=%23-%E4%BA%8Cv01--v10%E5%B7%AE%E5%BC%82%E5%AF%B9%E7%85%A7%E8%A1%A8%E6%A0%B8%E5%BF%83%E5%BF%85%E8%AF%BB" ref="nofollow noopener noreferrer">🚀 二、v0.1 → v1.0：差异对照表（核心必读）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2589langchain-v1-%25E6%259E%25B6%25E6%259E%2584%25E6%2580%25BB%25E8%25A7%2588" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%89langchain-v1-%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88" ref="nofollow noopener noreferrer">🧱 三、LangChain v1 架构总览</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%259B%259Bcreate_agent%25E5%2585%25A8%25E6%2596%25B0%25E7%259A%2584-agent-%25E5%2588%259B%25E5%25BB%25BA%25E6%2596%25B9%25E5%25BC%258F" target="_blank" title="https://www.google.com/search?q=%23-%E5%9B%9Bcreate_agent%E5%85%A8%E6%96%B0%E7%9A%84-agent-%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F" ref="nofollow noopener noreferrer">🧰 四、create_agent：全新的 Agent 创建方式</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25BA%2594middleware%25E6%25A0%25B8%25E5%25BF%2583%25E6%2589%25A9%25E5%25B1%2595%25E6%259C%25BA%25E5%2588%25B6%25E6%25B4%258B%25E8%2591%25B1%25E6%25A8%25A1%25E5%259E%258B" target="_blank" title="https://www.google.com/search?q=%23-%E4%BA%94middleware%E6%A0%B8%E5%BF%83%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B" ref="nofollow noopener noreferrer">🔧 五、Middleware：核心扩展机制（洋葱模型）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%2585%25ADcontent_blocks%25E8%25B7%25A8%25E6%25A8%25A1%25E5%259E%258B%25E7%25BB%259F%25E4%25B8%2580%25E8%25BE%2593%25E5%2587%25BA" target="_blank" title="https://www.google.com/search?q=%23-%E5%85%ADcontent_blocks%E8%B7%A8%E6%A8%A1%E5%9E%8B%E7%BB%9F%E4%B8%80%E8%BE%93%E5%87%BA" ref="nofollow noopener noreferrer">📦 六、content_blocks：跨模型统一输出</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2583%25E7%25BB%2593%25E6%259E%2584%25E5%258C%2596%25E8%25BE%2593%25E5%2587%25BAstructured-output" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%83%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BAstructured-output" ref="nofollow noopener noreferrer">📐 七、结构化输出（Structured Output）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%2585%25AB%25E5%2591%25BD%25E5%2590%258D%25E7%25A9%25BA%25E9%2597%25B4%25E9%2587%258D%25E6%259E%2584--langchain-classic" target="_blank" title="https://www.google.com/search?q=%23-%E5%85%AB%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%87%8D%E6%9E%84--langchain-classic" ref="nofollow noopener noreferrer">📚 八、命名空间重构 + langchain-classic</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B9%259Dv0--v1-%25E8%25BF%2581%25E7%25A7%25BB%25E6%258C%2587%25E5%258D%2597%25E5%25AE%259E%25E6%2588%2598%25E7%2589%2588" target="_blank" title="https://www.google.com/search?q=%23-%E4%B9%9Dv0--v1-%E8%BF%81%E7%A7%BB%E6%8C%87%E5%8D%97%E5%AE%9E%E6%88%98%E7%89%88" ref="nofollow noopener noreferrer">🛠 九、v0 → v1 迁移指南（实战版）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E6%258E%25A8%25E8%258D%2590%25E7%259A%2584%25E7%2594%259F%25E4%25BA%25A7%25E7%25BA%25A7%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BB%2593%25E6%259E%2584%25E5%259B%25BE" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E6%8E%A8%E8%8D%90%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E5%9B%BE" ref="nofollow noopener noreferrer">🏗 十、推荐的生产级项目结构图</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25B8%2580%25E7%259C%259F%25E5%25AE%259E%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7%25E6%25A1%2588%25E4%25BE%258B%25E5%25A4%259A%25E6%25AD%25A5%25E9%25AA%25A4%25E4%25BB%25BB%25E5%258A%25A1-agent" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%B8%80%E7%9C%9F%E5%AE%9E%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%A1%88%E4%BE%8B%E5%A4%9A%E6%AD%A5%E9%AA%A4%E4%BB%BB%E5%8A%A1-agent" ref="nofollow noopener noreferrer">🧪 十一、真实企业级案例：多步骤任务 Agent</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25BA%258C%25E5%258F%25AF%25E8%25BF%2590%25E8%25A1%258C%25E7%25BB%25BC%25E5%2590%2588%25E7%25A4%25BA%25E4%25BE%258B%25E4%25BB%25A3%25E7%25A0%2581" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%BA%8C%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81" ref="nofollow noopener noreferrer">📄 十二、可运行综合示例代码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25B8%2589%25E6%2580%25BB%25E7%25BB%2593" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%B8%89%E6%80%BB%E7%BB%93" ref="nofollow noopener noreferrer">📍 十三、总结</a></li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3c0946c7f754c509c415ec7c41395e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764351876&amp;x-signature=%2BwOZ4LEjJgMGSln38CEuIWgLku4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">0. 环境准备</h3>
<p>在开始之前，请确保 Python 版本 <strong>≥ 3.9</strong>，并安装以下核心包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 v1 核心包、经典兼容包和图运行时</span>
pip install -U langchain langchain-classic langgraph

<span class="hljs-comment"># 安装适配的模型提供商包 (以 OpenAI 为例)</span>
pip install -U langchain-openai
</code></pre>
<hr/>
<h3 data-id="heading-3">一、LangChain v1 为什么是一次“大版本革命”？</h3>
<p>LangChain v1 不再仅仅是一个“LLM 调用工具箱”，而是正式转向<strong>构建生产级 Agent 系统的工程框架</strong>。</p>
<p><strong>核心变化包括：</strong></p>
<ol>
<li><strong><code>create_agent</code></strong>：正式成为 Agent 的标准构建方式（底层基于 LangGraph）。</li>
<li><strong>Middleware (中间件)</strong>：允许在任意阶段（模型调用前、工具执行时、输出后）拦截并修改逻辑。</li>
<li><strong><code>content_blocks</code></strong>：所有模型输出（推理/文本/工具调用）统一为标准格式，不再依赖正则解析。</li>
<li><strong>结构化输出</strong>：Pydantic Schema 成为一等公民，极大提升稳定性。</li>
<li><strong>命名空间拆分</strong>：旧 API（如 Chains）全部迁入 <code>langchain-classic</code>，主包只保留 Agent 核心。</li>
</ol>
<hr/>
<h3 data-id="heading-4">二、v0.1 → v1.0：差异对照表（核心必读）</h3>
<p>这是理解 v1 最重要的一张表，展示了从“脚本思维”到“工程思维”的转变。</p>

































































<table><thead><tr><th><strong>项目</strong></th><th><strong>LangChain v0.x (旧版)</strong></th><th><strong>LangChain v1.0 (新版)</strong></th><th><strong>核心差异</strong></th></tr></thead><tbody><tr><td><strong>中心思想</strong></td><td>Chains (链式调用)</td><td><strong>Agents (智能体)</strong></td><td>从线性执行转向循环图执行 (Graph)</td></tr><tr><td><strong>构建入口</strong></td><td><code>initialize_agent</code></td><td><strong><code>create_agent</code></strong></td><td>统一的新标准接口</td></tr><tr><td><strong>底层引擎</strong></td><td><code>AgentExecutor</code> (硬编码循环)</td><td><strong>LangGraph</strong></td><td>支持持久化、流式、分支、循环的图运行时</td></tr><tr><td><strong>流式能力</strong></td><td>部分支持 (Token级)</td><td><strong>全链路流式</strong></td><td>支持 Token、中间步骤、推理过程的实时流</td></tr><tr><td><strong>扩展机制</strong></td><td>无 (需修改源码或Prompt)</td><td><strong>Middleware</strong></td><td>完整的生命周期钩子 (Hooks)</td></tr><tr><td><strong>工具定义</strong></td><td><code>Tool</code> + <code>func</code></td><td><code>Tool</code> + <strong>Pydantic Schema</strong></td><td>类型更安全，参数定义更清晰</td></tr><tr><td><strong>结构化输出</strong></td><td>JSON Parser + Regex</td><td><strong>Structured Output</strong></td><td>直接绑定 Pydantic 类，由模型底层保证格式</td></tr><tr><td><strong>输出解析</strong></td><td>纯文本 + 正则匹配</td><td><strong><code>content_blocks</code></strong></td><td>标准化对象 (推理块、文本块、工具块)</td></tr><tr><td><strong>包管理</strong></td><td><code>langchain.*</code></td><td><strong><code>langchain-classic</code></strong></td><td>旧功能移至 classic 包，保持主包轻量</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">三、LangChain v1 架构总览</h3>
<blockquote>
<p><strong>💡 核心提示</strong>：LangChain v1 的底层引擎实际上是 <strong>LangGraph</strong>。<code>create_agent</code> 本质上是为你预构建了一个标准的 LangGraph 图。</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph AgentRuntime ["LangGraph 运行时"]
        direction TB
        A["用户输入 (Messages)"] --&gt; B[" 模型推理 (LLM)"]
        B --&gt; C{"决策节点"}
        C --&gt;|需要工具| D[" 工具执行 (Tool Execution)"]
        D --&gt; E[" 工具结果反馈"]
        E --&gt; B
        C --&gt;|无需工具/结束| F[" 生成最终回答"]
    end
    
    style A fill:#e1f5fe,stroke:#01579b
    style B fill:#fff9c4,stroke:#fbc02d
    style D fill:#e8f5e9,stroke:#2e7d32
</code></pre>
<hr/>
<h3 data-id="heading-6">四、create_agent：全新的 Agent 创建方式</h3>
<p>为什么废弃 initialize_agent？</p>
<p>因为 v1 统一使用图架构（Graph Architecture）。所有的 Agent 本质上都是：推理 → 工具 → 再推理 的循环。create_agent 是这个标准循环的工厂函数。</p>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 定义模型</span>
model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 2. 创建 Agent</span>
agent = create_agent(
    model=model,
    tools=[search_tool, calculator_tool],
    system_prompt=<span class="hljs-string">"你是一个乐于助人的金融分析师。"</span>
)

<span class="hljs-comment"># 3. 运行 (Invoke)</span>
result = agent.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"分析 AAPL 股价"</span>}]})
</code></pre>
<hr/>
<h3 data-id="heading-7">五、Middleware：核心扩展机制（洋葱模型）</h3>
<p>中间件是 v1 最强大的功能，允许你在 Agent 生命周期的任意节点插入逻辑（如鉴权、日志、路由）。</p>
<p><strong>生命周期时序图：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant MW as Middleware (中间件层)
    participant Agent as Agent Runtime
    participant Model as LLM

    User-&gt;&gt;Agent: invoke(input)
    Agent-&gt;&gt;MW: 1. before_agent_start
    MW--&gt;&gt;Agent: (清洗后的输入)

    loop 思考与执行循环
        Agent-&gt;&gt;MW: 2. before_model
        Note right of MW: 动态修改 Prompt / 路由模型
        
        rect rgb(240,240,240)
            MW-&gt;&gt;Model: 3. wrap_model_call
            Model--&gt;&gt;MW: 返回原始结果
        end
        
        MW--&gt;&gt;Agent: 4. after_model (校验输出)

        opt 工具调用
            Agent-&gt;&gt;MW: 5. wrap_tool_call
            Note right of MW: 敏感操作审批 / 审计
            MW--&gt;&gt;Agent: 工具结果
        end
    end

    Agent-&gt;&gt;MW: 6. after_agent
    MW--&gt;&gt;User: 最终响应
</code></pre>
<hr/>
<h3 data-id="heading-8">六、content_blocks：跨模型统一输出</h3>
<p>解决“不同模型返回格式不同”的痛点。</p>
<p>模型输出现在包含统一的 .content_blocks 属性：</p>
<ul>
<li><code>reasoning</code>: 模型的思考过程（如 Chain of Thought）。</li>
<li><code>tool_call</code>: 结构化的工具调用请求。</li>
<li><code>text</code>: 最终回复文本。</li>
</ul>
<hr/>
<h3 data-id="heading-9">七、结构化输出（Structured Output）</h3>
<p>v1 推荐使用 <strong>Pydantic Schema</strong> 来强制模型输出特定格式，而不是在 Prompt 里写“请返回 JSON”。</p>
<p><strong>三种策略：</strong></p>
<ol>
<li><strong>SchemaBasedStructurer</strong> (推荐)：直接传入 Pydantic 类。</li>
<li><strong>ToolStrategy</strong>：利用 Tool Calling 机制输出结构。</li>
<li><strong>ProviderStrategy</strong>：利用模型原生 JSON Mode（如 OpenAI JSON Object）。</li>
</ol>
<hr/>
<h3 data-id="heading-10">八、命名空间重构 + langchain-classic</h3>
<p>为了给 Agent 让路，旧的“链式”组件被移入 <code>classic</code> 包。</p>
<p><strong>迁移对照：</strong></p>

























<table><thead><tr><th><strong>组件</strong></th><th><strong>旧引入方式</strong></th><th><strong>v1 新引入方式</strong></th></tr></thead><tbody><tr><td><strong>Memory</strong></td><td><code>from langchain.memory import ...</code></td><td><code>from langchain_classic.memory import ...</code></td></tr><tr><td><strong>Chains</strong></td><td><code>from langchain.chains import ...</code></td><td><code>from langchain_classic.chains import ...</code></td></tr><tr><td><strong>Retrievers</strong></td><td><code>from langchain.retrievers import ...</code></td><td><code>from langchain_classic.retrievers import ...</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">🛠 九、v0 → v1 迁移指南（实战版）</h3>
<h4 data-id="heading-12">1. ConversationChain → create_agent</h4>
<ul>
<li>
<p>❌ <strong>旧 (v0)</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> ConversationChain
chain = ConversationChain(llm=llm)
chain.run(<span class="hljs-string">"Hi"</span>)
</code></pre>
</li>
<li>
<p>✔ <strong>新 (v1)</strong>：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-comment"># create_agent 自带记忆管理 (通过 LangGraph checkpoint)</span>
agent = create_agent(model=llm, tools=[])
agent.invoke({<span class="hljs-string">"messages"</span>: [...]})
</code></pre>
</li>
</ul>
<h4 data-id="heading-13">2. LLMChain → model.invoke</h4>
<ul>
<li>
<p>❌ <strong>旧 (v0)</strong>：</p>
<pre><code class="hljs language-python" lang="python">chain = LLMChain(prompt=prompt, llm=llm)
chain.run(variable=<span class="hljs-string">"value"</span>)
</code></pre>
</li>
<li>
<p>✔ <strong>新 (v1)</strong>：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 直接使用 LCEL (LangChain Expression Language)</span>
chain = prompt | llm
chain.invoke({<span class="hljs-string">"variable"</span>: <span class="hljs-string">"value"</span>})
</code></pre>
</li>
</ul>
<h4 data-id="heading-14">3. Tool 定义方式</h4>
<ul>
<li>❌ <strong>旧 (v0)</strong>：依赖 <code>func</code> 和文档字符串解析。</li>
<li>✔ <strong>新 (v1)</strong>：强烈建议使用 <code>@tool</code> 装饰器并配合 Pydantic 类型的参数注解，或者使用 <code>create_tool(schema=MySchema)</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-15">十、推荐的生产级项目结构图</h3>
<p>在 v1 时代，推荐采用分层架构来管理 Agent 项目：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  Root[" my_agent_project/"] --&gt; A[" app/"]
  
  A --&gt; B[" agent.py &lt;br/&gt; (create_agent 组装入口)"]
  
  A --&gt; C["middleware/ &lt;br/&gt; (中间件层)"]
  C --&gt; C1[" auth_middleware.py"]
  C --&gt; C2[" risk_control.py"]
  
  A --&gt; D[" schemas/ &lt;br/&gt; (数据结构)"]
  D --&gt; D1[" user_context.py"]
  D --&gt; D2[" output_schema.py"]
  
  A --&gt; E[" tools/ &lt;br/&gt; (工具集)"]
  E --&gt; E1[" search_tool.py"]
  E --&gt; E2[" db_tool.py"]
  
  A --&gt; F[" main.py &lt;br/&gt; (FastAPI/Streamlit 入口)"]
</code></pre>
<hr/>
<h3 data-id="heading-16">十一、真实企业级案例：多步骤任务 Agent</h3>
<p>场景：自动代码修复 Agent。</p>
<p>流程：写代码 → 运行测试 → 失败则分析日志 → 修复代码 → 循环直至成功。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start(("开始")) --&gt; Gen["生成初版代码"]
    Gen --&gt; Run["🔧 工具: 运行代码/测试"]
    Run --&gt; Check{"测试通过?"}
    
    Check --&gt;|失败| Debug[" LLM: 分析错误日志"]
    Debug --&gt; Gen
    
    Check --&gt;|成功| Output["输出最终代码"]
    Output --&gt; End(("结束"))
</code></pre>
<p><em>这在 v1 中通过 <code>create_agent</code> 天然支持，因为底层 Graph 支持循环，且可以通过中间件记录每次尝试的详细日志。</em></p>
<hr/>
<h3 data-id="heading-17">十二、可运行综合示例代码</h3>
<p>这是一个包含了 <strong>中间件 (Middleware)</strong> 和 <strong>结构化输出</strong> 的完整 v1 示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware, ModelRequest, ModelResponse

<span class="hljs-comment"># 1. 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-comment"># 模拟 API 返回</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 天气晴朗, 25°C"</span>

<span class="hljs-comment"># 2. 定义结构化输出 Schema</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherReport</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    city: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"城市名称"</span>)
    temperature: <span class="hljs-built_in">float</span> = Field(description=<span class="hljs-string">"温度数值"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"一句话天气总结"</span>)

<span class="hljs-comment"># 3. 定义自定义中间件 (示例：自动添加礼貌用语)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolitenessMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap_model_call</span>(<span class="hljs-params">self, request: ModelRequest, handler</span>) -&gt; ModelResponse:
        <span class="hljs-comment"># 在发送给模型前，修改 System Prompt</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🕵️ Middleware: 正在注入礼貌指令..."</span>)
        <span class="hljs-keyword">if</span> request.messages:
            last_msg = request.messages[-<span class="hljs-number">1</span>]
            <span class="hljs-keyword">if</span> last_msg.role == <span class="hljs-string">"user"</span>:
                last_msg.content += <span class="hljs-string">" (请用非常礼貌的语气回答)"</span>
        <span class="hljs-keyword">return</span> handler(request)

<span class="hljs-comment"># 4. 构建 Agent</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    agent = create_agent(
        model=ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>),
        tools=[get_weather],
        middleware=[PolitenessMiddleware()],
        <span class="hljs-comment"># 强制结构化输出 (v1 特性)</span>
        <span class="hljs-comment"># response_format=ToolStrategy(WeatherReport) # 若需强制结构化可开启此行</span>
    )

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 Agent 启动..."</span>)
    result = <span class="hljs-keyword">await</span> agent.ainvoke({
        <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"帮我查一下北京的天气"</span>}]
    })

    <span class="hljs-comment"># v1 的 result 包含完整的执行状态</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n💬 最终回复:"</span>)
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<hr/>
<h3 data-id="heading-18">十三、总结</h3>
<p>LangChain v1 标志着我们从 <strong>“玩票性质的 Chain”</strong> 走向了 <strong>“工程化的 Agent”</strong>。</p>
<ul>
<li>如果你需要构建简单的问答机器人，LangChain v1 提供了更统一的接口。</li>
<li>如果你需要构建复杂的、多步推理的、具有自我纠错能力的企业级智能体，LangChain v1 (配合 LangGraph) 是目前 Python 生态中最佳的选择。</li>
</ul>
<p><strong>下一步建议：</strong> 安装 <code>langchain-classic</code> 确保旧代码运行，同时在新模块中开始尝试使用 <code>create_agent</code>。
慎重更新老项目。。。。。。崩了。。。别赖我。。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ultracite：为 AI 时代打造的零配置代码规范工具]]></title>    <link>https://juejin.cn/post/7575090551356686388</link>    <guid>https://juejin.cn/post/7575090551356686388</guid>    <pubDate>2025-11-22T10:26:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551356686388" data-draft-id="7575090551356670004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ultracite：为 AI 时代打造的零配置代码规范工具"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-11-22T10:26:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JinSo"/> <meta itemprop="url" content="https://juejin.cn/user/2041171430876333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ultracite：为 AI 时代打造的零配置代码规范工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041171430876333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JinSo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T10:26:41.000Z" title="Sat Nov 22 2025 10:26:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">Ultracite 是什么？</h2>
<p>Ultracite 是一个<strong>高度固定化、零配置</strong>的代码检查和格式化工具。它基于高性能的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbiomejs.dev%2F" target="_blank" title="https://biomejs.dev/" ref="nofollow noopener noreferrer">Biome</a> 构建，适用于所有前端项目，无论你使用 React、Vue、Angular 还是原生 JavaScript，都能让你和 AI 编程助手编写出一致且高质量的代码。</p>
<h3 data-id="heading-1">核心理念：约定优于配置</h3>
<p>不同于 ESLint + Prettier 需要大量配置，Ultracite 采用了极简主义设计理念：</p>
<ul>
<li><strong>零配置</strong>：开箱即用，无需编写任何配置文件</li>
<li><strong>固定规则</strong>：精心挑选的规则集，避免无谓的选择困扰</li>
<li><strong>统一标准</strong>：整个团队和 AI 助手都遵循相同的代码规范</li>
</ul>
<h2 data-id="heading-2">快速开始</h2>
<h3 data-id="heading-3">初始化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目中初始化 Ultracite</span>
pnpm dlx ultracite init
</code></pre>
<p>Ultracite 提供了交互式的安装体验，让你根据项目需求选择功能：</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm dlx ultracite init
┌
888     888 888    88888888888 8888888b.         d8888  .d8888b. 8888888 88888888888 8888888888
888     888 888        888     888   Y88b       d88888 d88P  Y88b  888       888     888
888     888 888        888     888    888      d88P888 888    888  888       888     888
888     888 888        888     888   d88P     d88P 888 888         888       888     8888888
888     888 888        888     8888888P<span class="hljs-string">"     d88P  888 888         888       888     888
888     888 888        888     888 T88b     d88P   888 888    888  888       888     888
Y88b. .d88P 888        888     888  T88b   d8888888888 Y88b  d88P  888       888     888
 "</span>Y88888P<span class="hljs-string">"  88888888   888     888   T88b d88P     888  "</span>Y8888P<span class="hljs-string">" 8888888     888     8888888888

│
●  Detected lockfile, using pnpm
│
◇  Remove existing formatters/linters (recommended for clean migration)?
│  Remove ESLint (dependencies, config files, VS Code settings)
│
◇  Which frameworks are you using (optional)?
│  React
│
◇  Which editors do you want to configure (recommended)?
│  VSCode / Cursor / Windsurf
│
◇  Which agents do you want to enable (optional)?
│  Cursor
│
◇  Which agent hooks do you want to enable (optional)?
│  Cursor
│
◇  Would you like any of the following (optional)?
│  Husky pre-commit hook, Lefthook pre-commit hook, Lint-staged
│
◑  ...省略安装步骤
◆  Successfully initialized Ultracite configuration!
</span></code></pre>
<p>初始化完成后，Ultracite 会根据你的选择自动完成以下配置：</p>
<ul>
<li>安装必要的依赖包</li>
<li>生成编辑器配置文件</li>
<li><strong>创建 AI 代码规范提示词</strong>（这是 Ultracite 的核心特性之一）</li>
<li>配置 Git Hooks 工具（Husky、Lefthook、Lint-staged）</li>
<li>更新 package.json 脚本</li>
<li>生成 biome.json 配置文件</li>
</ul>
<p>关于 Git Hooks 工具的详细介绍，可以参考我之前的文章：<a href="https://juejin.cn/post/7309290887363592233" target="_blank" title="https://juejin.cn/post/7309290887363592233">在 Monorepo 中对代码进行规范(husky + lint-staged)</a></p>
<h3 data-id="heading-4">基本使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查代码问题</span>
npx ultracite check

<span class="hljs-comment"># 自动修复和格式化代码</span>
npx ultracite fix
</code></pre>
<h2 data-id="heading-5">AI 友好特性</h2>
<p>这是 Ultracite 的一大亮点 —— 它专门为 AI 编程时代设计，让 AI 助手也能遵循项目的代码规范。</p>
<h3 data-id="heading-6">AI 提示词集成</h3>
<p>当你选择启用 AI agent（如 Cursor）时，Ultracite 会生成一份详细的代码规范提示词文件 <code>.cursor/rules/ultracite.mdc</code>。这份文件包含了完整的编码规范，涵盖：</p>
<ul>
<li><strong>类型安全规范</strong>：要求使用明确的类型定义，避免 any 类型</li>
<li><strong>现代语法规范</strong>：优先使用箭头函数、可选链、解构赋值等现代特性</li>
<li><strong>异步编程规范</strong>：正确使用 async/await，妥善处理错误</li>
<li><strong>React 最佳实践</strong>：函数组件、Hooks 规则、无障碍访问等</li>
<li><strong>代码组织原则</strong>：函数复杂度控制、早期返回、关注点分离</li>
</ul>
<p>有了这份提示词，AI 助手生成的代码会自动遵循这些规范，大大减少了代码审查的工作量。</p>
<h3 data-id="heading-7">Cursor Hooks 集成</h3>
<p>对于 Cursor 用户，Ultracite 还会生成 hooks 配置（<code>.cursor/hooks.json</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"version"</span>: 1,
  <span class="hljs-string">"hooks"</span>: {
    <span class="hljs-string">"afterFileEdit"</span>: [
      {
        <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx ultracite fix"</span>
      }
    ]
  }
}
</code></pre>
<p>这个配置实现了"保存即格式化"的效果 —— 每次你或 AI 编辑文件后，代码都会自动格式化，保持整个项目的一致性。</p>
<h2 data-id="heading-8">Git Hooks 集成</h2>
<p>Ultracite 支持主流的 Git Hooks 工具，确保提交的代码都经过检查和格式化。</p>
<h3 data-id="heading-9">Husky 集成</h3>
<p>生成的 <code>.husky/pre-commit</code> 文件会在提交前自动运行代码检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-comment"># Exit on any error</span>
<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># Check if there are any staged files</span>
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-subst">$(git diff --cached --name-only)</span>"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"No staged files to format"</span>
  <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Store the hash of staged changes to detect modifications</span>
STAGED_HASH=$(git diff --cached | <span class="hljs-built_in">sha256sum</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">' '</span> -f1)

<span class="hljs-comment"># Save list of staged files (handling all file states)</span>
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
PARTIALLY_STAGED=$(git diff --name-only)

<span class="hljs-comment"># Stash unstaged changes to preserve working directory</span>
git stash push --quiet --keep-index --message <span class="hljs-string">"pre-commit-stash"</span> || <span class="hljs-literal">true</span>
STASHED=$?

<span class="hljs-comment"># Run formatter on the staged files</span>
pnpm dlx ultracite fix
FORMAT_EXIT_CODE=$?

<span class="hljs-comment"># Restore working directory state</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$STASHED</span> -eq 0 ]; <span class="hljs-keyword">then</span>
  <span class="hljs-comment"># Re-stage the formatted files</span>
  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$STAGED_FILES</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$STAGED_FILES</span>"</span> | <span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r file; <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>
        git add <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>
      <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-comment"># Restore unstaged changes</span>
  git stash pop --quiet || <span class="hljs-literal">true</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Check if staged files actually changed</span>
NEW_STAGED_HASH=$(git diff --cached | <span class="hljs-built_in">sha256sum</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">' '</span> -f1)
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$STAGED_HASH</span>"</span> != <span class="hljs-string">"<span class="hljs-variable">$NEW_STAGED_HASH</span>"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"✨ Files formatted by Ultracite"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> <span class="hljs-variable">$FORMAT_EXIT_CODE</span>
</code></pre>
<p>这个脚本会智能处理部分暂存的文件，确保只格式化你要提交的代码。</p>
<h3 data-id="heading-10">Lefthook 集成</h3>
<p>如果你选择使用 Lefthook，会生成 <code>lefthook.yml</code> 配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">pre-commit:</span>
  <span class="hljs-attr">jobs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">dlx</span> <span class="hljs-string">ultracite</span> <span class="hljs-string">fix</span>
      <span class="hljs-attr">glob:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.js"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.jsx"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.ts"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.tsx"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.json"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.jsonc"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*.css"</span>
      <span class="hljs-attr">stage_fixed:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>Lefthook 的优势在于并行执行和更灵活的配置选项。</p>
<h3 data-id="heading-11">Lint-staged 集成</h3>
<p>配合 lint-staged 可以只处理暂存的文件，在 <code>package.json</code> 中会添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,jsx,ts,tsx,json,jsonc,css,scss,md,mdx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"pnpm dlx ultracite fix"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-12">VSCode 深度集成</h2>
<p>Ultracite 会自动为 VSCode（包括 Cursor、Windsurf）生成配置，实现保存时自动格式化：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .vscode/settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[javascript]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[typescript]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[javascriptreact]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[typescriptreact]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[json]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[jsonc]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[css]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[graphql]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"biomejs.biome"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"typescript.tsdk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_modules/typescript/lib"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.formatOnPaste"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"emmet.showExpandedAbbreviation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"never"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"source.fixAll.biome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explicit"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"source.organizeImports.biome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explicit"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-13"><strong>MCP（Model Context Protocol）支持</strong></h2>
<p>MCP 是一个开放标准，让 Claude、Cursor 等 AI 工具能够安全地连接外部数据源和系统。可以把它理解为一个"万能遥控器"，让 AI 工具能够访问真实世界的数据和功能。Ultracite 通过支持 MCP 来增强你的 AI 开发工作流。</p>
<h3 data-id="heading-14"><strong>安装配置</strong></h3>
<ol>
<li>
<p><strong>选择你的 AI 工具</strong></p>
<p>确保你使用的 AI 开发工具支持 MCP：</p>
<ul>
<li>Claude Desktop（免费，推荐初学者使用）</li>
<li>Cursor（AI 驱动的代码编辑器）</li>
<li>Windsurf by Codeium（AI 开发平台）</li>
<li>其他支持 MCP 的工具</li>
</ul>
</li>
<li>
<p><strong>找到配置文件位置</strong></p>
<p>根据你的 AI 工具，需要编辑对应的配置文件：</p>
<ul>
<li>
<p><strong>Claude Desktop</strong>:</p>
<ul>
<li>macOS: <code>~/Library/Application\ Support/Claude/claude_desktop_config.json</code></li>
<li>Windows: <code>%APPDATA%\Claude\claude_desktop_config.json</code></li>
</ul>
</li>
<li>
<p><strong>Cursor</strong>: <code>.cursor/mcp.json</code></p>
</li>
<li>
<p><strong>Windsurf</strong>: <code>.codeium/windsurf/mcp_config.json</code></p>
</li>
<li>
<p><strong>其他工具</strong>: 查看对应工具的 MCP 文档</p>
</li>
</ul>
</li>
<li>
<p><strong>添加 Ultracite 配置</strong></p>
<p>将以下配置复制到你的 MCP 配置文件中：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ultracite"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"mcp-remote"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"&lt;https://www.ultracite.ai/api/mcp/mcp&gt;"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>重启 AI 工具</strong></p>
<p>关闭并重新打开你的 AI 应用，让配置生效。</p>
</li>
<li>
<p><strong>验证连接</strong></p>
<p>通过询问你的 AI 助手来测试集成是否成功：</p>
<blockquote>
<p>"Ultracite 有哪些可用的规则？"</p>
</blockquote>
<p>如果配置成功，AI 应该能够列出并解释 Ultracite 的规则！</p>
</li>
</ol>
<h2 data-id="heading-15">从 ESLint + Prettier 迁移</h2>
<p>迁移过程非常简单：</p>
<ol>
<li>运行 <code>pnpm dlx ultracite init</code></li>
<li>选择移除现有的 ESLint 和 Prettier 配置</li>
<li>更新 package.json 中的脚本命令</li>
<li>删除旧的配置文件</li>
</ol>
<p>Ultracite 的规则集已经涵盖了大多数常用的 ESLint 和 Prettier 规则，你几乎不需要任何额外配置。</p>
<h2 data-id="heading-16">总结</h2>
<p>Ultracite 代表了代码质量工具的新方向：简单、快速、AI 友好。它特别适合：</p>
<ul>
<li><strong>使用 AI 编程的开发者</strong>：通过提示词和 hooks 确保 AI 生成高质量代码</li>
<li><strong>追求效率的团队</strong>：零配置设计，减少工具链维护成本</li>
<li><strong>任何前端项目</strong>：无论使用什么框架，都能获得一致的代码质量</li>
<li><strong>Monorepo 项目</strong>：原生支持，配置简单</li>
</ul>
<p>相比传统的 ESLint + Prettier 组合，Ultracite 提供了更快的性能、更简单的配置、更统一的工具链，以及原生的 AI 编程支持。在 AI 辅助编程越来越普及的今天，选择一个 AI 友好的代码规范工具，能让你的开发效率更上一层楼。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 属性值 initial、unset 和 revert 的解析]]></title>    <link>https://juejin.cn/post/7575083657994158107</link>    <guid>https://juejin.cn/post/7575083657994158107</guid>    <pubDate>2025-11-22T14:17:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575083657994158107" data-draft-id="7575133880434966579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 属性值 initial、unset 和 revert 的解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-22T14:17:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 属性值 initial、unset 和 revert 的解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T14:17:29.000Z" title="Sat Nov 22 2025 14:17:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<strong>前端架构师</strong>，关注微信公众号【<strong>程序员大卫</strong>】，免费领取前端最新面试资料。</p>
<h2 data-id="heading-0">背景</h2>
<p>在 CSS 中，管理属性值和继承行为是创建健壮、可维护样式的基础。除了常见的具体数值（如 <code>16px</code>、<code>#333</code>）或通用值（如 <code>inherit</code>）之外，CSS 还提供了一些特殊的<strong>关键字</strong>，它们能重置或恢复属性值到其“默认”或前一个状态。</p>
<p>其中，<code>initial</code>、<code>unset</code> 和 <code>revert</code> 是三个功能强大且容易混淆的关键字。理解它们的区别，能帮助您更好地控制样式，尤其是在处理第三方组件或大型应用中的样式冲突时。</p>
<h2 data-id="heading-1">核心区别一览</h2>





























<table><thead><tr><th align="left">关键字</th><th align="left">作用</th><th align="left">行为细节</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong><code>initial</code></strong></td><td align="left">重置为<strong>初始值</strong></td><td align="left">将属性重置为其在 CSS 规范中定义的<strong>初始值</strong>（就像该属性从未被设置过一样）。</td><td align="left">确保属性值是浏览器默认的“出厂设置”，不考虑继承。</td></tr><tr><td align="left"><strong><code>unset</code></strong></td><td align="left">重置为<strong>未设置值</strong></td><td align="left">如果该属性是<strong>可继承</strong>的，则表现为 <code>inherit</code>（继承父元素的值）。<br/>如果该属性是<strong>不可继承</strong>的，则表现为 <code>initial</code>。</td><td align="left">恢复属性到其自然的（默认的）继承行为。</td></tr><tr><td align="left"><strong><code>revert</code></strong></td><td align="left">重置为<strong>上一个级联值</strong></td><td align="left">将属性重置为<strong>用户代理样式表</strong>（浏览器默认样式）、<strong>用户样式表</strong>或<strong>作者样式表</strong>中应用过的上一个值。它会撤销当前样式块的更改，恢复到级联链中更早的值。</td><td align="left">撤销对属性的特定覆盖，恢复到浏览器或用户定义的样式，常用于恢复浏览器默认样式。</td></tr></tbody></table>
<h2 data-id="heading-2">关键字详解与示例</h2>
<p>为了更好地理解，我们主要关注 <code>color</code>（可继承）和 <code>border</code>（不可继承）这两个属性。</p>
<h3 data-id="heading-3">1. <code>initial</code>：回到起点</h3>
<p><code>initial</code> 总是将属性值设置为 CSS 规范中定义的<strong>初始值</strong>。这个值是固定的，并且与该元素是否继承了父元素的值<strong>无关</strong>。</p>
<h4 data-id="heading-4"><strong>示例：</strong></h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 初始设置 */</span>
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: blue;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid black;
}

<span class="hljs-comment">/* 应用 initial */</span>
<span class="hljs-selector-class">.initial-demo</span> {
  <span class="hljs-comment">/* color 是可继承属性，但 initial 强制设为初始值 (通常是 black) */</span>
  <span class="hljs-attribute">color</span>: initial;
  <span class="hljs-comment">/* border 是不可继承属性，initial 强制设为初始值 (none) */</span>
  <span class="hljs-attribute">border</span>: initial;
}
</code></pre>























<table><thead><tr><th align="left">元素</th><th align="left">父元素 <code>div</code> 的样式</th><th align="left"><code>.initial-demo</code> 的样式</th><th align="left">最终值</th></tr></thead><tbody><tr><td align="left"><code>color</code></td><td align="left"><code>blue</code></td><td align="left"><code>initial</code></td><td align="left"><strong><code>black</code></strong> (初始值)</td></tr><tr><td align="left"><code>border</code></td><td align="left"><code>1px solid black</code></td><td align="left"><code>initial</code></td><td align="left"><strong><code>none</code></strong> (初始值)</td></tr></tbody></table>
<h3 data-id="heading-5">2. <code>unset</code>：恢复自然状态</h3>
<p><code>unset</code> 是一个“智能”的重置。它根据属性的<strong>可继承性</strong>来决定行为：</p>
<ul>
<li><strong>可继承属性：</strong> 表现为 <code>inherit</code>。</li>
<li><strong>不可继承属性：</strong> 表现为 <code>initial</code>。</li>
</ul>
<h4 data-id="heading-6"><strong>示例：</strong></h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 初始设置 */</span>
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: blue;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid black;
}

<span class="hljs-comment">/* 应用 unset */</span>
<span class="hljs-selector-class">.unset-demo</span> {
  <span class="hljs-comment">/* color 是可继承属性，表现为 inherit */</span>
  <span class="hljs-attribute">color</span>: unset;
  <span class="hljs-comment">/* border 是不可继承属性，表现为 initial */</span>
  <span class="hljs-attribute">border</span>: unset;
}
</code></pre>























<table><thead><tr><th align="left">元素</th><th align="left">父元素 <code>div</code> 的样式</th><th align="left"><code>.unset-demo</code> 的样式</th><th align="left">最终值</th></tr></thead><tbody><tr><td align="left"><code>color</code></td><td align="left"><code>blue</code></td><td align="left"><code>unset</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <code>inherit</code></td><td align="left"><strong><code>blue</code></strong> (继承自父元素)</td></tr><tr><td align="left"><code>border</code></td><td align="left"><code>1px solid black</code></td><td align="left"><code>unset</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <code>initial</code></td><td align="left"><strong><code>none</code></strong> (初始值)</td></tr></tbody></table>
<h3 data-id="heading-7">3. <code>revert</code>：撤销作者样式</h3>
<p><code>revert</code> 是最独特的。它沿着 CSS 级联（Cascading）链向上查找，恢复到<strong>上一个</strong>被应用的值。它本质上是<strong>撤销</strong>了当前样式表中的属性定义，恢复到：</p>
<ol>
<li><strong>用户样式</strong>（如果用户设置了）。</li>
<li><strong>浏览器默认样式</strong>（用户代理样式表）。</li>
<li>如果以上都没有，则恢复到 <code>unset</code> 的行为。</li>
</ol>
<p>它主要用于恢复浏览器默认样式，例如，您不想让某个 <code>&lt;h1&gt;</code> 标签应用您的全局字体样式，希望它用回浏览器默认的粗体大字。</p>
<h4 data-id="heading-8"><strong>示例：</strong></h4>
<p>假设浏览器默认样式是：<code>h1 { font-weight: bold; }</code></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 作者样式表 (您的代码) */</span>
<span class="hljs-selector-tag">h1</span> {
  <span class="hljs-comment">/* 覆盖了浏览器默认样式 */</span>
  <span class="hljs-attribute">font-weight</span>: normal; 
}

<span class="hljs-selector-class">.revert-demo</span> {
  <span class="hljs-comment">/* 撤销了上方的 font-weight: normal; */</span>
  <span class="hljs-attribute">font-weight</span>: revert;
}
</code></pre>
<p>在这个例子中，<code>.revert-demo</code> 元素会将 <code>font-weight</code> 恢复到 <strong>浏览器默认值</strong> (<code>bold</code>)，因为它撤销了作者样式表中的 <code>normal</code> 声明。</p>
<h2 data-id="heading-9">✅ 总结与应用建议</h2>

























<table><thead><tr><th align="left">关键字</th><th align="left">记忆点</th><th align="left">应用场景</th></tr></thead><tbody><tr><td align="left"><strong><code>initial</code></strong></td><td align="left"><strong>“绝对初始”</strong></td><td align="left">确保属性值是其 CSS 规范定义的<strong>原始默认值</strong>，不考虑上下文。</td></tr><tr><td align="left"><strong><code>unset</code></strong></td><td align="left"><strong>“智能重置”</strong></td><td align="left">恢复属性的<strong>自然继承行为</strong>（可继承则 <code>inherit</code>，不可继承则 <code>initial</code>）。</td></tr><tr><td align="left"><strong><code>revert</code></strong></td><td align="left"><strong>“撤销”</strong></td><td align="left">撤销作者样式，<strong>恢复到浏览器默认或用户样式</strong>。常用于希望保持浏览器默认外观的元素。</td></tr></tbody></table>
<p><strong>什么时候用哪个？</strong></p>
<ul>
<li>如果您想确保一个属性值是<strong>固定的、明确的 CSS 初始值</strong>，使用 <code>initial</code>。</li>
<li>如果您想让一个属性<strong>遵循其固有的继承规则</strong>（即，可继承的就继承，不可继承的就使用初始值），使用 <code>unset</code>。</li>
<li>如果您想<strong>撤销您的样式对某个元素默认外观的覆盖</strong>，恢复到浏览器提供的默认样式，使用 <code>revert</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战 · 进阶与职业发展：Web 全栈（Django / FastAPI）]]></title>    <link>https://juejin.cn/post/7575015480199118900</link>    <guid>https://juejin.cn/post/7575015480199118900</guid>    <pubDate>2025-11-22T04:39:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575015480199118900" data-draft-id="7575065455074574371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战 · 进阶与职业发展：Web 全栈（Django / FastAPI）"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-22T04:39:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战 · 进阶与职业发展：Web 全栈（Django / FastAPI）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T04:39:16.000Z" title="Sat Nov 22 2025 04:39:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Python 的职业化道路上，Web 开发几乎是绕不过的方向。从传统 MVC 框架到现代异步 API 服务，Python 的 Web 生态主要由两大代表占据：<strong>Django</strong> 与 <strong>FastAPI</strong>。</p>
</blockquote>
<p>它们风格迥异，却都有着非常强的生产力。本篇带你从架构理念、应用场景、核心特性到工程实践，全面了解它们在 Web 全栈开发中的定位。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Django：成熟的“全家桶” Web Framework</strong></h2>
<p>如果你想构建一个<strong>完整、严肃、功能完善的 Web 网站</strong>，那么 Django 是最稳妥的选择。它遵循 MTV 模式，并且带着大量“开箱即用”的组件：</p>
<ul>
<li>ORM（数据库层）</li>
<li>模板系统（前端渲染）</li>
<li>用户认证系统</li>
<li>中间件机制</li>
<li>Admin 后台</li>
<li>缓存系统</li>
<li>Form / 表单验证</li>
<li>会话管理等成熟机制</li>
</ul>
<p>这种设计让它一直是企业级 Web 项目的首选，尤其适合：</p>
<p>✔ CMS / 企业网站
✔ 电商系统
✔ 内部管理平台（ERP/CRM）
✔ 内容发布系统
✔ 需要账户体系、权限的项目</p>
<hr/>
<h3 data-id="heading-1"><strong>1. Django 的架构优势</strong></h3>
<h4 data-id="heading-2"><strong>（1）高集成度：无需自行挑选依赖</strong></h4>
<p>Django 的核心价值之一就是让开发者<strong>专注业务，而不是框架搭建</strong>。</p>
<p>一个简单命令就能初始化项目：</p>
<pre><code class="hljs language-bash" lang="bash">django-admin startproject mysite
</code></pre>
<p>用户体系、Admin 后台、ORM 全都自带，基本不用操心“装一堆库”。</p>
<hr/>
<h4 data-id="heading-3"><strong>（2）Django ORM：开发效率极高</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span>(models.Model):
    title = models.CharField(max_length=<span class="hljs-number">100</span>)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>)
</code></pre>
<p>增删改查完全不用写 SQL：</p>
<pre><code class="hljs language-python" lang="python">Article.objects.create(title=<span class="hljs-string">"Hello"</span>, content=<span class="hljs-string">"World"</span>)
</code></pre>
<p>对于复杂项目，这种 ORM 能省掉大量样板代码。</p>
<hr/>
<h4 data-id="heading-4"><strong>（3）Admin 后台：企业项目必备</strong></h4>
<p>Django Admin 是一个超级生产力工具：</p>
<ul>
<li>自动生成增删改查界面</li>
<li>自动分页、搜索、过滤</li>
<li>自动管理权限</li>
</ul>
<p>只需几行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin
<span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> Article

admin.site.register(Article)
</code></pre>
<p>就拥有一个可用的后台管理系统。</p>
<hr/>
<h4 data-id="heading-5"><strong>（4）扩展性与生态</strong></h4>
<p>Django 拥有成熟的第三方生态：</p>
<ul>
<li>DRF（构建 REST API）</li>
<li>Django Debug Toolbar</li>
<li>Django Channels（WebSocket）</li>
<li>Celery（任务队列）</li>
<li>Wagtail / Django-CMS</li>
</ul>
<p>适合构建复杂/长期维护的项目。</p>
<hr/>
<h2 data-id="heading-6"><strong>二、FastAPI：异步时代的高性能接口框架</strong></h2>
<p>FastAPI 是近年来增长最快的 Python Web 框架，它代表了现代 API 设计理念：</p>
<p><strong>高性能 + 异步 + 类型提示 + 自动文档</strong></p>
<p>非常适合：</p>
<p>✔ 高并发 API 服务
✔ 微服务架构
✔ AI / 数据接口
✔ 移动端后端
✔ 需要自动化文档的项目（Swagger UI）</p>
<hr/>
<h3 data-id="heading-7"><strong>1. FastAPI 的核心优势</strong></h3>
<h4 data-id="heading-8"><strong>（1）性能强：基于 Starlette + Pydantic</strong></h4>
<p>FastAPI 是目前性能最强的 Python Web 框架之一，接近 Node.js 和 Go。</p>
<p>它的异步特性让它可以轻松支撑高并发请求：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

app = FastAPI()

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/hello"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"msg"</span>: <span class="hljs-string">"world"</span>}
</code></pre>
<hr/>
<h4 data-id="heading-9"><strong>（2）自动生成 Swagger / Redoc 文档</strong></h4>
<p>只需访问：</p>
<pre><code class="hljs language-bash" lang="bash">/docs
</code></pre>
<p>就能看到完整的 API 文档，所有参数、返回值都自动推导。</p>
<hr/>
<h4 data-id="heading-10"><strong>（3）Pydantic 数据验证非常强大</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    age: <span class="hljs-built_in">int</span>
</code></pre>
<p>请求体验证直接写成数据模型，大幅提升可靠性。</p>
<hr/>
<h4 data-id="heading-11"><strong>（4）更现代的代码风格</strong></h4>
<p>FastAPI 鼓励：</p>
<ul>
<li>类型注解</li>
<li>异步 async/await</li>
<li>依赖注入模式（DI）</li>
<li>面向微服务架构的组织方式</li>
</ul>
<p>与当代工程趋势高度契合。</p>
<hr/>
<h2 data-id="heading-12"><strong>三、两者差异：你应该选择哪个？</strong></h2>













































<table><thead><tr><th>项目需求</th><th>Django</th><th>FastAPI</th></tr></thead><tbody><tr><td>传统 Web 网站</td><td>✔✔ 最适合</td><td>一般</td></tr><tr><td>复杂业务系统（权限、后台）</td><td>✔✔ 最优</td><td>一般</td></tr><tr><td>微服务 / API</td><td>可用（DRF）</td><td>✔✔ 最优</td></tr><tr><td>高并发场景</td><td>一般</td><td>✔✔ 更强</td></tr><tr><td>快速开发</td><td>✔（有全家桶）</td><td>✔（较少样板）</td></tr><tr><td>自动化 API 文档</td><td>需要 DRF</td><td>内置</td></tr><tr><td>异步支持</td><td>不完美</td><td>完美</td></tr></tbody></table>
<p>一句话总结：</p>
<p><strong>Django 适合长周期、复杂业务的“企业级系统”；
FastAPI 适合现代、高性能 API 服务与微服务架构。</strong></p>
<p>在真实团队中，两者经常搭配使用：</p>
<ul>
<li><strong>后台管理：Django（Admin + ORM）</strong></li>
<li><strong>高性能 API：FastAPI（并发友好）</strong></li>
</ul>
<hr/>
<h2 data-id="heading-13"><strong>四、实战：项目结构对比（专业级示例）</strong></h2>
<h3 data-id="heading-14"><strong>1. Django 项目结构</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">mysite/
    manage.py
    settings.py
    urls.py
    apps/
        blog/
            models.py
            views.py
            urls.py
            admin.py
    templates/
    <span class="hljs-type">static</span>/
</code></pre>
<hr/>
<h3 data-id="heading-15"><strong>2. FastAPI 项目结构（推荐）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">app/
    main.py
    api/
        v1/
            users.py
            items.py
    models/
        user.py
    core/
        config.py
    services/
        user_service.py
</code></pre>
<p>清晰、可扩展、适合大型项目。</p>
<hr/>
<h2 data-id="heading-16"><strong>五、数据库、异步、权限：全栈工程关键点</strong></h2>
<h4 data-id="heading-17"><strong>Django：ORM + Admin 基本搞定全局业务</strong></h4>
<ul>
<li>权限管理成熟</li>
<li>ORM 强大</li>
<li>Sessions/Cache 中间件完善</li>
</ul>
<p>适合需要管理后台的系统。</p>
<hr/>
<h4 data-id="heading-18"><strong>FastAPI：异步友好的数据库工具</strong></h4>
<p>常见选择：</p>
<ul>
<li>SQLAlchemy + AsyncSession</li>
<li>Tortoise ORM</li>
<li>Prisma-Python</li>
</ul>
<hr/>
<h4 data-id="heading-19"><strong>API 权限（FastAPI）</strong></h4>
<p>FastAPI 中使用依赖注入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_token</span>(<span class="hljs-params">token: <span class="hljs-built_in">str</span> = Header(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">if</span> token != <span class="hljs-string">"VALID"</span>:
        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">403</span>)
</code></pre>
<p>非常灵活。</p>
<hr/>
<h2 data-id="heading-20"><strong>六、部署：工程团队必须掌握的知识点</strong></h2>
<h4 data-id="heading-21"><strong>Django 部署</strong></h4>
<p>推荐：</p>
<ul>
<li>Nginx + Gunicorn / uWSGI</li>
<li>Celery + Redis（任务队列）</li>
<li>Supervisor / systemd 管理进程</li>
</ul>
<p>适合传统单体架构。</p>
<hr/>
<h4 data-id="heading-22"><strong>FastAPI 部署</strong></h4>
<p>推荐：</p>
<ul>
<li>Nginx + Uvicorn / Hypercorn</li>
<li>Docker（微服务最佳）</li>
<li>Kubernetes（大规模集群）</li>
</ul>
<p>FastAPI 对容器化支持更好。</p>
<hr/>
<h2 data-id="heading-23"><strong>七、总结：真正的 Python Web 全栈能力</strong></h2>
<p>成为专业 Python 工程师，你应该掌握：</p>
<p>✔ Django：打造复杂业务系统与后台
✔ DRF：Django API 化
✔ FastAPI：高性能 API 服务
✔ ORM（Django ORM / SQLAlchemy）
✔ 前后端分离（Vue / React）
✔ Nginx / Docker 部署流程</p>
<p>而 Django + FastAPI 的组合，能覆盖绝大多数企业级场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌳 Claude `code/worktree` 命令最佳实践指南]]></title>    <link>https://juejin.cn/post/7575050949959614500</link>    <guid>https://juejin.cn/post/7575050949959614500</guid>    <pubDate>2025-11-22T02:30:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949959614500" data-draft-id="7575067409416077355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌳 Claude `code/worktree` 命令最佳实践指南"/> <meta itemprop="keywords" content="人工智能,Claude,Trae"/> <meta itemprop="datePublished" content="2025-11-22T02:30:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌳 Claude `code/worktree` 命令最佳实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:30:09.000Z" title="Sat Nov 22 2025 02:30:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧭 一、前言：当AI开始「搬砖」</h2>
<p>在与 <strong>Claude</strong>（Anthropic 开发的AI助手）协作开发代码时，<code>code/worktree</code> 命令是一个极其有趣的工具。<br/>
这一命令的意图，是让 AI 和开发者在一个<strong>隔离但同步的工作区</strong>中协同修改、组织项目，就像是给 Claude 自己准备了一个“虚拟分支工位”。</p>
<p>简言之：</p>
<blockquote>
<p><code>code/worktree</code> ≈ “让 Claude 不破坏主代码库就能实验新功能的魔法空间”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🧩 二、命令的逻辑本质与底层哲学</h2>
<p>从底层原理讲，它与 Git 的 <strong>worktree</strong> 思想一致：<br/>
创建一个共享 <code>.git</code> 元数据但独立工作目录的副本。<br/>
这种设计既保留了版本控制的完整性，又让多场景开发成为可能。</p>
<p>在 Claude 体系中，<code>code/worktree</code> 的哲学是这样的：</p>
<ol>
<li><strong>Claude 不直接改主干（main branch）</strong> 。</li>
<li><strong>每次生成代码，都在临时工作区中修改。</strong></li>
<li><strong>开发者可以选择合入、重构或丢弃。</strong></li>
</ol>
<p>换句话说：Claude 是文明的，不会直接在你的主分支上乱动。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 三、基础语法与结构</h2>
<p>假设你已经将项目以 Claude 的 workspace 方式加载。<br/>
此时使用命令：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree create feature/refactor-api
</code></pre>
<p>Claude 将：</p>
<ol>
<li>创建一个 <code>feature/refactor-api</code> 的工作区。</li>
<li>将当前 HEAD 的代码复制到新目录（但共享 <code>.git</code> 数据）。</li>
<li>在该工作区下生成、修改、运行代码。</li>
</ol>
<p>完成后，你可以通过：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree merge feature/refactor-api
</code></pre>
<p>将改动安全地合并回主工作区。</p>
<hr/>
<h2 data-id="heading-3">🧰 四、实践案例：让 Claude 改造你的 Web 应用</h2>
<h3 data-id="heading-4">🧪 场景示例</h3>
<p>你有一个 Node.js + React 的项目：</p>
<pre><code class="hljs language-css" lang="css">my-app/
  ├── <span class="hljs-attribute">src</span>/
  ├── package<span class="hljs-selector-class">.json</span>
  └── server<span class="hljs-selector-class">.js</span>
</code></pre>
<p>你希望 Claude 帮你：</p>
<blockquote>
<p>将 Express server 改为支持 WebSocket 通信。</p>
</blockquote>
<h3 data-id="heading-5">🦾 操作流程</h3>
<ol>
<li>
<p><strong>创建 Claude 工作区</strong></p>
<pre><code class="hljs language-bash" lang="bash">/worktree create feature/add-websocket
</code></pre>
</li>
<li>
<p><strong>Claude 进入专属工位</strong></p>
<p>Claude 会自动克隆代码结构到一个新工作区。<br/>
它的修改操作不会影响主分支。</p>
</li>
<li>
<p><strong>让 Claude 修改代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">/edit In feature/add-websocket:
Add WebSocket support to server.js
</code></pre>
</li>
<li>
<p><strong>Claude 编辑并展示差异</strong></p>
<p>Claude 会用 diff 形式展示修改区域，开发者确认后才会落地。</p>
</li>
<li>
<p><strong>测试和评审</strong></p>
<p>你可以让 Claude 执行单元测试命令：</p>
<pre><code class="hljs language-bash" lang="bash">/run npm <span class="hljs-built_in">test</span>
</code></pre>
<p>或让它自动运行 ESLint 检查。</p>
</li>
<li>
<p><strong>合并成果</strong></p>
<p>一旦满意，可以：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree merge feature/add-websocket
</code></pre>
<p>完成集成后可使用：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree delete feature/add-websocket
</code></pre>
<p>清理隔离区，保持工作区整洁。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">🧠 五、底层实现建议（结合Git机制）</h2>
<blockquote>
<p>Claude <code>code/worktree</code> 的实现可被理解为：通过<strong>AI控制的Git临时分支</strong>执行抽象的工作流。</p>
</blockquote>
<p>在底层实现上，可复用以下类 Git 逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 Claude 的 code/worktree 流程</span>
<span class="hljs-keyword">const</span> { execSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git worktree add ../<span class="hljs-subst">${branch}</span> <span class="hljs-subst">${branch}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🌿 Created worktree: <span class="hljs-subst">${branch}</span>`</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git checkout main`</span>);
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git merge <span class="hljs-subst">${branch}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ Merged <span class="hljs-subst">${branch}</span> into main`</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git worktree remove ../<span class="hljs-subst">${branch}</span> --force`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🧹 Deleted worktree: <span class="hljs-subst">${branch}</span>`</span>);
}
</code></pre>
<p>Claude 在其内部系统中执行了类似逻辑，但将其关联到 AI 文件缓存和编辑上下文管理中，使其能够：</p>
<ul>
<li>高速加载关联文件；</li>
<li>在隔离环境中编译；</li>
<li>支持多版本回溯。</li>
</ul>
<hr/>
<h2 data-id="heading-7">⚖️ 六、最佳实践建议（重磅精华）</h2>



































<table><thead><tr><th>目标</th><th>建议实践</th><th>Claude命令示例</th></tr></thead><tbody><tr><td>快速试验</td><td>为重大重构代码预留独立worktree</td><td><code>/worktree create feature/new-ui</code></td></tr><tr><td>审查代码</td><td>使用 Claude 生成diff并由人工确认</td><td><code>/diff feature/new-ui</code></td></tr><tr><td>自动化测试</td><td>将测试脚本注册为 Hook</td><td><code>/test run feature/new-ui</code></td></tr><tr><td>并行开发</td><td>为每个模块分配 Claude 实例与独立 worktree</td><td><code>/worktree create feature/auth-refactor</code></td></tr><tr><td>安全管理</td><td>定期让 Claude 清理过期工作区</td><td><code>/worktree prune</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">🧩 七、冷知识与幽默插曲</h2>
<ul>
<li>
<p>有人问：为什么 Claude 不直接改主分支？<br/>
🧑‍💻 回答：<strong>因为他懂版本管理的礼仪。</strong></p>
</li>
<li>
<p>一个典型的错误用法是：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree create main-feature
</code></pre>
<p>Claude 会温柔地提醒：<br/>
<em>“您刚试图改写历史，请冷静。”</em></p>
</li>
<li>
<p>在大型项目中，Claude 的 <code>code/worktree</code> 策略就像多线程调度：</p>
<blockquote>
<p>每个工作区就是一个线程，每个线程都在为未来的主干静静努力。</p>
</blockquote>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">🛠 八、结语：让Claude成为你的「安全编辑器」</h2>
<p>合理使用 <code>code/worktree</code>，本质上是让 Claude 从一个“AI助手”升级为<strong>协同式副开发者（Co-Developer）</strong> 。<br/>
它不只是写代码，而是遵守开发流程，与人类团队共生。</p>
<p>当 Claude 生成代码的同时，还能保证主分支的整洁与安全时，<br/>
你会发现开发变得轻盈、策略变得优雅。</p>
<hr/>
<blockquote>
<p>✨ <strong>最终箴言：</strong></p>
<p>“聪明的开发者自己写代码，更聪明的开发者教 Claude 在另一个 world 里写。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略]]></title>    <link>https://juejin.cn/post/7575022279568588841</link>    <guid>https://juejin.cn/post/7575022279568588841</guid>    <pubDate>2025-11-22T02:26:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575022279568588841" data-draft-id="7575050949959581732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略"/> <meta itemprop="keywords" content="人工智能,Trae"/> <meta itemprop="datePublished" content="2025-11-22T02:26:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:26:48.000Z" title="Sat Nov 22 2025 02:26:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧊 一、引言：当AI还没“醒来”</h2>
<p>在AIGC（AI Generated Content）浪潮中，我们常常遇到这样一个尴尬时刻：</p>
<blockquote>
<p>产品上线第一天，用户点开页面，AI模型沉默如山。<br/>
团队眨眼互望，一句“稍等加载”成为高频台词。</p>
</blockquote>
<p>这就是我们常说的——<strong>AIGC模型的冷启动问题</strong>。<br/>
别被这个词吓到，它不是什么玄学，而是计算机系统在面对<strong>初始资源匮乏、模型未热身、数据不足、请求未定型</strong>时的那种<em>灵魂冰点</em>。<br/>
想象一下，AI 模型还在喝它的第一杯咖啡，而用户已经在敲键盘催命。</p>
<hr/>
<h2 data-id="heading-1">🧬 二、冷启动的本质：一场从零到「上线」的进化</h2>
<p>从底层原理来看，AIGC 模型的冷启动过程包含三个阶段：</p>
<ol>
<li><strong>计算冷</strong>：<br/>
模型参数巨大（动辄十亿个参数），首次加载模型时需要把这些参数从磁盘搬进显存。<br/>
就像一个懒惰的巨人——每一层神经都得先伸个懒腰。</li>
<li><strong>网络冷</strong>：<br/>
如果模型部署在云端，那就有「延迟初恋」这一说。第一次请求往往要花费额外的握手时间、容器唤醒、负载平衡。</li>
<li><strong>语义冷</strong>：<br/>
刚上线的模型还不知道你的业务习惯，比如“APP内提示语风格”。<br/>
它的第一句话，可能像刚出厂的R2-D2一样——充满机械的纯真。</li>
</ol>
<hr/>
<h2 data-id="heading-2">⚙️ 三、从底层出发：技术支撑策略</h2>
<p>冷启动并不是宿命，而是可以用技术“焐热”的。以下是常用的支撑策略，背后各自有着深厚的系统哲学。</p>
<hr/>
<h3 data-id="heading-3">🚀 1. 模型预热（Warm-Up）</h3>
<p>思路很简单：</p>
<blockquote>
<p>不要等到用户来了，才去唤醒模型。</p>
</blockquote>
<p>在Web应用启动后，我们可以模拟一组虚假的 API 调用请求，让模型提前加载。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 🧊 AIGC 冷启动预热脚本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">warmUpModel</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fakePrompts = [
    <span class="hljs-string">"你好，请简单介绍一下你自己。"</span>,
    <span class="hljs-string">"生成一句充满科技感的口号。"</span>,
    <span class="hljs-string">"写一句让程序员春风得意的俏皮话。"</span>
  ];

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🚀 模型预热开始 ..."</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> prompt <span class="hljs-keyword">of</span> fakePrompts) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/generate"</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ prompt }),
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> }
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔥 已预热：<span class="hljs-subst">${prompt}</span>`</span>);
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 模型已成功热身！"</span>);
}

<span class="hljs-title function_">warmUpModel</span>();
</code></pre>
<blockquote>
<p>💡 <em>小贴士：这段代码相当于提前帮AI打了三瓶咖啡。</em></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">☁️ 2. 按需加载 + 模型分层缓存</h3>
<p>底层策略在这里显得优雅又“狡猾”：</p>
<ul>
<li>把模型权重分层存储，比如只加载用于启动的核心层。</li>
<li>其余部分按需加载，动态补齐。</li>
<li>对于常见Token结果建立<strong>向量缓存</strong>，让模型“记忆”高频回答。</li>
</ul>
<p>这类似于<strong>懒加载+缓存继承</strong>的策略组合。<br/>
如果程序是舞台，那缓存层就是那个“技术黑幕”，在后台默默挡住冷风。</p>
<hr/>
<h3 data-id="heading-5">🧞 3. 灰度 + 蒙特卡洛采样（经验数据啤酒算法）</h3>
<p>早期阶段，不妨给模型“喂”一些业务数据采样。<br/>
这里通常通过经验分布采样策略实现，使模型在推理阶段有更好的初始收敛。</p>
<p>通俗点说：</p>
<blockquote>
<p>我们让模型在上岗前，提前实习几天。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">🕸️ 4. 边缘节点缓存与轻量推理引擎</h3>
<p>很多人忽略了网络拓扑在冷启动中的作用。<br/>
若用户在日本，而你的模型服务器在硅谷，那延迟就像打越洋电话。</p>
<p>解决方案是 <strong>部署边缘节点推理代理</strong>：</p>
<ul>
<li>前端就近调用轻量引擎（Mini-Inference），处理通用请求。</li>
<li>再由主模型处理复杂请求。</li>
<li>用户感受到的不是“冷启动”，而是“热响应”。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧠 四、技术之外：冷启动的哲学与幽默</h2>
<p>冷启动，归根结底是人与系统之间的一场信任测试。<br/>
有时候，AI不是不想快，而是太害羞。它还没准备好展示它的全部魅力。</p>
<p>从操作系统到语言运行时，从HTTP握手到显存调度，每一次延迟都像是计算机世界深处那种——</p>
<blockquote>
<p>“我正在努力加载灵魂，请稍等片刻。”</p>
</blockquote>
<p>从这个角度看，每一个冷启动，<br/>
其实就是人工智能世界的<strong>黎明微光</strong>。🌄</p>
<hr/>
<h2 data-id="heading-8">🧩 五、最后的小结与温柔暴论</h2>






























<table><thead><tr><th>阶段</th><th>问题</th><th>对策</th></tr></thead><tbody><tr><td>模型加载</td><td>初始化慢</td><td>预热请求、延迟缓存</td></tr><tr><td>网络延迟</td><td>通信慢</td><td>边缘推理、Cloudflare Worker代理</td></tr><tr><td>业务不适配</td><td>输出生硬</td><td>向量缓存、蒸馏训练</td></tr><tr><td>用户体验差</td><td>页面卡顿</td><td>Skeleton UI、渐进渲染</td></tr></tbody></table>
<blockquote>
<p>🗣️ <strong>暴论总结</strong>：<br/>
真正的冷启动不是模型冷，是我们没教会它怎么热。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🎬 尾声：当AI开始呼吸</h2>
<p>当第一位用户顺滑地扫描二维码、浏览页面，AI回应流畅如诗时，<br/>
你听到的不只是HTTP返回200，而是一句轻声的问候：</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome浏览器自带翻译的诡异Bug：ID翻译后竟然变化了]]></title>    <link>https://juejin.cn/post/7574978545144856611</link>    <guid>https://juejin.cn/post/7574978545144856611</guid>    <pubDate>2025-11-21T18:09:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978545144856611" data-draft-id="7574978545144840227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome浏览器自带翻译的诡异Bug：ID翻译后竟然变化了"/> <meta itemprop="keywords" content="前端,Chrome"/> <meta itemprop="datePublished" content="2025-11-21T18:09:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天渺工作室"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102179325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome浏览器自带翻译的诡异Bug：ID翻译后竟然变化了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102179325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天渺工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T18:09:11.000Z" title="Fri Nov 21 2025 18:09:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前负责的项目主打海外业务，总免不了和多语言打交道。但最近我在Vite+Vue3+Element Plus技术栈的项目里，遇到了一个堪称“玄学”的bug——Chrome浏览器自带翻译功能，居然能把表格里的数字ID直接改了！从印度同事到国内运营，两次触发都让我摸不着头脑，今天把整个过程记录下来，求大佬们看看这到底是怎么回事。</p>
<h2 data-id="heading-0">一、两次“诡异漂移”：翻译按钮成了ID篡改器</h2>
<p>我们的后台管理系统很明确：部分页面根元素设为<code>lang="zh"</code>（中文界面），部分设为<code>lang="en"</code>（英文界面），语言标识没搞混也没遗漏。</p>
<h3 data-id="heading-1">第一次：印度同事的英文翻译触发</h3>
<p>年初，负责海外业务的印度同事反馈：“搜索出来的广告数据有问题，Ad ID从10111872变成10111873了”。我第一时间查接口，返回的ID明明是正确的10111872；再看前端代码，就是最常规的Element Plus表格用法，没有任何多余计算。</p>
<p>远程连接他的电脑才发现，他把中文界面用Chrome右键翻译成了英文——我让他关闭翻译功能刷新页面，ID瞬间恢复10111872；重新开启翻译，数字又跳成10111873。当时以为是个案，没深查，只提醒他暂时不用翻译。</p>
<h3 data-id="heading-2">第二次：国内运营的中文翻译触发</h3>
<p>前天，国内运营同事在英文界面操作时，把页面翻译成中文，结果历史重演：表格里的ID 20011872直接变成20011873。这次我确定不是偶然，而是Chrome翻译和Element Plus表格的“兼容性陷阱”。</p>
<p>贴一下我们的核心代码，真的就是最基础的<code>el-table</code>配置，没有任何花里胡哨的操作：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"orderTableData"</span>
      <span class="hljs-attr">border</span>
      <span class="hljs-attr">stripe</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%"</span>
    &gt;</span>
      <span class="hljs-comment">&lt;!-- 普通列：Ad Name翻译正常，无异常 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"Ad Name"</span>  
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"adName"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span>
      /&gt;</span>
      
      <span class="hljs-comment">&lt;!-- 异常列：开启Chrome翻译后，该列adId数值会发生漂移（如10111872→10111873） --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"Ad ID"</span>  
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"adId"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElTable</span>, <span class="hljs-title class_">ElTableColumn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;

<span class="hljs-comment">// 模拟接口返回数据，真实场景为接口拉取</span>
<span class="hljs-keyword">const</span> orderTableData = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">adId</span>: <span class="hljs-number">10111872</span>, <span class="hljs-attr">adName</span>: <span class="hljs-string">"Summer Promotion"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"已上线"</span> },
  { <span class="hljs-attr">adId</span>: <span class="hljs-number">10111172</span>, <span class="hljs-attr">adName</span>: <span class="hljs-string">"New Product Launch"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"待审核"</span> },
  { <span class="hljs-attr">adId</span>: <span class="hljs-number">10111272</span>, <span class="hljs-attr">adName</span>: <span class="hljs-string">"Member Exclusive"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"已下线"</span> }
]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">二、排查过程：绕了一圈，排除所有常规可能</h2>
<p>为了找到问题根源，我几乎把能排查的点都过了一遍，但结果全是“正常”：</p>
<ol>
<li><strong>接口与数据层面</strong>：Network面板反复确认，接口返回的adId是正确值，没有被篡改；前端接收数据后也没有做任何运算，直接赋值给表格数据源。</li>
<li><strong>本地与多设备测试</strong>：我换了自己的Windows、MacBook，又找了5个同事用不同系统（Windows10/11、macOS）测试，无论怎么开翻译，ID都纹丝不动。</li>
<li><strong>浏览器环境排查</strong>：远程检查触发异常的两台电脑，Chrome都是最新版本，没有安装任何可疑插件，清除缓存、重启浏览器后，问题依然存在。</li>
<li><strong>代码与依赖检查</strong>：Element Plus版本是稳定版，没有兼容性问题；表格没有自定义渲染函数，也没有使用任何修改DOM的指令或插件。</li>
</ol>
<p>排查到最后，我甚至怀疑是不是“量子纠缠”——直到发现两次异常都有一个共同触发条件：<strong>Chrome浏览器开启页面翻译</strong>。</p>
<h2 data-id="heading-4">三、解决方案：给ID加“翻译豁免权”</h2>
<p>既然确定是翻译功能搞的鬼，就顺着这个方向找解决方案。查HTML标准发现，HTML5原生有个<code>translate</code>属性，专门控制元素是否参与翻译——给元素加<code>translate="no"</code>，浏览器就会跳过该元素的翻译处理。</p>
<p>针对表格ID列做了修改，核心是给ID所在的元素添加这个属性，修改后的代码如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 修复后的ID列代码，其他列不变 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Ad ID"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"scope"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 关键修复：添加translate="no"，禁止Chrome翻译该节点，避免ID数值被篡改 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ad-id"</span> <span class="hljs-attr">translate</span>=<span class="hljs-string">"no"</span>&gt;</span>{{ scope.row.adId }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
</code></pre>
<p>把修改后的代码发给出问题的同事，他们开启翻译再测试——ID稳稳地显示正确值，再也没有出现“漂移”。这个临时方案虽然解决了问题，但我的疑惑更重了。</p>
<h2 data-id="heading-5">四、疑惑：这到底是Chrome的bug，还是我漏了什么？</h2>
<p>虽然问题解决了，但几个疑问始终萦绕在我心头，想借这篇文章问问各位大佬：</p>
<ol>
<li>为什么只有特定设备触发这个问题？同样的Chrome版本、同样的操作，大部分设备正常，而触发的同事电脑上设备必现，难道和浏览器的某些隐藏配置有关？</li>
<li>为什么ID篡改有固定规律？两次异常都是ID末尾+1，不是随机乱改，这背后有没有特定的DOM处理逻辑？</li>
<li>这是Chrome翻译的bug，还是Element Plus表格的DOM结构容易被翻译器误判？有没有更根本的解决办法，而不是给每个关键节点加豁免？</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode插件: 自动临时分配Theme以区分不同窗口]]></title>    <link>https://juejin.cn/post/7575022279567540265</link>    <guid>https://juejin.cn/post/7575022279567540265</guid>    <pubDate>2025-11-21T16:56:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575022279567540265" data-draft-id="7575050949958664228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode插件: 自动临时分配Theme以区分不同窗口"/> <meta itemprop="keywords" content="前端,Visual Studio Code,TypeScript"/> <meta itemprop="datePublished" content="2025-11-21T16:56:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洗澡水加冰"/> <meta itemprop="url" content="https://juejin.cn/user/191729824978955"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode插件: 自动临时分配Theme以区分不同窗口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191729824978955/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洗澡水加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T16:56:09.000Z" title="Fri Nov 21 2025 16:56:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VSCode插件：自动临时分配Theme或者状态栏以区分不同窗口</h2>
<p>日常开发中经常同时打开多个项目，多个VS Code窗口堆在任务栏，每次切换都要一个个点开看看到底是哪个项目。尤其是在利用AI写项目时，多个窗口管理同一个程序的多个版本实现，同名同主题就容易写乱了。</p>
<p>想着能不能找到一个办法来帮助我区分不同的窗口与不同的项目，在我打开多个窗口的时候，能够自动分配状态帮我区分。感觉可以通过VSCode插件来做到这个功能，于是诞生了<code>Auto Themer</code>这个项目。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dseanz-hahaha.auto-themer" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=seanz-hahaha.auto-themer" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></p>
<h3 data-id="heading-1">Auto Themer是什么？</h3>
<p>简单来说，这就是一个<strong>自动给不同VS Code窗口分配不同视觉标识</strong>的插件，检查到多个窗口并且主题相同时，采用不同的策略来辅助区分窗口。它有两种工作模式：</p>
<h4 data-id="heading-2">模式一：主题区分法</h4>
<p>给每个窗口自动分配不同的配色主题，一眼就能看出区别：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf41bf78a3945c3b00a2d64b8271e70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSX5r6h5rC05Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764348969&amp;x-signature=jlP1DEJwCKdkPH0Q5Dw%2BiMkj%2Frc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>当前窗口打开项目A用默认主题，再新开以窗口的项目B时主题冲突，会自动更换别的主题</li>
<li>可以自己选择主题，也可以随机分配主题</li>
<li>支持通过工作区路径将主题持久化，下次打开项目会自动切换</li>
<li>关闭窗口或者切换工作区时，设置的主题状态会被重置——意味着同一个项目每一次打开可能都是不同的主题配置</li>
</ul>
<h4 data-id="heading-3">模式二：状态栏魔法</h4>
<p>有的人不喜欢更改Theme，插件提供第二种方式：修改底部状态栏。会给每个窗口的底部状态栏设置不同的颜色和文字标签：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b9cbf606e26436d9ef499c93c25343b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSX5r6h5rC05Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764348969&amp;x-signature=rNNp1CMlw0nUBnc9H5cdumlDHyE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>当前窗口打开项目A用默认主题，再新开以窗口的项目B时主题冲突，会自动修改窗口B的底部状态栏与文字标签</li>
<li>可以自己选择底部状态栏的颜色，也可以点击自动分配下一个颜色</li>
<li>支持通过工作区路径将状态栏的文字标签持久化，下次打开项目会自动切换。比如 生产环境项目 → "PROD"标签</li>
<li>关闭窗口或者切换工作区时，设置的底部状态栏会被重置——意味着同一个项目每一次打开可能都是不同的底部状态栏配置</li>
</ul>
<h3 data-id="heading-4">怎么使用？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dseanz-hahaha.auto-themer" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=seanz-hahaha.auto-themer" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a> 下载插件并安装。</p>
<ul>
<li>进入插件设置，配置<code>autoThemer.windowsThreshold</code>，打开的窗口数超过该阈值时才会自动分配主题。</li>
<li>配置 <code>autoThemer.conflictResolution</code> ,选择<code>theme</code>或<code>statusBar</code>，分别表示通过主题或底部状态栏区分窗口。</li>
<li>其他操作可以通过侧边栏的插件面板设置，如切换主题、切换状态栏颜色、持久化当前工作区的主题映射、持久化底部状态栏标签映射。</li>
<li>新窗口打开工作区后，自动检测并分配主题或者状态栏到<code>.vscode/settings.json</code>；切换工作区或者关闭窗口时，会自动重置.vscode/settings.json的colorTheme。</li>
</ul>
<h4 data-id="heading-5">插件面板功能说明</h4>
<ul>
<li>select theme: 选择当前窗口的主题</li>
<li>random theme: 随机为当前窗口分配主题</li>
<li>reassign theme: 重新分配当前窗口的主题</li>
<li>persist theme: 持久化当前窗口的主题映射</li>
<li>show mappings: 查看工作区与主题的映射关系</li>
<li>pick status bar scheme: 选择当前窗口的底部状态栏颜色配置(仅内置)</li>
<li>persist status bar: 持久化当前窗口的底部状态栏标签映射</li>
</ul>
<h4 data-id="heading-6">配置</h4>
<p>在 VSCode 设置中配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"autoThemer.enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoThemer.conflictResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"theme"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoThemer.windowsThreshold"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoThemer.builtinThemes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoThemer.themeMappingsText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/my/pro-dev: Kimbie Dark; /easy/hc: Kimbie Dark"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoThemer.statusBarMappingsText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/my/pro-dev: 自定义标签; /easy/hc: 自定义项目"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>说明：
<code>themeMappingsText</code> 使用分号分隔的 <code>路径: 主题</code> 文本，插件在内存中解析并使用该映射。
<code>statusBarMappingsText</code> 使用分号分隔的 <code>路径: 标签</code> 文本，插件在内存中解析并使用该映射。</p>
<hr/>
<p>接下来聊聊实现原理。</p>
<h3 data-id="heading-7">实现原理</h3>
<p>插件会在VS Code的全局存储中维护一个基于磁盘文件的窗口实例协调系统，所有窗口通过这个机制来"协商"谁用什么主题/颜色。当检测到多窗口场景时，它会：</p>
<ol>
<li>扫描当前活动窗口</li>
<li>检查是否有持久化映射配置</li>
<li>给没有映射的窗口分配唯一标识</li>
<li>定期检测冲突并处理</li>
<li>窗口关闭时自动清理配置</li>
</ol>
<p>具体实现上，它通过修改工作区的<code>.vscode/settings.json</code>来应用主题或颜色配置，关闭窗口时会自动重置，不会影响项目的原始配置。</p>
<h3 data-id="heading-8">总结</h3>
<p><code>Auto Themer</code> 为了解决一个看似简单但确实很影响效率的问题——区分多个项目窗口，支持通过Theme区分或者通过StatusBar区分，可以自动切换配色以便区分，并强调临时状态管理与状态重置，也支持状态持久化。</p>
<p>通过简单的配置就可以启动功能，欢迎使用，也可以提PR。(—— 一个不怎么写前端的开发者:)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[准备手写Simple Raft（二）: 跑通最基本的Leader选举]]></title>    <link>https://juejin.cn/post/7574978545144938531</link>    <guid>https://juejin.cn/post/7574978545144938531</guid>    <pubDate>2025-11-22T00:49:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978545144938531" data-draft-id="7574992086715826191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="准备手写Simple Raft（二）: 跑通最基本的Leader选举"/> <meta itemprop="keywords" content="后端,Raft"/> <meta itemprop="datePublished" content="2025-11-22T00:49:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            准备手写Simple Raft（二）: 跑通最基本的Leader选举
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T00:49:26.000Z" title="Sat Nov 22 2025 00:49:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者背景：20年IT一线开发经验，15年架构师经验。擅长分布式、微服务、搜索引擎，手写过各类中间件。曾对Jacoco、夜莺等进行二次开发，负责过200多个节点的大规模集群，涉及K8s、微服务监控、多个中间件的运维。自研过加解密中间件，现服务于一家金融公司，担任架构师。</p>
</blockquote>
<p><strong>完整代码已开源：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-raft" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-raft" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a>   本章代码分支：ch2</p>
<hr/>
<p>上一篇讲了Raft的核心思想，这篇开始写代码。</p>
<p>从理论到实现是最难跨越的鸿沟。Nacos的JRaft有5万行代码，直接看会很困惑。</p>
<p>所以这次我决定自己动手写一个最简化的Raft，从最基础的选举开始。不求完美，先跑通再说。</p>
<h2 data-id="heading-0">一、MVP的边界：只做选举</h2>
<p>实现完整的Raft容易半途而废，更好的方式是从最基础的选举开始。</p>
<p><strong>这次我们只做这三件事：</strong></p>
<ol>
<li>选举出一个Leader</li>
<li>Leader定时发心跳维持地位</li>
<li>持久化term和votedFor</li>
</ol>
<p><strong>暂时不做：</strong></p>
<ul>
<li>日志复制（下一篇再搞）</li>
<li>快照</li>
<li>配置变更</li>
<li>ReadIndex</li>
</ul>
<p>为什么？因为选举是地基，必须先打牢。日志复制是80%的工作量，放后面慢慢啃。</p>
<h2 data-id="heading-1">二、架构设计：能简单就不复杂</h2>
<p>技术选型上选择了最简单的方案：用HTTP而不是gRPC，因为HTTP够用，出问题还能用curl调试。</p>
<pre><code class="hljs language-bash" lang="bash">simple-raft/
├── surfing-raft-core      <span class="hljs-comment"># 核心算法（纯Java）</span>
│   ├── RaftNode           <span class="hljs-comment"># 状态机核心</span>
│   ├── rpc/               <span class="hljs-comment"># RPC消息定义</span>
│   └── storage/           <span class="hljs-comment"># 持久化</span>
└── surfing-raft-node      <span class="hljs-comment"># 节点服务（Spring Boot）</span>
    ├── RaftService        <span class="hljs-comment"># 定时调度</span>
    ├── RaftController     <span class="hljs-comment"># HTTP接口</span>
    └── RaftRpcClient      <span class="hljs-comment"># HTTP客户端</span>
</code></pre>
<p><strong>为什么分两层？</strong></p>
<ul>
<li>core层：纯算法逻辑，不依赖框架，方便单元测试</li>
<li>node层：处理定时任务、HTTP通信这些工程问题</li>
</ul>
<p>算法和工程分离的好处是：核心逻辑不会被框架的注解搞得一团糟。</p>
<p><strong>模块调用关系：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "surfing-raft-node（工程层）"
        Controller[RaftController&lt;br/&gt;REST API]
        Service[RaftService&lt;br/&gt;定时调度+RPC编排]
        Client[RaftRpcClient&lt;br/&gt;HTTP客户端]
    end
    
    subgraph "surfing-raft-core（算法层）"
        Node[RaftNode&lt;br/&gt;核心状态机]
        Storage[FileStatePersistence&lt;br/&gt;持久化]
        RPC[RPC消息&lt;br/&gt;Request/Response]
    end
    
    Controller --&gt;|转发RPC| Service
    Service --&gt;|调用算法| Node
    Service --&gt;|发送RPC| Client
    Client --&gt;|HTTP POST| Controller
    Node --&gt;|读写| Storage
    Service --&gt;|构造消息| RPC
    
    style Node fill:#ffe6e6
    style Storage fill:#e6f3ff
    style Service fill:#e6ffe6
</code></pre>
<p><strong>数据流示例（收到投票请求）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Peer as 其他节点
    participant Controller as RaftController
    participant Service as RaftService
    participant Node as RaftNode
    participant Storage as FileStatePersistence
    
    Peer-&gt;&gt;Controller: POST /raft/vote&lt;br/&gt;RequestVoteRequest
    Controller-&gt;&gt;Service: handleRequestVote(request)
    Service-&gt;&gt;Node: handleRequestVote(request)
    
    rect rgb(255, 240, 240)
    Note over Node: 加锁处理
    Node-&gt;&gt;Node: 检查term
    Node-&gt;&gt;Node: 决定是否投票
    alt 同意投票
        Node-&gt;&gt;Storage: save(term, votedFor)
        Storage--&gt;&gt;Node: 持久化成功
        Node-&gt;&gt;Node: resetElectionTimeout()
    end
    end
    
    Node--&gt;&gt;Service: RequestVoteResponse
    Service--&gt;&gt;Controller: RequestVoteResponse
    Controller--&gt;&gt;Peer: HTTP 200&lt;br/&gt;返回响应
</code></pre>
<h2 data-id="heading-2">三、核心逻辑：少即是多</h2>
<h3 data-id="heading-3">3.1 持久化：只存两个字段</h3>
<p>Raft论文明确说了，必须持久化的只有两个：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersistentState</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> currentTerm;   <span class="hljs-comment">// 当前任期</span>
    <span class="hljs-keyword">private</span> String votedFor;    <span class="hljs-comment">// 投给谁了</span>
}
</code></pre>
<p><strong>为什么不存state（LEADER/FOLLOWER）？</strong></p>
<p>重启后默认都是Follower，通过心跳或选举自然就恢复了。能不存就不存，这是分布式系统的基本原则。</p>
<p>持久化状态越多，系统升级时的兼容性问题就越复杂。</p>
<h3 data-id="heading-4">3.2 原子性写入：保证数据完整</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(PersistentState state)</span> {
    <span class="hljs-comment">// 先写临时文件</span>
    <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(stateFilePath + <span class="hljs-string">".tmp"</span>);
    objectMapper.writeValue(tempFile, state);
    
    <span class="hljs-comment">// 原子性重命名</span>
    Files.move(tempFile.toPath(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(stateFilePath).toPath(), 
        StandardCopyOption.ATOMIC_MOVE);
}
</code></pre>
<p>这种"写临时文件+原子重命名"的模式在很多存储系统中都有使用，比如PostgreSQL的WAL机制。</p>
<p><strong>为什么要这样做？</strong></p>
<p>先写临时文件，成功后再原子性重命名。这样即使写入过程中宕机，要么新文件成功，要么旧文件还在，不会出现文件损坏的情况。</p>
<h3 data-id="heading-5">3.3 选举逻辑：term是核心</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">becomeCandidate</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        state = CANDIDATE;
        currentTerm++;              <span class="hljs-comment">// 关键：任期递增</span>
        votedFor = nodeId;          <span class="hljs-comment">// 投给自己</span>
        votesReceived = <span class="hljs-number">1</span>;          <span class="hljs-comment">// 自己算一票</span>
        
        savePersistentState();      <span class="hljs-comment">// 立即持久化！</span>
        resetElectionTimeout();
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<p>这里有几个需要注意的点：</p>
<p><strong>注意1：term必须先递增再发投票请求</strong>
如果发完请求才递增term，其他节点会因为term过旧而拒绝投票。</p>
<p><strong>注意2：投票后必须立即持久化</strong>
如果不持久化就重启，节点可能忘记已投票，在同一term投多次票，导致两个Leader。这是Raft安全性的根基。</p>
<p><strong>注意3：votesReceived要包含自己</strong>
候选人自己也算一票。如果忘记这点，3节点集群会需要3票才能当选，永远选不出Leader。</p>
<h3 data-id="heading-6">3.4 投票规则：同一任期只投一次</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RequestVoteResponse <span class="hljs-title function_">handleRequestVote</span><span class="hljs-params">(RequestVoteRequest request)</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 拒绝过期请求</span>
        <span class="hljs-keyword">if</span> (request.getTerm() &lt; currentTerm) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestVoteResponse</span>(currentTerm, <span class="hljs-literal">false</span>);
        }
        
        <span class="hljs-comment">// 发现更高term，立即降级</span>
        <span class="hljs-keyword">if</span> (request.getTerm() &gt; currentTerm) {
            becomeFollower(request.getTerm());
        }
        
        <span class="hljs-comment">// 检查是否已投票</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">canVote</span> <span class="hljs-operator">=</span> (votedFor == <span class="hljs-literal">null</span> || 
                          votedFor.equals(request.getCandidateId()));
        
        <span class="hljs-keyword">if</span> (canVote) {
            votedFor = request.getCandidateId();
            savePersistentState();    <span class="hljs-comment">// 又是立即持久化</span>
            resetElectionTimeout();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestVoteResponse</span>(currentTerm, <span class="hljs-literal">true</span>);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestVoteResponse</span>(currentTerm, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<p>这里体现了Raft的精髓：<strong>term是逻辑时钟</strong>。</p>
<p>任何时候收到更高的term，不管你是Leader还是Candidate，立即认怂变Follower。这保证了集群在最高term下只有一个合法Leader。</p>
<h3 data-id="heading-7">3.5 心跳机制：Leader的生命线</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendHeartbeats</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (raftNode.getState() != NodeState.LEADER) {
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 只有Leader发心跳</span>
    }
    
    <span class="hljs-type">AppendEntriesRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppendEntriesRequest</span>(
        raftNode.getCurrentTerm(),
        raftNode.getNodeId(),
        <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>  <span class="hljs-comment">// 暂时没有日志，这些字段都是0</span>
    );
    
    <span class="hljs-comment">// 并行发送给所有Peer</span>
    <span class="hljs-keyword">for</span> (String peer : raftNode.getPeers()) {
        executor.submit(() -&gt; {
            <span class="hljs-type">AppendEntriesResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> rpcClient.appendEntries(peer, request);
            <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span> &amp;&amp; response.getTerm() &gt; raftNode.getCurrentTerm()) {
                <span class="hljs-comment">// 发现更高term，Leader降级</span>
                raftNode.becomeFollower(response.getTerm());
            }
        });
    }
}
</code></pre>
<p><strong>为什么心跳间隔是50ms？</strong></p>
<p>选举超时是150-300ms，心跳间隔应该远小于它，一般是1/3。这样即使偶尔丢包，也不会触发选举。</p>
<p>如果心跳间隔设置得过长（比如100ms心跳配120ms超时），网络稍有抖动就会频繁选举，集群难以稳定。</p>
<p><strong>为什么并行发送？</strong></p>
<p>串行发送的话，3个节点就要150ms（50ms * 3），早就超时了。并行发送能保证心跳及时送达。</p>
<p><strong>注意：不要用CompletableFuture.allOf()等待所有响应。</strong> 一个节点慢了，整个心跳就慢了。正确做法是发完就完事，响应异步处理。</p>
<h3 data-id="heading-8">3.6 完整的选举流程</h3>
<p>用时序图看得更清楚：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant N1 as Node-1&lt;br/&gt;(Follower)
    participant N2 as Node-2&lt;br/&gt;(Follower)
    participant N3 as Node-3&lt;br/&gt;(Follower)
    
    Note over N1,N3: 所有节点启动，初始状态都是Follower&lt;br/&gt;term=0, votedFor=null
    
    Note over N1: 选举超时(200ms)&lt;br/&gt;没收到心跳
    
    rect rgb(255, 240, 240)
    Note over N1: 开始选举
    N1-&gt;&gt;N1: becomeCandidate()&lt;br/&gt;term: 0→1&lt;br/&gt;votedFor: node-1&lt;br/&gt;votes: 1
    N1-&gt;&gt;N1: 持久化(term=1, votedFor=node-1)
    end
    
    par 并发发送投票请求
        N1-&gt;&gt;N2: RequestVote&lt;br/&gt;{term:1, candidateId:node-1}
        N1-&gt;&gt;N3: RequestVote&lt;br/&gt;{term:1, candidateId:node-1}
    end
    
    rect rgb(240, 255, 240)
    Note over N2: 处理投票请求
    N2-&gt;&gt;N2: term: 0→1&lt;br/&gt;votedFor: node-1
    N2-&gt;&gt;N2: 持久化(term=1, votedFor=node-1)
    N2-&gt;&gt;N2: 重置选举超时
    N2--&gt;&gt;N1: VoteGranted: true
    end
    
    rect rgb(240, 255, 240)
    Note over N3: 处理投票请求
    N3-&gt;&gt;N3: term: 0→1&lt;br/&gt;votedFor: node-1
    N3-&gt;&gt;N3: 持久化(term=1, votedFor=node-1)
    N3-&gt;&gt;N3: 重置选举超时
    N3--&gt;&gt;N1: VoteGranted: true
    end
    
    rect rgb(240, 240, 255)
    Note over N1: 收到多数派投票
    N1-&gt;&gt;N1: votes: 3/3 &gt;= 2&lt;br/&gt;becomeLeader()
    Note over N1: 成为Leader
    end
    
    loop 每50ms发送心跳
        N1-&gt;&gt;N2: AppendEntries&lt;br/&gt;{term:1, leaderId:node-1}
        N1-&gt;&gt;N3: AppendEntries&lt;br/&gt;{term:1, leaderId:node-1}
        N2--&gt;&gt;N1: Success: true
        N3--&gt;&gt;N1: Success: true
    end
    
    Note over N1,N3: 集群稳定&lt;br/&gt;Node-1是Leader, term=1
</code></pre>
<p><strong>关键时刻：</strong></p>
<ol>
<li><strong>0-200ms</strong>: 所有节点等待，Node-1先超时</li>
<li><strong>200ms</strong>: Node-1发起选举，term变成1</li>
<li><strong>200-250ms</strong>: 投票请求在网络中传输（假设延迟50ms）</li>
<li><strong>250ms</strong>: Node-2和Node-3收到请求，投票给Node-1</li>
<li><strong>250-300ms</strong>: 投票响应返回</li>
<li><strong>300ms</strong>: Node-1收到多数票，成为Leader</li>
<li><strong>300ms后</strong>: Leader每50ms发一次心跳</li>
</ol>
<h3 data-id="heading-9">3.7 Leader失联后的重新选举</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant L as Node-1&lt;br/&gt;(Leader)
    participant F1 as Node-2&lt;br/&gt;(Follower)
    participant F2 as Node-3&lt;br/&gt;(Follower)
    
    Note over L,F2: 稳定状态: Node-1是Leader, term=1
    
    loop Leader正常发送心跳
        L-&gt;&gt;F1: AppendEntries{term:1}
        L-&gt;&gt;F2: AppendEntries{term:1}
        F1--&gt;&gt;L: Success
        F2--&gt;&gt;L: Success
    end
    
    rect rgb(255, 200, 200)
    Note over L: Leader宕机/网络断开
    end
    
    Note over F1,F2: Followers等待心跳...&lt;br/&gt;选举超时开始计时
    
    Note over F1: 选举超时(250ms)
    
    rect rgb(255, 240, 240)
    F1-&gt;&gt;F1: becomeCandidate()&lt;br/&gt;term: 1→2&lt;br/&gt;votedFor: node-2&lt;br/&gt;votes: 1
    F1-&gt;&gt;F1: 持久化(term=2, votedFor=node-2)
    end
    
    F1-&gt;&gt;F2: RequestVote&lt;br/&gt;{term:2, candidateId:node-2}
    
    rect rgb(240, 255, 240)
    F2-&gt;&gt;F2: term: 1→2&lt;br/&gt;votedFor: node-2
    F2-&gt;&gt;F2: 持久化(term=2, votedFor=node-2)
    F2--&gt;&gt;F1: VoteGranted: true
    end
    
    rect rgb(240, 240, 255)
    F1-&gt;&gt;F1: votes: 2/2 &gt;= 2&lt;br/&gt;becomeLeader()
    Note over F1: Node-2成为新Leader
    end
    
    loop 新Leader发送心跳
        F1-&gt;&gt;F2: AppendEntries{term:2, leaderId:node-2}
        F2--&gt;&gt;F1: Success: true
    end
    
    Note over F1,F2: 集群恢复&lt;br/&gt;Node-2是Leader, term=2

    opt Leader恢复后
        L-&gt;&gt;F1: AppendEntries{term:1}
        rect rgb(255, 240, 240)
        Note over F1: 发现旧term
        F1--&gt;&gt;L: {term:2, success:false}
        end
        rect rgb(255, 200, 200)
        Note over L: 收到更高term
        L-&gt;&gt;L: becomeFollower(2)&lt;br/&gt;state: LEADER→FOLLOWER&lt;br/&gt;持久化
        end
    end
</code></pre>
<p><strong>这个流程体现了Raft的两个关键特性：</strong></p>
<ol>
<li><strong>任期单调递增</strong>：新Leader的term=2 &gt; 旧Leader的term=1</li>
<li><strong>旧Leader自动降级</strong>：收到更高term后，立即变成Follower</li>
</ol>
<h3 data-id="heading-10">3.8 节点状态转换规则</h3>
<p>Raft节点有3个状态：Follower、Candidate、Leader。状态转换的触发条件如下：</p>

































































<table><thead><tr><th>当前状态</th><th>触发条件</th><th>转换到</th><th>执行动作</th></tr></thead><tbody><tr><td><strong>Follower</strong></td><td>选举超时，未收到心跳</td><td>Candidate</td><td>term++，投票给自己，持久化</td></tr><tr><td><strong>Follower</strong></td><td>收到合法Leader心跳</td><td>Follower</td><td>重置选举超时</td></tr><tr><td><strong>Follower</strong></td><td>收到更高term</td><td>Follower</td><td>更新term，持久化</td></tr><tr><td><strong>Candidate</strong></td><td>获得多数票</td><td>Leader</td><td>开始发送心跳</td></tr><tr><td><strong>Candidate</strong></td><td>选举超时，未获得多数票</td><td>Candidate</td><td>term++，发起新一轮选举</td></tr><tr><td><strong>Candidate</strong></td><td>收到更高term</td><td>Follower</td><td>更新term，持久化</td></tr><tr><td><strong>Candidate</strong></td><td>收到合法Leader心跳</td><td>Follower</td><td>更新term，重置选举超时</td></tr><tr><td><strong>Leader</strong></td><td>收到更高term</td><td>Follower</td><td>立即降级，更新term，持久化</td></tr><tr><td><strong>Leader</strong></td><td>正常运行</td><td>Leader</td><td>定时发送心跳维持地位</td></tr></tbody></table>
<p><strong>关键规则：</strong></p>
<ul>
<li>任何状态收到更高term，都要更新term并转为Follower</li>
<li>Follower和Candidate收到合法Leader心跳，立即转为Follower并重置选举超时</li>
<li>Candidate获得多数票(包括自己)，立即转为Leader</li>
<li>Leader只有在收到更高term时才会降级</li>
</ul>
<h2 data-id="heading-11">四、运行效果：眼见为实</h2>
<p>Talk is cheap, show me the code. 不，show me the running cluster!</p>
<h3 data-id="heading-12">4.1 启动集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> simple-raft
./start-cluster.sh
</code></pre>
<p>这个脚本会：</p>
<ol>
<li>清理旧数据（<code>/tmp/raft-data</code>）</li>
<li>编译项目（Maven）</li>
<li>后台启动3个节点</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">清理旧数据...</span>
<span class="hljs-string">编译项目...</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">BUILD</span> <span class="hljs-string">SUCCESS</span>
<span class="hljs-string">启动节点</span> <span class="hljs-number">1</span><span class="hljs-string">...</span>
<span class="hljs-string">节点</span> <span class="hljs-attr">1 PID:</span> <span class="hljs-number">55160</span>
<span class="hljs-string">启动节点</span> <span class="hljs-number">2</span><span class="hljs-string">...</span>
<span class="hljs-string">节点</span> <span class="hljs-attr">2 PID:</span> <span class="hljs-number">55166</span>
<span class="hljs-string">启动节点</span> <span class="hljs-number">3</span><span class="hljs-string">...</span>
<span class="hljs-string">节点</span> <span class="hljs-attr">3 PID:</span> <span class="hljs-number">55170</span>

<span class="hljs-string">三个节点已启动：</span>
  <span class="hljs-string">节点</span> <span class="hljs-attr">1:</span> <span class="hljs-string">http://localhost:8081</span> <span class="hljs-string">(PID:</span> <span class="hljs-number">55160</span><span class="hljs-string">)</span>
  <span class="hljs-string">节点</span> <span class="hljs-attr">2:</span> <span class="hljs-string">http://localhost:8082</span> <span class="hljs-string">(PID:</span> <span class="hljs-number">55166</span><span class="hljs-string">)</span>
  <span class="hljs-string">节点</span> <span class="hljs-attr">3:</span> <span class="hljs-string">http://localhost:8083</span> <span class="hljs-string">(PID:</span> <span class="hljs-number">55170</span><span class="hljs-string">)</span>
</code></pre>
<p><strong>启动后的内部流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Spring as Spring Boot
    participant Service as RaftService
    participant Node as RaftNode
    participant Storage as FileStatePersistence
    
    Spring-&gt;&gt;Service: @PostConstruct&lt;br/&gt;start()
    Service-&gt;&gt;Storage: 创建持久化
    Service-&gt;&gt;Node: 创建RaftNode
    Node-&gt;&gt;Storage: loadPersistentState()
    
    alt 首次启动(文件不存在)
        Storage--&gt;&gt;Node: {term:0, votedFor:null}
        Note over Node: 初始化为Follower&lt;br/&gt;term=0, votedFor=null
    else 重启(文件存在)
        Storage--&gt;&gt;Node: {term:5, votedFor:node-2}
        Note over Node: 恢复为Follower&lt;br/&gt;term=5, votedFor=node-2
    end
    
    Node-&gt;&gt;Node: 生成随机选举超时&lt;br/&gt;150-300ms
    
    Service-&gt;&gt;Service: 启动定时任务
    
    rect rgb(240, 255, 240)
    Note over Service: 定时任务1: 选举超时检查(50ms)
    loop 每50ms执行
        Service-&gt;&gt;Node: 检查是否超时
        alt 超时且未收到心跳
            Service-&gt;&gt;Service: startElection()
        end
    end
    end
    
    rect rgb(240, 240, 255)
    Note over Service: 定时任务2: 心跳发送(50ms)
    loop 每50ms执行
        alt 当前是Leader
            Service-&gt;&gt;Service: sendHeartbeats()
        end
    end
    end
    
    Note over Spring,Storage: 节点启动完成，进入运行状态
</code></pre>
<p><strong>3个节点的配置差异：</strong></p>



































<table><thead><tr><th>配置项</th><th>Node-1</th><th>Node-2</th><th>Node-3</th></tr></thead><tbody><tr><td>server.port</td><td>8081</td><td>8082</td><td>8083</td></tr><tr><td>raft.node-id</td><td>node-1</td><td>node-2</td><td>node-3</td></tr><tr><td>raft.peers</td><td>localhost:8082,<br/>localhost:8083</td><td>localhost:8081,<br/>localhost:8083</td><td>localhost:8081,<br/>localhost:8082</td></tr><tr><td>raft.storage-dir</td><td>/tmp/raft-data/<br/>node-1</td><td>/tmp/raft-data/<br/>node-2</td><td>/tmp/raft-data/<br/>node-3</td></tr></tbody></table>
<p><strong>持久化文件：</strong></p>
<ul>
<li>Node-1: <code>/tmp/raft-data/node-1/node-1-state.json</code></li>
<li>Node-2: <code>/tmp/raft-data/node-2/node-2-state.json</code></li>
<li>Node-3: <code>/tmp/raft-data/node-3/node-3-state.json</code></li>
</ul>
<p>文件内容示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"currentTerm"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"votedFor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">4.2 查看状态</h3>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8081/raft/status | jq
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"nodeId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LEADER"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"currentTerm"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"leaderId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8082/raft/status | jq
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"nodeId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"FOLLOWER"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"currentTerm"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"leaderId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>看到没？node-1是Leader，其他两个是Follower。集群稳定了。</p>
<h3 data-id="heading-14">4.3 测试Leader失联</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 杀掉Leader</span>
<span class="hljs-built_in">kill</span> 55160

<span class="hljs-comment"># 等2秒，让选举完成</span>
<span class="hljs-built_in">sleep</span> 2

<span class="hljs-comment"># 查看新状态</span>
curl http://localhost:8082/raft/status | jq
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"nodeId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LEADER"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"currentTerm"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"leaderId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-2"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>node-2成为新Leader了，term从1变成2。这就是Raft的容错能力。</p>
<h3 data-id="heading-15">4.4 观察日志：选举的完整过程</h3>
<p>我在代码里加了详细的日志，你可以实时看到选举过程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">tail</span> -f /tmp/raft-node-1.<span class="hljs-built_in">log</span>
</code></pre>
<p><strong>完整的日志输出（带时间戳和解读）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">2024-11-18 22:49:23.156 <span class="hljs-section">[main]</span> INFO  RaftNode - Node node-1 initialized as FOLLOWER
2024-11-18 22:49:23.158 <span class="hljs-section">[main]</span> INFO  FileStatePersistence - No persistent state file found, initializing with defaults
2024-11-18 22:49:23.159 <span class="hljs-section">[main]</span> INFO  RaftNode - Loaded persistent state: <span class="hljs-attr">term</span>=<span class="hljs-number">0</span>, votedFor=null
2024-11-18 22:49:23.162 <span class="hljs-section">[main]</span> INFO  RaftService - RaftService started for node node-1
</code></pre>
<p><strong>↑ 节点启动，初始化为Follower，term=0</strong></p>
<hr/>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024-11-18 22:49:23.450</span> [<span class="hljs-string">pool-2-thread-1</span>] <span class="hljs-string">INFO</span>  <span class="hljs-string">RaftNode</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Election</span> <span class="hljs-string">timeout</span> <span class="hljs-string">reached,</span> <span class="hljs-attr">current state:</span> <span class="hljs-string">FOLLOWER</span>
<span class="hljs-number">2024-11-18 22:49:23.451</span> [<span class="hljs-string">pool-2-thread-1</span>] <span class="hljs-attr">INFO  RaftNode - State changed:</span> <span class="hljs-string">FOLLOWER</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">CANDIDATE,</span> <span class="hljs-attr">term:</span> <span class="hljs-number">0</span> <span class="hljs-string">-&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-number">2024-11-18 22:49:23.452</span> [<span class="hljs-string">pool-2-thread-1</span>] <span class="hljs-attr">INFO  FileStatePersistence - Saved persistent state:</span> <span class="hljs-string">term=1,</span> <span class="hljs-string">votedFor=node-1</span>
</code></pre>
<p><strong>↑ 选举超时(~300ms)，转为Candidate，term变成1，投票给自己并持久化</strong></p>
<hr/>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-18</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">23.453</span> [pool<span class="hljs-number">-2</span>-thread<span class="hljs-number">-1</span>] INFO  RaftService - Starting election <span class="hljs-keyword">for</span> term <span class="hljs-number">1</span>
<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-18</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">23.454</span> [pool<span class="hljs-number">-3</span>-thread<span class="hljs-number">-1</span>] INFO  RaftService - Sending vote <span class="hljs-built_in">request</span> <span class="hljs-keyword">to</span> localhost:<span class="hljs-number">8082</span>
<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-18</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">23.454</span> [pool<span class="hljs-number">-3</span>-thread<span class="hljs-number">-2</span>] INFO  RaftService - Sending vote <span class="hljs-built_in">request</span> <span class="hljs-keyword">to</span> localhost:<span class="hljs-number">8083</span>
</code></pre>
<p><strong>↑ 发起选举，并行向其他两个节点发送投票请求</strong></p>
<hr/>
<pre><code class="hljs language-ini" lang="ini">2024-11-18 22:49:23.512 <span class="hljs-section">[pool-3-thread-1]</span> INFO  RaftService - Received vote response from localhost:8082: <span class="hljs-attr">granted</span>=<span class="hljs-literal">true</span>, term=<span class="hljs-number">1</span>
2024-11-18 22:49:23.513 <span class="hljs-section">[pool-3-thread-2]</span> INFO  RaftService - Received vote response from localhost:8083: <span class="hljs-attr">granted</span>=<span class="hljs-literal">true</span>, term=<span class="hljs-number">1</span>
</code></pre>
<p><strong>↑ 收到其他两个节点的投票，都是同意(granted=true)</strong></p>
<hr/>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024-11-18 22:49:23.514</span> [<span class="hljs-string">pool-3-thread-1</span>] <span class="hljs-string">INFO</span>  <span class="hljs-string">RaftNode</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Received</span> <span class="hljs-string">majority</span> <span class="hljs-string">votes</span> <span class="hljs-string">(3/3),</span> <span class="hljs-string">becoming</span> <span class="hljs-string">LEADER</span>
<span class="hljs-number">2024-11-18 22:49:23.514</span> [<span class="hljs-string">pool-3-thread-1</span>] <span class="hljs-attr">INFO  RaftNode - State changed:</span> <span class="hljs-string">CANDIDATE</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">LEADER</span>
</code></pre>
<p><strong>↑ 获得多数票(3票≥2票)，成为Leader</strong></p>
<hr/>
<pre><code class="hljs language-ini" lang="ini">2024-11-18 22:49:23.565 <span class="hljs-section">[pool-2-thread-2]</span> INFO  RaftService - Sending heartbeats to 2 peers, <span class="hljs-attr">term</span>=<span class="hljs-number">1</span>
2024-11-18 22:49:23.615 <span class="hljs-section">[pool-2-thread-2]</span> INFO  RaftService - Sending heartbeats to 2 peers, <span class="hljs-attr">term</span>=<span class="hljs-number">1</span>
2024-11-18 22:49:23.665 <span class="hljs-section">[pool-2-thread-2]</span> INFO  RaftService - Sending heartbeats to 2 peers, <span class="hljs-attr">term</span>=<span class="hljs-number">1</span>
</code></pre>
<p><strong>↑ Leader每50ms发送一次心跳</strong></p>
<hr/>
<p><strong>同时看Node-2的日志（Follower视角）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">tail</span> -f /tmp/raft-node-2.<span class="hljs-built_in">log</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini">2024-11-18 22:49:23.480 <span class="hljs-section">[http-nio-8082-exec-1]</span> INFO  RaftController - Received RequestVote: {term:1, candidateId:node-1}
2024-11-18 22:49:23.481 <span class="hljs-section">[http-nio-8082-exec-1]</span> INFO  RaftNode - Received RequestVote from node-1 for term 1
2024-11-18 22:49:23.482 <span class="hljs-section">[http-nio-8082-exec-1]</span> INFO  RaftNode - Granting vote to node-1 for term 1
2024-11-18 22:49:23.483 <span class="hljs-section">[http-nio-8082-exec-1]</span> INFO  FileStatePersistence - Saved persistent state: <span class="hljs-attr">term</span>=<span class="hljs-number">1</span>, votedFor=node-<span class="hljs-number">1</span>
</code></pre>
<p><strong>↑ Follower收到投票请求，同意投票，持久化votedFor=node-1</strong></p>
<hr/>
<pre><code class="hljs language-ini" lang="ini">2024-11-18 22:49:23.570 <span class="hljs-section">[http-nio-8082-exec-2]</span> INFO  RaftController - Received AppendEntries: {term:1, leaderId:node-1}
2024-11-18 22:49:23.571 <span class="hljs-section">[http-nio-8082-exec-2]</span> INFO  RaftNode - Received heartbeat from Leader node-1, <span class="hljs-attr">term</span>=<span class="hljs-number">1</span>
2024-11-18 22:49:23.571 <span class="hljs-section">[http-nio-8082-exec-2]</span> INFO  RaftNode - Resetting election timeout
</code></pre>
<p><strong>↑ Follower收到Leader的心跳，重置选举超时</strong></p>
<hr/>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">2024</span>-<span class="hljs-number">11</span>-<span class="hljs-number">18</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">23.620</span> [http-nio-<span class="hljs-number">8082</span>-exec-<span class="hljs-number">3</span>] INFO  RaftController - Received AppendEntries: {term:<span class="hljs-number">1</span>, leaderId:node-<span class="hljs-number">1</span>}
<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>-<span class="hljs-number">18</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">23.670</span> [http-nio-<span class="hljs-number">8082</span>-exec-<span class="hljs-number">4</span>] INFO  RaftController - Received AppendEntries: {term:<span class="hljs-number">1</span>, leaderId:node-<span class="hljs-number">1</span>}
</code></pre>
<p><strong>↑ 持续收到心跳，每50ms一次</strong></p>
<hr/>
<p><strong>日志时间线分析：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title 选举过程时间线（毫秒级）
    dateFormat x
    axisFormat %L
    
    section Node-1
    启动初始化          :0, 23156
    等待选举超时        :23156, 23450
    成为Candidate       :23450, 23452
    发送投票请求        :23453, 23454
    收到投票响应        :23512, 23514
    成为Leader          :23514, 23515
    发送心跳            :23565, 150000
    
    section Node-2
    启动初始化          :0, 23160
    等待                :23160, 23480
    收到投票请求        :23480, 23481
    投票给Node-1        :23481, 23483
    收到心跳            :23570, 150000
</code></pre>
<p><strong>关键时间点：</strong></p>
<ul>
<li><strong>23.156s</strong>: Node-1启动</li>
<li><strong>23.450s</strong>: Node-1选举超时（等了294ms）</li>
<li><strong>23.453s</strong>: 发起选举</li>
<li><strong>23.480s</strong>: Node-2收到投票请求（网络延迟27ms）</li>
<li><strong>23.512s</strong>: Node-1收到第一张投票（总延迟59ms）</li>
<li><strong>23.514s</strong>: 获得多数票，成为Leader（总耗时64ms）</li>
<li><strong>23.565s</strong>: 开始发送心跳</li>
</ul>
<h2 data-id="heading-16">五、与Nacos JRaft的对比</h2>
<p>Simple Raft只有500行代码，而JRaft有5万行，差距在哪？</p>
<p>我整理了个对比表：</p>























































<table><thead><tr><th>特性</th><th>Simple Raft</th><th>Nacos JRaft</th></tr></thead><tbody><tr><td>代码量</td><td>~500行</td><td>~5万行</td></tr><tr><td>选举机制</td><td>完全一致</td><td>完全一致</td></tr><tr><td>持久化</td><td>文件（JSON）</td><td>RocksDB</td></tr><tr><td>RPC</td><td>HTTP + JSON</td><td>gRPC/Bolt</td></tr><tr><td>日志复制</td><td>未实现</td><td>完整实现</td></tr><tr><td>快照</td><td>未实现</td><td>完整实现</td></tr><tr><td>性能</td><td>够用（demo）</td><td>生产级（万级TPS）</td></tr><tr><td>PreVote优化</td><td>无</td><td>有</td></tr><tr><td>Pipeline复制</td><td>无</td><td>有</td></tr></tbody></table>
<p><strong>核心思想是一样的</strong>，差距在工程实现上。</p>
<p>JRaft做了大量优化：</p>
<ul>
<li>批量复制日志</li>
<li>Pipeline降低延迟</li>
<li>RocksDB持久化</li>
<li>详尽的监控指标</li>
</ul>
<p>但这些都不是Raft的核心。<strong>我们先把核心搞懂，优化以后再说。</strong></p>
<h2 data-id="heading-17">六、常见的实现问题</h2>
<h3 data-id="heading-18">问题1：并发安全</h3>
<p>仅用volatile不够，<code>currentTerm++</code>和<code>state=CANDIDATE</code>不是原子操作，可能出现term已经+1但state还是FOLLOWER的情况。</p>
<p>需要用ReentrantLock保护所有状态变更操作。</p>
<h3 data-id="heading-19">问题2：选举超时未随机化</h3>
<p>如果所有节点的选举超时都是固定值(比如200ms)，会导致多个节点同时超时、同时发起选举、互相投票给自己，一直平票。</p>
<p>解决方案：设置随机的选举超时(150-300ms)，让某个节点先发起选举。</p>
<h3 data-id="heading-20">问题3：心跳失败后Leader未降级</h3>
<p>Leader和Follower断网后，Leader可能继续认为自己是Leader。</p>
<p>原因：心跳失败后只打日志，没有检查响应的term。正确做法：<strong>收到更高term，立即降级</strong>。</p>
<h3 data-id="heading-21">问题4：持久化时机错误</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误写法</span>
votedFor = candidateId;
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestVoteResponse</span>(currentTerm, <span class="hljs-literal">true</span>);
savePersistentState();  <span class="hljs-comment">// 永远执行不到</span>

<span class="hljs-comment">// 正确写法</span>
votedFor = candidateId;
savePersistentState();  <span class="hljs-comment">// 先持久化</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestVoteResponse</span>(currentTerm, <span class="hljs-literal">true</span>);
</code></pre>
<p>状态变更必须先持久化再返回，这是Raft安全性的基础。</p>
<h2 data-id="heading-22">七、当前实现的局限</h2>
<p>通过这个MVP版本，我们跑通了Raft的Leader选举和心跳机制。3个节点能正常选举，Leader能维持统治，节点重启后能正确恢复。</p>
<p>但这只是Raft的入门。<strong>当前实现还缺少最核心的功能：</strong></p>
<h3 data-id="heading-23">没有日志复制</h3>
<p>现在的Leader只会发心跳，不会处理任何业务请求。选举只是解决了"谁来协调"，还没有解决"怎么协调"。</p>
<p>回顾第一篇说的：Raft的核心是保证所有节点按相同顺序执行相同的操作。现在我们只有Leader，但没有"操作"和"顺序"。</p>
<h3 data-id="heading-24">没有状态机</h3>
<p>日志复制后，需要应用到状态机。这才是Raft的最终目的：构建一个一致性的状态机。</p>
<h3 data-id="heading-25">没有过半提交机制</h3>
<p>Leader如何知道日志已经被多数节点接收？什么时候可以告诉客户端"写入成功"？这些都需要实现。</p>
<h3 data-id="heading-26">日志一致性检查</h3>
<p>如果Follower的日志和Leader不一致怎么办？如何通过prevLogIndex/prevLogTerm检查一致性？冲突了如何处理？</p>
<p><strong>这些问题，都在下一篇解决。</strong></p>
<p>下一篇将实现日志复制机制，包括：</p>
<ul>
<li>AppendEntries携带日志条目</li>
<li>日志一致性检查</li>
<li>过半确认与提交</li>
<li>简单的KV状态机</li>
</ul>
<p>那时候才算真正理解了Raft的核心。</p>
<hr/>
<p>如果你也在学习Raft，或者对分布式共识有自己的理解，欢迎在评论区交流。有问题也可以直接留言，看到会回复。</p>
<p>代码已开源，欢迎Star：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-raft" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-raft" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二叉树的三种迭代遍历（无栈版本）-- 我在马克思主义课上的一些巧思]]></title>    <link>https://juejin.cn/post/7575021014033645587</link>    <guid>https://juejin.cn/post/7575021014033645587</guid>    <pubDate>2025-11-22T03:54:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575021014033645587" data-draft-id="7574718964045398066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二叉树的三种迭代遍历（无栈版本）-- 我在马克思主义课上的一些巧思"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-11-22T03:54:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shemol"/> <meta itemprop="url" content="https://juejin.cn/user/1927864794744251"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二叉树的三种迭代遍历（无栈版本）-- 我在马克思主义课上的一些巧思
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927864794744251/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shemol
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:54:53.000Z" title="Sat Nov 22 2025 03:54:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前情提要</h2>
<p>事情是这样的：本人近日跟着邓俊辉的网课学习数据结构（不知道有没有听过的，讲得真的很好），在学习到二叉树的三种遍历，也就是先序、中序、后序这三种时，对课堂上提供的算法有些不满：三种算法全都采用引入一个辅助栈的方法来确定节点的遍历顺序。</p>
<p>这样的算法在我的眼中，不够优雅。老师在二叉树遍历的第一节课就说过，随着二叉树的规模、深度增大，递归遍历版本会出现“函数调用栈溢出”的问题。现在优化为了迭代版本，却依然没有解决这个问题。</p>
<p>于是我就带着这个问题，走向了马克思主义的教室（本人开学以来第一次见到这老师，其他时间都是在寝室自学，今天听说有期中考试才来的）。课上实在无聊，我口袋里又正好有一张草稿纸。闲来无事，在上面画了一棵树。</p>
<p>历史上也不乏这样的时刻--灵感总是在不经意间涌现。我把目光从整体的递归，或者说迭代策略，转向了局部，节点与节点之间的逻辑联系。于是发现了一种基于父指针的，不需要辅助栈的迭代遍历策略。这样的发现不能说不令人欣喜，于是写下我的第一篇博客，以作纪念。</p>
<h2 data-id="heading-1">算法思路与实现</h2>
<p>我的算法基于父指针来维系节点之间的逻辑联系。这大概是其唯一的缺点。但是，耗费与栈相当的空间（对于已经提供父指针的情景，额外的空间是O(1)），不仅能够解决栈溢出的问题，而且在形式上，三种遍历算法高度统一，我自认为算是个优雅且优秀的算法。</p>
<h3 data-id="heading-2">先序遍历：V-&gt;L-&gt;R</h3>
<p>先从先序遍历开始吧，我们有一棵二叉树，如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fa422cc04a14323839ec8ed296a11a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlbW9s:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764388493&amp;x-signature=IpnrWdBR09VoNVbvWJ4a2GRJpwM%3D" alt="image.png" loading="lazy"/></p>
<p>思路是这样的，从根节点开始。在任意时刻，我们先遍历当前节点，然后面临的无非这几种情况：</p>
<pre><code class="hljs">当前节点有左孩子，那就继续去遍历左孩子。
当前节点没有左孩子（左孩子为空），但是有右孩子，那就去遍历右孩子。
当前节点既没有左孩子，也没有右孩子（叶子节点），那就要回溯了。
</code></pre>
<p>回溯到什么时候呢？回溯时也无非两种情况，我们不妨讨论一下，使得你的思路更加清晰：</p>
<p>一、回溯时，自己是父节点的“非独生”左孩子。这很好理解，也就是这个父节点的左子树遍历完了嘛，那就接着去遍历他的右子树</p>
<p>二、回溯时，自己是父节点的“独生”左孩子，或是右孩子。也很好理解吧，那这个父节点的左右子树就全部遍历完了！我们就跳过这个父节点,继续向上回溯，直到它是父节点的“非独生”左孩子。</p>
<p>现在我们已经讨论完了遍历中所有的情况，那循环什么时候退出呢？答案是“根节点的左右子树被遍历完”。也就是说，当前节点重新回到根节点（父节点为空）时，退出循环，遍历结束。</p>
<p>下面给出代码（自认为完美，欢迎大佬来找bug）：</p>
<pre><code class="hljs language-scss" lang="scss">template&lt;typename T, typename VST&gt;
void <span class="hljs-built_in">traverse</span>(bin_node&lt;T&gt;* node, VST&amp; visit)
{
	if (node == nullptr) return;<span class="hljs-comment">//边界情况考虑</span>

	while (true)
	{
		<span class="hljs-built_in">visit</span>(node);<span class="hljs-comment">//先序遍历</span>
		if (node-&gt;get_left_child() != nullptr) node = node-&gt;<span class="hljs-built_in">get_left_child</span>();<span class="hljs-comment">//如果左孩子存在，则继续深入</span>
		else if (node-&gt;get_right_child() != nullptr) node = node-&gt;<span class="hljs-built_in">get_right_child</span>();<span class="hljs-comment">//如果没有左孩子，但是有右孩子，则转向右孩子</span>

		<span class="hljs-comment">//如果为叶节点，开始回溯</span>
		else
		{
			while (true)
			{
				if (node-&gt;get_parent() == nullptr)break;<span class="hljs-comment">//如果追溯到根节点，说明整棵树遍历完了，退出循环</span>
				if (node == node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_left_child</span>())<span class="hljs-comment">//如果是父节点的左孩子，讨论是否“独生”</span>
				{
					if (node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_right_child</span>() == nullptr);<span class="hljs-comment">//如果独生，那就继续回溯</span>
					else break;<span class="hljs-comment">//如果非独生，就退出循环，去遍历父节点的右子树</span>
				}
				else;<span class="hljs-comment">//如果是父节点的右孩子，继续回溯</span>

				node = node-&gt;<span class="hljs-built_in">get_parent</span>();
			}
			if (node-&gt;get_parent() == nullptr) return;<span class="hljs-comment">//如果追溯到根节点的上方，说明已经遍历完了</span>
			node = node-&gt;<span class="hljs-built_in">get_parent</span>()-&gt;<span class="hljs-built_in">get_right_child</span>();<span class="hljs-comment">//如果不是根节点，转向右孩子</span>
		}
	}
}
</code></pre>
<h3 data-id="heading-3">中序遍历</h3>
<p>思路是一样的，只不过这里要等到节点的左子树遍历完再遍历该节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3afc1a90d31c4a98b5c0d8b5700fe274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlbW9s:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764388493&amp;x-signature=9vU0%2FFQlVGahiFbsdXFvBf9CHJ0%3D" alt="image.png" loading="lazy"/>
我们也分情况讨论。从根节点开始。在任意时刻，我们先不遍历当前节点，面临的无非这几种情况：</p>
<pre><code class="hljs">当前节点有左孩子，那就转向左孩子
当前节点没有左孩子，但是有右孩子。那就到了这个节点被遍历的时候了。它被遍历之后，要转向他的右孩子。
当前节点为叶节点，那就开始回溯
</code></pre>
<p>回溯的时候呢，也无非下面几种情况：</p>
<p>一、当前节点为左孩子，那就说明他的父节点的左子树已经遍历完了，遍历他的父节点。如果这个父节点有右孩子呢，就去遍历，如果没有那就继续向上回溯。</p>
<p>二、当前节点为右孩子，那说明它的父节点是不用遍历的，向上回溯。</p>
<p>（写到这里，不得不感叹一句：这写文章和在脑子里想真不是一回事啊。脑子里的思路透明如水晶，一到想要写下来时却找不着东南西北。）</p>
<pre><code class="hljs language-scss" lang="scss">template&lt;typename T, typename VST&gt;
void <span class="hljs-built_in">my_traverse_middle</span>(bin_node&lt;T&gt;* node, VST&amp; visit)
{
	if (node == nullptr) return;<span class="hljs-comment">//边界情况</span>

	while (true)
	{
		if (node-&gt;get_left_child() != nullptr) node = node-&gt;<span class="hljs-built_in">get_left_child</span>();<span class="hljs-comment">//如果左孩子存在，继续深入</span>
		else<span class="hljs-comment">//如果没有左孩子，那就遍历当前节点</span>
		{
			<span class="hljs-built_in">visit</span>(node);
			if (node-&gt;get_right_child() != nullptr) node = node-&gt;<span class="hljs-built_in">get_right_child</span>();<span class="hljs-comment">//如果有右孩子，那就转向右孩子</span>

			else<span class="hljs-comment">//没有的话，也就是叶节点，向上回溯,直到当前节点为"非独生"左孩子</span>
			{
				while (true)
				{
					if (node-&gt;get_parent() == nullptr)break;<span class="hljs-comment">//如果追溯到根节点，说明整棵树遍历完了，退出循环</span>
					if (node == node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_left_child</span>())<span class="hljs-comment">//如果是父节点的左孩子，就遍历父节点，再讨论是否“独生”</span>
					{
						<span class="hljs-built_in">visit</span>(node-&gt;get_parent());
						if (node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_right_child</span>() != nullptr) break;<span class="hljs-comment">//如果非独生，就去遍历父节点的右子树</span>
						else;<span class="hljs-comment">//如果独生，继续回溯</span>
					}
					else;<span class="hljs-comment">//如果是父节点的右孩子，继续回溯</span>

					node = node-&gt;<span class="hljs-built_in">get_parent</span>();
				}
				if (node-&gt;get_parent() == nullptr) return;<span class="hljs-comment">//如果追溯到根节点的上方，说明遍历完了</span>
				node = node-&gt;<span class="hljs-built_in">get_parent</span>()-&gt;<span class="hljs-built_in">get_right_child</span>();
			}
		}
	}
}
</code></pre>
<h3 data-id="heading-4">后序遍历</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92c6b3cb4d9b4e93b9440604882cd7c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlbW9s:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764388493&amp;x-signature=qpqgnq%2FHOyhzoTOT8YoK0w8eSV4%3D" alt="image.png" loading="lazy"/></p>
<p>对于后序遍历，我们理解这样一个事实：对于任意一棵（子）树，我们总是先去遍历最左边的叶子</p>
<p>从根节点开始，我们向下遍历，无非这几种情况：</p>
<pre><code class="hljs">当前节点有左孩子，那就继续向左
如果当前孩子没有左孩子，那就尝试向右
如果当前节点为叶子节点，那就遍历，并开始回溯
</code></pre>
<p>我们接着讨论回溯时的情况</p>
<p>一、当前孩子为“非独生”左孩子，那就去遍历他的父节点的右子树</p>
<p>二、当前节点为“独生”左孩子，或者当前节点为右孩子，说明到了它的父节点被遍历的时候了</p>
<p>下面给出这个算法的实现：</p>
<pre><code class="hljs language-scss" lang="scss">template&lt;typename T, typename VST&gt;
void <span class="hljs-built_in">traverse</span>(bin_node&lt;T&gt;* node, VST&amp; visit)
{
	if (node == nullptr) return;<span class="hljs-comment">//边界情况</span>

	while (true)
	{
		if (node-&gt;get_left_child() != nullptr)node = node-&gt;<span class="hljs-built_in">get_left_child</span>();<span class="hljs-comment">//如果有左孩子，就向左</span>
		else if (node-&gt;get_right_child() != nullptr)node = node-&gt;<span class="hljs-built_in">get_right_child</span>();<span class="hljs-comment">//如果没有左孩子，但是有右孩子，就向右</span>

		else <span class="hljs-comment">//都没有，说明是叶节点，开始回溯</span>
		{
			<span class="hljs-built_in">visit</span>(node);
			while (true)
			{
				if (node-&gt;get_parent() == nullptr)break;<span class="hljs-comment">//如果追溯到根节点，说明整棵树遍历完了，退出循环</span>
				if (node == node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_left_child</span>())<span class="hljs-comment">//如果是父节点的左孩子，讨论是否“独生”</span>
				{
					if (node-&gt;get_parent()-&gt;<span class="hljs-built_in">get_right_child</span>() == nullptr)<span class="hljs-built_in">visit</span>(node-&gt;get_parent());<span class="hljs-comment">//如果独生，说明父节点左右子树均遍历完，到了他被遍历的时候</span>
					else break;<span class="hljs-comment">//如果非独生，就退出循环，去遍历父节点的右子树</span>
				}
				else<span class="hljs-comment">//如果是父节点的右孩子，那就遍历父节点，继续回溯</span>
				{
					<span class="hljs-built_in">visit</span>(node-&gt;get_parent());
				}

				node = node-&gt;<span class="hljs-built_in">get_parent</span>();
			}
                        if (node-&gt;get_parent() == nullptr) return;<span class="hljs-comment">//如果追溯到根节点的上方，说明遍历完了</span>
                        node = node-&gt;<span class="hljs-built_in">get_parent</span>()-&gt;<span class="hljs-built_in">get_right_child</span>();
		}

	}
}
</code></pre>
<h3 data-id="heading-5">总结</h3>
<p>我认为这个算法是有价值的</p>
<p>首先，空间上：对于自带父指针的树，他的额外空间复杂度是O(1),就算是算上父指针也不过O(n)，还能避免栈溢出的问题。</p>
<p>形式上，不难看出，三种遍历算法的逻辑和代码实现都是高度统一的。</p>
<p>时间上，省去了入栈出栈的操作，代价是每个非叶子节点都要被node“经过”两次。总体上，时间复杂度对比传统的辅助栈方法是小优，仍然是O(n)</p>
<p>当然也有缺点，首先是这个父指针的事吧，我跟着课堂上实现的二叉树版本是自带父指针的，我也不知道这个父指针的泛用性咋样。还有就是代码逻辑对比传统的辅助栈方法确实不那么简明，但我觉得还好。（不知道看到这里的你看懂了吗？）</p>
<p>事实上，对于层次遍历，我也自己推导出了“无队列版本”，但为了保证这篇博客内容的统一性，就不放在这里了。有兴趣的朋友可以私信交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java没有指针，那它是怎么干C语言里指针干的活的？]]></title>    <link>https://juejin.cn/post/7574997924931043368</link>    <guid>https://juejin.cn/post/7574997924931043368</guid>    <pubDate>2025-11-22T07:06:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574997924931043368" data-draft-id="7575103881420881974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java没有指针，那它是怎么干C语言里指针干的活的？"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-22T07:06:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XUN4J"/> <meta itemprop="url" content="https://juejin.cn/user/4179664935335515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java没有指针，那它是怎么干C语言里指针干的活的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4179664935335515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XUN4J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T07:06:01.000Z" title="Sat Nov 22 2025 07:06:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一句话简单回答就是：<strong>Java虽然有指针，但到处都是指针的影子！只是Java通过JVM把它隐藏了起来，不让你用C/C++那种显式的方式操作它。我们把这个东西称之为“引用”。</strong></p>
<hr/>
<h3 data-id="heading-0">一、C/CPP指针与Java引用的对比：</h3>
<p>C/CPP的指针被JVM包装成了更加安全的Java引用</p>






























<table><thead><tr><th>特性</th><th>C++ 指针</th><th>Java 引用</th></tr></thead><tbody><tr><td><strong>语法</strong>​</td><td><code>MyClass *obj = new MyClass();</code></td><td><code>MyClass obj = new MyClass();</code></td></tr><tr><td><strong>本质</strong>​</td><td>存储另一个变量的内存地址</td><td><strong>本质上也是存储对象的内存地址</strong>​</td></tr><tr><td><strong>操作</strong>​</td><td>可以进行算术运算（<code>++</code>, <code>--</code>）、任意转换</td><td>不能进行算术运算，类型安全</td></tr><tr><td><strong>目标</strong>​</td><td>可以指向任何内存地址（包括无效的）</td><td>只能指向有效的对象或<code>null</code></td></tr></tbody></table>
<p>所以说，并不是Java里没有指针，而是强大的JVM帮我们把指针操作更包装成一个更安全、不需要担心回收的引用。</p>
<hr/>
<h3 data-id="heading-1">二、Java执行MyClass obj = new MyClass()到底发生了什么</h3>
<p>1、声明引用变量MyClass obj时，JVM在当前方法的栈帧（Stack中）中分配一个引用变量的空间给obj；</p>
<p>2、创建实例化对象new MyClass()时，JVM在堆区（Heap）分配足够的内存来存储MyClass对象的所有数据</p>
<p>3、建立指向关系=，将堆中对象的内存地址赋值给栈中的引用变量obj，使得引用指向实例化对象。</p>
<p>补充JVM架构图：</p>
<h2 data-id="heading-2"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/323cc03737a249d1be87fecf54fe3946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWFVONEo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764473417&amp;x-signature=IbUHMLDevRi6%2BTmsGCbCUfn0C5c%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-3">三、JVM还包装了哪些机制</h3>
<ol>
<li>垃圾回收机制
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>(); <span class="hljs-comment">// 手动分配</span>
<span class="hljs-comment">// ... 使用对象</span>
obj = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 无需手动释放！垃圾回收器会自动回收内存</span>
</code></pre>
</li>
</ol>
<ul>
<li>Java有一个后台的<strong>垃圾回收器GC</strong>，它会自动监控哪些对象不再被任何引用指向。</li>
<li>当对象变得“不可达”时，GC会在某个时间点自动释放它们占用的内存。</li>
<li><strong>优势</strong>：避免了可怕的内存泄漏和悬空指针问题。</li>
<li><strong>代价</strong>：程序员无法控制内存释放的精确时机，可能有性能开销。</li>
</ul>
<h4 data-id="heading-4">2. 完全禁止指针算术和直接内存操作</h4>
<p>C/C++可以通过操作指针进一步操作内存，这是它强大但也危险的地方。但是考虑到Java是站在C/CPP之上的语言，它完全摈弃了指针算术和直接内存操作，</p>
<p>通过禁止这些操作，Java保证了：</p>
<ul>
<li><strong>内存安全</strong>：程序不会意外覆盖随机内存，导致崩溃。</li>
<li><strong>类型安全</strong>：避免了因类型转换错误导致的数据损坏。</li>
<li><strong>可移植性</strong>：Java程序不依赖特定硬件的内存布局。</li>
</ul>
<h3 data-id="heading-5">四、CPP与Java在函数参数传递的区别（引用传递）</h3>
<p>CPP可以在方法的参数列表上指定到底是传参数的数值还是引用，但对于Java来说：
<strong>Java里对于方法传入的是对象就是对象引用的副本，如果是基本类型就是值的副本，不会影响本身。</strong></p>
<p>温馨提示：1、String虽然是数组，但是由于String的final属性，传入方法后，还是不能对其本身进行修改（若需要修改可以使用StringBuilder对象）；2、数组也是对象哦（这个确实是基本常识，但是我刚学Java时老是觉得int [] arr是基本数据类型hhh，所以在这儿提醒下刚学Java的小白）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BLE 通信设计与架构落地]]></title>    <link>https://juejin.cn/post/7575006095389573129</link>    <guid>https://juejin.cn/post/7575006095389573129</guid>    <pubDate>2025-11-22T04:35:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575006095389573129" data-draft-id="7575017581037322278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BLE 通信设计与架构落地"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2025-11-22T04:35:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星月赶路人"/> <meta itemprop="url" content="https://juejin.cn/user/3491704661625079"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BLE 通信设计与架构落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704661625079/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星月赶路人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T04:35:40.000Z" title="Sat Nov 22 2025 04:35:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>面向低功耗、稳定可靠 BLE 通信方案，从软件设计目标、方案选型到分层架构与关键流程，配套流程图与实现要点，直达量产质量与研发效率。</p>
</blockquote>
<h2 data-id="heading-0">背景与目标</h2>
<ul>
<li>背景：电机控制、状态采集、故障诊断与 OTA 升级都依赖移动端与设备端的低延迟、低功耗、稳定连接。</li>
<li>目标：低功耗、快速连接、高可靠传输、应用层安全、可扩展协议、易维护 SDK。</li>
</ul>
<h2 data-id="heading-1">架构总览</h2>
<ul>
<li>分层清晰：UI → SDK → 协议 → BLE 客户端 → 设备固件 → 服务/状态机</li>
<li>控制与状态分离：控制通道低延迟，状态通道稳定流式；OTA 独立不阻塞控制</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ed4d399aa24dd08f095b968ed072e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5pyI6LW26Lev5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764393562&amp;x-signature=VpauAQ5YtF%2B5M1sk9dwPadNHipY%3D" alt="截屏2025-11-22 12.45.56.png" loading="lazy"/></p>
<h2 data-id="heading-2">方案选型</h2>
<ul>
<li>传输：基于 GATT；命令走写入特征，设备通过通知特征上行响应与事件。</li>
<li>编码：采用起止分隔符与转义机制，配合 XOR 校验保证帧边界与数据一致性；帧结构为 <code>7E | cmd(1) | len(2) | payload | xor(1) | 7E</code>。</li>
<li>命令集：包含应用版本查询、应用控制设置、仪表信息上报、控制响应等，区分查询型与设置型。</li>
<li>解析：先进行包格式与校验验证，再按协议掩码解析为结构化的状态/响应模型。</li>
<li>MTU：优先协商更大 MTU 值，写入根据协商结果自动选择短写或长写以提升吞吐。</li>
<li>服务与特征：定义稳定的服务 UUID 与写/通知特征 UUID；扫描阶段可结合常见服务进行辅助过滤提升发现成功率。</li>
</ul>
<h2 data-id="heading-3">连接生命周期</h2>
<ul>
<li>秒级发现、自动检测系统已连/已配对设备；MTU 协商后开启 Notify 再发指令</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  A[扫描广播] --&gt; B{过滤设备}
  B --&gt;|匹配UUID/厂商数据| C[建立GATT连接]
  C --&gt; D[MTU协商]
  D --&gt; E[订阅Notify特征]
  E --&gt; F[开启通知]
  F --&gt; G[正常通信]
  H --&gt; I{断链?}
  I --&gt;|是| J[退回扫描/优先重连]
  I --&gt;|否| H
</code></pre>
<h2 data-id="heading-4">指令与应答</h2>
<ul>
<li>上层采用统一命令模型构建请求，协议层负责组帧与发送；设备通过通知返回响应或状态，协议处理器完成验证与解析，上层按请求-响应模式匹配回调。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  participant App
  participant SDK
  participant Device

  App-&gt;&gt;SDK: send(Command)
  SDK-&gt;&gt;SDK: 组帧(7E/转义/XOR)
  SDK-&gt;&gt;Device: 写入数据包
  Device--&gt;&gt;SDK: 通知上行数据包
  SDK--&gt;&gt;SDK: 验证/解析为模型
  SDK--&gt;&gt;App: 回调(响应/状态)
</code></pre>
<h2 data-id="heading-5">服务与特征</h2>
<ul>
<li>服务与特征保持稳定命名，便于跨端协作与维护；扫描阶段可结合通用服务过滤以提升发现效率。</li>
<li>写入策略根据 MTU 协商结果选择短写/长写，兼顾效率与兼容性。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
  CtrlSvc[控制服务 0xFFF0] --&gt; cmd_write[cmd_write: Write NR]
  CtrlSvc --&gt; cmd_notify[cmd_notify: Notify]
  StateSvc[状态服务 0xFFF1] --&gt; state_notify[state_notify: Notify]
  OTASvc[OTA服务 0xFFF2] --&gt; ota_write[ota_write: Write]
  OTASvc --&gt; ota_notify[ota_notify: Notify]
</code></pre>
<h2 data-id="heading-6">协议帧设计</h2>
<ul>
<li>结构：<code>7E | cmd(1) | len(2,BE) | payload(N) | xor(1) | 7E</code>。</li>
<li>转义：对分隔符与转义字符采用双字节转义，保证帧边界不被误判。</li>
<li>校验：使用 XOR 校验覆盖命令、长度与载荷，快速验证数据一致性。</li>
<li>验证：先校验起止与最小长度，再重算校验对比，失败立即丢弃并上报错误。</li>
</ul>
<h2 data-id="heading-7">安全策略（可选）</h2>
<ul>
<li>基于明文帧 + 校验的基本可靠性方案；如需加强安全，可在载荷层加入签名与时间戳，或在连接建立后协商会话密钥并进行载荷加密与认证。</li>
</ul>
<h2 data-id="heading-8">OTA 升级</h2>
<ul>
<li>使用长写支持大数据包传输，结合 MTU 协商提升吞吐；分片与断点续传由上层控制，升级流程与控制通道隔离，保障常规通信不受影响。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
  Start[开始升级] --&gt; Prepare[校验包/签名/版本]
  Prepare --&gt; Switch[进入DFU模式/暂停控制通道]
  Switch --&gt; Chunk[分片发送]
  Chunk --&gt; Ack{应答/校验通过?}
  Ack --&gt;|否| Retry[重传/断点续传]
  Ack --&gt;|是| Commit[提交/应用新固件]
  Commit --&gt; Reboot[重启/回到正常模式]
  Reboot --&gt; End[升级完成]
</code></pre>
<h2 data-id="heading-9">低功耗策略</h2>
<ul>
<li>广播：普通 300–500ms；待机 800–1200ms；事件触发短时提升</li>
<li>连接：<code>interval=30–50ms</code>、<code>slaveLatency=4–10</code>、<code>timeout=4–6s</code></li>
<li>MTU：协商至 185，分片随 ATT 与机型差异自适应</li>
<li>节流：状态合并与节流（100–200ms）；小包合帧减少唤醒</li>
</ul>
<h2 data-id="heading-10">关键实现要点</h2>
<ul>
<li>重传窗口：大小 3–5；超时 300–500ms；指数退避防抖</li>
<li>指令模型：区分必答控制与可跳过状态；明确重试与时限</li>
<li>线程模型：移动端 BLE 回调线程与业务线程解耦；设备侧事件与控制循环分离</li>
<li>指标与日志：连接时延、MTU、吞吐、丢包、重试、握手耗时、失败原因</li>
</ul>
<h2 data-id="heading-11">调试与调优</h2>
<ul>
<li>吞吐压测：不同 MTU 下 <code>pps/重试率</code> 对比；寻找最佳分片</li>
<li>稳定性：高干扰场景（电机 PWM/金属环境）重连成功率与耗时</li>
<li>兼容性：iOS/Android 栈差异（如 Android GATT 133）；连接后强制 <code>discoverServices</code></li>
<li>低功耗验证：记录电流曲线，量化参数调整影响</li>
<li>OTA 可靠性：断电/断链恢复、双镜像回滚、进度一致性</li>
</ul>
<h2 data-id="heading-12">常见坑与规避</h2>
<ul>
<li>iOS 后台：后台模式声明与速率控制；避免系统挂起</li>
<li>Android 缓存：特征缓存可能写旧；连接后重新 <code>discoverServices</code></li>
<li>MTU 协商：必须在连接成功后；返回值可能不等于实际可用</li>
<li>Notify 订阅：先订阅再发指令；避免早期响应丢失</li>
<li>多连接：一车一连；设备侧拒绝第二连接请求</li>
</ul>
<h2 data-id="heading-13">实现思路要点</h2>
<ul>
<li>命令模型统一、组帧规范化、解析结构化，方便扩展与回归测试。</li>
<li>请求-响应严格时序：先订阅响应流，再发送请求，避免早期响应丢失。</li>
<li>设备数据流按设备维度隔离，支持多设备并发管理与订阅清理。</li>
<li>日志与指标贯穿链路：连接与协商、吞吐与丢包、解析与错误，辅助定位与调优。</li>
</ul>
<h2 data-id="heading-14">结语</h2>
<ul>
<li>核心在于稳定、可靠与可维护。围绕 GATT 传输、稳健的帧/转义/校验与清晰的请求-响应模式，既保证 eBike 场景的低功耗与高可靠，又为后续安全与功能扩展留足空间。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实战：为开源记账 App 实现优雅的暗黑模式（Design Token + 动态主题）]]></title>    <link>https://juejin.cn/post/7575047994681409587</link>    <guid>https://juejin.cn/post/7575047994681409587</guid>    <pubDate>2025-11-22T03:39:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575047994681409587" data-draft-id="7575031395861954606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实战：为开源记账 App 实现优雅的暗黑模式（Design Token + 动态主题）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-22T03:39:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈阿笑"/> <meta itemprop="url" content="https://juejin.cn/user/2629687543598200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实战：为开源记账 App 实现优雅的暗黑模式（Design Token + 动态主题）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2629687543598200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈阿笑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:39:57.000Z" title="Sat Nov 22 2025 03:39:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近为我的开源记账 App <strong>BeeCount 蜜蜂记账</strong> 实现了暗黑模式，踩了不少坑，也总结了一些经验。这篇文章会详细介绍整个技术方案和实现过程，希望对大家有帮助。</p>
<h2 data-id="heading-0">效果预览</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/658b1a6c6cc84142a18a332bf9fe1083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=b6%2FqlRbiSLdECrbuJJeDS1dR7KA%3D" alt="1.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/347a91474a024be5ab6b6173cbee9c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=wL0xB%2Fjb%2FIAVCZgavkzDatqtybY%3D" alt="2.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96fede5bf2ff4191b5865c5c186dfb9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=cbj4VI654C8oiqYhwsm8MlFLkdk%3D" alt="3.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b1c4999b8f451ebf7e2a8110340301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=%2FBir%2B%2Bovdjla2d7AOFxZT%2BmBIhY%3D" alt="4.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee2186803b624a02b5e27149e275c22b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=nqilFMljrb2M%2FRNnGaAHi1ffTlU%3D" alt="5.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8299ea97865944578bb5724e19f6d9a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI6Zi_56yR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764387597&amp;x-signature=mNeSEkUU2XjM39ZiqOMCbPwsHZY%3D" alt="6.jpg" loading="lazy"/></p>
<p>暗黑模式采用「<strong>纯黑背景 + 主题色边框</strong>」的设计方案：</p>
<ul>
<li>纯黑背景：OLED 友好，夜间护眼</li>
<li>主题色边框：保留个性化，层次分明</li>
<li>全局适配：所有页面、组件统一风格</li>
</ul>
<hr/>
<h2 data-id="heading-1">技术方案概述</h2>
<p>在开始写代码之前，我先梳理了整体的技术方案：</p>
<ol>
<li><strong>Design Token 系统</strong>：统一管理所有颜色，一处修改全局生效</li>
<li><strong>主题状态管理</strong>：使用 Riverpod 管理主题模式，支持持久化</li>
<li><strong>MaterialApp 配置</strong>：配置 theme 和 darkTheme，支持跟随系统切换</li>
<li><strong>组件级适配</strong>：针对特殊组件（图表、弹窗等）单独处理</li>
</ol>
<p>下面逐一介绍。</p>
<hr/>
<h2 data-id="heading-2">1. Design Token 系统</h2>
<h3 data-id="heading-3">为什么需要 Design Token？</h3>
<p>项目初期，颜色都是硬编码的：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 到处都是这种代码</span>
Text(<span class="hljs-string">'Hello'</span>, style: TextStyle(color: Colors.black87))
Container(color: Colors.white)
</code></pre>
<p>这样做的问题：</p>
<ul>
<li>要支持暗黑模式，得全局搜索替换</li>
<li>颜色值不统一，同样的「次要文字」可能写成 <code>black54</code>、<code>grey</code>、<code>Colors.grey.shade600</code></li>
<li>维护困难，改一个颜色要改 N 个地方</li>
</ul>
<p>所以我借鉴了 Web 前端的 <strong>CSS Variables</strong> 思路，建立了一套 Design Token 系统。</p>
<h3 data-id="heading-4">核心实现</h3>
<p><strong>文件：<code>lib/styles/tokens.dart</code></strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">Design Token 系统</span></span>
<span class="hljs-comment">/// <span class="markdown">统一管理所有颜色，自动适配亮色/暗黑模式</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BeeTokens</span> </span>{

  <span class="hljs-comment">// ========== 工具方法 ==========</span>

  <span class="hljs-comment">/// <span class="markdown">判断当前是否暗黑模式</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isDark(BuildContext context) {
    <span class="hljs-keyword">return</span> Theme.of(context).brightness == Brightness.dark;
  }

  <span class="hljs-comment">/// <span class="markdown">获取主题色</span></span>
  <span class="hljs-keyword">static</span> Color primary(BuildContext context) {
    <span class="hljs-keyword">return</span> Theme.of(context).primaryColor;
  }

  <span class="hljs-comment">// ========== 背景色 ==========</span>

  <span class="hljs-comment">/// <span class="markdown">页面背景色</span></span>
  <span class="hljs-keyword">static</span> Color scaffoldBackground(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.black : <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFF5F5F5</span>);
  }

  <span class="hljs-comment">/// <span class="markdown">卡片/表面背景色</span></span>
  <span class="hljs-keyword">static</span> Color surface(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.black : Colors.white;
  }

  <span class="hljs-comment">/// <span class="markdown">提升的表面（如弹窗、下拉菜单）</span></span>
  <span class="hljs-keyword">static</span> Color surfaceElevated(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFF1C1C1E</span>) : Colors.white;
  }

  <span class="hljs-comment">/// <span class="markdown">Header 背景色</span></span>
  <span class="hljs-keyword">static</span> Color surfaceHeader(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.black : Colors.white;
  }

  <span class="hljs-comment">// ========== 文字颜色 ==========</span>

  <span class="hljs-comment">/// <span class="markdown">主要文字（标题、正文）</span></span>
  <span class="hljs-keyword">static</span> Color textPrimary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white : Colors.black87;
  }

  <span class="hljs-comment">/// <span class="markdown">次要文字（说明文字、副标题）</span></span>
  <span class="hljs-keyword">static</span> Color textSecondary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white70 : Colors.black54;
  }

  <span class="hljs-comment">/// <span class="markdown">提示文字（placeholder、禁用状态）</span></span>
  <span class="hljs-keyword">static</span> Color textTertiary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white38 : Colors.black38;
  }

  <span class="hljs-comment">// ========== 图标颜色 ==========</span>

  <span class="hljs-keyword">static</span> Color iconPrimary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white : Colors.black87;
  }

  <span class="hljs-keyword">static</span> Color iconSecondary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white70 : Colors.black54;
  }

  <span class="hljs-keyword">static</span> Color iconTertiary(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white38 : Colors.black38;
  }

  <span class="hljs-comment">// ========== 边框和分割线 ==========</span>

  <span class="hljs-comment">/// <span class="markdown">普通边框</span></span>
  <span class="hljs-keyword">static</span> Color border(BuildContext context) {
    <span class="hljs-keyword">if</span> (isDark(context)) {
      <span class="hljs-keyword">return</span> Theme.of(context).primaryColor.withOpacity(<span class="hljs-number">0.3</span>);
    }
    <span class="hljs-keyword">return</span> Colors.grey.shade200;
  }

  <span class="hljs-comment">/// <span class="markdown">分割线</span></span>
  <span class="hljs-keyword">static</span> Color divider(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? Colors.white12 : Colors.grey.shade200;
  }

  <span class="hljs-comment">/// <span class="markdown">主题色边框（用于强调）</span></span>
  <span class="hljs-keyword">static</span> Color borderThemed(BuildContext context) {
    <span class="hljs-keyword">return</span> Theme.of(context).primaryColor.withOpacity(<span class="hljs-number">0.3</span>);
  }

  <span class="hljs-comment">// ========== 语义颜色 ==========</span>

  <span class="hljs-comment">/// <span class="markdown">成功色（收入、正数）</span></span>
  <span class="hljs-keyword">static</span> Color success(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFF4CD964</span>) : <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFF34C759</span>);
  }

  <span class="hljs-comment">/// <span class="markdown">错误色（支出、负数、错误提示）</span></span>
  <span class="hljs-keyword">static</span> Color error(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFFF6B6B</span>) : <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFFF3B30</span>);
  }

  <span class="hljs-comment">/// <span class="markdown">警告色</span></span>
  <span class="hljs-keyword">static</span> Color warning(BuildContext context) {
    <span class="hljs-keyword">return</span> isDark(context) ? <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFFFD60A</span>) : <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFFF9500</span>);
  }
}
</code></pre>
<h3 data-id="heading-5">使用方式</h3>
<p>替换原来的硬编码颜色：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 之前</span>
Container(
  color: Colors.white,
  child: Text(
    <span class="hljs-string">'Hello'</span>,
    style: TextStyle(color: Colors.black87),
  ),
)

<span class="hljs-comment">// ✅ 之后</span>
Container(
  color: BeeTokens.surface(context),
  child: Text(
    <span class="hljs-string">'Hello'</span>,
    style: TextStyle(color: BeeTokens.textPrimary(context)),
  ),
)
</code></pre>
<h3 data-id="heading-6">Token 命名规范</h3>
<p>我采用了语义化命名，让代码更易读：</p>



























































<table><thead><tr><th>Token</th><th>用途</th><th>亮色</th><th>暗色</th></tr></thead><tbody><tr><td><code>scaffoldBackground</code></td><td>页面背景</td><td>#F5F5F5</td><td>#000000</td></tr><tr><td><code>surface</code></td><td>卡片背景</td><td>#FFFFFF</td><td>#000000</td></tr><tr><td><code>surfaceElevated</code></td><td>弹窗背景</td><td>#FFFFFF</td><td>#1C1C1E</td></tr><tr><td><code>textPrimary</code></td><td>主要文字</td><td>black87</td><td>white</td></tr><tr><td><code>textSecondary</code></td><td>次要文字</td><td>black54</td><td>white70</td></tr><tr><td><code>textTertiary</code></td><td>提示文字</td><td>black38</td><td>white38</td></tr><tr><td><code>border</code></td><td>卡片边框</td><td>grey200</td><td>主题色30%</td></tr><tr><td><code>divider</code></td><td>分割线</td><td>grey200</td><td>white12</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">2. 主题状态管理</h2>
<h3 data-id="heading-8">Provider 定义</h3>
<p>使用 Riverpod 管理主题状态：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_riverpod/flutter_riverpod.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:shared_preferences/shared_preferences.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">主题模式枚举</span></span>
<span class="hljs-keyword">enum</span> ThemeModeOption {
  system,  <span class="hljs-comment">// 跟随系统</span>
  light,   <span class="hljs-comment">// 始终亮色</span>
  dark,    <span class="hljs-comment">// 始终暗黑</span>
}

<span class="hljs-comment">/// <span class="markdown">扩展方法：转换为 Flutter 的 ThemeMode</span></span>
<span class="hljs-keyword">extension</span> ThemeModeOptionExtension <span class="hljs-keyword">on</span> ThemeModeOption {
  ThemeMode toThemeMode() {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ThemeModeOption.system:
        <span class="hljs-keyword">return</span> ThemeMode.system;
      <span class="hljs-keyword">case</span> ThemeModeOption.light:
        <span class="hljs-keyword">return</span> ThemeMode.light;
      <span class="hljs-keyword">case</span> ThemeModeOption.dark:
        <span class="hljs-keyword">return</span> ThemeMode.dark;
    }
  }

  <span class="hljs-built_in">String</span> toDisplayName(BuildContext context) {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ThemeModeOption.system:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'跟随系统'</span>;
      <span class="hljs-keyword">case</span> ThemeModeOption.light:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'始终亮色'</span>;
      <span class="hljs-keyword">case</span> ThemeModeOption.dark:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'始终暗黑'</span>;
    }
  }
}

<span class="hljs-comment">/// <span class="markdown">主题模式 Provider</span></span>
<span class="hljs-keyword">final</span> themeModeProvider = StateNotifierProvider&lt;ThemeModeNotifier, ThemeModeOption&gt;((ref) {
  <span class="hljs-keyword">return</span> ThemeModeNotifier();
});

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThemeModeNotifier</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StateNotifier</span>&lt;<span class="hljs-title">ThemeModeOption</span>&gt; </span>{
  ThemeModeNotifier() : <span class="hljs-keyword">super</span>(ThemeModeOption.system) {
    _loadFromPrefs();
  }

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _key = <span class="hljs-string">'theme_mode'</span>;

  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadFromPrefs() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> value = prefs.getString(_key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) {
      state = ThemeModeOption.values.firstWhere(
        (e) =&gt; e.name == value,
        orElse: () =&gt; ThemeModeOption.system,
      );
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; setThemeMode(ThemeModeOption mode) <span class="hljs-keyword">async</span> {
    state = mode;
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> prefs.setString(_key, mode.name);
  }
}
</code></pre>
<h3 data-id="heading-9">主题色 Provider</h3>
<p>用户可以自定义主题色，这个也要持久化：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">预设主题色列表</span></span>
<span class="hljs-keyword">const</span> <span class="hljs-built_in">List</span>&lt;Color&gt; presetColors = [
  Color(<span class="hljs-number">0xFFFFB020</span>), <span class="hljs-comment">// 蜜蜂黄（默认）</span>
  Color(<span class="hljs-number">0xFFFF6B6B</span>), <span class="hljs-comment">// 珊瑚红</span>
  Color(<span class="hljs-number">0xFF4ECDC4</span>), <span class="hljs-comment">// 薄荷绿</span>
  Color(<span class="hljs-number">0xFF5C7AEA</span>), <span class="hljs-comment">// 靛蓝</span>
  Color(<span class="hljs-number">0xFFAB47BC</span>), <span class="hljs-comment">// 紫罗兰</span>
  Color(<span class="hljs-number">0xFF26A69A</span>), <span class="hljs-comment">// 青绿</span>
  Color(<span class="hljs-number">0xFFEC407A</span>), <span class="hljs-comment">// 粉红</span>
  Color(<span class="hljs-number">0xFF42A5F5</span>), <span class="hljs-comment">// 天蓝</span>
];

<span class="hljs-comment">/// <span class="markdown">主题色 Provider</span></span>
<span class="hljs-keyword">final</span> primaryColorProvider = StateNotifierProvider&lt;PrimaryColorNotifier, Color&gt;((ref) {
  <span class="hljs-keyword">return</span> PrimaryColorNotifier();
});

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrimaryColorNotifier</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StateNotifier</span>&lt;<span class="hljs-title">Color</span>&gt; </span>{
  PrimaryColorNotifier() : <span class="hljs-keyword">super</span>(presetColors[<span class="hljs-number">0</span>]) {
    _loadFromPrefs();
  }

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _key = <span class="hljs-string">'primary_color'</span>;

  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadFromPrefs() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> value = prefs.getInt(_key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) {
      state = Color(value);
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; setPrimaryColor(Color color) <span class="hljs-keyword">async</span> {
    state = color;
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> prefs.setInt(_key, color.value);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">3. MaterialApp 配置</h2>
<p>在 App 入口处配置主题：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConsumerWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context, WidgetRef ref) {
    <span class="hljs-keyword">final</span> themeMode = ref.watch(themeModeProvider);
    <span class="hljs-keyword">final</span> primaryColor = ref.watch(primaryColorProvider);

    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'BeeCount'</span>,

      <span class="hljs-comment">// 主题模式</span>
      themeMode: themeMode.toThemeMode(),

      <span class="hljs-comment">// 亮色主题</span>
      theme: ThemeData(
        brightness: Brightness.light,
        primaryColor: primaryColor,
        scaffoldBackgroundColor: <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFF5F5F5</span>),
        colorScheme: ColorScheme.light(
          primary: primaryColor,
          secondary: primaryColor,
          surface: Colors.white,
        ),
        appBarTheme: AppBarTheme(
          backgroundColor: Colors.white,
          foregroundColor: Colors.black87,
          elevation: <span class="hljs-number">0</span>,
          systemOverlayStyle: SystemUiOverlayStyle.dark,
        ),
        dividerTheme: DividerThemeData(
          color: Colors.grey.shade200,
          thickness: <span class="hljs-number">0.5</span>,
        ),
        <span class="hljs-comment">// ... 其他配置</span>
      ),

      <span class="hljs-comment">// 暗黑主题</span>
      darkTheme: ThemeData(
        brightness: Brightness.dark,
        primaryColor: primaryColor,
        scaffoldBackgroundColor: Colors.black,
        colorScheme: ColorScheme.dark(
          primary: primaryColor,
          secondary: primaryColor,
          surface: Colors.black,
        ),
        appBarTheme: AppBarTheme(
          backgroundColor: Colors.black,
          foregroundColor: Colors.white,
          elevation: <span class="hljs-number">0</span>,
          systemOverlayStyle: SystemUiOverlayStyle.light,
        ),
        dividerTheme: <span class="hljs-keyword">const</span> DividerThemeData(
          color: Colors.white12,
          thickness: <span class="hljs-number">0.5</span>,
        ),
        <span class="hljs-comment">// ... 其他配置</span>
      ),

      home: <span class="hljs-keyword">const</span> HomePage(),
    );
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-11">4. 组件级适配</h2>
<h3 data-id="heading-12">卡片组件</h3>
<p>封装一个统一的卡片组件：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BeeCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry? padding;
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry? margin;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> borderRadius;

  <span class="hljs-keyword">const</span> BeeCard({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child,
    <span class="hljs-keyword">this</span>.padding,
    <span class="hljs-keyword">this</span>.margin,
    <span class="hljs-keyword">this</span>.borderRadius = <span class="hljs-number">12</span>,
  });

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> isDark = BeeTokens.isDark(context);

    <span class="hljs-keyword">return</span> Container(
      margin: margin,
      padding: padding ?? <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      decoration: BoxDecoration(
        color: BeeTokens.surface(context),
        borderRadius: BorderRadius.circular(borderRadius),
        <span class="hljs-comment">// 暗黑模式：主题色边框</span>
        border: isDark
            ? Border.all(color: BeeTokens.border(context), width: <span class="hljs-number">1</span>)
            : <span class="hljs-keyword">null</span>,
        <span class="hljs-comment">// 亮色模式：阴影</span>
        boxShadow: isDark
            ? <span class="hljs-keyword">null</span>
            : [
                BoxShadow(
                  color: Colors.black.withOpacity(<span class="hljs-number">0.05</span>),
                  blurRadius: <span class="hljs-number">8</span>,
                  offset: <span class="hljs-keyword">const</span> Offset(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
                ),
              ],
      ),
      child: child,
    );
  }
}
</code></pre>
<h3 data-id="heading-13">图表适配</h3>
<p>使用 <code>fl_chart</code> 库时，需要单独处理颜色：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:fl_chart/fl_chart.dart'</span>;

Widget buildLineChart(BuildContext context, <span class="hljs-built_in">List</span>&lt;FlSpot&gt; spots) {
  <span class="hljs-keyword">final</span> isDark = BeeTokens.isDark(context);
  <span class="hljs-keyword">final</span> primaryColor = Theme.of(context).primaryColor;

  <span class="hljs-keyword">return</span> LineChart(
    LineChartData(
      <span class="hljs-comment">// 网格线</span>
      gridData: FlGridData(
        <span class="hljs-keyword">show</span>: <span class="hljs-keyword">true</span>,
        drawVerticalLine: <span class="hljs-keyword">false</span>,
        horizontalInterval: <span class="hljs-number">1</span>,
        getDrawingHorizontalLine: (value) =&gt; FlLine(
          color: isDark ? Colors.white10 : Colors.grey.shade200,
          strokeWidth: <span class="hljs-number">1</span>,
        ),
      ),

      <span class="hljs-comment">// 边框</span>
      borderData: FlBorderData(
        <span class="hljs-keyword">show</span>: <span class="hljs-keyword">true</span>,
        border: Border(
          bottom: BorderSide(
            color: isDark ? Colors.white24 : Colors.grey.shade300,
          ),
          left: BorderSide(
            color: isDark ? Colors.white24 : Colors.grey.shade300,
          ),
        ),
      ),

      <span class="hljs-comment">// 坐标轴标题</span>
      titlesData: FlTitlesData(
        bottomTitles: AxisTitles(
          sideTitles: SideTitles(
            showTitles: <span class="hljs-keyword">true</span>,
            getTitlesWidget: (value, meta) =&gt; Text(
              <span class="hljs-string">'<span class="hljs-subst">${value.toInt()}</span>'</span>,
              style: TextStyle(
                color: BeeTokens.textSecondary(context),
                fontSize: <span class="hljs-number">12</span>,
              ),
            ),
          ),
        ),
        leftTitles: AxisTitles(
          sideTitles: SideTitles(
            showTitles: <span class="hljs-keyword">true</span>,
            getTitlesWidget: (value, meta) =&gt; Text(
              <span class="hljs-string">'<span class="hljs-subst">${value.toInt()}</span>'</span>,
              style: TextStyle(
                color: BeeTokens.textSecondary(context),
                fontSize: <span class="hljs-number">12</span>,
              ),
            ),
          ),
        ),
        topTitles: <span class="hljs-keyword">const</span> AxisTitles(sideTitles: SideTitles(showTitles: <span class="hljs-keyword">false</span>)),
        rightTitles: <span class="hljs-keyword">const</span> AxisTitles(sideTitles: SideTitles(showTitles: <span class="hljs-keyword">false</span>)),
      ),

      <span class="hljs-comment">// 数据线</span>
      lineBarsData: [
        LineChartBarData(
          spots: spots,
          isCurved: <span class="hljs-keyword">true</span>,
          color: primaryColor,
          barWidth: <span class="hljs-number">2</span>,
          dotData: FlDotData(
            <span class="hljs-keyword">show</span>: <span class="hljs-keyword">true</span>,
            getDotPainter: (spot, percent, barData, index) {
              <span class="hljs-keyword">return</span> FlDotCirclePainter(
                radius: <span class="hljs-number">4</span>,
                color: primaryColor,
                strokeWidth: <span class="hljs-number">2</span>,
                strokeColor: isDark ? Colors.black : Colors.white,
              );
            },
          ),
          belowBarData: BarAreaData(
            <span class="hljs-keyword">show</span>: <span class="hljs-keyword">true</span>,
            color: primaryColor.withOpacity(<span class="hljs-number">0.1</span>),
          ),
        ),
      ],
    ),
  );
}
</code></pre>
<h3 data-id="heading-14">弹窗适配</h3>
<p><code>showModalBottomSheet</code>、<code>showDialog</code> 等弹窗需要单独处理：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;T?&gt; showBeeBottomSheet&lt;T&gt;({
  <span class="hljs-keyword">required</span> BuildContext context,
  <span class="hljs-keyword">required</span> WidgetBuilder builder,
  <span class="hljs-built_in">bool</span> isScrollControlled = <span class="hljs-keyword">false</span>,
}) {
  <span class="hljs-keyword">return</span> showModalBottomSheet&lt;T&gt;(
    context: context,
    isScrollControlled: isScrollControlled,
    <span class="hljs-comment">// 关键：指定背景色</span>
    backgroundColor: BeeTokens.surfaceElevated(context),
    <span class="hljs-comment">// 圆角</span>
    shape: <span class="hljs-keyword">const</span> RoundedRectangleBorder(
      borderRadius: BorderRadius.vertical(top: Radius.circular(<span class="hljs-number">16</span>)),
    ),
    builder: builder,
  );
}

Future&lt;T?&gt; showBeeDialog&lt;T&gt;({
  <span class="hljs-keyword">required</span> BuildContext context,
  <span class="hljs-keyword">required</span> WidgetBuilder builder,
}) {
  <span class="hljs-keyword">return</span> showDialog&lt;T&gt;(
    context: context,
    builder: (context) =&gt; Dialog(
      backgroundColor: BeeTokens.surfaceElevated(context),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(<span class="hljs-number">16</span>),
        <span class="hljs-comment">// 暗黑模式下加边框</span>
        side: BeeTokens.isDark(context)
            ? BorderSide(color: BeeTokens.border(context))
            : BorderSide.none,
      ),
      child: builder(context),
    ),
  );
}
</code></pre>
<h3 data-id="heading-15">输入框适配</h3>
<pre><code class="hljs language-dart" lang="dart">TextField(
  decoration: InputDecoration(
    hintText: <span class="hljs-string">'请输入'</span>,
    hintStyle: TextStyle(color: BeeTokens.textTertiary(context)),
    filled: <span class="hljs-keyword">true</span>,
    fillColor: BeeTokens.isDark(context)
        ? Colors.white.withOpacity(<span class="hljs-number">0.05</span>)
        : Colors.grey.shade100,
    border: OutlineInputBorder(
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      borderSide: BorderSide.none,
    ),
    focusedBorder: OutlineInputBorder(
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      borderSide: BorderSide(
        color: Theme.of(context).primaryColor,
        width: <span class="hljs-number">1.5</span>,
      ),
    ),
  ),
  style: TextStyle(color: BeeTokens.textPrimary(context)),
)
</code></pre>
<hr/>
<h2 data-id="heading-16">5. 踩坑记录</h2>
<h3 data-id="heading-17">坑 1：硬编码颜色遍布全局</h3>
<p><strong>问题</strong>：项目历史代码中，颜色值散落在各处。</p>
<p><strong>解决</strong>：我写了个脚本，全局搜索替换常见的硬编码颜色：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索硬编码颜色</span>
grep -rn <span class="hljs-string">"Colors.black87"</span> lib/
grep -rn <span class="hljs-string">"Colors.black54"</span> lib/
grep -rn <span class="hljs-string">"Colors.white"</span> lib/
grep -rn <span class="hljs-string">"Color(0xFF"</span> lib/
</code></pre>
<p>然后逐个替换为对应的 Token。这个过程比较繁琐，但一劳永逸。</p>
<h3 data-id="heading-18">坑 2：弹窗背景色不生效</h3>
<p><strong>问题</strong>：<code>showModalBottomSheet</code> 在暗黑模式下背景还是白色。</p>
<p><strong>原因</strong>：Flutter 的 BottomSheet 默认使用 <code>Theme.of(context).canvasColor</code>。</p>
<p><strong>解决</strong>：显式指定 <code>backgroundColor</code> 参数。</p>
<pre><code class="hljs language-dart" lang="dart">showModalBottomSheet(
  context: context,
  backgroundColor: BeeTokens.surfaceElevated(context), <span class="hljs-comment">// 必须指定！</span>
  builder: (context) =&gt; ...
)
</code></pre>
<h3 data-id="heading-19">坑 3：状态栏图标颜色</h3>
<p><strong>问题</strong>：暗黑模式下状态栏图标还是黑色，看不清。</p>
<p><strong>解决</strong>：在 AppBar 或页面级别设置 <code>SystemUiOverlayStyle</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方式 1：通过 AppBar</span>
AppBar(
  systemOverlayStyle: BeeTokens.isDark(context)
      ? SystemUiOverlayStyle.light
      : SystemUiOverlayStyle.dark,
)

<span class="hljs-comment">// 方式 2：通过 AnnotatedRegion</span>
AnnotatedRegion&lt;SystemUiOverlayStyle&gt;(
  value: BeeTokens.isDark(context)
      ? SystemUiOverlayStyle.light
      : SystemUiOverlayStyle.dark,
  child: Scaffold(...),
)
</code></pre>
<h3 data-id="heading-20">坑 4：CupertinoDatePicker 颜色</h3>
<p><strong>问题</strong>：iOS 风格的日期选择器在暗黑模式下颜色不对。</p>
<p><strong>解决</strong>：用 <code>CupertinoTheme</code> 包裹：</p>
<pre><code class="hljs language-dart" lang="dart">CupertinoTheme(
  data: CupertinoThemeData(
    brightness: BeeTokens.isDark(context) ? Brightness.dark : Brightness.light,
    primaryColor: Theme.of(context).primaryColor,
  ),
  child: CupertinoDatePicker(...),
)
</code></pre>
<h3 data-id="heading-21">坑 5：图片和图标</h3>
<p><strong>问题</strong>：某些图标/图片在暗黑模式下对比度不够。</p>
<p><strong>解决</strong>：</p>
<ol>
<li>使用 Icon 时，显式指定颜色而非依赖默认值</li>
<li>对于图片，考虑准备暗黑模式版本，或使用 <code>ColorFiltered</code> 调整</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 图标：显式指定颜色</span>
Icon(
  Icons.settings,
  color: BeeTokens.iconPrimary(context), <span class="hljs-comment">// 不要省略</span>
)

<span class="hljs-comment">// 图片：可以用 ColorFiltered 调整</span>
ColorFiltered(
  colorFilter: BeeTokens.isDark(context)
      ? <span class="hljs-keyword">const</span> ColorFilter.mode(Colors.white, BlendMode.srcIn)
      : <span class="hljs-keyword">null</span>,
  child: Image.asset(<span class="hljs-string">'assets/logo.png'</span>),
)
</code></pre>
<h3 data-id="heading-22">坑 6：主题切换后 Provider 状态</h3>
<p><strong>问题</strong>：主题切换后，某些页面颜色没更新。</p>
<p><strong>原因</strong>：没有正确使用 <code>ref.watch()</code>。</p>
<p><strong>解决</strong>：确保在 <code>build</code> 方法中使用 <code>ref.watch()</code> 监听 Provider：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 错误：只在 initState 读取一次</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConsumerState</span>&lt;<span class="hljs-title">MyPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> Color _bgColor;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _bgColor = BeeTokens.surface(context); <span class="hljs-comment">// 这里读取后不会更新</span>
  }
}

<span class="hljs-comment">// ✅ 正确：在 build 中监听</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConsumerState</span>&lt;<span class="hljs-title">MyPage</span>&gt; </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> bgColor = BeeTokens.surface(context); <span class="hljs-comment">// 每次 build 都重新获取</span>
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-23">设计思考</h2>
<h3 data-id="heading-24">为什么选纯黑而不是深灰？</h3>




















<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>纯黑 #000000</td><td>OLED 省电、对比度高、极简</td><td>可能显得「空洞」</td></tr><tr><td>深灰 #121212</td><td>Material Design 推荐、柔和</td><td>OLED 不省电、对比度低</td></tr></tbody></table>
<p>最终选择纯黑，因为：</p>
<ol>
<li>现在大部分手机是 OLED 屏，纯黑真的能省电</li>
<li>配合主题色边框，不会显得单调</li>
<li>极简风格更符合这个 App 的调性</li>
</ol>
<h3 data-id="heading-25">为什么用主题色边框？</h3>
<ol>
<li><strong>保留个性化</strong>：用户可以自定义主题色，暗黑模式下也能体现</li>
<li><strong>层次分明</strong>：边框让卡片和背景区分开，不会黑成一片</li>
<li><strong>品牌感</strong>：彩色点缀让界面更有记忆点</li>
<li><strong>技术简单</strong>：只需要在暗黑模式下加一个 border，不用准备两套资源</li>
</ol>
<hr/>
<h2 data-id="heading-26">项目地址</h2>
<p><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTNT-Likely%2FBeeCount" target="_blank" title="https://github.com/TNT-Likely/BeeCount" ref="nofollow noopener noreferrer">github.com/TNT-Likely/…</a></p>
<p>这是一个完全开源的 Flutter 记账 App，目前已有 <strong>600+ Star</strong>。</p>
<p>主要特性：</p>
<ul>
<li>完全免费，无广告</li>
<li>隐私优先，数据本地存储</li>
<li>支持 WebDAV/Supabase 自托管同步</li>
<li>多账本、账户管理、统计报表等完整功能</li>
<li>支持 iOS 和 Android</li>
</ul>
<p><strong>如果这篇文章或这个项目对你有帮助，欢迎给个 ⭐ Star 支持一下！</strong></p>
<p>代码都是开源的，欢迎参考和借鉴。</p>
<hr/>
<h2 data-id="heading-27">下载体验</h2>
<ul>
<li><strong>iOS App Store</strong>（海外区）：搜索「蜜蜂记账-简洁记账本」</li>
<li><strong>iOS TestFlight</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftestflight.apple.com%2Fjoin%2FEaw2rWxa" target="_blank" title="https://testflight.apple.com/join/Eaw2rWxa" ref="nofollow noopener noreferrer">testflight.apple.com/join/Eaw2rW…</a></li>
<li><strong>Android APK</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTNT-Likely%2FBeeCount%2Freleases" target="_blank" title="https://github.com/TNT-Likely/BeeCount/releases" ref="nofollow noopener noreferrer">github.com/TNT-Likely/…</a></li>
</ul>
<p>欢迎试用并反馈意见！有问题可以在 GitHub Issues 或评论区告诉我。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 数组进阶操作]]></title>    <link>https://juejin.cn/post/7575102209606352922</link>    <guid>https://juejin.cn/post/7575102209606352922</guid>    <pubDate>2025-11-23T10:18:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606352922" data-draft-id="7575438636330844211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 数组进阶操作"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-23T10:18:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天没ID"/> <meta itemprop="url" content="https://juejin.cn/user/441367612371065"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 数组进阶操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/441367612371065/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天没ID
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:18:20.000Z" title="Sun Nov 23 2025 10:18:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数组作为 Java 中最基础的数据结构，其固定长度的特性使得增删操作需要特殊处理。本文将基于数组查找功能，一步步实现元素插入（单个元素 / 数组）和删除操作，带你掌握数组操作的核心技巧。</p>
<h2 data-id="heading-0">基础：数组元素查找</h2>
<p>首先，我们需要实现一个基础功能 —— 查找指定元素在数组中的位置。这是后续所有操作的前提。</p>
<h3 data-id="heading-1">查找功能实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 查找数组中指定元素的位置
 * 
 * <span class="hljs-doctag">@param</span> arr 待查找的数组
 * <span class="hljs-doctag">@param</span> target 要查找的目标元素
 * <span class="hljs-doctag">@return</span> 元素所在索引，未找到返回-1
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findElement</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target)</span> {
    <span class="hljs-comment">// 空数组直接返回-1</span>
    <span class="hljs-keyword">if</span> (arr == <span class="hljs-literal">null</span> || arr.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">// 遍历数组查找元素</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++) {
        <span class="hljs-keyword">if</span> (arr[i] == target) {
            <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到元素，返回索引</span>
        }
    }
    
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到元素</span>
}
</code></pre>
<h2 data-id="heading-2">进阶操作一：在指定元素后插入单个元素</h2>
<h3 data-id="heading-3">代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 在指定元素后插入单个新元素
 * 
 * <span class="hljs-doctag">@param</span> arr 原数组
 * <span class="hljs-doctag">@param</span> target 目标元素（在其后插入）
 * <span class="hljs-doctag">@param</span> newValue 要插入的新元素
 * <span class="hljs-doctag">@return</span> 插入后的新数组
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] insertAfterElement(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target, <span class="hljs-type">int</span> newValue) {
    <span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> findElement(arr, target);
    
    <span class="hljs-comment">// 未找到目标元素，返回原数组副本</span>
    <span class="hljs-keyword">if</span> (targetIndex == -<span class="hljs-number">1</span>) {
        <span class="hljs-type">int</span>[] newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length];
        System.arraycopy(arr, <span class="hljs-number">0</span>, newArr, <span class="hljs-number">0</span>, arr.length);
        <span class="hljs-keyword">return</span> newArr;
    }
    
    <span class="hljs-comment">// 创建新数组，长度+1</span>
    <span class="hljs-type">int</span>[] newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length + <span class="hljs-number">1</span>];
    
    <span class="hljs-comment">// 复制目标元素及之前的元素</span>
    System.arraycopy(arr, <span class="hljs-number">0</span>, newArr, <span class="hljs-number">0</span>, targetIndex + <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 插入新元素</span>
    newArr[targetIndex + <span class="hljs-number">1</span>] = newValue;
    
    <span class="hljs-comment">// 复制目标元素之后的元素</span>
    System.arraycopy(arr, targetIndex + <span class="hljs-number">1</span>, newArr, targetIndex + <span class="hljs-number">2</span>, 
                     arr.length - targetIndex - <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">return</span> newArr;
}
</code></pre>
<h2 data-id="heading-4">进阶操作二：在指定元素后插入数组</h2>
<p>有时候我们需要插入多个元素，这就需要在指定位置插入一个数组。</p>
<h3 data-id="heading-5">代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 在指定元素后插入一个数组的所有元素
 * 
 * <span class="hljs-doctag">@param</span> arr 原数组
 * <span class="hljs-doctag">@param</span> target 目标元素（在其后插入）
 * <span class="hljs-doctag">@param</span> insertArr 要插入的数组
 * <span class="hljs-doctag">@return</span> 插入后的新数组
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] insertArrayAfterElement(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target, <span class="hljs-type">int</span>[] insertArr) {
    <span class="hljs-keyword">if</span> (insertArr == <span class="hljs-literal">null</span> || insertArr.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> arr.clone(); <span class="hljs-comment">// 插入数组为空，返回原数组副本</span>
    }
    
    <span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> findElement(arr, target);
    
    <span class="hljs-comment">// 未找到目标元素，返回原数组副本</span>
    <span class="hljs-keyword">if</span> (targetIndex == -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> arr.clone();
    }
    
    <span class="hljs-comment">// 创建新数组，长度=原数组长度+插入数组长度</span>
    <span class="hljs-type">int</span>[] newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length + insertArr.length];
    
    <span class="hljs-comment">// 复制目标元素及之前的元素</span>
    System.arraycopy(arr, <span class="hljs-number">0</span>, newArr, <span class="hljs-number">0</span>, targetIndex + <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 插入新数组</span>
    System.arraycopy(insertArr, <span class="hljs-number">0</span>, newArr, targetIndex + <span class="hljs-number">1</span>, insertArr.length);
    
    <span class="hljs-comment">// 复制目标元素之后的元素</span>
    System.arraycopy(arr, targetIndex + <span class="hljs-number">1</span>, newArr, 
                     targetIndex + <span class="hljs-number">1</span> + insertArr.length, 
                     arr.length - targetIndex - <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">return</span> newArr;
}
</code></pre>
<h2 data-id="heading-6">进阶操作三：删除指定元素</h2>
<h3 data-id="heading-7">代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 删除数组中的指定元素
 * 
 * <span class="hljs-doctag">@param</span> arr 原数组
 * <span class="hljs-doctag">@param</span> target 要删除的目标元素
 * <span class="hljs-doctag">@return</span> 删除后的新数组
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] deleteElement(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target) {
    <span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> findElement(arr, target);
    
    <span class="hljs-comment">// 未找到目标元素，返回原数组副本</span>
    <span class="hljs-keyword">if</span> (targetIndex == -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> arr.clone();
    }
    
    <span class="hljs-comment">// 创建新数组，长度-1</span>
    <span class="hljs-type">int</span>[] newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length - <span class="hljs-number">1</span>];
    
    <span class="hljs-comment">// 复制目标元素之前的元素</span>
    System.arraycopy(arr, <span class="hljs-number">0</span>, newArr, <span class="hljs-number">0</span>, targetIndex);
    
    <span class="hljs-comment">// 复制目标元素之后的元素</span>
    System.arraycopy(arr, targetIndex + <span class="hljs-number">1</span>, newArr, targetIndex, 
                     arr.length - targetIndex - <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">return</span> newArr;
}
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>本文通过数组查找、插入、删除三大操作的实现，展示了 Java 数组操作的核心技巧：</p>
<ol>
<li><strong>查找是基础</strong>：所有定位操作都依赖于元素查找功能</li>
<li><strong>增删靠复制</strong>：数组长度固定，增删操作本质是创建新数组并分区域复制元素</li>
<li><strong>分段处理是关键</strong>：无论是插入还是删除，都需要将数组分为目标位置前后两部分分别处理</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React+ts+vite脚手架搭建（五）【登录篇】]]></title>    <link>https://juejin.cn/post/7575182522411384870</link>    <guid>https://juejin.cn/post/7575182522411384870</guid>    <pubDate>2025-11-23T10:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575182522411384870" data-draft-id="7573886599433666611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React+ts+vite脚手架搭建（五）【登录篇】"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-23T10:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React+ts+vite脚手架搭建（五）【登录篇】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:19:42.000Z" title="Sun Nov 23 2025 10:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-plateau-dark">.hljs-comment,.hljs-quote{color:#7e7777}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ca4949}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#b45a3c}.hljs-bullet,.hljs-string,.hljs-symbol{color:#4b8b8b}.hljs-section,.hljs-title{color:#7272ca}.hljs-keyword,.hljs-selector-tag{color:#8464c4}.hljs-addition,.hljs-deletion{color:#1b1818;display:inline-block;width:100%}.hljs-deletion{background-color:#ca4949}.hljs-addition{background-color:#4b8b8b}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1b1818;color:#8a8585}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇我们介绍了在脚手架中配置代码格式规范、代码提交规范：<a href="https://juejin.cn/post/7561623724090097683" target="_blank" title="https://juejin.cn/post/7561623724090097683">React+ts+vite脚手架搭建（五）【规范篇】</a></p>
<p>本篇我们将开始脚手架中的最后一篇--登录篇</p>
<p>本文我们将完成一个传统的账号+密码登录功能</p>
<h2 data-id="heading-1">具体步骤</h2>
<h3 data-id="heading-2">新建一个登录路由</h3>
<p>在路由配置中新建一个登录路由
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf6125ff1054441b3616fabdab9aab5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497982&amp;x-signature=FCozqos%2FUo1%2BESlSoWqRff6n41I%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">新建登录+代码</h3>
<ul>
<li>在这段代码中我们分别做了：
<ul>
<li>账号和密码的输入框、登录按钮</li>
<li>点击登录按钮逻辑</li>
<li>登录成功后将返回的token保存到localStorage
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18acd908be1446849d505c7e2ffd6052~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497982&amp;x-signature=nmwjyWjfJgykJ38I8KkCi0%2FKZrc%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.css"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Login</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [form, setForm] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">""</span>,
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) =&gt; {
    <span class="hljs-keyword">const</span> { name, value } = e.<span class="hljs-property">target</span>;
    <span class="hljs-title function_">setForm</span>({
      ...form,
      [name]: value,
    });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!form.<span class="hljs-property">username</span> || !form.<span class="hljs-property">password</span>) {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">"请输入账号密码"</span>);
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"token"</span>, <span class="hljs-string">"123456"</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"login"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>登录页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{form.username}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{form.password}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{login}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Login</span>;
</code></pre>
<p>页面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc37c86b10e24eeda46c40c807d88be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497982&amp;x-signature=mXOU%2FoLhsA0Qj%2BqUW1EJ%2BZFsfvo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">token的携带</h3>
<p>我们存储完token后，需要在每次的接口请求中都携带上，这里我们直接在请求拦截器上携带上</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd2816b24f0941bf8ee5339088172d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497982&amp;x-signature=PE78tMcmoFxSj8IpBichn0wH73k%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">登录的校验</h3>
<p>一般来说一个需要登录的系统，大部分的接口都是需要登录验证的，所以我们直接将登录的校验写在响应拦截器中，当发现接口响应回来的code为未登录的code时，即直接跳转到登录页重新开始登录</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba32290a36df4420baf2611e87114aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764497982&amp;x-signature=mYwtHQQWQzmPaBg0ubqt4vIcGtQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>这样一个极简的登录系统就已经做好。。。</p>
<p>这里有几点补充：</p>
<ul>
<li>系统登录的token一般是通过接口返回的，我这里是模拟了一下，大家后续可以根据自己项目的实际情况来写接口</li>
<li>登录的token我是存在localStorage中的，你也可以存储在sessionStorage中</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从问答到决策：Agentic AI如何重新定义AI智能体的未来]]></title>    <link>https://juejin.cn/post/7575102209606402074</link>    <guid>https://juejin.cn/post/7575102209606402074</guid>    <pubDate>2025-11-23T10:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606402074" data-draft-id="7575133880436490291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从问答到决策：Agentic AI如何重新定义AI智能体的未来"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-23T10:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从问答到决策：Agentic AI如何重新定义AI智能体的未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:38:54.000Z" title="Sun Nov 23 2025 10:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有这么个现象，如果你的 AI 助手不再只是个听话的工具，而是能真正明白你想要什么，然后自己规划、动手执行，让你能腾出手来，专心做那些真正重要的事。</p>
<p>这可不是科幻电影里的情节。</p>
<p>这就是 AI 的未来，一种叫做“<strong>Agentic AI</strong>”（还不知道怎么翻译合适，自主型AI？）的新模式，它已经开始改变我们的工作方式、自动化流程，并激发全新的创新。</p>
<p>你让 AI 助手写封邮件，它就写了。但如果它更进一步，不仅帮你写，还能自己判断这封邮件该发给谁、什么时候发最合适，甚至在对方没回复时，主动帮你追问一下呢？</p>
<p>再想远一点：同一个 AI 还能管理你的待办事项，通过观察你每天的工作习惯，在小麻烦演变成大问题之前，就提前给你预警。</p>
<p>这就是 Agentic AI 带来的可能性。它不再只是一个问一句答一句、或者生成内容的工具，而是更像一个“数字队友”。它会为了一个明确的目标，自己做决定、规划步骤，并采取行动。</p>
<p>在接下来的内容，我们就来聊聊 Agentic AI 到底是什么、它和我们熟知的 AI智能体有什么不同，以及为什么它会成为现在 AI 领域最热门的话题之一。</p>
<h2 data-id="heading-0"><strong>什么是Agentic AI？</strong></h2>
<p>Agentic AI指的是能够<strong>独立思考、制定计划并采取行动</strong>的人工智能系统，就像一个有使命的代理人一样。这些系统以目标为导向，能够将大任务拆解成小步骤，找出最佳实现方式，甚至在情况发生变化时灵活调整。</p>
<h3 data-id="heading-1">可以这样理解：</h3>
<ul>
<li><strong>传统AI</strong>：回答你的问题</li>
<li><strong>生成式AI</strong>：创造内容</li>
<li><strong>AI智能体</strong>：根据规则或指令执行特定任务</li>
<li><strong>Agentic AI</strong>：设定目标，制定计划，付诸实施，并从结果中学习</li>
</ul>
<h3 data-id="heading-2">举个简单的例子：</h3>
<p>假设你在一家保险公司工作。与其只是用聊天机器人回答保单问题（传统AI），或者生成客户邮件（生成式AI），或者自动处理理赔确认（AI<strong>智能体</strong>）不同，<strong>Agentic AI</strong>能够：</p>
<ul>
<li>发现某个特定地区的理赔数量激增</li>
<li>利用内部和外部数据调查原因</li>
<li>更新承保风险模型</li>
<li>为受影响的客户起草针对性沟通内容</li>
<li>提醒合规和反欺诈团队</li>
<li>持续监控并调整策略——完全自主完成</li>
</ul>
<p>这就是区别所在——Agentic AI不仅仅是辅助工具，它带来的是<strong>主动性、独立性和适应性</strong>。</p>
<h3 data-id="heading-3">什么不是<strong>Agentic AI</strong>？</h3>
<p>为了真正理解什么是<strong>Agentic AI</strong>，我们先看看它不是什么。</p>
<ul>
<li><strong>不是简单的问答机器人</strong>：比如那种只回答常见问题的机器人，虽然能帮忙解答疑问，但它只是对问题作出即时回复，不会超出当前请求去进行规划或采取行动。</li>
<li><strong>不是只会生成文本的工具</strong>：比如 ChatGPT 在收到指令时编写博客文章，虽然效果出色，但它仅仅是在人的指示下工作，不能自己设定更大的目标。</li>
<li><strong>不是推荐系统</strong>：那些会给你推荐电影或商品的系统，虽然很聪明，但它们主要依靠预测，而不是根据目标做出实际行动。</li>
<li><strong>也不仅仅是自动化工具</strong>：比如那些自动发送提醒邮件或更新表格的程序，它们通常是根据固定规则执行任务，不会自行决定要干什么或为什么去做。</li>
</ul>
<p>在上面这些情况中，相关系统都是“被动式”的：它们只是在等待输入或按照事先设定好的流程工作，缺乏自主设定目标、做出决策或根据环境变化自我调整的能力。</p>
<p>而<strong>Agentic AI</strong>更进一步——它能有目的地行动，会根据情况灵活调整，而且常常不需要人不断监督。它不仅仅是实现自动化，更是在实现智能化的独立决策和行动。</p>
<h2 data-id="heading-4">对比这些概念：AI vs. 生成式 AI vs. 智能体 vs. <strong>Agentic AI</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d494255b982a4a7990b7530cc149a699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764499133&amp;x-signature=eetyAAXArB8CgFg17%2B97pDRvHlE%3D" alt="" loading="lazy"/></p>



























































<table><thead><tr><th>特性</th><th>生成式AI</th><th>智能体</th><th>Agentic AI</th></tr></thead><tbody><tr><td><strong>目的</strong></td><td>生成输出</td><td>实现目标</td><td>完成高层目标</td></tr><tr><td><strong>执行方式</strong></td><td>一次性生成</td><td>一步步做出决策</td><td>动态、多步骤决策</td></tr><tr><td><strong>工具使用</strong></td><td>不支持</td><td>基础工具访问</td><td>高级工具编排</td></tr><tr><td><strong>记忆能力</strong></td><td>无记忆</td><td>有限/临时记忆</td><td>跨会话使用记忆</td></tr><tr><td><strong>推理能力</strong></td><td>基础（模型内部）</td><td>中等推理能力</td><td>高级推理及自我批评</td></tr><tr><td><strong>子Agent支持</strong></td><td>无</td><td>单个Agent</td><td>协作式子Agent</td></tr><tr><td><strong>自主程度</strong></td><td>低</td><td>中等</td><td>高</td></tr><tr><td><strong>最适用场景</strong></td><td>文本/图像/代码生成</td><td>简单任务自动化</td><td>复杂决策和问题解决</td></tr></tbody></table>
<h3 data-id="heading-5"><strong>人工智能 (AI)</strong></h3>
<p>人工智能（AI）就像一个大帽子，包含了很多不同的技术。简单来说，它指的是那些能模仿人类智能来完成事情的机器或系统，比如学习、思考或者解决问题。</p>
<p><strong>举个例子：</strong> 一种评估保险索赔的系统，它会分析客户数据和索赔历史，来判断索赔是否有欺诈行为。</p>
<p><strong>它能做什么：</strong> 它可以处理有规律的数据，发现其中的趋势，并帮助人们做出决策——比如批准或标记索赔。</p>
<p><strong>它的局限性：</strong> 传统的AI通常比较“单一”，它被设计用于完成特定的任务。它无法处理超出它训练范围的事情，而且它也无法像人类一样理解上下文和目的。</p>
<h3 data-id="heading-6"><strong>生成式人工智能 (Generative AI)</strong></h3>
<p>生成式人工智能（Generative AI）是一种“有创造力”的AI。它能创造出全新的内容，例如文本、图片、视频或代码，通过学习现有的数据来做到这一点。</p>
<p><strong>举个例子：</strong> 一种生成式AI模型可以根据客户的交易数据和投资目标，为客户生成个性化的财务建议报告。</p>
<p><strong>它能做什么：</strong> 当你给它一个问题，它会产生内容，比如一份承保报告、一份保单概要，或者给客户发送的一封邮件。</p>
<p><strong>它的局限性：</strong> 它是“反应式”的。它只能在你明确提供输入的时候工作。它不会主动决定要创造什么，或者什么时候开始行动——它只是在响应你的指令。</p>
<h3 data-id="heading-7"><strong>AI智能体 (AI Agents)</strong></h3>
<p>AI智能体（AI Agents）能“行动”。它们被设计用来根据指令完成特定的任务，通常是为了自动化重复性的工作。</p>
<p><strong>举个例子：</strong> 一个AI智能体可以自动将收到的邮件根据内容分析，路由到正确的部门——例如索赔、承保或支持部门。</p>
<p><strong>它能做什么：</strong> 它可以按照设定的任务执行指令——比如给客户发送提醒、更新CRM记录或者从表格中提取关键数据。</p>
<p><strong>它的局限性：</strong> 它通常是“任务导向”的，并且通常是“基于规则”的。它无法适应情况，也无法主动采取行动，除非它被编程来执行特定的任务。</p>
<h3 data-id="heading-8"><strong>Agentic AI</strong></h3>
<p>这是最新也是最先进的一种AI形式。智能体式AI 不仅仅会等待指令——它能“设定自己的目标、制定计划并采取行动”来实现这些目标，就像人类一样。</p>
<p><strong>举个例子：</strong> 你告诉一个智能体式AI “改进客户注册流程”。它会分析注册过程中的问题，重新设计注册流程，使用RAG（检索增强生成）生成个性化的常见问题解答，并自动收集文档，同时还会衡量客户满意度——这些都是它自己完成的。</p>
<p><strong>它能做什么：</strong> 它可以“思考、推理和适应”。它可以创建和改进策略、解决问题，并与其他系统协同工作——就像一位数字项目经理或业务分析师。</p>
<p><strong>它的局限性：</strong> 它“还在发展中”。智能体式AI可能需要一些监督，以确保它与公司的目标、价值观和安全限制保持一致。它非常强大，但并非万无一失的。</p>
<h3 data-id="heading-9"><strong>Agentic AI的核心特征</strong></h3>
<p>Agentic AI不只是聪明，更重要的是<strong>有明确目标，能主动出击</strong>。它融合了思考能力、记忆能力和独立行动能力，更像是你的数字同事，而不是传统工具。</p>
<ul>
<li><strong>有明确目标：</strong> 朝着具体目标前进，而不是被动地回答提问。</li>
<li><strong>独立行动：</strong> 主动出击，执行任务时不需要你一步步告诉它怎么做。</li>
<li><strong>会思考和规划：</strong> 能把复杂问题拆解开，自己想清楚最好的解决办法。</li>
<li><strong>有记忆和学习能力：</strong> 记得之前做过什么、结果怎样，用这些经验来做更好的决策。</li>
<li><strong>理解情境：</strong> 能感知周围的环境，根据不同情况调整自己的行动方式。</li>
<li><strong>知道何时需要人：</strong> 遇到风险时会停下来问你、向你汇报，确保一切在控制之中。</li>
</ul>
<p>这种<strong>独立思考和主动行动的结合</strong>，就是Agentic AI真正厉害的地方。</p>
<h3 data-id="heading-10"><strong>为什么现在需要 Agentic AI？</strong></h3>
<p>在现在这个变化飞快的发展环境中，Agentic AI 正在成为推动智能化、全流程自动化的关键力量。它的重要性体现在这几点：</p>
<ul>
<li><strong>数据太多，决策变慢</strong> 保险公司每天要处理政策文件、理赔资料、法规更新、客户沟通这些杂乱的信息。Agentic AI 能帮着<strong>整理信息、分清轻重缓急、主动执行任务</strong>，比如加快核保速度、提升欺诈识别效率、简化合规流程。</li>
<li><strong>AI 工具越来越成熟</strong> 现在有了像 GPT-4 这样的强大语言模型，加上 LangChain、ReAct、AutoGPT 这类平台，AI 能<strong>跨文档、跨系统、跨任务分析问题</strong>。这让客户开户、理赔分类、风险评估这些流程可以被智能自动化。</li>
<li><strong>要的是能自己干活的AI</strong> 企业不再满足于死板的规则机器人，现在希望AI能<strong>主动发起行动、实时监控效果、灵活调整策略</strong>。比如在交易中发现异常，或者在理赔时自动推荐下一步操作，它都能做到。</li>
<li><strong>从省钱到赚钱</strong> 传统自动化（RPA）只能节省时间，Agentic AI 却能<strong>创造实际价值</strong>。它能提升客户体验、提高留存率、实现个性化服务，甚至帮公司发现新收入来源——在整个保险和投资流程里，它都是个靠谱的数字伙伴。</li>
</ul>
<p>Agentic AI 不是单纯地把任务做得更快，而是让整个业务流程变得更<strong>聪明、灵活、有适应性</strong>。它代表的不是简单的自动化，而是让AI真正具备<strong>自主行动力</strong>的转变。</p>
<h2 data-id="heading-11"><strong>总结</strong></h2>
<p>Agentic AI 的出现，标志着 AI 的角色迎来了一次大变身。它不再是一个你叫它做什么、它就做什么的被动工具，而是变成了一个能主动干活、主动思考的“数字同事”。</p>
<p>它的任务不再只是生成点内容或跑跑固定流程，而是要<strong>为最终的结果负责</strong>，为了达成业务目标自己想办法、做决策，就像你身边那些能力出众的真人同事一样。</p>
<p>对企业来说，这就好比解锁了超能力。像<strong>保险核保</strong>、<strong>理赔管理</strong>、<strong>反欺诈</strong>、<strong>合规审查</strong>这些过去让人头疼的复杂工作，现在都可以交给它。Agentic AI 不仅能把这些事处理得更快，关键是更聪明，还能根据实际情况灵活调整。它能轻松驾驭公司内部那些复杂又互不连通的各种系统，让智能的力量贯穿全局，而且整个过程几乎不需要人怎么操心。</p>
<p>而这一切，还仅仅是个开始。</p>
<p>随着 Agentic AI 越来越成熟，未来的商业世界里，我们会看到 AI 智能体和人类员工并肩协作。它们会主动管理投资组合、与客户沟通互动、对市场的风吹草动迅速做出反应——同时还能确保所有行为都符合公司和法规的要求。</p>
<p>这带来的机遇，早已超越了简单的“自动化”范畴，而是迈向了“<strong>在整个企业范围内，实现自主的价值创造</strong>”这一全新高度。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[jpa将SQL记录到日志文件]]></title>    <link>https://juejin.cn/post/7575442779039105066</link>    <guid>https://juejin.cn/post/7575442779039105066</guid>    <pubDate>2025-11-23T10:59:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575442779039105066" data-draft-id="7575313772988678185" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="jpa将SQL记录到日志文件"/> <meta itemprop="keywords" content="后端,Spring Boot,Spring"/> <meta itemprop="datePublished" content="2025-11-23T10:59:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="考虑考虑"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335157287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            jpa将SQL记录到日志文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335157287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    考虑考虑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T10:59:35.000Z" title="Sun Nov 23 2025 10:59:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>Springboot整合jpa可以把SQL语句记录到日志文件</p>
<h3 data-id="heading-1">配置如下</h3>
<p>在<code>application.yml</code>配置如下</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.hibernate.SQL:</span> <span class="hljs-string">DEBUG</span>  <span class="hljs-comment"># 打印 SQL 语句</span>
    <span class="hljs-attr">org.hibernate.type.descriptor.sql.BasicBinder:</span> <span class="hljs-string">TRACE</span>  <span class="hljs-comment"># 打印 SQL 参数绑定值</span>
    <span class="hljs-attr">org.springframework.data.jpa:</span> <span class="hljs-string">INFO</span>  <span class="hljs-comment"># Spring Data JPA 日志（可选）</span>
</code></pre>
<p>这样就可以把<code>SQL</code>语句记录到日志文件</p>
<h3 data-id="heading-2">总结</h3>
<p>如果使用JPA框架时，有时候需要排查问题，可以将jpa语句记录到日志文件，但是可能会拖慢运行效率</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin抽象类（与接口的区别）]]></title>    <link>https://juejin.cn/post/7575106644499071010</link>    <guid>https://juejin.cn/post/7575106644499071010</guid>    <pubDate>2025-11-23T07:20:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499071010" data-draft-id="7575112613777883170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin抽象类（与接口的区别）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T07:20:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin抽象类（与接口的区别）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:20:55.000Z" title="Sun Nov 23 2025 07:20:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们来详细探讨一下 Kotlin 中的抽象类。</p>
<p>在 Kotlin 中，<strong>抽象类</strong>是一种不能被直接实例化的类，其主要目的是作为其他类的基类（父类），用于定义通用的属性和方法，而将具体的实现细节留给子类。</p>
<h3 data-id="heading-0">1. 定义抽象类</h3>
<p>在 Kotlin 中，使用 <code>abstract</code> 关键字来声明一个抽象类。</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义一个抽象类 Shape</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-comment">// 抽象属性（没有初始化值，必须在子类中重写）</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> name: String

    <span class="hljs-comment">// 抽象方法（没有方法体，必须在子类中重写）</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateArea</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Double</span>

    <span class="hljs-comment">// 非抽象方法（有具体实现，可以被子类继承或重写）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printName</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"形状名称: <span class="hljs-variable">$name</span>"</span>)
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>抽象类可以包含<strong>抽象属性</strong>和<strong>抽象方法</strong>，这些必须在子类中实现。</li>
<li>抽象类也可以包含<strong>非抽象属性</strong>和<strong>非抽象方法</strong>，这些会被子类继承。</li>
<li>抽象类<strong>不能被直接实例化</strong>，即不能使用 <code>val shape = Shape()</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 继承抽象类</h3>
<p>子类继承抽象类时，必须使用 <code>override</code> 关键字重写所有抽象属性和方法。</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 子类 Circle 继承自抽象类 Shape</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span>(
    <span class="hljs-keyword">val</span> radius: <span class="hljs-built_in">Double</span>
) : Shape() {
    <span class="hljs-comment">// 重写抽象属性</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"圆形"</span>

    <span class="hljs-comment">// 重写抽象方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateArea</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Double</span> {
        <span class="hljs-keyword">return</span> Math.PI * radius * radius
    }
}

<span class="hljs-comment">// 子类 Rectangle 继承自抽象类 Shape</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span>(
    <span class="hljs-keyword">val</span> width: <span class="hljs-built_in">Double</span>,
    <span class="hljs-keyword">val</span> height: <span class="hljs-built_in">Double</span>
) : Shape() {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"矩形"</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateArea</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Double</span> {
        <span class="hljs-keyword">return</span> width * height
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<p>kotlin</p>
<pre><code class="hljs language-scss" lang="scss">fun <span class="hljs-selector-tag">main</span>() {
    val circle = Circle(<span class="hljs-number">5.0</span>)
    circle<span class="hljs-selector-class">.printName</span>() <span class="hljs-comment">// 输出：形状名称: 圆形</span>
    <span class="hljs-built_in">println</span>("面积: ${circle.calculateArea()}") <span class="hljs-comment">// 输出：面积: 78.5398...</span>

    val rectangle = <span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">4.0</span>, <span class="hljs-number">6.0</span>)
    rectangle<span class="hljs-selector-class">.printName</span>() <span class="hljs-comment">// 输出：形状名称: 矩形</span>
    <span class="hljs-built_in">println</span>("面积: ${rectangle.calculateArea()}") <span class="hljs-comment">// 输出：面积: 24.0</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 抽象类的特点</h3>
<ol>
<li>
<p><strong>不能实例化</strong>：</p>
<p>kotlin</p>
<pre><code class="hljs language-scss" lang="scss">val shape = <span class="hljs-built_in">Shape</span>() <span class="hljs-comment">// 错误：抽象类不能被实例化</span>
</code></pre>
</li>
<li>
<p><strong>可以包含抽象和非抽象成员</strong>：</p>
<ul>
<li>抽象成员（<code>abstract</code> 修饰）必须在子类中重写。</li>
<li>非抽象成员可以直接继承或被子类重写（使用 <code>override</code>）。</li>
</ul>
</li>
<li>
<p><strong>子类必须实现所有抽象成员</strong>：如果子类没有实现所有抽象属性和方法，那么子类也必须声明为抽象类。</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span>(
    <span class="hljs-keyword">val</span> sideLength: <span class="hljs-built_in">Double</span>
) : Shape() {
    <span class="hljs-comment">// 只重写了抽象属性，没有重写抽象方法 calculateArea()</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"正方形"</span>
    
    <span class="hljs-comment">// 因此 Square 类也必须是抽象的</span>
}
</code></pre>
</li>
<li>
<p><strong>抽象类可以继承其他类</strong>：抽象类可以继承自另一个非抽象类或抽象类。</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"动物发出声音"</span>)
    }
}

<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-type">Animal</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 重写并声明为抽象方法，子类必须实现</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Puppy</span> : <span class="hljs-type">Dog</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"小狗汪汪叫"</span>)
    }
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">4. 抽象类与接口的区别</h3>
<p>在 Kotlin 中，抽象类和接口（<code>interface</code>）都可以用于定义抽象行为，但它们有几个关键区别：</p>



































<table><thead><tr><th>特性</th><th>抽象类 (<code>abstract class</code>)</th><th>接口 (<code>interface</code>)</th></tr></thead><tbody><tr><td><strong>构造函数</strong></td><td>可以有构造函数</td><td>不能有构造函数（Kotlin 1.9+ 支持接口中定义带默认实现的属性，但仍不能有构造函数）</td></tr><tr><td><strong>多重继承</strong></td><td>只能单继承（一个类只能继承一个抽象类）</td><td>可以实现多个接口</td></tr><tr><td><strong>属性</strong></td><td>可以包含非抽象属性</td><td>接口中的属性默认是抽象的，或必须提供 getter 实现</td></tr><tr><td><strong>方法实现</strong></td><td>可以包含非抽象方法的实现</td><td>接口中的方法默认是抽象的，或必须提供实现（Kotlin 1.4+ 支持接口方法的默认实现）</td></tr><tr><td><strong>访问修饰符</strong></td><td>可以使用 <code>private</code>, <code>protected</code>, <code>public</code></td><td>接口成员默认是 <code>public</code>，不能有 <code>private</code> 修饰符</td></tr></tbody></table>
<p><strong>使用建议</strong>：</p>
<ul>
<li>如果需要定义一个通用的基类，并且需要包含构造函数、非抽象属性或方法，使用<strong>抽象类</strong>。</li>
<li>如果只是需要定义一组抽象行为（方法或属性），并且希望类可以实现多个这样的行为，使用<strong>接口</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">5. 总结</h3>
<ul>
<li>抽象类是用 <code>abstract</code> 关键字声明的类，不能被直接实例化。</li>
<li>抽象类可以包含抽象成员（必须在子类中重写）和非抽象成员（可以直接继承）。</li>
<li>子类继承抽象类时，必须重写所有抽象成员，否则子类也必须是抽象类。</li>
<li>抽象类适合作为具有共同属性和行为的类的基类，而接口适合定义多个类可以实现的抽象行为。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 16KB Page Size 适配实战流程：以重编译FFmpeg so库为例]]></title>    <link>https://juejin.cn/post/7575655132748316708</link>    <guid>https://juejin.cn/post/7575655132748316708</guid>    <pubDate>2025-11-23T08:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132748316708" data-draft-id="7575807729722441762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 16KB Page Size 适配实战流程：以重编译FFmpeg so库为例"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-23T08:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在狂风暴雨中奔跑"/> <meta itemprop="url" content="https://juejin.cn/user/1841028550886683"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 16KB Page Size 适配实战流程：以重编译FFmpeg so库为例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1841028550886683/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在狂风暴雨中奔跑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:25:35.000Z" title="Sun Nov 23 2025 08:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android 16KB Page Size 适配实战流程：以重编译FFmpeg so库为例</h2>
<h3 data-id="heading-1">前言</h3>
<p>为了优化了系统内存性能，谷歌计划将 Android 平台架构向 16KB Page Size（16384 字节内存页大小）迁移，这会导致许多仅支持4 KB 内存页面大小的依赖 C/C++ 原生库（.so 文件）的应用在 16KB AVD 或设备上遭遇加载崩溃。根据谷歌最新官方消息，自 2025 年 11 月 1 日起，提交到 Google Play 且以 Android 15 及更高版本为目标平台的所有新应用和现有应用更新都必须在 64 位设备上支持 16KB Page Size。 依赖 C/C++ 原生库（.so 文件）的应用没办法躲过适配16KB Page Size的工作了。<br/>
我手上的项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAudioAndVideoEditor" target="_blank" title="https://github.com/Ilovecat1949/AudioAndVideoEditor" ref="nofollow noopener noreferrer">AudioAndVideoEditor</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAeroFFmpeg" target="_blank" title="https://github.com/Ilovecat1949/AeroFFmpeg" ref="nofollow noopener noreferrer">AeroFFmpeg</a>均依赖FFmpeg so库且未适配16KB Page Size，适配16KB Page Size对于我而言也是一个很大的挑战。我本人也不是很懂 C/C++ 的编译底层原理，通过抄谷歌官方指导教程和大佬博客、问ai一路适配，最终应该是成功适配的了。<br/>
本文以重编译FFmpeg so库为例子讲诉适配流程：从判断是否支持16KB Page Size，到交叉编译so库，到重新编译构建整个项目，最终确保应用在最新的 16KB Android 环境中稳定运行。</p>
<h3 data-id="heading-2">适配难点</h3>
<p>虽然 16KB 适配对平台理论上有显著益处，但其大规模落地面临很大挑战。纯Java/Kolin项目理论上可以直接支持16KB Page Size设备，关键在于庞大的C/C++ 原生库生态。<br/>
1.源代码缺失或不可修改： 许多应用使用了多年前编译的、已停止维护的第三方 SDK 或原生库。如果无法获取源代码或修改其构建脚本，则根本无法重新编译并注入 16KB 链接器标志。<br/>
2.多层依赖嵌套： 复杂应用可能依赖的 A 库又依赖 B 库，而 B 库又依赖 C 库。只要依赖链中有一个库未适配，整个应用在 16KB 环境中就可能崩溃。<br/>
总之，没有 C/C++ 原生库就没有烦恼。<br/>
不同项目使用的 C/C++ 编译工具链和构建系统 不一样，涉及的原生库不一样，本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAudioAndVideoEditor" target="_blank" title="https://github.com/Ilovecat1949/AudioAndVideoEditor" ref="nofollow noopener noreferrer">AudioAndVideoEditor</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAeroFFmpeg" target="_blank" title="https://github.com/Ilovecat1949/AeroFFmpeg" ref="nofollow noopener noreferrer">AeroFFmpeg</a>为例子介绍C/C++ 原生库适配16KB Page Size的流程。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAudioAndVideoEditor" target="_blank" title="https://github.com/Ilovecat1949/AudioAndVideoEditor" ref="nofollow noopener noreferrer">AudioAndVideoEditor</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAeroFFmpeg" target="_blank" title="https://github.com/Ilovecat1949/AeroFFmpeg" ref="nofollow noopener noreferrer">AeroFFmpeg</a>依赖的x264、x265、LAME、FFmpeg都是知名项目且代码开源，因此可以自己重新编译源码适配16KB Page Size，这一点是比较幸运的。我是先在Linux环境使用NDK r20交叉编译x264、x265、LAME、FFmpeg得到对应so库，再集成到Android项目里面使用CMake+NDK r25编译构建得到最终的Android应用和SDK库。重新编译so库的过程还是比较琐碎且耗时的。</p>
<h3 data-id="heading-3">判断你的应用是否满足16KB Page Size的要求</h3>
<p>16KB 适配最好安装新的Android Studio以使用谷歌提供的最新工具。虽然升级Android Studio可能会给老项目又带来一些问题，但是长痛不如短痛，升级Android Studio尽量跟上谷歌的步伐是最好的。</p>
<ol>
<li>使用Android Studio中的Analyze APK工具<br/>
在Android Studio打开项目，在最顶上菜单栏中，依次点击 Build &gt; Analyze APK...<br/>
如果你的 C/C++ 原生库已经适配 16KB ，结果如下：\</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1548376344c448e8e7e7d4544761ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo54uC6aOO5pq06Zuo5Lit5aWU6LeR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491135&amp;x-signature=pI%2F3%2FIBpjXdlk7hsBtLY7Pe0QMc%3D" alt="APP分析.jpg" loading="lazy"/></p>
<ol start="2">
<li>16 KB 虚拟机设备直接运行测试<br/>
arm64-v8a或x86_64的64位设备才有16KB Page Size的问题，我们可以在Android Studio的16KB 虚拟机上测试应用是否能正常运行。注意如果你是在AMD的Windows上开发，那你应该选择x86_64的16KB Page Size虚拟机，如果是ARM架构的Mac应该选择arm64-v8a的16KB Page Size虚拟机。<br/>
默认情况下，16KB Page Size虚拟机会使用16 KB 向后兼容模式，也就是说你的应用不支持16KB Page Size也不会一下崩掉，而是会弹出提示。\</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b2360713364841bb279ca26feed160~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo54uC6aOO5pq06Zuo5Lit5aWU6LeR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491135&amp;x-signature=o%2ByA8OJ%2FH4eYZ50SV%2BwX%2B8FIu0M%3D" alt="未适配提示.jpg" loading="lazy"/></p>
<pre><code class="hljs">如果你想看看你的应用崩溃的样子，可以在应用设置里面选择关掉16 KB 向后兼容模式，报错信息如下。

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10d04a9c0e974d54bf47d86195aac2d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo54uC6aOO5pq06Zuo5Lit5aWU6LeR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491135&amp;x-signature=0x9QX%2BxdUYpme9ML5wrBY1xHNH8%3D" alt="报错.jpg" loading="lazy"/></p>
<h3 data-id="heading-4">适配16KB Page Size</h3>
<h4 data-id="heading-5">关键的链接器标志</h4>
<p>为Android编译 C/C++ 原生库依靠NDK，不同版本NDK对16KB Page Size的支持不一样。NDK 版本 r28 及更高版本默认编译为 16 KB 对齐。Android NDK r27及以下版本需要设置相关配置文件、编译脚本文件的参数，主要是链接器标志参数。谷歌官方推荐始终更新 NDK，但实际上对于旧项目而言更新NDK往往会带来一系列麻烦的问题（往往不是花一天两天能解决的），因此我依靠不升级NDK的适配方法。<br/>
适配 16KB 的关键在于，在原生库的链接阶段，告诉链接器（ld）将所有 ELF 程序段的对齐值设置为 16KB。我们可以使用以下链接器标志：</p>
<pre><code class="hljs language-ini" lang="ini">-Wl,-z,<span class="hljs-attr">max-page-size</span>=<span class="hljs-number">16384</span>
-Wl,-z,<span class="hljs-attr">common-page-size</span>=<span class="hljs-number">16384</span>
</code></pre>
<p>max-page-size是适配16KB Page Size的关键，它强制链接器将 ELF 文件中所有可加载的程序段（Program Segments，例如包含代码的 .text 段或包含数据的 .data 段）的对齐要求 p_align 设置为 16384 字节（16KB）。Android NDK r27~r23理论上用它就行。<br/>
common-page-size用于设置链接器在进行内部优化和确定文件布局时所使用的通用页大小。它影响链接器如何组织代码和数据，以优化空间利用和内存映射。它可以解决适配16KB Page Size过程中（对于Android NDK r22 及更低版本）旧版 GNU ld 和 LLVM lld 链接器中的 bug。<br/>
出于稳妥起见，我两个链接器标志都使用。</p>
<p>例如在CMakeLists.txt这样使用：</p>
<pre><code class="hljs language-bash" lang="bash">target_link_options(<span class="hljs-variable">${CMAKE_PROJECT_NAME}</span> PRIVATE <span class="hljs-string">"-Wl,-z,max-page-size=16384"</span>)
target_link_options(<span class="hljs-variable">${CMAKE_PROJECT_NAME}</span> PRIVATE <span class="hljs-string">"-Wl,-z,common-page-size=16384"</span>)     
</code></pre>
<h4 data-id="heading-6">重新交叉编译so库</h4>
<p>编译环境：VMware Workstation Pro中的ubuntu虚拟机<br/>
NDK：NDK r20<br/>
使用NDK交叉编译so库的时候在编译脚本加入上面两个链接器标志参数。<br/>
编译x264脚本关键部分如下：</p>
<pre><code class="hljs language-bash" lang="bash">    <span class="hljs-comment"># ...</span>
    <span class="hljs-built_in">export</span> LDFLAGS=<span class="hljs-string">"-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"</span>
	
	<span class="hljs-keyword">function</span> build
	{
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; build start &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span>
	
	  ./configure \
	  --prefix=<span class="hljs-variable">$TARGET</span> \
	  --enable-static \
	  --enable-shared \
	  --enable-pic \
	  --host=aarch64-linux-android \
	  --disable-asm \
	  --disable-opencl \
	  --disable-cli \
	  --cross-prefix=<span class="hljs-variable">$TOOLCHAIN</span>/bin/aarch64-linux-android- \
	  --sysroot=<span class="hljs-variable">$TOOLCHAIN</span>/sysroot \
	
	make clean
	make
	make install
	
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt;&gt;&gt;&gt; build done &lt;&lt;&lt;&lt;&lt;&lt;"</span>
	}
	
	build
</code></pre>
<p>编译LAME脚本关键部分如下：</p>
<pre><code class="hljs language-bash" lang="bash">    <span class="hljs-comment"># ...</span>
LDFLAGS=<span class="hljs-string">"-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"</span>
API=24

<span class="hljs-keyword">function</span> build_android_arm
{
<span class="hljs-built_in">echo</span> <span class="hljs-string">"build for android <span class="hljs-variable">$CPU</span>"</span>
./configure \
--host=<span class="hljs-variable">$HOST</span> \
--disable-static \
--enable-shared \
--disable-frontend \
--prefix=<span class="hljs-string">"<span class="hljs-variable">$TARGET</span>"</span> \
LDFLAGS=<span class="hljs-string">"<span class="hljs-variable">${LDFLAGS}</span>"</span> \
CPPFLAGS=<span class="hljs-string">"-fPIC"</span>

make clean
make -j8
make install

<span class="hljs-built_in">echo</span> <span class="hljs-string">"build for android <span class="hljs-variable">$CPU</span> completed"</span>
}
</code></pre>
<p>最终编译FFmpeg关键部分如下：</p>
<pre><code class="hljs language-bash" lang="bash">DYNAMIC_LINKER_FLAGS=<span class="hljs-string">"-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">function</span> build
{
  ./configure \
  --pkg-config=pkg-config \
  --pkg-config-flags=<span class="hljs-string">"--static"</span> \
  --prefix=<span class="hljs-variable">$OUTPUT</span> \
  --target-os=android \
  --<span class="hljs-built_in">arch</span>=arm64 \
  --cpu=armv8-a \
  --disable-x86asm \
  --disable-asm \
  --enable-neon \
  --enable-cross-compile \
  --enable-shared \
  --disable-static \
  --disable-doc \
  --disable-ffplay \
  --disable-ffprobe \
  --disable-symver \
  --disable-ffmpeg \
  --enable-pic \
  --sysroot=<span class="hljs-variable">$SYSROOT</span> \
  --cross-prefix=<span class="hljs-variable">$TOOLCHAIN</span>/bin/aarch64-linux-android- \
  --cross-prefix-clang=<span class="hljs-variable">$TOOLCHAIN</span>/bin/aarch64-linux-android<span class="hljs-variable">$API</span>- \
  --enable-encoder=aac \
  --enable-decoder=aac \
  --enable-gpl \
  --enable-encoder=libx264 \
  --enable-libx264 \
  --enable-encoder=libx265 \
  --enable-libx265 \
  --enable-libmp3lame \
  --extra-cflags=<span class="hljs-string">"-I<span class="hljs-variable">$X264_DIR</span>/include -I<span class="hljs-variable">$LAME_DIR</span>/include -I<span class="hljs-variable">$X265_DIR</span>/include"</span> \
  --extra-ldflags=<span class="hljs-string">"<span class="hljs-variable">$DYNAMIC_LINKER_FLAGS</span> -L<span class="hljs-variable">$X264_DIR</span>/lib -L<span class="hljs-variable">$LAME_DIR</span>/lib -L<span class="hljs-variable">$X265_DIR</span>/lib"</span> \
  --extra-cflags=<span class="hljs-string">"-fPIC"</span>

  make clean all
  <span class="hljs-comment"># 这里是定义用几个CPU编译</span>
  make -j12
  make install
}
</code></pre>
<p>可以看见都加上了max-page-size和common-page-size两个链接器标志，这样设置最终得到的so库是符合16KB Page Size要求的。</p>
<h4 data-id="heading-7">修改CMakeLists.txt重新构建项目</h4>
<p>将新鲜出炉的16KB so库放到Android项目的对应目录下。<br/>
注意在Android项目里面的CMakeLists.txt也需要添加max-page-size和common-page-size两个链接器标志。</p>
<pre><code class="hljs language-ini" lang="ini">target_link_libraries(

        <span class="hljs-comment"># 指定目标库，native-lib 是在上面 add_library 中配置的目标库</span>
        aeroffmpeglib

        <span class="hljs-comment"># 4. 连接 FFmpeg 相关的库</span>
        avutil
        swresample
        avcodec
        avfilter
        swscale
        avformat
        avdevice
        h264
        h265
        mp3lame
        ffmpeg

        -landroid
        OpenSLES
        -lEGL
        -lGLESv2
        <span class="hljs-comment"># Links the target library to the log library</span>
        <span class="hljs-comment"># included in the NDK.</span>
        ${log-lib}
        -Wl,-z,<span class="hljs-attr">max-page-size</span>=<span class="hljs-number">16384</span>
        -Wl,-z,<span class="hljs-attr">common-page-size</span>=<span class="hljs-number">16384</span>
)
</code></pre>
<p>修改CMakeLists.txt后重新同步配置信息并构建整个项目。</p>
<h3 data-id="heading-8">总结</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAudioAndVideoEditor" target="_blank" title="https://github.com/Ilovecat1949/AudioAndVideoEditor" ref="nofollow noopener noreferrer">AudioAndVideoEditor</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAeroFFmpeg" target="_blank" title="https://github.com/Ilovecat1949/AeroFFmpeg" ref="nofollow noopener noreferrer">AeroFFmpeg</a>现在应该都支持Android 16KB Page Size。<br/>
我希望谷歌以后少做涉及 C/C++ 原生库的更新了。</p>
<h3 data-id="heading-9">参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fguide%2Fpractices%2Fpage-sizes%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/guide/practices/page-sizes?hl=zh-cn" ref="nofollow noopener noreferrer">谷歌支持 16 KB 的页面大小指南</a><br/>
<a href="https://juejin.cn/post/7396306532671094793" target="_blank" title="https://juejin.cn/post/7396306532671094793">Android 15 上适配 16K Page Size 的填坑思路，以 IJKPlayer 为例子</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Re: 0x03. 从零开始的光线追踪实现-多球体着色]]></title>    <link>https://juejin.cn/post/7575425466904576063</link>    <guid>https://juejin.cn/post/7575425466904576063</guid>    <pubDate>2025-11-23T07:18:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466904576063" data-draft-id="7575313772988071977" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Re: 0x03. 从零开始的光线追踪实现-多球体着色"/> <meta itemprop="keywords" content="macOS,计算机图形学"/> <meta itemprop="datePublished" content="2025-11-23T07:18:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壕壕"/> <meta itemprop="url" content="https://juejin.cn/user/3180232448155495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Re: 0x03. 从零开始的光线追踪实现-多球体着色
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3180232448155495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壕壕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:18:55.000Z" title="Sun Nov 23 2025 07:18:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="fancy">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目标</h2>
<p><a href="https://juejin.cn/post/7555462803492356150" target="_blank" title="https://juejin.cn/post/7555462803492356150">上一节</a> 已经实现一个球显示在窗口中央，这节的目标是显示多个球。</p>
<h2 data-id="heading-1">本节最终效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8652a0cb44b4827a06246fa4a33ff84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aOV5aOV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764487135&amp;x-signature=98peJZl8uLs8OXbMQaVJRZ5Ub20%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">先显示两个球</h2>
<p>我们先来想像现实场景，假设你桌子有一个有显示器，此时你举起手机录屏，你能很直观认识到手机离你更近，显示器离你更远，你的眼睛就是那个摄像机，它发出的射线，肯定是先到手机，再到显示器。<br/>
现在我们代码做得事情就是，球就是“手机”，背景（天空）就是“显示器”，通过 <code>intersect_sphere</code> 我们可以计算出把“显示器”挡住的“手机”。</p>
<p>回到之前的代码，只显示一个球，也就是满足光线跟球相交时，就告诉 fragment shader 这里要应该显示某个颜色</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">intersect_sphere</span>(ray, sphere) &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0.76</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">1</span>);
}
</code></pre>
<p>现在我们要显示两个球，所以先弄一个数组。需要注意到，这里用 <code>constant</code> 是因为 MSL（Metal Shading Language）规定 <strong>Program scope variable must reside in constant address space</strong>（程序作用域的变量，必须放在常量地址空间），总之就是你要是写个函数外的常量，那就用 <code>constant</code> 把它放到常量地址空间去。</p>
<pre><code class="hljs language-cpp" lang="cpp">constant u32 OBJECT_COUNT = <span class="hljs-number">2</span>;

constant Sphere scene[OBJECT_COUNT] = {
  { .center = <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">-1.</span>), .radius = <span class="hljs-number">0.5</span> },
  { .center = <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0.</span>, <span class="hljs-number">-100.5</span>, <span class="hljs-number">-1.</span>), .radius = <span class="hljs-number">100.</span> },
};
</code></pre>
<p>声明结束后，在 fragment shader 函数内循环匹配光线相交。<br/>
我们把离咱们最近的值定义为 <code>closest_t</code>，初始值给个 Metal 内置的常量 <code>FLT_MAX</code>，它表示 float 的最大值（因为我们用了 <code>float</code> 类型），然后循环通过调用 <code>intersect_sphere</code> 计算的值 <code>t</code> 去更新 <code>closest_t</code>（因为 <code>intersect_sphere</code> 没匹配到会返回 <code>-1</code>，所以很显然我们要判断 <code>t &gt; 0.</code>，同时要再判断下这个 <code>t</code> 是比已知最近的还要近的值，也就是要满足 <code>t &lt; closest_t</code>）。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">fragment vec4f <span class="hljs-title">fragmentFn</span><span class="hljs-params">(Vertex in [[stage_in]], constant Uniforms &amp;uniforms [[buffer(<span class="hljs-number">1</span>)]])</span> </span>{
  <span class="hljs-comment">// ...</span>
  let ray = Ray { origin, direction };
  var <span class="hljs-type">closest_t</span> = FLT_MAX;
  <span class="hljs-keyword">for</span> (u32 i = <span class="hljs-number">0</span>; i &lt; OBJECT_COUNT; ++i) {
    var t = <span class="hljs-built_in">intersect_sphere</span>(ray, scene[i]);
    <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">0.</span> &amp;&amp; t &lt; <span class="hljs-type">closest_t</span>) {
      <span class="hljs-type">closest_t</span> = t;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-type">closest_t</span> &lt; FLT_MAX) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0.76</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-built_in">sky_color</span>(ray), <span class="hljs-number">1</span>);
}
</code></pre>
<p>于是就会显示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/416c454758084e83bcfa831977bd0651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aOV5aOV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764487135&amp;x-signature=%2BdxdeG3aGOK4%2BZr8VYwNxgoWgVo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">改颜色</h2>
<p>这里因为我们设置的颜色是相同，所以连在一块根本分不清哪跟哪，所以我们可以让离得近得更亮，离得远的更暗，给原先设置的颜色再乘上一个值，<code>saturate</code> 这个是 MSL 内置的函数，作用是把小于 0 的转成 0，大于 1 的转成 1，在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 范围内的不变，等于讲，大的就乘多一点，小的就乘少一点，符合近得更亮，远得更暗的要求</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">fragment vec4f <span class="hljs-title">fragmentFn</span><span class="hljs-params">(Vertex in [[stage_in]], constant Uniforms &amp;uniforms [[buffer(<span class="hljs-number">1</span>)]])</span> </span>{
  <span class="hljs-comment">// ...</span>
  let ray = Ray { origin, direction };
  var <span class="hljs-type">closest_t</span> = FLT_MAX;
  <span class="hljs-keyword">for</span> (u32 i = <span class="hljs-number">0</span>; i &lt; OBJECT_COUNT; ++i) {
    var t = <span class="hljs-built_in">intersect_sphere</span>(ray, scene[i]);
    <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">0.</span> &amp;&amp; t &lt; <span class="hljs-type">closest_t</span>) {
      <span class="hljs-type">closest_t</span> = t;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-type">closest_t</span> &lt; FLT_MAX) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0.76</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">1</span>) * <span class="hljs-built_in">saturate</span>(<span class="hljs-number">1.</span> - <span class="hljs-type">closest_t</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-built_in">sky_color</span>(ray), <span class="hljs-number">1</span>);
}
</code></pre>
<p>现在我们能看到这个效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a4ba77a46064f29a8b08f0592e42352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aOV5aOV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764487135&amp;x-signature=7jkvQsTSAYWCaWJq5mZyBFCZags%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">实现目标效果</h2>
<p>其实到这一步，只是换个颜色，为了实现目标效果，我们直接用 <code>closest_t</code> 作为基础值，在它的基础上转成颜色向量</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">if</span> (<span class="hljs-type">closest_t</span> &lt; FLT_MAX) {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-built_in">saturate</span>(<span class="hljs-type">closest_t</span>) * <span class="hljs-number">0.5</span>);
}
</code></pre>
<p>这样就能实现最终效果</p>
<hr/>
<p>最后总结一下代码</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;metal_stdlib&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> let const auto</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> var auto</span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> metal;

<span class="hljs-keyword">using</span> vec2f = float2;
<span class="hljs-keyword">using</span> vec3f = float3;
<span class="hljs-keyword">using</span> vec4f = float4;

<span class="hljs-keyword">using</span> u8 = uchar;
<span class="hljs-keyword">using</span> i8 = <span class="hljs-type">char</span>;
<span class="hljs-keyword">using</span> u16 = ushort;
<span class="hljs-keyword">using</span> i16 = <span class="hljs-type">short</span>;
<span class="hljs-keyword">using</span> i32 = <span class="hljs-type">int</span>;
<span class="hljs-keyword">using</span> u32 = uint;
<span class="hljs-keyword">using</span> f16 = half;
<span class="hljs-keyword">using</span> f32 = <span class="hljs-type">float</span>;
<span class="hljs-keyword">using</span> usize = <span class="hljs-type">size_t</span>;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">VertexIn</span> {
  vec2f position;
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Vertex</span> {
  vec4f position [[position]];
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Uniforms</span> {
  u32 width;
  u32 height;
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Ray</span> {
  vec3f origin;
  vec3f direction;
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Sphere</span> {
  vec3f center;
  f32 radius;
};

constant u32 OBJECT_COUNT = <span class="hljs-number">2</span>;
constant Sphere scene[OBJECT_COUNT] = {
  { .center = <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">-1.</span>), .radius = <span class="hljs-number">0.5</span> },
  { .center = <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0.</span>, <span class="hljs-number">-100.5</span>, <span class="hljs-number">-1.</span>), .radius = <span class="hljs-number">100.</span> },
};

<span class="hljs-function">f32 <span class="hljs-title">intersect_sphere</span><span class="hljs-params">(<span class="hljs-type">const</span> Ray ray, <span class="hljs-type">const</span> Sphere sphere)</span> </span>{
  let v = ray.origin - sphere.center;
  let a = <span class="hljs-built_in">dot</span>(ray.direction, ray.direction);
  let b = <span class="hljs-built_in">dot</span>(v, ray.direction);
  let c = <span class="hljs-built_in">dot</span>(v, v) - sphere.radius * sphere.radius;
  let d = b * b - a * c;
  <span class="hljs-keyword">if</span> (d &lt; <span class="hljs-number">0.</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1.</span>;
  }
  let sqrt_d = <span class="hljs-built_in">sqrt</span>(d);
  let recip_a = <span class="hljs-number">1.</span> / a;
  let mb = -b;
  let t = (mb - sqrt_d) * recip_a;
  <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">0.</span>) {
    <span class="hljs-keyword">return</span> t;
  }
  <span class="hljs-keyword">return</span> (mb + sqrt_d) * recip_a;
}

<span class="hljs-function">vec3f <span class="hljs-title">sky_color</span><span class="hljs-params">(Ray ray)</span> </span>{
  let a = <span class="hljs-number">0.5</span> * (<span class="hljs-built_in">normalize</span>(ray.direction).y + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-number">1</span> - a) * <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">1</span>) + a * <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>);
}

<span class="hljs-function">vertex Vertex <span class="hljs-title">vertexFn</span><span class="hljs-params">(constant VertexIn *vertices [[buffer(<span class="hljs-number">0</span>)]], uint vid [[vertex_id]])</span> </span>{
  <span class="hljs-keyword">return</span> Vertex { <span class="hljs-built_in">vec4f</span>(vertices[vid].position, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) };
}

<span class="hljs-function">fragment vec4f <span class="hljs-title">fragmentFn</span><span class="hljs-params">(Vertex in [[stage_in]], constant Uniforms &amp;uniforms [[buffer(<span class="hljs-number">1</span>)]])</span> </span>{
  let origin = <span class="hljs-built_in">vec3f</span>(<span class="hljs-number">0</span>);
  let focus_distance = <span class="hljs-number">1.0</span>;
  let aspect_ratio = <span class="hljs-built_in">f32</span>(uniforms.width) / <span class="hljs-built_in">f32</span>(uniforms.height);
  var uv = in.position.xy / <span class="hljs-built_in">vec2f</span>(<span class="hljs-built_in">f32</span>(uniforms.width - <span class="hljs-number">1</span>), <span class="hljs-built_in">f32</span>(uniforms.height - <span class="hljs-number">1</span>));
  uv = (<span class="hljs-number">2</span> * uv - <span class="hljs-built_in">vec2f</span>(<span class="hljs-number">1</span>)) * <span class="hljs-built_in">vec2f</span>(aspect_ratio, <span class="hljs-number">-1</span>);
  let direction = <span class="hljs-built_in">vec3f</span>(uv, -focus_distance);
  let ray = Ray { origin, direction };
  var <span class="hljs-type">closest_t</span> = FLT_MAX;
  <span class="hljs-keyword">for</span> (u32 i = <span class="hljs-number">0</span>; i &lt; OBJECT_COUNT; ++i) {
    var t = <span class="hljs-built_in">intersect_sphere</span>(ray, scene[i]);
    <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">0.</span> &amp;&amp; t &lt; <span class="hljs-type">closest_t</span>) {
      <span class="hljs-type">closest_t</span> = t;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-type">closest_t</span> &lt; FLT_MAX) {
<span class="hljs-comment">//    return vec4f(1, 0.76, 0.03, 1);</span>
<span class="hljs-comment">//    return vec4f(1, 0.76, 0.03, 1) * saturate(1. - closest_t);</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-built_in">saturate</span>(<span class="hljs-type">closest_t</span>) * <span class="hljs-number">0.5</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec4f</span>(<span class="hljs-built_in">sky_color</span>(ray), <span class="hljs-number">1</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 llm + SQLite 实现自然语言到 SQL 的智能转换：一个实战案例]]></title>    <link>https://juejin.cn/post/7575102209605926938</link>    <guid>https://juejin.cn/post/7575102209605926938</guid>    <pubDate>2025-11-23T06:33:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209605926938" data-draft-id="7575133880436097075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 llm + SQLite 实现自然语言到 SQL 的智能转换：一个实战案例"/> <meta itemprop="keywords" content="LLM,SQLite,Agent"/> <meta itemprop="datePublished" content="2025-11-23T06:33:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 llm + SQLite 实现自然语言到 SQL 的智能转换：一个实战案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T06:33:20.000Z" title="Sun Nov 23 2025 06:33:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，我们经常需要从数据库中查询数据。但对非技术人员来说，写 SQL 查询语句可能是个“噩梦”。而随着大模型的兴起，<strong>将自然语言直接转化为 SQL 查询</strong>已成为现实。</p>
<p>今天，我将结合 <strong>DeepSeek Reasoner 模型</strong> 和 <strong>SQLite 数据库</strong>，展示如何通过一段简单的 Python 代码，实现“<strong>你说中文，我出 SQL</strong>”的自动化能力。</p>
<hr/>
<h2 data-id="heading-0">🧩 项目目标</h2>
<p>给定一个简单的员工信息表，用户输入自然语言问题（如：“开发部门员工的姓名和工资是多少？”），程序自动解析并生成对应的 SQL 查询语句。</p>
<hr/>
<h2 data-id="heading-1">🔧 环境准备</h2>
<p>我们使用轻量级的 SQLite 数据库，并接入 DeepSeek 的 API 来完成自然语言理解与 SQL 生成任务。</p>
<h3 data-id="heading-2">1. 创建数据库表</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-comment"># 打开链接</span>
conn = sqlite3.connect(<span class="hljs-string">"test.db"</span>)
cursor = conn.cursor()

cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees(
    id INTEGER PRIMARY KEY,
    name TEXT,
    department TEXT,
    salary INTEGER
)
"""</span>)
</code></pre>
<blockquote>
<p>✅ 这一步创建了一个名为 <code>employees</code> 的表，包含员工编号、姓名、部门和工资字段。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">2. 插入测试数据</h3>
<pre><code class="hljs language-scss" lang="scss">sample_data = <span class="hljs-selector-attr">[    (6, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"开发部"</span>, 32000),    (7, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"销售部"</span>, 20000),    (8, <span class="hljs-string">"老六"</span>, <span class="hljs-string">"开发部"</span>, 33000),    (9, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"销售部"</span>, 15000)]</span>

<span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.executemany</span>("INSERT INTO employees VALUES(?,?,?,?)", sample_data)
conn<span class="hljs-selector-class">.commit</span>()
</code></pre>
<blockquote>
<p>💡 插入了4条测试数据，涵盖两个部门：开发部和销售部。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">3. 获取数据库 Schema</h3>
<p>为了让 LLM 理解表结构，我们需要把表的 schema 提供给模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 通过 table_info 拿到 employees 表的描述</span>
schema = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
schema_str = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">{col[<span class="hljs-number">2</span>]}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema]) + <span class="hljs-string">"\n)"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库Schema:"</span>)
<span class="hljs-built_in">print</span>(schema_str)
</code></pre>
<p>输出结果类似：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> EMPLOYEES (
id <span class="hljs-type">INTEGER</span>
name TEXT
department TEXT
salary <span class="hljs-type">INTEGER</span>
)
</code></pre>
<blockquote>
<p>📌 这个 schema 将作为上下文传给 DeepSeek 模型，帮助它理解字段含义。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4. 调用 DeepSeek 生成 SQL</h3>
<p>现在，我们调用 DeepSeek 的 API，让模型根据自然语言生成 SQL 查询。</p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">''</span>,//这里写入自己的apikey
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">'https://api.deepseek.com/v1'</span>
)

def ask_deepseek(query, schema):
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""这是一个数据库的Schema:
{schema}
根据这个Schema，你能输出一个SQL查询来回答以下问题吗？
只输出SQL查询，不要输出任何内容，也不要带任何格式。
问题:{query}
"""</span>
    <span class="hljs-attr">response</span> = client.chat_completions.create(
        <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-reasoner"</span>,
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">2048</span>,
        <span class="hljs-attr">messages</span>=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}
        ]
    )
    return response.choices<span class="hljs-section">[0]</span>.message.content

<span class="hljs-comment"># 示例提问</span>
<span class="hljs-attr">question</span> = <span class="hljs-string">"开发部门员工的姓名和工资是多少?"</span>
<span class="hljs-attr">sql</span> = ask_deepseek(question, schema_str)
print("生成的sql查询：")
print(sql)
</code></pre>
<hr/>
<h2 data-id="heading-6">✅ 预期输出</h2>
<p>运行上述代码后，你可能会得到如下 SQL 查询：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT name, salary FROM employees WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'开发部'</span><span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>🎉 完美！模型成功理解了“开发部门”对应的是 <code>department = '开发部'</code>，并返回了正确的字段选择。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">🚀 技术亮点解析</h2>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>自然语言 → SQL</strong></td><td>利用 LLM 的理解能力，无需人工编写复杂查询</td></tr><tr><td><strong>Schema 上下文注入</strong></td><td>让模型知道表结构，避免误读字段名</td></tr><tr><td><strong>轻量级部署</strong></td><td>使用 SQLite，无需复杂数据库环境</td></tr><tr><td><strong>可扩展性强</strong></td><td>可轻松接入其他数据库或前端界面</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">🛠️ 应用场景建议</h2>
<ul>
<li><strong>低代码平台</strong>：让用户用自然语言查询数据</li>
<li><strong>内部报表工具</strong>：非技术人员也能快速获取数据</li>
<li><strong>教学辅助</strong>：帮助学生理解 SQL 逻辑</li>
<li><strong>自动化脚本</strong>：集成到工作流中，提升效率</li>
</ul>
<hr/>
<h2 data-id="heading-9">📌 总结</h2>
<p>通过本次实践，我们展示了如何利用 <strong>llm</strong>，结合 <strong>SQLite</strong> 数据库，构建一个简单却强大的“自然语言转 SQL”系统。整个流程清晰、易于复现，适合初学者上手，也具备实际应用价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Foundation Models Framework]]></title>    <link>https://juejin.cn/post/7575106644499169314</link>    <guid>https://juejin.cn/post/7575106644499169314</guid>    <pubDate>2025-11-23T07:53:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499169314" data-draft-id="7575106644499136546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Foundation Models Framework"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-23T07:53:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="alloc"/> <meta itemprop="url" content="https://juejin.cn/user/923245496765566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Foundation Models Framework
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245496765566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    alloc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:53:10.000Z" title="Sun Nov 23 2025 07:53:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读37分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 第一部分：开场和Foundation Models简介</h2>
<h3 data-id="heading-1">1.1 为什么需要Foundation Models？</h3>
<h4 data-id="heading-2">业务痛点 vs 解决方案</h4>
<p>在相册业务中，我们经常遇到以下问题：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB  
    subgraph "传统方案痛点"  
        P1[搜索体验差&lt;br/&gt;难以用关键词找到照片]  
        P2[分类工作繁琐&lt;br/&gt;手动整理耗时耗力]  
        P3[内容理解不足&lt;br/&gt;无法自动理解照片]  
        P4[个性化推荐缺失&lt;br/&gt;难以推荐相关照片]  
    end  
      
    subgraph "Foundation Models解决方案"  
        S1[自然语言搜索&lt;br/&gt;去年夏天在海边的照片]  
        S2[智能分类&lt;br/&gt;自动组织照片]  
        S3[内容理解&lt;br/&gt;自动分析照片内容]  
        S4[智能推荐&lt;br/&gt;相似照片推荐]  
    end  
      
    P1 --&gt; S1  
    P2 --&gt; S2  
    P3 --&gt; S3  
    P4 --&gt; S4  
      
    style P1 fill:#FF3B30,color:#fff  
    style P2 fill:#FF3B30,color:#fff  
    style P3 fill:#FF3B30,color:#fff  
    style P4 fill:#FF3B30,color:#fff  
      
    style S1 fill:#34C759,color:#fff  
    style S2 fill:#34C759,color:#fff  
    style S3 fill:#34C759,color:#fff  
    style S4 fill:#34C759,color:#fff  
</code></pre>
<h3 data-id="heading-3">1.2 什么是Foundation Models Framework</h3>
<h4 data-id="heading-4">核心定义</h4>
<ul>
<li><strong>官方定义</strong>: Apple在iOS 18/macOS 15中引入的原生AI框架，是Apple Intelligence的核心组件</li>
<li><strong>技术定位</strong>: 让开发者轻松集成Apple Intelligence的大语言模型能力到应用中</li>
<li><strong>设计理念</strong>: <br/>
- 隐私优先：所有处理都在设备本地完成<br/>
- 开发者友好：简洁的API，易于集成<br/>
- 系统集成：与iOS/macOS深度集成</li>
</ul>
<h4 data-id="heading-5">Foundation Models vs 传统AI模型</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB  
    subgraph "传统AI方案"  
        T1[云端服务&lt;br/&gt;需要网络连接]  
        T2[数据上传&lt;br/&gt;需要上传到服务器]  
        T3[高延迟&lt;br/&gt;网络往返延迟]  
        T4[成本计费&lt;br/&gt;按使用量付费]  
        T5[API密钥&lt;br/&gt;需要密钥管理]  
        T6[隐私风险&lt;br/&gt;数据可能泄露]  
    end  
      
    subgraph "Foundation Models方案"  
        F1[设备端运行&lt;br/&gt;无需网络]  
        F2[数据本地化&lt;br/&gt;不出设备]  
        F3[低延迟&lt;br/&gt;本地处理]  
        F4[零成本&lt;br/&gt;Apple提供]  
        F5[无需密钥&lt;br/&gt;系统集成]  
        F6[隐私保护&lt;br/&gt;完全本地处理]  
    end  
      
    T1 -.对比.-&gt; F1  
    T2 -.对比.-&gt; F2  
    T3 -.对比.-&gt; F3  
    T4 -.对比.-&gt; F4  
    T5 -.对比.-&gt; F5  
    T6 -.对比.-&gt; F6  
      
    style T1 fill:#FF3B30,color:#fff  
    style T2 fill:#FF3B30,color:#fff  
    style T3 fill:#FF3B30,color:#fff  
    style T4 fill:#FF3B30,color:#fff  
    style T5 fill:#FF3B30,color:#fff  
    style T6 fill:#FF3B30,color:#fff  
      
    style F1 fill:#34C759,color:#fff  
    style F2 fill:#34C759,color:#fff  
    style F3 fill:#34C759,color:#fff  
    style F4 fill:#34C759,color:#fff  
    style F5 fill:#34C759,color:#fff  
    style F6 fill:#34C759,color:#fff  
</code></pre>
<p><strong>对比表格</strong>:</p>













































<table><thead><tr><th>特性</th><th>传统AI模型</th><th>Foundation Models</th></tr></thead><tbody><tr><td>部署方式</td><td>云端服务</td><td>设备端运行</td></tr><tr><td>网络要求</td><td>需要网络连接</td><td>无需网络</td></tr><tr><td>数据处理</td><td>数据上传到服务器</td><td>数据完全本地化</td></tr><tr><td>延迟</td><td>较高（网络往返）</td><td>低（本地处理）</td></tr><tr><td>成本</td><td>按使用量计费</td><td>零成本（Apple提供）</td></tr><tr><td>API密钥</td><td>需要管理</td><td>无需API密钥</td></tr><tr><td>隐私</td><td>数据可能泄露</td><td>完全隐私保护</td></tr></tbody></table>
<h4 data-id="heading-6">Apple Intelligence 架构概览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB  
    subgraph "应用层"  
        App1[iOS App]  
        App2[macOS App]  
        App3[iPadOS App]  
    end  
      
    subgraph "Foundation Models Framework"  
        FM1[LanguageModelSession&lt;br/&gt;会话管理]  
        FM2[Tool Protocol&lt;br/&gt;工具协议]  
        FM3[Structured Generation&lt;br/&gt;结构化生成]  
        FM4[SystemLanguageModel&lt;br/&gt;系统语言模型]  
    end  
      
    subgraph "底层执行层"  
        CoreML[Core ML&lt;br/&gt;模型推理]  
        NeuralEngine[Neural Engine&lt;br/&gt;硬件加速]  
    end  
      
    subgraph "隐私和安全层"  
        Privacy[隐私保护&lt;br/&gt;设备端处理]  
        Security[数据加密&lt;br/&gt;安全存储]  
    end  
      
    App1 --&gt; FM1  
    App2 --&gt; FM1  
    App3 --&gt; FM1  
      
    FM1 --&gt; FM2  
    FM1 --&gt; FM3  
    FM1 --&gt; FM4  
      
    FM4 --&gt; CoreML  
    CoreML --&gt; NeuralEngine  
      
    NeuralEngine --&gt; Privacy  
    Privacy --&gt; Security  
      
    style FM1 fill:#007AFF,color:#fff  
    style FM2 fill:#007AFF,color:#fff  
    style FM3 fill:#007AFF,color:#fff  
    style FM4 fill:#007AFF,color:#fff  
    style CoreML fill:#34C759,color:#fff  
    style NeuralEngine fill:#34C759,color:#fff  
    style Privacy fill:#FF9500,color:#fff  
    style Security fill:#FF9500,color:#fff  
</code></pre>
<p><strong>关键组件说明</strong>:</p>
<ol>
<li><strong>LanguageModelSession</strong>: 会话管理，维护对话上下文</li>
<li><strong>SystemLanguageModel</strong>: 系统提供的语言模型</li>
<li><strong>Tool Protocol</strong>: 扩展模型能力，连接系统功能</li>
<li><strong>Structured Generation</strong>: 类型安全的数据生成</li>
</ol>
<h4 data-id="heading-7">核心能力概览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((Foundation Models&lt;br/&gt;核心能力))  
    自然语言理解  
      理解用户查询  
      生成流畅响应  
      多轮对话  
      上下文维护  
    结构化数据生成  
      @Generable标记  
      类型安全  
      自动解析  
      易于集成  
    工具调用  
      Tool协议  
      系统功能连接  
      AI自动判断  
      多工具协调  
    流式响应  
      实时生成  
      提升体验  
      长文本支持  
    多语言支持  
      10种语言  
      自动检测  
      代码切换  
</code></pre>
<h3 data-id="heading-8">1.3 系统要求与兼容性</h3>
<h4 data-id="heading-9">设备要求详解</h4>
<p><strong>⚠️ 重要澄清</strong>：关于设备要求的常见混淆</p>
<ul>
<li><strong>正确理解</strong>：需要 <strong>A17 Pro 芯片及以上</strong></li>
<li><strong>对应设备</strong>：iPhone 15 Pro 及以上（因为 iPhone 15 Pro 搭载 A17 Pro 芯片）</li>
<li><strong>常见误解</strong>：有人误以为需要 "iPhone 17 Pro"，但实际上：<br/>
- iPhone 15 Pro 使用的是 <strong>A17 Pro</strong> 芯片<br/>
- iPhone 17 Pro 目前还不存在（截至 2024 年，最新是 iPhone 16 系列）<br/>
- 要求是 <strong>A17 Pro 芯片</strong>，不是 iPhone 17 Pro</li>
</ul>
<p><strong>完整设备要求列表</strong>：</p>






























<table><thead><tr><th>设备类型</th><th>具体要求</th><th>示例设备</th></tr></thead><tbody><tr><td><strong>iPhone</strong></td><td>A17 Pro 芯片及以上</td><td>iPhone 15 Pro、iPhone 15 Pro Max、iPhone 16 系列</td></tr><tr><td><strong>iPad</strong></td><td>A17 Pro 芯片或 M1 芯片及以上</td><td>iPad Pro (M1/M2/M3)、iPad Air (M1/M2)</td></tr><tr><td><strong>Mac</strong></td><td>Apple Silicon (M 系列)</td><td>MacBook Air/Pro (M1/M2/M3)、iMac (M1/M2/M3)</td></tr><tr><td><strong>Apple Vision Pro</strong></td><td>支持</td><td>Apple Vision Pro</td></tr></tbody></table>
<p><strong>系统要求</strong>：</p>
<ul>
<li><strong>操作系统</strong>: iOS 18.0+ / macOS 15.0+ / iPadOS 18.0+</li>
<li><strong>开发工具</strong>: Xcode 16.0+</li>
<li><strong>功能要求</strong>: Apple Intelligence 已启用（在系统设置中）</li>
</ul>
<h4 data-id="heading-10">系统要求检查流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([应用启动]) --&gt; CheckOS{检查系统版本&lt;br/&gt;iOS 18+/macOS 15+?}  
    CheckOS --&gt;|否| Error1[系统版本过低&lt;br/&gt;提示升级]  
    CheckOS --&gt;|是| CheckDevice{检查设备&lt;br/&gt;A17 Pro+/M系列?}  
    CheckDevice --&gt;|否| Error2[设备不支持&lt;br/&gt;Apple Intelligence]  
    CheckDevice --&gt;|是| CheckSetting{检查设置&lt;br/&gt;Apple Intelligence已启用?}  
    CheckSetting --&gt;|否| Error3[功能未启用&lt;br/&gt;引导用户开启]  
    CheckSetting --&gt;|是| CheckModel{检查模型可用性&lt;br/&gt;SystemLanguageModel.default}  
    CheckModel --&gt;|可用| Success[可以使用&lt;br/&gt;Foundation Models]  
    CheckModel --&gt;|不可用| Error4[模型不可用&lt;br/&gt;显示原因]  
      
    Error1 --&gt; End([结束])  
    Error2 --&gt; End  
    Error3 --&gt; End  
    Error4 --&gt; End  
    Success --&gt; Prewarm[预热模型&lt;br/&gt;可选但推荐]  
    Prewarm --&gt; End  
      
    style Start fill:#007AFF,color:#fff  
    style CheckOS fill:#5AC8FA,color:#000  
    style CheckDevice fill:#5AC8FA,color:#000  
    style CheckSetting fill:#5AC8FA,color:#000  
    style CheckModel fill:#5AC8FA,color:#000  
    style Success fill:#34C759,color:#fff  
    style Error1 fill:#FF3B30,color:#fff  
    style Error2 fill:#FF3B30,color:#fff  
    style Error3 fill:#FF3B30,color:#fff  
    style Error4 fill:#FF3B30,color:#fff  
    style Prewarm fill:#FF9500,color:#fff  
</code></pre>
<p><strong>兼容性检查代码</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FoundationModels

<span class="hljs-comment">// 检查模型可用性  </span>
<span class="hljs-keyword">let</span> model <span class="hljs-operator">=</span> <span class="hljs-type">SystemLanguageModel</span>.default  
<span class="hljs-keyword">switch</span> model.availability {  
<span class="hljs-keyword">case</span> .available:  
    <span class="hljs-comment">// 可以使用Foundation Models  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Foundation Models可用"</span>)  
<span class="hljs-keyword">case</span> .unavailable(<span class="hljs-keyword">let</span> reason):  
    <span class="hljs-comment">// 处理不可用情况  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 模型不可用: <span class="hljs-subst">\(reason.localizedDescription)</span>"</span>)  
}  
</code></pre>
<h4 data-id="heading-11">开发注意事项</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    subgraph "开发限制"  
        L1[模拟器限制&lt;br/&gt;必须真机测试]  
        L2[地区限制&lt;br/&gt;部分功能不可用]  
        L3[用户设置&lt;br/&gt;需启用AI功能]  
    end  
      
    subgraph "解决方案"  
        S1[使用真机测试&lt;br/&gt;iPhone 15 Pro及以上]  
        S2[提供降级方案&lt;br/&gt;功能不可用时]  
        S3[引导用户设置&lt;br/&gt;提示开启步骤]  
    end  
      
    L1 --&gt; S1  
    L2 --&gt; S2  
    L3 --&gt; S3  
      
    style L1 fill:#FF3B30,color:#fff  
    style L2 fill:#FF3B30,color:#fff  
    style L3 fill:#FF3B30,color:#fff  
    style S1 fill:#34C759,color:#fff  
    style S2 fill:#34C759,color:#fff  
    style S3 fill:#34C759,color:#fff  
</code></pre>
<h3 data-id="heading-12">1.4 应用场景概览</h3>
<h4 data-id="heading-13">在相册业务中的应用场景</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD  
    subgraph "智能照片分析"  
        A1[自动生成描述]  
        A2[识别内容]  
        A3[质量评分]  
    end  
      
    subgraph "自然语言搜索"  
        B1[时间搜索&lt;br/&gt;去年夏天]  
        B2[地点搜索&lt;br/&gt;在海边]  
        B3[人物搜索&lt;br/&gt;包含女朋友]  
    end  
      
    subgraph "智能分类"  
        C1[时间分类]  
        C2[地点分类]  
        C3[主题分类]  
        C4[人物分类]  
    end  
      
    subgraph "视频理解"  
        D1[视频摘要]  
        D2[关键时刻]  
        D3[封面生成]  
    end  
      
    subgraph "智能推荐"  
        E1[相似照片]  
        E2[相关回忆]  
        E3[个性化推荐]  
    end  
      
    subgraph "相册管理"  
        F1[清理建议]  
        F2[存储优化]  
        F3[相册整理]  
    end  
      
    style A1 fill:#007AFF,color:#fff  
    style A2 fill:#007AFF,color:#fff  
    style A3 fill:#007AFF,color:#fff  
    style B1 fill:#34C759,color:#fff  
    style B2 fill:#34C759,color:#fff  
    style B3 fill:#34C759,color:#fff  
    style C1 fill:#FF9500,color:#fff  
    style C2 fill:#FF9500,color:#fff  
    style C3 fill:#FF9500,color:#fff  
    style C4 fill:#FF9500,color:#fff  
    style D1 fill:#5AC8FA,color:#000  
    style D2 fill:#5AC8FA,color:#000  
    style D3 fill:#5AC8FA,color:#000  
    style E1 fill:#AF52DE,color:#fff  
    style E2 fill:#AF52DE,color:#fff  
    style E3 fill:#AF52DE,color:#fff  
    style F1 fill:#FF2D55,color:#fff  
    style F2 fill:#FF2D55,color:#fff  
    style F3 fill:#FF2D55,color:#fff  
</code></pre>
<h3 data-id="heading-14">1.5 与其他AI框架的对比</h3>
<h4 data-id="heading-15">Foundation Models vs Core ML vs OpenAI API</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB  
    subgraph "Core ML"  
        CM1[通用ML框架]  
        CM2[需要训练模型]  
        CM3[底层API]  
        CM4[各种ML任务]  
    end  
      
    subgraph "Foundation Models"  
        FM1[专用语言模型]  
        FM2[Apple预训练]  
        FM3[高级API]  
        FM4[NLP任务]  
    end  
      
    subgraph "OpenAI API"  
        OA1[云端服务]  
        OA2[需要网络]  
        OA3[需要密钥]  
        OA4[付费使用]  
    end  
      
    style CM1 fill:#FF9500,color:#fff  
    style CM2 fill:#FF9500,color:#fff  
    style CM3 fill:#FF9500,color:#fff  
    style CM4 fill:#FF9500,color:#fff  
      
    style FM1 fill:#34C759,color:#fff  
    style FM2 fill:#34C759,color:#fff  
    style FM3 fill:#34C759,color:#fff  
    style FM4 fill:#34C759,color:#fff  
      
    style OA1 fill:#FF3B30,color:#fff  
    style OA2 fill:#FF3B30,color:#fff  
    style OA3 fill:#FF3B30,color:#fff  
    style OA4 fill:#FF3B30,color:#fff  
</code></pre>
<p><strong>对比表格</strong>:</p>





















































<table><thead><tr><th>特性</th><th>Core ML</th><th>Foundation Models</th><th>OpenAI API</th></tr></thead><tbody><tr><td>定位</td><td>通用ML框架</td><td>专用语言模型</td><td>云端AI服务</td></tr><tr><td>模型来源</td><td>需要自己训练/转换</td><td>Apple预训练</td><td>OpenAI提供</td></tr><tr><td>API级别</td><td>底层</td><td>高级</td><td>高级</td></tr><tr><td>适用任务</td><td>各种ML任务</td><td>NLP任务</td><td>NLP任务</td></tr><tr><td>部署方式</td><td>设备端</td><td>设备端</td><td>云端</td></tr><tr><td>网络需求</td><td>无需</td><td>无需</td><td>需要</td></tr><tr><td>成本</td><td>免费</td><td>免费</td><td>付费</td></tr></tbody></table>
<h3 data-id="heading-16">1.6 设计哲学与最佳实践</h3>
<h4 data-id="heading-17">Apple的设计哲学</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    subgraph "设计理念"  
        P1[隐私优先&lt;br/&gt;设备端处理]  
        P2[开发者友好&lt;br/&gt;简洁API]  
        P3[系统集成&lt;br/&gt;深度集成]  
        P4[性能优化&lt;br/&gt;Neural Engine]  
    end  
      
    subgraph "最佳实践"  
        B1[检查可用性]  
        B2[错误处理]  
        B3[降级方案]  
        B4[上下文管理]  
        B5[流式响应]  
    end  
      
    P1 --&gt; B1  
    P2 --&gt; B2  
    P3 --&gt; B3  
    P4 --&gt; B4  
    P4 --&gt; B5  
      
    style P1 fill:#007AFF,color:#fff  
    style P2 fill:#34C759,color:#fff  
    style P3 fill:#FF9500,color:#fff  
    style P4 fill:#5AC8FA,color:#000  
    style B1 fill:#AF52DE,color:#fff  
    style B2 fill:#AF52DE,color:#fff  
    style B3 fill:#AF52DE,color:#fff  
    style B4 fill:#AF52DE,color:#fff  
    style B5 fill:#AF52DE,color:#fff  
</code></pre>
<hr/>
<h2 data-id="heading-18">🔧 第二部分：核心API快速上手 </h2>
<h3 data-id="heading-19">2.1 LanguageModelSession - 会话管理</h3>
<h4 data-id="heading-20">基础使用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram  
    participant App as 应用程序  
    participant Session as LanguageModelSession  
    participant Model as SystemLanguageModel  
      
    App-&gt;&gt;Session: 创建会话  
    Session-&gt;&gt;Model: 检查可用性  
    Model--&gt;&gt;Session: 返回可用状态  
      
    App-&gt;&gt;Session: sendMessage("生成标题")  
    Session-&gt;&gt;Model: 发送请求  
    Model--&gt;&gt;Session: 返回响应  
    Session--&gt;&gt;App: 返回content  
      
    Note over App,Model: 会话自动维护上下文  
</code></pre>
<p><strong>代码示例</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FoundationModels

<span class="hljs-comment">// 创建会话  </span>
<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()

<span class="hljs-comment">// 单轮对话  </span>
<span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
    to: <span class="hljs-string">"生成一个旅行博客的标题"</span>  
)  
<span class="hljs-built_in">print</span>(response.content)

<span class="hljs-comment">// 多轮对话 - 会话自动维护上下文  </span>
<span class="hljs-keyword">let</span> response1 <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"我喜欢摄影"</span>)  
<span class="hljs-keyword">let</span> response2 <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"推荐一些拍摄技巧"</span>)  
<span class="hljs-comment">// AI会记住之前说喜欢摄影  </span>
</code></pre>
<h4 data-id="heading-21">自定义指令（Instructions）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
    instructions: <span class="hljs-type">Instructions</span>(<span class="hljs-string">"""  
        你是一个专业的摄影助手，擅长：  
        1. 分析照片和提供拍摄建议  
        2. 识别照片内容和场景  
        3. 提供构图和光线建议  
    """</span>)  
)  
</code></pre>
<h3 data-id="heading-22">2.2 流式响应</h3>
<h4 data-id="heading-23">流式响应工作流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram  
    participant UI as UI界面  
    participant Session as LanguageModelSession  
    participant Model as 语言模型  
      
    UI-&gt;&gt;Session: streamResponse("分析照片")  
    Session-&gt;&gt;Model: 开始生成  
    loop 流式生成  
        Model--&gt;&gt;Session: 生成部分文本  
        Session--&gt;&gt;UI: 返回partialText  
        UI-&gt;&gt;UI: 实时更新UI  
    end  
    Model--&gt;&gt;Session: 生成完成  
    Session--&gt;&gt;UI: 流结束  
</code></pre>
<p><strong>代码示例</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> stream <span class="hljs-operator">=</span> session.streamResponse(to: <span class="hljs-string">"分析照片"</span>)

<span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> partialText <span class="hljs-keyword">in</span> stream {  
    updateUI(with: partialText) <span class="hljs-comment">// 实时更新UI  </span>
}  
</code></pre>
<p><strong>应用场景</strong>: 聊天界面、长文本生成</p>
<h3 data-id="heading-24">2.3 结构化数据生成（@Generable）</h3>
<h4 data-id="heading-25">结构化生成流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    A[定义数据模型&lt;br/&gt;@Generable] --&gt; B[生成Prompt&lt;br/&gt;包含字段描述]  
    B --&gt; C[AI理解需求&lt;br/&gt;基于@Guide]  
    C --&gt; D[生成结构化数据&lt;br/&gt;类型安全]  
    D --&gt; E[自动解析&lt;br/&gt;返回结果]  
      
    style A fill:#007AFF,color:#fff  
    style B fill:#5AC8FA,color:#000  
    style C fill:#FF9500,color:#fff  
    style D fill:#34C759,color:#fff  
    style E fill:#AF52DE,color:#fff  
</code></pre>
<p><strong>定义数据模型</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoAnalysis</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的主题或主要内容"</span>)  
    <span class="hljs-keyword">let</span> subject: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的情感色彩：positive, neutral, negative"</span>)  
    <span class="hljs-keyword">let</span> mood: <span class="hljs-type">PhotoMood</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的拍摄场景：indoor, outdoor, portrait, landscape等"</span>)  
    <span class="hljs-keyword">let</span> scene: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片质量评分，1-10分"</span>)  
    <span class="hljs-keyword">let</span> qualityScore: <span class="hljs-type">Int</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的关键词标签"</span>)  
    <span class="hljs-keyword">let</span> tags: [<span class="hljs-type">String</span>]  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"改进建议"</span>)  
    <span class="hljs-keyword">let</span> suggestions: [<span class="hljs-type">String</span>]  
}

<span class="hljs-keyword">enum</span> <span class="hljs-title class_">PhotoMood</span>: <span class="hljs-title class_">String</span>, <span class="hljs-title class_">Codable</span> {  
    <span class="hljs-keyword">case</span> positive, neutral, negative  
}  
</code></pre>
<p><strong>使用结构化生成</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
<span class="hljs-keyword">let</span> analysis <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
    to: <span class="hljs-string">"分析这张照片：<span class="hljs-subst">\(photoDescription)</span>"</span>,  
    generating: <span class="hljs-type">PhotoAnalysis</span>.<span class="hljs-keyword">self</span>  
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"主题: <span class="hljs-subst">\(analysis.content.subject)</span>"</span>)  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"质量评分: <span class="hljs-subst">\(analysis.content.qualityScore)</span>"</span>)  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"标签: <span class="hljs-subst">\(analysis.content.tags.joined(separator: <span class="hljs-string">", "</span>))</span>"</span>)  
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>✅ 类型安全</li>
<li>✅ 自动解析</li>
<li>✅ 易于集成到现有代码</li>
</ul>
<p><strong>⚠️ Schema 开销注意</strong>: 使用 <code>@Generable</code> 时，每个属性约增加 30 tokens 的开销。在设计复杂的数据结构时，需要考虑这个开销对上下文窗口的影响。</p>
<h3 data-id="heading-26">2.4 工具调用（Tool Calling）- 核心概念</h3>
<h4 data-id="heading-27">Tool协议结构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram  
    class Tool {  
        &lt;&lt;protocol&gt;&gt;  
        +String name  
        +String description  
        +GenerationSchema parameters  
        +call(Arguments) Output  
    }  
      
    class PhotoSearchTool {  
        +String name  
        +String description  
        +call(Arguments) Output  
    }  
      
    class PhotoAnalysisTool {  
        +String name  
        +String description  
        +call(Arguments) Output  
    }  
      
    Tool &lt;|.. PhotoSearchTool  
    Tool &lt;|.. PhotoAnalysisTool  
      
    note for Tool "关键特性:\n- name: 工具标识符\n- description: AI判断何时使用\n- parameters: 定义参数结构\n- call: 工具执行方法"  
</code></pre>
<p><strong>Tool协议定义</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Tool</span>&lt;<span class="hljs-title class_">Arguments</span>, <span class="hljs-title class_">Output</span>&gt; : <span class="hljs-title class_">Sendable</span> {  
    <span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span> { <span class="hljs-keyword">get</span> }  
    <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> { <span class="hljs-keyword">get</span> }  
    <span class="hljs-keyword">var</span> parameters: <span class="hljs-type">GenerationSchema</span> { <span class="hljs-keyword">get</span> }  
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">arguments</span>: <span class="hljs-type">Arguments</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Output</span>  
}  
</code></pre>
<h4 data-id="heading-28">基础Tool实现示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoSearchTool</span>: <span class="hljs-title class_">Tool</span> {  
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"searchPhotos"</span>  
    <span class="hljs-keyword">let</span> description <span class="hljs-operator">=</span> <span class="hljs-string">"根据关键词搜索相册中的照片"</span>  
      
    <span class="hljs-meta">@Generable</span>  
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Arguments</span> {  
        <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"搜索关键词"</span>)  
        <span class="hljs-keyword">var</span> keyword: <span class="hljs-type">String</span>  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">arguments</span>: <span class="hljs-type">Arguments</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">PromptRepresentable</span> {  
        <span class="hljs-keyword">let</span> photos <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> searchPhotos(keyword: arguments.keyword)  
        <span class="hljs-keyword">return</span> <span class="hljs-type">GeneratedContent</span>(properties: [  
            <span class="hljs-string">"count"</span>: photos.count,  
            <span class="hljs-string">"photos"</span>: photos.map { <span class="hljs-variable">$0</span>.toDict() }  
        ])  
    }  
}  
</code></pre>
<h4 data-id="heading-29">工具调用工作机制</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([用户输入:&lt;br/&gt;找一下去年夏天在海边的照片]) --&gt; Step1[1. AI理解用户意图&lt;br/&gt;分析查询内容]  
    Step1 --&gt; Step2[2. 匹配工具描述&lt;br/&gt;PhotoSearchTool description]  
    Step2 --&gt; Step3[3. 生成参数&lt;br/&gt;keyword: 海边&lt;br/&gt;timeRange: 去年夏天]  
    Step3 --&gt; Step4[4. 执行工具&lt;br/&gt;PhotoSearchTool.call]  
    Step4 --&gt; Step5[5. 获取结果&lt;br/&gt;返回照片列表]  
    Step5 --&gt; Step6[6. 生成最终响应&lt;br/&gt;我找到了5张照片...]  
    Step6 --&gt; End([返回给用户])  
      
    style Start fill:#007AFF,color:#fff  
    style Step1 fill:#5AC8FA,color:#000  
    style Step2 fill:#5AC8FA,color:#000  
    style Step3 fill:#FF9500,color:#fff  
    style Step4 fill:#FF9500,color:#fff  
    style Step5 fill:#34C759,color:#fff  
    style Step6 fill:#34C759,color:#fff  
    style End fill:#007AFF,color:#fff  
</code></pre>
<p><strong>示例流程</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">用户: "找一下去年夏天在海边的照片"  
→ AI识别: 搜索照片  
→ 匹配工具: PhotoSearchTool  
→ 提取参数: <span class="hljs-attr">keyword</span>=<span class="hljs-string">"海边"</span>, timeRange=<span class="hljs-string">"去年夏天"</span>  
→ 调用工具 → 返回结果  
</code></pre>
<h4 data-id="heading-30">多工具协调</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR  
    User([用户请求:&lt;br/&gt;找照片+分析+创建相册]) --&gt; AI[AI分析请求]  
      
    AI --&gt; Tool1[PhotoSearchTool&lt;br/&gt;搜索照片]  
    Tool1 --&gt; Result1[照片列表]  
    Result1 --&gt; Tool2[PhotoAnalysisTool&lt;br/&gt;分析内容]  
    Tool2 --&gt; Result2[分析结果]  
    Result2 --&gt; Tool3[AlbumCreationTool&lt;br/&gt;创建相册]  
    Tool3 --&gt; Result3[相册创建成功]  
    Result3 --&gt; Response[AI生成最终响应]  
      
    style User fill:#007AFF,color:#fff  
    style AI fill:#5AC8FA,color:#000  
    style Tool1 fill:#FF9500,color:#fff  
    style Tool2 fill:#FF9500,color:#fff  
    style Tool3 fill:#FF9500,color:#fff  
    style Response fill:#34C759,color:#fff  
</code></pre>
<p><strong>使用示例</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
    tools: [<span class="hljs-type">PhotoSearchTool</span>(), <span class="hljs-type">PhotoAnalysisTool</span>(), <span class="hljs-type">AlbumCreationTool</span>()],  
    instructions: <span class="hljs-type">Instructions</span>(<span class="hljs-string">"你是智能相册助手"</span>)  
)

<span class="hljs-comment">// AI自动判断何时调用工具  </span>
<span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
    to: <span class="hljs-string">"找去年夏天在海边的照片，分析内容，创建相册"</span>  
)  
</code></pre>
<h4 data-id="heading-31">Tool Calling最佳实践</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((Tool Calling&lt;br/&gt;最佳实践))  
    清晰的工具描述  
      AI判断依据  
      描述要准确  
      包含使用场景  
    详细的参数Guide  
      帮助AI理解  
      明确参数含义  
      提供示例  
    结构化的返回结果  
      便于AI处理  
      统一的格式  
      包含必要信息  
    完善的错误处理  
      友好的错误信息  
      异常情况处理  
      降级方案  
    单一职责原则  
      一个工具一件事  
      避免功能耦合  
      易于维护  
</code></pre>
<hr/>
<h2 data-id="heading-32">📸 第三部分：相册业务应用场景 </h2>
<h3 data-id="heading-33">3.1 智能照片分析</h3>
<h4 data-id="heading-34">场景1: 自动生成照片描述</h4>
<p><strong>数据模型定义</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoDescription</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的简短描述，50字以内"</span>)  
    <span class="hljs-keyword">let</span> shortDescription: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"详细描述，包含人物、场景、活动等"</span>)  
    <span class="hljs-keyword">let</span> detailedDescription: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"建议的相册分类"</span>)  
    <span class="hljs-keyword">let</span> suggestedAlbum: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的情感价值：high, medium, low"</span>)  
    <span class="hljs-keyword">let</span> emotionalValue: <span class="hljs-type">String</span>  
}  
</code></pre>
<p><strong>实现流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram  
    participant User as 用户  
    participant ViewModel as PhotoAnalysisViewModel  
    participant Session as LanguageModelSession  
    participant AI as Foundation Models  
      
    User-&gt;&gt;ViewModel: 选择照片  
    ViewModel-&gt;&gt;ViewModel: 获取照片元数据  
    ViewModel-&gt;&gt;Session: 生成分析Prompt  
    Session-&gt;&gt;AI: 发送请求  
    AI-&gt;&gt;AI: 分析照片内容  
    AI--&gt;&gt;Session: 返回结构化数据  
    Session--&gt;&gt;ViewModel: PhotoDescription  
    ViewModel-&gt;&gt;ViewModel: 更新UI状态  
    ViewModel--&gt;&gt;User: 显示分析结果  
</code></pre>
<p><strong>ViewModel实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Observable</span>  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoAnalysisViewModel</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
        instructions: <span class="hljs-type">Instructions</span>(  
            <span class="hljs-string">"你是一个专业的照片分析助手，擅长分析照片内容并生成有意义的描述。"</span>  
        )  
    )  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhoto</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
        <span class="hljs-keyword">let</span> metadata <span class="hljs-operator">=</span> photo.metadata  
          
        <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
            分析这张照片：  
            - 拍摄时间: <span class="hljs-subst">\(metadata.date)</span>  
            - 拍摄地点: <span class="hljs-subst">\(metadata.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
            - EXIF信息: <span class="hljs-subst">\(metadata.exifInfo)</span>  
              
            请生成详细的照片描述和分类建议。  
        """</span>  
          
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
            to: <span class="hljs-type">Prompt</span>(prompt),  
            generating: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
        )  
          
        <span class="hljs-keyword">return</span> response.content  
    }  
}  
</code></pre>
<h4 data-id="heading-35">场景2: 智能相册分类</h4>
<p><strong>分类流程图</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([多张照片]) --&gt; Extract[提取照片信息&lt;br/&gt;时间、地点、描述等]  
    Extract --&gt; Build[构建Prompt&lt;br/&gt;包含所有照片信息]  
    Build --&gt; AI[AI分析&lt;br/&gt;识别共同特征]  
    AI --&gt; Classify{分类标准}  
    Classify --&gt; Time[时间相关性]  
    Classify --&gt; Location[地点相关性]  
    Classify --&gt; Theme[主题相关性]  
    Classify --&gt; People[人物相关性]  
    Time --&gt; Result[生成相册建议]  
    Location --&gt; Result  
    Theme --&gt; Result  
    People --&gt; Result  
    Result --&gt; End([返回AlbumSuggestion列表])  
      
    style Start fill:#007AFF,color:#fff  
    style Extract fill:#5AC8FA,color:#000  
    style Build fill:#5AC8FA,color:#000  
    style AI fill:#FF9500,color:#fff  
    style Result fill:#34C759,color:#fff  
    style End fill:#007AFF,color:#fff  
</code></pre>
<p><strong>代码实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AlbumSuggestion</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"建议的相册名称"</span>)  
    <span class="hljs-keyword">let</span> albumName: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"相册描述"</span>)  
    <span class="hljs-keyword">let</span> description: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"应该包含的照片ID列表"</span>)  
    <span class="hljs-keyword">let</span> photoIds: [<span class="hljs-type">String</span>]  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"分类理由"</span>)  
    <span class="hljs-keyword">let</span> reasoning: <span class="hljs-type">String</span>  
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">suggestAlbums</span>(<span class="hljs-params">for</span> <span class="hljs-params">photos</span>: [<span class="hljs-type">Photo</span>]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">AlbumSuggestion</span>] {  
    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
      
    <span class="hljs-keyword">let</span> photoDescriptions <span class="hljs-operator">=</span> photos.map { photo <span class="hljs-keyword">in</span>  
        <span class="hljs-string">"照片<span class="hljs-subst">\(photo.id)</span>: <span class="hljs-subst">\(photo.description <span class="hljs-operator">??</span> <span class="hljs-string">"无描述"</span>)</span> - <span class="hljs-subst">\(photo.date)</span>"</span>  
    }.joined(separator: <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>)  
      
    <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
        分析以下照片，建议如何将它们组织成相册：  
          
        <span class="hljs-subst">\(photoDescriptions)</span>  
          
        请考虑：  
        1. 时间相关性  
        2. 地点相关性  
        3. 主题相关性  
        4. 人物相关性  
    """</span>  
      
    <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
        to: <span class="hljs-type">Prompt</span>(prompt),  
        generating: [<span class="hljs-type">AlbumSuggestion</span>].<span class="hljs-keyword">self</span>  
    )  
      
    <span class="hljs-keyword">return</span> response.content  
}  
</code></pre>
<h3 data-id="heading-36">3.2 智能搜索和推荐</h3>
<h4 data-id="heading-37">场景3: 自然语言搜索</h4>
<p><strong>搜索工作流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    User([用户输入:&lt;br/&gt;去年夏天在海边拍的照片]) --&gt; Parse[AI解析查询&lt;br/&gt;提取关键词]  
    Parse --&gt; Extract[提取信息&lt;br/&gt;时间: 去年夏天&lt;br/&gt;地点: 海边&lt;br/&gt;人物: 可选]  
    Extract --&gt; Tool[调用PhotoSearchTool&lt;br/&gt;searchPhotos]  
    Tool --&gt; Search[执行搜索&lt;br/&gt;匹配条件]  
    Search --&gt; Filter[筛选结果&lt;br/&gt;按相似度排序]  
    Filter --&gt; Result[返回照片列表]  
    Result --&gt; Display[展示给用户]  
      
    style User fill:#007AFF,color:#fff  
    style Parse fill:#5AC8FA,color:#000  
    style Extract fill:#5AC8FA,color:#000  
    style Tool fill:#FF9500,color:#fff  
    style Search fill:#FF9500,color:#fff  
    style Filter fill:#34C759,color:#fff  
    style Result fill:#34C759,color:#fff  
    style Display fill:#007AFF,color:#fff  
</code></pre>
<p><strong>Tool实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoSearchTool</span>: <span class="hljs-title class_">Tool</span> {  
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"searchPhotos"</span>  
    <span class="hljs-keyword">let</span> description <span class="hljs-operator">=</span> <span class="hljs-string">"在相册中搜索照片，支持自然语言查询"</span>  
      
    <span class="hljs-meta">@Generable</span>  
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Arguments</span> {  
        <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"搜索查询，如'去年夏天在海边的照片'、'包含我妈妈的照片'"</span>)  
        <span class="hljs-keyword">var</span> query: <span class="hljs-type">String</span>  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">arguments</span>: <span class="hljs-type">Arguments</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">PromptRepresentable</span> {  
        <span class="hljs-comment">// 解析自然语言查询  </span>
        <span class="hljs-keyword">let</span> searchCriteria <span class="hljs-operator">=</span> parseNaturalLanguageQuery(arguments.query)  
          
        <span class="hljs-comment">// 执行搜索  </span>
        <span class="hljs-keyword">let</span> results <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> performPhotoSearch(criteria: searchCriteria)  
          
        <span class="hljs-keyword">return</span> <span class="hljs-type">GeneratedContent</span>(properties: [  
            <span class="hljs-string">"count"</span>: results.count,  
            <span class="hljs-string">"photos"</span>: results.map { <span class="hljs-variable">$0</span>.toDictionary() }  
        ])  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">parseNaturalLanguageQuery</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">query</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">SearchCriteria</span> {  
        <span class="hljs-comment">// 使用Foundation Models解析查询  </span>
        <span class="hljs-comment">// 提取：时间、地点、人物、关键词等  </span>
    }  
}

<span class="hljs-comment">// 使用示例  </span>
<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(tools: [<span class="hljs-type">PhotoSearchTool</span>()])  
<span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
    to: <span class="hljs-string">"帮我找一下去年夏天在海边拍的照片，要包含我女朋友的"</span>  
)  
</code></pre>
<h4 data-id="heading-38">场景4: 智能推荐相似照片</h4>
<p><strong>推荐算法流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD  
    Target[目标照片] --&gt; Extract[提取特征&lt;br/&gt;描述、地点、时间、人物、标签]  
    Extract --&gt; Compare[与相册中其他照片&lt;br/&gt;进行特征比较]  
    Compare --&gt; Score[计算相似度评分&lt;br/&gt;多维度加权]  
    Score --&gt; Sort[按相似度排序]  
    Sort --&gt; Filter[筛选Top 5]  
    Filter --&gt; Result[生成推荐结果&lt;br/&gt;包含相似原因]  
      
    style Target fill:#007AFF,color:#fff  
    style Extract fill:#5AC8FA,color:#000  
    style Compare fill:#FF9500,color:#fff  
    style Score fill:#FF9500,color:#fff  
    style Sort fill:#34C759,color:#fff  
    style Filter fill:#34C759,color:#fff  
    style Result fill:#007AFF,color:#fff  
</code></pre>
<p><strong>代码实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SimilarPhotoRecommendation</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"推荐的照片ID"</span>)  
    <span class="hljs-keyword">let</span> photoId: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"相似度评分，1-10分"</span>)  
    <span class="hljs-keyword">let</span> similarityScore: <span class="hljs-type">Int</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"相似的原因"</span>)  
    <span class="hljs-keyword">let</span> reason: <span class="hljs-type">String</span>  
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">findSimilarPhotos</span>(<span class="hljs-params">to</span> <span class="hljs-params">targetPhoto</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">SimilarPhotoRecommendation</span>] {  
    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
      
    <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
        基于以下照片特征，推荐相似的照片：  
          
        目标照片:  
        - 描述: <span class="hljs-subst">\(targetPhoto.description <span class="hljs-operator">??</span> <span class="hljs-string">"无"</span>)</span>  
        - 地点: <span class="hljs-subst">\(targetPhoto.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
        - 时间: <span class="hljs-subst">\(targetPhoto.date)</span>  
        - 人物: <span class="hljs-subst">\(targetPhoto.people.joined(separator: <span class="hljs-string">", "</span>))</span>  
        - 标签: <span class="hljs-subst">\(targetPhoto.tags.joined(separator: <span class="hljs-string">", "</span>))</span>  
          
        请从用户相册中推荐5张最相似的照片。  
    """</span>  
      
    <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
        to: <span class="hljs-type">Prompt</span>(prompt),  
        generating: [<span class="hljs-type">SimilarPhotoRecommendation</span>].<span class="hljs-keyword">self</span>  
    )  
      
    <span class="hljs-keyword">return</span> response.content  
}  
</code></pre>
<h3 data-id="heading-39">3.3 视频内容理解</h3>
<h4 data-id="heading-40">场景5: 视频摘要生成</h4>
<p><strong>视频分析流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Video[视频文件] --&gt; Metadata[提取元数据&lt;br/&gt;时长、时间、地点]  
    Metadata --&gt; KeyFrames[提取关键帧&lt;br/&gt;描述关键画面]  
    KeyFrames --&gt; Build[构建Prompt&lt;br/&gt;包含所有信息]  
    Build --&gt; AI[AI分析&lt;br/&gt;理解视频内容]  
    AI --&gt; Summary[生成摘要&lt;br/&gt;简短描述]  
    AI --&gt; Moments[提取关键时刻&lt;br/&gt;时间戳+描述]  
    AI --&gt; Theme[识别主题]  
    AI --&gt; Thumbnail[建议封面时间]  
    Summary --&gt; Result[返回VideoSummary]  
    Moments --&gt; Result  
    Theme --&gt; Result  
    Thumbnail --&gt; Result  
      
    style Video fill:#007AFF,color:#fff  
    style Metadata fill:#5AC8FA,color:#000  
    style KeyFrames fill:#5AC8FA,color:#000  
    style Build fill:#5AC8FA,color:#000  
    style AI fill:#FF9500,color:#fff  
    style Result fill:#34C759,color:#fff  
</code></pre>
<p><strong>数据模型</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">VideoSummary</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"视频的简短摘要，100字以内"</span>)  
    <span class="hljs-keyword">let</span> summary: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"视频的关键时刻时间戳列表"</span>)  
    <span class="hljs-keyword">let</span> keyMoments: [<span class="hljs-type">KeyMoment</span>]  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"视频的主题"</span>)  
    <span class="hljs-keyword">let</span> theme: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"建议的封面帧时间"</span>)  
    <span class="hljs-keyword">let</span> suggestedThumbnailTime: <span class="hljs-type">Double</span>  
}

<span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">KeyMoment</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"时刻的时间戳（秒）"</span>)  
    <span class="hljs-keyword">let</span> timestamp: <span class="hljs-type">Double</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"时刻的描述"</span>)  
    <span class="hljs-keyword">let</span> description: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"重要性评分，1-10"</span>)  
    <span class="hljs-keyword">let</span> importance: <span class="hljs-type">Int</span>  
}  
</code></pre>
<h3 data-id="heading-41">3.4 智能相册管理</h3>
<h4 data-id="heading-42">场景6: 自动整理和清理建议</h4>
<p><strong>清理建议流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Photos[照片列表] --&gt; Analyze[分析每张照片&lt;br/&gt;质量、大小、日期、描述]  
    Analyze --&gt; Criteria[应用清理标准&lt;br/&gt;模糊、重复、低质量、临时]  
    Criteria --&gt; Score[计算清理优先级&lt;br/&gt;综合评分]  
    Score --&gt; Sort[按优先级排序]  
    Sort --&gt; Suggest[生成清理建议&lt;br/&gt;包含原因和空间]  
    Suggest --&gt; Result[返回CleanupSuggestion]  
      
    style Photos fill:#007AFF,color:#fff  
    style Analyze fill:#5AC8FA,color:#000  
    style Criteria fill:#FF9500,color:#fff  
    style Score fill:#FF9500,color:#fff  
    style Sort fill:#34C759,color:#fff  
    style Suggest fill:#34C759,color:#fff  
    style Result fill:#007AFF,color:#fff  
</code></pre>
<p><strong>代码实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CleanupSuggestion</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"建议删除的照片ID列表"</span>)  
    <span class="hljs-keyword">let</span> photosToDelete: [<span class="hljs-type">String</span>]  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"删除原因"</span>)  
    <span class="hljs-keyword">let</span> reason: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"预计可释放的存储空间（MB）"</span>)  
    <span class="hljs-keyword">let</span> spaceToFree: <span class="hljs-type">Double</span>  
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">suggestCleanup</span>(<span class="hljs-params">for</span> <span class="hljs-params">photos</span>: [<span class="hljs-type">Photo</span>]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">CleanupSuggestion</span> {  
    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
        instructions: <span class="hljs-type">Instructions</span>(  
            <span class="hljs-string">"你是一个相册管理助手，帮助用户清理重复、模糊或低质量的照片。"</span>  
        )  
    )  
      
    <span class="hljs-keyword">let</span> photoList <span class="hljs-operator">=</span> photos.map { photo <span class="hljs-keyword">in</span>  
        <span class="hljs-string">"""  
        照片<span class="hljs-subst">\(photo.id)</span>:  
        - 大小: <span class="hljs-subst">\(photo.fileSize)</span>MB  
        - 质量: <span class="hljs-subst">\(photo.qualityScore)</span>/10  
        - 日期: <span class="hljs-subst">\(photo.date)</span>  
        - 描述: <span class="hljs-subst">\(photo.description <span class="hljs-operator">??</span> <span class="hljs-string">"无"</span>)</span>  
        """</span>  
    }.joined(separator: <span class="hljs-string">"<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>)  
      
    <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
        分析以下照片，建议哪些可以删除以释放存储空间：  
          
        <span class="hljs-subst">\(photoList)</span>  
          
        考虑因素：  
        1. 照片质量（模糊、过曝、欠曝）  
        2. 重复照片  
        3. 截图和临时照片  
        4. 用户可能不需要的照片  
    """</span>  
      
    <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
        to: <span class="hljs-type">Prompt</span>(prompt),  
        generating: <span class="hljs-type">CleanupSuggestion</span>.<span class="hljs-keyword">self</span>  
    )  
      
    <span class="hljs-keyword">return</span> response.content  
}  
</code></pre>
<hr/>
<h2 data-id="heading-43">💡 第四部分：实际编码实践和最佳实践 </h2>
<h3 data-id="heading-44">4.1 从零开始：实际开发流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([开始集成Foundation Models]) --&gt; Step1[步骤1: 检查模型可用性&lt;br/&gt;SystemLanguageModel.default]  
    Step1 --&gt; Check{模型可用?}  
    Check --&gt;|否| Error[显示错误提示&lt;br/&gt;提供降级方案]  
    Check --&gt;|是| Step2[步骤2: 创建Session管理器&lt;br/&gt;PhotoAISessionManager]  
    Step2 --&gt; Step3[步骤3: 集成到ViewModel&lt;br/&gt;PhotoAnalysisViewModel]  
    Step3 --&gt; Step4[步骤4: 在SwiftUI中使用&lt;br/&gt;PhotoAnalysisView]  
    Step4 --&gt; Success([完成集成])  
    Error --&gt; End([结束])  
    Success --&gt; End  
      
    style Start fill:#007AFF,color:#fff  
    style Step1 fill:#5AC8FA,color:#000  
    style Step2 fill:#5AC8FA,color:#000  
    style Step3 fill:#5AC8FA,color:#000  
    style Step4 fill:#5AC8FA,color:#000  
    style Check fill:#FF9500,color:#fff  
    style Error fill:#FF3B30,color:#fff  
    style Success fill:#34C759,color:#fff  
</code></pre>
<h4 data-id="heading-45">步骤1: 检查模型可用性</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FoundationModels

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FoundationModelsManager</span> {  
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">FoundationModelsManager</span>()  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {}  
      
    <span class="hljs-comment">/// 检查Foundation Models是否可用  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkAvailability</span>() -&gt; (available: <span class="hljs-type">Bool</span>, reason: <span class="hljs-type">String</span>?) {  
        <span class="hljs-keyword">let</span> model <span class="hljs-operator">=</span> <span class="hljs-type">SystemLanguageModel</span>.default  
        <span class="hljs-keyword">switch</span> model.availability {  
        <span class="hljs-keyword">case</span> .available:  
            <span class="hljs-keyword">return</span> (<span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>)  
        <span class="hljs-keyword">case</span> .unavailable(<span class="hljs-keyword">let</span> reason):  
            <span class="hljs-keyword">return</span> (<span class="hljs-literal">false</span>, reason.localizedDescription)  
        }  
    }  
      
    <span class="hljs-comment">/// 在应用启动时检查并预热  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">setup</span>() <span class="hljs-keyword">async</span> {  
        <span class="hljs-keyword">let</span> (available, reason) <span class="hljs-operator">=</span> checkAvailability()  
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>available {  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ Foundation Models不可用: <span class="hljs-subst">\(reason <span class="hljs-operator">??</span> <span class="hljs-string">"未知原因"</span>)</span>"</span>)  
            <span class="hljs-keyword">return</span>  
        }  
          
        <span class="hljs-comment">// 预热模型（可选，但推荐）  </span>
        <span class="hljs-keyword">await</span> prewarmModel()  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">prewarmModel</span>() <span class="hljs-keyword">async</span> {  
        <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
        <span class="hljs-keyword">do</span> {  
            <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"Hello"</span>)  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Foundation Models预热成功"</span>)  
        } <span class="hljs-keyword">catch</span> {  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 模型预热失败: <span class="hljs-subst">\(error)</span>"</span>)  
        }  
    }  
}

<span class="hljs-comment">// 在App启动时调用  </span>
<span class="hljs-keyword">@main</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyApp</span>: <span class="hljs-title class_">App</span> {  
    <span class="hljs-keyword">init</span>() {  
        <span class="hljs-type">Task</span> {  
            <span class="hljs-keyword">await</span> <span class="hljs-type">FoundationModelsManager</span>.shared.setup()  
        }  
    }  
}  
</code></pre>
<h4 data-id="heading-46">步骤2: 创建可复用的Session管理器</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram  
    class PhotoAISessionManager {  
        -LanguageModelSession session  
        -[Tool] tools  
        +sendMessage(String) String  
        +streamMessage(String) AsyncStream  
        +generateStructured(T) T  
        +reset()  
    }  
      
    class LanguageModelSession {  
        +respond(Prompt) Response  
        +streamResponse(Prompt) AsyncStream  
        +transcript Transcript  
    }  
      
    class PhotoSearchTool {  
        +name: String  
        +description: String  
        +call(Arguments) Output  
    }  
      
    class PhotoAnalysisTool {  
        +name: String  
        +description: String  
        +call(Arguments) Output  
    }  
      
    PhotoAISessionManager --&gt; LanguageModelSession  
    PhotoAISessionManager --&gt; PhotoSearchTool  
    PhotoAISessionManager --&gt; PhotoAnalysisTool  
</code></pre>
<p><strong>完整实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FoundationModels  
<span class="hljs-keyword">import</span> Observation

<span class="hljs-meta">@Observable</span>  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoAISessionManager</span> {  
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> session: <span class="hljs-type">LanguageModelSession</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> tools: [<span class="hljs-keyword">any</span> <span class="hljs-type">Tool</span>]  
      
    <span class="hljs-keyword">init</span>() {  
        <span class="hljs-keyword">self</span>.tools <span class="hljs-operator">=</span> [  
            <span class="hljs-type">PhotoSearchTool</span>(),  
            <span class="hljs-type">PhotoAnalysisTool</span>(),  
            <span class="hljs-type">AlbumCreationTool</span>()  
        ]  
          
        <span class="hljs-keyword">self</span>.session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
            tools: tools,  
            instructions: <span class="hljs-type">Instructions</span>(<span class="hljs-string">"""  
                你是一个智能相册助手，可以帮助用户：  
                1. 搜索照片（使用searchPhotos工具）  
                2. 分析照片内容（使用analyzePhoto工具）  
                3. 创建相册（使用createAlbum工具）  
                  
                始终用友好、自然的方式与用户交流。  
            """</span>)  
        )  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-type">Prompt</span>(message))  
        <span class="hljs-keyword">return</span> response.content  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">streamMessage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">AsyncThrowingStream</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Error</span>&gt; {  
        <span class="hljs-type">AsyncThrowingStream</span> { continuation <span class="hljs-keyword">in</span>  
            <span class="hljs-type">Task</span> {  
                <span class="hljs-keyword">do</span> {  
                    <span class="hljs-keyword">let</span> stream <span class="hljs-operator">=</span> session.streamResponse(to: <span class="hljs-type">Prompt</span>(message))  
                    <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> partialText <span class="hljs-keyword">in</span> stream {  
                        continuation.yield(partialText)  
                    }  
                    continuation.finish()  
                } <span class="hljs-keyword">catch</span> {  
                    continuation.finish(throwing: error)  
                }  
            }  
        }  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">generateStructured</span>&lt;<span class="hljs-type">T</span>: <span class="hljs-type">Generable</span>&gt;(  
        <span class="hljs-params">prompt</span>: <span class="hljs-type">String</span>,  
        <span class="hljs-params">type</span>: <span class="hljs-type">T</span>.<span class="hljs-keyword">Type</span>  
    ) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">T</span> {  
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
            to: <span class="hljs-type">Prompt</span>(prompt),  
            generating: type  
        )  
        <span class="hljs-keyword">return</span> response.content  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">reset</span>() {  
        <span class="hljs-keyword">self</span>.session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
            tools: tools,  
            instructions: <span class="hljs-type">Instructions</span>(<span class="hljs-string">"你是一个智能相册助手"</span>)  
        )  
    }  
}  
</code></pre>
<h4 data-id="heading-47">步骤3: 集成到ViewModel</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB  
    subgraph "View Layer"  
        View[PhotoAnalysisView&lt;br/&gt;SwiftUI View]  
    end  
      
    subgraph "ViewModel Layer"  
        ViewModel[PhotoAnalysisViewModel&lt;br/&gt;@Observable]  
        SessionManager[PhotoAISessionManager]  
    end  
      
    subgraph "Model Layer"  
        Model[Photo Model]  
        FoundationModels[Foundation Models]  
    end  
      
    View --&gt;|@State| ViewModel  
    ViewModel --&gt;|调用| SessionManager  
    SessionManager --&gt;|使用| FoundationModels  
    ViewModel --&gt;|操作| Model  
    Model --&gt;|更新| ViewModel  
    ViewModel --&gt;|通知| View  
      
    style View fill:#007AFF,color:#fff  
    style ViewModel fill:#5AC8FA,color:#000  
    style SessionManager fill:#FF9500,color:#fff  
    style Model fill:#34C759,color:#fff  
    style FoundationModels fill:#FF3B30,color:#fff  
</code></pre>
<p><strong>ViewModel实现</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Observable</span>  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoAnalysisViewModel</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> sessionManager <span class="hljs-operator">=</span> <span class="hljs-type">PhotoAISessionManager</span>()  
      
    <span class="hljs-keyword">var</span> isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
    <span class="hljs-keyword">var</span> errorMessage: <span class="hljs-type">String</span>?  
    <span class="hljs-keyword">var</span> analysisResult: <span class="hljs-type">PhotoDescription</span>?  
    <span class="hljs-keyword">var</span> streamingText <span class="hljs-operator">=</span> <span class="hljs-string">""</span>  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhoto</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> {  
        isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>  
        errorMessage <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>  
          
        <span class="hljs-keyword">do</span> {  
            <span class="hljs-keyword">let</span> metadata <span class="hljs-operator">=</span> photo.metadata  
            <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
                分析这张照片：  
                - 时间: <span class="hljs-subst">\(metadata.date)</span>  
                - 地点: <span class="hljs-subst">\(metadata.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
                - EXIF: <span class="hljs-subst">\(metadata.exifInfo)</span>  
                  
                请生成详细的照片描述和分类建议。  
            """</span>  
              
            <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> sessionManager.generateStructured(  
                prompt: prompt,  
                type: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
            )  
              
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                <span class="hljs-keyword">self</span>.analysisResult <span class="hljs-operator">=</span> result  
                <span class="hljs-keyword">self</span>.isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
            }  
        } <span class="hljs-keyword">catch</span> {  
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                <span class="hljs-keyword">self</span>.errorMessage <span class="hljs-operator">=</span> handleError(error)  
                <span class="hljs-keyword">self</span>.isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
            }  
        }  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhotoWithStreaming</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> {  
        isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>  
        streamingText <span class="hljs-operator">=</span> <span class="hljs-string">""</span>  
        errorMessage <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>  
          
        <span class="hljs-keyword">do</span> {  
            <span class="hljs-keyword">let</span> metadata <span class="hljs-operator">=</span> photo.metadata  
            <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
                分析这张照片：  
                - 时间: <span class="hljs-subst">\(metadata.date)</span>  
                - 地点: <span class="hljs-subst">\(metadata.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
                  
                请详细分析照片内容。  
            """</span>  
              
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> partialText <span class="hljs-keyword">in</span> sessionManager.streamMessage(prompt) {  
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                    <span class="hljs-keyword">self</span>.streamingText <span class="hljs-operator">+=</span> partialText  
                }  
            }  
              
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                <span class="hljs-keyword">self</span>.isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
            }  
        } <span class="hljs-keyword">catch</span> {  
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                <span class="hljs-keyword">self</span>.errorMessage <span class="hljs-operator">=</span> handleError(error)  
                <span class="hljs-keyword">self</span>.isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
            }  
        }  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleError</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> generationError <span class="hljs-operator">=</span> error <span class="hljs-keyword">as?</span> <span class="hljs-type">LanguageModelSession</span>.<span class="hljs-type">GenerationError</span> {  
            <span class="hljs-keyword">switch</span> generationError {  
            <span class="hljs-keyword">case</span> .exceededContextWindowSize:  
                <span class="hljs-keyword">return</span> <span class="hljs-string">"对话内容过长，请清理历史记录"</span>  
            <span class="hljs-keyword">default</span>:  
                <span class="hljs-keyword">return</span> <span class="hljs-string">"生成失败: <span class="hljs-subst">\(generationError.localizedDescription)</span>"</span>  
            }  
        }  
        <span class="hljs-keyword">return</span> <span class="hljs-string">"错误: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>  
    }  
}  
</code></pre>
<h4 data-id="heading-48">步骤4: 在SwiftUI中使用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoAnalysisView</span>: <span class="hljs-title class_">View</span> {  
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">PhotoAnalysisViewModel</span>()  
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> selectedPhoto: <span class="hljs-type">Photo</span>?  
      
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {  
        <span class="hljs-type">VStack</span> {  
            <span class="hljs-keyword">if</span> viewModel.isLoading {  
                <span class="hljs-type">ProgressView</span>(<span class="hljs-string">"分析中..."</span>)  
                    .padding()  
            }  
              
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> viewModel.errorMessage {  
                <span class="hljs-type">Text</span>(<span class="hljs-string">"错误: <span class="hljs-subst">\(error)</span>"</span>)  
                    .foregroundColor(.red)  
                    .padding()  
            }  
              
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> viewModel.analysisResult {  
                <span class="hljs-type">VStack</span>(alignment: .leading, spacing: <span class="hljs-number">12</span>) {  
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"主题: <span class="hljs-subst">\(result.subject)</span>"</span>)  
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"质量评分: <span class="hljs-subst">\(result.qualityScore)</span>/10"</span>)  
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"标签: <span class="hljs-subst">\(result.tags.joined(separator: <span class="hljs-string">", "</span>))</span>"</span>)  
                }  
                .padding()  
            }  
              
            <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>viewModel.streamingText.isEmpty {  
                <span class="hljs-type">ScrollView</span> {  
                    <span class="hljs-type">Text</span>(viewModel.streamingText)  
                        .padding()  
                }  
            }  
              
            <span class="hljs-type">Button</span>(<span class="hljs-string">"分析照片"</span>) {  
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> photo <span class="hljs-operator">=</span> selectedPhoto {  
                    <span class="hljs-type">Task</span> {  
                        <span class="hljs-keyword">await</span> viewModel.analyzePhoto(photo)  
                    }  
                }  
            }  
            .disabled(viewModel.isLoading <span class="hljs-operator">||</span> selectedPhoto <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span>)  
        }  
    }  
}  
</code></pre>
<h3 data-id="heading-49">4.2 性能优化实践</h3>
<h4 data-id="heading-50">内存消耗与性能特征</h4>
<p><strong>实际内存占用</strong>:</p>
<p>根据实际测试，Foundation Models 在运行时的内存消耗包括：</p>






























<table><thead><tr><th>组件</th><th>内存占用</th><th>说明</th></tr></thead><tbody><tr><td>模型权重</td><td>~750MB</td><td>3B 参数 × 2-bit 量化</td></tr><tr><td>KV Cache</td><td>~300-600MB</td><td>8-bit 量化，37.5% 减少优化</td></tr><tr><td>框架开销</td><td>~100-200MB</td><td>系统框架和运行时开销</td></tr><tr><td><strong>总计</strong></td><td><strong>~1.0-1.5GB</strong></td><td>实际运行时内存占用</td></tr></tbody></table>
<p><strong>内存管理建议</strong>:</p>
<ul>
<li>在内存受限的设备上，需要仔细考虑何时加载和释放 session</li>
<li>好消息是苹果做了很多优化，比如 KV cache 的 8-bit 量化和 37.5% 的 block sharing 减少</li>
<li>base 模型本身似乎在不用时也会自动 unload</li>
</ul>
<p><strong>性能特征</strong>:</p>























<table><thead><tr><th>场景</th><th>iPhone</th><th>M2 Pro</th><th>说明</th></tr></thead><tbody><tr><td>单 session</td><td>10-30 tokens/s</td><td>~30 tokens/s</td><td>正常性能</td></tr><tr><td>3 个并发 session</td><td><strong>每个约 1 token/s</strong></td><td><strong>每个约 1 token/s</strong></td><td>⚠️ 严重性能下降</td></tr></tbody></table>
<p><strong>⚠️ 并发性能警告</strong>: 多 session 并发会严重影响性能，从 10-30 tokens/s 骤降至约 1 token/s。苹果只考虑了单 session 的使用场景。</p>
<p><strong>推荐做法</strong>: 全局管理<strong>一个 session</strong>，使用队列串行访问，避免任何并发 session。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ✅ 推荐：使用队列管理请求  </span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">SessionManager</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> requestQueue: [<span class="hljs-type">AIRequest</span>] <span class="hljs-operator">=</span> []  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processRequest</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">request</span>: <span class="hljs-type">AIRequest</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">AIResponse</span> {  
        <span class="hljs-comment">// 串行处理，不要并发  </span>
        <span class="hljs-comment">// 使用队列确保同一时间只有一个请求在使用 session  </span>
    }  
}  
</code></pre>
<h4 data-id="heading-51">上下文窗口管理</h4>
<p><strong>⚠️ 重要限制</strong>: 虽然苹果提到模型训练时支持最高 65K tokens 的上下文，但<strong>实际部署到用户设备上的硬限制是 4096 tokens</strong>。这对于一般的对话场景，大约能支持 10-20 轮对话。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([开始对话]) --&gt; Check{Token使用量&lt;br/&gt;检查}  
    Check --&gt;|小于80%| Normal[正常使用]  
    Check --&gt;|达到80%| Clean[清理旧对话]  
    Normal --&gt; Continue[继续对话]  
    Clean --&gt; Keep[保留最近对话&lt;br/&gt;约3000 tokens]  
    Keep --&gt; Continue  
    Continue --&gt; Check  
      
    style Start fill:#007AFF,color:#fff  
    style Check fill:#FF9500,color:#fff  
    style Normal fill:#34C759,color:#fff  
    style Clean fill:#FF3B30,color:#fff  
    style Keep fill:#5AC8FA,color:#000  
</code></pre>
<p><strong>实现代码</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedChatViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {  
    <span class="hljs-comment">// ⚠️ 实际限制是 4096 tokens，不是 65K  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxTokens <span class="hljs-operator">=</span> <span class="hljs-number">4096</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> windowThreshold <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span> <span class="hljs-comment">// 80%时开始清理  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> targetWindowSize <span class="hljs-operator">=</span> <span class="hljs-number">3000</span> <span class="hljs-comment">// 目标窗口大小（保留一些余量）  </span>
      
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> session: <span class="hljs-type">LanguageModelSession</span>  
      
    <span class="hljs-keyword">init</span>() {  
        <span class="hljs-keyword">self</span>.session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">shouldApplySlidingWindow</span>() -&gt; <span class="hljs-type">Bool</span> {  
        <span class="hljs-keyword">let</span> currentTokens <span class="hljs-operator">=</span> session.transcript.estimatedTokenCount  
        <span class="hljs-keyword">let</span> ratio <span class="hljs-operator">=</span> <span class="hljs-type">Double</span>(currentTokens) <span class="hljs-operator">/</span> <span class="hljs-type">Double</span>(maxTokens)  
        <span class="hljs-keyword">return</span> ratio <span class="hljs-operator">&gt;=</span> windowThreshold  
    }  
      
    <span class="hljs-meta">@MainActor</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">applySlidingWindow</span>() <span class="hljs-keyword">async</span> {  
        <span class="hljs-keyword">let</span> recentEntries <span class="hljs-operator">=</span> session.transcript.entriesWithinTokenBudget(  
            targetWindowSize: targetWindowSize  
        )  
          
        <span class="hljs-keyword">var</span> finalEntries <span class="hljs-operator">=</span> recentEntries  
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> instructions <span class="hljs-operator">=</span> session.transcript.first(where: {  
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .instructions <span class="hljs-operator">=</span> <span class="hljs-variable">$0</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> }  
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>  
        }) {  
            <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>finalEntries.contains(where: { <span class="hljs-variable">$0</span>.id <span class="hljs-operator">==</span> instructions.id }) {  
                finalEntries.insert(instructions, at: <span class="hljs-number">0</span>)  
            }  
        }  
          
        session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
            transcript: <span class="hljs-type">Transcript</span>(entries: finalEntries)  
        )  
    }  
      
    <span class="hljs-meta">@MainActor</span>  
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {  
        <span class="hljs-keyword">if</span> shouldApplySlidingWindow() {  
            <span class="hljs-keyword">await</span> applySlidingWindow()  
        }  
          
        <span class="hljs-keyword">let</span> stream <span class="hljs-operator">=</span> session.streamResponse(to: <span class="hljs-type">Prompt</span>(message))  
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> stream {  
            <span class="hljs-comment">// 流式响应自动更新transcript  </span>
        }  
    }  
}  
</code></pre>
<h4 data-id="heading-52">预加载和预热（Prewarming）</h4>
<p><strong>预热（Prewarming）</strong> 是在用户发出请求之前，提前加载和初始化设备上的语言模型，从而减少初始延迟的关键优化技术。</p>
<h5 data-id="heading-53">预热的工作原理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    subgraph NoPrewarm [无预热场景]  
        User1[用户请求] --&gt; Load1[加载模型 耗时 2-3秒]  
        Load1 --&gt; Init1[初始化模型 耗时 0.5-1秒]  
        Init1 --&gt; Inference1[执行推理 耗时 1-2秒]  
        Inference1 --&gt; Response1[返回结果 总耗时 3.5-6秒]  
    end  
      
    subgraph WithPrewarm [预热场景]  
        Trigger[触发预热 用户打开页面或点击输入框] --&gt; Load2[后台加载模型 用户无感知]  
        Load2 --&gt; Init2[后台初始化模型 用户无感知]  
        Init2 --&gt; Ready[模型准备就绪 保持在内存中]  
        User2[用户请求] --&gt; Inference2[立即执行推理 耗时 1-2秒]  
        Inference2 --&gt; Response2[返回结果 总耗时 1-2秒]  
    end  
      
    style User1 fill:#FF3B30,color:#fff  
    style Load1 fill:#FF3B30,color:#fff  
    style Response1 fill:#FF3B30,color:#fff  
    style Trigger fill:#5AC8FA,color:#000  
    style Ready fill:#34C759,color:#fff  
    style User2 fill:#007AFF,color:#fff  
    style Response2 fill:#34C759,color:#fff  
</code></pre>
<p><strong>预热的核心价值</strong>:</p>
<ul>
<li>✅ <strong>减少首次调用延迟</strong>: 从 3-6 秒降低到 1-2 秒</li>
<li>✅ <strong>提升用户体验</strong>: 用户几乎无感知的等待时间</li>
<li>✅ <strong>优化资源利用</strong>: 在用户空闲时提前准备，避免阻塞主线程</li>
</ul>
<h5 data-id="heading-54">预热的最佳时机</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    AppStart[应用启动] --&gt; Check1{是否支持 Foundation Models?}  
    Check1 --&gt;|是| Prewarm1[后台预热 低优先级]  
    Check1 --&gt;|否| Skip1[跳过预热]  
      
    UserEnter[用户进入AI功能页面] --&gt; Prewarm2[立即预热 中优先级]  
      
    UserClick[用户点击输入框] --&gt; Prewarm3[快速预热 高优先级]  
      
    Prewarm1 --&gt; Ready[模型准备就绪]  
    Prewarm2 --&gt; Ready  
    Prewarm3 --&gt; Ready  
      
    Ready --&gt; UserRequest[用户发起请求]  
    UserRequest --&gt; FastResponse[快速响应]  
      
    style AppStart fill:#007AFF,color:#fff  
    style UserEnter fill:#5AC8FA,color:#000  
    style UserClick fill:#FF9500,color:#fff  
    style Prewarm1 fill:#34C759,color:#fff  
    style Prewarm2 fill:#34C759,color:#fff  
    style Prewarm3 fill:#34C759,color:#fff  
    style Ready fill:#AF52DE,color:#fff  
    style FastResponse fill:#34C759,color:#fff  
</code></pre>
<p><strong>预热时机优先级</strong>:</p>
<ol>
<li>
<p><strong>应用启动时</strong>（低优先级）<br/>
- 优点：最早准备，用户首次使用即可快速响应<br/>
- 缺点：可能影响应用启动速度<br/>
- 建议：在后台低优先级线程预热，不影响启动</p>
</li>
<li>
<p><strong>用户进入AI功能页面时</strong>（中优先级）<br/>
- 优点：用户明确意图，预热价值高<br/>
- 缺点：如果用户不实际使用，浪费资源<br/>
- 建议：在页面出现时立即预热</p>
</li>
<li>
<p><strong>用户点击输入框时</strong>（高优先级）<br/>
- 优点：用户即将使用，预热最及时<br/>
- 缺点：可能来不及完全预热<br/>
- 建议：快速预热，至少完成基础初始化</p>
</li>
</ol>
<h5 data-id="heading-55">基础预热实现</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelPrewarmer</span> {  
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">ModelPrewarmer</span>()  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isPrewarmed <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> prewarmingTask: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> prewarmQueue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"com.app.prewarm"</span>, qos: .utility)  
      
    <span class="hljs-comment">/// 预热模型（基础版本）  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">prewarm</span>() {  
        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>isPrewarmed <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }  
          
        prewarmQueue.async {  
            <span class="hljs-type">Task</span> {  
                <span class="hljs-keyword">do</span> {  
                    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
                    <span class="hljs-comment">// 发送一个简单的请求来预热模型  </span>
                    <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"Hello"</span>)  
                    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                        <span class="hljs-keyword">self</span>.isPrewarmed <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>  
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 模型预热成功"</span>)  
                    }  
                } <span class="hljs-keyword">catch</span> {  
                    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 模型预热失败: <span class="hljs-subst">\(error)</span>"</span>)  
                    }  
                }  
            }  
        }  
    }  
      
    <span class="hljs-comment">/// 检查预热状态  </span>
    <span class="hljs-keyword">var</span> isReady: <span class="hljs-type">Bool</span> {  
        <span class="hljs-keyword">return</span> isPrewarmed  
    }  
}  
</code></pre>
<h5 data-id="heading-56">智能预热实现（多时机支持）</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PrewarmPriority</span> {  
    <span class="hljs-keyword">case</span> low      <span class="hljs-comment">// 应用启动时  </span>
    <span class="hljs-keyword">case</span> medium   <span class="hljs-comment">// 进入功能页面时  </span>
    <span class="hljs-keyword">case</span> high     <span class="hljs-comment">// 用户点击输入框时  </span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartModelPrewarmer</span> {  
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">SmartModelPrewarmer</span>()  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isPrewarmed <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> prewarmingTask: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> prewarmStartTime: <span class="hljs-type">Date</span>?  
      
    <span class="hljs-comment">/// 智能预热：根据优先级和时机决定是否预热  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">prewarm</span>(<span class="hljs-params">priority</span>: <span class="hljs-type">PrewarmPriority</span> <span class="hljs-operator">=</span> .medium) {  
        <span class="hljs-comment">// 如果已经预热，直接返回  </span>
        <span class="hljs-keyword">if</span> isPrewarmed {  
            <span class="hljs-keyword">return</span>  
        }  
          
        <span class="hljs-comment">// 如果正在预热，检查优先级  </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> prewarmingTask, <span class="hljs-operator">!</span>task.isCancelled {  
            <span class="hljs-comment">// 高优先级可以取消低优先级预热，重新开始  </span>
            <span class="hljs-keyword">if</span> priority <span class="hljs-operator">==</span> .high {  
                task.cancel()  
            } <span class="hljs-keyword">else</span> {  
                <span class="hljs-keyword">return</span>  
            }  
        }  
          
        <span class="hljs-comment">// 根据优先级设置 QoS  </span>
        <span class="hljs-keyword">let</span> qos: <span class="hljs-type">TaskPriority</span> <span class="hljs-operator">=</span> priority <span class="hljs-operator">==</span> .high <span class="hljs-operator">?</span> .userInitiated : .utility  
          
        prewarmStartTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()  
        prewarmingTask <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>(priority: qos) {  
            <span class="hljs-keyword">do</span> {  
                <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
                  
                <span class="hljs-comment">// 根据优先级选择预热策略  </span>
                <span class="hljs-keyword">switch</span> priority {  
                <span class="hljs-keyword">case</span> .high:  
                    <span class="hljs-comment">// 高优先级：快速预热，只做基础初始化  </span>
                    <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"Hi"</span>)  
                <span class="hljs-keyword">case</span> .medium:  
                    <span class="hljs-comment">// 中优先级：完整预热  </span>
                    <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"Hello, how can I help you?"</span>)  
                <span class="hljs-keyword">case</span> .low:  
                    <span class="hljs-comment">// 低优先级：后台预热，不阻塞  </span>
                    <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: <span class="hljs-string">"Hello"</span>)  
                }  
                  
                <span class="hljs-keyword">let</span> duration <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().timeIntervalSince(<span class="hljs-keyword">self</span>.prewarmStartTime <span class="hljs-operator">??</span> <span class="hljs-type">Date</span>())  
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                    <span class="hljs-keyword">self</span>.isPrewarmed <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>  
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 模型预热成功（优先级: <span class="hljs-subst">\(priority)</span>, 耗时: <span class="hljs-subst">\(String(format: <span class="hljs-string">"%.2f"</span>, duration))</span>秒）"</span>)  
                }  
            } <span class="hljs-keyword">catch</span> {  
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {  
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 模型预热失败: <span class="hljs-subst">\(error)</span>"</span>)  
                }  
            }  
        }  
    }  
      
    <span class="hljs-comment">/// 取消预热（如果用户离开页面）  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cancelPrewarming</span>() {  
        prewarmingTask<span class="hljs-operator">?</span>.cancel()  
        prewarmingTask <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>  
    }  
}  
</code></pre>
<h5 data-id="heading-57">在应用中的集成</h5>
<p><strong>场景1: 应用启动时预热</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@main</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyApp</span>: <span class="hljs-title class_">App</span> {  
    <span class="hljs-keyword">init</span>() {  
        <span class="hljs-comment">// 应用启动时，低优先级预热  </span>
        <span class="hljs-type">Task</span>.detached(priority: .utility) {  
            <span class="hljs-keyword">await</span> <span class="hljs-type">SmartModelPrewarmer</span>.shared.prewarm(priority: .low)  
        }  
    }  
}  
</code></pre>
<p><strong>场景2: 进入AI功能页面时预热</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoAnalysisView</span>: <span class="hljs-title class_">View</span> {  
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">PhotoAnalysisViewModel</span>()  
      
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {  
        <span class="hljs-type">VStack</span> {  
            <span class="hljs-comment">// UI 内容  </span>
        }  
        .onAppear {  
            <span class="hljs-comment">// 用户进入页面时，立即预热  </span>
            <span class="hljs-type">SmartModelPrewarmer</span>.shared.prewarm(priority: .medium)  
        }  
        .onDisappear {  
            <span class="hljs-comment">// 用户离开页面时，可以取消预热（可选）  </span>
            <span class="hljs-comment">// SmartModelPrewarmer.shared.cancelPrewarming()  </span>
        }  
    }  
}  
</code></pre>
<p><strong>场景3: 用户点击输入框时预热</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChatInputView</span>: <span class="hljs-title class_">View</span> {  
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> inputText <span class="hljs-operator">=</span> <span class="hljs-string">""</span>  
    <span class="hljs-meta">@FocusState</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isInputFocused: <span class="hljs-type">Bool</span>  
      
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {  
        <span class="hljs-type">TextField</span>(<span class="hljs-string">"输入消息..."</span>, text: <span class="hljs-variable">$inputText</span>)  
            .focused(<span class="hljs-variable">$isInputFocused</span>)  
            .onChange(of: isInputFocused) { focused <span class="hljs-keyword">in</span>  
                <span class="hljs-keyword">if</span> focused {  
                    <span class="hljs-comment">// 用户点击输入框时，高优先级快速预热  </span>
                    <span class="hljs-type">SmartModelPrewarmer</span>.shared.prewarm(priority: .high)  
                }  
            }  
    }  
}  
</code></pre>
<h5 data-id="heading-58">预热效果对比</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    subgraph NoPrewarm [无预热]  
        Request1[用户请求] --&gt; Wait1[等待 3-6秒]  
        Wait1 --&gt; Response1[返回结果]  
    end  
      
    subgraph WithPrewarm [有预热]  
        Prewarm[提前预热 用户无感知] --&gt; Ready[模型就绪]  
        Request2[用户请求] --&gt; Wait2[等待 1-2秒]  
        Wait2 --&gt; Response2[返回结果]  
    end  
      
    style Request1 fill:#FF3B30,color:#fff  
    style Wait1 fill:#FF3B30,color:#fff  
    style Prewarm fill:#34C759,color:#fff  
    style Ready fill:#34C759,color:#fff  
    style Request2 fill:#007AFF,color:#fff  
    style Wait2 fill:#5AC8FA,color:#000  
    style Response2 fill:#34C759,color:#fff  
</code></pre>
<p><strong>性能提升数据</strong>（基于 Instruments 分析）:</p>





























<table><thead><tr><th>场景</th><th>无预热</th><th>有预热</th><th>提升</th></tr></thead><tbody><tr><td>首次调用延迟</td><td>3-6秒</td><td>1-2秒</td><td><strong>50-70%</strong></td></tr><tr><td>用户感知等待</td><td>明显</td><td>几乎无感知</td><td><strong>显著改善</strong></td></tr><tr><td>内存占用</td><td>按需加载</td><td>提前占用</td><td>增加约 200-500MB</td></tr></tbody></table>
<h5 data-id="heading-59">预热最佳实践</h5>
<p><strong>1. 预热时机选择</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((预热时机选择))  
    应用启动  
      低优先级  
      后台执行  
      不影响启动速度  
    进入功能页面  
      中优先级  
      立即执行  
      用户意图明确  
    点击输入框  
      高优先级  
      快速预热  
      最及时响应  
    避免过度预热  
      不要频繁预热  
      检查预热状态  
      避免资源浪费  
</code></pre>
<p><strong>2. 预热策略建议</strong></p>
<ul>
<li>✅ <strong>渐进式预热</strong>: 先做基础初始化，再逐步完善</li>
<li>✅ <strong>优先级管理</strong>: 根据用户行为调整预热优先级</li>
<li>✅ <strong>资源监控</strong>: 使用 Instruments 监控预热对内存和性能的影响</li>
<li>✅ <strong>降级处理</strong>: 如果预热失败，提供友好的降级方案</li>
</ul>
<p><strong>3. 预热检查清单</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否在合适的时机触发预热？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 预热是否影响应用启动速度？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否处理了预热失败的情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否在用户离开页面时取消不必要的预热？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用 Instruments 验证预热效果？</li>
</ul>
<p><strong>参考资源</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fzvayivqt0ufji%2Farticle%2Fdetails%2F149374995" target="_blank" title="https://blog.csdn.net/zvayivqt0ufji/article/details/149374995" ref="nofollow noopener noreferrer">CSDN - Foundation Models 预热优化</a></li>
</ul>
<h4 data-id="heading-60">缓存策略</h4>
<p>缓存策略是优化 Foundation Models 应用性能的重要手段。合理的缓存可以显著减少重复计算，提升响应速度，降低资源消耗。</p>
<h5 data-id="heading-61">缓存策略概述</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Request[用户请求] --&gt; CheckCache{检查缓存}  
    CheckCache --&gt;|命中| ReturnCache[返回缓存结果 快速响应]  
    CheckCache --&gt;|未命中| Generate[调用 Foundation Models 生成结果]  
    Generate --&gt; Store[存储到缓存]  
    Store --&gt; ReturnNew[返回新结果]  
      
    subgraph CacheManagement [缓存管理]  
        Store --&gt; Evict{缓存已满?}  
        Evict --&gt;|是| Strategy[执行淘汰策略 LRU/LFU/FIFO]  
        Evict --&gt;|否| Keep[保留缓存]  
        Strategy --&gt; Keep  
    end  
      
    style Request fill:#007AFF,color:#fff  
    style CheckCache fill:#FF9500,color:#fff  
    style ReturnCache fill:#34C759,color:#fff  
    style Generate fill:#5AC8FA,color:#000  
    style Store fill:#AF52DE,color:#fff  
    style Strategy fill:#FF3B30,color:#fff  
</code></pre>
<p><strong>缓存的核心价值</strong>:</p>
<ul>
<li>✅ <strong>减少重复计算</strong>: 相同输入直接返回缓存结果</li>
<li>✅ <strong>提升响应速度</strong>: 缓存命中时几乎零延迟</li>
<li>✅ <strong>降低资源消耗</strong>: 减少模型调用次数，节省计算资源</li>
<li>✅ <strong>改善用户体验</strong>: 快速响应，特别是重复查看相同内容时</li>
</ul>
<h5 data-id="heading-62">缓存键设计</h5>
<p>缓存键的设计直接影响缓存命中率和有效性。</p>
<p><strong>好的缓存键应该包含</strong>:</p>
<ul>
<li>输入数据的唯一标识（如照片ID）</li>
<li>可能影响结果的数据版本（如修改时间）</li>
<li>生成参数（如不同的Instructions可能产生不同结果）</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheKeyBuilder</span> {  
    <span class="hljs-comment">/// 为照片分析生成缓存键  </span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">keyForPhotoAnalysis</span>(  
        <span class="hljs-params">photoId</span>: <span class="hljs-type">String</span>,  
        <span class="hljs-params">modificationDate</span>: <span class="hljs-type">Date</span>,  
        <span class="hljs-params">instructionsHash</span>: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>  
    ) -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-keyword">var</span> components <span class="hljs-operator">=</span> [photoId, <span class="hljs-type">String</span>(modificationDate.timeIntervalSince1970)]  
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> hash <span class="hljs-operator">=</span> instructionsHash {  
            components.append(hash)  
        }  
        <span class="hljs-keyword">return</span> components.joined(separator: <span class="hljs-string">"|"</span>)  
    }  
      
    <span class="hljs-comment">/// 为自然语言搜索生成缓存键  </span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">keyForSearch</span>(  
        <span class="hljs-params">query</span>: <span class="hljs-type">String</span>,  
        <span class="hljs-params">photoCount</span>: <span class="hljs-type">Int</span>  
    ) -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-comment">// 使用查询内容和照片数量作为键  </span>
        <span class="hljs-comment">// 注意：如果相册内容变化，需要使缓存失效  </span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"search:<span class="hljs-subst">\(query.hashValue)</span>:<span class="hljs-subst">\(photoCount)</span>"</span>  
    }  
}  
</code></pre>
<h5 data-id="heading-63">内存缓存实现</h5>
<p><strong>基础内存缓存</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryCache</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">Codable</span>&gt; {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cache: [<span class="hljs-type">String</span>: <span class="hljs-type">CacheEntry</span>&lt;<span class="hljs-type">T</span>&gt;] <span class="hljs-operator">=</span> [:]  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxSize: <span class="hljs-type">Int</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> accessQueue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"com.app.cache"</span>, attributes: .concurrent)  
      
    <span class="hljs-keyword">init</span>(<span class="hljs-params">maxSize</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>) {  
        <span class="hljs-keyword">self</span>.maxSize <span class="hljs-operator">=</span> maxSize  
    }  
      
    <span class="hljs-comment">/// 获取缓存  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">T</span>? {  
        <span class="hljs-keyword">return</span> accessQueue.sync {  
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> cache[key] <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }  
              
            <span class="hljs-comment">// 更新访问时间（用于LRU）  </span>
            entry.lastAccessed <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()  
            <span class="hljs-keyword">return</span> entry.value  
        }  
    }  
      
    <span class="hljs-comment">/// 设置缓存  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {  
        accessQueue.async(flags: .barrier) {  
            <span class="hljs-comment">// 如果缓存已满，执行淘汰策略  </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.cache.count <span class="hljs-operator">&gt;=</span> <span class="hljs-keyword">self</span>.maxSize <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-keyword">self</span>.cache[key] <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span> {  
                <span class="hljs-keyword">self</span>.evictOldest()  
            }  
              
            <span class="hljs-keyword">self</span>.cache[key] <span class="hljs-operator">=</span> <span class="hljs-type">CacheEntry</span>(value: value, lastAccessed: <span class="hljs-type">Date</span>())  
        }  
    }  
      
    <span class="hljs-comment">/// LRU淘汰：移除最久未访问的条目  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">evictOldest</span>() {  
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> oldest <span class="hljs-operator">=</span> cache.min(by: { <span class="hljs-variable">$0</span>.value.lastAccessed <span class="hljs-operator">&lt;</span> <span class="hljs-variable">$1</span>.value.lastAccessed }) <span class="hljs-keyword">else</span> {  
            <span class="hljs-keyword">return</span>  
        }  
        cache.removeValue(forKey: oldest.key)  
    }  
      
    <span class="hljs-comment">/// 清除所有缓存  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">clear</span>() {  
        accessQueue.async(flags: .barrier) {  
            <span class="hljs-keyword">self</span>.cache.removeAll()  
        }  
    }  
      
    <span class="hljs-comment">/// 获取缓存统计  </span>
    <span class="hljs-keyword">var</span> stats: <span class="hljs-type">CacheStats</span> {  
        <span class="hljs-keyword">return</span> accessQueue.sync {  
            <span class="hljs-type">CacheStats</span>(  
                size: cache.count,  
                maxSize: maxSize,  
                hitRate: <span class="hljs-number">0</span> <span class="hljs-comment">// 需要额外实现命中率统计  </span>
            )  
        }  
    }  
}

<span class="hljs-comment">/// 缓存条目  </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;<span class="hljs-title class_">T</span>&gt; {  
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">T</span>  
    <span class="hljs-keyword">var</span> lastAccessed: <span class="hljs-type">Date</span>  
    <span class="hljs-keyword">var</span> accessCount: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>  
      
    <span class="hljs-keyword">init</span>(<span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">lastAccessed</span>: <span class="hljs-type">Date</span>) {  
        <span class="hljs-keyword">self</span>.value <span class="hljs-operator">=</span> value  
        <span class="hljs-keyword">self</span>.lastAccessed <span class="hljs-operator">=</span> lastAccessed  
    }  
}

<span class="hljs-comment">/// 缓存统计  </span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CacheStats</span> {  
    <span class="hljs-keyword">let</span> size: <span class="hljs-type">Int</span>  
    <span class="hljs-keyword">let</span> maxSize: <span class="hljs-type">Int</span>  
    <span class="hljs-keyword">let</span> hitRate: <span class="hljs-type">Double</span>  
}  
</code></pre>
<p><strong>使用内存缓存的完整示例</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedPhotoAnalysisService</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">MemoryCache</span>&lt;<span class="hljs-type">PhotoDescription</span>&gt;(maxSize: <span class="hljs-number">100</span>)  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> sessionManager <span class="hljs-operator">=</span> <span class="hljs-type">PhotoAISessionManager</span>()  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhoto</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
        <span class="hljs-comment">// 生成缓存键  </span>
        <span class="hljs-keyword">let</span> cacheKey <span class="hljs-operator">=</span> <span class="hljs-type">CacheKeyBuilder</span>.keyForPhotoAnalysis(  
            photoId: photo.id,  
            modificationDate: photo.modificationDate  
        )  
          
        <span class="hljs-comment">// 检查缓存  </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cached <span class="hljs-operator">=</span> cache.get(for: cacheKey) {  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 缓存命中: <span class="hljs-subst">\(cacheKey)</span>"</span>)  
            <span class="hljs-keyword">return</span> cached  
        }  
          
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 缓存未命中，生成新结果: <span class="hljs-subst">\(cacheKey)</span>"</span>)  
          
        <span class="hljs-comment">// 生成新结果  </span>
        <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> generateAnalysisPrompt(for: photo)  
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> sessionManager.generateStructured(  
            prompt: prompt,  
            type: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
        )  
          
        <span class="hljs-comment">// 存储到缓存  </span>
        cache.set(result, for: cacheKey)  
          
        <span class="hljs-keyword">return</span> result  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">generateAnalysisPrompt</span>(<span class="hljs-params">for</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-comment">// 生成分析提示词  </span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"分析照片..."</span>  
    }  
}  
</code></pre>
<h5 data-id="heading-64">持久化缓存实现</h5>
<p>对于需要跨应用启动保持的缓存，可以使用文件系统持久化：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PersistentCache</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">Codable</span>&gt; {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> memoryCache <span class="hljs-operator">=</span> <span class="hljs-type">MemoryCache</span>&lt;<span class="hljs-type">T</span>&gt;(maxSize: <span class="hljs-number">50</span>)  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cacheDirectory: <span class="hljs-type">URL</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> fileManager <span class="hljs-operator">=</span> <span class="hljs-type">FileManager</span>.default  
      
    <span class="hljs-keyword">init</span>(<span class="hljs-params">cacheName</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">throws</span> {  
        <span class="hljs-keyword">let</span> cacheDir <span class="hljs-operator">=</span> fileManager.urls(for: .cachesDirectory, in: .userDomainMask)[<span class="hljs-number">0</span>]  
        cacheDirectory <span class="hljs-operator">=</span> cacheDir.appendingPathComponent(cacheName)  
          
        <span class="hljs-comment">// 创建缓存目录  </span>
        <span class="hljs-keyword">try</span> fileManager.createDirectory(at: cacheDirectory, withIntermediateDirectories: <span class="hljs-literal">true</span>)  
    }  
      
    <span class="hljs-comment">/// 获取缓存（先查内存，再查磁盘）  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">T</span>? {  
        <span class="hljs-comment">// 先查内存缓存  </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> memoryValue <span class="hljs-operator">=</span> memoryCache.get(for: key) {  
            <span class="hljs-keyword">return</span> memoryValue  
        }  
          
        <span class="hljs-comment">// 再查磁盘缓存  </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> diskValue <span class="hljs-operator">=</span> loadFromDisk(key: key) {  
            <span class="hljs-comment">// 加载到内存缓存  </span>
            memoryCache.set(diskValue, for: key)  
            <span class="hljs-keyword">return</span> diskValue  
        }  
          
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>  
    }  
      
    <span class="hljs-comment">/// 设置缓存（同时写入内存和磁盘）  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {  
        <span class="hljs-comment">// 写入内存缓存  </span>
        memoryCache.set(value, for: key)  
          
        <span class="hljs-comment">// 异步写入磁盘  </span>
        <span class="hljs-type">Task</span>.detached(priority: .utility) {  
            <span class="hljs-keyword">self</span>.saveToDisk(value: value, key: key)  
        }  
    }  
      
    <span class="hljs-comment">/// 从磁盘加载  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadFromDisk</span>(<span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">T</span>? {  
        <span class="hljs-keyword">let</span> fileURL <span class="hljs-operator">=</span> cacheDirectory.appendingPathComponent(<span class="hljs-string">"<span class="hljs-subst">\(key.hashValue)</span>.json"</span>)  
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">Data</span>(contentsOf: fileURL),  
              <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">T</span>.<span class="hljs-keyword">self</span>, from: data) <span class="hljs-keyword">else</span> {  
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>  
        }  
        <span class="hljs-keyword">return</span> value  
    }  
      
    <span class="hljs-comment">/// 保存到磁盘  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">saveToDisk</span>(<span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {  
        <span class="hljs-keyword">let</span> fileURL <span class="hljs-operator">=</span> cacheDirectory.appendingPathComponent(<span class="hljs-string">"<span class="hljs-subst">\(key.hashValue)</span>.json"</span>)  
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONEncoder</span>().encode(value) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }  
        <span class="hljs-keyword">try?</span> data.write(to: fileURL)  
    }  
      
    <span class="hljs-comment">/// 清理过期缓存  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cleanExpired</span>(<span class="hljs-params">maxAge</span>: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> <span class="hljs-operator">*</span> <span class="hljs-number">24</span> <span class="hljs-operator">*</span> <span class="hljs-number">3600</span>) {  
        <span class="hljs-comment">// 清理超过7天的缓存文件  </span>
        <span class="hljs-comment">// 实现细节...  </span>
    }  
}  
</code></pre>
<h5 data-id="heading-65">缓存失效策略</h5>
<p>缓存失效是缓存策略的重要组成部分，需要根据业务场景选择合适的策略：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Cache[缓存条目] --&gt; Check1{基于时间失效?}  
    Check1 --&gt;|是| TimeBased[时间过期策略 如：7天后失效]  
    Check1 --&gt;|否| Check2{基于数据变化失效?}  
      
    Check2 --&gt;|是| DataBased[数据变化策略 如：照片修改后失效]  
    Check2 --&gt;|否| Check3{基于版本失效?}  
      
    Check3 --&gt;|是| VersionBased[版本策略 如：Instructions变化后失效]  
    Check3 --&gt;|否| Manual[手动失效 用户主动清除]  
      
    TimeBased --&gt; Invalidate[使缓存失效]  
    DataBased --&gt; Invalidate  
    VersionBased --&gt; Invalidate  
    Manual --&gt; Invalidate  
      
    style Cache fill:#007AFF,color:#fff  
    style Check1 fill:#FF9500,color:#fff  
    style Check2 fill:#FF9500,color:#fff  
    style Check3 fill:#FF9500,color:#fff  
    style TimeBased fill:#34C759,color:#fff  
    style DataBased fill:#34C759,color:#fff  
    style VersionBased fill:#34C759,color:#fff  
    style Manual fill:#5AC8FA,color:#000  
    style Invalidate fill:#FF3B30,color:#fff  
</code></pre>
<p><strong>实现带失效策略的缓存</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntryWithExpiry</span>&lt;<span class="hljs-title class_">T</span>&gt; {  
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">T</span>  
    <span class="hljs-keyword">let</span> createdAt: <span class="hljs-type">Date</span>  
    <span class="hljs-keyword">let</span> expiresAt: <span class="hljs-type">Date</span>?  
      
    <span class="hljs-keyword">init</span>(<span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">ttl</span>: <span class="hljs-type">TimeInterval</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>) {  
        <span class="hljs-keyword">self</span>.value <span class="hljs-operator">=</span> value  
        <span class="hljs-keyword">self</span>.createdAt <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()  
        <span class="hljs-keyword">self</span>.expiresAt <span class="hljs-operator">=</span> ttl.map { <span class="hljs-type">Date</span>().addingTimeInterval(<span class="hljs-variable">$0</span>) }  
    }  
      
    <span class="hljs-keyword">var</span> isExpired: <span class="hljs-type">Bool</span> {  
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> expiresAt <span class="hljs-operator">=</span> expiresAt <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> }  
        <span class="hljs-keyword">return</span> <span class="hljs-type">Date</span>() <span class="hljs-operator">&gt;</span> expiresAt  
    }  
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpiringCache</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">Codable</span>&gt; {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cache: [<span class="hljs-type">String</span>: <span class="hljs-type">CacheEntryWithExpiry</span>&lt;<span class="hljs-type">T</span>&gt;] <span class="hljs-operator">=</span> [:]  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxSize: <span class="hljs-type">Int</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> defaultTTL: <span class="hljs-type">TimeInterval</span>?  
      
    <span class="hljs-keyword">init</span>(<span class="hljs-params">maxSize</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>, <span class="hljs-params">defaultTTL</span>: <span class="hljs-type">TimeInterval</span>? <span class="hljs-operator">=</span> <span class="hljs-number">7</span> <span class="hljs-operator">*</span> <span class="hljs-number">24</span> <span class="hljs-operator">*</span> <span class="hljs-number">3600</span>) {  
        <span class="hljs-keyword">self</span>.maxSize <span class="hljs-operator">=</span> maxSize  
        <span class="hljs-keyword">self</span>.defaultTTL <span class="hljs-operator">=</span> defaultTTL  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">T</span>? {  
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> cache[key] <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }  
          
        <span class="hljs-comment">// 检查是否过期  </span>
        <span class="hljs-keyword">if</span> entry.isExpired {  
            cache.removeValue(forKey: key)  
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>  
        }  
          
        <span class="hljs-keyword">return</span> entry.value  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>, <span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>, <span class="hljs-params">ttl</span>: <span class="hljs-type">TimeInterval</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>) {  
        <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> <span class="hljs-type">CacheEntryWithExpiry</span>(value: value, ttl: ttl <span class="hljs-operator">??</span> defaultTTL)  
          
        <span class="hljs-comment">// 如果缓存已满，移除过期或最旧的条目  </span>
        <span class="hljs-keyword">if</span> cache.count <span class="hljs-operator">&gt;=</span> maxSize <span class="hljs-operator">&amp;&amp;</span> cache[key] <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span> {  
            evictExpiredOrOldest()  
        }  
          
        cache[key] <span class="hljs-operator">=</span> entry  
    }  
      
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">evictExpiredOrOldest</span>() {  
        <span class="hljs-comment">// 先移除过期的  </span>
        <span class="hljs-keyword">let</span> expiredKeys <span class="hljs-operator">=</span> cache.filter { <span class="hljs-variable">$0</span>.value.isExpired }.map { <span class="hljs-variable">$0</span>.key }  
        expiredKeys.forEach { cache.removeValue(forKey: <span class="hljs-variable">$0</span>) }  
          
        <span class="hljs-comment">// 如果还有空间，不需要继续  </span>
        <span class="hljs-keyword">if</span> cache.count <span class="hljs-operator">&lt;</span> maxSize { <span class="hljs-keyword">return</span> }  
          
        <span class="hljs-comment">// 移除最旧的  </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> oldest <span class="hljs-operator">=</span> cache.min(by: { <span class="hljs-variable">$0</span>.value.createdAt <span class="hljs-operator">&lt;</span> <span class="hljs-variable">$1</span>.value.createdAt }) {  
            cache.removeValue(forKey: oldest.key)  
        }  
    }  
      
    <span class="hljs-comment">/// 手动使缓存失效  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">invalidate</span>(<span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {  
        cache.removeValue(forKey: key)  
    }  
      
    <span class="hljs-comment">/// 使所有缓存失效  </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">invalidateAll</span>() {  
        cache.removeAll()  
    }  
}  
</code></pre>
<h5 data-id="heading-66">缓存策略选择指南</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((缓存策略选择))  
    内存缓存  
      快速访问  
      适合频繁访问  
      容量有限  
      应用重启后丢失  
    持久化缓存  
      跨启动保持  
      适合重要结果  
      需要磁盘空间  
      需要管理文件  
    缓存失效  
      时间过期  
      数据变化触发  
      版本控制  
      手动清除  
    缓存淘汰  
      LRU 最近最少使用  
      LFU 最不常用  
      FIFO 先进先出  
      根据场景选择  
</code></pre>
<p><strong>不同场景的缓存策略建议</strong>:</p>








































<table><thead><tr><th>场景</th><th>缓存类型</th><th>失效策略</th><th>淘汰策略</th><th>容量建议</th></tr></thead><tbody><tr><td>照片分析结果</td><td>内存+持久化</td><td>照片修改时失效</td><td>LRU</td><td>100-200条</td></tr><tr><td>搜索查询结果</td><td>仅内存</td><td>相册内容变化时失效</td><td>LRU</td><td>50-100条</td></tr><tr><td>相册分类建议</td><td>仅内存</td><td>照片数量变化时失效</td><td>FIFO</td><td>20-50条</td></tr><tr><td>视频摘要</td><td>持久化</td><td>7天过期</td><td>LRU</td><td>50-100条</td></tr></tbody></table>
<h5 data-id="heading-67">缓存最佳实践</h5>
<p><strong>1. 缓存键设计原则</strong></p>
<ul>
<li>✅ 包含所有影响结果的因素</li>
<li>✅ 使用稳定的标识符（如照片ID + 修改时间）</li>
<li>✅ 避免包含易变数据（如当前时间戳）</li>
<li>✅ 考虑哈希冲突，使用足够长的键</li>
</ul>
<p><strong>2. 缓存容量管理</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheManager</span> {  
    <span class="hljs-comment">/// 根据设备内存动态调整缓存大小  </span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">optimalCacheSize</span>() -&gt; <span class="hljs-type">Int</span> {  
        <span class="hljs-keyword">let</span> totalMemory <span class="hljs-operator">=</span> <span class="hljs-type">ProcessInfo</span>.processInfo.physicalMemory  
        <span class="hljs-keyword">let</span> availableMemory <span class="hljs-operator">=</span> totalMemory <span class="hljs-operator">/</span> <span class="hljs-number">4</span> <span class="hljs-comment">// 使用1/4可用内存  </span>
          
        <span class="hljs-comment">// 假设每个缓存条目平均占用 10KB  </span>
        <span class="hljs-keyword">let</span> entrySize <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span>  
        <span class="hljs-keyword">let</span> maxEntries <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(availableMemory) <span class="hljs-operator">/</span> entrySize  
          
        <span class="hljs-comment">// 限制在合理范围内  </span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(maxEntries, <span class="hljs-number">500</span>)  
    }  
}  
</code></pre>
<p><strong>3. 缓存性能监控</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheMetrics</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> hits: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> misses: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">recordHit</span>() { hits <span class="hljs-operator">+=</span> <span class="hljs-number">1</span> }  
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">recordMiss</span>() { misses <span class="hljs-operator">+=</span> <span class="hljs-number">1</span> }  
      
    <span class="hljs-keyword">var</span> hitRate: <span class="hljs-type">Double</span> {  
        <span class="hljs-keyword">let</span> total <span class="hljs-operator">=</span> hits <span class="hljs-operator">+</span> misses  
        <span class="hljs-keyword">guard</span> total <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> }  
        <span class="hljs-keyword">return</span> <span class="hljs-type">Double</span>(hits) <span class="hljs-operator">/</span> <span class="hljs-type">Double</span>(total)  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">reset</span>() {  
        hits <span class="hljs-operator">=</span> <span class="hljs-number">0</span>  
        misses <span class="hljs-operator">=</span> <span class="hljs-number">0</span>  
    }  
}

<span class="hljs-comment">// 在缓存服务中使用  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedPhotoAnalysisService</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> metrics <span class="hljs-operator">=</span> <span class="hljs-type">CacheMetrics</span>()  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhoto</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
        <span class="hljs-keyword">let</span> cacheKey <span class="hljs-operator">=</span> <span class="hljs-type">CacheKeyBuilder</span>.keyForPhotoAnalysis(<span class="hljs-operator">...</span>)  
          
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cached <span class="hljs-operator">=</span> cache.get(for: cacheKey) {  
            metrics.recordHit()  
            <span class="hljs-keyword">return</span> cached  
        }  
          
        metrics.recordMiss()  
        <span class="hljs-comment">// ... 生成新结果  </span>
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getCacheStats</span>() -&gt; (hitRate: <span class="hljs-type">Double</span>, size: <span class="hljs-type">Int</span>) {  
        <span class="hljs-keyword">return</span> (metrics.hitRate, cache.stats.size)  
    }  
}  
</code></pre>
<p><strong>4. 缓存检查清单</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 缓存键是否包含所有影响结果的因素？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否实现了合适的失效策略？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 缓存容量是否合理（不会导致内存压力）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否监控了缓存命中率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否处理了缓存失败的情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否需要持久化缓存（跨启动保持）？</li>
</ul>
<p><strong>参考资源</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fonevcat.com%2F2025%2F06%2Ffoundation-models%2F" target="_blank" title="https://onevcat.com/2025/06/foundation-models/" ref="nofollow noopener noreferrer">OneV's Den - Foundation Models 内存分析</a></li>
</ul>
<h4 data-id="heading-68">使用 Instruments 进行性能分析</h4>
<p><strong>Instruments</strong> 是 Apple 提供的性能分析工具，最新版本已添加 <strong>Foundation Models 模块</strong>，可以在 iPhone 设备上直接进行性能分析，帮助开发者优化应用性能。</p>
<h5 data-id="heading-69">Instruments Foundation Models 模块功能</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Start([启动 Instruments]) --&gt; Select[选择 Foundation Models 模板]  
    Select --&gt; Connect[连接 iPhone 设备]  
    Connect --&gt; Launch[启动应用]  
    Launch --&gt; Record[开始录制性能数据]  
    Record --&gt; Analyze[分析性能指标]  
      
    Analyze --&gt; LoadTime[模型加载时间分析]  
    Analyze --&gt; InferenceTime[推理时间分析]  
    Analyze --&gt; TokenCount[输入令牌数量分析]  
    Analyze --&gt; Memory[内存使用分析]  
      
    LoadTime --&gt; Optimize1[优化加载策略]  
    InferenceTime --&gt; Optimize2[优化 Prompt 设计]  
    TokenCount --&gt; Optimize3[优化输入长度]  
    Memory --&gt; Optimize4[优化内存管理]  
      
    style Start fill:#007AFF,color:#fff  
    style Select fill:#5AC8FA,color:#000  
    style Connect fill:#5AC8FA,color:#000  
    style Record fill:#FF9500,color:#fff  
    style Analyze fill:#FF9500,color:#fff  
    style LoadTime fill:#34C759,color:#fff  
    style InferenceTime fill:#34C759,color:#fff  
    style TokenCount fill:#34C759,color:#fff  
    style Memory fill:#34C759,color:#fff  
</code></pre>
<p><strong>核心分析指标</strong>:</p>
<ol>
<li>
<p><strong>模型加载时间（Model Load Time）</strong><br/>
- 测量模型从存储加载到内存并准备就绪的时间<br/>
- 帮助识别首次调用延迟问题<br/>
- 优化建议：预热模型、优化存储位置</p>
</li>
<li>
<p><strong>推理时间（Inference Time）</strong><br/>
- 测量模型接收输入并生成输出所需的时间<br/>
- 识别性能瓶颈和优化点<br/>
- 优化建议：精简 Prompt、优化 Instructions</p>
</li>
<li>
<p><strong>输入令牌数量（Input Token Count）</strong><br/>
- 统计每次请求的输入令牌总数<br/>
- 帮助优化输入长度，减少成本<br/>
- 优化建议：精简上下文、使用摘要</p>
</li>
<li>
<p><strong>内存使用（Memory Usage）</strong><br/>
- 监控模型运行时的内存占用<br/>
- 识别内存泄漏和峰值使用<br/>
- 优化建议：及时释放 Session、管理上下文窗口</p>
</li>
</ol>
<h5 data-id="heading-70">使用步骤</h5>
<p><strong>步骤1: 打开 Instruments</strong></p>
<ol>
<li>在 Xcode 中，选择 <strong>Product → Profile</strong>（或按 <code>⌘I</code>）</li>
<li>选择 <strong>Foundation Models</strong> 模板</li>
<li>选择目标设备（必须是支持 Apple Intelligence 的真实设备）</li>
</ol>
<p><strong>步骤2: 配置分析选项</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR  
    Config[配置分析选项] --&gt; Option1[模型加载时间追踪]  
    Config --&gt; Option2[推理时间追踪]  
    Config --&gt; Option3[令牌计数追踪]  
    Config --&gt; Option4[内存使用追踪]  
      
    Option1 --&gt; Start[开始录制]  
    Option2 --&gt; Start  
    Option3 --&gt; Start  
    Option4 --&gt; Start  
      
    style Config fill:#007AFF,color:#fff  
    style Option1 fill:#5AC8FA,color:#000  
    style Option2 fill:#5AC8FA,color:#000  
    style Option3 fill:#5AC8FA,color:#000  
    style Option4 fill:#5AC8FA,color:#000  
    style Start fill:#34C759,color:#fff  
</code></pre>
<p><strong>步骤3: 执行操作并分析</strong></p>
<p>在应用中使用 Foundation Models 功能，Instruments 会自动记录：</p>
<ul>
<li>每次 <code>LanguageModelSession.respond()</code> 调用的时间线</li>
<li>模型加载事件和耗时</li>
<li>输入令牌数量统计</li>
<li>内存分配和释放情况</li>
</ul>
<p><strong>步骤4: 查看分析结果</strong></p>
<p>Instruments 会显示以下视图：</p>
<ul>
<li><strong>时间线视图</strong>: 显示模型加载和推理的时间分布</li>
<li><strong>统计视图</strong>: 显示平均/最大/最小推理时间</li>
<li><strong>令牌统计</strong>: 显示输入令牌数量分布</li>
<li><strong>内存视图</strong>: 显示内存使用趋势</li>
</ul>
<h5 data-id="heading-71">性能优化实践示例</h5>
<p><strong>场景1: 优化首次调用延迟</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在 Instruments 中观察模型加载时间  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoAnalysisService</span> {  
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhoto</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
        <span class="hljs-comment">// Instruments 会记录这里的模型加载时间  </span>
        <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
          
        <span class="hljs-comment">// 如果加载时间过长，考虑预热  </span>
        <span class="hljs-comment">// 在应用启动时提前加载模型  </span>
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
            to: <span class="hljs-type">Prompt</span>(<span class="hljs-string">"分析照片"</span>),  
            generating: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
        )  
        <span class="hljs-keyword">return</span> response.content  
    }  
}  
</code></pre>
<p><strong>优化建议</strong>:</p>
<ul>
<li>如果 Instruments 显示首次调用延迟 &gt; 2秒，考虑在应用启动时预热模型</li>
<li>使用 <code>ModelPrewarmer</code> 在后台预热，避免用户首次使用时等待</li>
</ul>
<p><strong>场景2: 优化 Prompt 长度</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在 Instruments 中观察输入令牌数量  </span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhotoWithMetadata</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
      
    <span class="hljs-comment">// ❌ 不好的做法：包含过多元数据，令牌数量过多  </span>
    <span class="hljs-keyword">let</span> longPrompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
        分析照片：  
        - 拍摄时间: <span class="hljs-subst">\(photo.date)</span>  
        - 拍摄地点: <span class="hljs-subst">\(photo.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
        - EXIF信息: <span class="hljs-subst">\(photo.exifInfo)</span>  
        - 文件大小: <span class="hljs-subst">\(photo.fileSize)</span>MB  
        - 分辨率: <span class="hljs-subst">\(photo.resolution)</span>  
        - 相机型号: <span class="hljs-subst">\(photo.cameraModel)</span>  
        - ISO: <span class="hljs-subst">\(photo.iso)</span>  
        - 光圈: <span class="hljs-subst">\(photo.aperture)</span>  
        - 快门速度: <span class="hljs-subst">\(photo.shutterSpeed)</span>  
        ... 更多元数据  
    """</span>  
      
    <span class="hljs-comment">// ✅ 好的做法：只包含关键信息，减少令牌数量  </span>
    <span class="hljs-keyword">let</span> optimizedPrompt <span class="hljs-operator">=</span> <span class="hljs-string">"""  
        分析照片：  
        - 时间: <span class="hljs-subst">\(photo.date)</span>  
        - 地点: <span class="hljs-subst">\(photo.location <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>)</span>  
        - 关键信息: <span class="hljs-subst">\(photo.keyMetadata)</span>  
    """</span>  
      
    <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
        to: <span class="hljs-type">Prompt</span>(optimizedPrompt),  
        generating: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
    )  
    <span class="hljs-keyword">return</span> response.content  
}  
</code></pre>
<p><strong>优化建议</strong>:</p>
<ul>
<li>使用 Instruments 监控输入令牌数量</li>
<li>如果平均令牌数量 &gt; 1000，考虑精简 Prompt</li>
<li>移除不必要的元数据，只保留关键信息</li>
</ul>
<p><strong>场景3: 识别性能瓶颈</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD  
    Profile[使用 Instruments 分析] --&gt; Check1{模型加载时间&lt;br/&gt;是否过长?}  
    Check1 --&gt;|是| Action1[预热模型&lt;br/&gt;优化加载策略]  
    Check1 --&gt;|否| Check2{推理时间&lt;br/&gt;是否过长?}  
      
    Check2 --&gt;|是| Action2[精简 Prompt&lt;br/&gt;优化 Instructions]  
    Check2 --&gt;|否| Check3{令牌数量&lt;br/&gt;是否过多?}  
      
    Check3 --&gt;|是| Action3[减少上下文&lt;br/&gt;使用摘要]  
    Check3 --&gt;|否| Check4{内存使用&lt;br/&gt;是否异常?}  
      
    Check4 --&gt;|是| Action4[管理上下文窗口&lt;br/&gt;及时释放 Session]  
    Check4 --&gt;|否| Success[性能优化完成]  
      
    Action1 --&gt; Success  
    Action2 --&gt; Success  
    Action3 --&gt; Success  
    Action4 --&gt; Success  
      
    style Profile fill:#007AFF,color:#fff  
    style Check1 fill:#FF9500,color:#fff  
    style Check2 fill:#FF9500,color:#fff  
    style Check3 fill:#FF9500,color:#fff  
    style Check4 fill:#FF9500,color:#fff  
    style Action1 fill:#34C759,color:#fff  
    style Action2 fill:#34C759,color:#fff  
    style Action3 fill:#34C759,color:#fff  
    style Action4 fill:#34C759,color:#fff  
    style Success fill:#007AFF,color:#fff  
</code></pre>
<h5 data-id="heading-72">Instruments 分析最佳实践</h5>
<p><strong>1. 建立性能基准</strong></p>
<p>在优化前，先建立性能基准：</p>
<ul>
<li>记录首次调用延迟</li>
<li>记录平均推理时间</li>
<li>记录典型场景的令牌数量</li>
<li>记录峰值内存使用</li>
</ul>
<p><strong>2. 对比优化效果</strong></p>
<p>每次优化后，使用 Instruments 对比：</p>
<ul>
<li>优化前后的时间对比</li>
<li>令牌数量变化</li>
<li>内存使用改善</li>
</ul>
<p><strong>3. 关注关键路径</strong></p>
<p>重点关注用户感知明显的路径：</p>
<ul>
<li>首次调用延迟（影响第一印象）</li>
<li>常见操作的推理时间（影响日常体验）</li>
<li>峰值内存使用（影响稳定性）</li>
</ul>
<p><strong>4. 真实设备测试</strong></p>
<p>⚠️ <strong>重要</strong>: Foundation Models 在模拟器上不可用，必须在真实设备上使用 Instruments 分析。</p>
<p><strong>参考资源</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fxcode%2Finstruments" target="_blank" title="https://developer.apple.com/documentation/xcode/instruments" ref="nofollow noopener noreferrer">Apple Developer - Instruments</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fzvayivqt0ufji%2Farticle%2Fdetails%2F149374995" target="_blank" title="https://blog.csdn.net/zvayivqt0ufji/article/details/149374995" ref="nofollow noopener noreferrer">CSDN - Foundation Models 性能分析</a></li>
</ul>
<h3 data-id="heading-73">4.3 Foundation Models 的边界和限制</h3>
<p>了解 Foundation Models 的边界和限制，对于在实际项目中使用至关重要。本节基于实际测试数据，帮助你理解框架的能力边界。</p>
<h4 data-id="heading-74">核心限制汇总</h4>



































<table><thead><tr><th>类别</th><th>限制/特征</th><th>详细说明</th></tr></thead><tbody><tr><td><strong>上下文窗口</strong></td><td>4096 tokens</td><td>• 实际限制：4096 tokens（不是训练时的 65K）<br/>• 约支持 10-20 轮对话<br/>• 需要设计上下文管理策略</td></tr><tr><td><strong>内存消耗</strong></td><td>1.0-1.5GB</td><td>• 模型权重：~750MB（3B 参数 × 2-bit 量化）<br/>• KV Cache：~300-600MB（8-bit 量化，37.5% 减少优化）<br/>• 框架开销：~100-200MB</td></tr><tr><td><strong>并发性能</strong></td><td>单 session 正常</td><td>• 单 session：iPhone 10-30 tokens/s，M2 Pro ~30 tokens/s<br/>• 多 session：每个 session 降至约 1 token/s<br/>• <strong>建议</strong>：使用队列串行访问，避免并发 session</td></tr><tr><td><strong>结构化生成</strong></td><td>Schema 开销</td><td>• 每个 <code>@Generable</code> 属性约增加 30 tokens<br/>• 设计复杂数据结构时需要考虑开销<br/>• 影响上下文窗口使用</td></tr><tr><td><strong>适用场景</strong></td><td>文本处理为主</td><td><strong>✅ 适合</strong>：文本摘要、内容分类、结构化提取、自然语言理解<br/><strong>❌ 不适合</strong>：数学计算、代码生成、复杂推理、最新信息（训练数据截止 2023年10月）</td></tr></tbody></table>
<h4 data-id="heading-75">适用场景与不适用场景</h4>
<p><strong>✅ 适合的场景</strong>:</p>
<p>根据实际测试，Foundation Models 在以下场景表现不错：</p>
<ul>
<li><strong>文本摘要</strong>: 生成内容摘要、提取关键信息</li>
<li><strong>内容分类</strong>: 对文本、照片等内容进行分类</li>
<li><strong>结构化数据提取</strong>: 从非结构化文本中提取结构化信息</li>
<li><strong>自然语言理解</strong>: 理解用户意图、解析查询</li>
</ul>
<p><strong>❌ 不适合的场景</strong>:</p>
<ul>
<li><strong>数学计算</strong>: 模型不适合进行精确的数学计算</li>
<li><strong>代码生成</strong>: 代码生成能力有限</li>
<li><strong>复杂推理</strong>: 复杂逻辑推理能力有限</li>
<li><strong>最新信息</strong>: 训练数据截止到 2023 年 10 月，世界知识有限</li>
</ul>
<h4 data-id="heading-76">温度参数敏感性</h4>
<p><strong>测试发现</strong>: 温度参数在 0.0-2.0 范围内表现稳定，意外地不敏感。这意味着你可以在这个范围内调整温度，而不会对输出质量产生显著影响。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 温度参数设置示例  </span>
<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>(  
    <span class="hljs-comment">// 温度范围 0.0-2.0 表现稳定  </span>
    <span class="hljs-comment">// 可以根据需要调整，但影响不会很大  </span>
)  
</code></pre>
<h4 data-id="heading-77">安全防护机制</h4>
<p>Foundation Models 内置了相当严格的安全防护机制：</p>
<ul>
<li><strong>内容过滤</strong>: 会删除违规的 transcript 条目</li>
<li><strong>自动清理</strong>: 检测到不当内容时会自动清理对话历史</li>
<li><strong>Guardrail</strong>: 内置安全护栏，防止生成不当内容</li>
</ul>
<p><strong>开发建议</strong>:</p>
<ul>
<li>在设计应用时，要考虑安全机制可能删除部分对话内容</li>
<li>对于敏感场景，需要额外的输入验证和输出检查</li>
<li>不要依赖模型完全阻止不当内容，应用层也需要做防护</li>
</ul>
<h4 data-id="heading-78">Apple Foundation Models 开发流程</h4>
<p>Apple Foundation Models 的开发遵循一个完整的机器学习管道，从数据收集到最终部署：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR  
    subgraph Multimodal["多模态 + 多语言处理"]  
        D[Data&lt;br/&gt;数据收集] --&gt; P[Preprocessing&lt;br/&gt;数据预处理]  
        P --&gt; PT[Pre-Training&lt;br/&gt;预训练]  
        PT --&gt; POST[Post-Training&lt;br/&gt;后训练]  
    end  
      
    POST --&gt; OPT[Optimization&lt;br/&gt;模型优化]  
    OPT --&gt; ADAPTERS[Adapters&lt;br/&gt;适配器层]  
    ADAPTERS --&gt; FM[Apple Foundation Models&lt;br/&gt;基础模型]  
      
    style D fill:#4A90E2,color:#fff  
    style P fill:#9B59B6,color:#fff  
    style PT fill:#E91E63,color:#fff  
    style POST fill:#F39C12,color:#fff  
    style OPT fill:#FF9800,color:#fff  
    style ADAPTERS fill:#3498DB,color:#fff  
    style FM fill:#2ECC71,color:#fff  
</code></pre>
<p><strong>流程阶段详解</strong>：</p>
<h5 data-id="heading-79">1. Data（数据收集）</h5>
<ul>
<li><strong>作用</strong>: 收集用于训练模型的数据集</li>
<li><strong>特点</strong>: 多模态（文本、图像、音频等）和多语言数据</li>
<li><strong>重要性</strong>: 数据质量直接影响模型性能</li>
</ul>
<h5 data-id="heading-80">2. Preprocessing（数据预处理）</h5>
<ul>
<li><strong>作用</strong>: 清洗、标准化和准备训练数据</li>
<li><strong>任务</strong>: <br/>
- 数据清洗（去除噪声、错误数据）<br/>
- 数据标注（为监督学习准备标签）<br/>
- 数据格式转换（统一数据格式）<br/>
- 多语言处理（处理不同语言的数据）</li>
</ul>
<h5 data-id="heading-81">3. Pre-Training（预训练）</h5>
<ul>
<li><strong>作用</strong>: 在大规模无标注数据上进行自监督学习</li>
<li><strong>目标</strong>: 让模型学习通用的语言表示和知识</li>
<li><strong>特点</strong>: <br/>
- 使用大量文本数据<br/>
- 学习语言的基本规律和模式<br/>
- 建立基础的语义理解能力</li>
</ul>
<h5 data-id="heading-82">4. Post-Training（后训练）</h5>
<ul>
<li><strong>作用</strong>: 在预训练基础上进行进一步优化</li>
<li><strong>任务</strong>:<br/>
- 指令微调（Instruction Tuning）<br/>
- 对齐训练（Alignment Training）<br/>
- 安全训练（Safety Training）<br/>
- 评估和验证模型性能</li>
</ul>
<h5 data-id="heading-83">5. Optimization（模型优化）</h5>
<ul>
<li><strong>作用</strong>: 针对设备端部署进行优化</li>
<li><strong>优化技术</strong>（详见下一节）:<br/>
- 2-bit 量化<br/>
- 推测解码和草稿模型<br/>
- 约束解码<br/>
- KV Cache 优化</li>
<li><strong>目标</strong>: 在保持模型质量的同时，减少存储和内存需求</li>
</ul>
<h5 data-id="heading-84">6. Adapters（适配器层）</h5>
<ul>
<li><strong>作用</strong>: 提供特定任务或领域的适配接口</li>
<li><strong>特点</strong>: <br/>
- 多个适配器可以连接到同一个基础模型<br/>
- 每个适配器针对不同的使用场景<br/>
- 允许在不修改基础模型的情况下扩展功能</li>
</ul>
<h5 data-id="heading-85">7. Apple Foundation Models（基础模型）</h5>
<ul>
<li><strong>作用</strong>: 最终部署的设备端模型</li>
<li><strong>特点</strong>:<br/>
- 通过适配器层访问<br/>
- 优化后的模型，适合设备端运行<br/>
- 支持多种任务和应用场景</li>
</ul>
<p><strong>核心原则</strong>：</p>
<blockquote>
<p><strong>Responsible AI principles inform all steps</strong>（负责任 AI 原则贯穿所有步骤）</p>
</blockquote>
<p>这意味着在整个开发流程中，Apple 都遵循负责任 AI 的原则：</p>
<ul>
<li><strong>隐私保护</strong>: 数据收集和处理过程中保护用户隐私</li>
<li><strong>公平性</strong>: 确保模型对不同用户群体公平</li>
<li><strong>透明度</strong>: 公开模型能力和限制</li>
<li><strong>安全性</strong>: 防止模型生成有害内容</li>
<li><strong>可解释性</strong>: 提供模型决策的解释</li>
</ul>
<p><strong>多模态 + 多语言处理</strong>：</p>
<p>前四个阶段（Data → Preprocessing → Pre-Training → Post-Training）被标记为"多模态 + 多语言"，说明：</p>
<ul>
<li><strong>多模态</strong>: 处理文本、图像、音频等多种数据类型</li>
<li><strong>多语言</strong>: 支持多种语言的训练和推理</li>
<li><strong>统一处理</strong>: 在同一个流程中处理不同类型的数据</li>
</ul>
<p><strong>流程关系</strong>：</p>
<pre><code class="hljs">数据收集 → 预处理 → 预训练 → 后训练 → 优化 → 适配器 → 基础模型  
  ↓         ↓        ↓        ↓        ↓       ↓        ↓  
多模态   标准化   学习通用  任务对齐  设备优化  任务适配  最终部署  
多语言   清洗标注  语言表示  安全训练  量化压缩  功能扩展  用户使用  
</code></pre>
<p><strong>实际应用</strong>：</p>
<p>这个流程确保了：</p>
<ol>
<li><strong>高质量</strong>: 通过完整的训练流程保证模型质量</li>
<li><strong>设备兼容</strong>: 通过优化阶段确保能在设备端运行</li>
<li><strong>灵活扩展</strong>: 通过适配器层支持不同应用场景</li>
<li><strong>负责任</strong>: 在整个流程中贯彻 AI 伦理原则</li>
</ol>
<p><strong>📋 官方来源链接</strong>：</p>
<p>该流程图可能来自以下官方资源（建议按顺序查找）：</p>
<ol>
<li>
<p><strong>WWDC 视频和幻灯片</strong>：<br/>
- 🎥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2024%2F10154%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2024/10154/" ref="nofollow noopener noreferrer">Meet the Foundation Models framework</a>（WWDC 2024）<br/>
- 🎥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fwwdc2024%2F" target="_blank" title="https://developer.apple.com/videos/wwdc2024/" ref="nofollow noopener noreferrer">WWDC 2024 所有 Session</a><br/>
- 🎥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2F" target="_blank" title="https://developer.apple.com/videos/" ref="nofollow noopener noreferrer">WWDC 2025 相关 Session</a>（如果有）</p>
</li>
<li>
<p><strong>Apple Developer 文档</strong>：<br/>
- 📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundationmodels" target="_blank" title="https://developer.apple.com/documentation/foundationmodels" ref="nofollow noopener noreferrer">Foundation Models Framework 文档</a><br/>
- 📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fapple-intelligence%2Fresources%2F" target="_blank" title="https://developer.apple.com/apple-intelligence/resources/" ref="nofollow noopener noreferrer">Apple Intelligence 资源页面</a><br/>
- 📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fmachine-learning%2Fwhats-new%2F" target="_blank" title="https://developer.apple.com/machine-learning/whats-new/" ref="nofollow noopener noreferrer">机器学习新功能页面</a></p>
</li>
<li>
<p><strong>Apple 新闻稿和技术报告</strong>：<br/>
- 📰 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apple.com%2Fnewsroom%2F2025%2F09%2Fapples-foundation-models-framework-unlocks-new-intelligent-app-experiences%2F" target="_blank" title="https://www.apple.com/newsroom/2025/09/apples-foundation-models-framework-unlocks-new-intelligent-app-experiences/" ref="nofollow noopener noreferrer">Apple Foundation Models Framework 新闻稿</a><br/>
- 📄 Apple Intelligence 技术报告（如果已发布）</p>
</li>
<li>
<p><strong>Apple Intelligence 相关页面</strong>：<br/>
- 🌐 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apple.com%2Fapple-intelligence%2F" target="_blank" title="https://www.apple.com/apple-intelligence/" ref="nofollow noopener noreferrer">Apple Intelligence 官网</a><br/>
- 🌐 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fapple-intelligence%2F" target="_blank" title="https://developer.apple.com/apple-intelligence/" ref="nofollow noopener noreferrer">Apple Developer - Apple Intelligence</a></p>
</li>
</ol>
<p><strong>⚠️ 查找建议</strong>：</p>
<p>如果无法在上述链接中找到确切的流程图，建议：</p>
<ol>
<li>查看 WWDC 2024/2025 相关 Session 的幻灯片（通常在视频页面可下载）</li>
<li>查看 Apple Developer 文档中的图片和图表</li>
<li>查看 Apple Intelligence 技术报告（如果已发布）</li>
<li>在 Apple Developer Forums 中搜索相关讨论</li>
</ol>
<p><strong>💡 提示</strong>：</p>
<ul>
<li>该流程图可能出现在 WWDC 演示的幻灯片中</li>
<li>也可能出现在 Apple Intelligence 的技术报告或白皮书中</li>
<li>如果图片来自第三方技术分析文章，建议标注来源</li>
</ul>
<hr/>
<h4 data-id="heading-86">模型优化技术</h4>
<p>苹果针对设备端场景做了大量优化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    subgraph Optimization [优化技术]  
        Q1[2-bit 量化 保持质量]  
        Q2[推测解码 Draft Model]  
        Q3[约束解码 结构化输出]  
        Q4[KV Cache优化 8-bit + 37.5%减少]  
    end  
      
    subgraph 效果  
        E1[减少存储]  
        E2[提升速度]  
        E3[保证可靠性]  
        E4[降低内存]  
    end  
      
    Q1 --&gt; E1  
    Q2 --&gt; E2  
    Q3 --&gt; E3  
    Q4 --&gt; E4  
      
    style Q1 fill:#007AFF,color:#fff  
    style Q2 fill:#5AC8FA,color:#000  
    style Q3 fill:#34C759,color:#fff  
    style Q4 fill:#FF9500,color:#fff  
</code></pre>
<p><strong>优化技术详细说明</strong>:</p>
<h5 data-id="heading-87">1. 2-bit 量化（2-bit Quantization）</h5>
<p><strong>技术原理</strong>:</p>
<ul>
<li>将模型权重从传统的 32 位浮点数（FP32）压缩到每权重 2 位（2-bit）</li>
<li>使用<strong>量化感知训练（Quantization-Aware Training, QAT）</strong>，在训练阶段模拟低精度量化的影响</li>
<li>引入可学习的缩放因子（learnable scaling factors），使模型在低精度下仍能保持高质量输出</li>
<li>结合可学习的权重裁剪（learnable weight pruning）和权重初始化方法</li>
</ul>
<p><strong>效果</strong>:</p>
<ul>
<li><strong>存储减少</strong>: 模型权重从 ~12GB（FP32）压缩到 ~750MB（2-bit），压缩比约 <strong>16:1</strong></li>
<li><strong>内存减少</strong>: 运行时内存占用大幅降低</li>
<li><strong>质量保持</strong>: 通过 QAT 训练，模型质量损失最小</li>
</ul>
<p><strong>数据来源</strong>:</p>
<ul>
<li>📰 <strong>技术细节</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Fnews%2F354610%2Fapple-foundation-models-2025-updates" target="_blank" title="https://www.oschina.net/news/354610/apple-foundation-models-2025-updates" ref="nofollow noopener noreferrer">OSCHINA - Apple Foundation Models 2025 更新</a></li>
<li>⚠️ <strong>注意</strong>: Apple 官方文档和 WWDC 视频中未直接提及 2-bit 量化的具体细节，这些信息主要来自第三方技术分析和实际测试</li>
</ul>
<h5 data-id="heading-88">2. 推测解码和草稿模型（Speculative Decoding &amp; Draft Model）</h5>
<p><strong>技术原理</strong>:</p>
<ul>
<li><strong>主模型</strong>: 约 3B 参数的基础语言模型，负责最终输出</li>
<li><strong>草稿模型（Draft Model）</strong>: 约 300M 参数的小型模型，用于快速生成初步预测</li>
<li><strong>工作流程</strong>:<br/>
1. 草稿模型快速生成多个候选 token（推测解码）<br/>
2. 主模型并行验证这些候选 token<br/>
3. 接受符合主模型预测的 token，拒绝不符合的并重新生成<br/>
4. 通过并行验证多个 token，提升整体生成速度</li>
</ul>
<p><strong>效果</strong>:</p>
<ul>
<li><strong>速度提升</strong>: 通过并行验证多个候选 token，推理速度提升约 <strong>2-3 倍</strong></li>
<li><strong>质量保证</strong>: 主模型验证确保输出质量不受影响</li>
<li><strong>资源平衡</strong>: 300M 草稿模型的内存开销相对较小</li>
</ul>
<p><strong>数据来源</strong>:</p>
<ul>
<li>📰 <strong>技术分析</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aigc.bar%2FAI%25E8%25B5%2584%25E8%25AE%25AF%25E6%2596%2587%25E7%25AB%25A0%2F2025%2F08%2F11%2Fapple-ai-foundation-models-ios-26-deep-dive" target="_blank" title="https://www.aigc.bar/AI%E8%B5%84%E8%AE%AF%E6%96%87%E7%AB%A0/2025/08/11/apple-ai-foundation-models-ios-26-deep-dive" ref="nofollow noopener noreferrer">AIGC.Bar - iOS 26 大模型技术深度解析</a></li>
<li>⚠️ <strong>注意</strong>: 3B 和 300M 的具体参数数量来自第三方分析，Apple 官方未明确公布模型参数规模</li>
</ul>
<h5 data-id="heading-89">3. 约束解码（Constrained Decoding）</h5>
<p><strong>技术原理</strong>:</p>
<ul>
<li>在生成过程中施加特定的结构约束，确保输出符合预期格式</li>
<li>Apple 通过 <strong>引导生成（Guided Generation）</strong> 实现约束解码</li>
<li>开发者使用 <code>@Generable</code> 宏和 <code>@Guide</code> 注解定义输出结构</li>
<li>模型在生成时遵循这些结构约束，生成符合 Swift 数据类型的输出</li>
</ul>
<p><strong>实现方式</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhotoAnalysis</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"照片的主题"</span>)  
    <span class="hljs-keyword">let</span> subject: <span class="hljs-type">String</span>  
      
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"质量评分，1-10分"</span>)  
    <span class="hljs-keyword">let</span> qualityScore: <span class="hljs-type">Int</span>  
}  
</code></pre>
<p><strong>效果</strong>:</p>
<ul>
<li><strong>可靠性</strong>: 确保输出始终符合定义的结构</li>
<li><strong>类型安全</strong>: 直接生成 Swift 类型，无需手动解析 JSON</li>
<li><strong>开发效率</strong>: 减少错误处理和类型转换代码</li>
</ul>
<p><strong>数据来源</strong>:</p>
<ul>
<li>📚 <strong>官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundationmodels" target="_blank" title="https://developer.apple.com/documentation/foundationmodels" ref="nofollow noopener noreferrer">Apple Developer - Foundation Models</a></li>
<li>🎥 <strong>WWDC 视频</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2024%2F10154%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2024/10154/" ref="nofollow noopener noreferrer">Meet the Foundation Models framework</a>（WWDC 2024）</li>
<li>📰 <strong>技术更新</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Fnews%2F354610%2Fapple-foundation-models-2025-updates" target="_blank" title="https://www.oschina.net/news/354610/apple-foundation-models-2025-updates" ref="nofollow noopener noreferrer">OSCHINA - Apple Foundation Models 2025 更新</a></li>
</ul>
<h5 data-id="heading-90">4. KV Cache 优化（KV Cache Optimization）</h5>
<p><strong>技术原理</strong>:</p>
<ul>
<li><strong>KV Cache</strong>: 存储注意力机制中的键（Key）和值（Value），避免重复计算</li>
<li><strong>8-bit 量化</strong>: 将 KV Cache 从 FP32 压缩到 8-bit 整数</li>
<li><strong>Block Sharing</strong>: 通过块共享技术，减少 37.5% 的 KV Cache 存储需求</li>
<li><strong>优化效果</strong>: 内存占用从理论上的 ~1.2GB 降低到实际的 ~300-600MB</li>
</ul>
<p><strong>内存占用对比</strong>:</p>





























<table><thead><tr><th>组件</th><th>未优化</th><th>优化后</th><th>说明</th></tr></thead><tbody><tr><td>模型权重</td><td>~12GB (FP32)</td><td>~750MB (2-bit)</td><td>2-bit 量化</td></tr><tr><td>KV Cache</td><td>~1.2GB (FP32)</td><td>~300-600MB (8-bit + block sharing)</td><td>8-bit 量化 + 37.5% 减少</td></tr><tr><td><strong>总计</strong></td><td><strong>~13.2GB</strong></td><td><strong>~1.0-1.5GB</strong></td><td><strong>显著降低</strong></td></tr></tbody></table>
<p><strong>效果</strong>:</p>
<ul>
<li><strong>内存降低</strong>: KV Cache 内存占用减少约 <strong>50-75%</strong></li>
<li><strong>性能保持</strong>: 推理速度不受影响</li>
<li><strong>设备兼容</strong>: 使得模型能在 iPhone 15 Pro 等设备上运行</li>
</ul>
<p><strong>数据来源</strong>:</p>
<ul>
<li>📊 <strong>主要来源</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fonevcat.com%2F2025%2F06%2Ffoundation-models%2F" target="_blank" title="https://onevcat.com/2025/06/foundation-models/" ref="nofollow noopener noreferrer">OneV's Den - Foundation Models 边界探索</a>（基于实际测试和 Instruments 分析）</li>
<li>⚠️ <strong>注意</strong>: 37.5% block sharing 减少的具体数值来自实际测试分析，Apple 官方未明确公布此优化细节</li>
</ul>
<hr/>
<p><strong>📋 数据来源总结</strong>:</p>



































<table><thead><tr><th>优化技术</th><th>官方来源</th><th>第三方分析来源</th><th>可信度</th></tr></thead><tbody><tr><td><strong>2-bit 量化</strong></td><td>❌ 未明确提及</td><td>OneV's Den、OSCHINA</td><td>⚠️ 需验证</td></tr><tr><td><strong>推测解码</strong></td><td>❌ 未明确提及</td><td>OneV's Den、AIGC.Bar</td><td>⚠️ 需验证</td></tr><tr><td><strong>约束解码</strong></td><td>✅ WWDC 2024、官方文档</td><td>-</td><td>✅ 官方确认</td></tr><tr><td><strong>KV Cache 优化</strong></td><td>❌ 未明确提及</td><td>OneV's Den（实际测试）</td><td>⚠️ 需验证</td></tr></tbody></table>
<p><strong>⚠️ 重要说明</strong>:</p>
<ul>
<li><strong>约束解码</strong>是唯一在 Apple 官方文档和 WWDC 视频中明确提及的技术</li>
<li>其他三项优化技术（2-bit 量化、推测解码、KV Cache 优化）主要来自第三方技术分析和实际测试</li>
<li>建议在实际使用中，以官方文档和 WWDC 视频为准</li>
<li>第三方分析数据（如 OneV's Den）基于实际测试，具有较高参考价值，但非官方声明</li>
</ul>
<p><strong>🔍 验证建议</strong>:</p>
<ol>
<li>查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundationmodels" target="_blank" title="https://developer.apple.com/documentation/foundationmodels" ref="nofollow noopener noreferrer">Apple Developer Documentation - Foundation Models</a></li>
<li>观看 WWDC 2024 相关 Session 视频</li>
<li>使用 Instruments 工具在实际设备上验证内存占用</li>
<li>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fonevcat.com%2F2025%2F06%2Ffoundation-models%2F" target="_blank" title="https://onevcat.com/2025/06/foundation-models/" ref="nofollow noopener noreferrer">OneV's Den 文章</a> 了解实际测试数据</li>
</ol>
<h4 data-id="heading-91">未来展望与注意事项</h4>
<p><strong>模型更新</strong>:</p>
<p>苹果明确表示模型会随着系统更新持续改进，这意味着：</p>
<ul>
<li>⚠️ <strong>Prompt 兼容性</strong>: 你针对旧版本模型调好的 prompt 可能会在新版本模型上不太适用</li>
<li>📋 <strong>测试建议</strong>: Apple 建议设定 test set，在每次模型更新时进行确认和调整</li>
<li>🔄 <strong>更新频率</strong>: 模型的更新间隔大概是半年到一年，因此每年可能会有两个新版本模型需要确认</li>
<li>🛠️ <strong>维护成本</strong>: 如果模型变化很大，可能需要针对不同的系统版本使用不同的提示词</li>
</ul>
<p><strong>macOS 限制</strong>:</p>
<p>macOS 上搭载的本地模型也是这个 3B 的小模型（同时也提供给 macOS 26 上的模拟器使用）。作为性能更加强劲的"生产力级别"设备，却使用了和手持设备一样的方案。</p>
<p><strong>开发建议</strong>:</p>
<ol>
<li><strong>现在就可以开始实验</strong>: 框架已经相当稳定</li>
<li><strong>围绕 4096 token 限制设计应用流程</strong>: 不要指望短期内会有大幅提升</li>
<li><strong>优先考虑 Tool Calling</strong>: 这可能是最有价值的功能</li>
<li><strong>准备好上下文管理策略</strong>: 如果存在对话式的场景，几乎必须处理上下文溢出</li>
<li><strong>在真机上测试性能</strong>: 模拟器版本跑的是 macOS 搭载的模型，性能结果可能不准确</li>
</ol>
<blockquote>
<p>📊 <strong>数据来源</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fonevcat.com%2F2025%2F06%2Ffoundation-models%2F" target="_blank" title="https://onevcat.com/2025/06/foundation-models/" ref="nofollow noopener noreferrer">OneV's Den - Foundation Models 边界探索</a></p>
</blockquote>
<h3 data-id="heading-92">4.4 错误处理和调试</h3>
<h4 data-id="heading-93">完整的错误处理</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD  
    Start([执行操作]) --&gt; Check[检查模型可用性]  
    Check --&gt;|不可用| Error1[模型不可用错误]  
    Check --&gt;|可用| Execute[执行操作]  
    Execute --&gt;|成功| Success[返回结果]  
    Execute --&gt;|上下文窗口超出| Error2[上下文窗口错误]  
    Execute --&gt;|工具调用失败| Error3[工具调用错误]  
    Execute --&gt;|其他错误| Error4[通用错误]  
      
    Error1 --&gt; Handle[错误处理]  
    Error2 --&gt; Handle  
    Error3 --&gt; Handle  
    Error4 --&gt; Handle  
    Handle --&gt; User[显示用户友好提示]  
      
    style Start fill:#007AFF,color:#fff  
    style Check fill:#5AC8FA,color:#000  
    style Execute fill:#FF9500,color:#fff  
    style Success fill:#34C759,color:#fff  
    style Error1 fill:#FF3B30,color:#fff  
    style Error2 fill:#FF3B30,color:#fff  
    style Error3 fill:#FF3B30,color:#fff  
    style Error4 fill:#FF3B30,color:#fff  
    style Handle fill:#AF52DE,color:#fff  
    style User fill:#5AC8FA,color:#000  
</code></pre>
<p><strong>错误处理代码</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PhotoAnalysisError</span>: <span class="hljs-title class_">LocalizedError</span> {  
    <span class="hljs-keyword">case</span> modelUnavailable(<span class="hljs-type">String</span>)  
    <span class="hljs-keyword">case</span> contextWindowExceeded  
    <span class="hljs-keyword">case</span> invalidResponse  
    <span class="hljs-keyword">case</span> toolCallFailed(<span class="hljs-type">String</span>)  
      
    <span class="hljs-keyword">var</span> errorDescription: <span class="hljs-type">String</span>? {  
        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> {  
        <span class="hljs-keyword">case</span> .modelUnavailable(<span class="hljs-keyword">let</span> reason):  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"AI模型不可用: <span class="hljs-subst">\(reason)</span>"</span>  
        <span class="hljs-keyword">case</span> .contextWindowExceeded:  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"对话内容过长，请清理历史记录"</span>  
        <span class="hljs-keyword">case</span> .invalidResponse:  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"AI响应格式错误"</span>  
        <span class="hljs-keyword">case</span> .toolCallFailed(<span class="hljs-keyword">let</span> toolName):  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"工具调用失败: <span class="hljs-subst">\(toolName)</span>"</span>  
        }  
    }  
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">analyzePhotoSafely</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">photo</span>: <span class="hljs-type">Photo</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">PhotoDescription</span> {  
    <span class="hljs-keyword">let</span> model <span class="hljs-operator">=</span> <span class="hljs-type">SystemLanguageModel</span>.default  
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">case</span> .available <span class="hljs-operator">=</span> model.availability <span class="hljs-keyword">else</span> {  
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .unavailable(<span class="hljs-keyword">let</span> reason) <span class="hljs-operator">=</span> model.availability {  
            <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.modelUnavailable(reason.localizedDescription)  
        }  
        <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.modelUnavailable(<span class="hljs-string">"未知原因"</span>)  
    }  
      
    <span class="hljs-keyword">do</span> {  
        <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
        <span class="hljs-keyword">let</span> prompt <span class="hljs-operator">=</span> generateAnalysisPrompt(for: photo)  
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
            to: <span class="hljs-type">Prompt</span>(prompt),  
            generating: <span class="hljs-type">PhotoDescription</span>.<span class="hljs-keyword">self</span>  
        )  
        <span class="hljs-keyword">return</span> response.content  
    } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">let</span> error <span class="hljs-keyword">as</span> <span class="hljs-type">LanguageModelSession</span>.<span class="hljs-type">GenerationError</span> {  
        <span class="hljs-keyword">switch</span> error {  
        <span class="hljs-keyword">case</span> .exceededContextWindowSize:  
            <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.contextWindowExceeded  
        <span class="hljs-keyword">default</span>:  
            <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.invalidResponse  
        }  
    } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">let</span> error <span class="hljs-keyword">as</span> <span class="hljs-type">LanguageModelSession</span>.<span class="hljs-type">ToolCallError</span> {  
        <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.toolCallFailed(error.localizedDescription)  
    } <span class="hljs-keyword">catch</span> {  
        <span class="hljs-keyword">throw</span> <span class="hljs-type">PhotoAnalysisError</span>.invalidResponse  
    }  
}  
</code></pre>
<h3 data-id="heading-94">4.4 提示设计和安全实践</h3>
<h4 data-id="heading-95">提示设计最佳实践</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((提示设计&lt;br/&gt;最佳实践))  
    清晰明确  
      角色定义  
      职责说明  
      格式要求  
    提供上下文  
      用户信息  
      当前状态  
      历史记录  
    示例引导  
      输入示例  
      输出示例  
      格式示例  
    结构化  
      分层次  
      标记重点  
      易于理解  
</code></pre>
<p><strong>Instructions设计示例</strong>:</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ✅ 好的Instructions  </span>
<span class="hljs-keyword">let</span> instructions <span class="hljs-operator">=</span> <span class="hljs-type">Instructions</span>(<span class="hljs-string">"""  
你是一个专业的照片分析助手，擅长：  
1. 分析照片内容（人物、场景、物体）  
2. 评估照片质量（构图、光线、清晰度）  
3. 提供拍摄改进建议  
4. 生成准确的照片标签和描述

请保持回答简洁专业，使用中文回复。  
"""</span>)  
</code></pre>
<h4 data-id="heading-96">安全实践</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    subgraph "安全机制"  
        S1[Guardrail&lt;br/&gt;内容过滤]  
        S2[输入验证&lt;br/&gt;长度检查]  
        S3[隐私保护&lt;br/&gt;本地处理]  
    end  
      
    subgraph "实践要点"  
        P1[处理安全错误]  
        P2[验证用户输入]  
        P3[避免敏感信息]  
    end  
      
    S1 --&gt; P1  
    S2 --&gt; P2  
    S3 --&gt; P3  
      
    style S1 fill:#FF3B30,color:#fff  
    style S2 fill:#FF3B30,color:#fff  
    style S3 fill:#FF3B30,color:#fff  
    style P1 fill:#34C759,color:#fff  
    style P2 fill:#34C759,color:#fff  
    style P3 fill:#34C759,color:#fff  
</code></pre>
<hr/>
<h2 data-id="heading-97">🎬 第五部分：Demo视频展示</h2>
<h3 data-id="heading-98">Demo 1: 智能照片分析</h3>
<p><strong>演示流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram  
    participant U as 用户  
    participant UI as 界面  
    participant VM as ViewModel  
    participant AI as Foundation Models  
      
    U-&gt;&gt;UI: 选择照片  
    UI-&gt;&gt;VM: analyzePhoto(photo)  
    VM-&gt;&gt;AI: 生成分析Prompt  
    AI-&gt;&gt;AI: 分析照片内容  
    loop 流式响应  
        AI--&gt;&gt;VM: 返回部分文本  
        VM--&gt;&gt;UI: 更新UI  
    end  
    AI--&gt;&gt;VM: 返回结构化结果  
    VM--&gt;&gt;UI: 显示分析结果  
    UI--&gt;&gt;U: 展示标签、评分、建议  
</code></pre>
<p><strong>讲解要点</strong>:</p>
<ul>
<li>展示结构化数据生成的实际效果</li>
<li>说明流式响应如何提升用户体验</li>
<li>强调本地处理的隐私优势</li>
</ul>
<h3 data-id="heading-99">Demo 2: 自然语言搜索</h3>
<p><strong>演示流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram  
    participant U as 用户  
    participant AI as Foundation Models  
    participant Tool as PhotoSearchTool  
      
    U-&gt;&gt;AI: "找去年夏天在海边的照片"  
    AI-&gt;&gt;AI: 理解用户意图  
    AI-&gt;&gt;AI: 匹配工具描述  
    AI-&gt;&gt;Tool: call(Arguments)  
    Tool-&gt;&gt;Tool: 执行搜索  
    Tool--&gt;&gt;AI: 返回照片列表  
    AI-&gt;&gt;AI: 生成响应  
    AI--&gt;&gt;U: "我找到了5张照片..."  
</code></pre>
<p><strong>讲解要点</strong>:</p>
<ul>
<li>展示工具调用的工作机制</li>
<li>说明自然语言理解的优势</li>
<li>强调无需精确关键词的便利性</li>
</ul>
<h3 data-id="heading-100">Demo 3: 完整工作流</h3>
<p><strong>演示流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR  
    User([用户请求]) --&gt; AI[AI分析]  
    AI --&gt; T1[搜索照片]  
    T1 --&gt; T2[分析内容]  
    T2 --&gt; T3[创建相册]  
    T3 --&gt; Result[完成]  
      
    style User fill:#007AFF,color:#fff  
    style AI fill:#5AC8FA,color:#000  
    style T1 fill:#FF9500,color:#fff  
    style T2 fill:#FF9500,color:#fff  
    style T3 fill:#FF9500,color:#fff  
    style Result fill:#34C759,color:#fff  
</code></pre>
<p><strong>讲解要点</strong>:</p>
<ul>
<li>展示多工具协调的能力</li>
<li>说明AI如何自动判断工具调用顺序</li>
<li>强调复杂任务的一站式解决</li>
</ul>
<hr/>
<h2 data-id="heading-101">📚 第六部分：学习资源和总结 </h2>
<h3 data-id="heading-102">官方资源</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD  
    Resource[学习资源] --&gt; Official[官方资源]  
    Resource --&gt; Video[视频教程]  
    Resource --&gt; Demo[示例项目]  
      
    Official --&gt; Doc[Apple文档]  
    Official --&gt; WWDC[WWDC 2024]  
      
    Video --&gt; V1[Framework介绍]  
    Video --&gt; V2[深入理解]  
    Video --&gt; V3[编码实践]  
    Video --&gt; V4[提示和安全]  
      
    Demo --&gt; Project[Foundation Lab]  
      
    style Resource fill:#007AFF,color:#fff  
    style Official fill:#34C759,color:#fff  
    style Video fill:#FF9500,color:#fff  
    style Demo fill:#5AC8FA,color:#000  
</code></pre>
<p><strong>资源列表</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundationmodels" target="_blank" title="https://developer.apple.com/documentation/foundationmodels" ref="nofollow noopener noreferrer">Apple Developer Documentation - Foundation Models</a></li>
<li>WWDC 2024相关Session</li>
<li>示例项目：Foundation Lab</li>
</ul>
<p><strong>推荐视频</strong>:</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DmJMvFyBvZEk" target="_blank" title="https://www.youtube.com/watch?v=mJMvFyBvZEk" ref="nofollow noopener noreferrer">Foundation Models Framework 介绍</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D6Wgg7DIY29E" target="_blank" title="https://www.youtube.com/watch?v=6Wgg7DIY29E" ref="nofollow noopener noreferrer">深入了解 Foundation Models 框架</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DS5F196tqRMI" target="_blank" title="https://www.youtube.com/watch?v=S5F196tqRMI" ref="nofollow noopener noreferrer">实际编码实践</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D-aMFBj-kwdU" target="_blank" title="https://www.youtube.com/watch?v=-aMFBj-kwdU" ref="nofollow noopener noreferrer">探索设备端基础模型的提示设计和安全</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Dz-t64Zlj1ok" target="_blank" title="https://www.youtube.com/watch?v=z-t64Zlj1ok" ref="nofollow noopener noreferrer">YouTube 分享视频</a> - 可作为补充参考，结合本文档内容观看，更好理解实际演示细节</li>
</ol>
<p><strong>深度技术分析</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fonevcat.com%2F2025%2F06%2Ffoundation-models%2F" target="_blank" title="https://onevcat.com/2025/06/foundation-models/" ref="nofollow noopener noreferrer">OneV's Den - Foundation Models：苹果设备端模型的边界探索</a> - 基于实际测试的性能数据、边界限制和最佳实践，包含内存消耗、并发性能、上下文窗口等关键指标的详细分析</li>
</ul>
<h3 data-id="heading-103">实践建议</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    Start([开始学习]) --&gt; Step1[单轮对话]  
    Step1 --&gt; Step2[结构化生成]  
    Step2 --&gt; Step3[实现Tool]  
    Step3 --&gt; Step4[业务集成]  
    Step4 --&gt; End([生产应用])  
      
    style Start fill:#007AFF,color:#fff  
    style Step1 fill:#5AC8FA,color:#000  
    style Step2 fill:#5AC8FA,color:#000  
    style Step3 fill:#FF9500,color:#fff  
    style Step4 fill:#34C759,color:#fff  
    style End fill:#007AFF,color:#fff  
</code></pre>
<hr/>
<h2 data-id="heading-104">🤔 第七部分：Q&amp;A </h2>
<h3 data-id="heading-105">常见问题对比</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB  
    Q1[Q: 和ChatGPT的区别?] --&gt; A1[完全本地化&lt;br/&gt;无需网络&lt;br/&gt;数据不出设备]  
    Q2[Q: 可用于生产?] --&gt; A2[需要iOS 18+&lt;br/&gt;设备需支持AI]  
    Q3[Q: 性能如何?] --&gt; A3[性能良好&lt;br/&gt;首次调用有延迟]  
    Q4[Q: 如何测试?] --&gt; A4[必须真机测试&lt;br/&gt;模拟器不支持]  
    Q5[Q: 成本如何?] --&gt; A5[完全免费&lt;br/&gt;无API费用]  
      
    style Q1 fill:#5AC8FA,color:#000  
    style Q2 fill:#5AC8FA,color:#000  
    style Q3 fill:#5AC8FA,color:#000  
    style Q4 fill:#5AC8FA,color:#000  
    style Q5 fill:#5AC8FA,color:#000  
    style A1 fill:#34C759,color:#fff  
    style A2 fill:#34C759,color:#fff  
    style A3 fill:#34C759,color:#fff  
    style A4 fill:#34C759,color:#fff  
    style A5 fill:#34C759,color:#fff  
</code></pre>
<h3 data-id="heading-106">讨论话题</h3>
<ul>
<li>在相册业务中，哪些场景最适合使用Foundation Models？</li>
<li>如何平衡AI能力和用户体验？</li>
<li>如何处理模型不可用的情况？</li>
</ul>
<hr/>
<h2 data-id="heading-107">📝 总结</h2>
<h3 data-id="heading-108">关键要点总结</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap  
  root((Foundation Models&lt;br/&gt;关键要点))  
    原生AI能力  
      Apple提供  
      iOS 18+  
      Apple Intelligence  
    隐私保护  
      设备端处理  
      数据不出设备  
      完全本地化  
    易于集成  
      简洁API  
      开发者友好  
      系统集成  
    应用场景  
      照片分析  
      自然语言搜索  
      智能分类  
      视频理解  
</code></pre>
<h3 data-id="heading-109">下一步行动</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR  
    A[创建Demo] --&gt; B[选择功能]  
    B --&gt; C[集成AI]  
    C --&gt; D[收集反馈]  
    D --&gt; E[迭代优化]  
      
    style A fill:#007AFF,color:#fff  
    style B fill:#5AC8FA,color:#000  
    style C fill:#FF9500,color:#fff  
    style D fill:#34C759,color:#fff  
    style E fill:#AF52DE,color:#fff  
</code></pre>
<h3 data-id="heading-110">相册业务应用优先级</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">pie title 相册业务应用优先级  
    "高优先级" : 3  
    "中优先级" : 3  
    "低优先级" : 2  
</code></pre>
<p><strong>优先级详情</strong>:</p>
<ul>
<li><strong>高优先级</strong>: 智能照片描述生成、自然语言搜索、智能相册分类</li>
<li><strong>中优先级</strong>: 相似照片推荐、视频摘要生成、清理建议</li>
<li><strong>低优先级</strong>: 照片质量评分、自动标签生成</li>
</ul>
<hr/>
<h2 data-id="heading-111">📎 附录：代码模板</h2>
<h3 data-id="heading-112">基础会话模板</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FoundationModels

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicSessionManager</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">chat</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">String</span> {  
        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(to: message)  
        <span class="hljs-keyword">return</span> response.content  
    }  
}  
</code></pre>
<h3 data-id="heading-113">Tool实现模板</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyTool</span>: <span class="hljs-title class_">Tool</span> {  
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"toolName"</span>  
    <span class="hljs-keyword">let</span> description <span class="hljs-operator">=</span> <span class="hljs-string">"工具描述"</span>  
      
    <span class="hljs-meta">@Generable</span>  
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Arguments</span> {  
        <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"参数描述"</span>)  
        <span class="hljs-keyword">var</span> param: <span class="hljs-type">String</span>  
    }  
      
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">arguments</span>: <span class="hljs-type">Arguments</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">PromptRepresentable</span> {  
        <span class="hljs-comment">// 实现工具逻辑  </span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"工具返回结果"</span>  
    }  
}  
</code></pre>
<h3 data-id="heading-114">结构化数据生成模板</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Generable</span>  
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyDataModel</span> {  
    <span class="hljs-meta">@Guide</span>(description: <span class="hljs-string">"字段描述"</span>)  
    <span class="hljs-keyword">let</span> field: <span class="hljs-type">String</span>  
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">generateData</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">MyDataModel</span> {  
    <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">LanguageModelSession</span>()  
    <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> session.respond(  
        to: <span class="hljs-string">"生成数据的提示词"</span>,  
        generating: <span class="hljs-type">MyDataModel</span>.<span class="hljs-keyword">self</span>  
    )  
    <span class="hljs-keyword">return</span> response.content  
}  
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP8.6 新的 RFC 提案 Context Managers 优雅管理资源生命周期]]></title>    <link>https://juejin.cn/post/7575112613778047010</link>    <guid>https://juejin.cn/post/7575112613778047010</guid>    <pubDate>2025-11-23T09:18:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613778047010" data-draft-id="7575162322240077824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP8.6 新的 RFC 提案 Context Managers 优雅管理资源生命周期"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-11-23T09:18:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP8.6 新的 RFC 提案 Context Managers 优雅管理资源生命周期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:18:13.000Z" title="Sun Nov 23 2025 09:18:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在日常 PHP 开发中，我们经常需要处理资源的生命周期管理：打开文件后要记得关闭，开启数据库事务后要确保提交或回滚，获取锁后要记得释放……这些重复的"设置-使用-清理"模式充斥着我们的代码，不仅繁琐，还容易出错。</p>
<p>PHP 8.6 即将引入的 <strong>Context Managers（上下文管理器）</strong> 特性，正是为了解决这一问题。这个特性借鉴自 Python，通过新增的 <code>using</code> 关键字和 <code>ContextManager</code> 接口，提供了一种优雅的方式来抽象这些通用的控制流和变量生命周期管理模式。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-11%2Fphp-context-managers-rfc-zh" target="_blank" title="https://catchadmin.com/post/2025-11/php-context-managers-rfc-zh" ref="nofollow noopener noreferrer">原文链接 PHP8.6 新的 RFC 提案 Context Managers 优雅管理资源生命周期</a>
让我们看一个典型的例子。传统的文件处理代码需要这样写：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$fp</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'w'</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$fp</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$someThing</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$value</span>));
        }
    } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
        <span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'The file failed.'</span>);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fp</span>);
    }
}
<span class="hljs-keyword">unset</span>(<span class="hljs-variable">$fp</span>);
</code></pre>
<p>而使用 Context Managers 后，可以简化为：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-title function_ invoke__">file_for_write</span>(<span class="hljs-string">'file.txt'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$someThing</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$value</span>));
    }
}
<span class="hljs-comment">// 此时可以保证 $fp 已经关闭，无论是否发生错误</span>
</code></pre>
<h2 data-id="heading-1">核心概念</h2>
<h3 data-id="heading-2">ContextManager 接口</h3>
<p>Context Managers 的核心是一个新的接口 <code>ContextManager</code>，它定义了两个关键方法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">mixed</span></span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span></span>;
}
</code></pre>
<ul>
<li><strong><code>enterContext()</code></strong>：在进入上下文块时调用，执行必要的设置操作，返回值将作为上下文变量提供给代码块使用</li>
<li><strong><code>exitContext()</code></strong>：在离开上下文块时调用，执行清理操作。接收一个可选的异常参数，如果返回 <code>true</code> 则抑制异常，否则异常会重新抛出</li>
</ul>
<h3 data-id="heading-3">using 关键字语法</h3>
<p><code>using</code> 语句的基本语法如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> ((EXPR [<span class="hljs-keyword">as</span> VAR])[,]+) {
    BODY
}
</code></pre>
<p>其中：</p>
<ul>
<li><strong>EXPR</strong>：任意表达式，其结果必须是 <code>ContextManager</code> 实例</li>
<li><strong>VAR</strong>：可选的变量名，用于接收 <code>enterContext()</code> 的返回值</li>
<li><strong>BODY</strong>：任意 PHP 语句</li>
<li><strong>逗号分隔</strong>：可以在一个 <code>using</code> 语句中使用多个上下文管理器，用逗号分隔</li>
</ul>
<p><strong>语法示例</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 单个上下文管理器，带上下文变量</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileManager</span>(<span class="hljs-string">'file.txt'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-comment">// 使用 $fp</span>
}

<span class="hljs-comment">// 单个上下文管理器，不需要上下文变量</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionManager</span>()) {
    <span class="hljs-comment">// 执行事务性操作</span>
}

<span class="hljs-comment">// 多个上下文管理器</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">LockA</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$a</span>, <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">LockB</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$b</span>) {
    <span class="hljs-comment">// 同时使用 $a 和 $b</span>
}

<span class="hljs-comment">// 表达式可以是函数调用或方法链</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">transaction</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$tx</span>) {
    <span class="hljs-comment">// 使用事务</span>
}
</code></pre>
<h3 data-id="heading-4">上下文管理器 vs 上下文变量</h3>
<p>需要特别注意的是，<strong>上下文管理器</strong>（ContextManager 实例）和<strong>上下文变量</strong>（<code>as</code> 后面的变量）是两个不同的概念：</p>
<ul>
<li><strong>上下文管理器</strong>：负责管理生命周期的对象，通常对业务代码不可见</li>
<li><strong>上下文变量</strong>：<code>enterContext()</code> 返回的值，这才是业务代码实际使用的对象</li>
</ul>
<p>例如，在文件处理场景中，Context Manager 可能是一个 <code>FileManager</code> 对象，而上下文变量则是实际的文件句柄。</p>
<h2 data-id="heading-5">执行流程详解</h2>
<h3 data-id="heading-6">成功场景</h3>
<p>当代码块正常执行完毕时：</p>
<ol>
<li>验证 EXPR 返回的是 <code>ContextManager</code> 实例（否则抛出 <code>TypeError</code>）</li>
<li>调用 <code>enterContext()</code>，将返回值赋给上下文变量（如果指定了 <code>as VAR</code>）</li>
<li>执行代码块中的语句</li>
<li>调用 <code>exitContext()</code>（不传参数）</li>
<li>显式 <code>unset()</code> 上下文变量</li>
<li>Context Manager 自然超出作用域，被垃圾回收</li>
</ol>
<h3 data-id="heading-7">失败场景</h3>
<p>当代码块中抛出异常时：</p>
<ol>
<li>捕获异常</li>
<li>调用 <code>exitContext($exception)</code>，传入捕获的异常</li>
<li>显式 <code>unset()</code> 上下文变量</li>
<li>如果 <code>exitContext()</code> 返回 <code>true</code>，异常被抑制；否则重新抛出异常</li>
</ol>
<h3 data-id="heading-8">特殊控制语句</h3>
<p>在 <code>using</code> 块中，三个关键字有特殊含义：</p>
<ul>
<li><strong><code>break</code></strong>：跳出 <code>using</code> 块，视为成功场景。如果在嵌套控制结构中，使用 <code>break 2</code> 等来指定跳出层级</li>
<li><strong><code>continue</code></strong>：行为同 <code>break</code>，但会触发警告（与 <code>switch</code> 保持一致）</li>
<li><strong><code>return</code></strong>：从函数返回，先触发成功场景的清理流程，再返回</li>
</ul>
<p><strong>重要说明</strong>：<code>using</code> 块不会创建新的作用域（不像函数或闭包）。这意味着：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$outer</span> = <span class="hljs-string">'outside'</span>;

<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Manager</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$ctx</span>) {
    <span class="hljs-comment">// 可以访问外部变量</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$outer</span>; <span class="hljs-comment">// 输出：outside</span>
    
    <span class="hljs-comment">// 在块内定义的变量</span>
    <span class="hljs-variable">$inner</span> = <span class="hljs-string">'inside'</span>;
}

<span class="hljs-comment">// 上下文变量 $ctx 已被显式 unset，此处不可访问</span>
<span class="hljs-comment">// var_dump($ctx); // 错误：Undefined variable</span>

<span class="hljs-comment">// 但块内定义的其他变量仍然存在</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$inner</span>; <span class="hljs-comment">// 输出：inside</span>
</code></pre>
<h2 data-id="heading-9">实现原理</h2>
<p><code>using</code> 块在编译时会被转换（desugaring）为传统代码。以下是一个简单示例的转换结果：</p>
<p><strong>原始代码</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Manager</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$var</span>) {
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Hello world\n"</span>;
}
</code></pre>
<p><strong>等效转换后的代码</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 步骤 1: 创建上下文管理器实例</span>
<span class="hljs-variable">$__mgr</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Manager</span>();

<span class="hljs-comment">// 步骤 2: 标记异常处理状态（确保 exitContext 只调用一次）</span>
<span class="hljs-variable">$__closed</span> = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 步骤 3: 调用 enterContext() 并保存返回值到上下文变量</span>
<span class="hljs-variable">$var</span> = <span class="hljs-variable">$__mgr</span>-&gt;<span class="hljs-title function_ invoke__">enterContext</span>();

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 步骤 4: 执行用户代码块</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Hello world\n"</span>;
    
} <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// 步骤 5a: 捕获异常时的处理（失败场景）</span>
    <span class="hljs-variable">$__closed</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 调用 exitContext 并传入异常</span>
    <span class="hljs-variable">$__ret</span> = <span class="hljs-variable">$__mgr</span>-&gt;<span class="hljs-title function_ invoke__">exitContext</span>(<span class="hljs-variable">$e</span>);
    
    <span class="hljs-comment">// 如果返回值不是 true，则重新抛出异常</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$__ret</span> !== <span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
    }
    <span class="hljs-comment">// 如果返回 true，则抑制异常（不再抛出）</span>
    
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 步骤 5b/6: 无论如何都会执行的清理代码</span>
    
    <span class="hljs-comment">// 如果没有发生异常（成功场景），调用 exitContext()</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$__closed</span>) {
        <span class="hljs-variable">$__mgr</span>-&gt;<span class="hljs-title function_ invoke__">exitContext</span>();
    }
    
    <span class="hljs-comment">// 显式清理所有相关变量</span>
    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$var</span>);      <span class="hljs-comment">// 清理上下文变量</span>
    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$__closed</span>); <span class="hljs-comment">// 清理状态标记</span>
    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$__mgr</span>);    <span class="hljs-comment">// 清理管理器（触发垃圾回收）</span>
}
</code></pre>
<p><strong>关键要点</strong>：</p>
<ul>
<li><code>$__mgr</code>、<code>$__closed</code>、<code>$__ret</code> 等变量实际上不会以这个名字暴露，这只是为了说明其工作原理</li>
<li><strong><code>exitContext()</code> 保证只会被调用一次</strong>，无论是成功还是失败场景</li>
<li>所有需要在两种情况下执行的清理操作都应该在 <code>exitContext()</code> 中统一处理</li>
<li><code>finally</code> 块确保清理代码一定会执行，即使在 <code>catch</code> 中重新抛出异常</li>
</ul>
<h2 data-id="heading-10">实战应用场景</h2>
<h3 data-id="heading-11">场景一：数据库事务</h3>
<p>数据库事务是 Context Managers 的典型应用场景。传统方式需要手动管理事务的开启、提交和回滚：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseTransaction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">private</span> DatabaseConnection <span class="hljs-variable">$connection</span>,
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">DatabaseConnection</span>
    </span>{
        <span class="hljs-comment">// 返回数据库连接，供业务代码使用</span>
        <span class="hljs-comment">// 注：实际应用中可能需要在此处调用 beginTransaction()</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;connection;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$e</span>) {
            <span class="hljs-variable language_">$this</span>-&gt;connection-&gt;<span class="hljs-title function_ invoke__">rollback</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">$this</span>-&gt;connection-&gt;<span class="hljs-title function_ invoke__">commit</span>();
        }
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transaction</span>(<span class="hljs-params"/>): <span class="hljs-title">DatabaseTransaction</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseTransaction</span>(<span class="hljs-variable language_">$this</span>);
    }
}
</code></pre>
<p>使用时非常简洁：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 注意这里省略了 'as' 表达式，因为不需要返回值</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-variable">$connection</span>-&gt;<span class="hljs-title function_ invoke__">transaction</span>()) {
    <span class="hljs-variable">$connection</span>-&gt;<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Alice'</span>]);
    <span class="hljs-variable">$connection</span>-&gt;<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-string">'logs'</span>, [<span class="hljs-string">'action'</span> =&gt; <span class="hljs-string">'user_created'</span>]);
}
<span class="hljs-comment">// 如果没有异常，事务自动提交；如果有异常，事务自动回滚</span>
</code></pre>
<h3 data-id="heading-12">场景二：文件锁定</h3>
<p>在需要独占访问某个文件时，文件锁定机制至关重要：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$handle</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-variable">$locked</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-variable">$forWriting</span> = <span class="hljs-literal">true</span>,
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">mixed</span>
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;handle = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$this</span>-&gt;file, <span class="hljs-variable">$this</span>-&gt;forWriting ? <span class="hljs-string">'w'</span> : <span class="hljs-string">'r'</span>);
        <span class="hljs-variable language_">$this</span>-&gt;locked = <span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$this</span>-&gt;handle, <span class="hljs-variable">$this</span>-&gt;forWriting ? LOCK_EX : LOCK_SH);
        
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;locked) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\RuntimeException</span>(<span class="hljs-string">'Could not acquire lock.'</span>);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;handle;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;locked) {
            <span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$this</span>-&gt;handle, LOCK_UN);
        }
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;handle);
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 需要写入文件的独占访问</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLock</span>(<span class="hljs-string">'file.txt'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-string">'important stuff'</span>);
}

<span class="hljs-comment">// 仅用于同步，不实际操作文件</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLock</span>(<span class="hljs-string">'sentinel'</span>)) {
    <span class="hljs-comment">// 执行需要同步的操作，不涉及文件读写</span>
}
</code></pre>
<h3 data-id="heading-13">场景三：结构化异步控制</h3>
<p>Context Managers 也可以用于管理异步协程的生命周期：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockingScope</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">private</span> Scope <span class="hljs-variable">$scope</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">Scope</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;scope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scope</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$e</span>) {
            <span class="hljs-comment">// 发生异常时取消所有协程</span>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;scope-&gt;routines <span class="hljs-keyword">as</span> <span class="hljs-variable">$r</span>) {
                <span class="hljs-variable">$r</span>-&gt;<span class="hljs-title function_ invoke__">cancel</span>();
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 正常退出时等待所有协程完成</span>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;scope-&gt;routines <span class="hljs-keyword">as</span> <span class="hljs-variable">$r</span>) {
                <span class="hljs-variable">$r</span>-&gt;<span class="hljs-title function_ invoke__">wait</span>();
            }
        }
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CancellingScope</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">private</span> Scope <span class="hljs-variable">$scope</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">Scope</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;scope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scope</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-comment">// 无论如何都取消所有协程</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;scope-&gt;routines <span class="hljs-keyword">as</span> <span class="hljs-variable">$r</span>) {
            <span class="hljs-variable">$r</span>-&gt;<span class="hljs-title function_ invoke__">cancel</span>();
        }
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockingScope</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$scope</span>) {
    <span class="hljs-variable">$scope</span>-&gt;<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-title function_ invoke__">someAsyncTask</span>());
    <span class="hljs-variable">$scope</span>-&gt;<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-title function_ invoke__">anotherAsyncTask</span>());
}
<span class="hljs-comment">// 代码会阻塞在这里，直到所有协程完成</span>

<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">CancellingScope</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$scope</span>) {
    <span class="hljs-variable">$scope</span>-&gt;<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-title function_ invoke__">longRunningTask</span>());
    <span class="hljs-variable">$scope</span>-&gt;<span class="hljs-title function_ invoke__">wait</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 等待 5 秒</span>
}
<span class="hljs-comment">// 5 秒后所有未完成的协程会被立即取消</span>
</code></pre>
<h3 data-id="heading-14">场景四：临时修改全局配置</h3>
<p>有时需要临时修改某个全局设置，执行完特定代码后恢复：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomErrorHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$oldHandler</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$newHandler</span>,
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;oldHandler = <span class="hljs-title function_ invoke__">set_error_handler</span>(<span class="hljs-variable">$this</span>-&gt;newHandler);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-title function_ invoke__">set_error_handler</span>(<span class="hljs-variable">$this</span>-&gt;oldHandler);
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 临时禁用所有错误处理</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomErrorHandler</span>(fn() =&gt; <span class="hljs-literal">null</span>)) {
    <span class="hljs-comment">// 在这里"危险地"执行代码</span>
}
<span class="hljs-comment">// 退出块后，之前的错误处理器已自动恢复</span>
</code></pre>
<p>类似的，可以创建用于临时修改 <code>ini</code> 设置的 Context Manager。</p>
<h3 data-id="heading-15">场景五：简化的文件处理</h3>
<p>对于常见的文件操作，可以创建便利的工厂函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_for_write</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span></span>): <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>($<span class="hljs-title">filename</span>) <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$handle</span>;
        
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span></span>) </span>{}
        
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">mixed</span>
        </span>{
            <span class="hljs-variable language_">$this</span>-&gt;handle = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$this</span>-&gt;file, <span class="hljs-string">'w'</span>);
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;handle) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\RuntimeException</span>(<span class="hljs-string">"Cannot open file: <span class="hljs-subst">{$this-&gt;file}</span>"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;handle;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
        </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;handle) {
                <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;handle);
            }
        }
    };
}
</code></pre>
<p>使用时非常直观：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-title function_ invoke__">file_for_write</span>(<span class="hljs-string">'output.txt'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-string">"Line 1\n"</span>);
    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-string">"Line 2\n"</span>);
}
<span class="hljs-comment">// 文件自动关闭，无论是否发生异常</span>
</code></pre>
<h2 data-id="heading-16">高级特性</h2>
<h3 data-id="heading-17">嵌套上下文管理器</h3>
<p><code>using</code> 语句支持在一个语句中使用多个上下文管理器，用逗号分隔：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$foo</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bar</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$bar</span>) {
    <span class="hljs-comment">// 可以同时使用 $foo 和 $bar</span>
}
</code></pre>
<p>这等价于嵌套的写法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$foo</span>) {
    <span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Bar</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$bar</span>) {
        <span class="hljs-comment">// 可以同时使用 $foo 和 $bar</span>
    }
}
</code></pre>
<p><strong>重要</strong>：后面的管理器会先执行清理。在上面的例子中，<code>Bar</code> 的 <code>exitContext()</code> 会先于 <code>Foo</code> 的 <code>exitContext()</code> 执行，这符合 LIFO（后进先出）的资源管理原则。</p>
<h3 data-id="heading-18">Resource 自动包装</h3>
<p>由于 PHP 中的资源（resource）类型尚未完全对象化（如 <code>fopen()</code> 返回的文件句柄），RFC 特别为资源提供了自动包装机制。</p>
<p>当 <code>using</code> 表达式返回一个资源类型时，会自动包装成一个内置的 Context Manager：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 这段代码</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'foo.txt'</span>, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-string">'bar'</span>);
}

<span class="hljs-comment">// 会自动转换为</span>
<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceContext</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'foo.txt'</span>, <span class="hljs-string">'r'</span>)) <span class="hljs-keyword">as</span> <span class="hljs-variable">$fp</span>) {
    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-string">'bar'</span>);
}
</code></pre>
<p>其中 <code>ResourceContext</code> 大致等价于：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContextManager</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-variable">$resource</span></span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterContext</span>(<span class="hljs-params"/>): <span class="hljs-title">mixed</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;resource;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitContext</span>(<span class="hljs-params">?\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span> = <span class="hljs-literal">null</span></span>): ?<span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_resource</span>(<span class="hljs-variable">$this</span>-&gt;resource)) {
            <span class="hljs-title function_ invoke__">close</span>(<span class="hljs-variable">$this</span>-&gt;resource); <span class="hljs-comment">// C 层面的统一关闭函数</span>
        }
    }
}
</code></pre>
<p>这样即使在资源完全对象化之前，也能享受 Context Managers 带来的便利。</p>
<h2 data-id="heading-19">设计决策</h2>
<h3 data-id="heading-20">为何选择 <code>using</code> 而非 <code>with</code></h3>
<p>最初的提案使用 <code>with</code> 关键字（与 Python 一致），但发现 Laravel 在全局助手函数中定义了一个名为 <code>with()</code> 的函数。引入 <code>with</code> 关键字会导致所有 Laravel 应用在升级到 PHP 8.6 时立即不兼容，这是不可接受的。</p>
<p>经过调研发现，<code>using</code> 在 Packagist 前 14000 个包中仅出现 2 次（相比之下 <code>with</code> 出现 19 次）。C# 也使用 <code>using</code> 实现类似（但功能较弱）的特性。因此最终选择了 <code>using</code> 关键字。</p>
<h3 data-id="heading-21">为何不使用析构函数</h3>
<p>有人可能会想，为什么不直接使用对象的构造函数和析构函数来实现"进入"和"退出"逻辑呢？这种方案存在以下问题：</p>
<ol>
<li><strong>无法分离管理器和变量</strong>：无法区分管理对象和实际使用的对象</li>
<li><strong>无法区分成功/失败</strong>：析构函数不接受参数，无法知道是正常退出还是异常退出</li>
<li><strong>时机不可控</strong>：析构函数的调用时机不确定，可能因为变量被其他地方引用而延迟执行</li>
<li><strong>顺序问题</strong>：在垃圾回收期间，析构函数的调用顺序是不确定的</li>
</ol>
<p>因此，RFC 采用了显式的接口设计。</p>
<h2 data-id="heading-22">影响和展望</h2>
<h3 data-id="heading-23">向后兼容性</h3>
<ul>
<li>引入了新的全局接口 <code>ContextManager</code></li>
<li>引入了新的半保留关键字 <code>using</code>（禁止用于全局常量和函数，但方法和类常量仍可使用）</li>
</ul>
<p>由于全局命名空间通常被认为是 PHP 内部保留的，预计不会有重大兼容性问题。</p>
<h3 data-id="heading-24">生态系统影响</h3>
<p>Context Managers 作为一个通用的"设置-清理"抽象，未来的 PHP API 设计可能会考虑提供相应的 Context Manager，而不是引入新的语法糖。</p>
<p>例如：</p>
<ul>
<li>数据库库可能提供事务 Context Manager</li>
<li>HTTP 客户端可能提供连接池 Context Manager</li>
<li>日志库可能提供上下文级别配置 Context Manager</li>
</ul>
<h3 data-id="heading-25">未来可能性：Generator 装饰器</h3>
<p>Python 允许使用生成器（generator）和装饰器来创建 Context Manager，使语法更简洁。PHP 也验证了类似实现的可行性：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[ContextManager</span><span class="hljs-meta">]</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">opening</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>) </span>{
    <span class="hljs-variable">$f</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">"r"</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$f</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"fopen(<span class="hljs-subst">$filename</span>) failed"</span>);
    }
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">yield</span> <span class="hljs-variable">$f</span>;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$f</span>);
    }
}

<span class="hljs-title function_ invoke__">using</span> (<span class="hljs-title function_ invoke__">opening</span>(<span class="hljs-keyword">__FILE__</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>) {
    <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$f</span>);
}
</code></pre>
<p>不过当前 RFC 认为对象形式已经足够，这个特性被列为未来可能的增强。</p>
<h2 data-id="heading-26">总结</h2>
<p>PHP Context Managers 为资源生命周期管理提供了一种优雅且统一的解决方案。通过 <code>using</code> 关键字和 <code>ContextManager</code> 接口，开发者可以：</p>
<ul>
<li><strong>减少样板代码</strong>：不再需要为每个资源操作编写重复的 try-finally 逻辑</li>
<li><strong>提高代码可靠性</strong>：保证清理代码一定会执行，即使发生异常</li>
<li><strong>提升可读性</strong>：业务逻辑更清晰，不再被资源管理细节干扰</li>
<li><strong>促进代码复用</strong>：将通用的资源管理模式封装成可复用的 Context Manager</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>文件操作</li>
<li>数据库事务</li>
<li>锁管理</li>
<li>临时配置修改</li>
<li>异步任务管理</li>
<li>任何需要"设置-使用-清理"模式的场景</li>
</ul>
<p>Context Managers 将随 <strong>PHP 8.6</strong> 发布，目前处于讨论阶段。如果你对此特性感兴趣，可以关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.php.net%2Frfc%2Fcontext_managers" target="_blank" title="https://wiki.php.net/rfc/context_managers" ref="nofollow noopener noreferrer">RFC 讨论</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Farnaud-lb%2Fphp-src%2Fpull%2F26" target="_blank" title="https://github.com/arnaud-lb/php-src/pull/26" ref="nofollow noopener noreferrer">实现代码</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[踩坑日记：为什么Git 突然 Push 不上去了]]></title>    <link>https://juejin.cn/post/7575112613777899554</link>    <guid>https://juejin.cn/post/7575112613777899554</guid>    <pubDate>2025-11-23T07:28:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613777899554" data-draft-id="7575106644499087394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="踩坑日记：为什么Git 突然 Push 不上去了"/> <meta itemprop="keywords" content="GitHub,Git,SSH"/> <meta itemprop="datePublished" content="2025-11-23T07:28:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小Lu的日常"/> <meta itemprop="url" content="https://juejin.cn/user/2585689638569422"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            踩坑日记：为什么Git 突然 Push 不上去了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2585689638569422/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小Lu的日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:28:34.000Z" title="Sun Nov 23 2025 07:28:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天在开发的时候遇到一个很离谱的问题，git push 明明昨天还好好的，结果今天突然完全推不上去。</p>
<p>报错信息如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ERROR:</span> no healthy upstream
<span class="hljs-symbol">fatal:</span> Could <span class="hljs-built_in">not</span> read <span class="hljs-keyword">from</span> remote repository.

Please make sure you have the correct access rights
<span class="hljs-built_in">and</span> the repository exists.
</code></pre>
<p>或者是</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ERROR:</span> upstream connect <span class="hljs-keyword">error</span> <span class="hljs-built_in">or</span> disconnect/reset before headers.
remote connection failure, transport failure reason: delayed connect <span class="hljs-keyword">error</span>: Connection refused
<span class="hljs-symbol">fatal:</span> Could <span class="hljs-built_in">not</span> read <span class="hljs-keyword">from</span> remote repository.
</code></pre>
<p>一开始我以为是 GitHub 挂了，或者我 SSH key 失效了。结果一切正常：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">ssh -T git@github.com

Hi shenlu89! You<span class="hljs-comment">'ve successfully authenticated, but GitHub does not provide shell access.</span>
</code></pre>
<p>我又查了一下远端Git仓库的URL是否正确：</p>
<pre><code class="hljs language-scss" lang="scss">git remote -v 
origin  git<span class="hljs-keyword">@github</span>.<span class="hljs-attribute">com</span>:shenlu89/docs.git (fetch)
origin  git<span class="hljs-keyword">@github</span>.<span class="hljs-attribute">com</span>:shenlu89/docs.git (push)
</code></pre>
<p>SSH 连接没有问题</p>
<ul>
<li>仓库地址没错</li>
<li>SSH 授权正常</li>
<li>git remote -v 正常</li>
</ul>
<p>那问题从哪里来？</p>
<p>正常来说，使用 SSH 方式 push，那只要 ssh -T 可用，push 一定可用，但我这里：</p>
<pre><code class="hljs language-java" lang="java">ssh -T git<span class="hljs-meta">@github</span>.com   <span class="hljs-comment">// 正常</span>
git push                <span class="hljs-comment">// 失败</span>
</code></pre>
<p>这说明 push 底层不是简单的 SSH 问题，而是 连接被代理或网络干扰了。</p>
<p>继续排查 macOS 系统代理：</p>
<pre><code class="hljs language-arduino" lang="arduino">networksetup -getwebproxy <span class="hljs-string">"Wi-Fi"</span>
networksetup -getsocksfirewallproxy <span class="hljs-string">"Wi-Fi"</span>
</code></pre>
<p>结果是：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Enabled:</span> <span class="hljs-literal">Yes</span>
<span class="hljs-attr">Server:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
<span class="hljs-attr">Port:</span> <span class="hljs-number">7890</span>
</code></pre>
<p>也就是说，macOS 系统级 HTTP/HTTPS/SOCKS 都指向了 127.0.0.1:7890。</p>
<p>这就导致所有 Git 连接走系统代理，系统代理为空，请求被直接拒绝，Git push 报 connection refused</p>
<p>这就是为什么 SSH 测试能连，但 git push 反而失败。</p>
<p>因为 SSH 测试命令不走系统代理，而 Git push 走了。</p>
<p>直接关掉 macOS 的代理即可：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">networksetup -setwebproxystate <span class="hljs-string">"Wi-Fi"</span> <span class="hljs-keyword">off</span>
networksetup -setsecurewebproxystate <span class="hljs-string">"Wi-Fi"</span> <span class="hljs-keyword">off</span>
networksetup -setsocksfirewallproxystate <span class="hljs-string">"Wi-Fi"</span> <span class="hljs-keyword">off</span>
</code></pre>
<p>然后：</p>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">push</span>
</code></pre>
<p>瞬间恢复正常。</p>
<p>还有一种方法，就是将 GitHub SSH 改用 443 端口，为了兼容各种奇怪网络环境（公司、学校、酒店 WiFi 等），我顺手也把 GitHub SSH 通道改到了 443 端口，编辑 ~/.ssh/config：</p>
<pre><code class="hljs language-bash" lang="bash">Host github.com
    HostName ssh.github.com
    Port 443
    User git
    IdentityFile ~/.ssh/id_ed25519
    IdentitiesOnly <span class="hljs-built_in">yes</span>
</code></pre>
<p>443 端口一般不会被封，也不受代理影响，比 22 端口稳定太多。</p>
<p>这样问题就成功解决了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[围小猫秘籍]]></title>    <link>https://juejin.cn/post/7575162322239979520</link>    <guid>https://juejin.cn/post/7575162322239979520</guid>    <pubDate>2025-11-23T08:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322239979520" data-draft-id="7575162322239963136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="围小猫秘籍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T08:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青青子衿悠悠我心"/> <meta itemprop="url" content="https://juejin.cn/user/4383112851623134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            围小猫秘籍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4383112851623134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青青子衿悠悠我心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:21:37.000Z" title="Sun Nov 23 2025 08:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">在线游戏 <a href="https://link.juejin.cn?target=https%3A%2F%2Fc.getline.cloud%2F" target="_blank" title="https://c.getline.cloud/" ref="nofollow noopener noreferrer">c.getline.cloud/</a></h4>
<h4 data-id="heading-1">社区代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwenyang0%2Fphaser-catch-the-cat" target="_blank" title="https://github.com/wenyang0/phaser-catch-the-cat" ref="nofollow noopener noreferrer">github.com/wenyang0/ph…</a></h4>
<h2 data-id="heading-2">围住一只猫猫需要几步？</h2>
<p>今天要讲的游戏叫做<strong>围小猫</strong>，2021年底在朋友圈里着实是火了一把，如果你还没有玩过，可以在搜索引擎中搜索“围小猫”。记忆力好的读者可能会记得，这款游戏并不是第一次火了，没错，它就是2014年曾在朋友圈大火过的“<strong>围住神经猫</strong>”的新皮肤！其原型可以追溯到更早。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50d89ac7f601408fb93618e7c043c26e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=Qsl3%2FrBH4GfLzZEmIqnodG%2F5sXo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">游戏介绍</h3>
<p>首先介绍一下游戏规则。</p>
<ul>
<li><strong>初始状态</strong>：小猫位于棋盘中心，6-8个障碍物会被预先随机放置在地图上。</li>
<li><strong>我方行动</strong>：每次点击小圆点就可以在该处放置一个障碍物。</li>
<li><strong>猫猫行动</strong>：小猫也会向地图边缘移动一格。</li>
<li><strong>胜负判定</strong>：
<ul>
<li><strong>胜利</strong>：猫猫被障碍物围住。</li>
<li><strong>失败</strong>：猫猫到达地图边缘溜走。</li>
</ul>
</li>
</ul>
<p>这样不断重复下去，直到游戏结束。</p>
<p>初上手的时候你会发现，这个游戏并不简单，几乎很难成功。因为棋盘其实并不大，猫只需要5步就可以跑出棋盘边界，很难将小猫堵住。</p>
<p>那么一个自然而然的问题是：<strong>如果棋盘足够大，可以保证将小猫堵住吗？</strong> 在回答这个问题之前，请让我先介绍一下“天使问题”。</p>
<h3 data-id="heading-4">天使问题</h3>
<p>天使问题首次见于1982年出版的《Winning Ways》一书，由书作者数学家<strong>约翰·H·康威</strong>（John H. Conway）提出。这是一个双方玩家分别扮演天使和恶魔的博弈游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22fb76a8d2a4b5ca01291480a98fb5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=YFvnMhhKAH5wq%2B7TVKiFFNmSyFM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>棋盘</strong>：游戏在一个无限大方格棋盘上进行，起始棋盘是空的。</li>
<li><strong>天使</strong>：定义正整数k为天使的<strong>阶数</strong>，k阶天使每步可以跳到k*k范围内的任何一格，无论路上有没有障碍物。</li>
<li><strong>恶魔</strong>：每一轮中，恶魔可以在棋盘上放置一个障碍物，但不可放在当前天使所在的位置。</li>
<li><strong>胜负</strong>：
<ul>
<li>若在一轮中，天使无法移动，则<strong>恶魔获胜</strong>。</li>
<li>如果天使能无限地继续游戏，则<strong>天使获胜</strong>。</li>
</ul>
</li>
</ul>
<p>康威已经证明（虽然他说是该书的共同作者伯利坎普展示给他的），只要棋盘大小大于32*33，k=1的情况下恶魔是必胜的。</p>
<p>为方便展示，这里将格点化为方格。如图2所示是一个33*33的棋盘，天使起始位于红色方格。无论天使开局怎么走，恶魔前8步只需将棋盘四周的8个黑格填上障碍物，这时天使必然位于中间的蓝色区域内，距离接触包围圈还有7步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e127c1aa3e14800b0b33c4200a5ef70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=nNErLXb8nngKVGjdUFYjxR%2F19n0%3D" alt="image.png" loading="lazy"/></p>
<p>而无论天使向哪个方向逃，恶魔都可以隔一格放一个障碍物这样逐渐缩小缺口，保证在天使接触棋盘边缘之前将缺口堵上，因此恶魔是必胜的。</p>
<h3 data-id="heading-5">回到围小猫</h3>
<p>一阶的天使问题告诉我们，只要棋盘足够大，让我们可以提前布置好包围圈，就一定能围住天使。而且天使问题中的棋盘是<strong>八连通</strong>的，即天使向横竖斜八个方向都可以移动，所以布置一个包围圈至少需要八步。而围小猫中的棋盘是<strong>六连通</strong>的，因此包围圈只需要6步。</p>
<p>我们定义<strong>猫猫从空白棋盘中心逃脱的最少步数为棋盘的深度n</strong>，可以看到，围小猫游戏的棋盘深度为5。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fae7ede7e26740388e006f99eea8d394~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=PyQoqXub0pokR%2BPDZ5sFYih9R7I%3D" alt="image.png" loading="lazy"/>
丰富的游戏经验告诉我，n=5显然是不够的。如果要保证必胜，像天使问题里一样布置一个包围圈至少需要6个障碍物，也就是6步。因为猫n步就会逃出棋盘，而我们必须在猫逃脱之前花至少一步堵住逃脱的方向，所以棋盘的深度n至少应该为6+1+1=8。</p>
<p>那么棋盘需要有多大才能保证必胜呢？答案就是<strong>n=8</strong>。图中偶数号格点为我方放的障碍物，奇数号格点依次为猫猫的行动轨迹，可以看到这种情况下，我方是必定获胜的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31f9c308eef741b6ada10e7d52125285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=9uwMqLRD9PuNalIxJ4%2Byhl70rps%3D" alt="image.png" loading="lazy"/></p>
<p>所以，<strong>只要棋盘的深度不小于8，即使是一个空白的棋盘，我们也是必定可以围住小猫的。</strong> 相应地，在没有障碍物的情况下，棋盘深度小于8时我们是不可能围住小猫的。</p>
<h3 data-id="heading-6">那么，有障碍物呢？</h3>
<p>终于回到了我们最初的问题：<strong>如何在一个n=5的棋盘上利用已有的障碍物围住猫猫。</strong></p>
<p>其实这里的思路还是一样的，那就是：先用若干步布置一个包围圈，然后通过围堵来完善包围圈。唯一的不同是，由于棋盘不够大，我们必须利用已有的障碍物来布置包围圈。和棋盘的深度一样，我们定义<strong>包围圈的深度为猫猫逃出包围圈的最少步数</strong>。很显然，包围圈越深，留给我们布置防线的步数就越多。</p>
<p>先来研究一下包围圈应该是什么样子的：</p>
<ul>
<li>包围圈应当是<strong>六边形</strong>，与棋盘形状相同。</li>
<li>每条边都<strong>必须经过每个经过格点的圆心</strong>，不允许斜着直接连。</li>
<li>只有包围圈的<strong>每个顶点</strong>（如下面图6中的1-6号点）或者<strong>与该顶点相邻且在包围圈上的格点</strong>（如下图6中的7-15号点）有障碍物，才能起到挡住猫猫的效果。如果上述位置没有障碍物的话，就无法保证在猫猫被追赶到此处时闭合包围圈。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d09e8af6011b4b119ccf62883bf5cba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=JOK236hgmRgUmBs3BPJZs54B2Eg%3D" alt="image.png" loading="lazy"/></p>
<p>如果一个顶点或与其相邻且在包围圈上的格点上有障碍物，我们就称这个顶点<strong>已完成</strong>，定义一个<strong>包围圈的完成度为已完成的顶点数量</strong>。下面我们举一个例子来说明。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec958e4073ee411098b78f7bd63b384c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=83Q0LPntbRJWr3FART%2FDFmikozI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/734496a7e84d4208bb2c939f161cb2da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=%2ByXb1a4rcbk6%2FrgCQddumcVvEYk%3D" alt="image.png" loading="lazy"/>
图6是一个包围圈的雏形，可以看到1，2，11，4，5号点都有障碍物，他们对应的顶点都已完成。但它并不是一个完整的包围圈，因为顶点6是未完成的。如果猫猫从右上往左上逃，我们堵住8号点后猫猫会逃至16号点，此时6，7两点均空，猫猫逃脱。顶点5虽然有障碍物，但它本身也是一个顶点，不能算作顶点6的相邻点。所以这个包围圈的完成度是5。</p>
<p>从棋盘深度为8的情形我们可以知道，在包围圈完成，即完成度为6时，如果猫猫距离包围圈至少有2格，我们根据猫猫的位置放障碍物来围堵就可以必胜。也就是说，<strong>必胜条件是包围圈深度 + 包围圈完成度至少为8</strong>。</p>
<p>所幸，上图中的猫猫距离包围圈有3格，也就是说包围圈的深度是3，如下图所示，我们只需补上包围圈里缺失的点，就可以保证必胜。这就是看过本文的我们，第一步落在看似不需要优先围堵的6号点的原因。</p>
<p>需要注意的是，<strong>画包围圈也是有技巧的</strong>。比如下面这个图8就有AB两种画圈的方式，且包围圈的完成度均为5。</p>
<ul>
<li>如果按照<strong>红色的A方案</strong>规划4，5号点之间的包围圈，则包围圈的深度为2，5+2&lt;8，无法围住猫猫。</li>
<li>如果按照<strong>蓝色的方案B</strong>，则包围圈的深度为3，5+3=8，可以围住猫猫。</li>
</ul>
<p>所以画圈的方式也是很重要的哦！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c253ad1207f44269b9d87554e1898ed1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=LyA3Cx6A0sxctaAGCGbjAfcPqC8%3D" alt="image.png" loading="lazy"/></p>
<p>然而，由于游戏条件的限制，初始只有6-8个障碍物，棋盘深度也只有5，所以大多数情况下都是无法必胜的，如果想围住小猫，就多多地刷新吧！</p>
<p>不过，实际上游戏里的这只小猫并不太聪明，它的逃脱逻辑只是一个<strong>单层的贪心算法</strong>：只考虑当前看来是最好的逃脱路线。所以我们可以利用这点设下陷阱，诱导猫猫走出多余的步数，从而赢下无法必胜的棋盘，有兴趣的读者朋友一定要去试一试哦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8da92d294b4d5497ad26d245eb7d5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S6Z2S5a2Q6KG_5oKg5oKg5oiR5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490897&amp;x-signature=ioO5GPCWelHSQpxc5iKQUWAyz3s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">围住猫猫的秘诀！</h3>
<p>最后，让我们总结一下围住猫猫的秘诀吧！只需要简单的三步哦。</p>
<ol>
<li><strong>第一步</strong>：根据已有的初始障碍物划定包围圈，在保证有尽可能多顶点被完成的前提下，让包围圈的深度尽可能地大。</li>
<li><strong>第二步</strong>：判断<strong>包围圈完成度 + 包围圈的深度</strong>是否<strong>≥8</strong>？如果小于则无法保证围住猫猫，直接重置。</li>
<li><strong>第三步</strong>：先将包围圈完成，然后对应猫猫所在位置进行围堵即可获胜。</li>
</ol>
<h3 data-id="heading-8">写在最后</h3>
<p>还记得开头说的天使问题吗？这个问题其实并没有被完全解决。目前在天使的阶数k比较小，比如k=2的时候，数学家已经证明天使在无限大棋盘上是必胜的，但是对于任意有限阶的天使，哪方能必胜这个问题尚无答案。</p>
<p>也许，能够解决这个问题的就是聪明的你。</p>
<p><strong>解决不了也没关系，至少，你学会如何抓住猫猫了，对吧？</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题]]></title>    <link>https://juejin.cn/post/7575367791272804390</link>    <guid>https://juejin.cn/post/7575367791272804390</guid>    <pubDate>2025-11-23T09:55:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791272804390" data-draft-id="7575182522411335718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题"/> <meta itemprop="keywords" content="后端,Java,面试"/> <meta itemprop="datePublished" content="2025-11-23T09:55:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叫煤球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058745054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058745054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叫煤球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:55:30.000Z" title="Sun Nov 23 2025 09:55:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. JDK 1.2：ThreadLocal 初版（最小可用）</h2>
<p><strong>核心特点：</strong></p>
<ul>
<li><code>ThreadLocal</code> 首次出现。</li>
<li>每个线程维护自己的 <code>ThreadLocalMap</code>。</li>
<li><code>ThreadLocalMap</code> 的 key 就是 <code>ThreadLocal</code> 本身。</li>
<li>底层使用开放地址法的哈希表（<code>Entry[] table</code>）。</li>
<li><strong>key 不是弱引用</strong>，导致 ThreadLocal 对象不释放时可能造成内存泄漏。</li>
</ul>
<p><strong>主要问题：</strong></p>
<ul>
<li>ThreadLocal 实例如果被 GC 回收前未手动 <code>remove()</code>，线程（尤其是线程池）不会结束，Entry 永远存在，导致 value 泄漏。</li>
</ul>
<p>这也是行业里常说的 ThreadLocal 泄漏最初来源。</p>
<hr/>
<h2 data-id="heading-1">2. JDK 1.3 ~ 1.4：Bug 修复 + 行为稳定</h2>
<p><strong>关键改动：</strong></p>
<ul>
<li>增强清理机制，但依然是 key 强引用。</li>
<li>修复部分扩容和冲突处理问题。</li>
</ul>
<p>但根本性的泄漏问题仍然存在。</p>
<hr/>
<h2 data-id="heading-2">3. JDK 5：引入弱引用（关键里程碑）</h2>
<p>这是 ThreadLocal 设计史上最重要的变更。</p>
<p><strong>重大更新：</strong></p>
<ul>
<li>
<p><code>ThreadLocalMap.Entry</code> 改为 <strong>弱引用</strong>：</p>
<pre><code class="hljs language-scala" lang="scala">static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</span> </span>{
    <span class="hljs-type">Object</span> value;
}
</code></pre>
</li>
<li>
<p>一旦 ThreadLocal 对象不再被外部引用，可以被 GC 回收，Entry 的 key 会变成 <code>null</code>。</p>
</li>
</ul>
<p><strong>为什么改成弱引用？</strong></p>
<ul>
<li>防止 ThreadLocal 对象不释放导致整组 Entry 无法被清理。</li>
</ul>
<p><strong>带来的副作用：</strong></p>
<ul>
<li>value 仍然是强引用，只要线程活着，value 永远不会被回收。</li>
<li>如果你不手动 <code>remove()</code>，依旧可能内存泄漏（尤其线程池）。</li>
</ul>
<p>至此，ThreadLocal 的内存泄漏问题变成了：</p>
<ul>
<li><strong>不是 key 泄漏，而是 value 泄漏。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">4. JDK 6：清理机制增强 + TAB 数组 rehash 改善</h2>
<p><strong>JDK6 的重要演进：</strong></p>
<ul>
<li>加强对 key 为 <code>null</code> 的 Entry 的清理逻辑（例如访问冲突位点时主动清理）。</li>
<li>优化 rehash 和探测机制。</li>
</ul>
<p>整体结构仍为开放地址法，不改变本质机制。</p>
<hr/>
<h2 data-id="heading-4">5. JDK 7：性能优化 + 部分线程局部缓存行为改进</h2>
<p>JDK7 的变化偏向实现层。</p>
<p><strong>增强点：</strong></p>
<ul>
<li>完善冲突探测，降低哈希冲突导致的退化。</li>
<li>改善 nextIndex/prevIndex 的性能。</li>
<li>修复扩容后 rehash 的一些 bug。</li>
</ul>
<p>ThreadLocalMap 变得更健壮，但不改变语义。</p>
<hr/>
<h2 data-id="heading-5">6. JDK 8：清理策略进一步加强，核心逻辑成熟稳定</h2>
<p><strong>关键变化：</strong></p>
<ul>
<li>
<p>ThreadLocalMap 清理 <code>stale entry</code>（key = null）的策略更加激进：</p>
<ul>
<li>get/set/remove 时都会尝试清理死 key。</li>
</ul>
</li>
<li>
<p>内部 rehash 策略更高效。</p>
</li>
<li>
<p>线程池场景下的内存泄漏仍然需要手动处理 (<code>remove()</code>)，但 default 逻辑更健壮。</p>
</li>
</ul>
<p><strong>JDK8 的 ThreadLocal 基本成为行业主流参考实现。</strong></p>
<hr/>
<h2 data-id="heading-6">7. JDK 9：新增 <code>ThreadLocal.withInitial()</code>（语法糖）</h2>
<p>此版本以后属于稳定期，新增功能而非机制变化。</p>
<p><strong>新增：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ThreadLocal<span class="hljs-selector-class">.withInitial</span>(() -&gt; new <span class="hljs-built_in">SimpleDateFormat</span>("yyyy-MM-dd"))
</code></pre>
<p>机制不变，易用性提升。</p>
<hr/>
<h2 data-id="heading-7">8. JDK 11 / JDK 17：几乎无变化，属于稳定维护期</h2>
<ul>
<li>持续做小修复，增强可读性与边界处理。</li>
<li>内存清理策略与 JDK8 几乎无差别。</li>
<li>语义和行为已经非常稳定。</li>
</ul>
<hr/>
<h2 data-id="heading-8">9. JDK 21：虚拟线程（Loom）下的 ThreadLocal 语义扩展（重要）</h2>
<p>在 Loom（虚拟线程）中：</p>
<p><strong>ThreadLocal 默认机制仍然可用，但成本更低：</strong></p>
<ul>
<li>虚拟线程是轻量结构，保留自己的 ThreadLocalMap。</li>
<li>虚拟线程不复用，生命周期短，因此不容易产生 ThreadLocal value 泄漏。</li>
</ul>
<p><strong>关键点：</strong></p>
<ul>
<li>虚拟线程不是池化线程，不会出现线程池泄漏问题。</li>
<li>某些场景 ThreadLocal 成本反而比传统线程更轻。</li>
</ul>
<hr/>
<h2 data-id="heading-9">10. 前后机制的核心变化总结</h2>


















































<table><thead><tr><th>JDK 版本</th><th>变化点</th><th>影响</th></tr></thead><tbody><tr><td>1.2</td><td>基本实现</td><td>存在严重泄漏风险</td></tr><tr><td>1.3-1.4</td><td>Bug 修复</td><td>稳定性增强</td></tr><tr><td>5</td><td><strong>key 改为弱引用</strong></td><td>避免 key 泄漏，但 value 泄漏依旧</td></tr><tr><td>6</td><td>加强化清理逻辑</td><td>降低内存泄漏风险</td></tr><tr><td>7</td><td>进一步优化冲突处理</td><td>性能提升</td></tr><tr><td>8</td><td><strong>成熟实现，清理更激进</strong></td><td>标准实现，被行业普遍使用</td></tr><tr><td>9+</td><td>易用性提升（withInitial）</td><td>开发体验增强</td></tr><tr><td>21</td><td>虚拟线程支持稳定</td><td>泄漏风险显著降低</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">11. 哪些问题贯穿所有版本？</h2>
<p>无论哪个版本，ThreadLocal 永远有两个核心风险：</p>
<ol>
<li><strong>value 会泄漏，只要线程还活着</strong></li>
<li><strong>线程池复用导致 value 长期驻留</strong></li>
</ol>
<p>这两个问题在 JDK21 的虚拟线程中弱化但未彻底消失。</p>
<hr/>
<h2 data-id="heading-11">12. 业内最佳实践</h2>
<ol>
<li>创建后必须手动 <code>remove()</code></li>
<li>避免在容器/框架级别缓存业务值</li>
<li>避免使用无界线程池结合 ThreadLocal</li>
<li>不要把 ThreadLocal 当成上下文传递机制（应使用 ThreadLocal 设计的框架）</li>
<li>推荐使用 <code>withInitial()</code> 避免 null 值</li>
</ol>
<hr/>
<h2 data-id="heading-12">13. 讲清楚本质</h2>
<p><strong>ThreadLocal 在整个 JDK 生命周期中的核心变化只有一次：JDK5 引入弱引用。</strong></p>
<p>其余版本改动都是：</p>
<ul>
<li>更激进的清理策略</li>
<li>更健壮的哈希探测与 rehash</li>
<li>更易用的 API</li>
<li>虚拟线程场景下的运行时表现改善</li>
</ul>
<p>但行为本质没有改变：</p>
<ul>
<li>每个线程维护一个 Map</li>
<li>key 弱引用</li>
<li>value 强引用</li>
<li>需要手动 remove，线程池中更应当如此</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从海量时序数据到无人值守：数据库在新能源集控系统中的架构实践]]></title>    <link>https://juejin.cn/post/7575442779038761002</link>    <guid>https://juejin.cn/post/7575442779038761002</guid>    <pubDate>2025-11-23T08:22:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575442779038761002" data-draft-id="7575442779038744618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从海量时序数据到无人值守：数据库在新能源集控系统中的架构实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-23T08:22:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从海量时序数据到无人值守：数据库在新能源集控系统中的架构实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:22:35.000Z" title="Sun Nov 23 2025 08:22:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b59e5aa258b845fc8c7f38558707f456~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490954&amp;x-signature=EjncswH7gCo%2BAzdkVNhJOGIhN3Y%3D" alt="640.gif" loading="lazy"/></p>
<p>@[toc]</p>
<h2 data-id="heading-0">引言</h2>
<p>谈到“双碳”与能源革命，风电，光伏这些新能源产业显然是当下最为炙手可热的风口，若想在该赛道跑得更远，更快，数字化和智能化转型并非可选，而是必备功课，要知道，从远程操控成千上万台风电机组，到及时分析大量的设备数据，直至把整个生产运维流程管理得井井有条，哪一步能离开稳定，高效且安全的数据“大后方”呢？</p>
<p>于是，一些问题便随之出现，新能源相关业务对于数据库的要求非常高，其一，物联网设备每日所生成的时序数据量犹如天文数字，其二，生产经营体系要承受高并发访问的压力，那些位于四面八方场站还要执行好容灾备份工作，这就像要求一名后卫不但要速度快而且体格健硕，关键时候也不能出现纰漏。</p>
<p>在此种大背景之下，我们高兴地发现，国产数据库正依靠自身的技术实力与服务，渐渐化为新能源行业数字化转型的中坚力量，金仓数据库（Kingbase）便是其中不可忽略的一个存在，其犹如一位身怀绝技的“扫地僧”，凭借在高性能，高可靠性，高安全性以及智能运作维护方面所积淀的深厚功底，给众多新能源企业的关键系统给予了稳固有力的支持，很好地解决了许多令人头疼的问题。</p>
<hr/>
<h2 data-id="heading-1">关于金仓数据库</h2>
<p>那么，这个金仓数据库到底是什么来头？</p>
<p>简单来说，Kingbase是电科金仓（北京）科技股份有限公司的当家产品。这家公司来头不小，不但是国内最早一批做自主数据库的厂商，还是中国电子科技集团（CETC）的“国家队”成员。他们的目标很明确，就是要做顶尖的企业级数据库产品。</p>
<p>其旗舰产品金仓数据库管理系统KingbaseES（简称KES），就是一款专为事务密集、高并发、高可用的复杂场景打造的企业级关系型数据库。它有几手“独门绝技”：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa25b64f0e334c88b3e0d54130d4d5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490954&amp;x-signature=aLBSol7mNTMuluaP9OmhvBlgun4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/755f78bc8e8549ada0abdf17cd814a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490954&amp;x-signature=LOv6GV1IzvMLOXea9rlSF5A8KQs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>卓越性能与自治调优</strong>：听起来很专业，其实可以理解为KingbaseES的内核里藏着一个“调优机器人”。它能自己诊断、自己优化，把以前需要数据库专家熬夜干的活儿，变成了数据库自己的日常工作。这样一来，就算面对几千人同时操作的极端情况，系统也能反应飞快。</p>
</li>
<li>
<p><strong>金融级高可用保障</strong>：新能源业务可是一天24小时、一年365天都不能停的。为了确保万无一失，KingbaseES拿出了一套金融级别的“不死鸟”方案。它支持“一主多备”的集群模式，主服务器的数据能实时同步到备用服务器上，万一主服务器“罢工”，备用服务器能秒级顶上，数据一个都不会丢。它甚至还能搞定跨越上千公里的异地容灾，真正做到高枕无忧。</p>
</li>
<li>
<p><strong>全方位数据安全</strong>：数据安全是命脉。KingbaseES就像给数据穿上了一层层“金钟罩铁布衫”，从访问控制、数据加密到安全审计，防护措施一应俱全，达到了国家信息系统安全等级保护的四级要求。把核心生产数据交给它，心里踏实。</p>
</li>
<li>
<p><strong>高度兼容与平滑迁移</strong>：很多企业最头疼的就是换系统，怕原来的应用跑不起来。KingbaseES早就想到了这一点，它对Oracle的语法兼容性做得非常好，还配了个叫KDTS的“搬家神器”。这个工具能把原来跑在MySQL、PostgreSQL甚至MongoDB上的数据和应用，以极低的成本、甚至“零代码修改”的代价，快速迁移过来，让国产化替代不再是件愁人的事。</p>
</li>
</ul>
<p>正是靠着这些硬核实力，金仓数据库才成了众多关键行业核心系统的放心之选。</p>
<hr/>
<h2 data-id="heading-2">金仓数据库在新能源行业的技术解读</h2>
<p>咱们再往深了聊聊，金仓数据库在新能源行业里，到底是怎么“秀肌肉”的。</p>
<p>一般来说，新能源的数字化系统，比如集控中心、运维平台，有四个“老大难”问题：时序数据多到爆炸、高并发访问压力山大、业务一秒都不能停、老旧系统五花八门。面对这些，KingbaseES见招拆招，用自己的一套组合拳给出了漂亮的答案。</p>
<h3 data-id="heading-3">1. 应对海量时序数据：分区存储与高效查询</h3>
<p><strong>业务挑战</strong>：风机、光伏板这些设备，个个都是数据“生产大户”，每时每刻都在往外蹦各种工况数据。这些数据是宝贝，是设备监控、故障预警的基础。但数据量实在太大了，怎么存、怎么查，才能又快又好，是个大难题。</p>
<p><strong>金仓解决方案</strong>：KingbaseES用了一个聪明的办法——<strong>表分区</strong>。它把一张巨大的数据表，按时间（比如按天或按月）切成一小块一小块。这样做的好处显而易见：</p>
<ul>
<li><strong>写入查询都飞快</strong>：新数据只往最新的那一小块里写，互不干扰。查询的时候，只要告诉它时间范围，它就能精准地找到对应的那几块数据，不用再大海捞针一样地全表扫描。</li>
<li><strong>管理数据超轻松</strong>：过期的历史数据想删掉？简单！以前用<code>DELETE</code>得删半天，还留下一堆“垃圾”。现在直接把对应的旧分区整个端掉就行，秒速完成，干净利落。</li>
</ul>
<p><strong>代码示例：创建按月分区的设备数据表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建一个按月分区的设备数据主表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> device_metrics (
    device_id   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    metric_time <span class="hljs-type">TIMESTAMP</span>   <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    metric_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">value</span>       <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">18</span>, <span class="hljs-number">6</span>)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (metric_time);

<span class="hljs-comment">-- 为2025年11月和12月创建分区</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> device_metrics_202511 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> device_metrics
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-11-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2025-12-01'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> device_metrics_202512 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> device_metrics
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-12-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2026-01-01'</span>);

<span class="hljs-comment">-- 当查询特定时间范围的数据时，优化器会自动选择对应的分区</span>
<span class="hljs-comment">-- 例如，此查询将仅扫描 device_metrics_202511 分区</span>
<span class="hljs-keyword">SELECT</span> device_id, <span class="hljs-keyword">value</span>
<span class="hljs-keyword">FROM</span> device_metrics
<span class="hljs-keyword">WHERE</span> metric_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-11-10'</span> <span class="hljs-keyword">AND</span> metric_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-11-11'</span>;
</code></pre>
<h3 data-id="heading-4">2. 支撑高并发访问：读写分离与自治调优</h3>
<p><strong>业务挑战</strong>：一个生产运维系统，可能同时有几千号人在线操作，有查报表的，有开工单的，有做检修的。这么多请求一股脑儿地涌过来，数据库要是扛不住，整个系统就得卡顿甚至瘫痪。</p>
<p><strong>金仓解决方案</strong>：KingbaseES有两大法宝来应对：<strong>读写分离集群</strong>和<strong>内核自治调优</strong>。</p>
<ul>
<li>
<p><strong>读写分离集群架构</strong>：这个战术很简单，就是“分工合作”。搞一个“一主多备”的集群，主节点是“总指挥”，专门处理“写”这种关键操作。其他几个备节点当“参谋”，从主节点那儿同步数据，然后专门负责“读”这种查询、看报表的工作。这样一来，就把压力分散出去了，大家都能轻松上阵。</p>
<pre><code class="hljs language-scss" lang="scss">+----------------+      /---&gt; <span class="hljs-selector-attr">[备节点1 (只读)]</span>
|   应用服务     |     /
| (读写请求)     |---&gt; <span class="hljs-selector-attr">[主节点 (读写)]</span> ---&gt; <span class="hljs-selector-attr">[备节点2 (只读)]</span>
+----------------+     \
                        \---&gt; <span class="hljs-selector-attr">[备节点3 (只读)]</span>
                                 |
                                 V
                            <span class="hljs-selector-attr">[物理日志流同步]</span>
</code></pre>
</li>
<li>
<p><strong>自治调优能力</strong>：这就是前面提到的“调优机器人”。它能自动优化SQL，还能根据历史经验“学习”进化，让执行计划越来越聪明。甚至在你写的SQL性能不佳时，它还会主动给你提建议，比如“这里该建个索引了”，大大减轻了数据库管理员的负担。</p>
</li>
</ul>
<h3 data-id="heading-5">3. 保障业务连续性：跨地域高可用与容灾</h3>
<p><strong>业务挑战</strong>：核心生产系统，就跟人的心脏一样，一秒钟都不能停。不仅要防止本地出故障，还得能扛得住地震、断电这种区域性的天灾人祸。</p>
<p><strong>金仓解决方案</strong>：KingbaseES提供的是一套经过实战检验的“两地三中心”或“异地双中心”高可用方案。</p>
<ul>
<li>
<p><strong>在生产中心</strong>：部署一个“一主两备”的本地高可用集群。主备之间的数据实时同步。万一主节点“牺牲”，系统几秒内就能自动把备用节点扶正，业务几乎感觉不到中断，数据也零丢失。</p>
</li>
<li>
<p><strong>在异地灾备中心</strong>：在几百甚至上千公里外的另一个城市，再部署一个灾备节点。生产中心的数据会准实时地复制过去。这样，就算整个生产中心都“沦陷”了，还能从容地把业务切换到灾备中心，保住最后的火种。</p>
<pre><code class="hljs language-scss" lang="scss">+---------------------------+      <span class="hljs-selector-attr">[广域网 (WAN)]</span>      +---------------------------+
|      生产中心 (城市A)     |                          |      灾备中心 (城市B)     |
|                           |                          |                           |
|  <span class="hljs-selector-attr">[主]</span> ---&gt; <span class="hljs-selector-attr">[备1]</span> ---&gt; <span class="hljs-selector-attr">[备2]</span> | <span class="hljs-built_in">--</span>(异步物理日志复制)--&gt; |           <span class="hljs-selector-attr">[备3]</span>           |
|  (同步/异步物理日志复制)  |                          |                           |
+---------------------------+                          +---------------------------+
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">4. 实现平滑迁移：高度兼容与自动化工具</h3>
<p><strong>业务挑战</strong>：很多新能源企业一路发展过来，系统里用了MySQL、Oracle、PostgreSQL等各种数据库，五花八门，形成了“数据孤岛”。现在想建一个统一的平台，把这些老系统里的宝贝数据和应用都搬过来，简直是浩大又头疼的工程。</p>
<p><strong>金仓解决方案</strong>：KingbaseES在设计之初就想到了这一点。</p>
<ul>
<li>
<p><strong>它高度兼容Oracle</strong>：从语法、数据类型到存储过程，都跟Oracle很像。这意味着，原来给Oracle写的应用，基本上不用怎么改，甚至不用改，就能直接在KingbaseES上跑起来。</p>
</li>
<li>
<p><strong>它有自动化“搬家”工具KDTS</strong>：这个工具非常强大，能自动搞定数据结构映射、数据迁移、数据校验这些繁琐的活儿。原来可能要花几个星期才能干完的迁移工作，现在几天甚至更短时间就能搞定，风险和成本都大大降低。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-7">案例分析：金仓数据库赋能新能源智慧运维</h2>
<p>“光说不练假把式”。理论说了这么多，我们来看看金仓数据库在真实战场上的表现到底怎么样。其实，它早就在国家能源集团、中国广核集团、国家电力投资集团等多个大型能源企业的核心系统中“身经百战”了。下面这几个案例，就很有代表性。</p>
<h3 data-id="heading-8">案例一：中广核新能源生产运维系统——应对“整合、高并发、高可用”三大挑战</h3>
<ul>
<li>
<p><strong>业务背景</strong>：中广核的新能源业务摊子铺得很大，风、光、水多点开花，管着600多个场站。但以前的生产系统都是各搞各的，技术五花八门，数据不通，管理起来很费劲。所以，他们下决心要搞一个统一的生产运维系统。</p>
</li>
<li>
<p><strong>核心挑战</strong>：</p>
<ol>
<li><strong>系统整合难</strong>：要把原来基于MySQL、PostgreSQL、MongoDB等各种数据库的应用和数据都统一起来，这活儿想想就头大。</li>
<li><strong>并发访问高</strong>：新系统上线，得撑住6000多号员工同时在线操作，还要求反应速度要快。</li>
<li><strong>可用性要求极致</strong>：这可是核心生产系统，必须做到金融级的99.999%可用性，还得能跨上千公里搞异地容灾。</li>
</ol>
</li>
<li>
<p><strong>金仓解决方案与成效</strong>：</p>
<ul>
<li><strong>平滑迁移，零代码修改</strong>：金仓的团队带着“搬家神器”KDTS一进场，很快就把各个“山头”的数据和应用都收编了过来，软件开发商的应用甚至做到了“零代码修改”，一下子就让大家悬着的心放下了。</li>
<li><strong>自治调优，性能卓越</strong>：面对6000人并发的压力测试，KingbaseES的“调优机器人”大显身手，只花了3天就完成了性能优化，让系统在高压下也能秒级响应。</li>
<li><strong>异地双中心，稳定可靠</strong>：通过部署“生产中心+灾备中心”的架构，KingbaseES给系统上了双保险，确保了7x24小时的稳定运行。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e691206c448246ff96d772447f3d78d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490954&amp;x-signature=%2FDpJ%2F8Q9yE1Ic0S9%2B1z26PEB0xM%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">案例二：国家能源集团龙源电力——186个新能源场站集控系统国产化替代</h3>
<ul>
<li>
<p><strong>业务背景</strong>：龙源电力是全球最大的风电运营商，他们要在全国27个省区的186个场站搞一套新的集控系统，把数据都统一管起来。</p>
</li>
<li>
<p><strong>核心挑战</strong>：</p>
<ol>
<li><strong>部署范围广</strong>：项目遍布大江南北，对部署、运维和本地化服务的响应能力是个巨大考验。</li>
<li><strong>核心系统可靠性</strong>：场站的集控核心系统绝对不能出问题，原来用的Oracle虽然稳，但维保成本高，还有“卡脖子”的风险。</li>
<li><strong>数据安全</strong>：这些可都是核心生产数据，安全等级要求非常高。</li>
</ol>
</li>
<li>
<p><strong>金仓解决方案与成效</strong>：</p>
<ul>
<li><strong>主备高可用，保障业务连续</strong>：每个场站都用KingbaseES搞了“双机主备”架构，成功换掉了Oracle，既保证了业务不中断，也做好了数据备份。</li>
<li><strong>高度兼容Oracle，快速迁移</strong>：因为KingbaseES和Oracle很“像”，整个替换过程非常顺滑，应用基本没怎么改。</li>
<li><strong>全国服务网络，本地化支持</strong>：金仓遍布全国的服务网络发挥了巨大作用，为27个省区的项目提供了7x24小时的本地支持，确保了项目顺利落地。</li>
<li><strong>安全合规</strong>：KingbaseES自带的各种安全功能，完全满足国家对核心数据安全的要求，让人放心。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a5ff48045c54bd981adffc1e19a548d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490954&amp;x-signature=TVeoY%2Bwwk64gHOKu8IGRBTTgL5E%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">案例三：国家电投集团甘肃新能源——“无人值守”风电场集控系统</h3>
<ul>
<li>
<p><strong>业务背景</strong>：为了在偏远地区实现风电场“无人值班、少人值守”的智慧运维，国家电投甘肃新能源公司需要一套高度自动化的集控系统。</p>
</li>
<li>
<p><strong>核心挑战</strong>：</p>
<ul>
<li><strong>数据一致性</strong>：“无人值守”模式下，数据绝对不能出错，否则一个错误的指令就可能造成巨大损失。</li>
<li><strong>业务连续性</strong>：自动化调度系统必须像永动机一样不停运转。</li>
</ul>
</li>
<li>
<p><strong>金仓解决方案与成效</strong>：</p>
<ul>
<li><strong>高可用架构，替代Oracle</strong>：同样，KingbaseES的高可用方案成功替代了Oracle，既保证了系统冗余，也确保了数据安全可靠。</li>
<li><strong>原厂本地化服务</strong>：金仓的运维团队提供了“秒级响应”的本地服务，成了系统稳定运行的坚实后盾，也为后续更大范围的国产化铺平了道路。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">结语</h2>
<p>写到最后，就会察觉，在形成新型电力系统这一时代洪流当中，数字化和智能化是极为关键的“船”与“桨”。</p>
<p>回顾金仓数据库的技术要点及其在新能源领域的实际应用情况，不论是解决复杂的异构数据迁移问题，承受大量的并发访问压力，还是保障“无人值守”风电场的稳定运行，该数据库均表现出色，这表明其作为国产数据库的领先者，具备成为新能源行业核心业务稳固根基的能力与实力。</p>
<p>未来的新能源世界必定会愈加重视数据，金仓数据库这般既精通技术又了解行业的人才将会一直发挥关键作用，凭借其稳定，可靠且高效的数据能力不断给中国新能源事业增添活力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大场面试之最终一致性与分布式锁]]></title>    <link>https://juejin.cn/post/7575655132748300324</link>    <guid>https://juejin.cn/post/7575655132748300324</guid>    <pubDate>2025-11-23T08:23:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132748300324" data-draft-id="7575442779038777386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大场面试之最终一致性与分布式锁"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-23T08:23:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大场面试之最终一致性与分布式锁
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:23:56.000Z" title="Sun Nov 23 2025 08:23:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">1.分布式相关理论(重点)</h2>
<h3 data-id="heading-1">1.1 CAP定理<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cfd7d997b8f4b9ba2281d931a5eafd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=AOupmtP2Us8lA%2BlAYx1Z2SX2ei0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h3>
<p>CAP定理，也称为布鲁尔定理，是分布式计算领域的一个基本原理，用于描述在分布式系统设计中的三个基本要素：一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）之间的权衡关系。</p>
<p>CAP定理表明，在一个分布式计算系统中，不可能同时满足一致性、可用性和分区容错性这三个要求，最多只能同时满足其中的两个。具体而言：</p>
<ol>
<li>一致性（Consistency）指的是在分布式系统中的所有节点，在同一时间点上是否具有相同的数据副本。如果系统在更新数据后，所有节点立即能够看到最新的数据，那么系统就是强一致性的；如果系统在更新数据后，不同节点的数据同步存在一定的延迟，那么系统就是弱一致性的。</li>
<li>可用性（Availability）指的是系统能够在有限的时间内对外提供服务，即系统能够处理请求并返回合理的响应。可用性要求系统在面对故障或异常情况时，仍能够保持正常的运行状态，对外提供服务。</li>
<li>分区容错性（Partition Tolerance）指的是系统能够在面对网络分区（节点之间的通信故障）时，仍能够继续运行，并保持数据一致性和可用性。分布式系统中的网络分区是不可避免的，因此分区容错性是必须考虑的因素。</li>
</ol>
<p>根据CAP定理，分布式系统设计者需要在一致性、可用性和分区容错性之间进行权衡取舍。根据实际需求和应用场景的不同，可以选择满足不同程度的一致性和可用性。</p>
<p>需要注意的是，CAP定理是一个理论上的原则，并没有要求系统只能满足其中的两个要求，实际系统可以根据具体需求和技术手段做出更细致的权衡和设计。此外，CAP定理只描述了三个基本要素之间的关系，并没有涉及性能、性价比等其他方面的考虑。在实际系统设计中，还需要结合具体的业务需求和技术实现来进行综合权衡和设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc07eded0594004b4a98ee04af5e415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=WirfF8OMb%2BemuUTCTBlYlX1dlwc%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<ul>
<li>CP 架构的系统:</li>
</ul>
<p>（1）<strong>Apache ZooKeeper</strong>：ZooKeeper是一个开源的分布式协调服务，提供了高可用、一致性和持久性的特性，用于构建分布式系统。</p>
<p>（2）<strong>Consul</strong>是由HashiCorp开发的服务发现和配置工具，提供了服务发现、健康检查、KV存储和多数据中心的功能。</p>
<ul>
<li>AP架构的系统：</li>
</ul>
<p>（1）<strong>Redis</strong>：Redis是一个开源的内存数据库，它提供了高性能的键值存储和支持复制、分区容错等特性，强调了可用性和分区容错性。</p>
<p>（2）<strong>Elasticsearch</strong>：Elasticsearch是一个分布式的搜索和分析引擎，具有高可用性和分区容错性，适用于构建实时搜索和分析系统。</p>
<p>（3）<strong>Apache Kafka</strong>：Kafka是一个分布式流处理平台，具有高可用性和分区容错性，被广泛用于构建实时数据管道和事件流处理系统。</p>
<p>（4）<strong>Nacos</strong>： nacos 是一个开源的动态服务发现、配置管理和服务管理平台。它提供了服务注册与发现、动态配置管理、服务健康检查和动态DNS等功能。默认AP，可手动改为CP 。</p>
<h3 data-id="heading-2">2.2 BASE理论</h3>
<p>BASE理论是分布式系统设计中的一个原则，用于描述在大规模分布式系统中追求可用性和性能的策略。BASE是"Basically Available, Soft state, Eventually consistent"的缩写。</p>
<ul>
<li><strong>Basically Available</strong>（基本可用）：系统在面对部分故障或异常情况时，仍能够保持基本的可用性，即系统能够处理请求并返回合理的响应。基本可用性是相对于完全不可用而言的，系统可以通过<strong>降级、限流</strong>等机制来保持基本的可用性。</li>
<li><strong>Soft state</strong>（软状态）：系统中的数据状态可以在一段时间内是不完全一致的。在分布式系统中，由于存在网络延迟、节点故障等因素，各节点之间的数据同步可能存在一定的延迟。软状态的特点是数据状态可以在一段时间内是部分一致的，但最终会达到一致状态。</li>
<li><strong>Eventually consistent</strong>（最终一致性）：系统中的数据最终会达到一致状态，但在某个时间点上可能存在部分不一致的情况。最终一致性是相对于强一致性而言的，系统可以通过<strong>异步复制、延迟补偿</strong>等机制来实现数据的最终一致性。</li>
</ul>
<p>BASE理论的目标是通过放宽一致性要求，追求更高的可用性和性能。相对于传统的ACID（原子性、一致性、隔离性、持久性）事务模型，BASE理论更适用于大规模分布式系统，可以提供更好的可扩展性和容错性。</p>
<p>需要注意的是，BASE理论并不是一个具体的算法或实现，而是一种思想和原则，可以根据具体的业务需求和技术实现进行灵活的应用。在实际系统设计中，需要综合考虑一致性、可用性、性能等因素，选择适合的策略并进行合理的权衡。</p>
<h2 data-id="heading-3">2. 服务端设备运行日志</h2>
<h3 data-id="heading-4">2.1 需求分析</h3>
<p>当用户支付成功后，服务端需要向设备发送出货指令。设备收到出货指令后，执行出货，并将结果发送给服务端。</p>
<p>我们需要随时掌握有哪些数据是成功了，有哪些是失败了，有哪些是没有得到结果。</p>
<h3 data-id="heading-5">2.2 实现思路</h3>
<p>我们需要在服务端建立一个设备发送日志，当发送给设备指令时新增记录，状态为0 ，当收到结果时修改状态，成功为1 ，失败为2 。</p>
<p>这个表就是 tb_vendout_running</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37740863caa84e0aa5ef6cfa1912a5b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=VhonmMZSaAPNrwgbcNLoY9hafo4%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h3 data-id="heading-6">2.3 代码实现</h3>
<h4 data-id="heading-7">2.3.1 发货添加日志</h4>
<p>（1）创建DTO</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VendoutRunningDTO</span> {


    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> orderNo;<span class="hljs-comment">//订单编号</span>


    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> innerCode;<span class="hljs-comment">//售货机编号</span>


    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> channelCode;<span class="hljs-comment">//货道编号</span>


    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> status;<span class="hljs-comment">//状态</span>

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）feign接口类 VMService 新增方法定义</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 新增售货机日志
 * @param vendoutRunning
 * @return 是否成功
 */</span>
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/vendoutRunning"</span>)
public boolean <span class="hljs-built_in">addVendoutRunning</span>(<span class="hljs-variable">@RequestBody</span> VendoutRunningDTO vendoutRunning);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）VmServiceFallbackFactory 编写熔断方法</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">addVendoutRunning</span>(<span class="hljs-params">VendoutRunningDTO vendoutRunning</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（4）创建运行日志状态</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 运行日志状态　
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VMRuningStatus</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> VENDOUT_PREP = <span class="hljs-string">"0"</span>; <span class="hljs-comment">//准备发货　</span>

    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> VENDOUT_COMP = <span class="hljs-string">"1"</span>;<span class="hljs-comment">//完成发货</span>

    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> VENDOUT_FAIL = <span class="hljs-string">"2"</span>;<span class="hljs-comment">//发货失败</span>

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（5）在发送出货指令时，向售货机运行日志插入记录，状态为0 （无结果）</p>
<p>修改CallBackServiceImpl的successPay方法，在发送消息前 ， 添加添加售货机运行日志</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void successPay(String orderSn) {
    log<span class="hljs-selector-class">.info</span>("支付成功回调{}",orderSn);
    OrderEntity orderEntity = orderService<span class="hljs-selector-class">.getByOrderNo</span>(orderSn);
    <span class="hljs-built_in">if</span>(orderEntity!=null){
        <span class="hljs-built_in">if</span>(orderEntity.getStatus()<span class="hljs-selector-class">.equals</span>( OrderStatus.ORDER_STATUS_CREATE )){
            orderEntity<span class="hljs-selector-class">.setStatus</span>(OrderStatus.ORDER_STATUS_PAYED); <span class="hljs-comment">//订单状态  已支付</span>
            orderEntity<span class="hljs-selector-class">.setPayStatus</span>(PayStatus.PAY_STATUS_PAYED) ;<span class="hljs-comment">//支付状态  成功</span>
            <span class="hljs-comment">//查询出货货道</span>
            ChannelVO channelVO = vmService<span class="hljs-selector-class">.getChannel</span>(orderEntity.getInnerCode(), orderEntity<span class="hljs-selector-class">.getSkuId</span>());
            orderEntity<span class="hljs-selector-class">.setChannelCode</span>( channelVO.getChannelCode() );
            orderService<span class="hljs-selector-class">.updateById</span>( orderEntity );

            <span class="hljs-comment">//添加服务端运行日志</span>
            VendoutRunningDTO vendoutRunning =new  <span class="hljs-built_in">VendoutRunningDTO</span>();
            BeanUtils<span class="hljs-selector-class">.copyProperties</span>( orderEntity,vendoutRunning );
            vendoutRunning<span class="hljs-selector-class">.setStatus</span>(VMRuningStatus.VENDOUT_PREP);  <span class="hljs-comment">//状态:准备发货</span>
            vmService<span class="hljs-selector-class">.addVendoutRunning</span>(vendoutRunning );

            <span class="hljs-comment">//构建报文并发送</span>
            VendoutDTO vendoutDTO=new <span class="hljs-built_in">VendoutDTO</span>();  <span class="hljs-comment">//报文封装对象  （数据传输对象）</span>
            BeanUtils<span class="hljs-selector-class">.copyProperties</span>( orderEntity,vendoutDTO );
            elegentAC<span class="hljs-selector-class">.publish</span>(TopicConfig.getVendoutTopic( orderEntity.getInnerCode() ) , vendoutDTO);
        }
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-8">2.3.2 处理出货结果</h4>
<p>在售货机微服务接到正常的出货结果时，更改日志状态为1 （正常）</p>
<p>在售货机微服务接到异常的出货结果时，更改日志状态为2 （异常）</p>
<p>修改售货机微服务 dkd_vms_service的VendOutResultHandler方法</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 售货机微服务处理出货结果
 */</span>
<span class="hljs-variable">@Topic</span>(TopicConfig.VMS_RESULT_TOPIC)
<span class="hljs-variable">@Slf4j</span>
public class VendoutResultHandler  implements ACHandler&lt;VendoutResultDTO&gt; {


    <span class="hljs-variable">@Autowired</span>
    private ChannelService channelService;

    <span class="hljs-variable">@Autowired</span>
    private VendoutRunningService vendoutRunningService;

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">process</span>(String s, VendoutResultDTO vendoutResultDTO) throws Exception {

        <span class="hljs-comment">//出货成功扣减库存</span>
        <span class="hljs-selector-tag">if</span>(vendoutResultDTO.<span class="hljs-built_in">isSuccess</span>()){
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>( <span class="hljs-string">"出货成功，扣减库存:{}"</span>,  vendoutResultDTO );
            <span class="hljs-selector-tag">ChannelEntity</span> <span class="hljs-selector-tag">channelEntity</span> = <span class="hljs-selector-tag">channelService</span><span class="hljs-selector-class">.getChannelInfo</span>(vendoutResultDTO.<span class="hljs-built_in">getInnerCode</span>(), vendoutResultDTO.<span class="hljs-built_in">getChannelCode</span>());
            <span class="hljs-selector-tag">channelEntity</span><span class="hljs-selector-class">.setCurrentCapacity</span>( channelEntity.<span class="hljs-built_in">getCurrentCapacity</span>()-<span class="hljs-number">1</span> );
            <span class="hljs-selector-tag">channelService</span><span class="hljs-selector-class">.updateById</span>( channelEntity);
            <span class="hljs-selector-tag">vendoutRunningService</span><span class="hljs-selector-class">.updateStatus</span>(vendoutResultDTO.<span class="hljs-built_in">getOrderNo</span>(), VMRuningStatus.VENDOUT_COMP);<span class="hljs-comment">//发货成功</span>

        }<span class="hljs-selector-tag">else</span>{
            <span class="hljs-selector-tag">vendoutRunningService</span><span class="hljs-selector-class">.updateStatus</span>(vendoutResultDTO.<span class="hljs-built_in">getOrderNo</span>(), VMRuningStatus.VENDOUT_FAIL);<span class="hljs-comment">//发货失败</span>
        }
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-9">2.3.3 最终一致性补偿数据</h4>
<p>因为服务端和设备需要通过网络进行通信，这期间可能会因为网络原因无法将出货指令送达到设备，也有可能会在设备出货后因为网络故障无法将结果上报给服务端。这两种情况，都可能导致运行日志的状态为0 。</p>
<p>那么，遇到这种情况如何处理呢？我们采用的方案是最终一致性。</p>
<p>服务端和设备端都保存有日志记录，设备端在接收到指令后，也会记录在日志中。设备在上报前和上报后都会做记录，如果设备端的日志记录上报状态为未上报，则是因为网络原因导致无法及时上报消息。</p>
<p>对于这些没有成功上报的消息，设备端会每间隔一段时间再次进行状态的上报。这样一旦网络通畅了，就会实现数据的最终一致性。</p>
<h2 data-id="heading-10">3.分布式锁技术研究(重点)</h2>
<h3 data-id="heading-11">3.1 什么是分布式锁</h3>
<p>分布式锁是一种用于协调分布式系统中并发访问的机制。在分布式系统中，多个节点可能同时访问共享资源，为了避免数据不一致或竞争条件的发生，需要一种机制来确保在某个节点操作共享资源时，其他节点不能同时访问该资源。</p>
<p>分布式锁通过在分布式系统中引入一个全局的锁来实现这一目的。当一个节点需要访问共享资源时，它首先尝试获取分布式锁，如果成功获取到锁，则可以执行相应的操作；如果获取锁失败，则需要等待锁释放后再次尝试。</p>
<p>分布式锁可以使用各种技术和算法来实现，常见的实现方式包括基于数据库、基于缓存、基于ZooKeeper等。这些实现方式通常要考虑高可用性、性能和可靠性等因素。</p>
<p>使用分布式锁可以有效地控制分布式系统中的并发访问，确保数据的一致性和正确性。然而，分布式锁的设计和使用需要仔细考虑各种情况，避免死锁、性能瓶颈和单点故障等问题的发生。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef87d16f140447e68ecab793ff4e4a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=%2FjfeWIr9J4%2FC7fCWCzgrs2H4uQM%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h3 data-id="heading-12">3.2 分布式锁的分类</h3>
<ol>
<li><strong>按实现方式分类</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>基于数据库的分布式锁：使用数据库的事务和唯一约束来实现分布式锁，通常使用表中的一行记录表示一个锁。</li>
<li>基于缓存的分布式锁：利用分布式缓存（如Redis）的原子性操作和过期时间特性来实现分布式锁。</li>
<li>基于Zookeeper的分布式锁：利用ZooKeeper这样的分布式协调服务来实现分布式锁，通过创建和删除节点来实现锁的获取和释放。</li>
<li>基于Consul 的分布式锁</li>
</ul>
</li>
</ul>
<ol>
<li><strong>按特性分类</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>阻塞锁</strong>：获取锁失败时，请求线程会被阻塞直到获取到锁为止。</li>
<li><strong>非阻塞锁</strong>：获取锁失败时，请求线程会立即返回而不会被阻塞，可以通过轮询或者回调方式来获取锁。</li>
</ul>
</li>
</ul>
<ol>
<li><strong>按是否可重入分类</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>可重入锁</strong>：允许同一个线程多次获取同一把锁，通常用于递归调用或者嵌套调用的场景。<br/>
可重入锁是一种特殊的锁，允许同一个线程在持有锁的情况下多次获取该锁，而不会被自己所持有的锁所阻塞。这种特性使得线程可以在递归调用或者嵌套调用的情况下安全地使用锁，而不必担心死锁或者竞争条件的问题。<br/>
在实现可重入锁时，通常需要记录当前锁的持有者以及持有次数。当线程再次获取同一把锁时，系统会检查当前线程是否已经持有该锁，如果是，则增加持有次数；如果不是，则阻塞或者返回失败。</li>
<li><strong>不可重入锁</strong></li>
</ul>
</li>
</ul>
<ol>
<li>按是否公平分类：</li>
</ol>
<ul>
<li>
<ul>
<li>
<p><strong>公平锁</strong>：<br/>
公平锁是一种锁，它保证锁的获取按照请求的顺序进行分配，避免某些线程长期等待而无法获取锁的情况，从而避免了"饥饿"现象的发生。<br/>
在公平锁中，当有多个线程竞争同一把锁时，锁会按照请求的顺序分配给等待时间最长的线程，而不是随机分配给任意一个等待的线程。这样可以确保所有线程都有公平的机会获取锁，避免了某些线程长期无法获取锁的情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fd41aa4e0464835b93fa5f54be31190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=Bx%2BV%2BGGtlJI5hE%2BGsfihrFb2zro%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
</li>
<li>
<p><strong>非公平锁</strong> 当有多个线程竞争同一把锁时 ，随机分配给任意一个等待的线程。</p>
</li>
<li>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b96573af220444ec8ecc4d4939902b7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=eWMIikYuld5wRU2ea%2FMfil2iiek%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">3.3 实现分布式锁的几种方式</h3>
<h4 data-id="heading-14">3.3.1 基于数据库实现的分布式锁（了解）</h4>
<p><strong>创建锁表</strong>：在数据库中创建一张用于存储锁信息的表，例如名为<code>distributed_lock</code>，包括以下字段：</p>
<ul>
<li><code>lock_name</code>：锁的名称，用于区分不同的锁。</li>
<li><code>holder</code>：锁的持有者标识，可以是进程ID、线程ID或者唯一的标识符。</li>
<li><code>expire_time</code>：锁的过期时间，避免锁被长时间占用。</li>
</ul>

<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> distributed_lock (
    lock_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    holder <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),
    expire_time <span class="hljs-type">TIMESTAMP</span>
);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>获取锁</strong>：在需要获取锁的地方，通过数据库事务来尝试插入一条锁记录，如果插入成功则表示获取到了锁，否则表示锁已经被其他进程持有。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> distributed_lock (lock_name, holder, expire_time) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'my_lock'</span>, <span class="hljs-string">'process_id'</span>, NOW() <span class="hljs-operator">+</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">10</span> <span class="hljs-keyword">SECOND</span>);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>释放锁</strong>：在任务执行完成或者锁过期时，通过事务操作来删除对应的锁记录，释放锁资源。</p>
<pre><code class="hljs language-ini" lang="ini">DELETE FROM distributed_lock WHERE <span class="hljs-attr">lock_name</span> = <span class="hljs-string">'my_lock'</span> AND holder = <span class="hljs-string">'process_id'</span><span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>处理锁超时</strong>：定期清理过期的锁记录，可以通过定时任务或者后台进程来实现。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> distributed_lock <span class="hljs-keyword">WHERE</span> expire_time <span class="hljs-operator">&lt;</span> NOW();
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>优缺点：</p>
<p>优点：不需要引入其它中间件。</p>
<p>缺点：对数据库压力较大，执行效率较低。</p>
<h4 data-id="heading-15">3.3.2 Redis分布式锁-setNx命令(了解)</h4>
<p>redis实现分布式锁可以使用Redis的setNx命令来实现，它的原理是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6cfa1d717614f3c9c26aa17f6ddeb2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=SjMQRpqZFutkj%2FJtSR0kUd10MSw%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>如果你使用的是SpringDataRedis ,实现的方式也比较简单：</p>
<p>如果是加锁，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Boolean <span class="hljs-attr">result</span> = redisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-number">1</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这里面实际就是调用了redis的setnx ，<strong>setnx</strong> 大致原理，主要依托了它的<strong>key不存在才能set成功的特性</strong>。</p>
<p>如果是释放锁，比较简单的是直接把这个key删除掉。但是这样一来删除锁和加锁的不一定是同一个进程，所以我们需要释放锁的时候判断当前进程和加锁的进程是不是同一个进程，这就需要在删除前再查询一次，而这样一来就不是一个原子操作了。如果释放锁想要成为一个原子操作，比较常见的方案就是通过调用lua脚本来实现。</p>
<p>释放锁的lua脚本是这样写的：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'get'</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] 
 <span class="hljs-keyword">then</span> 
 <span class="hljs-comment">-- 执行删除操作</span>
 <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'del'</span>, KEYS[<span class="hljs-number">1</span>]) 
<span class="hljs-keyword">else</span> 
 <span class="hljs-comment">-- 不成功，返回0</span>
 <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> 
 <span class="hljs-keyword">end</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在这个Lua脚本中，假设锁的键名为<code>KEYS[1]</code>，并且锁的值为<code>ARGV[1]</code>。脚本首先通过<code>get</code>命令获取锁的当前值，然后判断锁的当前值是否与传入的值相同。如果相同，则使用<code>del</code>命令删除该键，表示成功释放锁；如果不相同，则返回0，表示释放失败。</p>
<p>执行释放锁的lua脚本</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 解锁脚本</span>
<span class="hljs-title class_">DefaultRedisScript</span>&lt;<span class="hljs-title class_">Object</span>&gt; unlockScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>();
unlockScript.<span class="hljs-title function_">setScriptSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceScriptSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"lockDel.lua"</span>)));
 <span class="hljs-comment">// 执行lua脚本解锁</span>
 redisTemplate.<span class="hljs-title function_">execute</span>(unlockScript, <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(keyName), value);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>【知识点小节】</p>
<ol>
<li>如何实现redis分布式锁？</li>
</ol>
<p>（1）我们可以使用Redis的setNx命令加锁，对于我们常用的SpringDataRedis框架来说，可以使用setIfAbsent方法来实现加锁。</p>
<p>（2）这种方式的释放锁不具备原子性，所以我们需要将释放锁的操作放到lua脚本，在代码中调用lua脚本来实现。我们可以使用redisTemplate的execute方法来调用lua脚本。</p>
<h4 data-id="heading-16">redis实现分布式锁可以使用Redis的setNx命令来实现，它的原理是这样的：</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a9f53e510844a2fa8ad2d6ce1b371b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=V3dOW%2BfWwtbA8uNRrD1tVJcM3oQ%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>如果你使用的是SpringDataRedis ,实现的方式也比较简单：</p>
<p>如果是加锁，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Boolean <span class="hljs-attr">result</span> = redisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-number">1</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这里面实际就是调用了redis的setnx ，<strong>setnx</strong> 大致原理，主要依托了它的<strong>key不存在才能set成功的特性</strong>。</p>
<p>如果是释放锁，比较简单的是直接把这个key删除掉。但是这样一来删除锁和加锁的不一定是同一个进程，所以我们需要释放锁的时候判断当前进程和加锁的进程是不是同一个进程，这就需要在删除前再查询一次，而这样一来就不是一个原子操作了。如果释放锁想要成为一个原子操作，比较常见的方案就是通过调用lua脚本来实现。</p>
<p>释放锁的lua脚本是这样写的：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'get'</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] 
 <span class="hljs-keyword">then</span> 
 <span class="hljs-comment">-- 执行删除操作</span>
 <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'del'</span>, KEYS[<span class="hljs-number">1</span>]) 
<span class="hljs-keyword">else</span> 
 <span class="hljs-comment">-- 不成功，返回0</span>
 <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> 
 <span class="hljs-keyword">end</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在这个Lua脚本中，假设锁的键名为KEYS[1]，并且锁的值为ARGV[1]。脚本首先通过get命令获取锁的当前值，然后判断锁的当前值是否与传入的值相同。如果相同，则使用del命令删除该键，表示成功释放锁；如果不相同，则返回0，表示释放失败。</p>
<p>执行释放锁的lua脚本</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 解锁脚本</span>
<span class="hljs-title class_">DefaultRedisScript</span>&lt;<span class="hljs-title class_">Object</span>&gt; unlockScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>();
unlockScript.<span class="hljs-title function_">setScriptSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceScriptSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"lockDel.lua"</span>)));
 <span class="hljs-comment">// 执行lua脚本解锁</span>
 redisTemplate.<span class="hljs-title function_">execute</span>(unlockScript, <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(keyName), value);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>【知识点小节】</p>
<ol>
<li>如何实现redis分布式锁？</li>
</ol>
<p>（1）我们可以使用Redis的setNx命令加锁，对于我们常用的SpringDataRedis框架来说，可以使用setIfAbsent方法来实现加锁。</p>
<p>（2）这种方式的释放锁不具备原子性，所以我们需要将释放锁的操作放到lua脚本，在代码中调用lua脚本来实现。我们可以使用redisTemplate的execute方法来调用lua脚本。</p>
<h4 data-id="heading-17">3.3.3 Redisson组件封装实现</h4>
<p>因为setNx加锁存在几个弊端：</p>
<p>（1）释放锁调用lua脚本实现稍繁琐</p>
<p>（2）不可重入</p>
<p>（3）没有实现续期</p>
<p>我们使用Redisson组件可以很轻松地解决以上问题。 Redisson组件提供了可重入的，可以实现续期的分布式锁。Redisson组件为你提供了一个“看门狗”机制。</p>
<p>在项目中使用，参考以下步骤：</p>
<p>（1） 引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）编写配置类</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Configuration</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissionConfig</span> {
   <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${spring.redis.host}</span>"</span>)</span>
   <span class="hljs-keyword">private</span> String redisHost;

   <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${spring.redis.password}</span>"</span>)</span>
   <span class="hljs-keyword">private</span> String password;

   <span class="hljs-keyword">private</span> int port = <span class="hljs-number">6379</span>;

   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> RedissonClient getRedisson() {
     Config config = new Config();
     config.useSingleServer().
     setAddress(<span class="hljs-string">"redis://"</span> + redisHost + <span class="hljs-string">":"</span> + port).
     setPassword(password);
     <span class="hljs-keyword">return</span> Redisson.create(config);
   }
 }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）加锁和释放锁</p>
<p>引入RedissonClient</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Resource</span>
 <span class="hljs-keyword">private</span> RedissonClient redissonClient;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>通过RLock加锁</p>
<pre><code class="hljs language-ini" lang="ini">RLock <span class="hljs-attr">rLock</span> = redissonClient.getLock(lockName)<span class="hljs-comment">;</span>
 boolean <span class="hljs-attr">isLocked</span> = rLock.tryLock(expireTime, TimeUnit.MILLISECONDS)<span class="hljs-comment">;</span>
 if (isLocked) {
 // TODO： 如果加锁成功 
 }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>通过RLock释放锁</p>
<pre><code class="hljs language-ini" lang="ini">RLock <span class="hljs-attr">rLock</span> = redissonClient.getLock(lockName)<span class="hljs-comment">;</span>
 boolean <span class="hljs-attr">isLocked</span> = rLock.unLock()<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>【知识点小节】</p>
<p>如何使用Redisson组件实现分布式锁？</p>
<p>（1）使用Redisson.create方法创建RedissonClient。</p>
<p>（2）通过redissonClient.getLock方法获取锁对象RLock。</p>
<p>（3）通过调用RLock的tryLock方法加锁</p>
<p>（4）通过调用RLock的unLock方法释放锁</p>
<h4 data-id="heading-18">3.3.4 RedLock算法的实现</h4>
<p>为什么需要使用红锁（RedLock）？</p>
<p>（1）如果我们连接的是一个单节点的Redis，有可能因为Redis宕机导致业务系统瘫痪。</p>
<p>（2）如果我们连接的是一个集群环境，有可能因为脑裂问题导致分布式锁失效。</p>
<p>脑裂 指的是因为网络通讯中断导致一个集群分裂为两个集群的现象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14fa6fdd04da4eb19a1b7995dc8e8695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=TyeC928XqPJ9zfkIPCTf98dktW8%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>（3）如果我们使用红锁算法，它所连接的多个节点，并不是一个集群，而是独立的，它的实现原理就是对每个节点依次加锁，超过半数成功，不超过半数失败。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d745924e5134121aa1e180628804aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=52MpwZnVutZNoFeaNCa0tXUGC40%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>如何使用红锁，我们看代码：</p>
<p>（1） 引入redisson依赖 ，和上边的一样</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.13.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）编写配置类，这个有些区别</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Configuration</span>
public class RedissionConfig {
  
    <span class="hljs-comment">/**
     * 红锁地址列表
     */</span>
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${elegent.lock.address}"</span>)
    private String[] address;

    <span class="hljs-keyword">@Bean</span>
    public RedissonClient[] getRedisson() {
        <span class="hljs-comment">//初始化</span>
        RedissonClient<span class="hljs-selector-attr">[]</span> redissonClients=new RedissonClient<span class="hljs-selector-attr">[ address.length  ]</span>;
        <span class="hljs-built_in">for</span>(int i=<span class="hljs-number">0</span>;i&lt;redisLockConfig.getAddress()<span class="hljs-selector-class">.length</span>;<span class="hljs-selector-tag">i</span>++){
            Config config = new <span class="hljs-built_in">Config</span>();
            config<span class="hljs-selector-class">.useSingleServer</span>()<span class="hljs-selector-class">.setAddress</span>( "redis://"+redisLockConfig.getAddress()<span class="hljs-selector-attr">[i]</span> );
            redissonClients<span class="hljs-selector-attr">[i]</span> = Redisson<span class="hljs-selector-class">.create</span>(config);
        }
        return redissonClients;
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）加锁和释放锁</p>
<p>先要初始化，假设我们有五个节点</p>
<pre><code class="hljs language-ini" lang="ini">//客户端
    private RedissonClient <span class="hljs-section">[]</span> redissonClients<span class="hljs-comment">;</span>

    @PostConstruct
    public void init() {
        //初始化
        <span class="hljs-attr">redissonClients</span>=new RedissonClient[ address.length  ]<span class="hljs-comment">;</span>
        for(int <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;redisLockConfig.getAddress().length;i++){</span>
            Config <span class="hljs-attr">config</span> = new Config()<span class="hljs-comment">;</span>
            config.useSingleServer().setAddress( "redis://"+redisLockConfig.getAddress()<span class="hljs-section">[i]</span> )<span class="hljs-comment">;</span>
            redissonClients<span class="hljs-section">[i]</span> = Redisson.create(config)<span class="hljs-comment">;</span>
        }
    }  

   private RedissonRedLock getRedissonRedLock(String lockName){
        RLock <span class="hljs-attr">lock0</span> = redissonClients[<span class="hljs-number">0</span>].getLock(lockName)<span class="hljs-comment">;</span>
        RLock <span class="hljs-attr">lock1</span> = redissonClients[<span class="hljs-number">1</span>].getLock(lockName)<span class="hljs-comment">;</span>
        RLock <span class="hljs-attr">lock2</span> = redissonClients[<span class="hljs-number">2</span>].getLock(lockName)<span class="hljs-comment">;</span>
        RLock <span class="hljs-attr">lock3</span> = redissonClients[<span class="hljs-number">3</span>].getLock(lockName)<span class="hljs-comment">;</span>
        RLock <span class="hljs-attr">lock4</span> = redissonClients[<span class="hljs-number">4</span>].getLock(lockName)<span class="hljs-comment">;</span>
        return new RedissonRedLock(lock0,lock1,lock2,lock3,lock4)<span class="hljs-comment">;</span>
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>业务代码中加锁和释放锁</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//红锁</span>
RedissonRedLock redLock=<span class="hljs-built_in">getRedissonRedLock</span>(lockName);  
redLock<span class="hljs-selector-class">.tryLock</span>(<span class="hljs-number">60</span> ,TimeUnit.SECONDS);<span class="hljs-comment">//加锁   参数1是过期时间 ，如果给-1则表示续期</span>
redLock<span class="hljs-selector-class">.unlock</span>();<span class="hljs-comment">//释放锁</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>【知识点小节】</p>
<p>如何使用红锁？</p>
<p>（1）创建每个redis节点的RedissonClient</p>
<p>（2）通过每个redis节点的RedissonClient构建RedissonRedLock 。</p>
<p>（3）通过RedissonRedLock的实例的tryLock加锁，unlock释放锁。</p>
<h3 data-id="heading-19">3.4 Elegent-lock</h3>
<h4 data-id="heading-20">3.4.1 Elegent-lock简介</h4>
<p>这是一个基于springboot的优雅的分布式锁组件。使用这个组件可以让你更轻松、更优雅地在项目中集成分布式锁，让你更专注业务代码的开发。它目前支持redis分布式锁、consul分布式锁两种实现方式，可以通过更改配置自由切换而不需要更改业务代码。</p>
<p>开源项目地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fchuanzhiliubei%2Felegent-lock" title="https://gitee.com/chuanzhiliubei/elegent-lock" target="_blank" ref="nofollow noopener noreferrer">gitee.com/chuanzhiliu…</a></p>
<h4 data-id="heading-21">3.4.2 Elegent-lock快速入门</h4>
<h5 data-id="heading-22">集成</h5>
<p>1.在项目中引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.lock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-lock-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>2.在项目配置文件添加配置，示例如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">lock:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:6379</span>
    <span class="hljs-attr">wait:</span> <span class="hljs-number">10</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>配置说明：</p>
<p>（1）type: 分布式锁类型，可选值：consul、redis，默认值是redis。</p>
<p>（2）host: 分布式锁中间件的部署地址，默认值为127.0.0.1。</p>
<p>（3）wait: 等待超时时间，单位秒，默认值10。表示在获取不到锁的时候会在此时间内会进行重试。</p>
<h5 data-id="heading-23">代码方式</h5>
<p>类中引入ElegentLock</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> ElegentLock elegentLock;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>方法调用以下方法实现加锁与释放锁</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//参数说明： 锁名称，过期时间，是否自旋</span>
boolean b = elegentLock.<span class="hljs-keyword">lock</span>(name,<span class="hljs-number">60</span>,<span class="hljs-literal">false</span>);
<span class="hljs-comment">//todo: 业务逻辑</span>
System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"业务逻辑"</span>+b);
elegentLock.unLock(name);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-24">注解方式</h5>
<p>在方法上添加注解<code>@ELegentLock(lockName = "test",isSpin= true,ttl=10)</code> 即可。</p>
<p><code>lockName</code>为锁名字，实际加锁会以<code>lockName</code>+方法参数作为锁key。</p>
<p><code>always =true</code>，加锁，如果锁被占用会通过自旋方式不断尝试，直到加成功为止。</p>
<p><code>always =false</code>，（默认值）加锁，只尝试一次。推荐使用此选项。</p>
<p>我们可以运行Elegent提供的demo代码，进行快速学习。</p>
<h3 data-id="heading-25">3.5 基于Consul分布式锁</h3>
<h4 data-id="heading-26">3.5.1 Consul简介</h4>
<p>Consul是HashiCorp公司推出的开源工具，用于实现分布式系统的服务发现与配置。 Consul是分布式的、高可用的、可横向扩展的。它具备以下特性 :</p>
<p>服务发现：consul通过DNS或者HTTP接口使服务注册和服务发现变的很容易。<br/>
健康检查：健康检测使consul可以快速的告警在集群中的操作。<br/>
键/值存储：一个用来存储动态配置的系统。提供简单的HTTP接口，可以在任何地方操作。<br/>
多数据中心：无需复杂的配置，即可支持任意数量的区域。</p>
<p>一句话概况：</p>
<p>Consul既可以用于注册中心和配置中心，也可以做keyValue存储。使用Consul做分布式锁的底层原理就是keyValue存储。</p>
<p>课程提供了配套的 consul 本地运行环境</p>
<h4 data-id="heading-27">3.5.2 项目为什么使用Consul做分布式锁？</h4>
<p>Consul的分布式锁与Redis分布式锁有什么不同？项目为什么使用Consul做分布式锁？</p>
<p>一句话概况：</p>
<p>因为Consul分布式锁是CP架构的，使用 Raft 算法来保证一致性。相比之下，Redis由于是AP架构，可能因为脑裂造成数据不一致，如果采用Redis红锁性能又很差。所以，当时我们权衡利弊，决定采用Consul分布式锁。</p>
<p>红锁会有弊端。时间复杂度变高（响应时间边长，吞吐量变低） ，空间复杂度变高了。</p>
<h4 data-id="heading-28">3.5.3 Consul做分布式锁快速入门</h4>
<p>修改配置文件 为consul</p>
<h2 data-id="heading-29">4 分布式锁解决超卖问题</h2>
<h3 data-id="heading-30">4.1 问题分析</h3>
<p>首先我们先说为什么会产生超买的问题。</p>
<p>如果售货机是带屏幕的，理论上来说是不会产生超卖问题的。因为带屏幕的售货机实际中就只能是独占类型的操作，但是如果是不带屏幕的售货机，用户就需要扫描售货机上的二维码来进行购买操作， 那么假设有两个用户在相近的时间点在同一台售货机购买了同一个商品， 而恰好这件商品只有一件了，就会可能产生超卖的问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/495f65418e504665afb86a120b5f23b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=jbsfGFIHihZ1vOMVReOhoXiEQzA%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>为什么会超卖呢？我们看一下下面的图：</p>
<p>这是一个用户的购买时序图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca6945323e04f18aec825913afc50a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=GnRAZbl8YJxasJJaWO6cnI2VUOA%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>当用户下单时，会判断当前要购买的商品在该售货机的库存，如果当前库存为1件，也是可以下单的，用户这个时候下单并支付，支付成功后，支付系统回调我们的订单微服务，订单微服务向售货机发送出货指令，售货机终端执行出货，并向服务端上报结果，服务端的售货机微服务再扣减库存。这期间其实至少也需几秒左右的时间才能完成。而如果在这期间，另外一个人也着急购买商品，扫描并下单购买同一个商品，那么这个时候第一个人购买的流程还没有结束，库存还没有扣减，所以显示的商品仍然还有一件，那他仍然可以下单。等他支付完成后，售货机没有商品可以出货了，这个时候就产生了超卖。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68c5d10ad6d4ad0b05f88f19aea71e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=TiN2BJKPmiYAQUf8A1fWk4umJd4%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>这样我们就会产生超卖的现象。</p>
<h3 data-id="heading-31">4.2 实现思路</h3>
<p>那么如何解决超卖现象呢？我们就需要使用分布式锁来解决。</p>
<p>user1在下单前需要加锁，在扣减库存后要释放锁。这样，就确保user2在下单时上一个流程是已经跑完的，此时的库存就是准确的，就不会产生超卖的问题了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d1fc320bf174cacbe4ac0ac47e85d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491036&amp;x-signature=xO5XE%2FScLggA%2BmfHAW3Zf4wLZ7I%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h3 data-id="heading-32">4.3 代码实现</h3>
<h4 data-id="heading-33">4.3.1 订单微服务加锁</h4>
<p>（1）在订单微服务的pom文件引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.lock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-lock-consul<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）在订单微服务的配置（配置中心）中添加以下配置</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">lock:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">consul</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8500</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）在OrderServiceImpl的createOrder方法中添加分布式锁代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">ElegentLock</span> eLegentLock;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OrderEntity</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">PayVO payVO,<span class="hljs-built_in">String</span> platform</span>) {
        <span class="hljs-comment">//判断库存</span>
        <span class="hljs-keyword">if</span>( !vmService.<span class="hljs-title function_">hasCapacity</span>(payVO.<span class="hljs-title function_">getInnerCode</span>(), <span class="hljs-title class_">Long</span>.<span class="hljs-title function_">valueOf</span>(payVO.<span class="hljs-title function_">getSkuId</span>())) ){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicException</span>(<span class="hljs-string">"商品库存不足"</span>);
        }

        <span class="hljs-comment">//加锁，判断上次交易是否完成</span>
        <span class="hljs-built_in">boolean</span> lock = eLegentLock.<span class="hljs-title function_">lock</span>(payVO.<span class="hljs-title function_">getInnerCode</span>() + <span class="hljs-string">"-"</span> + payVO.<span class="hljs-title function_">getSkuId</span>(), <span class="hljs-number">60</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span>(!lock){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicException</span>(<span class="hljs-string">"上一笔交易未完成，请稍后！"</span>);
        }
        ..................................
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-34">4.3.2 售货机微服务释放锁</h4>
<p>（1）在售货机微服务的pom文件引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.lock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-lock-consul<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）在售货机微服务的配置（配置中心）中添加以下配置</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">lock:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">consul</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8500</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）在VendOutResultHandler的process方法中添加释放分布式锁代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> ElegentLock elegentLock;

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(String s,VendoutResultDTO vendoutResultDTO)</span> <span class="hljs-keyword">throws</span> Exception {
    log.info(<span class="hljs-string">"接收到出货结果,{}"</span>, vendoutResultDTO);
    ..........       
    <span class="hljs-comment">//释放锁</span>
    elegentLock.unLock( vendoutResultDTO.getInnerCode()+<span class="hljs-string">"-"</span>+vendoutResultDTO.getSkuId() );
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-35">5.超时订单处理方案-延迟消息</h2>
<h3 data-id="heading-36">5.1 需求分析</h3>
<p>有很多时候，用户下单后，并不一定会支付。如果用户一直不支付，那么这个订单岂不是一直处于未支付状态，这并不利于我们的订单管理，我们通常的做法是设定一个时效，超过这个时间，需要将这个订单更改为无效状态，并且在支付平台将这笔交易关闭掉。</p>
<h3 data-id="heading-37">5.2 实现思路</h3>
<p>（1）在下单时，通过AC框架发送异步消息，延迟时间为5分钟。发送内容为订单号</p>
<p>协议封装: OrderCheck 封装的是订单号</p>
<p>主题封装: TopicConfig.ORDER_CHECK_TOPIC</p>
<p>如果延迟5分钟,前缀为 $delayed/300/</p>
<p>（2）在订单服务中接收延迟消息, 从协议中解析出订单号, 查询订单，如果此订单未支付则修改为无效订单，并关闭此支付交易单。</p>
<h3 data-id="heading-38">5.3 代码实现</h3>
<h4 data-id="heading-39">5.3.1 主题定义与协议封装</h4>
<p>（1）TopicConfig定义延迟订单主题</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 延迟订单主题
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> ORDER_CHECK_TOPIC = <span class="hljs-string">"server/order/check"</span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）service_common定义OrderCheckDTO，用于封装订单号</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 订单延迟检查协议类
 */</span>
@Data
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCheckDTO</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> orderNo;

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-40">5.3.2 发送延迟消息</h4>
<p>OrderServiceImpl引入</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> ElegentAC elegentAC;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在OrderServiceImpl 的createOrder方法<strong>结尾处</strong>添加以下代码</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//将订单放到延迟队列中，5分钟后检查支付状态！！！！！！！！！！！！！！！！！！</span>
OrderCheckDTO orderCheck = new <span class="hljs-built_in">OrderCheckDTO</span>();
orderCheck<span class="hljs-selector-class">.setOrderNo</span>(orderEntity.getOrderNo());
try {
    elegentAC<span class="hljs-selector-class">.delayPublish</span>(TopicConfig.ORDER_CHECK_TOPIC,orderCheck,<span class="hljs-number">300</span>);
} catch (Exception e) {
    log<span class="hljs-selector-class">.error</span>("send to emq error",e);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-41">5.3.3 接收延迟消息</h4>
<p>在订单服务项目中实现接收到该消息的处理代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 订单超时处理
 */</span>
<span class="hljs-variable">@Topic</span>(TopicConfig.ORDER_CHECK_TOPIC)
<span class="hljs-variable">@Slf4j</span>
public class OrderCheckHandler implements ACHandler&lt;OrderCheckDTO&gt; {

    <span class="hljs-variable">@Autowired</span>
    private OrderService orderService;

    <span class="hljs-variable">@Autowired</span>
    private ElegentPay elegentPay;

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">process</span>(String s, OrderCheckDTO orderCheck) throws Exception {

        <span class="hljs-selector-tag">if</span>(orderCheck == null || Strings.<span class="hljs-built_in">isNullOrEmpty</span>(orderCheck.<span class="hljs-built_in">getOrderNo</span>())) <span class="hljs-selector-tag">return</span>;
        <span class="hljs-comment">//查询订单</span>
        <span class="hljs-selector-tag">OrderEntity</span> <span class="hljs-selector-tag">orderEntity</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.getByOrderNo</span>(orderCheck.<span class="hljs-built_in">getOrderNo</span>());
        <span class="hljs-selector-tag">if</span>(orderEntity == null) <span class="hljs-selector-tag">return</span>;
        <span class="hljs-selector-tag">if</span>(orderEntity.<span class="hljs-built_in">getStatus</span>().<span class="hljs-built_in">equals</span>(OrderStatus.ORDER_STATUS_CREATE)){  <span class="hljs-comment">//如果是未支付</span>
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"订单无效处理 订单号：{}"</span>,orderCheck.<span class="hljs-built_in">getOrderNo</span>());
            <span class="hljs-selector-tag">orderEntity</span><span class="hljs-selector-class">.setStatus</span>(OrderStatus.ORDER_STATUS_INVALID); <span class="hljs-comment">//无效状态</span>
            <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.updateById</span>(orderEntity);
            <span class="hljs-comment">//关闭支付</span>
            <span class="hljs-selector-tag">elegentPay</span><span class="hljs-selector-class">.closePay</span>( orderEntity.<span class="hljs-built_in">getOrderNo</span>(),orderEntity.<span class="hljs-built_in">getPayType</span>() );
        }
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-42">总结：</h3>
<p>（１）请问你如何理解CAP定理 ？</p>
<p>CAP 定理阐述一个观点： C（一致性）A（可用性）P（分区容错） 不能同时满足。</p>
<p>CP系统： ZK \ consul</p>
<p>AP系统： redis NACOS</p>
<p>（２）什么是BASE理论</p>
<p>基本可用 软状态 最终一致性。</p>
<p>（３）你在项目中是否使用过分布锁？</p>
<p>是，用过。我们使用CONSUL的原因。[分析分布式锁单机版单点故障、红锁性能损失角度逐步分析 ]</p>
<p>（４）你在项目中是否使用过线程池技术？</p>
<p>是，用过。</p>
<p>（５）分布式锁有哪些？</p>
<p>（６）REDISSION分布式锁你是怎么实现的？ 答：常见方法．引出框架和CONSUL分布式锁。</p>
<p>（７）延迟消息你项目中场景是什么？</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用好PowerMock，轻松搞定那些让你头疼的单元测试]]></title>    <link>https://juejin.cn/post/7575102209606221850</link>    <guid>https://juejin.cn/post/7575102209606221850</guid>    <pubDate>2025-11-23T08:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606221850" data-draft-id="7575119254313844762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用好PowerMock，轻松搞定那些让你头疼的单元测试"/> <meta itemprop="keywords" content="后端,单元测试"/> <meta itemprop="datePublished" content="2025-11-23T08:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java随想录"/> <meta itemprop="url" content="https://juejin.cn/user/2837192913204935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用好PowerMock，轻松搞定那些让你头疼的单元测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2837192913204935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java随想录
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:26:47.000Z" title="Sun Nov 23 2025 08:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文已收录至GitHub，推荐阅读 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBookSea4j%2FJavaRecord" target="_blank" title="https://github.com/BookSea4j/JavaRecord" ref="nofollow noopener noreferrer">Java随想录</a></p>
<p>微信公众号：Java随想录</p>
<p>结合 <a href="https://juejin.cn/post/7498580969286631434" target="_blank" title="https://juejin.cn/post/7498580969286631434">不用Mockito写单元测试？你可能在浪费一半时间</a> 阅读体验更佳。</p>
<blockquote>
<p>面对无法Mock的静态方法、私有方法和final类，PowerMock为你打开一扇新的大门</p>
</blockquote>
<p>作为一名Java开发者，单元测试是我们保证代码质量的重要环节。但在实际工作中，我们经常会遇到一些难以测试的代码场景：静态工具类、final类、私有方法等。传统的Mockito框架对这些情况束手无策，而PowerMock的出现正好解决了这些痛点。</p>
<h2 data-id="heading-0">PowerMock是什么？为什么需要它？</h2>
<h3 data-id="heading-1">PowerMock的核心定位</h3>
<p>PowerMock是一个强大的Java单元测试框架，它通过扩展现有的Mock框架（如Mockito和EasyMock），提供了更强大的Mock能力。<strong>PowerMock的核心价值在于它能够Mock那些传统Mock工具无法处理的情况</strong>，包括静态方法、final类和方法、私有方法、构造函数等。</p>
<p>与普通Mock框架不同，PowerMock使用自定义的类加载器和字节码操作技术（基于Javassist和ASM库），在运行时修改类的行为，从而实现对这些"难以Mock"的场景的完全控制。</p>
<h3 data-id="heading-2">PowerMock与Mockito的关系和区别</h3>
<p>虽然PowerMock和Mockito都是用于单元测试的Mock框架，但它们在功能和定位上有着明显的区别：</p>
<p><strong>Mockito</strong>是一个轻量级、简单易用的Mock框架，适用于大多数日常测试场景。但它有明显的局限性：无法Mock静态方法、final类、私有方法和构造函数等。</p>
<p><strong>PowerMock</strong>则是对Mockito的增强，填补了Mockito的功能空白。它不是替代Mockito，而是与Mockito协同工作，共同构建完整的单元测试解决方案。</p>
<p>两者核心区别体现在底层实现上：Mockito使用动态代理（CGLIB）技术，而PowerMock通过修改字节码来实现更强大的Mock能力。</p>
<p>正因为这种根本差异，PowerMock可以解决Mockito无法解决的问题。</p>
<h3 data-id="heading-3">PowerMock解决的痛点</h3>
<p>在日常开发中，我们经常会遇到以下测试难题：</p>
<ul>
<li><strong>静态工具类</strong>：如各种Util类中的静态方法。</li>
<li><strong>final类和final方法</strong>：特别是第三方库中的final类。</li>
<li><strong>私有方法</strong>：需要直接测试的私有方法逻辑。</li>
<li><strong>构造函数依赖</strong>：方法内部通过new创建的对象。</li>
<li><strong>静态代码块和系统类</strong>：如System.currentTimeMillis()。</li>
</ul>
<p>这些问题使用传统Mock框架难以解决，而PowerMock为此提供了完整的解决方案</p>
<h2 data-id="heading-4">环境配置与基本用法</h2>
<h3 data-id="heading-5">添加Maven依赖</h3>
<p>要开始使用PowerMock，首先需要在项目中添加相关依赖。由于PowerMock需要与Mockito协同工作，需要同时添加两个依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- PowerMock + Mockito 组合 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-module-junit4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-api-mockito2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>版本兼容性注意</strong>：确保PowerMock与Mockito/JUnit版本匹配，具体兼容性关系可参考官方文档。</p>
<h3 data-id="heading-6">基本配置注解</h3>
<p>使用PowerMock需要在测试类上添加必要的注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span> <span class="hljs-comment">// 必须使用PowerMockRunner</span>
<span class="hljs-meta">@PrepareForTest({StaticUtils.class, User.class})</span> <span class="hljs-comment">// 声明需增强的类</span>
<span class="hljs-meta">@PowerMockIgnore("javax.management.*")</span> <span class="hljs-comment">// 解决类加载器冲突</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {
    <span class="hljs-comment">// 测试内容</span>
}
</code></pre>
<ul>
<li><code>@RunWith(PowerMockRunner.class)</code>：告诉JUnit使用PowerMock的测试运行器。</li>
<li><code>@PrepareForTest</code>：指定需要被PowerMock修改的类（包含静态方法、final方法等的类）。</li>
<li><code>@PowerMockIgnore</code>：解决使用PowerMock后可能出现的类加载器冲突问题。</li>
</ul>
<h2 data-id="heading-7">PowerMock核心使用场景详解</h2>
<h3 data-id="heading-8">静态方法Mock</h3>
<p>静态方法是最常见的测试难点之一，让我们看看PowerMock如何解决这个问题。</p>
<p><strong>场景示例</strong>：假设我们有一个静态工具类，用于生成唯一ID：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdGenerator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateUniqueId</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 实际业务中可能包含复杂的逻辑或外部依赖</span>
        <span class="hljs-keyword">return</span> UUID.randomUUID().toString();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> IdGenerator.generateUniqueId();
        <span class="hljs-comment">// 创建订单的逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ORDER_"</span> + orderId;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({IdGenerator.class, OrderService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderWithStaticMock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 准备静态类的Mock</span>
        PowerMockito.mockStatic(IdGenerator.class);
        
        <span class="hljs-comment">// 2. 预设静态方法行为</span>
        PowerMockito.when(IdGenerator.generateUniqueId()).thenReturn(<span class="hljs-string">"123e4567"</span>);
        
        <span class="hljs-comment">// 3. 创建被测试对象并调用被测方法</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder();
        
        <span class="hljs-comment">// 4. 验证结果</span>
        assertEquals(<span class="hljs-string">"ORDER_123e4567"</span>, result);
        
        <span class="hljs-comment">// 5. 验证静态方法调用（必须调用）</span>
        PowerMockito.verifyStatic(IdGenerator.class);
        IdGenerator.generateUniqueId();
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>mockStatic()</code>方法用于告诉PowerMock要Mock哪个类的静态方法</li>
<li>静态方法的Stubbing（定义行为）与普通Mockito语法类似</li>
<li><strong>必须调用</strong><code>verifyStatic()</code>来验证静态方法的调用，且需要在验证前调用一次</li>
</ul>
<p><strong>常见坑点</strong>：忘记调用<code>verifyStatic()</code>会导致无法验证静态方法是否被正确调用。</p>
<h3 data-id="heading-9">私有方法Mock</h3>
<p>测试私有方法一直存在争议，但在某些场景下（如复杂算法验证）确实有必要直接测试私有方法。</p>
<p><strong>场景示例</strong>：一个包含复杂校验逻辑的UserService：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateUser</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-keyword">if</span> (!isValidFormat(username) || !isValidFormat(password)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> internalComplexValidation(username, password);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidFormat</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-comment">// 复杂的格式校验逻辑</span>
        <span class="hljs-keyword">return</span> input != <span class="hljs-literal">null</span> &amp;&amp; input.length() &gt;= <span class="hljs-number">5</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">internalComplexValidation</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-comment">// 非常复杂的内部校验逻辑</span>
        <span class="hljs-comment">// 可能涉及加密、数据库查询等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 简化示例</span>
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserService.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建被测类的Spy对象（部分真实调用）</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// 2. Stubbing：预设私有方法行为</span>
        PowerMockito.doReturn(<span class="hljs-literal">true</span>).when(spyService, <span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());

        <span class="hljs-comment">// 3. 调用被测方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"testuser"</span>, <span class="hljs-string">"testpass"</span>);

        <span class="hljs-comment">// 4. 验证结果</span>
        assertTrue(result);

        <span class="hljs-comment">// 5. 验证私有方法被调用（可选）</span>
        PowerMockito.verifyPrivate(spyService,Mockito.times(<span class="hljs-number">2</span>))
                .invoke(<span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethodWithArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// Mock有参数的私有方法</span>
        PowerMockito.doReturn(<span class="hljs-literal">false</span>)
                .when(spyService, <span class="hljs-string">"internalComplexValidation"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        assertFalse(result);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li>使用<code>spy()</code>方法创建对象，这样未被Mock的方法会保持真实行为。</li>
<li>使用<code>doReturn().when()</code>语法来Mock私有方法，需通过方法名字符串指定目标方法。</li>
<li>可以通过<code>verifyPrivate()</code>验证私有方法的调用。</li>
</ul>
<p><strong>最佳实践</strong>：优先通过公共方法测试私有逻辑，仅在复杂算法验证等特殊场景下直接测试私有方法。</p>
<h3 data-id="heading-10">final类与方法Mock</h3>
<p>final类和方法由于其不可继承性，在传统Mock框架中无法被Mock，但PowerMock完美解决了这个问题。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalUtility</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Final implementation"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">staticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Static final implementation"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">utility</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalUtility</span>();
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">useFinalClass</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> utility.finalMethod() + <span class="hljs-string">"_processed"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({FinalUtility.class, SomeService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFinalClassAndMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 创建final类的Mock对象</span>
        <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">mockUtility</span> <span class="hljs-operator">=</span> PowerMockito.mock(FinalUtility.class);
        
        <span class="hljs-comment">// 2. 预设final方法行为</span>
        PowerMockito.when(mockUtility.finalMethod()).thenReturn(<span class="hljs-string">"Mocked final"</span>);
        
        <span class="hljs-comment">// 3. 当创建真实对象时返回Mock对象</span>
        PowerMockito.whenNew(FinalUtility.class).withNoArguments().thenReturn(mockUtility);
        
        <span class="hljs-comment">// 4. 测试</span>
        <span class="hljs-type">SomeService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> service.useFinalClass();
        
        assertEquals(<span class="hljs-string">"Mocked final_processed"</span>, result);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStaticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Mock静态final方法</span>
        PowerMockito.mockStatic(FinalUtility.class);
        PowerMockito.when(FinalUtility.staticFinalMethod()).thenReturn(<span class="hljs-string">"Mocked static final"</span>);
        
        assertEquals(<span class="hljs-string">"Mocked static final"</span>, FinalUtility.staticFinalMethod());
    }
}
</code></pre>
<p><strong>底层原理</strong>：PowerMock通过修改字节码，去除了final方法的final标识符，从而允许Mock操作。</p>
<h3 data-id="heading-11">构造函数Mock</h3>
<p>当方法内部直接通过new创建对象时，传统Mock难以介入，PowerMock的构造函数Mock功能为此提供了解决方案。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
    <span class="hljs-keyword">private</span> String connectionString;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnection</span><span class="hljs-params">(String connectionString)</span> {
        <span class="hljs-built_in">this</span>.connectionString = connectionString;
        <span class="hljs-comment">// 可能包含复杂的初始化逻辑</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-comment">// 执行SQL逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 在方法内部直接创建依赖对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnection</span>(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
        <span class="hljs-keyword">return</span> connection.execute(<span class="hljs-string">"INSERT INTO users VALUES ('"</span> + username + <span class="hljs-string">"')"</span>);
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserRepository.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConstructorMock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建Mock对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">mockConnection</span> <span class="hljs-operator">=</span> PowerMockito.mock(DatabaseConnection.class);
        
        <span class="hljs-comment">// 2. 预设构造函数行为</span>
        PowerMockito.whenNew(DatabaseConnection.class)
                   .withParameterTypes(String.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>)
                   .thenReturn(mockConnection);
        
        <span class="hljs-comment">// 3. 预设方法行为</span>
        PowerMockito.when(mockConnection.execute(Mockito.anyString())).thenReturn(<span class="hljs-literal">true</span>);
        
        <span class="hljs-comment">// 4. 执行测试</span>
        <span class="hljs-type">UserRepository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRepository</span>();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> repository.saveUser(<span class="hljs-string">"testuser"</span>);
        
        <span class="hljs-comment">// 5. 验证</span>
        assertTrue(result);
        PowerMockito.verifyNew(DatabaseConnection.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>whenNew()</code>用于拦截构造函数调用。</li>
<li><code>withParameterTypes()</code>和<code>withArguments()</code>用于精确匹配构造函数。</li>
<li>需要使用<code>verifyNew()</code>验证构造函数调用。</li>
</ul>
<p><strong>应用场景</strong>：适用于测试遗留代码中在方法内部直接实例化依赖对象的情况。</p>
<h3 data-id="heading-12">静态代码块处理</h3>
<p>静态代码块在类加载时执行，可能包含不愿在测试中运行的代码（如初始化昂贵资源），PowerMock可以抑制静态代码块的执行。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoader</span> {
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 静态代码块，可能包含昂贵的初始化操作</span>
        loadConfigurationFromRemote();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadConfigurationFromRemote</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟昂贵的初始化</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不应该在测试中执行"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"value"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(ConfigurationLoader.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoaderTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuppressStaticInitializer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 抑制静态代码块执行</span>
        PowerMockito.suppress(PowerMockito.method(ConfigurationLoader.class, <span class="hljs-string">"loadConfigurationFromRemote"</span>));
        
        <span class="hljs-comment">// 现在可以安全测试，静态代码块不会执行</span>
        assertNotNull(ConfigurationLoader.getConfig(<span class="hljs-string">"testkey"</span>));
    }
}
</code></pre>
<h2 data-id="heading-13">PowerMock最佳实践与注意事项</h2>
<h3 data-id="heading-14">谨慎使用PowerMock</h3>
<p>虽然PowerMock功能强大，但过度使用可能是代码设计问题的信号。<strong>以下是一些使用原则</strong>：</p>
<ul>
<li><strong>优先考虑重构</strong>：如果代码中大量使用PowerMock，应该考虑重构代码以提高可测试性。例如，将静态方法改为实例方法，通过依赖注入解耦等。</li>
<li><strong>仅用于遗留代码</strong>：在新项目中，优先通过良好设计避免使用PowerMock，仅在处理难以修改的遗留代码时大量使用。</li>
<li><strong>隔离使用</strong>：将使用PowerMock的测试类单独放置，防止影响其他测试的执行效率。</li>
</ul>
<h3 data-id="heading-15">性能优化建议</h3>
<p>PowerMock由于使用自定义类加载器和字节码操作，会对测试执行时间产生显著影响。以下是一些优化建议：</p>
<ul>
<li><strong>最小化@PrepareForTest</strong>：只将确实需要Mock的类放入注解中，减少字节码操作的范围。</li>
<li><strong>合理使用Mockito</strong>：对于常规Mock场景，仍然使用Mockito，仅在必要时使用PowerMock。</li>
<li><strong>避免过度Mock</strong>：不要Mock系统类或简单值对象，这会给测试带来不必要的复杂性。</li>
</ul>
<h3 data-id="heading-16">版本选择与兼容性</h3>
<p><strong>版本兼容性</strong>：PowerMock与Mockito、JUnit的版本兼容性非常重要。以下是推荐组合：</p>
<ul>
<li>PowerMock 2.x + Mockito 2.x + JUnit 4.12+</li>
<li>避免混合使用不兼容的版本</li>
</ul>
<p><strong>JUnit 5支持</strong>：截至目前，PowerMock不支持JUnit 5，这是选择测试框架时需要考虑的因素。</p>
<h3 data-id="heading-17">常见问题排查</h3>
<p><strong>类加载器冲突</strong>：使用<code>@PowerMockIgnore</code>注解排除冲突的包。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PowerMockIgnore({"javax.management.*", "javax.net.ssl.*"})</span>
</code></pre>
<p><strong>版本冲突</strong>：确保所有Mock相关库的版本兼容。</p>
<p><strong>静态方法验证失败</strong>：记住每次验证静态方法调用时都要先调用<code>verifyStatic()</code>。</p>
<h2 data-id="heading-18">总结</h2>
<p>PowerMock解决了传统Mock框架无法处理的棘手问题。通过字节码操作技术，PowerMock能够Mock静态方法、final类、私有方法和构造函数等"不可Mock"的元素。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li>填补了Mockito的功能空白，完善了Java单元测试的工具链。</li>
<li>特别适用于处理遗留代码和第三方库的测试问题。</li>
<li>通过提高代码覆盖率来提升软件质量。</li>
</ul>
<p><strong>适用边界</strong>：</p>
<ul>
<li>不是所有场景都适合使用PowerMock，新项目应优先考虑良好的代码设计。</li>
<li>在测试性能和代码可维护性之间需要权衡。</li>
<li>建议将使用范围控制在确实必要的复杂场景中。</li>
</ul>
<p>希望本文能帮助你在实际项目中更好地使用PowerMock。如果你有任何问题或经验分享，欢迎在评论区留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于WASM的纯前端Office解决方案：在线编辑/导入导出/权限切换（已开源）]]></title>    <link>https://juejin.cn/post/7575425466904723519</link>    <guid>https://juejin.cn/post/7575425466904723519</guid>    <pubDate>2025-11-23T08:32:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466904723519" data-draft-id="7575425466904690751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于WASM的纯前端Office解决方案：在线编辑/导入导出/权限切换（已开源）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T08:32:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Electrolux"/> <meta itemprop="url" content="https://juejin.cn/user/3004311888208296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于WASM的纯前端Office解决方案：在线编辑/导入导出/权限切换（已开源）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3004311888208296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Electrolux
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:32:31.000Z" title="Sun Nov 23 2025 08:32:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">效果展示</h2>
<p>所有操作均在浏览器进行，先来看看最终效果：</p>
<p>🌐 <strong>在线演示</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmvp-onlyoffice.vercel.app%2F" target="_blank" title="https://mvp-onlyoffice.vercel.app/" ref="nofollow noopener noreferrer">mvp-onlyoffice.vercel.app/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc97b2347465410184d7b237954a61bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxlY3Ryb2x1eA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491695&amp;x-signature=J3BA0nQbpFpxQGMHFE5DLw59lks%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">核心功能演示</h3>
<ul>
<li>✅ <strong>文档上传</strong>：支持本地文件直接上传</li>
<li>✅ <strong>实时编辑</strong>：流畅的文档编辑体验</li>
<li>✅ <strong>格式转换</strong>：基于WASM的文档格式转换</li>
<li>✅ <strong>导出保存</strong>：一键导出编辑后的文档</li>
<li>✅ <strong>模式切换</strong>：只读/可编辑模式自由切换</li>
<li>✅ <strong>多语言支持</strong>：中英文界面无缝切换</li>
</ul>
<h2 data-id="heading-2">技术架构</h2>
<h3 data-id="heading-3">核心技术栈</h3>
<ul>
<li><strong>React 19</strong> + <strong>Next.js 15</strong>：现代化前端框架</li>
<li><strong>OnlyOffice SDK</strong>：官方JavaScript SDK，提供文档编辑核心能力</li>
<li><strong>WebAssembly (x2t-wasm)</strong>：文档格式转换引擎</li>
<li><strong>TypeScript</strong>：类型安全的开发体验</li>
<li><strong>EventBus</strong>：事件驱动的架构设计</li>
<li><strong>IndexedDB</strong>：WASM文件缓存优化</li>
</ul>
<p>tip: 事实上不依赖于 react，你可以拿到 项目中的 src/onlyoffice-comp ,然后接入到任何系统中去，接入层可以参考 <code>src/app/excel/page.tsx</code>等应用层文件</p>
<h3 data-id="heading-4">架构流程图</h3>
<pre><code class="hljs language-scss" lang="scss">用户上传文档
    ↓
React组件层
    ↓
EditorManager (编辑器管理器)
    ↓
X2T Converter (WASM转换器)
    ↓
OnlyOffice SDK (文档编辑器)
    ↓
EventBus (事件总线)
    ↓
导出/保存文档
</code></pre>
<h2 data-id="heading-5">WASM文档转换核心流程</h2>
<h3 data-id="heading-6">转换流程图解</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户选择文件
<span class="hljs-code">    ↓
浏览器读取文件
    ↓
WASM虚拟文件系统
    ↓
X2T引擎执行转换
    ↓
生成二进制数据 + 媒体资源
    ↓
OnlyOffice编辑器加载
</span></code></pre>
<h3 data-id="heading-7">核心代码实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/onlyoffice-comp/lib/x2t.ts</span>

<span class="hljs-comment">/**
 * X2T 工具类 - 负责文档转换功能
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">X2TConverter</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">x2tModule</span>: <span class="hljs-title class_">EmscriptenModule</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-comment">// 支持的文件类型映射</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">DOCUMENT_TYPE_MAP</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">DocumentType</span>&gt; = {
    <span class="hljs-attr">docx</span>: <span class="hljs-string">'word'</span>,
    <span class="hljs-attr">doc</span>: <span class="hljs-string">'word'</span>,
    <span class="hljs-attr">odt</span>: <span class="hljs-string">'word'</span>,
    <span class="hljs-attr">rtf</span>: <span class="hljs-string">'word'</span>,
    <span class="hljs-attr">txt</span>: <span class="hljs-string">'word'</span>,
    <span class="hljs-attr">xlsx</span>: <span class="hljs-string">'cell'</span>,
    <span class="hljs-attr">xls</span>: <span class="hljs-string">'cell'</span>,
    <span class="hljs-attr">ods</span>: <span class="hljs-string">'cell'</span>,
    <span class="hljs-attr">csv</span>: <span class="hljs-string">'cell'</span>,
    <span class="hljs-attr">pptx</span>: <span class="hljs-string">'slide'</span>,
    <span class="hljs-attr">ppt</span>: <span class="hljs-string">'slide'</span>,
    <span class="hljs-attr">odp</span>: <span class="hljs-string">'slide'</span>,
  };

  <span class="hljs-comment">/**
   * 转换文档格式
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">convertDocument</span>(<span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ConversionResult</span>&gt; {
    <span class="hljs-comment">// 初始化WASM模块</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">ensureReady</span>();
    
    <span class="hljs-comment">// 写入虚拟文件系统</span>
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> file.<span class="hljs-title function_">arrayBuffer</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x2tModule</span>!.<span class="hljs-property">FS</span>.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'/working/origin'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data));
    
    <span class="hljs-comment">// 执行C++编译的转换模块</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeConversion</span>(<span class="hljs-string">'/working/params.xml'</span>);
    
    <span class="hljs-comment">// 提取转换结果和媒体文件</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">bin</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">x2tModule</span>!.<span class="hljs-property">FS</span>.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'/working/output.bin'</span>),
      <span class="hljs-attr">media</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectMediaFiles</span>() <span class="hljs-comment">// 提取图片等资源</span>
    };
  }
}
</code></pre>
<h2 data-id="heading-8">编辑器管理器：Proxy模式的安全封装</h2>
<p>项目采用Proxy模式对OnlyOffice编辑器实例进行安全封装，提供统一的API接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/onlyoffice-comp/lib/editor-manager.ts</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditorManager</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">editor</span>: <span class="hljs-title class_">DocEditor</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-comment">// 使用 Proxy 提供安全的访问接口</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">createProxy</span>(): <span class="hljs-title class_">DocEditor</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>({} <span class="hljs-keyword">as</span> <span class="hljs-title class_">DocEditor</span>, {
      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">_target, prop</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'destroyEditor'</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">destroy</span>();
        }
        <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'sendCommand'</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>) {
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">sendCommand</span>(params);
            }
          };
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span> ? (<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)[prop] : <span class="hljs-literal">undefined</span>;
      },
    });
  }
  
  <span class="hljs-comment">// 导出文档（事件驱动）</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">export</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">SaveDocumentData</span>&gt; {
    <span class="hljs-keyword">const</span> editor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">if</span> (!editor) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Editor not available'</span>);
    }
    
    <span class="hljs-comment">// 触发保存</span>
    (editor <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-title function_">downloadAs</span>();
    
    <span class="hljs-comment">// 等待保存事件</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> onlyofficeEventbus.<span class="hljs-title function_">waitFor</span>(
      <span class="hljs-variable constant_">ONLYOFFICE_EVENT_KEYS</span>.<span class="hljs-property">SAVE_DOCUMENT</span>, 
      <span class="hljs-number">10000</span>
    );
    
    <span class="hljs-keyword">return</span> result;
  }
}
</code></pre>
<h2 data-id="heading-9">事件驱动架构：EventBus解耦设计</h2>
<p>项目采用事件总线机制，实现组件间的松耦合通信：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/onlyoffice-comp/lib/eventbus.ts</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">EventKey</span>, <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 监听事件</span>
  on&lt;K <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EventKey</span>&gt;(<span class="hljs-attr">key</span>: K, <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">data: EventDataMap[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(key, []);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(key)!.<span class="hljs-title function_">push</span>(callback);
  }
  
  <span class="hljs-comment">// 等待事件触发（返回 Promise）</span>
  waitFor&lt;K <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EventKey</span>&gt;(<span class="hljs-attr">key</span>: K, timeout?: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">EventDataMap</span>[K]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> timeoutId = timeout
        ? <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(key, handleEvent);
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Event <span class="hljs-subst">${key}</span> timeout after <span class="hljs-subst">${timeout}</span>ms`</span>));
          }, timeout)
        : <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEvent</span> = (<span class="hljs-params">data: EventDataMap[K]</span>) =&gt; {
        <span class="hljs-keyword">if</span> (timeoutId) <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(key, handleEvent);
        <span class="hljs-title function_">resolve</span>(data);
      };

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(key, handleEvent);
    });
  }
}
</code></pre>
<h3 data-id="heading-10">支持的事件类型</h3>
<ul>
<li><code>saveDocument</code> - 文档保存完成事件</li>
<li><code>documentReady</code> - 文档加载就绪事件</li>
<li><code>loadingChange</code> - 加载状态变化事件</li>
</ul>
<h2 data-id="heading-11">核心功能特性</h2>
<h3 data-id="heading-12">1. 国际化支持</h3>
<p>项目内置多语言支持，可自由切换中英文界面：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 切换语言</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLanguageSwitch</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> newLang = currentLang === <span class="hljs-string">'zh'</span> ? <span class="hljs-string">'en'</span> : <span class="hljs-string">'zh'</span>;
  <span class="hljs-title function_">setCurrentLang</span>(newLang);
  
  <span class="hljs-comment">// 如果编辑器已存在，重新创建以应用新语言</span>
  <span class="hljs-keyword">if</span> (editorManager.<span class="hljs-title function_">exists</span>()) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleView</span>(fileName, file);
  }
};
</code></pre>
<h3 data-id="heading-13">2. 导入导出功能</h3>
<p>完整的文档导入导出能力：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导出文档</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">export</span>();
<span class="hljs-comment">// result 包含: { fileName, fileType, binData, media }</span>

<span class="hljs-comment">// 转换并下载</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertBinToDocument</span>(
  result.<span class="hljs-property">binData</span>, 
  result.<span class="hljs-property">fileName</span>,
  <span class="hljs-variable constant_">FILE_TYPE</span>.<span class="hljs-property">XLSX</span>, 
  result.<span class="hljs-property">media</span>
);

<span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([buffer.<span class="hljs-property">data</span>], {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span>
});
<span class="hljs-comment">// 执行下载操作</span>
</code></pre>
<h3 data-id="heading-14">3. 只读/可编辑模式切换</h3>
<p>灵活的权限控制，支持动态切换编辑模式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设置为只读模式</span>
<span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">setReadOnly</span>(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 切换为可编辑模式</span>
<span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">setReadOnly</span>(<span class="hljs-literal">false</span>);

<span class="hljs-comment">// 查询当前模式</span>
<span class="hljs-keyword">const</span> isReadOnly = editorManager.<span class="hljs-title function_">getReadOnly</span>();
</code></pre>
<p><strong>实现原理</strong>：</p>
<ul>
<li>从只读切换到可编辑：重新创建编辑器实例</li>
<li>从可编辑切换到只读：使用<code>processRightsChange</code>命令</li>
</ul>
<h3 data-id="heading-15">4. IndexedDB缓存优化</h3>
<p>使用IndexedDB缓存WASM文件，大幅提升二次加载速度：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 拦截 fetch，缓存 WASM 文件到 IndexedDB</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">interceptFetch</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> originalFetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>;
  
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">input: RequestInfo | URL</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-comment">// 先尝试从缓存读取</span>
    <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCachedWasm</span>(url);
    <span class="hljs-keyword">if</span> (cached) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(cached, {
        <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/wasm'</span> }
      });
    }
    
    <span class="hljs-comment">// 缓存未命中，从网络加载并缓存</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">originalFetch</span>(input);
    <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cacheWasm</span>(url, arrayBuffer);
    
    <span class="hljs-keyword">return</span> response;
  };
}
</code></pre>
<h2 data-id="heading-16">使用示例</h2>
<h3 data-id="heading-17">基本使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createEditorView } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/onlyoffice-comp/lib/x2t'</span>;
<span class="hljs-keyword">import</span> { editorManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/onlyoffice-comp/lib/editor-manager'</span>;

<span class="hljs-comment">// 创建编辑器视图</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">createEditorView</span>({
  <span class="hljs-attr">file</span>: fileObject,        <span class="hljs-comment">// File 对象（可选）</span>
  <span class="hljs-attr">fileName</span>: <span class="hljs-string">'document.xlsx'</span>, <span class="hljs-comment">// 文件名</span>
  <span class="hljs-attr">isNew</span>: <span class="hljs-literal">false</span>,            <span class="hljs-comment">// 是否新建文档</span>
  <span class="hljs-attr">readOnly</span>: <span class="hljs-literal">false</span>,        <span class="hljs-comment">// 是否只读</span>
  <span class="hljs-attr">lang</span>: <span class="hljs-string">'zh'</span>,             <span class="hljs-comment">// 界面语言</span>
});

<span class="hljs-comment">// 导出文档</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">export</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'导出成功:'</span>, result);
</code></pre>
<h3 data-id="heading-18">React组件集成</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/app/excel/page.tsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExcelPageContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [readOnly, setReadOnly] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [currentLang, setCurrentLang] = useState&lt;<span class="hljs-string">'zh'</span> | <span class="hljs-string">'en'</span>&gt;(<span class="hljs-string">'zh'</span>);
  
  <span class="hljs-comment">// 上传文档</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleView</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileName: <span class="hljs-built_in">string</span>, file?: File</span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">initializeOnlyOffice</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createEditorView</span>({
      file,
      fileName,
      <span class="hljs-attr">isNew</span>: !file,
      readOnly,
      <span class="hljs-attr">lang</span>: currentLang,
    });
  };
  
  <span class="hljs-comment">// 导出文档</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExport</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">export</span>();
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertBinToDocument</span>(
      result.<span class="hljs-property">binData</span>, 
      result.<span class="hljs-property">fileName</span>,
      <span class="hljs-variable constant_">FILE_TYPE</span>.<span class="hljs-property">XLSX</span>, 
      result.<span class="hljs-property">media</span>
    );
    <span class="hljs-comment">// 下载文件...</span>
  };
  
  <span class="hljs-comment">// 切换只读模式</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleReadOnly</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> newReadOnly = !readOnly;
    <span class="hljs-title function_">setReadOnly</span>(newReadOnly);
    <span class="hljs-keyword">await</span> editorManager.<span class="hljs-title function_">setReadOnly</span>(newReadOnly);
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* UI组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-19">项目结构</h2>
<pre><code class="hljs language-csharp" lang="csharp">mvp-onlyoffice/
├── src/
│   ├── app/              <span class="hljs-meta"># Next.js 应用页面</span>
│   │   ├── excel/        <span class="hljs-meta"># Excel 编辑器页面</span>
│   │   ├── docs/         <span class="hljs-meta"># Word 编辑器页面</span>
│   │   └── ppt/          <span class="hljs-meta"># PowerPoint 编辑器页面</span>
│   ├── onlyoffice-comp/  <span class="hljs-meta"># OnlyOffice 组件库</span>
│   │   └── lib/
│   │       ├── editor-manager.ts  <span class="hljs-meta"># 编辑器管理器</span>
│   │       ├── x2t.ts             <span class="hljs-meta"># 文档转换模块</span>
│   │       ├── eventbus.ts        <span class="hljs-meta"># 事件总线</span>
│   │       └── utils.ts            <span class="hljs-meta"># 工具函数</span>
│   └── components/       <span class="hljs-meta"># 通用组件</span>
├── <span class="hljs-keyword">public</span>/               <span class="hljs-meta"># 静态资源</span>
│   ├── web-apps/         <span class="hljs-meta"># OnlyOffice Web 应用资源</span>
│   ├── sdkjs/            <span class="hljs-meta"># OnlyOffice SDK 资源</span>
│   └── wasm/             <span class="hljs-meta"># WebAssembly 转换器</span>
└── onlyoffice-x2t-wasm/  <span class="hljs-meta"># x2t-wasm 源码</span>
</code></pre>
<h2 data-id="heading-20">部署方案</h2>
<h3 data-id="heading-21">Vercel一键部署</h3>
<p>项目已配置静态导出，可直接部署到Vercel：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
npm install

<span class="hljs-comment"># 构建项目</span>
npm run build

<span class="hljs-comment"># Vercel 会自动检测并部署</span>
</code></pre>
<p>🌐 <strong>在线演示</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmvp-onlyoffice.vercel.app%2F" target="_blank" title="https://mvp-onlyoffice.vercel.app/" ref="nofollow noopener noreferrer">mvp-onlyoffice.vercel.app/</a></p>
<h3 data-id="heading-22">静态文件部署</h3>
<p>项目支持静态导出，构建后的文件可部署到任何静态托管服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建静态文件</span>
npm run build

<span class="hljs-comment"># 输出目录: out/</span>
<span class="hljs-comment"># 可直接部署到 GitHub Pages、Netlify、Nginx 等</span>
</code></pre>
<h2 data-id="heading-23">技术优势总结</h2>













































<table><thead><tr><th>特性</th><th>传统方案</th><th>本方案</th></tr></thead><tbody><tr><td>数据安全</td><td>❌ 需要上传服务器</td><td>✅ 完全本地处理</td></tr><tr><td>部署成本</td><td>❌ 需要后端服务</td><td>✅ 纯静态部署</td></tr><tr><td>格式支持</td><td>⚠️ 有限格式</td><td>✅ 30+种格式</td></tr><tr><td>离线使用</td><td>❌ 需要网络</td><td>✅ 完全离线</td></tr><tr><td>性能优化</td><td>⚠️ 依赖网络</td><td>✅ IndexedDB缓存</td></tr><tr><td>国际化</td><td>⚠️ 需额外配置</td><td>✅ 内置支持</td></tr><tr><td>权限控制</td><td>⚠️ 复杂实现</td><td>✅ 简单API</td></tr></tbody></table>
<h2 data-id="heading-24">技术原理</h2>
<h3 data-id="heading-25">使用x2t-wasm替代OnlyOffice服务</h3>
<p>传统OnlyOffice集成需要：</p>
<ol>
<li>搭建OnlyOffice Document Server</li>
<li>配置文档转换服务</li>
<li>处理文档上传下载</li>
<li>管理服务器资源</li>
</ol>
<p>本方案通过WASM技术：</p>
<ol>
<li>在浏览器中直接运行x2t转换引擎</li>
<li>使用虚拟文件系统处理文档</li>
<li>完全客户端化，无需服务器</li>
</ol>
<h3 data-id="heading-26">参考项目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQihoo360%2Fse-office" target="_blank" title="https://github.com/Qihoo360/se-office" ref="nofollow noopener noreferrer">Qihoo360/se-office</a> - se-office扩展，提供基于开放标准的全功能办公生产力套件</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcryptpad%2Fonlyoffice-x2t-wasm" target="_blank" title="https://github.com/cryptpad/onlyoffice-x2t-wasm" ref="nofollow noopener noreferrer">cryptpad/onlyoffice-x2t-wasm</a> - CryptPad WebAssembly文件转换工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Franuts%2Fdocument" target="_blank" title="https://github.com/ranuts/document" ref="nofollow noopener noreferrer">ranuts/document</a> - 参考静态资源实现</li>
</ul>
<h2 data-id="heading-27">开源地址</h2>
<p>🔗 <strong>GitHub仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyour-username%2Fmvp-onlyoffice" target="_blank" title="https://github.com/your-username/mvp-onlyoffice" ref="nofollow noopener noreferrer">mvp-onlyoffice</a></p>
<h2 data-id="heading-28">总结</h2>
<p>本项目提供了一个完整的纯前端OnlyOffice集成方案，通过WASM技术实现了文档格式转换的本地化，结合React和OnlyOffice SDK，打造了一个功能完善、性能优秀的文档编辑器。</p>
<p><strong>核心亮点</strong>：</p>
<ul>
<li>🚀 纯前端架构，无需后端服务</li>
<li>🔒 数据完全本地化，保护隐私安全</li>
<li>⚡ 基于WASM的高性能转换</li>
<li>🌏 内置国际化支持</li>
<li>📦 支持导入导出</li>
<li>🔐 灵活的权限控制</li>
</ul>
<p>欢迎Star和Fork，一起推动前端Office编辑技术的发展！</p>
<hr/>
<p><strong>相关阅读</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.onlyoffice.com%2Fzh-CN%2Fdocs%2Fdocs-api%2Fusage-api%2Fconfig%2Fdocument%2F" target="_blank" title="https://api.onlyoffice.com/zh-CN/docs/docs-api/usage-api/config/document/" ref="nofollow noopener noreferrer">OnlyOffice API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebassembly.org%2F" target="_blank" title="https://webassembly.org/" ref="nofollow noopener noreferrer">WebAssembly 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fdeploying%2Fstatic-exports" target="_blank" title="https://nextjs.org/docs/app/building-your-application/deploying/static-exports" ref="nofollow noopener noreferrer">Next.js 静态导出</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试日志elk之ES数据查询与数据同步]]></title>    <link>https://juejin.cn/post/7575425466904739903</link>    <guid>https://juejin.cn/post/7575425466904739903</guid>    <pubDate>2025-11-23T08:36:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575425466904739903" data-draft-id="7575442779038793770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试日志elk之ES数据查询与数据同步"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-23T08:36:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试日志elk之ES数据查询与数据同步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:36:47.000Z" title="Sun Nov 23 2025 08:36:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">1.ES持久层技术<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e71b2815054e41c3a5854e4d2a53f1ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=jlTZBLahH27cIf3s5ZhjweZlzgY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h2>
<h3 data-id="heading-1">1.1 ES应用场景<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b3f551db8dd4c08b1dfbaa0ad5a3201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=0BUiIMFn0j%2B1rVYQAvsEZ8InnAA%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h3>
<p><strong>1全文搜索</strong></p>
<p>Elasticsearch可以用于实现全文搜索功能，例如搜索引擎、文档管理系统、电子商务搜索等。它支持复杂的查询语句、中文分词、近似搜索等功能，可以快速地搜索并返回匹配的结果。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3938e6b79c648f2ae9599c9e4f88772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=T8yNTzVvHw24z45TTIZ%2FnYVi9%2FE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><strong>2日志分析</strong></p>
<p>Elasticsearch可以用于实现实时日志分析，例如监控系统、异常日志分析等。它可以快速地索引和搜索大量的日志数据，并支持聚合、可视化等功能，可以帮助用户快速定位和解决问题。 <strong>ELK</strong></p>
<p><strong>3业务分析</strong></p>
<p>Elasticsearch可以用于实现业务分析，例如企业数据分析、市场调研等。它可以对海量数据进行搜索、聚合和分析，支持多种数据格式和数据源，例如数据库、日志、网页等，可以帮助用户了解业务情况、市场趋势等。</p>
<p><strong>4搜索推荐</strong></p>
<p>Elasticsearch可以用于实现搜索推荐功能，例如电商搜索推荐、新闻推荐等。它可以根据用户的搜索历史、行为等数据，进行个性化推荐，并支持实时更新和调整推荐结果。</p>
<p><strong>5地理信息系统</strong></p>
<p>Elasticsearch可以用于实现地理信息系统，例如地图搜索、位置分析等。它支持地理坐标索引和查询，可以快速地搜索和聚合地理数据，并支持地图可视化等功能。 <strong>GEO</strong></p>
<h3 data-id="heading-2">1.2 Elasticsearch持久层技术盘点</h3>
<ol>
<li><strong>Elasticsearch官方提供的Java客户端</strong>： Elasticsearch官方提供了Java客户端（<strong>High-Level REST Client和Low-Level REST Client</strong>），可以通过Java代码与ES进行交互。这些客户端提供了各种API和方法，用于执行索引、搜索、更新、删除等操作，并且支持与ES集群的连接和通信。</li>
<li><strong>Spring Data Elasticsearch</strong>： Spring Data Elasticsearch是SpringData框架提供的一个模块，用于简化与Elasticsearch的集成和操作。对于比较简单的查询操作，Spring Data Elasticsearch可以比较简便地实现查询功能，但是对于比较复杂的查询，<strong>Spring Data Elasticsearch使用起来依然比较繁琐</strong>，而且它的版本更新速度跟不上 Elasticsearch官方版本的更新速度，所以企业应用较少。</li>
<li><strong>Jest</strong>： Jest是一个开源的Java HTTP客户端库，专门用于与Elasticsearch进行交互。它提供了一组易于使用的API和方法，可以执行索引、搜索、更新、删除等操作。Jest具有良好的可扩展性和灵活性，并且支持与ES集群的连接和通信。</li>
<li><strong>Transport Client</strong>（已弃用）： Transport Client是Elasticsearch早期版本中提供的Java客户端，自Elasticsearch 7.0版本起，<strong>Transport Client已被官方弃用</strong>。</li>
<li><strong>Elegent Data Elasticsearch</strong>：Elegent Data Elasticsearch是Elegent Data的子框架。Elegent Data是传智教育研究院开发的一款针对NoSQL的持久层框架。Elegent Data Elasticsearch 改变了大家头疼的Elasticsearch持久化操作的难题。因为它可以<strong>让用户按照myBatisPlus的风格来操作Elasticsearch</strong>，轻松上手。</li>
</ol>
<p>使用Elegent Data Elasticsearch框架，可以让你的程序更优雅。我们选择Elegent Data Elasticsearch框架。</p>
<h3 data-id="heading-3">1.3 Elegent Data</h3>
<h4 data-id="heading-4">1.3.1 Elegent Data 简介</h4>
<p>Elegent Data是一个优雅的NoSQL数据持久层框架。</p>
<p>（1）使用这个组件可以让你更轻松、更优雅地在项目中操作 Elasticsearch 等NoSQL数据库，风格类似于MyBatisPlus，让你更专注业务代码的开发。</p>
<p>（2）支持用户自行扩展。</p>
<p>开源项目地址 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fchuanzhiliubei%2Felegent-data" title="https://gitee.com/chuanzhiliubei/elegent-data" target="_blank" ref="nofollow noopener noreferrer">gitee.com/chuanzhiliu…</a></p>
<p>我们看一下Elegent Data框架的系统架构图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56b9e8f6cc44070b5a8a06ba7b073bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=3J7j7sFyDBiZWTDsJIXsqHnLAIE%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h4 data-id="heading-5">1.3.2 Elegent Data Elasticsearch快速入门</h4>
<p>（1）在pom文件中添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.data<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-data-elasticsearch7<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）application.yml添加配置</p>
<pre><code class="hljs language-less" lang="less">spring:
  elasticsearch:
    <span class="hljs-attribute">rest</span>:
      <span class="hljs-attribute">uris</span>: <span class="hljs-attribute">http</span>:<span class="hljs-comment">//127.0.0.1:9201</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）创建DTO</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDTO</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> id;<span class="hljs-comment">//id</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> orderNo;<span class="hljs-comment">//订单编号</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> innerCode;<span class="hljs-comment">//机器编号</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> addr;<span class="hljs-comment">//点位地址</span>
  
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> skuId;<span class="hljs-comment">//商品id</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> skuName;<span class="hljs-comment">//商品名称</span>
  
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> status;<span class="hljs-comment">//订单状态:0-创建;1-支付完成;2-出货成功;3-出货失败;</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> amount;<span class="hljs-comment">//支付金额</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> bill;<span class="hljs-comment">//分账金额</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> price;<span class="hljs-comment">//商品金额</span>
  
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（4）创建服务类</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderEsService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Elasticsearch7DataService&lt;OrderDTO&gt;</span> </span>{

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（5）创建Controller类，测试分页查询、列表查询、增加、删除、修改操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderEsService</span> orderEsService;


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/page"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Pager</span>&lt;<span class="hljs-title class_">OrderDTO</span>&gt; <span class="hljs-title function_">findPage</span>(<span class="hljs-params"/>){
        <span class="hljs-title class_">ElegentQueryWapper</span> elegentQueryWapper=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ElegentQueryWapper</span>();
        elegentQueryWapper.<span class="hljs-title function_">from</span>(<span class="hljs-string">"order"</span>)
                .<span class="hljs-title function_">eq</span>(<span class="hljs-string">"status"</span>,<span class="hljs-string">"1"</span>)
                .<span class="hljs-title function_">eq</span>(<span class="hljs-string">"sku_name"</span>,<span class="hljs-string">"统一奶茶"</span>);
        <span class="hljs-keyword">return</span>  orderEsService.<span class="hljs-title function_">page</span>(elegentQueryWapper,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>);
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/list"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">OrderDTO</span>&gt; <span class="hljs-title function_">findList</span>(<span class="hljs-params"/>){
        <span class="hljs-title class_">ElegentQueryWapper</span> elegentQueryWapper=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ElegentQueryWapper</span>();
        elegentQueryWapper.<span class="hljs-title function_">from</span>(<span class="hljs-string">"order"</span>);
        <span class="hljs-keyword">return</span>  orderEsService.<span class="hljs-title function_">list</span>(elegentQueryWapper);
    }


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/statistics"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">StatisticsVo</span>&gt; <span class="hljs-title function_">findStatistics</span>(<span class="hljs-params"/>){
        <span class="hljs-title class_">ElegentQueryWapper</span> queryWapper=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ElegentQueryWapper</span>();
        queryWapper.<span class="hljs-title function_">from</span>(<span class="hljs-string">"order"</span>)
                .<span class="hljs-title function_">eq</span>(<span class="hljs-string">"status"</span>,<span class="hljs-string">"1"</span>)
                .<span class="hljs-title function_">count</span>(<span class="hljs-string">"price"</span>).<span class="hljs-title function_">groupBy</span>(<span class="hljs-string">"sku_id"</span>);
        <span class="hljs-keyword">return</span>  orderEsService.<span class="hljs-title function_">statistics</span>(queryWapper);
    }


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/save"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">save</span>(<span class="hljs-params"/>){
        <span class="hljs-title class_">OrderDTO</span> orderDTO=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
        orderDTO.<span class="hljs-title function_">setId</span>(200L);
        orderDTO.<span class="hljs-title function_">setAddr</span>(<span class="hljs-string">"测试地址"</span>);
        orderDTO.<span class="hljs-title function_">setStatus</span>(<span class="hljs-number">1</span>);
        orderEsService.<span class="hljs-title function_">save</span>(<span class="hljs-string">"order"</span>,orderDTO.<span class="hljs-title function_">getId</span>()+<span class="hljs-string">""</span>,orderDTO);
    }


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/update"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>){
        <span class="hljs-title class_">OrderDTO</span> orderDTO=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
        orderDTO.<span class="hljs-title function_">setId</span>(200L);
        orderDTO.<span class="hljs-title function_">setAddr</span>(<span class="hljs-string">"地址测试"</span>);
        orderDTO.<span class="hljs-title function_">setStatus</span>(<span class="hljs-number">2</span>);
        orderEsService.<span class="hljs-title function_">update</span>(<span class="hljs-string">"order"</span>,orderDTO.<span class="hljs-title function_">getId</span>()+<span class="hljs-string">""</span>,orderDTO);
    }


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/delete"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params"/>){
        orderEsService.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"order"</span>,<span class="hljs-string">"200"</span>);
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/findById/{id}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OrderDTO</span> <span class="hljs-title function_">findById</span>(<span class="hljs-params"> <span class="hljs-meta">@PathVariable</span>(<span class="hljs-string">"id"</span>) <span class="hljs-built_in">String</span> id</span>){
        <span class="hljs-title class_">OrderDTO</span> order = orderEsService.<span class="hljs-title function_">findById</span>(<span class="hljs-string">"order"</span>, id);
        <span class="hljs-keyword">return</span> order;
    }

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-6">2.订单搜索</h2>
<h3 data-id="heading-7">2.1 需求分析</h3>
<p>用户在微信小程序中能够根据日期范围检索查询历史订单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b07548397224bcfb5d9018bd3cee06f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=8GB3PidTOi0b2xH0ADOqebXB6BY%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p>除了小程序，还有管理后台也需要订单查询功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b11b093a0b4f4c81e9c0c217a230c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=quf0Q6UnVy%2FYjtURPVeAVNCUxdY%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h3 data-id="heading-8">2.2 实现思路</h3>
<p>（1）在订单微服务，封装查询逻辑，通过使用<strong>ElegentData查询</strong>elasticsearch中的订单数据。</p>
<p>（2）在C端网关路由到订单微服务</p>
<h3 data-id="heading-9">2.3 代码实现</h3>
<h4 data-id="heading-10">2.3.1 订单微服务搜索功能的实现</h4>
<p>（1）在订单微服务的pom文件中，添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.data<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-data-elasticsearch7<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）在订单微服务的配置中（配置中心），添加以下配置</p>
<pre><code class="hljs language-less" lang="less">spring:
  elasticsearch:
    <span class="hljs-attribute">rest</span>:
      <span class="hljs-attribute">uris</span>: <span class="hljs-attribute">http</span>:<span class="hljs-comment">//127.0.0.1:9201</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）创建搜索服务类 OrderEsService</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderEsService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Elasticsearch7DataService&lt;OrderVO&gt;</span> </span>{

}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（4）OrderService新增方法</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 搜索订单
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">pageIndex</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">pageSize</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">orderNo</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">openId</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">startDate</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">endDate</span>
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-title class_">Pager</span>&lt;<span class="hljs-title class_">OrderVO</span>&gt; <span class="hljs-title function_">search</span>(<span class="hljs-title class_">Integer</span> pageIndex, <span class="hljs-title class_">Integer</span> pageSize, <span class="hljs-title class_">String</span> orderNo, <span class="hljs-title class_">String</span> openId, <span class="hljs-title class_">String</span> startDate, <span class="hljs-title class_">String</span> endDate);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（5）OrderServiceImpl实现此方法</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderEsService</span> orderEsService;

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Pager</span>&lt;<span class="hljs-title class_">OrderVO</span>&gt; <span class="hljs-title function_">search</span>(<span class="hljs-params">Integer pageIndex, Integer pageSize, <span class="hljs-built_in">String</span> orderNo, <span class="hljs-built_in">String</span> openId, <span class="hljs-built_in">String</span> startDate, <span class="hljs-built_in">String</span> endDate</span>) {
    <span class="hljs-title class_">ElegentQueryWapper</span> elegentQueryWapper=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ElegentQueryWapper</span>();
    elegentQueryWapper.<span class="hljs-title function_">from</span>(<span class="hljs-string">"order"</span>);
    <span class="hljs-keyword">if</span>(orderNo!=<span class="hljs-literal">null</span>){
        elegentQueryWapper.<span class="hljs-title function_">eq</span>(<span class="hljs-string">"order_no"</span>,orderNo);
    }
    <span class="hljs-keyword">if</span>(openId!=<span class="hljs-literal">null</span>){
        elegentQueryWapper.<span class="hljs-title function_">eq</span>(<span class="hljs-string">"open_id"</span>,openId);
    }
    <span class="hljs-keyword">if</span>(startDate!=<span class="hljs-literal">null</span> &amp;&amp; endDate!=<span class="hljs-literal">null</span>){
        elegentQueryWapper.<span class="hljs-title function_">between</span>(  <span class="hljs-string">"create_time"</span>,startDate, endDate  );
    }
   <span class="hljs-keyword">return</span> orderEsService.<span class="hljs-title function_">page</span>(elegentQueryWapper, pageIndex, pageSize);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（6）OrderController调用 service的search方法</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 搜索
 * @param pageIndex
 * @param pageSize
 * @param orderNo
 * @param openId
 * @param startDate
 * @param endDate
 * @return
 */</span>
<span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/search"</span>)
public Pager&lt;OrderVO&gt; <span class="hljs-built_in">search</span>(
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"pageIndex"</span>,required = false,defaultValue = <span class="hljs-string">"1"</span>) Integer pageIndex,
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"pageSize"</span>,required = false,defaultValue = <span class="hljs-string">"10"</span>) Integer pageSize,
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"orderNo"</span>,required = false,defaultValue = <span class="hljs-string">""</span>) String orderNo,
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"openId"</span>,required = false,defaultValue = <span class="hljs-string">""</span>) String openId,
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"startDate"</span>,required = false,defaultValue = <span class="hljs-string">""</span>) String startDate,
        <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"endDate"</span>,required = false,defaultValue = <span class="hljs-string">""</span>) String endDate){
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.search</span>(pageIndex,pageSize,orderNo,openId,startDate,endDate);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-11">2.3.2 C端网关路由配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-comment">#订单微服务</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-service</span>
        <span class="hljs-attr">predicates:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span>
        <span class="hljs-attr">filters:</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-12">2.4 测试</h3>
<p>VSCODE的测试脚本</p>
<pre><code class="hljs language-css" lang="css">GET http://{{hostname}}:{{port}}/<span class="hljs-attribute">order</span>/search?pageIndex=<span class="hljs-number">1</span>&amp;pageSize=<span class="hljs-number">10</span>&amp;openId=oJ9WJ5MhIS-hiwuUX0GmsHDzqTyQ&amp;startDate=<span class="hljs-number">2020</span>-<span class="hljs-number">01</span>-<span class="hljs-number">01</span>&amp;endDate=<span class="hljs-number">2023</span>-<span class="hljs-number">12</span>-<span class="hljs-number">31</span> HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-attribute">Content</span>-Type: {{contentType}}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-13">3. 数据同步技术</h2>
<p>我们现在已经实现了ES数据的查询功能，但是ES数据从哪里来呀？这就需要数据同步技术实现数据从Mysql到ES的搬运。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7253a186b274e8b993929be85b8f02f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491806&amp;x-signature=9sICyHlwrTQARGDxLT0VWpQ3Pic%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<h3 data-id="heading-14">3.1 技术方案选型</h3>
<h4 data-id="heading-15">3.1.1 MQ异步通知</h4>
<p>MQ（消息队列）异步通知是一种常见的异步通信模式，用于在分布式系统中实现解耦和异步处理。它通过将消息发送到消息队列中，然后由消费者从队列中获取消息并进行处理，实现了消息的异步传递和处理。</p>
<p>我们可以在数据的增删改方法操作上，发送数据MQ， 消费者接受数据后进行数据的同步处理。</p>
<h4 data-id="heading-16">3.1.2 canal</h4>
<p>阿里的Canal是一种开源的分布式数据库复制与实时数据订阅系统。它由阿里巴巴集团开发，旨在解决大规模分布式数据库的数据同步和实时数据订阅的需求。</p>
<p>Canal基于MySQL的主从复制原理，通过解析MySQL的binlog日志来实现数据的增量订阅和同步。它支持多种订阅方式，包括基于数据库表的增量订阅、基于全局事务的增量订阅以及基于时间点的全量订阅。Canal可以将数据库的变更数据实时地推送给订阅者，使得订阅者能够实时获取到数据库的最新数据。</p>
<h4 data-id="heading-17">3.1.3 Elegent Pipe</h4>
<p>传智教育研究院研发的一款数据同步框架。它的实现原理与Canal是类似的，都是基于MySQL的主从复制原理，通过解析MySQL的binlog日志来实现数据的增量订阅和同步。与Canal不同的是，Elegent Pipe 是分为服务端和客户端两个部分，服务端处理监听后，通过ElegentAC将数据库变动的内容发送给客户端，所以ElegentPipe 更适合微服务架构应用程序的开发。</p>
<p>开源项目地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fchuanzhiliubei%2Felegent-pipe" title="https://gitee.com/chuanzhiliubei/elegent-pipe" target="_blank" ref="nofollow noopener noreferrer">gitee.com/chuanzhiliu…</a></p>
<h3 data-id="heading-18">3.2 Elegent Pipe快速入门</h3>
<h4 data-id="heading-19">3.2.1 开启binlog</h4>
<p>mysql8是默认开启binlog的 ，mysql5.7默认不开启.</p>
<p>我们可以通过以下命令查看binlog是否开启</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%log_bin%'</span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>要开启MySQL的binlog，您可以按照以下步骤进行操作：</p>
<ol>
<li>编辑MySQL的配置文件 <code>my.cnf</code> 或 <code>my.ini</code>，具体位置根据您的操作系统和MySQL版本而定。</li>
<li>找到并修改以下参数：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[mysqld]</span>
<span class="hljs-attr">log-bin</span>=mysql-bin
<span class="hljs-attr">server-id</span>=<span class="hljs-number">1</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ul>
<li>
<ul>
<li><code>log-bin</code>：指定binlog日志文件的前缀名称，可以根据需要自定义。</li>
<li><code>server-id</code>：指定MySQL实例的唯一标识，每个MySQL实例需要有不同的server-id。</li>
</ul>
</li>
</ul>
<ol>
<li>保存并退出配置文件。</li>
<li>重启MySQL服务，以使配置生效。</li>
</ol>
<p>开启binlog后，MySQL将开始记录所有的数据库更改操作，并将其写入binlog文件中。这些binlog文件可以用于数据恢复、数据备份、数据同步等用途。</p>
<p>请注意，在修改MySQL配置文件之前，请确保您对MySQL有足够的权限，并且备份了重要的数据。此外，开启binlog会增加MySQL的写入负载，因此在生产环境中，应该根据系统的性能和资源情况进行评估和调整。</p>
<h4 data-id="heading-20">3.2.2 代码实现</h4>
<p>（1）在服务端的工程引入依赖 （由于ElegentPipe依赖ElegentAC，所以还要引入elegent-AC-mqtt ）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.pipe<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-pipe-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.ac<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-AC-mqtt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）在服务端的配置引入依赖</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">pipe:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">passwd:</span> <span class="hljs-string">HuangShu_2023</span>
    <span class="hljs-attr">tables:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">demo:users</span>
  <span class="hljs-attr">ac:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">1883</span>
    <span class="hljs-attr">clientId:</span> <span class="hljs-string">transmitServer</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">public</span>
    <span class="hljs-attr">keepAliveInterval:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">connectionTimeout:</span> <span class="hljs-number">60</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8888</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）在客户端工程引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.pipe<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-pipe-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.ac<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-AC-mqtt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（4）在客户端工程的配置文件添加</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">ac:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">1883</span>
    <span class="hljs-attr">clientId:</span> <span class="hljs-string">transmitClient</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">public</span>
    <span class="hljs-attr">keepAliveInterval:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">connectionTimeout:</span> <span class="hljs-number">60</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（5）在客户端工程添加类用于处理数据增删改之后的操作</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@ElegentPipe</span>(db=<span class="hljs-string">"demo"</span>,table = <span class="hljs-string">"users"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserTransmit</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PipeService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">insertHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改前数据："</span>+transmitDTO.<span class="hljs-title function_">getBefore</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后数据："</span>+transmitDTO.<span class="hljs-title function_">getAfter</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改前数据："</span>+transmitDTO.<span class="hljs-title function_">getBefore</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后数据："</span>+transmitDTO.<span class="hljs-title function_">getAfter</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改前数据："</span>+transmitDTO.<span class="hljs-title function_">getBefore</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后数据："</span>+transmitDTO.<span class="hljs-title function_">getAfter</span>());
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-21">3.2.3 常见错误</h4>
<p>Java监听mysql的binlog 报错解决办法</p>
<p>报错：com.github.shyiko.mysql.binlog.network.AuthenticationException: Client does not support authentication protocol requested by server; consider upgrading MySQL client</p>
<p>这是你的mysql认证规则不正确导致的。</p>
<p>解决方案：在mysql中执行以下命令</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">user</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> identified <span class="hljs-keyword">with</span> mysql_native_password <span class="hljs-keyword">by</span> <span class="hljs-string">'密码'</span>;  <span class="hljs-comment">--修改认证规则</span>
flush privileges; <span class="hljs-comment">--刷新权限</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-22">4. 订单数据同步</h2>
<h3 data-id="heading-23">4.1 需求分析</h3>
<p>将订单库中的订单表数据，同步到ES中</p>
<h3 data-id="heading-24">4.2 实现思路</h3>
<p>（1）创建数据同步的服务端模块，引入elegent-pipe-server以及Springboot依赖</p>
<p>（2）在服务端模块配置文件中，配置监听dkd_order库的tb_order表。</p>
<p>（3）在订单微服务引入elegent-pipe-client</p>
<p>（4）编写数据处理类，接收数据，并通过Elegent Data Elasticsearch将数据保存到 elasticsearch中。</p>
<h3 data-id="heading-25">4.3 代码实现</h3>
<h4 data-id="heading-26">4.3.1 构建数据同步服务</h4>
<p>（1）创建dkd_pipe_service模块,Pom文件引入elegent-pipe-server以及Springboot依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.pipe<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-pipe-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.ac<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-AC-mqtt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）创建配置文件 application.yml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">elegent:</span>
  <span class="hljs-attr">pipe:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">passwd:</span> <span class="hljs-string">HuangShu_2023</span>
    <span class="hljs-attr">tables:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">dkd_order:tb_order</span>
  <span class="hljs-attr">ac:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">1883</span>
    <span class="hljs-attr">clientId:</span> <span class="hljs-string">transmitServer</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">public</span>
    <span class="hljs-attr">keepAliveInterval:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">connectionTimeout:</span> <span class="hljs-number">60</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">pipe-service</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8999</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）添加启动类</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransmitServerApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">TransmitServerApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-27">4.3.2 同步逻辑的实现</h4>
<p>（1）订单微服务 添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.elegent.pipe<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elegent-pipe-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）订单微服务 创建数据同步处理类</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 接受订单数据同步
 */</span>
<span class="hljs-meta">@ElegentPipe</span>(db=<span class="hljs-string">"dkd_order"</span>,table = <span class="hljs-string">"tb_order"</span>)
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderPipe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PipeService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderEsService</span> orderEsService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">insertHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Serializable</span>&gt; orderMap = transmitDTO.<span class="hljs-title function_">getAfter</span>();
        orderEsService.<span class="hljs-title function_">save</span>(<span class="hljs-string">"order"</span>, (<span class="hljs-title class_">Long</span>)orderMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"id"</span>)+<span class="hljs-string">""</span>,orderMap );
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ES插入订单数据{}"</span>,orderMap);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Serializable</span>&gt; orderMap = transmitDTO.<span class="hljs-title function_">getAfter</span>();
        orderEsService.<span class="hljs-title function_">update</span>(<span class="hljs-string">"order"</span>,(<span class="hljs-title class_">Long</span>)orderMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"id"</span>)+<span class="hljs-string">""</span>,orderMap );
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ES修改订单数据{}"</span>,orderMap);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteHandler</span>(<span class="hljs-params">TransmitDTO transmitDTO</span>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Serializable</span>&gt; orderMap = transmitDTO.<span class="hljs-title function_">getBefore</span>();
        orderEsService.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"order"</span>,(<span class="hljs-title class_">Long</span>)orderMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"id"</span>)+<span class="hljs-string">""</span>);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ES删除订单数据{}"</span>,orderMap);
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[快 2026 年了，谁还在为 this 挠头？看完这篇让你彻底从懵圈到精通]]></title>    <link>https://juejin.cn/post/7575807729722359842</link>    <guid>https://juejin.cn/post/7575807729722359842</guid>    <pubDate>2025-11-23T08:00:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575807729722359842" data-draft-id="7575104251866284042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="快 2026 年了，谁还在为 this 挠头？看完这篇让你彻底从懵圈到精通"/> <meta itemprop="keywords" content="JavaScript,前端,Node.js"/> <meta itemprop="datePublished" content="2025-11-23T08:00:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            快 2026 年了，谁还在为 this 挠头？看完这篇让你彻底从懵圈到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:00:36.000Z" title="Sun Nov 23 2025 08:00:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>各位 前端er 们，谁还没被 JavaScript 里的 <code>this</code> 虐过？这玩意简直就是编程界的 <strong>“变脸大师”</strong>，翻脸比孙猴子还快。一会儿是全局对象，一会儿是某个实例，一会儿又跟着调用场景改头换面，这不就是活生生的 “百变马丁” 吗？写代码时总被它搞得晕头转向，调试半天就因为 <code>this</code> 指向不对，真有种 <strong>“一杯茶一包烟，一个this改一天”</strong> 的崩溃感。如果你还搞不懂 JavaScript 里面的 <code>this</code>,那这篇将让你搞定原理并且拿捏用法，把那些绕人的绑定规则掰扯得明明白白！</p>
<h3 data-id="heading-1">一、为什么要有 this？—— 让代码 “优雅到飞起”</h3>
<p>想象一下，你写了个函数，想在不同对象上复用它。要是没有<code>this</code>，就得每次手动传对象参数，想想都麻烦！<code>this</code>就像个 “智能代词”，悄咪咪地帮我们传递对象引用。通俗来说就是 <code>this</code> 提供了一种更优雅的方式来隐式的传递一个对象引用，可以让代码更简洁易于复用。</p>
<p>比如下面这两种写法：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">identify</span>(context) {
    return context<span class="hljs-selector-class">.name</span><span class="hljs-selector-class">.toUpperCase</span>();
}
function <span class="hljs-attribute">speak</span>(context) {
    <span class="hljs-selector-tag">var</span> greet = 'hello, <span class="hljs-selector-tag">I</span> am ' + <span class="hljs-built_in">identify</span>(context);
    console<span class="hljs-selector-class">.log</span>(greet);
}
<span class="hljs-selector-tag">var</span> myname = {
    name: <span class="hljs-string">'henry'</span>
}
<span class="hljs-attribute">speak</span>(myname);
</code></pre>
<p>我们定义 <code>identify</code> 函数接收对象参数，返回其 <code>name</code> 大写值；<code>speak</code> 函数接收对象，调用 <code>identify</code> 拼接问候语并打印；最后创建含 <code>name</code> 的 <code>myname</code> 对象，传给 <code>speak</code> 执行，输出 <code>hello, I am HENRY</code>。核心是<strong>手动传递</strong>对象参数实现复用。</p>
<p>输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf3a10c989a48f8bbad9aa01b590edb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=ndRrkutsgIwH9NLuQh1awex5y9I%3D" alt="image.png" loading="lazy"/></p>
<p>结果没错，<code>henry</code> 确确实实大写了，但每次都要手动传参你自己不嫌麻烦吗？这时候我们请出大名鼎鼎的--<code>this</code>！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">identify</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> greet = <span class="hljs-string">'hello, I am '</span> + identify.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(greet);
}
<span class="hljs-keyword">var</span> myname = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>
}
speak.<span class="hljs-title function_">call</span>(myname);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a11d00940b6d4722a15f8e2ae7f6adc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=mXiVLKZgc7NIU3nAsGcl%2Bo3FJYs%3D" alt="image.png" loading="lazy"/></p>
<p>诶，你会发现，我2个函数都没有传参，但是都输出了结果。这里有2个关键点：</p>
<ul>
<li>用 <code>call</code> 强制让 <code>speak</code> 的 <code>this</code> 指向 <code>myname</code>；</li>
<li><code>speak</code> 内部调用 <code>identify.call(this)</code> 时，<code>this</code> 已绑定 <code>myname</code>，因此 <code>identify</code> 也能访问 <code>myname.name</code>。</li>
</ul>
<p>至于<code>call</code>是个啥，往下看吧，嘿嘿！</p>
<h3 data-id="heading-2">二、this 用在哪？—— “代词” 的舞台</h3>
<p><code>this</code>就像 “变色龙”，在不同场景下指代不同的角色：</p>
<ul>
<li><strong>全局作用域</strong>：在浏览器里，<code>this</code>就等于<code>window</code>（就像全局舞台的 “C 位”）。比如你直接写<code>console.log(this)</code>，打印的就是<code>window</code>对象。</li>
</ul>
<p>比如我在 Google Chrome 上面写<code>console.log(this)</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07785dce0614bf5b46bec9805371ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=4rEz48d8iytdOPiD6HijzftVf9o%3D" alt="image.png" loading="lazy"/></p>
<p>但在node.js里，打印出来的是<code>global</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ee9a520ea04d23b3bb720ee6908fcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=gFtVWwP%2FmRm7YcT1iDOyi%2Fl88k8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>函数作用域</strong>：这就是<code>this</code>的 “主战场”了，在这它的身份变化可多了，咱们接着往下看。</li>
</ul>
<h3 data-id="heading-3">三、this 的绑定规则 —— 给 this “定规矩”</h3>
<h4 data-id="heading-4">1. 默认绑定 —— “自由散漫” 的 this</h4>
<p>当函数被<strong>独立调用</strong>时，<code>this</code>就指向<code>window</code>（严格模式下是<code>undefined</code>）。就像你一个人逛街，没对象陪~</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
function foo() {
    console.log(this.a)<span class="hljs-comment">;</span>
}
function bar() {
    var <span class="hljs-attr">a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    foo()<span class="hljs-comment">;</span>
}
bar()<span class="hljs-comment">;</span>
</code></pre>
<p>灵魂拷问：输出结果是多少？肯定有人说<code>2</code>，而且还不少！你不服了，这调用<code>bar()</code>，然后里面在调用<code>foo()</code>, 不应该根据变量提升先找<code>bar()</code>里面的<code>a = 2</code>吗？说明前面还没看懂嘻嘻，当函数被独立调用--就一个<code>foo()</code>，它就是指向全局，不管那些杂七杂八的，你就是一个人逛街，没有对象陪，所以答案就是全局的<code>a = 1</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a379da0232fd4236a4907503ceacc9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=t3f4m1wC6QLi%2FfJk2mzjS%2BaXUT0%3D" alt="image.png" loading="lazy"/></p>
<p>最后就是打印出了<code>1</code>，这就是函数的独立调用。</p>
<h4 data-id="heading-5">2. 隐式绑定 —— “依附对象” 的 this</h4>
<p>当函数被<strong>上下文对象调用</strong>时，<code>this</code>就绑定到这个对象上。比如：</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
    console.log(this)<span class="hljs-comment">;</span>
}
var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
var <span class="hljs-attr">obj</span> = {
    foo: foo
}
obj.foo()<span class="hljs-comment">;</span>
</code></pre>
<p>好，最后的调用<code>obj.foo()</code>。首先它不是单独调用，那么就要用到<strong>上下文对象调用</strong>，咱们一句话说清核心：<code>obj.foo()</code> 是通过对象 <code>obj</code> 调用函数 <code>foo</code>，所以 <code>foo</code> 里的 <code>this</code> 直接绑定到 <code>obj</code>，最终打印 <code>obj</code> 整个对象。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2844f0af6e73459a9f0e9e1847e592e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=3pxzCNi920tAcZUMdGKQ6a0m2PI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">3. 隐式丢失 —— “层层剥离” 的 this</h4>
<p>当函数被多层对象调用时，<code>this</code>会指向<strong>最近的那个对象</strong>。是不是有点像小时候玩的游戏🎮 “击鼓传花”，传到最后花落谁家？</p>
<p>好，那看一个例子：</p>
<pre><code class="hljs language-css" lang="css">function foo() {
    console<span class="hljs-selector-class">.log</span>(this<span class="hljs-selector-class">.a</span>);
}
<span class="hljs-selector-tag">var</span> obj = {
    <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>,
    foo: foo
}
<span class="hljs-selector-tag">var</span> obj2 = {
    <span class="hljs-selector-tag">a</span>: <span class="hljs-number">2</span>,
    foo: obj
}
obj2<span class="hljs-selector-class">.foo</span><span class="hljs-selector-class">.foo</span>();
</code></pre>
<p>OK，懵了⊙▃⊙吧。怎么回事连续调用2次，最后输出的到底是<code>obj</code>里的还是<code>obj2</code>里的？答案是<code>obj</code>！</p>
<p><strong>关键误区提醒</strong>：</p>
<p>不要以为 <code>obj2</code> 在前面，<code>this</code> 就指向 <code>obj2</code>！</p>
<p><code>this</code> 只看 <strong>「函数执行时的直接调用者」</strong>，和外层嵌套的对象（<code>obj2</code>）无关。如果想让 <code>this</code> 指向 <code>obj2</code>，需要让 <code>obj2</code> 直接调用 <code>foo</code>（比如 <code>obj2.foo = foo; obj2.foo()</code>）。</p>
<p>就好比我们英语的 <strong>就近原则</strong>，离谁近就指向谁！</p>
<p>输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4c5549bd148495d90237bfb9a6088ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=zez8A4FLcydF5hlgtAmDnOYM6Zo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">4. 显式绑定 —— “强行指定” 的 this（call、apply、bind 三位好室友登场！）</h4>
<p>咱们可以把这三个方法想象成你的三个 “热心室友”：</p>
<ul>
<li><strong>call 室友</strong>：急性子，直接帮函数把<code>this</code>绑定到目标对象，参数一个个传。</li>
<li><strong>apply 室友</strong>：爱偷懒，参数打包成数组传给函数。</li>
<li><strong>bind 室友</strong>：慢性子，先绑定<code>this</code>和部分参数，返回一个 “半成品” 函数，想啥时候调用都行。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">var</span> obj = {
    <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>
}
function <span class="hljs-built_in">foo</span>(x, y) { 
    console<span class="hljs-selector-class">.log</span>(this.a, x + y);
}
foo<span class="hljs-selector-class">.call</span>(obj, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);    <span class="hljs-comment">// call室友出马</span>
foo<span class="hljs-selector-class">.apply</span>(obj, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]); <span class="hljs-comment">// apply室友偷懒</span>
const bar = foo<span class="hljs-selector-class">.bind</span>(obj, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);  
<span class="hljs-built_in">bar</span>();  <span class="hljs-comment">// bind室友慢性子</span>
</code></pre>
<ol>
<li><code>foo.call(obj, 1, 2)</code>：call 室友 “急性子”，直接把 foo 的 this 绑定到 obj，再逐个传入参数 1 和 2 → 打印 obj 的 a（1）和 1+2（3），输出：1 3；</li>
<li><code>foo.apply(obj, [1, 2])</code>：apply 室友 “爱偷懒”，同样绑定 this 到 obj，但参数要打包成数组 [1,2] 传入 → 结果和 call 一致，输出：1 3；</li>
<li><code>const bar = foo.bind(obj, 2, 3); bar()</code>：bind 室友 “慢性子”，先绑定 this 到 obj、预传参数 1 和 2，返回 “半成品” 函数 bar，调用 bar 时才执行 → 打印 obj 的 a（1）和 1+2（3），输出：1 3。</li>
</ol>
<p>结果和我们分析的一样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5899e8ff04b94c72a74cace92a0fc362~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=eaESjDe%2B3ptMCkYsWIDShML0ZuQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">5. new 绑定 —— “实例专属” 的 this</h4>
<p><code>new</code>关键字就像个 “专属定制工厂”，专门用构造函数为新对象 “量身打造” 身份。当我们用<code>new</code>调用构造函数时，<code>this</code>会直接绑定到这个刚创建的<strong>实例对象</strong>上，相当于工厂把定制好的 “专属身份” 直接赋给了新实例。</p>
<p>但这个 “定制工厂” 有个<strong>特殊规则</strong>,分三种情况:</p>
<p><strong>情况 1：正常定制</strong> —— 返回绑定 this 的实例</p>
<p>当构造函数里没有手动<code>return</code>，或者只<code>return</code>了<code>undefined</code>（默认隐含）时，工厂会按流程完成 “定制”，返回绑定了<code>this</code>的实例对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'henry'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出"henry"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);      <span class="hljs-comment">// 输出Person { name: "henry" }，this绑定生效</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9dfb60533a4af79a7d2e0889f0d080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=6FB358AMcLNNu%2B5m7YXSWZe5rZw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>情况 2：放弃定制</strong> —— return 引用类型，返回手动指定的对象</p>
<p>如果构造函数里主动<code>return</code>了一个<strong>引用类型</strong>（比如对象、数组、函数等复杂数据），相当于你给工厂递了一个 “现成产品”，工厂会直接放弃原本的定制流程，返回这个手动指定的引用类型，原本绑定<code>this</code>的实例会被直接忽略。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> }; 
}
<span class="hljs-keyword">let</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'harvest'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);      <span class="hljs-comment">// 输出{ age: 20 }，实例被忽略</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出undefined，拿不到原本的name属性</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17b7695c002c47f893a1903e851e6ffd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=tQe57Um4TKAXNfVHHsj%2B4yRNAuA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>情况 3：无视 return</strong> —— return 原始类型，依然返回实例</p>
<p>如果构造函数里<code>return</code>的是<strong>原始数据类型</strong>（比如数字、字符串、布尔值、null、undefined），这个<code>return</code>会被工厂 “无视”，依然按原规则返回绑定了<code>this</code>的实例对象，相当于你递了个 “无效产品”，工厂还是按定制流程来。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>; <span class="hljs-comment">// return 无效</span>
}
<span class="hljs-keyword">let</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'henry'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p3.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出"henry"，实例正常生效</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a9a661eade4e5da9cadc93475da495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=zwaQaMGNZ1tKJvZEDFwDpT8Tgsk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">6. 箭头函数 —— “没有 this” 的 this</h4>
<p>箭头函数里没有自己的<code>this</code>，它的<code>this</code>是<strong>外层非箭头函数的 this</strong>。就像 “小跟班”，永远跟着外层函数的<code>this</code>走，不会被任何绑定规则改变。</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
    var <span class="hljs-attr">bar</span> = () =&gt; {
        <span class="hljs-attr">this.a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    }
    bar()<span class="hljs-comment">;</span>
}
var <span class="hljs-attr">obj</span> = {
    a: 1,
    baz: foo
}
obj.baz()<span class="hljs-comment">;</span>
console.log(obj)<span class="hljs-comment">;</span>
</code></pre>
<p>再次灵魂拷问：<code>a</code> 是 1 还是 2 ？ 答案：<code>2</code> ！</p>
<p><strong>关键逻辑：</strong></p>
<ol>
<li><code>obj.baz()</code> 是<strong>隐式绑定</strong>：foo 函数被 obj 调用，所以 foo 里的<code>this</code>指向 obj；</li>
<li>箭头函数<code>bar</code>没有自己的<code>this</code>，直接 “偷” 了外层 foo 的<code>this</code>（也就是 obj）；</li>
<li>执行<code>bar()</code>时，<code>this.a = 2</code> 其实是给<code>obj.a</code>赋值，把原来的 1 改成了 2；</li>
<li>最后打印 obj，a 属性已经变成 2，结果就是 <code>{ a: 2, baz: 函数foo }</code>。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9a92f2c5f224de680f283a132db4316~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764489636&amp;x-signature=k2qlGEtEpbMiI9nrfxLAAGGJEoM%3D" alt="image.png" loading="lazy"/></p>
<p>OK，是不是觉得自己已经拿捏<code>this</code>了？</p>
<h2 data-id="heading-10">总结</h2>
<p>从 “自由散漫” 的默认绑定、“依附对象” 的隐式绑定，到 “强行指定” 的三个“热心”的室友，再到 “定制化” 的 new 绑定（三种情况），最后是 “粘人跟班” 的箭头函数 —— 只要找准场景对号入座，<code>this</code>就再也不会让你头疼啦！</p>
<blockquote>
<p>掌握<code>this</code>，让你的代码更上一层楼吧!</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK8 Lambda 加持：打造优雅通用的对象构建器]]></title>    <link>https://juejin.cn/post/7575119254313648154</link>    <guid>https://juejin.cn/post/7575119254313648154</guid>    <pubDate>2025-11-23T07:19:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575119254313648154" data-draft-id="7575182522411040806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK8 Lambda 加持：打造优雅通用的对象构建器"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-23T07:19:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只会写代码"/> <meta itemprop="url" content="https://juejin.cn/user/995479086189514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK8 Lambda 加持：打造优雅通用的对象构建器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/995479086189514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只会写代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:19:29.000Z" title="Sun Nov 23 2025 07:19:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常 Java 开发中，对象构建是高频操作。传统的<code>new 对象 + 链式setter</code>或手动编写 Builder 模式，要么代码冗余繁琐，要么需要重复开发模板代码。本文将基于 JDK8 的 Lambda 特性，实现一个通用、优雅、支持灵活校验的对象构建器，彻底解决对象构建的痛点。</p>
<h2 data-id="heading-0">一、痛点回顾：传统对象构建的困境</h2>
<p>先看一个常见场景：创建一个<code>User</code>对象并设置属性，部分属性需要校验（如年龄必须大于 0）。</p>
<h3 data-id="heading-1">1. 传统 setter 模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
user.setName(<span class="hljs-string">"张三"</span>);
user.setAge(<span class="hljs-number">25</span>);
user.setEmail(<span class="hljs-string">"zhangsan@xxx.com"</span>);
<span class="hljs-comment">// 校验逻辑散落各处</span>
<span class="hljs-keyword">if</span> (user.getAge() &lt;= <span class="hljs-number">0</span>) {
   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"年龄必须大于0"</span>);
}
</code></pre>
<ul>
<li>问题：代码冗长，缺乏链式调用的流畅性，校验逻辑与属性设置分离，维护成本高。</li>
</ul>
<h3 data-id="heading-2">2. 手动编写 Builder 模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBuilder</span> {
   <span class="hljs-keyword">private</span> User user;
   <span class="hljs-keyword">private</span> <span class="hljs-title function_">UserBuilder</span><span class="hljs-params">()</span> { user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(); }
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserBuilder <span class="hljs-title function_">builder</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBuilder</span>(); }
   <span class="hljs-keyword">public</span> UserBuilder <span class="hljs-title function_">name</span><span class="hljs-params">(String name)</span> {
       user.setName(name);
       <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
   }
   <span class="hljs-keyword">public</span> UserBuilder <span class="hljs-title function_">age</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
       <span class="hljs-keyword">if</span> (age &lt;= <span class="hljs-number">0</span>) {
           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"年龄必须大于0"</span>);
       }
       user.setAge(age);
       <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
   }
   <span class="hljs-comment">// 其他属性的setter...</span>
   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">build</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> user; }
}
<span class="hljs-comment">// 使用</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserBuilder.builder()
       .name(<span class="hljs-string">"张三"</span>)
       .age(<span class="hljs-number">25</span>)
       .email(<span class="hljs-string">"zhangsan@xxx.com"</span>)
       .build();
</code></pre>
<ul>
<li>问题：每个实体类都要编写对应的 Builder 类，重复代码多；校验逻辑与 Builder 强耦合，灵活性差。
有没有一种方式，既能享受 Builder 模式的链式优雅，又不用编写重复模板代码，还能灵活支持属性校验？答案是：用 JDK8 Lambda 实现通用构建器！</li>
</ul>
<h2 data-id="heading-3">二、核心设计：Lambda 构建器的实现原理</h2>
<p>核心思路：<strong>用函数式接口承接 setter 逻辑，通过 Lambda 表达式简化调用，封装构建逻辑为通用工具类</strong>。
整体结构分为两部分：</p>
<ol>
<li>函数式接口<code>SetterFunction</code>：定义属性设置行为</li>
<li>构建器类<code>InstanceBuilder</code>：封装实例创建、属性设置、校验逻辑</li>
</ol>
<h3 data-id="heading-4">1. 函数式接口：SetterFunction</h3>
<p>这是 Lambda 能生效的核心 —— 必须是<strong>函数式接口</strong>（仅一个抽象方法），用于承接 “对象 + 属性值” 的设置逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
* Setter方法函数式接口
* 承接对象的属性设置行为，为Lambda表达式提供目标类型
* <span class="hljs-doctag">@param</span> &lt;T&gt; 目标对象类型
* <span class="hljs-doctag">@param</span> &lt;P&gt; 属性值类型
*/</span>
<span class="hljs-meta">@FunctionalInterface</span> <span class="hljs-comment">// 显式声明函数式接口（可选，但推荐）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SetterFunction</span>&lt;T, P&gt; {
    <span class="hljs-comment">/**
    * 执行属性设置
    * <span class="hljs-doctag">@param</span> target 目标对象
    * <span class="hljs-doctag">@param</span> param 要设置的属性值
    */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(T target, P param)</span>;
    }
</code></pre>
<p>为什么不用 JDK 自带的<code>BiConsumer&lt;T, P&gt;</code>？
<code>BiConsumer</code>的方法名是<code>accept</code>，语义不够明确；而<code>SetterFunction</code>的<code>call</code>方法更直观体现 “执行属性设置” 的意图，且自定义接口可后续扩展（如添加默认方法），灵活性更高。</p>
<h3 data-id="heading-5">2. 核心构建器：InstanceBuilder</h3>
<p>封装实例创建、链式设置、属性校验、实例返回的完整逻辑，提供两种创建方式（新实例 / 现有实例），支持可选校验。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Objects;
<span class="hljs-keyword">import</span> java.util.function.Predicate;

<span class="hljs-comment">/**
 * 实例构建器
 * 用于构建和配置对象实例，支持链式调用设置属性值
 *
 * <span class="hljs-doctag">@param</span> &lt;T&gt; 要构建的实例类型
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstanceBuilder</span>&lt;T&gt; {

    <span class="hljs-comment">/** 正在构建的实例对象 */</span>
    <span class="hljs-keyword">private</span> T inst;

    <span class="hljs-comment">/**
     * 私有构造函数 - 基于现有实例创建构建器
     *
     * <span class="hljs-doctag">@param</span> inst 已存在的实例对象
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">InstanceBuilder</span><span class="hljs-params">(T inst)</span> {
        <span class="hljs-built_in">this</span>.inst = Objects.requireNonNull(inst, <span class="hljs-string">"Instance cannot be null"</span>);
    }

    <span class="hljs-comment">/**
     * 私有构造函数 - 基于类创建构建器（通过反射实例化）
     *
     * <span class="hljs-doctag">@param</span> instClass 要实例化的类
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">InstanceBuilder</span><span class="hljs-params">(Class&lt;T&gt; instClass)</span> {
        Objects.requireNonNull(instClass, <span class="hljs-string">"instClass cannot be null"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用无参构造函数创建实例</span>
            <span class="hljs-built_in">this</span>.inst = instClass.getDeclaredConstructor().newInstance();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to create instance of "</span> + instClass.getName(), e);
        }
    }

    <span class="hljs-comment">/**
     * 静态工厂方法 - 基于现有实例创建构建器
     *
     * <span class="hljs-doctag">@param</span> &lt;T&gt; 实例类型
     * <span class="hljs-doctag">@param</span> inst 已存在的实例对象
     * <span class="hljs-doctag">@return</span> InstBuilder实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; InstanceBuilder&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(T inst)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstanceBuilder</span>&lt;&gt;(inst);
    }

    <span class="hljs-comment">/**
     * 静态工厂方法 - 基于类创建构建器
     *
     * <span class="hljs-doctag">@param</span> &lt;T&gt; 实例类型
     * <span class="hljs-doctag">@param</span> instClass 要实例化的类
     * <span class="hljs-doctag">@return</span> InstBuilder实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; InstanceBuilder&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(Class&lt;T&gt; instClass)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstanceBuilder</span>&lt;&gt;(instClass);
    }

    <span class="hljs-comment">/**
     * 设置实例属性值
     * 使用函数式接口方式设置实例的特定属性，支持链式调用
     *
     * <span class="hljs-doctag">@param</span> &lt;V&gt; 属性值类型
     * <span class="hljs-doctag">@param</span> fnSet 设置属性的函数式接口
     * <span class="hljs-doctag">@param</span> v 要设置的属性值
     * <span class="hljs-doctag">@return</span> 当前构建器实例（支持链式调用）
     */</span>
    <span class="hljs-keyword">public</span> &lt;V&gt; InstanceBuilder&lt;T&gt; <span class="hljs-title function_">set</span><span class="hljs-params">(SetterFunction&lt;T, V&gt; fnSet, V v)</span>{
        fnSet.call(inst, v);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-comment">/**
     * 带校验的set方法（重载，想用时用，不想用还能用原来的）
     * <span class="hljs-doctag">@param</span> fnSet 设置属性的函数式接口
     * <span class="hljs-doctag">@param</span> v 要设置的属性值
     * <span class="hljs-doctag">@param</span> validator 校验器
     * <span class="hljs-doctag">@return</span> 当前构建器实例（支持链式调用）
     * <span class="hljs-doctag">@param</span> &lt;V&gt; 属性值类型
     */</span>
    <span class="hljs-keyword">public</span> &lt;V&gt; InstanceBuilder&lt;T&gt; <span class="hljs-title function_">set</span><span class="hljs-params">(SetterFunction&lt;T, V&gt; fnSet, V v, Predicate&lt;V&gt; validator)</span>{
        <span class="hljs-comment">// 先校验：符合条件才设置属性，不符合就报错</span>
        <span class="hljs-keyword">if</span> (!validator.test(v)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"属性值不对："</span> + v);
        }
        fnSet.call(inst, v); <span class="hljs-comment">// 校验通过再调用你原有的设置逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-comment">/**
     * 构建并返回配置完成的实例
     *
     * <span class="hljs-doctag">@return</span> 构建完成的实例对象
     */</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">build</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> inst;
    }
}
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino">核心设计亮点：
* 私有构造 + 静态工厂：限制创建方式，保证实例安全性
* 双重创建支持：既支持新实例创建（反射无参构造），也支持现有实例修改
* 重载 set 方法：普通设置 + 校验设置分离，按需使用，不侵入基础逻辑
* 函数式接口结合：`SetterFunction`承接 setter，`Predicate`承接校验，Lambda 简化调用

## 三、实战用法：<span class="hljs-number">3</span> 分钟上手优雅构建
下面通过 <span class="hljs-number">3</span> 个核心场景，演示如何用这个构建器简化开发。
### 准备工作：定义实体类
先定义一个普通实体类（无需任何改造，无侵入性）：

```java
<span class="hljs-comment">/**
* 普通实体类（无需实现任何接口/注解）
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> email;
    <span class="hljs-comment">// 无参构造（反射创建必需）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-comment">// getter/setter（常规生成即可）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{ <span class="hljs-keyword">this</span>.name = name; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> age; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(Integer age)</span> </span>{ <span class="hljs-keyword">this</span>.age = age; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> email; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setEmail</span><span class="hljs-params">(<span class="hljs-type">String</span> email)</span> </span>{ <span class="hljs-keyword">this</span>.email = email; }
}
</code></pre>
<h3 data-id="heading-6">场景 1：创建新实例（无参构造）</h3>
<p>通过<code>InstanceBuilder.of(Class)</code>创建新实例，链式设置属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 构建User实例：无校验</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> InstanceBuilder.of(User.class)
    .set(User::setName, <span class="hljs-string">"张三"</span>) <span class="hljs-comment">// Lambda替代setter调用</span>
    .set(User::setAge, <span class="hljs-number">25</span>)
    .set(User::setEmail, <span class="hljs-string">"zhangsan@xxx.com"</span>)
    .build();
System.out.println(user.getName()); <span class="hljs-comment">// 输出：张三</span>
</code></pre>
<h3 data-id="heading-7">场景 2：修改现有实例</h3>
<p>通过<code>InstanceBuilder.of(实例)</code>修改已有对象的属性（适合 DTO 转换、对象更新场景）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 已有实例</span>
<span class="hljs-type">User</span> <span class="hljs-variable">existingUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
existingUser.setName(<span class="hljs-string">"李四"</span>);
<span class="hljs-comment">// 修改现有实例的属性</span>
<span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> InstanceBuilder.of(existingUser)
    .set(User::setAge, <span class="hljs-number">30</span>)
    .set(User::setEmail, <span class="hljs-string">"lisi@xxx.com"</span>)
    .build();
System.out.println(updatedUser.getAge()); <span class="hljs-comment">// 输出：30</span>
System.out.println(updatedUser.getName()); <span class="hljs-comment">// 输出：李四（未修改的属性保留原值）</span>
</code></pre>
<h3 data-id="heading-8">场景 3：带属性校验的构建</h3>
<p>通过<code>set(SetterFunction, value, Predicate)</code>添加校验逻辑（如年龄 &gt; 0、邮箱非空）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">validUser</span> <span class="hljs-operator">=</span> InstanceBuilder.of(User.class)
        .set(User::setName, <span class="hljs-string">"王五"</span>, name -&gt; name.length() &gt;= <span class="hljs-number">2</span>) <span class="hljs-comment">// 姓名至少2个字符</span>
        .set(User::setAge, -<span class="hljs-number">5</span>, age -&gt; age &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">// 年龄必须大于0（故意传错值）</span>
        .set(User::setEmail, <span class="hljs-string">"wangwu@xxx.com"</span>, email -&gt; email.contains(<span class="hljs-string">"@"</span>)) <span class="hljs-comment">// 邮箱必须包含@</span>
        .build();
} <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {
    System.out.println(e.getMessage()); <span class="hljs-comment">// 输出：属性值校验失败：-5</span>
}
</code></pre>
<p>校验逻辑灵活可配置，支持任意复杂规则（如多条件组合、正则匹配等）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 复杂校验：邮箱必须包含@且长度&gt;5</span>
.set(User::setEmail, <span class="hljs-string">"ww@xxx.com"</span>, email -&gt; email.contains(<span class="hljs-string">"@"</span>) &amp;&amp; email.length() &gt; <span class="hljs-number">5</span>)
</code></pre>
<h2 data-id="heading-9">四、核心特性：为什么这个构建器值得用？</h2>
<h3 data-id="heading-10">1. 极简链式调用，代码更优雅</h3>
<p>Lambda 表达式替代了冗长的 setter 调用，链式写法一气呵成，代码可读性大幅提升。</p>
<h3 data-id="heading-11">2. 零侵入性，无需改造实体类</h3>
<p>实体类无需实现任何接口、添加任何注解，也不用编写 Builder 内部类，完全复用原有 getter/setter。</p>
<h3 data-id="heading-12">3. 灵活创建 + 修改，场景全覆盖</h3>
<p>支持 “新实例创建” 和 “现有实例修改” 两种场景，满足对象初始化、DTO 更新、属性批量修改等需求。</p>
<h3 data-id="heading-13">4. 可选校验机制，逻辑解耦</h3>
<p>校验逻辑通过<code>Predicate</code>传入，与属性设置分离，无需侵入实体类或构建器核心逻辑，按需启用。</p>
<h3 data-id="heading-14">5. JDK8 原生支持，无依赖</h3>
<p>仅依赖 JDK8 核心 API（Lambda、函数式接口、反射），无需引入第三方框架（如 Lombok），轻量化无冗余。</p>
<h2 data-id="heading-15">五、对比传统方案：优势一目了然</h2>

































<table><thead><tr><th>方案</th><th>代码简洁度</th><th>侵入性</th><th>校验支持</th><th>复用性</th></tr></thead><tbody><tr><td>传统 new+setter</td><td>低</td><td>无</td><td>差（散落）</td><td>无</td></tr><tr><td>手动编写 Builder</td><td>中</td><td>高（需写内部类）</td><td>中（耦合）</td><td>低（每个实体类单独写）</td></tr><tr><td>本文 Lambda 构建器</td><td>高</td><td>无</td><td>高（灵活）</td><td>高（通用）</td></tr></tbody></table>
<h2 data-id="heading-16">六、总结</h2>
<p>本文基于 JDK8 Lambda 特性，实现了一个通用、优雅、灵活的对象构建器。核心是通过<code>SetterFunction</code>函数式接口承接 setter 逻辑，结合<code>InstanceBuilder</code>封装构建流程，既解决了传统 setter 的繁琐，又避免了手动编写 Builder 的重复劳动。
这个构建器的核心价值在于：<strong>用极简的代码实现强大的功能，同时保持零侵入、高灵活、无依赖</strong>，适合在任何 JDK8 + 项目中使用，尤其适合多属性、需校验、频繁构建对象的场景。</p>
<h2 data-id="heading-17">七、总结</h2>
<p>若你厌倦了手动编写 Builder 的重复模板 —— 新增属性就得同步改 Builder，也受够了传统 setter 的冗长、校验逻辑的耦合，这个 Lambda 构建器正是解方。</p>
<p>它零模板代码、不改造实体类，一行 Lambda 搞定属性设置，校验随用随加，新实例创建或老对象修改都能极简链式承接，还无需第三方依赖，特别适合个人开发场景下快速复用。</p>
<p>下次构建对象时，直接用InstanceBuilder.of(User.class)开篇，体验 “5 行代码替代 20 行传统 Builder” 的清爽。本文前文已完整附上SetterFunction与InstanceBuilder源码，直接复制到项目中，即可重构下一次对象构建。</p>
<p>若使用中遇到疑问、有优化建议，欢迎留言交流；觉得实用也可收藏备用，方便后续自己复用或分享给有需要的开发者朋友。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Arthas 线上常用命令速查手册：Java 诊断神器，5 分钟定位线上问题！]]></title>    <link>https://juejin.cn/post/7575133880436228147</link>    <guid>https://juejin.cn/post/7575133880436228147</guid>    <pubDate>2025-11-23T07:38:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575133880436228147" data-draft-id="7575119254313680922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Arthas 线上常用命令速查手册：Java 诊断神器，5 分钟定位线上问题！"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-23T07:38:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sino爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/1873223544473431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Arthas 线上常用命令速查手册：Java 诊断神器，5 分钟定位线上问题！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223544473431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sino爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:38:59.000Z" title="Sun Nov 23 2025 07:38:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a4a87f485942cb92b2af3519bc6ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lub-eIseWtpuS5oA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764490187&amp;x-signature=BkgMikxh1aC3tyTrmZ8Mzbpa%2F88%3D" alt="1763883473870.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、Arthas 是什么？为什么用它？</h2>
<p>Arthas 是阿里巴巴开源的一款 Java 线上诊断工具，无需重启 JVM、无需修改代码，即可实时监控、诊断 Java 应用的运行状态。</p>
<h3 data-id="heading-1">✅ 适用场景</h3>



































<table><thead><tr><th>场景</th><th>传统方式</th><th>Arthas 方式</th></tr></thead><tbody><tr><td>线上 CPU 飙高</td><td><code>top</code> + <code>jstack</code> 手动抓栈</td><td><code>thread -n 3</code> 一键定位</td></tr><tr><td>接口响应慢</td><td>加日志 → 重新发布</td><td><code>trace</code> 追踪耗时</td></tr><tr><td>代码未生效</td><td>怀疑人生</td><td><code>jad</code> 反编译确认</td></tr><tr><td>异常信息不全</td><td>日志缺失</td><td><code>watch</code> 实时观测</td></tr><tr><td>热更新</td><td>重启服务</td><td><code>redefine</code> 热加载</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">二、快速安装与启动</h2>
<h3 data-id="heading-3">1. 一键启动（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash">curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar
</code></pre>
<h3 data-id="heading-4">2. 选择目标进程</h3>
<pre><code class="hljs language-bash" lang="bash">[INFO] Found existing java process, please choose one:
* [1]: 12345 demo.jar
  [2]: 67890 app.jar
</code></pre>
<p>输入编号（如 <code>1</code>）即可 attach。</p>
<hr/>
<h2 data-id="heading-5">三、线上高频命令速查表</h2>






































































<table><thead><tr><th>命令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>dashboard</code></td><td>实时系统面板（线程、内存、GC）</td><td><code>dashboard -i 2000 -n 5</code></td></tr><tr><td><code>thread</code></td><td>线程分析</td><td><code>thread -n 3</code>（最忙线程）<br/><code>thread -b</code>（死锁）</td></tr><tr><td><code>trace</code></td><td>方法耗时追踪</td><td><code>trace com.example.UserService getUserById</code></td></tr><tr><td><code>watch</code></td><td>观测方法入参/返回值/异常</td><td><code>watch com.example.UserService getUserById "{params, returnObj, throwExp}" -x 3</code></td></tr><tr><td><code>jad</code></td><td>反编译类或方法</td><td><code>jad com.example.UserService</code></td></tr><tr><td><code>sc</code></td><td>查找已加载的类</td><td><code>sc -d com.example.UserService</code></td></tr><tr><td><code>sm</code></td><td>查看类方法签名</td><td><code>sm -d com.example.UserService</code></td></tr><tr><td><code>monitor</code></td><td>方法调用统计</td><td><code>monitor -c 60 com.example.UserService getUserById</code></td></tr><tr><td><code>tt</code></td><td>方法调用时光隧道（记录与回放）</td><td><code>tt -t com.example.UserService getUserById</code></td></tr><tr><td><code>heapdump</code></td><td>导出堆快照</td><td><code>heapdump /tmp/dump.hprof</code></td></tr><tr><td><code>profiler</code></td><td>生成 CPU 火焰图</td><td><code>profiler start</code> → <code>profiler stop --format html</code></td></tr><tr><td><code>redefine</code></td><td>热更新 <code>.class</code> 文件</td><td><code>redefine /tmp/UserService.class</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">四、实战案例：5 分钟定位线上问题</h2>
<h3 data-id="heading-7">案例 1：CPU 飙高</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看最忙线程</span>
thread -n 1

<span class="hljs-comment"># 2. 查看堆栈</span>
thread 123

<span class="hljs-comment"># 3. 反编译问题方法</span>
jad com.example.MyService calculate
</code></pre>
<h3 data-id="heading-8">案例 2：接口响应慢</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 追踪方法耗时</span>
trace com.example.controller.UserController getProfile

<span class="hljs-comment"># 2. 发现数据库查询慢</span>
trace com.example.dao.UserDAO findById

<span class="hljs-comment"># 3. 查看 SQL 参数</span>
watch com.example.dao.UserDAO findById <span class="hljs-string">"{params[0]}"</span> -x 1
</code></pre>
<h3 data-id="heading-9">案例 3：代码未生效（热更新）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 反编译源码</span>
jad com.example.UserService --source-only &gt; /tmp/UserService.java

<span class="hljs-comment"># 2. 修改代码后编译</span>
mc /tmp/UserService.java -d /tmp

<span class="hljs-comment"># 3. 热加载</span>
redefine /tmp/com/example/UserService.class
</code></pre>
<hr/>
<h2 data-id="heading-10">五、注意事项与最佳实践</h2>

























<table><thead><tr><th>项目</th><th>建议</th></tr></thead><tbody><tr><td><strong>权限控制</strong></td><td>生产环境限制使用权限，避免误操作</td></tr><tr><td><strong>性能影响</strong></td><td><code>watch</code>、<code>trace</code> 会增强字节码，排查后及时 <code>stop</code> 或 <code>reset</code></td></tr><tr><td><strong>安全风险</strong></td><td>禁止将 Arthas 暴露在公网，建议通过隧道或跳板机访问</td></tr><tr><td><strong>命令冲突</strong></td><td><code>redefine</code> 与 <code>watch/trace</code> 冲突，使用前需 <code>reset</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">六、进阶：Docker &amp; K8s 集成建议</h2>
<h3 data-id="heading-12">Dockerfile 示例（预装 Arthas）</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM openjdk:8-jdk-alpine
COPY arthas /opt/arthas
COPY app.jar /app.jar
CMD java -jar /app.jar &amp; \
    sleep 15 &amp;&amp; \
    java -jar /opt/arthas/arthas-boot.jar --tunnel-server 'ws://tunnel-server:7777/ws' --app-name myapp
</code></pre>
<h3 data-id="heading-13">K8s 一键 attach（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash">helm install arthas arthas/arthas-k8s
arthas-k8s attach myapp-0
</code></pre>
<hr/>
<h2 data-id="heading-14">七、总结：一张图记住 Arthas</h2>
<pre><code class="hljs language-text" lang="text">+--------------------------------------------------+
|                    Arthas                        |
|                                                  |
|  dashboard → 系统面板                            |
|  thread   → 线程/死锁                            |
|  trace    → 方法耗时                             |
|  watch    → 入参/返回值/异常                      |
|  jad      → 反编译                               |
|  tt       → 时光隧道（记录+回放）                 |
|  redefine → 热更新                               |
|  profiler → 火焰图                               |
+--------------------------------------------------+
</code></pre>
<hr/>
<h2 data-id="heading-15">八、参考资料与延伸阅读</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2Fdoc%2F" target="_blank" title="https://arthas.aliyun.com/doc/" ref="nofollow noopener noreferrer">Arthas 官方文档（中文）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Farthas" target="_blank" title="https://github.com/alibaba/arthas" ref="nofollow noopener noreferrer">Arthas GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2Fdoc%2Ftunnel.html" target="_blank" title="https://arthas.aliyun.com/doc/tunnel.html" ref="nofollow noopener noreferrer">Arthas Tunnel 集中管理方案</a></li>
</ul>
<hr/>
<p><strong>© 2025 技术博客 | 转载请注明原作者与链接</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[synchronized 的底层原理及优化机制]]></title>    <link>https://juejin.cn/post/7575162322239930368</link>    <guid>https://juejin.cn/post/7575162322239930368</guid>    <pubDate>2025-11-23T08:03:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322239930368" data-draft-id="7575807729722343458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="synchronized 的底层原理及优化机制"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-11-23T08:03:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随风飘的云"/> <meta itemprop="url" content="https://juejin.cn/user/361110952753560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            synchronized 的底层原理及优化机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/361110952753560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随风飘的云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:03:06.000Z" title="Sun Nov 23 2025 08:03:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>synchronized</code> 是 Java 内置的<strong>悲观锁</strong>，核心作用是保证多线程环境下的<strong>原子性、可见性和有序性</strong>，从 JDK 1.6 开始进行了大量优化（如偏向锁、轻量级锁），性能大幅提升，成为并发编程中最常用的同步手段之一。</p>
<h2 data-id="heading-0">一、底层核心原理</h2>
<p><code>synchronized</code> 的实现依赖 <strong>Java 对象头（Mark Word）</strong>  和 <strong>监视器锁（Monitor）</strong> ，其核心逻辑是：<strong>通过竞争 Monitor 的所有权实现线程互斥</strong>。</p>
<h3 data-id="heading-1">1. 核心依赖：监视器锁（Monitor）</h3>
<p>Monitor 是 JVM 层面的抽象概念，本质是一种<strong>同步工具</strong>，可理解为 “锁的持有者管理机制”，每个 Java 对象都隐式关联一个 Monitor（即 “对象锁” 的底层载体）。</p>
<h4 data-id="heading-2">Monitor 的结构（简化）：</h4>
<ul>
<li><strong>Owner</strong>：当前持有锁的线程（同一时间只能有一个线程持有）。</li>
<li><strong>EntryList</strong>：等待获取锁的线程队列（线程处于 BLOCKED 状态）。</li>
<li><strong>WaitSet</strong>：调用 <code>wait()</code> 后释放锁的线程队列（线程处于 WAITING 状态）。</li>
</ul>
<h4 data-id="heading-3">Monitor 的核心逻辑：</h4>
<ol>
<li>
<p>线程尝试获取锁时，会竞争 Monitor 的 Owner 位置：</p>
<ul>
<li>若 Owner 为空，当前线程直接成为 Owner，持有锁。</li>
<li>若 Owner 已被其他线程占用，当前线程进入 EntryList 阻塞。</li>
</ul>
</li>
<li>
<p>线程释放锁时（退出同步块 / 方法、调用 <code>wait()</code>）：</p>
<ul>
<li>若调用 <code>wait()</code>，线程释放 Owner 身份，进入 WaitSet 等待被唤醒。</li>
<li>若正常释放，Owner 置空，JVM 从 EntryList 唤醒一个线程竞争锁。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">2. 锁状态的存储基础：Java 对象头（Mark Word）</h3>
<p>Java 对象在内存中分为 3 部分：<strong>对象头、实例数据、对齐填充</strong>。其中，<strong>对象头的 Mark Word 是存储锁状态的关键</strong>。</p>
<h4 data-id="heading-5">Mark Word 的结构（动态变化，32 位 JVM 示例）：</h4>

























<table><thead><tr><th>锁状态</th><th>Mark Word 存储内容</th></tr></thead><tbody><tr><td>无锁</td><td>HashCode（25 位） + 对象年龄（4 位） + 是否偏向锁（1 位，0） + 锁状态（2 位，01）</td></tr><tr><td>偏向锁</td><td>偏向线程 ID（23 位） + Epoch（2 位） + 对象年龄（4 位） + 是否偏向锁（1 位，1） + 锁状态（2 位，01）</td></tr><tr><td>轻量级锁</td><td>指向栈帧中 “锁记录（Lock Record）” 的指针（30 位） + 锁状态（2 位，00）</td></tr><tr><td>重量级锁</td><td>指向 Monitor 的指针（30 位） + 锁状态（2 位，11）</td></tr></tbody></table>
<ul>
<li>锁状态由 <strong>2 位标志位</strong> + <strong>是否偏向锁标志位</strong> 共同决定。</li>
<li>Mark Word 的动态变化是 <code>synchronized</code> 锁升级的核心依据。</li>
</ul>
<h3 data-id="heading-6">3. synchronized 的两种使用方式及底层实现</h3>
<p><code>synchronized</code> 可修饰<strong>方法</strong>或<strong>代码块</strong>，底层实现略有差异，但核心都是竞争 Monitor。</p>
<h4 data-id="heading-7">（1）修饰代码块：monitorenter + monitorexit 指令</h4>
<p>编译后，同步代码块的前后会插入 <code>monitorenter</code> 和 <code>monitorexit</code> 字节码指令：</p>
<ul>
<li><strong>monitorenter</strong>：线程进入时执行，尝试获取 Monitor 所有权（成功则 Owner 设为当前线程，失败则阻塞）。</li>
<li><strong>monitorexit</strong>：线程退出时执行，释放 Monitor 所有权（Owner 置空，唤醒等待线程）。</li>
</ul>
<blockquote>
<p>注意：编译器会生成 <strong>2 个 monitorexit</strong>：一个对应正常退出，一个对应异常退出（确保锁一定释放，避免死锁）。</p>
</blockquote>
<h4 data-id="heading-8">（2）修饰方法：ACC_SYNCHRONIZED 标志</h4>
<p>修饰方法时，字节码中不会插入指令，而是在<strong>方法表（method_info）</strong>  中添加 <code>ACC_SYNCHRONIZED</code> 标志：</p>
<ul>
<li>线程调用方法时，JVM 检查该标志：若存在，先获取 Monitor 锁，再执行方法体。</li>
<li>方法执行完毕（正常返回 / 抛出异常），JVM 自动释放 Monitor 锁。</li>
</ul>
<h4 data-id="heading-9">类锁 vs 对象锁</h4>
<ul>
<li><strong>对象锁</strong>：修饰实例方法或代码块（锁对象为 <code>this</code> 或自定义对象），竞争的是 “实例对象关联的 Monitor”。</li>
<li><strong>类锁</strong>：修饰静态方法或代码块（锁对象为 <code>XXX.class</code>），竞争的是 “类对象（Class 实例）关联的 Monitor”。</li>
<li>本质：类锁也是对象锁（Class 是 JVM 加载的单例对象），两者独立，互不干扰。</li>
</ul>
<h2 data-id="heading-10">二、JDK 1.6+ 核心优化机制</h2>
<p>早期 <code>synchronized</code> 是 “重量级锁”，线程竞争失败会直接阻塞（切换到内核态，开销大）。JDK 1.6 引入<strong>锁升级机制</strong>和其他优化，让 <code>synchronized</code> 在无竞争 / 轻度竞争场景下性能接近乐观锁（如 <code>ReentrantLock</code>）。</p>
<p>核心优化思路：<strong>根据竞争强度动态切换锁状态（无锁 → 偏向锁 → 轻量级锁 → 重量级锁），减少无竞争 / 轻度竞争时的开销</strong>。</p>
<h3 data-id="heading-11">1. 锁升级机制（核心优化）</h3>
<p>锁升级是不可逆的（只能从低开销向高开销升级），目的是 “按需分配资源”：无竞争时用偏向锁，轻度竞争时用轻量级锁，激烈竞争时用重量级锁。</p>
<h4 data-id="heading-12">（1）偏向锁：无竞争场景的最优解</h4>
<p><strong>适用场景</strong>：锁由同一线程多次获取，无其他线程竞争（如单线程循环调用同步方法）。<strong>核心思想</strong>：“偏向” 第一个获取锁的线程，后续该线程无需竞争，直接持有锁。</p>
<h5 data-id="heading-13">实现原理：</h5>
<ol>
<li>
<p>线程第一次获取锁时，通过 CAS 将 Mark Word 中的 “偏向线程 ID” 设为当前线程 ID，“是否偏向锁” 设为 1，锁状态保持 01（偏向锁标识）。</p>
</li>
<li>
<p>后续该线程再次获取锁时，仅需检查：</p>
<ul>
<li>Mark Word 中的偏向线程 ID 是否为当前线程。</li>
<li>偏向锁标志是否为 1。</li>
<li>锁状态是否为 01。满足则直接获取锁，无需 CAS 或阻塞，开销极低。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-14">偏向锁的撤销：</h5>
<p>当有其他线程尝试竞争偏向锁时，偏向锁会被 “撤销”，升级为轻量级锁。撤销流程：</p>
<ol>
<li>
<p>暂停持有偏向锁的线程（STW 短暂停顿）。</p>
</li>
<li>
<p>检查持有线程的状态：</p>
<ul>
<li>若线程已终止，直接将 Mark Word 重置为无锁状态。</li>
<li>若线程仍存活，将锁升级为轻量级锁，持有线程继续执行，竞争线程进入轻量级锁竞争。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-15">（2）轻量级锁：轻度竞争场景的优化</h4>
<p><strong>适用场景</strong>：少量线程竞争锁，且竞争时间短（如两个线程交替获取锁）。<strong>核心思想</strong>：用 “自旋” 替代 “阻塞”，避免线程切换到内核态的开销。</p>
<h5 data-id="heading-16">实现原理：</h5>
<ol>
<li>
<p>线程获取锁时，先在当前栈帧中创建一个 <strong>Lock Record（锁记录）</strong> ，存储对象当前的 Mark Word 副本（Displaced Mark Word）。</p>
</li>
<li>
<p>通过 CAS 将对象的 Mark Word 更新为 “指向当前 Lock Record 的指针”：</p>
<ul>
<li>CAS 成功：线程获取轻量级锁，锁状态变为 00。</li>
<li>CAS 失败：说明有其他线程竞争，此时会先自旋（空循环）几次，尝试再次获取锁。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-17">轻量级锁的膨胀：</h5>
<p>若自旋失败（如自旋次数耗尽仍未获取锁，或有更多线程参与竞争），轻量级锁会 “膨胀” 为重量级锁：</p>
<ol>
<li>将 Mark Word 中的指针改为 “指向 Monitor 的指针”，锁状态变为 11。</li>
<li>未获取锁的线程进入 EntryList 阻塞（BLOCKED 状态），避免无效自旋浪费 CPU。</li>
</ol>
<h4 data-id="heading-18">（3）重量级锁：激烈竞争场景的兜底</h4>
<p><strong>适用场景</strong>：多个线程同时竞争锁，且竞争时间长（如线程持有锁执行耗时操作）。<strong>实现原理</strong>：依赖操作系统的 <strong>互斥量（Mutex）</strong>  实现，线程竞争失败会直接阻塞（从用户态切换到内核态），等待被唤醒。<strong>特点</strong>：开销最大（线程阻塞 / 唤醒需内核态切换），但稳定性最高，适合激烈竞争场景。</p>
<h3 data-id="heading-19">2. 其他关键优化</h3>
<h4 data-id="heading-20">（1）自旋锁与适应性自旋锁</h4>
<ul>
<li>
<p><strong>自旋锁</strong>：轻量级锁竞争时，线程不直接阻塞，而是自旋（空循环）一段时间（默认 10 次），等待持有锁的线程快速释放。自旋无需切换内核态，适合锁持有时间短的场景。</p>
</li>
<li>
<p><strong>适应性自旋锁</strong>：JDK 1.6 优化，自旋次数不再固定，而是根据 “历史自旋成功率” 动态调整：</p>
<ul>
<li>若之前自旋成功获取锁，下次自旋次数增加（如 20 次）。</li>
<li>若之前自旋失败，下次自旋次数减少或直接放弃自旋（避免浪费 CPU）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">（2）锁消除</h4>
<p>JIT 编译器在编译时，通过<strong>逃逸分析</strong>判断：若一个锁对象仅被当前线程访问（无逃逸到其他线程），则直接消除该锁。</p>
<ul>
<li>示例：<code>StringBuffer</code> 的 <code>append()</code> 方法是同步方法，但单线程环境下，JIT 会消除其锁（因为 <code>StringBuffer</code> 对象未逃逸，无需同步）。</li>
</ul>
<h4 data-id="heading-22">（3）锁粗化</h4>
<p>若多个连续的锁操作针对<strong>同一个对象</strong>，JIT 会将这些分散的锁合并为一个 “粗粒度锁”，减少锁的获取 / 释放次数。</p>
<ul>
<li>示例：循环中多次调用 <code>synchronized (this) { ... }</code>，JIT 会将锁粗化到循环外部，仅获取一次锁即可。</li>
</ul>
<h2 data-id="heading-23">三、synchronized 如何保证可见性，有序性，原子性</h2>
<p><code>synchronized</code> 是 Java 中唯一能同时保证 <strong>原子性、可见性、有序性</strong> 的内置同步机制，其保障逻辑完全基于底层的 <strong>Monitor 监视器锁</strong> 和 <strong>JMM（Java 内存模型）规则</strong>，与之前提到的底层原理（如锁获取 / 释放、对象头操作）深度绑定。下面分三个特性，拆解其具体保障机制：</p>
<h3 data-id="heading-24">1、保证原子性：基于 Monitor 的互斥执行</h3>
<h4 data-id="heading-25">1.1. 原子性的定义</h4>
<p>原子性指 <strong>一个操作或一组操作，要么全部执行且执行过程不被打断，要么全部不执行</strong>（不可分割）。比如 <code>i++</code> 本质是「读取 i → 加 1 → 写入 i」三个步骤，若不加同步，多线程环境下可能被其他线程打断，导致结果错误。</p>
<h4 data-id="heading-26">1.2. synchronized 如何保证原子性？</h4>
<p>核心逻辑：<strong>通过 Monitor 锁的互斥性，确保同步块 / 方法在同一时间只能被一个线程执行</strong>。</p>
<p>结合底层原理的细节：</p>
<ul>
<li>线程要进入同步块 / 方法，必须先获取 Monitor 的所有权（通过 <code>monitorenter</code> 指令或 <code>ACC_SYNCHRONIZED</code> 标志）。</li>
<li>Monitor 的 <code>Owner</code> 字段同一时间只能指向一个线程（互斥性），其他竞争线程会被阻塞在 <code>EntryList</code>（BLOCKED 状态），直到当前线程释放锁。</li>
<li>同步块 / 方法内的所有操作，会作为一个 “整体” 被执行 —— 在当前线程释放锁前，其他线程无法插入执行，因此这组操作具备不可分割的原子性。</li>
</ul>
<h4 data-id="heading-27">示例验证：</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    count++; <span class="hljs-comment">// 读取、加1、写入三个步骤，被synchronized保证为原子操作</span>
}
</code></pre>
<ul>
<li>若不加 <code>synchronized</code>，1000 个线程各调用 1000 次 <code>increment()</code>，最终 <code>count</code> 会小于 1000000（因步骤被打断）。</li>
<li>加 <code>synchronized</code> 后，<code>count++</code> 的三个步骤被 “串行化”，最终结果必然是 1000000，原子性得到保证。</li>
</ul>
<h4 data-id="heading-28">补充：可重入性不破坏原子性</h4>
<p><code>synchronized</code> 是可重入锁（同一线程可多次获取同一锁），但多次获取不会打破互斥性 —— 其他线程仍需等待当前线程完全释放锁（所有重入的锁都释放）才能竞争，因此原子性依然成立。</p>
<h3 data-id="heading-29">2、保证可见性：基于锁释放 / 获取的内存刷新规则</h3>
<h4 data-id="heading-30">2.1. 可见性的定义</h4>
<p>可见性指 <strong>一个线程修改了共享变量的值后，其他线程能立刻感知到这个修改</strong>。若没有可见性保障，线程 A 修改的变量可能只存在于自己的工作内存中，未同步到主内存，线程 B 读取的仍是主内存中旧值。</p>
<h4 data-id="heading-31">2.2. synchronized 如何保证可见性？</h4>
<p>核心逻辑：<strong>JMM 为 <code>synchronized</code> 定义了「锁释放 - 获取的内存语义」，强制刷新共享变量的内存</strong>。</p>
<p>具体规则（与底层锁操作绑定）：</p>
<ul>
<li><strong>锁释放时：强制刷新工作内存到主内存</strong>线程释放 Monitor 锁时（执行 <code>monitorexit</code> 指令，或方法执行完毕），JVM 会触发一个动作：将该线程在工作内存中修改的所有共享变量，<strong>强制刷新到主内存</strong>（清空工作内存中的缓存，确保主内存是最新值）。</li>
<li><strong>锁获取时：强制从主内存加载最新值</strong>线程获取 Monitor 锁时（执行 <code>monitorenter</code> 指令，或调用同步方法），JVM 会触发一个动作：将该线程工作内存中对应的共享变量 <strong>置为无效</strong>，后续读取该变量时，必须从主内存重新加载（确保拿到的是最新值）。</li>
</ul>
<h4 data-id="heading-32">示例验证：</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> flag = <span class="hljs-literal">false</span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">setFlag</span><span class="hljs-params">()</span> </span>{
    flag = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 线程A修改后，释放锁时刷新到主内存</span>
}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">checkFlag</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (flag) { <span class="hljs-comment">// 线程B获取锁时，从主内存加载最新的flag（true）</span>
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"感知到flag修改"</span>);
    }
}
</code></pre>
<ul>
<li>若不加 <code>synchronized</code>，线程 A 修改变量后可能未刷新到主内存，线程 B 一直读取工作内存中的旧值 <code>false</code>，无法感知修改。</li>
<li>加 <code>synchronized</code> 后，锁释放 / 获取的内存语义确保了 <code>flag</code> 的修改对其他线程可见。</li>
</ul>
<h3 data-id="heading-33">3、保证有序性：基于互斥执行 + happens-before 规则</h3>
<h4 data-id="heading-34">3.1. 有序性的定义</h4>
<p>有序性指 <strong>程序执行的顺序与代码编写的顺序一致</strong>，避免因「指令重排序」导致的多线程执行混乱。JIT 编译器、CPU 为了优化性能，会在不影响单线程执行结果的前提下重排序指令，但多线程环境下可能导致错误。</p>
<h4 data-id="heading-35">3.2. synchronized 如何保证有序性？</h4>
<p>核心逻辑：<strong>通过「互斥执行的串行化」和「JMM 的 happens-before 规则」，间接禁止指令重排序的可见性</strong>。</p>
<h5 data-id="heading-36">（1）互斥执行的串行化保障</h5>
<p>由于同步块 / 方法同一时间只能被一个线程执行，相当于将多线程执行转化为「单线程串行执行」。而单线程环境下，指令重排序不会影响执行结果（as-if-serial 语义）—— 无论指令如何重排，单线程执行的最终结果与代码顺序一致，因此多线程通过 <code>synchronized</code> 执行时，不会出现因重排序导致的逻辑错误。</p>
<h5 data-id="heading-37">（2）happens-before 规则的强约束</h5>
<p>JMM 定义了「监视器锁规则」：<strong>对同一个锁的解锁操作（unlock），happens-before 于后续对该锁的加锁操作（lock）</strong> 。</p>
<ul>
<li>
<p><code>happens-before</code> 的含义：若操作 A happens-before 操作 B，则 A 的执行结果对 B 可见，且 A 的执行顺序在 B 之前（禁止 A 之后的指令重排序到 A 之前，也禁止 B 之前的指令重排序到 B 之后）。</p>
</li>
<li>
<p>具体效果：同步块内的所有操作（解锁前的操作），happens-before 于后续获取该锁的线程执行的操作（加锁后的操作）。这意味着：</p>
<ul>
<li>同步块内的指令可以重排序，但不会重排序到同步块外部（解锁后）。</li>
<li>后续线程获取锁后，能看到前一个线程同步块内所有操作的结果（包括指令重排序后的正确结果）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-38">示例验证（避免重排序问题）：</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> ready = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 线程A执行</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">()</span> </span>{
    a = <span class="hljs-number">1</span>;      <span class="hljs-comment">// 操作1</span>
    ready = <span class="hljs-literal">true</span>;<span class="hljs-comment">// 操作2</span>
}

<span class="hljs-comment">// 线程B执行</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (ready) { <span class="hljs-comment">// 操作3</span>
        System.out.<span class="hljs-built_in">println</span>(a); <span class="hljs-comment">// 操作4，必然输出1</span>
    }
}
</code></pre>
<ul>
<li>
<p>若不加 <code>synchronized</code>，CPU 可能将线程 A 的「操作 1 和操作 2」重排序（先执行 <code>ready=true</code>，再执行 <code>a=1</code>），导致线程 B 执行时 <code>ready=true</code> 但 <code>a=0</code>，输出错误。</p>
</li>
<li>
<p>加 <code>synchronized</code> 后：</p>
<ol>
<li>线程 A 的同步块内，操作 1 和操作 2 可重排序，但不会重排序到 <code>write()</code> 方法外部（解锁后）。</li>
<li>「线程 A 解锁」happens-before「线程 B 加锁」，因此线程 B 执行时，必然能看到线程 A 操作 1 和操作 2 的最终结果（<code>a=1</code> 且 <code>ready=true</code>），输出正确。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-39">4、总结：三个特性的核心保障逻辑</h3>





















<table><thead><tr><th>特性</th><th>核心保障机制</th></tr></thead><tbody><tr><td>原子性</td><td>Monitor 锁的互斥性：同步块 / 方法同一时间仅一个线程执行，操作不可分割。</td></tr><tr><td>可见性</td><td>锁释放 / 获取的内存语义：释放锁时刷新工作内存到主内存，获取锁时从主内存加载最新值。</td></tr><tr><td>有序性</td><td>1. 互斥执行转化为单线程串行（as-if-serial 语义）；2. happens-before 规则约束指令重排序。</td></tr></tbody></table>
<h2 data-id="heading-40">四、总结</h2>
<h3 data-id="heading-41">1. 底层原理核心</h3>
<p><code>synchronized</code> 基于 <strong>Monitor 监视器锁</strong> 和 <strong>对象头 Mark Word</strong> 实现，通过竞争 Monitor 所有权保证线程互斥，锁状态存储在 Mark Word 中。</p>
<h3 data-id="heading-42">2. 优化机制核心</h3>
<p>JDK 1.6+ 的优化核心是  <strong>“锁升级”</strong> ：从偏向锁（无竞争）→ 轻量级锁（轻度竞争，自旋）→ 重量级锁（激烈竞争，阻塞），按需降低开销；配合自旋锁、锁消除、锁粗化等优化，让 <code>synchronized</code> 兼顾安全性和高性能。</p>
<h3 data-id="heading-43">3. 性能对比</h3>
<ul>
<li>无竞争场景：偏向锁 &gt; 轻量级锁 &gt; 重量级锁（偏向锁几乎无开销）。</li>
<li>轻度竞争场景：轻量级锁（自旋）&gt; 重量级锁（避免内核态切换）。</li>
<li>激烈竞争场景：重量级锁（自旋无效，阻塞更高效）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开始使用 Elastic Agent Builder 和 Microsoft Agent Framework]]></title>    <link>https://juejin.cn/post/7575313772988399657</link>    <guid>https://juejin.cn/post/7575313772988399657</guid>    <pubDate>2025-11-23T08:40:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575313772988399657" data-draft-id="7575655132748349476" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开始使用 Elastic Agent Builder 和 Microsoft Agent Framework"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-23T08:40:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开始使用 Elastic Agent Builder 和 Microsoft Agent Framework
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:40:23.000Z" title="Sun Nov 23 2025 08:40:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fjonathan-simon" title="https://www.elastic.co/search-labs/author/jonathan-simon" target="_blank" ref="nofollow noopener noreferrer">Jonathan Simon</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e12fa40a8534389b0387e53ff3c0016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=oIIS7CCMF2LuT17tdHYHDvoXPQk%3D" alt="" loading="lazy"/></p>
<p>逐步讲解如何使用 Elastic Agent Builder 创建一个 agent 的完整流程，然后探索如何通过由 Microsoft Agent Framework 编排的 A2A 协议来使用该 agent。</p>
<p>Agent Builder 现在作为技术预览版提供。开始使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration%3Futm_source%3Dagentic-ai-category%26utm_medium%3Dsearch-labs%26utm_campaign%3Dagent-builder" title="https://cloud.elastic.co/registration?utm_source=agentic-ai-category&amp;utm_medium=search-labs&amp;utm_campaign=agent-builder" target="_blank" ref="nofollow noopener noreferrer">Elastic Cloud 试用</a>，并在此查看 Agent Builder 的文档。</p>
<p>Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F153865391" title="https://elasticstack.blog.csdn.net/article/details/153865391" target="_blank" ref="nofollow noopener noreferrer">9.2</a> 最近发布，并包含一个名为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Felasticsearch%2Fagent-builder" title="https://www.elastic.co/elasticsearch/agent-builder" target="_blank" ref="nofollow noopener noreferrer">Agent Builder</a> 的新功能。它让开发者能够快速创建由 Elasticsearch 中存储的数据驱动的 AI agents 和 tools。你在 Agent Builder 中创建的任何 tools 或 agents 都可以立即在你自己的自定义 AI 应用中使用。</p>
<p>在这篇博客文章中，我们将讲解使用 Elastic Agent Builder 创建一个 agent 的所有步骤。然后我们将讲解运行一个示例 Python 应用的流程，该应用使用 Microsoft Agent Framework 来编排你的 Elastic agent。</p>
<h2 data-id="heading-0">创建一个 Elastic Serverless 项目</h2>
<p>要使用 Agent Builder，你需要一个 Elastic 部署或一个 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fserverless" title="https://www.elastic.co/cloud/serverless" target="_blank" ref="nofollow noopener noreferrer">serverless</a> 项目，所以我们先从创建一个 Elastic serverless 项目开始。进入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration" title="https://cloud.elastic.co/registration" target="_blank" ref="nofollow noopener noreferrer">Elastic Cloud</a> 并创建一个新的 Elasticsearch <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fserverless" title="https://www.elastic.co/cloud/serverless" target="_blank" ref="nofollow noopener noreferrer">Serverless</a> 项目。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d217235199794785a2b684aba2bfb3be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=gUhNOGypdo%2FnZwsyxJRD2J2omjE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">创建一个索引并添加数据</h2>
<p>现在我们已经有了一个 Elastic 项目，让我们创建一个索引，这是 Elasticsearch 用来存储数据的地方。打开 Elastic Cloud 中的 Developer Tools，我们可以在这里运行命令来创建一个索引。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b428801cf1a14dc3bc53d1264f06eef3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=uclXaT4954LTq9emN2HeGCuWixA%3D" alt="" loading="lazy"/></p>
<p>复制下面的 PUT 命令，它会创建一个名为 my-docs 的索引，包含多种字段，以及利用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">语义搜索</a>的内容。</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /my-docs
2.  {
3.    <span class="hljs-string">"mappings"</span>: {
4.      <span class="hljs-string">"properties"</span>: {
5.        <span class="hljs-string">"title"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
6.        <span class="hljs-string">"content"</span>: { 
7.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"semantic_text"</span>
8.        },
9.        <span class="hljs-string">"filename"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
10.        <span class="hljs-string">"last_modified"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span> }
11.      }
12.    }
13.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>将 PUT 命令粘贴到 Developer Tools 控制台的输入区域。把鼠标悬停在控制台中的命令上，然后点击 Run 按钮来执行该命令。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/383550b40f3649ec8f17e3e33dc2df7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=HwMjEZEUh%2B%2BJLO9AlxCU%2F1740Kc%3D" alt="" loading="lazy"/></p>
<p>下一步是向你刚创建的 my-docs 索引中添加一些数据。将下面的命令复制并粘贴到 Develop Tools 控制台中。</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /my-docs/_doc/greetings-md
2.  {
3.    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Greetings"</span>,
4.    <span class="hljs-string">"content"</span>: <span class="hljs-string">"
5.  # Greetings

7.  ## Basic Greeting
8.  Hello!

10.  ## Helloworld Greeting
11.  Hello World! 🌎

13.  ## Not Greeting
14.  I'm only a greeting agent. 🤷

16.  "</span>,
17.    <span class="hljs-string">"filename"</span>: <span class="hljs-string">"greetings.md"</span>,
18.    <span class="hljs-string">"last_modified"</span>: <span class="hljs-string">"2025-11-04T12:00:00Z"</span>
19.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>点击该命令的 Run 按钮来执行命令，这将向 my-docs 索引添加一个文档。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3067081540db4b6e84b62180f196b98b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=Un1vqEg6RDYZEUoGPPHSzolxzDQ%3D" alt="" loading="lazy"/></p>
<p>如你所见，上面的命令添加了一个名为 greetings.md 的文档，其中包含不同类型的问候回应内容。</p>
<p>现在我们已经在 Elastic 索引中有了一些数据，让我们确认一下可以使用的数据。利用 Agent Builder 中默认启用的内置 Elastic AI Agent，你现在可以就你的数据进行对话。在导航菜单中选择 Agents。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/940bc29e283347bda465a0f4b54bbbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=OabfpsMxQM7E21hne7S9ZaiZgdQ%3D" alt="" loading="lazy"/></p>
<p>然后只需问：“我有什么数据？”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a55c7d9b2177413aad033832b886877a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=%2FbQdDI%2B6qLP4oo3XV4UKlM%2FpKNw%3D" alt="" loading="lazy"/></p>
<p>默认的 Elastic AI Agent 会提供当前存储在 Elastic 中数据的良好总结。</p>
<h2 data-id="heading-2">创建一个 tool</h2>
<p>此演练的下一步是创建一个能够使用存储在 Elastic 中数据的 agent。</p>
<p>如你所见，Elastic Agent Builder 中的默认 agent 已经可以用来与你的数据聊天，但要真正赋予 agent 自定义能力，它们需要通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fdocs%2Fgetting-started%2Fintro" title="https://modelcontextprotocol.io/docs/getting-started/intro" target="_blank" ref="nofollow noopener noreferrer">Model Context Protocol (MCP)</a> 访问 tools。Agent Builder 拥有完整的 tool 创建和管理功能，你可以用它快速创建自定义 MCP tools，这些 tools 会托管在与数据相同的可扩展 Elastic 项目中。</p>
<p>现在让我们在 Elastic Agent Builder 中创建一个可以访问 Elastic 中数据的 tool。点击 + New 开始。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f795dec328184949b4ca1a878f906086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=IeE4iZ2pPR7lQvQCsTfhZU7jtOU%3D" alt="" loading="lazy"/></p>
<p>然后点击 Manage tools。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4be79f7ee762471588354922a413420a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=uSYQXw3TsINQawcf6tcrSsfOw8c%3D" alt="" loading="lazy"/></p>
<p>点击 + New tool 按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dcbda00590748ed9a0d6bd43dba5e57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=SGxwM%2F5j4z34HuiNcVpw5x7o%2FLA%3D" alt="" loading="lazy"/></p>
<p>在 Create Tool 表单中，选择 ES|QL 作为 tool Type，并输入以下值。</p>
<p><strong>Tool ID</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`example.get_greetings`</span>AI写代码
</code></pre>
<p><strong>Description</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">`<span class="hljs-keyword">Get</span> greetings doc <span class="hljs-keyword">from</span> Elasticsearch my_docs index.`AI写代码
</code></pre>
<p><strong>Configuration</strong>：在 ES|QL Query 文本区域中输入以下查询：</p>
<pre><code class="hljs language-ini" lang="ini">`FROM my-docs | WHERE <span class="hljs-attr">filename</span> == <span class="hljs-string">"greetings.md"</span>`AI写代码
</code></pre>
<p>你完成的 Create a new tool 表单应如下所示。点击 Save 创建该 tool。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7b2dba5b034284a21afdd127023f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=AeFPT%2Fh5SfNrlEw3Ux7mvQT6ie8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">创建一个 Agent 并为其分配一个 tool</h2>
<p>啊！有了新 tool 并准备使用的感觉真好。Agents 需要 tools 来赋予它们超出一般 LLM 能力的特殊功能，而我们现在有了一个全新的 tool。让我们创建一个可以充分利用我们 tool 的 agent。在导航菜单中选择 Agents。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5017f7bf2d6343a2ab9358ecbf0de508~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=b%2B8xWmBlJReUS4EKfz9%2F4lTF9kc%3D" alt="" loading="lazy"/></p>
<p>点击 Create a new agent。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d985de944f04cf79001770bdb005183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=fosa7HZKNd7e%2FtFgh31Z436yVjs%3D" alt="" loading="lazy"/></p>
<p>根据 tool 的名称和它访问的数据，你可能已经猜到我们要创建一个问候 agent，你猜对了！让我们现在创建一个 Hello World agent。</p>
<p>在 New Agent 表单中，输入以下值。</p>
<p><strong>Agent ID</strong>：输入文本：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`helloworld_agent`</span>AI写代码
</code></pre>
<p>在 <strong>Custom Instructions</strong> 文本区域中输入以下指令：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  If the prompt <span class="hljs-keyword">contains</span> greeting text <span class="hljs-keyword">like</span> "Hi" <span class="hljs-keyword">or</span> "Hello" <span class="hljs-keyword">then</span> respond <span class="hljs-keyword">with</span> <span class="hljs-keyword">only</span> the Basic Hello text <span class="hljs-keyword">from</span> your documents.

<span class="hljs-number">3.</span>  If the prompt <span class="hljs-keyword">contains</span> the text “Hello World” <span class="hljs-keyword">then</span> respond <span class="hljs-keyword">with</span> <span class="hljs-keyword">only</span> the Hello World text <span class="hljs-keyword">from</span> your documents.

<span class="hljs-number">5.</span>  <span class="hljs-keyword">In</span> <span class="hljs-keyword">all</span> other cases <span class="hljs-keyword">where</span> the prompt does <span class="hljs-keyword">not</span> contain greeting words, <span class="hljs-keyword">then</span> respond <span class="hljs-keyword">with</span> <span class="hljs-keyword">only</span> the <span class="hljs-keyword">Not</span> Greeting text <span class="hljs-keyword">from</span> your documents.

`AI写代码
</code></pre>
<p><strong>Display name</strong>：输入文本：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`HelloWorld Agent`</span>AI写代码
</code></pre>
<p><strong>Display description</strong>：输入文本：</p>
<pre><code class="hljs language-css" lang="css">`An agent that responds <span class="hljs-selector-tag">to</span> greetings.`AI写代码
</code></pre>
<p>你完成的 <strong>New Agent</strong> 表单应如下所示。下一步是为 agent 分配我们在上一步创建的 tool。点击 <strong>Tools</strong> 标签。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2928610d469b4f239c161d86e86804aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=hUJZPj5vxVr1qYtC3kaiP1CYrwE%3D" alt="" loading="lazy"/></p>
<p>只选择我们之前创建的 example.get_greetings tool。取消选择所有其他可用的 tools。这将配置正在创建的 agent 仅能访问我们创建的 tool。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c721718bf9ec4b40bcf188d59bf9774c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=TQd0QyujnA1AniH%2Fb8RQ%2BCA2lZE%3D" alt="" loading="lazy"/></p>
<p>点击 <strong>Save</strong> 创建该 agent。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d5ec24af7af4120a55faa92315e6f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=xPsKPYZuIowxpotZNEknI3NSJ8o%3D" alt="" loading="lazy"/></p>
<p>你将被带到 Agents 列表，在那里可以看到新的 HelloWorld Agent 已经创建。我们可以在 Agent Builder 中快速测试我们的新 agent。在导航菜单中选择 Agents。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ab5fe1716b843bda92ca29fce18144a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=zSBhYbP%2F4wrlDSMO8MmEnBJIb4s%3D" alt="" loading="lazy"/></p>
<p>在 Agent Chat agent 选择器中选择 HelloWorld Agent。输入提示 “hello world”，你应该会从存储在 my-docs Elastic 索引中的 greetings.md 文档中得到 Hello World 文本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb09d6d4c534b60932b7d0c7ed40b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=SmMPirV7gu%2BvXWLbgLxxPgIIcDY%3D" alt="" loading="lazy"/></p>
<p>干得好。现在我们知道我们的 agent 按预期工作，让我们探索在 Agent Builder 中创建的 tools 和 agents 带来的即时开发好处。你在 Agent Builder 中创建的任何 tools 都可以通过 MCP 被任何支持 MCP 的 agent 构建平台使用。同时，你在 Agent Builder 中创建的任何 agents 都可以在任何支持 AgentToAgent (A2A) 协议的 agent 构建平台中使用。</p>
<h2 data-id="heading-4">Microsoft Agent Framework</h2>
<p>如果你有兴趣尝试新的 Agent 开发工具，那么最近宣布的开源开发工具包 <a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Foverview%2Fagent-framework-overview" title="https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview" target="_blank" ref="nofollow noopener noreferrer">Microsoft Agent Framework</a> 你绝对应该亲自尝试。Agent Framework 允许你使用 A2A 协议来编排 agent 应用，可以组合在不同主机上运行的多个 agents，从而实现仅靠通用 GenAI Large Language Model 无法实现的解决方案。Agent Framework 提供 Python 和 C# 版本。让我们看看如何使用基于 Python 的 Agent Framework 调用我们刚创建的自定义 Elastic Agent。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/311fb06b0c614586bb26a53b6a96af79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=Bzs94%2BOuTFe04%2BhVGsDP%2FMEnX%2FI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">在 Python 中开始使用 Agent Framework</h2>
<p>让我们运行一些代码！在你的本地电脑上打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdownload" title="https://code.visualstudio.com/download" target="_blank" ref="nofollow noopener noreferrer">Visual Studio Code</a> 并打开一个新的终端。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/198375dc5d2e453c8eb1c58610cfeb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=hZUoZ9K3LXmkugUcvgPo3ufgByg%3D" alt="" loading="lazy"/></p>
<p>在打开的终端中，克隆包含 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%2Ftree%2Fmain%2Fsupporting-blog-content%2Fagent-builder-a2a-agent-framework" title="https://github.com/elastic/elasticsearch-labs/tree/main/supporting-blog-content/agent-builder-a2a-agent-framework" target="_blank" ref="nofollow noopener noreferrer">Elastic Agent Builder A2A 示例应用</a>的 Elastic Search Labs 源代码仓库。</p>
<pre><code class="hljs language-bash" lang="bash">`git <span class="hljs-built_in">clone</span> https://github.com/elastic/elasticsearch-labs`AI写代码
</code></pre>
<p>在终端中，使用 cd 命令切换目录到 elasticsearch-labs。</p>
<pre><code class="hljs language-bash" lang="bash">`<span class="hljs-built_in">cd</span> elasticsearch-labs`AI写代码
</code></pre>
<p>在终端中，输入以下命令以在 Visual Studio Code 编辑器中打开当前文件夹。</p>
<pre><code class="hljs language-css" lang="css">`<span class="hljs-selector-tag">code</span> .`AI写代码
</code></pre>
<p>在 Visual Studio 文件资源管理器中，展开 supporting-blog-content 和 agent-builder-a2a-agent-framework 文件夹，然后在文本编辑器中打开名为 elastic_agent_builder_a2a.py 的文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1651e1e6031f45559a4012b352edd887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=KveKCpM6ZfqGwDZ0ue5ZqQFwF0k%3D" alt="" loading="lazy"/></p>
<p>这是你在文本编辑器中应该看到的 elastic_agent_builder_a2a.py 的内容：</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  import asyncio
2.  from dotenv import load_dotenv
3.  import httpx
4.  import os
5.  from a2a.client import A2ACardResolver
6.  from agent_framework.a2a import A2AAgent

9.  async def main():
10.      load_dotenv()
<span class="hljs-attr">11.      a2a_agent_host</span> = os.getenv(<span class="hljs-string">"ES_AGENT_URL"</span>)
<span class="hljs-attr">12.      a2a_agent_key</span> = os.getenv(<span class="hljs-string">"ES_API_KEY"</span>)

14.      print(f"Connection to Elastic A2A agent at: {a2a_agent_host}")

<span class="hljs-attr">16.      custom_headers</span> = {<span class="hljs-string">"Authorization"</span>: f<span class="hljs-string">"ApiKey {a2a_agent_key}"</span>}

18.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
19.          <span class="hljs-comment"># Resolve the A2A Agent Card</span>
<span class="hljs-attr">20.          resolver</span> = A2ACardResolver(httpx_client=http_client, base_url=a2a_agent_host)
<span class="hljs-attr">21.          agent_card</span> = await resolver.get_agent_card(
<span class="hljs-attr">22.              relative_card_path</span>=<span class="hljs-string">"/helloworld_agent.json"</span>
23.          )
24.          print(f"Found Agent: {agent_card.name} - {agent_card.description}")

26.          <span class="hljs-comment"># Use the Agent</span>
<span class="hljs-attr">27.          agent</span> = A2AAgent(
<span class="hljs-attr">28.              name</span>=agent_card.name,
<span class="hljs-attr">29.              description</span>=agent_card.description,
<span class="hljs-attr">30.              agent_card</span>=agent_card,
<span class="hljs-attr">31.              url</span>=a2a_agent_host,
<span class="hljs-attr">32.              http_client</span>=http_client,
33.          )
<span class="hljs-attr">34.          prompt</span> = input(<span class="hljs-string">"Enter Greeting &gt;&gt;&gt; "</span>)
35.          print("\nSending message to Elastic A2A agent...")
<span class="hljs-attr">36.          response</span> = await agent.run(prompt)
37.          print("\nAgent Response:")
38.          for message in response.messages:
39.              print(message.text)

42.  if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
43.      asyncio.run(main())

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>main() 方法中的代码演示了如何使用 Agent Framework 控制你的 Elastic Agent Builder agent。它使用来自你的 Elastic 项目的 URL 和 API key 为 agent 创建一个 http_client。然后调用 Agent Framework 的 A2ACardResolver，并传入该 http_client，以根据 relative_card_path 为 “/helloworld_agent.json” 获取 agent 的 A2A agent card，从而引用你的 agent 的 Agent ID，即 “helloworld_agent”。接着，代码使用 Agent Framework 调用你的 agent 并传入 A2A agent card。main() 方法的最后部分提示应用的用户输入一个 “greeting”，然后将用户输入作为提示发送给你的 agent。根据你创建 agent 时指定的指令和 tools，agent 的响应会显示给应用用户。</p>
<h2 data-id="heading-6">将你的 agent URL 和 API Key 设置为环境变量</h2>
<p>复制文件 env.example 并将新文件命名为 .env。编辑新创建的 .env 文件，将环境变量的值设置为从你的 Elastic 项目中复制的特定值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9469770a5dca47b09693c7aa46067d90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=J5Uzv5MLL%2FbU7e5nmq9Bp3%2FVULA%3D" alt="" loading="lazy"/></p>
<p>首先，我们将 替换为你可以从 Elastic 项目中的 Agent Builder - Tools 页面复制的 Agent URL 路径。回到 Elastic Agent Builder，在导航菜单中点击 Agents。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/534f619664af4bf791846d2a8208e328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=eoVGbnWNvggB8m9nF8t1Fse2T%2FE%3D" alt="" loading="lazy"/></p>
<p>选择 Manage tools。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b121e546060a489a81c7424be35243e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=1scXn%2FnXYZcAsyOuOudr1ve5DMA%3D" alt="" loading="lazy"/></p>
<p>点击 Tools 页面顶部的 MCP Server 下拉菜单。选择 Copy MCP Server URL。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05044a5651b24a86a366d653c0752979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=xj6Xt%2F44qYoJirHe2jTJa64oyBE%3D" alt="" loading="lazy"/></p>
<p>回到 Visual Studio Code，在 .env 文件中找到占位符文本 “<strong>YOUR-ELASTIC-AGENT-BUILDER-URL&gt;</strong>”，并粘贴复制的 MCP Server URL 来替换占位符文本。现在编辑粘贴的 MCP Server URL。删除 URL 末尾的 “mcp” 文本，并替换为 “a2a”。编辑后的 URL 应该看起来像这样：</p>
<pre><code class="hljs language-bash" lang="bash">`https://example-project-a123.kb.westus2.azure.elastic.cloud/api/agent_builder/a2a`AI写代码
</code></pre>
<p>下一个需要在 .env 文件中替换的占位符文本是 。我们将用来自你的 Elastic 项目的实际 API Key 替换它。回到你的 Elastic 项目，在导航菜单中点击 Elasticsearch。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b2b86cd27784905849c2304808d5493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=peXEnbb6%2F3PuGEDHrItEvTSjem8%3D" alt="" loading="lazy"/></p>
<p>点击 Create API key 创建一个新的 API key。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dbb46d8db094070bd110f7fdd5d7898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=IYPENBjhPV0MMq5a5RoROTY6zHE%3D" alt="" loading="lazy"/></p>
<p>输入 API key 的 Name，然后点击 Create API key。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f834245ec3374a2895618490a85a64ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=hNUIUlTTwVtJiBjj%2FdMs%2BJp2CFY%3D" alt="" loading="lazy"/></p>
<p>点击复制按钮来复制 API key。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b367a4c6b84a2cadbc0841747fbc81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=%2FsyDwD1DTJVvfbU9CKwZKDx0Qxw%3D" alt="" loading="lazy"/></p>
<p>回到 Visual Studio Code，在 .env 文件中找到占位符文本 “<strong/>”，并粘贴复制的 API Key 值来替换占位符文本。</p>
<p>现在我们可以保存对 .env 文件所做的更改。编辑后的文件应看起来像这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95372068b90a495499b4578ce6428ecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=kKD16WypLILv%2B4KNXFIOEDyHTPc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">运行示例应用</h2>
<p>现在是运行代码的时候了。为此，在 Visual Studio Code 中打开一个新终端。点击顶部菜单的 Terminal，然后选择 New Terminal。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc40130777204bd6bc3dc1ecb5ccc31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=xwJ4mRuJokjjDeooYc2QONj1kEg%3D" alt="" loading="lazy"/></p>
<p>在新终端中，使用 cd 命令切换目录到包含 agent-builder-a2a-agent-framework 示例应用的目录。</p>
<pre><code class="hljs language-bash" lang="bash">`<span class="hljs-built_in">cd</span> elasticsearch-labs/supporting-blog-content/agent-builder-a2a-agent-framework`AI写代码
</code></pre>
<p>在终端中，通过运行以下代码创建一个 Python 虚拟环境。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`python -m venv .venv`</span>AI写代码
</code></pre>
<p>在终端窗口中运行以下命令以激活虚拟环境（根据你的操作系统）：</p>
<ul>
<li>如果你使用的是 MacOS 或 Linux，激活虚拟环境的命令是：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`<span class="hljs-built_in">source</span> .venv/bin/activate`AI写代码
</code></pre>
<p>如果你使用的是 Windows，激活虚拟环境的命令是：</p>
<pre><code class="hljs language-r" lang="r">`.venv\Scripts\activate`AI写代码
</code></pre>
<p>elastic_agent_builder_a2a.py 文件中的代码由 Microsoft Agent Framework 驱动，我们仍然需要安装它，所以现在来安装。运行以下 pip 命令以安装基于 Python 的 Agent Framework 及其所需的 Python 包：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`pip install -r requirements.txt`</span>AI写代码
</code></pre>
<p>太棒了！现在一切都已就绪。是时候体验那种美妙的感觉了……让我们运行它。在终端中输入以下命令运行示例代码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`python elastic_agent_builder_a2a.py`</span>AI写代码
</code></pre>
<p>你应该会看到 Agent Framework 连接到 Elastic Agent。当提示输入 greeting 时，输入 “hello world”。你应该会看到 HelloWorld Agent 的响应 → Hello World! 🌎</p>
<p>顶尖的工作！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a8870e7751f4c90a39578f5075491bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764492022&amp;x-signature=7SVFOAZ9Wv%2F3mt5nnSNPU0l0UGU%3D" alt="" loading="lazy"/></p>
<p>在 Agent Builder 中构建 agents 并将它们连接到 tools，可以让你立即与最新的 agent 开发平台（如 Microsoft Agent Framework）实现可操作性。你现在已经知道如何创建一个 Elastic agent 并将其用作可扩展的相关数据源，随时为你接下来构建的所有 AI 应用提供自定义上下文。</p>
<p>今天就免费试用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration%3Futm_source%3Dagentic-ai-category%26utm_medium%3Dsearch-labs%26utm_campaign%3Dagent-builder" title="https://cloud.elastic.co/registration?utm_source=agentic-ai-category&amp;utm_medium=search-labs&amp;utm_campaign=agent-builder" target="_blank" ref="nofollow noopener noreferrer">Elastic</a> 并创建一些 agents 吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 LLM 自动生成 SQL：从 SQLite Schema 到自然语言查询的完整实践]]></title>    <link>https://juejin.cn/post/7575102474640162867</link>    <guid>https://juejin.cn/post/7575102474640162867</guid>    <pubDate>2025-11-23T08:47:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102474640162867" data-draft-id="7574651025728110630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 LLM 自动生成 SQL：从 SQLite Schema 到自然语言查询的完整实践"/> <meta itemprop="keywords" content="全栈"/> <meta itemprop="datePublished" content="2025-11-23T08:47:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玉宇夕落"/> <meta itemprop="url" content="https://juejin.cn/user/3323164053734988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 LLM 自动生成 SQL：从 SQLite Schema 到自然语言查询的完整实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323164053734988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玉宇夕落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:47:44.000Z" title="Sun Nov 23 2025 08:47:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么要做“自然语言转 SQL”？</h2>
<p>在数据分析、低代码平台、BI 工具等场景中，非技术人员常因不会写 SQL 而无法自助查询数据。而借助 LLM（如 DeepSeek、GPT），我们可以：</p>
<ul>
<li><strong>降低使用门槛</strong>：用户只需用自然语言提问（如“开发部员工工资多少？”）</li>
<li><strong>提升开发效率</strong>：自动生成准确 SQL，减少人工编写与调试成本</li>
<li><strong>快速验证想法</strong>：原型阶段无需构建复杂 UI，一句话即可查数据</li>
</ul>
<blockquote>
<p>✅ 本文以 <strong>SQLite + DeepSeek API</strong> 为例，展示一个最小可行方案（MVP）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、技术栈与准备</h2>

























<table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td><strong>数据库</strong></td><td>SQLite（Python 内置，无需安装服务）</td></tr><tr><td><strong>LLM 服务</strong></td><td>DeepSeek（兼容 OpenAI API，国内可访问）</td></tr><tr><td><strong>编程语言</strong></td><td>Python 3.7+</td></tr><tr><td><strong>依赖库</strong></td><td><code>sqlite3</code>（内置）、<code>openai</code>（用于调用 DeepSeek）</td></tr></tbody></table>
<p>安装依赖：</p>
<pre><code class="hljs">bash
编辑
pip install openai
</code></pre>
<hr/>
<h2 data-id="heading-2">三、完整实现步骤</h2>
<h3 data-id="heading-3">步骤 1：创建 SQLite 表并插入示例数据</h3>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-keyword">import</span> sqlite3

<span class="hljs-comment"># 连接数据库（若不存在则自动创建）</span>
conn = sqlite3.connect(<span class="hljs-string">"text5.db"</span>)
cursor = conn.cursor()

<span class="hljs-comment"># 创建 employees 表</span>
cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees (
    id INTEGER PRIMARY KEY,      -- 注意：原文 PRINARY 是拼写错误，应为 PRIMARY
    name TEXT,
    department TEXT,
    salary INTEGER
)
"""</span>)

<span class="hljs-comment"># 插入测试数据</span>
sample_data = [
    (<span class="hljs-number">6</span>, <span class="hljs-string">"陈老板"</span>, <span class="hljs-string">"开发部"</span>, <span class="hljs-number">100000</span>),
    (<span class="hljs-number">7</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"销售部"</span>, <span class="hljs-number">20000</span>),
    (<span class="hljs-number">8</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"开发部"</span>, <span class="hljs-number">50000</span>),
    (<span class="hljs-number">9</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"销售部"</span>, <span class="hljs-number">22000</span>),
]
cursor.executemany(<span class="hljs-string">'INSERT INTO employees VALUES (?, ?, ?, ?)'</span>, sample_data)
conn.commit()
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：原文中 <code>PRINARY KEY</code> 是拼写错误，正确应为 <code>PRIMARY KEY</code>，否则会创建成普通列！</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">步骤 2：提取表结构（Schema）</h3>
<p>为了让 LLM 理解表结构，需提供清晰的 Schema 描述：</p>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-comment"># 获取表字段信息</span>
schema = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
<span class="hljs-comment"># 构造 CREATE TABLE 风格的字符串</span>
schema_str = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"    <span class="hljs-subst">{col[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">{col[<span class="hljs-number">2</span>]}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema]) + <span class="hljs-string">"\n)"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库 Schema:"</span>)
<span class="hljs-built_in">print</span>(schema_str)
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">sql</span>
编辑
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> EMPLOYEES (
    id <span class="hljs-type">INTEGER</span>
    name TEXT
    department TEXT
    salary <span class="hljs-type">INTEGER</span>
)
</code></pre>
<blockquote>
<p>💡 虽然缺少约束（如 PRIMARY KEY），但对简单查询已足够。更严谨的做法可解析 DDL 或补充注释。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">步骤 3：调用 LLM 生成 SQL</h3>
<p>使用 DeepSeek 的 Reasoner 模型（擅长推理任务）：</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">'sk-xxxx'</span>,  <span class="hljs-comment"># 替换为你的 DeepSeek API Key</span>
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">'https://api.deepseek.com/v1'</span>
)

def ask_deepseek(query: str, schema: str) -&gt; str:
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
这是一个数据库的Schema:
{schema}
根据这个Schema,你能输出一个SQL查询来回答以下问题吗？
只输出SQL查询,不要输出任何其他内容。也不要带任何格式。
问题：{query}
"""</span>
    <span class="hljs-attr">response</span> = client.chat.completions.create(
        <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-reasoner"</span>,
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">2048</span>,
        <span class="hljs-attr">messages</span>=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}]
    )
    return response.choices<span class="hljs-section">[0]</span>.message.content.strip()

<span class="hljs-comment"># 测试提问</span>
<span class="hljs-attr">question</span> = <span class="hljs-string">"开发部部门员工的姓名和工资是多少？"</span>
<span class="hljs-attr">sql</span> = ask_deepseek(question, schema_str)
print("生成的 SQL 查询：")
print(sql)
</code></pre>
<p>预期输出：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">sql</span>
编辑
<span class="hljs-keyword">SELECT</span> name, salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department <span class="hljs-operator">=</span> <span class="hljs-string">'开发部'</span>;
</code></pre>
<hr/>
<h3 data-id="heading-6">步骤 4：执行 SQL 并返回结果（可选）</h3>
<pre><code class="hljs language-scss" lang="scss">python
编辑
result = <span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.execute</span>(sql)<span class="hljs-selector-class">.fetchall</span>()
<span class="hljs-built_in">print</span>("查询结果：", result)
# 输出：<span class="hljs-selector-attr">[(<span class="hljs-string">'陈老板'</span>, 100000), (<span class="hljs-string">'李四'</span>, 50000)]</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">四、关键技巧与注意事项</h2>
<h3 data-id="heading-8">1. Prompt 设计要点</h3>
<ul>
<li><strong>明确指令</strong>：“只输出 SQL，不要解释”</li>
<li><strong>提供精确 Schema</strong>：字段名、类型必须一致</li>
<li><strong>示例引导（Few-shot）</strong> ：复杂场景可加 1~2 个例子提升准确率</li>
</ul>
<h3 data-id="heading-9">2. 常见问题与解决方案</h3>






























<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>生成无效 SQL</td><td>Schema 不清晰或字段名不匹配</td><td>使用 <code>PRAGMA table_info</code> 精确获取字段</td></tr><tr><td>返回多余文本</td><td>LLM 未严格遵循指令</td><td>在 Prompt 中强调“仅输出 SQL”</td></tr><tr><td>表名大小写错误</td><td>SQLite 默认小写</td><td>Schema 中统一用小写表名</td></tr><tr><td>拼写错误（如 PRINARY）</td><td>手动建表失误</td><td>建表时仔细检查语法</td></tr></tbody></table>
<h3 data-id="heading-10">3. 安全警告 ⚠️</h3>
<ul>
<li><strong>切勿直接执行 LLM 生成的 SQL！</strong><br/>
应进行<strong>白名单校验</strong>（如只允许 SELECT）、<strong>参数化查询</strong>，防止注入攻击。</li>
<li>生产环境建议增加 SQL 解析器（如 <code>sqlglot</code>）做语法校验。</li>
</ul>
<hr/>
<h2 data-id="heading-11">五、方案对比：不同实现方式优劣</h2>





























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>LLM 直接生成 SQL</strong></td><td>快速、灵活、支持自然语言</td><td>可能出错、需校验</td><td>原型验证、内部工具</td></tr><tr><td><strong>模板匹配 + 规则引擎</strong></td><td>稳定、可控</td><td>扩展性差、需维护规则</td><td>固定查询模式</td></tr><tr><td><strong>专用 NL2SQL 模型（如 SQLCoder）</strong></td><td>准确率高</td><td>需部署模型、资源消耗大</td><td>企业级产品</td></tr></tbody></table>
<blockquote>
<p>✅ 对于个人项目或 MVP，<strong>LLM + Prompt 工程</strong> 是性价比最高的选择。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">六、总结要点</h2>
<ul>
<li>✅ SQLite 轻量易用，适合本地数据存储与测试</li>
<li>✅ 通过 <code>PRAGMA table_info</code> 可程序化获取表结构</li>
<li>✅ LLM（如 DeepSeek）能有效将自然语言转为 SQL</li>
<li>✅ <strong>Prompt 要清晰、约束要明确</strong></li>
<li>❌ <strong>永远不要信任 LLM 输出，必须校验 SQL 安全性</strong></li>
</ul>
<hr/>
<h2 data-id="heading-13">七、拓展思考</h2>
<ol>
<li><strong>如何支持多表 JOIN 查询？</strong><br/>
→ 在 Schema 中提供多个表的 DDL，并在问题中明确关联字段。</li>
<li><strong>能否缓存常见问题的 SQL？</strong><br/>
→ 可建立“问题- SQL”映射缓存，提升响应速度与稳定性。</li>
<li><strong>如何评估生成 SQL 的准确率？</strong><br/>
→ 构建测试集，用执行结果 vs 人工标注结果做比对。</li>
<li><strong>前端集成？</strong><br/>
→ 用 Flask/FastAPI 封装为 REST API，前端输入问题 → 返回表格数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：前端如何通过 `fetch` 调用 大模型（详解）]]></title>    <link>https://juejin.cn/post/7575104251866873866</link>    <guid>https://juejin.cn/post/7575104251866873866</guid>    <pubDate>2025-11-23T06:34:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575104251866873866" data-draft-id="7575102474639327283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从零开始：前端如何通过 `fetch` 调用 大模型（详解）"/> <meta itemprop="keywords" content="前端,JavaScript,LLM"/> <meta itemprop="datePublished" content="2025-11-23T06:34:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从零开始：前端如何通过 `fetch` 调用 大模型（详解）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T06:34:12.000Z" title="Sun Nov 23 2025 06:34:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 AI 应用开发中，我们经常需要在浏览器端直接调用大语言模型（LLM）的 API。虽然有 OpenAI SDK 等封装工具，但使用原生 <code>fetch</code> 发送 HTTP 请求是一种更灵活、可控且易于理解的方式。</p>
<p>本文将结合你提供的代码和笔记，深入解析 <strong>如何在前端通过 <code>fetch</code> 调用 DeepSeek 的聊天接口</strong>，并逐行解释每一个关键步骤。</p>
<hr/>
<h2 data-id="heading-0">🧩 一、完整的调用代码</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// llm api 地址</span>
<span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>;

<span class="hljs-comment">// 请求头</span>
<span class="hljs-keyword">const</span> headers = {
  <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
  <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_DEEPSEEK_API_KEY}</span>`</span>
};

<span class="hljs-comment">// 请求体</span>
<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">messages</span>: [
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'You are a helpful assistant.'</span> },
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你好 Deepseek'</span> }
  ]
};

<span class="hljs-comment">// 发起请求</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  headers,
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
});

<span class="hljs-comment">// 解析响应</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">// 显示结果</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
</code></pre>
<p>这段代码实现了从用户输入到模型回复的完整流程。下面我们逐部分拆解。</p>
<hr/>
<h2 data-id="heading-1">🔍 二、HTTP 请求结构解析（结合你的笔记）</h2>
<h3 data-id="heading-2">1. 请求行（Request Line）</h3>
<pre><code class="hljs language-bash" lang="bash">POST /chat/completions HTTP/1.1
Host: api.deepseek.com
</code></pre>
<ul>
<li><code>POST</code>：必须使用 POST 方法，因为 API 接口要求；</li>
<li><code>/chat/completions</code>：DeepSeek 的聊天接口路径；</li>
<li><code>HTTP/1.1</code>：标准版本，浏览器自动处理。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 请求头（Headers）</h3>
<pre><code class="hljs language-css" lang="css">{
  '<span class="hljs-attribute">Content</span>-Type': <span class="hljs-string">'application/json'</span>,
  <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer sk-xxxxxx'</span>
}
</code></pre>
<ul>
<li><code>'Content-Type': 'application/json'</code><br/>
告诉服务器请求体是 JSON 格式，这是必需的。</li>
<li><code>'Authorization': 'Bearer &lt;key&gt;'</code><br/>
认证方式，<code>Bearer</code> 是固定前缀，后面跟你的 API Key。</li>
</ul>
<blockquote>
<p>⚠️ 注意：API Key 不能硬编码在前端代码中，应通过 Vite 的环境变量管理：</p>
<pre><code class="hljs language-ini" lang="ini">// .env 文件
<span class="hljs-attr">VITE_DEEPSEEK_API_KEY</span>=sk-xxxxxxxx
</code></pre>
<p>在代码中使用 <code>import.meta.env.VITE_DEEPSEEK_API_KEY</code> 获取。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">3. 请求体（Body）</h3>
<pre><code class="hljs language-css" lang="css">{
  model: <span class="hljs-string">'deepseek-chat'</span>,
  messages: [
    { role: <span class="hljs-string">'system'</span>, content: <span class="hljs-string">'You are a helpful assistant.'</span> },
    { role: <span class="hljs-string">'user'</span>, content: <span class="hljs-string">'你好 Deepseek'</span> }
  ]
}
</code></pre>
<ul>
<li>
<p><code>model</code>：指定使用的模型名称；</p>
</li>
<li>
<p><code>messages</code>：对话历史，支持多轮交互；</p>
<ul>
<li><code>role: "system"</code>：设定助手行为；</li>
<li><code>role: "user"</code>：用户的提问内容。</li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ 注意：<strong>请求体必须是字符串化后的 JSON</strong>，所以要用 <code>JSON.stringify()</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4. 使用 <code>fetch</code> 发送请求</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  headers,
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
});
</code></pre>
<ul>
<li><code>method: 'POST'</code>：发送 POST 请求；</li>
<li><code>headers</code>：设置请求头；</li>
<li><code>body: JSON.stringify(payload)</code>：将 JS 对象转为字符串，<strong>不能直接传对象</strong>。</li>
</ul>
<blockquote>
<p>💡 <code>await</code> 比 <code>.then()</code> 更直观，适合异步操作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">5. 处理响应</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">data</span> = await response.json()<span class="hljs-comment">;</span>
console.log(data)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>response.json()</code> 将响应体解析为 JavaScript 对象；</li>
<li><code>data.choices[0].message.content</code> 是模型返回的文本。</li>
</ul>
<hr/>
<h3 data-id="heading-7">6. 显示结果</h3>
<pre><code class="hljs language-ini" lang="ini">document.getElementById('reply').<span class="hljs-attr">textContent</span> = data.choices[<span class="hljs-number">0</span>].message.content<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>将模型回复显示在页面上（假设有一个 id 为 <code>reply</code> 的元素）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">🔄 三、异步处理：<code>.then</code> vs <code>await</code></h2>
<p>你提到：</p>
<blockquote>
<p><code>- await 异步变同步比 then 更方便</code></p>
</blockquote>
<p>✅ 完全正确！</p>

















<table><thead><tr><th>方式</th><th>特点</th></tr></thead><tbody><tr><td><code>.then()</code></td><td>链式调用，适合复杂逻辑</td></tr><tr><td><code>await</code></td><td>代码像同步一样，更易读</td></tr></tbody></table>
<p>推荐使用 <code>await</code>，尤其是在处理多个异步操作时。</p>
<hr/>
<h2 data-id="heading-9">🔐 四、安全建议：API Key 的存放位置</h2>
<h3 data-id="heading-10">❌ 不推荐（前端暴露）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">apiKey</span> = <span class="hljs-string">'sk-xxxxxxxx'</span><span class="hljs-comment">; // 直接写在代码里 → 容易泄露</span>
</code></pre>
<h3 data-id="heading-11">✅ 推荐（后端代理）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端路由</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${process.env.DEEPSEEK_API_KEY}</span>`</span> <span class="hljs-comment">// 后端环境变量，安全！</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(req.<span class="hljs-property">body</span>)
  });
  res.<span class="hljs-title function_">json</span>(result);
});
</code></pre>
<p>然后前端只调用自己的 <code>/api/chat</code>，<strong>永远看不到真实 API Key</strong>。</p>
<hr/>
<h2 data-id="heading-12">✅ 五、总结：前端调用 LLM 的核心要点</h2>





































<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td>✅ 使用 <code>fetch</code> 发送 POST 请求</td><td>标准方式，兼容性强</td></tr><tr><td>✅ 设置 <code>Content-Type: application/json</code></td><td>必须</td></tr><tr><td>✅ 添加 <code>Authorization: Bearer &lt;key&gt;</code></td><td>认证必要</td></tr><tr><td>✅ 使用 <code>JSON.stringify()</code> 处理请求体</td><td>不能直接发送 JS 对象</td></tr><tr><td>✅ 使用 <code>await</code> 处理异步</td><td>更简洁</td></tr><tr><td>✅ 环境变量管理 API Key</td><td>Vite 支持 <code>VITE_</code> 开头变量</td></tr><tr><td>⚠️ 不要在生产环境中暴露 API Key</td><td>必须走后端代理</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13">🎯 结语</h2>
<blockquote>
<p><strong>技术的本质是解决问题，而不是追求“高大上”的工具。</strong></p>
</blockquote>
<p>当你理解了 <code>fetch</code> 的工作原理，就能轻松对接任何符合 OpenAI 协议的 LLM 服务。无论是 DeepSeek、Qwen 还是其他模型，只要你知道它的 API 地址和参数格式，就可以用这段代码快速接入。</p>
<p>希望这篇文章帮你彻底搞懂了前端调用 LLM 的全过程！<br/>
如果你正在做项目，我可以帮你封装一个通用的 AI 调用模块 😊</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端调用大语言模型：基于 Vite 的工程化实践与 HTTP 请求详解]]></title>    <link>https://juejin.cn/post/7575090551357521972</link>    <guid>https://juejin.cn/post/7575090551357521972</guid>    <pubDate>2025-11-23T07:17:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357521972" data-draft-id="7575162322239881216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端调用大语言模型：基于 Vite 的工程化实践与 HTTP 请求详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-23T07:17:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端调用大语言模型：基于 Vite 的工程化实践与 HTTP 请求详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T07:17:23.000Z" title="Sun Nov 23 2025 07:17:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端调用大语言模型：基于 Vite 的工程化实践与 HTTP 请求详解</h2>
<p>随着人工智能技术的迅猛发展，大语言模型已逐渐从科研实验室走向工业应用。本文将围绕“前端如何以 HTTP 请求方式调用大语言模型”这一核心主题，结合现代前端工程化工具 Vite，详细讲解项目初始化、环境变量配置、fetch 请求封装、安全注意事项等关键环节，帮助读者掌握从前端发起 LLM 调用的全流程。</p>
<hr/>
<h3 data-id="heading-1">一、为什么前端可以直接调用 LLM？</h3>
<p>传统观点认为，AI 模型应由后端服务代理调用，前端仅负责展示结果。然而，在某些场景下，<strong>前端直连 LLM API 是可行且高效的</strong>，前提是：</p>
<ol>
<li><strong>API 支持 CORS（跨域资源共享）</strong> ：如 DeepSeek、OpenRouter 等部分服务商允许浏览器直接请求。</li>
<li><strong>安全性可控</strong>：通过短期有效的 API Key、IP 白名单、请求频率限制等方式降低风险。</li>
<li><strong>无需敏感数据处理</strong>：用户输入不涉及隐私或机密信息。</li>
</ol>
<p>以 DeepSeek 为例，其官方 API 支持 CORS，允许前端通过 <code>fetch</code> 直接发起 POST 请求，这为快速原型开发和轻量级应用提供了极大便利。</p>
<hr/>
<h3 data-id="heading-2">二、项目初始化：使用 Vite 搭建全栈友好型前端项目</h3>
<p>Vite 是新一代前端构建工具，以其极速的冷启动和热更新能力著称。虽然 Vite 本身是前端构建器，但其对环境变量、TypeScript、ESM 模块的原生支持，使其成为调用 LLM 的理想脚手架。</p>
<h4 data-id="heading-3">1. 创建项目</h4>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> vite<span class="hljs-variable">@latest</span> llm<span class="hljs-operator">-</span>frontend<span class="hljs-operator">-</span>demo <span class="hljs-comment">-- --template vanilla</span>
cd llm<span class="hljs-operator">-</span>frontend<span class="hljs-operator">-</span>demo
npm install
</code></pre>
<p>选择 <code>vanilla</code> 模板即可获得一个纯净的 HTML/CSS/JS 项目结构，适合教学和快速验证。</p>
<h4 data-id="heading-4">2. 配置环境变量</h4>
<p>出于安全考虑，<strong>API Key 绝不能硬编码在源码中</strong>。Vite 提供了 <code>.env</code> 文件机制，所有以 <code>VITE_</code> 开头的变量会被注入到客户端代码中。</p>
<p>创建 <code>.env.local</code> 文件（该文件通常加入 <code>.gitignore</code>，避免提交到版本控制）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">VITE_DEEPSEEK_API_KEY</span>=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre>
<blockquote>
<p>⚠️ 注意：此方法仅适用于 API 服务商允许前端直连的场景。若服务商禁止 CORS 或要求更高安全级别，则必须通过后端代理。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">三、HTTP 请求详解：如何正确调用 LLM API</h3>
<p>LLM API 通常遵循 RESTful 设计，使用 JSON 格式通信。以 DeepSeek 的 <code>/chat/completions</code> 接口为例，一次完整的请求包含三个部分：<strong>请求行、请求头、请求体</strong>。</p>
<h4 data-id="heading-6">1. 请求行（Request Line）</h4>
<ul>
<li><strong>Method</strong>: <code>POST</code>（因为需要发送消息内容）</li>
<li><strong>URL</strong>: <code>https://api.deepseek.com/chat/completions</code></li>
<li><strong>HTTP 版本</strong>: 通常由浏览器自动处理，无需显式指定</li>
</ul>
<h4 data-id="heading-7">2. 请求头（Headers）</h4>
<p>必须包含两个关键字段：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> headers = {
  <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
  <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_DEEPSEEK_API_KEY}</span>`</span>
};
</code></pre>
<ul>
<li><code>Content-Type: application/json</code> 告知服务器请求体为 JSON 格式。</li>
<li><code>Authorization: Bearer &lt;token&gt;</code> 是 OAuth 2.0 标准的认证方式，<code>Bearer</code> 为固定前缀。</li>
</ul>
<h4 data-id="heading-8">3. 请求体（Body）</h4>
<p>LLM 接口通常要求结构化的消息数组：</p>
<pre><code class="hljs language-css" lang="css">const payload = {
  model: <span class="hljs-string">'deepseek-chat'</span>, // 指定模型名称
  messages: [
    { role: <span class="hljs-string">"system"</span>, content: <span class="hljs-string">"You are a helpful assistant."</span> },
    { role: <span class="hljs-string">"user"</span>, content: <span class="hljs-string">"你好 DeepSeek"</span> }
  ]
};
</code></pre>
<p>注意：<strong>body 必须是字符串</strong>，不能直接传入 JavaScript 对象。需使用 <code>JSON.stringify()</code> 序列化：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>: JSON.<span class="hljs-built_in">stringify</span>(payload)
</code></pre>
<h5 data-id="heading-9">为什么 body 必须是字符串？</h5>
<p>这是因为 <strong><code>fetch</code> API 的底层实现遵循 HTTP 协议规范</strong>，而 HTTP 协议规定：<strong>请求体（request body）只能是字节流（即二进制数据）</strong> 。在浏览器环境中，JavaScript 无法直接发送对象、数组等高级数据结构——这些结构只存在于运行时内存中，网络传输必须将其转换为可序列化的格式。</p>
<p>当你调用 <code>fetch</code> 并设置 <code>body</code> 字段时，浏览器期望你提供以下几种类型之一：</p>
<ul>
<li><code>string</code>（如 JSON 字符串）</li>
<li><code>FormData</code></li>
<li><code>URLSearchParams</code></li>
<li><code>Blob</code> / <code>ArrayBuffer</code> / <code>ReadableStream</code> 等二进制类型</li>
</ul>
<p>如果你直接传入一个 JavaScript 对象（例如 <code>{ key: "value" }</code>），浏览器会尝试将其隐式转换为字符串，结果通常是 <code>[object Object]</code> —— 这显然不是服务器期望的 JSON 格式，会导致 API 返回解析错误（如 400 Bad Request）。</p>
<p>因此，<strong>必须显式使用 <code>JSON.stringify()</code> 将对象转换为标准的 JSON 字符串</strong>，确保服务端能正确反序列化并理解你的请求内容。同时，配合设置请求头 <code>'Content-Type': 'application/json'</code>，告知服务器：“我发送的是 JSON 格式的文本”。</p>
<blockquote>
<p>✅ 正确做法：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>: JSON.<span class="hljs-built_in">stringify</span>({ message: <span class="hljs-string">"hello"</span> })
</code></pre>
<p>❌ 错误做法：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>: { message: <span class="hljs-string">"hello"</span> }  // 实际发送的是 "<span class="hljs-selector-attr">[object Object]</span>"
</code></pre>
</blockquote>
<p>这一细节看似微小，却是前后端数据通信可靠性的关键保障。</p>
<h3 data-id="heading-10">四、使用 fetch 发起异步请求</h3>
<p>现代浏览器原生支持 <code>fetch</code> API，它是发起 HTTP 请求的标准方式。</p>
<h4 data-id="heading-11">完整调用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callDeepSeek</span>(<span class="hljs-params">userMessage</span>) {
  <span class="hljs-keyword">const</span> headers = {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_DEEPSEEK_API_KEY}</span>`</span>
  };

  <span class="hljs-keyword">const</span> payload = {
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-attr">messages</span>: [
      { <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"You are a helpful assistant."</span> },
      { <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: userMessage }
    ]
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      headers,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">${response.status}</span>`</span>);
    }

    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调用 DeepSeek 失败:'</span>, error);
    <span class="hljs-keyword">return</span> <span class="hljs-string">'抱歉，暂时无法获取回复。'</span>;
  }
}

<span class="hljs-comment">// 绑定按钮点击事件</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'send-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-input'</span>);
  <span class="hljs-keyword">const</span> replyEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>);

  <span class="hljs-keyword">const</span> userMsg = input.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (!userMsg) <span class="hljs-keyword">return</span>;

  replyEl.<span class="hljs-property">textContent</span> = <span class="hljs-string">'思考中...'</span>;
  <span class="hljs-keyword">const</span> reply = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callDeepSeek</span>(userMsg);
  replyEl.<span class="hljs-property">textContent</span> = reply;
  input.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
});
</code></pre>
<h4 data-id="heading-12">关键点说明</h4>
<ul>
<li>使用 <code>async/await</code> 使异步代码更易读，避免回调地狱。</li>
<li>对 <code>response.ok</code> 进行判断，防止非 2xx 响应被误认为成功。</li>
<li>错误处理必不可少，网络波动或配额耗尽可能导致请求失败。</li>
</ul>
<hr/>
<h3 data-id="heading-13">五、工程化思维：代码如钢筋水泥</h3>
<p>在 Trae 所倡导的“工程化”理念中，代码不仅是功能的载体，更是可维护、可扩展、可协作的“建筑材料”。调用 LLM 不应只是复制粘贴一段 fetch 代码，而应思考：</p>
<ul>
<li><strong>可复用性</strong>：将 LLM 调用封装为独立函数或模块。</li>
<li><strong>可配置性</strong>：模型名称、系统提示词可通过参数传入。</li>
<li><strong>可测试性</strong>：模拟 API 响应进行单元测试。</li>
<li><strong>用户体验</strong>：加载状态、错误提示、输入限制等细节。</li>
</ul>
<p>例如，可进一步抽象为：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMClient</span> {
  <span class="hljs-keyword">constructor</span>(apiKey, model = <span class="hljs-string">'deepseek-chat'</span>) {
    <span class="hljs-keyword">this</span>.apiKey = apiKey;
    <span class="hljs-keyword">this</span>.model = model;
    <span class="hljs-keyword">this</span>.endpoint = <span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>;
  }

  async chat(messages, systemPrompt = <span class="hljs-string">"You are a helpful assistant."</span>) {
    <span class="hljs-keyword">const</span> fullMessages = [
      { role: <span class="hljs-string">"system"</span>, content: systemPrompt },
      ...messages
    ];

    <span class="hljs-keyword">const</span> response = await fetch(<span class="hljs-keyword">this</span>.endpoint, {
      method: <span class="hljs-string">'POST'</span>,
      headers: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-string">'Authorization'</span>: `Bearer ${<span class="hljs-keyword">this</span>.apiKey}`
      },
      body: JSON.stringify({ model: <span class="hljs-keyword">this</span>.model, messages: fullMessages })
    });

    <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = await response.json();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.choices[<span class="hljs-number">0</span>].message.content;
  }
}
</code></pre>
<p>这种面向对象的设计更利于大型项目集成。</p>
<hr/>
<h3 data-id="heading-14">六、安全与最佳实践</h3>
<p>尽管前端直连 LLM 便捷高效，但也存在风险：</p>
<ol>
<li>
<p><strong>API Key 泄露</strong>：一旦 <code>.env</code> 中的 Key 被提取，可能被滥用产生高额费用。</p>
<ul>
<li>解决方案：使用短期 Token、设置 IP 白名单、监控调用量。</li>
</ul>
</li>
<li>
<p><strong>CORS 限制</strong>：并非所有 LLM 服务商都开放 CORS。</p>
<ul>
<li>替代方案：通过 Vite 的代理功能（仅开发环境）或部署轻量后端（如 Cloudflare Workers）中转。</li>
</ul>
</li>
<li>
<p><strong>速率限制</strong>：频繁请求可能触发限流。</p>
<ul>
<li>建议：添加防抖、队列机制或用户提示。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-15">结语</h3>
<p>前端调用大语言模型不再是遥不可及的概念，而是触手可及的工程实践。借助 Vite 的现代化开发体验和浏览器原生的 <code>fetch</code> 能力，我们可以快速构建具备 AI 能力的 Web 应用。然而，技术便利的背后是对工程规范、安全意识和用户体验的更高要求。</p>
<p>未来，随着 WebAssembly、WebGPU 等技术的发展，甚至可能在浏览器本地运行小型 LLM，实现完全离线的智能交互。但无论技术如何演进，“工程化”始终是高质量软件开发的基石——正如钢筋水泥之于摩天大楼，代码结构之于数字世界。</p>
<blockquote>
<p><strong>代码不是魔法，而是精心设计的工程。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Monorepo 架构全解析：从概念到落地的完整指南]]></title>    <link>https://juejin.cn/post/7575807729722392610</link>    <guid>https://juejin.cn/post/7575807729722392610</guid>    <pubDate>2025-11-23T08:06:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575807729722392610" data-draft-id="7575807729722228770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Monorepo 架构全解析：从概念到落地的完整指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T08:06:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wect"/> <meta itemprop="url" content="https://juejin.cn/user/4185164878720068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Monorepo 架构全解析：从概念到落地的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185164878720068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:06:51.000Z" title="Sun Nov 23 2025 08:06:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Monorepo？</h2>
<h3 data-id="heading-1">1.1 核心概念</h3>
<p>Monorepo（单体仓库）是一种软件开发架构模式，它将多个相关项目、应用或模块的源代码集中存储在单一的代码仓库中进行管理。与传统的多仓库（Multi-repo）模式不同，Monorepo 允许团队在一个统一的上下文中开发多个相关组件，从而简化了代码共享和项目间依赖管理。</p>
<h3 data-id="heading-2">1.2 与多仓库（Multi-repo）的对比</h3>


















































<table><thead><tr><th>特性/方面</th><th>Monorepo（单体仓库）</th><th>Multi-repo（多仓库）</th></tr></thead><tbody><tr><td><strong>代码组织</strong></td><td>所有项目代码在一个仓库中</td><td>每个项目独立仓库</td></tr><tr><td><strong>代码共享</strong></td><td>直接通过引用共享代码，无需发布包</td><td>需要将共享代码发布为npm包才能复用</td></tr><tr><td><strong>依赖管理</strong></td><td>统一依赖版本，避免版本冲突</td><td>各仓库可能使用不同版本的依赖，易出现冲突</td></tr><tr><td><strong>代码变更</strong></td><td>跨项目变更可在一次提交中完成</td><td>需要在多个仓库中进行多次提交和协调</td></tr><tr><td><strong>构建测试</strong></td><td>可统一构建、测试所有项目</td><td>需要单独构建、测试每个仓库</td></tr><tr><td><strong>存储效率</strong></td><td>依赖只安装一次，节省空间</td><td>相同依赖在各仓库中重复安装</td></tr><tr><td><strong>权限管理</strong></td><td>较难实现细粒度的权限控制</td><td>可针对不同仓库设置不同权限</td></tr><tr><td><strong>初始复杂度</strong></td><td>配置相对复杂，需要专用工具支持</td><td>配置简单，容易上手</td></tr></tbody></table>
<h3 data-id="heading-3">1.3 适用场景</h3>
<p>Monorepo 特别适合以下场景：</p>
<ul>
<li><strong>微服务架构</strong>：多个服务紧密相关，经常需要协同开发和部署</li>
<li><strong>组件库开发</strong>：共享UI组件、工具函数等公共资源</li>
<li><strong>前端应用与后端服务的联合开发</strong>：需要频繁跨项目协作</li>
<li><strong>大型团队协作</strong>：代码共享需求高，需要统一的工作流和规范</li>
<li><strong>需要频繁同步更新的多项目</strong>：相关项目之间存在紧密依赖关系</li>
</ul>
<h3 data-id="heading-4">1.4 常见误区</h3>
<p>需要注意的是，Monorepo 并非适用于所有场景：</p>
<ul>
<li>它不意味着所有代码都必须放在一个文件中，仍然保持良好的模块化结构</li>
<li>它不消除代码隔离的需要，相反，Monorepo 更强调合理的项目边界划分</li>
<li>它不是解决所有协作问题的银弹，仍需良好的开发规范和流程配合</li>
<li>对于完全独立、技术栈差异大、几乎不需要代码共享的项目，多仓库模式可能更合适</li>
</ul>
<h2 data-id="heading-5">二、Monorepo 核心目标</h2>
<p>在动手前，先明确 Monorepo 的核心目标，避免走偏。其核心是“公共代码抽离、业务项目隔离”，具体目标包括：</p>
<ul>
<li><strong>统一管理</strong>：代码、依赖、构建、测试、部署流程统一维护；</li>
<li><strong>共享复用</strong>：公共代码（如工具函数、组件、配置）抽为公共包，避免重复开发；</li>
<li><strong>隔离清晰</strong>：各项目/模块独立编译、测试、发布，互不干扰；</li>
<li><strong>高效协作</strong>：跨项目开发无需切换仓库，分支管理、代码审查更简化；</li>
<li><strong>版本一致</strong>：避免多仓库间依赖版本冲突，确保所有项目使用统一的依赖版本。</li>
</ul>
<h2 data-id="heading-6">三、技术栈选择</h2>
<p>在众多 Monorepo 解决方案中，本次选用的技术栈及核心理由如下：</p>

























<table><thead><tr><th>技术组件</th><th>版本/作用</th><th>选择理由</th></tr></thead><tbody><tr><td>核心包管理器</td><td>Yarn 4.9.1（Workspace 特性）</td><td>1. Workspace 功能成熟稳定；2. 依赖提升机制（hoisting）减少重复依赖；3. 支持 node-modules 模式；4. 丰富的命令行工具适配 Monorepo 操作</td></tr><tr><td>代码规范</td><td>EditorConfig</td><td>统一多编辑器代码格式配置，保证团队编码风格一致</td></tr><tr><td>任务调度</td><td>concurrently</td><td>支持并行执行多个命令，提升开发和构建效率</td></tr></tbody></table>
<h2 data-id="heading-7">四、项目目录结构设计</h2>
<p>合理的目录结构是 Monorepo 成功的关键，本次采用经典的分层结构，清晰区分业务应用与公共资源，具体结构如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">LowCode/
├── package.json                <span class="hljs-meta"># 根项目配置（管理公共依赖、脚本命令）</span>
├── tsconfig.<span class="hljs-keyword">base</span>.json          <span class="hljs-meta"># TypeScript 基础配置（共享给所有子项目）</span>
├── .yarn/                      <span class="hljs-meta"># Yarn 配置</span>
├── .yarnrc.yml                 <span class="hljs-meta"># Yarn 运行时配置</span>
├── 其他配置...
├── apps/                       <span class="hljs-meta"># 业务项目目录（独立部署的应用）</span>
│   ├── web/                    <span class="hljs-meta"># 前端 Web 应用</span>
│   │   └── package.json
│   ├── api/                    <span class="hljs-meta"># 后端 API 服务</span>
│   │   └── package.json
├── packages/                   <span class="hljs-meta"># 公共包目录（可被其他项目依赖）</span>
│   ├── utils/                  <span class="hljs-meta"># 工具函数库</span>
│   │   └── package.json
│   ├── components/             <span class="hljs-meta"># UI 组件库</span>
│   │   └── package.json
│   └── config/                 <span class="hljs-meta"># 共享配置库</span>
│   │   └── package.json
</code></pre>
<p><strong>核心目录说明</strong>：</p>
<ul>
<li><strong>apps/</strong> ：存放业务应用，每个应用都是独立可部署的项目，如前端 Web 应用和后端 API 服务；</li>
<li><strong>packages/</strong> ：存放可重用的公共库，供 apps 目录下的项目依赖使用，包括工具函数、UI 组件和共享配置等；</li>
<li><strong>根目录</strong>：承担全局管理职责，包含项目级公共配置、共享脚本、依赖声明和项目文档。</li>
</ul>
<h2 data-id="heading-8">五、实现步骤详解</h2>
<p>Monorepo 的实现遵循“初始化-配置-细化”的流程，从根项目搭建到子项目配置逐步推进，确保每个环节衔接顺畅。</p>
<h3 data-id="heading-9">1. 初始化根项目</h3>
<p>首先创建项目根目录并通过 Yarn 初始化，生成基础的 package.json 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> LowCode
<span class="hljs-built_in">cd</span> LowCode
yarn init -y
</code></pre>
<h3 data-id="heading-10">2. 配置 Yarn Workspace</h3>
<p>Yarn Workspace 是实现 Monorepo 依赖管理和项目关联的核心，需在根项目的 package.json 中添加如下配置，明确工作空间范围和公共脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"low_code"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn@4.9.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"packages/*"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 所有在 packages 目录下的子项目</span>
    <span class="hljs-string">"apps/*"</span>         <span class="hljs-comment">// 所有在 apps 目录下的子项目</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A run test"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:all"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A -p run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:apps"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A --include 'apps/*' -p run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A --include 'packages/*' -p run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev:web"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace @wect/web dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev:api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace @wect/api dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev:all"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"concurrently "</span>yarn workspace @wect/web dev<span class="hljs-string">" "</span>yarn workspace @wect/api dev<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A -p run clean"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"add"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"remove"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspace"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A -p run lint"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn workspaces foreach -A -p run lint:fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write './**/*.{js,jsx,ts,tsx,json,md,yml}' --ignore-path .prettierignore"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format:check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --check './**/*.{js,jsx,ts,tsx,json,md,yml}' --ignore-path .prettierignore"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"concurrently"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.2.1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置关键点</strong>：</p>
<ul>
<li><code>private: true</code> 确保根项目不会被意外发布；</li>
<li><code>workspaces</code> 数组定义工作空间位置，自动识别指定目录下的子项目；</li>
<li>通过 <code>workspace</code> 命令操作单个子项目，<code>workspaces foreach</code> 批量操作所有子项目；</li>
<li>子项目名称统一使用作用域前缀（如 <code>@wect/web</code>），避免命名冲突。</li>
</ul>
<h3 data-id="heading-11">3. 配置 Yarn 运行时</h3>
<p>创建 <code>.yarnrc.yml</code> 文件，指定 Yarn 的依赖链接模式，本次采用经典的 node-modules 模式，兼容性更强：</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># Yarn配置文件</span>
<span class="hljs-attr">nodeLinker:</span> <span class="hljs-string">node-modules</span>
</code></pre>
<h3 data-id="heading-12">4. 初始化子项目</h3>
<p>子项目初始化提供两种方式，可根据实际需求选择：</p>
<h4 data-id="heading-13">方法一：批量初始化（推荐）</h4>
<p>先安装任务调度依赖 concurrently，再通过 Yarn 命令批量初始化所有子项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装公共开发依赖</span>
yarn add -D concurrently

<span class="hljs-comment"># 批量初始化所有子项目</span>
yarn workspaces foreach -A -p init
</code></pre>
<h4 data-id="heading-14">方法二：手动初始化（适用于个别项目）</h4>
<p>进入具体子项目目录，单独执行初始化命令，以 web 应用为例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> apps/web
yarn init -y
</code></pre>
<h3 data-id="heading-15">5. 配置子项目</h3>
<p>每个子项目需配置独立的 package.json，明确自身依赖、脚本命令等信息，同时通过 workspace 协议关联内部公共包。以下是核心子项目的配置示例：</p>
<h4 data-id="heading-16">Web 应用配置（apps/web/package.json）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@wect/web"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yarn@4.9.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc &amp;&amp; vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo '运行Web测试...'"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint 'src/**/*.{js,jsx,ts,tsx}'"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint 'src/**/*.{js,jsx,ts,tsx}' --fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write 'src/**/*' --ignore-path ../../.prettierignore"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@wect/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 依赖内部工具包</span>
    <span class="hljs-attr">"@wect/components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 依赖内部组件库</span>
    <span class="hljs-attr">"@wect/config"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 依赖内部配置库</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^20.14.10"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@vitejs/plugin-react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.7.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint-plugin-react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.35.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint-plugin-react-hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.3.9"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-17">API 服务配置（apps/api/package.json）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@wect/api"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>启动API开发服务器...<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>构建API服务...<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>运行API服务测试...<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>检查API服务代码...<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>清理API服务构建产物...<span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deploy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo "</span>部署API服务...<span class="hljs-string">""</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@wect/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@wect/config"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">6. 依赖管理详解</h3>
<p>Monorepo 中的依赖管理分为“外部依赖”和“内部依赖”，需采用不同的管理方式：</p>
<h4 data-id="heading-19">安装外部依赖</h4>
<p>根据依赖的作用范围，可安装在根项目（所有子项目共享）或特定子项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装根项目依赖（所有子项目共享）</span>
yarn add -D prettier eslint

<span class="hljs-comment"># 为 web 应用单独安装依赖</span>
yarn workspace @wect/web add react react-dom
</code></pre>
<h4 data-id="heading-20">依赖内部子项目</h4>
<p>使用 <code>workspace:</code> 协议引用其他工作空间，确保始终使用本地最新版本，避免版本不一致问题：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@wect/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// * 表示匹配最新版本</span>
    <span class="hljs-attr">"@wect/components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-21">7. 常用脚本命令详解</h3>
<p>根项目的 scripts 配置了批量操作子项目的命令，结合 Yarn Workspace 特性实现高效管理，核心命令及用途如下：</p>

































































<table><thead><tr><th>命令分类</th><th>具体命令</th><th>功能说明</th></tr></thead><tbody><tr><td>开发命令</td><td>yarn dev:web</td><td>单独启动 web 应用开发服务器</td></tr><tr><td>yarn dev:api</td><td>单独启动 API 服务开发服务器</td><td/></tr><tr><td>yarn dev:all</td><td>并行启动 web 和 API 开发服务（依赖 concurrently）</td><td/></tr><tr><td>构建命令</td><td>yarn build:all</td><td>构建所有工作空间（应用+公共包）</td></tr><tr><td>yarn build:apps</td><td>仅构建 apps 目录下的业务应用</td><td/></tr><tr><td>yarn build:packages</td><td>仅构建 packages 目录下的公共包</td><td/></tr><tr><td>质量保障命令</td><td>yarn test</td><td>运行所有子项目的测试用例</td></tr><tr><td>yarn lint / lint:fix</td><td>检查/修复所有子项目的代码规范问题</td><td/></tr><tr><td>yarn format / format:check</td><td>格式化代码/检查代码格式是否合规</td><td/></tr><tr><td>yarn clean</td><td>清理所有子项目的构建产物（dist 目录）</td><td/></tr><tr><td/><td/><td/></tr></tbody></table>
<p><strong>批量命令技巧</strong>：</p>
<ul>
<li><code>-A</code> 参数：操作所有工作空间；</li>
<li><code>-p</code> 参数：并行执行命令，提升效率；</li>
<li><code>--include</code> 参数：过滤目标工作空间，如 <code>--include 'apps/*'</code> 仅操作应用项目。</li>
</ul>
<h2 data-id="heading-22">六、版本一致性保障</h2>
<p>Monorepo 中依赖版本不一致是常见问题，可能导致运行报错或功能异常，需从以下三方面保障版本统一：</p>
<ol>
<li><strong>根级依赖锁定</strong>：将 TypeScript、构建工具、代码规范工具等公共依赖在根项目的 package.json 中明确定义版本，子项目无需重复声明，直接继承根依赖版本；</li>
<li><strong>使用 workspace 协议</strong>：子项目间的依赖必须使用 <code>workspace:*</code> 协议，确保始终引用本地最新版本，避免子项目间依赖版本错位；</li>
<li><strong>统一 TypeScript 配置</strong>：根项目创建 <code>tsconfig.base.json</code> 作为基础配置，子项目通过 <code>"extends": "../../tsconfig.base.json"</code> 继承，保证类型检查规则一致。</li>
</ol>
<h2 data-id="heading-23">七、实际配置总结</h2>
<p>本次 Monorepo 实现的核心配置要点可归纳为以下三点，便于后续维护和扩展：</p>
<ul>
<li><strong>依赖模式</strong>：采用 node-modules 模式，兼容性强，避免 PnP 模式可能出现的工具适配问题；</li>
<li><strong>命名规范</strong>：子项目统一使用 <code>@wect/</code> 作用域前缀，清晰区分项目归属，避免命名冲突；</li>
<li><strong>脚本统一</strong>：所有子项目定义一致的脚本命令（如 build、dev、test），确保批量操作顺畅；</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vite 下使用 Module Federation]]></title>    <link>https://juejin.cn/post/7575090551357571124</link>    <guid>https://juejin.cn/post/7575090551357571124</guid>    <pubDate>2025-11-23T08:31:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357571124" data-draft-id="7575106644499202082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vite 下使用 Module Federation"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T08:31:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一千柯橘"/> <meta itemprop="url" content="https://juejin.cn/user/2010369939736343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vite 下使用 Module Federation
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2010369939736343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一千柯橘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:31:56.000Z" title="Sun Nov 23 2025 08:31:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-dark">.hljs-comment,.hljs-quote{color:#898ea4}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#202746;color:#979db4}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Module Federation</h2>
<blockquote>
<p>Module Federation 的核心是  <strong>“打破构建边界，实现模块级的跨应用共享与协同”</strong> ，其最佳使用场景需满足以下特征：</p>
<ul>
<li>应用 / 模块由多团队独立开发维护；</li>
<li>需要复用公共依赖或组件，避免重复打包；</li>
<li>希望简化模块更新流程（免 npm 发布）；</li>
<li>需实现微前端、跨技术栈协作或模块级灰度发布。</li>
</ul>
</blockquote>
<blockquote>
<p>注意： 每个应用都可以在 Federation 中暴露 或者加载 远程可共享模块</p>
</blockquote>
<h3 data-id="heading-1">如何使用 vite 搭建 MF</h3>
<blockquote>
<p>项目 github 参考地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkejuqu%2Ffebe-repos" target="_blank" title="https://github.com/kejuqu/febe-repos" ref="nofollow noopener noreferrer">github.com/kejuqu/febe…</a></p>
</blockquote>
<h4 data-id="heading-2">创建两个应用 <code>vite-react</code> 和 <code>vite-react-provider</code></h4>
<ul>
<li><code>vite-react-provider</code> 暴露 Button 组件</li>
<li><code>vite-react</code> 使用 <code>vite-react-provider</code> 应用暴露的 Button 组件</li>
</ul>
<h4 data-id="heading-3"><code>vite-react-provider</code> 应用</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig, type <span class="hljs-title class_">PluginOption</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-react"</span>;
<span class="hljs-keyword">import</span> { federation } <span class="hljs-keyword">from</span> <span class="hljs-string">"@module-federation/vite"</span>;

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3006</span>,
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>({
      <span class="hljs-attr">babel</span>: {
        <span class="hljs-attr">plugins</span>: [[<span class="hljs-string">"babel-plugin-react-compiler"</span>]],
      },
    }),
    <span class="hljs-title function_">federation</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"remote"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">"remoteEntry.js"</span>,
      <span class="hljs-comment">// exposes 暴露 组件或者使用的工具函数</span>
      <span class="hljs-attr">exposes</span>: {
        <span class="hljs-string">"./c-button"</span>: <span class="hljs-string">"./src/components/button.tsx"</span>,
      },
      <span class="hljs-attr">shared</span>: [<span class="hljs-string">"react"</span>, <span class="hljs-string">"react-dom"</span>],
    }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PluginOption</span>[],
  ],
});

<span class="hljs-comment">// src/components/button.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">props: React.ComponentProps&lt;<span class="hljs-string">"button"</span>&gt;</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> {<span class="hljs-attr">...props</span>}&gt;</span>button from remote<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-4"><code>vite-react</code> 使用 React.Lazy + dynamic import 加载远程模块</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> { federation } <span class="hljs-keyword">from</span> <span class="hljs-string">"@module-federation/vite"</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-react"</span>;

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3005</span>,
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>({
      <span class="hljs-attr">babel</span>: {
        <span class="hljs-attr">plugins</span>: [[<span class="hljs-string">"babel-plugin-react-compiler"</span>]],
      },
    }),
    <span class="hljs-title function_">federation</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"customer"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">"vite-react.js"</span>,
      <span class="hljs-comment">// // exposes 暴露 组件或者使用的工具函数</span>
      <span class="hljs-comment">// exposes: {</span>
      <span class="hljs-comment">//   "./utils": "./src/utils.tsx",</span>
      <span class="hljs-comment">// },</span>
      <span class="hljs-attr">remotes</span>: {
        <span class="hljs-attr">remote</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"module"</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">"remote"</span>,
          <span class="hljs-attr">entry</span>: <span class="hljs-string">"http://localhost:3006/remoteEntry.js"</span>,
          <span class="hljs-attr">entryGlobalName</span>: <span class="hljs-string">"remote"</span>,
          <span class="hljs-attr">shareScope</span>: <span class="hljs-string">"default"</span>,
        },
      },
      <span class="hljs-attr">shared</span>: [<span class="hljs-string">"react"</span>, <span class="hljs-string">"react-dom"</span>],
    }),
  ],
});


<span class="hljs-comment">// src/App.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./App.css"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">RemoteBtn</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"remote/c-button"</span>));

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">React.Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">RemoteBtn</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> alert("clicked")} /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">React.Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-5">效果图</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f03d0efca94ae68eadce1ff86b881a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y2D5p-v5qmY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764491516&amp;x-signature=aLUFDZdcogXymuEubcgG3h7bQVo%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 JavaScript 中的异步编程：从回调到 async/await]]></title>    <link>https://juejin.cn/post/7575162322239995904</link>    <guid>https://juejin.cn/post/7575162322239995904</guid>    <pubDate>2025-11-23T08:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322239995904" data-draft-id="7575112613777997858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 JavaScript 中的异步编程：从回调到 async/await"/> <meta itemprop="keywords" content="Promise"/> <meta itemprop="datePublished" content="2025-11-23T08:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 JavaScript 中的异步编程：从回调到 async/await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:35:05.000Z" title="Sun Nov 23 2025 08:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 JavaScript 中的异步编程：从回调到 async/await</h2>
<p>在现代 Web 开发中，异步操作无处不在——无论是从服务器获取数据、读取本地文件，还是处理用户交互。JavaScript 作为一门单线程语言，通过多种机制支持异步编程。本文将带你回顾异步编程的发展历程，并重点解析 <code>async/await</code> 这一 ES8 引入的强大语法糖。</p>
<hr/>
<h3 data-id="heading-1">1. 回调函数（Callback）时代：最初的异步方案</h3>
<p>早期的 JavaScript 主要依赖<strong>回调函数</strong>来处理异步操作。例如，在 Node.js 中使用 <code>fs.readFile</code> 读取文件：</p>
<pre><code class="hljs language-javascript" lang="javascript">fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./1.html'</span>, <span class="hljs-string">'utf-8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);
});
</code></pre>
<p>这种方式简单直接，但存在明显问题：</p>
<ul>
<li><strong>回调地狱（Callback Hell）</strong> ：多层嵌套导致代码难以阅读和维护。</li>
<li><strong>错误处理分散</strong>：每个回调都需要单独处理错误。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. Promise：ES6 带来的结构化异步</h3>
<p>为了解决回调地狱，ES6 引入了 <strong>Promise</strong> 对象，它代表一个异步操作的最终完成（或失败）及其结果值。</p>
<p>我们可以将 <code>fs.readFile</code> 封装成一个 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./1.html'</span>, <span class="hljs-string">'utf-8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-title function_">reject</span>(err);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">resolve</span>(data);
    });
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);
}).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
});
</code></pre>
<p>Promise 的优势：</p>
<ul>
<li>链式调用（<code>.then().then()</code>）</li>
<li>统一的错误处理（<code>.catch()</code>）</li>
<li>更清晰的异步流程控制</li>
</ul>
<p>但 <code>.then()</code> 链仍然不够“同步感”，尤其在复杂逻辑中仍显繁琐。</p>
<hr/>
<h3 data-id="heading-3">3. async / await：ES8 的终极优雅方案</h3>
<p>ES8（ECMAScript 2017）引入了 <strong><code>async</code> 和 <code>await</code></strong>，让异步代码写起来像同步代码一样直观。</p>
<h4 data-id="heading-4">基本用法</h4>
<ul>
<li><code>async</code> 用于声明一个函数为异步函数，该函数<strong>总是返回一个 Promise</strong>。</li>
<li><code>await</code> 只能在 <code>async</code> 函数内部使用，用于“等待”一个 Promise 被 resolve，并将其结果赋值给变量。</li>
</ul>
<p>例如，封装后的文件读取可以这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> html = <span class="hljs-keyword">await</span> p; <span class="hljs-comment">// 等待 Promise 完成</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(html);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
    }
};
<span class="hljs-title function_">main</span>();
</code></pre>
<p>再比如，从 GitHub API 获取用户仓库信息：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">main</span> = async () =&gt; {
    try {
        const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.github.com/users/shunwuyu/repos'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
        console.log(data)<span class="hljs-comment">;</span>
    } catch (error) {
        console.error('请求失败:', error)<span class="hljs-comment">;</span>
    }
}<span class="hljs-comment">;</span>
main()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">优势总结</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>可读性强</strong></td><td>代码结构接近同步逻辑，易于理解和调试</td></tr><tr><td><strong>错误处理统一</strong></td><td>使用 <code>try...catch</code> 捕获异步错误</td></tr><tr><td><strong>避免回调地狱</strong></td><td>不再需要层层嵌套 <code>.then()</code></td></tr><tr><td><strong>与现有 Promise 兼容</strong></td><td><code>await</code> 后可接任何 Promise</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">4. 实际应用场景对比</h3>
<p>以获取 GitHub 用户仓库为例：</p>
<ul>
<li>
<p><strong>传统 Promise 链式写法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/users/shunwuyu/repos')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; console.log(data))
  .catch(<span class="hljs-attr">err</span> =&gt; console.error(err))<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>async/await 写法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">getRepos</span> = async () =&gt; {
    try {
        const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.github.com/users/shunwuyu/repos'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
        console.log(data)<span class="hljs-comment">;</span>
    } catch (err) {
        console.error(err)<span class="hljs-comment">;</span>
    }
}<span class="hljs-comment">;</span>
getRepos()<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<p>后者更接近自然语言：“先获取响应，再解析 JSON，最后打印数据”。</p>
<hr/>
<h3 data-id="heading-7">5. 注意事项</h3>
<ul>
<li><code>await</code> 只能在 <code>async</code> 函数内使用。</li>
<li><code>async</code> 函数总是返回 Promise，即使你 <code>return</code> 一个普通值。</li>
<li>多个不相关的异步操作应避免串行 <code>await</code>，可使用 <code>Promise.all()</code> 并行处理以提升性能。</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 低效：串行执行</span>
const <span class="hljs-selector-tag">a</span> = await <span class="hljs-built_in">fetch</span>(url1);
const <span class="hljs-selector-tag">b</span> = await <span class="hljs-built_in">fetch</span>(url2);

<span class="hljs-comment">// ✅ 高效：并行执行</span>
const <span class="hljs-selector-attr">[res1, res2]</span> = await Promise<span class="hljs-selector-class">.all</span>([fetch(url1), <span class="hljs-built_in">fetch</span>(url2)]);
</code></pre>
<hr/>
<h3 data-id="heading-8">结语</h3>
<p>从回调函数到 Promise，再到 <code>async/await</code>，JavaScript 的异步编程模型不断演进，目标始终是：<strong>让异步代码更简洁、更安全、更易维护</strong>。如今，<code>async/await</code> 已成为现代前端和 Node.js 开发的标配。掌握它，不仅能提升开发效率，也能写出更具可读性和健壮性的代码。</p>
<blockquote>
<p>正如那句老话所说：“异步不可怕，可怕的是写得像同步却不是同步。”而 <code>async/await</code>，正是让异步“看起来像同步”的最佳实践。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[人人都能学AI，人人都要学AI]]></title>    <link>https://juejin.cn/post/7575106644499251234</link>    <guid>https://juejin.cn/post/7575106644499251234</guid>    <pubDate>2025-11-23T09:00:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499251234" data-draft-id="7575162322240045056" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="人人都能学AI，人人都要学AI"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-23T09:00:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袁庭新"/> <meta itemprop="url" content="https://juejin.cn/user/1207714136735408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            人人都能学AI，人人都要学AI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1207714136735408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袁庭新
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:00:37.000Z" title="Sun Nov 23 2025 09:00:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是袁庭新。很多朋友想借助AI来赋能自己，但苦于不知从何学起，又世面上的学习资料鱼龙混杂，怕误了时间；为此呢，我专门创建了一个AI技术学习的知识星球，星球里有海量的成体系的学习资料供大家学习。</p>
<p><strong>1、星球介绍</strong></p>
<p>知识星球「人人都要学AI」是由袁庭新发起的一站式AI学习社群。涵盖文案写作、PPT制作、数据分析、思维导图、会议纪要、视频生成、生活、教育、创业、政务、法律、投研、科研、自媒体、智能体、软件开发、等50余高频工作场景，100+提示词开箱即用。社群内每月设大咖直播答疑，支持全天候互动交流，致力于为职场人、学生党、创业者等不同群体，搭建从理论认知到实践落地的全链路成长平台，助你系统掌握AI知识与技能，拥抱数字化时代的核心竞争力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e97d401987143fcb3681f7aeaa05ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764493237&amp;x-signature=cQTmfuY4htKGFFMY8lDC%2Fz2wnWs%3D" alt="" loading="lazy"/></p>
<p><strong>2、星球亮点</strong></p>
<p>（1）AI行业信息：快速掌握AI领域最新动态，深度解读关键事件与行业趋势，助你始终站在技术前沿。</p>
<p>（2）AI专业知识：定期分享AI工具实操、应用教程、案例解析及开源项目，构建系统化知识体系。</p>
<p>（3）资料库共享：每周更新AI研报、政策解读、工具教材及案例资料，星友可免费下载学习。</p>
<p>（4）实战项目：提供保姆级教程、教练带队指导与社群答疑支持。</p>
<p>（5）人脉链接：联结志同道合的AI学习者，通过交流探讨实现经验共享与共同成长。</p>
<p>（6）社群陪伴：星球配有专属微信群，不定期邀请嘉宾分享，还方便寻找同频伙伴一起进步。</p>
<p>（7）专家答疑：星主与嘉宾会在社群和直播间里答疑，帮助大家解决日常工作中遇到的AI应用相关问题。</p>
<p>（8）资源对接：联通行业专家、合作伙伴与投资者，助力获取AI领域所需资源。</p>
<p>（9）副业变现：借助AI技术探索绘画、视频、数字人、智能体等变现路径，实现个人创富目标。</p>
<p>（10）社群共创：不仅有AI读报时间，学员还可以分享学习笔记、AI实操案例，探索AI变现项目，促进知识的交流与合作。</p>
<p>（11）岗位内推：为星球成员提供来自知名企业的内推机会，涵盖互联网、人工智能、科技等热门领域的招聘岗位，助力精准求职。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7136b2e4031e44dab9866bfc7ba7574e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764493237&amp;x-signature=MpfHrWg3zXan07uiVQPEDPCqoeA%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端直连大模型：用原生 JavaScript 调用 DeepSeek API]]></title>    <link>https://juejin.cn/post/7575133880436326451</link>    <guid>https://juejin.cn/post/7575133880436326451</guid>    <pubDate>2025-11-23T08:34:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575133880436326451" data-draft-id="7575119254313861146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端直连大模型：用原生 JavaScript 调用 DeepSeek API"/> <meta itemprop="keywords" content="JavaScript,DeepSeek"/> <meta itemprop="datePublished" content="2025-11-23T08:34:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端直连大模型：用原生 JavaScript 调用 DeepSeek API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:34:10.000Z" title="Sun Nov 23 2025 08:34:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI 应用快速普及的今天，大语言模型（LLM）不再只是后端服务的专属能力。通过标准的 HTTP 接口，前端应用也能直接与模型对话——无需中间服务器，只需一个 API Key 和几行代码。本文将带你从零开始，使用原生 HTML/JavaScript 搭建一个能调用 DeepSeek 大模型的前端项目，并深入解析如何安全、规范地发起复杂请求。</p>
<h2 data-id="heading-0">项目初始化：选择合适的开发脚手架</h2>
<p>虽然纯 HTML 文件足以完成基础调用，但现代前端开发更推荐使用工程化工具提升效率。Vite 是目前最轻量且功能强大的全栈脚手架之一，支持 TypeScript、环境变量、热更新等特性。</p>
<p>首先，初始化一个 Vite 项目：</p>
<pre><code class="hljs language-perl" lang="perl">npm create vite@latest <span class="hljs-keyword">my</span>-llm-app -- --template vanilla
cd <span class="hljs-keyword">my</span>-llm-app
npm install
</code></pre>
<p>这会创建一个基于原生 JavaScript 的项目结构，包含 <code>index.html</code> 和 <code>main.js</code>，非常适合快速集成 LLM 调用逻辑。</p>
<h2 data-id="heading-1">理解 LLM 的 HTTP 调用协议</h2>
<p>大模型 API 本质上是一个标准的 RESTful 服务。以 DeepSeek 为例，其聊天接口地址为：</p>
<pre><code class="hljs language-bash" lang="bash">https://api.deepseek.com/v1/chat/completions
</code></pre>
<p>调用它需要构造一个符合要求的 <strong>POST 请求</strong>，包含三个关键部分：</p>
<h3 data-id="heading-2">1. 请求行（Request Line）</h3>
<ul>
<li>方法：<code>POST</code></li>
<li>URL：完整接口地址</li>
<li>协议版本：HTTP/1.1（由浏览器自动处理）</li>
</ul>
<h3 data-id="heading-3">2. 请求头（Headers）</h3>
<p>必须包含两项：</p>
<ul>
<li><code>Content-Type: application/json</code>：声明请求体为 JSON 格式</li>
<li><code>Authorization: Bearer &lt;your-api-key&gt;</code>：身份认证令牌</li>
</ul>
<h3 data-id="heading-4">3. 请求体（Body）</h3>
<ul>
<li>必须是字符串，不能直接传 JavaScript 对象</li>
<li>需用 <code>JSON.stringify()</code> 序列化</li>
<li>包含模型名称、消息历史等参数</li>
</ul>
<h2 data-id="heading-5">前端代码实现：用 fetch 发起请求</h2>
<p>下面是在 <code>main.js</code> 中封装的调用函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从环境变量读取 API Key（Vite 支持 .env 文件）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_KEY</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_DEEPSEEK_API_KEY</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">'https://api.deepseek.com/v1/chat/completions'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">askDeepSeek</span>(<span class="hljs-params">messages</span>) {
  <span class="hljs-keyword">const</span> payload = {
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,
    <span class="hljs-attr">messages</span>: messages,
    <span class="hljs-attr">max_tokens</span>: <span class="hljs-number">500</span>
  };

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">API_URL</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
  });

  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">${response.status}</span>`</span>);
  }

  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
}
</code></pre>
<h3 data-id="heading-6">关键点解析：</h3>
<ul>
<li>
<p><strong><code>import.meta.env</code></strong>：Vite 提供的环境变量读取方式。需在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">VITE_DEEPSEEK_API_KEY</span>=sk-xxxxxxxxxxxxxxxxxxxx
</code></pre>
<blockquote>
<p>注意：Vite 要求环境变量必须以 <code>VITE_</code> 开头才能在前端暴露，这是安全机制。</p>
</blockquote>
</li>
<li>
<p><strong><code>await fetch</code></strong>：相比 <code>.then()</code> 链式调用，<code>async/await</code> 语法更接近同步代码，逻辑清晰易读。</p>
</li>
<li>
<p><strong>错误处理</strong>：检查 <code>response.ok</code> 可捕获 4xx/5xx 错误，避免解析失败的 JSON。</p>
</li>
</ul>
<h2 data-id="heading-7">在页面中使用</h2>
<p>在 <code>index.html</code> 中添加简单交互：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>AI 助手<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"question"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入问题..."</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleAsk()"</span>&gt;</span>提问<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"answer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAsk</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'question'</span>);
      <span class="hljs-keyword">const</span> answerDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'answer'</span>);
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">askDeepSeek</span>([
          { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: input.<span class="hljs-property">value</span> }
        ]);
        answerDiv.<span class="hljs-property">textContent</span> = response;
      } <span class="hljs-keyword">catch</span> (err) {
        answerDiv.<span class="hljs-property">textContent</span> = <span class="hljs-string">'请求失败：'</span> + err.<span class="hljs-property">message</span>;
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这里通过内联 <code>&lt;script&gt;</code> 调用模块化的 <code>askDeepSeek</code> 函数，实现了从用户输入到 AI 回答的完整流程。</p>
<h2 data-id="heading-8">安全提醒：前端暴露 API Key 的风险</h2>
<p>必须明确：<strong>将 API Key 写在前端代码中存在泄露风险</strong>。任何访问你网页的用户都能通过开发者工具查看该密钥。因此，这种方式仅适用于：</p>
<ul>
<li>个人测试项目</li>
<li>密钥有严格用量限制</li>
<li>使用了 API 平台的域名白名单或 Referer 限制</li>
</ul>
<p>对于生产环境，强烈建议通过自己的后端代理请求，由服务器保管密钥。</p>
<h2 data-id="heading-9">总结</h2>
<p>通过原生 fetch API，前端可以直接与大模型服务通信，实现低延迟的智能交互。结合 Vite 的工程化能力，我们不仅能高效开发，还能通过环境变量管理敏感信息。虽然存在安全限制，但在可控场景下，这种“前端直连 LLM”的模式极大简化了 AI 应用的构建流程——从一行 HTML 到智能对话，不过百行代码的距离。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出谈谈RPC框架]]></title>    <link>https://juejin.cn/post/7575104251865890826</link>    <guid>https://juejin.cn/post/7575104251865890826</guid>    <pubDate>2025-11-22T16:11:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575104251865890826" data-draft-id="7575083657994223643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出谈谈RPC框架"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-22T16:11:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XUN4J"/> <meta itemprop="url" content="https://juejin.cn/user/4179664935335515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出谈谈RPC框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4179664935335515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XUN4J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T16:11:48.000Z" title="Sat Nov 22 2025 16:11:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想要学好微服务，RPC框架肯定是一个绕不开的话题。在我看来，任何框架都是为了后续开发者的便利，帮我们封装好可重复利用的工具或者某些固定流程，RPC框架也不例外。RPC框架最重要的作用就是帮我们将多个服务连接起来，即实现<strong>远程调用</strong>，让我们能<strong>像调用本地方法一样调用别的服务里的方法</strong>。</p>
<p>简而言之，RPC框架就是将复杂的网络通信、序列化等操作封装起来，这是最重要的。当然，一个完整的生产级RPC框架还融合了更多模块来保证其健壮性和高性能，比如服务注册与发现、重试机制、容错（熔断）机制、基于TCP的自定义协议、负载均衡等。这篇文章为了“浅出”，我们先搭建一个简易RPC框架的骨架，讲讲各个核心模块的作用，暂不深入挖掘具体实现。</p>
<h3 data-id="heading-0">一、 网络通信</h3>
<p>首先，我们想要调用另一个服务的方法，必然要通过网络进行通信。最常见的就是消费者发送一个请求，提供者处理后再返回结果。那么，这个请求里需要包含哪些信息，提供者才能准确地找到并执行对应的方法呢？</p>
<p><strong>核心信息包括：</strong></p>
<ol>
<li><strong>接口全限定名</strong>：比如 <code>com.example.UserService</code>。告诉提供者“我要调用哪个服务接口”。</li>
<li><strong>方法名</strong>：比如 <code>getUserById</code>。告诉提供者“我要调用这个接口下的哪个方法”。</li>
<li><strong>参数类型</strong>：比如 <code>(java.lang.Long)</code>。方法可能会重载，只有方法名不够，还需要参数类型才能唯一确定一个方法。</li>
<li><strong>参数值</strong>：比如 <code>123L</code>。执行方法所需要的具体数据。</li>
<li><strong>版本号</strong>（可选）：如果接口有多个不兼容的版本，需要版本号来做区分。</li>
</ol>
<p><strong>通信协议的选择：</strong></p>
<ul>
<li><strong>HTTP</strong>：优点在于简单、通用，任何语言都支持。但对于高性能的RPC内部调用来说，HTTP协议的头部信息（Header）较大，效率不是最高。</li>
<li><strong>TCP + 自定义协议</strong>：高性能RPC框架（如Dubbo、gRPC）的常见选择。可以设计非常紧凑的二进制协议，减少不必要的网络开销，性能极高。这才是RPC框架网络层的精髓。</li>
</ul>
<p><strong>简单来说，网络通信模块就是RPC的远程调用的“核心”，负责将请求从客户端运送到服务端，再把结果运送回来。</strong></p>
<h3 data-id="heading-1">二、 代理对象</h3>
<p>既然我们的目标是“像调用本地方法一样”，那么我们在客户端代码里就不应该看到任何网络操作的痕迹（比如<code>HttpClient</code>）。如何实现这一点？答案就是：<strong>动态代理</strong>。</p>
<p>代理对象是RPC框架的“魔法师”，它对外伪装成真正的服务接口。当你调用 <code>userService.getUserById(123)</code>时，你实际上调用的是代理对象的方法。</p>
<p>这个代理对象在背后默默地做了以下事情：</p>
<ol>
<li><strong>拦截调用</strong>：它拦截了你对所有接口方法的调用。</li>
<li><strong>信息封装</strong>：它将你调用的方法名、参数类型、参数值等信息，按照和服务器约定好的格式封装起来。</li>
<li><strong>委托通信模块</strong>：它将封装好的数据交给<strong>网络通信</strong>模块发送给服务端。</li>
<li><strong>等待并返回结果</strong>：它同步等待网络返回，拿到结果数据后，再原样返回给你。</li>
</ol>
<p>这样，作为开发者的你，只需要关心接口的定义和调用，完全感知不到背后的网络请求。代理模式是实现RPC透明性的关键技术。</p>
<h3 data-id="heading-2">三、 注册中心</h3>
<p>在简单的RPC调用中，服务提供者的IP和端口可以直接写在消费者的配置里。但在微服务架构中，服务实例众多且会动态变化（扩缩容、宕机），这种“硬编码”的方式就无法工作了。这时就需要<strong>注册中心</strong>。</p>
<p>注册中心就像是微服务世界的 <strong>“服务列表”</strong>，存储了各种服务状态以及信息，让Consummer知道给哪个ip中的哪个端口发送消息。</p>
<ul>
<li><strong>服务注册</strong>：当一个服务提供者启动时，它会将自己的服务名（如<code>UserService</code>）和网络地址（如<code>192.168.1.10:8080</code>）注册到注册中心。</li>
<li><strong>服务发现</strong>：当一个服务消费者需要调用<code>UserService</code>时，它不再需要硬编码地址，而是去注册中心查询所有可用的<code>UserService</code>实例的地址列表。</li>
<li><strong>健康检查</strong>：注册中心会定期检查服务提供者的健康状态（心跳机制），如果发现某个实例宕机，就将其从地址列表中移除，确保消费者不会调用到已失效的节点。</li>
</ul>
<p><strong>常见的注册中心有：Nacos、Zookeeper、Consul、Eureka等。</strong> ​ 注册中心的存在是实现服务治理和高可用的基石。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/408592a6ecd54b9eb6d23ef53a55e2b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWFVONEo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764473391&amp;x-signature=FdpfkbCpv1Un%2BKw7FKv8rtmVHDk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">四、 优化与扩展</h3>
<p>一个基础的RPC框架有了以上三个部分就可以运行了。但要成为一个成熟的生产级框架，还需要很多可优化和扩展的点。</p>
<p><strong>1. 多种序列化方式</strong></p>
<p>序列化是将对象转换为字节流的过程，反序列化则是其逆过程。不同的序列化协议在速度、体积、可读性、跨语言支持上各有优劣。提供多种选择（如JSON、Hessian、Protobuf、Kryo）可以让用户根据具体场景（如高性能、跨语言）进行权衡。</p>
<p><strong>2. 多种负载均衡策略</strong></p>
<p>当同一个服务有多个提供者时，消费者需要决定调用哪一个。这就是负载均衡。常见的策略有：</p>
<ul>
<li><strong>随机</strong>：从可用列表中随机选择一个。</li>
<li><strong>轮询</strong>：依次调用每一个提供者。</li>
<li><strong>最少活跃调用数</strong>：优先调用当前处理请求最少的服务器。</li>
<li><strong>一致性哈希</strong>：相同参数的请求总是发到同一提供者，适用于需要缓存的场景。</li>
</ul>
<p><strong>3. 多种网络通信协议</strong></p>
<p>除了支持基本的TCP自定义协议，还可以扩展支持HTTP/2、gRPC等协议，以适应不同的网络环境或生态集成。</p>
<p><strong>4. SPI机制</strong></p>
<p>SPI（Service Provider Interface）是一种服务发现机制。
它将接口的实现类配置在文件中，程序在运行时读取文件来加载具体的实现。不同于SpringBoot里将配置信息写在application中，可以实现某些配置信息与业务代码分离。SPI的作用是实现动态加载，其结合application就可以完美实现上述多种协议、多种序列化机制的动态选择。
<strong>利用SPI，框架的所有核心组件（如序列化、负载均衡、注册中心）都可以做成可插拔的</strong>，极大地提升了框架的扩展性。这是Dubbo等优秀框架设计的精髓。</p>
<p><strong>5. 重试机制与容错机制</strong></p>
<p>网络是不可靠的，调用可能会失败。框架需要提供容错策略。</p>
<ul>
<li>
<p><strong>重试机制</strong>：调用失败后自动重试，通常需要配合幂等设计。</p>
</li>
<li>
<p><strong>容错策略</strong>：</p>
<ul>
<li><strong>Failover</strong>（故障转移）：失败后自动重试其他服务器。</li>
<li><strong>Failfast</strong>（快速失败）：失败后立即报错，用于非幂等操作。</li>
<li><strong>Failsafe</strong>（安全失败）：失败后忽略，仅记录日志。</li>
<li><strong>熔断器机制</strong>：当故障达到一定阈值，自动“熔断”，防止故障雪崩，并在一段时间后尝试恢复。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">总结</h3>
<p>让我们再串一下整个流程：消费者通过<strong>代理对象</strong>调用接口方法 -&gt; 代理对象将调用信息<strong>序列化</strong>​ -&gt; 通过<strong>网络通信</strong>模块发送请求 -&gt; 请求首先被发往<strong>注册中心</strong>进行服务发现，获取真实的服务地址 -&gt; 请求被发送到服务提供者 -&gt; 提供者<strong>反序列化</strong>请求，通过反射执行本地方法 -&gt; 将结果按原路返回。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java面试题总结（含答案）]]></title>    <link>https://juejin.cn/post/7575112613777834018</link>    <guid>https://juejin.cn/post/7575112613777834018</guid>    <pubDate>2025-11-23T06:02:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613777834018" data-draft-id="7575162322239815680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java面试题总结（含答案）"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-11-23T06:02:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java面试题总结（含答案）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T06:02:45.000Z" title="Sun Nov 23 2025 06:02:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h6 data-id="heading-0">发现网上很多Java面试题都没有答案，所以花了很长时间搜集整理出来了这套Java面试题大全~ <strong>这套互联网 Java 工程师面试题包括了：MyBatis、ZK、Dubbo、EL、Redis、MySQL、并发编程、Java面试、Spring、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong>  <strong>一、Java 基础</strong> <strong>1. JDK 和 JRE 有什么区别？</strong>  </h6>
<ul>
<li>JDK：Java Development Kit 的简称，java 开发工具包，提供了 java 的开发环境和运行环境。</li>
<li>JRE：Java Runtime Environment 的简称，java 运行环境，为 java 的运行提供了所需环境。</li>
</ul>
<p>具体来说 JDK 其实包含了 JRE，同时还包含了[编译 java] 源码的编译器 [javac]，还包含了很多 java 程序调试和分析的工具。简单来说：如果你需要运行 java 程序，只需安装 JRE 就可以了，如果你需要编写 java 程序，需要安装 JDK。<br/>
<strong>2. == 和 equals 的区别是什么？</strong><br/>
== 对于基本类型来说是值比较，对于引用类型来说是比较的是引用；而 equals 默认情况下是引用比较，只是很多类重新了 equals 方法，比如 String、Integer 等把它变成了值比较，所以一般情况下 equals 比较的是值是否相等。<br/>
<strong>3. 两个对象的 hashCode()相同，则 equals()也一定为 true，对吗？</strong><br/>
不对，两个对象的 hashCode()相同，equals()不一定 true。<br/>
代码解读：很显然“通话”和“重地”的 hashCode() 相同，然而 equals() 则为 false，因为在[散列表]中，hashCode()相等即两个键值对的哈希值相等，然而哈希值相等，并不一定能得出键值对相等。<br/>
<strong>4. final 在 java 中有什么作用？</strong><br/>
</p>
<ul>
<li>final 修饰的类叫最终类，该类不能被继承。</li>
<li>final 修饰的方法不能被重写。</li>
<li>final 修饰的变量叫常量，常量必须初始化，初始化之后值就不能被修改。</li>
</ul>
<p><strong>5. java 中的 Math.round(-1.5) 等于多少？</strong><br/>
等于 -1，因为在数轴上取值时，中间值（0.5）向右取整，所以正 0.5 是往上取整，负 0.5 是直接舍弃。<br/>
<strong>6. String 属于基础的数据类型吗？</strong><br/>
String 不属于基础类型，基础类型有 8 种：byte、boolean、char、short、int、float、long、double，而 String 属于对象。<br/>
<strong>7. java 中操作字符串都有哪些类？它们之间有什么区别？</strong><br/>
操作字符串的类有：String、StringBuffer、StringBuilder。<br/>
String 和 StringBuffer、StringBuilder 的区别在于 String 声明的是不可变的对象，每次操作都会生成新的 String 对象，然后将指针指向新的 String</p>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                    即可免费获取**</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1134fb8ab14da08b3b633d1585cba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=Vh90fwbFeCv54lFdBGJtsGkM0X8%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<p>对象，而 StringBuffer、StringBuilder 可以在原有对象的基础上进行操作，所以在经常改变字符串内容的情况下最好不要使用 String。<br/>
StringBuffer 和 StringBuilder 最大的区别在于，StringBuffer 是线程安全的，而 StringBuilder 是非线程安全的，但 StringBuilder 的性能却高于 StringBuffer，所以在单线程环境下推荐使用 StringBuilder，多线程环境下推荐使用 StringBuffer。<br/>
<strong>8. String str="i"与 String str=new String("i")一样吗？</strong><br/>
不一样，因为内存的分配方式不一样。String str="i"的方式，java 虚拟机会将其分配到[常量池]中；而 String str=new String("i") 则会被分到堆内存中。<br/>
<strong>9. 如何将字符串反转？</strong><br/>
使用 StringBuilder 或者 stringBuffer 的 reverse() 方法。<br/>
<strong>10. String 类的常用方法都有那些？</strong></p>
<ul>
<li>indexOf()：返回指定字符的索引。</li>
<li>charAt()：返回指定索引处的字符。</li>
<li>replace()：字符串替换。</li>
<li>trim()：去除字符串两端空白。</li>
<li>split()：分割字符串，返回一个分割后的字符串数组。</li>
<li>getBytes()：返回字符串的 byte 类型数组。</li>
<li>length()：返回字符串长度。</li>
<li>toLowerCase()：将字符串转成小写字母。</li>
<li>toUpperCase()：将字符串转成大写字符。</li>
<li>substring()：截取字符串。</li>
<li>equals()：字符串比较。</li>
</ul>
<p><strong>11. 抽象类必须要有抽象方法吗？</strong><br/>
不需要，抽象类不一定非要有抽象方法。<br/>
</p>
<ul>
<li>普通类不能包含抽象方法，抽象类可以包含抽象方法。</li>
<li>抽象类不能直接实例化，普通类可以直接实例化。</li>
</ul>
<p><strong>13. 抽象类能使用 final 修饰吗？</strong><br/>
不能，定义抽象类就是让其他类继承的，如果定义为 final 该类就不能被继承，这样彼此就会产生矛盾，所以 final 不能修饰抽象类<br/>
<strong>14. 接口和抽象类有什么区别？</strong><br/>
</p>
<ul>
<li>实现：抽象类的子类使用 extends 来继承；接口必须使用 implements 来实现接口。</li>
<li>构造函数：抽象类可以有构造函数；接口不能有。</li>
<li>main 方法：抽象类可以有 main 方法，并且我们能运行它；接口不能有 main 方法。</li>
<li>实现数量：类可以实现很多个接口；但是只能继承一个抽象类。</li>
<li>访问修饰符：接口中的方法默认使用 public 修饰；抽象类中的方法可以是任意访问修饰符。</li>
</ul>
<p><strong>15. java 中 IO 流分为几种？</strong><br/>
按功能来分：输入流（input）、输出流（output）。<br/>
按类型来分：字节流和字符流。<br/>
字节流和字符流的区别是：字节流按 8 位传输以字节为单位输入输出数据，字符流按 16 位传输以字符为单位输入输出数据。<br/>
<strong>16. BIO、NIO、AIO 有什么区别？</strong><br/>
</p>
<ul>
<li>BIO：Block IO 同步阻塞式 IO，就是我们平常使用的传统 IO，它的特点是模式简单使用方便，并发处理能力低。</li>
<li>NIO：New IO 同步非阻塞 IO，是传统 IO 的升级，客户端和服务器端通过 Channel（通道）通讯，实现了多路复用。</li>
<li>AIO：Asynchronous IO 是 NIO 的升级，也叫 NIO2，实现了异步非堵塞 IO ，异步 IO 的操作基于事件和回调机制。</li>
</ul>
<p><strong>17. Files的常用方法都有哪些？</strong><br/>
</p>
<ul>
<li>
<p>Files.exists()：检测文件路径是否存在。</p>
</li>
<li>
<p>Files.createFile()：创建文件。</p>
</li>
<li>
<p>Files.createDirectory()：创建文件夹。</p>
</li>
<li>
<p>Files.delete()：删除一个文件或目录。</p>
</li>
<li>
<p>Files.copy()：复制文件。</p>
</li>
<li>
<p>Files.move()：移动文件。</p>
</li>
<li>
<p>Files.size()：查看文件个数。</p>
</li>
<li>
<p>Files.read()：读取文件。</p>
</li>
<li>
<p>Files.write()：写入文件。</p>
</li>
</ul>
<p><strong>二、容器</strong><br/>
<strong>18. java 容器都有哪些？</strong><br/>
常用容器的图录：<br/>
</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c491f90ead85489da6c3ff49e9a507e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=U5zJhf%2BwK%2BI%2FW7ZLdeEZTE9lyXQ%3D" alt="" loading="lazy"/></p>
<p><strong>19. Collection 和 Collections 有什么区别？</strong><br/>
</p>
<ul>
<li>java.util.Collection 是一个集合接口（集合类的一个顶级接口）。它提供了对集合对象进行基本操作的通用接口方法。Collection接口在Java 类库中有很多具体的实现。Collection接口的意义是为各种具体的集合提供了最大化的统一操作方式，其直接继承接口有List与Set。</li>
<li>Collections则是集合类的一个工具类/帮助类，其中提供了一系列静态方法，用于对集合中元素进行排序、搜索以及线程安全等各种操作。</li>
</ul>
<p><strong>20. List、Set、Map 之间的区别是什么？</strong><br/>
</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5264903a4f074b50b673a66693add46f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=tN03Yd6DCz9uHfDexX8seIR4DQs%3D" alt="" loading="lazy"/></p>
<p><strong>21. HashMap 和 Hashtable 有什么区别？</strong><br/>
</p>
<ul>
<li>
<p>hashMap去掉了HashTable 的contains方法，但是加上了containsValue（）和containsKey（）方法。</p>
</li>
<li>
<p>hashTable同步的，而HashMap是非同步的，效</p>
</li>
</ul>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                    即可免费获取**</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1134fb8ab14da08b3b633d1585cba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=Vh90fwbFeCv54lFdBGJtsGkM0X8%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs">率上逼hashTable要高。
</code></pre>
<ul>
<li>hashMap允许空键值，而hashTable不允许。</li>
</ul>
<p><strong>22. 如何决定使用 HashMap 还是 TreeMap？</strong><br/>
对于在Map中插入、删除和定位元素这类操作，HashMap是最好的选择。然而，假如你需要对一个有序的key集合进行遍历，TreeMap是更好的选择。基于你的collection的大小，也许向HashMap中添加元素会更快，将map换为TreeMap进行有序key的遍历。<br/>
<strong>23. 说一下 HashMap 的实现原理？</strong><br/>
HashMap概述： HashMap是基于哈希表的Map接口的非同步实现。此实现提供所有可选的映射操作，并允许使用null值和null键。此类不保证映射的顺序，特别是它不保证该顺序恒久不变。<br/>
HashMap的数据结构： 在java编程语言中，最基本的结构就是两种，一个是数组，另外一个是模拟指针（引用），所有的数据结构都可以用这两个基本结构来构造的，HashMap也不例外。HashMap实际上是一个“链表散列”的数据结构，即数组和链表的结合体。<br/>
</p>
<ul>
<li>HashSet底层由HashMap实现</li>
<li>HashSet的值存放于HashMap的key上</li>
<li>HashMap的value统一为PRESENT</li>
</ul>
<p><strong>25. ArrayList 和 LinkedList 的区别是什么？</strong><br/>
最明显的区别是 ArrrayList底层的数据结构是数组，支持随机访问，而 LinkedList 的底层数据结构是双向循环链表，不支持随机访问。使用下标访问一个元素，ArrayList 的时间复杂度是 O(1)，而 LinkedList 是 O(n)。<br/>
<strong>26. 如何实现数组和 List 之间的转换？</strong><br/>
</p>
<ul>
<li>List转换成为数组：调用ArrayList的toArray方法。</li>
<li>数组转换成为List：调用Arrays的asList方法。</li>
</ul>
<p><strong>27. ArrayList 和 Vector 的区别是什么？</strong><br/>
</p>
<ul>
<li>Vector是同步的，而ArrayList不是。然而，如果你寻求在迭代的时候对列表进行改变，你应该使用CopyOnWriteArrayList。</li>
<li>ArrayList比Vector快，它因为有同步，不会过载。</li>
<li>ArrayList更加通用，因为我们可以使用Collections工具类轻易地获取同步列表和只读列表。</li>
</ul>
<p><strong>28. Array 和 ArrayList 有何区别？</strong><br/>
</p>
<ul>
<li>Array可以容纳基本类型和对象，而ArrayList只能容纳对象。</li>
<li>Array是指定大小的，而ArrayList大小是固定的。</li>
<li>Array没有提供ArrayList那么多功能，比如addAll、removeAll和iterator等。</li>
</ul>
<p><strong>29. 在 Queue 中 poll()和 remove()有什么区别？</strong><br/>
poll() 和 remove() 都是从队列中取出一个元素，但是 poll() 在获取元素失败的时候会返回空，但是 remove() 失败的时候会抛出异常。<br/>
<strong>30. 哪些集合类是线程安全的？</strong><br/>
</p>
<ul>
<li>vector：就比arraylist多了个同步化机制（线程安全），因为效率较低，现在已经不太建议使用。在web应用中，特别是前台页面，往往效率（页面响应速度）是优先考虑的。</li>
<li>statck：堆栈类，先进后出。</li>
<li>hashtable：就比hashmap多了个线程安全。</li>
<li>enumeration：枚举，相当于迭代器。</li>
</ul>
<p><strong>31. 迭代器 Iterator 是什么？</strong><br/>
迭代器是一种设计模式，它是一个对象，它可以遍历并选择序列中的对象，而开发人员不需要了解该序列的底层结构。迭代器通常被称为“轻量级”对象，因为创建它的代价小。<br/>
<strong>32. Iterator 怎么使用？有什么特点？</strong><br/>
(1) 使用方法iterator()要求容器返回一个Iterator。第一次调用Iterator的next()方法时，它返回序列的第一个元素。注意：iterator()方法是java.lang.Iterable接口,被Collection继承。<br/>
(2) 使用next()获得序列中的下一个元素。<br/>
(3) 使用hasNext()检查序列中是否还有元素。<br/>
(4) 使用remove()将迭代器新返回的元素删除。<br/>
Iterator是Java迭代器最简单的实现，为List设计的ListIterator具有更多的功能，它可以从两个方向遍历List，也可以从List中插入和删除元素。<br/>
<strong>33. Iterator 和 ListIterator 有什么区别？</strong><br/>
</p>
<ul>
<li>Iterator可用来遍历Set和List集合，但是ListIterator只能用来遍历List。</li>
<li>Iterator对集合只能是前向遍历，ListIterator既可以前向也可以后向。</li>
<li>ListIterator实现了Iterator接口，并包含其他的功能，比如：增加元素，替换元素，获取前一个和后一个元素的索引，等等。</li>
</ul>
<p>三、<strong>多线程</strong><br/>
<strong>35. 并行和并发有什么区别？</strong><br/>
</p>
<ul>
<li>并行是指两个或者多个事件在同一时刻发生；而并发是指两个或多个事件在同一时间间隔发生。</li>
<li>并行是在不同实体上的多个事件，并发是在同一实体上的多个事件。</li>
<li>在一台处理器上“同时”处理多个任务，在多台处理器上同时处理多个任务。如hadoop分布式集群。</li>
</ul>
<p>所以并发编程的目标是充分的利用处理器的每一个核，以达到最高的处理性能。<br/>
<strong>36. 线程和进程的区别？</strong><br/>
简而言之，进程是程序运行和资源分配的基本单位，一个程序至少有一个进程，一个进程至少有一个线程。线程是进程的一个实体，是cpu调度和分派的基本单位，是比程序更小的能独立运行的基本单位。同一进程中的多个线程之间可以并发执行。<br/>
<strong>37. 守护线程是什么？</strong><br/>
守护线程（即daemon thread），是个服务线程，准确地来说就是服务其他的线程。<br/>
<strong>38. 创建线程有哪几种方式？</strong><br/>
①. 继承Thread类创建线程类<br/>
②. 通过Runnable接口创建线程类<br/>
③. 通过Callable和Future创建线程<br/>
<strong>39. 说一下 runnable 和 callable 有什么区别？</strong><br/>
</p>
<ul>
<li>Runnable接口中的run()方法的返回值是void，它做的事情只是纯粹地去执行run()方法中的代码而已；</li>
<li>Callable接口中的call()方法是有返回值的，是一个泛型，和Future、FutureTask配合可以用来获取异步执行的结果。</li>
</ul>
<p><strong>40. 线程有哪些状态？</strong><br/>
线程通常都有五种状态，创建、就绪、运行、阻塞和死亡。<br/>
<strong>41. sleep() 和 wait() 有什么区别？</strong><br/>
sleep()：方法是线程类（Thread）的静态方法，让调用线程进入睡眠状态，让出执行机会给其他线程，等到休眠时间结束后，线程进入就绪状态和其他线程一起竞争cpu的执行时间。因为sleep() 是static静态的方法，他不能改变对象的机锁，当一个synchronized块中调用了sleep() 方法，线程虽然进入休眠，但是对象的机锁没有被释放，其他线程依然无法访问这个对象。<br/>
wait()：wait()是Object类的方法，当一个线程执行到wait方法时，它就进入到一个和该对象相关的等待池，同时释放对象的机锁，使得其他线程能够访问，可以通过notify，notifyAll方法来唤醒等待的线程。<br/>
<strong>42. notify()和 notifyAll()有什么区别？</strong></p>
<ul>
<li>如果线程调用了对象的 wait()方法，那么线程便会处于该对象的等待池中，等待池中的线程不会去竞争该对象的锁。</li>
<li>当有线程调用了对象的 notifyAll()方法（唤醒所有 wait 线程）或 notify()方法（只随机唤醒一个 wait 线程），被唤醒的的线程便会进入该对象的锁池中，锁池中的线程会去竞争该对象锁。也就是说，调用了notify后只要一个线程会由等待池进入锁池，而notifyAll会将该对象等待池内的所有线程移动到锁池中，等待锁竞争。</li>
<li>优先级高的线程竞争到对象锁的概率大，假若某线程没有竞争到该对象锁，它还会留在锁池中，唯有线程再次调用 wait()方法，它才会重新回到等待池中。而竞争到对象锁的线程则继续往下执行，直到执行完了 synchronized 代码块，它会释放掉该对象锁，这时锁池中的线程会继续竞争该对象锁。</li>
</ul>
<p><strong>43. 线程的 run()和 start()有什么区别？</strong><br/>
start()方法来启动一个线程，真正实现了多线程运行。这时无需等待run方法体代码执行完毕，可以直接继续执行下面的代码； 这时此线程是处于就绪状态， 并没有运行。 然后通过此Thread类调用方法run()来完成其运行状态， 这里方法run()称为线程体，它包含了要执行的这个线程的内容， Run方法运行结束， 此线程终止。然后CPU再调度其它线程。<br/>
run()方法是在本线程里的，只是线程里的一个函数,而不是多线程的。 如果直接调用run(),其实就相当于是调用了一个普通函数而已，直接待用run()方法必须等待run()方法执行完毕才能执行下面的代码，所以执行路径还是只有一条，根本就没有线程的特征，所以在多线程执行时要使用start()方法而不是run()方法。<br/>
<strong>44. 创建线程池有哪几种方式？</strong><br/>
①. newFixedThreadPool(int nThreads)<br/>
创建一个固定长度的线程池，每当提交一个任务就创建一个线程，直到达到线程池的最大数量，这时线程规模将不再变化，当线程发生未预期的错误而结束时，线程池会补充一个新的线程。<br/>
②. newCachedThreadPool()<br/>
创建一个可缓存的线程池，如果线程池的规模超过了处理需求，将自动回收空闲线程，而当需求增加时，则可以自动添加新线程，线程池的规模不存在任何限制。<br/>
③. newSingleThreadExecutor()<br/>
这是一个单线程的Executor，它创建单个工作线程来执行任务，如果这个线程异常结束，会创建一个新的来替代它；它的特点是能确保依照任务在队列中的顺序来串行执行。<br/>
④. newScheduledThreadPool(int corePoolSize)<br/>
创建了一个固定长度的线程池，而且以延迟或定时的方式来执行任务，类似于Timer。<br/>
<strong>45. 线程池都有哪些状态？</strong><br/>
线程池有5种状态：Running、ShutDown、Stop、Tidying、Terminated。<br/>
线程池各个状态切换框架图：<br/>
</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daedeb56f6214c14b62f57fcc5b7a868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=Ff7z85mg0UU1sVNmHc89hLwavaY%3D" alt="" loading="lazy"/></p>
<p><strong>46. 线程池中 submit()和 execute()方法有什么区别？</strong><br/>
</p>
<ul>
<li>接收的参数不一样</li>
<li>submit有返回值，而execute没有</li>
<li>submit方便Exception处理</li>
</ul>
<p><strong>47. 在 java 程序中怎么保证多线程的运行安全？</strong><br/>
线程安全在三个方面体现：<br/>
</p>
<ul>
<li>原子性：提供互斥访问，同一时刻只能有一个线程对数据进行操作，（atomic,synchronized）；</li>
<li>可见性：一个线程对主内存的修改可以及时地被其他线程看到，（synchronized,volatile）；</li>
<li>有序性：一个线程观察其他线程中的指令执行顺序，由于指令重排序，该观察结果一般杂乱无序，（happens-before原则）。</li>
</ul>
<p><strong>48. 多线程锁的升级原理是什么？</strong><br/>
在Java中，锁共有4种状态，级别从低到高依次为：无状态锁，偏向锁，轻量级锁和重量级锁状态，这几个状态会随着竞争情况逐渐升级。锁可以升级但不能降级。<br/>
锁升级的图示过程：<br/>
</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7328db561b4fcc98ee1da1a04354e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764483585&amp;x-signature=Ixc2JrO5A0yqUl78A9tDzPIpA6E%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>