<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！]]></title>    <link>https://juejin.cn/post/7585452404112801807</link>    <guid>https://juejin.cn/post/7585452404112801807</guid>    <pubDate>2025-12-20T04:16:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112801807" data-draft-id="7585458459165818914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T04:16:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:16:30.000Z" title="Sat Dec 20 2025 04:16:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端开发领域，构建工具的性能直接影响开发体验和生产力。Vite 作为新一代前端构建工具，凭借其原生 ESM 支持和极速的热更新能力，已经成为许多开发者的首选。然而，即使是性能优异的 Vite，在实际项目中也可能因为配置不当或使用方式欠佳而未能发挥全部潜力。本文将深入剖析 5 个经过实战检验的 Vite 优化技巧，帮助你将构建速度提升高达 50%，这些方法正在被众多高效能团队秘密使用。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 精准配置依赖预构建（OptimizeDeps）</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>Vite 的核心优势之一是其依赖预构建机制，它将 CommonJS/UMD 模块转换为 ESM 格式并缓存以提高后续加载速度。然而，默认配置可能无法完美适应所有项目。</p>
<h4 data-id="heading-5">优化方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-comment">// 明确列出高频使用的大型库</span>
      <span class="hljs-string">'lodash-es'</span>,
      <span class="hljs-string">'axios'</span>
    ],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'某些不需要预构建的库'</span>],
    <span class="hljs-attr">force</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
  }
})
</code></pre>
<h4 data-id="heading-6">技术细节</h4>
<ul>
<li><strong>include</strong>：主动声明需要预构建的依赖项可以避免自动探测的开销</li>
<li><strong>force</strong>：生产环境强制重新构建确保一致性</li>
<li><strong>esbuildOptions</strong>：可通过此参数调整 ESBuild 的配置（如 target）</li>
</ul>
<p>实测数据：在包含50+依赖项的中型项目中，此项优化可减少15%-20%的冷启动时间。</p>
<h3 data-id="heading-7">2. Smart CSS Code Splitting</h3>
<h4 data-id="heading-8">CSS处理的瓶颈</h4>
<p>传统打包器会将所有CSS合并成单个文件，导致首屏加载不必要的样式代码。</p>
<h4 data-id="heading-9">Vite高级解决方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { splitVendorChunkPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">devSourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-comment">// PostCSS配置...</span>
    },
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>
    }
  },
  
})
</code></pre>
<p>结合以下实践：</p>
<ul>
<li><code>@import</code>替换为ESM导入（支持Tree Shaking）</li>
<li>CSS Modules自动作用域处理减少冗余代码</li>
<li>build.cssCodeSplit保持启用（默认true）</li>
</ul>
<p>效果验证：某电商项目应用后CSS体积减少38%，关键路径CSS缩减62%。</p>
<h3 data-id="heading-10">3. Advanced Cache Strategy</h3>
<h4 data-id="heading-11">Vite缓存机制深度利用</h4>
<p>Vite默认缓存位置在node_modules/.vite：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/MacOS用户可将缓存移至内存文件系统</span>
<span class="hljs-built_in">export</span> VITE_CACHE_DIR=/dev/shm/vite_cache

<span class="hljs-comment"># Windows用户可用RAMDisk工具实现类似效果</span>
</code></pre>
<h4 data-id="heading-12">Programmatic Cache Control示例：</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createServer</span>({
  
})

server.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">async</span> (file) =&gt; {
  
})
</code></pre>
<p>实际案例：某金融系统通过定制化缓存策略使HMR更新时间从1200ms降至400ms。</p>
<h3 data-id="heading-13">### ###4. Fine-Tuned Build Parallelism</h3>
<h4 data-id="heading-14">ESBuild多核优化秘诀：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  
}) 
</code></pre>
<p>需要配合以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">

</code></pre>
<p>基准测试对比：</p>














<table><thead><tr><th>Worker数量</th><th>Build时间(s)</th><th>Memory占用</th></tr></thead><tbody><tr><td>Default(4)</td><td/></tr></tbody></table>
<h2 data-id="heading-15">##总结</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程]]></title>    <link>https://juejin.cn/post/7585390679398989830</link>    <guid>https://juejin.cn/post/7585390679398989830</guid>    <pubDate>2025-12-20T04:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398989830" data-draft-id="7585400495682994218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,TypeScript"/> <meta itemprop="datePublished" content="2025-12-20T04:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:42:58.000Z" title="Sat Dec 20 2025 04:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、前言</h2>
<p>分享一次完整的鸿蒙 HAR SDK 发布过程，以前几天发布的 <code>JWorker</code> SDK 为例。</p>
<blockquote>
<p><code>JWorker</code> 是一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制。</p>
<p>库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2Fjworker" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/jworker" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker" target="_blank" title="https://github.com/zincPower/JWorker" ref="nofollow noopener noreferrer">github.com/zincPower/J…</a></p>
</blockquote>
<p>话不多说，接下来分享每一步的操作细节。</p>
<h2 data-id="heading-1">一、添加 README.md、CHANGELOG.md、LICENSE 文件</h2>
<p><strong>在发布的模块中添加这三个文件，需要与模块的 <code>src</code> 文件夹同层级。</strong> 具体结构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c33f55082134940919c79053252c504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jnPAwj%2FnnxuABZllC2ukPg9PZaw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1、README.md 文件</h3>
<p>内容描述 SDK 怎么被安装和使用，还有个人或团队的介绍等。<strong>描述内容一定要包含 <code>ohpm install &lt;你发布的 SDK 名称&gt;</code></strong> ，否则上架审核时会被拒绝，并收到以下错误。</p>
<pre><code class="hljs language-css" lang="css">README<span class="hljs-selector-class">.md</span>中未包含安装命令：ohpm install xxx或ohpm <span class="hljs-selector-tag">i</span> xxx；
</code></pre>
<h3 data-id="heading-3">2、CHANGELOG.md 文件</h3>
<p>用于记录 SDK 每个版本的发布时间和修改内容。</p>
<h3 data-id="heading-4">3、LICENSE 开源许可证</h3>
<p>选择合适的开源许可证类型，例如：MIT、Apache-2.0 等。</p>
<blockquote>
<p>MIT：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchoosealicense.com%2Flicenses%2Fmit%2F" target="_blank" title="https://choosealicense.com/licenses/mit/" ref="nofollow noopener noreferrer">choosealicense.com/licenses/mi…</a>
Apache-2.0：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apache.org%2Flicenses%2FLICENSE-2.0.txt" target="_blank" title="https://www.apache.org/licenses/LICENSE-2.0.txt" ref="nofollow noopener noreferrer">www.apache.org/licenses/LI…</a></p>
</blockquote>
<p>具体内容可以从上面的链接中拷贝然后修改。以 MIT 为例，需要修改 <code>[year]</code> 和 <code>[fullname]</code> 两个值。</p>
<p><strong>值得注意：</strong></p>
<ul>
<li><code>[fullname]</code> 必须和 SDK 的 <code>oh-package.json5</code> 中 <code>name</code> 的值完全一致，否则上架审核时会被拒绝，并收到以下错误。</li>
</ul>

<pre><code class="hljs language-go" lang="go">LICENSE文件中许可证条款内容和oh-<span class="hljs-keyword">package</span>.json5文件中许可证名称不一致；
</code></pre>
<ul>
<li>修改 <code>oh-package.json5</code> 的 <code>license</code> 的类型，默认是 <code>Apache-2.0</code> ，<code>JWorker</code> 使用的是 <code>MIT</code> 所以需要进行修改。否则还是会报上面的错误。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 省略其他</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">4、让你的项目评分更高</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca6986e68454a49a0ef0a09b6ba5be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=CXz73NcDzjnk834sX9XHWj%2BuE70%3D" alt="" loading="lazy"/></p>
<p>如果想让 SDK 评分得满 50 分，则必须满足以下两点：</p>
<p>1、在 <code>oh-package.json5</code> 配置 <code>author</code>、<code>keywords</code>、<code>homepage</code> 和 <code>repository</code>，具体作用请看下面 json 配置。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 项目名称</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jworker"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 版本</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Index.ets"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 作者</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"江澎涌"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 开源协议类型</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>                                             
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 关键字，能够让你的仓库被搜索到</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                                             
    <span class="hljs-string">"harmonyos"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"worker"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"rpc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"communication"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"thread"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"多线程"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"emitter"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"线程通讯"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 主页</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower"</span><span class="hljs-punctuation">,</span>               
  <span class="hljs-comment">// 代码仓库</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower/JWorker"</span><span class="hljs-punctuation">,</span>     
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2、创建 example 目录，可以根据情况增加 README.md 和示例代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca69f4bc0674b20914649496d1e23ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=j54LFJY6rrGmogZt8MfhZzfTRLw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">二、生成密钥</h2>
<p>通过以下命令生成密钥</p>
<pre><code class="hljs language-css" lang="css">ssh-keygen -m PEM -t RSA -<span class="hljs-selector-tag">b</span> <span class="hljs-number">4096</span> -f /<span class="hljs-selector-attr">[存放路径]</span>/<span class="hljs-selector-attr">[密钥名称]</span>
</code></pre>
<p>例如生成一个名称为 <code>ohos_publish_key</code> 的密钥，可以使用 <code>ssh-keygen -m PEM -t RSA -b 4096 -f ohos_publish_key</code> 进行生成，<strong>期间必须设置密钥密码，否则 OHPM 包管理器会拒绝。</strong> 过程如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/303817fba07c4dc7890675fdedd1677e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nItvGZ4NcyBzG89PE0zwG5UKcy8%3D" alt="" loading="lazy"/></p>
<p>运行后会生成两个文件，私钥 <code>ohos_publish_key</code> 和 公钥 <code>ohos_publish_key.pub</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b438752956d84f479d91b287aceb985d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nhsCG4Rwbt%2B%2BghhzLvG9JWyZUXE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">三、提交公钥</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2FsshKeys" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/sshKeys" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心-认证管理”</a>，根据下图所示，在 “认证管理-新增” 的弹框中填入刚才生成的公钥 <code>ohos_publish_key.pub</code> 的内容然后保存。</p>
<blockquote>
<p>如果没有 OpenHarmony 三方库中心仓的帐号先进行注册，这里就不再赘述。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37141d9286d04623812ff989365ac284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=0OzZ95feus2k4emNgYR6RnDK7Xc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、本地配置私钥</h2>
<p>将刚生成的私钥 <code>ohos_publish_key</code> 进行配置，配置命令如下</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set key_path [ohos_publish_key 的路径]
</code></pre>
<p><strong>输入后如果遇到 <code>zsh: command not found: ohpm</code> 说明需要配置 ohpm</strong>，通过 <code>open ~/.zshrc</code> 打开配置，添加以下配置即可</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">OHPM_PATH</span>=/Users/[你的 mac 用户名]/Library/Huawei/ohpm/bin
export <span class="hljs-attr">PATH</span>=<span class="hljs-variable">${PATH}</span>:<span class="hljs-variable">${OHPM_PATH}</span>
</code></pre>
<p>配置后运行 <code>source ~/.zshrc</code> 或是重新打开 terminal 再次运行配置私钥命令即可。</p>
<h2 data-id="heading-9">五、配置发布码</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 在下图位置复制发布码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b452e0bfbfdb4cfc905fa2e8d04cd11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=GG5cw23plJ0owXdGSf8%2BASj5nVw%3D" alt="" loading="lazy"/></p>
<p>然后在 terminal 输入以下命令进行配置</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set publish_id [刚刚获取的发布码]
</code></pre>
<h2 data-id="heading-10">六、编译发布的 har 包</h2>
<p>在鸿蒙的开发 ide 中，先进行 <code>Build - Clean Project</code> 打扫项目，然后 <code>Build - Make Module '你的模块名'</code> 进行 HAR 包编译，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1fe89a7fab4913b199fe2586c81834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jV38xm7077CxMIovk0nKVTCKjgI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">七、发布 har 包</h2>
<p>进入到上图所示的 <code>default</code> 目录下，然后运行 <code>ohpm publish jworker.har</code> 进行发布，过程需要输入密钥的密码，输入后就完成了。过程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea662e905f284c15bc95de0bfb105248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=Y7f4KwO3wtbHn5aQgdNOL3mVnzI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">八、查看发布情况</h2>
<p>回到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 就可以看到对应的消息提示了，后续多留意 SDK 的审核情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f66a5a842af43cd84ab25bff6275343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=hzpOhPh9xmB9dwOW3m4ub4pG7vc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">九、官方文档</h2>
<p>发布共享包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har-publish" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har-publish" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>编译HAR模块：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har%23section7892044183814" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har#section7892044183814" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<h2 data-id="heading-14">十、作者博客</h2>
<p>掘金：<a href="https://juejin.cn/user/1820446986338504" target="_blank" title="https://juejin.cn/user/1820446986338504">juejin.cn/user/182044…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f0c6d5e0964c9795f3e8f5897f8311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=%2Fe3VOoCeHwS8JOFzL7u72ZRPmxQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（五）实战：解放写API接口的繁琐工作]]></title>    <link>https://juejin.cn/post/7585289701793677338</link>    <guid>https://juejin.cn/post/7585289701793677338</guid>    <pubDate>2025-12-19T05:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585289701793677338" data-draft-id="7585005164726386726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（五）实战：解放写API接口的繁琐工作"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-19T05:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（五）实战：解放写API接口的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T05:58:46.000Z" title="Fri Dec 19 2025 05:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>公司当前项目使用的是Apifox作为API调试/文档工具，所以以这个为例。市面上的工具应该都逐步开放了AI能力，需要关注一下，只要能提供原始数据就行，不能的话那也没办法喂给AI。</p>
<p>上一篇已经让AI写UI了，这一篇让AI写接口请求。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能遇到的问题</h2>
<p>默认网络请求用的retrofit，其它也是一通百通。</p>
<h3 data-id="heading-1">1、问题一：适配请求头</h3>
<p>项目中网络请求的拦截器已经定义了请求头，读取的原始数据如何关联？答案就是在skill中告诉AI，并让它模仿你的代码写。</p>
<h3 data-id="heading-2">2、问题二：适配请求参数中有一些公共部分</h3>
<p>项目中网络请求的拦截器已经定义了一些公共请求参数，读取的原始数据如何关联？例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"{{locale}}"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"{{terminal_id}}"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"{{platform}}"</span>
    },
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-comment">//每个接口只有这里有差异</span>
    }
}
</code></pre>
<p>只有data块中有差异。答案其实同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-3">3、问题三：返回数据脱壳</h3>
<p>例如项目中的壳是这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> msg: String,
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T
) : BaseResponse&lt;T&gt;() {...}
</code></pre>
<p>那我们需要的解析的Data Class可能只需要脱壳的部分，如何让AI知道？答案也同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-4">4、问题四：viewmodel中网络请求如何写</h3>
<p>道理同上。</p>
<h3 data-id="heading-5">5、问题五：代码放在哪个文件</h3>
<p>这个问题的解答要看情况了，我们先看下面只给代码的示例，最后再探讨一下这个问题。</p>
<h2 data-id="heading-6">二、获取接口原始数据</h2>
<p>这一步依赖MCP的开放能力，后端兄弟接口怎么定义的，字段怎么写的，Android如何封装Data Class都依赖这些原始数据。接下来看通过Apifox如何办到的。</p>
<p>Apifox的MCP现阶段还不能集成到Codex中使用，启动的时候会报错：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">⚠ MCP client <span class="hljs-keyword">for</span> `apifox_api_docs` failed to start: MCP startup failed: handshaking with MCP server failed: connection closed: initialize response
⚠ MCP startup incomplete (failed: apifox_api_docs)
</code></pre>
<p>原因是Apifox的MCP返回不符合Codex定义的规范。</p>
<p>那换其他方式，打开Apifox终端（当前V版本2.7.58 (2.7.58)），选择需要生成代码的接口：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2912582992aa4b93981239341d8f3546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGltZUZpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766742632&amp;x-signature=59jJlOCs9ni4MWdY7lke9mdIFbg%3D" alt="image.png" loading="lazy"/></p>
<p>如上操作，可以得到复制的一段信息如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">请访问以下链接获取接口“天气信息V3”的接口定义信息：https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%B0%6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-f1489</span>
</code></pre>
<p>这样我们就拿到了接口的原始数据链接。</p>
<h2 data-id="heading-7">三、如何编辑skills</h2>
<p>这一步跟项目强关联，因为每个项目写法都不一样，文件不一样，所以skill的写法因项目而异。</p>
<p>先自己手动写一份粗糙的，然后给AI帮你改一改。</p>
<p>下面贴一份自己写的粗糙的，剔除敏感信息后的skill：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。
---
## 请访问链接获取接口定义信息，给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：生成retrofit接口定义
`java/api` 文件夹内是定义的retrofit api 请求的接口，例如其中的一例：

<span class="hljs-comment">/**
 * 获取Camera Event事件
 */</span>
<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverXXX"</span>)</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">discoverXxx</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">Request</span>)</span></span>: ApiResponse&lt;Response?&gt;

请按照链接中的请求类型给出类似上面的接口定义。

### <span class="hljs-number">2</span>、代码二：给出请求的<span class="hljs-meta">@Body</span>
一般的请求数据示例是下面这样的：

{
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-string">"dev_id"</span>: <span class="hljs-string">"xxx"</span>
    },
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"en_AU"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"8AE4EC1E36904B869D03FC9BABE4C087"</span>,
        <span class="hljs-string">"alias"</span>: <span class="hljs-string">"Kevin 的 A52"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"foxx"</span>
    }
}

为了避免每次都给出重复的参数，我在retrofit添加了一个拦截器，请参考`AddPublicParamsInterceptor.kt`文件，这里是添加公共请求参数的地方。所以<span class="hljs-meta">@Body</span>中只需要给出<span class="hljs-keyword">data</span>节点的内容即可，如果<span class="hljs-keyword">data</span>节点内的内容为空，那就不需要给出任何参数，因为`AddPublicParamsInterceptor.kt`中会默认添加`{}`.

### <span class="hljs-number">3</span>、代码三：给出返回的response
返回的数据使用`ApiResponse.kt`剥壳，所以给出的response数据应该是剥壳后的数据，一般是一个<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>类。请参考`java/<span class="hljs-keyword">data</span>`文件夹内其他response的写法给出。

### <span class="hljs-number">4</span>、代码四：viewmodel中实际请求的代码
viewmodel中实际请求的代码请参考下面的代码给出：

    <span class="hljs-comment">/**
     * 获取设备同步授权码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">syncAppDevice</span><span class="hljs-params">(
        buffer: <span class="hljs-type">MeshBanBindBuffer</span>,
        success: (<span class="hljs-type">Any</span>?) -&gt; <span class="hljs-type">Unit</span>,
        fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
        error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> request = SyncAppDeviceRequest(...)
        requestWithHttpException({ apiService.syncAppDevice(request) }, success = {
            success(it)
        }, fail = {
            fail(it)
        }, error = {
            error(it)
        })
    }
</code></pre>
<p>根据项目情况可以写的更丰富，更详细。</p>
<p>这一份是让AI改过后的，如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。访问用户提供的接口文档链接，解析请求/响应结构，并按项目约定生成：Retrofit 接口、<span class="hljs-meta">@Body(data 节点)</span>、剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>、以及优化后的 ViewModel 调用代码（全部用 Markdown 代码块输出）。
---

# 访问链接生成 Retrofit / Request / Response / ViewModel 代码

## 何时使用
当用户提供一个**接口定义链接**（Swagger/Apifox/Postman 文档/自研文档页面等），并要求按项目既定规范生成 Android(Kotlin) 网络层代码时使用。

## 输入
- 必须：接口文档链接（包含请求方式、path、请求体、返回体说明）
- 可选：项目约束/示例（已有 api service、已有 response/request 命名、字段命名风格、是否可空等）

## 输出（必须全部提供，且全部以 Markdown 代码块输出）
<span class="hljs-number">1.</span> **代码一：Retrofit 接口定义**（放入 `java/api` 对应 service）
<span class="hljs-number">2.</span> **代码二：请求 <span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）**（Request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> 或 Map 形态）
<span class="hljs-number">3.</span> **代码三：剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**（放入 `java/<span class="hljs-keyword">data</span>`）
<span class="hljs-number">4.</span> **代码四：ViewModel 中实际请求代码**（基于现有 `requestWithHttpException` 机制优化写法）

---

## 核心约定（严格遵守）
### A. Retrofit 接口风格
- 按接口文档的请求类型使用：`<span class="hljs-meta">@GET</span>/<span class="hljs-meta">@POST</span>/<span class="hljs-meta">@PUT</span>/<span class="hljs-meta">@DELETE</span>/...`
- 路径按文档给出，例如：`<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverEvents"</span>)</span>`
- 返回统一：`ApiResponse&lt;T?&gt;`
- KDoc 注释写清楚「做什么」
- 形参规则：
  - 若接口使用 body：使用 `<span class="hljs-meta">@Body</span> request: XxxRequest` 或 `<span class="hljs-meta">@Body</span> params: Map&lt;String, Any?&gt;`
  - 若 <span class="hljs-keyword">data</span> 节点为空：**不要要求调用方传参**
    - Retrofit 接口直接写成：`<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">xxx</span><span class="hljs-params">()</span></span>: ApiResponse&lt;Resp?&gt;`
    - 或（仅在必须显式 body 的场景）使用默认空对象：`<span class="hljs-meta">@Body</span> request: Map&lt;String, Any?&gt; = emptyMap()`

### B. 请求体只给 <span class="hljs-keyword">data</span> 节点
项目通过拦截器 `AddPublicParamsInterceptor.kt` 统一注入公共字段（例如 `app.locale/tid/alias/platform` 等），因此：
- `<span class="hljs-meta">@Body</span>` 只包含 `<span class="hljs-keyword">data</span>` 的内容
- 若 `<span class="hljs-keyword">data</span>` 为空，则调用方不传任何参数（或传 `{}` 由拦截器兜底）

### C. Response 必须“剥壳后”
网络返回会被 `ApiResponse.kt` 统一剥壳，因此你输出的 Response 类只描述真正业务数据结构：
- 输出为 `<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxResponse</span>(...)`
- 字段名遵循服务端返回字段（通常是 snake_case），按项目既有写法决定是否用 `<span class="hljs-meta">@SerializedName</span>`

### D. ViewModel 请求代码要更“干净”
在不破坏现有 `requestWithHttpException` 用法前提下，优化目标：
- 减少重复样板代码
- 参数构造更明确（优先 `buildMap {}` 或 request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>）
- success/fail/error 的传递更简洁
- 方法命名、注释清晰一致

---

## 严格流程（每次都按此执行）
<span class="hljs-number">1.</span> **打开链接并提取接口定义**
   - 请求方式、path、query/path/header/body 结构
   - `<span class="hljs-keyword">data</span>` 节点字段清单、类型、必填/可选、枚举/限制
   - 返回体结构（剥掉外层 wrapper，仅保留业务 <span class="hljs-keyword">data</span>）
<span class="hljs-number">2.</span> **生成代码一：Retrofit 接口定义**
   - 按项目示例风格输出（参考 `java/api` 里的写法）
<span class="hljs-number">3.</span> **生成代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）**
   - 若字段少且动态：用 `buildMap { put(...) }`
   - 若字段多/有嵌套：建 `XxxRequest` <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（只含 <span class="hljs-keyword">data</span> 字段本体，不含 app）
<span class="hljs-number">4.</span> **生成代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**
   - 仅业务字段，按返回体结构拆分嵌套类
   - 可空性：以文档标注为准；没标注时宁可保守为可空
<span class="hljs-number">5.</span> **生成代码四：ViewModel 调用（优化版）**
   - 统一用一个小型私有封装减少重复（示例见下方“推荐写法模板”）
<span class="hljs-number">6.</span> **最终输出格式固定**
   - 依次输出：代码一/二/三/四
   - 如需说明：放在代码块外的简短要点（不发散）

---

## 推荐写法模板（用于生成 ViewModel 优化版）
&gt; 你需要在生成 ViewModel 代码时尽量贴近此风格（不改变现有基础设施前提下）。

- 用一个私有方法把重复的 `requestWithHttpException(...)` 统一收敛：
  - `<span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">call</span><span class="hljs-params">(...)</span></span>`
- 请求参数：
  - Map：`<span class="hljs-keyword">val</span> params = buildMap { put(<span class="hljs-string">"dev_id"</span>, devId) }`
  - Request：`<span class="hljs-keyword">val</span> request = XxxRequest(...)`
- success/fail/error：
  - 直接透传 lambda，不要重复 `success(it)` 这种包一层的写法

---

## 你输出时的固定结构（必须遵守）
### 代码一：Retrofit 接口定义
<span class="hljs-comment">// 放在对应 ApiService 中</span>

### 代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）
<span class="hljs-comment">// XxxRequest data class 或 buildMap 示例（二选一或都给，看接口复杂度）</span>

### 代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（剥壳后）
<span class="hljs-comment">// 放在 java/data 下，参考项目现有 response 写法</span>

### 代码四：ViewModel 请求代码（优化版）
<span class="hljs-comment">// 给出可直接粘贴的 ViewModel 方法（包含必要的私有封装）</span>

---

## 质量检查清单（输出前自检）
	•	Retrofit 注解的 HTTP 方法与 path 与文档一致
	•	<span class="hljs-meta">@Body</span> 只包含 <span class="hljs-keyword">data</span> 节点，且 <span class="hljs-keyword">data</span> 为空时不强迫传参
	•	Response 已剥壳：不再包含 ApiResponse 外层结构
	•	ViewModel 代码已减少重复样板，参数构造清晰，回调透传简洁
	•	所有代码均在 Markdown 代码块中输出

如果你接下来把“接口文档链接”贴出来，我就会按这个 skill 的流程输出 **四段代码**（并直接给出优化后的 ViewModel 写法）。


</code></pre>
<p>Apifox复制链接的内容因为匹配skill的<code>description</code>，所以给出链接就可以触发上面的skill。Codex生成的代码如下(剔除了敏感信息)：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">• 使用 api_to_request 技能，因为需要从接口文档生成 Retrofit 请求、请求体、响应体与 ViewModel 调用代码。(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/</span>
  %E5%A4%A9%E6%F%A1%E6%<span class="hljs-number">81</span>%AFv3-<span class="hljs-number">253061517</span>?t=e0be3ab5-e8bf-4ec2-be81-f148d9))

  代码一：Retrofit 接口定义(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f14569))

  <span class="hljs-comment">/**
   * 天气信息V3
   */</span>
  <span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/weather/getCurrentInfo"</span>)</span>
  <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">WeatherInfoV3Request</span>)</span></span>: ApiResponse&lt;WeatherInfoV3Response?&gt;

  代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f8569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Request</span>(
      <span class="hljs-keyword">var</span> lon: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> lat: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> unit: String = <span class="hljs-string">"IMPERIAL"</span> <span class="hljs-comment">// METRIC / IMPERIAL</span>
  )

  代码三：Response（剥壳后的 <span class="hljs-keyword">data</span>）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%F%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f18569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Response</span>(
      <span class="hljs-keyword">var</span> day: <span class="hljs-built_in">Boolean</span>?,
      <span class="hljs-keyword">var</span> weather: WeatherV3?,
      <span class="hljs-keyword">var</span> temperature: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> wind: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> pressure: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> humidity: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> aqi: String?
  )

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherV3</span>(
      <span class="hljs-keyword">var</span> condition: String?,
      <span class="hljs-keyword">var</span> icon: String?
  )

  代码四：ViewModel 中实际请求代码(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f1469))

  <span class="hljs-comment">/**
   * 获取天气信息V3
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(
      lon: <span class="hljs-type">Double</span>,
      lat: <span class="hljs-type">Double</span>,
      unit: <span class="hljs-type">String</span> = <span class="hljs-string">"IMPERIAL"</span>,
      success: (<span class="hljs-type">WeatherInfoV3Response</span>?) -&gt; <span class="hljs-type">Unit</span>,
      fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
      error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
  )</span></span> {
      <span class="hljs-keyword">val</span> request = WeatherInfoV3Request(
          lon = lon,
          lat = lat,
          unit = unit
      )
      requestWithHttpException({ homeManagementApiService.getCurrentInfoV3(request) }, success = {
          success(it)
      }, fail = {
          fail(it)
      }, error = {
          error(it)
      })
  }

</code></pre>
<p>生成的代码可用度极高，很大程度上解放了生产力。</p>
<h2 data-id="heading-8">四、AI的放权</h2>
<p>AI生成的代码可用度这么高，那是不是应该放权直接让AI写文件呢？</p>
<p>1、如果是一个新项目，定义好项目架构后就大胆的让AI生成文件自己写代码吧，能”摸鱼"就别动手，人生苦短我用AI。</p>
<p>2、如果是一个成熟度高的项目，建议以小颗粒度的形式让AI生成或修改文件代码，这样影响的范围可控，git提交的时候请仔细审查AI生成的代码。</p>
<p>3、如果是一个成熟度高的项目，修改的需求复杂，牵扯面广，或者公司规定不让AI写代码只让辅助参考，那还是开只读模式自己写吧。</p>
<p>回到最上面的问题五：代码放哪个文件？</p>
<p>答案就简单了。</p>
<ul>
<li>项目架构清晰，让AI干活，可以完全让AI自主决策，后续自己调整。</li>
<li>可以在skill中添加提示加以引导，让AI放哪个文件/目录。</li>
<li>只读模式，自己处理AI生成的代码，前期可以开只读熟悉AI的使用，等熟练后就可以让AI自己写文件了。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 技术栈全解析：从模型编排到 RAG 实战]]></title>    <link>https://juejin.cn/post/7585138968167088164</link>    <guid>https://juejin.cn/post/7585138968167088164</guid>    <pubDate>2025-12-19T07:16:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585138968167088164" data-draft-id="7585214391827890219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 技术栈全解析：从模型编排到 RAG 实战"/> <meta itemprop="keywords" content="前端,LangChain,Python"/> <meta itemprop="datePublished" content="2025-12-19T07:16:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程干货铺"/> <meta itemprop="url" content="https://juejin.cn/user/52383084474680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 技术栈全解析：从模型编排到 RAG 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/52383084474680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程干货铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T07:16:41.000Z" title="Fri Dec 19 2025 07:16:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d91378c1684fe1862186d879886cd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=%2BUR%2BIetRoN43mSOr0nfx8CNobII%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>随着大语言模型能力的快速演进，真正的技术挑战已经不再是“如何调用模型”，而是：</p>
<ul>
<li>如何组织 Prompt</li>
<li>如何管理上下文</li>
<li>如何接入外部数据</li>
<li>如何构建多步骤推理流程</li>
<li>如何让模型在复杂任务中稳定工作</li>
</ul>
<p>LangChain 正是为解决这些问题而诞生的框架。</p>
<p>它不是一个模型，也不是一个简单的 SDK，而是一个<strong>用于构建 LLM 应用的应用层编排框架</strong>。</p>
<h2 data-id="heading-1">1. LangChain 是什么</h2>
<p>LangChain 是一个用于构建大模型应用（LLM Applications）的开源框架，其核心目标是：</p>
<blockquote>
<p><strong>将模型、提示词、数据源、工具和控制逻辑组织成可复用、可组合、可维护的应用流程。</strong></p>
</blockquote>
<p>在架构层面，LangChain 处于：</p>
<ul>
<li>大模型 API 之上</li>
<li>具体业务逻辑之下</li>
</ul>
<p>它承担的是 <strong>“AI 应用的中间层 / 编排层”</strong> 角色。</p>
<h2 data-id="heading-2">2. LangChain 解决了哪些问题</h2>
<p>在没有 LangChain 的情况下，LLM 应用通常存在以下问题：</p>
<ol>
<li>Prompt 分散在代码中，难以维护</li>
<li>多轮对话上下文不可控</li>
<li>检索、生成、工具调用逻辑耦合严重</li>
<li>难以构建多步骤推理流程</li>
<li>应用无法演进为复杂系统</li>
</ol>
<p>LangChain 的设计目标正是系统性地解决上述问题。</p>
<h2 data-id="heading-3">3. LangChain 的核心抽象模型</h2>
<p>LangChain 的能力建立在一组高度内聚的抽象之上：</p>









































<table><thead><tr><th>抽象</th><th>作用</th></tr></thead><tbody><tr><td>LLM / ChatModel</td><td>大模型统一接口</td></tr><tr><td>PromptTemplate</td><td>结构化提示词</td></tr><tr><td>Chain</td><td>可组合的执行流程</td></tr><tr><td>Memory</td><td>上下文与状态管理</td></tr><tr><td>Retriever</td><td>检索接口</td></tr><tr><td>VectorStore</td><td>向量存储</td></tr><tr><td>Tool</td><td>外部能力封装</td></tr><tr><td>Agent</td><td>推理 + 决策控制器</td></tr></tbody></table>
<p>这些抽象共同构成了 LangChain 的技术骨架。</p>
<h2 data-id="heading-4">4. 安装与基础调用</h2>
<h3 data-id="heading-5">JavaScript</h3>
<pre><code class="hljs language-bash" lang="bash">npm install langchain @langchain/openai
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span>
});

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<h3 data-id="heading-6">Python</h3>
<pre><code class="hljs language-bash" lang="bash">pip install langchain langchain-openai
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)
resp = model.invoke(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>)
<span class="hljs-built_in">print</span>(resp.content)
</code></pre>
<h2 data-id="heading-7">5. PromptTemplate：结构化提示词</h2>
<p>PromptTemplate 用于将 Prompt 从字符串提升为可配置对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/prompts"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptTemplate</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"请解释 {concept} 的核心作用"</span>,
  <span class="hljs-attr">inputVariables</span>: [<span class="hljs-string">"concept"</span>]
});

<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> prompt.<span class="hljs-title function_">format</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"LangChain"</span> });
</code></pre>
<p>优势在于：</p>
<ul>
<li>参数明确</li>
<li>可复用</li>
<li>易组合</li>
</ul>
<h2 data-id="heading-8">6. Chain：构建可组合的执行流程</h2>
<p>Chain 是 LangChain 的核心执行单元。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LLMChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LLMChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span> }),
  prompt
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"Chain 机制"</span> });
</code></pre>
<p>Chain 使得 <strong>Prompt → 模型 → 输出</strong> 成为一个标准化流程单元。</p>
<h2 data-id="heading-9">7. Memory：上下文与状态管理</h2>
<p>Memory 用于控制模型可感知的历史上下文。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConversationChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BufferMemory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>(),
  <span class="hljs-attr">memory</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferMemory</span>()
});
</code></pre>
<p>Memory 的存在，使多轮对话和状态管理成为一等能力。</p>
<h2 data-id="heading-10">8. 向量化与检索：RAG 的技术基础</h2>
<p>RAG（Retrieval-Augmented Generation）并不是一个模型，而是一种架构模式。</p>
<p>LangChain 将 RAG 拆解为三个核心组件：</p>
<ol>
<li><strong>Text Splitter</strong>：文本分割</li>
<li><strong>Embedding</strong>：向量化</li>
<li><strong>VectorStore / Retriever</strong>：检索接口</li>
</ol>
<h2 data-id="heading-11">9. LangChain RAG 实战案例</h2>
<p>下面是一个结构完整、可运行的 LangChain RAG 示例（简化版）。</p>
<h3 data-id="heading-12">9.1 文档准备与切分</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecursiveCharacterTextSplitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/text_splitter"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">`
LangChain 是一个用于构建大语言模型应用的框架，
核心目标是将模型、数据、工具组织成可维护的流程。
`</span>;

<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecursiveCharacterTextSplitter</span>({
  <span class="hljs-attr">chunkSize</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">chunkOverlap</span>: <span class="hljs-number">20</span>
});

<span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">splitText</span>(text);
</code></pre>
<h3 data-id="heading-13">9.2 向量化并存入向量库</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OpenAIEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MemoryVectorStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/vectorstores/memory"</span>;

<span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title class_">MemoryVectorStore</span>.<span class="hljs-title function_">fromTexts</span>(
  docs,
  docs.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> ({})),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAIEmbeddings</span>()
);
</code></pre>
<h3 data-id="heading-14">9.3 基于检索的问答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">similaritySearch</span>(
  <span class="hljs-string">"LangChain 的核心作用是什么？"</span>,
  <span class="hljs-number">2</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>));
</code></pre>
<h3 data-id="heading-15">9.4 结合模型生成最终回答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> context = results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>);

<span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>().<span class="hljs-title function_">invoke</span>(
  <span class="hljs-string">`基于以下资料回答问题：\n<span class="hljs-subst">${context}</span>\n\n问题：LangChain 的作用是什么？`</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(answer.<span class="hljs-property">content</span>);
</code></pre>
<h2 data-id="heading-16">10. Agent 与工具调用（进阶能力）</h2>
<p>LangChain 的 Agent 允许模型在运行时：</p>
<ul>
<li>判断是否需要工具</li>
<li>选择合适的工具</li>
<li>执行并整合结果</li>
</ul>
<p>这是构建复杂 AI 系统的重要基础。</p>
<h2 data-id="heading-17">11. LangChain 的典型应用方向</h2>
<ul>
<li>企业知识库问答（RAG）</li>
<li>智能客服系统</li>
<li>AI 助手与自动化 Agent</li>
<li>多步骤任务执行系统</li>
<li>AI 中台与能力编排层</li>
</ul>
<h2 data-id="heading-18">结语</h2>
<p>LangChain 的价值不在于“帮你写 Prompt”，
而在于 <strong>让大模型应用具备工程结构和系统能力</strong>。</p>
<p>当 LLM 应用从 Demo 走向生产环境，
LangChain 几乎是绕不开的技术栈之一。</p>
<p>如果你正在构建真实的 AI 应用系统，
理解并掌握 LangChain，是非常值得投入的一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/821171844b6a4abd9daca23c087ca843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=t%2BlH9D0aw1%2FGLxs%2F7KMsGinvAV8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7fe2ec0c944a17a9c76e01962d29b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=dGohuWQhcg7B7gfcZo5N0A6%2FWoA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%]]></title>    <link>https://juejin.cn/post/7585097023747915791</link>    <guid>https://juejin.cn/post/7585097023747915791</guid>    <pubDate>2025-12-19T04:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585097023747915791" data-draft-id="7585130590291656719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-19T04:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T04:16:53.000Z" title="Fri Dec 19 2025 04:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。随着V8引擎的不断进化，许多开发者可能并未充分挖掘其潜力。V8作为Chrome和Node.js的核心引擎，通过即时编译（JIT）、隐藏类（Hidden Classes）、内联缓存（Inline Caching）等技术大幅提升了JavaScript的执行效率。然而，许多优化技巧仍被低估或忽视。本文将深入探讨5个鲜为人知的V8引擎技巧，帮助你将代码性能提升高达50%。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>利用隐藏类（Hidden Classes）避免动态属性分配</strong></h3>
<p>V8通过隐藏类来优化对象属性访问。当对象的结构（即属性的顺序和类型）频繁变化时，V8会创建多个隐藏类，导致性能下降。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：动态添加属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = {};
  user.<span class="hljs-property">name</span> = <span class="hljs-string">"John"</span>;
  user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// V8会为每次属性添加创建新的隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 正例：一次性初始化所有属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserOptimized</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }; <span class="hljs-comment">// V8只需创建一个隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>尽量在对象构造时一次性定义所有属性。</li>
<li>避免在运行时动态删除或重新排序属性。</li>
</ul>
<h3 data-id="heading-4">2. <strong>避免数字类型的频繁切换（Smi vs. Heap Number）</strong></h3>
<p>V8对数字有两种内部表示形式：</p>
<ul>
<li><strong>Smi</strong>（Small Integer）：31位有符号整数，直接存储在对象中，访问速度快。</li>
<li><strong>Heap Number</strong>：双精度浮点数，存储在堆中，访问较慢。</li>
</ul>
<p>频繁切换这两种类型会导致性能损失：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// Smi</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  count += i; <span class="hljs-comment">// 保持Smi类型</span>
}

<span class="hljs-keyword">let</span> floatCount = <span class="hljs-number">0.1</span>; <span class="hljs-comment">// Heap Number</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  floatCount += i; <span class="hljs-comment">// V8需要反复切换类型</span>
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>在密集计算中尽量使用整数（Smi）。</li>
<li>避免混合整数和浮点运算。</li>
</ul>
<h3 data-id="heading-5">3. <strong>利用内联缓存（Inline Caching）优化函数调用</strong></h3>
<p>V8通过内联缓存记录函数调用点的类型信息，加速后续调用。如果函数参数类型不稳定，会导致缓存失效（Megamorphic状态）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：多态参数导致内联缓存失效</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);       <span class="hljs-comment">// IC记录Number类型</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>);   <span class="hljs-comment">// IC失效，重新学习String类型</span>

<span class="hljs-comment">// 正例：保持参数类型一致</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">addNumbers</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// IC始终有效</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>确保高频调用的函数参数类型稳定。</li>
<li>避免在热代码路径中使用<code>arguments</code>或动态参数。</li>
</ul>
<p>###4. <strong>谨慎使用<code>try-catch</code>和<code>with</code>语句</strong></p>
<p>V8会对包含<code>try-catch</code>或<code>with</code>的函数禁用某些优化（如函数内联）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// try-catch影响性能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">riskyOperation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ...可能抛出异常的操作...</span>
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}

<span class="hljs-comment">// Node.js中更高效的错误处理方式：</span>
<span class="hljs-keyword">if</span> (errorProneCondition) {
    process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"..."</span>); });
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>将<code>try-catch</code>移至外层或非关键路径。</li>
<li>完全避免使用<code>with</code>语句（已废弃）。</li>
</ul>
<p>###5. <strong>预编译正则表达式并利用持久化匹配状态</strong></p>
<p>正则表达式在V8中会被编译为原生代码，但重复编译会拖慢性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  反例：每次循环重新编译正则 </span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    <span class="hljs-regexp">/test(\d+)/</span>.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  正例：预编译正则 </span>
<span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/test(\d+)/</span>; 
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    regex.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  进阶技巧：复用RegExp实例的lastIndex </span>
<span class="hljs-keyword">const</span> globalRegex = <span class="hljs-regexp">/test(\d+)/g</span>; 
globalRegex.<span class="hljs-property">lastIndex</span> =  <span class="hljs-number">0</span> ; <span class="hljs-comment">//  显式重置位置 </span>
<span class="hljs-keyword">while</span> ((match = globalRegex.<span class="hljs-title function_">exec</span>(input)) !== <span class="hljs-literal">null</span>) { ... }
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>通过深入理解V8的工作原理并调整编码习惯 ——从对象构造、数字处理到函数设计——开发者可以显著提升JavaScript的执行效率</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（六）实战：解放页面开发前的繁琐工作]]></title>    <link>https://juejin.cn/post/7585121055037358130</link>    <guid>https://juejin.cn/post/7585121055037358130</guid>    <pubDate>2025-12-19T06:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585121055037358130" data-draft-id="7585121055036964914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（六）实战：解放页面开发前的繁琐工作"/> <meta itemprop="keywords" content="架构,Android"/> <meta itemprop="datePublished" content="2025-12-19T06:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（六）实战：解放页面开发前的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T06:59:54.000Z" title="Fri Dec 19 2025 06:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一般开发一个新页面的工作是这样的:</p>
<ul>
<li>新建Activity/Fragment，里面会各种继承和默认实现的函数。</li>
<li>新建ViewModel，也是继承和基础实现。</li>
<li>如果有RecyclerView还要创建Adapter。</li>
</ul>
<p>大部分开发者估计都是拷贝之前的文件然后改改就用了，但是拷贝这些文件是不是很繁琐？以后这些活交给AI来干。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能碰到的问题</h2>
<h3 data-id="heading-1">1、文件名的定义</h3>
<p>如果要生成Activity，Fragment，ViewModel，Adapter，ViewBinding等，文件名要怎么取？
答案是按项目的命名规范告诉AI即可，例如要创建AboutActivity，告诉AI对应的Fragment应该是AboutFragment，ViewModel应该是AboutViewModel，Adapter应该是AboutAdapter，ViewBding应该是ActivityAboutBinding，如果是XML布局文件来写UI，布局文件应该是activity_about。在skill中描述清楚。</p>
<h3 data-id="heading-2">2、文件放哪儿</h3>
<p>上一篇有讨论这个问题，可以见上篇。</p>
<h2 data-id="heading-3">二、编辑skill</h2>
<p>还是让AI只给出代码。</p>
<p>需要在skill中描述生成哪些文件以及每个文件应该如何参考项目的模版代码生成。下面是一份手动写的简单示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: new_page_dev
description: 新页面开发生成Activity。
---
## 创建Activity等并给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：创建对应的Activity
可以参考`MyOrdersActivity`这个Activity。

布局文件的Binding按规则:例如AActivity, 那么viewbinding就是ActivityABinding，我会在后续补充这个布局文件。

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityMyOrdersListBinding</span>&gt;() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>

}
请参照上面的模版代码给出。

给出AndroidManifest清单文件注册的代码。

### <span class="hljs-number">2</span>、代码二：给出ViewModel的代码
ViewModel的命名规则如果是AActivity,那么ViewModel就是AViewModel。

AViewModel的创建可参考的代码为：
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertDetailsViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

    }
}

### <span class="hljs-number">3</span>、代码三：给出Adapter的代码

Adapter的命名规则同上。

可参考的Adapter的代码：

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersListAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">PlanDetails, QuickViewHolder</span>&gt;() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">PlanDetails</span>?)</span></span> {
        <span class="hljs-keyword">val</span> binding = ItemMyOrdersInfoBinding.bind(holder.itemView)
        item?.apply {
        	<span class="hljs-comment">//TODO</span>
            }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
        <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_my_orders_info, parent)
    }
}

</code></pre>
<p>根据项目的实际情况编辑上面的skill。<strong>给AI让它帮你修改成标准格式的skill</strong>，因为跟项目代码关联，这里没办法贴出我的。</p>
<p>在Codex Cli中输入：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">新页面开发生成AboutActivity
</code></pre>
<p>下面是AI生成的结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> Using skill new_page_dev to generate the Activity/ViewModel/Adapter skeletons.

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityAboutBinding</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> viewModel <span class="hljs-keyword">by</span> viewModels&lt;AboutViewModel&gt;()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mAdapter = AboutAdapter()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mDataList = mutableListOf&lt;Any&gt;()

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewBinding</span><span class="hljs-params">(inflater: <span class="hljs-type">LayoutInflater</span>)</span></span>: ActivityAboutBinding {
          <span class="hljs-keyword">return</span> ActivityAboutBinding.inflate(inflater)
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
          multiStateContainer = MultiStatePage.bindMultiState(binding.rlContainer)
          initAdapter()
          requestData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initAdapter</span><span class="hljs-params">()</span></span> {
          binding.rcy.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
          binding.rcy.adapter = mAdapter
          binding.refreshLayout.setEnableFooterFollowWhenNoMoreData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"NotifyDataSetChanged"</span>)</span>
      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestData</span><span class="hljs-params">(isShowLoading: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>)</span></span> {
          <span class="hljs-keyword">if</span> (isShowLoading) {
              multiStateContainer.showLoading()
          }
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> request data and update mDataList / adapter</span>
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showErrorCustom {
              requestData(<span class="hljs-literal">true</span>)
          }
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showEmpty</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showEmptyCustom()
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createObserver</span><span class="hljs-params">()</span></span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

      <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">Any, QuickViewHolder</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">Any</span>?)</span></span> {
          <span class="hljs-keyword">val</span> binding = ItemAboutBinding.bind(holder.itemView)
          item?.apply {
              <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> bind item</span>
          }
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
          <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_about, parent)
      }
  }

  Confirm the target <span class="hljs-keyword">package</span> and whether <span class="hljs-keyword">this</span> page <span class="hljs-keyword">is</span> list-based (RecyclerView). If not, I can simplify the Activity and remove the adapter scaffold.
</code></pre>
<p>代码完全可用，开启写的权限，复制粘贴都省了。</p>
<h2 data-id="heading-4">三、总结</h2>
<p>实战的三篇分别解决了：</p>
<ul>
<li>根据需求创建模板文件；</li>
<li>通过Figma MCP加skill生成UI；</li>
<li>通过Apifox加skill生成接口数据；</li>
</ul>
<p>作为开发者：</p>
<ul>
<li>基本不用写UI了；</li>
<li>不用写接口接入那一套流程了；</li>
<li>不用操作创建一堆文件那一套流程了；</li>
</ul>
<p>重心只需要放在需求和数据对接的代码即可，极大的解放了生成力。</p>
<p>如果终端开多个窗口跑，同时完成上面的工作，效率会进一步提高。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[查看项目中无引用到的文件、函数]]></title>    <link>https://juejin.cn/post/7585180150254665743</link>    <guid>https://juejin.cn/post/7585180150254665743</guid>    <pubDate>2025-12-19T08:09:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585180150254665743" data-draft-id="7585130590292803599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="查看项目中无引用到的文件、函数"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-19T08:09:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小黑屋"/> <meta itemprop="url" content="https://juejin.cn/user/4476867078793198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            查看项目中无引用到的文件、函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4476867078793198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小黑屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:09:19.000Z" title="Fri Dec 19 2025 08:09:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">unimported 查看没有引用的文件</h2>
<ol>
<li>全局安装 unimported</li>
</ol>

<pre><code class="hljs">npm install -g unimported
</code></pre>
<p>2.  在 package.json 的 scripts 增加</p>

<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   
  <span class="hljs-attr">"analyze:deadcode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"unimported &amp;&amp; webpack --profile --json &gt; stats.json"</span> 
<span class="hljs-punctuation">}</span> 
</code></pre>
<p>3.  增加文件 .unimportedrc.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entry"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/app.{js,ts,jsx,tsx}"</span><span class="hljs-punctuation">,</span>       
      <span class="hljs-string">"src/app.config.{js,ts}"</span><span class="hljs-punctuation">,</span>        
      <span class="hljs-string">"src/pages/**/*.{js,ts,jsx,tsx}"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignore"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"**/node_modules/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/dist/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.test.{js,ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.spec.{js,ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/__mocks__/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"project.config.json"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"config/**/*.js"</span>                 
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUnused"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/types/**/*.d.ts"</span><span class="hljs-punctuation">,</span>           
      <span class="hljs-string">"src/assets/**/*"</span><span class="hljs-punctuation">,</span>               
      <span class="hljs-string">"src/styles/**/*.{css,scss,less}"</span> 
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>

</code></pre>
<ol start="4">
<li>然后运行</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">npm run analyze:deadcode
</code></pre>
<p>运行后输出以下内容，列出未引用的文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4de9e4fd21245489615a219e78d9c4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736559&amp;x-signature=0icGhst%2FzCElAcUTPmz9SSRfTTw%3D" alt="image.png" loading="lazy"/></p>
<p>注意
有些小程序页面 A 也会有 /component 的组件，只给页面A用，
但是 <code>"src/pages/**/*.{js,ts,jsx,tsx}"</code> 会涵盖掉，不会把A的无用组件列出来，
这种情况下，小程序最好每个页面的路径都列出来，例如以下，这样可以更加精确的定位到每个页面ABCD里面的component是否真正有被使用</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entry"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/app.{js,ts,jsx,tsx}"</span><span class="hljs-punctuation">,</span>       
      <span class="hljs-string">"src/app.config.{js,ts}"</span><span class="hljs-punctuation">,</span>        
      <span class="hljs-string">"src/pages/index/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/home/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/category/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/cart/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/mine/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/product/detail/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/product/content-hub/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignore"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUnused"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">使用Webpack插件 webpack-deadcode-plugin 查看未使用的函数和变量</h2>
<ol>
<li>安装 webpack-deadcode-plugin</li>
</ol>

<pre><code class="hljs language-css" lang="css">npm install webpack-deadcode-plugin <span class="hljs-attr">--save-dev</span>
</code></pre>
<p>2.  在webpack配置中添加：</p>

<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DeadCodePlugin</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'webpack-deadcode-plugin'</span>);

<span class="hljs-comment">// 增强配置可检测具体方法</span>
chain.<span class="hljs-title function_ invoke__">plugin</span>(<span class="hljs-string">'deadcode'</span>)
  .<span class="hljs-keyword">use</span>(DeadCodePlugin, [{
    detectUnusedExport: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 检测未使用的导出</span>
    detectUnusedClass: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 检测未使用的类</span>
    detectUnusedFunction: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 检测未使用的函数</span>
    detectUnusedVariable: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 检测未使用的变量</span>
    log: <span class="hljs-string">'all'</span>                   <span class="hljs-comment">// 显示所有未使用项</span>
  }]);
</code></pre>
<p>3.  运行构建后会生成未使用文件的报告<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e73c1142c64b3fb32bf7acd8729bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736559&amp;x-signature=KLeh63ILFErgr%2FUThvlPaKgK7M8%3D" alt="image.png" loading="lazy"/></p>
<p>通过这些方式可以 了解到 哪些文件、函数、变量没有使用到</p>
<p>如果要删除</p>
<ol>
<li>一定要确认、确认、确认、多次确认 清楚再删</li>
<li>小规模的删，不要一次性删太多东西</li>
<li>删除之后，对于相关的流程做好自测，也要跟 QA 和 产品说明清楚，可能要做大版本的回测</li>
<li>对于已经上线的项目，不建议再做这样的操作，如果需要做也必须【提前】跟 PM、QA 商量一下是否有足够的时间安排来做代码优化和流程测试，避免出现生产事故</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Gradle - ASM + AsmClassVisitorFactory插桩使用]]></title>    <link>https://juejin.cn/post/7585222924566102056</link>    <guid>https://juejin.cn/post/7585222924566102056</guid>    <pubDate>2025-12-19T08:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585222924566102056" data-draft-id="7582155513586417716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Gradle - ASM + AsmClassVisitorFactory插桩使用"/> <meta itemprop="keywords" content="前端,Android,gradle"/> <meta itemprop="datePublished" content="2025-12-19T08:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明川"/> <meta itemprop="url" content="https://juejin.cn/user/114004941350269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Gradle - ASM + AsmClassVisitorFactory插桩使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941350269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:14:15.000Z" title="Fri Dec 19 2025 08:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>  前边陆续总结学习了 Task 和 Plugin，今天就开始总结插桩的使用，正好能把前边学的知识串起来，温故而知新。</p>
<p>  我们都知道Apk 是从资源编译 -&gt; 源代码 （java/kotlin）-&gt; 编译器（javac/kotlinc） -&gt; JVM字节码 （.class） -&gt; D8/R8 编译器 -&gt; DEX字节码（.dex） -&gt; 最后到我们的APK，字节码操作主要在 JVM这一步，发生在编译后，打包前的class文件环节，比较适合处理一些有规则的代码插入，在编写代码层面无侵入 不容易遗漏。</p>
<h2 data-id="heading-1">插桩</h2>
<p>  <strong>字节码插桩</strong>（Bytecode Instrumentation）是在<strong>编译后、打包前</strong>修改 <code>.class</code> 文件的技术。</p>
<p>先看一个例子：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Hi"</span>);
    }
}
</code></pre>
<p>用 <code>javac</code> 编译后，生成的 <code>Hello.class</code> 是这样的：</p>
<pre><code class="hljs language-r" lang="r">CA FE BA BE <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>D <span class="hljs-number">0</span>A
<span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span><span class="hljs-built_in">F</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span>
<span class="hljs-number">12</span> <span class="hljs-number">0</span>A <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span>
<span class="hljs-number">16</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">3</span>C <span class="hljs-number">69</span> <span class="hljs-number">6</span>E <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">3</span>E ...
（全是二进制数据）种 JVM 指令的二进制编码、计算字节偏移、维护常量池索引……
</code></pre>
<p>  <strong>这就是我们需要 ASM 的原因</strong>：ASM 是一个 Java 库，帮你<strong>读取、修改、生成</strong> <code>.class</code> 文件，让你不用关心底层的二进制细节，借助工具来修改 Class 文件，更加简单方便。</p>

























<table><thead><tr><th>方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>手写代码</strong></td><td>直观、可控</td><td>侵入性强、容易遗漏、难以统一</td></tr><tr><td><strong>AOP 注解</strong></td><td>使用简单</td><td>运行时开销、无法处理三方库</td></tr><tr><td><strong>字节码插桩</strong></td><td>无侵入、可处理所有代码</td><td>学习成本高</td></tr></tbody></table>
<h3 data-id="heading-2">ASM重要方法</h3>
<p>  这里插入一下 ASM几个重要的方法和作用，因为下边会有一些实例代码，关于 Transfrom 中如何修改的案例会使用到。</p>

























<table><thead><tr><th>类名</th><th>作用</th></tr></thead><tbody><tr><td><strong>ClassReader</strong></td><td>读取 .class 文件，包括类中的信息方法名和字段</td></tr><tr><td><strong>ClassVisitor</strong></td><td>ClassReader读取，可以在 visit、visitField和visitMethod方法中查看</td></tr><tr><td><strong>MethodVisitor</strong></td><td>访问方法内部</td></tr><tr><td><strong>ClassWriter</strong></td><td>生成新的 .class</td></tr></tbody></table>
<h3 data-id="heading-3">ASM 和 Transform</h3>
<p>  <strong>Transform</strong> 在AGP 4.+版本，我们默认都用的Transform 来实现Class 拦截和输出工作。但是在高版本AGP中， 根据 官方的说法 Transform API 会被移除：<strong>为了提高构建性能，使用 Transform API 很难与其它 Gradle 特性结合使用</strong> ，不过就我自己的使用体验，确实Transform <strong>使用起来代码更多，需要手动处理：遍历文件、读取字节、处理 Jar、写入输出等 ，多个Transform串联执行，执行效率不高</strong> 。</p>
<p>由于项目中之前是使用的 Bytex，这里我写一个 简单的transform 实例代码，仅用于参考</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransform</span> : <span class="hljs-type">Transform</span>() {

    <span class="hljs-comment">// Task 名称</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"MyTransform"</span>

    <span class="hljs-comment">// 处理什么类型 class 文件</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInputTypes</span><span class="hljs-params">()</span></span>: Set&lt;QualifiedContent.ContentType&gt; {
        <span class="hljs-keyword">return</span> setOf(QualifiedContent.DefaultContentType.CLASSES)
    }

    <span class="hljs-comment">// 处理代码范围</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScopes</span><span class="hljs-params">()</span></span>: MutableSet&lt;<span class="hljs-keyword">in</span> QualifiedContent.Scope&gt; {
        <span class="hljs-keyword">return</span> mutableSetOf(
            QualifiedContent.Scope.PROJECT,
            QualifiedContent.Scope.SUB_PROJECTS,
            QualifiedContent.Scope.EXTERNAL_LIBRARIES
        )
    }

    <span class="hljs-comment">// 增量编译</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isIncremental</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 处理输入，生成输出</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transform</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>)</span></span> {
        <span class="hljs-keyword">val</span> inputs = transformInvocation.inputs
        <span class="hljs-keyword">val</span> outputProvider = transformInvocation.outputProvider
        <span class="hljs-keyword">val</span> isIncremental = transformInvocation.isIncremental

        <span class="hljs-keyword">if</span> (!isIncremental) {
            outputProvider.deleteAll()
        }

        <span class="hljs-comment">// 手动遍历所有输入</span>
        inputs.forEach { input -&gt;

            <span class="hljs-comment">// 处理目录输入</span>
            input.directoryInputs.forEach { dirInput -&gt;
                <span class="hljs-keyword">val</span> outputDir = outputProvider.getContentLocation(
                    dirInput.name,
                    dirInput.contentTypes,
                    dirInput.scopes,
                    Format.DIRECTORY
                )

                <span class="hljs-comment">// 需要手动遍历每个 class 文件</span>
                dirInput.file.walkTopDown().forEach { file -&gt;
                    <span class="hljs-keyword">if</span> (file.isFile &amp;&amp; file.name.endsWith(<span class="hljs-string">".class"</span>)) {
                        <span class="hljs-comment">// 需要手动读取字节</span>
                        <span class="hljs-keyword">val</span> classBytes = file.readBytes()

                        <span class="hljs-comment">// 使用 ASM 处理</span>
                        <span class="hljs-keyword">val</span> classReader = ClassReader(classBytes)
                        <span class="hljs-keyword">val</span> classWriter = ClassWriter(ClassWriter.COMPUTE_FRAMES)
                        <span class="hljs-keyword">val</span> classVisitor = MyClassVisitor(classWriter)
                        classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES)

                        <span class="hljs-comment">// 需要手动写入输出</span>
                        <span class="hljs-keyword">val</span> outputFile = File(outputDir, file.relativeTo(dirInput.file).path)
                        outputFile.parentFile.mkdirs()
                        outputFile.writeBytes(classWriter.toByteArray())
                    }
                }
            }

            <span class="hljs-comment">// 处理 Jar 输入（依赖库）</span>
            input.jarInputs.forEach { jarInput -&gt;
                <span class="hljs-comment">// 需要手动解压、处理、重新打包 Jar</span>
                <span class="hljs-keyword">val</span> outputJar = outputProvider.getContentLocation(
                    jarInput.name,
                    jarInput.contentTypes,
                    jarInput.scopes,
                    Format.JAR
                )
                <span class="hljs-comment">// 解压 → 遍历 → 处理 → 重新打包...</span>
                <span class="hljs-comment">// 省略大量代码...</span>
            }
        }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        <span class="hljs-keyword">val</span> android = project.extensions.getByType(AppExtension::<span class="hljs-keyword">class</span>.java)
        <span class="hljs-comment">// AGP 8.0 中已被删除</span>
        android.registerTransform(MyTransform())
    }
}

</code></pre>
<p>主要功能描述都放在注释里了，这里不多赘述</p>
<h3 data-id="heading-4">AsmClassVisitorFactory示例</h3>
<p>  相比于Transfrom，新的AsmClassVisitorFactory <strong>帮你完成遍历 Class文件，读取字节码 遍历ClassReader/ClassWriter 并处理jar和增量编辑等逻辑</strong>，根据官网所说，代码减少五倍 （不敢苟同哈，但是以前确实要实现5个抽象方法， 相比来说较少写很多代码是真的）。</p>
<p>  我们这里重点讲新的Transfrom的方式，我们这里实现一个 方法耗时打印的插桩。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90917f53974d4774bd4234631f655d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5bed:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736855&amp;x-signature=ihA07V2ENTsrzYIkt5BGY1n3SEk%3D" alt="image.png" loading="lazy"/></p>








































<table><thead><tr><th>文件名</th><th>作用</th><th>关键方法/属性</th></tr></thead><tbody><tr><td>MethodTracePlugin.kt</td><td>插件入口，注册到 Gradle</td><td>apply() - 创建扩展配置、注册 AsmClassVisitorFactory</td></tr><tr><td>MethodTraceExtension.kt</td><td>DSL 扩展配置，供 build.gradle 使用</td><td>enable、enableLog、includePackages、excludePackages、thresholdMs</td></tr><tr><td>MethodTraceParams.kt</td><td>传递给 Factory 的参数接口</td><td>与 Extension 对应的 Property 参数</td></tr><tr><td>MethodTraceClassVisitorFactory.kt</td><td>AGP 的入口工厂类，决定哪些类需要插桩</td><td>isInstrumentable() - 过滤类<br/>createClassVisitor() - 创建 ClassVisitor</td></tr><tr><td>MethodTraceClassVisitor.kt</td><td>类级别访问器，遍历类中的方法</td><td>visitMethod() - 返回自定义的 MethodVisitor</td></tr><tr><td>MethodTraceMethodVisitor.kt</td><td>方法级别访问器，真正插入字节码</td><td>onMethodEnter() - 方法入口插桩<br/>onMethodExit() - 方法出口插桩</td></tr></tbody></table>
<p><strong>超级多代码警告！！</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTracePlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"MethodTracePlugin"</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 插件已应用"</span>)
        <span class="hljs-comment">// 创建扩展配置</span>
        <span class="hljs-keyword">val</span> extension = project.extensions.create(
            <span class="hljs-string">"methodTrace"</span>,
            MethodTraceExtension::<span class="hljs-keyword">class</span>.java
        )
        <span class="hljs-comment">// 获取 Android 组件扩展</span>
        <span class="hljs-keyword">val</span> androidComponents = project.extensions.findByType(
            AndroidComponentsExtension::<span class="hljs-keyword">class</span>.java
        ) ?: run {
            println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 未找到 Android 组件，跳过"</span>)
            <span class="hljs-keyword">return</span>
        }
        <span class="hljs-comment">// AGP 的回调执行顺序：onVariants → afterEvaluate</span>
        androidComponents.onVariants { variant -&gt;
            <span class="hljs-comment">// 使用 Provider 延迟获取配置值（配置阶段还没完成）</span>
            <span class="hljs-keyword">val</span> enabled = extension.enable.getOrElse(<span class="hljs-literal">true</span>)
            
            <span class="hljs-keyword">if</span> (!enabled) {
                println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 插件已禁用，跳过变体 <span class="hljs-subst">${variant.name}</span>"</span>)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@onVariants</span>
            }
            
            println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 配置变体 <span class="hljs-subst">${variant.name}</span>"</span>)

            variant.instrumentation.transformClassesWith(
                MethodTraceClassVisitorFactory::<span class="hljs-keyword">class</span>.java,
                InstrumentationScope.PROJECT  <span class="hljs-comment">// 只处理项目代码</span>
            ) { params -&gt;
                <span class="hljs-comment">// 使用 Provider 链接，这样值会在真正需要时才获取</span>
                params.enableLog.<span class="hljs-keyword">set</span>(extension.enableLog)
                params.includePackages.<span class="hljs-keyword">set</span>(extension.includePackages)
                params.excludePackages.<span class="hljs-keyword">set</span>(extension.excludePackages)
                params.thresholdMs.<span class="hljs-keyword">set</span>(extension.thresholdMs)
            }

            variant.instrumentation.setAsmFramesComputationMode(
                FramesComputationMode.COMPUTE_FRAMES_FOR_INSTRUMENTED_METHODS
            )
        }
    }
}
</code></pre>
<p>  <strong>MethodTracePlugin</strong> 是整个插件的入口，是需要注册在gradle的插件中的，不然是找不到该插件的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodTraceParams</span> : <span class="hljs-type">InstrumentationParameters</span> {
    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> enableLog: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;  <span class="hljs-comment">// 插件开关</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> includePackages: ListProperty&lt;String&gt; <span class="hljs-comment">// 要处理的包名列表</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> excludePackages: ListProperty&lt;String&gt;  <span class="hljs-comment">// 要排除的白名单列表</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> thresholdMs: Property&lt;<span class="hljs-built_in">Long</span>&gt;   <span class="hljs-comment">// 方法打印毫秒阈值</span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceExtension</span> {

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> enable: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> enableLog: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> includePackages: ListProperty&lt;String&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> excludePackages: ListProperty&lt;String&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> thresholdMs: Property&lt;<span class="hljs-built_in">Long</span>&gt;

    <span class="hljs-keyword">init</span> {
        enable.convention(<span class="hljs-literal">true</span>)
        enableLog.convention(<span class="hljs-literal">false</span>)
        includePackages.convention(emptyList())
        excludePackages.convention(emptyList())
        thresholdMs.convention(<span class="hljs-number">0L</span>)
    }
}
</code></pre>
<p>  我们可以根据自己想要自定义的部分，<strong>MethodTraceExtension为 gradle 扩展配置</strong>，方便用户在App中使用自定义关键阈值和开关等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceClassVisitorFactory</span> :
    <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">MethodTraceParams</span>&gt; {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(
        classContext: <span class="hljs-type">ClassContext</span>,
        nextClassVisitor: <span class="hljs-type">ClassVisitor</span>
    )</span></span>: ClassVisitor {
        <span class="hljs-keyword">return</span> MethodTraceClassVisitor(
            nextClassVisitor,
            classContext.currentClassData.className,
            parameters.<span class="hljs-keyword">get</span>().enableLog.<span class="hljs-keyword">get</span>(),
            parameters.<span class="hljs-keyword">get</span>().thresholdMs.<span class="hljs-keyword">get</span>()
        )
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> className = classData.className
        <span class="hljs-keyword">val</span> params = parameters.<span class="hljs-keyword">get</span>()

        <span class="hljs-comment">// 排除 MethodTracer 本身，避免死循环！</span>
        <span class="hljs-keyword">if</span> (className.contains(<span class="hljs-string">"MethodTracer"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }

        <span class="hljs-comment">// 检查排除列表</span>
        <span class="hljs-keyword">val</span> excludePackages = params.excludePackages.<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">for</span> (pkg <span class="hljs-keyword">in</span> excludePackages) {
            <span class="hljs-keyword">if</span> (className.startsWith(pkg)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
        }

        <span class="hljs-comment">// 检查包含列表</span>
        <span class="hljs-keyword">val</span> includePackages = params.includePackages.<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">if</span> (includePackages.isEmpty()) {
            <span class="hljs-comment">// 如果没有配置，默认处理所有非系统类</span>
            <span class="hljs-keyword">return</span> !className.startsWith(<span class="hljs-string">"android."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"androidx."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"kotlin."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"java."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"javax."</span>)
        }
        <span class="hljs-keyword">for</span> (pkg <span class="hljs-keyword">in</span> includePackages) {
            <span class="hljs-keyword">if</span> (className.startsWith(pkg)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
}
</code></pre>
<p>  接下来就实现 已经在 MethodTracePlugin 指定的工厂层 <strong>MethodTraceClassVisitorFactory</strong> ，结合 isInstrumentable 方法可以控制是否跳过对应class ，createClassVisitor方法 则是创建 对应的方法处理类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceClassVisitor</span> (
    nextVisitor: ClassVisitor,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> enableLog: <span class="hljs-built_in">Boolean</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> thresholdMs: <span class="hljs-built_in">Long</span>
) : ClassVisitor(Opcodes.ASM9, nextVisitor) {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(
        access: <span class="hljs-type">Int</span>,
        name: <span class="hljs-type">String</span>,
        descriptor: <span class="hljs-type">String</span>,
        signature: <span class="hljs-type">String</span>?,
        exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?
    )</span></span>: MethodVisitor? {

        <span class="hljs-keyword">val</span> mv = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
            ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 跳过构造方法和静态初始化块</span>
        <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"&lt;init&gt;"</span> || name == <span class="hljs-string">"&lt;clinit&gt;"</span>) {
            <span class="hljs-keyword">return</span> mv
        }

        <span class="hljs-comment">// 跳过抽象方法和 native 方法</span>
        <span class="hljs-keyword">if</span> ((access and Opcodes.ACC_ABSTRACT) != <span class="hljs-number">0</span> ||
            (access and Opcodes.ACC_NATIVE) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> mv
        }

        <span class="hljs-keyword">if</span> (enableLog) {
            println(<span class="hljs-string">"  插桩方法: <span class="hljs-variable">$className</span>#<span class="hljs-variable">$name</span><span class="hljs-variable">$descriptor</span>"</span>)
        }

        <span class="hljs-comment">// 返回自定义的 MethodVisitor，传递阈值参数</span>
        <span class="hljs-keyword">return</span> MethodTraceMethodVisitor(
            mv,
            access,
            className,
            name,
            descriptor,
            thresholdMs  <span class="hljs-comment">// 传递耗时阈值</span>
        )
    }
}
</code></pre>
<p>   <strong>MethodTraceClassVisitor</strong> 主要作用就是 遍历方法，过滤一些特殊的方法，可主要针对核心业务代码进行选择。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceMethodVisitor</span>(
    methodVisitor: MethodVisitor,
    access: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,      <span class="hljs-comment">// 第3个参数：类名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> methodName: String,     <span class="hljs-comment">// 第4个参数：方法名  </span>
    descriptor: String,                 <span class="hljs-comment">// 第5个参数：方法描述符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> thresholdMs: <span class="hljs-built_in">Long</span>       <span class="hljs-comment">// 第6个参数：耗时阈值（毫秒）</span>
) : AdviceAdapter(Opcodes.ASM9, methodVisitor, access, methodName, descriptor) {

    <span class="hljs-comment">// 存储开始时间的局部变量索引</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> startTimeVarIndex = <span class="hljs-number">0</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span></span> {
        startTimeVarIndex = newLocal(org.objectweb.asm.Type.LONG_TYPE)

        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"java/lang/System"</span>,
            <span class="hljs-string">"nanoTime"</span>,
            <span class="hljs-string">"()J"</span>,
            <span class="hljs-literal">false</span>
        )
        mv.visitVarInsn(LSTORE, startTimeVarIndex)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodExit</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">if</span> (opcode != ATHROW) {
            printMethodCost()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMethodCost</span><span class="hljs-params">()</span></span> {
        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"java/lang/System"</span>,
            <span class="hljs-string">"nanoTime"</span>,
            <span class="hljs-string">"()J"</span>,
            <span class="hljs-literal">false</span>
        )
        mv.visitVarInsn(LLOAD, startTimeVarIndex)
        mv.visitInsn(LSUB)  <span class="hljs-comment">// 执行减法</span>
        
        <span class="hljs-comment">// 存储耗时结果</span>
        <span class="hljs-keyword">val</span> durationVarIndex = newLocal(org.objectweb.asm.Type.LONG_TYPE)
        mv.visitVarInsn(LSTORE, durationVarIndex)

        <span class="hljs-keyword">if</span> (thresholdMs &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> skipLabel = org.objectweb.asm.Label()
            
            <span class="hljs-comment">// 加载 durationNs</span>
            mv.visitVarInsn(LLOAD, durationVarIndex)
            <span class="hljs-comment">// 加载阈值（转换为纳秒）</span>
            mv.visitLdcInsn(thresholdMs * <span class="hljs-number">1_000_000L</span>)
            mv.visitInsn(LCMP)
            <span class="hljs-comment">// 如果 durationNs &lt; threshold，跳过 trace 调用</span>
            mv.visitJumpInsn(IFLT, skipLabel)
            
            <span class="hljs-comment">// 调用 trace</span>
            invokeTrace(durationVarIndex)
            
            <span class="hljs-comment">// 跳过标签</span>
            mv.visitLabel(skipLabel)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 没有阈值限制，直接调用</span>
            invokeTrace(durationVarIndex)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeTrace</span><span class="hljs-params">(durationVarIndex: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 调用 MethodTracer.trace(className, methodName, durationNs)</span>
        mv.visitLdcInsn(className.replace(<span class="hljs-string">"/"</span>, <span class="hljs-string">"."</span>))  <span class="hljs-comment">// 第1个参数: className</span>
        mv.visitLdcInsn(methodName)                    <span class="hljs-comment">// 第2个参数: methodName</span>
        mv.visitVarInsn(LLOAD, durationVarIndex)       <span class="hljs-comment">// 第3个参数: durationNs (long)</span>
        
        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"com/xmly/gradley/trace/MethodTracer"</span>,  <span class="hljs-comment">// 对应 app 中的类</span>
            <span class="hljs-string">"trace"</span>,
            <span class="hljs-string">"(Ljava/lang/String;Ljava/lang/String;J)V"</span>,  <span class="hljs-comment">// (String, String, long) -&gt; void</span>
            <span class="hljs-literal">false</span>
        )
    }
}
</code></pre>
<p>   这里其实才是 真正的字节码插入的地方，onMethodEnter 方法开始的地方 插入获取当前时间，onMethodExit 方法结束的时候，插入 MethodTracer.trace ，用来打印实际耗时。</p>
<p>最后不要忘记再 gradle-plugin 的 build.gradle.kts中注册插件</p>
<pre><code class="hljs language-ini" lang="ini">create("methodTrace") {
    <span class="hljs-attr">id</span> = <span class="hljs-string">"com.xmly.methodtrace"</span>
    <span class="hljs-attr">implementationClass</span> = <span class="hljs-string">"com.xmly.plugin.trace.MethodTracePlugin"</span>
    <span class="hljs-attr">displayName</span> = <span class="hljs-string">"Method Trace Plugin"</span>
    <span class="hljs-attr">description</span> = <span class="hljs-string">"方法耗时统计插件"</span>
}
</code></pre>
<p>最后就是我们的 发布了， plugin library 都是需要发布的</p>
<pre><code class="hljs language-ruby" lang="ruby">./gradlew <span class="hljs-symbol">:gradle-plugin</span><span class="hljs-symbol">:publish</span>
</code></pre>
<p>对应的，我们在前边自定义了 Gradle扩展函数，所以我们可以自定义一些 plugin 逻辑，我们来到 App build.gradle 中引入插件</p>
<pre><code class="hljs language-ini" lang="ini">plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
    ...
    id 'com.xmly.methodtrace' version '1.0.0'  // 方法耗时插件
}

// 基于 gradle 拓展函数 ，就可以控制开关和 时间戳限制等逻辑
methodTrace {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">enableLog</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">includePackages</span> = [<span class="hljs-string">'com.xmly.gradley'</span>]
    <span class="hljs-attr">excludePackages</span> = [<span class="hljs-string">'com.xmly.gradley.test'</span>]
    <span class="hljs-attr">thresholdMs</span> = <span class="hljs-number">1</span>L  // 只记录超过 <span class="hljs-number">1</span>ms 的方法
}


</code></pre>
<p>最后，我们实现以下 App文件夹下 对应的 log实现类</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> MethodTracer {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"MethodTracer"</span>

    <span class="hljs-comment">// 是否启用（运行时开关）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> enabled = <span class="hljs-literal">true</span>

    <span class="hljs-comment">/**
     * 运行时开关，可动态禁用日志输出
     */</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setEnabled</span><span class="hljs-params">(enabled: <span class="hljs-type">Boolean</span>)</span></span> {
        <span class="hljs-keyword">this</span>.enabled = enabled
    }

    <span class="hljs-comment">/**
     * 记录方法耗时
     * 
     * 注意：阈值判断已在编译时完成（ASM 插桩生成了 if 判断），
     * 所以这里只负责打印，不再做阈值判断。
     * 
     * <span class="hljs-doctag">@param</span> className 类名
     * <span class="hljs-doctag">@param</span> methodName 方法名
     * <span class="hljs-doctag">@param</span> durationNs 耗时（纳秒）
     */</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trace</span><span class="hljs-params">(className: <span class="hljs-type">String</span>, methodName: <span class="hljs-type">String</span>, durationNs: <span class="hljs-type">Long</span>)</span></span> {
        <span class="hljs-keyword">if</span> (!enabled) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 阈值判断已在编译时完成，这里直接打印</span>
        <span class="hljs-keyword">val</span> durationMs = durationNs / <span class="hljs-number">1_000_000.0</span>
        Log.d(TAG, String.format(
            <span class="hljs-string">"%.2fms | %s#%s"</span>,
            durationMs,
            className,
            methodName
        ))
    }
}
</code></pre>
<p>这里重点看trace 即可，主要就是用来打印</p>
<h3 data-id="heading-5">ASM插桩 LayoutInflater 拓展</h3>
<p>  这里简单聊一下对上述方法的拓展，比如说我现在需要对布局绘制进行一些简单的耗时打点，就可以借助上边的办法，针对 <code>View view = layoutInflater.inflate(R.layout.activity_main, container)</code>的代码进行插桩。</p>
<p>目标示例代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">// 方式一：直接替换方法调用
View <span class="hljs-attr">view</span> = LayoutInflaterAgent.wrapInflate(layoutInflater, R.layout.activity_main, container)<span class="hljs-comment">;</span>

// 方式二：前后包裹（记录耗时）
long <span class="hljs-attr">startTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
View <span class="hljs-attr">view</span> = layoutInflater.inflate(R.layout.activity_main, container)<span class="hljs-comment">;</span>
long <span class="hljs-attr">cost</span> = System.currentTimeMillis() - startTime<span class="hljs-comment">;</span>
LayoutInflaterAgent.inflateHook(view, R.layout.activity_main, cost)<span class="hljs-comment">;</span>
</code></pre>
<p>我们重点模拟下 方法替换 Visitor 的代码，主要是针对 三个方法，<code>inflate(int resource, ViewGroup root)</code> ， <code>inflate(int resource, ViewGroup root, boolean attachToRoot)</code> 和 <code>ViewStub.inflate()</code>三个方法进行拦截和替换</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InflateMethodVisitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodVisitor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Opcodes</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TO_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com/ximalaya/commonaspectj/LayoutInflaterAgent"</span>;
    <span class="hljs-keyword">private</span> String mName, mDesc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">MethodInsnNode</span> <span class="hljs-variable">targetMethodNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInsnNode</span>(INVOKEVIRTUAL,
            <span class="hljs-string">"android/view/LayoutInflater"</span>,
            <span class="hljs-string">"inflate"</span>,
            INFLATEDESC_1, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-type">MethodInsnNode</span> <span class="hljs-variable">viewStubMethodNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInsnNode</span>(INVOKEVIRTUAL,
            <span class="hljs-string">"android/view/ViewStub"</span>, <span class="hljs-string">"inflate"</span>,
            <span class="hljs-string">"()Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InflateMethodVisitor</span><span class="hljs-params">(<span class="hljs-type">int</span> api, MethodVisitor methodVisitor, String name, String desc)</span> {
        <span class="hljs-built_in">super</span>(api, methodVisitor);
        <span class="hljs-built_in">this</span>.mName = name;
        <span class="hljs-built_in">this</span>.mDesc = desc;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitMethodInsn</span><span class="hljs-params">(<span class="hljs-type">int</span> opcode, String owner, String name, String descriptor, <span class="hljs-type">boolean</span> isInterface)</span> {
        <span class="hljs-keyword">if</span> (owner.equals(targetMethodNode.owner) &amp;&amp; name.equals(targetMethodNode.name)) {
            <span class="hljs-keyword">if</span> (descriptor.equals(INFLATEDESC_1)) {
                mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/LayoutInflater;ILandroid/view/ViewGroup;)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
                XLog.INSTANCE.d( getLogTag(),<span class="hljs-string">"2_"</span>+className + <span class="hljs-string">"#"</span> + mName + mDesc);

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (descriptor.equals(INFLATEDESC_2)) {
                mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/LayoutInflater;ILandroid/view/ViewGroup;Z)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
                XLog.INSTANCE.d(getLogTag(), <span class="hljs-string">"3_"</span> +className + <span class="hljs-string">"#"</span> + mName + mDesc);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (owner.equals(viewStubMethodNode.owner) &amp;&amp; name.equals(viewStubMethodNode.name) &amp;&amp; descriptor.equals(viewStubMethodNode.desc)) {
            mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/ViewStub;)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
            XLog.INSTANCE.d(getLogTag(),<span class="hljs-string">"3_"</span>+className + <span class="hljs-string">"#"</span> + mName + mDesc);

            XLog.INSTANCE.i(getLogTag(),<span class="hljs-string">"className: "</span> + className
                    + <span class="hljs-string">", name: "</span> + name + <span class="hljs-string">", descriptor: "</span> + descriptor
                    + <span class="hljs-string">", owner: "</span> + owner + <span class="hljs-string">", mName: "</span> + mName
                    + <span class="hljs-string">", mDesc: "</span> + mDesc);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface);
        }

    }
}
</code></pre>
<p>  其实原理和 检测方法耗时是一样的，只是关于方法的替换逻辑不一样，其他的 apm其实大部分原理都差不多。</p>
<h2 data-id="heading-6">最后</h2>
<p>  到这里基本结束了，其实主要是列了一下 新版本的transform的使用方式以及 ASM plugin的开发和使用。关于其他的ASM用来实现什么apm逻辑，就要看自己举一反三了。最近也是终于有空把本地的 Gradle和 ASM插桩知识总结了一下，临近年关，又要对自己来一次 Review，感觉很多知识类的在AI的加持下，可以更快的上手和落地实现了，后续也会把本地的AI使用做一个归纳和总结，<strong>后续也要把输出文章重点放在AI侧方向</strong>。</p>
<h2 data-id="heading-7">参考文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fasm.ow2.io%2F" target="_blank" title="https://asm.ow2.io/" ref="nofollow noopener noreferrer">ASM 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Ftools%2Fgradle-api%2Fcurrent%2Fcom%2Fandroid%2Fbuild%2Fapi%2Finstrumentation%2Fpackage-summary" target="_blank" title="https://developer.android.com/reference/tools/gradle-api/current/com/android/build/api/instrumentation/package-summary" ref="nofollow noopener noreferrer">AGP Instrumentation API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2FByteX" target="_blank" title="https://github.com/bytedance/ByteX" ref="nofollow noopener noreferrer">ByteX 开源项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchuyouyinghe%2Farticle%2Fdetails%2F144297435" target="_blank" title="https://blog.csdn.net/chuyouyinghe/article/details/144297435" ref="nofollow noopener noreferrer">手把手教你通过 AGP + ASM 实现 Android 应用插桩</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么]]></title>    <link>https://juejin.cn/post/7585206549284995113</link>    <guid>https://juejin.cn/post/7585206549284995113</guid>    <pubDate>2025-12-19T03:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585206549284995113" data-draft-id="7585096444190818340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么"/> <meta itemprop="keywords" content="Agent,AI编程,AIGC"/> <meta itemprop="datePublished" content="2025-12-19T03:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T03:20:27.000Z" title="Fri Dec 19 2025 03:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 Gemini CLI 到 Innies CLI：Monorepo 架构改造实践</h2>
<p>做开源项目二次开发的时候，经常会遇到一个问题：上游项目的架构设计得很好，但文档里不会告诉你"为什么这么设计"。只有真正改造的时候，才会慢慢理解那些设计决策背后的意图。</p>
<p>最近在把 Qwen Code（基于 Google Gemini CLI 改造）再改造成我们自己的 用来私有化部署的CLI，过程中对 Monorepo 架构有了更深的理解。这篇文章从项目架构讲起，学习下 Google 在这个 CLI 项目里的好的设计决策。</p>
<hr/>
<h3 data-id="heading-1">项目背景</h3>
<p>先说说这个项目的"血统"：</p>
<pre><code class="hljs language-java" lang="java">Google Gemini <span class="hljs-title function_">CLI</span> <span class="hljs-params">(原版)</span>
       ↓ 改造
Qwen <span class="hljs-title function_">Code</span> <span class="hljs-params">(通义版)</span>
       ↓ 改造
xxx <span class="hljs-title function_">CLI</span> <span class="hljs-params">(我们的版本)</span>
</code></pre>
<p>Google 的 Gemini CLI 是一个 AI 命令行工具，用 TypeScript 写的，架构设计得挺讲究。Qwen Code 把它改造成了适配通义千问的版本，我们又在 Qwen Code 基础上做了进一步定制。</p>
<p>整个项目用的是 <strong>npm workspaces</strong> 管理的 Monorepo 结构，这个选择在后面会发现特别重要。</p>
<hr/>
<h3 data-id="heading-2">Monorepo 结构</h3>
<p>先看项目的目录结构：</p>
<pre><code class="hljs language-ruby" lang="ruby">innies-cli/
├── packages/
│   ├── cli/           <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/xxx-cli - 命令行界面</span>
│   ├── core/          <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/xxx-core - 核心逻辑</span>
│   ├── test-utils/    <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/test-utils - 测试工具</span>
│   └── vscode-ide-companion/  <span class="hljs-comment"># VS Code 扩展</span>
├── scripts/           <span class="hljs-comment"># 构建脚本</span>
├── eslint-rules/      <span class="hljs-comment"># 自定义 ESLint 规则</span>
├── .husky/            <span class="hljs-comment"># Git hooks</span>
├── .github/workflows/ <span class="hljs-comment"># CI/CD</span>
└── package.json       <span class="hljs-comment"># 根配置</span>
</code></pre>
<p>根 <code>package.json</code> 里的 workspaces 配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"packages/*"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">为什么要拆成多个包？</h4>
<p>刚开始看到这个结构的时候，我在想：一个 CLI 工具有必要拆成这么多包吗？后来改造的时候才明白，这个拆分很有道理。</p>
<p><strong>cli 包</strong>：负责终端 UI、命令解析、用户交互。用的是 React + Ink 渲染终端界面。</p>
<p><strong>core 包</strong>：负责核心逻辑，包括 AI 模型调用、工具执行、MCP 协议、沙箱管理。这部分跟 UI 完全无关。</p>
<p>这个拆分的好处在改造的时候体现出来了：</p>
<ol>
<li><strong>换模型不影响 UI</strong>：我们把 Gemini 换成自己的模型，只需要改 core 包，cli 包几乎不用动</li>
<li><strong>复用核心逻辑</strong>：core 包可以被 VS Code 扩展、其他工具直接引用</li>
<li><strong>独立测试</strong>：两个包可以分别跑测试，互不干扰</li>
</ol>
<hr/>
<h3 data-id="heading-4">包之间的依赖关系</h3>
<p>在 <code>packages/cli/package.json</code> 里，可以看到这样的依赖声明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@innies/innies-core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../core"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>file:../core</code> 是 npm workspaces 的本地包引用方式。在开发时，npm 会自动把这个软链接到 <code>node_modules/@innies/innies-core</code>，修改 core 包的代码，cli 包能立刻感知到。</p>
<p>发布的时候，这个 <code>file:</code> 协议会被替换成真正的版本号。</p>
<hr/>
<h3 data-id="heading-5">禁止跨包相对导入</h3>
<p>这里就要说到 Google 制定的一条规则了。</p>
<p>在 <code>eslint-rules/</code> 目录下，有一个自定义的 ESLint 规则：<code>no-relative-cross-package-imports.js</code>。这个规则做一件事：<strong>禁止用相对路径跨包导入</strong>。</p>
<h4 data-id="heading-6">错误写法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 packages/cli/src/someFile.ts 中</span>
<span class="hljs-keyword">import</span> { something } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../core/src/utils.js'</span>;
</code></pre>
<h4 data-id="heading-7">正确写法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 packages/cli/src/someFile.ts 中</span>
<span class="hljs-keyword">import</span> { something } <span class="hljs-keyword">from</span> <span class="hljs-string">'@innies/innies-core'</span>;
</code></pre>
<h4 data-id="heading-8">为什么要有这条规则？</h4>
<p>改造过程中就明白了。</p>
<p><strong>场景一：改包名</strong></p>
<p>我们把 <code>@qwen-code/qwen-code</code> 改成 <code>@innies/innies-cli</code>，如果代码里到处都是 <code>../../core/src/xxx</code>，那这些路径不用改。但问题是，这些"不用改"的代码，会让你误以为两个包之间没有边界。</p>
<p><strong>场景二：重构目录结构</strong></p>
<p>假设有一天要把 <code>packages/core/src/utils.js</code> 移动到 <code>packages/core/src/shared/utils.js</code>，用包名导入的代码完全不受影响（只要 core 包的导出不变），但用相对路径的代码全部要改。</p>
<p><strong>场景三：发布为独立包</strong></p>
<p>如果未来想把 core 包独立发布到 npm，用包名导入的代码一行不用改。用相对路径的代码？那就只能祈祷了。</p>
<h4 data-id="heading-9">完整规则实现</h4>
<p>下面是 Google 写的完整规则代码，值得仔细看看：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@license</span>
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> Disallows relative imports between specified monorepo packages.
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">/**
 * Finds the package name by searching for the nearest `package.json` file
 * in the directory hierarchy, starting from the given file's directory
 * and moving upwards until the specified root directory is reached.
 * It reads the `package.json` and extracts the `name` property.
 *
 * <span class="hljs-doctag">@requires</span> module:path Node.js path module
 * <span class="hljs-doctag">@requires</span> module:fs Node.js fs module
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">filePath</span> - The path (absolute or relative) to a file within the potential package structure.
 * The search starts from the directory containing this file.
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">root</span> - The absolute path to the root directory of the project/monorepo.
 * The upward search stops when this directory is reached.
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string | undefined | null</span>} The value of the `name` field from the first `package.json` found.
 * Returns `undefined` if the `name` field doesn't exist in the found `package.json`.
 * Returns `null` if no `package.json` is found before reaching the `root` directory.
 * <span class="hljs-doctag">@throws</span> {<span class="hljs-type">Error</span>} Can throw an error if `fs.readFileSync` fails (e.g., permissions) or if `JSON.parse` fails on invalid JSON content.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findPackageName</span>(<span class="hljs-params">filePath, root</span>) {
  <span class="hljs-keyword">let</span> currentDir = path.<span class="hljs-title function_">dirname</span>(path.<span class="hljs-title function_">resolve</span>(filePath));
  <span class="hljs-keyword">while</span> (currentDir !== root) {
    <span class="hljs-keyword">const</span> parentDir = path.<span class="hljs-title function_">dirname</span>(currentDir);
    <span class="hljs-keyword">const</span> packageJsonPath = path.<span class="hljs-title function_">join</span>(currentDir, <span class="hljs-string">'package.json'</span>);
    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(packageJsonPath)) {
      <span class="hljs-keyword">const</span> pkg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(packageJsonPath, <span class="hljs-string">'utf-8'</span>));
      <span class="hljs-keyword">return</span> pkg.<span class="hljs-property">name</span>;
    }

    <span class="hljs-comment">// Move up one level</span>
    currentDir = parentDir;
    <span class="hljs-comment">// Safety break if we somehow reached the root directly in the loop condition (less likely with path.resolve)</span>
    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">dirname</span>(currentDir) === currentDir) <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// Not found within the expected structure</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'problem'</span>,
    <span class="hljs-attr">docs</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Disallow relative imports between packages.'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'Best Practices'</span>,
      <span class="hljs-attr">recommended</span>: <span class="hljs-string">'error'</span>,
    },
    <span class="hljs-attr">fixable</span>: <span class="hljs-string">'code'</span>,
    <span class="hljs-attr">schema</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">root</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
            <span class="hljs-attr">description</span>:
              <span class="hljs-string">'Absolute path to the root of all relevant packages to consider.'</span>,
          },
        },
        <span class="hljs-attr">required</span>: [<span class="hljs-string">'root'</span>],
        <span class="hljs-attr">additionalProperties</span>: <span class="hljs-literal">false</span>,
      },
    ],
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-attr">noRelativePathsForCrossPackageImport</span>:
        <span class="hljs-string">"Relative import '{{importedPath}}' crosses package boundary from '{{importingPackage}}' to '{{importedPackage}}'. Use a direct package import ('{{importedPackage}}') instead."</span>,
      <span class="hljs-attr">relativeImportIsInvalidPackage</span>:
        <span class="hljs-string">"Relative import '{{importedPath}}' does not reference a valid package. All source must be in a package directory."</span>,
    },
  },

  <span class="hljs-title function_">create</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> options = context.<span class="hljs-property">options</span>[<span class="hljs-number">0</span>] || {};
    <span class="hljs-keyword">const</span> allPackagesRoot = options.<span class="hljs-property">root</span>;

    <span class="hljs-keyword">const</span> currentFilePath = context.<span class="hljs-property">filename</span>;
    <span class="hljs-keyword">if</span> (
      !currentFilePath ||
      currentFilePath === <span class="hljs-string">'&lt;input&gt;'</span> ||
      currentFilePath === <span class="hljs-string">'&lt;text&gt;'</span>
    ) {
      <span class="hljs-comment">// Skip if filename is not available (e.g., linting raw text)</span>
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-keyword">const</span> currentPackage = <span class="hljs-title function_">findPackageName</span>(currentFilePath, allPackagesRoot);

    <span class="hljs-comment">// If the current file isn't inside a package structure, don't apply the rule</span>
    <span class="hljs-keyword">if</span> (!currentPackage) {
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-title class_">ImportDeclaration</span>(node) {
        <span class="hljs-keyword">const</span> importingPackage = currentPackage;
        <span class="hljs-keyword">const</span> importedPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;

        <span class="hljs-comment">// Only interested in relative paths</span>
        <span class="hljs-keyword">if</span> (
          !importedPath ||
          <span class="hljs-keyword">typeof</span> importedPath !== <span class="hljs-string">'string'</span> ||
          !importedPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)
        ) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// Resolve the absolute path of the imported module</span>
        <span class="hljs-keyword">const</span> absoluteImportPath = path.<span class="hljs-title function_">resolve</span>(
          path.<span class="hljs-title function_">dirname</span>(currentFilePath),
          importedPath,
        );

        <span class="hljs-comment">// Find the package information for the imported file</span>
        <span class="hljs-keyword">const</span> importedPackage = <span class="hljs-title function_">findPackageName</span>(
          absoluteImportPath,
          allPackagesRoot,
        );

        <span class="hljs-comment">// If the imported file isn't in a recognized package, report issue</span>
        <span class="hljs-keyword">if</span> (!importedPackage) {
          context.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>,
            <span class="hljs-attr">messageId</span>: <span class="hljs-string">'relativeImportIsInvalidPackage'</span>,
            <span class="hljs-attr">data</span>: { <span class="hljs-attr">importedPath</span>: importedPath },
          });
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// The core check: Are the source and target packages different?</span>
        <span class="hljs-keyword">if</span> (currentPackage !== importedPackage) {
          <span class="hljs-comment">// We found a relative import crossing package boundaries</span>
          context.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>, <span class="hljs-comment">// Report the error on the source string literal</span>
            <span class="hljs-attr">messageId</span>: <span class="hljs-string">'noRelativePathsForCrossPackageImport'</span>,
            <span class="hljs-attr">data</span>: {
              importedPath,
              importedPackage,
              importingPackage,
            },
            <span class="hljs-title function_">fix</span>(<span class="hljs-params">fixer</span>) {
              <span class="hljs-keyword">return</span> fixer.<span class="hljs-title function_">replaceText</span>(node.<span class="hljs-property">source</span>, <span class="hljs-string">`'<span class="hljs-subst">${importedPackage}</span>'`</span>);
            },
          });
        }
      },
    };
  },
};

</code></pre>
<p>这个规则的设计有几个亮点：</p>
<ol>
<li>
<p><strong><code>findPackageName</code> 函数</strong>：从当前文件向上查找 <code>package.json</code>，找到就返回包名。这个逻辑很通用，不管包嵌套多深都能正确识别。</p>
</li>
<li>
<p><strong>两种错误消息</strong>：一种是跨包导入，另一种是导入了不在任何包里的文件。后者能帮你发现项目结构问题。</p>
</li>
<li>
<p><strong>自动修复</strong>：<code>fix(fixer)</code> 函数直接把相对路径替换成包名，跑 <code>eslint --fix</code> 就能批量修复。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">其他 Google 制定的规则</h3>
<p>除了跨包导入规则，eslint 配置里还有几条值得一提的规则：</p>
<h4 data-id="heading-11">禁止 require</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'CallExpression[callee.name="require"]'</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'Avoid using require(). Use ES6 imports instead.'</span>,
}
</code></pre>
<p>整个项目用的是 ESM（<code>"type": "module"</code>），不允许混用 CommonJS 的 <code>require</code>。</p>
<h4 data-id="heading-12">禁止抛出字符串</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'ThrowStatement &gt; Literal'</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'Do not throw string literals. Throw new Error("...") instead.'</span>,
}
</code></pre>
<p>这条规则防止 <code>throw "something went wrong"</code> 这种写法，要求必须抛 Error 对象。好处是错误堆栈更清晰。</p>
<h4 data-id="heading-13">禁止访问内部模块</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'import/no-internal-modules'</span>: [
  <span class="hljs-string">'error'</span>,
  {
    <span class="hljs-attr">allow</span>: [<span class="hljs-string">'react-dom/test-utils'</span>, <span class="hljs-string">'memfs/lib/volume.js'</span>, <span class="hljs-string">'yargs/**'</span>]
  }
]
</code></pre>
<p>这条规则禁止直接导入一个包的内部文件（比如 <code>lodash/src/xxx</code>），只能用包的正式导出。白名单里的是一些特殊情况。</p>
<hr/>
<h3 data-id="heading-14">改造过程中的踩坑</h3>
<h4 data-id="heading-15">包名全局替换</h4>
<p>第一步是把包名从 <code>@qwen-code</code> 改成 <code>@xxx</code>。这看起来简单，实际上要改的地方很多：</p>
<ul>
<li>所有 <code>package.json</code></li>
<li>所有 import 语句</li>
<li>Docker 镜像名</li>
<li>CI/CD 配置</li>
<li>文档</li>
</ul>
<p>如果之前用的是相对路径导入，这一步会轻松很多（因为相对路径不涉及包名）。但正因为用了包名导入，后续的维护和理解成本会低很多。这是一个短期痛苦换长期收益的选择。</p>
<h4 data-id="heading-16">版本号同步</h4>
<p>Monorepo 里有个常见问题：多个包的版本号怎么管理？</p>
<p>一种做法是各个包独立版本（比如 lerna 的 independent mode），但这样容易版本混乱。Google 选择了另一种方式：<strong>所有包统一版本号</strong>，用一个脚本 <code>scripts/version.js</code> 来同步。</p>
<p>执行 <code>npm run release:version patch</code> 时，这个脚本会依次做这些事：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先更新根 package.json 的版本</span>
<span class="hljs-title function_">run</span>(<span class="hljs-string">`npm version <span class="hljs-subst">${versionType}</span> --no-git-tag-version`</span>);

<span class="hljs-comment">// 2. 遍历所有 workspace，逐个更新版本</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> workspaceName <span class="hljs-keyword">of</span> workspacesToVersion) {
  <span class="hljs-title function_">run</span>(<span class="hljs-string">`npm version <span class="hljs-subst">${versionType}</span> --workspace <span class="hljs-subst">${workspaceName}</span> --no-git-tag-version`</span>);
}

<span class="hljs-comment">// 3. 同步更新 Docker 镜像的 tag</span>
rootPackageJson.<span class="hljs-property">config</span>.<span class="hljs-property">sandboxImageUri</span> =
  rootPackageJson.<span class="hljs-property">config</span>.<span class="hljs-property">sandboxImageUri</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:.*$/</span>, <span class="hljs-string">`:<span class="hljs-subst">${newVersion}</span>`</span>);

<span class="hljs-comment">// 4. 更新 package-lock.json</span>
<span class="hljs-title function_">run</span>(<span class="hljs-string">'npm install --package-lock-only'</span>);
</code></pre>
<p>最终效果是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 根 package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sandboxImageUri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ghcr.io/zhimanai/innies-cli:0.1.5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// packages/cli/package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sandboxImageUri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ghcr.io/zhimanai/innies-cli:0.1.5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// packages/core/package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一条命令，所有 <code>package.json</code> 和 Docker 镜像 tag 全部同步更新，不会出现版本不一致的问题。</p>
<h4 data-id="heading-17">构建顺序</h4>
<p>Monorepo 的另一个问题是构建顺序。cli 包依赖 core 包，所以要先构建 core，再构建 cli。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build:packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build --workspaces"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>npm workspaces 会自动处理依赖顺序，但有时候还是会遇到问题。比如 core 包构建失败了，cli 包的构建也会失败，错误信息可能不太直观。</p>
<hr/>
<h3 data-id="heading-18">Husky + lint-staged</h3>
<p>项目用 Husky 管理 Git hooks，提交前会自动运行 lint-staged：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,jsx,ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"eslint --fix --max-warnings 0"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"*.{json,md}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"prettier --write"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个配置保证了提交到仓库的代码格式统一、没有 lint 警告。</p>
<p>一开始觉得 <code>--max-warnings 0</code> 太严格了，后来发现这是对的。warning 堆积起来，总有一天会变成技术债。不如一开始就卡死。</p>
<hr/>
<h3 data-id="heading-19">总结</h3>
<p>从 Gemini CLI 到 Innies CLI 的改造过程，让我对 Monorepo 架构有了更深的理解：</p>
<ol>
<li><strong>包拆分要有明确的边界</strong>：cli 负责 UI，core 负责逻辑，职责清晰</li>
<li><strong>禁止跨包相对导入</strong>：短期麻烦，长期收益。这条 Google 制定的规则真的很有用</li>
<li><strong>版本号统一管理</strong>：避免各个包版本不一致的混乱</li>
<li><strong>Lint 规则从严</strong>：<code>--max-warnings 0</code> 看起来严格，但能防止技术债堆积</li>
</ol>
<p>这些设计决策，在代码里看不出"为什么"，只有真正改造一遍才能体会。</p>
<p>如果你也在做类似的项目改造，希望这些经验能帮到你。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi-vue2集成flowable6.7.2后端篇]]></title>    <link>https://juejin.cn/post/7585091990347481124</link>    <guid>https://juejin.cn/post/7585091990347481124</guid>    <pubDate>2025-12-19T04:29:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585091990347481124" data-draft-id="7585206549285191721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi-vue2集成flowable6.7.2后端篇"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-19T04:29:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi-vue2集成flowable6.7.2后端篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T04:29:19.000Z" title="Fri Dec 19 2025 04:29:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>ruoyi在中国市场有着广泛的群众基础， flowable也在很多企业落地。 本文将讲解如何在ruoyi集成flowable，主要是后端。</p>
</blockquote>
<h2 data-id="heading-0">环境说明</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f7eb740380243cc89c0ffc7217f342f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=8CVPOphMG09Ec6nR%2F3%2Fnz7DyhZw%3D" alt="image.png" loading="lazy"/></p>
<p>ruoyi: Ruoyi-Vue2-Boot-2.x, <br/>
版本信息: 3.9.0<br/>
jdk: 1.8<br/>
flowable: 6.7.2<br/></p>
<h2 data-id="heading-1">安装步骤</h2>
<ul>
<li>在IDEA工具导入项目， 在项目名称上， 右键点击选择Module, 创建一个新的模块。ruoyi-flowable</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a08a259b940c434abb1db5b9af5f664a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=oC6HGEvvPjTjRtxLftocji%2Bvyhk%3D" alt="r2.png" loading="lazy"/></p>
<ul>
<li>maven配置
在ruoyi项目的根目录下找到pom.xml文件， 添加flowable依赖</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">flowable.spring-boot.version</span>&gt;</span>6.7.2<span class="hljs-tag">&lt;/<span class="hljs-name">flowable.spring-boot.version</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 忽略其他--&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>


 <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
       <span class="hljs-comment">&lt;!--忽略其他--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${flowable.spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span> 
</code></pre>
<p>在ruoyi-flowable模块下的根目录pom.xml文件加入以下依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- swagger3--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--common--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.40<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.40<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>继续在根pom.xml下，加入ruoyi-flowable，与ruoyi-common在同一个位置。这一步就是将新增模块嵌入了系统当中!!!</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-flowable<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${ruoyi.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在ruoyi-admin模块下加入ruoyi-flowable模块</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 代码生成--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- flowable--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-flowable<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">配置application.yml</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flowable:</span>
  <span class="hljs-comment">#关闭定时任务JOB</span>
  <span class="hljs-attr">async-executor-activate:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment">#将databaseSchemaUpdate设置为true。当flowable发现库与数据库表结构不一致时，会自动将数据库表结构升级至新版本。</span>
  <span class="hljs-attr">database-schema-update:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 自动部署验证设置:true-开启（默认）、false-关闭</span>
  <span class="hljs-attr">check-process-definitions:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment">#保存历史数据级别设置为full最高级别，便于历史数据的追溯</span>
  <span class="hljs-attr">history-level:</span> <span class="hljs-string">full</span>
</code></pre>
<ul>
<li>在application-druid.yml在url添加nullCatalogMeansCurrent=true</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;db&gt;?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8&amp;nullCatalogMeansCurrent=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">&lt;your_user&gt;</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">&lt;your_pass&gt;</span>

</code></pre>
<h2 data-id="heading-3">验证Swagger是否加载</h2>
<p>随便在ruoyi-flowable写一个controller，验证能否加载成功！</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8080/swagger-ui/index.html
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46309c681274af8879cb314029b1bf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=pD8DmGgHkvIvozBbB2K1X6MSBqw%3D" alt="r3.png" loading="lazy"/></p>
<h2 data-id="heading-4">若依工作流</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96df552a271e405688e2ae734a1be3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=%2BgdiDGiNGHx%2BktS1fi4XfgELDhI%3D" alt="r4.png" loading="lazy"/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a> 提供开箱即用的工作流源码解决方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器]]></title>    <link>https://juejin.cn/post/7585410547337723954</link>    <guid>https://juejin.cn/post/7585410547337723954</guid>    <pubDate>2025-12-20T02:50:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547337723954" data-draft-id="7585377128490631220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2025-12-20T02:50:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:50:20.000Z" title="Sat Dec 20 2025 02:50:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0"><code>Zustand</code>  VS  <code>Redux</code></h2>
<p>在文章开始前咱们先唠嗑一下，各位平时用哪个更多点呢？<strong>大数据</strong>不会骗人：</p>
<p>首先<code>GitHub</code>上的 Star 数量比较：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae79054cda14ddf91cbd6dfca32a293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=PIoL1fNIHR%2Fa7LPILLJXuGiE4s0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7323fd248be42978ceb9e219f0b4101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=l9bzGuLM7S358Pep1XYqMNk04GE%3D" alt="image.png" loading="lazy"/></p>
<p>其次每周的下载数量比较：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031b589864214d159786932ac330fc23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=9Bp8POAuYFn1gTlZWOmhiwD2L78%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49f9a7b333e4d979a9d679340254b26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=QRIHy2JMzg2eFv2LAf1xp%2FDnW5M%3D" alt="image.png" loading="lazy"/></p>
<p>显然，想必用<code>Zustand</code>的可能大概也许应该会居多（单纯看数据来讲）。那么明明<code>Redux</code>才是大哥，为啥被<code>Zustand</code>这个小弟后来居上了？</p>
<p>给大家一个表：</p>



































<table><thead><tr><th>对比项</th><th>Redux（老牌流程派）</th><th>Zustand（新晋清爽党）</th></tr></thead><tbody><tr><td>上手门槛</td><td>高：得记 action type、reducer、Provider 等一堆概念</td><td>低：会用 React Hook 就能写，几行代码起手</td></tr><tr><td>代码量</td><td>多：改个 count 得写 action、reducer 一堆模板代码</td><td>少：创建 store + 组件调用，加起来不到 20 行</td></tr><tr><td>组件里怎么用</td><td>得用 <code>useSelector</code> 取数据 + <code>useDispatch</code> 发动作</td><td>直接 <code>useStore( state =&gt; state.xxx )</code> 一步到位</td></tr><tr><td>要不要包 Provider</td><td>必须包：得用 <code>&lt;Provider store={store}&gt;</code> 裹整个 App</td><td>不用包：组件直接调用 store，省一层嵌套</td></tr><tr><td>适合场景</td><td>大型复杂项目（多人协作、状态逻辑多）</td><td>中小型项目 / 快速开发（想少写代码、快速落地）</td></tr></tbody></table>
<p>相信看完表大家已经很明了了，那么如果还想深入了解的可以自行去搜搜，我们唠嗑就到这，开始今天的学习。</p>
<p>具体资料大家去官网看：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fzustand" target="_blank" title="https://www.npmjs.com/package/zustand" ref="nofollow noopener noreferrer">www.npmjs.com/package/zus…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Freact-redux" target="_blank" title="https://www.npmjs.com/package/react-redux" ref="nofollow noopener noreferrer">www.npmjs.com/package/rea…</a></p>
</blockquote>
<h2 data-id="heading-1">前言</h2>
<p>想象一下：你正在开发一个 <code>React</code> 项目，<strong>Home 组件</strong>要改个数字，<strong>About 组件</strong>得同步显示，<strong>List 组件</strong>还要从接口拉数据 —— 要是每个组件都自己存状态，代码早乱成一锅粥了！今天咱们就用 <code>Zustand</code> 这个<strong>躺平神器</strong>，把这些组件串成丝滑的整体，顺便解锁 React 全局状态的 <strong>“极简玩法”</strong>。</p>
<h3 data-id="heading-2">一、先搭个 “状态仓库”：Zustand 初体验</h3>
<p><code>Zustand</code> 是啥？你可以把它理解成一个 <strong>“共享储物柜”</strong>：组件们不用再互相传 <code>props</code>，直接从这个柜子里拿数据、调方法就行。</p>
<p>首先你需要下载<code>Zustand</code>（在开篇的资料里也可以找到~）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c1d479b2f324448bf69f482aaec11c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=7No%2FHByDB3vEZyN5nYKmCDMeNGs%3D" alt="image.png" loading="lazy"/></p>
<p>先看我们的第一个 “储物格”——<code>count.js</code>（负责管理计数状态）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/count.js</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;

<span class="hljs-comment">// 用 create 造一个“状态仓库”</span>
<span class="hljs-keyword">const</span> useCountStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-comment">// 存数据：初始计数是0，还有个默认年龄19</span>
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">19</span>,
    <span class="hljs-comment">// 存方法：点一下计数+1（set会自动更新视图）</span>
    <span class="hljs-attr">increase</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
    <span class="hljs-comment">// 传个参数，计数直接减val</span>
    <span class="hljs-attr">decrease</span>: <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - val }))
}))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCountStore;
</code></pre>
<p>就这么几行，一个能 <strong>“存数据 + 改数据”</strong> 的全局状态就搞定了 —— 比 Redux 轻量到没朋友！</p>
<h3 data-id="heading-3">二、组件 “抢着用”：状态共享原来这么丝滑</h3>
<p>有了仓库，组件们就能 “按需取货” 了。先看 <strong>Home 组件</strong>（负责操作计数）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/Home.jsx</span>
<span class="hljs-keyword">import</span> useCountStore <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/count.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从仓库里“拿”count数据</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);
    <span class="hljs-comment">// 从仓库里“拿”increase、decrease方法</span>
    <span class="hljs-keyword">const</span> increase = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">increase</span>);
    <span class="hljs-keyword">const</span> decrease = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">decrease</span>);
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 点按钮直接调仓库里的方法，不用传参！ */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increase}</span>&gt;</span>发送-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> decrease(10)}&gt;减少-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>再看 <strong>About 组件</strong>（负责显示计数）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/About.jsx</span>
<span class="hljs-keyword">import</span> useCountStore <span class="hljs-keyword">from</span> <span class="hljs-string">"../store/count"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 同样从仓库拿count，Home改了这里自动更！</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>title-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>点击前：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74aba9ea775b4eac85fa667e5d6f8535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=PnGVL84Z1INxXqVr12EWpGwla0E%3D" alt="image.png" loading="lazy"/></p>
<p>点击<strong>10次发送</strong>后：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62917e087a854c55938ef4bd46edbd8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=OgYsGTWma1nbdx%2BysDOeGq3CSg8%3D" alt="image.png" loading="lazy"/></p>
<p>刷新然后点击<strong>10次减少</strong>后：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18deb8bd80f14cd29519606a94dab509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=t3R2YHZRpQ4DY6WqkwZNIQt4Ijk%3D" alt="image.png" loading="lazy"/></p>
<p>你看你看你看看看，<code>Home</code> 点按钮改了 <strong>count，About</strong> 里的标题直接同步更新 —— 连 props 都不用传，这丝滑感谁用谁知道！</p>
<h3 data-id="heading-4">三、进阶玩法：状态里塞接口请求</h3>
<p>光存数字才哪到哪，<strong>还不够炫</strong>！咱们给仓库加个 “拉接口” 的功能。先写 <code>list.js</code>（负责管理列表数据）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/list.js</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;

<span class="hljs-comment">// 先写个请求接口的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://mock.mengxuegu.com/mock/66585c4db462b81cb3916d3e/songer/songer'</span>);
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>; <span class="hljs-comment">// async函数的return会变成Promise的resolve值</span>
}

<span class="hljs-comment">// 造个存列表的仓库</span>
<span class="hljs-keyword">const</span> useListStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-attr">list</span>: [], <span class="hljs-comment">// 初始列表是空数组</span>
    <span class="hljs-comment">// 存个“拉列表”的方法，里面调用接口</span>
    <span class="hljs-attr">fetchList</span>: <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchApi</span>();
        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">list</span>: res }) <span class="hljs-comment">// 拿到数据后更新list</span>
    }
}))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useListStore;
</code></pre>
<p>然后让 <strong>List 组件</strong> 用这个仓库：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/List.jsx</span>
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> useListStore <span class="hljs-keyword">from</span> <span class="hljs-string">"../store/list"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从仓库拿list数据和fetchList方法</span>
    <span class="hljs-keyword">const</span> list = <span class="hljs-title function_">useListStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">list</span>);
    <span class="hljs-keyword">const</span> fetchList = <span class="hljs-title function_">useListStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">fetchList</span>);

    <span class="hljs-comment">// 组件一加载就调用接口拉数据</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">fetchList</span>()
    }, [])

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 拿到数据直接map渲染 */}
            {list.map((item) =&gt; {
                return <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.name}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            })}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>接口数据就出现在浏览器上啦：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf758c4ca4544619ba6cd21247f969aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=kVQsvN12pi6rGub750QVknFixf0%3D" alt="image.png" loading="lazy"/></p>
<p>打开页面，<strong>List 组件</strong>会自动<strong>拉接口、存数据、渲染列表</strong> —— 状态管理 + 接口请求，一套流程直接在仓库里包圆了！</p>
<h3 data-id="heading-5">四、最后一步：把组件都塞进 App</h3>
<p>最后在 <code>App.jsx</code> 里把这些组件拼起来：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/Home"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/About"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">List</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/List"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Home</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Home</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">About</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">About</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">List</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">List</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b1499e7d82c4051bd978af9f145b954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=z63RmA22UzL7foxHhh9CHbSzEdg%3D" alt="image.png" loading="lazy"/></p>
<p>启动项目，你会看到：About 显示着计数，List 自动渲染接口数据 —— 这就是 <code>Zustand</code> 给 React 带来的 <strong>“状态自由”</strong>！</p>
<h3 data-id="heading-6">总结</h3>
<p><code>Zustand</code> 堪称 React 状态管理的 <strong>“轻骑兵”</strong>：无需写冗余的 reducer、不用嵌套 Provider 包裹组件树，几行代码就能搭建<strong>全局状态仓库</strong>。它剥离了传统状态管理的繁琐仪式感，让我们彻底摆脱模板代码的束缚，聚焦业务本身。</p>
<h2 data-id="heading-7">结语</h2>
<p>相比 <code>Redux</code> 的 “厚重” 和 <code>Context API</code> 在高频更新下的性能短板，<code>Zustand</code> 就像一把恰到好处的 <strong>“瑞士军刀”</strong>，轻巧却锋利，用最简单的方式解决了 React 组件间的状态共享难题，让开发者能把更多精力放在业务逻辑本身，而不是状态管理的 “套路” 里。</p>
<blockquote>
<p><strong>好的工具从来不是炫技的枷锁，而是让开发者回归创造本身的桥梁。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握相关性分析：读懂数据间的“悄悄话”]]></title>    <link>https://juejin.cn/post/7585171571129384996</link>    <guid>https://juejin.cn/post/7585171571129384996</guid>    <pubDate>2025-12-19T08:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585171571129384996" data-draft-id="7585171571129303076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握相关性分析：读懂数据间的“悄悄话”"/> <meta itemprop="keywords" content="Python,数据分析,数据挖掘"/> <meta itemprop="datePublished" content="2025-12-19T08:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握相关性分析：读懂数据间的“悄悄话”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:04:20.000Z" title="Fri Dec 19 2025 08:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据分析的江湖里，我们经常会听到老板或业务方抛出这样的问题：</p>
<ul>
<li>“现在的年轻人越晚睡，买护肤品是不是越疯狂？”</li>
<li>“我们APP的各种优惠券，真的能提升用户的留存率吗？”</li>
<li>“天气越热，这只股票是不是跌得越惨？”</li>
</ul>
<p>面对这些问题，很多新人容易犯 <strong>“凭感觉”</strong> 的错误：“我觉得应该有关系吧……”</p>
<p><strong>数据分析不相信“我觉得”，只相信证据。</strong> 而寻找变量之间关系强弱的这个过程，就叫做<strong>相关分析</strong>。</p>
<p>今天，就带大家把相关分析的工具箱翻个底朝天，从基础到进阶，一次性讲透！</p>
<h2 data-id="heading-0">1. 什么是相关分析？</h2>
<p>简单来说，相关分析就是判断<strong>两个或多个事物之间是否存在某种联系，以及这种联系有多紧密</strong>。</p>
<p>但请务必记住数据分析界的第一铁律：<strong>相关 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo mathvariant="normal">≠</mo></mrow><annotation encoding="application/x-tex">\neq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span></span></span></span></span></strong> 因果</strong>。</p>
<ul>
<li><strong>相关</strong>：公鸡叫了，天亮了。（它俩有关系，经常一起发生）</li>
<li><strong>因果</strong>：因为公鸡叫了，所以天亮了。（这就错了，天亮是因为地球自转，不是因为鸡叫）</li>
</ul>
<p>我们要做的，就是用数值（相关系数）来量化这种“一起发生”的程度。</p>
<h2 data-id="heading-1">2. 数据相关的“三剑客”</h2>
<p><strong>皮尔森相关系数</strong>，<strong>斯皮尔曼相关系数</strong>和<strong>肯达尔相关系数</strong>，这是最常见的三种相关系数，它们处理的是<strong>数值型</strong>或者<strong>有等级顺序</strong>的数据。</p>
<h3 data-id="heading-2">2.1. 皮尔森相关系数：精确测量的标准</h3>
<p><strong>皮尔森相关</strong>是最常用的相关性分析方法，适用于符合以下条件的数据：</p>
<ul>
<li>连续数据（定距或定比尺度）</li>
<li>数据服从正态分布</li>
<li>变量间呈线性关系</li>
</ul>
<p>这是最“挑剔”也是最常用的指标。它要求数据是<strong>连续数值</strong>（定距/定比），并且最好服从<strong>正态分布</strong>（钟形曲线）。它衡量的是<strong>线性关系</strong>（是不是一条直线）。</p>
<p>比如：<strong>身高和体重</strong>。一般来说，人越高，体重越重，这是一个比较标准的线性关系。</p>
<p>它的取值范围从 <code>-1</code> 到 <code>1</code>。接近 1 表示<strong>正相关</strong>（同涨同跌），接近 -1 表示<strong>负相关</strong>（此消彼长），0 表示<strong>没关系</strong>。</p>
<p>代码示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats

<span class="hljs-comment"># 模拟数据：运动时间(小时/周)与体重指数(BMI)</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成100个样本</span>
n_samples = <span class="hljs-number">100</span>
exercise_time = np.random.normal(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, n_samples)  <span class="hljs-comment"># 平均每周运动5小时</span>
<span class="hljs-comment"># BMI与运动时间负相关（运动越多，BMI越低）</span>
bmi = <span class="hljs-number">25</span> - <span class="hljs-number">0.5</span> * exercise_time + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1.5</span>, n_samples)

<span class="hljs-comment"># 创建DataFrame</span>
data = pd.DataFrame({<span class="hljs-string">'运动时间_小时每周'</span>: exercise_time, <span class="hljs-string">'BMI'</span>: bmi})

<span class="hljs-comment"># 计算皮尔森相关系数</span>
pearson_corr, p_value = stats.pearsonr(data[<span class="hljs-string">'运动时间_小时每周'</span>], data[<span class="hljs-string">'BMI'</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"皮尔森相关系数: <span class="hljs-subst">{pearson_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{p_value:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
皮尔森相关系数: -0.614
P值: 0.00000
'''</span>
</code></pre>
<p>图形展示的效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807281bfaebc40d7b2a19fa14a27ceed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=3yShIPrcXp47bU87baG4V6xpya4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 斯皮尔曼相关系数：打破正态分布的限制</h3>
<p>如果数据<strong>不服从正态分布</strong>，或者有<strong>极端值</strong>（比如马云的财富混进了我们的收入数据中），<strong>皮尔森相关系数</strong>就不准了。</p>
<p>这时候用<strong>斯皮尔曼相关系数</strong>。它看重的是排名（Rank），而不是具体数值。</p>
<p>比如语文成绩排名和数学成绩排名，我们不关心具体考了多少分，只关心你的位次。</p>
<p>代码示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：社交媒体表现</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成非正态分布的数据</span>
followers = np.random.exponential(<span class="hljs-number">5000</span>, <span class="hljs-number">50</span>)  <span class="hljs-comment"># 指数分布</span>
likes = <span class="hljs-number">0.1</span> * followers**<span class="hljs-number">1.2</span> + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">50</span>)  <span class="hljs-comment"># 非线性关系</span>

<span class="hljs-comment"># 创建DataFrame</span>
social_data = pd.DataFrame({<span class="hljs-string">"粉丝数"</span>: followers, <span class="hljs-string">"平均点赞数"</span>: likes})

<span class="hljs-comment"># 计算斯皮尔曼相关系数</span>
spearman_corr, spearman_p = stats.spearmanr(
    social_data[<span class="hljs-string">"粉丝数"</span>], social_data[<span class="hljs-string">"平均点赞数"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"斯皮尔曼相关系数: <span class="hljs-subst">{spearman_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{spearman_p:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
斯皮尔曼相关系数: 0.857
P值: 0.00000
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab63f41784814f9c8f0a1e47b02e0253~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=q3vEuk3JjaRI3TN%2BRvOfTqSzBaM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 肯达尔相关系数：小样本和有序数据的首选</h3>
<p><strong>肯达尔相关</strong>也适用于等级数据，与<strong>斯皮尔曼相关</strong>不同，它更关注“和谐对”与“不和谐对”。</p>
<p>通常用于样本量较小，或者数据有很多并列排名的情况。</p>
<p>比如：<strong>两位面试官给5个候选人打分</strong>。我们要看这两位面试官的审美标准是否一致。</p>
<p>代码示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：电影评分与票房</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成有序数据（电影评分和票房排名）</span>
movie_data = pd.DataFrame(
    {
        <span class="hljs-string">"电影名称"</span>: [<span class="hljs-string">f"电影<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)],
        <span class="hljs-string">"评分等级"</span>: np.random.choice(
            [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], <span class="hljs-number">20</span>, p=[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.1</span>]
        ),  <span class="hljs-comment"># 1-5星</span>
        <span class="hljs-string">"票房排名"</span>: np.arange(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>),  <span class="hljs-comment"># 票房排名</span>
    }
)

<span class="hljs-comment"># 添加一些相关性：评分越高，票房排名越好（数字越小）</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(movie_data)):
    <span class="hljs-keyword">if</span> movie_data.loc[i, <span class="hljs-string">"评分等级"</span>] &gt;= <span class="hljs-number">4</span>:
        movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] = <span class="hljs-built_in">max</span>(
            <span class="hljs-number">1</span>, movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] - np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>)
        )
    <span class="hljs-keyword">elif</span> movie_data.loc[i, <span class="hljs-string">"评分等级"</span>] &lt;= <span class="hljs-number">2</span>:
        movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] = <span class="hljs-built_in">min</span>(
            <span class="hljs-number">20</span>, movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] + np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>)
        )

<span class="hljs-comment"># 计算肯德尔相关系数</span>
kendall_corr, kendall_p = stats.kendalltau(
    movie_data[<span class="hljs-string">"评分等级"</span>], movie_data[<span class="hljs-string">"票房排名"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"肯德尔相关系数: <span class="hljs-subst">{kendall_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{kendall_p:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
肯德尔相关系数: -0.503
P值: 0.00460
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3cdb566e334286ab6d44f6d77eef14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=9J3ztbsCmfvXPAjLsnaSRRWqegA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">3. 偏相关分析：谁是“第三者”？</h2>
<p>有时候，两个变量看起来关系很好，其实是因为有“第三者”在捣乱。</p>
<p><strong>偏相关分析</strong>允许我们在控制其他变量的情况下，分析两个变量之间的 <strong>"纯"</strong> 相关性。</p>
<p>比如一个生活中的案例：<strong>“冰淇淋销量”</strong> 和 <strong>“溺水事故数量”</strong>。
数据统计发现，冰淇淋卖得越好的日子，溺水的人越多（相关系数很高）。难道吃冰淇淋会导致溺水？
当然不是！背后的控制变量（第三者）是<strong>气温</strong>。气温高 -&gt; 买冰淇淋多 &amp; 游泳的人多 -&gt; 溺水概率大。</p>
<p>想要正确分析，必须<strong>剔除</strong>控制变量（气温）的影响后，再看另外两个变量（冰淇淋和溺水）是否还相关。</p>
<p>下面的示例中，我们先排除收入影响后，分析教育水平与消费水平的关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用pingouin库进行偏相关分析（需要安装：pip install pingouin）</span>
<span class="hljs-keyword">import</span> pingouin <span class="hljs-keyword">as</span> pg

<span class="hljs-comment"># 模拟数据：教育水平、收入和消费水平</span>
np.random.seed(<span class="hljs-number">42</span>)
n = <span class="hljs-number">100</span>

<span class="hljs-comment"># 教育水平（1-5，5为最高）</span>
education = np.random.choice([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], n, p=[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.1</span>])

<span class="hljs-comment"># 收入与教育水平正相关</span>
income = <span class="hljs-number">30000</span> + <span class="hljs-number">15000</span> * education + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5000</span>, n)

<span class="hljs-comment"># 消费水平与收入和教育水平都相关</span>
consumption = <span class="hljs-number">1000</span> + <span class="hljs-number">0.3</span> * income + <span class="hljs-number">200</span> * education + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>, n)

<span class="hljs-comment"># 创建DataFrame</span>
socioeconomic_data = pd.DataFrame(
    {<span class="hljs-string">"教育水平"</span>: education, <span class="hljs-string">"收入_元每月"</span>: income, <span class="hljs-string">"消费水平"</span>: consumption}
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 简单相关分析 ==="</span>)
simple_corr, simple_p = stats.pearsonr(
    socioeconomic_data[<span class="hljs-string">"教育水平"</span>], socioeconomic_data[<span class="hljs-string">"消费水平"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"教育水平与消费水平的简单相关系数: <span class="hljs-subst">{simple_corr:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 偏相关分析（控制收入）==="</span>)
<span class="hljs-comment"># 使用pingouin进行偏相关分析</span>
partial_corr = pg.partial_corr(
    data=socioeconomic_data, x=<span class="hljs-string">"教育水平"</span>, y=<span class="hljs-string">"消费水平"</span>, covar=<span class="hljs-string">"收入_元每月"</span>
)
<span class="hljs-built_in">print</span>(partial_corr.<span class="hljs-built_in">round</span>(<span class="hljs-number">3</span>))

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
=== 简单相关分析 ===
教育水平与消费水平的简单相关系数: 0.965

=== 偏相关分析（控制收入）===
        n   r    	CI95%       	p-val
pearson	100	0.129	[-0.07, 0.32]	0.204
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05c356bc346492c80d9027872de5fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=R5Erjg6Ohs%2FdKChCd%2FaLIBH3yQQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4. 距离相关分析：多变量关系的度量</h2>
<p><strong>距离相关分析</strong>可以衡量两组变量（每个变量组包含多个指标）之间的相关性，是<strong>多变量分析</strong>的有力工具。</p>
<p>比如<strong>压力与工作效率</strong>（耶克斯-多德森定律）的关系。</p>
<p>压力太小，人会懒散（效率低）；压力太大，人会崩溃（效率低）；只有适度的压力，效率最高。</p>
<p>这是一个 <strong>U型（非线性）</strong> 关系。这时候用<code>Pearson</code>去算，结果可能是<code>0</code>（因为它找不到直线），但其实它们关系很紧密。</p>
<p>下面的示例，比较两个城市的综合发展水平（经济、环境、社会等多维度指标）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> scipy.spatial.distance <span class="hljs-keyword">import</span> pdist, squareform

<span class="hljs-comment"># 模拟数据：两个城市的多维指标</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 城市A和城市B的6个发展指标（经济、环境、教育、医疗、文化、创新）</span>
indicators = [<span class="hljs-string">"经济"</span>, <span class="hljs-string">"环境"</span>, <span class="hljs-string">"教育"</span>, <span class="hljs-string">"医疗"</span>, <span class="hljs-string">"文化"</span>, <span class="hljs-string">"创新"</span>]
city_a = np.array([<span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>, <span class="hljs-number">82</span>, <span class="hljs-number">80</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
city_b = np.array([<span class="hljs-number">88</span>, <span class="hljs-number">75</span>, <span class="hljs-number">87</span>, <span class="hljs-number">92</span>, <span class="hljs-number">79</span>, <span class="hljs-number">85</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)

<span class="hljs-comment"># 创建多个城市的比较数据</span>
cities_data = pd.DataFrame(
    {
        <span class="hljs-string">"城市A"</span>: city_a,
        <span class="hljs-string">"城市B"</span>: city_b,
        <span class="hljs-string">"城市C"</span>: np.array([<span class="hljs-number">70</span>, <span class="hljs-number">85</span>, <span class="hljs-number">75</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>, <span class="hljs-number">72</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
        <span class="hljs-string">"城市D"</span>: np.array([<span class="hljs-number">92</span>, <span class="hljs-number">70</span>, <span class="hljs-number">85</span>, <span class="hljs-number">87</span>, <span class="hljs-number">76</span>, <span class="hljs-number">91</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
        <span class="hljs-string">"城市E"</span>: np.array([<span class="hljs-number">78</span>, <span class="hljs-number">88</span>, <span class="hljs-number">80</span>, <span class="hljs-number">85</span>, <span class="hljs-number">87</span>, <span class="hljs-number">78</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
    },
    index=indicators,
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"各城市发展指标数据："</span>)
<span class="hljs-built_in">print</span>(cities_data.<span class="hljs-built_in">round</span>(<span class="hljs-number">2</span>))


<span class="hljs-comment"># 计算距离相关性（自定义简化版）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">distance_correlation</span>(<span class="hljs-params">x, y</span>):
    <span class="hljs-string">"""计算距离相关性"""</span>

    <span class="hljs-comment"># 计算距离矩阵</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dist_matrix</span>(<span class="hljs-params">v</span>):
        v = np.array(v)
        n = <span class="hljs-built_in">len</span>(v)
        a = np.zeros((n, n))
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
                a[i, j] = <span class="hljs-built_in">abs</span>(v[i] - v[j])
        <span class="hljs-keyword">return</span> a

    A = dist_matrix(x)
    B = dist_matrix(y)

    <span class="hljs-comment"># 双中心化</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">double_centering</span>(<span class="hljs-params">D</span>):
        n = <span class="hljs-built_in">len</span>(D)
        row_means = D.mean(axis=<span class="hljs-number">1</span>)
        col_means = D.mean(axis=<span class="hljs-number">0</span>)
        grand_mean = D.mean()

        C = np.zeros((n, n))
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
                C[i, j] = D[i, j] - row_means[i] - col_means[j] + grand_mean
        <span class="hljs-keyword">return</span> C

    A_centered = double_centering(A)
    B_centered = double_centering(B)

    <span class="hljs-comment"># 计算距离协方差和距离方差</span>
    dCov_XY = np.sqrt((A_centered * B_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))
    dVar_X = np.sqrt((A_centered * A_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))
    dVar_Y = np.sqrt((B_centered * B_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 计算距离相关性</span>
    dCor = dCov_XY / np.sqrt(dVar_X * dVar_Y)

    <span class="hljs-keyword">return</span> dCor


<span class="hljs-comment"># 比较城市A和城市B的距离相关性</span>
city_a_scores = cities_data[<span class="hljs-string">"城市A"</span>].values
city_b_scores = cities_data[<span class="hljs-string">"城市B"</span>].values

dcor = distance_correlation(city_a_scores, city_b_scores)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n城市A与城市B的距离相关性: <span class="hljs-subst">{dcor:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
各城市发展指标数据：
      城市A  城市B  城市C  城市D   城市E
经济  87.48  95.90  71.21  87.46  75.28
环境  77.31  78.84  75.43  62.94  88.55
教育  93.24  84.65  66.38  92.33  74.25
医疗  95.62  94.71  77.19  85.87  86.88
文化  80.83  76.68  84.94  76.34  84.00
创新  78.83  82.67  73.57  83.88  76.54

城市A与城市B的距离相关性: 0.764
'''</span>
</code></pre>
<p>图形化的结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f73a889047344872b76840e6f4a35f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=eWWDkyeMbQLYNviejHsBsAeWT7k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">5. 相关性卡方检验：分类变量的关联分析</h2>
<p>如果我们分析的数据不是数字，而是<strong>类别</strong>（定类数据/低测度数据）呢？</p>
<p>当两个变量都是分类变量（定类数据）时，我们可以使用<strong>卡方检验</strong>来分析它们之间是否存在关联。</p>
<p>比如<strong>性别（男/女）</strong> 与 <strong>爱喝的饮料（奶茶/咖啡）</strong> 是否相关？
这里没有大小之分，只有类别。我们可以使用<strong>卡方检验</strong>来判断两个分类变量是否独立。</p>
<p>下面的示例，我们尝试分析性别与购物偏好类别之间的关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：性别与购物偏好</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 创建列联表</span>
data = pd.DataFrame(
    {
        <span class="hljs-string">"性别"</span>: np.random.choice([<span class="hljs-string">"男"</span>, <span class="hljs-string">"女"</span>], <span class="hljs-number">200</span>),
        <span class="hljs-string">"购物偏好"</span>: np.random.choice(
            [<span class="hljs-string">"电子产品"</span>, <span class="hljs-string">"服装鞋包"</span>, <span class="hljs-string">"美妆护肤"</span>, <span class="hljs-string">"运动户外"</span>, <span class="hljs-string">"家居生活"</span>], <span class="hljs-number">200</span>
        ),
    }
)

<span class="hljs-comment"># 根据性别调整偏好概率（创建一些关联）</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):
    <span class="hljs-keyword">if</span> data.loc[i, <span class="hljs-string">"性别"</span>] == <span class="hljs-string">"男"</span>:
        <span class="hljs-comment"># 男性更可能偏好电子产品和运动户外</span>
        <span class="hljs-keyword">if</span> np.random.random() &lt; <span class="hljs-number">0.3</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"电子产品"</span>
        <span class="hljs-keyword">elif</span> np.random.random() &lt; <span class="hljs-number">0.5</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"运动户外"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 女性更可能偏好美妆护肤和服装鞋包</span>
        <span class="hljs-keyword">if</span> np.random.random() &lt; <span class="hljs-number">0.3</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"美妆护肤"</span>
        <span class="hljs-keyword">elif</span> np.random.random() &lt; <span class="hljs-number">0.4</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"服装鞋包"</span>

<span class="hljs-comment"># 创建列联表</span>
contingency_table = pd.crosstab(data[<span class="hljs-string">"性别"</span>], data[<span class="hljs-string">"购物偏好"</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"性别与购物偏好的列联表："</span>)
<span class="hljs-built_in">print</span>(contingency_table)

<span class="hljs-comment"># 执行卡方检验</span>
chi2, p, dof, expected = stats.chi2_contingency(contingency_table)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n卡方检验结果："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"卡方值: <span class="hljs-subst">{chi2:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{p:<span class="hljs-number">.5</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自由度: <span class="hljs-subst">{dof}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n期望频数表："</span>)
<span class="hljs-built_in">print</span>(
    pd.DataFrame(
        expected, index=contingency_table.index, columns=contingency_table.columns
    ).<span class="hljs-built_in">round</span>(<span class="hljs-number">2</span>)
)


<span class="hljs-comment"># 计算Cramer's V（衡量分类变量关联强度）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cramers_v</span>(<span class="hljs-params">contingency_table</span>):
    <span class="hljs-string">"""计算Cramer's V系数"""</span>
    chi2 = stats.chi2_contingency(contingency_table)[<span class="hljs-number">0</span>]
    n = contingency_table.<span class="hljs-built_in">sum</span>().<span class="hljs-built_in">sum</span>()
    min_dim = <span class="hljs-built_in">min</span>(contingency_table.shape) - <span class="hljs-number">1</span>

    v = np.sqrt(chi2 / (n * min_dim))
    <span class="hljs-keyword">return</span> v


cramers_v_value = cramers_v(contingency_table)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nCramer's V系数: <span class="hljs-subst">{cramers_v_value:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"解读：0.1-0.3弱相关，0.3-0.5中等相关，&gt;0.5强相关"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
性别与购物偏好的列联表：
购物偏好  家居生活  服装鞋包  电子产品  美妆护肤  运动户外
性别
女        2    33    15    40    10
男       10     2    45    10    33

卡方检验结果：
卡方值: 78.093
P值: 0.00000
自由度: 4

期望频数表：
购物偏好  家居生活  服装鞋包  电子产品  美妆护肤  运动户外
性别
女      6.0  17.5  30.0  25.0  21.5
男      6.0  17.5  30.0  25.0  21.5

Cramer's V系数: 0.625
解读：0.1-0.3弱相关，0.3-0.5中等相关，&gt;0.5强相关
'''</span>
</code></pre>
<p>图形化的结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0266aa89fc7c433f9b792be686590296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=gtzddsW3L%2B7D3U5jiRPAUjvfqAA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">6. 总结</h2>
<p>数据分析师在面对变量关系时，要根据数据的 <strong>“长相”</strong> 来选工具：</p>








































<table><thead><tr><th>方法</th><th>适用数据类型</th><th>特点</th></tr></thead><tbody><tr><td>皮尔森相关</td><td>连续、正态分布、线性关系</td><td>最常用，对异常值敏感</td></tr><tr><td>斯皮尔曼相关</td><td>连续但不正态，或有序数据</td><td>稳健，适用于单调关系</td></tr><tr><td>肯德尔相关</td><td>有序数据，小样本</td><td>适合等级数据，解释直观</td></tr><tr><td>偏相关</td><td>需控制其他变量影响</td><td>揭示变量间的直接关系</td></tr><tr><td>距离相关</td><td>多变量组间关系</td><td>衡量多维度综合关联</td></tr><tr><td>卡方检验</td><td>分类变量</td><td>检验类别间关联性</td></tr></tbody></table>
<p>我们在分析数据相关性的时候，不要急于得出数据之间是否相关的结论。</p>
<p>先看看下面的注意事项是否有违背！</p>
<ol>
<li><strong>相关性不等于因果性</strong>：即使两个变量高度相关，也不能断定一个导致另一个</li>
<li><strong>警惕第三变量问题</strong>：可能两个变量都受到第三个未测量变量的影响</li>
<li><strong>注意异常值的影响</strong>：异常值可能夸大或掩盖真实的相关性</li>
<li><strong>检查线性假设</strong>：皮尔森相关要求线性关系，非线性关系需要其他方法</li>
<li><strong>样本大小的重要性</strong>：小样本的相关性可能不稳定</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优]]></title>    <link>https://juejin.cn/post/7585283741540204590</link>    <guid>https://juejin.cn/post/7585283741540204590</guid>    <pubDate>2025-12-19T01:52:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585283741540204590" data-draft-id="7585289701792497690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优"/> <meta itemprop="keywords" content="后端,大数据,Logstash"/> <meta itemprop="datePublished" content="2025-12-19T01:52:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T01:52:19.000Z" title="Fri Dec 19 2025 01:52:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：Logstash 过滤后需要稳定输出到控制台、文件、Elasticsearch，并支持多路复用与条件路由</li>
<li>结论：Output 阶段决定吞吐、可靠性与可观测性；参数（批量/重试/缓冲）比“能跑”更关键</li>
<li>产出：3 类输出最小可用配置 + 生产组合范式 + 性能与故障速查卡</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8748c160b3244759c27b19541a9eab0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=bZuXnjEh39FYUmGkDpH2WPln%2BgY%3D" alt="大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





































<table><thead><tr><th>组件/能力</th><th>已验证说明</th></tr></thead><tbody><tr><td>Logstash版本</td><td>7.3.0</td></tr><tr><td>示例目录结构</td><td><code>/opt/servers/logstash-7.3.0</code></td></tr><tr><td>stdout输出</td><td>使用rubydebug codec进行stdin联调与字段验收（最快闭环方式）</td></tr><tr><td>file输出</td><td>配置为<code>codec =&gt; line</code>格式，动态路径模板<code>%{+YYYY-MM-dd}-%{host}.txt</code></td></tr><tr><td>Elasticsearch输出</td><td>基础写入配置已给出（未标注ES版本，注意7/8版本差异会影响type/参数）</td></tr><tr><td>条件路由</td><td>支持（概念验证）</td></tr><tr><td>多输出并行</td><td>支持（需配合生产环境的队列/重试策略定型）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b0208dcbeb455a898c5b99d790cee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=Ka0vyOKygEXjvWyP0QepKkpLFTI%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">Output插件</h2>
<p>Logstash Output 插件是 Logstash 管道中的最后一个阶段，负责将处理后的数据输出到各种目标系统或存储设备。每一个输出插件都能将 Logstash 接收到并解析的数据发送到不同的外部服务，如数据库、消息队列、搜索引擎、文件系统等。</p>
<h3 data-id="heading-3">工作原理</h3>
<p>Logstash 的输出插件（Output Plugins）是数据处理流程的关键环节，负责将经过过滤处理的事件数据高效可靠地推送到各类外部系统。作为 Logstash 管道的最终阶段，输出插件支持多种数据目的地和传输协议，能够满足不同场景下的数据存储和分析需求。</p>
<p>常见的输出插件类型包括：</p>
<ol>
<li>
<p><strong>存储系统输出</strong>：</p>
<ul>
<li>Elasticsearch 输出插件（最常用）：将数据索引到 Elasticsearch 集群，支持批量提交和自动重试</li>
<li>文件输出插件：将事件写入本地文件系统，支持文件轮转和压缩</li>
<li>数据库输出插件：支持 MySQL、PostgreSQL 等关系型数据库</li>
</ul>
</li>
<li>
<p><strong>消息队列输出</strong>：</p>
<ul>
<li>Kafka 输出插件：将数据发布到 Kafka 主题</li>
<li>RabbitMQ 输出插件：通过 AMQP 协议发送消息</li>
</ul>
</li>
<li>
<p><strong>云服务输出</strong>：</p>
<ul>
<li>Amazon S3 输出插件：将日志存档到 S3 存储桶</li>
<li>Google Cloud Storage 输出插件</li>
</ul>
</li>
<li>
<p><strong>监控系统输出</strong>：</p>
<ul>
<li>Prometheus 输出插件</li>
<li>Nagios 输出插件</li>
</ul>
</li>
</ol>
<p>输出插件通常提供以下关键特性：</p>
<ul>
<li>批量处理能力（bulk processing）</li>
<li>自动重试机制（retry on failure）</li>
<li>负载均衡支持（multiple endpoints）</li>
<li>数据格式转换（如 JSON、CSV 等）</li>
</ul>
<p>配置示例（输出到 Elasticsearch）：</p>
<pre><code class="hljs language-ruby" lang="ruby">output {
  elasticsearch {
    hosts =&gt; [<span class="hljs-string">"http://localhost:9200"</span>]
    index =&gt; <span class="hljs-string">"applogs-%{+YYYY.MM.dd}"</span>
    document_type =&gt; <span class="hljs-string">"_doc"</span>
    retry_on_failure =&gt; <span class="hljs-number">3</span>
  }
}
</code></pre>
<p>在实际生产环境中，通常会采用多输出插件组合的方式，比如同时输出到 Elasticsearch 进行实时分析和文件系统进行长期归档。输出插件的性能调优（如批量大小、工作线程数等参数）对整体数据处理效率有重要影响。</p>
<h3 data-id="heading-4">主要功能</h3>
<ul>
<li>多种输出目标：支持广泛的输出目标，如 Elasticsearch、Kafka、RabbitMQ、Amazon S3、文件、HTTP、数据库等。</li>
<li>批处理：在某些情况下，输出插件可以批量发送数据，而非逐条处理，从而提高性能。例如，Elasticsearch 插件可以配置批量请求，以优化写入性能。</li>
<li>数据格式化：插件能够根据需要以特定格式（如 JSON、CSV、Plaintext）输出数据。</li>
<li>重试机制：某些输出插件具有自动重试功能，确保在网络故障或系统不稳定时数据不会丢失。</li>
<li>动态路由：可以根据事件的内容动态决定数据输出到哪个目标系统。通过条件语句，可以对不同类型的数据使用不同的输出路径。</li>
<li>插件配置灵活性：每个插件都有丰富的配置选项，可以定制行为，比如指定目标主机、端口、身份验证机制、缓冲设置、批处理参数等。</li>
</ul>
<h3 data-id="heading-5">高级功能</h3>
<ul>
<li>
<p><strong>输出负载均衡</strong>：Logstash 提供了强大的负载均衡功能，可以配置多个输出目标（如多个 Elasticsearch 节点或多个 Kafka 代理）。Logstash 会自动将数据轮询分发到这些目标，避免单点故障并提高数据传输的吞吐量。例如，在生产环境中可以配置 3 个 Elasticsearch 节点作为输出目标，Logstash 会均匀地将日志事件分发到这些节点，既提高了系统的可用性，又实现了读写负载的均衡分配。</p>
</li>
<li>
<p><strong>事件条件判断</strong>：Logstash 支持使用条件语句（如 if/else）对事件进行过滤和路由。可以根据事件字段值动态决定输出目标，实现精细化的日志分发策略。典型应用场景包括：</p>
<ul>
<li>将 ERROR 级别的日志发送到专门的告警系统</li>
<li>将不同业务线的日志路由到不同的 Elasticsearch 索引</li>
<li>示例配置：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">    output {
      <span class="hljs-keyword">if</span> [log_level] == <span class="hljs-string">"ERROR"</span> {
        elasticsearch { ... } <span class="hljs-comment"># 错误日志专用管道</span>
      } <span class="hljs-keyword">else</span> {
        kafka { ... } <span class="hljs-comment"># 普通日志管道</span>
      }
    }
</code></pre>
<ul>
<li><strong>插件组合输出</strong>：Logstash 支持在单个管道中并行使用多个输出插件，实现数据的多路复用。常见组合方式包括：
<ul>
<li>存储+转发组合：同时写入 Elasticsearch 和 Kafka</li>
<li>主备方案：主要输出到 Elasticsearch，备用输出到文件系统</li>
<li>监控方案：在业务输出的同时，将统计指标发送到 Prometheus</li>
<li>典型配置示例：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">    output {
      elasticsearch { ... } <span class="hljs-comment"># 主要存储</span>
      kafka { 
        topic_id =&gt; <span class="hljs-string">"log_backup"</span> <span class="hljs-comment"># 消息队列备份</span>
      }
      file {
        path =&gt; <span class="hljs-string">"/var/log/logstash/archive.log"</span> <span class="hljs-comment"># 本地归档</span>
      }
    }
</code></pre>
<h3 data-id="heading-6">常见问题</h3>
<ul>
<li>
<p><strong>网络问题</strong>：由于输出插件大多与外部系统交互，网络问题可能导致输出失败。常见的网络问题包括：</p>
<ul>
<li>连接超时（如默认 30 秒未建立连接）</li>
<li>带宽限制导致数据传输缓慢</li>
<li>防火墙或安全组策略阻止访问</li>
<li>DNS 解析失败
应对方案：</li>
<li>重试机制（如指数退避重试，初始间隔 1 秒，最大重试 5 次）</li>
<li>内存/磁盘缓冲（如设置 500MB 内存缓冲区，溢出时写入临时文件）</li>
<li>心跳检测（每 60 秒发送 ping 包检测连接状态）</li>
</ul>
</li>
<li>
<p><strong>性能瓶颈</strong>：某些输出插件（例如 Elasticsearch、Kafka）在高并发场景下需要调整批处理和缓冲参数：</p>
<ul>
<li>Elasticsearch 场景：
<ul>
<li>建议批量大小设置为 500-1000 条/批次</li>
<li>并发 worker 数建议为 CPU 核数的 1.5 倍</li>
<li>启用压缩传输（设置 gzip 压缩级别为 6）</li>
</ul>
</li>
<li>Kafka 场景：
<ul>
<li>调整 linger.ms 参数（建议 50-100ms）</li>
<li>设置 batch.size 为 16384-32768 字节</li>
<li>配置 acks=1 平衡可靠性与性能</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>数据格式问题</strong>：输出的数据格式需要与目标系统兼容，典型场景包括：</p>
<ul>
<li>数据库写入：
<ul>
<li>字段类型映射（如将日志中的字符串 "123" 转换为 INTEGER 类型）</li>
<li>时间格式转换（UTC 时间转本地时区）</li>
<li>处理字段缺失（设置默认值或跳过空字段）</li>
</ul>
</li>
<li>API 对接：
<ul>
<li>遵循 OpenAPI 规范定义数据结构</li>
<li>处理嵌套 JSON（展平或保留层级结构）</li>
<li>添加必要的请求头（如 Content-Type: application/json）</li>
</ul>
</li>
<li>特殊字符处理：
<ul>
<li>转义单引号（' → '）</li>
<li>处理换行符（\n → \n）</li>
<li>编码非 ASCII 字符（使用 UTF-8 编码）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">标准输出到控制台</h3>
<p>将收集到的数据直接打印到控制台：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -e 'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'
</code></pre>
<p>运行之后，对应的结果如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d36ea0cd5f4038be6f9aa8878f0446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=6XkqaeSbMDa7Ocfe0%2FJ72%2FWbPqo%3D" alt="Logstash Output" loading="lazy"/></p>
<h3 data-id="heading-8">采集的数据保存到文件中</h3>
<h4 data-id="heading-9">需求描述</h4>
<p>Logstash也可以将收集到的数据写入到文件当中去保存，接下来我们看看Logstash如何配置以实现将数据写入到文件当中。</p>
<h4 data-id="heading-10">编写配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim output_file.conf
</code></pre>
<p>写入的内容如下：</p>
<pre><code class="hljs language-shell" lang="shell">input {stdin{}}
output {
  file {
    path =&gt; "/opt/servers/es/%{+YYYY-MM-dd}-%{host}.txt"
    codec =&gt; line {
      format =&gt; "%{message}"
    }
    flush_interval =&gt; 0
  }
}
</code></pre>
<p>写入的内容截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6cdb1ad77b1439bb32916ef80c6a4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=fxuPvsR757pJhJb6Iycq5lIMDl4%3D" alt="Logstash Input output" loading="lazy"/></p>
<h4 data-id="heading-11">检查配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_file.conf -t 
</code></pre>
<p>检查结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b5f51d84ae74a49a35d1cf6fba42def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=LekDXzNwxb%2BuOekwgNGJT5ZsIpU%3D" alt="Logstash 检测配置" loading="lazy"/></p>
<h4 data-id="heading-12">启动配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_file.conf
</code></pre>
<p>启动的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c0d5bcc696e47e2a8a723264f1b5561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=1G3AjtyQvw%2FJSIxoCu%2BkXe09zNg%3D" alt="Logstash 启动配置" loading="lazy"/></p>
<h4 data-id="heading-13">测试数据</h4>
<p>我们在控制台中输入一些测试的内容，然后查看输出的文件的内容：</p>
<pre><code class="hljs language-shell" lang="shell">hello wzk icu!
</code></pre>
<p>查看的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f6c9154f824381949316ba04460ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=zCOzVVfY62ws8gby6CEHoyO9wqc%3D" alt="Logstash 测试数据" loading="lazy"/></p>
<h4 data-id="heading-14">查看内容：</h4>
<pre><code class="hljs language-shell" lang="shell">cat /opt/servers/es/2024-08-19-h121.wzk.icu.txt
</code></pre>
<p>结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48e25d6a2c24ef7bcf65fa36a2a20c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=mBb1k9eMR%2F86%2FGseWRRofa3OBPQ%3D" alt="Logstash 查看内容" loading="lazy"/></p>
<h3 data-id="heading-15">采集数据保存到Elasticsearch</h3>
<h4 data-id="heading-16">需求描述</h4>
<p>不过多描述，主要就是把收集到的数据写入到Elasticsearch中。</p>
<h4 data-id="heading-17">编写配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim output_es.conf
</code></pre>
<p>写入的内容如下：</p>
<pre><code class="hljs language-shell" lang="shell">input {stdin{}}
output {
  elasticsearch {
    hosts =&gt; ["h121.wzk.icu:9200"]
    index =&gt; "logstash-%{+YYYY.MM.dd}"
  }
}
</code></pre>
<p>对应的截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c5341a4c1a4e6783a11b548ce18def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=2L15rvxruHxjJRmfiG5s4ii%2Bz88%3D" alt="Logstash 配置数据到 ES" loading="lazy"/></p>
<p>注意：这个index是保存到Elasticsearch的索引名称，如何命名是非常重要的，因为我们后续可能有某些需求做查询，所以最好带上时间。</p>
<h4 data-id="heading-18">检查配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_es.conf -t
</code></pre>
<p>运行的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdcf04309f874493b5babd84787078bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=afdoBa0cHdQdhlN4W2j1XT500wo%3D" alt="Logstash 检查配置" loading="lazy"/></p>
<h4 data-id="heading-19">启动配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_es.conf
</code></pre>
<p>启动结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a537c873520b4989bb1e1149feac6e20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=zto30a32tikftmYr0XoBtg1oqoY%3D" alt="Logstash 启动配置" loading="lazy"/></p>
<h4 data-id="heading-20">测试数据</h4>
<p>向控制台写入 hello wzk icu !
查看ES集群中的数据如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93fea0d214f14982abcc608ed7536080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=bT6ZaWfD7T%2Biz5Z3IbKmGYX%2FZ%2Bs%3D" alt="Logstash 测试数据" loading="lazy"/></p>
<h2 data-id="heading-21">错误速查</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>启动成功但 stdout 没输出</td><td>stdin 无输入/管道未加载目标 conf/多管道覆盖</td><td>bin/logstash -t；启动日志里确认 pipeline 与 conf 路径指定 -f 到正确 conf；用 stdin{} 直接输入验证</td></tr><tr><td>file 输出无文件/文件为空</td><td>目录不存在/权限不足/字段缺失导致路径渲染异常</td><td>看 Logstash 日志报错；确认目标目录与用户权限预创建目录并授权；路径字段改为稳定值（或给 host 默认值）</td></tr><tr><td>ES 连接超时/拒绝连接</td><td>hosts 不通、端口/防火墙、协议/域名解析问题</td><td>curl -sS <a href="https://link.juejin.cn?target=http%3A%2F%2Fhost%3A9200%25EF%25BC%259BLogstash" target="_blank" title="http://host:9200%EF%BC%9BLogstash" ref="nofollow noopener noreferrer">http://host:9200；Logstash</a> 日志里 connection error hosts 写全协议与端口；放通网络；修正 DNS/安全组</td></tr><tr><td>ES 返回 401/403</td><td>开了安全认证但未配 user/pass 或证书</td><td>ES 响应码与响应体；Logstash 输出插件报 auth 配置 user/password 或 API Key；TLS 配置证书</td></tr><tr><td>写入失败：mapper_parsing_exception</td><td>字段类型漂移（string↔number/date）、动态映射冲突</td><td>ES 返回的 bulk item error；查看 index template/mapping 固定 mapping（模板/组件模板）；在 filter 阶段做类型转换与字段清洗</td></tr><tr><td>写入失败：bulk 413/请求过大</td><td>单批次过大/事件体积过大/网关限制</td><td>ES/代理返回 413；Logstash 重试但持续失败 降低批量大小；启用压缩；拆分大字段或截断</td></tr><tr><td>吞吐低、CPU 高、延迟抖动</td><td>flush 过频、批量太小、并发不匹配、下游慢</td><td>观察 pipeline throughput；看 JVM/GC/队列积压 调大批量与并发；合理 flush；必要时启用持久队列/背压策略</td></tr><tr><td>重试后仍丢数据/重复数据</td><td>无持久化队列、下游短暂故障、幂等策略缺失</td><td>看 Logstash persistent queue 是否开启；ES 是否幂等写入 开启 PQ；用稳定 document_id 做幂等；为失败事件加旁路输出</td></tr></tbody></table>
<h2 data-id="heading-22">其他系列</h2>
<h3 data-id="heading-23">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-24">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-196 消息队列选型：RabbitMQ vs RocketMQ vs Kafka</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-25">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 错误使用事务导致数据可见性问题分析]]></title>    <link>https://juejin.cn/post/7585112748897091627</link>    <guid>https://juejin.cn/post/7585112748897091627</guid>    <pubDate>2025-12-19T03:53:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585112748897091627" data-draft-id="7585091990347382820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 错误使用事务导致数据可见性问题分析"/> <meta itemprop="keywords" content="Spring Boot,数据库"/> <meta itemprop="datePublished" content="2025-12-19T03:53:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jaising666"/> <meta itemprop="url" content="https://juejin.cn/user/2418581311850301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 错误使用事务导致数据可见性问题分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581311850301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jaising666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T03:53:26.000Z" title="Fri Dec 19 2025 03:53:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>继续，案例同样来自于企业级代码，这里是一个错误使用事务导致的故障。</p>
<p>因为网络隔离，两个服务依赖于同一个数据库做数据传递，一个服务开启事务写入数据并通知另一个服务，另一个服务收到通知后更新数据。故障现象是两个服务和数据库都没有明显异常，但会偶尔发生数据未被更新。</p>
<p>经过排查确认第一个服务事务未被正确使用，如果第二个服务消费数据快于第一个服务事务提交速度就会发生数据更新丢失的问题，下面对问题做了抽象简要回顾。</p>
<hr/>
<h2 data-id="heading-1">1. 问题发生原因：单个事务控制不当导致调用服务更新丢失</h2>
<h3 data-id="heading-2">1.1 问题场景描述</h3>
<p>在典型的业务场景中，需要先创建数据记录，然后调用外部服务进行后续处理。错误的实现将数据库操作和外部服务调用放在同一个事务中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误的实现方式</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBusinessRequest</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
    <span class="hljs-comment">// 1. 在事务中创建数据库记录</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> createBusinessRecord(request, operator);
    
    <span class="hljs-comment">// 2. 在同一事务中调用外部服务</span>
    callExternalService(taskId, request); <span class="hljs-comment">// 问题发生点</span>
}
</code></pre>
<h3 data-id="heading-3">1.2 问题表现</h3>
<ol>
<li><strong>数据可见性问题</strong>：外部服务查询不到刚创建的业务记录</li>
<li><strong>业务逻辑错误</strong>：外部服务基于空数据执行错误的业务逻辑</li>
<li><strong>数据状态不一致</strong>：本地认为数据已创建，外部服务认为数据不存在</li>
<li><strong>性能问题</strong>：长时间持有数据库锁，影响并发性能</li>
</ol>
<hr/>
<h2 data-id="heading-4">2. 问题根本原因：事务传播机制与隔离机制</h2>
<h3 data-id="heading-5">2.1 事务隔离级别机制</h3>
<h4 data-id="heading-6">READ COMMITTED隔离级别（Spring与MySQL默认配置）</h4>
<p><strong>READ COMMITTED规则：</strong></p>
<ul>
<li>只能读取<strong>已提交</strong>的数据</li>
<li>防止脏读，但允许不可重复读</li>
<li>未提交的事务对其他事务不可见</li>
</ul>
<h4 data-id="heading-7">MVCC多版本并发控制</h4>
<pre><code class="hljs language-ini" lang="ini">数据版本链机制：
时间点1: 事务A开始 (<span class="hljs-attr">TxID</span>=<span class="hljs-number">100</span>)
时间点2: INSERT batch_001 -&gt; <span class="hljs-section">[batch_001@100, 未提交]</span> -&gt; <span class="hljs-section">[空表@0, 已提交]</span>
时间点3: 事务B查询 (<span class="hljs-attr">TxID</span>=<span class="hljs-number">101</span>) -&gt; 只能看到已提交版本 -&gt; 返回空表
时间点4: 事务A提交 -&gt; <span class="hljs-section">[batch_001@100, 已提交]</span> -&gt; 所有事务可见
</code></pre>
<h3 data-id="heading-8">2.2 事务传播机制</h3>
<h4 data-id="heading-9">REQUIRED传播行为（默认）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 默认 propagation = Propagation.REQUIRED</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 外层事务开始</span>
    innerMethod(); <span class="hljs-comment">// 加入外层事务，不会创建新事务</span>
    <span class="hljs-comment">// 外层事务结束时才提交</span>
}

<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 数据库操作在外层事务中执行</span>
    <span class="hljs-comment">// 此时数据对外部不可见</span>
}
</code></pre>
<h4 data-id="heading-10">问题时序分析</h4>
<pre><code class="hljs language-sql" lang="sql">时间轴    应用A(事务中)              外部服务B                数据库MVCC
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">1</span>   <span class="hljs-keyword">BEGIN</span> TRANSACTION            <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 创建事务A(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">2</span>   <span class="hljs-keyword">INSERT</span> business_task         <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 写入数据(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>,未提交)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 版本链: [task_001<span class="hljs-variable">@100</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> [空<span class="hljs-variable">@0</span>]
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">3</span>   HTTP调用外部服务 <span class="hljs-comment">-----------&gt; | 查询业务上下文          |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">4</span>                                 <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> task_001 <span class="hljs-comment">-----&gt; | 新事务B(TxID=101)</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> READ_committed规则:
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 只能读取已提交数据
  <span class="hljs-number">5</span>                                 <span class="hljs-operator">|</span> <span class="hljs-operator">&lt;</span><span class="hljs-comment">-- 返回空结果 -------- | task_001@100未提交,不可见</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">6</span>                                 <span class="hljs-operator">|</span> 基于空数据执行业务逻辑   <span class="hljs-operator">|</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">7</span>   外部服务完成 <span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------- | 返回处理结果            |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">8</span>   <span class="hljs-keyword">COMMIT</span> <span class="hljs-comment">-----------------&gt; |                       | 提交事务A</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">9</span>   业务状态不一致！              <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 数据现在可见，但外部服务
      本地：任务已创建              <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 已基于"无数据"执行完毕
      外部：基于空数据处理          <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
</code></pre>
<h3 data-id="heading-11">2.3 技术验证</h3>
<p>可以通过SQL直接验证隔离机制：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 会话1：模拟应用事务</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> business_task (task_id, status) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'task_001'</span>, <span class="hljs-string">'PENDING'</span>);
<span class="hljs-comment">-- 不提交事务</span>

<span class="hljs-comment">-- 会话2：模拟外部服务查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> business_task <span class="hljs-keyword">WHERE</span> task_id <span class="hljs-operator">=</span> <span class="hljs-string">'task_001'</span>;
<span class="hljs-comment">-- 结果：Empty set (READ COMMITTED隔离机制)</span>

<span class="hljs-comment">-- 会话1：提交事务</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 会话2：再次查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> business_task <span class="hljs-keyword">WHERE</span> task_id <span class="hljs-operator">=</span> <span class="hljs-string">'task_001'</span>;
<span class="hljs-comment">-- 结果：现在能查询到数据了</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">3. 修复方法：使用Self注入完成事务代理</h2>
<h3 data-id="heading-13">3.1 基于代理的事务原理</h3>
<h4 data-id="heading-14">Spring AOP事务代理机制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring为Service类创建的代理对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl$$SpringProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> {
    
    <span class="hljs-keyword">private</span> BusinessServiceImpl target; <span class="hljs-comment">// 真实对象</span>
    <span class="hljs-keyword">private</span> TransactionInterceptor transactionInterceptor; <span class="hljs-comment">// 事务拦截器</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createDistributionRecordsInTransaction</span><span class="hljs-params">(ScriptDeployDTO deployDTO, String operator)</span> {
        <span class="hljs-comment">// 1. 事务拦截器开始事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(transactionDefinition);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 调用真实对象的方法</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> target.createDistributionRecordsInTransaction(deployDTO, operator);
            
            <span class="hljs-comment">// 3. 提交事务</span>
            transactionManager.commit(status);
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 4. 回滚事务</span>
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h4 data-id="heading-15">内部方法调用的问题</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deployScript</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ❌ 直接调用内部方法，绕过了代理对象</span>
        createRecords(); <span class="hljs-comment">// 事务注解不生效！</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRecords</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 事务不会开启，因为没有通过代理调用</span>
    }
}
</code></pre>
<h3 data-id="heading-16">3.2 Self注入解决方案</h3>
<h4 data-id="heading-17">正确的实现方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BusinessServiceImpl self; <span class="hljs-comment">// 注入代理对象</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBusinessRequest</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
        <span class="hljs-comment">// 1. 通过代理对象调用，确保事务生效</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> self.createBusinessRecordInTransaction(request, operator);
        <span class="hljs-comment">// 第一个事务在这里提交，数据立即可见</span>
        
        <span class="hljs-comment">// 2. 事务提交后调用外部服务</span>
        callExternalService(taskId, request);
    }
    
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createBusinessRecordInTransaction</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
        <span class="hljs-keyword">return</span> createBusinessRecord(request, operator);
    } <span class="hljs-comment">// 事务在此处提交</span>
}
</code></pre>
<h4 data-id="heading-18">Self注入的技术原理</h4>
<ol>
<li>
<p><strong>Spring容器管理</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring容器中的Bean定义</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> BusinessServiceImpl <span class="hljs-title function_">BusinessService</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> Proxy.newProxyInstance(
        classLoader,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{BusinessService.class},
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionInvocationHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessServiceImpl</span>())
    );
}
</code></pre>
</li>
<li>
<p><strong>代理对象注入</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BusinessServiceImpl self; 
<span class="hljs-comment">// 注入的是代理对象，包含事务拦截逻辑</span>
</code></pre>
</li>
<li>
<p><strong>事务拦截流程</strong>：</p>
<pre><code class="hljs language-java" lang="java">self.createDistributionRecordsInTransaction() 
-&gt; TransactionInterceptor.invoke()
-&gt; PlatformTransactionManager.getTransaction()
-&gt; 目标方法执行
-&gt; PlatformTransactionManager.commit()
</code></pre>
</li>
</ol>
<h3 data-id="heading-19">3.3 修复后的完整时序</h3>
<pre><code class="hljs language-sql" lang="sql">时间轴    应用A                     外部服务B                数据库MVCC
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">1</span>   调用self.createRecords()     <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">2</span>   <span class="hljs-keyword">BEGIN</span> TRANSACTION            <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 创建事务A(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">3</span>   <span class="hljs-keyword">INSERT</span> distribution_result   <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 写入数据(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">4</span>   <span class="hljs-keyword">COMMIT</span> <span class="hljs-comment">-----------------&gt; |                       | 提交事务A</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 数据对所有事务可见
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">5</span>   HTTP调用外部服务 <span class="hljs-comment">-----------&gt; | 立即回调查询            |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">6</span>                                 <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> batch_001 <span class="hljs-comment">----&gt; | 新事务B(TxID=101)</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 能读取已提交数据
  <span class="hljs-number">7</span>                                 <span class="hljs-operator">|</span> <span class="hljs-operator">&lt;</span><span class="hljs-comment">-- 返回数据 --------- | 返回batch_001记录</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">8</span>   外部服务成功 <span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------- |                       |</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">4. 事务常见使用错误与最佳实践</h2>
<h3 data-id="heading-21">4.1 常见错误模式</h3>
<h4 data-id="heading-22">错误1：内部方法调用事务失效</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerUser</span><span class="hljs-params">(User user)</span> {
        validateUser(user);
        saveUser(user); <span class="hljs-comment">// 事务不生效</span>
        sendEmail(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        userMapper.insert(user);
    }
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService self;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerUser</span><span class="hljs-params">(User user)</span> {
        validateUser(user);
        self.saveUser(user); <span class="hljs-comment">// 通过代理调用，事务生效</span>
        sendEmail(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        userMapper.insert(user);
    }
}
</code></pre>
<h4 data-id="heading-23">错误2：长事务包含外部调用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
    <span class="hljs-comment">// 数据库操作</span>
    orderMapper.insert(order);
    
    <span class="hljs-comment">// 外部服务调用（可能很慢）</span>
    paymentService.processPayment(order); <span class="hljs-comment">// 持有数据库锁</span>
    
    <span class="hljs-comment">// 更多数据库操作</span>
    orderMapper.updateStatus(order.getId(), <span class="hljs-string">"PAID"</span>);
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
    <span class="hljs-comment">// 第一个事务：创建订单</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> self.createOrderInTransaction(order);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 外部服务调用（无事务）</span>
        <span class="hljs-type">PaymentResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentService.processPayment(order);
        
        <span class="hljs-comment">// 第二个事务：更新状态</span>
        self.updateOrderStatusInTransaction(orderId, <span class="hljs-string">"PAID"</span>);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 第三个事务：处理失败</span>
        self.updateOrderStatusInTransaction(orderId, <span class="hljs-string">"FAILED"</span>);
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h4 data-id="heading-24">错误3：异常处理不当导致事务不回滚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        <span class="hljs-keyword">try</span> {
            processItem(data);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理失败"</span>, e);
            <span class="hljs-comment">// 异常被吞掉，事务不会回滚</span>
        }
    }
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        <span class="hljs-keyword">try</span> {
            processItem(data);
        } <span class="hljs-keyword">catch</span> (BusinessException e) {
            log.error(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
            <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 重新抛出，触发回滚</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"系统异常"</span>, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemException</span>(<span class="hljs-string">"处理失败"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-25">错误4：事务传播行为使用不当</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例：审计日志应该独立事务</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 主业务逻辑</span>
    performBusinessLogic();
    
    <span class="hljs-comment">// 审计日志（如果主业务失败，审计日志也会回滚）</span>
    auditService.recordOperation(); <span class="hljs-comment">// 使用默认REQUIRED传播</span>
}

<span class="hljs-comment">// ✅ 正确示例：使用REQUIRES_NEW</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuditService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 独立事务，即使主业务失败也会提交</span>
        auditMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AuditLog</span>());
    }
}

<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        performBusinessLogic();
        auditService.recordOperation(); <span class="hljs-comment">// 记录成功日志</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        auditService.recordOperation(); <span class="hljs-comment">// 记录失败日志</span>
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h3 data-id="heading-26">4.2 最佳实践总结</h3>
<h4 data-id="heading-27">1. 事务边界设计原则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 推荐模式：短事务 + 状态管理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complexBusinessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 短事务创建初始状态</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> self.createTaskInTransaction(PENDING);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 无事务的外部操作</span>
        <span class="hljs-type">ExternalResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> externalService.process(taskId);
        
        <span class="hljs-comment">// 3. 短事务更新最终状态</span>
        self.updateTaskStatusInTransaction(taskId, SUCCESS, result);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 4. 短事务记录失败状态</span>
        self.updateTaskStatusInTransaction(taskId, FAILED, e.getMessage());
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h4 data-id="heading-28">2. 事务注解配置规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 完整的事务配置</span>
<span class="hljs-meta">@Transactional(
    rollbackFor = Exception.class,           // 所有异常都回滚
    timeout = 30,                           // 30秒超时
    isolation = Isolation.READ_COMMITTED,   // 明确指定隔离级别
    propagation = Propagation.REQUIRED      // 明确指定传播行为
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 业务逻辑</span>
}
</code></pre>
<h4 data-id="heading-29">3. 异常处理规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 分层异常处理</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        riskyOperation();
    } <span class="hljs-keyword">catch</span> (BusinessException e) {
        <span class="hljs-comment">// 业务异常：记录并重新抛出</span>
        log.warn(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (SystemException e) {
        <span class="hljs-comment">// 系统异常：记录并重新抛出</span>
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 未知异常：包装后抛出</span>
        log.error(<span class="hljs-string">"未知异常"</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemException</span>(<span class="hljs-string">"操作失败"</span>, e);
    }
}
</code></pre>
<h4 data-id="heading-30">4. 性能优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 批量操作优化</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcess</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-comment">// 分批处理，避免长事务</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; dataList.size(); i += batchSize) {
        List&lt;Data&gt; batch = dataList.subList(i, Math.min(i + batchSize, dataList.size()));
        processBatch(batch);
    }
}

<span class="hljs-comment">// ✅ 只读事务优化</span>
<span class="hljs-meta">@Transactional(readOnly = true)</span>
<span class="hljs-keyword">public</span> List&lt;Data&gt; <span class="hljs-title function_">queryData</span><span class="hljs-params">(QueryCondition condition)</span> {
    <span class="hljs-comment">// 只读事务，数据库可以进行优化</span>
    <span class="hljs-keyword">return</span> dataMapper.selectByCondition(condition);
}
</code></pre>
<h4 data-id="heading-31">5. 监控和调试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 事务状态监控</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMonitorService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkTransactionStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isActive</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.isActualTransactionActive();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isReadOnly</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly();
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.getCurrentTransactionName();
        
        log.info(<span class="hljs-string">"事务状态: active={}, readOnly={}, name={}"</span>, isActive, isReadOnly, name);
    }
}

<span class="hljs-comment">// ✅ 事务日志配置</span>
# logback-spring.xml
&lt;logger name=<span class="hljs-string">"org.springframework.transaction"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
&lt;logger name=<span class="hljs-string">"org.springframework.orm.jpa"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
</code></pre>
<hr/>
<h2 data-id="heading-32">5. 总结</h2>
<h3 data-id="heading-33">5.1 核心要点</h3>
<ol>
<li><strong>事务隔离是竞态条件的根本原因</strong>：READ COMMITTED隔离级别导致未提交数据不可见</li>
<li><strong>代理机制是事务生效的前提</strong>：内部方法调用必须通过代理对象</li>
<li><strong>事务边界设计至关重要</strong>：数据库操作与外部调用应该分离</li>
<li><strong>状态管理保证最终一致性</strong>：通过状态字段和补偿机制处理异常情况</li>
</ol>
<h3 data-id="heading-34">5.2 实施建议</h3>
<ol>
<li><strong>立即修复</strong>：使用self注入解决内部方法调用问题</li>
<li><strong>重构长事务</strong>：将外部调用从事务中分离出来</li>
<li><strong>完善监控</strong>：添加事务状态监控和性能指标</li>
</ol>
<h3 data-id="heading-35">5.3 预期效果</h3>
<ul>
<li><strong>消除竞态条件</strong>：外部服务能正常查询到已提交数据</li>
<li><strong>提升并发性能</strong>：缩短事务持有锁的时间</li>
<li><strong>增强系统稳定性</strong>：减少因外部服务故障导致的事务回滚</li>
<li><strong>改善可维护性</strong>：清晰的事务边界和错误处理机制</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南]]></title>    <link>https://juejin.cn/post/7585406229150826534</link>    <guid>https://juejin.cn/post/7585406229150826534</guid>    <pubDate>2025-12-19T06:37:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406229150826534" data-draft-id="7585085798810140699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南"/> <meta itemprop="keywords" content="Spring Cloud,微服务"/> <meta itemprop="datePublished" content="2025-12-19T06:37:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T06:37:00.000Z" title="Fri Dec 19 2025 06:37:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南</h2>
<p>在微服务架构（如 RuoYi-Cloud-Plus）中，我们将一个庞大的单体应用拆分成了多个独立的服务（如订单服务、库存服务、账户服务）。这种拆分虽然提升了开发效率和系统扩展性，但也带来了一个棘手的问题：<strong>数据一致性</strong>。</p>
<p>本文将深入浅出地讲解 Seata 的作用，并以 <code>ruoyi-order</code> 服务为例，提供标准的接入配置指南。</p>
<hr/>
<h3 data-id="heading-1">第一部分：Seata 是什么？有什么用？</h3>
<h4 data-id="heading-2">1. 为什么我们需要 Seata？</h4>
<p>在传统的<strong>单体应用</strong>中，所有的业务表都在同一个数据库里。我们只需要使用 Spring 的 <code>@Transactional</code> 注解，数据库本身就能保证“<strong>要么全成功，要么全失败</strong>”。</p>
<p>但在<strong>微服务架构</strong>中，业务被拆分了：</p>
<ul>
<li><strong>订单服务</strong>（连 订单库）</li>
<li><strong>库存服务</strong>（连 库存库）</li>
</ul>
<p><strong>场景模拟：用户下单</strong></p>
<ol>
<li>用户请求 <strong>订单服务</strong> -&gt; 创建订单（Insert Order 成功）。</li>
<li>订单服务 远程调用 <strong>库存服务</strong> -&gt; 扣减库存（Update Stock 失败，抛出异常）。</li>
</ol>
<p><strong>如果没有 Seata：</strong>
库存服务虽然报错回滚了，但订单服务刚才已经提交了事务。结果就是：<strong>订单创建了，但库存没扣</strong>。商家亏钱，数据错乱。</p>
<h4 data-id="heading-3">2. Seata 的作用：微服务的“大管家”</h4>
<p>Seata (Simple Extensible Autonomous Transaction Architecture) 是阿里巴巴开源的分布式事务解决方案。</p>
<p><strong>它的核心作用是：</strong>
将跨越多个服务、多个数据库的操作，看作一个<strong>全局的大事务</strong>。</p>
<ul>
<li><strong>一荣俱荣：</strong> 所有服务都执行成功，才最终提交。</li>
<li><strong>一损俱损：</strong> 只要有一个服务失败，Seata 会指挥其他所有服务<strong>自动回滚</strong>，就像什么都没发生过一样。</li>
</ul>
<h4 data-id="heading-4">3. <code>undo_log</code> 表是干嘛的？（核心原理）</h4>
<p>在部署 Seata 时，我们必须在每个业务数据库里导入一张 <code>undo_log</code> 表。这是 Seata <strong>AT 模式</strong>（最常用模式）的魔法所在。</p>
<p><strong>“时光倒流”机制：</strong></p>
<ol>
<li><strong>一阶段：</strong> 当你的业务代码执行 <code>UPDATE</code> 时，Seata 会拦截 SQL，先查询更新前的数据（镜像），保存到 <code>undo_log</code> 表中，然后再提交业务数据。</li>
<li><strong>二阶段（如果出错）：</strong> 如果其他服务报错了，Seata 会读取 <code>undo_log</code> 里的记录，生成反向 SQL，把数据<strong>恢复</strong>成原来的样子。</li>
</ol>
<hr/>
<h3 data-id="heading-5">第二部分：实战配置指南</h3>
<p>理解了 Seata 的作用，我们来看看当新增一个微服务（例如 <strong><code>ruoyi-order</code></strong>）时，如何正确配置它。</p>
<h4 data-id="heading-6">1. 现象描述</h4>
<p>启动新服务 <code>ruoyi-order</code> 时，控制台抛出如下异常：</p>
<pre><code class="hljs language-text" lang="text">io.seata.config.exception.ConfigNotFoundException: service.vgroupMapping.ruoyi-order-group configuration item is required
...
</code></pre>
<p><strong>原因：</strong> Seata 客户端生成了事务分组名 <code>ruoyi-order-group</code>，但在 Seata 服务端（注册中心）找不到该分组对应的集群。</p>
<h4 data-id="heading-7">2. Seata 的三层映射机制</h4>
<p>Seata 使用“三层映射”来实现逻辑隔离与高可用：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[微服务应用] --&gt;|配置: tx-service-group| B(事务分组名 Transaction Service Group)
    B --&gt;|Nacos配置: vgroupMapping| C(Seata 集群名 Cluster Name)
    C --&gt;|服务发现| D[Seata Server 集群]
</code></pre>
<h4 data-id="heading-8">3. 标准配置步骤</h4>
<p><strong>不建议</strong>在本地强行修改为 <code>default_tx_group</code>，应遵循 <strong>“自动生成 + Nacos 注册”</strong> 的标准流程。</p>
<h5 data-id="heading-9">步骤一：客户端配置（通常已自动继承）</h5>
<p>在 <code>ruoyi-order</code> 服务中，确保继承了框架的通用配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">ruoyi-order</span>

<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 【自动生成】结果为：ruoyi-order-group</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">${spring.application.name}-group</span>
</code></pre>
<h5 data-id="heading-10">步骤二：服务端添加映射（Nacos 操作）</h5>
<p>我们需要告诉 Seata：<strong>“<code>ruoyi-order-group</code> 是合法的，请由 <code>default</code> 集群处理。”</strong></p>
<ol>
<li><strong>登录 Nacos 控制台</strong>。</li>
<li>进入 <strong>配置管理 -&gt; 配置列表</strong>。</li>
<li>找到 Seata Server 读取的配置文件（通常名为 <strong><code>seata-server.properties</code></strong>）。</li>
<li><strong>编辑配置</strong>，追加以下内容：</li>
</ol>
<pre><code class="hljs language-properties" lang="properties"># ===================================================
# Seata 事务分组映射表
# 语法：service.vgroupMapping.{事务分组名}={Seata集群名}
# ===================================================

# 系统原有的
service.vgroupMapping.default_tx_group=default
service.vgroupMapping.ruoyi-system-group=default

# ★★★ 新增：为 ruoyi-order 服务添加映射 ★★★
# 左边：ruoyi-order-group (服务名 + "-group")
# 右边：default (Seata Server 的集群名称)
service.vgroupMapping.ruoyi-order-group=default
</code></pre>
<ol start="5">
<li>点击 <strong>发布</strong>。</li>
</ol>
<h5 data-id="heading-11">步骤三：验证</h5>
<p>重启 <code>ruoyi-order</code> 服务。观察日志，报错应消失，且出现 <code>Transaction Manager Client ... init success</code> 字样。</p>
<hr/>
<h3 data-id="heading-12">4. 总结</h3>
<ol>
<li><strong>Seata 的价值：</strong> 它是微服务数据一致性的守护者，保证跨库操作“要么全成，要么全败”。</li>
<li><strong>undo_log 的作用：</strong> 它是“后悔药”，记录了数据修改前的样子，用于出错时自动回滚。</li>
<li><strong>配置原则：</strong> 新增服务时，<strong>不要</strong>改代码里的分组名，而要<strong>去 Nacos 注册</strong>这个分组名。</li>
</ol>
<p>通过本文的配置，您的 <code>ruoyi-order</code> 服务已成功接入分布式事务保护网，可以放心地进行跨服务调用了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[爬楼梯？不，你在攀登算法的珠穆朗玛峰！]]></title>    <link>https://juejin.cn/post/7585466235660861492</link>    <guid>https://juejin.cn/post/7585466235660861492</guid>    <pubDate>2025-12-20T03:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585466235660861492" data-draft-id="7585458459165720610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 爬楼梯？不，你在攀登算法的珠穆朗玛峰！"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-20T03:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwwW"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             爬楼梯？不，你在攀登算法的珠穆朗玛峰！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwwW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:19:05.000Z" title="Sat Dec 20 2025 03:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">爬楼梯？不，你在攀登算法的珠穆朗玛峰！</h2>
<blockquote>
<p>一道看似“幼儿园难度”的面试题：<br/>
<strong>“每次能爬1阶或2阶，问爬到第n阶有几种方法？”</strong><br/>
却暗藏递归、动态规划、记忆化、空间优化四大内功心法——<br/>
它不是考你会不会算数，而是看你有没有<strong>系统性思维</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧗‍♂️ 初见：天真递归 —— “我能行！”（然后爆栈了）</h3>
<p>最直觉的解法？当然是递归！</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">climbStairs</span>(n) {
  if (n === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span>;
  if (n === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span>;
  return <span class="hljs-built_in">climbStairs</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-built_in">climbStairs</span>(n - <span class="hljs-number">2</span>);
}
</code></pre>
<p><strong>逻辑完美</strong>：</p>
<ul>
<li>要到第 <code>n</code> 阶，要么从 <code>n-1</code> 上来，要么从 <code>n-2</code> 跳上来</li>
<li>所以 <code>f(n) = f(n-1) + f(n-2)</code> —— 这不就是斐波那契？</li>
</ul>
<p>但问题来了：<br/>
当你调用 <code>climbStairs(45)</code>，电脑会疯狂重复计算：</p>
<ul>
<li><code>f(43)</code> 被算两次</li>
<li><code>f(42)</code> 被算三次</li>
<li>……<br/>
<strong>时间复杂度 O(2ⁿ)</strong> —— 指数爆炸！</li>
</ul>
<blockquote>
<p>就像你让一个人背完整本字典来查一个词——可行，但荒谬。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🧠 进阶：记忆化递归 —— “我记住了！”</h3>
<p>既然重复计算是罪魁祸首，那就<strong>把算过的答案存起来</strong>！</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">memo</span> = {}<span class="hljs-comment">;</span>
function climbStairs(n) {
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  if (memo<span class="hljs-section">[n]</span>) return memo<span class="hljs-section">[n]</span><span class="hljs-comment">; // ← 关键：查缓存！</span>
  memo<span class="hljs-section">[n]</span> = climbStairs(n - 1) + climbStairs(n - 2)<span class="hljs-comment">;</span>
  return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>✅ <strong>效果</strong>：每个 <code>f(k)</code> 只算一次 → 时间复杂度 <strong>O(n)</strong><br/>
✅ <strong>思想</strong>：<strong>空间换时间</strong>，典型的<strong>自顶向下动态规划（Top-down DP）</strong></p>
<p>但有个小瑕疵：<code>memo</code> 是全局变量，容易被污染。</p>
<hr/>
<h3 data-id="heading-3">🔒 优雅封装：闭包 + 记忆化 —— “我的缓存，外人别碰！”</h3>
<p>用<strong>闭包</strong>把 <code>memo</code> 私有化，打造一个“智能函数”：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">climbStairs</span> = (function() {
  const <span class="hljs-attr">memo</span> = {}<span class="hljs-comment">; // ← 外部无法访问！</span>
  return function climb(n) {
    if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    if (memo<span class="hljs-section">[n]</span>) return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
    memo<span class="hljs-section">[n]</span> = climb(n - 1) + climb(n - 2)<span class="hljs-comment">;</span>
    return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
</code></pre>
<p>✨ <strong>优势</strong>：</p>
<ul>
<li>多次调用共享缓存（越用越快）</li>
<li>状态私有，安全可靠</li>
<li>接口干净：用户只需 <code>climbStairs(n)</code></li>
</ul>
<blockquote>
<p>这不是函数，这是一个<strong>会学习、有记忆、懂封装的智能体</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">🚀 终极优化：自底向上 + 滚动变量 —— “我不需要递归！”</h3>
<p>其实，我们根本不需要递归，也不需要存所有中间值！</p>
<p>观察规律：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>) = <span class="hljs-number">1</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) = <span class="hljs-number">2</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">3</span>) = <span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) + <span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>) = <span class="hljs-number">3</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">4</span>) = <span class="hljs-built_in">f</span>(<span class="hljs-number">3</span>) + <span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) = <span class="hljs-number">5</span>
...
</code></pre>
<p>只需要<strong>两个变量</strong>，就能滚动计算出结果：</p>
<pre><code class="hljs language-ini" lang="ini">function climbStairs(n) {
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  
  let <span class="hljs-attr">prevPrev</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // f(i-2)</span>
  let <span class="hljs-attr">prev</span> = <span class="hljs-number">2</span><span class="hljs-comment">;     // f(i-1)</span>
  
  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">3</span><span class="hljs-comment">; i &lt;= n; i++) {</span>
    const <span class="hljs-attr">current</span> = prev + prevPrev<span class="hljs-comment">; // f(i)</span>
    <span class="hljs-attr">prevPrev</span> = prev<span class="hljs-comment">;   // 滚动窗口</span>
    <span class="hljs-attr">prev</span> = current<span class="hljs-comment">;</span>
  }
  
  return prev<span class="hljs-comment">;</span>
}
</code></pre>
<p>✅ <strong>时间复杂度</strong>：O(n)<br/>
✅ <strong>空间复杂度</strong>：O(1) —— <strong>极致优化！</strong><br/>
✅ <strong>无递归</strong>：避免调用栈溢出（n 很大时更安全）</p>
<blockquote>
<p>这就是<strong>自底向上的动态规划（Bottom-up DP）</strong> —— 从已知出发，一步步推导未知。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">📊 四种解法对比</h3>








































<table><thead><tr><th>方法</th><th>时间复杂度</th><th>空间复杂度</th><th>是否递归</th><th>适用场景</th></tr></thead><tbody><tr><td>暴力递归</td><td>O(2ⁿ)</td><td>O(n)</td><td>✅</td><td>教学演示</td></tr><tr><td>记忆化递归</td><td>O(n)</td><td>O(n)</td><td>✅</td><td>中等规模，逻辑清晰</td></tr><tr><td>闭包记忆化</td><td>O(n)</td><td>O(n)</td><td>✅</td><td>需要缓存复用</td></tr><tr><td><strong>滚动变量</strong></td><td><strong>O(n)</strong></td><td><strong>O(1)</strong></td><td>❌</td><td><strong>生产环境首选</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">💡 面试加分回答</h3>
<p>当面试官问这道题，你可以这样说：</p>
<blockquote>
<p>“我会根据场景选择方案：</p>
<ul>
<li>如果是教学或快速原型，用记忆化递归，逻辑直观；</li>
<li>如果是高性能生产环境，用滚动变量的迭代法，O(1) 空间且无栈溢出风险。<br/>
此外，我还会考虑边界情况（如 n ≤ 0）、类型校验，以及是否需要支持‘每次可爬1~k阶’的扩展。”</li>
</ul>
</blockquote>
<p>——瞬间从“会写代码”升级到“有工程思维”。</p>
<hr/>
<h3 data-id="heading-7">🌟 结语：小题大智慧</h3>
<p>“爬楼梯”从来不是一道数学题，而是一面镜子：</p>
<ul>
<li>它照出你是否理解<strong>递归的本质</strong></li>
<li>它检验你是否掌握<strong>动态规划的思想</strong></li>
<li>它考验你能否在<strong>简洁、性能、可维护性</strong>之间做权衡</li>
</ul>
<p>下次再有人说“这题太简单”，你可以微笑回应：</p>
<blockquote>
<p>“是啊，简单到能写出四种境界。”</p>
</blockquote>
<p>而这，正是优秀工程师和普通 coder 的分水岭。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决]]></title>    <link>https://juejin.cn/post/7585452404112752655</link>    <guid>https://juejin.cn/post/7585452404112752655</guid>    <pubDate>2025-12-20T03:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112752655" data-draft-id="7585406030021951523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-20T03:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zsnoin能"/> <meta itemprop="url" content="https://juejin.cn/user/2142280667371624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2142280667371624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zsnoin能
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:50:41.000Z" title="Sat Dec 20 2025 03:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">国际化和暗黑主题适配</h2>
<p>前端实现国际化和暗黑主题适配已成为现代产品的核心刚需：国际化能够突破语言、地区和文化壁垒，让产品适配全球不同用户的语言习惯、格式规范（日期/货币/地址）及合规要求，覆盖多语言网站、跨境电商、企业级SaaS等场景，是拓展用户群体、提升全球市场竞争力的基础；而暗黑主题适配不仅能在低光环境下保护用户视力、为OLED设备降低功耗，还能适配不同用户的视觉偏好与特殊人群的无障碍需求，同时契合科技、游戏等行业的产品调性，提升用户体验与使用舒适度；二者结合既满足了产品全球化的适配能力，又兼顾了用户个性化的体验诉求，是提升产品包容性、用户留存率和市场适配性的关键设计与开发策略。</p>
<h3 data-id="heading-1">1、国际化</h3>
<p>国际化（<strong>i18n</strong>）是指让软件、网站或应用能够适配不同语言、地区和文化习惯的设计与开发过程，其核心目标是<strong>无需大规模修改代码</strong>，就能支持多语言、多地区的本地化部署
<strong>使用插件 i18n</strong></p>
<h4 data-id="heading-2">1.1 定义存储当前语言的方法</h4>
<p>src\utils\cookies.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Cookies</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'js-cookie'</span>

<span class="hljs-keyword">const</span> languageKey = <span class="hljs-string">'dd_language'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLanguage</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">get</span>(languageKey)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setLanguage</span> = (<span class="hljs-params">language:string</span>) =&gt; <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(languageKey, language)
</code></pre>
<h4 data-id="heading-3">1.2 准备翻译文件</h4>
<p>有的组件国际化语言较少，可能自行添加，比如vxe-table版本不是最新的，没有越南和俄罗斯翻译，需手动添加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b484fb33e0244ed48968a41b6b3d4d12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=wR7fwRzYyE%2BSNmJOaPbq0qe3CRU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.3 翻译文件</h4>
<h5 data-id="heading-5">1.3.1 主文件内容</h5>
<ul>
<li>src\lang\index.ts</li>
<li>注释已经很详细了，就是对翻译文件进行合并，然后根据当前选中的语言进行应用</li>
<li><strong>重点介绍一下远程翻译，很多时候翻译的不是很准确，客户可能需要能自行进行翻译，我们可以在这里定义一个 <code>loadRemoteMessages</code> 方法，用于加载远程翻译，后端返回给你远程自定义的翻译，然后通过扩展运算符进行合并，后面的数据会覆盖前面，从而实现替换，非常简单吧，根本没啥难度。</strong></li>
<li><code>document.title</code> 能直接修改网页标题，可以通过这个设置网页标题多语言。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>;
<span class="hljs-keyword">import</span> { getLanguage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/cookies'</span>;
<span class="hljs-comment">// import { fetchRemoteTranslations } from '../api/translation' // 引入远程接口</span>

<span class="hljs-comment">// vxe-table 组件翻译（保留本地，不被远程覆盖）</span>
<span class="hljs-keyword">import</span> vxe_zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table/lib/locale/lang/zh-CN'</span>;
<span class="hljs-keyword">import</span> vxe_enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table/lib/locale/lang/en-US'</span>;
<span class="hljs-keyword">import</span> vxe_ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lang/vxeTabel/ru_RU'</span>;


<span class="hljs-comment">// ant-design 组件翻译（保留本地，不被远程覆盖）</span>
<span class="hljs-keyword">import</span> ant_zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>;
<span class="hljs-keyword">import</span> ant_enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>;
<span class="hljs-keyword">import</span> ant_ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>;


<span class="hljs-comment">// dayjs 本地化（无需修改）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/zh-cn"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/en"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/ru"</span>;

<span class="hljs-comment">// 本地业务翻译（可能被远程覆盖）</span>
<span class="hljs-keyword">import</span> enLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./en'</span>;
<span class="hljs-keyword">import</span> zhLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./zh'</span>;
<span class="hljs-keyword">import</span> ruLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./ru'</span>;



<span class="hljs-comment">// 初始化本地消息（组件库翻译 + 本地业务翻译）</span>
<span class="hljs-keyword">const</span> baseMessages = {
    <span class="hljs-attr">en_US</span>: {
        ...ant_enUS,    <span class="hljs-comment">// 组件库翻译（优先级最高，不被覆盖）</span>
        ...vxe_enUS,
        ...enLocale     <span class="hljs-comment">// 本地业务翻译（可能被远程覆盖）</span>
    },
    <span class="hljs-attr">zh_CN</span>: {
        ...ant_zhCN,
        ...vxe_zhCN,
        ...zhLocale
    },
    <span class="hljs-attr">ru_RU</span>: {
        ...ant_ruRU,
        ...vxe_ruRU,
        ...ruLocale
    }
}

<span class="hljs-comment">// 获取当前语言（复用你的现有逻辑）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLocale</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> cookieLanguage = <span class="hljs-title function_">getLanguage</span>()
    <span class="hljs-keyword">if</span> (cookieLanguage) {
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">lang</span> = cookieLanguage
        <span class="hljs-keyword">return</span> cookieLanguage
    }
    <span class="hljs-keyword">const</span> language = navigator.<span class="hljs-property">language</span>.<span class="hljs-title function_">toLowerCase</span>()
    <span class="hljs-keyword">const</span> locales = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(baseMessages)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> locale <span class="hljs-keyword">of</span> locales) {
        <span class="hljs-keyword">if</span> (language.<span class="hljs-title function_">indexOf</span>(locale) &gt; -<span class="hljs-number">1</span>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">lang</span> = locale
            <span class="hljs-keyword">return</span> locale
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'zh_CN'</span> <span class="hljs-comment">// 默认中文</span>
}

<span class="hljs-comment">// 创建基础 i18n 实例（先加载本地翻译）</span>
<span class="hljs-keyword">const</span> i18n = <span class="hljs-title function_">createI18n</span>({
    <span class="hljs-attr">legacy</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">globalInjection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">locale</span>: <span class="hljs-title function_">getLocale</span>(),
    <span class="hljs-attr">messages</span>: baseMessages, <span class="hljs-comment">// 先使用本地基础翻译</span>
    <span class="hljs-attr">silentTranslationWarn</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-comment">// 核心：加载远程翻译并合并（远程覆盖本地业务翻译，不影响组件库翻译）</span>
<span class="hljs-comment">// 定义语言类型</span>
type <span class="hljs-title class_">Locale</span> = <span class="hljs-string">'en_US'</span> | <span class="hljs-string">'zh_CN'</span> | <span class="hljs-string">'ru_RU'</span>;

<span class="hljs-comment">// 修改 loadRemoteMessages 函数，添加类型约束</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadRemoteMessages</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">locale: Locale = getLocale()</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// const remoteTrans = await fetchRemoteTranslations(locale)</span>
        <span class="hljs-keyword">let</span> remoteTrans = {
            <span class="hljs-number">99001</span>: <span class="hljs-string">"测试远程翻译"</span>,
        }
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'波奇壁纸管理系统'</span>
        <span class="hljs-keyword">if</span> (locale == <span class="hljs-string">'en_US'</span>) {
            remoteTrans = {
                <span class="hljs-number">99001</span>: <span class="hljs-string">"test this a remote translation"</span>,
            }
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'bocchi wallpaper management system'</span>
        }
        <span class="hljs-comment">// 2. 合并规则：远程翻译覆盖本地业务翻译，但不影响组件库翻译</span>
        <span class="hljs-keyword">const</span> merged = {
            ...baseMessages[locale], <span class="hljs-comment">// 基础：组件库 + 本地业务</span>
            ...remoteTrans          <span class="hljs-comment">// 远程业务翻译覆盖本地业务</span>
        }
        <span class="hljs-comment">// 3. 更新 i18n 实例的翻译数据</span>
        i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">setLocaleMessage</span>(locale, merged)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已加载 <span class="hljs-subst">${locale}</span> 远程翻译`</span>)
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`远程翻译加载失败，使用本地翻译:`</span>, err)
        <span class="hljs-comment">// 失败时仍使用本地翻译</span>
    }
}


<span class="hljs-comment">// 初始化时立即加载远程翻译（确保页面首次渲染使用最新翻译）</span>
<span class="hljs-title function_">loadRemoteMessages</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> i18n
</code></pre>
<h5 data-id="heading-6">1.3.1 翻译文件示例</h5>
<p>src\lang\en.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-comment">// 系统 10</span>
    <span class="hljs-number">10001</span>: <span class="hljs-string">''</span>,

    <span class="hljs-comment">// 菜单 20</span>
    <span class="hljs-number">20001</span>: <span class="hljs-string">'Home'</span>,
    <span class="hljs-number">20002</span>: <span class="hljs-string">'Wallpaper Management'</span>,
    <span class="hljs-number">20003</span>: <span class="hljs-string">'Wallpaper Information'</span>,
    <span class="hljs-number">20004</span>: <span class="hljs-string">'Image Upload'</span>,
    <span class="hljs-number">20005</span>: <span class="hljs-string">'Video Upload'</span>,
    <span class="hljs-number">20006</span>: <span class="hljs-string">'Data Management'</span>,
    <span class="hljs-number">20007</span>: <span class="hljs-string">'User Management'</span>,
    <span class="hljs-number">20008</span>: <span class="hljs-string">'User Information'</span>,
    <span class="hljs-number">20009</span>: <span class="hljs-string">'Long-term Inactive'</span>,
    <span class="hljs-number">20010</span>: <span class="hljs-string">'Entertainment Management'</span>,
    <span class="hljs-number">20011</span>: <span class="hljs-string">'System Management'</span>,
    <span class="hljs-number">20012</span>: <span class="hljs-string">'Port Information'</span>,
    <span class="hljs-number">20013</span>: <span class="hljs-string">'Software Information'</span>
}
</code></pre>
<p>引用并挂载多语言 src\main.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'ant-design-vue/dist/reset.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/global.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/vxeTable.css'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VXETable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vxe-table/lib/style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/router/permisstion'</span>
<span class="hljs-keyword">import</span> globalComponents <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/index'</span>
<span class="hljs-keyword">import</span> globalDirective <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directives/index'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./auto-update'</span> <span class="hljs-comment">// 自动更新</span>
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'./lang'</span>

<span class="hljs-title class_">VXETable</span>.<span class="hljs-title function_">setConfig</span>({
  <span class="hljs-attr">size</span>: <span class="hljs-string">'mini'</span>, <span class="hljs-comment">// 全局尺寸</span>
  <span class="hljs-attr">i18n</span>: <span class="hljs-function">(<span class="hljs-params">key: string, args: any</span>) =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args),
  <span class="hljs-title function_">translate</span>(<span class="hljs-params">key, args</span>) {
    <span class="hljs-keyword">return</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args)
  }
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-comment">// @ts-ignore</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$i18n</span> = i18n;

app.<span class="hljs-title function_">use</span>(i18n) 
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VXETable</span>)
store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)
app.<span class="hljs-title function_">use</span>(store)
app.<span class="hljs-title function_">use</span>(globalComponents)
app.<span class="hljs-title function_">use</span>(globalDirective)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-7">1.4 定义多语言切换组件</h4>
<ul>
<li>src\components\layout\Language\index.vue</li>
<li>在合适的地方引入即可实现多语言切换</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"Language"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a-dropdown</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">overlay</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a-menu</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onLanguage"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a-menu-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"itm in languageList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"itm.value"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"itm.label"</span>&gt;</span>
                        {{ itm.label }}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">a-menu-item</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">a-menu</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 110px"</span>&gt;</span>
                {{ language }}
                <span class="hljs-tag">&lt;<span class="hljs-name">DownOutlined</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">a-dropdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DownOutlined</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/icons-vue'</span>;
<span class="hljs-keyword">import</span> { useI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-i18n"</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { setLanguage } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/cookies'</span>
<span class="hljs-keyword">import</span> { loadRemoteMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lang/index'</span>

<span class="hljs-keyword">const</span> { locale } = <span class="hljs-title function_">useI18n</span>();
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(store);

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'on-click'</span>])

<span class="hljs-comment">//多语音</span>
<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">switch</span> (lang.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'zh_CN'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'简体中文'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'en_US'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'English'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'ru_RU'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Russia'</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'简体中文'</span>;
    }
})
<span class="hljs-keyword">const</span> languageList = [
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'简体中文'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'zh_CN'</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'English'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'en_US'</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'Russia'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'ru_RU'</span> },
]

<span class="hljs-comment">//切换语言</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onLanguage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">v: any</span>) =&gt; {
    <span class="hljs-comment">// language.value = v.item.name;</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadRemoteMessages</span>(v.<span class="hljs-property">key</span>);
    locale.<span class="hljs-property">value</span> = v.<span class="hljs-property">key</span>;
    lang.<span class="hljs-property">value</span> = v.<span class="hljs-property">key</span>;
    <span class="hljs-title function_">setLanguage</span>(v.<span class="hljs-property">key</span>)
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'on-click'</span>)
}

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLanguage</span>(lang.<span class="hljs-property">value</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-8">1.5 主UI库适配</h4>
<ul>
<li>src\App.vue</li>
<li>这里以 <code>ant-design-vue</code> 为例，按照官网方法设置即可，其它 UI库同理。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">:locale</span>=<span class="hljs-string">"language"</span> <span class="hljs-attr">:theme</span>=<span class="hljs-string">"themeConfig"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, ref, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dayjs/locale/zh-cn'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user.ts'</span>
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>
<span class="hljs-keyword">import</span> ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">"ant-design-vue"</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(userStore)
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">themeStore</span>())

<span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">algorithm</span>: isDark.<span class="hljs-property">value</span> ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>, <span class="hljs-comment">// 核心：切换明暗算法</span>
});

<span class="hljs-title function_">watch</span>(isDark, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">algorithm</span> = newVal ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, newVal);
})


<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: any = {
  <span class="hljs-string">'zh_CN'</span>: zhCN,
  <span class="hljs-string">'en_US'</span>: enUS,
  <span class="hljs-string">'ru_RU'</span>: ruRU
}

<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> obj[lang.<span class="hljs-property">value</span>]
})

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, isDark.<span class="hljs-property">value</span>);
})

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<h4 data-id="heading-9">1.6 使用</h4>
<p>直接使用 <code>$t('key')</code> 或者 引入后使用 <code>t('key')</code> 都行</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div&gt;
        &lt;hr&gt;
        {{ t('99001') }}
        &lt;hr&gt;
        {{ $t('99001') }}
        &lt;hr&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import { useI18n } from "vue-i18n";

const { t } = useI18n();
&lt;/script&gt;

</code></pre>
<h4 data-id="heading-10">1.7 效果预览</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc9071a6c69e43e4b29586f7613065a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=xAOWvWfwBxjfNNIifLR4kezIcMM%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ebc6e7f0f04dd8849014070556790c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=j0YVf4W3S4ag0cijvxW7YsXBtkw%3D" alt="image.png" width="100%" loading="lazy"/>
<h3 data-id="heading-11">2、暗黑模式</h3>
<p>暗黑模式（Dark Mode）核心价值是适配特定行业调性。刚做的工厂mes系统，现场属于高亮环境，不同时间段还会有太阳光反射等情况，亮色模式下看不清，领导就要求加入暗黑模式，咱就给他加。</p>
<h4 data-id="heading-12">2.1 定义主题仓库</h4>
<ul>
<li>src\store\themeStore.ts</li>
<li>用于记录主题和改变主题</li>
<li>仓库已做持久化存储</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> themeStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'theme'</span>, {
  <span class="hljs-attr">state</span>: (): {
    <span class="hljs-attr">isDark</span>: boolean,
  } =&gt; {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isDark</span>: <span class="hljs-literal">false</span>,
    }
  },
  <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDark</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDark</span>
    },
  },
  <span class="hljs-attr">getters</span>: {},
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> themeStore

</code></pre>
<h4 data-id="heading-13">2.2 定义主题参数</h4>
<ul>
<li>src\styles\global.css</li>
</ul>
<h5 data-id="heading-14">2.2.1自定义 css 全局变量</h5>
<ul>
<li>分别定义 暗黑主题 和 亮色主题 的css变量</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础变量：覆盖 90% 通用场景，与 Antd 风格对齐 */</span>
<span class="hljs-selector-pseudo">:root</span> {
    <span class="hljs-attr">--bg</span>: white;
    <span class="hljs-comment">/* ========== 背景色 ========== */</span>
    <span class="hljs-attr">--bg-primary</span>: <span class="hljs-number">#ffffff</span>;
    <span class="hljs-attr">--bg-secondary</span>: <span class="hljs-number">#f5f5f5</span>;
    <span class="hljs-attr">--bg-tertiary</span>: <span class="hljs-number">#fafafa</span>;
    <span class="hljs-attr">--bg-overlay</span>: <span class="hljs-number">#ffffff</span>;

    <span class="hljs-comment">/* ========== 文字色 ========== */</span>
    <span class="hljs-attr">--text-primary</span>: black;
    <span class="hljs-attr">--text-secondary</span>: <span class="hljs-number">#4b5563</span>;
    <span class="hljs-attr">--text-tertiary</span>: <span class="hljs-number">#9ca3af</span>;
    <span class="hljs-attr">--text-inverse</span>: <span class="hljs-number">#ffffff</span>;

    <span class="hljs-comment">/* ========== 边框色 ========== */</span>
    <span class="hljs-attr">--border-primary</span>: <span class="hljs-number">#e5e7eb</span>;
    <span class="hljs-attr">--border-secondary</span>: <span class="hljs-number">#d1d5db</span>;
    <span class="hljs-attr">--border-hover</span>: <span class="hljs-number">#9ca3af</span>;

    <span class="hljs-comment">/* ========== 功能色（与 Antd 主色对齐） ========== */</span>
    <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#1890ff</span>;
    <span class="hljs-attr">--color-success</span>: <span class="hljs-number">#52c41a</span>;
    <span class="hljs-attr">--color-warning</span>: <span class="hljs-number">#faad14</span>;
    <span class="hljs-attr">--color-danger</span>: <span class="hljs-number">#ff4d4f</span>;
    <span class="hljs-attr">--color-info</span>: <span class="hljs-number">#1890ff</span>;

    <span class="hljs-comment">/* ========== 交互状态 ========== */</span>
    <span class="hljs-attr">--hover-bg</span>: <span class="hljs-number">#f9fafb</span>;
    <span class="hljs-attr">--active-bg</span>: <span class="hljs-number">#f3f4f6</span>;
    <span class="hljs-attr">--disabled-bg</span>: <span class="hljs-number">#f9fafb</span>;

    <span class="hljs-comment">/* 偏白色的主色调 */</span>
    <span class="hljs-attr">--color-primary-light</span>: <span class="hljs-number">#e6f7ff</span>;
    <span class="hljs-attr">--color-primary-lighter</span>: <span class="hljs-number">#bae7ff</span>;
    <span class="hljs-attr">--color-primary-lightest</span>: <span class="hljs-number">#69c0ff</span>;
    <span class="hljs-attr">--color-primary-darker</span>: <span class="hljs-number">#40a9ff</span>;
    <span class="hljs-attr">--color-primary-darkest</span>: <span class="hljs-number">#096dd9</span>;

    <span class="hljs-comment">/* 白色透明梯度色 */</span>
    <span class="hljs-attr">--color-gradient-light</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.3</span>);
    <span class="hljs-attr">--color-gradient-lighter</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.4</span>);
    <span class="hljs-attr">--color-gradient-lightest</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>);

    <span class="hljs-comment">/* 表格相关 */</span>
    <span class="hljs-attr">--table-hover-bg</span>: <span class="hljs-number">#f1f2ffe8</span>;
    <span class="hljs-attr">--table-active-bg</span>: <span class="hljs-number">#cee9ffe2</span>;



    <span class="hljs-comment">/* vxe-table 专属变量 */</span>
    <span class="hljs-attr">--vxe-table-bg</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attr">--vxe-table-header-bg</span>: <span class="hljs-built_in">var</span>(--bg-secondary);
    <span class="hljs-attr">--vxe-table-row-hover-bg</span>: <span class="hljs-number">#f9fafb</span>;
    <span class="hljs-attr">--vxe-table-row-active-bg</span>: <span class="hljs-number">#f3f4f6</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attr">--vxe-table-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-header-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-cell-hover-color</span>: <span class="hljs-built_in">var</span>(--color-primary);


}

<span class="hljs-comment">/* 暗黑模式变量：基于 Antd 暗黑风格优化 */</span>
<span class="hljs-selector-class">.dark</span> {
    <span class="hljs-attr">--bg</span>: black;
    <span class="hljs-comment">/* ========== 背景色 ========== */</span>
    <span class="hljs-attr">--bg-primary</span>: <span class="hljs-number">#141414</span>;
    <span class="hljs-attr">--bg-secondary</span>: <span class="hljs-number">#1f1f1f</span>;
    <span class="hljs-attr">--bg-tertiary</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--bg-overlay</span>: <span class="hljs-number">#1f1f1f</span>;

    <span class="hljs-comment">/* ========== 文字色 ========== */</span>
    <span class="hljs-attr">--text-primary</span>: white;
    <span class="hljs-attr">--text-secondary</span>: <span class="hljs-number">#9ca3af</span>;
    <span class="hljs-attr">--text-tertiary</span>: <span class="hljs-number">#6b7280</span>;
    <span class="hljs-attr">--text-inverse</span>: <span class="hljs-number">#141414</span>;

    <span class="hljs-comment">/* ========== 边框色 ========== */</span>
    <span class="hljs-attr">--border-primary</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--border-secondary</span>: <span class="hljs-number">#3d3d3d</span>;
    <span class="hljs-attr">--border-hover</span>: <span class="hljs-number">#474747</span>;

    <span class="hljs-comment">/* ========== 功能色（暗黑模式优化） ========== */</span>
    <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#359eff</span>;
    <span class="hljs-attr">--color-success</span>: <span class="hljs-number">#67c23a</span>;
    <span class="hljs-attr">--color-warning</span>: <span class="hljs-number">#feb019</span>;
    <span class="hljs-attr">--color-danger</span>: <span class="hljs-number">#ff7875</span>;
    <span class="hljs-attr">--color-info</span>: <span class="hljs-number">#359eff</span>;

    <span class="hljs-comment">/* ========== 交互状态 ========== */</span>
    <span class="hljs-attr">--hover-bg</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--active-bg</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--disabled-bg</span>: <span class="hljs-number">#1f1f1f</span>;

    <span class="hljs-comment">/* 暗黑模式 - 偏暗的主色调（匹配原亮色蓝色系，适配深色背景） */</span>
    <span class="hljs-attr">--color-primary-light</span>: <span class="hljs-number">#142f40</span>;
    <span class="hljs-attr">--color-primary-lighter</span>: <span class="hljs-number">#103c58</span>;
    <span class="hljs-attr">--color-primary-lightest</span>: <span class="hljs-number">#2386c8</span>;
    <span class="hljs-attr">--color-primary-darker</span>: <span class="hljs-number">#2994e0</span>;
    <span class="hljs-attr">--color-primary-darkest</span>: <span class="hljs-number">#359eff</span>;

    <span class="hljs-comment">/* 黑色透明梯度色 */</span>
    <span class="hljs-attr">--color-gradient-light</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
    <span class="hljs-attr">--color-gradient-lighter</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>);
    <span class="hljs-attr">--color-gradient-lightest</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);

    <span class="hljs-comment">/* 表格相关 */</span>
    <span class="hljs-attr">--table-hover-bg</span>: <span class="hljs-number">#4e4e4e</span>;
    <span class="hljs-attr">--table-active-bg</span>: <span class="hljs-number">#000a3aa4</span>;


    <span class="hljs-comment">/* vxe-table 专属变量（适配暗黑） */</span>
    <span class="hljs-attr">--vxe-table-bg</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attr">--vxe-table-header-bg</span>: <span class="hljs-built_in">var</span>(--bg-secondary);
    <span class="hljs-attr">--vxe-table-row-hover-bg</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--vxe-table-row-active-bg</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attr">--vxe-table-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-header-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-cell-hover-color</span>: <span class="hljs-built_in">var</span>(--color-primary);
}
</code></pre>
<h5 data-id="heading-15">2.2.2 覆盖插件样式</h5>
<ul>
<li>对于一些没有适配暗黑模式或者暗黑模式不清晰的插件，可以对样式进行覆盖</li>
<li>这里以 vxe-table 为例，官网的设置暗黑方法不存在，可能是版本原因吧</li>
<li>其它插件同理覆盖即可</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 覆盖 vxe-table 基础样式 - 全局生效 */</span>
<span class="hljs-selector-class">.vxe-table</span> {
    <span class="hljs-attr">--vxe-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-hover-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-current-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-active-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-body-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-empty-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-header--row</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--level-0</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--stripe</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-tertiary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-loading</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-gradient-light) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-input--inner</span>,
<span class="hljs-selector-class">.vxe-pager--jump-prev</span>,
<span class="hljs-selector-class">.vxe-select--panel-wrapper</span>,
<span class="hljs-selector-class">.vxe-pager--prev-btn</span>,
<span class="hljs-selector-class">.vxe-pager--num-btn</span>,
<span class="hljs-selector-class">.vxe-pager--next-btn</span>,
<span class="hljs-selector-class">.vxe-pager--jump-next</span>,
<span class="hljs-selector-class">.vxe-pager--goto</span>,
<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-comment">/* 进入行 */</span>
<span class="hljs-selector-class">.row--hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-hover-bg) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 选中行 */</span>
<span class="hljs-selector-class">.row--current</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-active-bg) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-table--body-wrapper</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-toolbar</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条整体部分*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条的轨道*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-track {
    <span class="hljs-attribute">background</span>: transparent <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条里面的小方块，能向上向下移动*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-thumb {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*边角，即两个滚动条的交汇处*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-corner {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-pager--btn-wrapper</span> <span class="hljs-selector-class">.is--active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: white <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 覆盖 vxe-table 基础样式 - 全局生效 */</span>
<span class="hljs-selector-class">.vxe-table</span> {
    <span class="hljs-attr">--vxe-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-hover-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-current-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-active-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-body-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-empty-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-header--row</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--level-0</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--stripe</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-tertiary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-loading</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-gradient-light) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-input--inner</span>,
<span class="hljs-selector-class">.vxe-pager--jump-prev</span>,
<span class="hljs-selector-class">.vxe-select--panel-wrapper</span>,
<span class="hljs-selector-class">.vxe-pager--prev-btn</span>,
<span class="hljs-selector-class">.vxe-pager--num-btn</span>,
<span class="hljs-selector-class">.vxe-pager--next-btn</span>,
<span class="hljs-selector-class">.vxe-pager--jump-next</span>,
<span class="hljs-selector-class">.vxe-pager--goto</span>,
<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-comment">/* 进入行 */</span>
<span class="hljs-selector-class">.row--hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-hover-bg) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 选中行 */</span>
<span class="hljs-selector-class">.row--current</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-active-bg) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-table--body-wrapper</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-toolbar</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条整体部分*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条的轨道*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-track {
    <span class="hljs-attribute">background</span>: transparent <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条里面的小方块，能向上向下移动*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-thumb {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*边角，即两个滚动条的交汇处*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-corner {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-pager--btn-wrapper</span> <span class="hljs-selector-class">.is--active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: white <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-icon-checkbox-unchecked</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-tertiary) <span class="hljs-meta">!important</span>;
}
</code></pre>
<h4 data-id="heading-16">2.3 引入定义好的变量和样式</h4>
<ul>
<li>src\main.ts</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'ant-design-vue/dist/reset.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/global.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/vxeTable.css'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VXETable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vxe-table/lib/style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/router/permisstion'</span>
<span class="hljs-keyword">import</span> globalComponents <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/index'</span>
<span class="hljs-keyword">import</span> globalDirective <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directives/index'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./auto-update'</span> <span class="hljs-comment">// 自动更新</span>
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'./lang'</span>

<span class="hljs-title class_">VXETable</span>.<span class="hljs-title function_">setConfig</span>({
  <span class="hljs-attr">size</span>: <span class="hljs-string">'mini'</span>, <span class="hljs-comment">// 全局尺寸</span>
  <span class="hljs-attr">i18n</span>: <span class="hljs-function">(<span class="hljs-params">key: string, args: any</span>) =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args),
  <span class="hljs-title function_">translate</span>(<span class="hljs-params">key, args</span>) {
    <span class="hljs-keyword">return</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args)
  }
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-comment">// @ts-ignore</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$i18n</span> = i18n;

app.<span class="hljs-title function_">use</span>(i18n) 
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VXETable</span>)
store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)
app.<span class="hljs-title function_">use</span>(store)
app.<span class="hljs-title function_">use</span>(globalComponents)
app.<span class="hljs-title function_">use</span>(globalDirective)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)

</code></pre>
<h4 data-id="heading-17">2.4 定义主题切换组件</h4>
<ul>
<li>src\components\layout\theme\index.vue</li>
<li>在合适的地方引入即可实现主题切换</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"themeButton"</span>  @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleDark"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"isDark ? dark : light"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 20px; height: 20px"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> dark <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/images/dark.png'</span>
<span class="hljs-keyword">import</span> light <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/images/light.png'</span>

<span class="hljs-keyword">const</span> themes = <span class="hljs-title function_">themeStore</span>()
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(themes)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleDark</span> = (<span class="hljs-params"/>) =&gt; {
    isDark.<span class="hljs-property">value</span> = !isDark.<span class="hljs-property">value</span>;
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.themeButton</span>{
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">32px</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-18">2.5 主UI库适配、应用主题</h4>
<ul>
<li>src\App.vue</li>
<li>这里以 <code>ant-design-vue</code> 为例，按照官网方法设置即可，其它 UI库同理。</li>
<li>原理很简单，就是监听是否是暗黑主题，如果是则为根元素添加 <code>dark</code> 类名，不是则移除。</li>
<li><code>记得初始化时默认设置一次类名</code></li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">:locale</span>=<span class="hljs-string">"language"</span> <span class="hljs-attr">:theme</span>=<span class="hljs-string">"themeConfig"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, ref, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dayjs/locale/zh-cn'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user.ts'</span>
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>
<span class="hljs-keyword">import</span> ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">"ant-design-vue"</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(userStore)
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">themeStore</span>())

<span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">algorithm</span>: isDark.<span class="hljs-property">value</span> ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>, <span class="hljs-comment">// 核心：切换明暗算法</span>
});

<span class="hljs-title function_">watch</span>(isDark, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">algorithm</span> = newVal ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, newVal);
})


<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: any = {
  <span class="hljs-string">'zh_CN'</span>: zhCN,
  <span class="hljs-string">'en_US'</span>: enUS,
  <span class="hljs-string">'ru_RU'</span>: ruRU
}

<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> obj[lang.<span class="hljs-property">value</span>]
})

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, isDark.<span class="hljs-property">value</span>);
})

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<h4 data-id="heading-19">2.6 使用</h4>
<ul>
<li>使用就非常简单了，通过 <code>var()</code> 使用自定义的css变量即可。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.form</span>{
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-primary);
}
</code></pre>
<h4 data-id="heading-20">2.7 效果预览</h4>
<ul>
<li>效果非常明显，暗黑模式在高亮环境下依然清晰可见。</li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0b776a3df5481ebd38fc0695a4d32f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=o1bG1GhiR1gn%2BYhvetQLHSFYwSA%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e3796e875574ae69cc078d87e02b1ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=NQgKFNe%2FVzsOxl0Vz0%2BZzlj%2Fcws%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d036b0ce29c9456389640599208a71f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=r6xx5Le%2F38zUw6PAewYy17ON36w%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa315dbdc564878857a1ba67e5f87ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=0H%2B%2BwZLLbyBrzLkjAJWUt3Q9Dl0%3D" alt="image.png" width="100%" loading="lazy"/>
<h3 data-id="heading-21">3、测试项目地址</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fzsnoin-can%2Flang-and-dark" target="_blank" title="https://gitee.com/zsnoin-can/lang-and-dark" ref="nofollow noopener noreferrer">gitee.com/zsnoin-can/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[kafka]伪集群搭建,各个节点配置文件中listeners参数的配置]]></title>    <link>https://juejin.cn/post/7585382553290227748</link>    <guid>https://juejin.cn/post/7585382553290227748</guid>    <pubDate>2025-12-20T03:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290227748" data-draft-id="7585412203978031147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[kafka]伪集群搭建,各个节点配置文件中listeners参数的配置"/> <meta itemprop="keywords" content="Kafka"/> <meta itemprop="datePublished" content="2025-12-20T03:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [kafka]伪集群搭建,各个节点配置文件中listeners参数的配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:34:36.000Z" title="Sat Dec 20 2025 03:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>不是的，各个节点的 <code>listeners</code> 配置必须不同</strong>，因为它们是绑定到不同的端口上的。</p>
<h2 data-id="heading-0">一、单机伪集群配置原则</h2>
<p>在一台电脑上部署 Kafka 伪集群时：</p>
<h3 data-id="heading-1">❌ <strong>错误做法</strong>（端口冲突）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 节点1
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093

# 节点2
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093  # ❌ 端口冲突！
</code></pre>
<h3 data-id="heading-2">✅ <strong>正确做法</strong>（不同端口）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 节点1
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093

# 节点2  
listeners=PLAINTEXT://localhost:9095,CONTROLLER://localhost:9096  # ✅ 不同端口

# 节点3
listeners=PLAINTEXT://localhost:9098,CONTROLLER://localhost:9099  # ✅ 不同端口
</code></pre>
<h2 data-id="heading-3">二、完整单机伪集群配置示例（3节点）</h2>
<h3 data-id="heading-4"><strong>端口规划表</strong>：</h3>





























<table><thead><tr><th>节点</th><th>客户端端口</th><th>控制器端口</th><th>日志目录</th></tr></thead><tbody><tr><td>Node1</td><td>9092</td><td>9093</td><td>/tmp/kafka-logs-1</td></tr><tr><td>Node2</td><td>9095</td><td>9096</td><td>/tmp/kafka-logs-2</td></tr><tr><td>Node3</td><td>9098</td><td>9099</td><td>/tmp/kafka-logs-3</td></tr></tbody></table>
<h3 data-id="heading-5"><strong>配置文件：</strong></h3>
<h4 data-id="heading-6"><strong>config/kafka1.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties"># 基本配置
process.roles=broker,controller
node.id=1

# 监听器配置 - 端口 9092/9093
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093
advertised.listeners=PLAINTEXT://localhost:9092

# 数据目录
log.dirs=/tmp/kafka-logs-1

# KRaft 配置
controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099

# 其他配置
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
num.partitions=1
num.recovery.threads.per.data.dir=1
</code></pre>
<h4 data-id="heading-7"><strong>config/kafka2.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties">process.roles=broker,controller
node.id=2

# 监听器配置 - 端口 9095/9096（与节点1不同！）
listeners=PLAINTEXT://localhost:9095,CONTROLLER://localhost:9096
advertised.listeners=PLAINTEXT://localhost:9095

log.dirs=/tmp/kafka-logs-2

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
</code></pre>
<h4 data-id="heading-8"><strong>config/kafka3.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties">process.roles=broker,controller
node.id=3

# 监听器配置 - 端口 9098/9099（与其他节点不同！）
listeners=PLAINTEXT://localhost:9098,CONTROLLER://localhost:9099
advertised.listeners=PLAINTEXT://localhost:9098

log.dirs=/tmp/kafka-logs-3

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
</code></pre>
<h2 data-id="heading-9">三、必须相同的配置 vs 必须不同的配置</h2>
<h3 data-id="heading-10"><strong>必须相同的配置</strong>（集群一致性）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 所有节点的这些配置必须完全一致
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
controller.listener.names=CONTROLLER
inter.broker.listener.name=PLAINTEXT
</code></pre>
<h3 data-id="heading-11"><strong>必须不同的配置</strong>（资源隔离）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 每个节点必须不同
node.id=1                    # 唯一节点ID
listeners=...                # 不同端口
log.dirs=/tmp/kafka-logs-1   # 不同数据目录
</code></pre>
<h2 data-id="heading-12">四、启动脚本示例</h2>
<h3 data-id="heading-13"><strong>start-kafka-cluster.sh</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 生成集群ID（首次运行时使用）</span>
CLUSTER_ID=$(./bin/kafka-storage.sh random-uuid)

<span class="hljs-built_in">echo</span> <span class="hljs-string">"集群ID: <span class="hljs-variable">$CLUSTER_ID</span>"</span>

<span class="hljs-comment"># 格式化存储目录（首次运行需要）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"格式化存储目录..."</span>
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka1.properties
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka2.properties  
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka3.properties

<span class="hljs-comment"># 启动集群（在三个不同的终端中）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点1..."</span>
./bin/kafka-server-start.sh config/kafka1.properties &amp;

<span class="hljs-built_in">echo</span> <span class="hljs-string">"等待5秒..."</span>
<span class="hljs-built_in">sleep</span> 5

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点2..."</span>
./bin/kafka-server-start.sh config/kafka2.properties &amp;

<span class="hljs-built_in">echo</span> <span class="hljs-string">"等待5秒..."</span>  
<span class="hljs-built_in">sleep</span> 5

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点3..."</span>
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka3.properties

<span class="hljs-built_in">echo</span> <span class="hljs-string">"集群启动完成！"</span>
</code></pre>
<h2 data-id="heading-14">五、验证集群状态</h2>
<h3 data-id="heading-15"><strong>检查端口占用</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有Kafka相关端口</span>
netstat -an | grep -E <span class="hljs-string">"9092|9093|9095|9096|9098|9099"</span>

<span class="hljs-comment"># 或使用 lsof</span>
lsof -i :9092,9093,9095,9096,9098,9099
</code></pre>
<h3 data-id="heading-16"><strong>测试集群功能</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用任意一个节点的客户端端口</span>
BOOTSTRAP_SERVER=<span class="hljs-string">"localhost:9092"</span>

<span class="hljs-comment"># 创建主题</span>
./bin/kafka-topics.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  --create --topic test-topic \
  --partitions 3 --replication-factor 3

<span class="hljs-comment"># 查看主题详情</span>
./bin/kafka-topics.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  --describe --topic test-topic

<span class="hljs-comment"># 查看集群元数据</span>
./bin/kafka-metadata-quorum.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  describe --status
</code></pre>
<h2 data-id="heading-17">六、使用 Docker Compose 的单机伪集群配置</h2>
<p>如果你更喜欢用 Docker，这里是一个 <code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">kafka1:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka1</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9092:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9093:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9092"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-1"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-1:/tmp/kafka-logs-1</span>

  <span class="hljs-attr">kafka2:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka2</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9095:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9096:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">2</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9095"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-2"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-2:/tmp/kafka-logs-2</span>

  <span class="hljs-attr">kafka3:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka3</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9098:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9099:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9098"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-3"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-3:/tmp/kafka-logs-3</span>
</code></pre>
<h2 data-id="heading-18">七、常见问题解决</h2>
<h3 data-id="heading-19"><strong>问题1：端口已占用</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决方案：修改端口</span>
<span class="hljs-comment"># 节点1：9092,9093 → 修改为 19092,19093</span>
<span class="hljs-comment"># 节点2：9095,9096 → 修改为 19095,19096</span>
<span class="hljs-comment"># 节点3：9098,9099 → 修改为 19098,19099</span>
</code></pre>
<h3 data-id="heading-20"><strong>问题2：启动顺序问题</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># KRaft 模式需要至少一个控制器先启动</span>
<span class="hljs-comment"># 解决方案：逐个启动，间隔几秒</span>
./bin/kafka-server-start.sh config/kafka1.properties
<span class="hljs-comment"># 等待10秒</span>
./bin/kafka-server-start.sh config/kafka2.properties
<span class="hljs-comment"># 等待10秒</span>
./bin/kafka-server-start.sh config/kafka3.properties
</code></pre>
<h3 data-id="heading-21"><strong>问题3：数据目录冲突</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决方案：使用不同的目录</span>
log.dirs=/tmp/kafka-cluster/node1
log.dirs=/tmp/kafka-cluster/node2
log.dirs=/tmp/kafka-cluster/node3
</code></pre>
<h2 data-id="heading-22">八、简化的配置方法（使用脚本自动生成）</h2>
<h3 data-id="heading-23"><strong>generate-configs.sh</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

BASE_PORT=9092
CONTROLLER_BASE_PORT=9093
NODES=3

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 1 <span class="hljs-variable">$NODES</span>); <span class="hljs-keyword">do</span>
  CLIENT_PORT=$((BASE_PORT + (i-<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>))
  CONTROLLER_PORT=$((CONTROLLER_BASE_PORT + (i-<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>))
  
  <span class="hljs-built_in">cat</span> &gt; config/kafka<span class="hljs-variable">$i</span>.properties &lt;&lt; <span class="hljs-string">EOF
# 自动生成的配置 - 节点$i
process.roles=broker,controller
node.id=$i

listeners=PLAINTEXT://localhost:$CLIENT_PORT,CONTROLLER://localhost:$CONTROLLER_PORT
advertised.listeners=PLAINTEXT://localhost:$CLIENT_PORT

log.dirs=/tmp/kafka-logs-$i

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099

num.partitions=3
default.replication.factor=3
min.insync.replicas=2
EOF</span>
  
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"生成 config/kafka<span class="hljs-variable">$i</span>.properties: client_port=<span class="hljs-variable">$CLIENT_PORT</span>, controller_port=<span class="hljs-variable">$CONTROLLER_PORT</span>"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p><strong>总结关键点</strong>：</p>
<ol>
<li>✅ <strong>每个节点必须有唯一的端口组合</strong></li>
<li>✅ <strong><code>controller.quorum.voters</code> 必须完全相同</strong></li>
<li>✅ <strong>数据目录必须不同</strong></li>
<li>✅ <strong>节点ID必须唯一</strong></li>
<li>❌ <strong>不要复用端口</strong>，一台机器上的端口不能重复绑定</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TanStack Router 基于文件的路由]]></title>    <link>https://juejin.cn/post/7585400495683305514</link>    <guid>https://juejin.cn/post/7585400495683305514</guid>    <pubDate>2025-12-20T02:17:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683305514" data-draft-id="7585397173022982163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TanStack Router 基于文件的路由"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:17:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TanStack Router 基于文件的路由
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:17:28.000Z" title="Sat Dec 20 2025 02:17:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TanStack Router 的大部分文档都是基于“基于文件的路由”这一视角编写的，旨在帮助你深入理解如何配置它以及其背后的技术细节。虽然<strong>基于文件的路由是配置 TanStack Router 的首选和推荐方式</strong>，但如果你愿意，也可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Fcode-based-routing" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/code-based-routing" ref="nofollow noopener noreferrer">基于代码的路由</a>。</p>
<h2 data-id="heading-0">什么是基于文件的路由？</h2>
<p>基于文件的路由是一种利用文件系统来配置路由的方式。你不需要通过代码定义路由结构，而是通过一系列代表应用程序路由层级的文件和目录来定义路由。这带来了许多好处：</p>
<ul>
<li>
<p><strong>简单性 (Simplicity)</strong>：对于新手和经验丰富的开发者来说，基于文件的路由都在视觉上更直观且易于理解。</p>
</li>
<li>
<p><strong>组织性 (Organization)</strong>：路由的组织方式直接镜像了应用程序的 URL 结构。</p>
</li>
<li>
<p><strong>可扩展性 (Scalability)</strong>：随着应用程序的增长，基于文件的路由使得添加新路由和维护现有路由变得容易。</p>
</li>
<li>
<p><strong>代码分割 (Code-Splitting)</strong>：基于文件的路由允许 TanStack Router 自动对路由进行代码分割，以获得更好的性能。</p>
</li>
<li>
<p><strong>类型安全 (Type-Safety)</strong>：基于文件的路由通过自动生成和管理路由的类型链接，极大提升了类型安全的上限，而在基于代码的路由中，这通常是一个繁琐的过程。</p>
</li>
<li>
<p><strong>一致性 (Consistency)</strong>：基于文件的路由强制执行一致的路由结构，使得维护、更新应用程序以及在不同项目间迁移变得更加容易。</p>
</li>
</ul>
<h2 data-id="heading-1"><code>/</code> 还是 <code>.</code> ？</h2>
<p>虽然目录长期以来一直用于表示路由层级，但基于文件的路由引入了一个额外的概念：在文件名中使用 <code>.</code> 字符来表示路由嵌套。这允许你避免为少量深度嵌套的路由创建目录，同时继续为更广泛的路由层级使用目录。让我们看一些例子！</p>
<h2 data-id="heading-2">目录路由 (Directory Routes)</h2>
<p>目录可用于表示路由层级，这对于将多个路由组织成逻辑组以及减少大量深度嵌套路由的文件名长度非常有用。</p>
<p>请看下面的例子：</p>





























































































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>📂 <code>posts</code></td><td/><td/></tr><tr><td>┄ ʦ <code>index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>📂 <code>posts_</code></td><td/><td/></tr><tr><td>┄ 📂 <code>$postId</code></td><td/><td/></tr><tr><td>┄ ┄ ʦ <code>edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>📂 <code>settings</code></td><td/><td/></tr><tr><td>┄ ʦ <code>profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>┄ ʦ <code>notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.tsx</code></td><td/><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;</code></td></tr><tr><td>📂 <code>_pathlessLayout</code></td><td/><td/></tr><tr><td>┄ ʦ <code>route-a.tsx</code></td><td><code>/route-a</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteA&gt;</code></td></tr><tr><td>┄ ʦ <code>route-b.tsx</code></td><td><code>/route-b</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteB&gt;</code></td></tr><tr><td>📂 <code>files</code></td><td/><td/></tr><tr><td>┄ ʦ <code>$.tsx</code></td><td><code>/files/$</code></td><td><code>&lt;Root&gt;&lt;Files&gt;</code></td></tr><tr><td>📂 <code>account</code></td><td/><td/></tr><tr><td>┄ ʦ <code>route.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>┄ ʦ <code>overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<h2 data-id="heading-3">扁平路由 (Flat Routes)</h2>
<p>扁平路由赋予你使用 <code>.</code> 来表示路由嵌套层级的能力。</p>
<p>当你有大量独特的深度嵌套路由，并且希望避免为每一个路由都创建目录时，这非常有用：</p>
<p>请看下面的例子：</p>


























































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>ʦ <code>posts.index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>ʦ <code>posts.$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>ʦ <code>posts_.$postId.edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>ʦ <code>settings.profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>ʦ <code>settings.notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.tsx</code></td><td/><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.route-a.tsx</code></td><td><code>/route-a</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteA&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.route-b.tsx</code></td><td><code>/route-b</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteB&gt;</code></td></tr><tr><td>ʦ <code>files.$.tsx</code></td><td><code>/files/$</code></td><td><code>&lt;Root&gt;&lt;Files&gt;</code></td></tr><tr><td>ʦ <code>account.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>ʦ <code>account.overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<h2 data-id="heading-4">混合扁平路由和目录路由</h2>
<p>极有可能 100% 的目录结构或 100% 的扁平路由结构都不完全适合你的项目，这就是为什么 TanStack Router 允许你将扁平路由和目录路由<strong>混合使用</strong>，从而创建一个结合两者优点的路由树。</p>
<p>请看下面的例子：</p>











































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>📂 <code>posts</code></td><td/><td/></tr><tr><td>┄ ʦ <code>index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>ʦ <code>settings.profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>ʦ <code>settings.notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>account.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>ʦ <code>account.overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<p>扁平路由和目录路由可以混合在一起，以便在合理的地方结合两者的优点来创建路由树。</p>
<blockquote>
<p>[!TIP]</p>
<p>如果你发现默认的基于文件的路由结构不符合你的需求，你始终可以使用 虚拟文件路由 (Virtual File Routes) 来控制路由的来源，同时仍然享受基于文件路由带来的出色性能优势。</p>
</blockquote>
<h2 data-id="heading-5">开始使用基于文件的路由</h2>
<p>要开始使用基于文件的路由，你需要配置你项目的打包工具（Bundler）以使用 TanStack Router Plugin 或 TanStack Router CLI。</p>
<p>要启用基于文件的路由，你需要在使用 React 的同时使用受支持的打包工具。请查看下面的配置指南，看看你的打包工具是否在列表中。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-vite" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-vite" ref="nofollow noopener noreferrer">Installation with Vite</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-rspack" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-rspack" ref="nofollow noopener noreferrer">Installation with Rspack/Rsbuild</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-webpack" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-webpack" ref="nofollow noopener noreferrer">Installation with Webpack</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-esbuild" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-esbuild" ref="nofollow noopener noreferrer">Installation with Esbuild</a></li>
</ul>
<p>当通过受支持的打包工具使用 TanStack Router 的基于文件的路由时，插件将<strong>通过打包工具的开发和构建过程自动生成你的路由配置</strong>。这是使用 TanStack Router 路由生成功能最简单的方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录]]></title>    <link>https://juejin.cn/post/7585206349749502004</link>    <guid>https://juejin.cn/post/7585206349749502004</guid>    <pubDate>2025-12-19T11:00:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585206349749502004" data-draft-id="7585394082822832162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录"/> <meta itemprop="keywords" content="OpenAI,后端"/> <meta itemprop="datePublished" content="2025-12-19T11:00:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sdguy"/> <meta itemprop="url" content="https://juejin.cn/user/1416608279436087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1416608279436087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sdguy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:00:37.000Z" title="Fri Dec 19 2025 11:00:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录</h2>
<blockquote>
<p>本文记录了一次在 <strong>Windows + pnpm 环境下安装 OpenAI Codex CLI</strong> 的完整踩坑与修复过程。<br/>
如果你遇到过 <code>pnpm global</code> 失败、<code>NO_GLOBAL_BIN_DIR</code>、安装卡死、PATH 混乱等问题，这篇文章可以作为一份<strong>可复用的工程级解决方案</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、问题背景：Codex 安装为什么会这么“折磨”</h3>
<p>我最初的目标非常简单：</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -g <span class="hljs-keyword">@openai</span>/codex
</code></pre>
<p>结果却遇到了以下问题组合：</p>
<ul>
<li>pnpm 报错：<code>ERR_PNPM_NO_GLOBAL_BIN_DIR</code></li>
<li>npm / pnpm 全局安装长时间“转圈”</li>
<li>Windows 下 PATH / 全局 bin 行为不透明</li>
<li>即使安装成功，也无法确认 <code>codex</code> 是否真正可用</li>
</ul>
<p>这类问题并不是 Codex 独有，而是 <strong>Windows + Node 全局工具链</strong> 的系统性问题。</p>
<hr/>
<h3 data-id="heading-2">二、核心结论先行（给着急的人）</h3>
<p>如果你只关心最终答案：</p>
<blockquote>
<p><strong>在 Windows 上使用 pnpm 全局 CLI 的前提是：必须正确初始化 <code>PNPM_HOME</code>，并确保全局 bin 被实际生成。</strong></p>
</blockquote>
<p>Codex 安装失败，<strong>90% 不是 Codex 的问题，而是 pnpm 全局环境未就绪</strong>。</p>
<hr/>
<h3 data-id="heading-3">三、第一步：正确初始化 pnpm 全局环境（关键）</h3>
<h4 data-id="heading-4">1️⃣ 执行 pnpm 官方初始化命令</h4>
<pre><code class="hljs language-arduino" lang="arduino">pnpm setup
</code></pre>
<p>成功后，pnpm 会：</p>
<ul>
<li>创建 <code>PNPM_HOME</code></li>
<li>修改用户级 PATH</li>
<li>输出提示：<strong>需要重开终端</strong></li>
</ul>
<p>⚠️ <strong>这一步之后必须关闭 PowerShell 窗口并重新打开</strong></p>
<hr/>
<h4 data-id="heading-5">2️⃣ 验证环境变量是否生效</h4>
<p>重新打开 PowerShell 后执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:PNPM_HOME
pnpm -v
</code></pre>
<p>期望结果类似：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\xxx\AppData\Local\pnpm</span>
10.x.x
</code></pre>
<hr/>
<h3 data-id="heading-6">四、一个容易误判的点：PNPM_HOME 里只有 <code>store/</code> 正常吗？</h3>
<p>刚完成 <code>pnpm setup</code> 后，我看到的目录是：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\xxx\AppData\Local\pnpm</span>
└── store/
</code></pre>
<p><strong>这是正常的，但还不算“完成”</strong> 。</p>
<p>原因是：</p>
<blockquote>
<p>pnpm 只有在 <strong>第一次发生全局安装行为时</strong>，才会生成全局可执行文件（pnpm / pnpx shim）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">五、触发 pnpm 全局 bin 初始化（v10 正确方式）</h3>
<p>在 pnpm v10 之后：</p>
<ul>
<li>❌ 不再允许 <code>pnpm add -g pnpm</code></li>
<li>✅ 正确方式是：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">pnpm <span class="hljs-built_in">self</span>-update
</code></pre>
<p>执行完成后，再查看：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> <span class="hljs-variable">$env</span>:PNPM_HOME
</code></pre>
<p>此时应该能看到类似内容：</p>
<pre><code class="hljs language-swift" lang="swift">.tools<span class="hljs-operator">/</span>
store<span class="hljs-operator">/</span>
pnpm
pnpm.<span class="hljs-type">CMD</span>
pnpx
pnpx.<span class="hljs-type">CMD</span>
</code></pre>
<p>这一步是 <strong>pnpm 全局环境真正就绪的标志</strong>。</p>
<hr/>
<h3 data-id="heading-8">六、验证 pnpx 是否可用（重要验收点）</h3>
<p>不要用 <code>pnpx --version</code>（这是不支持的）。</p>
<p>正确的验证方式是：</p>
<pre><code class="hljs">pnpx cowsay hello
</code></pre>
<p>如果你看到一只牛输出 <code>hello</code>，说明：</p>
<ul>
<li>PNPM_HOME ✔</li>
<li>PATH ✔</li>
<li>pnpx / dlx 执行链 ✔</li>
</ul>
<hr/>
<h3 data-id="heading-9">七、正式安装 OpenAI Codex CLI（可观测方式）</h3>
<h4 data-id="heading-10">1️⃣（可选但强烈推荐）设置国内 registry</h4>
<pre><code class="hljs language-arduino" lang="arduino">pnpm config set registry https:<span class="hljs-comment">//registry.npmmirror.com</span>
</code></pre>
<p>避免 100MB+ 包下载卡死。</p>
<hr/>
<h4 data-id="heading-11">2️⃣ 安装 Codex（带 ndjson 日志）</h4>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>g <span class="hljs-variable">@openai</span><span class="hljs-operator">/</span>codex <span class="hljs-comment">--reporter ndjson</span>
</code></pre>
<p>在日志中你应该能看到：</p>
<ul>
<li><code>@openai/codex@x.y.z</code> resolved</li>
<li>fetched（完整下载）</li>
<li>imported</li>
<li>linked</li>
<li>没有 postinstall 错误</li>
</ul>
<hr/>
<h3 data-id="heading-12">八、Codex 是否真正安装成功？最终验收标准</h3>
<p><strong>不要只看安装日志，看这一步：</strong></p>
<pre><code class="hljs language-bash" lang="bash">codex --<span class="hljs-built_in">help</span>
</code></pre>
<p>如果你能看到完整的 CLI 帮助，例如：</p>
<ul>
<li><code>exec</code></li>
<li><code>review</code></li>
<li><code>mcp / mcp-server</code></li>
<li><code>sandbox</code></li>
<li><code>apply</code></li>
<li><code>--version</code></li>
</ul>
<p>👉 <strong>这意味着 Codex CLI 已 100% 可用</strong></p>
<hr/>
<h3 data-id="heading-13">九、关于 <code>where codex</code> 没有输出的说明</h3>
<p>在 Windows + pnpm 场景下：</p>
<ul>
<li>可执行文件通常是 <code>codex.CMD</code></li>
<li>PowerShell 的 <code>where</code> 有时不会显示 shim</li>
<li><strong>只要 <code>codex</code> 能直接运行，就不是问题</strong></li>
</ul>
<hr/>
<h3 data-id="heading-14">十、登录与使用</h3>
<p>首次使用前执行：</p>
<pre><code class="hljs">codex login
</code></pre>
<p>认证信息会保存在 <code>~/.codex/</code>，不污染环境变量。</p>
<hr/>
<h3 data-id="heading-15">十一、一些经验总结（非常重要）</h3>
<h4 data-id="heading-16">1️⃣ 不要急着怪 Codex</h4>
<ul>
<li>Codex 安装慢 / 失败<br/>
→ <strong>99% 是 Node 全局环境问题</strong></li>
</ul>
<h4 data-id="heading-17">2️⃣ Windows 下推荐顺序</h4>
<pre><code class="hljs language-sql" lang="sql">pnpm setup
→ 重开终端
→ pnpm self<span class="hljs-operator">-</span><span class="hljs-keyword">update</span>
→ pnpx 验证
→ pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>g <span class="hljs-variable">@openai</span><span class="hljs-operator">/</span>codex
</code></pre>
<h4 data-id="heading-18">3️⃣ 如果只是“想用”，npx / pnpx 也是合理选择</h4>
<pre><code class="hljs language-bash" lang="bash">pnpx @openai/codex
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TanStack Router 文件命名约定]]></title>    <link>https://juejin.cn/post/7585382553290063908</link>    <guid>https://juejin.cn/post/7585382553290063908</guid>    <pubDate>2025-12-20T02:20:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290063908" data-draft-id="7585382553290047524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TanStack Router 文件命名约定"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:20:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TanStack Router 文件命名约定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:20:25.000Z" title="Sat Dec 20 2025 02:20:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于文件的路由要求你遵循一些简单的文件命名约定，以确保正确生成路由。这些约定所启用的概念在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Froute-trees" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/route-trees" ref="nofollow noopener noreferrer">路由树与嵌套</a> 指南中有详细介绍。</p>

















































<table><thead><tr><th><strong>特性 (Feature)</strong></th><th><strong>描述 (Description)</strong></th></tr></thead><tbody><tr><td><strong><code>__root.tsx</code></strong></td><td>根路由文件必须命名为 <code>__root.tsx</code>，并且必须放置在配置的 <code>routesDirectory</code> 的根目录下。</td></tr><tr><td><strong><code>.</code> 分隔符</strong></td><td>路由可以使用 <code>.</code> 字符来表示嵌套路由。例如，<code>blog.post</code> 将生成为 <code>blog</code> 的子路由。</td></tr><tr><td><strong><code>$</code> 标记</strong></td><td>带有 <code>$</code> 标记的路由片段是参数化的，并将从 URL 路径名中提取值作为路由 <code>param</code>（参数）。</td></tr><tr><td><strong><code>_</code> 前缀</strong></td><td>带有 <code>_</code> 前缀的路由片段被视为<strong>无路径布局路由</strong>，在将子路由与 URL 路径名匹配时不会使用它。</td></tr><tr><td><strong><code>_</code> 后缀</strong></td><td>带有 <code>_</code> 后缀的路由片段将该路由排除在任何父路由的嵌套之外（即非嵌套路由）。</td></tr><tr><td><strong><code>-</code> 前缀</strong></td><td>带有 <code>-</code> 前缀的文件和文件夹将从路由树中<strong>排除</strong>。它们不会被添加到 <code>routeTree.gen.ts</code> 文件中，可用于在路由文件夹中共存逻辑代码。</td></tr><tr><td><strong><code>(folder)</code> 文件夹名模式</strong></td><td>匹配此模式的文件夹被视为<strong>路由组</strong>，防止该文件夹包含在路由的 URL 路径中。</td></tr><tr><td><strong><code>[x]</code> 转义</strong></td><td>方括号用于转义文件名中具有路由含义的特殊字符。例如，<code>script[.]js.tsx</code> 变为 <code>/script.js</code>，<code>api[.]v1.tsx</code> 变为 <code>/api.v1</code>。</td></tr><tr><td><strong><code>index</code> 标记</strong></td><td>以 <code>index</code> 标记结尾（在任何文件扩展名之前）的路由片段，当 URL 路径名精确匹配父路由时，将匹配父路由。这可以通过 <code>indexToken</code> 配置选项进行配置，参见 [suspicious link removed]。</td></tr><tr><td><strong><code>.route.tsx</code> 文件类型</strong></td><td>当使用目录组织路由时，<code>route</code> 后缀可用于在目录路径处创建路由文件。例如，<code>blog.post.route.tsx</code> 或 <code>blog/post/route.tsx</code> 可用作 <code>/blog/post</code> 路由的路由文件。这可以通过 <code>routeToken</code> 配置选项进行配置，参见 [suspicious link removed]。</td></tr></tbody></table>
<blockquote>
<p><strong>💡 记住：</strong> 项目的文件命名约定可能会受到所配置的 [suspicious link removed] 的影响。</p>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p>要转义尾随下划线（例如 /posts[_].tsx），需要使用升级后的 非嵌套路由。</p>
</blockquote>
<h2 data-id="heading-0">动态路径参数 (Dynamic Path Params)</h2>
<p>动态路径参数可用于扁平路由和目录路由，以创建可以匹配 URL 路径动态片段的路由。动态路径参数由文件名中的 <code>$</code> 字符表示：</p>




















<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>ʦ <code>posts.$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr></tbody></table>
<p>我们将在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Fguide%2Fpath-params" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/guide/path-params" ref="nofollow noopener noreferrer">路径参数</a> 指南中了解更多关于动态路径参数的信息。</p>
<h2 data-id="heading-1">无路径路由 (Pathless Routes)</h2>
<p>无路径路由用逻辑或组件包裹子路由，而不需要 URL 路径。无路径路由由文件名中的 <code>_</code> 字符表示：</p>

























<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>_app.tsx</code></td><td/><td/></tr><tr><td>ʦ <code>_app.a.tsx</code></td><td>/a</td><td><code>&lt;Root&gt;&lt;App&gt;&lt;A&gt;</code></td></tr><tr><td>ʦ <code>_app.b.tsx</code></td><td>/b</td><td><code>&lt;Root&gt;&lt;App&gt;&lt;B&gt;</code></td></tr></tbody></table>
<p>要了解更多关于无路径路由的信息，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Frouting-concepts%23pathless-layout-routes" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/routing-concepts#pathless-layout-routes" ref="nofollow noopener noreferrer">路由概念 - 无路径路由</a> 指南。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[升级二进制kubernetes集群（小版本升级）]]></title>    <link>https://juejin.cn/post/7585395972294148105</link>    <guid>https://juejin.cn/post/7585395972294148105</guid>    <pubDate>2025-12-19T11:25:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294148105" data-draft-id="7585406229167587378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="升级二进制kubernetes集群（小版本升级）"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-19T11:25:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈运维"/> <meta itemprop="url" content="https://juejin.cn/user/3315782802482007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            升级二进制kubernetes集群（小版本升级）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782802482007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈运维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:25:29.000Z" title="Fri Dec 19 2025 11:25:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">升级二进制kubernetes集群（小版本升级）</h2>
<p>此文档基于我的二进制安装仓库
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<h3 data-id="heading-1">基础操作</h3>
<h4 data-id="heading-2">查看当前版本信息</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS   ROLES    AGE    VERSION
k8s-master01   Ready    &lt;none&gt;   110d   v1.34.0
k8s-master02   Ready    &lt;none&gt;   110d   v1.34.0
k8s-master03   Ready    &lt;none&gt;   110d   v1.34.0
k8s-node01     Ready    &lt;none&gt;   110d   v1.34.0
k8s-node02     Ready    &lt;none&gt;   110d   v1.34.0
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-3">主机域名以及IP地址</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# cat /etc/hosts | grep k8s
192.168.1.31 k8s-master01
192.168.1.32 k8s-master02
192.168.1.33 k8s-master03
192.168.1.34 k8s-node01
192.168.1.35 k8s-node02
fc00::31 k8s-master01
fc00::32 k8s-master02
fc00::33 k8s-master03
fc00::34 k8s-node01
fc00::35 k8s-node02
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-4">下载二进制安装包</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.34.3/kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.35.0/kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-5">解压二进制安装包</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# tar xf kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-6">升级Maser</h3>
<h4 data-id="heading-7">升级三台主节点上的客户端</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.32:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.33:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kubectl version
Client Version: v1.34.3
Kustomize Version: v5.7.1
Server Version: v1.34.0
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-8">升级三台主节点api组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-apiserver root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-apiserver --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 

</code></pre>
<h4 data-id="heading-9">升级三台主节点控制器组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-controller-manager root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-controller-manager --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-10">升级三台主节点选择器组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-scheduler root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-scheduler --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-11">升级Worker</h3>
<h4 data-id="heading-12">每一台机器都要升级kubelet</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubelet root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "kubelet --version"
Kubernetes v1.34.3
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-13">每一台机器都要升级kube-proxy</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-proxy root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-proxy --version
</code></pre>
<h3 data-id="heading-14">验证</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS   ROLES    AGE    VERSION
k8s-master01   Ready    &lt;none&gt;   110d   v1.34.3
k8s-master02   Ready    &lt;none&gt;   110d   v1.34.3
k8s-master03   Ready    &lt;none&gt;   110d   v1.34.3
k8s-node01     Ready    &lt;none&gt;   110d   v1.34.3
k8s-node02     Ready    &lt;none&gt;   110d   v1.34.3
[root@k8s-master01 ~]# 

[root@k8s-master01 ~]# kubectl  version
Client Version: v1.34.3
Kustomize Version: v5.7.1
Server Version: v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<blockquote>
<p><strong>关于</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2F" target="_blank" title="https://www.oiox.cn/" ref="nofollow noopener noreferrer">www.oiox.cn/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2Findex.php%2Fstart-page.html" target="_blank" title="https://www.oiox.cn/index.php/start-page.html" ref="nofollow noopener noreferrer">www.oiox.cn/index.php/s…</a></p>
<p><strong>CSDN、GitHub、知乎、开源中国、思否、掘金、简书、华为云、阿里云、腾讯云、哔哩哔哩、今日头条、新浪微博、个人博客</strong></p>
<p><strong>全网可搜《小陈运维》</strong></p>
<p><strong>文章主要发布于微信公众号</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘]]></title>    <link>https://juejin.cn/post/7585410547336626226</link>    <guid>https://juejin.cn/post/7585410547336626226</guid>    <pubDate>2025-12-19T11:59:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547336626226" data-draft-id="7585406229167718450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘"/> <meta itemprop="keywords" content="前端,IndexedDB,Agent"/> <meta itemprop="datePublished" content="2025-12-19T11:59:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:59:46.000Z" title="Fri Dec 19 2025 11:59:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景：智能体对话的"失忆症"困扰</h2>
<p>在使用智能体服务的过程中，我们遇到了一个令人困扰的问题：<strong>智能体没有历史会话记录功能</strong>。每次刷新页面或重新打开应用，之前与 AI 的对话就消失了，就像智能体患上了"失忆症"。</p>
<h3 data-id="heading-1">1.1 痛点分析</h3>
<h4 data-id="heading-2">痛点 1：对话上下文丢失</h4>
<p>用户在与智能体交流时，经常需要进行多轮对话。例如：</p>
<ul>
<li><strong>第一轮</strong>："帮我分析一下企业信用风险评估的流程"</li>
<li><strong>第二轮</strong>："刚才提到的第三步能详细说明吗？"（❌ 刷新后无法继续）</li>
<li><strong>第三轮</strong>："这个方案在反欺诈场景下怎么应用？"（❌ 上下文全部丢失）</li>
</ul>
<p><strong>影响</strong>：用户需要重新描述问题背景，降低了交互效率，破坏了对话的连贯性。</p>
<h4 data-id="heading-3">痛点 2：知识检索效率低</h4>
<p>在日常工作中，用户可能会反复查询相似的问题：</p>
<ul>
<li>上周询问过的技术方案，本周需要再次查阅</li>
<li>与同事讨论时需要回顾之前与 AI 的对话内容</li>
<li>需要整理 AI 给出的多次建议进行对比</li>
</ul>
<p><strong>影响</strong>：没有历史记录意味着每次都要重新提问，浪费 AI 计算资源和用户时间。</p>
<h4 data-id="heading-4">痛点 3：用户体验不佳</h4>
<p>对比主流的 AI 对话产品（ChatGPT、Claude、文心一言等），用户已经习惯了以下体验：</p>
<ul>
<li>可以随时回顾历史对话</li>
<li>可以继续之前的话题</li>
<li>可以在多个设备间切换（云端同步）</li>
</ul>
<p><strong>影响</strong>：缺乏历史会话功能让产品的用户体验大打折扣，降低了用户粘性。</p>
<h3 data-id="heading-5">1.2 为什么历史会话如此重要？</h3>
<p>从产品价值角度看，历史会话功能带来的价值不容忽视：</p>





























<table><thead><tr><th>价值维度</th><th>具体体现</th></tr></thead><tbody><tr><td><strong>提升效率</strong></td><td>快速回顾历史方案，无需重复提问</td></tr><tr><td><strong>增强连贯性</strong></td><td>支持多轮对话，深度交流</td></tr><tr><td><strong>知识沉淀</strong></td><td>历史对话成为个人知识库</td></tr><tr><td><strong>优化决策</strong></td><td>对比多次咨询结果，做出更好的决策</td></tr><tr><td><strong>用户留存</strong></td><td>符合用户使用习惯，提升满意度</td></tr></tbody></table>
<h2 data-id="heading-6">二、技术选型：为什么选择前端 IndexedDB 方案？</h2>
<p>面对这个痛点，我们有多种技术方案可选：</p>
<h3 data-id="heading-7">2.1 方案对比</h3>



































<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>后端数据库存储</strong></td><td>数据可靠、支持多端同步</td><td>增加服务器压力、开发周期长、依赖后端服务</td><td>企业级应用、需要多端同步</td></tr><tr><td><strong>LocalStorage</strong></td><td>简单易用</td><td>容量限制（5-10MB）、无索引、性能差</td><td>简单配置存储</td></tr><tr><td><strong>SessionStorage</strong></td><td>页面级隔离</td><td>刷新即失效、无法持久化</td><td>临时数据</td></tr><tr><td><strong>IndexedDB（✅ 我们的选择）</strong></td><td>大容量、高性能、支持索引、离线可用</td><td>API 相对复杂</td><td>大量结构化数据存储</td></tr></tbody></table>
<h3 data-id="heading-8">2.2 为什么选择前端 IndexedDB 方案？</h3>
<p>经过技术调研和业务分析，我们最终选择了<strong>基于 IndexedDB 的前端存储方案</strong>，主要基于以下考虑：</p>
<h4 data-id="heading-9">✅ 优势 1：极致的加载速度</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统后端方案：需要网络请求</span>
用户点击历史对话 → 发送 <span class="hljs-variable constant_">HTTP</span> 请求 → 等待服务器响应 → 数据返回 → 渲染
⏱️ 耗时：500ms - 2000ms（取决于网络状况）

<span class="hljs-comment">// IndexedDB 方案：本地读取</span>
用户点击历史对话 → 从本地数据库读取 → 渲染
⏱️ 耗时：10ms - 50ms（纯本地操作）
</code></pre>
<p><strong>性能提升：10-200 倍！</strong></p>
<h4 data-id="heading-10">✅ 优势 2：天然的用户数据隔离</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 数据按用户 ERP 存储</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConversationRecord</span> {
  <span class="hljs-attr">erp</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 用户唯一标识</span>
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">historyMessages</span>: <span class="hljs-title class_">HistoryMessage</span>[];
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 查询时自动隔离</span>
<span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">getByErp</span>(currentUserErp);
</code></pre>
<p>每个用户的数据存储在各自的浏览器中，<strong>天然实现了数据隔离</strong>，无需担心数据泄露或混淆。</p>
<h4 data-id="heading-11">✅ 优势 3：大幅降低后端压力</h4>
<p>让我们用数据说话：</p>
<p><strong>假设场景</strong>：</p>
<ul>
<li>1000 个活跃用户</li>
<li>每人每天查看历史对话 10 次</li>
<li>每次加载 50 条历史消息</li>
</ul>
<p><strong>后端方案的资源消耗</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">每日数据库查询次数：1000 * <span class="hljs-attr">10</span> = <span class="hljs-number">10</span>,<span class="hljs-number">000</span> 次/天
每次查询响应大小：~50KB
每日流量消耗：10,000 * 50KB ≈ 488 MB/天
数据库连接开销：高
服务器 CPU/内存占用：显著
</code></pre>
<p><strong>IndexedDB 方案的资源消耗</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">后端请求次数：仅在新对话时需要调用 SSE 接口
历史加载请求：<span class="hljs-number">0</span> 次（完全本地化）
服务器压力：降低 <span class="hljs-number">90</span><span class="hljs-comment">% 以上</span>
后端成本：显著降低
</code></pre>
<p><strong>成本对比</strong>：</p>



































<table><thead><tr><th>维度</th><th>后端方案</th><th>IndexedDB 方案</th><th>节省比例</th></tr></thead><tbody><tr><td>数据库查询</td><td>10,000 次/天</td><td>~100 次/天（仅新对话）</td><td><strong>90%</strong></td></tr><tr><td>网络流量</td><td>488 MB/天</td><td>~10 MB/天</td><td><strong>98%</strong></td></tr><tr><td>服务器负载</td><td>高</td><td>低</td><td><strong>80%+</strong></td></tr><tr><td>响应延迟</td><td>500-2000ms</td><td>10-50ms</td><td><strong>95%</strong></td></tr></tbody></table>
<h4 data-id="heading-12">✅ 优势 4：离线可用性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 即使在网络断开的情况下</span>
<span class="hljs-comment">// 用户依然可以：</span>
✅ 查看所有历史对话
✅ 浏览过往聊天记录
✅ 搜索历史内容（规划中）
</code></pre>
<p>这对于网络不稳定的场景特别有价值。</p>
<h4 data-id="heading-13">✅ 优势 5：敏捷的开发迭代</h4>
<pre><code class="hljs language-diff" lang="diff">后端方案开发周期：
<span class="hljs-deletion">- 数据库表设计：1天</span>
<span class="hljs-deletion">- 后端接口开发：2天</span>
<span class="hljs-deletion">- 前端开发：1天</span>
<span class="hljs-deletion">- 接口联调测试：1天</span>
<span class="hljs-deletion">- 测试优化：1天</span>
总计：7天

IndexedDB 方案开发周期：
<span class="hljs-deletion">- 数据库封装：1天</span>
<span class="hljs-deletion">- 前端开发集成：1天</span>
<span class="hljs-deletion">- 测试优化：1天</span>
总计：3天
</code></pre>
<p>而且无需协调后端资源，<strong>前端独立完成</strong>，迭代更加敏捷。</p>
<h4 data-id="heading-14">✅ 优势 6：强大的查询能力</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// IndexedDB 支持多维度索引查询</span>
- 按用户查询：<span class="hljs-title function_">getByErp</span>(erp)
- 按模块查询：<span class="hljs-title function_">getByCode</span>(code)
- 按会话查询：<span class="hljs-title function_">getByTraceId</span>(traceId)
- 复合查询：<span class="hljs-title function_">getByErpAndCode</span>(erp, code)
- 时间范围查询：按 createdAt 索引排序
</code></pre>
<p>通过合理的索引设计，查询性能可以媲美专业数据库。</p>
<h2 data-id="heading-15">三、技术实现：如何构建一个高性能的前端存储方案</h2>
<h3 data-id="heading-16">3.1 整体架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────┐
│                     用户界面层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ 历史会话列表  │  │  消息展示区   │  │   输入框     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────┬──────────────────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────────────────┐
│                     业务逻辑层                           │
│  - 会话管理（创建、切换、加载）                           │
│  - 消息处理（发送、接收、保存）                           │
│  - 状态管理（React State + Zustand）                    │
└─────────────┬──────────────────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────────────────┐
│                    数据存储层                            │
│  ┌─────────────────┐         ┌────────────────────┐   │
│  │  IndexedDB      │         │   SSE 实时通信      │   │
│  │  (本地持久化)    │◄────────┤   (与AI交互)       │   │
│  └─────────────────┘         └────────────────────┘   │
└────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-17">3.2 核心技术点</h3>
<h4 data-id="heading-18">1. 数据库设计：索引优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建多维度索引，提升查询性能</span>
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"traceId"</span>, <span class="hljs-string">"traceId"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp"</span>, <span class="hljs-string">"erp"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"code"</span>, <span class="hljs-string">"code"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp_traceId"</span>, [<span class="hljs-string">"erp"</span>, <span class="hljs-string">"traceId"</span>], { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp_code"</span>, [<span class="hljs-string">"erp"</span>, <span class="hljs-string">"code"</span>], { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
</code></pre>
<p><strong>索引策略</strong>：</p>
<ul>
<li><strong>单字段索引</strong>：用于简单查询（按用户、按会话）</li>
<li><strong>复合索引</strong>：用于多条件查询（按用户+模块）</li>
</ul>
<h4 data-id="heading-19">2. 流式对话 + 增量保存</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// SSE 流式响应实时保存</span>
<span class="hljs-keyword">const</span> controller = airobotApi.<span class="hljs-title function_">chat</span>(params, {
  <span class="hljs-attr">onMessage</span>: <span class="hljs-keyword">async</span> (responseAll, done) =&gt; {
    <span class="hljs-comment">// 实时更新 UI（流式显示）</span>
    <span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> 
      msg.<span class="hljs-property">id</span> === assistantMessageId 
        ? { ...msg, <span class="hljs-attr">keyword</span>: responseAll }
        : msg
    ));
    
    <span class="hljs-comment">// 响应完成后保存到本地数据库</span>
    <span class="hljs-keyword">if</span> (done) {
      <span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">appendHistoryMessagesByTraceId</span>(
        <span class="hljs-title class_">TraceId</span>,
        [{
          <span class="hljs-attr">id</span>: <span class="hljs-title class_">TraceId</span>,
          <span class="hljs-attr">keyword</span>: responseAll,
          <span class="hljs-attr">type</span>: <span class="hljs-string">"assistant"</span>,
          <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        }]
      );
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadHistoryChats</span>(); <span class="hljs-comment">// 刷新历史列表</span>
    }
  }
});
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>✅ 用户立即看到 AI 响应（流式体验）</li>
<li>✅ 响应完成后自动保存（无需手动操作）</li>
<li>✅ 异步保存不阻塞 UI（体验流畅）</li>
</ul>
<h4 data-id="heading-20">3. 智能去重机制</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">record</span>: <span class="hljs-title class_">ConversationRecord</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-comment">// 检查是否已存在相同的 traceId</span>
  <span class="hljs-keyword">const</span> existing = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getByTraceId</span>(record.<span class="hljs-property">traceId</span>);
  <span class="hljs-keyword">if</span> (existing.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`会话 <span class="hljs-subst">${record.traceId}</span> 已存在，跳过添加`</span>);
    <span class="hljs-keyword">return</span> existing[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>!;
  }
  
  <span class="hljs-comment">// 不存在才添加</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>!.<span class="hljs-title function_">transaction</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">storeName</span>], <span class="hljs-string">"readwrite"</span>);
    <span class="hljs-keyword">const</span> request = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storeName</span>).<span class="hljs-title function_">add</span>({
      ...record,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    });
    <span class="hljs-comment">// ...</span>
  });
}
</code></pre>
<p>避免了重复数据，保证数据一致性。</p>
<h4 data-id="heading-21">4. 按日期分组展示</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 将历史会话按日期分组</span>
<span class="hljs-keyword">const</span> groupedChats = records.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">groups, record</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(record.<span class="hljs-property">createdAt</span>!).<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">"zh-CN"</span>, {
    <span class="hljs-attr">year</span>: <span class="hljs-string">"numeric"</span>,
    <span class="hljs-attr">month</span>: <span class="hljs-string">"2-digit"</span>,
    <span class="hljs-attr">day</span>: <span class="hljs-string">"2-digit"</span>,
  }).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">"/"</span>);
  
  <span class="hljs-keyword">if</span> (!groups[date]) {
    groups[date] = [];
  }
  
  groups[date].<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">traceId</span>: record.<span class="hljs-property">traceId</span>,
    <span class="hljs-attr">name</span>: record.<span class="hljs-property">keyword</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>) + 
          (record.<span class="hljs-property">keyword</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">20</span> ? <span class="hljs-string">"..."</span> : <span class="hljs-string">""</span>),
    <span class="hljs-attr">active</span>: record.<span class="hljs-property">traceId</span> === currentTraceId,
    <span class="hljs-attr">createdAt</span>: record.<span class="hljs-property">createdAt</span>,
  });
  
  <span class="hljs-keyword">return</span> groups;
}, {} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">HistoryChatItem</span>[]&gt;);
</code></pre>
<p><strong>展示效果</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">2024/12/19
<span class="hljs-bullet">  -</span> 如何进行企业信用评估？
<span class="hljs-bullet">  -</span> 反欺诈模型的核心指标
  
2024/12/18
<span class="hljs-bullet">  -</span> 个人征信报告解读
<span class="hljs-bullet">  -</span> 风险预警策略优化
</code></pre>
<p>用户可以快速定位到特定日期的对话。</p>
<h3 data-id="heading-22">3.3 性能优化策略</h3>
<h4 data-id="heading-23">优化 1：延迟加载历史消息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 历史列表只显示标题，点击时才加载完整消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleHistoryChatClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">traceId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">setSearchParams</span>({ traceId });
  <span class="hljs-title function_">setCurrentTraceId</span>(traceId);
  
  <span class="hljs-comment">// 此时才从 IndexedDB 加载完整的历史消息</span>
  <span class="hljs-keyword">const</span> records = <span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">getByTraceId</span>(traceId);
  <span class="hljs-keyword">if</span> (records.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">setMessages</span>(records[<span class="hljs-number">0</span>].<span class="hljs-property">historyMessages</span> || []);
  }
};
</code></pre>
<p><strong>优势</strong>：避免一次性加载所有会话的所有消息，节省内存和渲染时间。</p>
<h4 data-id="heading-24">优化 2：连接管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件卸载时自动关闭 SSE 连接</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (sseControllerRef.<span class="hljs-property">current</span>) {
      sseControllerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">close</span>();
      sseControllerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    }
  };
}, []);
</code></pre>
<p><strong>优势</strong>：防止内存泄漏，避免多个 SSE 连接同时存在。</p>
<h4 data-id="heading-25">优化 3：批量更新 UI</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用函数式更新，避免重复渲染</span>
<span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> 
  msg.<span class="hljs-property">id</span> === assistantMessageId 
    ? { ...msg, <span class="hljs-attr">keyword</span>: responseAll }
    : msg
));
</code></pre>
<p><strong>优势</strong>：React 的批处理机制确保多次状态更新只触发一次渲染。</p>
<h2 data-id="heading-26">四、实测数据：量化的性能提升</h2>
<p>我们在真实业务场景中进行了对比测试：</p>
<h3 data-id="heading-27">测试环境</h3>
<ul>
<li>用户数量：100 人</li>
<li>会话数量：每人平均 20 个会话</li>
<li>消息数量：每个会话平均 10 条消息</li>
<li>测试设备：MacBook Pro 2021, Chrome 120</li>
</ul>
<h3 data-id="heading-28">测试结果</h3>









































<table><thead><tr><th>操作场景</th><th>后端方案</th><th>IndexedDB 方案</th><th>提升倍数</th></tr></thead><tbody><tr><td><strong>加载历史列表</strong></td><td>856 ms</td><td>23 ms</td><td><strong>37x</strong></td></tr><tr><td><strong>打开历史对话</strong></td><td>1240 ms</td><td>18 ms</td><td><strong>69x</strong></td></tr><tr><td><strong>搜索会话</strong></td><td>1560 ms</td><td>45 ms</td><td><strong>35x</strong></td></tr><tr><td><strong>切换会话</strong></td><td>720 ms</td><td>12 ms</td><td><strong>60x</strong></td></tr><tr><td><strong>离线访问</strong></td><td>❌ 不可用</td><td>✅ 可用</td><td>-</td></tr></tbody></table>
<h3 data-id="heading-29">用户体验指标</h3>



































<table><thead><tr><th>指标</th><th>后端方案</th><th>IndexedDB 方案</th><th>改善幅度</th></tr></thead><tbody><tr><td><strong>首次加载时间</strong></td><td>2.3s</td><td>0.8s</td><td><strong>65%</strong></td></tr><tr><td><strong>操作响应时间</strong></td><td>1.2s</td><td>0.03s</td><td><strong>97%</strong></td></tr><tr><td><strong>离线可用性</strong></td><td>0%</td><td>100%</td><td><strong>+100%</strong></td></tr><tr><td><strong>后端 QPS</strong></td><td>2500/分钟</td><td>250/分钟</td><td><strong>-90%</strong></td></tr></tbody></table>
<h3 data-id="heading-30">成本节约估算</h3>
<p><strong>假设：</strong></p>
<ul>
<li>后端服务器成本：$200/月（2核4G）</li>
<li>数据库成本：$150/月（基础实例）</li>
<li>带宽成本：$50/月</li>
</ul>
<p><strong>采用 IndexedDB 方案后：</strong></p>
<ul>
<li>后端负载降低 90%，可节省服务器资源</li>
<li>数据库查询减少 90%，可降级数据库实例</li>
<li>网络流量减少 98%</li>
</ul>
<p><strong>预计每月节省：$300-400</strong></p>
<h2 data-id="heading-31">五、方案的不足与未来规划</h2>
<h3 data-id="heading-32">5.1 当前局限性</h3>
<p>虽然前端 IndexedDB 方案有诸多优势，但也存在一些局限：</p>






























<table><thead><tr><th>局限性</th><th>影响</th><th>缓解方案</th></tr></thead><tbody><tr><td><strong>无法多端同步</strong></td><td>更换设备或浏览器后数据丢失</td><td>规划云端同步功能（可选）</td></tr><tr><td><strong>数据备份困难</strong></td><td>用户无法主动备份数据</td><td>提供数据导出功能</td></tr><tr><td><strong>存储空间限制</strong></td><td>浏览器有存储配额限制（通常 &gt;50MB）</td><td>实现自动清理老旧数据</td></tr><tr><td><strong>隐私模式失效</strong></td><td>隐私/无痕模式下数据不持久化</td><td>提示用户切换到普通模式</td></tr></tbody></table>
<h3 data-id="heading-33">5.2 未来规划</h3>
<h4 data-id="heading-34">阶段一：功能完善（Q4 2025）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话搜索（全文检索）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话导出（JSON/Markdown）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话删除</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话重命名</li>
</ul>
<h4 data-id="heading-35">阶段二：体验优化（Q1 2026）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 虚拟滚动（支持数千条历史记录）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 代码块语法高亮</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 消息复制和引用</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 消息反馈（点赞/点踩）</li>
</ul>
<h4 data-id="heading-36">阶段三：高级功能（Q2 2026）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 云端同步（可选，需后端支持）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 数据加密存储</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 智能标签和分类</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 会话分享功能</li>
</ul>
<h2 data-id="heading-37">六、总结：前端存储的最佳实践</h2>
<p>通过这次实践，我们验证了<strong>在特定场景下，前端存储方案可以比传统后端方案更优秀</strong>。</p>
<h3 data-id="heading-38">核心要点回顾</h3>
<p>✅ <strong>选择 IndexedDB 的黄金场景</strong>：</p>
<ol>
<li>数据属于单用户使用，无需多端同步</li>
<li>数据量适中（几千到几万条记录）</li>
<li>读取频率远高于写入频率</li>
<li>需要快速响应的用户体验</li>
<li>希望降低后端成本和复杂度</li>
</ol>
<p>✅ <strong>实现高质量方案的关键</strong>：</p>
<ol>
<li>合理的索引设计（单字段 + 复合索引）</li>
<li>完善的错误处理和降级方案</li>
<li>良好的封装和抽象</li>
<li>持续的性能监控和优化</li>
</ol>
<p>✅ <strong>量化的收益</strong>：</p>
<ul>
<li><strong>性能提升</strong>：37-69 倍加载速度</li>
<li><strong>成本节约</strong>：90% 后端压力降低</li>
<li><strong>用户体验</strong>：97% 响应时间缩短</li>
<li><strong>开发效率</strong>：3-4 天即可上线</li>
</ul>
<h3 data-id="heading-39">技术启示</h3>
<p>这个方案的成功告诉我们：</p>
<blockquote>
<p><strong>不要迷信"后端万能论"。在移动互联网和前端技术高速发展的今天，前端已经具备了处理复杂业务逻辑和数据存储的能力。合理利用浏览器提供的强大 API（IndexedDB、Service Worker、WebAssembly 等），可以构建出性能卓越、用户体验一流的应用。</strong></p>
</blockquote>
<p>前端工程师应该跳出"只做页面展示"的思维定式，主动思考：</p>
<ul>
<li>哪些数据可以放在前端？</li>
<li>哪些计算可以在浏览器完成？</li>
<li>如何在前后端之间找到最佳平衡点？</li>
</ul>
<h3 data-id="heading-40">写在最后</h3>
<p>IndexedDB 方案不是银弹，但在合适的场景下，它是一个极具性价比的选择。希望这个案例能给大家带来启发，在面对类似问题时，多一个解决思路。</p>
<p>技术的本质是解决问题，而不是堆砌工具。选择最适合业务场景的方案，才是优秀工程师的特质。</p>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FIndexedDB_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API" ref="nofollow noopener noreferrer">IndexedDB API - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FServer-sent_events" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events" ref="nofollow noopener noreferrer">Server-Sent Events - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Frender-and-commit" target="_blank" title="https://react.dev/learn/render-and-commit" ref="nofollow noopener noreferrer">React 性能优化指南</a></li>
</ul>
<p><strong>如果你觉得这篇文章有帮助，欢迎分享给更多前端小伙伴！</strong> 💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 休眠时内核线程冻结机制说明]]></title>    <link>https://juejin.cn/post/7585390679397826566</link>    <guid>https://juejin.cn/post/7585390679397826566</guid>    <pubDate>2025-12-19T12:57:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679397826566" data-draft-id="7585382553289408548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 休眠时内核线程冻结机制说明"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-19T12:57:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 休眠时内核线程冻结机制说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:57:46.000Z" title="Fri Dec 19 2025 12:57:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、冻结流程概述</h2>
<p>Linux休眠时的冻结过程分为<strong>两个阶段</strong>：</p>
<h3 data-id="heading-1">阶段1：冻结用户空间进程</h3>
<ul>
<li>调用：<code>freeze_processes()</code></li>
<li>设置：<code>pm_freezing = true</code></li>
<li>调用：<code>try_to_freeze_tasks(true)</code> - <code>user_only=true</code></li>
<li>目标：只冻结用户空间进程（非内核线程）</li>
</ul>
<h3 data-id="heading-2">阶段2：冻结内核线程</h3>
<ul>
<li>调用：<code>freeze_kernel_threads()</code></li>
<li>设置：<code>pm_nosig_freezing = true</code></li>
<li>调用：<code>try_to_freeze_tasks(false)</code> - <code>user_only=false</code></li>
<li>目标：冻结可冻结的内核线程</li>
</ul>
<h2 data-id="heading-3">二、代码实现分析</h2>
<h3 data-id="heading-4">2.1 冻结判断逻辑</h3>
<p>在 <code>kernel/freezer.c</code> 的 <code>freezing_slow_path()</code> 函数中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">bool</span> <span class="hljs-title function_">freezing_slow_path</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p)</span>
{
    <span class="hljs-keyword">if</span> (p-&gt;flags &amp; (PF_NOFREEZE | PF_SUSPEND_TASK))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (pm_nosig_freezing || cgroup_freezing(p))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 第二阶段：冻结所有任务（包括内核线程）</span>

    <span class="hljs-keyword">if</span> (pm_freezing &amp;&amp; !(p-&gt;flags &amp; PF_KTHREAD))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 第一阶段：只冻结非内核线程</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>第一阶段</strong>（<code>pm_freezing=true</code>）：<code>!(p-&gt;flags &amp; PF_KTHREAD)</code> - 只冻结非内核线程</li>
<li><strong>第二阶段</strong>（<code>pm_nosig_freezing=true</code>）：会冻结所有任务，包括内核线程</li>
</ul>
<h3 data-id="heading-5">2.2 冻结流程代码</h3>
<p>在 <code>kernel/power/power.h</code> 中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">suspend_freeze_processes</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 第一阶段：冻结用户空间进程</span>
    error = freeze_processes();  <span class="hljs-comment">// 设置 pm_freezing=true, 调用 try_to_freeze_tasks(true)</span>
    
    <span class="hljs-keyword">if</span> (error)
        <span class="hljs-keyword">return</span> error;
    
    <span class="hljs-comment">// 第二阶段：冻结内核线程</span>
    error = freeze_kernel_threads();  <span class="hljs-comment">// 设置 pm_nosig_freezing=true, 调用 try_to_freeze_tasks(false)</span>
    
    <span class="hljs-keyword">if</span> (error) {
        thaw_processes();  <span class="hljs-comment">// 如果失败，解冻所有进程</span>
    }
    
    <span class="hljs-keyword">return</span> error;
}
</code></pre>
<h3 data-id="heading-6">2.3 不可冻结任务的判断</h3>
<p>在 <code>kernel/power/process.c</code> 的 <code>try_to_freeze_tasks()</code> 函数中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* 检查是否不可冻结 */</span>
<span class="hljs-keyword">if</span> (p-&gt;flags &amp; PF_NOFREEZE) {
    unfreezable_tasks++;
    <span class="hljs-comment">// 标记为UNFREEZABLE，跳过，不调用freeze_task</span>
    <span class="hljs-keyword">continue</span>;
}

<span class="hljs-comment">/* 尝试冻结任务 */</span>
<span class="hljs-keyword">if</span> (!freeze_task(p)) {
    failed_freeze_tasks++;
    <span class="hljs-comment">// 标记为FAILED_FREEZE</span>
}
</code></pre>
<h2 data-id="heading-7">三、实际日志分析</h2>
<p>从 <code>20251219_12.log</code> 日志中可以看到：</p>
<h3 data-id="heading-8">3.1 第一阶段：冻结用户空间进程</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.808286]</span> Freezing user space processes ... 
<span class="hljs-section">[   98.808292]</span> LLLLLLLL try_to_freeze_tasks: <span class="hljs-attr">user_only</span>=<span class="hljs-number">1</span>, timeout=<span class="hljs-number">20000</span> ms
<span class="hljs-section">[   98.810973]</span> LLLLLLLL UNFREEZABLE: kthreadd (pid 2), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.811793]</span> LLLLLLLL UNFREEZABLE: rcu_gp (pid 3), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
...
</code></pre>
<p><strong>观察</strong>：</p>
<ul>
<li><code>user_only=1</code> - 只冻结用户空间进程</li>
<li>但是仍然会遍历所有任务，包括内核线程</li>
<li>内核线程会被标记为UNFREEZABLE（如果有PF_NOFREEZE标志）或跳过</li>
</ul>
<h3 data-id="heading-9">3.2 第二阶段：冻结内核线程</h3>
<p><strong>重要发现</strong>：从日志中可以看到，<strong>第一阶段就失败了</strong>，所以没有进入第二阶段：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  119.065869]</span> freeze_processes: failed to freeze tasks, error -16
<span class="hljs-section">[  119.066756]</span> freeze_processes: failed with error -16, thawing processes
<span class="hljs-section">[  119.177013]</span> PM: SUSPEND_DEBUG: suspend_prepare: freeze failed, <span class="hljs-attr">error</span>=-<span class="hljs-number">16</span>
<span class="hljs-section">[  119.177018]</span> PM: SUSPEND_DEBUG: suspend_prepare: FORCE SUSPEND enabled, ignoring freeze failure
</code></pre>
<p><strong>实际情况</strong>：</p>
<ul>
<li>第一阶段（<code>freeze_processes()</code>）超时失败（error -16 = EBUSY）</li>
<li>系统启用了<code>FORCE SUSPEND</code>模式，即使冻结失败也继续挂起</li>
<li><strong>因此没有进入第二阶段</strong>（<code>freeze_kernel_threads()</code>）</li>
<li>这意味着<strong>内核线程没有被冻结</strong></li>
</ul>
<p><strong>这解释了为什么</strong>：</p>
<ul>
<li>只有3个任务被成功冻结（都是用户空间进程）</li>
<li>24个任务拒绝冻结（包括kswapd0和jbd2线程）</li>
<li>95个任务被标记为UNFREEZABLE（有PF_NOFREEZE标志的内核线程）</li>
</ul>
<h2 data-id="heading-10">四、关键问题回答</h2>
<h3 data-id="heading-11">Q: 在休眠唤醒时，内核的这些task也会冻结吗？</h3>
<p><strong>A: 是的，但分两个阶段，且有例外</strong></p>
<h3 data-id="heading-12">详细说明：</h3>
<ol>
<li>
<p><strong>第一阶段 - 只冻结用户空间进程</strong>：</p>
<ul>
<li>设置 <code>pm_freezing = true</code></li>
<li>调用 <code>try_to_freeze_tasks(true)</code> - <code>user_only=true</code></li>
<li>在 <code>freezing_slow_path()</code> 中：<code>if (pm_freezing &amp;&amp; !(p-&gt;flags &amp; PF_KTHREAD))</code></li>
<li><strong>只冻结非内核线程</strong>（用户空间进程）</li>
</ul>
</li>
<li>
<p><strong>第二阶段 - 冻结可冻结的内核线程</strong>：</p>
<ul>
<li>设置 <code>pm_nosig_freezing = true</code></li>
<li>调用 <code>try_to_freeze_tasks(false)</code> - <code>user_only=false</code></li>
<li>在 <code>freezing_slow_path()</code> 中：<code>if (pm_nosig_freezing || cgroup_freezing(p))</code></li>
<li><strong>会冻结所有任务，包括内核线程</strong></li>
</ul>
</li>
<li>
<p><strong>例外 - 不可冻结的内核线程</strong>：</p>
<ul>
<li>有 <code>PF_NOFREEZE</code> 标志的内核线程<strong>不会被冻结</strong></li>
<li>在 <code>try_to_freeze_tasks()</code> 中会被跳过</li>
<li>这就是为什么我们看到95个UNFREEZABLE任务</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">总结：</h3>
<ul>
<li>✅ <strong>用户空间进程</strong>：第一阶段被冻结</li>
<li>✅ <strong>可冻结的内核线程</strong>（没有PF_NOFREEZE标志）：第二阶段被冻结</li>
<li>❌ <strong>不可冻结的内核线程</strong>（有PF_NOFREEZE标志）：不会被冻结</li>
</ul>
<h2 data-id="heading-14">五、为什么内核线程要分两个阶段冻结？</h2>
<h3 data-id="heading-15">5.1 设计原因</h3>
<ol>
<li>
<p><strong>用户空间进程优先</strong>：</p>
<ul>
<li>用户空间进程可能正在执行关键操作</li>
<li>需要先确保用户空间进程停止，避免数据不一致</li>
</ul>
</li>
<li>
<p><strong>内核线程可能依赖用户空间</strong>：</p>
<ul>
<li>某些内核线程可能正在处理来自用户空间的请求</li>
<li>先冻结用户空间，可以避免内核线程处理到一半被冻结</li>
</ul>
</li>
<li>
<p><strong>错误处理</strong>：</p>
<ul>
<li>如果第一阶段失败，只需要解冻用户空间进程</li>
<li>如果第二阶段失败，需要解冻所有进程</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">5.2 实际好处</h3>
<ul>
<li><strong>更清晰的错误处理</strong>：可以区分是用户空间还是内核线程冻结失败</li>
<li><strong>更好的调试</strong>：可以分别查看两个阶段的日志</li>
<li><strong>更灵活的控制</strong>：某些场景可能只需要冻结用户空间进程</li>
</ul>
<h2 data-id="heading-17">六、不可冻结的内核线程</h2>
<h3 data-id="heading-18">6.1 为什么有些内核线程不可冻结？</h3>
<p><strong>原因</strong>：</p>
<ol>
<li><strong>系统核心功能</strong>：如kthreadd、RCU相关线程，如果被冻结会导致系统死锁</li>
<li><strong>硬件交互</strong>：如中断处理线程，必须及时响应硬件中断</li>
<li><strong>数据一致性</strong>：某些线程正在执行关键操作，不能中途停止</li>
</ol>
<h3 data-id="heading-19">6.2 如何判断内核线程是否可冻结？</h3>
<p><strong>判断标准</strong>：</p>
<ul>
<li>有 <code>PF_NOFREEZE</code> 标志 → 不可冻结（UNFREEZABLE）</li>
<li>没有 <code>PF_NOFREEZE</code> 标志 → 可冻结（但可能冻结失败）</li>
</ul>
<p><strong>从日志中可以看到</strong>：</p>
<ul>
<li>95个UNFREEZABLE任务：都有 <code>PF_NOFREEZE</code> 标志</li>
<li>6个FAILED_FREEZE任务：没有 <code>PF_NOFREEZE</code> 标志，但冻结失败</li>
</ul>
<h2 data-id="heading-20">七、总结</h2>
<h3 data-id="heading-21">7.1 冻结流程</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  └─ 只冻结用户空间进程（!(p-&gt;flags &amp; PF_KTHREAD)）
  ↓
<span class="hljs-built_in">freeze_kernel_threads</span>()  <span class="hljs-selector-attr">[第二阶段]</span>
  ├─ 设置 pm_nosig_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(false)
  └─ 冻结可冻结的内核线程（没有PF_NOFREEZE标志的）
</code></pre>
<h3 data-id="heading-22">7.2 任务分类</h3>



































<table><thead><tr><th>任务类型</th><th>第一阶段</th><th>第二阶段</th><th>最终状态</th></tr></thead><tbody><tr><td>用户空间进程</td><td>✅ 冻结</td><td>-</td><td>已冻结</td></tr><tr><td>可冻结的内核线程（无PF_NOFREEZE）</td><td>❌ 跳过</td><td>✅ 冻结</td><td>已冻结</td></tr><tr><td>不可冻结的内核线程（有PF_NOFREEZE）</td><td>❌ 跳过</td><td>❌ 跳过</td><td>UNFREEZABLE</td></tr><tr><td>冻结失败的内核线程</td><td>❌ 跳过</td><td>❌ 失败</td><td>FAILED_FREEZE</td></tr></tbody></table>
<h3 data-id="heading-23">7.3 关键结论</h3>
<p><strong>理论上，内核线程也会被冻结，但是</strong>：</p>
<ol>
<li>
<p><strong>正常流程</strong>：</p>
<ul>
<li><strong>分两个阶段</strong>：先冻结用户空间进程，再冻结内核线程</li>
<li><strong>有例外</strong>：有 <code>PF_NOFREEZE</code> 标志的内核线程不会被冻结</li>
<li><strong>可能失败</strong>：某些内核线程可能无法冻结（如kswapd0、jbd2线程）</li>
</ul>
</li>
<li>
<p><strong>实际情况（从日志看）</strong>：</p>
<ul>
<li><strong>第一阶段就失败了</strong>：<code>freeze_processes()</code> 超时失败（error -16）</li>
<li><strong>没有进入第二阶段</strong>：因为第一阶段失败，没有调用 <code>freeze_kernel_threads()</code></li>
<li><strong>强制挂起</strong>：系统启用了<code>FORCE SUSPEND</code>，即使冻结失败也继续挂起</li>
<li><strong>结果</strong>：内核线程<strong>没有被冻结</strong>（除了有PF_NOFREEZE标志的，它们本来就不会被冻结）</li>
</ul>
</li>
<li>
<p><strong>这可能是唤醒失败的原因之一</strong>：</p>
<ul>
<li>内核线程（如kswapd0、jbd2）没有被冻结</li>
<li>系统在不完整的状态下进入深度睡眠</li>
<li>唤醒时无法从不一致的状态中恢复</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pkg.pr.new 快速验证第三方包-最新修复]]></title>    <link>https://juejin.cn/post/7585390679398563846</link>    <guid>https://juejin.cn/post/7585390679398563846</guid>    <pubDate>2025-12-20T02:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398563846" data-draft-id="7585397173022933011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pkg.pr.new 快速验证第三方包-最新修复"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知了清语"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498942055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pkg.pr.new 快速验证第三方包-最新修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498942055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知了清语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:24:33.000Z" title="Sat Dec 20 2025 02:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"> <strong>pkg.pr.new 是什么？</strong></h3>
<ul>
<li>
<p><strong>pkg.pr.new</strong> 是一个为 GitHub 仓库提供**即时预览包（preview packages）**的服务。</p>
</li>
<li>
<p>每当有新的 commit 推送或 Pull Request 创建时，它会自动生成一个可通过 npm 兼容 URL 直接安装的临时包。</p>
<ul>
<li>示例：<code>npm i https://pkg.pr.new/vite@main</code></li>
</ul>
</li>
<li>
<p>支持与 <strong>StackBlitz WebContainers</strong> 集成，允许用户在完全隔离的浏览器环境中试用这些预览包。</p>
</li>
</ul>
<h3 data-id="heading-1"> <strong>存储管理策略</strong></h3>
<ul>
<li>
<p>pkg.pr.new <strong>不是永久包注册表</strong>，而是临时预览服务。</p>
</li>
<li>
<p>自动清理机制：</p>
<ul>
<li>超过 <strong>1 个月未被下载</strong> 的包会被删除。</li>
<li>超过 <strong>6 个月</strong> 的包也会被自动移除。</li>
</ul>
</li>
<li>
<p>这一策略有效控制了存储成本，未来在 Cloudflare 支持下可适当放宽限制。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">用 pkg.pr.new 快速验证 Element Plus 的 Tree 内存泄漏修复</h2>
<h3 data-id="heading-3">背景：一个真实的性能问题</h3>
<p>在 Element Plus 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felement-plus%2Felement-plus%2Fpull%2F23055" target="_blank" title="https://github.com/element-plus/element-plus/pull/23055" ref="nofollow noopener noreferrer">PR #23055</a> 中，开发者 @rzzf 发现并修复了一个 <strong>el-tree 组件在数据更新后可能引发内存泄漏</strong> 的问题。</p>
<p>这个问题的表现是：</p>
<ul>
<li>当频繁更新 tree 的 data 时，旧节点引用未被正确释放；</li>
<li>导致内存持续增长，尤其在 Chrome 130 等新版本浏览器中更为明显（见 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">Issue #23059</a>）。</li>
</ul>
<p>修复本身并不复杂——关键在于<strong>确保事件监听器和节点缓存在数据变更时被清理</strong>。但作为用户或 Reviewer，我们最关心的是：</p>
<blockquote>
<p><strong>这个修复真的有效吗？我能不能在自己的项目里快速试一下？</strong></p>
</blockquote>
<h4 data-id="heading-4">传统方式 vs pkg.pr.new</h4>
<p>过去，要测试一个未发布的 PR，你需要：</p>
<ol>
<li>拉取 PR 分支；</li>
<li>本地构建 element-plus；(切对应的node环境，繁琐)</li>
<li>链接到你的项目（<code>npm link</code> 或 <code>yalc</code>）；</li>
<li>重启开发服务器……</li>
</ol>
<p>整个过程繁琐且容易出错。</p>
<p>而现在，有了 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.pr.new%2F" target="_blank" title="https://pkg.pr.new/" ref="nofollow noopener noreferrer">pkg.pr.new</a></strong>，一切变得极其简单。</p>
<h3 data-id="heading-5">一行命令，直接安装 PR 构建包</h3>
<p>对于 PR #23055，你可以直接运行：</p>
<pre><code class="hljs language-shell" lang="shell">npm install https://pkg.pr.new/element-plus/element-plus@23055

pnpm add https://pkg.pr.new/element-plus/element-plus@23055

yarn add https://pkg.pr.new/element-plus/element-plus@23055
</code></pre>
<blockquote>
<p>✅ 这个 URL 会自动指向该 PR 对应的最新 CI 构建产物，完全兼容 npm 安装流程。</p>
</blockquote>
<p>等到官方发布了 最新的版本， 可以重新回归到 正常的版本号的 <code>正轨</code></p>
<h3 data-id="heading-6">生态支持</h3>
<ul>
<li>已生成 <strong>超过 100 万个预览包</strong></li>
</ul>
<h3 data-id="heading-7">结语</h3>
<p>PR #23055 不仅修复了一个关键的内存问题，更展示了现代开源项目的<strong>高效协作范式</strong>：</p>
<blockquote>
<p><strong>代码提交 → 自动构建 → 在线预览 → 社区验证 → 合并发布</strong></p>
</blockquote>
<h3 data-id="heading-8">相关链接</h3>
<ul>
<li>🐞 PR #23055: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felement-plus%2Felement-plus%2Fpull%2F23055" target="_blank" title="https://github.com/element-plus/element-plus/pull/23055" ref="nofollow noopener noreferrer">perf(components): [tree] resolve memory leak occurring after data update by rzzf · Pull Request #23055 · element-plus/element-plus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.stackblitz.com%2Fposts%2Fpkg-pr-new%2F" target="_blank" title="https://blog.stackblitz.com/posts/pkg-pr-new/" ref="nofollow noopener noreferrer">宣布 pkg.pr.new --- Announcing pkg.pr.new</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 内核线程冻结情况分析]]></title>    <link>https://juejin.cn/post/7585397173022441491</link>    <guid>https://juejin.cn/post/7585397173022441491</guid>    <pubDate>2025-12-19T13:54:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173022441491" data-draft-id="7585390679397957638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 内核线程冻结情况分析"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-19T13:54:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 内核线程冻结情况分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T13:54:19.000Z" title="Fri Dec 19 2025 13:54:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、关键发现</h2>
<h3 data-id="heading-1">1.1 实际情况</h3>
<p><strong>是的，您确实没有冻结应该被冻结的内核线程！</strong></p>
<p>从日志分析：</p>
<ol>
<li>
<p><strong>第一阶段失败</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  119.065869]</span> freeze_processes: failed to freeze tasks, error -16
<span class="hljs-section">[  119.177008]</span> PM: SUSPEND_DEBUG: suspend_freeze_processes: freeze_processes failed, <span class="hljs-attr">error</span>=-<span class="hljs-number">16</span>
</code></pre>
</li>
<li>
<p><strong>没有进入第二阶段</strong>：</p>
<ul>
<li>日志中<strong>没有</strong>看到 <code>"freezing kernel threads"</code> 或 <code>"44444444 freeze_kernel_threads ENTER"</code></li>
<li>说明 <code>freeze_kernel_threads()</code> <strong>根本没有被调用</strong></li>
</ul>
</li>
<li>
<p><strong>强制挂起</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  119.177018]</span> PM: SUSPEND_DEBUG: suspend_prepare: FORCE SUSPEND enabled, ignoring freeze failure
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">1.2 代码逻辑</h3>
<p>从 <code>kernel/power/power.h</code> 中的代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">suspend_freeze_processes</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    error = freeze_processes();  <span class="hljs-comment">// 第一阶段</span>
    <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">return</span> error;  <span class="hljs-comment">// 如果失败，直接返回，不会调用freeze_kernel_threads()</span>
    }
    
    error = freeze_kernel_threads();  <span class="hljs-comment">// 第二阶段（但第一阶段失败，所以不会执行到这里）</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>如果第一阶段（<code>freeze_processes()</code>）失败，函数会直接返回错误</li>
<li><strong>不会调用第二阶段</strong>（<code>freeze_kernel_threads()</code>）</li>
<li>系统启用了<code>FORCE SUSPEND</code>，即使返回错误也继续挂起</li>
</ul>
<h2 data-id="heading-3">二、冻结统计</h2>
<h3 data-id="heading-4">2.1 从日志中看到的统计</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  118.830604]</span> LLLLLLLL FINAL STATS: <span class="hljs-attr">total</span>=<span class="hljs-number">146</span>, frozen=<span class="hljs-number">3</span>, freezing=<span class="hljs-number">24</span>, unfreezable=<span class="hljs-number">95</span>, skipped=<span class="hljs-number">18</span>
</code></pre>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>total=146</strong>：总共146个任务</li>
<li><strong>frozen=3</strong>：只有3个任务被成功冻结（用户空间进程）</li>
<li><strong>freezing=24</strong>：24个任务正在冻结中（但最终超时失败）</li>
<li><strong>unfreezable=95</strong>：95个任务不可冻结（有PF_NOFREEZE标志）</li>
<li><strong>skipped=18</strong>：18个任务被跳过</li>
</ul>
<h3 data-id="heading-5">2.2 被成功冻结的3个用户空间进程</h3>
<p>从日志分析，被成功冻结的3个用户空间进程是：</p>

































<table><thead><tr><th>PID</th><th>进程名</th><th>进入冻结时间</th><th>解冻时间</th><th>状态确认</th></tr></thead><tbody><tr><td><strong>1994</strong></td><td><strong>audio_server</strong></td><td><code>[  105.806568]</code></td><td><code>[  119.161300]</code></td><td><code>was_frozen=1</code></td></tr><tr><td><strong>2455</strong></td><td><strong>sleep</strong></td><td><code>[  100.207489]</code></td><td><code>[  119.174184]</code></td><td><code>was_frozen=1</code></td></tr><tr><td><strong>2456</strong></td><td><strong>mtop</strong></td><td><code>[   99.447028]</code></td><td><code>[  119.174862]</code></td><td><code>was_frozen=1</code></td></tr></tbody></table>
<p><strong>详细日志</strong>：</p>
<ol>
<li>
<p><strong>audio_server (pid 1994)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  105.806568]</span> 11111111 __refrigerator ENTER: task audio_server (pid 1994)
<span class="hljs-section">[  105.809739]</span> 11111111 __refrigerator: task audio_server (pid 1994) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.161300]</span> __thaw_task: woke up frozen task audio_server (pid 1994)
<span class="hljs-section">[  119.165322]</span> 11111111 __refrigerator EXIT: task audio_server (pid 1994), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：音频服务进程</li>
<li><strong>冻结时长</strong>：约13.35秒</li>
</ul>
</li>
<li>
<p><strong>sleep (pid 2455)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  100.207489]</span> 11111111 __refrigerator ENTER: task sleep (pid 2455)
<span class="hljs-section">[  100.208222]</span> 11111111 __refrigerator: task sleep (pid 2455) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.174184]</span> __thaw_task: woke up frozen task sleep (pid 2455)
<span class="hljs-section">[  119.177853]</span> 11111111 __refrigerator EXIT: task sleep (pid 2455), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：执行sleep命令的进程</li>
<li><strong>冻结时长</strong>：约18.97秒</li>
</ul>
</li>
<li>
<p><strong>mtop (pid 2456)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   99.447028]</span> 11111111 __refrigerator ENTER: task mtop (pid 2456)
<span class="hljs-section">[   99.447734]</span> 11111111 __refrigerator: task mtop (pid 2456) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.174862]</span> __thaw_task: woke up frozen task mtop (pid 2456)
<span class="hljs-section">[  119.178822]</span> 11111111 __refrigerator EXIT: task mtop (pid 2456), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：系统监控工具进程</li>
<li><strong>冻结时长</strong>：约19.73秒</li>
</ul>
</li>
</ol>
<p><strong>说明</strong>：</p>
<ul>
<li>这3个都是用户空间进程（第一阶段只冻结用户空间进程）</li>
<li>它们都成功进入了<code>__refrigerator()</code>（冻结函数）</li>
<li>解冻时都显示<code>woke up frozen task</code>和<code>was_frozen=1</code>，确认被冻结</li>
<li>这3个是唯一被成功冻结的任务，其他任务要么不可冻结（95个），要么冻结失败（6个），要么被跳过（18个）</li>
</ul>
<h3 data-id="heading-6">2.3 没有成功冻结的内核线程</h3>
<p>从日志分析，没有成功冻结的内核线程主要是<strong>6个冻结失败的内核线程</strong>：</p>





























































<table><thead><tr><th>PID</th><th>任务名</th><th>Flags</th><th>State</th><th>CPU</th><th>状态</th></tr></thead><tbody><tr><td><strong>88</strong></td><td><strong>kswapd0</strong></td><td>0xa20840</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>239</strong></td><td><strong>jbd2/loop0-8</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>907</strong></td><td><strong>jbd2/mmcblk0p10</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>926</strong></td><td><strong>jbd2/mmcblk0p17</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>948</strong></td><td><strong>jbd2/mmcblk0p16</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>987</strong></td><td><strong>jbd2/mmcblk0p19</strong></td><td>0x240040</td><td>1</td><td>3</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr></tbody></table>
<p><strong>详细日志</strong>：</p>
<ol>
<li>
<p><strong>kswapd0 (pid 88)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.858688]</span> LLLLLLLL FAILED_FREEZE: kswapd0 (pid 88), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>xa20840, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.843734]</span> LLLLLLLL NOT_FREEZING: kswapd0 (pid 88), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>xa20840, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：内存交换守护线程</li>
<li><strong>标志分析</strong>：<code>0xa20840 = PF_KTHREAD (0x00200000) + PF_MEMALLOC (0x00000800) + PF_KSWAPD (0x00020000)</code></li>
<li><strong>状态</strong>：有PF_KTHREAD，没有PF_NOFREEZE，应该被冻结</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/loop0-8 (pid 239)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.894967]</span> LLLLLLLL FAILED_FREEZE: jbd2/loop0-8 (pid 239), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.844660]</span> LLLLLLLL NOT_FREEZING: jbd2/loop0-8 (pid 239), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：loop设备文件系统日志线程</li>
<li><strong>标志分析</strong>：<code>0x240040 = PF_KTHREAD (0x00200000) + PF_FORKNOEXEC (0x00000040)</code></li>
<li><strong>状态</strong>：有PF_KTHREAD，没有PF_NOFREEZE，应该被冻结</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p10 (pid 907)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.902590]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p10 (pid 907), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.902100]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p10 (pid 907), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区10的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p17 (pid 926)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.910231]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p17 (pid 926), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.903093]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p17 (pid 926), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区17的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p16 (pid 948)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.917871]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p16 (pid 948), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.904086]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p16 (pid 948), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区16的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p19 (pid 987)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.925519]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p19 (pid 987), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">3</span>
<span class="hljs-section">[  118.905087]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p19 (pid 987), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">3</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区19的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
</ol>
<p><strong>关键特点</strong>：</p>
<ul>
<li>✅ 都是内核线程（有PF_KTHREAD标志）</li>
<li>✅ 都没有PF_NOFREEZE标志（应该被冻结）</li>
<li>❌ 第一阶段尝试冻结但失败（FAILED_FREEZE）</li>
<li>❌ 第二阶段没有执行，所以它们没有被冻结</li>
<li>❌ 最终状态显示为NOT_FREEZING（没有冻结）</li>
</ul>
<p><strong>为什么无法冻结</strong>：</p>
<ol>
<li><strong>kswapd0</strong>：可能正在执行内存交换操作，处于不可中断的I/O等待状态</li>
<li><strong>jbd2线程</strong>：可能正在写入文件系统日志，处于不可中断的磁盘I/O等待状态</li>
<li><strong>状态问题</strong>：这些线程可能处于TASK_RUNNING或TASK_INTERRUPTIBLE状态，但无法响应冻结请求</li>
</ol>
<p><strong>影响</strong>：</p>
<ul>
<li>这6个内核线程没有被冻结，处于不一致的状态</li>
<li>系统在不完整的状态下进入深度睡眠</li>
<li>唤醒时可能无法从不一致的状态中恢复</li>
<li><strong>这是导致唤醒失败的重要原因</strong></li>
</ul>
<h3 data-id="heading-7">2.4 任务分类</h3>



































<table><thead><tr><th>任务类型</th><th>数量</th><th>说明</th></tr></thead><tbody><tr><td><strong>成功冻结</strong></td><td>3</td><td>用户空间进程（第一阶段）</td></tr><tr><td><strong>冻结失败</strong></td><td>6</td><td>kswapd0和5个jbd2线程（没有PF_NOFREEZE，但冻结失败）</td></tr><tr><td><strong>不可冻结</strong></td><td>95</td><td>有PF_NOFREEZE标志的内核线程（本来就不应该被冻结）</td></tr><tr><td><strong>跳过</strong></td><td>18</td><td>其他被跳过的任务</td></tr><tr><td><strong>应该被冻结但没冻结的内核线程</strong></td><td><strong>6</strong></td><td><strong>kswapd0和5个jbd2线程（没有PF_NOFREEZE，但冻结失败）</strong></td></tr></tbody></table>
<h2 data-id="heading-8">三、应该被冻结的内核线程</h2>
<h3 data-id="heading-9">3.1 判断标准</h3>
<p><strong>应该被冻结的内核线程</strong>：</p>
<ul>
<li>有 <code>PF_KTHREAD</code> 标志（是内核线程）</li>
<li><strong>没有</strong> <code>PF_NOFREEZE</code> 标志（没有标记为不可冻结）</li>
<li><strong>没有</strong> <code>PF_FREEZER_SKIP</code> 标志（没有被跳过）</li>
</ul>
<h3 data-id="heading-10">3.2 从日志中看到的</h3>
<p><strong>冻结失败的内核线程（6个）</strong>：</p>
<ul>
<li><code>kswapd0 (pid 88)</code> - flags=0xa20840（有PF_KTHREAD，没有PF_NOFREEZE）</li>
<li><code>jbd2/loop0-8 (pid 239)</code> - flags=0x240040（有PF_KTHREAD，没有PF_NOFREEZE）</li>
<li><code>jbd2/mmcblk0p10 (pid 907)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p17 (pid 926)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p16 (pid 948)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p19 (pid 987)</code> - flags=0x240040</li>
</ul>
<p><strong>这些任务</strong>：</p>
<ul>
<li>✅ 是内核线程（有PF_KTHREAD）</li>
<li>✅ 没有PF_NOFREEZE标志（应该被冻结）</li>
<li>❌ 但冻结失败（FAILED_FREEZE）</li>
<li>❌ 第二阶段没有执行，所以它们没有被冻结</li>
</ul>
<h3 data-id="heading-11">3.3 其他内核线程的情况</h3>
<p><strong>关键发现</strong>：从日志分析，<strong>只有6个内核线程被尝试冻结</strong>（kswapd0和5个jbd2线程），其他所有内核线程都被标记为UNFREEZABLE。</p>
<p><strong>问题</strong>：除了这6个内核线程，其他的内核线程是不需要冻结，还是说没有成功冻结？</p>
<p><strong>答案：其他内核线程（95个）都是不需要冻结的（有PF_NOFREEZE标志）。</strong></p>
<p>只有这6个内核线程是应该被冻结但没有成功冻结的（没有PF_NOFREEZE标志，但冻结失败）。</p>
<h4 data-id="heading-12">3.3.1 从日志统计验证</h4>
<p>从日志 <code>20251219_12.log</code> 的统计信息可以看到：</p>
<pre><code class="hljs language-ini" lang="ini">FINAL STATS:
- <span class="hljs-attr">unfreezable</span>=<span class="hljs-number">95</span>：<span class="hljs-number">95</span>个任务不可冻结（有PF_NOFREEZE标志）
- <span class="hljs-attr">failed</span>=<span class="hljs-number">6</span>：<span class="hljs-number">6</span>个任务冻结失败（没有PF_NOFREEZE标志，但冻结失败）
</code></pre>
<h4 data-id="heading-13">3.3.2 UNFREEZABLE内核线程（95个）</h4>
<p><strong>特征</strong>：</p>
<ul>
<li>所有UNFREEZABLE内核线程都有<code>PF_NOFREEZE</code>标志</li>
<li>它们<strong>不需要冻结</strong>，这是正确的行为</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.810973]</span> LLLLLLLL UNFREEZABLE: kthreadd (pid 2), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.811793]</span> LLLLLLLL UNFREEZABLE: rcu_gp (pid 3), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.812644]</span> LLLLLLLL UNFREEZABLE: rcu_par_gp (pid 4), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.815247]</span> LLLLLLLL UNFREEZABLE: kworker/0:0 (pid 7), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.820687]</span> LLLLLLLL UNFREEZABLE: ksoftirqd/0 (pid 13), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.822436]</span> LLLLLLLL UNFREEZABLE: migration/0 (pid 15), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208040, state=<span class="hljs-number">1</span>
...
</code></pre>
<p><strong>Flags值分析</strong>：</p>
<ul>
<li><code>0x208040 = 0x00200000 (PF_KTHREAD) + 0x00008000 (PF_NOFREEZE) + 0x00000040 (PF_FORKNOEXEC)</code></li>
<li><code>0x4208060 = 0x00200000 (PF_KTHREAD) + 0x00000020 (PF_WQ_WORKER) + 0x00008000 (PF_NOFREEZE) + 0x00000040 (PF_FORKNOEXEC)</code></li>
<li><code>0x4208040 = 0x00200000 (PF_KTHREAD) + 0x00000020 (PF_WQ_WORKER) + 0x00008000 (PF_NOFREEZE)</code></li>
</ul>
<p><strong>结论</strong>：所有这些flags值都包含<code>PF_NOFREEZE (0x00008000)</code>，所以它们不需要冻结。</p>
<p><strong>包括</strong>：kthreadd、rcu_gp、所有kworker线程、中断处理线程等</p>
<h4 data-id="heading-14">3.3.3 FAILED_FREEZE内核线程（6个）</h4>
<p><strong>特征</strong>：</p>
<ul>
<li>这6个内核线程<strong>没有</strong><code>PF_NOFREEZE</code>标志</li>
<li>它们<strong>应该被冻结</strong>，但冻结失败</li>
<li>包括：kswapd0和5个jbd2线程</li>
</ul>
<p><strong>Flags值分析</strong>：</p>
<ul>
<li><code>0xa20840 = 0x00200000 (PF_KTHREAD) + 0x00020000 (PF_KSWAPD) + 0x00000800 (PF_MEMALLOC) + 0x00000040 (PF_FORKNOEXEC)</code>
<ul>
<li><strong>没有</strong><code>PF_NOFREEZE (0x00008000)</code></li>
</ul>
</li>
<li><code>0x240040 = 0x00200000 (PF_KTHREAD) + 0x00000040 (PF_FORKNOEXEC)</code>
<ul>
<li><strong>没有</strong><code>PF_NOFREEZE (0x00008000)</code></li>
</ul>
</li>
</ul>
<p><strong>结论</strong>：这些flags值都<strong>不包含</strong><code>PF_NOFREEZE</code>，所以它们应该被冻结，但冻结失败了。</p>
<h4 data-id="heading-15">3.3.4 为什么只有这6个被尝试冻结？</h4>
<p><strong>原因</strong>：第一阶段（<code>freeze_processes()</code>）虽然主要冻结用户空间进程，但也会遍历所有任务，包括内核线程。</p>
<p><strong>代码逻辑</strong>（<code>kernel/power/process.c</code>）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">try_to_freeze_tasks</span><span class="hljs-params">(<span class="hljs-type">bool</span> user_only)</span>
{
    <span class="hljs-comment">// ...</span>
    for_each_process_thread(g, p) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">if</span> (p-&gt;flags &amp; PF_NOFREEZE) {
            unfreezable_tasks++;
            <span class="hljs-comment">// 标记为UNFREEZABLE，跳过，不调用freeze_task</span>
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-comment">// 如果没有PF_NOFREEZE标志，尝试冻结</span>
        <span class="hljs-keyword">if</span> (!freeze_task(p)) {
            failed_freeze_tasks++;
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>第一阶段会遍历所有任务（包括内核线程）</li>
<li>如果有<code>PF_NOFREEZE</code>标志，标记为UNFREEZABLE，跳过</li>
<li>如果没有<code>PF_NOFREEZE</code>标志，尝试冻结（调用<code>freeze_task</code>）</li>
<li>所以，只有没有<code>PF_NOFREEZE</code>标志的内核线程会被尝试冻结</li>
</ul>
<p><strong>实际情况</strong>：</p>
<ul>
<li>系统中只有6个内核线程没有<code>PF_NOFREEZE</code>标志（kswapd0和5个jbd2线程）</li>
<li>这6个线程在第一阶段被尝试冻结，但都失败了</li>
<li>其他所有内核线程都有<code>PF_NOFREEZE</code>标志，不需要冻结</li>
</ul>
<h4 data-id="heading-16">3.3.5 是否有其他应该被冻结但没有被尝试冻结的内核线程？</h4>
<p><strong>答案：没有</strong></p>
<p><strong>原因</strong>：</p>
<ul>
<li>从日志看，只有6个内核线程被尝试冻结（有<code>freeze_task</code>调用）</li>
<li>其他所有内核线程都被标记为UNFREEZABLE（有PF_NOFREEZE标志）</li>
<li><strong>这说明系统中所有内核线程要么有PF_NOFREEZE标志（不需要冻结），要么没有PF_NOFREEZE标志但被尝试冻结了（虽然失败了）</strong></li>
</ul>
<p><strong>关键点</strong>：</p>
<ul>
<li>第一阶段虽然主要冻结用户空间进程，但也会遍历所有任务，包括内核线程</li>
<li>所以，所有没有<code>PF_NOFREEZE</code>标志的内核线程在第一阶段就被尝试冻结了</li>
<li>第二阶段主要是为了确保所有可冻结的内核线程都被冻结，但由于第一阶段已经处理了，所以第二阶段没有执行也不会遗漏</li>
</ul>
<p><strong>结论</strong>：</p>
<ul>
<li>除了这6个冻结失败的内核线程，其他内核线程都是不需要冻结的</li>
<li>系统中没有其他应该被冻结但没有被尝试冻结的内核线程</li>
</ul>
<h2 data-id="heading-17">四、问题分析</h2>
<h3 data-id="heading-18">4.1 为什么第二阶段没有执行？</h3>
<p><strong>原因</strong>：</p>
<ol>
<li>第一阶段（<code>freeze_processes()</code>）超时失败（error -16 = EBUSY）</li>
<li><code>suspend_freeze_processes()</code> 在检测到第一阶段失败后直接返回错误</li>
<li>没有调用 <code>freeze_kernel_threads()</code></li>
</ol>
<p><strong>代码逻辑</strong>：</p>
<pre><code class="hljs language-c" lang="c">error = freeze_processes();  <span class="hljs-comment">// 第一阶段失败</span>
<span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> error;  <span class="hljs-comment">// 直接返回，不执行第二阶段</span>
}
error = freeze_kernel_threads();  <span class="hljs-comment">// 永远不会执行到这里</span>
</code></pre>
<h3 data-id="heading-19">4.2 强制挂起的影响</h3>
<p><strong>系统行为</strong>：</p>
<ul>
<li>虽然 <code>suspend_freeze_processes()</code> 返回错误</li>
<li>但系统启用了 <code>FORCE SUSPEND</code></li>
<li>即使冻结失败也继续挂起</li>
<li><strong>结果</strong>：系统在不完整的状态下进入深度睡眠</li>
</ul>
<h3 data-id="heading-20">4.3 这导致的问题</h3>
<ol>
<li>
<p><strong>内核线程没有被冻结</strong>：</p>
<ul>
<li>应该被冻结的内核线程（没有PF_NOFREEZE标志的）没有被冻结</li>
<li>包括kswapd0和jbd2线程（虽然它们冻结失败，但至少尝试了）</li>
</ul>
</li>
<li>
<p><strong>状态不一致</strong>：</p>
<ul>
<li>用户空间进程被冻结了（3个）</li>
<li>内核线程没有被冻结（除了有PF_NOFREEZE标志的）</li>
<li>系统在不一致的状态下进入深度睡眠</li>
</ul>
</li>
<li>
<p><strong>唤醒失败的可能原因</strong>：</p>
<ul>
<li>内核线程（如kswapd0、jbd2）没有被冻结</li>
<li>它们可能处于不一致的状态</li>
<li>唤醒时无法从不一致的状态中恢复</li>
</ul>
</li>
</ol>
<h2 data-id="heading-21">五、正常流程应该是怎样的？</h2>
<h3 data-id="heading-22">5.1 正常流程</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  └─ 冻结用户空间进程
  ↓
<span class="hljs-built_in">freeze_kernel_threads</span>()  <span class="hljs-selector-attr">[第二阶段]</span>
  ├─ 设置 pm_nosig_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(false)
  └─ 冻结可冻结的内核线程（没有PF_NOFREEZE标志的）
</code></pre>
<h3 data-id="heading-23">5.2 实际流程（从日志看）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  ├─ 冻结用户空间进程（部分成功，<span class="hljs-number">3</span>个）
  └─ ❌ 超时失败（error -<span class="hljs-number">16</span>）
  ↓
❌ 直接返回错误，不执行第二阶段
  ↓
FORCE SUSPEND启用，继续挂起
  ↓
系统在不完整的状态下进入深度睡眠
</code></pre>
<h2 data-id="heading-24">六、结论</h2>
<h3 data-id="heading-25">6.1 关键结论</h3>
<p><strong>是的，您确实没有冻结应该被冻结的内核线程！</strong></p>
<p><strong>原因</strong>：</p>
<ol>
<li>第一阶段（冻结用户空间进程）失败</li>
<li>因为第一阶段失败，第二阶段（冻结内核线程）<strong>根本没有执行</strong></li>
<li>系统启用了强制挂起，即使冻结失败也继续挂起</li>
<li>结果：应该被冻结的内核线程（没有PF_NOFREEZE标志的）没有被冻结</li>
</ol>
<h3 data-id="heading-26">6.2 影响</h3>
<ol>
<li>
<p><strong>kswapd0和jbd2线程</strong>：</p>
<ul>
<li>没有PF_NOFREEZE标志，应该被冻结</li>
<li>第一阶段尝试冻结它们，但失败了</li>
<li>第二阶段应该再次尝试，但第二阶段没有执行</li>
<li><strong>结果：它们没有被冻结</strong></li>
</ul>
</li>
<li>
<p><strong>其他应该被冻结的内核线程</strong>：</p>
<ul>
<li>没有PF_NOFREEZE标志</li>
<li>第一阶段不会冻结它们（只冻结用户空间进程）</li>
<li>第二阶段应该冻结它们，但第二阶段没有执行</li>
<li><strong>结果：它们也没有被冻结</strong></li>
</ul>
</li>
<li>
<p><strong>系统状态</strong>：</p>
<ul>
<li>只有3个用户空间进程被冻结</li>
<li>应该被冻结的内核线程都没有被冻结</li>
<li>系统在不一致的状态下进入深度睡眠</li>
<li><strong>这很可能是唤醒失败的根本原因</strong></li>
</ul>
</li>
</ol>
<h3 data-id="heading-27">6.3 建议</h3>
<ol>
<li>
<p><strong>禁用强制挂起模式</strong>：</p>
<ul>
<li>如果冻结失败，应该取消挂起，而不是强制继续</li>
<li>这样可以避免系统在不完整的状态下进入深度睡眠</li>
</ul>
</li>
<li>
<p><strong>优化冻结机制</strong>：</p>
<ul>
<li>解决第一阶段冻结失败的问题</li>
<li>确保能够进入第二阶段，冻结内核线程</li>
</ul>
</li>
<li>
<p><strong>增加调试信息</strong>：</p>
<ul>
<li>记录哪些内核线程应该被冻结但没有被冻结</li>
<li>帮助诊断问题</li>
</ul>
</li>
</ol>
<h2 data-id="heading-28">七、内核线程分类总结</h2>
<h3 data-id="heading-29">7.1 完整分类表</h3>








































<table><thead><tr><th>类别</th><th>数量</th><th>特征</th><th>是否需要冻结</th><th>实际行为</th></tr></thead><tbody><tr><td><strong>成功冻结</strong></td><td>3</td><td>用户空间进程</td><td>✅ 需要</td><td>成功冻结</td></tr><tr><td><strong>UNFREEZABLE</strong></td><td>95</td><td>有PF_NOFREEZE标志</td><td>❌ 不需要</td><td>标记为UNFREEZABLE，跳过冻结</td></tr><tr><td><strong>FAILED_FREEZE</strong></td><td>6</td><td>没有PF_NOFREEZE标志</td><td>✅ 需要</td><td>尝试冻结但失败</td></tr><tr><td><strong>跳过</strong></td><td>18</td><td>其他被跳过的任务</td><td>-</td><td>被跳过</td></tr></tbody></table>
<h3 data-id="heading-30">7.2 关键结论</h3>
<ol>
<li>
<p><strong>其他内核线程（95个）都是不需要冻结的</strong>：</p>
<ul>
<li>它们都有<code>PF_NOFREEZE</code>标志</li>
<li>这是正确的行为，这些内核线程不应该被冻结</li>
<li>包括：kthreadd、rcu_gp、所有kworker线程、中断处理线程等</li>
</ul>
</li>
<li>
<p><strong>只有6个内核线程是应该被冻结但没有成功冻结的</strong>：</p>
<ul>
<li>它们没有<code>PF_NOFREEZE</code>标志</li>
<li>应该被冻结，但冻结失败</li>
<li>包括：kswapd0和5个jbd2线程</li>
</ul>
</li>
<li>
<p><strong>系统中没有其他应该被冻结但没有被尝试冻结的内核线程</strong>：</p>
<ul>
<li>从日志看，只有这6个内核线程没有<code>PF_NOFREEZE</code>标志</li>
<li>这6个线程都被尝试冻结了（虽然失败了）</li>
<li>其他所有内核线程都有<code>PF_NOFREEZE</code>标志，不需要冻结</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python--面向对象（3）]]></title>    <link>https://juejin.cn/post/7585395972294410249</link>    <guid>https://juejin.cn/post/7585395972294410249</guid>    <pubDate>2025-12-19T14:50:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294410249" data-draft-id="7585406229168013362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python--面向对象（3）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-19T14:50:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="酷酷的佳"/> <meta itemprop="url" content="https://juejin.cn/user/2939463340923272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python--面向对象（3）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2939463340923272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    酷酷的佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T14:50:52.000Z" title="Fri Dec 19 2025 14:50:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、常用魔术方法（特殊方法）</h2>
<p>Python 中以 <code>__</code> 开头和结尾的方法称为 “魔术方法”，用于自定义对象的行为：</p>



































<table><thead><tr><th>方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>__init__</code></td><td>初始化实例</td><td><code>def __init__(self, name): ...</code></td></tr><tr><td><code>__str__</code></td><td>打印实例时的字符串</td><td><code>def __str__(self): return f"Person({self.name})"</code></td></tr><tr><td><code>__repr__</code></td><td>交互式解释器显示的字符串</td><td><code>def __repr__(self): return f"Person('{self.name}')"</code></td></tr><tr><td><code>__add__</code></td><td>重载 + 运算符</td><td><code>def __add__(self, other): return self.age + other.age</code></td></tr><tr><td><code>__len__</code></td><td>重载 len () 函数</td><td><code>def __len__(self): return len(self.name)</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Person(name=<span class="hljs-subst">{self.name}</span>, age=<span class="hljs-subst">{self.age}</span>)"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-keyword">return</span> self.age + other.age

p1 = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>)
p2 = Person(<span class="hljs-string">"李四"</span>, <span class="hljs-number">19</span>)

<span class="hljs-built_in">print</span>(p1)        <span class="hljs-comment"># 输出：Person(name=张三, age=18)（调用 __str__）</span>
<span class="hljs-built_in">print</span>(p1 + p2)   <span class="hljs-comment"># 输出：37（调用 __add__）</span>
</code></pre>
<h2 data-id="heading-1">二、抽象类</h2>
<p>抽象类是包含 “抽象方法” 的类，不能实例化，子类必须实现抽象方法（强制规范子类行为），需借助 <code>abc</code> 模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABCMeta, abstractmethod

<span class="hljs-comment"># 抽象类：继承 ABCMeta</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span>(metaclass=ABCMeta):
    <span class="hljs-comment"># 抽象方法：只有定义，无实现</span>
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 子类必须实现抽象方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-title class_ inherited__">Shape</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, radius</span>):
        self.radius = radius
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14</span> * self.radius **<span class="hljs-number">2</span>

<span class="hljs-comment"># shape = Shape()  # 报错：无法实例化抽象类</span>
circle = Circle(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(circle.area())  <span class="hljs-comment"># 输出：78.5</span>
</code></pre>
<h2 data-id="heading-2">三、组合：替代多继承的复用方式</h2>
<p>组合是将 “其他类的实例” 作为当前类的属性，实现代码复用（比多继承更灵活）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 引擎类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"引擎启动"</span>)

<span class="hljs-comment"># 汽车类（组合引擎类）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.engine = Engine()  <span class="hljs-comment"># 组合：将 Engine 实例作为属性</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self</span>):
        self.engine.run()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"汽车启动"</span>)

car = Car()
car.start()
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 引擎启动</span>
<span class="hljs-comment"># 汽车启动</span>
</code></pre>
<h2 data-id="heading-3">四、核心总结</h2>
<ol>
<li>
<p><strong>类与对象</strong>：类是模板，对象是实例，<code>self</code> 指代当前实例；</p>
</li>
<li>
<p><strong>属性</strong>：实例属性（独有）、类属性（共享）；</p>
</li>
<li>
<p><strong>方法</strong>：实例方法（<code>self</code>）、类方法（<code>@classmethod + cls</code>）、静态方法（<code>@staticmethod</code>）；</p>
</li>
<li>
<p><strong>三大特性</strong>：</p>
<ul>
<li>封装：私有属性 / 方法 + <code>@property</code> 隐藏细节；</li>
<li>继承：<code>class 子类(父类)</code>，<code>super()</code> 调用父类方法；</li>
<li>多态：子类重写父类方法，统一接口调用；</li>
</ul>
</li>
<li>
<p><strong>进阶</strong>：魔术方法自定义对象行为，抽象类强制子类规范，组合替代多继承实现复用。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二进制安装Kubernetes（k8s）v1.35.0]]></title>    <link>https://juejin.cn/post/7585395972294524937</link>    <guid>https://juejin.cn/post/7585395972294524937</guid>    <pubDate>2025-12-19T15:42:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294524937" data-draft-id="7585227038992285734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二进制安装Kubernetes（k8s）v1.35.0"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-19T15:42:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈运维"/> <meta itemprop="url" content="https://juejin.cn/user/3315782802482007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二进制安装Kubernetes（k8s）v1.35.0
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782802482007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈运维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T15:42:05.000Z" title="Fri Dec 19 2025 15:42:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">二进制安装Kubernetes（k8s）v1.35.0</h2>
<h2 data-id="heading-1">介绍</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a> 开源不易，帮忙点个star，谢谢了</h3>
<h3 data-id="heading-3">支持IPv4+IPv6双栈。本文是精简文档，删除了注释以及一些基础的内容，社交媒体超出字数限制，完整版见：</h3>
<h3 data-id="heading-4">项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></h3>
<h2 data-id="heading-5">1.环境</h2>





















































<table><thead><tr><th>主机名称</th><th>IP地址</th><th>说明</th><th>软件</th></tr></thead><tbody><tr><td/><td>192.168.1.60</td><td>外网节点</td><td>下载各种所需安装包</td></tr><tr><td>Master01</td><td>192.168.1.31</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master02</td><td>192.168.1.32</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master03</td><td>192.168.1.33</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Node01</td><td>192.168.1.34</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td>Node02</td><td>192.168.1.35</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td/><td>192.168.1.36</td><td>VIP</td><td/></tr></tbody></table>
<p>详细版本</p>

























































<table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>cni_plugins_version</td><td>v1.9.0</td></tr><tr><td>cri_containerd_cni_version</td><td>2.2.1</td></tr><tr><td>crictl_version</td><td>v1.35.0</td></tr><tr><td>cri_dockerd_version</td><td>0.3.21</td></tr><tr><td>etcd_version</td><td>v3.6.7</td></tr><tr><td>cfssl_version</td><td>1.6.5</td></tr><tr><td>kubernetes_server_version</td><td>1.35.0</td></tr><tr><td>docker_version</td><td>29.1.3</td></tr><tr><td>runc_version</td><td>1.4.0</td></tr><tr><td>kernel_version</td><td>6.16.4</td></tr><tr><td>helm_version</td><td>4.0.4</td></tr><tr><td>nginx_version</td><td>1.29.4</td></tr></tbody></table>
<p>网段  <br/></p>
<p>IPv4   <br/>
物理主机：192.168.1.0/24  <br/>
service：10.96.0.0/12  <br/>
pod：172.16.0.0/12 <br/></p>
<p>IPv6   <br/>
物理主机：2408:822a:732:5ce1::1001/64  <br/>
物理主机：fc00::31/8  <br/>
service：fd00:1111::/112  <br/>
pod：fc00:2222::/112</p>
<p>安装包已经整理好：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes%2Freleases%2Fdownload%2Fv1.35.0%2Fkubernetes-v1.35.0.tar" target="_blank" title="https://github.com/cby-chen/Kubernetes/releases/download/v1.35.0/kubernetes-v1.35.0.tar" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<h3 data-id="heading-6">1.1.k8s基础系统环境配置</h3>
<h4 data-id="heading-7">1.2.配置IP</h4>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-8">1.3.设置主机名</h4>
<pre><code class="hljs language-shell" lang="shell">hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-master02
hostnamectl set-hostname k8s-master03
hostnamectl set-hostname k8s-node01
hostnamectl set-hostname k8s-node02
</code></pre>
<h4 data-id="heading-9">1.4.配置yum源</h4>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-10">1.5.安装一些必备工具</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">对于 Ubuntu</span>
apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y wget psmisc vim net-tools nfs-kernel-server telnet lvm2 git tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 7</span>
yum update -y &amp;&amp; yum -y install  wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 8</span>
yum update -y &amp;&amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 9</span>
yum update -y &amp;&amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl
</code></pre>
<h5 data-id="heading-11">1.5.1 下载离线所需文件(可选)</h5>
<p>在互联网服务器上安装一个一模一样的系统进行下载所需包</p>
<h6 data-id="heading-12">CentOS7</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-13">CentOS8</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-14">CentOS9</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-15">Ubuntu 下载包和依赖</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-16">1.6.选择性下载需要工具</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">查看版本地址：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">
<span class="hljs-comment"># https://github.com/containernetworking/plugins/releases/</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/containerd/containerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/etcd-io/etcd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/cloudflare/cfssl/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/opencontainers/runc/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/helm/helm/tags</span>
<span class="hljs-meta prompt_"># </span><span class="bash">http://nginx.org/download/</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">Version numbers</span>
cni_plugins_version='v1.9.0'
cri_containerd_cni_version='2.2.1'
crictl_version='v1.35.0'
cri_dockerd_version='0.3.21'
etcd_version='v3.6.7'
cfssl_version='1.6.5'
kubernetes_server_version='1.35.0'
docker_version='29.1.3'
runc_version='1.4.0'
kernel_version='5.4.278'
helm_version='4.0.4'
nginx_version='1.29.4'
<span class="hljs-meta prompt_">
# </span><span class="bash">URLs</span> 
base_url='https://github.com'
kernel_url="http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-${kernel_version}-1.el7.elrepo.x86_64.rpm"
runc_url="${base_url}/opencontainers/runc/releases/download/v${runc_version}/runc.amd64"
docker_url="https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-${docker_version}.tgz"
cni_plugins_url="${base_url}/containernetworking/plugins/releases/download/${cni_plugins_version}/cni-plugins-linux-amd64-${cni_plugins_version}.tgz"
cri_containerd_cni_url="${base_url}/containerd/containerd/releases/download/v${cri_containerd_cni_version}/containerd-${cri_containerd_cni_version}-linux-amd64.tar.gz"
crictl_url="${base_url}/kubernetes-sigs/cri-tools/releases/download/${crictl_version}/crictl-${crictl_version}-linux-amd64.tar.gz"
cri_dockerd_url="${base_url}/Mirantis/cri-dockerd/releases/download/v${cri_dockerd_version}/cri-dockerd-${cri_dockerd_version}.amd64.tgz"
etcd_url="${base_url}/etcd-io/etcd/releases/download/${etcd_version}/etcd-${etcd_version}-linux-amd64.tar.gz"
cfssl_url="${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssl_${cfssl_version}_linux_amd64"
cfssljson_url="${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssljson_${cfssl_version}_linux_amd64"
helm_url="https://mirrors.huaweicloud.com/helm/v${helm_version}/helm-v${helm_version}-linux-amd64.tar.gz"
kubernetes_server_url="https://cdn.dl.k8s.io/release/v${kubernetes_server_version}/kubernetes-server-linux-amd64.tar.gz"
nginx_url="http://nginx.org/download/nginx-${nginx_version}.tar.gz"
<span class="hljs-meta prompt_">
# </span><span class="bash">Download packages</span>
packages=(
<span class="hljs-meta prompt_">  # </span><span class="bash"><span class="hljs-variable">$kernel_url</span></span>
<span class="hljs-meta prompt_">  $</span><span class="bash">runc_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">docker_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cni_plugins_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cri_containerd_cni_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">crictl_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cri_dockerd_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">etcd_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cfssl_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cfssljson_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">helm_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">kubernetes_server_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">nginx_url</span>
)

for package_url in "${packages[@]}"; do
  filename=$(basename "$package_url")
  if curl --parallel --parallel-immediate -k -L -C - -o "$filename" "$package_url"; then
    echo "Downloaded $filename"
  else
    echo "Failed to download $filename"
    exit 1
  fi
done
</code></pre>
<h4 data-id="heading-17">1.7.关闭防火墙</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
systemctl disable --now firewalld
</code></pre>
<h4 data-id="heading-18">1.8.关闭SELinux</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
</code></pre>
<h4 data-id="heading-19">1.9.关闭交换分区</h4>
<pre><code class="hljs language-shell" lang="shell">sed -ri 's/.*swap.*/#&amp;/' /etc/fstab
swapoff -a &amp;&amp; sysctl -w vm.swappiness=0

cat /etc/fstab
<span class="hljs-meta prompt_"># </span><span class="bash">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
</code></pre>
<h4 data-id="heading-20">1.10.网络配置（俩种方式二选一）</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行，CentOS9不支持方式一</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">方式一</span>
<span class="hljs-meta prompt_"># </span><span class="bash">systemctl <span class="hljs-built_in">disable</span> --now NetworkManager</span>
<span class="hljs-meta prompt_"># </span><span class="bash">systemctl start network &amp;&amp; systemctl <span class="hljs-built_in">enable</span> network</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">方式二</span>
cat &gt; /etc/NetworkManager/conf.d/calico.conf &lt;&lt; EOF 
[keyfile]
unmanaged-devices=interface-name:cali*;interface-name:tunl*
EOF
systemctl restart NetworkManager
</code></pre>
<h4 data-id="heading-21">1.11.进行时间同步</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">服务端</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install chrony -y</span>
yum install chrony -y
cat &gt; /etc/chrony.conf &lt;&lt; EOF 
pool ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow 192.168.1.0/24
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF

systemctl restart chronyd ; systemctl enable chronyd
<span class="hljs-meta prompt_">
# </span><span class="bash">客户端</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install chrony -y</span>
yum install chrony -y
cat &gt; /etc/chrony.conf &lt;&lt; EOF 
pool 192.168.1.31 iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF

systemctl restart chronyd ; systemctl enable chronyd
<span class="hljs-meta prompt_">
#</span><span class="bash">使用客户端进行验证</span>
chronyc sources -v
</code></pre>
<h4 data-id="heading-22">1.12.配置ulimit</h4>
<pre><code class="hljs language-shell" lang="shell">ulimit -SHn 65535
cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimitedd
EOF
</code></pre>
<h4 data-id="heading-23">1.13.配置免密登录</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">apt install -y sshpass</span>
yum install -y sshpass
ssh-keygen -f /root/.ssh/id_rsa -P ''
export IP="192.168.1.31 192.168.1.32 192.168.1.33 192.168.1.34 192.168.1.35"
export SSHPASS=123123
for HOST in $IP;do
     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST
done
</code></pre>
<h4 data-id="heading-24">1.14.添加启用源</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-9或 CentOS-9配置源</span>
yum install https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-8或 CentOS-8配置源</span>
yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo</span> 
yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">查看可用安装包</span>
yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available
</code></pre>
<h4 data-id="heading-25">1.15.升级内核至4.18版本以上</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">安装最新的内核</span>
<span class="hljs-meta prompt_"># </span><span class="bash">我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt</span>  
yum -y --enablerepo=elrepo-kernel  install  kernel-ml
<span class="hljs-meta prompt_">
# </span><span class="bash">查看已安装那些内核</span>
rpm -qa | grep kernel
<span class="hljs-meta prompt_">
# </span><span class="bash">查看默认内核</span>
grubby --default-kernel
<span class="hljs-meta prompt_">
# </span><span class="bash">若不是最新的使用命令设置</span>
grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo)
<span class="hljs-meta prompt_">
# </span><span class="bash">重启生效</span>
reboot
<span class="hljs-meta prompt_">
# </span><span class="bash">v8 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install kernel-lt -y ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">v8 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install kernel-lt -y ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">v7 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install  kernel-lt -y ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">离线版本</span> 
yum install -y /root/cby/kernel-lt-*-1.el7.elrepo.x86_64.rpm ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot 
</code></pre>
<h4 data-id="heading-26">1.16.安装ipvsadm</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">对于CentOS7离线安装</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum install /root/centos7/ipset-*.el7.x86_64.rpm /root/centos7/lm_sensors-libs-*.el7.x86_64.rpm  /root/centos7/ipset-libs-*.el7.x86_64.rpm /root/centos7/sysstat-*.el7_9.x86_64.rpm  /root/centos7/ipvsadm-*.el7.x86_64.rpm  -y</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 Ubuntu</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install ipvsadm ipset sysstat conntrack -y</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS</span>
yum install ipvsadm ipset sysstat conntrack libseccomp -y
cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF 
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF

systemctl restart systemd-modules-load.service

lsmod | grep -e ip_vs -e nf_conntrack
ip_vs_sh               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 237568  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          217088  3 nf_nat,nft_ct,ip_vs
nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs
nf_defrag_ipv4         16384  1 nf_conntrack
libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs

</code></pre>
<h4 data-id="heading-27">1.17.修改内核参数</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384

net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding = 1
EOF

sysctl --system
</code></pre>
<h4 data-id="heading-28">1.18.所有节点配置hosts本地解析</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/hosts &lt;&lt;EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.1.31 k8s-master01
192.168.1.32 k8s-master02
192.168.1.33 k8s-master03
192.168.1.34 k8s-node01
192.168.1.35 k8s-node02
192.168.1.36 lb-vip

fc00::31 k8s-master01
fc00::32 k8s-master02
fc00::33 k8s-master03
fc00::34 k8s-node01
fc00::35 k8s-node02
EOF
</code></pre>
<h2 data-id="heading-29">2.k8s基本组件安装</h2>
<p><strong>注意 ： 2.1 和 2.2 二选其一即可</strong></p>
<h3 data-id="heading-30">2.1.安装Containerd作为Runtime</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/containernetworking/plugins/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/containernetworking/plugins/releases/download/v1.7.1/cni-plugins-linux-amd64-v1.7.1.tgz</span>

cd cby/
<span class="hljs-meta prompt_">
#</span><span class="bash">创建cni插件所需目录</span>
mkdir -p /etc/cni/net.d /opt/cni/bin 
<span class="hljs-meta prompt_">#</span><span class="bash">解压cni二进制包</span>
tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/
<span class="hljs-meta prompt_">
# </span><span class="bash">https://github.com/containerd/containerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/containerd/containerd/releases/download/v2.0.5/containerd-2.0.5-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar -xzf containerd-*-linux-amd64.tar.gz -C /usr/local/
<span class="hljs-meta prompt_">
#</span><span class="bash">创建服务启动文件</span>
cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-31">2.1.1配置Containerd所需的模块</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
</code></pre>
<h4 data-id="heading-32">2.1.2加载模块</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl restart systemd-modules-load.service
</code></pre>
<h4 data-id="heading-33">2.1.3配置Containerd所需的内核</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">加载内核</span>
sysctl --system
</code></pre>
<h4 data-id="heading-34">2.1.4创建Containerd的配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建默认配置文件</span>
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml
<span class="hljs-meta prompt_">
# </span><span class="bash">修改Containerd的配置文件</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">sed -i <span class="hljs-string">"s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g"</span> /etc/containerd/config.toml</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">cat</span> /etc/containerd/config.toml | grep SystemdCgroup</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">沙箱pause镜像</span>
sed -i "s#registry.k8s.io#registry.aliyuncs.com/chenby#g" /etc/containerd/config.toml
cat /etc/containerd/config.toml | grep sandbox
<span class="hljs-meta prompt_">
# </span><span class="bash">配置加速器</span>
[root@k8s-master01 ~]# vim /etc/containerd/config.toml
[root@k8s-master01 ~]# cat /etc/containerd/config.toml | grep certs.d -C 5

    [plugins.'io.containerd.cri.v1.images'.pinned_images]
      sandbox = 'registry.aliyuncs.com/chenby/pause:3.10'

    [plugins.'io.containerd.cri.v1.images'.registry]
      config_path = '/etc/containerd/certs.d'

    [plugins.'io.containerd.cri.v1.images'.image_decryption]
      key_model = 'node'

  [plugins.'io.containerd.cri.v1.runtime']
[root@k8s-master01 ~]# 


mkdir /etc/containerd/certs.d/docker.io -pv
cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF
server = "https://docker.io"
[host."https://jockerhub.com"]
  capabilities = ["pull", "resolve"]
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">配置 GFW 代理</span>
mkdir -p /etc/systemd/system/containerd.service.d
touch /etc/systemd/system/containerd.service.d/http-proxy.conf
tee /etc/systemd/system/containerd.service.d/http-proxy.conf &lt;&lt; EOF
[Service]
Environment="HTTP_PROXY=http://IP:Port"
Environment="HTTPS_PROXY=http://IP:Port"
Environment="NO_PROXY=localhost,127.0.0.1,containerd"
EOF
</code></pre>
<h4 data-id="heading-35">2.1.5启动并设置为开机启动</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now containerd.service
systemctl stop containerd.service
systemctl start containerd.service
systemctl restart containerd.service
systemctl status containerd.service
</code></pre>
<h4 data-id="heading-36">2.1.6配置crictl客户端连接的运行时位置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.35.0/crictl-v1.35.0-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar xf crictl-v*-linux-amd64.tar.gz -C /usr/bin/
<span class="hljs-meta prompt_">#</span><span class="bash">生成配置文件</span>
cat &gt; /etc/crictl.yaml &lt;&lt;EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
<span class="hljs-meta prompt_">
#</span><span class="bash">测试</span>
systemctl restart  containerd
crictl info
</code></pre>
<h3 data-id="heading-37">2.2 安装docker作为Runtime</h3>
<h4 data-id="heading-38">2.2.1 解压docker程序</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-27.4.0.tgz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar xf docker-*.tgz 
<span class="hljs-meta prompt_">#</span><span class="bash">拷贝二进制文件</span>
cp docker/* /usr/bin/
</code></pre>
<h4 data-id="heading-39">2.2.2 创建containerd的service文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">创建containerd的service文件,并且启动</span>
cat &gt;/etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">设置开机自启</span>
systemctl enable --now containerd.service
</code></pre>
<h4 data-id="heading-40">2.2.3 准备docker的service文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">准备docker的service文件</span>
cat &gt; /etc/systemd/system/docker.service &lt;&lt;EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
Type=notify
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process
OOMScoreAdjust=-500

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-41">2.2.4 准备docker的socket文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">准备docker的socket文件</span>
cat &gt; /etc/systemd/system/docker.socket &lt;&lt;EOF
[Unit]
Description=Docker Socket for the API

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF
</code></pre>
<h4 data-id="heading-42">2.2.5 配置加速器</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">配置加速器</span>
mkdir /etc/docker/ -pv
cat &gt;/etc/docker/daemon.json &lt;&lt;EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "registry-mirrors": [
    "https://jockerhub.com"
  ],
  "max-concurrent-downloads": 10,
  "log-driver": "json-file",
  "log-level": "warn",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
    },
  "data-root": "/var/lib/docker",
  "proxies": {
    "http-proxy": "http://192.168.1.100:7890",
    "https-proxy": "http://192.168.1.100:7890",
    "no-proxy": "localhost"
  }
}
EOF
</code></pre>
<h4 data-id="heading-43">2.2.6 启动docker</h4>
<pre><code class="hljs language-shell" lang="shell">groupadd docker
systemctl daemon-reload
systemctl enable --now docker.service
systemctl enable --now docker.socket
systemctl stop docker.service
systemctl start docker.service
systemctl restart docker.service
systemctl status docker.service
docker info
</code></pre>
<h4 data-id="heading-44">2.2.7 解压cri-docker</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">由于1.24以及更高版本不支持docker所以安装cri-docker</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下载cri-docker</span> 
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget  https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.16/cri-dockerd-0.3.16.amd64.tgz</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">解压cri-docker</span>
tar xvf cri-dockerd-*.amd64.tgz 
cp -r cri-dockerd/  /usr/bin/
chmod +x /usr/bin/cri-dockerd/cri-dockerd
</code></pre>
<h4 data-id="heading-45">2.2.8 写入启动cri-docker配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入启动配置文件</span>
cat &gt;  /usr/lib/systemd/system/cri-docker.service &lt;&lt;EOF
[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=5
Restart=always
StartLimitBurst=5
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-46">2.2.9 写入cri-docker的socket配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入socket配置文件</span>
cat &gt; /usr/lib/systemd/system/cri-docker.socket &lt;&lt;EOF
[Unit]
Description=CRI Docker Socket for the API
PartOf=cri-docker.service

[Socket]
ListenStream=%t/cri-dockerd.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF
</code></pre>
<h4 data-id="heading-47">2.2.10 启动cri-docker</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now cri-docker.service
systemctl restart cri-docker.service
systemctl status cri-docker.service
</code></pre>
<h3 data-id="heading-48">2.3.k8s与etcd下载及安装（仅在master01操作）</h3>
<h4 data-id="heading-49">2.3.1解压k8s安装包</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载安装包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/etcd-io/etcd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
<span class="hljs-meta prompt_"># </span><span class="bash">
<span class="hljs-comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.5.21/etcd-v3.5.21-linux-amd64.tar.gz</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://cdn.dl.k8s.io/release/v1.35.0/kubernetes-server-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">解压k8s安装文件</span>
cd cby
tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}
<span class="hljs-meta prompt_">
# </span><span class="bash">解压etcd安装文件</span>
tar -xf etcd*.tar.gz &amp;&amp; mv etcd-*/etcd /usr/local/bin/ &amp;&amp; mv etcd-*/etcdctl /usr/local/bin/
<span class="hljs-meta prompt_">
# </span><span class="bash">查看/usr/local/bin下内容</span>
[root@localhost cby]# ll /usr/local/bin/
总用量 398984
-rwxr-xr-x 1 1000 docker 26087608 12月 18 03:41 etcd
-rwxr-xr-x 1 1000 docker 17207480 12月 18 03:41 etcdctl
-rwxr-xr-x 1 root root   85766328 12月 17 20:56 kube-apiserver
-rwxr-xr-x 1 root root   71815352 12月 17 20:56 kube-controller-manager
-rwxr-xr-x 1 root root   58597560 12月 17 20:56 kubectl
-rwxr-xr-x 1 root root   58110244 12月 17 20:56 kubelet
-rwxr-xr-x 1 root root   43258040 12月 17 20:56 kube-proxy
-rwxr-xr-x 1 root root   47685816 12月 17 20:56 kube-scheduler
[root@localhost cby]# 

</code></pre>
<h4 data-id="heading-50">2.3.2查看版本</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]#  kubelet --version
Kubernetes v1.35.0
[root@k8s-master01 ~]# etcdctl version
etcdctl version: 3.6.7
API version: 3.6
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-51">2.3.3将组件发送至其他k8s节点</h4>
<pre><code class="hljs language-shell" lang="shell">Master='k8s-master02 k8s-master03'
Work='k8s-node01 k8s-node02'
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝master组件</span>
for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝work组件</span>
for NODE in $Work; do echo $NODE; scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done
<span class="hljs-meta prompt_">
# </span><span class="bash">所有节点执行</span>
mkdir -p /opt/cni/bin
</code></pre>
<h3 data-id="heading-52">2.3创建证书相关文件</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">请查看Github仓库 或者进行获取已经打好的包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">可以根据下文3.x进行手动部署操作</span> 
https://github.com/cby-chen/Kubernetes/
https://github.com/cby-chen/Kubernetes/tags
https://github.com/cby-chen/Kubernetes/releases/download/v1.35.0/kubernetes-v1.35.0.tar
</code></pre>
<h2 data-id="heading-53">3.相关证书生成</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">master01节点下载证书生成工具</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget <span class="hljs-string">"https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl_1.6.5_linux_amd64"</span> -O /usr/local/bin/cfssl</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget <span class="hljs-string">"https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64"</span> -O /usr/local/bin/cfssljson</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">软件包内有</span>
cp cfssl_*_linux_amd64 /usr/local/bin/cfssl
cp cfssljson_*_linux_amd64 /usr/local/bin/cfssljson
<span class="hljs-meta prompt_">
# </span><span class="bash">添加执行权限</span>
chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre>
<h3 data-id="heading-54">3.1.生成etcd证书</h3>
<p>特别说明除外，以下操作在所有master节点操作</p>
<h4 data-id="heading-55">3.1.1所有master节点创建证书存放目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir /etc/etcd/ssl -p
</code></pre>
<h4 data-id="heading-56">3.1.2master01节点生成etcd证书</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入生成证书所需的配置文件</span>
cat &gt; ca-config.json &lt;&lt; EOF 
{
  "signing": {
    "default": {
      "expiry": "876000h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "876000h"
      }
    }
  }
}
EOF

cat &gt; etcd-ca-csr.json  &lt;&lt; EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若没有IPv6 可删除可保留</span> 

cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca

cat &gt; etcd-csr.json &lt;&lt; EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/etcd/ssl/etcd-ca.pem \
   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \
   -config=ca-config.json \
   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.31,192.168.1.32,192.168.1.33,::1 \
   -profile=kubernetes \
   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
</code></pre>
<h4 data-id="heading-57">3.1.3将证书复制到其他节点</h4>
<pre><code class="hljs language-shell" lang="shell">Master='k8s-master02 k8s-master03'
for NODE in $Master; do ssh $NODE "mkdir -p /etc/etcd/ssl"; for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do scp /etc/etcd/ssl/${FILE} $NODE:/etc/etcd/ssl/${FILE}; done; done
</code></pre>
<h3 data-id="heading-58">3.2.生成k8s相关证书</h3>
<p>特别说明除外，以下操作在所有master节点操作</p>
<h4 data-id="heading-59">3.2.1 所有k8s节点创建证书存放目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /etc/kubernetes/pki
</code></pre>
<h4 data-id="heading-60">3.2.2 master01节点生成k8s证书</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入生成证书所需的配置文件</span>
cat &gt; ca-csr.json   &lt;&lt; EOF 
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF


cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca

cat &gt; apiserver-csr.json &lt;&lt; EOF 
{
  "CN": "kube-apiserver",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span>
<span class="hljs-meta prompt_"># </span><span class="bash">10.96.0.1是service网段的第一个地址，需要计算，192.168.1.36为高可用vip地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若没有IPv6 可删除可保留</span> 

cfssl gencert   \
-ca=/etc/kubernetes/pki/ca.pem   \
-ca-key=/etc/kubernetes/pki/ca-key.pem   \
-config=ca-config.json   \
-hostname=10.96.0.1,192.168.1.36,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,z.oiox.cn,192.168.1.31,192.168.1.32,192.168.1.33,192.168.1.34,192.168.1.35,192.168.1.36,192.168.1.37,192.168.1.38,192.168.1.39,192.168.1.40,::1   \
-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</code></pre>
<h4 data-id="heading-61">3.2.3 生成apiserver聚合证书</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF 
{
  "CN": "kubernetes",
  "key": {
     "algo": "rsa",
     "size": 2048
  },
  "ca": {
    "expiry": "876000h"
  }
}
EOF

cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 

cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF 
{
  "CN": "front-proxy-client",
  "key": {
     "algo": "rsa",
     "size": 2048
  }
}
EOF

cfssl gencert  \
-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \
-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \
-config=ca-config.json   \
-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre>
<h4 data-id="heading-62">3.2.4 生成controller-manage的证书</h4>
<p>在《5.高可用配置》选择使用那种高可用方案
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code>
若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<pre><code class="hljs language-shell" lang="shell">cat &gt; manager-csr.json &lt;&lt; EOF 
{
  "CN": "system:kube-controller-manager",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-controller-manager",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
<span class="hljs-meta prompt_">

# </span><span class="bash">设置一个集群项</span>
<span class="hljs-meta prompt_"># </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>
kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://127.0.0.1:8443 \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes \
    --cluster=kubernetes \
    --user=system:kube-controller-manager \
    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
  # </span><span class="bash">设置一个用户项</span>
kubectl config set-credentials system:kube-controller-manager \
   --client-certificate=/etc/kubernetes/pki/controller-manager.pem \
   --client-key=/etc/kubernetes/pki/controller-manager-key.pem \
   --embed-certs=true \
   --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">设置默认环境</span>
kubectl config use-context system:kube-controller-manager@kubernetes \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

</code></pre>
<h4 data-id="heading-63">3.2.5 生成kube-scheduler的证书</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; scheduler-csr.json &lt;&lt; EOF 
{
  "CN": "system:kube-scheduler",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-scheduler",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
<span class="hljs-meta prompt_">

# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://127.0.0.1:8443 \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig


kubectl config set-credentials system:kube-scheduler \
     --client-certificate=/etc/kubernetes/pki/scheduler.pem \
     --client-key=/etc/kubernetes/pki/scheduler-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig


kubectl config set-context system:kube-scheduler@kubernetes \
     --cluster=kubernetes \
     --user=system:kube-scheduler \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</code></pre>
<h4 data-id="heading-64">3.2.6 生成admin的证书配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; admin-csr.json &lt;&lt; EOF 
{
  "CN": "admin",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
<span class="hljs-meta prompt_">
# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://127.0.0.1:8443     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config set-credentials kubernetes-admin  \
  --client-certificate=/etc/kubernetes/pki/admin.pem     \
  --client-key=/etc/kubernetes/pki/admin-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes    \
  --cluster=kubernetes     \
  --user=kubernetes-admin     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig
</code></pre>
<h4 data-id="heading-65">3.2.7 创建kube-proxy证书</h4>
<p>在《5.高可用配置》选择使用那种高可用方案
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code>
若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<pre><code class="hljs language-shell" lang="shell">cat &gt; kube-proxy-csr.json  &lt;&lt; EOF 
{
  "CN": "system:kube-proxy",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-proxy",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF

cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy
<span class="hljs-meta prompt_">
# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://127.0.0.1:8443     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig


kubectl config set-credentials kube-proxy  \
  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \
  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context kube-proxy@kubernetes    \
  --cluster=kubernetes     \
  --user=kube-proxy     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig

kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
</code></pre>
<h4 data-id="heading-66">3.2.8 创建ServiceAccount Key ——secret</h4>
<pre><code class="hljs language-shell" lang="shell">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</code></pre>
<h4 data-id="heading-67">3.2.9 将证书发送到其他master节点</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">其他节点创建目录</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">mkdir</span>  /etc/kubernetes/pki/ -p</span>

for NODE in k8s-master02 k8s-master03; do  for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do  scp /etc/kubernetes/pki/${FILE} $NODE:/etc/kubernetes/pki/${FILE}; done;  for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do  scp /etc/kubernetes/${FILE} $NODE:/etc/kubernetes/${FILE}; done; done
</code></pre>
<h4 data-id="heading-68">3.2.10 查看证书</h4>
<pre><code class="hljs language-shell" lang="shell">[root@localhost cby]# ll /etc/kubernetes/pki/
总用量 104
-rw-r--r-- 1 root root 1025 12月 19 20:22 admin.csr
-rw------- 1 root root 1675 12月 19 20:22 admin-key.pem
-rw-r--r-- 1 root root 1444 12月 19 20:22 admin.pem
-rw-r--r-- 1 root root 1415 12月 19 20:21 apiserver.csr
-rw------- 1 root root 1679 12月 19 20:21 apiserver-key.pem
-rw-r--r-- 1 root root 1805 12月 19 20:21 apiserver.pem
-rw-r--r-- 1 root root 1070 12月 19 20:21 ca.csr
-rw------- 1 root root 1679 12月 19 20:21 ca-key.pem
-rw-r--r-- 1 root root 1363 12月 19 20:21 ca.pem
-rw-r--r-- 1 root root 1082 12月 19 20:21 controller-manager.csr
-rw------- 1 root root 1675 12月 19 20:21 controller-manager-key.pem
-rw-r--r-- 1 root root 1501 12月 19 20:21 controller-manager.pem
-rw-r--r-- 1 root root  940 12月 19 20:21 front-proxy-ca.csr
-rw------- 1 root root 1679 12月 19 20:21 front-proxy-ca-key.pem
-rw-r--r-- 1 root root 1094 12月 19 20:21 front-proxy-ca.pem
-rw-r--r-- 1 root root  903 12月 19 20:21 front-proxy-client.csr
-rw------- 1 root root 1679 12月 19 20:21 front-proxy-client-key.pem
-rw-r--r-- 1 root root 1188 12月 19 20:21 front-proxy-client.pem
-rw-r--r-- 1 root root 1045 12月 19 20:22 kube-proxy.csr
-rw------- 1 root root 1679 12月 19 20:22 kube-proxy-key.pem
-rw-r--r-- 1 root root 1464 12月 19 20:22 kube-proxy.pem
-rw------- 1 root root 1704 12月 19 20:22 sa.key
-rw-r--r-- 1 root root  451 12月 19 20:22 sa.pub
-rw-r--r-- 1 root root 1058 12月 19 20:22 scheduler.csr
-rw------- 1 root root 1679 12月 19 20:22 scheduler-key.pem
-rw-r--r-- 1 root root 1476 12月 19 20:22 scheduler.pem
[root@localhost cby]# 
<span class="hljs-meta prompt_">


# </span><span class="bash">一共26个就对了</span>
ls /etc/kubernetes/pki/ |wc -l
26
</code></pre>
<h2 data-id="heading-69">4.k8s系统组件配置</h2>
<h3 data-id="heading-70">4.1.etcd配置</h3>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-71">4.1.1master01配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master01'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.31:2380'
listen-client-urls: 'https://192.168.1.31:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.31:2380'
advertise-client-urls: 'https://192.168.1.31:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h4 data-id="heading-72">4.1.2master02配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master02'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.32:2380'
listen-client-urls: 'https://192.168.1.32:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.32:2380'
advertise-client-urls: 'https://192.168.1.32:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h4 data-id="heading-73">4.1.3master03配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master03'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.33:2380'
listen-client-urls: 'https://192.168.1.33:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.33:2380'
advertise-client-urls: 'https://192.168.1.33:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h3 data-id="heading-74">4.2.创建service（所有master节点操作）</h3>
<h4 data-id="heading-75">4.2.1创建etcd.service并启动</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF

[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
TimeoutSec=0
RestartSec=60
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity

[Install]
WantedBy=multi-user.target
Alias=etcd3.service

EOF
</code></pre>
<h4 data-id="heading-76">4.2.2创建etcd证书目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir /etc/kubernetes/pki/etcd
ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/

systemctl daemon-reload
systemctl enable --now etcd.service
systemctl restart etcd.service
systemctl status etcd.service
</code></pre>
<h4 data-id="heading-77">4.2.3查看etcd状态</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
export ETCDCTL_API=3
etcdctl --endpoints="192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
|     ENDPOINT      |        ID        | VERSION | STORAGE VERSION | DB SIZE | IN USE | PERCENTAGE NOT IN USE | QUOTA  | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | DOWNGRADE TARGET VERSION | DOWNGRADE ENABLED |
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
| 192.168.1.33:2379 |  8065f2e59c8d68c |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |     false |      false |         4 |         14 |                 14 |        |                          |             false |
| 192.168.1.32:2379 | b7b7ad6bf4db3f28 |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |      true |      false |         4 |         14 |                 14 |        |                          |             false |
| 192.168.1.31:2379 | bf047bcfe3b9bf27 |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |     false |      false |         4 |         14 |                 14 |        |                          |             false |
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
</code></pre>
<h2 data-id="heading-78">5.高可用配置（在Master服务器上操作）</h2>
<p><em><em>注意</em> 5.1.1 和5.1.2 二选一即可</em>*</p>
<p>选择使用那种高可用方案，同时可以俩种都选用，实现内外兼顾的效果，比如：
5.1 的 NGINX方案实现集群内的高可用
5.2 的 haproxy、keepalived 方案实现集群外访问</p>
<p>在《3.2.生成k8s相关证书》</p>
<p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code>
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code></p>
<h3 data-id="heading-79">5.1 NGINX高可用方案</h3>
<h4 data-id="heading-80">5.1.1 进行编译</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装编译环境</span>
yum install gcc -y
<span class="hljs-meta prompt_">
# </span><span class="bash">下载解压nginx二进制文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget http://nginx.org/download/nginx-1.25.3.tar.gz</span>
tar xvf nginx-*.tar.gz
cd nginx-*
<span class="hljs-meta prompt_">
# </span><span class="bash">进行编译</span>
./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module
make &amp;&amp; make install 
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝编译好的nginx</span>
node='k8s-master02 k8s-master03 k8s-node01 k8s-node02'
for NODE in $node; do scp -r /usr/local/nginx/ $NODE:/usr/local/nginx/; done

</code></pre>
<h4 data-id="heading-81">5.1.2 写入启动配置</h4>
<p>在所有主机上执行</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入nginx配置文件</span>
cat &gt; /usr/local/nginx/conf/kube-nginx.conf &lt;&lt;EOF
worker_processes 1;
events {
    worker_connections  1024;
}
stream {
    upstream backend {
        least_conn;
        hash $remote_addr consistent;
        server 192.168.1.31:6443        max_fails=3 fail_timeout=30s;
        server 192.168.1.32:6443        max_fails=3 fail_timeout=30s;
        server 192.168.1.33:6443        max_fails=3 fail_timeout=30s;
    }
    server {
        listen 127.0.0.1:8443;
        proxy_connect_timeout 1s;
        proxy_pass backend;
    }
}
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">写入启动配置文件</span>
cat &gt; /etc/systemd/system/kube-nginx.service &lt;&lt;EOF
[Unit]
Description=kube-apiserver nginx proxy
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx
ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload
PrivateTmp=true
Restart=always
RestartSec=5
StartLimitInterval=0
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">设置开机自启</span>
systemctl daemon-reload
systemctl enable --now kube-nginx.service
systemctl restart kube-nginx.service
systemctl status kube-nginx.service
</code></pre>
<h3 data-id="heading-82">5.2 keepalived和haproxy 高可用方案</h3>
<h4 data-id="heading-83">5.2.1安装keepalived和haproxy服务</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl disable --now firewalld
setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
yum -y install keepalived haproxy
</code></pre>
<h4 data-id="heading-84">5.2.2修改haproxy配置文件（配置文件一样）</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;"EOF"
global
 maxconn 2000
 ulimit-n 16384
 log 127.0.0.1 local0 err
 stats timeout 30s

defaults
 log global
 mode http
 option httplog
 timeout connect 5000
 timeout client 50000
 timeout server 50000
 timeout http-request 15s
 timeout http-keep-alive 15s


frontend monitor-in
 bind *:33305
 mode http
 option httplog
 monitor-uri /monitor

frontend k8s-master
 bind 0.0.0.0:9443
 bind 127.0.0.1:9443
 mode tcp
 option tcplog
 tcp-request inspect-delay 5s
 default_backend k8s-master


backend k8s-master
 mode tcp
 option tcplog
 option tcp-check
 balance roundrobin
 default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
 server  k8s-master01  192.168.1.31:6443 check
 server  k8s-master02  192.168.1.32:6443 check
 server  k8s-master03  192.168.1.33:6443 check
EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-85">5.2.3Master01配置keepalived master节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    # 注意网卡名
    interface ens160 
    mcast_src_ip 192.168.1.31
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<h4 data-id="heading-86">5.2.4Master02配置keepalived backup节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface ens160
    mcast_src_ip 192.168.1.32
    virtual_router_id 51
    priority 80
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<h4 data-id="heading-87">5.2.5Master03配置keepalived backup节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface ens160
    mcast_src_ip 192.168.1.33
    virtual_router_id 51
    priority 50
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-88">5.2.6健康检查脚本配置（lb主机）</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt;  /etc/keepalived/check_apiserver.sh &lt;&lt; EOF
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>

err=0
for k in \$(seq 1 3)
do
    check_code=\$(pgrep haproxy)
    if [[ \$check_code == "" ]]; then
        err=\$(expr \$err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ \$err != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">给脚本授权</span>

chmod +x /etc/keepalived/check_apiserver.sh
</code></pre>
<h4 data-id="heading-89">5.2.7启动服务</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now haproxy.service
systemctl enable --now keepalived.service
systemctl status haproxy.service
systemctl status keepalived.service
</code></pre>
<h4 data-id="heading-90">5.2.8测试高可用</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">能ping同</span>
[root@k8s-node02 ~]# ping 192.168.1.36
<span class="hljs-meta prompt_">
# </span><span class="bash">能telnet访问</span>
[root@k8s-node02 ~]# telnet 192.168.1.36 9443
<span class="hljs-meta prompt_">
# </span><span class="bash">关闭主节点，看vip是否漂移到备节点</span>
</code></pre>
<h2 data-id="heading-91">6.k8s组件配置</h2>
<p>所有k8s节点创建以下目录</p>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre>
<h3 data-id="heading-92">6.1.创建apiserver（所有master节点）</h3>
<h4 data-id="heading-93">6.1.1master01节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.31 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true
Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-94">6.1.2master02节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.32 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-95">6.1.3master03节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service  &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.33 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-96">6.1.4启动apiserver（所有master节点）</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-apiserver.service
systemctl restart kube-apiserver.service
systemctl status kube-apiserver.service
</code></pre>
<h3 data-id="heading-97">6.2.配置kube-controller-manager service</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">所有master节点配置，且配置相同</span>
<span class="hljs-meta prompt_"># </span><span class="bash">172.16.0.0/12为pod网段，按需求设置你自己的网段</span>

cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
      --leader-elect=true \\
      --use-service-account-credentials=true \\
      --node-monitor-grace-period=40s \\
      --node-monitor-period=5s \\
      --controllers=*,bootstrapsigner,tokencleaner \\
      --allocate-node-cidrs=true \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\
      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\
      --node-cidr-mask-size-ipv4=24 \\
      --node-cidr-mask-size-ipv6=120 \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">


# </span><span class="bash">关闭IPv6</span> 
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --service-cluster-ip-range 中的IPv6地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --cluster-cidr 中的IPv6地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --node-cidr-mask-size-ipv6=120</span>
cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
      --leader-elect=true \\
      --use-service-account-credentials=true \\
      --node-monitor-grace-period=40s \\
      --node-monitor-period=5s \\
      --controllers=*,bootstrapsigner,tokencleaner \\
      --allocate-node-cidrs=true \\
      --service-cluster-ip-range=10.96.0.0/12 \\
      --cluster-cidr=172.16.0.0/12 \\
      --node-cidr-mask-size-ipv4=24 \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-98">6.2.1启动kube-controller-manager，并查看状态</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-controller-manager.service
systemctl restart kube-controller-manager.service
systemctl status kube-controller-manager.service
</code></pre>
<h3 data-id="heading-99">6.3.配置kube-scheduler service</h3>
<h4 data-id="heading-100">6.3.1所有master节点配置，且配置相同</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --leader-elect=true \\
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-101">6.3.2启动并查看服务状态</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-scheduler.service
systemctl restart kube-scheduler.service
systemctl status kube-scheduler.service
</code></pre>
<h2 data-id="heading-102">7.TLS Bootstrapping配置</h2>
<h3 data-id="heading-103">7.1在master01上配置</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
--certificate-authority=/etc/kubernetes/pki/ca.pem     \
--embed-certs=true     --server=https://127.0.0.1:8443     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">可以使用这个命令进行创建token也可以使用我的</span>
echo "$(head -c 6 /dev/urandom | md5sum | head -c 6)"."$(head -c 16 /dev/urandom | md5sum | head -c 16)"

kubectl config set-credentials tls-bootstrap-token-user     \
--token=c8ad9c.2e4d610cf3e7426e \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-context tls-bootstrap-token-user@kubernetes     \
--cluster=kubernetes     \
--user=tls-bootstrap-token-user     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config use-context tls-bootstrap-token-user@kubernetes     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span>
mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre>
<h3 data-id="heading-104">7.2查看集群状态，没问题的话继续后续操作</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1.28 版本只能查看到一个etcd 属于正常现象</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> ETCDCTL_API=3</span>
<span class="hljs-meta prompt_"># </span><span class="bash">etcdctl --endpoints=<span class="hljs-string">"192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379"</span> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span>

kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE   ERROR
scheduler            Healthy   ok        
controller-manager   Healthy   ok        
etcd-0               Healthy   ok 
<span class="hljs-meta prompt_">
# </span><span class="bash">写入bootstrap-token</span>
cat &gt; bootstrap.secret.yaml &lt;&lt; EOF
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubelet '."
  token-id: c8ad9c
  token-secret: 2e4d610cf3e7426e
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubelet-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-bootstrapper
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-certificate-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: ""
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">切记执行，别忘记！！！</span>
kubectl create -f bootstrap.secret.yaml
</code></pre>
<h2 data-id="heading-105">8.node节点配置</h2>
<h3 data-id="heading-106">8.1.在master01上将证书复制到node节点</h3>
<pre><code class="hljs language-shell" lang="shell">cd /etc/kubernetes/

for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/${FILE}; done; done
</code></pre>
<h3 data-id="heading-107">8.2.kubelet配置</h3>
<p><strong>注意 ： 8.2.1 和 8.2.2 需要和 上方 2.1 和 2.2 对应起来</strong></p>
<h4 data-id="heading-108">8.2.1当使用docker作为Runtime</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\
    --node-labels=node.kubernetes.io/node= 


[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">IPv6示例</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若不使用IPv6那么忽略此项即可</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下方 --node-ip 更换为每个节点的IP即可</span>
**cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\
    --node-labels=node.kubernetes.io/node=   \\
    --node-ip=192.168.1.31,fc00::31
[Install]
WantedBy=multi-user.target
EOF**
</code></pre>
<h4 data-id="heading-109">8.2.2当使用Containerd作为Runtime</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
<span class="hljs-meta prompt_">
# </span><span class="bash">所有k8s节点配置kubelet service</span>
cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
    --node-labels=node.kubernetes.io/node=

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">IPv6示例</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若不使用IPv6那么忽略此项即可</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下方 --node-ip 更换为每个节点的IP即可</span>
cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
    --node-labels=node.kubernetes.io/node=  \\
    --node-ip=192.168.1.31,fc00::31
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-110">8.2.3所有k8s节点创建kubelet的配置文件</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
EOF
</code></pre>
<h4 data-id="heading-111">8.2.4启动kubelet</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kubelet.service
systemctl restart kubelet.service
systemctl status kubelet.service
</code></pre>
<h4 data-id="heading-112">8.2.5查看集群</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS     ROLES    AGE   VERSION
k8s-master01   NotReady   &lt;none&gt;   15s   v1.35.0
k8s-master02   NotReady   &lt;none&gt;   14s   v1.35.0
k8s-master03   NotReady   &lt;none&gt;   12s   v1.35.0
k8s-node01     NotReady   &lt;none&gt;   11s   v1.35.0
k8s-node02     NotReady   &lt;none&gt;   9s    v1.35.0
[root@k8s-master01 ~]# 

</code></pre>
<h4 data-id="heading-113">8.2.6查看容器运行时</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl describe node | grep Runtime
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
[root@k8s-master01 ~]# kubectl describe node | grep Runtime
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-114">8.3.kube-proxy配置</h3>
<h4 data-id="heading-115">8.3.1将kubeconfig发送至其他节点</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">master-1执行</span>
for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done
</code></pre>
<h4 data-id="heading-116">8.3.2所有k8s节点添加kube-proxy的service文件</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/etc/kubernetes/kube-proxy.yaml \\
  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\
  --v=2
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
<span class="hljs-meta prompt_">

# </span><span class="bash">关闭IPv6</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --cluster-cidr 的IPv6地址</span>
cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/etc/kubernetes/kube-proxy.yaml \\
  --cluster-cidr=172.16.0.0/12 \\
  --v=2
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-117">8.3.3所有k8s节点添加kube-proxy的配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: ""
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/12,fc00:2222::/112
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: ""
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: "rr"
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: "ipvs"
nodePortAddresses: null
oomScoreAdj: -999
portRange: ""
udpIdleTimeout: 250ms
EOF
</code></pre>
<h4 data-id="heading-118">8.3.4启动kube-proxy</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-proxy.service
systemctl restart kube-proxy.service
systemctl status kube-proxy.service
</code></pre>
<h2 data-id="heading-119">9.安装网络插件</h2>
<p><strong>注意 9.1 和 9.2 二选其一即可，建议在此处创建好快照后在进行操作，后续出问题可以回滚</strong></p>
<p>** centos7 要升级libseccomp 不然 无法安装网络插件**</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/opencontainers/runc/releases</span>
<span class="hljs-meta prompt_"># </span><span class="bash">升级runc</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64</span>

install -m 755 runc.amd64 /usr/local/sbin/runc
cp -p /usr/local/sbin/runc  /usr/local/bin/runc
cp -p /usr/local/sbin/runc  /usr/bin/runc
<span class="hljs-meta prompt_">
#</span><span class="bash">查看当前版本</span>
[root@k8s-master-1 ~]# rpm -qa | grep libseccomp
libseccomp-2.5.2-2.el9.x86_64
<span class="hljs-meta prompt_">
#</span><span class="bash">下载高于2.4以上的包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum -y install http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span>
<span class="hljs-meta prompt_"># </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum -y install https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span>
</code></pre>
<h3 data-id="heading-120">9.1安装Calico</h3>
<h4 data-id="heading-121">9.1.1更改calico网段</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">安装operator</span>
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.31.2/manifests/tigera-operator.yaml
<span class="hljs-meta prompt_">

# </span><span class="bash">下载配置文件</span>
curl https://raw.githubusercontent.com/projectcalico/calico/v3.31.2/manifests/custom-resources.yaml -O

<span class="hljs-meta prompt_">


# </span><span class="bash">修改地址池</span>
vim custom-resources.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
    - name: default-ipv4-ippool
      blockSize: 26
      cidr: 172.16.0.0/12
      encapsulation: VXLANCrossSubnet
      natOutgoing: Enabled
      nodeSelector: all()

<span class="hljs-meta prompt_">


# </span><span class="bash">修改地址池</span>
vim custom-resources.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
    - name: ipv4-ippool
      cidr: 172.16.0.0/12
      blockSize: 26
      encapsulation: IPIP
      natOutgoing: Enabled
      nodeSelector: all()
    - name: ipv6-ippool
      cidr: "fd00:100::/64"
      blockSize: 122
      encapsulation: None
      natOutgoing: Enabled
      nodeSelector: all()
    nodeAddressAutodetectionV4:
      interface: "eth.*|en.*"
    nodeAddressAutodetectionV6:
      interface: "eth.*|en.*"
<span class="hljs-meta prompt_">
# </span><span class="bash">执行安装</span>
kubectl create -f custom-resources.yaml
<span class="hljs-meta prompt_">


# </span><span class="bash">安装客户端</span>
curl -L https://github.com/projectcalico/calico/releases/download/v3.30.3/calicoctl-linux-amd64 -o calicoctl
<span class="hljs-meta prompt_">

# </span><span class="bash">给客户端添加执行权限</span>
chmod +x ./calicoctl
<span class="hljs-meta prompt_">

# </span><span class="bash">查看集群节点</span>
./calicoctl get nodes --allow-version-mismatch
<span class="hljs-meta prompt_"># </span><span class="bash">查看集群节点状态</span>
./calicoctl node status --allow-version-mismatch
<span class="hljs-meta prompt_">#</span><span class="bash">查看地址池</span>
./calicoctl get ipPool --allow-version-mismatch
./calicoctl get ipPool --allow-version-mismatch -o yaml


</code></pre>
<h4 data-id="heading-122">9.1.2查看容器状态</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span>
[root@k8s-master01 kubernetes-v1.35.0]# kubectl get pod -A
NAMESPACE         NAME                                       READY   STATUS    RESTARTS   AGE
calico-system     calico-apiserver-8944cd746-8cf9n           1/1     Running   0          3m17s
calico-system     calico-apiserver-8944cd746-kdvx4           1/1     Running   0          3m17s
calico-system     calico-kube-controllers-757dc6b956-bpx2m   1/1     Running   0          3m16s
calico-system     calico-node-89xvc                          1/1     Running   0          3m16s
calico-system     calico-node-95dgk                          1/1     Running   0          3m16s
calico-system     calico-node-jbm6g                          1/1     Running   0          3m16s
calico-system     calico-node-p5mb2                          1/1     Running   0          3m16s
calico-system     calico-node-t68xn                          1/1     Running   0          3m16s
calico-system     calico-typha-68687d94bd-7pcmq              1/1     Running   0          3m14s
calico-system     calico-typha-68687d94bd-cfclr              1/1     Running   0          3m16s
calico-system     calico-typha-68687d94bd-t62kd              1/1     Running   0          3m14s
calico-system     csi-node-driver-5mwsv                      2/2     Running   0          3m16s
calico-system     csi-node-driver-jtp56                      2/2     Running   0          3m16s
calico-system     csi-node-driver-ncd7q                      2/2     Running   0          3m16s
calico-system     csi-node-driver-nvb6d                      2/2     Running   0          3m16s
calico-system     csi-node-driver-s6dk9                      2/2     Running   0          3m16s
calico-system     goldmane-576ddf78d8-4zkch                  1/1     Running   0          3m17s
calico-system     whisker-58576c6584-nv246                   2/2     Running   0          2m43s
tigera-operator   tigera-operator-5cd7bd49c7-rwb54           1/1     Running   0          3m34s
[root@k8s-master01 kubernetes-v1.35.0]# 


</code></pre>
<h3 data-id="heading-123">9.2 安装cilium</h3>
<h4 data-id="heading-124">9.2.1 安装helm</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># chmod 700 get_helm.sh</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># ./get_helm.sh</span></span>
<span class="hljs-meta prompt_">
# </span><span class="bash">wget https://get.helm.sh/helm-v4.0.4-linux-amd64.tar.gz</span>
tar xvf helm-*-linux-amd64.tar.gz
cp linux-amd64/helm /usr/local/bin/
</code></pre>
<h4 data-id="heading-125">9.2.2 安装cilium</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加源</span>
helm repo add cilium https://helm.cilium.io
<span class="hljs-meta prompt_">
# </span><span class="bash">修改为国内源</span>
helm pull cilium/cilium
tar xvf cilium-*.tgz
cd cilium/
<span class="hljs-meta prompt_">
# </span><span class="bash">sed -i <span class="hljs-string">"s#quay.io/#quay.m.daocloud.io/#g"</span> values.yaml</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm install  cilium ./cilium/ -n kube-system

helm install cilium cilium/cilium --version 1.17.4 -n kube-system
<span class="hljs-meta prompt_">
# </span><span class="bash">启用ipv6</span>
<span class="hljs-meta prompt_"># </span><span class="bash">helm install cilium cilium/cilium -n cilium-system --<span class="hljs-built_in">set</span> ipv6.enabled=<span class="hljs-literal">true</span></span> 
<span class="hljs-meta prompt_">

# </span><span class="bash">启用路由信息和监控插件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">helm install cilium ./cilium/ --namespace kube-system --<span class="hljs-built_in">set</span> ipv6.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.relay.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.ui.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> prometheus.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> operator.prometheus.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.metrics.enabled=<span class="hljs-string">"{dns,drop,tcp,flow,port-distribution,icmp,http}"</span></span> 
</code></pre>
<h4 data-id="heading-126">9.2.3 查看</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get pod -A | grep cil
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   cilium-2tnfb                       1/1     Running   0          60s
kube-system   cilium-5tgcb                       1/1     Running   0          60s
kube-system   cilium-6shf5                       1/1     Running   0          60s
kube-system   cilium-ccbcx                       1/1     Running   0          60s
kube-system   cilium-cppft                       1/1     Running   0          60s
kube-system   cilium-operator-675f685d59-7q27q   1/1     Running   0          60s
kube-system   cilium-operator-675f685d59-kwmqz   1/1     Running   0          60s
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-127">9.2.4 下载专属监控面板</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# wget https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml

[root@k8s-master01 yaml]# sed -i "s#docker.io/#jockerhub.com/#g" monitoring-example.yaml

[root@k8s-master01 yaml]# kubectl  apply -f monitoring-example.yaml
namespace/cilium-monitoring created
serviceaccount/prometheus-k8s created
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/grafana created
service/prometheus created
deployment.apps/grafana created
deployment.apps/prometheus created
[root@k8s-master01 yaml]#
</code></pre>
<h4 data-id="heading-128">9.2.5 修改为NodePort</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# kubectl  edit svc  -n kube-system hubble-ui
service/hubble-ui edited
[root@k8s-master01 yaml]#
[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring grafana
service/grafana edited
[root@k8s-master01 yaml]#
[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring prometheus
service/prometheus edited
[root@k8s-master01 yaml]#

type: NodePort
</code></pre>
<h4 data-id="heading-129">9.2.6 查看端口</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# kubectl get svc -A | grep NodePort
cilium-monitoring   grafana          NodePort    10.111.74.3      &lt;none&gt;        3000:32648/TCP   74s
cilium-monitoring   prometheus       NodePort    10.107.240.124   &lt;none&gt;        9090:30495/TCP   74s
kube-system         hubble-ui        NodePort    10.96.185.26     &lt;none&gt;        80:31568/TCP     99s
</code></pre>
<h4 data-id="heading-130">9.2.7 访问</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">http://192.168.1.31:32648
http://192.168.1.31:30495
http://192.168.1.31:31568
</code></pre>
<h2 data-id="heading-131">10.安装CoreDNS</h2>
<h3 data-id="heading-132">10.1以下步骤只在master01操作</h3>
<h4 data-id="heading-133">10.1.1修改文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载tgz包</span>
helm repo add coredns https://coredns.github.io/helm
helm pull coredns/coredns
tar xvf coredns-*.tgz
cd coredns/
<span class="hljs-meta prompt_">
# </span><span class="bash">修改IP地址</span>
vim values.yaml
cat values.yaml | grep clusterIP:
clusterIP: "10.96.0.10"
<span class="hljs-meta prompt_">
# </span><span class="bash">示例</span>
---
service:
<span class="hljs-meta prompt_"># </span><span class="bash">clusterIP: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">clusterIPs: []</span>
<span class="hljs-meta prompt_"># </span><span class="bash">loadBalancerIP: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">externalIPs: []</span>
<span class="hljs-meta prompt_"># </span><span class="bash">externalTrafficPolicy: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">ipFamilyPolicy: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_">  # </span><span class="bash">The name of the Service</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">If not <span class="hljs-built_in">set</span>, a name is generated using the fullname template</span>
  clusterIP: "10.96.0.10"
  name: ""
  annotations: {}
---
<span class="hljs-meta prompt_">
# </span><span class="bash">修改为国内源</span>
sed -i "s#registry.k8s.io/#k8s.m.daocloud.io/#g" values.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm install  coredns ./coredns/ -n kube-system
</code></pre>
<h2 data-id="heading-134">11.安装Metrics Server</h2>
<h3 data-id="heading-135">11.1以下步骤只在master01操作</h3>
<h4 data-id="heading-136">11.1.1安装Metrics-server</h4>
<p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载</span> 
wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml 
<span class="hljs-meta prompt_">
# </span><span class="bash">修改配置</span>
vim metrics-server.yaml 

---
<span class="hljs-meta prompt_"># </span><span class="bash">1</span>
    - args:
        - --cert-dir=/tmp
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls
        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem
        - --requestheader-username-headers=X-Remote-User
        - --requestheader-group-headers=X-Remote-Group
        - --requestheader-extra-headers-prefix=X-Remote-Extra-
<span class="hljs-meta prompt_">
# </span><span class="bash">2</span>
        volumeMounts:
        - mountPath: /tmp
          name: tmp-dir
        - name: ca-ssl
          mountPath: /etc/kubernetes/pki
<span class="hljs-meta prompt_">
# </span><span class="bash">3</span>
      volumes:
      - emptyDir: {}
        name: tmp-dir
      - name: ca-ssl
        hostPath:
          path: /etc/kubernetes/pki
---
<span class="hljs-meta prompt_">

# </span><span class="bash">修改为国内源 docker源可选</span>
sed -i "s#registry.k8s.io/#k8s.m.daocloud.io/#g" metrics-server.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">执行部署</span>
kubectl apply -f metrics-server.yaml 
</code></pre>
<h4 data-id="heading-137">11.1.2稍等片刻查看状态</h4>
<pre><code class="hljs language-shell" lang="shell">kubectl  top node
NAME           CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)   
k8s-master01   182m         2%       2059Mi          58%         
k8s-master02   104m         1%       1577Mi          44%         
k8s-master03   113m         1%       1516Mi          42%         
k8s-node01     53m          0%       915Mi           25%         
k8s-node02     66m          0%       930Mi           26%         
</code></pre>
<h2 data-id="heading-138">12.集群验证</h2>
<h3 data-id="heading-139">12.1部署pod资源</h3>
<pre><code class="hljs language-shell" lang="shell">cat&lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: docker.m.daocloud.io/library/busybox:1.28
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">查看</span>
kubectl  get pod
NAME      READY   STATUS    RESTARTS   AGE
busybox   1/1     Running   0          17s
</code></pre>
<h3 data-id="heading-140">12.2用pod解析默认命名空间中的kubernetes</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看name</span>
kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17h
<span class="hljs-meta prompt_">
# </span><span class="bash">进行解析</span>
kubectl exec  busybox -n default -- nslookup kubernetes
3Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</code></pre>
<h3 data-id="heading-141">12.3测试跨命名空间是否可以解析</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看有那些name</span>
kubectl  get svc -A
NAMESPACE     NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
default       kubernetes        ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         76m
kube-system   calico-typha      ClusterIP   10.105.100.82   &lt;none&gt;        5473/TCP        35m
kube-system   coredns-coredns   ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   8m14s
kube-system   metrics-server    ClusterIP   10.105.60.31    &lt;none&gt;        443/TCP         109s
<span class="hljs-meta prompt_">
# </span><span class="bash">进行解析</span>
kubectl exec  busybox -n default -- nslookup coredns.kube-system
Server:    10.96.0.10
Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local

Name:      coredns-coredns.kube-system
Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local
[root@k8s-master01 metrics-server]# 
</code></pre>
<h3 data-id="heading-142">12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h3>
<pre><code class="hljs language-shell" lang="shell">telnet 10.96.0.1 443
Trying 10.96.0.1...
Connected to 10.96.0.1.
Escape character is '^]'.

telnet 10.96.0.10 53
Trying 10.96.0.10...
Connected to 10.96.0.10.
Escape character is '^]'.

curl 10.96.0.10:53
curl: (52) Empty reply from server
</code></pre>
<h3 data-id="heading-143">12.5Pod和Pod之前要能通</h3>
<pre><code class="hljs language-shell" lang="shell">kubectl get po -owide
NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
busybox   1/1     Running   0          17m   172.27.14.193   k8s-node02   &lt;none&gt;           &lt;none&gt;

kubectl get po -n kube-system -owide
NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-76754ff848-pw4xg   1/1     Running   0          38m     172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;
calico-node-97m55                          1/1     Running   0          38m     192.168.1.34     k8s-node01     &lt;none&gt;           &lt;none&gt;
calico-node-hlz7j                          1/1     Running   0          38m     192.168.1.32     k8s-master02   &lt;none&gt;           &lt;none&gt;
calico-node-jtlck                          1/1     Running   0          38m     192.168.1.33     k8s-master03   &lt;none&gt;           &lt;none&gt;
calico-node-lxfkf                          1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;
calico-node-t667x                          1/1     Running   0          38m     192.168.1.31     k8s-master01   &lt;none&gt;           &lt;none&gt;
calico-typha-59d75c5dd4-gbhfp              1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;
coredns-coredns-c5c6d4d9b-bd829            1/1     Running   0          10m     172.25.92.65     k8s-master02   &lt;none&gt;           &lt;none&gt;
metrics-server-7c8b55c754-w7q8v            1/1     Running   0          3m56s   172.17.125.3     k8s-node01     &lt;none&gt;           &lt;none&gt;
<span class="hljs-meta prompt_">
# </span><span class="bash">进入busybox ping其他节点上的pod</span>

kubectl exec -ti busybox -- sh
/ # ping 192.168.1.34
PING 192.168.1.34 (192.168.1.34): 56 data bytes
64 bytes from 192.168.1.34: seq=0 ttl=63 time=0.358 ms
64 bytes from 192.168.1.34: seq=1 ttl=63 time=0.668 ms
64 bytes from 192.168.1.34: seq=2 ttl=63 time=0.637 ms
64 bytes from 192.168.1.34: seq=3 ttl=63 time=0.624 ms
64 bytes from 192.168.1.34: seq=4 ttl=63 time=0.907 ms
<span class="hljs-meta prompt_">
# </span><span class="bash">可以连通证明这个pod是可以跨命名空间和跨主机通信的</span>
</code></pre>
<h3 data-id="heading-144">12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h3>
<pre><code class="hljs language-shell" lang="shell">cat&lt;&lt;EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
EOF

kubectl  get pod 
NAME                               READY   STATUS    RESTARTS   AGE
busybox                            1/1     Running   0          6m25s
nginx-deployment-9456bbbf9-4bmvk   1/1     Running   0          8s
nginx-deployment-9456bbbf9-9rcdk   1/1     Running   0          8s
nginx-deployment-9456bbbf9-dqv8s   1/1     Running   0          8s
<span class="hljs-meta prompt_">
# </span><span class="bash">删除nginx</span>
[root@k8s-master01 ~]# kubectl delete deployments nginx-deployment 
</code></pre>
<h2 data-id="heading-145">13.安装dashboard</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加源信息</span>
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
<span class="hljs-meta prompt_">

# </span><span class="bash">修改为国内源</span>
helm pull kubernetes-dashboard/kubernetes-dashboard
tar xvf kubernetes-dashboard-*.tgz
cd kubernetes-dashboard
sed -i "s#docker.io/#jockerhub.com/#g" values.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm upgrade --install kubernetes-dashboard ./kubernetes-dashboard/  --create-namespace --namespace kube-system
<span class="hljs-meta prompt_">

# </span><span class="bash">我的集群使用默认参数安装 kubernetes-dashboard-kong 出现异常 8444 端口占用</span>
<span class="hljs-meta prompt_"># </span><span class="bash">使用下面的命令进行安装，在安装时关闭kong.tls功能</span>
helm upgrade --install kubernetes-dashboard ./kubernetes-dashboard/ --namespace kube-system --set kong.admin.tls.enabled=false
</code></pre>
<h3 data-id="heading-146">13.1更改dashboard的svc为NodePort，如果已是请忽略</h3>
<pre><code class="hljs language-shell" lang="shell">kubectl edit svc  -n kube-system kubernetes-dashboard-kong-proxy
  type: NodePort
</code></pre>
<h3 data-id="heading-147">13.2查看端口号</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl get svc kubernetes-dashboard-kong-proxy -n kube-system
NAME                              TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard-kong-proxy   NodePort   10.100.9.217   &lt;none&gt;        443:31330/TCP   42s
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-148">13.3创建token</h3>
<pre><code class="hljs language-shell" lang="shell">cat &gt; dashboard-user.yaml &lt;&lt; EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
EOF

kubectl  apply -f dashboard-user.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">创建token</span>
kubectl -n kube-system create token admin-user
eyJhbGciOiJSUzI1NiIsImtpZCI6ImtxelI3UzBZOFl5MGtWU1k0c2QyUVRaOXhQeEFNYTNHWlNyRUFucHBIVGMifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY2MTUzNDIwLCJpYXQiOjE3NjYxNDk4MjAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiN2E1NWM3MDEtODc5ZC00YjBmLTg2YTMtNWVmMDBjZjE0NGI0Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZTc5ODAyMzYtNTUyOC00NjRjLWFlOTctMWVmNDJiMWY3ODhhIn19LCJuYmYiOjE3NjYxNDk4MjAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.oDH1uZAWnxeq7gun0ej0ihbSJa6YYZwXcDt9O_tHQsWRi9Lr4kcusG0sm6UntEAy7fHLf6UWLTNHtv-V2lvDjUxRM46xQUzDOQ2v5hBI9NnpcRXQRvMvwn0s6wFeGNr2aFZ9i9aeSJZTdqHOlBjrqxsJtYD6fqDGtJYGdbvUA50nvXPN25a9ofgKvEtWjMA50ojGCr3yqF3vrWruEV77suFeYyIye5YXMnJw_I7Cp3zSEwrAuqfyVAlRv8mYQKxZJsNyban2-wcV10V5qzkofSL4DkgBaqqTDh1aOeD2NJrjmLKPQUt8meLohYy5tMGoyZgx0NGzr-9R71KF8tFHoA
</code></pre>
<h3 data-id="heading-149">13.4创建长期token</h3>
<pre><code class="hljs language-shell" lang="shell">cat &gt; dashboard-user-token.yaml &lt;&lt; EOF
apiVersion: v1
kind: Secret
metadata:
  name: admin-user
  namespace: kube-system
  annotations:
    kubernetes.io/service-account.name: "admin-user"   
type: kubernetes.io/service-account-token  
EOF

kubectl  apply -f dashboard-user-token.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">查看密码</span>
kubectl get secret admin-user -n kube-system -o jsonpath={".data.token"} | base64 -d

eyJhbGciOiJSUzI1NiIsImtpZCI6ImtxelI3UzBZOFl5MGtWU1k0c2QyUVRaOXhQeEFNYTNHWlNyRUFucHBIVGMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlNzk4MDIzNi01NTI4LTQ2NGMtYWU5Ny0xZWY0MmIxZjc4OGEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.etS6ehzcPjtdipt4zm3L2FJpcbYFlJGLGXmrd8dLMGDw2xVU5XQgZM2gMrHa_rrJPnRKcksaG7qNpasM574D7__CpcktduTM_EsUiOc5i7u9lHDMxsPczyiFxlOp7d8jOdNbqwnlEPA5iYWJ6P3Cj3LiDfFKKHQChKgv8mS588Eh-nnYiMsblWltqvPd_DOJ9JxJ4G4T25yWsbEgpH3uZmXUAyVUDNgDFLNIKRPQXLg5d07rlmgHjJInvEsnrrCs8dxp173iNW8LYxnDNy7pwjrXbvniYiRXjltAwc6F68G590hQaogy9AEVUskeTgBvONPJwkZRHbf0beOL30pT0w
</code></pre>
<h3 data-id="heading-150">13.5登录dashboard</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2F192.168.1.31%3A31268%2F" target="_blank" title="https://192.168.1.31:31268/" ref="nofollow noopener noreferrer">https://192.168.1.31:31268/</a></p>
<h2 data-id="heading-151">14.部署metallb</h2>
<h3 data-id="heading-152">14.1 下载部署</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载应用包</span>
wget https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">修改镜像地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">自行找代理</span>
sed -i "s#quay.io#quay.chenby.cn#g" metallb-native.yaml 
cat metallb-native.yaml | grep image
        image: quay.chenby.cn/metallb/controller:v0.14.5
        image: quay.chenby.cn/metallb/speaker:v0.14.5
        
<span class="hljs-meta prompt_"># </span><span class="bash">执行部署</span>
kubectl apply -f metallb-native.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">可以连接国际网络</span>
<span class="hljs-meta prompt_"># </span><span class="bash">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml</span>
</code></pre>
<h3 data-id="heading-153">14.2 查看运行情况</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 kubernetes-v1.35.0]# kubectl -n metallb-system get all 
NAME                              READY   STATUS              RESTARTS   AGE
pod/controller-59f49888d7-chwst   1/1     Running             0          54s
pod/speaker-4nkv6                 0/1     Running             0          54s
pod/speaker-dzfzs                 0/1     ErrImagePull        0          53s
pod/speaker-fmwgn                 0/1     ContainerCreating   0          53s
pod/speaker-jch8z                 0/1     Running             0          53s
pod/speaker-pplvk                 0/1     Running             0          53s

NAME                              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/metallb-webhook-service   ClusterIP   10.100.70.55   &lt;none&gt;        443/TCP   54s

NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/speaker   5         5         0       5            0           kubernetes.io/os=linux   54s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/controller   1/1     1            1           54s

NAME                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/controller-59f49888d7   1         1         1       54s
[root@k8s-master01 kubernetes-v1.35.0]# 


</code></pre>
<h3 data-id="heading-154">14.3 配置VIP的资源池</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">新版本metallb使用了CR（Custom Resources），这里我们通过IPAddressPool的CR，进行地址池的定义。</span>
<span class="hljs-meta prompt_"># </span><span class="bash">如果实例中不设置IPAddressPool选择器L2Advertisement；那么L2Advertisement默认为该实例所有的IPAddressPool相关联。</span>

cat &gt; metallb-config-ipaddresspool.yaml &lt;&lt; EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.1.71-192.168.1.75
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">进行L2关联地址池的绑定。</span>

cat &gt; metallb-config-L2Advertisement.yaml &lt;&lt; EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">执行部署</span>
kubectl apply -f metallb-config-ipaddresspool.yaml
kubectl apply -f metallb-config-L2Advertisement.yaml
</code></pre>
<h2 data-id="heading-155">15.ingress安装</h2>
<h3 data-id="heading-156">15.1执行部署</h3>
<p>字数限制，详见完整版 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<p><strong>关于</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2F" target="_blank" title="https://www.oiox.cn/" ref="nofollow noopener noreferrer">www.oiox.cn/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2Findex.php%2Fstart-page.html" target="_blank" title="https://www.oiox.cn/index.php/start-page.html" ref="nofollow noopener noreferrer">www.oiox.cn/index.php/s…</a></p>
<p><strong>CSDN、GitHub、知乎、开源中国、思否、掘金、简书、华为云、阿里云、腾讯云、哔哩哔哩、今日头条、新浪微博、个人博客</strong></p>
<p><strong>全网可搜《小陈运维》</strong></p>
<p><strong>文章主要发布于微信公众号：《Linux运维交流社区》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux系统调用实现原理（基于ARM 64, kernel-6.6）]]></title>    <link>https://juejin.cn/post/7585390679397810182</link>    <guid>https://juejin.cn/post/7585390679397810182</guid>    <pubDate>2025-12-19T12:30:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679397810182" data-draft-id="7585382553289359396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux系统调用实现原理（基于ARM 64, kernel-6.6）"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2025-12-19T12:30:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子非愚"/> <meta itemprop="url" content="https://juejin.cn/user/538088404426650"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux系统调用实现原理（基于ARM 64, kernel-6.6）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/538088404426650/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子非愚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:30:10.000Z" title="Fri Dec 19 2025 12:30:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用户态发起系统调用</h2>
<p>当用户态代码调用系统调用时，将会触发一次异常，从而进入内核态。ARM64提供了汇编指令svc，实现该功能。其中x8寄存器存储了系统调用号，参数一般存在x0寄存器到x5寄存器。</p>
<p>以下案例是绕过libc，直接通过内联方法调用系统调用的案例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 手动调用 write 系统调用（ARM64）</span>
    <span class="hljs-comment">// 参数：x0=1(STDOUT), x1=字符串地址, x2=长度, x8=64(write 系统调用号)</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg = <span class="hljs-string">"Raw Syscall: Hello ARM64\n"</span>;
    <span class="hljs-type">int</span> len = <span class="hljs-number">21</span>;  <span class="hljs-comment">// 字符串长度</span>
    
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(
        <span class="hljs-string">"mov x8, #64\n"</span>    <span class="hljs-comment">// x8 = write 系统调用号（64）</span>
        <span class="hljs-string">"svc #0\n"</span>         <span class="hljs-comment">// 触发系统调用（ARM64 核心指令）</span>
        :                   <span class="hljs-comment">// 输出寄存器（无）</span>
        : <span class="hljs-string">"r"</span>(<span class="hljs-number">1</span>), <span class="hljs-string">"r"</span>(msg), <span class="hljs-string">"r"</span>(len)  <span class="hljs-comment">// 输入寄存器：x0=1, x1=msg, x2=len</span>
        : <span class="hljs-string">"x8"</span>, <span class="hljs-string">"memory"</span>    <span class="hljs-comment">// 告诉编译器：x8 和内存会被修改，避免优化</span>
    )</span></span>;

    <span class="hljs-comment">// 手动调用 exit 系统调用（x8=93, x0=0）</span>
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(
        <span class="hljs-string">"mov x8, #93\n"</span>    <span class="hljs-comment">// x8 = exit 系统调用号（93）</span>
        <span class="hljs-string">"svc #0\n"</span>
        :
        : <span class="hljs-string">"r"</span>(<span class="hljs-number">0</span>)           <span class="hljs-comment">// x0=0（退出码）</span>
        : <span class="hljs-string">"x8"</span>
    )</span></span>;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译出中间汇编代码</p>
<pre><code class="hljs language-arduino" lang="arduino">aarch64-linux-gnu-gcc -S -O0 -fverbose-<span class="hljs-keyword">asm</span> -ffreestanding -nostdlib -o test.s test.c
</code></pre>
<p>编译出最后可执行文件</p>
<pre><code class="hljs language-csharp" lang="csharp">aarch64-linux-gnu-gcc -<span class="hljs-keyword">static</span> -ffreestanding -nostdlib -e main -o test.<span class="hljs-keyword">out</span> test.c
</code></pre>
<h2 data-id="heading-1">内核执行系统调用</h2>
<p>kernel会在内核态实现该异常处理。</p>
<h3 data-id="heading-2">el0t_64_sync</h3>
<p>kernel的用户态入口实现一般在 <em>arch/arm64/kernel/entry.S</em></p>
<pre><code class="hljs language-ini" lang="ini">entry_handler	0, t, 64, sync  <span class="hljs-comment">; 启用 EL0 64位 同步异常（如SVC/Abort/Trap）处理入口</span>
entry_handler	0, t, 64, irq   <span class="hljs-comment">; 启用 EL0 64位 普通中断（IRQ）处理入口</span>
entry_handler	0, t, 64, fiq   <span class="hljs-comment">; 启用 EL0 64位 快速中断（FIQ）处理入口</span>
entry_handler	0, t, 64, error <span class="hljs-comment">; 启用 EL0 64位 系统错误（SError）处理入口</span>
</code></pre>
<p>其中entry_handler为汇编中的宏，具体定义如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">; el:req, ht:req, regsize:req, label:req 代表<span class="hljs-number">4</span>个参数
; el\el\ht\()_\regsize\()_\label 拼接出字符串，比如el0t_64_sync
	.macro entry_handler el:req, ht:req, regsize:req, label:<span class="hljs-function">req
<span class="hljs-title">SYM_CODE_START_LOCAL</span>(<span class="hljs-params">el\el\ht\(</span>)_\regsize\()_\label)
	kernel_entry \el, \regsize
	mov	x0, sp
	bl	el\el\ht\()_\regsize\()_\label\()_handler
	.<span class="hljs-keyword">if</span> \el</span> == <span class="hljs-number">0</span>
	b	ret_to_user
	.<span class="hljs-keyword">else</span>
	b	ret_to_kernel
	.<span class="hljs-function">endif
<span class="hljs-title">SYM_CODE_END</span>(<span class="hljs-params">el\el\ht\(</span>)_\regsize\()_\label)
	.endm
</span></code></pre>
<p><strong>&lt;include/linux/linkage.h&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* SYM_L_* -- linkage of symbols */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_GLOBAL(name)			.globl name</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_WEAK(name)			.weak name</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_LOCAL(name)			<span class="hljs-comment">/* nothing */</span></span>

<span class="hljs-comment">/* SYM_A_* -- align the symbol? */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_A_ALIGN				ALIGN</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_A_NONE				<span class="hljs-comment">/* nothing */</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_CODE_START_LOCAL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_CODE_START_LOCAL(name)			\
	SYM_START(name, SYM_L_LOCAL, SYM_A_ALIGN)</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// ASM_NL 汇编换行符</span>
<span class="hljs-comment">// 此处生成参数name的段</span>

<span class="hljs-comment">/* SYM_ENTRY -- use only if you have to for non-paired symbols */</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_ENTRY</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_ENTRY(name, linkage, align...)		\
	linkage(name) ASM_NL				\
	align ASM_NL					\
	name:</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">/* SYM_START -- use only if you have to */</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_START</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_START(name, linkage, align...)		\
	SYM_ENTRY(name, linkage, align)</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<p>所以会在entry.s中生成el0t_64_sync函数段，该函数非常简单，先执行el0t_64_sync_handler，最后调用ret_to_user返回用户态。</p>
<h3 data-id="heading-3">el0t_64_sync_handler</h3>
<p><strong>&lt;arch/arm64/kernel/entry-common.c&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">asmlinkage <span class="hljs-type">void</span> noinstr <span class="hljs-title">el0t_64_sync_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pt_regs *regs)</span>
</span>{
	<span class="hljs-comment">// 从esr寄存器读取陷入异常的原因</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esr = <span class="hljs-built_in">read_sysreg</span>(esr_el1);

	<span class="hljs-keyword">switch</span> (<span class="hljs-built_in">ESR_ELx_EC</span>(esr)) {
	<span class="hljs-keyword">case</span> ESR_ELx_EC_SVC64: <span class="hljs-comment">// 64 位用户态 SVC 系统调用</span>
		<span class="hljs-built_in">el0_svc</span>(regs);
		<span class="hljs-keyword">break</span>;
	<span class="hljs-keyword">case</span> ESR_ELx_EC_DABT_LOW:
		<span class="hljs-built_in">el0_da</span>(regs, esr);
	...
}
</code></pre>
<p>el0_svc -&gt; do_el0_svc -&gt; el0_svc_common(arch/arm64/kernel/syscall.c文件中) -&gt; invoke_syscall</p>
<h3 data-id="heading-4">invoke_syscall</h3>
<p><strong>&lt;arch/arm64/kernel/syscall.c&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">do_el0_svc</span>(struct pt_regs *regs)
{
	<span class="hljs-comment">// sys_call_table 系统调用表</span>
	<span class="hljs-comment">// regs-&gt;regs[8]中获取到系统调用号</span>
	<span class="hljs-built_in">el0_svc_common</span>(regs, regs-&gt;regs[<span class="hljs-number">8</span>], __NR_syscalls, sys_call_table);
}

static void <span class="hljs-built_in">el0_svc_common</span>(struct pt_regs *regs, int scno, int sc_nr,
			   const syscall_fn_t syscall_table[])
{
	...
	<span class="hljs-built_in">invoke_syscall</span>(regs, scno, sc_nr, syscall_table);
	...
}

static long <span class="hljs-built_in">__invoke_syscall</span>(struct pt_regs *regs, syscall_fn_t syscall_fn)
{
	return <span class="hljs-built_in">syscall_fn</span>(regs);
}

static void <span class="hljs-built_in">invoke_syscall</span>(struct pt_regs *regs, unsigned int scno,
			   unsigned int sc_nr,
			   const syscall_fn_t syscall_table[])
{
	long ret;

	<span class="hljs-built_in">add_random_kstack_offset</span>();

	if (scno &lt; sc_nr) {
		syscall_fn_t syscall_fn;
		<span class="hljs-comment">// 根据方法号找到系统调用实现</span>
		syscall_fn = syscall_table<span class="hljs-selector-attr">[array_index_nospec(scno, sc_nr)]</span>;
		<span class="hljs-comment">// 调用系统调用实现</span>
		ret = <span class="hljs-built_in">__invoke_syscall</span>(regs, syscall_fn);
	} else {
		ret = <span class="hljs-built_in">do_ni_syscall</span>(regs, scno);
	}

	<span class="hljs-built_in">syscall_set_return_value</span>(current, regs, <span class="hljs-number">0</span>, ret);

	<span class="hljs-comment">/*
	 * This value will get limited by KSTACK_OFFSET_MAX(), which is 10
	 * bits. The actual entropy will be further reduced by the compiler
	 * when applying stack alignment constraints: the AAPCS mandates a
	 * 16-byte aligned SP at function boundaries, which will remove the
	 * 4 low bits from any entropy chosen here.
	 *
	 * The resulting 6 bits of entropy is seen in SP[9:4].
	 */</span>
	<span class="hljs-built_in">choose_random_kstack_offset</span>(get_random_u16());
}
</code></pre>
<h2 data-id="heading-5">内核实现系统调用</h2>
<h3 data-id="heading-6">系统调用表</h3>
<pre><code class="hljs language-arduino" lang="arduino">...

<span class="hljs-comment">/*
 * Wrappers to pass the pt_regs argument.
 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __arm64_sys_personality		__arm64_sys_arm64_personality</span>

<span class="hljs-comment">// 通过宏声明系统调用的实现函数</span>
<span class="hljs-comment">// 拼接的函数名，比如 __arm64_mmap</span>
<span class="hljs-meta">#<span class="hljs-keyword">undef</span> __SYSCALL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __SYSCALL(nr, sym)	asmlinkage long __arm64_##sym(const struct pt_regs *);</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span>

<span class="hljs-comment">// 定义嵌套宏</span>
<span class="hljs-meta">#<span class="hljs-keyword">undef</span> __SYSCALL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __SYSCALL(nr, sym)	[nr] = __arm64_##sym,</span>

<span class="hljs-comment">// 通过宏生成系统调用表</span>
<span class="hljs-type">const</span> <span class="hljs-type">syscall_fn_t</span> sys_call_table[__NR_syscalls] = {
	[<span class="hljs-number">0</span> ... __NR_syscalls - <span class="hljs-number">1</span>] = __arm64_sys_ni_syscall,
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span>
};
</code></pre>
<p>unistd.h头文件嵌套：
arch/arm64/include/asm/unistd.h -&gt; arch/arm64/include/uapi/asm/unistd.h -&gt; include/uapi/asm-generic/unistd.h<br/>
<strong>&lt;include/uapi/asm-generic/unistd.h&gt;</strong> 中罗列了系统调用列表。</p>
<pre><code class="hljs language-arduino" lang="arduino">...
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_setxattr 5</span>
__SYSCALL(__NR_setxattr, sys_setxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_lsetxattr 6</span>
__SYSCALL(__NR_lsetxattr, sys_lsetxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsetxattr 7</span>
__SYSCALL(__NR_fsetxattr, sys_fsetxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_getxattr 8</span>
__SYSCALL(__NR_getxattr, sys_getxattr)
...
</code></pre>
<h3 data-id="heading-7">定义系统调用</h3>
<p>系统调用表中的函数，是通过<em>SYSCALL_DEFINE</em>宏定义的。
比如mmap的系统调用实现如下：</p>
<p><strong>&lt;arch/arm64/kernel/sys.c&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/compiler.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/export.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sched.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span>
<span class="hljs-comment">// 会嵌套调用 #include &lt;asm/syscall_wrapper.h&gt;</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/syscalls.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/cpufeature.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/syscall.h&gt;</span></span>

...

<span class="hljs-built_in">SYSCALL_DEFINE6</span>(mmap, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, len,
		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, prot, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, flags,
		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, off)
{
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">offset_in_page</span>(off) != <span class="hljs-number">0</span>)
		<span class="hljs-keyword">return</span> -EINVAL;

	<span class="hljs-keyword">return</span> <span class="hljs-built_in">ksys_mmap_pgoff</span>(addr, len, prot, flags, fd, off &gt;&gt; PAGE_SHIFT);
}
</code></pre>
<p><strong>&lt;include/linux/syscalls.h&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/list.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bug.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/siginfo.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/quota.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/key.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/personality.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;trace/syscall.h&gt;</span></span>

<span class="hljs-comment">// 如果打开该宏，引入syscall_wrapper头文件</span>
<span class="hljs-comment">// arm64上使用该头文件的 SYSCALL_DEFINE 宏定义</span>
 
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ARCH_HAS_SYSCALL_WRAPPER</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/syscall_wrapper.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> /</span>
...
</code></pre>
<p><strong>&lt;arch/arm64/include/asm/syscall_wrapper.h&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">__SYSCALL_DEFINEx</span>(x, name, ...)						\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs);		\
	<span class="hljs-built_in">ALLOW_ERROR_INJECTION</span>(__arm64_sys##name, ERRNO);			\
	static long __se_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_LONG,__VA_ARGS__));		\
	static inline long __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_DECL,__VA_ARGS__));	\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs);		\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs)		\
	{									\
		return __se_sys#<span class="hljs-selector-id">#name</span>(SC_ARM64_REGS_TO_ARGS(x,__VA_ARGS__));	\
	}									\
	static long __se_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_LONG,__VA_ARGS__))		\
	{									\
		long ret = __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_CAST,__VA_ARGS__));	\
		<span class="hljs-built_in">__MAP</span>(x,__SC_TEST,__VA_ARGS__);					\
		<span class="hljs-built_in">__PROTECT</span>(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));		\
		return ret;							\
	}									\
	static inline long __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_DECL,__VA_ARGS__))

<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">SYSCALL_DEFINE0</span>(sname)							\
	<span class="hljs-built_in">SYSCALL_METADATA</span>(_##sname, <span class="hljs-number">0</span>);						\
	asmlinkage long __arm64_sys_#<span class="hljs-selector-id">#sname</span>(const struct pt_regs *__unused);	\
	<span class="hljs-built_in">ALLOW_ERROR_INJECTION</span>(__arm64_sys_##sname, ERRNO);			\
	asmlinkage long __arm64_sys_#<span class="hljs-selector-id">#sname</span>(const struct pt_regs *__unused)

<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">SYSCALL_DEFINEx</span>(x, sname, ...)				\
	<span class="hljs-built_in">SYSCALL_METADATA</span>(sname, x, __VA_ARGS__)			\
	<span class="hljs-built_in">__SYSCALL_DEFINEx</span>(x, sname, __VA_ARGS__)
</code></pre>
<p>ARM64上默认开启了<strong>ARCH_HAS_SYSCALL_WRAPPER</strong>宏。</p>
<p><strong>&lt;arch/arm64/Kconfig&gt;</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">config</span> ARM64
	def_bool y
	...
	<span class="hljs-built_in">select</span> ARCH_HAS_SYSCALL_WRAPPER
</code></pre>
<p>所以 <strong>SYSCALL_DEFINE6 mmap</strong> 会定义 <strong>__arm64_sys_mmap</strong> 函数，即为系统调用表中mmap系统调用的实现。</p>
<h2 data-id="heading-8">CPU如何找到异常处理函数</h2>
<p>执行svc指令，为什么会调到el0t_64_sync函数呢？
其实是通过查询启动时设置进ARM规定的寄存器内异常向量表，找到异常处理函数后进行跳转的。</p>
<h3 data-id="heading-9">生成异常向量表</h3>
<p>异常向量表也是通过汇编宏实现的：<br/>
<strong>&lt;arch/arm64/kernel/entry.S&gt;</strong><br/>
<strong>1. 定义汇编宏</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.macro</span> <span class="hljs-selector-tag">kernel_ventry</span>, <span class="hljs-selector-tag">el</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">ht</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">regsize</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">label</span>:<span class="hljs-selector-tag">req</span>
	<span class="hljs-selector-class">.align</span> <span class="hljs-number">7</span>
; 第一步，如果是从<span class="hljs-selector-tag">el0</span>进<span class="hljs-selector-tag">el1</span>，备份和清理<span class="hljs-selector-tag">tpidrro_el0</span>
<span class="hljs-selector-class">.Lventry_start</span>\@:
	<span class="hljs-selector-class">.if</span>	\<span class="hljs-selector-tag">el</span> == <span class="hljs-number">0</span>
	<span class="hljs-comment">/*
	 * This must be the first instruction of the EL0 vector entries. It is
	 * skipped by the trampoline vectors, to trigger the cleanup.
	 */</span>
	<span class="hljs-selector-tag">b</span>	<span class="hljs-selector-class">.Lskip_tramp_vectors_cleanup</span>\@
	<span class="hljs-selector-class">.if</span>	\<span class="hljs-selector-tag">regsize</span> == <span class="hljs-number">64</span>
	<span class="hljs-selector-tag">mrs</span>	<span class="hljs-selector-tag">x30</span>, <span class="hljs-selector-tag">tpidrro_el0</span>
	<span class="hljs-selector-tag">msr</span>	<span class="hljs-selector-tag">tpidrro_el0</span>, <span class="hljs-selector-tag">xzr</span>
	<span class="hljs-selector-class">.else</span>
	<span class="hljs-selector-tag">mov</span>	<span class="hljs-selector-tag">x30</span>, <span class="hljs-selector-tag">xzr</span>
	<span class="hljs-selector-class">.endif</span>
<span class="hljs-selector-class">.Lskip_tramp_vectors_cleanup</span>\@:
	<span class="hljs-selector-class">.endif</span>

; 第二步，在<span class="hljs-selector-tag">stack</span>上构建异常栈帧
	<span class="hljs-selector-tag">sub</span>	<span class="hljs-selector-tag">sp</span>, <span class="hljs-selector-tag">sp</span>, <span class="hljs-selector-id">#PT_REGS_SIZE</span>

; 第三步，跳转到异常处理函数段，比如<span class="hljs-selector-tag">el0t_64_sync</span>
	<span class="hljs-selector-tag">b</span>	<span class="hljs-selector-tag">el</span>\<span class="hljs-selector-tag">el</span>\<span class="hljs-selector-tag">ht</span>\()<span class="hljs-selector-tag">_</span>\<span class="hljs-selector-tag">regsize</span>\()<span class="hljs-selector-tag">_</span>\<span class="hljs-selector-tag">label</span>
<span class="hljs-selector-class">.org</span> <span class="hljs-selector-class">.Lventry_start</span>\@ + <span class="hljs-number">128</span>	<span class="hljs-comment">// Did we overflow the ventry slot?</span>
	<span class="hljs-selector-class">.endm</span>
</code></pre>
<p><strong>2. 拼接构建异常向量表</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">/*
 * Exception vectors.
 */</span>
	.pushsection <span class="hljs-string">".entry.text"</span>, <span class="hljs-string">"ax"</span>

	.align	<span class="hljs-number">11</span>
SYM_CODE_START(vectors)
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error EL1t</span>

	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error EL1h</span>

	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error 64-bit EL0</span>

	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, sync		<span class="hljs-comment">// Synchronous 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, irq		<span class="hljs-comment">// IRQ 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, fiq		<span class="hljs-comment">// FIQ 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error 32-bit EL0</span>
SYM_CODE_END(vectors)
</code></pre>
<p>异常向量表的布局，需要严格遵守ARM的约定：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c57b2ff0e24e4658a0f1d39d58f4361a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q6Z2e5oSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766752210&amp;x-signature=zMwTi8t7v2GSbGMeeaL%2BkXS8Vb0%3D" alt="image.png" loading="lazy"/>
<em><strong>《Learn the architecture - AArch64 Exception Model》</strong></em></p>
<p>中文解释如下：</p>




























































































































<table><thead><tr><th>相对基址偏移</th><th>异常入口类型</th><th>异常等级/模式</th><th>触发场景（举例）</th><th>对应内核代码中的宏</th></tr></thead><tbody><tr><td>0x000</td><td>Synchronous</td><td>EL0 (AArch64)</td><td>用户态系统调用（svc #0）、未定义指令</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x080</td><td>IRQ</td><td>EL0 (AArch64)</td><td>用户态外设中断（如键盘中断）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x100</td><td>FIQ</td><td>EL0 (AArch64)</td><td>用户态快速中断（极少使用）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x180</td><td>Error</td><td>EL0 (AArch64)</td><td>用户态数据访问错误（如非法地址）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x200</td><td>Synchronous</td><td>EL1t (AArch64)</td><td>内核态同步异常（如空指针访问）</td><td><code>kernel_ventry(1,t,64,sync)</code></td></tr><tr><td>0x280</td><td>IRQ</td><td>EL1t (AArch64)</td><td>内核态外设中断（如网卡中断）</td><td><code>kernel_ventry(1,t,64,irq)</code></td></tr><tr><td>0x300</td><td>FIQ</td><td>EL1t (AArch64)</td><td>内核态快速中断（极少使用）</td><td><code>kernel_ventry(1,t,64,fiq)</code></td></tr><tr><td>0x380</td><td>Error</td><td>EL1t (AArch64)</td><td>内核态数据访问错误（如页表错误）</td><td><code>kernel_ventry(1,t,64,error)</code></td></tr><tr><td>0x400</td><td>Synchronous</td><td>EL1h (AArch64)</td><td>虚拟化模式内核同步异常</td><td><code>kernel_ventry(1,h,64,sync)</code></td></tr><tr><td>0x480</td><td>IRQ</td><td>EL1h (AArch64)</td><td>虚拟化模式内核IRQ中断</td><td><code>kernel_ventry(1,h,64,irq)</code></td></tr><tr><td>0x500</td><td>FIQ</td><td>EL1h (AArch64)</td><td>虚拟化模式内核FIQ中断</td><td><code>kernel_ventry(1,h,64,fiq)</code></td></tr><tr><td>0x580</td><td>Error</td><td>EL1h (AArch64)</td><td>虚拟化模式内核错误异常</td><td><code>kernel_ventry(1,h,64,error)</code></td></tr><tr><td>0x600</td><td>Synchronous</td><td>EL0 (AArch32)</td><td>32位用户态系统调用</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x680</td><td>IRQ</td><td>EL0 (AArch32)</td><td>32位用户态IRQ中断</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x700</td><td>FIQ</td><td>EL0 (AArch32)</td><td>32位用户态FIQ中断</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x780</td><td>Error</td><td>EL0 (AArch32)</td><td>32位用户态错误异常</td><td><code>tramp_ventry (EL0,32)</code></td></tr></tbody></table>
<h4 data-id="heading-10">备份清理tpidrro_el0</h4>
<p>tpidrro_el0：ARM64 架构中EL0（用户态）只读的线程局部存储（TLS）寄存器，核心作用是为用户态线程提供 “线程私有数据的快速访问入口”。</p>
<pre><code class="hljs language-ini" lang="ini">.if	\<span class="hljs-attr">regsize</span> == <span class="hljs-number">64</span>
	<span class="hljs-comment">; 将tpidrro_el0备份到x30寄存器</span>
	mrs	x30, tpidrro_el0
	<span class="hljs-comment">; 用零值寄存器xzr清理tpidrro_el0</span>
	msr	tpidrro_el0, xzr
</code></pre>
<p><strong>为什么要保存tpidrro_el0寄存器</strong></p>
<ol>
<li>防止用户态数据泄露到内核态，引起安全性问题</li>
<li>调试等操作可能污染tpidrro_el0寄存器数据</li>
<li>tpidrro_el0寄存器不会自动保存，此处不保存的话，如果切换任务后，tpidrro_el0会被其他用户态进程干扰污染</li>
<li>tpidrro_el0是用户态只读寄存器，因此依赖内核做备份和清理操作</li>
</ol>
<p><strong>为什么使用x30寄存器</strong></p>
<p>x30寄存器，在arm64中为Link Register (LR)链接寄存器，存储函数调用的返回地址（bl 指令会自动将返回地址写入 x30）；若无函数调用时，可作为普通通用寄存器使用。</p>
<ol>
<li>陷入异常时，并未发生函数调用，因此x30可以复用。而x0-x29等通用寄存器需要保留，后续会用于保存栈帧。</li>
<li>异常切换时，CPU只会自动保存/恢复通用寄存器（x0-x30），所以会用x30作为备份寄存器。</li>
</ol>
<h3 data-id="heading-11">设置异常向量表</h3>
<p><strong>&lt;arch/arm64/kernel/head.S&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">SYM_FUNC_START_LOCAL</span>(__primary_switched)
	adr_l	x4, init_task
	init_cpu_task x4, x5, x6

	<span class="hljs-comment">// 加载异常向量表（vectors）的虚拟地址到x8</span>
	adr_l	x8, vectors			<span class="hljs-comment">// load VBAR_EL1 with virtual</span>
	<span class="hljs-comment">// 将向量表地址写入VBAR_EL1寄存器</span>
	msr	vbar_el1, x8			<span class="hljs-comment">// vector table address</span>
	<span class="hljs-comment">// 指令同步屏障，确保VBAR_EL1修改立即生效</span>
	isb
	...
</code></pre>
<p>调用顺序：primary_entry -&gt; __primary_switch -&gt; __primary_switched，而 primary_entry 是 ARM64 主 CPU 核上电后执行的第一个汇编入口。<br/>
VBAR_EL1 是 ARM64 架构中EL1（内核态）的向量基地址寄存器（Vector Base Address Register），核心作用是存储异常向量表的虚拟基地址。<br/>
<strong>因此发生系统调用时，cpu通过vbar_el1查询到异常处理函数地址，进而跳转到异常处理函数。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++ constexpr]]></title>    <link>https://juejin.cn/post/7585410547337232434</link>    <guid>https://juejin.cn/post/7585410547337232434</guid>    <pubDate>2025-12-19T18:54:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547337232434" data-draft-id="7585410547336986674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++ constexpr"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-19T18:54:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sichg"/> <meta itemprop="url" content="https://juejin.cn/user/2276407984011465"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++ constexpr
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276407984011465/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sichg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T18:54:40.000Z" title="Fri Dec 19 2025 18:54:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>constexpr</code>是C++的修饰词，用于指定“编译期可以求数值的常量表达式”，可用于修饰变量，函数，类/结构体，构造函数/析构函数，模板五种情况，作用就是支持编译期常量处理。<code>constexpr</code>的实际应用中最常用的是修饰变量和函数。</p>
<ul>
<li><code>constexpr</code>用于修饰变量，可以构建真常量，即编译器常量。</li>
<li><code>constexpr</code>用于修饰函数，可以用于编译期求值；</li>
<li><code>constexpr</code>用于修饰类/结构体。可以用来在编译期构造对象；</li>
<li><code>constexpr</code>用于修饰构造函数/析构函数，可以在编译器就对类对象进行初始化/销毁；</li>
<li><code>constexpr</code>用于修饰模板，在编译期间完成模板实例化进行求数值。</li>
</ul>
<p>增加编译期间求解的效果是提升性能、增强类型安全。</p>
<h4 data-id="heading-0">实例1——<code>constexpr</code>修饰变量：</h4>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> MAXsize = <span class="hljs-number">100</span>; <span class="hljs-comment">// 由constexptr修饰的int型真常量，</span>
<span class="hljs-comment">//在编译期就可以通过直接赋值确定取值为100.</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> OVERsize = MAXsize + <span class="hljs-number">50</span>；
<span class="hljs-comment">//在编译期可以通过计算得到确定取值为150.</span>
<span class="hljs-comment">//由constexpr修饰的MAXsize和OVERsize两个真常量，分别取值100和150.</span>
<span class="hljs-comment">//编译正常。符合处理直觉。</span>
</code></pre>
<p>提问：
constexpr 可以修饰变量，此时该变量是编译期常量（值必须在编译期确定，且生命周期内不可修改，比 const 更严格）如果这个变量的取值在编译期间没有确定会报错吗?还是任意给这个变量取定一个随机值?取定随机值会导致这个变量实际没有可用效果? 以及这里讲的生命周期不可修改是什么意思?一个constexpr修饰的真常量的生命周期不就是整个程序运行的期间都有效吗?编译期常量即真常量是不占用C++堆内存和栈内存的吧！</p>
<pre><code class="hljs language-arduino" lang="arduino">解答：
<span class="hljs-comment">// constexpr 修饰变量，这个变量的数值必须在编译期确定，生命周期内不可修改。</span>
<span class="hljs-comment">// 如果编译期间这个变量的数值没有确定指定，会直接编译报错，无随机值。</span>
<span class="hljs-comment">// constexpr 修饰得到的真常量在生命周期内都只具有只读属性，不可修改。</span>
<span class="hljs-comment">// constexpr 修饰得到的真常量的生命周期取决于变量定义所在的作用域决定。</span>
    <span class="hljs-comment">// 即constexpr只负责跟编译器通力合作在编译期间确定数值。</span>
    <span class="hljs-comment">// 至于这个真常量在何时失效取决于这个变量的自身的作用域，</span>
    <span class="hljs-comment">// 即定义在函数内部的变量，即便加上constexpr修饰，</span>
    <span class="hljs-comment">// 这个真常量的生命周期依然只在函数内的局部作用域效果下。constexpr修饰的真常量被存储在静态只读数据区。</span>
</code></pre>
<p>总结1：</p>
<ul>
<li><code>constexpr</code>修饰变量，得到真常量，存储在静态存储区，不占用运行内存；（因此增强性能）</li>
<li><code>constexpr</code>修饰得到的真常量，如果没有在编译期指定，直接报错。</li>
<li><code>constexpr</code>修饰得到的真常量，生命周期内权限为只读，不可修改。</li>
<li><code>constexpr</code>修饰得到的真常量，生命周期长度取决于变量本身的生命周期。</li>
</ul>
<h4 data-id="heading-1">实例2——<code>constexpr</code>修饰函数：</h4>
<p>表示这个函数，如果入参是编译期常量，在编译期完成计算得到处理结果。如果入参不是编译期间常量，那就退化成普通函数。两种情况都不会报错。UDL和普通函数都支持这种退化兼容。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">//constexpr修饰UDL(自定义字面值运算符)</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-keyword">operator</span> <span class="hljs-string">""</span> _KM2m(<span class="hljs-type">long</span> <span class="hljs-type">long</span> kilometer) {
    <span class="hljs-keyword">return</span> kilometer*<span class="hljs-number">1000</span>;
}
<span class="hljs-comment">//constexpr修饰普通函数</span>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span></span>{
    <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h4 data-id="heading-2">实例3——<code>constexpr</code>修饰类/结构体：</h4>
<p>作用是在编译期构造类对象，即<strong>编译期常量对象</strong>。
要求：</p>
<ul>
<li>类的构造函数必须是<code>constexpr</code>构造函数；</li>
<li>编译期内需调用的成员函数也必须有<code>constexpr</code>修饰；</li>
<li>类的成员变量中，对于被<code>constexpr</code>使用/依赖的静态成员变量，必须在类内<code>constexpr</code>修饰。而且最好直接用<code>static constexpr</code></li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">//constexpr修饰结构体(在C++中将结构体视为类的一种)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>{

    <span class="hljs-comment">//constexpr 修饰构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x_, <span class="hljs-type">int</span> y_)</span> ： <span class="hljs-title">x</span><span class="hljs-params">(x_)</span>, <span class="hljs-title">y</span><span class="hljs-params">(y_)</span> </span>{}
        <span class="hljs-comment">// C++中约定俗成用 变量名右加下划线 表示类成员变量的命名。</span>
        <span class="hljs-comment">// x(x_), y(y_) 是 C++ 中的「成员初始化列表（Member Initialization List）</span>
            <span class="hljs-comment">// 效果是将x_,y_的值对应赋值给x，y</span>
            <span class="hljs-comment">// `x(x_)` 和 `x=x_` 在初始化列表中等价</span>
            
    <span class="hljs-comment">//constexpr 修饰构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">get_x</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span>}
    }
    
    <span class="hljs-type">int</span> x;
    <span class="hljs-type">int</span> y;
   }
   
   <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span> </span>{
       <span class="hljs-comment">//编译器构造Ponit对象</span>
       <span class="hljs-function"><span class="hljs-keyword">constexpr</span> Point <span class="hljs-title">p0</span><span class="hljs-params">(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>)</span></span>;
       <span class="hljs-comment">//编译期调用成员函数，获取数值</span>
       <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> x_val = p0.<span class="hljs-built_in">get_x</span>(); 
       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
   }
</code></pre>
<ul>
<li>非静态成员变量是指属于单个对象的变量，每个对象独一份，生命周期随对象变化；</li>
<li>静态成员变量属于类本身的，所有对象共享一份，生命周期贯穿程序。
<ul>
<li>静态const成员变量：类内直接初始化，因为贯穿程序的生命周期，且在运行期间数值不可修改，是绑定在整个类上的变量。<code>static const</code> 变量类型 变量名 = 初始化数值；
<ul>
<li><code>static constexpr</code> 变量类型 变量名 = 初始化数值; 效果更好。</li>
</ul>
</li>
<li>-这里的static其实是指类共享。静态变量本质是类共享变量；非静态变量是类不共享变量。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">实例4——<code>constexpr</code>修饰构造函数/析构函数：</h4>
<p>构造函数用<code>constexpr</code>修饰，要么非空要么只涉及基本四则运算和判断的简洁函数体。
析构函数用<code>constexpr</code>修饰，得到的效果是编译期对象销毁时没有运行期开销。
（<code>constexpr</code>修饰的效果要么是用于设定真常量，要么是能在编译期间能处理的事情给处理了。）</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInt</span>{

    <span class="hljs-keyword">public</span>: 
        <span class="hljs-comment">//构造函数</span>
        <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">MyInt</span> <span class="hljs-params">(<span class="hljs-type">int</span> val_)</span> : val(val_) {</span>}
        <span class="hljs-comment">//析构函数</span>
        <span class="hljs-keyword">constexpr</span> ~<span class="hljs-built_in">MyInt</span>() = <span class="hljs-keyword">default</span>; <span class="hljs-comment">//析构函数直接 = default 就行。</span>
        <span class="hljs-comment">//成员函数</span>
        <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">get_val</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
            <span class="hljs-keyword">return</span> val;
        }

    <span class="hljs-keyword">private</span>:
        <span class="hljs-type">int</span> val;
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//在编译期构造 MyInt 对象</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> MyInt <span class="hljs-title">mi</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span></span>;
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> val = mi.<span class="hljs-built_in">get_val</span>(); <span class="hljs-comment">// 编译期求值为100</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>关联说明类成员函数的<code>const</code>尾缀修饰：
<code>constexpr int get_val() const {             return val; //这个const成员函数只读取，没有修改val的权限。         }</code></p>
<h5 data-id="heading-4"><code>const</code>成员函数</h5>
<p>作用是限定这个成员函数对成员变量的操作权限仅仅是只读。</p>
<ul>
<li>禁止修改类的非静态成员变量，确保这个函数只进行只读操作，不会改变对象的状态。</li>
<li>禁止调用非<code>const</code>成员函数。</li>
</ul>
<h5 data-id="heading-5"><code>const</code> 是 “承诺不修改成员变量”，仅支持运行期执行；<code>constexpr</code> 是 “支持编译期求值”，</h5>
<h4 data-id="heading-6">实例5——<code>constexpr</code>修饰模板template：</h4>
<p>使模板实例化后具备编译器求值能力。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">template</span> T&gt;
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> T <span class="hljs-title">max_val</span><span class="hljs-params">(T a, T b)</span></span>{
        <span class="hljs-keyword">return</span> a &gt; b ? a : b;
    }
    
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> max_num = <span class="hljs-built_in">max_val</span>(<span class="hljs-number">5</span>,<span class="hljs-number">10</span>);
    <span class="hljs-comment">//编译期求值: max_val(5,10)实例化得到int型数据，取值为10.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 容器启动的全方位方法汇总]]></title>    <link>https://juejin.cn/post/7585452404112375823</link>    <guid>https://juejin.cn/post/7585452404112375823</guid>    <pubDate>2025-12-20T01:49:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112375823" data-draft-id="7585145251843309583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 容器启动的全方位方法汇总"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T01:49:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 容器启动的全方位方法汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:49:20.000Z" title="Sat Dec 20 2025 01:49:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、最基础的启动</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run &lt;镜像名&gt;
</code></pre>
<ul>
<li>仅启动容器，不映射端口，不持久化数据</li>
<li>容器退出后数据会丢失</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、后台运行</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d &lt;镜像名&gt;
</code></pre>
<ul>
<li><code>-d</code> → detached 模式，后台运行</li>
<li>常用于服务类镜像（MySQL、Redis、Nginx 等）</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、命名容器</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run --name mycontainer &lt;镜像名&gt;
</code></pre>
<ul>
<li>方便管理、停止、删除</li>
<li>例如 <code>docker stop mycontainer</code></li>
</ul>
<hr/>
<h2 data-id="heading-3">四、端口映射（外部访问）</h2>
<pre><code class="hljs language-xml" lang="xml">docker run -p <span class="hljs-tag">&lt;<span class="hljs-name">宿主机端口</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器端口</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<ul>
<li>Web 服务、数据库必须映射端口</li>
<li>多端口映射示例：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> nginx
</code></pre>
<hr/>
<h2 data-id="heading-4">五、数据持久化（卷和目录挂载）</h2>
<ol>
<li><strong>挂载宿主机目录</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">docker run -v /宿主机路径:/容器路径 &lt;镜像名&gt;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -v /data/mysql:/var/lib/mysql mysql:8.0
</code></pre>
<ol start="2">
<li><strong>Docker 卷</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">docker volume create myvolume
docker run -v myvolume:/容器路径 &lt;镜像名&gt;
</code></pre>
<ul>
<li>卷管理方便，可通过 <code>docker volume ls</code> 查看</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、环境变量配置</h2>
<pre><code class="hljs language-ini" lang="ini">docker run -e <span class="hljs-attr">KEY</span>=VALUE &lt;镜像名&gt;
</code></pre>
<ul>
<li>
<p>数据库镜像常用：</p>
<ul>
<li><code>MYSQL_ROOT_PASSWORD</code></li>
<li><code>MYSQL_DATABASE</code></li>
<li><code>MYSQL_USER</code></li>
<li><code>MYSQL_PASSWORD</code></li>
</ul>
</li>
<li>
<p>Web 服务镜像常用：</p>
<ul>
<li><code>TZ</code>（时区）</li>
<li><code>APP_ENV</code>、<code>DEBUG</code> 等自定义变量</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">七、重启策略</h2>
<pre><code class="hljs language-xml" lang="xml">docker run --restart <span class="hljs-tag">&lt;<span class="hljs-name">策略</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<ul>
<li><code>no</code> → 不自动重启（默认）</li>
<li><code>always</code> → 容器停止或 Docker 重启都会自动启动</li>
<li><code>unless-stopped</code> → 除非手动停止，否则自动启动</li>
<li><code>on-failure[:最大重试次数]</code> → 出错自动重启</li>
</ul>
<hr/>
<h2 data-id="heading-7">八、交互模式（进入容器）</h2>
<pre><code class="hljs language-javascript" lang="javascript">docker run -it &lt;镜像名&gt; <span class="hljs-regexp">/bin/</span>bash
</code></pre>
<ul>
<li><code>-it</code> → 交互模式 + 分配伪终端</li>
<li>适用于调试、临时测试</li>
</ul>
<hr/>
<h2 data-id="heading-8">九、组合启动示例（生产环境通用模板）</h2>
<pre><code class="hljs language-xml" lang="xml">docker run -d \
  --name <span class="hljs-tag">&lt;<span class="hljs-name">容器名</span>&gt;</span> \
  -p <span class="hljs-tag">&lt;<span class="hljs-name">宿主端口</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器端口</span>&gt;</span> \
  -v <span class="hljs-tag">&lt;<span class="hljs-name">宿主路径</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器路径</span>&gt;</span> \
  -e KEY1=VALUE1 -e KEY2=VALUE2 \
  --restart unless-stopped \
  <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">十、常用容器管理命令</h2>









































<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker ps</code></td><td>查看运行中的容器</td></tr><tr><td><code>docker ps -a</code></td><td>查看所有容器</td></tr><tr><td><code>docker stop &lt;容器&gt;</code></td><td>停止容器</td></tr><tr><td><code>docker start &lt;容器&gt;</code></td><td>启动容器</td></tr><tr><td><code>docker restart &lt;容器&gt;</code></td><td>重启容器</td></tr><tr><td><code>docker rm &lt;容器&gt;</code></td><td>删除容器</td></tr><tr><td><code>docker logs &lt;容器&gt;</code></td><td>查看日志</td></tr><tr><td><code>docker exec -it &lt;容器&gt; &lt;命令&gt;</code></td><td>进入容器或执行命令</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">十一、镜像管理</h2>





































<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker pull &lt;镜像&gt;</code></td><td>下载镜像</td></tr><tr><td><code>docker images</code></td><td>查看本地镜像</td></tr><tr><td><code>docker rmi &lt;镜像&gt;</code></td><td>删除镜像</td></tr><tr><td><code>docker save -o &lt;文件&gt;.tar &lt;镜像&gt;</code></td><td>导出镜像</td></tr><tr><td><code>docker load -i &lt;文件&gt;.tar</code></td><td>导入镜像</td></tr><tr><td><code>docker tag &lt;镜像&gt; &lt;新镜像&gt;</code></td><td>镜像打标签</td></tr><tr><td><code>docker push &lt;镜像&gt;</code></td><td>推送到仓库</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">十二、系统信息与清理</h2>

























<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker info</code></td><td>查看 Docker 系统信息</td></tr><tr><td><code>docker version</code></td><td>查看版本</td></tr><tr><td><code>docker system df</code></td><td>查看磁盘占用</td></tr><tr><td><code>docker system prune -a</code></td><td>清理无用镜像、容器、网络</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">十三、特殊启动选项</h2>

































<table><thead><tr><th>需求</th><th>参数</th></tr></thead><tbody><tr><td>限制内存</td><td><code>--memory=1g</code></td></tr><tr><td>限制 CPU</td><td><code>--cpus=1.5</code></td></tr><tr><td>设置 hostname</td><td><code>--hostname myhost</code></td></tr><tr><td>指定网络</td><td><code>--network mynet</code></td></tr><tr><td>连接多个网络</td><td><code>--network network1 --network network2</code></td></tr><tr><td>临时容器（退出自动删除）</td><td><code>--rm</code></td></tr></tbody></table>
<hr/>
<p>💡 总结：</p>
<ul>
<li><strong>必需参数</strong>：镜像名、端口映射（服务类）、数据卷（持久化）</li>
<li><strong>推荐参数</strong>：环境变量、重启策略、容器命名</li>
<li><strong>可选参数</strong>：CPU/内存限制、网络配置、调试模式</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观察者模式：从理论到生产实践]]></title>    <link>https://juejin.cn/post/7585397173023014931</link>    <guid>https://juejin.cn/post/7585397173023014931</guid>    <pubDate>2025-12-20T02:27:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023014931" data-draft-id="7585400495683321898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观察者模式：从理论到生产实践"/> <meta itemprop="keywords" content="设计模式,Java"/> <meta itemprop="datePublished" content="2025-12-20T02:27:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观察者模式：从理论到生产实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:27:07.000Z" title="Sat Dec 20 2025 02:27:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">观察者模式深度解析：从理论到生产实践</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c416cb9945a411d90037b47ef3563de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=3HkmNCsWokdIGT4tARE5%2Fw4DnVs%3D" alt="01_观察者模式UML类图.png" loading="lazy"/></p>
<p>在软件开发中，我们经常需要实现"一个对象状态变化，多个对象自动更新"的场景。比如用户注册成功时，需要发送欢迎邮件、赠送积分、记录日志等多个操作。这种一对多的依赖关系，正是观察者模式的典型应用场景。</p>
<h3 data-id="heading-1">观察者模式是什么？</h3>
<p>观察者模式（Observer Pattern）是一种行为设计模式，它定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。当主题对象的状态发生变化时，所有观察者都会收到通知并自动更新。</p>
<p>这里借用建筑监理的比喻：投资方（观察者们）委托建筑师（主题）监督项目进度。每当有建筑进展，建筑师主动通知所有投资方，无需投资方反复询问。</p>
<h3 data-id="heading-2">核心角色与实现</h3>
<p>观察者模式主要包含四个角色：</p>
<ol>
<li><strong>Subject（主题）</strong>：定义了被观察者对象的基本接口</li>
<li><strong>ConcreteSubject（具体主题）</strong>：主题的具体实现，维护观察者列表</li>
<li><strong>Observer（观察者）</strong>：定义了观察者对通知做出反应的方法</li>
<li><strong>ConcreteObserver（具体观察者）</strong>：实现Observer接口，观察主题并执行相应操作</li>
</ol>
<p>下面通过一个实际的电商库存管理示例来展示观察者模式的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 观察者接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span>;
}

<span class="hljs-comment">// 具体观察者1：库存预警系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryAlert</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &lt; <span class="hljs-number">10</span>) {
            System.out.println(<span class="hljs-string">"⚠️ 库存预警: "</span> + product.getName() + <span class="hljs-string">" 库存不足，当前数量: "</span> + newQuantity);
        }
    }
}

<span class="hljs-comment">// 具体观察者2：订单处理系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &lt; <span class="hljs-number">5</span>) {
            System.out.println(<span class="hljs-string">"📦 自动触发补货: "</span> + product.getName() + <span class="hljs-string">" 正在向供应商下单..."</span>);
        }
    }
}

<span class="hljs-comment">// 具体观察者3：价格调整系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceAdjuster</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &gt; <span class="hljs-number">100</span>) {
            System.out.println(<span class="hljs-string">"💰 库存充足，可以考虑促销降价！"</span>);
        }
    }
}

<span class="hljs-comment">// 主题接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventorySubject</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(InventoryObserver observer)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(InventoryObserver observer)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> quantity)</span>;
}

<span class="hljs-comment">// 具体主题：库存管理器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventorySubject</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;InventoryObserver&gt; observers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Integer&gt; inventory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(InventoryObserver observer)</span> {
        observers.add(observer);
        System.out.println(<span class="hljs-string">"添加观察者: "</span> + observer.getClass().getSimpleName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(InventoryObserver observer)</span> {
        observers.remove(observer);
        System.out.println(<span class="hljs-string">"移除观察者: "</span> + observer.getClass().getSimpleName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-keyword">for</span> (InventoryObserver observer : observers) {
            observer.onInventoryChanged(product, quantity);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateStock</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> quantity)</span> {
        inventory.put(productId, quantity);
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(productId, <span class="hljs-string">"Product-"</span> + productId);
        notifyObservers(product, quantity);
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObserverDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建库存管理器（主题）</span>
        <span class="hljs-type">InventoryManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryManager</span>();

        <span class="hljs-comment">// 创建观察者</span>
        <span class="hljs-type">InventoryAlert</span> <span class="hljs-variable">alert</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryAlert</span>();
        <span class="hljs-type">OrderProcessor</span> <span class="hljs-variable">orderProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderProcessor</span>();
        <span class="hljs-type">PriceAdjuster</span> <span class="hljs-variable">priceAdjuster</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceAdjuster</span>();

        <span class="hljs-comment">// 注册观察者</span>
        manager.addObserver(alert);
        manager.addObserver(orderProcessor);
        manager.addObserver(priceAdjuster);

        System.out.println(<span class="hljs-string">"\n--- 模拟库存变化 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 库存不足场景</span>

        System.out.println(<span class="hljs-string">"\n--- 模拟供应商补货 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">50</span>);  <span class="hljs-comment">// 补货后库存正常</span>

        System.out.println(<span class="hljs-string">"\n--- 模拟库存积压 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">150</span>); <span class="hljs-comment">// 库存积压场景</span>
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-diff" lang="diff">添加观察者: InventoryAlert
添加观察者: OrderProcessor
添加观察者: PriceAdjuster

<span class="hljs-comment">--- 模拟库存变化 ---</span>
⚠️ 库存预警: Product-iphone 库存不足，当前数量: 3
📦 自动触发补货: Product-iphone 正在向供应商下单...

<span class="hljs-comment">--- 模拟供应商补货 ---</span>

<span class="hljs-comment">--- 模拟库存积压 ---</span>
💰 库存充足，可以考虑促销降价！
</code></pre>
<h3 data-id="heading-3">Spring框架中的事件机制</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf401cc8aa2458baca0f5233762cc7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=2p1Gxi8gnpVfF7CtQ9VeE8fYSDE%3D" alt="03_Spring事件机制架构.png" loading="lazy"/></p>
<p>观察者模式在Spring框架中被广泛应用，其事件机制就是典型的实现。Spring的事件机制以ApplicationContext为核心，实现了观察者模式的高级封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRegisterEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserRegisterEvent</span><span class="hljs-params">(Object source, String username)</span> {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }
}

<span class="hljs-comment">// 事件监听器（观察者）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailSendListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmail</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"📧 发送欢迎邮件给: "</span> + event.getUsername());
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointsGrantListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">grantPoints</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"🎁 为新用户 "</span> + event.getUsername() + <span class="hljs-string">" 赠送100积分"</span>);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogRecordListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordLog</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"📝 记录用户注册日志: "</span> + event.getUsername());
    }
}

<span class="hljs-comment">// 事件发布者</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;

    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String username)</span> {
        <span class="hljs-comment">// 注册用户...</span>
        System.out.println(<span class="hljs-string">"创建用户: "</span> + username);

        <span class="hljs-comment">// 发布事件</span>
        <span class="hljs-type">UserRegisterEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRegisterEvent</span>(<span class="hljs-built_in">this</span>, username);
        eventPublisher.publishEvent(event);

        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"注册成功"</span>);
    }
}
</code></pre>
<p>Spring的事件机制优势：</p>
<ul>
<li><strong>完全解耦</strong>：发布者和订阅者互不感知</li>
<li><strong>异步支持</strong>：支持@Async异步事件处理</li>
<li><strong>事务绑定</strong>：@TransactionalEventListener支持事务提交后触发</li>
<li><strong>条件过滤</strong>：@EventListener支持SpEL条件表达式</li>
</ul>
<h3 data-id="heading-4">消息队列中的观察者模式</h3>
<p>消息队列系统RabbitMQ本质上也是观察者模式的延伸，但采用了更灵活的发布-订阅模式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置多队列消息监听</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RabbitListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventHandler</span> {

    <span class="hljs-comment">// 监听订单创建事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderCreated")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(Order order)</span> {
        log.info(<span class="hljs-string">"订单创建事件: {}"</span>, order.getId());

        <span class="hljs-comment">// 1. 减库存</span>
        inventoryService.reduceStock(order);

        <span class="hljs-comment">// 2. 发送确认邮件</span>
        emailService.sendOrderConfirm(order);

        <span class="hljs-comment">// 3. 记录业务日志</span>
        auditService.log(order);
    }

    <span class="hljs-comment">// 监听订单支付事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderPaid")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderPaid</span><span class="hljs-params">(String orderId)</span> {
        log.info(<span class="hljs-string">"订单支付事件: {}"</span>, orderId);

        <span class="hljs-comment">// 1. 更新订单状态</span>
        orderService.payOrder(orderId);

        <span class="hljs-comment">// 2. 通知物流系统发货</span>
        logisticsService.shipOrder(orderId);

        <span class="hljs-comment">// 3. 更新用户累计消费</span>
        userService.addConsumption(orderId);
    }

    <span class="hljs-comment">// 监听订单取消事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderCancelled")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCancelled</span><span class="hljs-params">(Order order)</span> {
        log.info(<span class="hljs-string">"订单取消事件: {}"</span>, order.getId());

        <span class="hljs-comment">// 1. 恢复库存</span>
        inventoryService.restoreStock(order);

        <span class="hljs-comment">// 2. 处理退款</span>
        paymentService.refund(order);

        <span class="hljs-comment">// 3. 发送取消通知</span>
        notificationService.orderCancelled(order);
    }
}
</code></pre>
<h3 data-id="heading-5">观察者模式 vs 发布-订阅模式</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f06e51881ab4859a313ccf7c8fa6a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=vEGnpo%2FAlJHLXNgSnnNijt1NhrE%3D" alt="04_观察者vs发布订阅对比.png" loading="lazy"/></p>
<p>很多人将观察者模式和发布-订阅模式混为一谈，实际上两者有明显区别：</p>



































<table><thead><tr><th>特性</th><th>观察者模式</th><th>发布-订阅模式</th></tr></thead><tbody><tr><td>耦合程度</td><td>相对较强（主题需维护观察者列表）</td><td>完全解耦（通过消息中介）</td></tr><tr><td>通信方式</td><td>同步通信</td><td>支持异步通信</td></tr><tr><td>分层结构</td><td>两层（主题-观察者）</td><td>三层（发布者-临时层-订阅者）</td></tr><tr><td>消息过滤</td><td>不支持</td><td>支持（如topic）</td></tr><tr><td>适用场景</td><td>同一应用中</td><td>分布式系统</td></tr></tbody></table>
<h3 data-id="heading-6">观察者模式工作流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc62a58e4fd04a63912cd80ba3238d05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=nozx44hd5a0Vzmvaq4qUURCzyGU%3D" alt="02_观察者模式工作流程.png" loading="lazy"/></p>
<p>观察者模式的工作流程主要分为以下几个步骤：</p>
<ol>
<li><strong>注册阶段</strong>：观察者调用subscrib方法将自己注册到主题</li>
<li><strong>状态变更</strong>：主题对象的内部状态发生改变</li>
<li><strong>通知阶段</strong>：主题调用notify方法通知所有注册的观察者</li>
<li><strong>更新阶段</strong>：观察者收到通知后，调用对象的update方法更新自身状态</li>
</ol>
<h3 data-id="heading-7">应用场景分析</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9435ae0c1e23486190288902533a6a83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=hvX8MqXCVU8vaDEQXtFtCBK0DJM%3D" alt="05_观察者模式应用场景.png" loading="lazy"/></p>
<p>观察者模式广泛应用于以下场景：</p>
<h4 data-id="heading-8">1. GUI组件事件监听</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JavaFX 按钮点击监听</span>
<span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>(<span class="hljs-string">"点击我"</span>);
button.setOnAction(event -&gt; {
    System.out.println(<span class="hljs-string">"按钮被点击！"</span>);
});
</code></pre>
<h4 data-id="heading-9">2. 实时数据同步</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库binlog监听（基于Canal）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseChangeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CanalClientEx</span> {
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleChange</span><span class="hljs-params">(CanalEntry.EventType change)</span> {
        <span class="hljs-comment">// 同步到ES</span>
        elasticsearchService.sync(change);
        <span class="hljs-comment">// 同步到缓存</span>
        cacheService.sync(change);
        <span class="hljs-comment">// 通知下游服务</span>
        messageService.publish(change);
    }
}
</code></pre>
<h3 data-id="heading-10">实现要点与注意事项</h3>
<h4 data-id="heading-11">1. 观察者管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用线程安全的集合管理观察者</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Observer&gt; observers =
    Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

<span class="hljs-comment">// 添加观察者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(Observer observer)</span> {
    <span class="hljs-keyword">if</span> (observer == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"观察者不能为空"</span>);
    }
    <span class="hljs-keyword">synchronized</span>(observers) {
        observers.add(observer);
    }
}

<span class="hljs-comment">// 移除观察者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(Observer observer)</span> {
    observers.remove(observer);
}
</code></pre>
<h4 data-id="heading-12">2. 防止观察者循环引用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteSubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Observable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用锁避免循环引用</span>
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-keyword">if</span> (!changed) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 复制观察者列表避免并发修改</span>
            Observer[] arr = observers.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>[<span class="hljs-number">0</span>]);
            clearChanged();

            <span class="hljs-keyword">for</span> (Observer observer : arr) {
                <span class="hljs-keyword">try</span> {
                    observer.update(<span class="hljs-built_in">this</span>, <span class="hljs-literal">null</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"通知观察者失败："</span>, e);
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-13">3. 异步通知避免阻塞</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用线程池异步通知</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncEventPublisher</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishEventAsync</span><span class="hljs-params">(InventoryEvent event)</span> {
        executor.execute(() -&gt; {
            <span class="hljs-keyword">try</span> {
                notifyObservers(event);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"异步事件通知失败"</span>, e);
            }
        });
    }

    <span class="hljs-comment">// 优雅关闭</span>
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        executor.shutdown();
    }
}
</code></pre>
<h3 data-id="heading-14">优缺点分析</h3>
<p>✅ <strong>优点：</strong></p>
<ol>
<li><strong>降低耦合度</strong>：发布者和订阅者相互解耦，易于系统扩展</li>
<li><strong>遵守开闭原则</strong>：新增观察者时无需修改主题代码</li>
<li><strong>实现广播通信</strong>：一个主题状态变化，多个观察者同步更新</li>
<li><strong>消息传递高效</strong>：直接方法调用，性能优于消息队列</li>
</ol>
<p>❌<strong>缺点：</strong></p>
<ol>
<li><strong>观察者数量与性能相关</strong>：当观察者数量较多时，通知过程变慢</li>
<li><strong>循环依赖风险</strong>：观察者和主题之间可能产生循环引用</li>
<li><strong>同步通知阻塞所有观察者</strong>：一个观察者阻塞会影响整个通知链</li>
</ol>
<p>观察者模式作为最经典的设计模式之一，它的思想贯穿于各种事件处理和通知机制中。从简单的对象监听，到复杂的分布式事件系统，观察者模式都能发挥其解耦和扩展性的优势。掌握观察者模式，能够帮助我们构建更加灵活、可维护的软件架构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 爬虫框架设计：类封装与工程化实践]]></title>    <link>https://juejin.cn/post/7585406030021836835</link>    <guid>https://juejin.cn/post/7585406030021836835</guid>    <pubDate>2025-12-20T01:23:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030021836835" data-draft-id="7585377128491221044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 爬虫框架设计：类封装与工程化实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T01:23:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Felixwb666"/> <meta itemprop="url" content="https://juejin.cn/user/485307600606522"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 爬虫框架设计：类封装与工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485307600606522/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Felixwb666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:23:45.000Z" title="Sat Dec 20 2025 01:23:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 1688 数据采集等爬虫场景中，<strong>类封装</strong>能实现代码的复用与解耦，<strong>工程化</strong>则保障爬虫的稳定性、可维护性和可扩展性。本文将结合 1688 爬虫的实际需求，从<strong>框架设计原则</strong>、<strong>核心类封装</strong>、<strong>工程化配套模块</strong>到<strong>实战落地</strong>，完整讲解爬虫框架的设计与实现。</p>
<h2 data-id="heading-0">一、框架设计原则与整体架构</h2>
<h3 data-id="heading-1">1. 核心设计原则</h3>
<p>爬虫框架需遵循<strong>开闭原则</strong>（对扩展开放、对修改关闭）、<strong>单一职责</strong>（每个模块只做一件事）和<strong>依赖注入</strong>（模块间通过配置解耦），同时需适配 1688 的反爬特性（如动态渲染、IP 封禁）。</p>
<h3 data-id="heading-2">2. 整体架构分层</h3>
<p>将爬虫拆分为<strong>5 个核心层</strong>，层与层之间通过接口交互，降低耦合：</p>



































<table><thead><tr><th>层级</th><th>职责</th><th>核心实现方式</th></tr></thead><tbody><tr><td><strong>配置层</strong></td><td>管理爬虫参数（如代理、UA、爬取关键词）、存储配置等</td><td>YAML/JSON 配置文件 + 配置类</td></tr><tr><td><strong>请求层</strong></td><td>封装 HTTP 请求，处理反爬（代理、UA、延迟）、异常重试</td><td>基础请求类 + 反爬中间件</td></tr><tr><td><strong>解析层</strong></td><td>解析网页 / 接口数据，提取目标字段（如 1688 商品标题、价格）</td><td>解析器基类 + 业务解析子类</td></tr><tr><td><strong>存储层</strong></td><td>处理数据持久化（CSV/MySQL/MongoDB），支持数据去重</td><td>存储基类 + 多存储实现子类</td></tr><tr><td><strong>调度层</strong></td><td>管理爬取任务（分页、多线程 / 异步）、监控任务状态</td><td>调度器类 + 任务队列</td></tr></tbody></table>
<h2 data-id="heading-3">二、核心类封装实现</h2>
<p>基于分层架构，我们通过<strong>类的继承与多态</strong>封装通用逻辑，再针对 1688 场景实现具体业务。</p>
<h3 data-id="heading-4">1. 环境准备</h3>
<p>安装必备依赖：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash">pip install requests beautifulsoup4 pyyaml fake-useragent playwright pymongo mysql-connector-python
playwright install chromium  <span class="hljs-comment"># 处理动态页面</span>
</code></pre>
<h3 data-id="heading-5">2. 配置层封装（Config 类）</h3>
<p>通过 YAML 配置文件管理参数，避免硬编码，便于后续修改。</p>
<p><strong>配置文件（config.yaml）</strong> ：</p>
<p>yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 爬虫基础配置</span>
<span class="hljs-attr">spider:</span>
  <span class="hljs-attr">keyword:</span> <span class="hljs-string">"手机壳"</span>  <span class="hljs-comment"># 1688搜索关键词</span>
  <span class="hljs-attr">max_page:</span> <span class="hljs-number">5</span>       <span class="hljs-comment"># 最大爬取页数</span>
  <span class="hljs-attr">delay:</span> <span class="hljs-number">3</span>          <span class="hljs-comment"># 请求延迟（秒）</span>
  <span class="hljs-attr">retry_times:</span> <span class="hljs-number">3</span>    <span class="hljs-comment"># 失败重试次数</span>

<span class="hljs-comment"># 反爬配置</span>
<span class="hljs-attr">anti_crawl:</span>
  <span class="hljs-attr">user_agent_pool:</span> [<span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36..."</span>, <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ..."</span>]
  <span class="hljs-attr">proxy_pool:</span> [<span class="hljs-string">"http://127.0.0.1:7890"</span>, <span class="hljs-string">"http://username:password@proxy.example.com:8080"</span>]  <span class="hljs-comment"># 代理池</span>

<span class="hljs-comment"># 存储配置</span>
<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"csv"</span>  <span class="hljs-comment"># 可选：csv/mongo/mysql</span>
  <span class="hljs-attr">csv_path:</span> <span class="hljs-string">"./1688_products.csv"</span>
  <span class="hljs-attr">mongo:</span>
    <span class="hljs-attr">uri:</span> <span class="hljs-string">"mongodb://localhost:27017/"</span>
    <span class="hljs-attr">db:</span> <span class="hljs-string">"1688_spider"</span>
    <span class="hljs-attr">collection:</span> <span class="hljs-string">"products"</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">"root"</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">"123456"</span>
    <span class="hljs-attr">db:</span> <span class="hljs-string">"1688_spider"</span>
</code></pre>
<p><strong>配置类封装（config.py）</strong> ：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> yaml
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
    <span class="hljs-string">"""配置管理类，加载并解析YAML配置文件"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"./config.yaml"</span></span>):
        self.config_path = config_path
        self.config = self._load_config()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_load_config</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""加载YAML配置"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.config_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">return</span> yaml.safe_load(f)
        <span class="hljs-keyword">except</span> FileNotFoundError:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"配置文件<span class="hljs-subst">{self.config_path}</span>不存在"</span>)
        <span class="hljs-keyword">except</span> yaml.YAMLError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"配置文件解析错误：<span class="hljs-subst">{e}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">str</span>, default: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""按层级获取配置，如'spider.keyword'"""</span>
        keys = key.split(<span class="hljs-string">"."</span>)
        value = self.config
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> keys:
            <span class="hljs-keyword">if</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> value:
                <span class="hljs-keyword">return</span> default
            value = value[k]
        <span class="hljs-keyword">return</span> value

<span class="hljs-comment"># 测试配置类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    <span class="hljs-built_in">print</span>(config.get(<span class="hljs-string">"spider.keyword"</span>))  <span class="hljs-comment"># 输出：手机壳</span>
    <span class="hljs-built_in">print</span>(config.get(<span class="hljs-string">"anti_crawl.proxy_pool"</span>))  <span class="hljs-comment"># 输出代理池列表</span>
</code></pre>
<h3 data-id="heading-6">3. 请求层封装（BaseRequest 类）</h3>
<p>封装 HTTP 请求的通用逻辑（反爬、重试、延迟），支持同步请求和动态页面请求（Playwright）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> fake_useragent <span class="hljs-keyword">import</span> UserAgent
<span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseRequest</span>:
    <span class="hljs-string">"""请求基类，封装通用请求逻辑"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config
        self.ua = UserAgent()
        self.retry_times = self.config.get(<span class="hljs-string">"spider.retry_times"</span>, <span class="hljs-number">3</span>)
        self.delay = self.config.get(<span class="hljs-string">"spider.delay"</span>, <span class="hljs-number">2</span>)
        self.proxy_pool = self.config.get(<span class="hljs-string">"anti_crawl.proxy_pool"</span>, [])
        self.ua_pool = self.config.get(<span class="hljs-string">"anti_crawl.user_agent_pool"</span>, [])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_random_proxy</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""随机获取代理"""</span>
        <span class="hljs-keyword">return</span> random.choice(self.proxy_pool) <span class="hljs-keyword">if</span> self.proxy_pool <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_random_ua</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""随机获取User-Agent"""</span>
        <span class="hljs-keyword">return</span> random.choice(self.ua_pool) <span class="hljs-keyword">if</span> self.ua_pool <span class="hljs-keyword">else</span> self.ua.random

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_delay</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""请求延迟，防反爬"""</span>
        time.sleep(random.uniform(self.delay, self.delay + <span class="hljs-number">2</span>))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span>, headers: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""同步GET请求，支持重试和反爬"""</span>
        headers = headers <span class="hljs-keyword">or</span> {}
        headers[<span class="hljs-string">"User-Agent"</span>] = self._get_random_ua()
        proxies = {<span class="hljs-string">"http"</span>: self._get_random_proxy(), <span class="hljs-string">"https"</span>: self._get_random_proxy()} <span class="hljs-keyword">if</span> self._get_random_proxy() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.retry_times):
            <span class="hljs-keyword">try</span>:
                self._add_delay()
                resp = requests.get(url, params=params, headers=headers, proxies=proxies, timeout=<span class="hljs-number">10</span>)
                resp.raise_for_status()  <span class="hljs-comment"># 抛出HTTP错误</span>
                <span class="hljs-keyword">return</span> resp.text
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败（第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>次重试）：<span class="hljs-subst">{e}</span>"</span>)
                time.sleep(<span class="hljs-number">2</span> ** retry)  <span class="hljs-comment"># 指数退避重试</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dynamic</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""动态页面请求（Playwright），返回关键数据"""</span>
        result = {<span class="hljs-string">"title"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"price"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"sales"</span>: <span class="hljs-literal">None</span>}
        <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
            browser = p.chromium.launch(headless=<span class="hljs-literal">True</span>)
            page = browser.new_page(user_agent=self._get_random_ua())
            <span class="hljs-keyword">try</span>:
                page.goto(url, timeout=<span class="hljs-number">30000</span>)
                <span class="hljs-comment"># 提取1688商品详情页关键数据（需根据页面结构调整）</span>
                result[<span class="hljs-string">"title"</span>] = page.locator(<span class="hljs-string">".detail-title"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".detail-title"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                result[<span class="hljs-string">"price"</span>] = page.locator(<span class="hljs-string">".price"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".price"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                result[<span class="hljs-string">"sales"</span>] = page.locator(<span class="hljs-string">".sales-volume"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".sales-volume"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                self._add_delay()
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"动态页面请求失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">finally</span>:
                browser.close()
        <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 测试请求类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    request = BaseRequest(config)
    html = request.get(<span class="hljs-string">"https://s.1688.com/selloffer/offer_search.htm?keywords=手机壳"</span>)
    <span class="hljs-built_in">print</span>(html[:<span class="hljs-number">500</span>])  <span class="hljs-comment"># 输出页面前500字符</span>
</code></pre>
<h3 data-id="heading-7">4. 解析层封装（BaseParser 类）</h3>
<p>封装数据解析的通用接口，子类实现具体的 1688 页面解析逻辑。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseParser</span>:
    <span class="hljs-string">"""解析器基类，定义解析接口"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, html: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""解析接口，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"子类需实现parse方法"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Ali1688ListParser</span>(<span class="hljs-title class_ inherited__">BaseParser</span>):
    <span class="hljs-string">"""1688商品列表页解析器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, html: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""解析商品列表页，提取标题、价格、链接"""</span>
        soup = BeautifulSoup(html, <span class="hljs-string">"lxml"</span>)
        products = soup.select(<span class="hljs-string">".sm-offer-item"</span>)
        result = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> products:
            <span class="hljs-comment"># 提取字段（需根据1688页面结构实时调整）</span>
            title_elem = item.select_one(<span class="hljs-string">".offer-title a"</span>)
            price_elem = item.select_one(<span class="hljs-string">".price"</span>)
            link_elem = item.select_one(<span class="hljs-string">".offer-title a"</span>)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (title_elem <span class="hljs-keyword">and</span> price_elem <span class="hljs-keyword">and</span> link_elem):
                <span class="hljs-keyword">continue</span>

            product = {
                <span class="hljs-string">"title"</span>: title_elem.get(<span class="hljs-string">"title"</span>, <span class="hljs-string">""</span>).strip(),
                <span class="hljs-string">"price"</span>: price_elem.text.strip(),
                <span class="hljs-string">"link"</span>: link_elem.get(<span class="hljs-string">"href"</span>, <span class="hljs-string">""</span>).strip(),
                <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>
            }
            result.append(product)
        <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 测试解析类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    request = BaseRequest(config)
    parser = Ali1688ListParser(config)
    html = request.get(<span class="hljs-string">"https://s.1688.com/selloffer/offer_search.htm?keywords=手机壳"</span>)
    <span class="hljs-keyword">if</span> html:
        products = parser.parse(html)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析到<span class="hljs-subst">{<span class="hljs-built_in">len</span>(products)}</span>个商品："</span>)
        <span class="hljs-built_in">print</span>(products[:<span class="hljs-number">2</span>])
</code></pre>
<h3 data-id="heading-8">5. 存储层封装（BaseStorage 类）</h3>
<p>支持多存储方式（CSV/MySQL/MongoDB），通过子类实现具体存储逻辑。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> pymongo
<span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseStorage</span>:
    <span class="hljs-string">"""存储基类，定义存储接口"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""存储接口，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"子类需实现save方法"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CsvStorage</span>(<span class="hljs-title class_ inherited__">BaseStorage</span>):
    <span class="hljs-string">"""CSV存储类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        <span class="hljs-built_in">super</span>().__init__(config)
        self.csv_path = self.config.get(<span class="hljs-string">"storage.csv_path"</span>, <span class="hljs-string">"./products.csv"</span>)
        <span class="hljs-comment"># 初始化CSV文件并写入表头</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"w"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            writer = csv.DictWriter(f, fieldnames=[<span class="hljs-string">"title"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"link"</span>, <span class="hljs-string">"source"</span>])
            writer.writeheader()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""将数据追加写入CSV"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"a"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            writer = csv.DictWriter(f, fieldnames=[<span class="hljs-string">"title"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"link"</span>, <span class="hljs-string">"source"</span>])
            writer.writerows(data)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span>条数据到CSV：<span class="hljs-subst">{self.csv_path}</span>"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoStorage</span>(<span class="hljs-title class_ inherited__">BaseStorage</span>):
    <span class="hljs-string">"""MongoDB存储类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        <span class="hljs-built_in">super</span>().__init__(config)
        self.client = pymongo.MongoClient(self.config.get(<span class="hljs-string">"storage.mongo.uri"</span>))
        self.db = self.client[self.config.get(<span class="hljs-string">"storage.mongo.db"</span>)]
        self.collection = self.db[self.config.get(<span class="hljs-string">"storage.mongo.collection"</span>)]
        <span class="hljs-comment"># 创建唯一索引，避免重复存储</span>
        self.collection.create_index(<span class="hljs-string">"link"</span>, unique=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""将数据写入MongoDB，自动去重"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">try</span>:
            self.collection.insert_many(data, ordered=<span class="hljs-literal">False</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span>条数据到MongoDB"</span>)
        <span class="hljs-keyword">except</span> pymongo.errors.BulkWriteError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 忽略重复数据错误</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"部分数据重复，实际写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data) - <span class="hljs-built_in">len</span>(e.details[<span class="hljs-string">'writeErrors'</span>])}</span>条"</span>)

<span class="hljs-comment"># 测试存储类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    storage = CsvStorage(config)
    <span class="hljs-comment"># 模拟数据</span>
    test_data = [
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"苹果15手机壳"</span>, <span class="hljs-string">"price"</span>: <span class="hljs-string">"10.00"</span>, <span class="hljs-string">"link"</span>: <span class="hljs-string">"https://example.com/1"</span>, <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>},
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"华为Mate60手机壳"</span>, <span class="hljs-string">"price"</span>: <span class="hljs-string">"8.50"</span>, <span class="hljs-string">"link"</span>: <span class="hljs-string">"https://example.com/2"</span>, <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>}
    ]
    storage.save(test_data)
</code></pre>
<h3 data-id="heading-9">6. 调度层封装（SpiderScheduler 类）</h3>
<p>管理爬取任务的生命周期（分页、任务分发），整合请求、解析、存储模块。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> request <span class="hljs-keyword">import</span> BaseRequest
<span class="hljs-keyword">from</span> parser <span class="hljs-keyword">import</span> Ali1688ListParser
<span class="hljs-keyword">from</span> storage <span class="hljs-keyword">import</span> BaseStorage, CsvStorage, MongoStorage

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderScheduler</span>:
    <span class="hljs-string">"""爬虫调度器，整合各模块并管理爬取任务"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config
        self.request = BaseRequest(config)
        self.parser = Ali1688ListParser(config)
        self.storage = self._init_storage()
        self.keyword = self.config.get(<span class="hljs-string">"spider.keyword"</span>)
        self.max_page = self.config.get(<span class="hljs-string">"spider.max_page"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_storage</span>(<span class="hljs-params">self</span>) -&gt; BaseStorage:
        <span class="hljs-string">"""根据配置初始化存储类"""</span>
        storage_type = self.config.get(<span class="hljs-string">"storage.type"</span>, <span class="hljs-string">"csv"</span>)
        <span class="hljs-keyword">if</span> storage_type == <span class="hljs-string">"csv"</span>:
            <span class="hljs-keyword">return</span> CsvStorage(self.config)
        <span class="hljs-keyword">elif</span> storage_type == <span class="hljs-string">"mongo"</span>:
            <span class="hljs-keyword">return</span> MongoStorage(self.config)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的存储类型：<span class="hljs-subst">{storage_type}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_url</span>(<span class="hljs-params">self, page: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""构建1688搜索页URL"""</span>
        <span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"https://s.1688.com/selloffer/offer_search.htm?keywords=<span class="hljs-subst">{quote(self.keyword)}</span>&amp;page=<span class="hljs-subst">{page}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""启动爬虫任务"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始爬取1688关键词【<span class="hljs-subst">{self.keyword}</span>】，共<span class="hljs-subst">{self.max_page}</span>页"</span>)
        all_data = []
        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, self.max_page + <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在爬取第<span class="hljs-subst">{page}</span>页..."</span>)
            url = self.build_url(page)
            html = self.request.get(url)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> html:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{page}</span>页爬取失败，跳过"</span>)
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 解析数据</span>
            page_data = self.parser.parse(html)
            <span class="hljs-keyword">if</span> page_data:
                all_data.extend(page_data)
                <span class="hljs-comment"># 实时存储</span>
                self.storage.save(page_data)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"爬取完成，总计获取<span class="hljs-subst">{<span class="hljs-built_in">len</span>(all_data)}</span>条商品数据"</span>)

<span class="hljs-comment"># 测试调度器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    scheduler = SpiderScheduler(config)
    scheduler.run()
</code></pre>
<h2 data-id="heading-10">三、工程化配套模块</h2>
<h3 data-id="heading-11">1. 日志系统（Logging）</h3>
<p>替换 print 语句，使用 Python 标准库<code>logging</code>实现分级日志（INFO/ERROR），便于问题排查。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_logger</span>() -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""初始化日志系统"""</span>
    <span class="hljs-comment"># 创建日志目录</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"logs"</span>):
        os.makedirs(<span class="hljs-string">"logs"</span>)
    <span class="hljs-comment"># 配置日志格式</span>
    log_format = <span class="hljs-string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span>
    <span class="hljs-comment"># 写入文件 + 控制台输出</span>
    logging.basicConfig(
        level=logging.INFO,
        <span class="hljs-built_in">format</span>=log_format,
        handlers=[
            logging.FileHandler(<span class="hljs-string">"logs/1688_spider.log"</span>, encoding=<span class="hljs-string">"utf-8"</span>),
            logging.StreamHandler()
        ]
    )

<span class="hljs-comment"># 在调度器中使用日志</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    init_logger()
    logger = logging.getLogger(__name__)
    logger.info(<span class="hljs-string">"爬虫启动"</span>)
    <span class="hljs-keyword">try</span>:
        config = Config()
        scheduler = SpiderScheduler(config)
        scheduler.run()
        logger.info(<span class="hljs-string">"爬虫结束"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"爬虫异常：<span class="hljs-subst">{e}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
</code></pre>
<h3 data-id="heading-12">2. 异常处理体系</h3>
<p>在核心模块中定义<strong>自定义异常</strong>，便于精准捕获和处理不同类型的错误：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># exceptions.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderRequestError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""请求异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderParseError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""解析异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderStorageError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""存储异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 在请求层中抛出自定义异常</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.retry_times):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ... 原有逻辑 ...</span>
            <span class="hljs-keyword">return</span> resp.text
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> retry == self.retry_times - <span class="hljs-number">1</span>:
                <span class="hljs-keyword">raise</span> SpiderRequestError(<span class="hljs-string">f"请求<span class="hljs-subst">{url}</span>失败：<span class="hljs-subst">{e}</span>"</span>)
            time.sleep(<span class="hljs-number">2</span> ** retry)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-13">3. 代理池集成</h3>
<p>对于大规模爬取，可对接第三方代理池（如阿布云、快代理）或自建代理池，通过 API 动态获取可用代理：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_proxy_from_pool</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""从代理池API获取可用代理"""</span>
    proxy_api = <span class="hljs-string">"http://proxy.example.com/get_proxy"</span>
    <span class="hljs-keyword">try</span>:
        resp = requests.get(proxy_api, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-keyword">return</span> resp.json().get(<span class="hljs-string">"proxy"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取代理失败：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h2 data-id="heading-14">四、工程化扩展与最佳实践</h2>
<h3 data-id="heading-15">1. 多线程 / 异步爬取</h3>
<p>针对单线程效率低的问题，可使用<code>concurrent.futures.ThreadPoolExecutor</code>实现多线程，或用<code>aiohttp</code>实现异步爬取（注意 1688 的反爬限制，避免并发过高）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_multi_thread</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""多线程爬取"""</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> executor:  <span class="hljs-comment"># 控制并发数</span>
        executor.<span class="hljs-built_in">map</span>(self.crawl_page, <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, self.max_page + <span class="hljs-number">1</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">crawl_page</span>(<span class="hljs-params">self, page: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""单页爬取逻辑，供线程调用"""</span>
    url = self.build_url(page)
    html = self.request.get(url)
    <span class="hljs-keyword">if</span> html:
        page_data = self.parser.parse(html)
        self.storage.save(page_data)
</code></pre>
<h3 data-id="heading-16">2. 爬虫监控与告警</h3>
<p>通过<code>prometheus</code>+<code>grafana</code>监控爬虫的爬取量、失败率，或通过邮件 / 钉钉机器人在爬虫异常时发送告警：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> smtplib
<span class="hljs-keyword">from</span> email.mime.text <span class="hljs-keyword">import</span> MIMEText

<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_alert_email</span>(<span class="hljs-params">message: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""发送告警邮件"""</span>
    msg = MIMEText(message, <span class="hljs-string">"plain"</span>, <span class="hljs-string">"utf-8"</span>)
    msg[<span class="hljs-string">"Subject"</span>] = <span class="hljs-string">"1688爬虫异常告警"</span>
    msg[<span class="hljs-string">"From"</span>] = <span class="hljs-string">"sender@example.com"</span>
    msg[<span class="hljs-string">"To"</span>] = <span class="hljs-string">"receiver@example.com"</span>

    smtp = smtplib.SMTP_SSL(<span class="hljs-string">"smtp.example.com"</span>, <span class="hljs-number">465</span>)
    smtp.login(<span class="hljs-string">"sender@example.com"</span>, <span class="hljs-string">"password"</span>)
    smtp.sendmail(<span class="hljs-string">"sender@example.com"</span>, [<span class="hljs-string">"receiver@example.com"</span>], msg.as_string())
    smtp.quit()
</code></pre>
<h3 data-id="heading-17">3. 合规与维护</h3>
<ol>
<li><strong>遵守 robots 协议</strong>：1688 的<code>robots.txt</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.1688.com%2Frobots.txt" target="_blank" title="https://www.1688.com/robots.txt" ref="nofollow noopener noreferrer">www.1688.com/robots.txt</a>）明确禁止爬取的路径需严格规避。</li>
<li><strong>定期更新解析规则</strong>：1688 页面结构会频繁变更，需定期检查并调整 CSS 选择器 / XPath。</li>
<li><strong>数据去重与清洗</strong>：通过商品链接、ID 等唯一键去重，对价格、销量等字段做格式清洗（如去除非数字字符）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android开发中的封装思路指导]]></title>    <link>https://juejin.cn/post/7585397173022834707</link>    <guid>https://juejin.cn/post/7585397173022834707</guid>    <pubDate>2025-12-20T01:16:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173022834707" data-draft-id="7585390679398400006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android开发中的封装思路指导"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T01:16:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Poorguy9527"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android开发中的封装思路指导
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Poorguy9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:16:25.000Z" title="Sat Dec 20 2025 01:16:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>面向对象编程中，封装是提升软件系统的手段</p>
</blockquote>
<p>封装是Android开发中提高代码质量、可维护性和可复用性的关键。以下是系统化的封装指导思路：</p>
<h2 data-id="heading-0">一、分层架构思想</h2>
<h3 data-id="heading-1">1. <strong>清晰的分层结构</strong></h3>
<pre><code class="hljs language-text" lang="text">┌─────────────────┐
│     UI层        │ ← Activity/Fragment/View
├─────────────────┤
│   ViewModel层   │ ← ViewModel/Presenter
├─────────────────┤
│   Domain层      │ ← 业务逻辑用例
├─────────────────┤
│   Data层        │ ← Repository/DataSource
├─────────────────┤
│   Model层       │ ← 数据实体/DTO
└─────────────────┘
</code></pre>
<h3 data-id="heading-2">2. <strong>各层职责明确</strong></h3>
<ul>
<li><strong>UI层</strong>: 只处理界面展示和用户交互</li>
<li><strong>ViewModel/Presenter层</strong>: 处理UI逻辑和状态管理</li>
<li><strong>Domain层</strong>: 纯业务逻辑，不依赖Android框架</li>
<li><strong>Data层</strong>: 数据获取和存储</li>
<li><strong>Model层</strong>: 数据结构定义</li>
</ul>
<h2 data-id="heading-3">二、模块化封装原则</h2>
<h3 data-id="heading-4">1. <strong>单一职责原则(SRP)</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不推荐 - 职责过多</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 登录逻辑 */</span> }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logout</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 登出逻辑 */</span> }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveToDatabase</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 数据库操作 */</span> }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadToServer</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 网络请求 */</span> }
}

<span class="hljs-comment">// ✅ 推荐 - 职责分离</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthService</span> { <span class="hljs-comment">/* 认证逻辑 */</span> }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> { <span class="hljs-comment">/* 数据操作 */</span> }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkService</span> { <span class="hljs-comment">/* 网络请求 */</span> }
</code></pre>
<h3 data-id="heading-5">2. <strong>依赖倒置原则(DIP)</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义抽象接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDataSource</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: User
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteUserDataSource</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiService: ApiService
) : UserDataSource {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: User {
        <span class="hljs-keyword">return</span> apiService.getUser(id)
    }
}

<span class="hljs-comment">// 使用依赖注入</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userDataSource: UserDataSource
)
</code></pre>
<h2 data-id="heading-6">三、常用组件封装策略</h2>
<h3 data-id="heading-7">1. <strong>Base基类封装</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span>&lt;<span class="hljs-type">VM : ViewModel</span>&gt; : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> viewModel: VM
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLayoutId</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(getLayoutId())
        initView()
        initObserver()
        initData()
    }
    
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initView</span><span class="hljs-params">()</span></span> {}
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initObserver</span><span class="hljs-params">()</span></span> {}
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initData</span><span class="hljs-params">()</span></span> {}
    
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showLoading</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 统一加载框 */</span> }
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hideLoading</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* 隐藏加载框 */</span> }
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showToast</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> { <span class="hljs-comment">/* 统一Toast */</span> }
}
</code></pre>
<h3 data-id="heading-8">2. <strong>工具类封装</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> NetworkUtils {
    
    <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"MissingPermission"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isNetworkAvailable</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> connectivityManager = context.getSystemService(
            Context.CONNECTIVITY_SERVICE
        ) <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">return</span> connectivityManager.activeNetwork?.let { network -&gt;
            connectivityManager.getNetworkCapabilities(network)?.let { capabilities -&gt;
                capabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||
                capabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR)
            }
        } ?: <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 使用扩展函数优化</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Context.<span class="hljs-title">isNetworkAvailable</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> NetworkUtils.isNetworkAvailable(<span class="hljs-keyword">this</span>)
}
</code></pre>
<h3 data-id="heading-9">3. <strong>View组件封装</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadingButton</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : MaterialButton(context, attrs, defStyleAttr) {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> originalText: CharSequence? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> progressBar = ProgressBar(context).apply {
        layoutParams = LayoutParams(
            LayoutParams.WRAP_CONTENT,
            LayoutParams.WRAP_CONTENT
        )
        isIndeterminate = <span class="hljs-literal">true</span>
        visibility = View.GONE
    }
    
    <span class="hljs-keyword">init</span> {
        addView(progressBar)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showLoading</span><span class="hljs-params">()</span></span> {
        originalText = text
        text = <span class="hljs-string">""</span>
        isEnabled = <span class="hljs-literal">false</span>
        progressBar.visibility = View.VISIBLE
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hideLoading</span><span class="hljs-params">()</span></span> {
        text = originalText
        isEnabled = <span class="hljs-literal">true</span>
        progressBar.visibility = View.GONE
    }
}
</code></pre>
<h2 data-id="heading-10">四、网络请求封装</h2>
<h3 data-id="heading-11">1. <strong>Retrofit + Kotlin协程封装</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"user/{id}"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(<span class="hljs-meta">@Path(<span class="hljs-string">"id"</span>)</span> userId: <span class="hljs-type">String</span>)</span></span>: ApiResponse&lt;User&gt;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiClient</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> BASE_URL = <span class="hljs-string">"https://api.example.com/"</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: ApiService {
            <span class="hljs-keyword">return</span> Retrofit.Builder()
                .baseUrl(BASE_URL)
                .addConverterFactory(GsonConverterFactory.create())
                .client(createOkHttpClient())
                .build()
                .create(ApiService::<span class="hljs-keyword">class</span>.java)
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
            <span class="hljs-keyword">return</span> OkHttpClient.Builder()
                .connectTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
                .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
                .addInterceptor(createInterceptor())
                .addInterceptor(HttpLoggingInterceptor().apply {
                    level = HttpLoggingInterceptor.Level.BODY
                })
                .build()
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createInterceptor</span><span class="hljs-params">()</span></span>: Interceptor {
            <span class="hljs-keyword">return</span> Interceptor { chain -&gt;
                <span class="hljs-keyword">val</span> request = chain.request().newBuilder()
                    .addHeader(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token"</span>)
                    .addHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
                    .build()
                chain.proceed(request)
            }
        }
    }
}

<span class="hljs-comment">// 统一响应封装</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> message: String?,
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T?
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSuccess</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = code == <span class="hljs-number">200</span>
}
</code></pre>
<h2 data-id="heading-12">五、数据库封装（Room）</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity(tableName = <span class="hljs-string">"users"</span>)</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-meta">@PrimaryKey</span> <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-meta">@ColumnInfo(name = <span class="hljs-string">"created_at"</span>)</span> <span class="hljs-keyword">val</span> createdAt: <span class="hljs-built_in">Long</span>
)

<span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> {
    <span class="hljs-meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insert</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span>
    
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM users WHERE id = :userId"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: User?
    
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM users"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAllUsers</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;User&gt;&gt;
}

<span class="hljs-meta">@Database(entities = [User::class], version = 1)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDatabase</span> : <span class="hljs-type">RoomDatabase</span>() {
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userDao</span><span class="hljs-params">()</span></span>: UserDao
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@Volatile</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> INSTANCE: AppDatabase? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: AppDatabase {
            <span class="hljs-keyword">return</span> INSTANCE ?: synchronized(<span class="hljs-keyword">this</span>) {
                INSTANCE ?: buildDatabase(context).also { INSTANCE = it }
            }
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildDatabase</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: AppDatabase {
            <span class="hljs-keyword">return</span> Room.databaseBuilder(
                context.applicationContext,
                AppDatabase::<span class="hljs-keyword">class</span>.java,
                <span class="hljs-string">"app_database"</span>
            ).build()
        }
    }
}
</code></pre>
<h2 data-id="heading-13">六、依赖注入封装</h2>
<h3 data-id="heading-14">1. <strong>使用Hilt/Dagger</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> AppModule {
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideApiService</span><span class="hljs-params">()</span></span>: ApiService {
        <span class="hljs-keyword">return</span> ApiClient.create()
    }
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideUserRepository</span><span class="hljs-params">(
        apiService: <span class="hljs-type">ApiService</span>,
        userDao: <span class="hljs-type">UserDao</span>
    )</span></span>: UserRepository {
        <span class="hljs-keyword">return</span> UserRepository(apiService, userDao)
    }
}

<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> userRepository: UserRepository
    
    <span class="hljs-comment">// 或通过ViewModel注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: MainViewModel <span class="hljs-keyword">by</span> viewModels()
}
</code></pre>
<h3 data-id="heading-15">2. <strong>手动依赖注入（无框架时）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> ServiceLocator {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> services = mutableMapOf&lt;String, Any&gt;()
    
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Any&gt;</span> <span class="hljs-title">register</span><span class="hljs-params">(service: <span class="hljs-type">T</span>)</span></span> {
        services[T::<span class="hljs-keyword">class</span>.java.name] = service
    }
    
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Any&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>: T {
        <span class="hljs-keyword">return</span> services[T::<span class="hljs-keyword">class</span>.java.name] <span class="hljs-keyword">as</span>? T
            ?: <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Service not registered: <span class="hljs-subst">${T::class.java}</span>"</span>)
    }
}

<span class="hljs-comment">// 初始化</span>
ServiceLocator.register(ApiClient.create())
ServiceLocator.register(UserRepository(...))
</code></pre>
<h2 data-id="heading-16">七、配置和常量封装</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> AppConfig {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> API_TIMEOUT = <span class="hljs-number">30L</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> DATABASE_NAME = <span class="hljs-string">"app.db"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> SHARED_PREF_NAME = <span class="hljs-string">"app_prefs"</span>
    
    <span class="hljs-keyword">object</span> Endpoints {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> BASE_URL = <span class="hljs-string">"https://api.example.com/"</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER = <span class="hljs-string">"user/{id}"</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> LOGIN = <span class="hljs-string">"auth/login"</span>
    }
    
    <span class="hljs-keyword">object</span> Preferences {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> KEY_TOKEN = <span class="hljs-string">"token"</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> KEY_USER_ID = <span class="hljs-string">"user_id"</span>
    }
}

<span class="hljs-comment">// 使用BuildConfig管理不同环境</span>
<span class="hljs-keyword">object</span> Environment {
    <span class="hljs-keyword">val</span> BASE_URL = BuildConfig.BASE_URL
    <span class="hljs-keyword">val</span> IS_DEBUG = BuildConfig.DEBUG
    <span class="hljs-keyword">val</span> VERSION_NAME = BuildConfig.VERSION_NAME
}
</code></pre>
<h2 data-id="heading-17">八、错误处理封装</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">out T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> exception: Exception) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandler</span> {
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleError</span><span class="hljs-params">(exception: <span class="hljs-type">Exception</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (exception) {
            <span class="hljs-keyword">is</span> IOException -&gt; <span class="hljs-string">"网络连接失败，请检查网络"</span>
            <span class="hljs-keyword">is</span> HttpException -&gt; <span class="hljs-keyword">when</span> (exception.code()) {
                <span class="hljs-number">401</span> -&gt; <span class="hljs-string">"未授权，请重新登录"</span>
                <span class="hljs-number">404</span> -&gt; <span class="hljs-string">"资源不存在"</span>
                <span class="hljs-number">500</span> -&gt; <span class="hljs-string">"服务器内部错误"</span>
                <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"网络请求失败: <span class="hljs-subst">${exception.message}</span>"</span>
            }
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"未知错误: <span class="hljs-subst">${exception.message}</span>"</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logError</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>, exception: <span class="hljs-type">Exception</span>)</span></span> {
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            Log.e(tag, exception.message, exception)
        }
        <span class="hljs-comment">// 生产环境上报到监控平台</span>
        FirebaseCrashlytics.getInstance().recordException(exception)
    }
}
</code></pre>
<h2 data-id="heading-18">九、测试友好的封装</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用接口便于Mock</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserRepository</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: User?
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveUser</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span>
}

<span class="hljs-comment">// 使用构造函数注入依赖</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userRepository: IUserRepository,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> errorHandler: ErrorHandler
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _userState = MutableStateFlow&lt;Result&lt;User&gt;&gt;(Result.Loading)
    <span class="hljs-keyword">val</span> userState: StateFlow&lt;Result&lt;User&gt;&gt; = _userState
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        _userState.value = Result.Loading
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> user = userRepository.getUser(userId)
            _userState.value = user?.let { Result.Success(it) }
                ?: Result.Error(Exception(<span class="hljs-string">"User not found"</span>))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            _userState.value = Result.Error(e)
            errorHandler.logError(<span class="hljs-string">"UserViewModel"</span>, e)
        }
    }
}
</code></pre>
<h2 data-id="heading-19">十、封装的最佳实践总结</h2>
<h3 data-id="heading-20">1. <strong>遵循SOLID原则</strong></h3>
<ul>
<li>单一职责</li>
<li>开闭原则</li>
<li>里氏替换</li>
<li>接口隔离</li>
<li>依赖倒置</li>
</ul>
<h3 data-id="heading-21">2. <strong>保持适当的封装粒度</strong></h3>
<ul>
<li>避免过度封装（每个方法都单独一个类）</li>
<li>避免封装不足（一个类做所有事情）</li>
</ul>
<h3 data-id="heading-22">3. <strong>考虑可测试性</strong></h3>
<ul>
<li>依赖注入</li>
<li>接口编程</li>
<li>避免静态方法和单例</li>
</ul>
<h3 data-id="heading-23">4. <strong>性能考虑</strong></h3>
<ul>
<li>延迟初始化</li>
<li>缓存策略</li>
<li>避免内存泄漏</li>
</ul>
<h3 data-id="heading-24">5. <strong>文档和注释</strong></h3>
<ul>
<li>公共API必须有文档</li>
<li>复杂逻辑需要注释</li>
<li>保持README更新</li>
</ul>
<h3 data-id="heading-25">6. <strong>版本兼容性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.O)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newApiMethod</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 高版本API实现</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compatibleMethod</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
        newApiMethod()
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 兼容实现</span>
    }
}
</code></pre>
<p>通过以上封装策略，可以提高代码的：</p>
<ul>
<li><strong>可维护性</strong>：结构清晰，易于修改</li>
<li><strong>可测试性</strong>：依赖明确，易于单元测试</li>
<li><strong>可复用性</strong>：组件独立，可在不同项目使用</li>
<li><strong>可读性</strong>：命名规范，逻辑清晰</li>
<li><strong>健壮性</strong>：错误处理完善，边界情况考虑周全</li>
</ul>
<blockquote>
<p>一个开发者，理应有属于自己的一套封装组件，在需要用时，开箱即用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go语言动手写Web框架 - Gee第二天 上下文Context]]></title>    <link>https://juejin.cn/post/7585227038992662566</link>    <guid>https://juejin.cn/post/7585227038992662566</guid>    <pubDate>2025-12-20T02:46:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585227038992662566" data-draft-id="7585382317444775946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go语言动手写Web框架 - Gee第二天 上下文Context"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-20T02:46:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Way2top"/> <meta itemprop="url" content="https://juejin.cn/user/1458388314893300"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go语言动手写Web框架 - Gee第二天 上下文Context
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458388314893300/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Way2top
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:46:47.000Z" title="Sat Dec 20 2025 02:46:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写在前面：本项目参考 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgeektutu.com%2Fpost%2Fgee.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fgeektutu.com%2Fpost%2Fgee.html" target="_blank">7天用Go从零实现Web框架Gee教程</a>，下面的内容全部参考自该网站。主要是记录我在学习过程中的所思所想，如有存在问题还请多多指教。</p>
<p>接下来我们继续优化 Gee，接下来要做的事情是<strong>设计 Context</strong>。</p>
<h4 data-id="heading-0">设计 Context 的必要性</h4>
<ol>
<li><strong>屏蔽底层 HTTP 细节，统一高频且易错的操作</strong></li>
</ol>
<p>在 Day1 中，我们的 Handler 是：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request)</span></span>
</code></pre>
<p>也就意味着，如果我们获取请求报文中的一些字段，比如：</p>
<pre><code class="hljs language-go" lang="go">method := req.Method <span class="hljs-comment">// 获取请求方式</span>
path := req.URL.Path <span class="hljs-comment">// 获取请求资源路径</span>
name := req.URL.Query().Get(<span class="hljs-string">"name"</span>) <span class="hljs-comment">// 获取 Query 参数</span>
age := req.URL.Query().Get(<span class="hljs-string">"age"</span>) <span class="hljs-comment">// 获取 Query 参数</span>

<span class="hljs-comment">// 获取请求头</span>
ua := req.Header.Get(<span class="hljs-string">"User-Agent"</span>)
token := req.Header.Get(<span class="hljs-string">"Authorization"</span>)


<span class="hljs-comment">// 获取 POST 表单参数</span>
err := req.ParseForm()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-comment">// error handling</span>
}
username := req.FormValue(<span class="hljs-string">"username"</span>)
password := req.FormValue(<span class="hljs-string">"password"</span>)
</code></pre>
<p>确实都可以通过 <code>req</code> 拿到，但是问题在于 <code>*http.Request</code> 提供的颗粒度太细了。对Web服务来说，无非是根据请求<code>*http.Request</code>，构造响应<code>http.ResponseWriter</code>。对于开发者来说，如果我想要构造一个完整的响应，要考虑很多东西，例如消息头（Header）和消息体（Body），而 Header 又包含了状态码（StatusCode）和消息类型（ContentType）等几乎每次都需要设置的信息。所以如果不进行有效的封装，那么使用 Day1 的 Gee 框架进行开发的开发者将需要写大量重复且繁杂的代码，而且容易出错。因此，针对常用场景，能够高效构造出 HTTP 响应是一个好的框架必须考虑的点。</p>
<p>举个生活中的例子，想象一下你家要接水用，但是没有水龙头，那么每次想用水，你都需要：</p>
<ul>
<li>自己拧开总阀</li>
<li>判断水压</li>
<li>调节冷热水比例</li>
<li>接一根临时管子</li>
<li>用完再关阀、放压</li>
</ul>
<p>这就相当于：</p>
<pre><code class="hljs language-scss" lang="scss">req<span class="hljs-selector-class">.URL</span><span class="hljs-selector-class">.Query</span>()
req<span class="hljs-selector-class">.ParseForm</span>()
w<span class="hljs-selector-class">.Header</span>()<span class="hljs-selector-class">.Set</span>()
w<span class="hljs-selector-class">.WriteHeader</span>()
w<span class="hljs-selector-class">.Write</span>()
</code></pre>
<p>每次都要重复一套机械的动作，而且一步出错就出问题。</p>
<p>而在安装了水龙头之后，事情就方便的多了，你只需要：</p>
<ul>
<li>拧一下</li>
</ul>
<p>水压、水温、出水路径全部被<strong>预先封装好</strong>。</p>
<p>这就相当于：</p>
<pre><code class="hljs language-javascript" lang="javascript">c.<span class="hljs-title class_">JSON</span>(<span class="hljs-number">200</span>, obj)
c.<span class="hljs-title class_">Query</span>(<span class="hljs-string">"name"</span>)
</code></pre>
<p>在 Day1 中，handler 直接操作 <code>http.Request</code> 和 <code>ResponseWriter</code>，就像每次用水都要自己接水管，步骤繁琐且容易出错；Context 的引入，相当于提供了标准水龙头，将复杂、易错的底层细节封装起来，只暴露简单、稳定的使用方式。</p>
<hr/>
<ol start="2">
<li><strong>作为请求生命周期的统一载体，承载框架扩展能力</strong></li>
</ol>
<p>针对使用场景，封装<code>*http.Request</code>和<code>http.ResponseWriter</code>的方法，简化相关接口的调用，只是设计 Context 的原因之一。对于框架来说，还需要支撑额外的功能，比如说动态路由。</p>
<p>动态路由是一个框架必须支持的功能。假设有这样一种情况，我们做一个用户系统：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span><span class="hljs-keyword">user</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>
<span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span><span class="hljs-keyword">user</span><span class="hljs-operator">/</span><span class="hljs-number">2</span>
<span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span><span class="hljs-keyword">user</span><span class="hljs-operator">/</span><span class="hljs-number">3</span>
</code></pre>
<p>对于每一个新创建的用户，都有一个独立的 URL，而在 Day1 的 Gee 中，对于路由的处理是这样的：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// gee/gee.go</span>
key := req.Method + <span class="hljs-string">"-"</span> + req.URL.Path
handler := engine.router[key]
</code></pre>
<p>拼接出 URL 之后，会去查 Engine 中的路由表，看 URL 是否注册。这样的设计显然存在问题：</p>
<ul>
<li><strong>不可扩展</strong>：每增加一个用户，就要增加一个路由，这显然不现实。</li>
<li><strong>参数提取困难</strong>：假设想在 handler 中获取用户 ID，你必须自己解析 <code>req.URL.Path</code>：</li>
</ul>
<pre><code class="hljs language-go" lang="go">parts := strings.Split(req.URL.Path, <span class="hljs-string">"/"</span>)
userID := parts[<span class="hljs-number">2</span>]
</code></pre>
<p>这个时候就需要动态路由。我们可以把路由设计为 <code>/user/:id</code>，其中 <code>:id</code> 可以匹配任意用户 ID，并且请求 <code>/user/123</code>、<code>/user/456</code> 都能匹配到同一个 handler。</p>
<p>Day1 的静态路由只能匹配固定路径，无法支持路径中带变量的 URL。</p>
<p>再比如，框架需要支持中间件，那中间件产生的信息放在哪呢？Context 随着每一个请求的出现而产生，请求的结束而销毁，和当前请求强相关的信息都应由 Context 承载。因此，设计 Context 结构，扩展性和复杂性留在了内部，而对外简化了接口。路由的处理函数，以及将要实现的中间件，参数都统一使用 Context 实例， Context 就像一次会话的百宝箱，可以找到任何东西。</p>
<p>如果你熟悉 Python，那么我们 Day2 要做的事情就有点·11类似于把 httpx 这个包升级到 request 这个包。Day1 就像直接用低级库写请求，Day2 的 Context 就像给它加了一层高级封装，让你专注业务而不用管协议细节。</p>
<hr/>
<h4 data-id="heading-1">具体实现</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// gee/context.go</span>
<span class="hljs-keyword">package</span> gee

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"encoding/json"</span>
        <span class="hljs-string">"fmt"</span>
        <span class="hljs-string">"net/http"</span>
)

<span class="hljs-keyword">type</span> H <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}

<span class="hljs-keyword">type</span> Context <span class="hljs-keyword">struct</span> {
        Writer     http.ResponseWriter
        Req        *http.Request
        Path       <span class="hljs-type">string</span> <span class="hljs-comment">// 请求资源路径</span>
        Method     <span class="hljs-type">string</span> <span class="hljs-comment">// 请求方式</span>
        StatusCode <span class="hljs-type">int</span>    <span class="hljs-comment">// 状态码</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newContext</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request)</span></span> *Context {
        <span class="hljs-keyword">return</span> &amp;Context{
                Writer: w,
                Req:    req,
                Path:   req.URL.Path,
                Method: req.Method,
        }
}

<span class="hljs-comment">// PostForm 从 POST 表单中获取指定字段的值</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> PostForm(key <span class="hljs-type">string</span>) <span class="hljs-type">string</span> {
        <span class="hljs-keyword">return</span> c.Req.URL.Query().Get(key)
}

<span class="hljs-comment">// Query 从 URL 查询参数中获取指定字段的值。</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> Query(key <span class="hljs-type">string</span>) <span class="hljs-type">string</span> {
        <span class="hljs-keyword">return</span> c.Req.URL.Query().Get(key)
}

<span class="hljs-comment">// Status 设置响应状态码并写入 HTTP Header</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> Status(code <span class="hljs-type">int</span>) {
        c.StatusCode = code
        c.Writer.WriteHeader(code)
}

<span class="hljs-comment">// SetHeader 设置响应头指定字段和值</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> SetHeader(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>) {
        c.Writer.Header().Set(key, value)
}

<span class="hljs-comment">// String 以纯文本格式构造 HTTP 响应并写入客户端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> String(code <span class="hljs-type">int</span>, format <span class="hljs-type">string</span>, values ...<span class="hljs-keyword">interface</span>{}) {
        c.SetHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain"</span>)
        c.Status(code)
        c.Writer.Write([]<span class="hljs-type">byte</span>(fmt.Sprintf(format, values...)))
}

<span class="hljs-comment">// JSON 将对象序列化为 JSON 格式big返回给客户端，同时设置 Content-Type</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> JSON(code <span class="hljs-type">int</span>, obj <span class="hljs-keyword">interface</span>{}) {
        c.SetHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
        c.Status(code)
        encoder := json.NewEncoder(c.Writer)
        <span class="hljs-keyword">if</span> err := encoder.Encode(obj); err != <span class="hljs-literal">nil</span> {
                http.Error(c.Writer, err.Error(), <span class="hljs-number">500</span>)
        }
}

<span class="hljs-comment">// Data 直接写入原始字节数据到响应体，返回给客户端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> Data(code <span class="hljs-type">int</span>, data []<span class="hljs-type">byte</span>) {
        c.Status(code)
        c.Writer.Write(data)
}

<span class="hljs-comment">// HTML 将 HTML 字符串作为响应返回，同时设置 Content-Type 为 text/html</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> HTML(code <span class="hljs-type">int</span>, html <span class="hljs-type">string</span>) {
        c.SetHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/html"</span>)
        c.Status(code)
        c.Writer.Write([]<span class="hljs-type">byte</span>(html))
}
</code></pre>
<p>这部分是实现 Context 的核心逻辑。在代码的开头给 <code>map[string]interface{}</code> 起了一个别名叫 <code>H</code>，这是为了后续在构建 JSON 数据的时候显得更加简洁。</p>
<p>然后我们可以看到 Context 的结构，包含了 <code>http.ResponseWriter</code>和<code>*http.Request</code>，另外提供了对 Method 和 Path 这两个常用属性的直接访问。</p>
<p>剩下的部分，包括提供了访问 Query 和 PostForm 参数的方法，以及提供了快速构造 String/Data/JSON/HTML 响应的方法。</p>
<hr/>
<p>这里提一下 JSON 部分的实现细节：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span></span> JSON(code <span class="hljs-type">int</span>, obj <span class="hljs-keyword">interface</span>{}) {
        c.SetHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
        c.Status(code)
        encoder := json.NewEncoder(c.Writer)
        <span class="hljs-keyword">if</span> err := encoder.Encode(obj); err != <span class="hljs-literal">nil</span> {
                http.Error(c.Writer, err.Error(), <span class="hljs-number">500</span>)
        }
}
</code></pre>
<p>这段代码的关键点并不在 <code>if err := ...</code>，而在这一行：</p>
<pre><code class="hljs language-css" lang="css">encoder := json.<span class="hljs-built_in">NewEncoder</span>(c.Writer)
</code></pre>
<p>我们点进去看 <code>json.NewEncoder</code> 的源码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// NewEncoder returns a new encoder that writes to w.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEncoder</span><span class="hljs-params">(w io.Writer)</span></span> *Encoder {
    <span class="hljs-keyword">return</span> &amp;Encoder{w: w, escapeHTML: <span class="hljs-literal">true</span>}
}
</code></pre>
<p>可以看到，<code>NewEncoder</code> 接受一个 <code>io.Writer</code>，并将其保存到 <code>Encoder</code> 结构体内部的 <code>w</code> 字段中。</p>
<p>也就是说，此时已经建立了这样一个关系：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">enc.w</span> === c.Writer
</code></pre>
<p>而 <code>c.Writer</code> 本质上就是 <code>http.ResponseWriter</code>。</p>
<p>接下来重点看 JSON 实现部分的这一行：</p>
<pre><code class="hljs language-scss" lang="scss">encoder<span class="hljs-selector-class">.Encode</span>(obj)
</code></pre>
<p>这句话比较容易误解为：只有出错时才会写响应。</p>
<p>实际上<strong>恰恰相反</strong>。</p>
<p><code>Encode</code> 的主要逻辑是：<strong>先</strong> <strong>序列化</strong> <strong>，再写响应</strong>，错误只是返回值而已。其简化后的源码逻辑如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(enc *Encoder)</span></span> Encode(v any) <span class="hljs-type">error</span> {
    data, err := json.Marshal(v)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<span class="hljs-keyword">return</span> err
    }
    data = <span class="hljs-built_in">append</span>(data, <span class="hljs-string">'\n'</span>)
    _, err = enc.w.Write(data)<span class="hljs-keyword">return</span> err
}
</code></pre>
<p>这里的执行流程非常关键：</p>
<ol>
<li>
<p><code>json.Marshal(v)</code></p>
<ol>
<li>把 Go 对象转换成 JSON 字节数组</li>
</ol>
</li>
<li>
<p><code>enc.w.Write(data)</code></p>
<ol>
<li><strong>直接把</strong> <strong>JSON</strong> <strong>数据写入到</strong> <strong><code>io.Writer</code></strong></li>
</ol>
</li>
<li>
<p>返回 <code>error</code>（如果有）</p>
</li>
</ol>
<p>注意这一点：</p>
<blockquote>
<p><strong>真正把响应体写出去的，是</strong> <strong><code>enc.w.Write(data)</code></strong> <strong>，而不是</strong> <strong><code>if err != nil</code></strong> <strong>这一行</strong></p>
</blockquote>
<p>而此时：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">enc.w</span> == c.Writer == http.ResponseWriter
</code></pre>
<p>因此：</p>
<pre><code class="hljs language-scss" lang="scss">encoder<span class="hljs-selector-class">.Encode</span>(obj)
</code></pre>
<p>这一行本身就已经完成了 <strong>HTTP 响应体的写入</strong>。</p>
<hr/>
<p><strong>为什么</strong> <strong><code>http.Error</code></strong> <strong>在这里“看起来没什么用”？</strong></p>
<p>因为在调用 <code>Encode</code> 之前，已经执行过：</p>
<pre><code class="hljs language-css" lang="css">c<span class="hljs-selector-class">.Status</span>(<span class="hljs-selector-tag">code</span>) // =&gt; Writer<span class="hljs-selector-class">.WriteHeader</span>(<span class="hljs-selector-tag">code</span>)
</code></pre>
<p>这一步已经往 HTTP 响应缓冲区写入了状态行和响应头。一个关键的规则是：</p>
<ul>
<li><strong>状态码只能写一次</strong></li>
<li><strong>响应体可以在之后多次写入</strong></li>
<li>第一次 <code>Write</code> 发生时，如果还没调用 <code>WriteHeader</code>，Go 会自动补一个 <code>200</code></li>
</ul>
<p>因此，这里的 <code>http.Error</code> 试图在发现错误（将内容转换为 JSON 格式失败）后试图修改响应行来进行挽救，实际上是没有作用的，这也是框架目前存在的一个缺点。</p>
<hr/>
<h4 data-id="heading-2">路由（Router）</h4>
<p>在设计完 Context 之后，对于之前写在 Engine 中的 router 我们也有了一些新的思考：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HandlerFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span>

<span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> {
        router <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]HandlerFunc <span class="hljs-comment">// 路由表</span>
}
</code></pre>
<p>之前的 Router 设计很简单，直接写在 Engine 的内部，handler 参数是原始的 <code>w</code> 和 <code>req</code>，每次请求都需要查询 <code>map[method-path]</code>，这样设计有下面这些缺点：</p>
<ul>
<li>Engine 里面直接管理路由，职责耦合</li>
<li>不支持动态路由 <code>/user/:id</code></li>
<li>扩展中间件或统一参数处理时，路由逻辑很难插手</li>
</ul>
<p>正好我们前面也引入了 Context，使得 Handler 不直接操作 <code>w</code> 和 <code>req</code>，而是操作 <code>*Context</code>，来让 Context 承载生命周期信息（Query、Form、Json 响应等）。</p>
<p><strong>于是引出了一个设计思路：把路由相关逻辑从 Engine 独立出来，形成一个</strong> <strong>Router</strong> <strong>模块。</strong></p>
<p>我们希望：</p>
<ul>
<li>
<p>Engine 只做“框架管控 + ServeHTTP 接口实现”</p>
</li>
<li>
<p>Router 只管“路由注册 + 请求匹配”</p>
</li>
<li>
<p>Context 只管“请求生命周期数据封装”</p>
</li>
</ul>
<p>接下来就是考虑如何将 Router 从 Engine 中隔离出来。我们修改 Engine，不再直接存 map，改为：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> {
    router *router
}
</code></pre>
<p>Router 新增方法：</p>
<pre><code class="hljs language-scss" lang="scss">func (r *router) <span class="hljs-built_in">addRoute</span>(...) <span class="hljs-comment">// 注册路由</span>
func (r *router) <span class="hljs-built_in">handle</span>(c *Context) <span class="hljs-comment">// 根据 Context 查找 handler 并调用</span>
</code></pre>
<p>具体的实现如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> gee

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"log"</span>
        <span class="hljs-string">"net/http"</span>
)

<span class="hljs-keyword">type</span> router <span class="hljs-keyword">struct</span> {
        handlers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]HandlerFunc
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newRouter</span><span class="hljs-params">()</span></span> *router {
        <span class="hljs-keyword">return</span> &amp;router{handlers: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]HandlerFunc)}
}

<span class="hljs-comment">// 注册路由</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *router)</span></span> addRoute(method <span class="hljs-type">string</span>, pattern <span class="hljs-type">string</span>, handler HandlerFunc) {
        log.Printf(<span class="hljs-string">"Route %4s - %s"</span>, method, pattern)
        key := method + <span class="hljs-string">"-"</span> + pattern
        r.handlers[key] = handler
}

<span class="hljs-comment">// 根据 Context 查找 handler 并调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *router)</span></span> handle(c *Context) {
        key := c.Method + <span class="hljs-string">"-"</span> + c.Path
        <span class="hljs-keyword">if</span> handler, ok := r.handlers[key]; ok {
                handler(c)
        } <span class="hljs-keyword">else</span> {
                c.String(http.StatusNotFound, <span class="hljs-string">"404 NOT FOUND: %s\n"</span>, c.Path)
        }
}
</code></pre>
<p>那么把 Engine 的 Router 逻辑隔离出来之后，<code>gee.go</code> 也应该做一个修改，具体如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> gee

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"net/http"</span>
)

<span class="hljs-comment">// HandlerFunc 定义了Gee框架使用的请求处理函数类型</span>
<span class="hljs-keyword">type</span> HandlerFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*Context)</span></span>

<span class="hljs-comment">// Engine 声明一个 Engine 结构体，这个结构体会实现 ServeHTTP 接口</span>
<span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> {
        router *router
}

<span class="hljs-comment">// New 创建 Engine 实例，初始化空的路由表</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span></span> *Engine {
        <span class="hljs-keyword">return</span> &amp;Engine{router: newRouter()}
}

<span class="hljs-comment">// 工具函数，后续 GET 和 POST 会使用这个函数给 engine 的路由表添加路由</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> addRoute(method <span class="hljs-type">string</span>, pattern <span class="hljs-type">string</span>, handler HandlerFunc) {
        engine.router.addRoute(method, pattern, handler)
}

<span class="hljs-comment">// GET 提供给用户注册 GET 请求的便捷方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> GET(pattern <span class="hljs-type">string</span>, handler HandlerFunc) {
        engine.addRoute(<span class="hljs-string">"GET"</span>, pattern, handler)
}

<span class="hljs-comment">// POST 提供给用户注册 POST 请求的便捷方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> POST(pattern <span class="hljs-type">string</span>, handler HandlerFunc) {
        engine.addRoute(<span class="hljs-string">"POST"</span>, pattern, handler)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> Run(addr <span class="hljs-type">string</span>) (err <span class="hljs-type">error</span>) {
        <span class="hljs-keyword">return</span> http.ListenAndServe(addr, engine)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> ServeHTTP(w http.ResponseWriter, req *http.Request) {
        c := newContext(w, req)
        engine.router.handle(c)
}
</code></pre>
<p>这时候我们的框架已经修改好了，对应的我们也该修改一下 main.go，用新的框架来进行测试开发：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"gee"</span>
        <span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        r := gee.New()
        r.GET(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gee.Context)</span></span> {
                c.HTML(http.StatusOK, <span class="hljs-string">"&lt;h1&gt;Hello Gee&lt;/h1&gt;"</span>)
        })
        r.GET(<span class="hljs-string">"/hello"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gee.Context)</span></span> {
                <span class="hljs-comment">// expect /hello?name=ryan</span>
                c.String(http.StatusOK, <span class="hljs-string">"hello %s, you're at %s\n"</span>, c.Query(<span class="hljs-string">"name"</span>), c.Path)
        })

        r.POST(<span class="hljs-string">"/login"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gee.Context)</span></span> {
                c.JSON(http.StatusOK, gee.H{
                        <span class="hljs-string">"username"</span>: c.PostForm(<span class="hljs-string">"username"</span>),
                        <span class="hljs-string">"password"</span>: c.PostForm(<span class="hljs-string">"password"</span>),
                })
        })

        r.Run(<span class="hljs-string">":9999"</span>)
}
</code></pre>
<p>这里可以看到，<code>Handler</code> 的参数变成了 <code>gee.Context</code>，同时提供了 <code>Query/PostForm</code> 参数的功能。同时 <code>gee.Context</code> 封装了 <code>HTML/String/JSON</code> 函数，能够快速构造 HTTP 响应。</p>
<p>运行后，效果一致。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">coding</span>/<span class="hljs-selector-tag">GoProject</span>/<span class="hljs-selector-tag">Gee</span> <span class="hljs-selector-tag">via</span>  <span class="hljs-selector-tag">v1</span><span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.3</span> 
❯ <span class="hljs-selector-tag">curl</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//localhost:9999/hello</span>
<span class="hljs-selector-tag">hello</span> , <span class="hljs-selector-tag">you</span>'<span class="hljs-selector-tag">re</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">hello</span>

<span class="hljs-selector-tag">coding</span>/<span class="hljs-selector-tag">GoProject</span>/<span class="hljs-selector-tag">Gee</span> <span class="hljs-selector-tag">via</span>  <span class="hljs-selector-tag">v1</span><span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.3</span> 
❯ <span class="hljs-selector-tag">curl</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//localhost:9999/     </span>
&lt;<span class="hljs-selector-tag">h1</span>&gt;<span class="hljs-selector-tag">Hello</span> <span class="hljs-selector-tag">Gee</span>&lt;/<span class="hljs-selector-tag">h1</span>&gt;%  
                    
<span class="hljs-selector-tag">coding</span>/<span class="hljs-selector-tag">GoProject</span>/<span class="hljs-selector-tag">Gee</span> <span class="hljs-selector-tag">via</span>  <span class="hljs-selector-tag">v1</span><span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.3</span> 
❯ <span class="hljs-selector-tag">curl</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//localhost:9999/login</span>
<span class="hljs-number">404</span> <span class="hljs-selector-tag">NOT</span> <span class="hljs-selector-tag">FOUND</span>: /<span class="hljs-selector-tag">login</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【麒麟Kylin】cmake-3.16.5 rpm包安装步骤详解 附常见问题]]></title>    <link>https://juejin.cn/post/7585397173022801939</link>    <guid>https://juejin.cn/post/7585397173022801939</guid>    <pubDate>2025-12-20T01:08:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173022801939" data-draft-id="7585400495683256362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【麒麟Kylin】cmake-3.16.5 rpm包安装步骤详解 附常见问题"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-20T01:08:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户613541146016"/> <meta itemprop="url" content="https://juejin.cn/user/1602431422584832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【麒麟Kylin】cmake-3.16.5 rpm包安装步骤详解 附常见问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1602431422584832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户613541146016
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:08:19.000Z" title="Sat Dec 20 2025 01:08:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<ol>
<li>先看看文件在哪</li>
</ol>
<p><strong>安装包下载：</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2F8d4f291511e3" title="https://pan.quark.cn/s/8d4f291511e3" target="_blank" ref="nofollow noopener noreferrer">pan.quark.cn/s/8d4f29151…</a>，一般下载完会在 <strong>下载</strong>​ 目录或者你放的地方，比如：</p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/Downloads/</span>cmake-<span class="hljs-number">3.16</span><span class="hljs-number">.5</span>-<span class="hljs-number">4.</span>p01.<span class="hljs-property">ky10</span>.<span class="hljs-property">x86_64</span>.<span class="hljs-property">rpm</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>你可以先用 <code>ls</code>命令确认一下文件名没错。</p>
<hr/>
<h2 data-id="heading-0">2. 打开终端</h2>
<p>右键桌面选“打开终端”，或者按 <code>Ctrl + Alt + T</code>。</p>
<hr/>
<h2 data-id="heading-1">3. 切到 rpm 文件目录</h2>
<p>比如文件在下载目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/Downloads
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">4. 检查有没有装过 cmake</h2>
<p>可以先敲：</p>
<pre><code class="hljs language-css" lang="css">cmake <span class="hljs-attr">--version</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>如果提示找不到命令，说明没装；如果有版本号，你想换这个版本就继续往下看。</p>
<hr/>
<h2 data-id="heading-3">5. 安装 rpm 包</h2>
<p>直接用系统的包管理工具装：</p>
<pre><code class="hljs">sudo rpm -ivh cmake-3.16.5-4.p01.ky10.x86_64.rpm
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这里 <code>-i</code>是安装，<code>-v</code>显示过程，<code>-h</code>显示进度条。</p>
<p>如果它提示缺依赖，你就得先把缺的包装上，不然装不上。</p>
<p>麒麟系统可以用 yum 或 dnf 自动解决依赖：</p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install ./cmake-3.16.5-4.p01.ky10.x86_64.rpm
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这样它会帮你把需要的依赖一起拉下来装好。</p>
<hr/>
<h2 data-id="heading-4">6. 验证安装</h2>
<p>装完后输入：</p>
<pre><code class="hljs language-css" lang="css">cmake <span class="hljs-attr">--version</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>看到版本号是 3.16.5 就说明 OK 了。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过Cursor分析js安全初体验]]></title>    <link>https://juejin.cn/post/7585377403633483822</link>    <guid>https://juejin.cn/post/7585377403633483822</guid>    <pubDate>2025-12-19T23:21:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585377403633483822" data-draft-id="7585706951582269449" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过Cursor分析js安全初体验"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2025-12-19T23:21:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="观一"/> <meta itemprop="url" content="https://juejin.cn/user/2754692828113043"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过Cursor分析js安全初体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754692828113043/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    观一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T23:21:47.000Z" title="Fri Dec 19 2025 23:21:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>在前端安全扫描中，获取完整的 JavaScript 代码是分析的基础。本文档介绍 Web 应用、H5 应用和快应用三种场景下的 JS 代码获取方法，以及如何使用 Cursor 进行代码分析。</p>
<hr/>
<h2 data-id="heading-1">一、Web 应用代码获取（HAR 方式）</h2>
<h3 data-id="heading-2">1.1 下载网站的完整 HAR 文件</h3>
<p>HAR（HTTP Archive）文件是浏览器将整个网页加载过程的所有网络请求完整记录下来的"抓包日志文件"。它记录了浏览器访问网页时触发的所有 HTTP 请求及详细信息，包括静态资源（JS/CSS/图片）的下载情况。我们下载 HAR 文件后，可以提取网页中的所有资源，其中 JS 是我们最主要的分析对象。</p>
<h4 data-id="heading-3">操作步骤：</h4>
<ol>
<li>
<p><strong>访问目标网站</strong>，打开浏览器开发者工具（F12）</p>
</li>
<li>
<p><strong>选择 Network 面板</strong>，勾选 <strong>Preserve log</strong> 选项</p>
<ul>
<li>勾选后，页面跳转或刷新时，Network 面板中的请求记录不会被清空，会保留下来
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c513361027c14af3a56481d1ece26343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KeC5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766791307&amp;x-signature=EBNwPrXJiAODTmm%2BiZnixnpleVk%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>刷新页面</strong>，让 JS 等资源加载完成</p>
</li>
<li>
<p><strong>点击下载按钮</strong>，导出 HAR 文件</p>
</li>
<li>
<p><strong>下载完成后</strong>，会得到一个 <code>domain.har</code> 的文件</p>
</li>
</ol>
<h3 data-id="heading-4">1.2 还原 HAR 文件中的内容</h3>
<p>使用以下 Python 脚本将 HAR 文件中的所有响应内容还原并保存为文件，保持原始目录结构。</p>
<h4 data-id="heading-5">运行命令：</h4>
<pre><code class="hljs language-bash" lang="bash">python extract_all_from_har.py site.har output_dir
</code></pre>
<h4 data-id="heading-6">Python 脚本代码：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 该文件是把web端加载的har中还原成内容</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlparse
<span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">3</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Usage: python extract_all_from_har.py site.har output_dir"</span>)
    sys.exit(<span class="hljs-number">1</span>)

har_file = sys.argv[<span class="hljs-number">1</span>]
out_root = sys.argv[<span class="hljs-number">2</span>]
os.makedirs(out_root, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">guess_ext</span>(<span class="hljs-params">url_path: <span class="hljs-built_in">str</span>, mime: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-comment"># 如果 URL 自带扩展名，优先用它</span>
    name = os.path.basename(url_path)
    <span class="hljs-keyword">if</span> <span class="hljs-string">"."</span> <span class="hljs-keyword">in</span> name <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> name.endswith(<span class="hljs-string">"."</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
    <span class="hljs-comment"># 否则根据 mimeType 猜一个</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".txt"</span>
    mime = mime.lower()
    <span class="hljs-keyword">if</span> <span class="hljs-string">"javascript"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".js"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"json"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".json"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"html"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".html"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"css"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".css"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"xml"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".xml"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"svg"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".svg"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"plain"</span> <span class="hljs-keyword">in</span> mime:
        <span class="hljs-keyword">return</span> <span class="hljs-string">".txt"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">".txt"</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(har_file, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    har = json.load(f)

count = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> har[<span class="hljs-string">"log"</span>][<span class="hljs-string">"entries"</span>]:
    req = entry.get(<span class="hljs-string">"request"</span>, {})
    res = entry.get(<span class="hljs-string">"response"</span>, {})
    content = res.get(<span class="hljs-string">"content"</span>, {})
    text = content.get(<span class="hljs-string">"text"</span>)

    <span class="hljs-comment"># 没有内容就跳过（很多大文件/二进制在 HAR 里不会带完整内容）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text:
        <span class="hljs-keyword">continue</span>

    url = req.get(<span class="hljs-string">"url"</span>, <span class="hljs-string">""</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> url:
        <span class="hljs-keyword">continue</span>

    parsed = urlparse(url)
    host = parsed.netloc <span class="hljs-keyword">or</span> <span class="hljs-string">"unknown_host"</span>
    path = parsed.path <span class="hljs-keyword">or</span> <span class="hljs-string">"/"</span>
    mime = content.get(<span class="hljs-string">"mimeType"</span>, <span class="hljs-string">""</span>)

    <span class="hljs-comment"># 生成本地文件路径：root/host/path</span>
    <span class="hljs-comment"># 例如：https://a.com/path/to/file.js -&gt; out_root/a.com/path/to/file.js</span>
    <span class="hljs-comment"># 如果 path 以 / 结尾，补一个 index</span>
    <span class="hljs-keyword">if</span> path.endswith(<span class="hljs-string">"/"</span>):
        path = path + <span class="hljs-string">"index"</span>

    <span class="hljs-comment"># 目录 + 文件名拆分</span>
    dir_path, filename = os.path.split(path)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filename:
        filename = <span class="hljs-string">"index"</span>

    <span class="hljs-comment"># 根据 mime 猜扩展名（如果 URL 里没有）</span>
    ext = <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"."</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> filename:
        ext = guess_ext(path, mime)
    filename_full = filename + ext

    out_dir = os.path.join(out_root, host, dir_path.lstrip(<span class="hljs-string">"/"</span>))
    os.makedirs(out_dir, exist_ok=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># 防止重名覆盖：同路径多次响应时加计数后缀</span>
    out_path = os.path.join(out_dir, filename_full)
    <span class="hljs-keyword">if</span> os.path.exists(out_path):
        base, ext2 = os.path.splitext(filename_full)
        out_path = os.path.join(out_dir, <span class="hljs-string">f"<span class="hljs-subst">{base}</span>_<span class="hljs-subst">{count}</span><span class="hljs-subst">{ext2}</span>"</span>)

    <span class="hljs-comment"># 处理可能的 base64 编码</span>
    <span class="hljs-keyword">if</span> content.get(<span class="hljs-string">"encoding"</span>) == <span class="hljs-string">"base64"</span>:
        <span class="hljs-keyword">try</span>:
            data = base64.b64decode(text)
            <span class="hljs-comment"># 尝试按 utf-8 解码成文本，失败就直接写二进制</span>
            <span class="hljs-keyword">try</span>:
                text_decoded = data.decode(<span class="hljs-string">"utf-8"</span>)
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>, errors=<span class="hljs-string">"ignore"</span>) <span class="hljs-keyword">as</span> out:
                    out.write(text_decoded)
            <span class="hljs-keyword">except</span> UnicodeDecodeError:
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out_path, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> out:
                    out.write(data)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[WARN] failed to decode base64 for <span class="hljs-subst">{url}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 直接写文本</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>, errors=<span class="hljs-string">"ignore"</span>) <span class="hljs-keyword">as</span> out:
            out.write(text)

    count += <span class="hljs-number">1</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Saved <span class="hljs-subst">{count}</span> responses to <span class="hljs-subst">{out_root}</span>"</span>)
</code></pre>
<h4 data-id="heading-7">执行结果：</h4>
<p>执行完成后，可以看到网站中的 JS 文件已经被全部下载下来了。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61c2e5ba169e4d099da1e6a12d69ae58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KeC5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766791307&amp;x-signature=XINmr0jHgRcsntP%2BKF0jQAxl4vw%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">二、H5 应用代码获取</h2>
<p>H5 和快应用类型的业务也是通过 JS 实现的，因此也可以通过 Cursor 来分析，只是获取 JS 代码的方式略有不同。</p>
<h3 data-id="heading-9">方式一：直接访问网站（推荐）</h3>
<p>H5 的 JS 代码可以直接访问网站地址，通过和 Web 应用一样的方式获得：</p>
<ol>
<li>使用浏览器直接访问 H5 页面 URL</li>
<li>按照 <strong>"一、Web 应用代码获取"</strong> 的方法，下载 HAR 文件并还原</li>
</ol>
<h3 data-id="heading-10">方式二：Attach 到 WebView 实例（Hybrid 场景）</h3>
<p>当 H5 页面嵌入在 App 的 WebView 中时，可以通过以下方式获取：</p>
<ol>
<li>
<p><strong>开启 WebView 调试</strong></p>
<ul>
<li>在 App 中启用 WebView 调试功能（通常需要在代码中设置 <code>setWebContentsDebuggingEnabled(true)</code>）</li>
</ul>
</li>
<li>
<p><strong>连接 WebView</strong></p>
<ul>
<li>在 Chrome 浏览器中打开 <code>chrome://inspect/#devices</code></li>
<li>找到目标 WebView 实例，点击 <strong>"inspect"</strong> 按钮
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80b23f73e3f94c45bd77616fe8473b5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KeC5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766791307&amp;x-signature=aYvecY0t0kzI1yhdtwVlJR2XRhk%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>手动下载 JS 文件</strong></p>
<ul>
<li>在打开的 DevTools 中，切换到 <strong>Sources</strong> 面板</li>
<li>找到需要分析的 JS 文件，右键选择 <strong>"Save as..."</strong> 保存到本地
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ce7fd319864733a462ccfc954b1b9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KeC5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766791307&amp;x-signature=llRFNrxEVFp9TAT4jYSi31J8ttw%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">为什么不能自动下载 HAR？</h4>
<p>在 Attach 到 WebView 时，Network 面板的事件来自 CDP（Chrome DevTools Protocol）网络域，是映射/转换后的视图，不一定包含完整的响应体。而 Sources 面板通过调试接口（<code>Debugger.getScriptSource</code>）直接从运行时获取脚本源码，因此可以下载。所以需要手动下载 JS，而不是依赖 HAR 导出。</p>
<hr/>
<h2 data-id="heading-12">三、快应用代码获取</h2>
<h3 data-id="heading-13">方式一：有 RPK 包的情况</h3>
<p>直接将快应用的 RPK 包进行解压即可获得完整的代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># RPK 文件本质上是一个 ZIP 压缩包</span>
unzip target_app.rpk -d output_dir
</code></pre>
<h3 data-id="heading-14">方式二：无 RPK 包的情况</h3>
<ol>
<li>
<p><strong>在快应用 App 中加载目标快应用</strong></p>
<ul>
<li>快应用引擎会把快应用的代码下载到本地</li>
</ul>
</li>
<li>
<p><strong>定位快应用包体目录</strong></p>
<ul>
<li>快应用的私有目录通常在：<code>/data/data/com.quick.instant/com.target.demo</code></li>
<li>具体路径可能因快应用引擎而异</li>
</ul>
</li>
<li>
<p><strong>使用 adb 命令导出</strong></p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接设备后，使用 adb pull 导出</span>
adb pull /data/data/com.quick.instant/com.target.demo ./output_dir
</code></pre>
<hr/>
<h2 data-id="heading-15">四、使用 Cursor 进行代码分析</h2>
<h3 data-id="heading-16">4.1 导入项目目录</h3>
<p>将获得的目录（无论是 HAR 还原的、WebView 下载的，还是快应用解压的）导入到 Cursor 中。</p>
<h3 data-id="heading-17">4.2 开始安全分析</h3>
<p>Cursor 可以对整个项目目录进行整体性分析，我们可以充分利用这个能力来识别 JS 中是否存在风险。</p>
<h4 data-id="heading-18">典型分析场景：</h4>
<ol>
<li>
<p><strong>接口加密和签名算法分析</strong></p>
<ul>
<li>识别 API 请求的加密方式</li>
<li>分析签名算法实现</li>
</ul>
</li>
<li>
<p><strong>硬编码敏感信息检测</strong></p>
<ul>
<li>查找硬编码的 Token、API Key、密码等</li>
<li>识别敏感配置信息</li>
</ul>
</li>
<li>
<p><strong>安全漏洞扫描</strong></p>
<ul>
<li>XSS 漏洞分析</li>
<li>开放重定向检测</li>
<li>JSBridge 安全分析（针对 H5）</li>
</ul>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7785c91d467c4916a36212cf6fd67030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KeC5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766791307&amp;x-signature=AQtzvHgnwibAM4yYahJksn1OMZs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-19">实战研究发现：</h4>
<p>Cursor 的分析能力非常强大，基本上可以完成绝大部分的分析工作，极大提升研究效率。</p>
<hr/>
<h2 data-id="heading-20">总结</h2>

























<table><thead><tr><th>应用类型</th><th>代码获取方式</th><th>注意事项</th></tr></thead><tbody><tr><td><strong>Web 应用</strong></td><td>下载 HAR → Python 脚本还原</td><td>确保勾选 Preserve log，完整加载页面</td></tr><tr><td><strong>H5 应用</strong></td><td>方式一：直接访问下载 HAR<br/>方式二：Attach WebView → Sources 手动下载</td><td>WebView 方式需手动下载，无法使用 HAR</td></tr><tr><td><strong>快应用</strong></td><td>方式一：解压 RPK 包<br/>方式二：adb pull 导出</td><td>需要 root 权限或使用 adb</td></tr></tbody></table>
<p>无论使用哪种方式获取代码，最终都可以导入 Cursor 进行统一的安全分析，提高效率。</p>
<hr/>
<h2 data-id="heading-21">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fchromedevtools.github.io%2Fdevtools-protocol%2F" target="_blank" title="https://chromedevtools.github.io/devtools-protocol/" ref="nofollow noopener noreferrer">Chrome DevTools Protocol 文档</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.softwareishard.com%2Fblog%2Fhar-12-spec%2F" target="_blank" title="http://www.softwareishard.com/blog/har-12-spec/" ref="nofollow noopener noreferrer">HAR 格式规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fdevtools%2Fremote-debugging%2Fwebviews%2F" target="_blank" title="https://developer.chrome.com/docs/devtools/remote-debugging/webviews/" ref="nofollow noopener noreferrer">Android WebView 调试指南</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vim查看日志技巧]]></title>    <link>https://juejin.cn/post/7585686247268515849</link>    <guid>https://juejin.cn/post/7585686247268515849</guid>    <pubDate>2025-12-20T00:17:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247268515849" data-draft-id="7585686247268499465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vim查看日志技巧"/> <meta itemprop="keywords" content="VIM"/> <meta itemprop="datePublished" content="2025-12-20T00:17:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="morn_venus"/> <meta itemprop="url" content="https://juejin.cn/user/4125813603073550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vim查看日志技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125813603073550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    morn_venus
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T00:17:40.000Z" title="Sat Dec 20 2025 00:17:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vim查看日志技巧</h2>
<ul>
<li>平常看日志都是用vim来查看，主要是使用vim能够快速打开大文件不卡顿，且搜索迅速，筛选也非常便捷</li>
<li>后来看同事用 <strong>TextAnalysisTool</strong> 查看日志，感觉有些功能还挺实用的，于是想着能不能通过vim也实现这些功能，以下是 <strong>TextAnalysisTool</strong>的常用功能
<ul>
<li>筛选器：支持反选、上色（上色有优先级）</li>
<li>折叠非筛选器命中的行</li>
<li>导出筛选器命中的行到其他文件</li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0245fac9c8443618cfc40517ef19a1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=mfkz%2FC9eK7EXQnQHy9rzU5eOV0w%3D" alt="image.png" loading="lazy"/></li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e73d2d99904fc381300334622e05d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=oAhWZcH%2FP9fXRV%2FI43TuZmnQtSQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h3 data-id="heading-1">模拟 TextAnalysisTool 功能</h3>
<h4 data-id="heading-2">筛选器</h4>
<ul>
<li>
<p><code>:vimgrep /\v(ERROR|WARN)/ %</code>  then <code>:copen</code></p>
<ul>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e6624fb4ff94d539c8a251926af9577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=tUH%2B6cOrqNDgl5X35%2F1o5LIdxQM%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p>染色</p>
<pre><code class="hljs language-bash" lang="bash">syn match LogError /^.*\[ERROR\].*$/
highlight LogError ctermbg=Red

syn match LogWarn /^.*\[WARN\].*$/
highlight LogWarn ctermbg=Yellow

syn match LogInfo /INFO/
highlight <span class="hljs-built_in">link</span> LogInfo Identifier
</code></pre>
<ul>
<li>将以上保存为一个文件比如 <code>color.vim</code>，在打开日志后实用命令: <code>:source color.vim</code> 即可，这样就不用每次都要临时配置颜色方案了。</li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30efd5dd8e764db5bcae19bc84b8ce1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=ptyasKoi30Qaw3K7mtRqlp8Xt0A%3D" alt="image.png" loading="lazy"/></li>
<li>优先级：后定义的优先级比先定义的优先级要高</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">折叠</h4>
<ul>
<li>其实导航窗口已经算是折叠后的效果了，而日志窗口是非折叠的效果，但是vim支持更高级的折叠功能
<ul>
<li><code>:set foldemethod=expr foldexpr=getline(v:lnum)!~'\\v(ERROR\|WARN)'</code></li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78c3d4184ea4b1db39bd2510bf5c10e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=%2BFDJiRJnh90k6zZe5j2Fp2gwL%2Fc%3D" alt="image.png" loading="lazy"/></li>
<li><code>za</code> 切换当前光标处的折叠项的展开和折叠状态</li>
<li><code>zR</code>: 展开所有折叠</li>
<li><code>zM</code>: 收起所有折叠</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">导出</h4>
<ul>
<li>导出非常简单，在导航窗口中执行: <code>:w file_name</code> 即可</li>
</ul>
<h4 data-id="heading-5">持久化</h4>
<ul>
<li>如果每次打开都要做这么一系列操作要烦死了，所以可以将这些操作放到脚本文件<code>log.vim</code>中</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> color.vim
<span class="hljs-built_in">set</span> foldmethod=<span class="hljs-built_in">expr</span> foldexpr=getline(v:lnum)!~<span class="hljs-string">'\\v(ERROR\|WARN)'</span>

vimgrep /\v(ERROR|WARN)/ %
copen
<span class="hljs-built_in">source</span> color.vim
</code></pre>
<ul>
<li>运行完: <code>:source log.vim</code> 的效果图
<ul>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf0756b21d74d32a209efc7ced12dd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=fb9c9Kz9w%2Bx0LcgYlnk5iW3yttM%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">blend</h3>
<ul>
<li>如果觉得背景色太碍眼了，可以设置前景色: <code>ctermbg</code> 改为 <code>ctermfg</code>
<ul>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95bda81442cf4578a7172c8298b1366f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ybl92ZW51cw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766794660&amp;x-signature=it447k08YGZy0i3twASadxv%2BO5Q%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-189 Nginx JSON 日志接入 ELK：ZK+Kafka+Elasticsearch 7.3.0+Kibana 实战搭建]]></title>    <link>https://juejin.cn/post/7585410547337363506</link>    <guid>https://juejin.cn/post/7585410547337363506</guid>    <pubDate>2025-12-20T01:06:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547337363506" data-draft-id="7585706951582367753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-189 Nginx JSON 日志接入 ELK：ZK+Kafka+Elasticsearch 7.3.0+Kibana 实战搭建"/> <meta itemprop="keywords" content="后端,大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T01:06:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-189 Nginx JSON 日志接入 ELK：ZK+Kafka+Elasticsearch 7.3.0+Kibana 实战搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:06:19.000Z" title="Sat Dec 20 2025 01:06:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 Nginx 产生日志，走 Zookeeper+Kafka 汇聚，写入 Elasticsearch，Kibana 可视化</li>
<li>结论：先把 Nginx access_log 规范为 JSON，后续采集解析成本最低、吞吐最稳</li>
<li>产出：可复现的最小链路（Nginx→Kafka→ES→Kibana）与常见故障速查表</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4702f4260124389bb15248feeca06c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=bPMUpAedI%2FALKrFpo%2BfB2xoZTPg%3D" alt="大数据-189 Nginx JSON 日志接入 ELK：ZK+Kafka+Elasticsearch 7.3.0+Kibana 实战搭建" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>















































<table><thead><tr><th>组件</th><th>版本</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>Nginx</td><td>apt 安装版（随发行版变化）</td><td>部分</td><td>关键在 <code>log_format json</code> 与 <code>access_log ... json;</code> 生效；版本不影响该用法主路径</td></tr><tr><td>Zookeeper</td><td>未注明</td><td>部分</td><td>需三节点分别 <code>zkServer.sh start</code>；注意服务用户、JAVA_HOME、数据目录一致性</td></tr><tr><td>Kafka</td><td>2.12-2.7.2</td><td>是</td><td>以 <code>kafka-server-start.sh -daemon .../server.properties</code> 启动；依赖可用的 ZK/或配置到位</td></tr><tr><td>Elasticsearch</td><td>7.3.0</td><td>是</td><td><code>.../elasticsearch -d</code>；注意 <code>vm.max_map_count</code>、权限、bootstrap check</td></tr><tr><td>Kibana</td><td>7.3.0</td><td>是</td><td>必须与 ES 主版本一致；<code>bin/kibana</code> 前台运行，建议配进程守护</td></tr><tr><td>日志格式</td><td>Nginx JSON（自定义字段）</td><td>是</td><td>以 JSON 直出降低后续解析成本；字段命名建议稳定（见速查卡）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad0e46f949549ad869c8e1a893ee24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=xEVeStD7HpNfUYIowDwrB%2B%2BQGeM%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">整体架构</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd01dd5571643d0be8d5d52973dd7c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=3zVNpnJz1%2BtbamVWJM3rqOpZAVU%3D" alt="整体的处理架构" loading="lazy"/></p>
<h2 data-id="heading-3">Nginx</h2>
<p>Nginx 是一个高性能的 HTTP 和反向代理服务器，同时也能作为 IMAP/POP3 邮件代理服务器使用。它最初由 Igor Sysoev 于 2004 年开发，目的是解决高并发情况下的 C10K 问题，即同时处理 1 万个客户端连接的问题。Nginx 采用了事件驱动架构，能够使用较少的资源处理大量并发请求，因此在静态资源服务、反向代理、负载均衡等场景中表现得尤为出色。</p>
<p>Nginx 的主要功能包括：</p>
<ul>
<li>静态资源服务：Nginx 可以非常高效地处理静态文件的请求，如 HTML、CSS、JavaScript、图片等，适合作为前端服务器。</li>
<li>反向代理：Nginx 可以作为反向代理，将客户端请求转发到后端服务器处理，再将响应返回给客户端。它支持 HTTP 和 HTTPS 协议，能够帮助隐藏后端服务器，增强安全性。</li>
<li>负载均衡：Nginx 支持多种负载均衡算法，如轮询、加权轮询、IP 哈希等。它可以将流量分发到多个后端服务器，提高系统的可靠性和可扩展性。</li>
<li>缓存：Nginx 可以缓存后端服务器的响应，减少对后端服务器的请求压力，提升性能。</li>
<li>高并发支持：由于采用异步非阻塞的事件驱动模型，Nginx 可以处理非常高的并发连接，适合大规模网站的流量处理需求。</li>
<li>模块化设计：Nginx 支持多种模块，如 gzip 压缩、SSL/TLS 加密、访问控制、连接限制等，方便定制和扩展。</li>
</ul>
<h3 data-id="heading-4">配置Nginx</h3>
<p>我这里直接用工具安装了，你也可以采用源码编译的方式等。</p>
<pre><code class="hljs language-shell" lang="shell">apt install nginx
</code></pre>
<p>安装完毕后，我们要修改一下Nginx的配置内容：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">可能不一样</span>
vim /etc/nginx/nginx.conf
</code></pre>
<p>原来的内容如下图所示，我们要修改内容：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dade12635ff4405a48c78f32686a70a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=HgHnpiUjhL%2BmBeKSyGX2%2Bmjh7hQ%3D" alt="配置Nginx" loading="lazy"/>
修改日志的格式（方便后续的Logstash进行解析，虽然Logstash可以通过正则的方式来实现字段的提取，但是效率并不高）。</p>
<pre><code class="hljs language-shell" lang="shell">log_format json '{ "@timestamp": "$time_iso8601", '
                '"remote_addr": "$remote_addr", '
                '"remote_user": "$remote_user", '
                '"body_bytes_sent": "$body_bytes_sent", '
                '"request_time": "$request_time", '
                '"status": "$status", '
                '"request_uri": "$request_uri", '
                '"request_method": "$request_method", '
                '"http_referrer": "$http_referer", '
                '"http_x_forwarded_for": "$http_x_forwarded_for", '
                '"http_user_agent": "$http_user_agent"}';
access_log logs/access.log json;
</code></pre>
<p>修改的对应的截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d161aa59c8a4e528b192fd4cde2b0fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=dqgGv4K3HIT5U5xFW8oNl4AbIGM%3D" alt="配置Nginx的Config" loading="lazy"/>
同时我们监听一个别的端口，必须8888</p>
<pre><code class="hljs language-shell" lang="shell">server {
    listen 8888;
    server_name localhost;
    location / {
            root html;
            index index.html index.htm;
    }
}
</code></pre>
<p>这部分的截图为：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b66579debb94564839a86f4e765600f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=mH3k4YSkc%2FTDP5SMUVsBpz38Ivg%3D" alt="修改服务" loading="lazy"/></p>
<h3 data-id="heading-5">重启Nginx</h3>
<pre><code class="hljs language-shell" lang="shell">nginx -s reload
</code></pre>
<h3 data-id="heading-6">访问页面</h3>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:8888/
</code></pre>
<p>我们多访问几次，可以看到后台的日志的内容：</p>
<pre><code class="hljs language-shell" lang="shell">root@h121:/opt/wzk/logs# tail -f access.log 
{ "@timestamp": "2024-08-19T14:24:39+08:00", "remote_addr": "223.80.101.21", "remote_user": "-", "body_bytes_sent": "0", "request_time": "0.000", "status": "304", "request_uri": "/", "request_method": "GET", "http_referrer": "-", "http_x_forwarded_for": "-", "http_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"}
{ "@timestamp": "2024-08-19T14:24:39+08:00", "remote_addr": "223.80.101.21", "remote_user": "-", "body_bytes_sent": "0", "request_time": "0.000", "status": "304", "request_uri": "/", "request_method": "GET", "http_referrer": "-", "http_x_forwarded_for": "-", "http_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"}
{ "@timestamp": "2024-08-19T14:24:43+08:00", "remote_addr": "223.80.101.21", "remote_user": "-", "body_bytes_sent": "396", "request_time": "0.000", "status": "200", "request_uri": "/", "request_method": "GET", "http_referrer": "-", "http_x_forwarded_for": "-", "http_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"}
{ "@timestamp": "2024-08-19T14:24:43+08:00", "remote_addr": "223.80.101.21", "remote_user": "-", "body_bytes_sent": "197", "request_time": "0.000", "status": "404", "request_uri": "/favicon.ico", "request_method": "GET", "http_referrer": "http://h121.wzk.icu:8888/", "http_x_forwarded_for": "-", "http_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"}
{ "@timestamp": "2024-08-19T14:24:44+08:00", "remote_addr": "223.80.101.21", "remote_user": "-", "body_bytes_sent": "0", "request_time": "0.000", "status": "304", "request_uri": "/", "request_method": "GET", "http_referrer": "-", "http_x_forwarded_for": "-", "http_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"}
</code></pre>
<p>对应的截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07317d06ce424879970ccfe32ab28c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766797579&amp;x-signature=f23oWeX%2FsfvYVNftUxmubYq7fDU%3D" alt="查看Nginx的日志" loading="lazy"/></p>
<h2 data-id="heading-7">Zookeeper</h2>
<p>Zookeeper 是一个分布式协调服务，用于分布式应用程序中的配置管理、命名服务、分布式同步和集群管理等功能。它提供了一种简单但可靠的机制，能够协调多个服务器之间的状态，使得分布式系统可以像单个系统一样进行管理。Zookeeper 的核心理念是通过一个树状的目录结构来存储配置信息，类似于文件系统，每个节点称为 znode。</p>
<p>Zookeeper 的主要功能包括：</p>
<ul>
<li>命名服务：Zookeeper 能够存储和提供分布式系统中的资源名称信息，例如分布式集群中的服务器名称和地址。</li>
<li>配置管理：Zookeeper 可以实时跟踪和分发配置数据，确保分布式系统中的各个节点拥有一致的配置状态。</li>
<li>分布式同步：Zookeeper 提供了一种原语，帮助分布式系统中的节点在操作时保持同步，避免数据冲突和竞争条件。</li>
<li>集群管理：Zookeeper 能够监控集群中节点的存活状态，提供节点的动态加入、移除以及失败恢复的功能。</li>
</ul>
<p>我们需要去启动 ZooKeeper 的集群服务，需要在：</p>
<ul>
<li>h121</li>
<li>h122</li>
<li>h123
上述节点分别启动 ZK 服务：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">zkServer.sh start
</code></pre>
<h2 data-id="heading-8">Kafka</h2>
<p>Kafka 是由 LinkedIn 开发的一个分布式流处理平台，现由 Apache 基金会维护。Kafka 最初是为了处理 LinkedIn 内部的大规模数据流而设计的，现在已成为各类企业用于处理实时数据流的重要工具。</p>
<p>Kafka 的优势包括：</p>
<ul>
<li>高吞吐量：Kafka 能够处理大量的数据流，支持低延迟的实时消息处理。</li>
<li>持久化存储：消息存储在磁盘上，可以设置保留策略来控制消息的生命周期。</li>
<li>可扩展性：Kafka 通过增加分区和 Broker 来水平扩展，无需中断服务。</li>
<li>容错性：通过副本机制，Kafka 可以在部分 Broker 失效的情况下仍然继续运行。</li>
</ul>
<p>我们需要去启动Kafka的集群服务，需要在：</p>
<ul>
<li>h121</li>
<li>h122</li>
<li>h123
上述节点分别启动 Kafka 服务：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">kafka-server-start.sh -daemon /opt/servers/kafka_2.12-2.7.2/config/server.properties
</code></pre>
<h2 data-id="heading-9">Elasticsearch</h2>
<p>Elasticsearch 是一个分布式、RESTful 搜索和分析引擎，基于 Apache Lucene 开发。它能够快速存储、搜索和分析大量数据，广泛应用于日志处理、全文搜索、数据分析等场景。</p>
<p>Elasticsearch 通常和其他工具如 Logstash 和 Kibana 一起使用，组成 ELK（Elasticsearch、Logstash、Kibana）堆栈，来实现从日志采集、处理到可视化展示的一体化解决方案。</p>
<p>我们需要去启动Elasticsearch的集群服务，需要在：</p>
<ul>
<li>h121</li>
<li>h122</li>
<li>h123
上述节点分别启动 Elasticsearch 服务：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">su es_server
/opt/servers/elasticsearch-7.3.0/bin/elasticsearch -d
</code></pre>
<h2 data-id="heading-10">Kibana</h2>
<p>Kibana 是一个开源的数据可视化和探索工具，专门为 Elasticsearch 设计，用来帮助用户对存储在 Elasticsearch 中的数据进行实时分析、可视化和管理。它提供了一个图形用户界面，用户可以轻松地创建不同类型的图表、仪表盘、以及数据监控工具，快速获取关键信息。</p>
<p>核心功能和特点：</p>
<ul>
<li>数据可视化：Kibana 支持创建多种图表，包括条形图、折线图、饼图、地理图等。用户可以通过拖拽界面元素，将复杂的数据转换为可读性强的可视化图表。</li>
<li>仪表盘：Kibana 允许用户将多个图表、地图、搜索结果组合成一个统一的仪表盘，以便实时监控系统运行状态或者追踪特定指标。仪表盘可以进行动态更新，显示最新的数据。</li>
<li>数据探索：用户可以使用 Kibana 的 Discover 功能，快速搜索、过滤和浏览 Elasticsearch 中的文档。通过 Kibana 提供的查询语言（例如 Lucene 查询语法或 Elasticsearch Query DSL），用户可以灵活地筛选所需的数据。</li>
<li>时间序列分析：Kibana 提供了强大的时间序列数据分析工具（如 Timelion 和 TSVB），可以帮助用户分析和展示按时间顺序排列的数据，适用于日志分析和监控系统性能。</li>
<li>安全与用户管理：在集成了 Elasticsearch 的 X-Pack 安全模块后，Kibana 可以实现细粒度的权限控制和用户管理。用户可以对不同的团队或用户分配不同的访问权限，确保数据安全。</li>
<li>报警与通知：Kibana 的 Alerting 功能允许用户设置告警规则，当监控的数据达到特定阈值时，自动触发通知（例如通过电子邮件或 webhook 发送告警信息）。</li>
<li>交互式地图：Kibana 提供了地理空间可视化功能，用户可以将地理数据绘制在交互式地图上，适合进行地理信息系统（GIS）相关的分析和展示。</li>
</ul>
<p>我们需要启动Kibana服务，这里我是启动了 h122 节点。</p>
<pre><code class="hljs language-shell" lang="shell">su es_server
cd /opt/servers/kibana-7.3.0-linux-x86_64
bin/kibana
</code></pre>
<h2 data-id="heading-11">错误速查</h2>

































































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>nginx -s reload 报错或不生效</td><td>配置语法错误/文件路径不对</td><td>nginx -t 看具体行号；先 nginx -t 通过再 reload；确认编辑的是实际生效的 nginx.conf/包含文件</td></tr><tr><td>access.log 不是 JSON 或字段缺失</td><td>log_format 未被引用/access_log 仍指向默认格式</td><td>查 access_log 指向与格式名；看生成内容；access_log  json; 与 log_format json '...' 名称一致；避免引号/逗号拼接错误</td></tr><tr><td>access_log logs/access.log 找不到或无写入</td><td>相对路径不在预期目录/权限不足</td><td>nginx -V 看 prefix；检查目录权限；改为绝对路径（如 /var/log/nginx/access_json.log）；确保目录可写</td></tr><tr><td>8888 端口访问失败</td><td>server 块未被 include/被防火墙拦/监听冲突</td><td><code>ss -lntp | grep 8888</code>、检查 include</td></tr><tr><td>日志里大量 304/0 bytes</td><td>浏览器缓存命中</td><td>对比 status=304、body_bytes_sent=0属正常；压测或 curl 时加禁缓存参数以验证写入</td></tr><tr><td>/favicon.ico 404</td><td>静态站点未提供图标</td><td>日志 request_uri=/favicon.ico属正常；需要可补 favicon 文件或单独 location 处理</td></tr><tr><td>zkServer.sh start 失败</td><td>JAVA_HOME/权限/数据目录问题</td><td>查 zookeeper.out/日志；设置 JAVA_HOME；确保 dataDir 可写；统一 myid 与配置</td></tr><tr><td>Kafka 启动失败或反复重启</td><td>ZK 未就绪/zookeeper.connect 错/端口不通</td><td>Kafka 日志、telnet ZK 端口；先确保 ZK 集群健康；核对 connect 字符串与网络连通</td></tr><tr><td>ES 启动报 bootstrap checks</td><td>内核参数/内存锁/文件句柄不足</td><td>ES 日志提示项常见：设置 vm.max_map_count、提升 ulimit、配置 heap 与权限</td></tr><tr><td>Kibana 连接不上 ES</td><td>版本不匹配/elasticsearch.hosts 配置错/ES 未起来</td><td>Kibana 控制台日志、访问 ES 端口；保证 Kibana 7.3.0 对 ES 7.3.0；修正 hosts；先验证 curl ES</td></tr><tr><td>后续解析成本高、字段漂移</td><td>JSON 字段命名随意/类型不稳定（数字变字符串）</td><td>对比多条日志同字段类型；固定字段集合与命名；数值字段尽量保持数值语义（如 request_time/body_bytes_sent）</td></tr></tbody></table>
<h2 data-id="heading-12">其他系列</h2>
<h3 data-id="heading-13">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-14">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-196 消息队列选型：RabbitMQ vs RocketMQ vs Kafka</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-15">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 实现 PDF 文档压缩：完整指南]]></title>    <link>https://juejin.cn/post/7585377403632779310</link>    <guid>https://juejin.cn/post/7585377403632779310</guid>    <pubDate>2025-12-19T10:39:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585377403632779310" data-draft-id="7585180775706181659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 实现 PDF 文档压缩：完整指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-19T10:39:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户372157426135"/> <meta itemprop="url" content="https://juejin.cn/user/1250599264325244"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 实现 PDF 文档压缩：完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1250599264325244/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户372157426135
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T10:39:09.000Z" title="Fri Dec 19 2025 10:39:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常办公、电子档案管理和文档传输中，PDF 文件因其格式固定、兼容性强而被广泛使用。然而，随着文档内容丰富、图片和图表增多，PDF 文件体积往往会变得很大，导致上传、分享和存储效率降低。如何在保证文档可读性的前提下减小 PDF 文件大小，成为实际应用中常见的问题。</p>
<p>本文将介绍如何使用 <strong>Python</strong> 对 PDF 文档进行压缩，帮助开发者高效处理 PDF 文件。</p>
<h2 data-id="heading-0">一、为什么需要压缩 PDF</h2>
<ul>
<li><strong>节省存储空间</strong>：大型 PDF 文件占用大量磁盘空间，尤其在企业文档管理系统中，存储成本明显增加。</li>
<li><strong>提高传输效率</strong>：邮件或在线传输大文件容易失败，压缩 PDF 可加快上传和下载速度。</li>
<li><strong>提升用户体验</strong>：用户在打开大文件时可能出现卡顿，压缩后的 PDF 更易于阅读和浏览。</li>
<li><strong>满足系统限制</strong>：某些网站或系统对上传文件大小有限制，压缩 PDF 是必要操作。</li>
</ul>
<h2 data-id="heading-1">二、安装与环境准备</h2>
<p>在使用 Python 对 PDF 文档进行压缩之前，需要准备相应的 PDF 处理工具库。本文所使用的是Spire.PDF for Python，该类库可以帮助开发者直接对 PDF 中的文本、图片和字体进行操作，无需依赖第三方软件即可实现文件压缩、优化和保存。</p>
<p>安装方式很简单，可以通过 Python 的包管理工具 pip 快速完成：</p>
<pre><code class="hljs">pip install spire.pdf
</code></pre>
<p>安装完成后，即可在代码中导入 spire.pdf 模块，进行 PDF 压缩、合并、拆分、加密等操作。</p>
<h2 data-id="heading-2">三、单文件压缩示例</h2>
<p>下面示例演示如何加载单个 PDF 文件，并设置图像压缩和质量参数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.pdf <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 加载 PDF 文件</span>
compressor = PdfCompressor(<span class="hljs-string">"C:/Users/Administrator/Documents/示例.pdf"</span>)

<span class="hljs-comment"># 获取压缩设置</span>
options = compressor.OptimizationOptions

<span class="hljs-comment"># 启用图片缩放</span>
options.SetResizeImages(<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 启用图片压缩</span>
options.SetIsCompressImage(<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 设置图片压缩质量（低/中/高）</span>
options.SetImageQuality(ImageQuality.Medium)

<span class="hljs-comment"># 执行压缩并保存</span>
compressor.CompressToFile(<span class="hljs-string">"压缩.pdf"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"PDF 压缩完成，文件已保存为 压缩.pdf"</span>)
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>SetResizeImages(True)：启用对 PDF 内嵌图片进行缩放，减少尺寸</li>
<li>SetIsCompressImage(True)：启用图片压缩</li>
<li>SetImageQuality(ImageQuality.Medium)：设置压缩质量，Low、Medium、High可选</li>
<li>CompressToFile：执行压缩并保存到指定路径</li>
</ul>
<h2 data-id="heading-3">四、压缩字体示例</h2>
<p>在某些 PDF 中，嵌入字体可能占用大量空间。压缩或取消嵌入字体可以显著减少文件的大小：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.pdf <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 加载 PDF 文件</span>
compressor = PdfCompressor(<span class="hljs-string">"C:/Users/Administrator/Documents/示例.pdf"</span>)

<span class="hljs-comment"># 获取压缩设置</span>
options = compressor.OptimizationOptions

<span class="hljs-comment"># 启用字体压缩</span>
options.SetIsCompressFonts(<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 可选：取消嵌入字体</span>
<span class="hljs-comment"># options.SetIsUnembedFonts(True)</span>

<span class="hljs-comment"># 执行压缩并保存</span>
compressor.CompressToFile(<span class="hljs-string">"压缩_fonts.pdf"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"PDF 字体压缩完成"</span>)
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>启用字体压缩可减少字体占用空间</li>
<li>取消嵌入字体可进一步压缩，但可能影响 PDF 在其他系统上的显示效果</li>
</ul>
<h2 data-id="heading-4">五、批量压缩 PDF 示例</h2>
<p>在实际工作中，可能需要压缩一个目录下的所有 PDF 文件，可以结合 Python 的 os 模块实现：</p>
<pre><code class="hljs language-ini" lang="ini">import os
from spire.pdf import *

<span class="hljs-attr">input_folder</span> = <span class="hljs-string">"C:/Users/Administrator/Documents/PDFs"</span>
<span class="hljs-attr">output_folder</span> = <span class="hljs-string">"C:/Users/Administrator/Documents/CompressedPDFs"</span>

os.makedirs(output_folder, <span class="hljs-attr">exist_ok</span>=<span class="hljs-literal">True</span>)

for filename in os.listdir(input_folder):
    if filename.endswith(".pdf"):
        <span class="hljs-attr">input_path</span> = os.path.join(input_folder, filename)
        <span class="hljs-attr">output_path</span> = os.path.join(output_folder, filename)

        <span class="hljs-attr">compressor</span> = PdfCompressor(input_path)
        <span class="hljs-attr">options</span> = compressor.OptimizationOptions
        options.SetResizeImages(True)
        options.SetIsCompressImage(True)
        options.SetImageQuality(ImageQuality.Medium)
        options.SetIsCompressFonts(True)

        compressor.CompressToFile(output_path)
        print(f"{filename} 已压缩完成")
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>自动遍历文件夹内所有 PDF 文件</li>
<li>可统一设置图像压缩和字体压缩参数</li>
<li>输出路径可自定义，便于管理</li>
<li>对大量文件，可结合多线程提高效率</li>
</ul>
<h2 data-id="heading-5">六、压缩注意事项</h2>
<ul>
<li><strong>压缩与清晰度</strong>：过度压缩图像可能降低阅读体验，应根据实际需求选择合适质量。</li>
<li><strong>字体嵌入</strong>：取消嵌入字体可以减小文件，但可能导致在其他系统显示异常。</li>
<li><strong>备份原始文件</strong>：在批量压缩前，建议保留原始文件以防压缩效果不理想。</li>
<li><strong>性能优化</strong>：批量处理大量文件时，可使用多线程或分批处理，减少阻塞。</li>
<li><strong>兼容性</strong>：确保 PDF 文件不是加密或受保护的，否则压缩可能失败。</li>
</ul>
<h2 data-id="heading-6">七、总结</h2>
<p>使用 Python，开发者可以高效实现 PDF 文件压缩，无需依赖其他工具或软件。无论是单个文件还是批量处理，都可以通过简单几行代码完成。掌握这些方法后，可以大幅减少 PDF 文件体积，提高文件传输、存储和浏览效率，是文档管理和办公自动化中非常实用的技术手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《别再写满屏的if-else了！Spring Boot + 策略模式实战优化》]]></title>    <link>https://juejin.cn/post/7585377403632795694</link>    <guid>https://juejin.cn/post/7585377403632795694</guid>    <pubDate>2025-12-19T10:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585377403632795694" data-draft-id="7585406229167390770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《别再写满屏的if-else了！Spring Boot + 策略模式实战优化》"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-19T10:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张工摆Bug"/> <meta itemprop="url" content="https://juejin.cn/user/960304533736219"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《别再写满屏的if-else了！Spring Boot + 策略模式实战优化》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/960304533736219/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张工摆Bug
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T10:41:35.000Z" title="Fri Dec 19 2025 10:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《别再写满屏的if-else了！Spring Boot + 策略模式实战优化》</h2>
<p>哈喽，小伙伴们！今天我们来聊聊一个让很多程序员头疼的问题——满屏幕的if-else语句。相信大家都见过那种一个方法里嵌套了十几层if-else的代码吧？不仅难维护，新加一个条件还得小心翼翼。今天我就给大家带来一个超实用的解决方案：Spring Boot + 策略模式实战优化！</p>
<h3 data-id="heading-1">一、问题场景：支付业务中的if-else地狱</h3>
<p>假设我们有个电商系统，需要支持多种支付方式：支付宝、微信支付、银联支付。很多同学可能会这样写：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PaymentService</span> {
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">pay</span>(<span class="hljs-params">String payType, BigDecimal amount</span>)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"alipay"</span>.<span class="hljs-keyword">equals</span>(payType)) {
            <span class="hljs-comment">// 支付宝支付</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"使用支付宝支付："</span> + amount);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"支付宝支付成功"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"wechat"</span>.<span class="hljs-keyword">equals</span>(payType)) {
            <span class="hljs-comment">// 微信支付</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"使用微信支付："</span> + amount);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"微信支付成功"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"unionpay"</span>.<span class="hljs-keyword">equals</span>(payType)) {
            <span class="hljs-comment">// 银联支付</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"使用银联支付："</span> + amount);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"银联支付成功"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"支付方式错误"</span>);
        }
    }
}
</code></pre>
<p>看起来是不是很熟悉？如果再加个“云闪付”、“数字货币支付”，这个方法就会越来越臃肿！</p>
<h3 data-id="heading-2">二、策略模式登场：优雅解决方案</h3>
<h4 data-id="heading-3">2.1 什么是策略模式？</h4>
<p>简单说，策略模式就是定义一系列算法，把它们封装起来，并且使它们可以相互替换。这样，算法的变化就不会影响到使用算法的客户端。</p>
<h4 data-id="heading-4">2.2 三步改造法</h4>
<h5 data-id="heading-5">第一步：定义策略接口</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface PaymentStrategy {
    <span class="hljs-comment">/**
     * 支付类型
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">/**
     * 支付方法
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">pay</span><span class="hljs-params">(BigDecimal amount)</span></span>;
}
</code></pre>
<h5 data-id="heading-6">第二步：实现具体策略</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"alipay"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">BigDecimal amount</span>) {
        <span class="hljs-comment">// 这里写真实的支付宝支付逻辑</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"执行支付宝支付，金额："</span> + amount);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"支付宝支付成功，金额："</span> + amount;
    }
}
​
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatPayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"wechat"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">BigDecimal amount</span>) {
        <span class="hljs-comment">// 微信支付逻辑</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"执行微信支付，金额："</span> + amount);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"微信支付成功，金额："</span> + amount;
    }
}
​
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnionPayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"unionpay"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">BigDecimal amount</span>) {
        <span class="hljs-comment">// 银联支付逻辑</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"执行银联支付，金额："</span> + amount);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"银联支付成功，金额："</span> + amount;
    }
}
</code></pre>
<h5 data-id="heading-7">第三步：策略工厂类</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStrategyFactory</span> {
    
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">PaymentStrategy</span>&gt; strategyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 注入所有PaymentStrategy实现
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStrategyFactory</span>(<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">PaymentStrategy</span>&gt; strategies) {
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">PaymentStrategy</span> strategy : strategies) {
            strategyMap.<span class="hljs-title function_">put</span>(strategy.<span class="hljs-title function_">getType</span>(), strategy);
        }
    }
    
    <span class="hljs-comment">/**
     * 获取支付策略
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStrategy</span> <span class="hljs-title function_">getStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> <span class="hljs-keyword">type</span></span>) {
        <span class="hljs-title class_">PaymentStrategy</span> strategy = strategyMap.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>);
        <span class="hljs-keyword">if</span> (strategy == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"未找到对应的支付策略："</span> + <span class="hljs-keyword">type</span>);
        }
        <span class="hljs-keyword">return</span> strategy;
    }
    
    <span class="hljs-comment">/**
     * 获取所有支持的支付方式
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getSupportTypes</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> strategyMap.<span class="hljs-title function_">keySet</span>();
    }
}
</code></pre>
<h3 data-id="heading-8">三、使用姿势：简洁优雅的调用</h3>
<h4 data-id="heading-9">3.1 改造后的Service</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">PaymentStrategyFactory</span> strategyFactory;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentService</span>(<span class="hljs-title class_">PaymentStrategyFactory</span> strategyFactory) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">strategyFactory</span> = strategyFactory;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> payType, BigDecimal amount</span>) {
        <span class="hljs-title class_">PaymentStrategy</span> strategy = strategyFactory.<span class="hljs-title function_">getStrategy</span>(payType);
        <span class="hljs-keyword">return</span> strategy.<span class="hljs-title function_">pay</span>(amount);
    }
    
    <span class="hljs-comment">/**
     * 获取支持的支付方式
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getSupportPayTypes</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> strategyFactory.<span class="hljs-title function_">getSupportTypes</span>();
    }
}
</code></pre>
<h4 data-id="heading-10">3.2 Controller层示例</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/payment"</span>)
public class PaymentController {
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">PaymentService</span> <span class="hljs-selector-tag">paymentService</span>;
    
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PaymentController</span>(PaymentService paymentService) {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.paymentService</span> = <span class="hljs-selector-tag">paymentService</span>;
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/pay"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;?&gt; <span class="hljs-selector-tag">pay</span>(<span class="hljs-variable">@RequestParam</span> String payType, 
                                <span class="hljs-variable">@RequestParam</span> BigDecimal amount) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">paymentService</span><span class="hljs-selector-class">.pay</span>(payType, amount);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(result);
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.badRequest</span>()<span class="hljs-selector-class">.body</span>(e.<span class="hljs-built_in">getMessage</span>());
        }
    }
    
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/support-types"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;?&gt; <span class="hljs-selector-tag">getSupportTypes</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(paymentService.<span class="hljs-built_in">getSupportPayTypes</span>());
    }
}
</code></pre>
<h3 data-id="heading-11">四、进阶玩法：注解 + 策略模式</h3>
<p>如果你想要更优雅，可以试试注解方式：</p>
<h4 data-id="heading-12">4.1 定义支付类型注解</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.TYPE)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Component</span>
public <span class="hljs-variable">@interface</span> PayType {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span>();
}
</code></pre>
<h4 data-id="heading-13">4.2 改造策略实现</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PayType</span>(<span class="hljs-string">"alipay"</span>)
public class AlipayStrategy implements PaymentStrategy {
    <span class="hljs-comment">// 省略具体实现</span>
}
​
<span class="hljs-variable">@PayType</span>(<span class="hljs-string">"wechat"</span>)
public class WechatPayStrategy implements PaymentStrategy {
    <span class="hljs-comment">// 省略具体实现</span>
}
</code></pre>
<h4 data-id="heading-14">4.3 改造工厂类</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStrategyFactoryV2</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, PaymentStrategy&gt; strategyMap = new ConcurrentHashMap&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 使用ApplicationContext获取所有带PayType注解的Bean
     */</span>
    <span class="hljs-keyword">public</span> PaymentStrategyFactoryV2(ApplicationContext applicationContext) {
        Map&lt;String, Object&gt; beans = applicationContext.getBeansWithAnnotation(PayType.<span class="hljs-keyword">class</span>);
        
        beans.forEach((beanName, bean) -&gt; {
            PayType <span class="hljs-keyword">annotation</span> = applicationContext.findAnnotationOnBean(beanName, PayType.<span class="hljs-keyword">class</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">annotation</span> != <span class="hljs-literal">null</span> &amp;&amp; bean instanceof PaymentStrategy) {
                strategyMap.put(<span class="hljs-keyword">annotation</span>.value(), (PaymentStrategy) bean);
            }
        });
    }
    
    <span class="hljs-comment">// 其他方法保持不变</span>
}
</code></pre>
<h3 data-id="heading-15">五、测试验证</h3>
<p>创建一个测试类验证一下：</p>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">@SpringBootTest
<span class="hljs-keyword">class</span> <span class="hljs-title">PaymentStrategyTest</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> PaymentService paymentService;
    
    @Test
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testPay</span>()</span> {
        BigDecimal amount = <span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-string">"100.50"</span>);
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"支持的支付方式："</span> + paymentService.getSupportPayTypes());
        
        String result = paymentService.pay(<span class="hljs-string">"alipay"</span>, amount);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"支付结果："</span> + result);
        
        result = paymentService.pay(<span class="hljs-string">"wechat"</span>, amount);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"支付结果："</span> + result);
        
        <span class="hljs-comment">// 测试不存在的支付方式</span>
        assertThrows(RuntimeException.<span class="hljs-keyword">class</span>, () -&gt; {
            paymentService.pay(<span class="hljs-string">"unknown"</span>, amount);
        });
    }
}
</code></pre>
<h3 data-id="heading-16">六、实际应用扩展</h3>
<h4 data-id="heading-17">6.1 结合配置文件动态启用策略</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># application.yml</span>
payment:
  enabled-strategies:
<span class="hljs-bullet">    -</span> alipay
<span class="hljs-bullet">    -</span> wechat
<span class="hljs-bullet">    -</span> unionpay
</code></pre>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicPaymentStrategyFactory</span> {
    
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${payment.enabled-strategies}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt; enabledStrategies;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">PaymentStrategy</span>&gt; strategyMap <span class="hljs-operator">=</span> new <span class="hljs-type">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">DynamicPaymentStrategyFactory</span>(<span class="hljs-type">List</span>&lt;<span class="hljs-type">PaymentStrategy</span>&gt; strategies) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">PaymentStrategy</span> strategy : strategies) {
            <span class="hljs-keyword">if</span> (enabledStrategies.contains(strategy.getType())) {
                strategyMap.put(strategy.getType(), strategy);
            }
        }
    }
    
    <span class="hljs-comment">// 其他方法...</span>
}
</code></pre>
<h4 data-id="heading-18">6.2 策略模式+模板方法模式组合</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractPaymentStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">BigDecimal amount</span>) {
        <span class="hljs-comment">// 1. 参数验证</span>
        <span class="hljs-title function_">validate</span>(amount);
        
        <span class="hljs-comment">// 2. 执行支付</span>
        <span class="hljs-title class_">String</span> transactionId = <span class="hljs-title function_">doPay</span>(amount);
        
        <span class="hljs-comment">// 3. 记录日志</span>
        <span class="hljs-title function_">logPayment</span>(transactionId, amount);
        
        <span class="hljs-comment">// 4. 返回结果</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">buildResult</span>(transactionId, amount);
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">doPay</span>(<span class="hljs-title class_">BigDecimal</span> amount);
    
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">BigDecimal amount</span>) {
        <span class="hljs-keyword">if</span> (amount.<span class="hljs-title function_">compareTo</span>(<span class="hljs-title class_">BigDecimal</span>.<span class="hljs-property">ZERO</span>) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"支付金额必须大于0"</span>);
        }
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">logPayment</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> transactionId, BigDecimal amount</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"支付流水号："</span> + transactionId + <span class="hljs-string">"，金额："</span> + amount);
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">buildResult</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> transactionId, BigDecimal amount</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getType</span>() + <span class="hljs-string">"支付成功，流水号："</span> + transactionId + <span class="hljs-string">"，金额："</span> + amount;
    }
}
</code></pre>
<h3 data-id="heading-19">总结</h3>
<h4 data-id="heading-20">优点总结：</h4>
<ol start="0">
<li><strong>开闭原则</strong>：新增支付方式只需添加新策略类，无需修改现有代码</li>
<li><strong>可读性</strong>：代码结构清晰，职责分明</li>
<li><strong>可维护性</strong>：每个支付逻辑独立，方便测试和修改</li>
<li><strong>可扩展性</strong>：轻松支持动态配置、热更新等高级功能</li>
</ol>
<h4 data-id="heading-21">使用场景：</h4>
<ul>
<li>多种相似算法或业务逻辑需要切换</li>
<li>存在大量的条件判断语句</li>
<li>系统需要动态选择不同算法</li>
<li>希望避免使用多重条件转移语句</li>
</ul>
<h4 data-id="heading-22">注意事项：</h4>
<ol start="0">
<li><strong>策略数量控制</strong>：如果策略类过多，考虑使用其他模式（如责任链模式）组合使用</li>
<li><strong>客户端感知</strong>：客户端需要知道所有策略，可以通过配置中心或枚举管理</li>
<li><strong>性能考虑</strong>：策略模式会增加对象数量，在极端性能敏感场景需要权衡</li>
<li><strong>Spring集成</strong>：确保策略类都被Spring管理，注意Bean的加载顺序</li>
<li><strong>默认策略</strong>：考虑提供一个默认策略，避免因策略不存在而报错</li>
<li><strong>策略参数</strong>：如果不同策略需要不同参数，可以考虑使用Context对象封装</li>
</ol>
<h4 data-id="heading-23">最后的小贴士：</h4>
<p>策略模式不是银弹，如果你的业务逻辑很简单，只有2-3个分支，那么简单的if-else可能更合适。但是当分支超过3个，或者未来可能会增加更多分支时，策略模式的优势就会体现出来。</p>
<p>记住，好的代码不是一蹴而就的，而是在不断重构中逐渐变好的。当你看到满屏的if-else时，不妨想想：这里是不是可以用策略模式优化一下？</p>
<p>希望这篇博客能帮到你！如果有问题或更好的建议，欢迎在评论区交流讨论。我们一起写出更优雅的代码！</p>
<hr/>
<p><em>作者：张工摆Bug</em> <em>转载请注明出处，让我们一起打造更好的技术社区！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底搞懂 Spring Boot 中 properties 和 YAML 的区别]]></title>    <link>https://juejin.cn/post/7585410547336790066</link>    <guid>https://juejin.cn/post/7585410547336790066</guid>    <pubDate>2025-12-19T13:01:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547336790066" data-draft-id="7585406229167767602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底搞懂 Spring Boot 中 properties 和 YAML 的区别"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-19T13:01:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天过得怎么样"/> <meta itemprop="url" content="https://juejin.cn/user/977884013421370"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底搞懂 Spring Boot 中 properties 和 YAML 的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/977884013421370/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天过得怎么样
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T13:01:15.000Z" title="Fri Dec 19 2025 13:01:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Spring Boot 开发中，<code>application.properties</code> 和 <code>application.yml</code> 是最常用的两种配置文件格式。随着项目复杂度提升，越来越多团队转向 YAML。那么，它们到底有何不同？今天我们就从<strong>定位、语法、数据表达能力、通用性</strong>四个角度，系统对比这两种配置方式。</p>
<hr/>
<h2 data-id="heading-0">一、定位不同：工具 vs 语言</h2>
<p><code>properties</code> 文件本质上是“<strong>属性文件</strong>”（Properties File），其设计初衷是在 Java 应用中以键值对的形式存储配置项。它简洁直接，长期以来作为 Spring Boot 默认的配置格式（尤其在 2.x 版本中）。</p>
<p>而 <strong>YAML</strong>（YAML Ain’t Markup Language，原意为 “Yet Another Markup Language”）则是一种<strong>通用的数据序列化格式</strong>，定位远不止于“配置属性”。它旨在以人类可读的方式表达结构化数据，适用于多种场景和语言。</p>
<blockquote>
<p>一句话总结：<code>properties</code> 是一个配置工具，<strong>YAML</strong> 是一种表达结构化数据的语言。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、语法风格：扁平 vs 层级</h2>
<h4 data-id="heading-2">properties 语法</h4>
<p>采用经典的 <code>key=value</code> 格式，每行一个配置项：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">server.port</span>=<span class="hljs-number">8080</span>
<span class="hljs-attr">debug</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3306</span>/dbname?characterEncoding=utf8
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root
</code></pre>
<h4 data-id="heading-3">YAML 语法</h4>
<p>使用缩进和冒号表示层级关系，<strong>冒号后必须跟一个空格</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span>
<span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/dbname?characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
</code></pre>
<p>✅ <strong>优势</strong>：YAML 层级清晰、结构直观，尤其在配置嵌套属性时，可读性和维护性显著优于 properties。</p>
<hr/>
<h2 data-id="heading-4">三、复杂数据类型支持：YAML 更强大</h2>
<p>除了基本的字符串、数字、布尔值，YAML 原生支持对象、列表、Map 等复杂结构，无需额外解析逻辑。</p>
<h4 data-id="heading-5">示例：配置对象</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">user:</span>
  <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Tom</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">20</span>
</code></pre>
<h4 data-id="heading-6">示例：配置列表</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 列表写法一（推荐）</span>
animals:
<span class="hljs-bullet">  -</span> Dog
<span class="hljs-bullet">  -</span> Cat
<span class="hljs-bullet">  -</span> Bird

<span class="hljs-section"># 列表写法二（行内）</span>
animals: [Dog, Cat, Bird]
</code></pre>
<p>相比之下，properties 虽可通过 <code>list[0]=Dog</code> 等方式模拟集合，但语法繁琐且易出错，远不如 YAML 自然。</p>
<h4 data-id="heading-7">对比：properties 模拟列表（不直观）</h4>
<pre><code class="hljs language-css" lang="css">animals<span class="hljs-selector-attr">[0]</span>=Dog 
animals<span class="hljs-selector-attr">[1]</span>=Cat 
animals<span class="hljs-selector-attr">[2]</span>=Bird
</code></pre>
<hr/>
<h2 data-id="heading-8">四、YAML 具备跨语言通用性</h2>
<p><code>properties</code> 是 Java 生态特有的配置格式，几乎仅用于 JVM 项目。<br/>
而 <strong>YAML 是一种语言无关的数据格式</strong>，被广泛应用于 Python、JavaScript、Go、Ruby、PHP 等多种编程语言中。</p>
<blockquote>
<p>这意味着：在多语言微服务架构中，若使用统一的配置中心（如 Nacos、Apollo），各团队可共享同一份 YAML 配置文件，极大提升协作效率与运维一致性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">总结</h2>






























<table><thead><tr><th>维度</th><th>properties</th><th>YAML</th></tr></thead><tbody><tr><td>定位</td><td>Java 属性配置</td><td>通用数据序列化语言</td></tr><tr><td>语法</td><td><code>key=value</code>，扁平结构</td><td><code>key: value</code>，支持嵌套与缩进</td></tr><tr><td>数据类型</td><td>仅基础类型</td><td>支持对象、列表、Map 等复杂结构</td></tr><tr><td>通用性</td><td>仅限 Java/Spring</td><td>多语言通用</td></tr></tbody></table>
<p>虽然 Spring Boot 同时支持两种格式，但从<strong>可读性、表达力和生态兼容性</strong>来看，YAML 显然是更现代、更优雅的选择。如果你的新项目尚未选定配置格式，不妨大胆拥抱 YAML！</p>
<hr/>
<blockquote>
<p>💡 <strong>小贴士</strong>：Spring Boot 会优先加载 <code>application.yml</code>（如果存在），若两者共存，YAML 配置将覆盖 properties 中的同名项。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 有什么奇技淫巧？]]></title>    <link>https://juejin.cn/post/7585171571130187812</link>    <guid>https://juejin.cn/post/7585171571130187812</guid>    <pubDate>2025-12-19T11:24:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585171571130187812" data-draft-id="7585206349748994100" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 有什么奇技淫巧？"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-19T11:24:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Flystone"/> <meta itemprop="url" content="https://juejin.cn/user/1451011079938125"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 有什么奇技淫巧？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1451011079938125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Flystone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:24:16.000Z" title="Fri Dec 19 2025 11:24:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F27432017%2Fanswer%2F1984773459834852908" target="_blank" title="https://www.zhihu.com/question/27432017/answer/1984773459834852908" ref="nofollow noopener noreferrer">转载自作者：独元殇</a></p>
<h3 data-id="heading-0">aspect-ratio</h3>
<p>宽高比</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">190px</span>; <span class="hljs-comment">/* 注意，这个数字要能容纳完内容才有效 */</span> 
        aspect-ratio: <span class="hljs-number">16</span> / <span class="hljs-number">9</span>; 
        <span class="hljs-attribute">background</span>: tomato; 
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我永远保持 16:9<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>如果，你 aspect-ratio 的值写成 1 ，那么就可以得到一个完美的正方形了！</p>
<h3 data-id="heading-1">object-fit</h3>
<p>它有两个值，一个是 cover （图片完全覆盖容器，且图片长宽不失真），一个是 scale-down （只保证图片长宽不失真）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-tag">img</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">object-fit</span>: cover; <span class="hljs-comment">/* 会裁切，只剩中间 */</span> 
        <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#000</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://placehold.co/300x200"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"demo"</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">color-scheme: dark light;</h3>
<p>启动浏览器自适应 深浅色模式！</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-pseudo">:root</span> { 
        <span class="hljs-attribute">color</span>-scheme: dark light; <span class="hljs-comment">/* 自动变色 */</span> 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>切换系统深浅模式来测试<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在深色模式下，下面的原生控件会自动变黑，文字变白：<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span> 输入框: <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">accent-color:red;</h3>
<p>它会自动计算出不同焦点下，表单控件的颜色</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> { 
        accent-<span class="hljs-attribute">color</span>:red; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">checked</span>&gt;</span> 选择框
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">checked</span>&gt;</span> 单选 
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span>&gt;</span> 拖动滑块
</code></pre>
<h3 data-id="heading-4">fit-content</h3>
<p>它是根据内容，来控制容器的大小的</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> {
        <span class="hljs-attribute">background</span>: skyblue; 
        <span class="hljs-attribute">width</span>: fit-content; 
        <span class="hljs-attribute">margin</span>: auto; 
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是一个 div，使用缩水大法<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">overscroll-behavior: contain;</h3>
<p>解决一个 div，有自己的滚动条。然后用户在这个 div 里滚动到底部时，，整个页面会开始滚动。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-tag">body</span> { 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">150vh</span>; 
        <span class="hljs-attribute">background</span>: <span class="hljs-number">#eee</span>; 
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">50px</span>; 
    } 
    <span class="hljs-selector-class">.scroll-box</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">overflow</span>: auto;
        <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> solid <span class="hljs-number">#333</span>;
        <span class="hljs-attribute">background</span>: white; 
        overscroll-behavior: contain; <span class="hljs-comment">/* 关键代码 */</span> 
    } 
    <span class="hljs-selector-class">.inner</span> { 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>; 
        <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to bottom, tomato, gold); 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scroll-box"</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"inner"</span>&gt;</span>内部滚动条<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>滚动上面的盒子到底部，再继续滚动试试...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">text-wrap: balance;</h3>
<p>它可以平衡行数之前的词语长度，使其做到尽可能的均衡，整体观感上，要舒服很多！
注意，这个属性，只支持 6 行以内，所以尽可能用在一些短小的地方，比如标题！</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-tag">h2</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">background</span>: gold; 
        <span class="hljs-attribute">text-align</span>: center; 
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; 
    } 
    <span class="hljs-selector-id">#test</span> { 
        text-wrap: balance; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">id</span>=<span class="hljs-string">test</span>&gt;</span>很长很长 so long 很长的 titletitle 标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>很长很长 so long 很长的 titletitle 标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">text-underline-offset: 0.25em;</h3>
<p>英文中的 g、y ，是不是这些字母，下面会拖一个尾巴。而 &lt; a &gt; 的原生效果是，这个 underline 线会重叠到这些小尾巴上。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-attr">[class]</span>) {
        text-underline-offset: <span class="hljs-number">0.25em</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>这是一个正文链接 (g/y)<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span>&gt;</span>这是一个按钮链接(不使用该 CSS) (g/y)<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">outline-offset ！</h3>
<p>不计入盒模型尺寸的轮廓线。
把鼠标移上去，就会有扩散效果了。而且，只是扩散，不会影响各种尺寸。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">button</span> { 
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">30px</span>; 
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
        <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#333</span>; 
        <span class="hljs-attribute">outline</span>: <span class="hljs-number">2px</span> dashed blue;
        <span class="hljs-attribute">outline-offset</span>: <span class="hljs-built_in">var</span>(--offset, <span class="hljs-number">2px</span>);
        <span class="hljs-attribute">transition</span>: outline-offset <span class="hljs-number">0.2s</span>; 
    } 
    <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> { 
        <span class="hljs-attr">--offset</span>: <span class="hljs-number">10px</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>鼠标悬停看扩散效果<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">scroll-margin-top</h3>
<p>怎么形容这个场景呢？你有个固定的顶部导航栏。它 高度是 100px 。然后你单击链接，是一个滚动到某个 #part 标题的链接，你会发现默认滚动后，它是紧挨着顶部的。那么导航栏就挡住了（我也不太能说清，大家看下面的例子吧）..... 如何不介入 js 来解决这个问题呢？就是scroll-margin-top ！</p>
<p>注意，要在本地建一个 html 来运行，否则会乱跳转！</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    <span class="hljs-selector-tag">nav</span> { 
        <span class="hljs-attribute">position</span>: fixed;
        <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>; 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; 
        <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>); 
    } 
    <span class="hljs-selector-tag">h2</span><span class="hljs-selector-attr">[id]</span> { 
        <span class="hljs-attribute">scroll-margin-top</span>: <span class="hljs-number">110px</span>; <span class="hljs-comment">/* 100px + 10px 缝隙 */</span> 
        <span class="hljs-attribute">background</span>: yellow; 
    } 
    <span class="hljs-selector-tag">body</span> { 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; 
        <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">120px</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>我是 100px 高的固定栏 (半透明)<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#part-1"</span>&gt;</span>&gt;&gt;&gt; 点我跳转到目标 &lt;&lt;&lt;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 500px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"part-1"</span>&gt;</span>目标标题：你看不到红色的遮挡<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">scrollbar-gutter: stable;</h3>
<p>解决 一个滚动条跳动 Bug 。就是页面的内容，动态变多，会突然出现滚动条。然后画面会跳动一下。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">150px</span>; 
        <span class="hljs-attribute">overflow-y</span>: auto; 
        <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#333</span>; 
        <span class="hljs-attribute">scrollbar-gutter</span>: stable; <span class="hljs-comment">/* 关键 */</span>
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> 虽然内容很少，不需要滚动， 但请注意右侧预留的空白槽。 这保证了内容增加时不会发生位移。 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue的“小外挂”：玩转自定义指令]]></title>    <link>https://juejin.cn/post/7585382553289244708</link>    <guid>https://juejin.cn/post/7585382553289244708</guid>    <pubDate>2025-12-19T11:56:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553289244708" data-draft-id="7585173051647705124" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue的“小外挂”：玩转自定义指令"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-19T11:56:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晷龙烬"/> <meta itemprop="url" content="https://juejin.cn/user/1874007727812221"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue的“小外挂”：玩转自定义指令
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874007727812221/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晷龙烬
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:56:05.000Z" title="Fri Dec 19 2025 11:56:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>🔥 以龙息淬炼代码，在时光灰烬中重铸技术星河 ！</p>
<p>欢迎来到 <code>晷龙烬</code>的博客小窝✨！ 这里记录技术学习点滴，分享实用技巧，偶尔聊聊奇思妙想～</p>
<p>原创内容✍️，转载请注明出处～感谢支持❤️！请尊重原创📩！ 欢迎在评论区交流🌟！</p>
</blockquote>
<h2 data-id="heading-0"><strong>引言</strong></h2>
<p>你好呀！在Vue的世界里，我们每天都在用 <code>v-model</code>、<code>v-if</code> 这些内置指令，它们就像官方给我们的“瑞士军刀”，特别好用。但有时候，我们总想搞点“个性化”操作，比如一进页面就让某个输入框自动聚焦，或者给按钮加个“防抖”防止用户疯狂点击。</p>
<p>这时候，Vue的“自定义指令”就该闪亮登场了！它就像是你给Vue安装的“小外挂”，让你能自己定义一些特殊的DOM行为。今天，咱们就把它聊明白。</p>
<h3 data-id="heading-1">一、 自定义指令是啥？能吃吗？</h3>
<p>简单说，<strong>自定义指令就是一套你自己写的、能用在HTML元素上的“操作说明书”</strong> ‍。</p>
<p>Vue的核心思想是“数据驱动视图”，我们通常通过改变数据来让视图自动更新。但有些时候，我们不得不直接去操作真实的DOM元素（比如让输入框聚焦、初始化一个第三方库），这些“副作用”操作，就是自定义指令的用武之地。</p>
<p>你可以把它理解成一个<strong>可复用的“DOM操作工具箱”</strong> ‍。哪里需要，就“v-你的指令名”一下，工具箱里的工具就会自动在那个元素上工作。</p>
<h3 data-id="heading-2">二、 怎么创建一个“小外挂”？</h3>
<p>创建自定义指令主要有两种方式：全局注册和局部注册。咱们先看最常用的全局注册，一次定义，全项目通用。</p>
<p><strong>1. 全局注册：给Vue加个“全家桶”工具</strong> 在你的主文件（比如 <code>main.js</code>）里，可以这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 定义一个名为 `v-focus` 的指令</span>
 <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, {
   <span class="hljs-comment">// 当被绑定的元素插入到 DOM 中时……</span>
   <span class="hljs-attr">inserted</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) {
     <span class="hljs-comment">// 聚焦元素</span>
     el.<span class="hljs-title function_">focus</span>()
   }
 })
</code></pre>
<p>用起来超简单，在模板里直接：</p>
<pre><code class="hljs language-css" lang="css"> &lt;<span class="hljs-selector-tag">input</span> v-focus&gt;
</code></pre>
<p>这样，只要这个 <code>input</code> 元素被插入页面，它就会自动获得焦点，用户可以直接打字，体验满分！</p>
<p><strong>2. 局部注册：某个组件私有的“小工具”</strong> ‍ 如果这个指令只在某个特定组件里用，可以把它定义在该组件内部：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
   <span class="hljs-attr">directives</span>: {
     <span class="hljs-attr">focus</span>: {
       <span class="hljs-attr">inserted</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) {
         el.<span class="hljs-title function_">focus</span>()
       }
     }
   }
 }
</code></pre>
<p>用法和全局的一样。这种方式让指令的作用范围更清晰。</p>
<h3 data-id="heading-3">三、 指令的“生命周期钩子”</h3>
<p>一个指令不是简单执行一下就完了，它也有自己的“人生阶段”，Vue提供了几个钩子函数让我们在关键时刻介入：</p>
<ul>
<li><strong><code>bind</code></strong>：<strong>只调用一次</strong>，指令第一次绑定到元素时调用。可以在这里做一次性的初始化设置。</li>
<li><strong><code>inserted</code></strong>：被绑定元素插入父节点时调用（仅保证父节点存在，但不一定已被插入文档）。上面让输入框聚焦的例子，就用这个钩子。</li>
<li><strong><code>update</code></strong>：<strong>所在组件的 VNode 更新时调用</strong>，但可能发生在其子 VNode 更新之前。指令的值可能发生了变化，也可能没有。</li>
<li><strong><code>componentUpdated</code></strong>：指令所在组件的 VNode <strong>及其子 VNode</strong> 全部更新后调用。</li>
<li><strong><code>unbind</code></strong>：<strong>只调用一次</strong>，指令与元素解绑时调用。适合在这里做清理工作，比如移除事件监听器，防止内存泄漏。</li>
</ul>
<p>这些钩子函数都会接收到几个参数，最常用的是 <code>el</code>（指令绑定的元素）和 <code>binding</code>（一个包含指令信息的对象）。</p>
<h3 data-id="heading-4">四、 钩子函数的参数详解</h3>
<p>让我们深入看看 <code>binding</code> 这个对象，它包含了指令的所有关键信息：</p>
<ul>
<li><code>name</code>：指令名，不包括 <code>v-</code> 前缀。</li>
<li><code>value</code>：指令的绑定值。例如 <code>v-my-directive="1 + 1"</code> 中，绑定值是 <code>2</code>。</li>
<li><code>oldValue</code>：指令绑定的前一个值，仅在 <code>update</code> 和 <code>componentUpdated</code> 钩子中可用。</li>
<li><code>expression</code>：字符串形式的指令表达式。例如 <code>v-my-directive="1 + 1"</code> 中，表达式是 <code>"1 + 1"</code>。</li>
<li><code>arg</code>：传给指令的参数。例如 <code>v-my-directive:foo</code> 中，参数是 <code>"foo"</code>。</li>
<li><code>modifiers</code>：一个包含修饰符的对象。例如 <code>v-my-directive.foo.bar</code> 中，修饰符对象是 <code>{ foo: true, bar: true }</code>。</li>
</ul>
<p>理解这些参数，你就能写出更灵活、强大的指令。</p>
<h3 data-id="heading-5">五、 来点更深入实用的例子</h3>
<p>光说不练假把式，咱们看几个深入、并且实用的场景。</p>
<h4 data-id="heading-6"><strong>例子1：按钮权限控制</strong></h4>
<p>假设我们有不同权限的用户，有些按钮只有管理员能点。</p>
<pre><code class="hljs language-ini" lang="ini"> Vue.directive('permission', {
   inserted: function (el, binding) {
     // binding.value 就是我们传给指令的值，比如用户角色
     const <span class="hljs-attr">userRole</span> = <span class="hljs-string">'user'</span> // 假设当前用户是普通用户
     const <span class="hljs-attr">requiredRole</span> = binding.value // 指令要求的管理员角色 <span class="hljs-string">'admin'</span>
 ​
     if (userRole !== requiredRole) {
       // 如果不是管理员，就把按钮禁用或者隐藏
       <span class="hljs-attr">el.style.display</span> = <span class="hljs-string">'none'</span>
       // 或者 <span class="hljs-attr">el.disabled</span> = <span class="hljs-literal">true</span>
     }
   }
 })
</code></pre>
<p>模板里可以这样用：</p>
<pre><code class="hljs language-ini" lang="ini"> &lt;button <span class="hljs-attr">v-permission</span>=<span class="hljs-string">"'admin'"</span>&gt;删除文章&lt;/button&gt;
</code></pre>
<p>普通用户就看不到这个删除按钮啦，权限管理轻松实现。</p>
<h4 data-id="heading-7"><strong>例子2：按钮防重复点击</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// main.js（Vue2 全局注册）</span>
 <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'throttle'</span>, {
   <span class="hljs-comment">// 元素插入DOM时绑定事件</span>
   <span class="hljs-title function_">inserted</span>(<span class="hljs-params">el, binding</span>) {
     <span class="hljs-comment">// 1. 基础配置：默认节流间隔500ms，支持通过参数自定义（如 v-throttle:1000）</span>
     <span class="hljs-keyword">const</span> delay = binding.<span class="hljs-property">arg</span> ? <span class="hljs-title class_">Number</span>(binding.<span class="hljs-property">arg</span>) : <span class="hljs-number">500</span>;
     <span class="hljs-comment">// 2. 校验回调函数（避免非函数报错）</span>
     <span class="hljs-keyword">const</span> callback = <span class="hljs-keyword">typeof</span> binding.<span class="hljs-property">value</span> === <span class="hljs-string">'function'</span> ? binding.<span class="hljs-property">value</span> : <span class="hljs-function">() =&gt;</span> {};
     
     <span class="hljs-comment">// 3. 核心变量：记录上一次执行时间</span>
     <span class="hljs-keyword">let</span> lastClickTime = <span class="hljs-number">0</span>;
 ​
     <span class="hljs-comment">// 4. 节流点击事件处理函数</span>
     <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
       <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
       <span class="hljs-comment">// 距离上次点击超过设定间隔，才执行回调</span>
       <span class="hljs-keyword">if</span> (now - lastClickTime &gt;= delay) {
         <span class="hljs-title function_">callback</span>(); <span class="hljs-comment">// 执行业务逻辑</span>
         lastClickTime = now; <span class="hljs-comment">// 更新最后点击时间</span>
       }
     };
 ​
     <span class="hljs-comment">// 5. 绑定点击事件 + 缓存函数（方便后续销毁）</span>
     el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleClick);
     el.<span class="hljs-property">_throttleClick</span> = handleClick; <span class="hljs-comment">// 把函数存到元素上</span>
   },
 ​
   <span class="hljs-comment">// 元素销毁时清理事件（避免内存泄漏）</span>
   <span class="hljs-title function_">unbind</span>(<span class="hljs-params">el</span>) {
     el.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, el.<span class="hljs-property">_throttleClick</span>);
     el.<span class="hljs-property">_throttleClick</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 清空缓存</span>
   }
 });
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-xml" lang="xml"> <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
   <span class="hljs-comment">&lt;!-- 1. 默认500ms节流 --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-throttle</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>默认节流点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
 ​
   <span class="hljs-comment">&lt;!-- 2. 自定义1000ms节流（通过参数指定） --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-throttle:1000</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>1秒节流点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>例子3：图片懒加载</strong> 这是一个非常经典的自定义指令应用场景，可以大幅提升页面加载性能。</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'lazy'</span>, {
   <span class="hljs-attr">inserted</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">el, binding</span>) {
     <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
       entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
         <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
           <span class="hljs-comment">// 图片进入视口</span>
           <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>
           img.<span class="hljs-property">src</span> = binding.<span class="hljs-property">value</span> <span class="hljs-comment">// 将data-src的值赋给src</span>
           observer.<span class="hljs-title function_">unobserve</span>(img) <span class="hljs-comment">// 停止观察</span>
         }
       })
     }, {
       <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'0px'</span>,
       <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span>
     })
 ​
     observer.<span class="hljs-title function_">observe</span>(el)
     <span class="hljs-comment">// 存储observer，以便在unbind时清理</span>
     el.<span class="hljs-property">_lazyObserver</span> = observer
   },
   <span class="hljs-attr">unbind</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) {
     <span class="hljs-keyword">if</span> (el.<span class="hljs-property">_lazyObserver</span>) {
       el.<span class="hljs-property">_lazyObserver</span>.<span class="hljs-title function_">disconnect</span>()
     }
   }
 })
</code></pre>
<p>HTML中使用：</p>
<pre><code class="hljs language-ini" lang="ini"> &lt;img <span class="hljs-attr">v-lazy</span>=<span class="hljs-string">"'https://example.com/image.jpg'"</span> alt=<span class="hljs-string">"懒加载图片"</span>&gt;
</code></pre>
<hr/>
<h3 data-id="heading-8">六、 自定义指令的适用场景总结</h3>
<ol>
<li><strong>DOM操作封装</strong>：聚焦、选择文本、内容复制等。</li>
<li><strong>事件处理优化</strong>：防抖、节流、长按、双击等。</li>
<li><strong>UI功能增强</strong>：拖拽、滚动监听、无限滚动、懒加载。</li>
<li><strong>权限与状态控制</strong>：按钮权限、元素可见性、功能开关。</li>
<li><strong>第三方库集成</strong>：图表库初始化、富文本编辑器、地图组件。</li>
<li><strong>样式与动画</strong>：动态样式绑定、动画触发、主题切换。</li>
</ol>
<h2 data-id="heading-9">结语</h2>
<p>自定义指令不是什么高深莫测的黑魔法，它就是一个帮你<strong>封装DOM操作、提升代码复用性和可维护性的好帮手</strong>。下次当你发现自己在多个地方重复写着相同的DOM操作代码时，不妨停下来想想：“是不是可以抽象成一个自定义指令？”</p>
<p>从简单的自动聚焦，到复杂的权限管理、性能优化，自定义指令都能让你的Vue项目代码更干净、更专业。希望这篇文章能帮你打开思路，在实际项目中用起来！</p>
<hr/>
<h2 data-id="heading-10">—— 完 ——</h2>
<p>✨ 至此结束 ✨</p>
<p>💡 点赞关注，解锁更多技术干货！</p>
<p>我是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fm0_56336997%3Fspm%3D1011.2124.3001.5343" target="_blank" title="https://blog.csdn.net/m0_56336997?spm=1011.2124.3001.5343" ref="nofollow noopener noreferrer">晷龙烬</a> 期待与你的下次相遇～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS3 实现16:9大屏居中显示]]></title>    <link>https://juejin.cn/post/7585206349749649460</link>    <guid>https://juejin.cn/post/7585206349749649460</guid>    <pubDate>2025-12-19T12:23:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585206349749649460" data-draft-id="7585391510058680372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS3 实现16:9大屏居中显示"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-19T12:23:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户188787106984"/> <meta itemprop="url" content="https://juejin.cn/user/2455640372153627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS3 实现16:9大屏居中显示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455640372153627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户188787106984
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:23:27.000Z" title="Fri Dec 19 2025 12:23:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大屏项目中，一般需要在不同分辨率上显示居中显示大屏内容，且不出现滚动条。实际展示大屏的硬件设备比例不一，为了兼容，并且不出现UI被拉伸的情况，发现可以使用CSS3的transfrom-scale属性，并配合CSS变量实现。
其中transfrom-scale用在大屏绘制最外层盒子上，盒子内的样式按照UI给出的16:9的比例绘制。
效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b4d4a9fab4648339fae400b8b35307a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766753178&amp;x-signature=CN6RN4q5p92XIrKXoXHTFei5foc%3D" alt="" loading="lazy"/></p>
<p>代码展示最外层盒子的缩放样式及比例计算：</p>
<p>style</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-pseudo">:root</span> {
    <span class="hljs-attr">--transformScale</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attr">--positionWidth</span>: <span class="hljs-number">1920px</span>;
    <span class="hljs-attr">--positionHeight</span>: <span class="hljs-number">1080px</span>;
  }

  * {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  }

  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
  }

  <span class="hljs-selector-class">.position</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--positionWidth);
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--positionHeight);
  }

  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">1080px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">1920px</span>;
    <span class="hljs-attribute">background-color</span>: aquamarine;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-built_in">var</span>(--transformScale));
    <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0%</span> <span class="hljs-number">0%</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 为了获取屏幕宽高添加的元素 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 为了定位添加的元素 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"position"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>script</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script&gt;
  // 全局缩放比基础宽
  const <span class="hljs-attr">width</span> = <span class="hljs-number">1920</span><span class="hljs-comment">;</span>
  // 全局缩放比基础高
  const <span class="hljs-attr">height</span> = <span class="hljs-number">1080</span><span class="hljs-comment">;</span>
  // 宽高比
  const <span class="hljs-attr">ratio</span> = <span class="hljs-number">16</span> / <span class="hljs-number">9</span><span class="hljs-comment">;</span>

  const <span class="hljs-attr">getBaseScale</span> = () =&gt; {
    const <span class="hljs-attr">element</span> = document.getElementsByClassName(<span class="hljs-string">"container"</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    // 获取可视区域的宽度
    const <span class="hljs-attr">w</span> = element.clientWidth<span class="hljs-comment">;</span>
    // 获取可视区域的高
    const <span class="hljs-attr">h</span> = element.clientHeight<span class="hljs-comment">;</span>
    // 根据宽高计算比例
    let <span class="hljs-attr">s</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    if (w / h &gt;= ratio) {
      // 设备左右留白 以高度为基础计算缩放比
      <span class="hljs-attr">s</span> = h / height<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">s</span> = w / width<span class="hljs-comment">;</span>
    }

    const <span class="hljs-attr">pw</span> = s * <span class="hljs-number">1920</span> + <span class="hljs-string">"px"</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">ph</span> = s * <span class="hljs-number">1080</span> + <span class="hljs-string">"px"</span><span class="hljs-comment">;</span>

    // 赋值
    document
      .getElementsByTagName("body")<span class="hljs-section">[0]</span>
      .style.setProperty("--transformScale", s)<span class="hljs-comment">;</span>
    document
      .getElementsByTagName("body")<span class="hljs-section">[0]</span>
      .style.setProperty("--positionWidth", pw)<span class="hljs-comment">;</span>
    document
      .getElementsByTagName("body")<span class="hljs-section">[0]</span>
      .style.setProperty("--positionHeight", ph)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  // 窗口变化
  <span class="hljs-attr">onresize</span> = getBaseScale<span class="hljs-comment">;</span>

  // 加载
  <span class="hljs-attr">onload</span> = getBaseScale<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<blockquote>
<p>补充</p>
</blockquote>
<h5 data-id="heading-0">一、JavaScript 操作 CSS 变量</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> root = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">":root"</span>);
<span class="hljs-comment">// 设置 CSS 变量</span>
root.style.setProperty(<span class="hljs-string">"--transformScale"</span>, <span class="hljs-number">0.2</span>);
</code></pre>

<pre><code class="hljs language-ini" lang="ini">// 读取 CSS 变量
const <span class="hljs-attr">computedStyle</span> = getComputedStyle(root)<span class="hljs-comment">;</span>
const <span class="hljs-attr">transformScale</span> = computedStyle.getPropertyValue(<span class="hljs-string">"--transformScale"</span>)<span class="hljs-comment">;</span>
console.log(transformScale)<span class="hljs-comment">;</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 删除 CSS 变量</span>
root.style.<span class="hljs-built_in">removeProperty</span>(<span class="hljs-string">"--transformScale"</span>);
</code></pre>
<h5 data-id="heading-1">二、CSS3 transform: scale</h5>
<p>语法：transform: scale(x, y)   transform: scaleX(x)   transform: scaleY(y)
1、scale(x, y) 对元素进行缩放；
① x表示水平方向，y表示竖直方向；
② y是一个可选参数，如果不写的话，X，Y 两个方向缩放一样；
2、scaleX(x) 对元素只在x轴(水平方向)进行缩放；
3、scaleY(y) 对元素只在y轴(竖直方向)进行缩放;
4、存在 2D 转换或 3D 转换。</p>
<p>兼容性：参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2F%3Fsearch%3Dtransform" target="_blank" title="https://caniuse.com/?search=transform" ref="nofollow noopener noreferrer">caniuse.com/?search=tra…</a></p>
<h5 data-id="heading-2">三、CSS3 transform-origin</h5>
<p>语法：transform-origin: x y z;
1、改变被转换元素的位置；
2、存在 2D 转换或 3D 转换；
3、相对于父节点改变位置。</p>





















<table><thead><tr><th align="center">值</th><th>属性值</th></tr></thead><tbody><tr><td align="center">x</td><td>left	center	right	length	%</td></tr><tr><td align="center">y</td><td>top	center	bottom	length	%</td></tr><tr><td align="center">z</td><td>length</td></tr></tbody></table>
<p>兼容性：参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2F%3Fsearch%3Dtransform-origin" target="_blank" title="https://caniuse.com/?search=transform-origin" ref="nofollow noopener noreferrer">caniuse.com/?search=tra…</a></p>
<p>博客园地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwttt123%2Fp%2F18104247" target="_blank" title="https://www.cnblogs.com/wttt123/p/18104247" ref="nofollow noopener noreferrer">www.cnblogs.com/wttt123/p/1…</a></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS3 clip-path+animation实现不规则容器中的粒子下落]]></title>    <link>https://juejin.cn/post/7585406030020870179</link>    <guid>https://juejin.cn/post/7585406030020870179</guid>    <pubDate>2025-12-19T12:26:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030020870179" data-draft-id="7585206349749665844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS3 clip-path+animation实现不规则容器中的粒子下落"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-19T12:26:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户188787106984"/> <meta itemprop="url" content="https://juejin.cn/user/2455640372153627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS3 clip-path+animation实现不规则容器中的粒子下落
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455640372153627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户188787106984
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:26:33.000Z" title="Fri Dec 19 2025 12:26:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用CSS3的clip-path实现不规则图形裁剪，结合CSS3 animation实现粒子下落动画效果，如下：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4297cc5f6803456dbb845d351c677b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766753098&amp;x-signature=%2Bpfmdgg3VoKxUyKkcTjJfoWgUpc%3D" height="200px" loading="lazy"/>
<p>html:
创建不规则容器及下落的粒子节点；</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"particle"</span>&gt;
  &lt;i <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item of 20"</span> :key=<span class="hljs-string">"item"</span> class=<span class="hljs-string">"particle-item"</span>&gt;&lt;/i&gt;
&lt;/div&gt;
</code></pre>
<p>style:
1、此demo使用less实现样式；</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不规则容器样式 */</span>
<span class="hljs-selector-class">.particle</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">90px</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">110px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">236px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">180deg</span>, <span class="hljs-number">#F44336</span> <span class="hljs-number">0%</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">250</span>, <span class="hljs-number">33</span>, <span class="hljs-number">245</span>, <span class="hljs-number">0.4</span>) <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">clip-path</span>: <span class="hljs-built_in">polygon</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span>, <span class="hljs-number">100px</span> <span class="hljs-number">0</span>, <span class="hljs-number">100px</span> <span class="hljs-number">200px</span>, <span class="hljs-number">46px</span> <span class="hljs-number">236px</span>, <span class="hljs-number">0</span> <span class="hljs-number">200px</span>);
}

<span class="hljs-comment">/* 下落粒子样式 */</span>
<span class="hljs-selector-class">.particle-item</span> {
  &amp;<span class="hljs-selector-pseudo">::before</span>,
  &amp;<span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">4px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">4px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>);
  }
  <span class="hljs-comment">/* 调用粒子下落样式函数 */</span>
  <span class="hljs-selector-class">.particle-selectors</span>(<span class="hljs-number">20</span>);
}
</code></pre>
<p>2、粒子下落样式函数主要计算粒子的初始位置及下落路径；</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.particle-selectors</span>(<span class="hljs-variable">@n</span>, <span class="hljs-variable">@i</span>:<span class="hljs-number">1</span>) <span class="hljs-keyword">when</span> (<span class="hljs-variable">@i</span> &lt;= <span class="hljs-variable">@n</span>) {
  <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-variable">@{i}</span>) {
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-pseudo">::before</span> ,
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-variable">@w:</span> <span class="hljs-built_in">`Math.floor(Math.random() * 100) `</span>;
      <span class="hljs-variable">@h:</span> <span class="hljs-built_in">`Math.floor(Math.random() * -100) `</span>;
      <span class="hljs-variable">@d:</span> <span class="hljs-built_in">`Math.random() * 0.2 `</span>;
      <span class="hljs-variable">@du:</span> <span class="hljs-built_in">calc</span>(<span class="hljs-string">~'@{d}s + 5s'</span>);
      <span class="hljs-variable">@t:</span> <span class="hljs-built_in">`Math.random() * -10 `</span>;
      <span class="hljs-variable">@ti:</span> <span class="hljs-built_in">calc</span>(<span class="hljs-string">~'@{t} * 0.6s'</span>);

      <span class="hljs-attribute">left</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-string">~'@{w} * 1px'</span>);
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-built_in">calc</span>(<span class="hljs-string">~'@{h} * 2px'</span>));
      <span class="hljs-selector-class">.animation</span>(<span class="hljs-variable">@du</span>, <span class="hljs-variable">@ti</span>);
    }
  }
  <span class="hljs-selector-class">.particle-selectors</span>(<span class="hljs-variable">@n</span>,(<span class="hljs-variable">@i</span> + <span class="hljs-number">1</span>));
}
</code></pre>
<p>3、粒子下落动画；</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.animation</span>(<span class="hljs-variable">@du</span>, <span class="hljs-variable">@de</span>) {
  <span class="hljs-keyword">@keyframes</span> frame {
    <span class="hljs-selector-tag">from</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">20px</span>);
    }
    <span class="hljs-selector-tag">to</span> {
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">280px</span>);
    }
  }
  <span class="hljs-attribute">animation</span>: frame <span class="hljs-number">10s</span> infinite;
  <span class="hljs-attribute">animation-delay</span>: <span class="hljs-variable">@de</span>;
  <span class="hljs-attribute">animation-duration</span>: <span class="hljs-variable">@du</span>;
}
</code></pre>
<p>博客园地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwttt123%2Fp%2F18296125" target="_blank" title="https://www.cnblogs.com/wttt123/p/18296125" ref="nofollow noopener noreferrer">www.cnblogs.com/wttt123/p/1…</a></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实现页面截图及截图内容包含跨域图片时的处理]]></title>    <link>https://juejin.cn/post/7585406030020886563</link>    <guid>https://juejin.cn/post/7585406030020886563</guid>    <pubDate>2025-12-19T12:54:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030020886563" data-draft-id="7585394082823012386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实现页面截图及截图内容包含跨域图片时的处理"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-19T12:54:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户188787106984"/> <meta itemprop="url" content="https://juejin.cn/user/2455640372153627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实现页面截图及截图内容包含跨域图片时的处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455640372153627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户188787106984
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:54:19.000Z" title="Fri Dec 19 2025 12:54:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目中遇到需要实现指定位置的截图，采取使用依赖 html2canvas 实现。
参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml2canvas.hertzen.com%2F" target="_blank" title="https://html2canvas.hertzen.com/" ref="nofollow noopener noreferrer">html2canvas.hertzen.com/</a></p>
<h4 data-id="heading-0">一、实现步骤：</h4>
<p>1、下载依赖或者使用官方js文件链接，本文使用的js链接；
2、代码
style</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.screen-box</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}
</code></pre>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"screen-box"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"screen-box"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这是一个需要截图的区域<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"screenShot()"</span>&gt;</span>点击截图<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>script</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://html2canvas.hertzen.com/dist/html2canvas.min.js"</span>&gt;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">srcipt</span>&gt;</span>
</span></code></pre>

<pre><code class="hljs language-ini" lang="ini">&lt;script&gt;
function screenShot() {
  const <span class="hljs-attr">element</span> = document.getElementById(<span class="hljs-string">'screen-box'</span>)<span class="hljs-comment">;</span>
  html2canvas(element).then(<span class="hljs-attr">canvas</span> =&gt; {
    const <span class="hljs-attr">img</span> = canvas.toDataURL(<span class="hljs-string">'image/png'</span>)<span class="hljs-comment">;</span>
    downloadImage(img)<span class="hljs-comment">;</span>
  })
}

function downloadImage(imgUrl, <span class="hljs-attr">fileName</span> = <span class="hljs-string">'image.png'</span>) {
  // 1. 创建a标签
  const <span class="hljs-attr">link</span> = document.createElement(<span class="hljs-string">'a'</span>)<span class="hljs-comment">;</span>
  // 2. 设置下载属性（指定文件名）
  <span class="hljs-attr">link.download</span> = fileName<span class="hljs-comment">;</span>
  // 3. 设置图片地址为a标签的href
  <span class="hljs-attr">link.href</span> = imgUrl<span class="hljs-comment">;</span>
  // 4. 隐藏a标签（可选，避免页面渲染）
  // <span class="hljs-attr">link.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
  // 5. 将a标签添加到DOM中（部分浏览器需要）
  document.body.appendChild(link)<span class="hljs-comment">;</span>
  // 6. 触发点击事件下载
  link.click()<span class="hljs-comment">;</span>
  // 7. 下载后移除a标签（清理DOM）
  document.body.removeChild(link)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-1">二、易错：</h4>
<p>1、当 html 中包含有同源图片时，此代码可下载的图片文件中包含html的图片；
2、当 html 中包含跨域图片时，此代码下载的图片文件会中不会显示html包含的文件。
例如，当需截图的代码片段中含有由第三方引入的图片地址：
html：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">id</span>=<span class="hljs-string">"screen-box"</span> class=<span class="hljs-string">"screen-box"</span>&gt;
  &lt;h1&gt;这是一个需要截图的区域&lt;/h1&gt;
  &lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"https://gips3.baidu.com/it/u=1821127123,1149655687&amp;fm=3028&amp;app=3028&amp;f=JPEG&amp;fmt=auto?w=720&amp;h=1280"</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">"300px"</span> title=<span class="hljs-string">"截图区图片"</span> alt=<span class="hljs-string">"图片"</span> /&gt;
&lt;/div&gt;
&lt;button <span class="hljs-attr">onclick</span>=<span class="hljs-string">"screenShot()"</span>&gt;点击截图&lt;/button&gt;
</code></pre>
<p>截图： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c05c6db92a44192b97141583866c921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766753659&amp;x-signature=GrXnEnAxfAkmKyL0vzN9n9I4Rxw%3D" width="300" loading="lazy"/></p>
<h5 data-id="heading-2">原因：</h5>
<p>这是由于 canvas 受限于 CORS 策略, 会存在跨域问题, 虽然可以使用图像, 但是绘制到画布上会污染画布, 一旦一个画布被污染, 就无法提取画布的数据。比如无法使用画布 toBlod() , toDataURL() 或者 getImageData() 方法。</p>
<h5 data-id="heading-3">解决办法：</h5>
<p>增加代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将文件读入到 blob 文件对象, 然后使用 URL.createObjectURL 转换成 src 可用的地址</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">toBlob</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> domUrl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">'img'</span>)[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(domUrl.<span class="hljs-property">src</span>, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span> });
  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'图片请求失败'</span>);
  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">blob</span>();
  <span class="hljs-keyword">const</span> blobUrl = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob);
  domUrl.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'src'</span>, blobUrl);
}
</code></pre>
<p>修改 screenShot 函数：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">screenShot</span>()</span> {
  <span class="hljs-keyword">await</span> toBlob();
  ...
}
</code></pre>
<p>修改代码后，截图如下：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39087970ae454c5b8b6b6e05793c460d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766753659&amp;x-signature=Ulz%2BxMH7EuzFLTRZeIK5JCBMPS0%3D" width="300" loading="lazy"/>
<h4 data-id="heading-4">三、本地地址的图片（地址为"file://"开头）不支持此方法</h4>
<h5 data-id="heading-5">解决办法：</h5>
<p>可将图片转码后赋值img标签的src属性再进行操作。</p>
<p>博客园：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwttt123%2Fp%2F19323299" target="_blank" title="https://www.cnblogs.com/wttt123/p/19323299" ref="nofollow noopener noreferrer">www.cnblogs.com/wttt123/p/1…</a></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SVG描边 - CSS3实现动画绘制矢量图]]></title>    <link>https://juejin.cn/post/7585406030020968483</link>    <guid>https://juejin.cn/post/7585406030020968483</guid>    <pubDate>2025-12-19T13:04:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030020968483" data-draft-id="7585406030020935715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SVG描边 - CSS3实现动画绘制矢量图"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-19T13:04:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户188787106984"/> <meta itemprop="url" content="https://juejin.cn/user/2455640372153627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SVG描边 - CSS3实现动画绘制矢量图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455640372153627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户188787106984
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T13:04:17.000Z" title="Fri Dec 19 2025 13:04:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读43分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用 SVG 的 stroke-dasharray 及 stroke-dashoffset，结合 CSS3 animation 实现画笔绘制矢量图的动画效果，如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac29e600cd884decad013bb615b5d02a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766754311&amp;x-signature=wo9Gx9O86UgoyXxJrAJP4Zt5Uac%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">html</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;svg
    <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span>
    <span class="hljs-attr">pointer-events</span>=<span class="hljs-string">"none"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"leaflet-zoom-animated"</span>
    <span class="hljs-attr">width</span>=<span class="hljs-string">"1452"</span>
    <span class="hljs-attr">height</span>=<span class="hljs-string">"857"</span>
    <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"-121 -71 1452 857"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"transform: translate3d(-121px, -71px, 0px)"</span>
  &gt;
    &lt;g&gt;
      &lt;path
        <span class="hljs-attr">class</span>=<span class="hljs-string">"leaflet-interactive"</span>
        <span class="hljs-attr">stroke</span>=<span class="hljs-string">"black"</span>
        <span class="hljs-attr">stroke-opacity</span>=<span class="hljs-string">"1"</span>
        <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"2"</span>
        <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span>
        <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span>
        <span class="hljs-attr">fill</span>=<span class="hljs-string">"red"</span>
        <span class="hljs-attr">fill-opacity</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">fill-rule</span>=<span class="hljs-string">"evenodd"</span>
        <span class="hljs-attr">d</span>=<span class="hljs-string">"M605 623L605 625L609 621L610 623L613 622L616 624L624 616L630 612L637 610L638 608L641 610L639 614L642 616L645 616L646 613L652 610L652 608L653 610L657 610L657 602L659 602L660 600L656 584L653 580L652 575L654 569L652 561L655 555L656 557L660 555L663 556L666 549L670 547L670 544L676 540L680 535L680 531L683 527L681 527L680 524L677 523L678 518L682 516L686 511L690 514L697 509L695 499L693 498L696 494L696 490L698 493L699 492L701 494L706 492L708 494L711 491L722 492L722 494L720 494L718 497L714 497L716 507L721 508L721 510L724 511L723 514L721 514L722 516L724 516L724 519L720 522L717 522L726 531L730 533L737 530L743 530L745 528L745 525L746 526L748 524L748 521L751 520L757 521L757 525L761 525L762 527L759 530L760 533L763 534L762 540L769 536L776 539L778 542L784 539L787 540L788 538L800 536L803 537L810 534L808 530L809 527L805 524L806 520L801 516L798 516L795 518L796 519L793 519L792 517L789 519L789 512L784 507L782 511L778 508L778 502L776 500L777 498L780 497L780 494L789 494L789 491L793 485L796 489L798 489L799 492L801 491L803 495L809 500L811 500L811 497L809 496L809 490L804 478L796 478L796 475L794 474L789 478L788 476L787 477L783 473L784 472L782 468L783 466L781 464L781 458L779 460L777 458L776 460L774 458L772 459L770 458L770 456L768 457L769 452L766 451L766 449L763 450L764 449L762 443L767 439L766 438L769 438L770 436L773 437L775 434L775 430L782 428L781 425L783 420L780 419L778 415L776 415L775 412L774 413L774 411L778 411L777 406L782 407L781 404L785 398L790 399L791 401L796 401L800 405L801 404L804 410L808 410L808 408L813 408L814 405L820 404L823 407L822 409L825 412L826 417L830 420L832 418L836 419L839 416L841 419L844 417L843 416L848 412L855 398L863 387L860 385L861 383L859 382L863 375L869 377L871 374L873 374L874 378L876 377L877 379L885 373L882 370L885 366L888 366L886 363L889 358L889 355L886 355L894 350L892 348L895 346L894 343L896 341L900 341L901 339L903 339L902 337L905 334L908 334L908 329L910 327L903 324L903 322L901 322L897 316L901 316L901 311L906 310L902 305L906 305L909 303L907 300L900 302L895 301L893 303L887 303L885 307L882 304L879 304L874 296L872 297L871 293L867 292L864 294L860 292L860 286L858 285L854 288L852 293L850 292L843 285L845 282L842 277L843 276L828 275L823 278L821 277L815 279L813 281L810 278L802 277L797 273L798 270L796 268L795 270L786 270L784 274L781 273L777 277L774 274L771 265L769 264L767 265L767 270L770 274L762 279L760 278L755 282L753 282L750 279L745 282L743 282L742 279L734 279L722 273L716 268L716 264L719 264L723 260L719 258L720 254L717 244L722 243L718 242L711 235L711 227L706 223L697 223L693 225L687 221L681 224L683 220L681 216L677 220L674 220L669 216L665 216L666 211L663 209L665 206L664 202L666 201L662 196L656 195L657 193L655 189L652 189L651 191L642 195L642 197L639 198L642 200L633 202L632 201L630 207L626 207L627 206L618 208L623 213L623 217L627 219L625 221L628 221L626 224L627 226L634 231L632 232L632 237L629 239L625 238L621 242L621 248L617 245L615 250L610 250L606 255L604 254L605 250L602 246L606 244L606 241L610 236L605 228L603 231L602 230L602 236L598 237L596 243L599 244L600 247L595 255L589 248L584 249L585 252L580 246L575 246L574 248L572 248L574 253L573 256L575 258L575 261L572 261L572 265L577 268L577 275L574 279L572 280L572 278L570 278L564 282L562 280L556 280L553 278L554 281L551 282L552 286L550 286L545 282L540 275L539 277L539 275L536 276L533 274L531 282L530 280L527 280L525 278L527 276L527 269L524 266L522 266L523 264L519 263L519 261L516 258L514 264L511 263L510 265L512 267L508 275L508 273L503 272L501 269L498 269L493 266L488 267L484 258L471 254L468 251L465 244L466 240L464 238L464 234L460 231L458 227L460 225L454 218L452 218L453 217L449 213L450 204L448 203L448 201L440 202L435 199L432 200L428 195L421 194L420 197L415 199L417 203L414 206L415 208L413 210L403 212L403 214L401 215L404 221L404 228L408 229L410 235L413 235L419 239L417 239L417 241L415 241L411 248L409 249L407 253L409 257L409 259L407 259L408 261L401 264L402 272L406 279L412 281L416 286L426 288L440 296L440 301L444 308L450 314L450 319L448 319L449 324L453 327L455 333L470 348L466 354L464 354L462 350L459 350L458 358L467 368L465 373L474 382L471 385L473 390L472 393L474 397L475 413L478 416L477 419L479 424L476 430L475 437L478 443L479 458L481 460L480 464L482 476L480 483L482 487L482 492L484 494L483 503L489 510L488 511L494 517L493 508L496 504L494 502L494 498L500 492L501 488L504 486L503 485L508 481L508 486L521 498L521 500L525 503L524 504L529 508L528 510L530 512L528 514L523 515L522 517L525 523L530 528L529 529L533 532L535 531L535 538L536 539L541 532L546 534L549 532L550 529L552 529L554 532L553 535L560 542L559 543L563 549L562 553L563 552L565 554L569 566L574 566L573 575L579 578L578 580L585 584L583 588L584 589L586 590L588 589L588 587L590 588L587 591L589 593L588 596L585 596L585 599L596 607L595 609L597 609L593 612L594 614L599 615L604 622zM806 410L806 410zM839 416L839 416zM774 411L774 411z"</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"四川省"</span>
      /&gt;
    &lt;/g&gt;
  &lt;/svg&gt;
</code></pre>
<h3 data-id="heading-1">style</h3>
<pre><code class="hljs language-css" lang="css">path {
  stroke-dasharray: <span class="hljs-number">2810</span>;
  stroke-dashoffset: <span class="hljs-number">2810</span>;
  fill-<span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-comment">/* animation: name duration timing-function delay iteration-count direction fill-mode play-state; */</span>
  <span class="hljs-attribute">animation</span>: dash <span class="hljs-number">10s</span> linear <span class="hljs-number">3s</span> <span class="hljs-number">1</span> forwards,
              dashOpacity <span class="hljs-number">5s</span> linear <span class="hljs-number">14s</span> <span class="hljs-number">1</span> forwards;
}
<span class="hljs-keyword">@keyframes</span> dash {
  <span class="hljs-selector-tag">to</span> {
    stroke-dashoffset: <span class="hljs-number">0</span>;
  }
}
<span class="hljs-keyword">@keyframes</span> dashOpacity {
  <span class="hljs-selector-tag">to</span> {
    fill-<span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.3</span>;
  }
}
</code></pre>
<h3 data-id="heading-2">script</h3>
<p>用于获取 svg 矢量图的长度</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">path</span> = document.querySelector(<span class="hljs-string">"path"</span>)<span class="hljs-comment">;</span>
var <span class="hljs-attr">length</span> = path.getTotalLength()<span class="hljs-comment">;</span>
console.log(length)<span class="hljs-comment">;</span>
</code></pre>
<p>拓展：在以上基础上实现流光效果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe93eb97ccc649fd8912bf352efa9f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766754311&amp;x-signature=xCDSCVohTyxT8S5ftHR73lBgONE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">html</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;svg
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span>
  <span class="hljs-attr">pointer-events</span>=<span class="hljs-string">"cursor"</span>
  <span class="hljs-attr">width</span>=<span class="hljs-string">"1452"</span>
  <span class="hljs-attr">height</span>=<span class="hljs-string">"857"</span>
  <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"-121 -71 1452 857"</span>
&gt;
  &lt;g&gt;
    &lt;path
      <span class="hljs-attr">class</span>=<span class="hljs-string">"animation-0"</span>
      <span class="hljs-attr">stroke-opacity</span>=<span class="hljs-string">"1"</span>
      <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"2"</span>
      <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span>
      <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span>
      <span class="hljs-attr">fill-opacity</span>=<span class="hljs-string">"0"</span>
      <span class="hljs-attr">fill-rule</span>=<span class="hljs-string">"evenodd"</span>
      <span class="hljs-attr">d</span>=<span class="hljs-string">"M605 623L605 625L609 621L610 623L613 622L616 624L624 616L630 612L637 610L638 608L641 610L639 614L642 616L645 616L646 613L652 610L652 608L653 610L657 610L657 602L659 602L660 600L656 584L653 580L652 575L654 569L652 561L655 555L656 557L660 555L663 556L666 549L670 547L670 544L676 540L680 535L680 531L683 527L681 527L680 524L677 523L678 518L682 516L686 511L690 514L697 509L695 499L693 498L696 494L696 490L698 493L699 492L701 494L706 492L708 494L711 491L722 492L722 494L720 494L718 497L714 497L716 507L721 508L721 510L724 511L723 514L721 514L722 516L724 516L724 519L720 522L717 522L726 531L730 533L737 530L743 530L745 528L745 525L746 526L748 524L748 521L751 520L757 521L757 525L761 525L762 527L759 530L760 533L763 534L762 540L769 536L776 539L778 542L784 539L787 540L788 538L800 536L803 537L810 534L808 530L809 527L805 524L806 520L801 516L798 516L795 518L796 519L793 519L792 517L789 519L789 512L784 507L782 511L778 508L778 502L776 500L777 498L780 497L780 494L789 494L789 491L793 485L796 489L798 489L799 492L801 491L803 495L809 500L811 500L811 497L809 496L809 490L804 478L796 478L796 475L794 474L789 478L788 476L787 477L783 473L784 472L782 468L783 466L781 464L781 458L779 460L777 458L776 460L774 458L772 459L770 458L770 456L768 457L769 452L766 451L766 449L763 450L764 449L762 443L767 439L766 438L769 438L770 436L773 437L775 434L775 430L782 428L781 425L783 420L780 419L778 415L776 415L775 412L774 413L774 411L778 411L777 406L782 407L781 404L785 398L790 399L791 401L796 401L800 405L801 404L804 410L808 410L808 408L813 408L814 405L820 404L823 407L822 409L825 412L826 417L830 420L832 418L836 419L839 416L841 419L844 417L843 416L848 412L855 398L863 387L860 385L861 383L859 382L863 375L869 377L871 374L873 374L874 378L876 377L877 379L885 373L882 370L885 366L888 366L886 363L889 358L889 355L886 355L894 350L892 348L895 346L894 343L896 341L900 341L901 339L903 339L902 337L905 334L908 334L908 329L910 327L903 324L903 322L901 322L897 316L901 316L901 311L906 310L902 305L906 305L909 303L907 300L900 302L895 301L893 303L887 303L885 307L882 304L879 304L874 296L872 297L871 293L867 292L864 294L860 292L860 286L858 285L854 288L852 293L850 292L843 285L845 282L842 277L843 276L828 275L823 278L821 277L815 279L813 281L810 278L802 277L797 273L798 270L796 268L795 270L786 270L784 274L781 273L777 277L774 274L771 265L769 264L767 265L767 270L770 274L762 279L760 278L755 282L753 282L750 279L745 282L743 282L742 279L734 279L722 273L716 268L716 264L719 264L723 260L719 258L720 254L717 244L722 243L718 242L711 235L711 227L706 223L697 223L693 225L687 221L681 224L683 220L681 216L677 220L674 220L669 216L665 216L666 211L663 209L665 206L664 202L666 201L662 196L656 195L657 193L655 189L652 189L651 191L642 195L642 197L639 198L642 200L633 202L632 201L630 207L626 207L627 206L618 208L623 213L623 217L627 219L625 221L628 221L626 224L627 226L634 231L632 232L632 237L629 239L625 238L621 242L621 248L617 245L615 250L610 250L606 255L604 254L605 250L602 246L606 244L606 241L610 236L605 228L603 231L602 230L602 236L598 237L596 243L599 244L600 247L595 255L589 248L584 249L585 252L580 246L575 246L574 248L572 248L574 253L573 256L575 258L575 261L572 261L572 265L577 268L577 275L574 279L572 280L572 278L570 278L564 282L562 280L556 280L553 278L554 281L551 282L552 286L550 286L545 282L540 275L539 277L539 275L536 276L533 274L531 282L530 280L527 280L525 278L527 276L527 269L524 266L522 266L523 264L519 263L519 261L516 258L514 264L511 263L510 265L512 267L508 275L508 273L503 272L501 269L498 269L493 266L488 267L484 258L471 254L468 251L465 244L466 240L464 238L464 234L460 231L458 227L460 225L454 218L452 218L453 217L449 213L450 204L448 203L448 201L440 202L435 199L432 200L428 195L421 194L420 197L415 199L417 203L414 206L415 208L413 210L403 212L403 214L401 215L404 221L404 228L408 229L410 235L413 235L419 239L417 239L417 241L415 241L411 248L409 249L407 253L409 257L409 259L407 259L408 261L401 264L402 272L406 279L412 281L416 286L426 288L440 296L440 301L444 308L450 314L450 319L448 319L449 324L453 327L455 333L470 348L466 354L464 354L462 350L459 350L458 358L467 368L465 373L474 382L471 385L473 390L472 393L474 397L475 413L478 416L477 419L479 424L476 430L475 437L478 443L479 458L481 460L480 464L482 476L480 483L482 487L482 492L484 494L483 503L489 510L488 511L494 517L493 508L496 504L494 502L494 498L500 492L501 488L504 486L503 485L508 481L508 486L521 498L521 500L525 503L524 504L529 508L528 510L530 512L528 514L523 515L522 517L525 523L530 528L529 529L533 532L535 531L535 538L536 539L541 532L546 534L549 532L550 529L552 529L554 532L553 535L560 542L559 543L563 549L562 553L563 552L565 554L569 566L574 566L573 575L579 578L578 580L585 584L583 588L584 589L586 590L588 589L588 587L590 588L587 591L589 593L588 596L585 596L585 599L596 607L595 609L597 609L593 612L594 614L599 615L604 622zM806 410L806 410zM839 416L839 416zM774 411L774 411z"</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">"四川省"</span>
      <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#00ffd0"</span>
      <span class="hljs-attr">stroke-dasharray</span>=<span class="hljs-string">"2810"</span>
      <span class="hljs-attr">stroke-dashoffset</span>=<span class="hljs-string">"2810"</span>
    /&gt;
    &lt;path
      <span class="hljs-attr">class</span>=<span class="hljs-string">"animation-1"</span>
      <span class="hljs-attr">stroke-opacity</span>=<span class="hljs-string">"0"</span>
      <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"2"</span>
      <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span>
      <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span>
      <span class="hljs-attr">fill-opacity</span>=<span class="hljs-string">"0"</span>
      <span class="hljs-attr">fill-rule</span>=<span class="hljs-string">"evenodd"</span>
      <span class="hljs-attr">d</span>=<span class="hljs-string">"M605 623L605 625L609 621L610 623L613 622L616 624L624 616L630 612L637 610L638 608L641 610L639 614L642 616L645 616L646 613L652 610L652 608L653 610L657 610L657 602L659 602L660 600L656 584L653 580L652 575L654 569L652 561L655 555L656 557L660 555L663 556L666 549L670 547L670 544L676 540L680 535L680 531L683 527L681 527L680 524L677 523L678 518L682 516L686 511L690 514L697 509L695 499L693 498L696 494L696 490L698 493L699 492L701 494L706 492L708 494L711 491L722 492L722 494L720 494L718 497L714 497L716 507L721 508L721 510L724 511L723 514L721 514L722 516L724 516L724 519L720 522L717 522L726 531L730 533L737 530L743 530L745 528L745 525L746 526L748 524L748 521L751 520L757 521L757 525L761 525L762 527L759 530L760 533L763 534L762 540L769 536L776 539L778 542L784 539L787 540L788 538L800 536L803 537L810 534L808 530L809 527L805 524L806 520L801 516L798 516L795 518L796 519L793 519L792 517L789 519L789 512L784 507L782 511L778 508L778 502L776 500L777 498L780 497L780 494L789 494L789 491L793 485L796 489L798 489L799 492L801 491L803 495L809 500L811 500L811 497L809 496L809 490L804 478L796 478L796 475L794 474L789 478L788 476L787 477L783 473L784 472L782 468L783 466L781 464L781 458L779 460L777 458L776 460L774 458L772 459L770 458L770 456L768 457L769 452L766 451L766 449L763 450L764 449L762 443L767 439L766 438L769 438L770 436L773 437L775 434L775 430L782 428L781 425L783 420L780 419L778 415L776 415L775 412L774 413L774 411L778 411L777 406L782 407L781 404L785 398L790 399L791 401L796 401L800 405L801 404L804 410L808 410L808 408L813 408L814 405L820 404L823 407L822 409L825 412L826 417L830 420L832 418L836 419L839 416L841 419L844 417L843 416L848 412L855 398L863 387L860 385L861 383L859 382L863 375L869 377L871 374L873 374L874 378L876 377L877 379L885 373L882 370L885 366L888 366L886 363L889 358L889 355L886 355L894 350L892 348L895 346L894 343L896 341L900 341L901 339L903 339L902 337L905 334L908 334L908 329L910 327L903 324L903 322L901 322L897 316L901 316L901 311L906 310L902 305L906 305L909 303L907 300L900 302L895 301L893 303L887 303L885 307L882 304L879 304L874 296L872 297L871 293L867 292L864 294L860 292L860 286L858 285L854 288L852 293L850 292L843 285L845 282L842 277L843 276L828 275L823 278L821 277L815 279L813 281L810 278L802 277L797 273L798 270L796 268L795 270L786 270L784 274L781 273L777 277L774 274L771 265L769 264L767 265L767 270L770 274L762 279L760 278L755 282L753 282L750 279L745 282L743 282L742 279L734 279L722 273L716 268L716 264L719 264L723 260L719 258L720 254L717 244L722 243L718 242L711 235L711 227L706 223L697 223L693 225L687 221L681 224L683 220L681 216L677 220L674 220L669 216L665 216L666 211L663 209L665 206L664 202L666 201L662 196L656 195L657 193L655 189L652 189L651 191L642 195L642 197L639 198L642 200L633 202L632 201L630 207L626 207L627 206L618 208L623 213L623 217L627 219L625 221L628 221L626 224L627 226L634 231L632 232L632 237L629 239L625 238L621 242L621 248L617 245L615 250L610 250L606 255L604 254L605 250L602 246L606 244L606 241L610 236L605 228L603 231L602 230L602 236L598 237L596 243L599 244L600 247L595 255L589 248L584 249L585 252L580 246L575 246L574 248L572 248L574 253L573 256L575 258L575 261L572 261L572 265L577 268L577 275L574 279L572 280L572 278L570 278L564 282L562 280L556 280L553 278L554 281L551 282L552 286L550 286L545 282L540 275L539 277L539 275L536 276L533 274L531 282L530 280L527 280L525 278L527 276L527 269L524 266L522 266L523 264L519 263L519 261L516 258L514 264L511 263L510 265L512 267L508 275L508 273L503 272L501 269L498 269L493 266L488 267L484 258L471 254L468 251L465 244L466 240L464 238L464 234L460 231L458 227L460 225L454 218L452 218L453 217L449 213L450 204L448 203L448 201L440 202L435 199L432 200L428 195L421 194L420 197L415 199L417 203L414 206L415 208L413 210L403 212L403 214L401 215L404 221L404 228L408 229L410 235L413 235L419 239L417 239L417 241L415 241L411 248L409 249L407 253L409 257L409 259L407 259L408 261L401 264L402 272L406 279L412 281L416 286L426 288L440 296L440 301L444 308L450 314L450 319L448 319L449 324L453 327L455 333L470 348L466 354L464 354L462 350L459 350L458 358L467 368L465 373L474 382L471 385L473 390L472 393L474 397L475 413L478 416L477 419L479 424L476 430L475 437L478 443L479 458L481 460L480 464L482 476L480 483L482 487L482 492L484 494L483 503L489 510L488 511L494 517L493 508L496 504L494 502L494 498L500 492L501 488L504 486L503 485L508 481L508 486L521 498L521 500L525 503L524 504L529 508L528 510L530 512L528 514L523 515L522 517L525 523L530 528L529 529L533 532L535 531L535 538L536 539L541 532L546 534L549 532L550 529L552 529L554 532L553 535L560 542L559 543L563 549L562 553L563 552L565 554L569 566L574 566L573 575L579 578L578 580L585 584L583 588L584 589L586 590L588 589L588 587L590 588L587 591L589 593L588 596L585 596L585 599L596 607L595 609L597 609L593 612L594 614L599 615L604 622zM806 410L806 410zM839 416L839 416zM774 411L774 411z"</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">"四川省"</span>
      <span class="hljs-attr">stroke</span>=<span class="hljs-string">"blue"</span>
      <span class="hljs-attr">stroke-dasharray</span>=<span class="hljs-string">"20 2810"</span>
      <span class="hljs-attr">stroke-dashoffset</span>=<span class="hljs-string">"2810"</span>
    /&gt;
  &lt;/g&gt;
&lt;/svg&gt;
</code></pre>
<h3 data-id="heading-4">style</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.animation-0</span> {
  <span class="hljs-attribute">animation</span>: dash <span class="hljs-number">10s</span> linear <span class="hljs-number">0.1s</span> <span class="hljs-number">1</span> forwards;
}
<span class="hljs-keyword">@keyframes</span> dash {
  <span class="hljs-selector-tag">to</span> {
    stroke-dashoffset: <span class="hljs-number">0</span>;
  }
}

<span class="hljs-comment">/* 实现流光 */</span>
<span class="hljs-selector-class">.animation-1</span> {
  <span class="hljs-comment">/* animation: name duration timing-function delay iteration-count direction fill-mode play-state; */</span>
  <span class="hljs-attribute">animation</span>: strokedash0 <span class="hljs-number">0.1s</span> linear <span class="hljs-number">10.1s</span> <span class="hljs-number">1</span> forwards,
              dash1 <span class="hljs-number">10s</span> linear <span class="hljs-number">10.2s</span> infinite forwards;
}
<span class="hljs-keyword">@keyframes</span> strokedash0 {
  <span class="hljs-selector-tag">to</span> {
    stroke-<span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  }
}
<span class="hljs-keyword">@keyframes</span> dash1 {
  <span class="hljs-selector-tag">to</span> {
    stroke-dashoffset: <span class="hljs-number">0</span>;
  }
}
<span class="hljs-keyword">@keyframes</span> strokedash1 {
  <span class="hljs-selector-tag">to</span> {
    stroke-<span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>博客园：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwttt123%2Fp%2F18101630" target="_blank" title="https://www.cnblogs.com/wttt123/p/18101630" ref="nofollow noopener noreferrer">www.cnblogs.com/wttt123/p/1…</a></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于vant3的搜索选择组件]]></title>    <link>https://juejin.cn/post/7585406030020984867</link>    <guid>https://juejin.cn/post/7585406030020984867</guid>    <pubDate>2025-12-19T13:08:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030020984867" data-draft-id="7585391510058762292" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于vant3的搜索选择组件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-19T13:08:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户188787106984"/> <meta itemprop="url" content="https://juejin.cn/user/2455640372153627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于vant3的搜索选择组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455640372153627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户188787106984
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T13:08:43.000Z" title="Fri Dec 19 2025 13:08:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>效果如下：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec13594764942199c3adf9350292a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTg4Nzg3MTA2OTg0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766754523&amp;x-signature=dZ7FLf5SZvHoL3GhYzFy6Jcb4HY%3D" width="150px" loading="lazy"/>
<p>使用：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;search-list
  :<span class="hljs-attr">list</span>=<span class="hljs-string">"List"</span>
  :<span class="hljs-attr">isShow</span>=<span class="hljs-string">"true"</span>
  :<span class="hljs-attr">isAddShow</span>=<span class="hljs-string">"true"</span>
  :<span class="hljs-attr">keyName</span>=<span class="hljs-string">"key"</span>
  :<span class="hljs-attr">typeName</span>=<span class="hljs-string">"name"</span>
  @<span class="hljs-attr">item-check</span>=<span class="hljs-string">"itemCheck"</span>
  @<span class="hljs-attr">show-status</span>=<span class="hljs-string">"showStatus"</span>
  @<span class="hljs-attr">call-back</span>=<span class="hljs-string">"callBack"</span>
/&gt;
</code></pre>
<p>参数值：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">List:</span> any[] = [{},{}];
<span class="hljs-symbol">isAddShow:</span> 新增的模块是否显示  不填默认为<span class="hljs-literal">false</span>
<span class="hljs-symbol">keyName:</span> 搜素及显示的键名
<span class="hljs-symbol">typeName:</span> 分类名
<span class="hljs-symbol">itemCheck:</span> 返回选中数据
<span class="hljs-symbol">showStatus:</span> 返回弹窗是否show  param: <span class="hljs-type">boolean</span>
<span class="hljs-symbol">callBack:</span> 点击新增按钮返回数据  param: 搜素框中的输入值
</code></pre>
<p>例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">List</span>= [
  {
    driverId: <span class="hljs-string">'111011101'</span>,
    driverName: <span class="hljs-string">'司机姓名'</span>,
    driverTel: <span class="hljs-string">'13112341234'</span>,
  }
]
<span class="hljs-attr">keyName</span>=<span class="hljs-string">'driverName'</span> 搜素列表显示driverName的数据，搜索页搜索driverName
<span class="hljs-attr">typeName</span>=<span class="hljs-string">'司机'</span> 搜索弹窗：【以下不是我的司机】 【点击建立新的司机】
itemCheck: 返回数据为： params: {driverId:'',driverName:'',driverTel:''}
callBack： 返回数据为'司机'
</code></pre>
<p>vue:</p>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;van-popup v-model:<span class="hljs-attr">show</span>=<span class="hljs-string">"show"</span> round position=<span class="hljs-string">"bottom"</span> :closeable=<span class="hljs-string">"true"</span> :close-icon=<span class="hljs-string">"closeImg"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"list-box"</span>&gt;
      &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"top-box"</span>&gt;
        &lt;p <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;请选择{{ typeName }}&lt;/p&gt;
        &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"search-box"</span>&gt;
          &lt;van-search
            <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchValue"</span>
            show-action
            <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"off"</span>
            autofocus
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入搜索关键词"</span>
            @<span class="hljs-attr">search</span>=<span class="hljs-string">"onSearch"</span>
            @<span class="hljs-attr">clear</span>=<span class="hljs-string">"onClear"</span>
          &gt;
            &lt;template <span class="hljs-comment">#action&gt;</span>
              &lt;div @<span class="hljs-attr">click</span>=<span class="hljs-string">"onSearch"</span> class=<span class="hljs-string">"search-btn"</span>&gt;搜索&lt;/div&gt;
            &lt;/template&gt;
          &lt;/van-search&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"list-box"</span>&gt;
        &lt;van-list <span class="hljs-attr">finished-text</span>=<span class="hljs-string">"没有更多了"</span>&gt;
          &lt;van-cell <span class="hljs-attr">class</span>=<span class="hljs-string">"add-box"</span> v-if=<span class="hljs-string">"addShow ? addShow : false"</span>&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"cell-title"</span>&gt;以下不是我的{{ typeName }}&lt;/div&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"cell-info"</span> @click=<span class="hljs-string">"target"</span>&gt;
              点击建立
              &lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"blue"</span>&gt;新的{{ typeName }}&lt;/span&gt;
            &lt;/div&gt;
          &lt;/van-cell&gt;
          &lt;template <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in listArr"</span> :key=<span class="hljs-string">"item"</span>&gt;
            &lt;van-cell @<span class="hljs-attr">click</span>=<span class="hljs-string">"checkItem(item)"</span>&gt;
              &lt;span
                <span class="hljs-attr">v-for</span>=<span class="hljs-string">"res in item[keyName]"</span>
                :<span class="hljs-attr">key</span>=<span class="hljs-string">"res"</span>
                :<span class="hljs-attr">class</span>=<span class="hljs-string">"
                  searchValue.length &gt; 0 &amp;&amp;
                  searchValue.indexOf(res) &gt; -1 &amp;&amp;
                  item[keyName].includes(searchValue)
                    ? 'active'
                    : ''
                "</span>
              &gt;
                {{ res }}
              &lt;/span&gt;
            &lt;/van-cell&gt;
          &lt;/template&gt;
        &lt;/van-list&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/van-popup&gt;
&lt;/template&gt;
</code></pre>
<p>ts:</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;
  import { defineComponent, ref, watch, watchEffect } from 'vue'<span class="hljs-comment">;</span>
  import { Popup, Cell, Search, List, Toast } from 'vant'<span class="hljs-comment">;</span>

  import closeImg from '/@/assets/images/close-1.png'<span class="hljs-comment">;</span>

  export default defineComponent({
    name: 'SearchDriver',
    components: {
      <span class="hljs-section">[Popup.name]</span>: Popup,
      <span class="hljs-section">[Cell.name]</span>: Cell,
      <span class="hljs-section">[Search.name]</span>: Search,
      <span class="hljs-section">[List.name]</span>: List,
    },
    props: {
      list: {
        type: Array,
        required: true,
        default: () =&gt; {
          return <span class="hljs-section">['']</span><span class="hljs-comment">;</span>
        },
      },
      isShow: {
        type: Boolean,
        default: false,
      },
      keyName: {
        type: String,
        default: '',
      },
      typeName: {
        type: String,
        default: '司机',
      },
      isAddShow: {
        type: Boolean,
        default: false,
      },
    },
    emits: <span class="hljs-section">['itemCheck', 'showStatus', 'callBack']</span>,
    setup(props, { emit }) {
      const <span class="hljs-attr">searchValue</span> = ref&lt;string&gt;(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
      // 数组
      let <span class="hljs-attr">propList</span> = ref&lt;string[]&gt;(props.list as string[])<span class="hljs-comment">;</span>
      let <span class="hljs-attr">newList</span> = ref&lt;string[]&gt;(props.list as string[])<span class="hljs-comment">;</span>
      // 弹窗是否显示
      let <span class="hljs-attr">show</span> = ref&lt;boolean&gt;(props.isShow)<span class="hljs-comment">;</span>
      // 新增模块是否显示
      let <span class="hljs-attr">addShow</span> = ref&lt;boolean&gt;(props.isAddShow)<span class="hljs-comment">;</span>
      // 列表显示数据
      let <span class="hljs-attr">listArr</span> = ref&lt;any&gt;()<span class="hljs-comment">;</span>
      // 类型
      let <span class="hljs-attr">type</span> = ref&lt;string&gt;(props.typeName)<span class="hljs-comment">;</span>

      const <span class="hljs-attr">dataMap</span> = (arr: any[]) =&gt; {
        if (!arr || arr.length &lt; 1) {
          return <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
        }
        return arr<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      <span class="hljs-attr">listArr.value</span> = dataMap(propList.value)<span class="hljs-comment">;</span>

      const <span class="hljs-attr">onSearch</span> = () =&gt; {
        console.log(searchValue.value)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      // 点击新增按钮后
      const <span class="hljs-attr">target</span> = () =&gt; {
        emit('callBack', searchValue.value)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      // 过滤掉不符合条件的数据
      const <span class="hljs-attr">filterData</span> = (list: any[]) =&gt; {
        <span class="hljs-attr">newList.value</span> = list.filter(
          (item) =&gt; item<span class="hljs-section">[props.keyName]</span> &amp;&amp; item<span class="hljs-section">[props.keyName]</span>.indexOf(searchValue.value) &gt; -1
        )<span class="hljs-comment">;</span>
        <span class="hljs-attr">listArr.value</span> = dataMap(newList.value)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      // 选中数据
      const <span class="hljs-attr">checkItem</span> = (item: any) =&gt; {
        if (!item || item.length &lt; 1) {
          Toast('请重新选择')<span class="hljs-comment">;</span>
          return<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">searchValue.value</span> = item[props.keyName]<span class="hljs-comment">;</span>
        <span class="hljs-attr">show.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        emit('itemCheck', item)<span class="hljs-comment">;</span>
        emit('showStatus', false)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      const <span class="hljs-attr">onClear</span> = () =&gt; {
        <span class="hljs-attr">searchValue.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">show.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        emit('itemCheck', '')<span class="hljs-comment">;</span>
        emit('showStatus', false)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      watchEffect(() =&gt; {
        <span class="hljs-attr">show.value</span> = props.isShow<span class="hljs-comment">;</span>
        <span class="hljs-attr">propList.value</span> = props.list as string[]<span class="hljs-comment">;</span>
        <span class="hljs-attr">newList.value</span> = props.list as string[]<span class="hljs-comment">;</span>
        <span class="hljs-attr">type.value</span> = props.typeName<span class="hljs-comment">;</span>
        filterData(newList.value)<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>

      watch(show, () =&gt; {
        emit('showStatus', show.value)<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>

      watch(type, (old, newValue) =&gt; {
        if (old !== newValue) {
          <span class="hljs-attr">searchValue.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>

      watch(searchValue, (val, oldVal) =&gt; {
        const <span class="hljs-attr">len</span> = val.length<span class="hljs-comment">;</span>
        const <span class="hljs-attr">oldLen</span> = oldVal.length<span class="hljs-comment">;</span>
        if (len &gt; oldLen) {
          // 写入
          filterData(newList.value)<span class="hljs-comment">;</span>
        } else {
          // 删除
          filterData(propList.value)<span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>

      return {
        searchValue,
        show,
        listArr,
        onSearch,
        onClear,
        checkItem,
        target,
        addShow,
        closeImg,
      }<span class="hljs-comment">;</span>
    },
  })<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<p>scss:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@charset</span> <span class="hljs-string">"UTF-8"</span>;

$topHeight: <span class="hljs-number">160px</span>;
$vnoTop: <span class="hljs-number">36px</span>;
$checkColor: <span class="hljs-number">#1777f2</span>;

<span class="hljs-selector-class">.list-box</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">50vh</span>;
  <span class="hljs-attribute">padding-top</span>: $vnoTop;

  <span class="hljs-selector-class">.top-box</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: $vnoTop;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: $topHeight;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e5e5e5</span>;

    <span class="hljs-selector-class">.title</span> {
      <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">40px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">36px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> / <span class="hljs-number">85%</span>);
    }

    <span class="hljs-selector-class">.search-box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">696px</span>;
      <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">15px</span>;

      <span class="hljs-selector-class">.search-btn</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
        <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
        <span class="hljs-attribute">color</span>: $checkColor;
      }
    }
  }

  <span class="hljs-selector-class">.list-box</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">76vh</span>;
    <span class="hljs-attribute">margin-top</span>: $topHeight;
    <span class="hljs-attribute">overflow</span>: auto;

    <span class="hljs-selector-class">.add-box</span> {
      <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">84px</span>;
      <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'../../assets/images/search.png'</span>);
      <span class="hljs-attribute">background-position</span>: <span class="hljs-number">40px</span> <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">background-repeat</span>: no-repeat;
      <span class="hljs-attribute">background-size</span>: <span class="hljs-number">30px</span> <span class="hljs-number">30px</span>;

      <span class="hljs-selector-class">.cell-title</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32px</span>;
        <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#1c1c1c</span>;
      }

      <span class="hljs-selector-class">.cell-info</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
        <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> / <span class="hljs-number">25%</span>);

        <span class="hljs-selector-class">.blue</span> {
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#1777f2</span>;
        }
      }
    }
  }

  <span class="hljs-selector-class">.van-cell</span> {
    <span class="hljs-attribute">position</span>: relative;

    &amp;<span class="hljs-selector-pseudo">::before</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">right</span>: <span class="hljs-built_in">var</span>(--van-padding-md);
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-built_in">var</span>(--van-padding-md);
      <span class="hljs-attribute">pointer-events</span>: none;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--van-cell-border-color);
      <span class="hljs-attribute">content</span>: <span class="hljs-string">' '</span>;
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.5</span>);
      <span class="hljs-attribute">box-sizing</span>: border-box;
    }

    <span class="hljs-selector-tag">span</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">color</span>: $checkColor;
    }
  }
}
</code></pre>
<p>博客园：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwttt123%2Fp%2F18316088" target="_blank" title="https://www.cnblogs.com/wttt123/p/18316088" ref="nofollow noopener noreferrer">www.cnblogs.com/wttt123/p/1…</a></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>