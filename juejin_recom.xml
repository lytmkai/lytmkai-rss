<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[「✍️JS原子笔记 」零基础吃透 Proxy 数据响应式]]></title>    <link>https://juejin.cn/post/7589201772118016006</link>    <guid>https://juejin.cn/post/7589201772118016006</guid>    <pubDate>2025-12-29T13:16:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772118016006" data-draft-id="7589201772117966854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「✍️JS原子笔记 」零基础吃透 Proxy 数据响应式"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-29T13:16:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「✍️JS原子笔记 」零基础吃透 Proxy 数据响应式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T13:16:57.000Z" title="Mon Dec 29 2025 13:16:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,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");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,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");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,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");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>众所周知，在Vue3中，用Proxy代理代替了原有的<code>Object.defineProperty</code>，接下来我用手写数据响应的方式，让大家再次深刻的理解一下Proxy究竟是什么样的“Magic” 。</p>
</blockquote>
<h2 data-id="heading-0">一、先搞懂：什么是「数据响应式」？</h2>
<p>简单说：<strong>当数据发生变化时，页面（或逻辑）自动做出反应，不需要我们手动去更新</strong>。</p>
<p>举个生活例子：</p>
<ul>
<li>你在购物 APP 上把商品加入购物车（数据变化：购物车列表新增商品）</li>
<li>购物车图标上的数字自动从 0 变成 1（页面自动反应）</li>
<li>这个 “数据变 → 页面自动变” 的过程，就是数据响应式。</li>
</ul>
<p>在代码里，没有响应式时，我们要手动做所有操作；有了响应式，数据变化会 “自动触发” 后续逻辑，这就是 Proxy 的核心价值。 大家发现了吗，特点就是：<strong>检测数据变化-&gt;触发数据更新-&gt;视图渲染</strong> 这三个步骤。</p>
<h2 data-id="heading-1">二、先认识两个核心工具：Proxy 和 Reflect</h2>
<p>这两个是 ES6 新增的 API，也是实现响应式的基础，我们先逐个搞懂，不着急组合。</p>
<h3 data-id="heading-2">Proxy：给对象加一个 “监听器 / 拦截器”</h3>
<p>你可以把 <code>Proxy</code> 理解为：<strong>给普通对象套了一个 “保护壳”，任何对对象的「读取」「修改」操作，都必须先经过这个保护壳，我们可以在壳里监听 / 拦截这些操作</strong>。</p>
<h4 data-id="heading-3">Proxy 的基本语法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
};

<span class="hljs-comment">//  创建 Proxy 代理对象（给 person 套上“监听器”）</span>
<span class="hljs-keyword">const</span> proxyPerson = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(person, {
  <span class="hljs-comment">// 【拦截读取操作】：当读取 proxyPerson 的属性时，自动触发这个 get 方法</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
    <span class="hljs-comment">// target：被代理的原始对象（这里就是 person）</span>
    <span class="hljs-comment">// property：当前要读取的属性名（比如读取 proxyPerson.name 时，property 就是 "name"）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`有人读取了 <span class="hljs-subst">${property}</span> 属性`</span>);
    <span class="hljs-comment">// 返回属性值（不让读取操作被拦截后“丢失”）</span>
    <span class="hljs-keyword">return</span> target[property];
  },

  <span class="hljs-comment">// 【拦截修改操作】：当修改 proxyPerson 的属性时，自动触发这个 set 方法</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
    <span class="hljs-comment">// target：被代理的原始对象（person）</span>
    <span class="hljs-comment">// property：当前要修改的属性名（比如修改 proxyPerson.age 时，property 就是 "age"）</span>
    <span class="hljs-comment">// value：当前要修改的新值（比如 proxyPerson.age = 21，value 就是 21）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`有人修改了 <span class="hljs-subst">${property}</span> 属性，新值是 <span class="hljs-subst">${value}</span>`</span>);
    <span class="hljs-comment">// 执行真正的修改操作（把新值赋给原始对象的对应属性）</span>
    target[property] = value;
    <span class="hljs-comment">// 注意：set 方法最好返回 true，表示修改成功（保持原生行为）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
});
</code></pre>
<h4 data-id="heading-4">测试一下 Proxy 的效果</h4>
<p>我们不直接操作原始对象 <code>person</code>，而是操作代理对象 <code>proxyPerson</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxyPerson.<span class="hljs-property">name</span>);  <span class="hljs-comment">//查看代理后name属性的下的值</span>
proxyPerson.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;           <span class="hljs-comment">//更改属性age的值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxyPerson.<span class="hljs-property">age</span>);   <span class="hljs-comment">//输出更改属性age后的值</span>

</code></pre>
<p>你将会看到</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff38ac6025ab4331bd50eca25b20da16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619017&amp;x-signature=0G6LmtoL4nZIAFwLxZw%2B9LsxVBw%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p><strong>强调</strong></p>
<ul>
<li>代理对象（<code>proxyPerson</code>）和原始对象（<code>person</code>）是 “关联” 的，但不是同一个对象</li>
<li>必须操作<strong>代理对象</strong>才会触发拦截器，直接操作原始对象不会有任何反应：</li>
</ul>
<p>像下面这样是<strong>无效的</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5c8a109a0994cf692c4f54b1562b2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619017&amp;x-signature=oGa64MDSR4oQEctM28fCUTc3wj4%3D" alt="image.png" width="50%" loading="lazy"/></p>
<h3 data-id="heading-5"> Reflect：更 “友好” 的对象操作工具</h3>
<p>刚才我们在 Proxy 的 get/set 里，用了 <code>target[property]</code> 读取、<code>target[property] = value</code> 修改，这是普通写法，但有一些坑（比如继承场景、严格模式下可能出错）。</p>
<p>ES6 提供了 <code>Reflect</code>，它的作用就是：<strong>用 “更标准、更安全” 的方式，执行对象的基本操作（读取、修改等），和 Proxy 是 “最佳搭档”</strong> 。</p>
<h4 data-id="heading-6">Reflect 的核心用法（和 Proxy 对应）</h4>
<p><code>Reflect</code> 是一个内置对象，不能实例化，直接调用它的静态方法即可，最常用的就是 <code>Reflect.get</code> 和 <code>Reflect.set</code>，对应对象的 “读取” 和 “修改”：</p>




















<table><thead><tr><th>普通对象操作</th><th>Reflect 对应操作</th><th>作用</th></tr></thead><tbody><tr><td>target[property]</td><td>Reflect.get(target, property)</td><td>读取对象的某个属性值</td></tr><tr><td>target[property] = value</td><td>Reflect.set(target, property, value)</td><td>修改对象的某个属性值</td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> };

<span class="hljs-keyword">const</span> proxyPerson = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(person, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`有人读取了 <span class="hljs-subst">${property}</span> 属性`</span>);
    <span class="hljs-comment">// 用 Reflect.get 代替 target[property]</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, property);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`有人修改了 <span class="hljs-subst">${property}</span> 属性，新值是 <span class="hljs-subst">${value}</span>`</span>);
    <span class="hljs-comment">// 用 Reflect.set 代替 target[property] = value</span>
    <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, property, value);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
});
</code></pre>
<h2 data-id="heading-7">三、分步实现：基于 Proxy 的完整响应式</h2>
<p>我们分 2 步实现，从简单到复杂，每一步都能独立运行，方便你测试理解。</p>
<h3 data-id="heading-8">步骤 1：封装一个基础的响应式函数（监听读写）</h3>
<p>我们先把 Proxy 的逻辑封装成一个函数，方便复用（这就是 Vue3 中 <code>reactive</code> 函数的简化版）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 封装响应式函数：给普通对象返回一个代理对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">obj</span> - 要被代理的原始对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Proxy</span>} - 代理后的响应式对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeReactive</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-comment">// 创建 Proxy 代理</span>
  <span class="hljs-keyword">const</span> proxyObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, {
    <span class="hljs-comment">// 拦截读取操作</span>
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
      <span class="hljs-comment">// 读取属性并返回</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, property);
    },
    <span class="hljs-comment">// 拦截修改操作</span>
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
      <span class="hljs-comment">// 执行修改操作</span>
      <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, property, value);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  });

  <span class="hljs-comment">// 返回代理对象</span>
  <span class="hljs-keyword">return</span> proxyObj;
}
</code></pre>
<h3 data-id="heading-9">步骤 2：升级：实现 “数据变 → 页面自动更新”</h3>
<p>大家最关心的是：如何让数据变化时，页面 DOM 自动更新？我们基于上面的代码，新增 DOM 更新逻辑，更贴近实际项目使用。</p>
<h4 data-id="heading-10">完整代码（可直接复制到 HTML 文件中运行）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>新手版 Proxy 响应式<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.user-info</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 页面DOM：要自动更新的内容 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户名：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"username"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>等级：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"level"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"upgradeBtn"</span>&gt;</span>点击升级等级<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 步骤1：封装响应式函数（新增：DOM更新逻辑）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">makeReactive</span>(<span class="hljs-params">obj</span>) {
      <span class="hljs-keyword">const</span> proxyObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, {
        <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, property);
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
          <span class="hljs-comment">// 1. 先修改数据</span>
          <span class="hljs-keyword">const</span> oldValue = target[property];
          <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, property, value);

          <span class="hljs-comment">// 2. 数据修改后，自动更新DOM（核心：响应式的实际落地）</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`数据 <span class="hljs-subst">${property}</span> 变化，自动更新页面`</span>);
          <span class="hljs-title function_">updateDOM</span>(property, value);

          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      });
      <span class="hljs-keyword">return</span> proxyObj;
    }

    <span class="hljs-comment">// 步骤2：封装 DOM 更新函数（根据数据变化，更新对应页面元素）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params">property, value</span>) {
      <span class="hljs-keyword">if</span> (property === <span class="hljs-string">"username"</span>) {
        <span class="hljs-comment">// 找到页面上的 username 元素，更新内容</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"username"</span>).<span class="hljs-property">innerText</span> = value;
      }
      <span class="hljs-keyword">if</span> (property === <span class="hljs-string">"level"</span>) {
        <span class="hljs-comment">// 找到页面上的 level 元素，更新内容</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"level"</span>).<span class="hljs-property">innerText</span> = value;
      }
    }

    <span class="hljs-comment">// 步骤3：初始化数据和页面</span>
    <span class="hljs-comment">// 1. 原始数据</span>
    <span class="hljs-keyword">const</span> user = {
      <span class="hljs-attr">username</span>: <span class="hljs-string">"前端新手"</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>
    };
    <span class="hljs-comment">// 2. 生成响应式对象</span>
    <span class="hljs-keyword">const</span> reactiveUser = <span class="hljs-title function_">makeReactive</span>(user);
    <span class="hljs-comment">// 3. 初始化页面（第一次手动渲染，后续自动更新）</span>
    <span class="hljs-title function_">updateDOM</span>(<span class="hljs-string">"username"</span>, reactiveUser.<span class="hljs-property">username</span>);
    <span class="hljs-title function_">updateDOM</span>(<span class="hljs-string">"level"</span>, reactiveUser.<span class="hljs-property">level</span>);

    <span class="hljs-comment">// 步骤4：绑定按钮点击事件（修改数据，测试自动更新）</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"upgradeBtn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 只需要修改响应式数据，页面会自动更新！</span>
      reactiveUser.<span class="hljs-property">level</span> = reactiveUser.<span class="hljs-property">level</span> + <span class="hljs-number">1</span>;
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`等级升级成功！当前等级：<span class="hljs-subst">${reactiveUser.level}</span>`</span>);
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">运行效果</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f81af0acfd74dc3b3a252ae7056d283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619017&amp;x-signature=BvCTAWXu3jr5LimtmNvFIP%2F9YQY%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>
<p>打开 HTML 文件，页面上会显示用户名和等级</p>
</li>
<li>
<p>点击 “点击升级等级” 按钮</p>
</li>
<li>
<p>你会发现：</p>
<ul>
<li>弹窗提示等级升级</li>
<li>页面上的 “等级” 数字会<strong>自动从 1 变成 2，再点击变成 3...</strong></li>
<li>我们没有手动写 <code>document.getElementById("level").innerText = 新值</code>，而是数据变化后自动触发，这就是完整的响应式效果！</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">四、核心知识点（总结）</h2>
<ol>
<li>
<p><strong>数据响应式</strong>：数据变 → 页面 / 逻辑自动变，无需手动操作。</p>
</li>
<li>
<p><strong>Proxy</strong>：给对象加 “拦截器”，监听「读取（get）」和「修改（set）」操作，是实现响应式的核心。</p>
</li>
<li>
<p><strong>Reflect</strong>：和 Proxy 搭档，更安全地操作对象属性（替代 <code>target[property]</code> 和 <code>target[property] = value</code>）。</p>
</li>
<li>
<p><strong>核心流程</strong>：</p>
<ul>
<li>用 <code>makeReactive</code> 函数把普通对象变成 Proxy 代理对象</li>
<li>操作代理对象时，会触发 get/set 拦截器</li>
<li>在 set 拦截器中，数据修改后自动执行 DOM 更新（或其他逻辑）</li>
</ul>
</li>
<li>
<p><strong>关键注意点</strong>：必须操作「Proxy 代理对象」才会触发响应式，操作原始对象无效。</p>
</li>
</ol>
<h2 data-id="heading-13">五、常见疑问解答</h2>
<ol>
<li><strong>问：为什么不用直接修改对象，非要用 Proxy？</strong> 答：直接修改对象无法 “监听” 变化，比如 <code>user.level = 2</code>，我们不知道什么时候改的、改了什么值；而 Proxy 能精准捕获这些操作，进而触发后续逻辑。</li>
<li><strong>问：这和 Vue3 的响应式有什么关系？</strong> 答：Vue3 的 <code>reactive</code> 函数底层就是基于 Proxy 实现的，我们写的 <code>makeReactive</code> 就是 <code>reactive</code> 的简化版，Vue3 只是在这个基础上增加了 “依赖收集” 等更复杂的逻辑（下一篇文章可能就会讲述，大家可以关注新的栏目"Vue源码解析"）。</li>
<li><strong>问：Reflect 必须用吗？不用行不行？</strong> 答：简单场景下不用也可以，但 Reflect 能解决很多坑（比如继承、严格模式），而且是 ES6 推荐的 Proxy 搭档，新手直接养成使用习惯即可。</li>
</ol>
<h2 data-id="heading-14">六、拓展</h2>
<p>既然都讲到这里啦，那就浅谈vue2和vue3中关于有无Proxy的区别吧~</p>
<h3 data-id="heading-15">1. Vue2 的响应式：基于 <code>Object.defineProperty</code></h3>
<p>Vue2 是通过 <code>Object.defineProperty</code> 给对象的<strong>每个属性</strong>单独设置 <code>getter/setter</code>，从而监听属性的读写。</p>
<p>但它有几个明显的<strong>缺陷</strong>：</p>
<ul>
<li>只能监听<strong>已存在的属性</strong>：如果给对象新增属性（比如 <code>obj.newKey = 1</code>），Vue2 监听不到，得用 <code>Vue.set</code> 手动触发响应。</li>
<li>无法监听<strong>数组的变化</strong>：比如数组的 <code>push/pop/splice</code> 等方法，Vue2 是通过 “重写数组原型方法” 的方式曲线救国，不够优雅。</li>
<li>必须遍历对象的所有属性：如果对象层级深，需要递归遍历，性能开销大。</li>
</ul>
<h3 data-id="heading-16">2. Vue3 的响应式：基于 <code>Proxy</code></h3>
<p>Vue3 用 <code>Proxy</code> 代理<strong>整个对象</strong>，直接拦截对象的「所有属性操作」，完美解决了 Vue2 的缺陷：</p>
<ul>
<li>能监听<strong>新增 / 删除属性</strong>：比如 <code>obj.newKey = 1</code> 会被 <code>Proxy</code> 的 <code>set</code> 拦截，自动响应。</li>
<li>能原生监听<strong>数组变化</strong>：数组的 <code>push/pop</code> 等操作会被 <code>Proxy</code> 捕获，不用再重写数组方法。</li>
<li>代理整个对象，无需递归遍历：<code>Proxy</code> 是代理整个对象，层级深的对象会在<strong>读取时懒代理</strong>，性能更优。</li>
</ul>
<h3 data-id="heading-17">总结</h3>
<p>Vue3 用 <code>Proxy</code> 替代 Vue2 的 <code>Object.defineProperty</code>，本质是<strong>用更现代、更强大的 ES6 特性，解决了 Vue2 响应式的各种 “痛点”</strong> ~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第四章：天道位格与诸法契约]]></title>    <link>https://juejin.cn/post/7589206614928982056</link>    <guid>https://juejin.cn/post/7589206614928982056</guid>    <pubDate>2025-12-30T01:48:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589206614928982056" data-draft-id="7589207843787210787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第四章：天道位格与诸法契约"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2025-12-30T01:48:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第四章：天道位格与诸法契约
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T01:48:49.000Z" title="Tue Dec 30 2025 01:48:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>恭喜道友！你已完成筑基，气海充盈，法宝熟练。现在，我们要迈入修仙路上的一个关键转折点——<strong>结丹期</strong>。</p>
<p>在这一章，你将领悟 Haskell 的**“天道授位”系统：Typeclasses（类型类）**。这决定了你的类型（灵根）在宇宙法则中究竟拥有何种“特权”。</p>
<hr/>
<p>在凡间的面向对象宗门（如 Java、C++），人们通过“继承”来获得能力，这往往导致血脉混乱（类层级过于复杂）。而 λ 门的规矩是： <strong>“不看出身，只看位格。”</strong></p>
<h3 data-id="heading-0">4.1 什么是 Typeclass？</h3>
<p><strong>Typeclass</strong> 并不是类，而是一份**“契约”<strong>或</strong>“位格”**。如果一个类型（Type）获得了某种位格，它就必须掌握该位格要求的“神通”。</p>
<ul>
<li><strong>Eq（辨真位）：</strong> 获得此位格，便可使用 <code>==</code> 和 <code>/=</code>，辨别两个法宝是否相同。</li>
<li><strong>Ord（争胜位）：</strong> 获得此位格，意味着可以比较高下（<code>&lt;</code>, <code>&gt;</code>, <code>compare</code>）。</li>
<li><strong>Show（显圣位）：</strong> 获得此位格，类型便能化虚为实，转化为 <code>String</code> 打印出来。</li>
<li><strong>Num（术数位）：</strong> 获得此位格，该类型便具备了数学属性，可进行加减乘除。</li>
</ul>
<hr/>
<h3 data-id="heading-1">4.2 敕封位格：Deriving（天道敕令）</h3>
<p>在 Haskell 中，最快捷的结丹方式就是使用 <code>deriving</code>。当你定义一个新的数据结构（Data Type）时，可以直接向天道申请位格。</p>
<p><strong>示例：炼制一枚“灵丹”</strong></p>
<p>Haskell</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 定义一个“灵丹”类型</span>
data SpiritPill <span class="hljs-operator">=</span> LowGrade <span class="hljs-operator">|</span> MidGrade <span class="hljs-operator">|</span> HighGrade
    deriving (Eq, Ord, <span class="hljs-keyword">Show</span>) <span class="hljs-comment">-- 自动获得辨别、排序、显示的能力</span>
</code></pre>
<p><strong>法力演示：</strong></p>
<ul>
<li><strong>显圣：</strong> <code>show LowGrade</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <code>"LowGrade"</code></li>
<li><strong>争胜：</strong> <code>HighGrade &gt; LowGrade</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <code>True</code>（在 <code>deriving</code> 中，后定义的通常比先定义的高级）</li>
<li><strong>辨真：</strong> <code>MidGrade == MidGrade</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <code>True</code></li>
</ul>
<hr/>
<h3 data-id="heading-2">4.3 契约约束：类型约束（Type Constraints）</h3>
<p>当你写一个通用的法术时，你可能需要要求输入者必须拥有某种“位格”。</p>
<p>示例：斗法函数</p>
<p>你想写一个法术，比较两个东西的强弱，并宣布胜者。这要求输入的东西必须拥有 Ord（能比大小）和 Show（能打印）这两个位格。</p>
<p>Haskell</p>
<pre><code class="hljs language-rust" lang="rust">battle :: (<span class="hljs-built_in">Ord</span> a, Show a) =&gt; a <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>
battle x y = 
    <span class="hljs-keyword">if</span> x &gt; y 
    then show x ++ <span class="hljs-string">" 胜出！"</span> 
    <span class="hljs-keyword">else</span> show y ++ <span class="hljs-string">" 胜出！"</span>
</code></pre>
<blockquote>
<p><strong>解析：</strong> <code>(Ord a, Show a) =&gt;</code> 便是**“契约前提”**。只有满足这两条规则的类型 <code>a</code>，才有资格进入这个法阵。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">4.4 自创契约：自定义 Typeclass</h3>
<p>如果你是宗门长老，你也可以自创一份契约。</p>
<p><strong>示例：定义“修行”位格</strong></p>
<p>Haskell</p>
<pre><code class="hljs language-rust" lang="rust">class Practicable a <span class="hljs-keyword">where</span>
    practice :: a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>  -- 凡是能修行的，都必须有 practice 这个动作
</code></pre>
<p>让不同的灵根实现这个位格：</p>
<p>Haskell</p>
<pre><code class="hljs language-ini" lang="ini">instance Practicable SpiritPill where
    practice <span class="hljs-attr">HighGrade</span> = <span class="hljs-string">"药效惊人，修为一日千里！"</span>
    practice <span class="hljs-attr">_</span>         = <span class="hljs-string">"药效尚可，需勤加修炼。"</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">⚡ 结丹心得：抽象的力量</h2>
<p>当你掌握了 Typeclasses，你写的代码将不再局限于具体的数字或字符串，而是专注于**“行为的本质”**。你可以写一个处理“所有可以排序的东西”的算法，而不必在乎它是灵石、飞剑还是道号。</p>
<hr/>
<h2 data-id="heading-5">📜 结丹试炼：第四关</h2>
<p>现在，请施展你的“天道授位”神通：</p>
<ol>
<li><strong>定义新境界：</strong> 定义一个数据类型 <code>Rank</code>，包含 <code>ZhuJi</code> (筑基), <code>JinDan</code> (金丹), <code>YuanYing</code> (元婴)。</li>
<li><strong>赋予位格：</strong> 让 <code>Rank</code> 拥有 <code>Eq</code>, <code>Show</code> 和 <code>Ord</code> 位格。</li>
<li><strong>验证：</strong> 尝试在 <code>ghci</code> 中运行 <code>JinDan &gt; ZhuJi</code> 以及 <code>show YuanYing</code>。</li>
<li><strong>进阶（可选）：</strong> 尝试手写一个 <code>instance Eq Rank where</code>，让 <code>ZhuJi</code> 和任何境界都“不相等”（即使是两个筑基也不相等，象征修仙之路唯有自知）。</li>
</ol>
<p><strong>“位格已定，金丹初成。从此以后，你眼中的数据不再是死物，而是背负着契约与使命的灵体。”</strong></p>
<hr/>
<p><strong>下一章预告：</strong> 终于要迎来修仙界最大的雷劫，也是 Haskell 力量的终极体现——<strong>Monad（单子）</strong> 。不要害怕，它其实只是一个带着“特殊环境”的盒子。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记一次发现 DataTransfer 的 getData 的有趣问题]]></title>    <link>https://juejin.cn/post/7588934987511087131</link>    <guid>https://juejin.cn/post/7588934987511087131</guid>    <pubDate>2025-12-29T13:23:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588934987511087131" data-draft-id="7589107312112713737" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记一次发现 DataTransfer 的 getData 的有趣问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T13:23:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HabaraAi"/> <meta itemprop="url" content="https://juejin.cn/user/2066737588871287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记一次发现 DataTransfer 的 getData 的有趣问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2066737588871287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HabaraAi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T13:23:41.000Z" title="Mon Dec 29 2025 13:23:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前情提要</h2>
<p>之前基于双越老师的 wangEditor 开发了一个软件，今早客户反应在单元格里面粘贴网页上复制的内容会将内容插入到表格下面，然后想试着复现一下，结果中途第一次遇到了 DataTransfer 的 getData 问题。</p>
<h2 data-id="heading-1">问题描述</h2>
<p>DataTransfer 的 getData 方法在有和没有断点的情况下，获取 text/html 类型的值不一样的问题，从而导致后续处理逻辑不一致的问题。</p>
<h2 data-id="heading-2">BUG 发现过程</h2>
<p>我准备了一个包含表格及单元格里面有富文本模块的模版和一段测试用的富文本，模版及测试粘贴内容如下图所示：</p>
<p>程序模版：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df95ab2fd89c4a65849c41d5786b2668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=cyC0euE5YpjzbAMHWFULeougw0Q%3D" alt="image.png" loading="lazy"/></p>
<p>内容为一个网上随便找的包含标题和内容的简单富文本：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1961a3afe1924e3d9af6c98cf64f8a45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=PqI2s7Bv%2BV3hmhaeXiDkaLiixgI%3D" alt="image.png" loading="lazy"/></p>
<p>在富文本模块中ctrl+v后，富文本内容确实被插入到了表格下面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5527b3dd014544d69352931447b72ee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=jLzD6eaXwBrxt6CQRBIQYDFw7Zs%3D" alt="image.png" loading="lazy"/></p>
<p>按照之前读的源码理解，此时先执行的应该是 wangEditor 内部的 paste 逻辑，断点检查后发现确实执行了但是并没有在 paste 里面处理，那么就只能是在 insertData 里面处理的。继续打断点确定最终的插入逻辑是在 wangEditor 内部的 with-event-data.ts 插件里面的 insertData 的覆写。以下是源代码：</p>
<pre><code class="hljs language-typescript" lang="typescript">  e.<span class="hljs-property">insertData</span> = <span class="hljs-function">(<span class="hljs-params">data: DataTransfer</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> fragment = data.<span class="hljs-title function_">getData</span>(<span class="hljs-string">'application/x-slate-fragment'</span>)
    <span class="hljs-keyword">if</span> (fragment) {
      <span class="hljs-keyword">const</span> decoded = <span class="hljs-built_in">decodeURIComponent</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">atob</span>(fragment))
      <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(decoded) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span>[]
      e.<span class="hljs-title function_">insertFragment</span>(parsed)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> text = data.<span class="hljs-title function_">getData</span>(<span class="hljs-string">'text/plain'</span>)
    <span class="hljs-keyword">const</span> html = data.<span class="hljs-title function_">getData</span>(<span class="hljs-string">'text/html'</span>)
    <span class="hljs-comment">// const rtf = data.getData('text/rtf')</span>

    <span class="hljs-keyword">if</span> (html) {
      e.<span class="hljs-title function_">dangerouslyInsertHtml</span>(html)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (text) {
      <span class="hljs-keyword">const</span> lines = text.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r\n|\r|\n/</span>)
      <span class="hljs-keyword">let</span> split = <span class="hljs-literal">false</span>

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (split) {
          <span class="hljs-title class_">Transforms</span>.<span class="hljs-title function_">splitNodes</span>(e, { <span class="hljs-attr">always</span>: <span class="hljs-literal">true</span> })
        }

        <span class="hljs-title function_">insertText</span>(line)
        split = <span class="hljs-literal">true</span>
      }
      <span class="hljs-keyword">return</span>
    }
  }
</code></pre>
<p>原本我想的非常简单，只需要检查我的自定义模块在执行最底层的 insertData 前都做了哪些处理就可以判断问题产生的原因及如何修复了，而也就是在这一步发现了 Datatransfer 的问题。</p>
<p>我在断点时根据调用栈找到了自定义模块也覆写了的 insertData 方法，打上断点，继续粘贴内容，F10一步一步的进行调用，随后出现的画面让我大吃一惊。。粘贴的内容居然出现在了富文本模块里面。但是标题的样式没了，这是什么情况？🤔
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0417cd5829b244d8adbd57c38fa01455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=5Zew1Rg6BfXQpVFN28TUns0J%2B%2Bs%3D" alt="image.png" loading="lazy"/></p>
<p>为什么打了断点执行和不打断点最终的效果会不一样。</p>
<p>于是我取消了其余断点，留下了第14行的 if (html) 这里的断点，继续调试。然后奇怪的现象出现了，粘贴的内容又跑到了表格下面。</p>
<p>此时就锁定问题了：wangEditor 在其余逻辑没有中断处理时，最终的 insertData 里面会获取 DataTransfer 里面的 text 和 html，html 是高优先级，当 html 有内容时，就会执行内部的 <code>dangerouslyInsertHtml</code> 方法，内部的实现就是会把富文本转换为 slatejs 的节点，然后插入到表格下面。而当 html 没有内容时，就会执行下面的 if (text) 块，最终执行的是 <code>insertText</code> 方法，内部处理就是非常简单的插入文本，所以粘贴内容才会出现在富文本模块下面，并且标题的样式没了。</p>
<h2 data-id="heading-3">发现主要问题</h2>
<p>为什么在打了多个断点后，getData("text/html") 的值会不一样？</p>
<ul>
<li>
<p>多个断点截图，html 拿到的是空字符串
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9670edd50b44c568107b9782984fcd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=9MXmb3q9CHAR87ivHmDgw1ZjBew%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>单个断点截图，html拿到了富文本值
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/355e993dd2c54f2a87090ec71c1b8274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=6CEJHGdNtuBanEo%2BN6LYEkeeiJQ%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-4">尝试理解原理</h2>
<p>遇事不决找 AI，于是问了下 Gemini，得到以下回答
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251c834539a140718595ab7414f84b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=F%2B%2FUY4MQ4z3hFSy1ILKTYqgE0wg%3D" alt="image.png" loading="lazy"/>
插句题外话，这里不得不吐槽一下，刚刚看完《绝命毒师》连遇到个问题都和海森堡有关，于是满脑子的“say my name”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd9f6df6a8441149cf5501f2d73f840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=LYJ6sQDbKCZumB2YqOdNYmyjv1Q%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/190faad0940b494bbf04bb2cd32a0260~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=kYei5wWBXtf8FgK%2B1FjgPRhKmac%3D" alt="image.png" loading="lazy"/></p>
<p>细问之下，得到以下结果
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3f8d5dcc944cb4b1bf4f5fd80ea61d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=ZVdtV8BoUcGLslcRghIFQ2%2F2Sac%3D" alt="image.png" loading="lazy"/>
简而言之就是浏览器在打断点期间，这个安全计时并未暂停，于是等我处理完上面的断点，走到 <code>getData("text/html")</code> 时，安全计时超时了也就拿到了空的内容。</p>
<p><strong>那为什么 <code>getData("text/plain")</code> 还是可以拿到值？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c2893557118482ca890a28d534e416e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=fA%2BgH1NBWQf84B%2BVmUDCzEoI%2Fgk%3D" alt="image.png" loading="lazy"/></p>
<p>这也就是为什么 text/plain 有值而 text/html 没有值。</p>
<h2 data-id="heading-5">如何解决</h2>
<p>问题找到了，那如何解决。如果我非要在断点后也能拿到 html 的数据，有没有办法，这个安全计时的最大时间又是多少？</p>
<p>根据我的简单试错，这个安全计时大概是5秒左右。当手速快一点的情况下，从执行事件到 text/html 这一步在5秒内时，多个断点也是可以拿到数据的。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a24ba3dc5ad84de09a9d7064beb7002d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=pJw50rjV8ji00xlg%2FzfnXldcqeg%3D" alt="image.png" loading="lazy"/></p>
<p>那么问题又双叒叕来了，<strong>有没有超过5秒也可以拿到数据的方法呢？</strong>，有的兄弟，有的。</p>
<p>当你手速不够快，又想一步一步慢慢调的时候，就去网站设置里面把剪贴斯权限由询问改成允许。就可以一步一步F10慢慢调了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c14d2bc05b74fe791ef80f72035dd9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=0uc%2F%2FrbEn5M%2BOG8f5Q%2FpIzrDTi4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8bba8fb51034382aad2a7e9473930ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=ZF%2BXAAQErbNAXjXxCC867tiJNZg%3D" alt="image.png" loading="lazy"/></p>
<p>看看效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e35db44cb2d4c5c9548421421b5c277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=4w1fMaO%2BkcpyYgY0zFDAY8ZooWM%3D" alt="image.png" loading="lazy"/></p>
<p>在第105行添加一个日志断点 <code>console.time("html")</code>，然后在106行加一个断点用来等下卡住，等过10秒再下一步，然后在114行添加日志断点 <code>console.timeEnd("html")</code>，再在117行卡住，就可以看到 html 还可以拿到值了。而控制台也显示了中途卡了11秒，这已经超过了5秒的安全计时，但依然可以拿到值。</p>
<h2 data-id="heading-6">小结</h2>
<p>关于这个问题，由于比较懒，没有去研究在不同的浏览器上是否都会有这个安全机制，或者不同的浏览器的安全限时是否是一样的，或者设置了剪贴板为允许后的行动逻辑是否一样。通过拖拽产生的DataTransfer是否也有这个限制，这个限制是在浏览器层面的，还是在 ECMAScript 里面规定的等等。又或者如果不是因为断点，而是因为中途处理逻辑就是超过了5秒，那是否还能拿得到。后续有机会的话再进行补充。</p>
<h2 data-id="heading-7">总结</h2>
<ol>
<li>在 devtools 里面，如果因为断点导致从交互事件到 getData("text/html") 的时间超过5秒，那么就会拿到一个空字符串。</li>
<li>getData("text/plain") 不受此限制，超过5秒也可以拿到值。</li>
<li>开发时通过将网页的剪贴板权限改成“允许”就可以突破这个安全计时限制。</li>
</ol>
<h2 data-id="heading-8">BUG 改了吗？（与本贴内容无关）</h2>
<p>改了，改了。非常简单，只需要在富文本模块重写 insertData 方法，如果事件执行时在富文本模块中，就获取 html，然后转换成 slate 节点，再把富文本模块整个替换掉就可以了。实现：</p>
<pre><code class="hljs language-typescript" lang="typescript">  newEditor.<span class="hljs-property">insertData</span> = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> richTextEntry = <span class="hljs-title class_">SlateEditor</span>.<span class="hljs-property">above</span>&lt;<span class="hljs-title class_">RichTextElement</span>&gt;(newEditor, {
      <span class="hljs-attr">match</span>: <span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title class_">DomEditor</span>.<span class="hljs-title function_">checkNodeType</span>(n, richTextModuleType),
      <span class="hljs-attr">mode</span>: <span class="hljs-string">'highest'</span>,
    })

    <span class="hljs-keyword">if</span> (!richTextEntry) {
      <span class="hljs-title function_">insertData</span>(data)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> html = data.<span class="hljs-title function_">getData</span>(<span class="hljs-string">'text/html'</span>)

    <span class="hljs-keyword">if</span> (html) {
      <span class="hljs-keyword">const</span> fragment = <span class="hljs-title function_">htmlToContent</span>(editor, html)
      <span class="hljs-title class_">SlateTransforms</span>.<span class="hljs-title function_">insertNodes</span>(newEditor, fragment)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-title function_">insertData</span>(data)
  }
</code></pre>
<p>效果如下，标题的样式也得到了保留：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36eebc1ad2ea4f9a8b25541b75c3a538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=Nv5lZc0mI3%2BaJJLovtI7ZZD6Oag%3D" alt="image.png" loading="lazy"/></p>
<p>表单模块也拿到了富文本的内容，业务系统就可以根据编辑器实例获取到模版的结构化值了：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e11c65a6931479e876fc8ecd6225a13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFiYXJhQWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619420&amp;x-signature=O39Kfm%2F4vPCMalgx9JshS7Ds7Mw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Vue.js 构建 Java 桌面应用]]></title>    <link>https://juejin.cn/post/7589126217250455593</link>    <guid>https://juejin.cn/post/7589126217250455593</guid>    <pubDate>2025-12-29T11:31:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126217250455593" data-draft-id="7589082912588693547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Vue.js 构建 Java 桌面应用"/> <meta itemprop="keywords" content="Vue.js,Java,前端"/> <meta itemprop="datePublished" content="2025-12-29T11:31:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TeamDev"/> <meta itemprop="url" content="https://juejin.cn/user/4158825167847872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Vue.js 构建 Java 桌面应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4158825167847872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TeamDev
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T11:31:02.000Z" title="Mon Dec 29 2025 11:31:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2563112fd5454b96d6f081bda447f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767612662&amp;x-signature=8nglmSr9qmh0paZQSBLa9Lictvw%3D" alt="" loading="lazy"/></p>
<p>如今，越来越多的桌面应用开始采用 Web 化界面设计。这种方法完美结合了 Web 技术的灵活性与原生应用的性能优势及系统集成能力，成为桌面开发的主流趋势。</p>
<p>本文介绍的 Java 桌面应用正是基于这一现代架构：通过 Vue.js 与 Tailwind CSS 构建 Web 界面，实现了跨平台一致、流畅响应且设计精美的用户体验。</p>
<h2 data-id="heading-0">Web UI 对比原生 UI</h2>
<p>传统桌面应用的原生 UI 工具包长期难以满足现代 UI 需求 —— 要实现精致的视觉效果、流畅的动画过渡、高 DPI 屏幕适配，或是像 Web 应用那样灵活切换主题（亮色 / 暗色模式、自定义配色等），往往需要大量定制开发工作。</p>
<p>另一方面，基于 Web 的用户界面受益于庞大的生态系统，其中包含现成的库、组件框架、响应式设计，以及跨操作系统和设备形态的一致性。</p>
<p>通过在桌面外壳中嵌入 Web UI，我们既能使用现代 Web 风格的界面，又能利用原生应用的能力。纯 Web 应用由于缺乏完全的文件系统访问、OS API 和离线能力，很难完全替代桌面应用；而在原生包装中运行 Web UI 则弥补了这些不足，实现两者的最佳组合。</p>
<h2 data-id="heading-1">应用概览</h2>
<p>该应用是一款跨平台 Java 桌面应用程序，核心架构是在原生 Java 窗口中集成现代化 Vue.js Web 界面，通过 Shadcn 组件库构建简洁直观的操作界面。</p>
<p>这种架构确保了以下特性：</p>
<ul>
<li>在 Windows、macOS、Linux 上统一的界面呈现。</li>
<li>丝滑的交互体验，接近 Web 应用的流畅度。</li>
<li>通过打包所有资源实现离线运行，启动即可使用，无需网络连接。</li>
</ul>
<p>应用启动后会显示主控制面板以及偏好设置窗口，用户可以调整界面主题、字体大小、布局等选项。所有设置都保存在本地文件系统，并在下次启动时自动恢复。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/744074cb0abd477ab27fd83c56fe4602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767612662&amp;x-signature=CwRfsEGvZs%2FyNOFV7g1SN7bCzHg%3D" alt="基于 Vue.js 构建 UI 的桌面应用" loading="lazy"/></p>
<p align="center"><span>基于 Vue.js 构建 UI 的桌面应用</span></p>
<p>完整源代码可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeamDev-IP%2FJxBrowser-Gallery%2Ftree%2Fmaster%2Fdesktop-web-app%3Futm_source%3Djuejin%26utm_medium%3Darticle%26utm_campaign%3Ddesktop-app-with-vue-js" target="_blank" title="https://github.com/TeamDev-IP/JxBrowser-Gallery/tree/master/desktop-web-app?utm_source=juejin&amp;utm_medium=article&amp;utm_campaign=desktop-app-with-vue-js" ref="nofollow noopener noreferrer">GitHub</a> 获取。</p>
<h2 data-id="heading-2">应用窗口与 Web 视图</h2>
<p>应用主窗口基于 Java Swing 的 <code>JFrame</code>实现，作为 Java 内置组件，它具备轻量易用的特点。窗口内部嵌入了 JxBrowser 提供的 Chromium 内核 Web 视图组件，能够直接在桌面窗口中渲染 Vue.js 界面，并支持所有现代浏览器特性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">var</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> Engine.newInstance(HARDWARE_ACCELERATED);
<span class="hljs-type">var</span> <span class="hljs-variable">browser</span> <span class="hljs-operator">=</span> engine.newBrowser();

SwingUtilities.invokeLater(() -&gt; {
    <span class="hljs-type">var</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> BrowserView.newInstance(browser);
    <span class="hljs-type">var</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFrame</span>(<span class="hljs-string">"Application"</span>);
    frame.addWindowListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowAdapter</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">windowClosing</span><span class="hljs-params">(WindowEvent e)</span> {
            engine.close();
        }
    });
    frame.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
    frame.add(view, BorderLayout.CENTER);
    frame.setSize(<span class="hljs-number">1280</span>, <span class="hljs-number">900</span>);
    frame.setLocationRelativeTo(<span class="hljs-literal">null</span>);
    frame.setVisible(<span class="hljs-literal">true</span>);
});
</code></pre>
<p>这套架构分工明确：Java 后端负责核心业务逻辑（数据读写、文件操作等），Vue.js 前端专注于界面布局与用户交互，各司其职且高效协同。</p>
<h2 data-id="heading-3">桌面应用中加载 Web UI</h2>
<p>Vue.js 部分本质上是一个标准 Web 项目，根据环境的不同，应用会从本地开发服务器或嵌入式静态文件加载它。</p>
<h3 data-id="heading-4">开发环境</h3>
<p>开发环境的 Web 应用加载流程极为简洁：启动本地开发服务器后，直接访问 localhost 地址即可：</p>
<pre><code class="hljs language-shell" lang="shell">./gradlew desktop-web-app:startDevServer -Pfrontend=vue
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (!AppDetails.isProduction()) {  
   browser.navigation().loadUrl(<span class="hljs-string">"http://localhost"</span>);
} <span class="hljs-keyword">else</span> {
   ...
}
</code></pre>
<p>应用启动后，嵌入式 Web 视图会导航至本地开发服务器地址。此时修改 Vue 组件或样式，无需重新构建 Java 部分即可实时生效。</p>
<h3 data-id="heading-5">生产环境</h3>
<p>在生产环境中，桌面应用需要完全离线运行。依赖本地 Web 服务器不仅增加复杂度，也带来潜在安全风险。</p>
<p>从本地或远程服务器提供用户界面会增加额外的安全风险；用户可能会在浏览器中加载 Web 应用程序 URL 并检查应用程序的源代码，从而暴露敏感逻辑。我们当然不希望这种情况发生，我们希望用户界面只能在桌面应用程序内部访问，并且其源代码隐藏在应用程序内部。</p>
<p>为实现这一目标，我们将 Web 应用文件打包至 Java 资源目录，通过 JxBrowser 的自定义协议拦截 API 从类路径中直接加载资源。</p>
<p>首先配置自定义协议与请求拦截器，用于处理 Web 资源请求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">var</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> EngineOptions.newBuilder(HARDWARE_ACCELERATED)
        .addScheme(Scheme.of(<span class="hljs-string">"jxb"</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlRequestInterceptor</span>());
<span class="hljs-type">var</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> Engine.newInstance(options.build());
</code></pre>
<p>Vue.js 应用被直接打包到 Java 资源中，通过 JxBrowser 加载，使 UI 部分完全独立封装：</p>
<ul>
<li>所有 HTML、CSS、JavaScript 文件均从应用 JAR 包中读取</li>
<li>无需依赖任何外部服务器</li>
<li>源代码不会被浏览器开发者工具审查</li>
</ul>
<p>这种方案确保了应用的高性能、安全性与可移植性，在 Windows、macOS 和 Linux 三大操作系统上均能稳定运行。</p>
<h2 data-id="heading-6">Vue.js 与 Java 之间的通信</h2>
<p>为了实现应用程序逻辑，Vue.js 前端需要与 Java 后端通信——例如，读取或更新存储在磁盘上的偏好设置。</p>
<h3 data-id="heading-7">JxBrowser JavaScript - Java 桥接器</h3>
<p>JxBrowser 内置了 JavaScript 与 Java 的直接通信桥，允许 Web UI 直接调用 Java 方法。Vue.js 前端可通过该桥调用后端接口（如 "保存主题设置"），Java 后端也能主动向前端发送事件或数据更新。</p>
<p>以下是如何在 JxBrowser 中声明 JavaScript 和 Java 之间通信的类型：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JsAccessible</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefsService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFontSize</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span> {
    
    }
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefsService</span> { 
    <span class="hljs-title function_">setFontSize</span>(<span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span>; 
}

<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">prefService</span>: <span class="hljs-title class_">PrefsService</span>;
...
prefsService.<span class="hljs-title function_">setFontSize</span>(<span class="hljs-number">12</span>);
</code></pre>
<h3 data-id="heading-8">Protobuf + gRPC</h3>
<p>对于简单交互，应用仍可使用现有 REST 接口；而针对更复杂、需要可扩展性的功能，我们引入了 Protocol Buffers（Protobuf）与 gRPC，构建了更快速、类型安全的通信层。</p>
<p>通过 Protobuf 统一定义数据结构与服务 API，可自动为前后端生成强类型客户端 / 服务器代码。只需在 <code>.proto</code> 文件中定义消息格式与服务接口，Protobuf 便会自动生成 Java 与 TypeScript 代码。</p>
<pre><code class="hljs language-proto" lang="proto">service PrefsService {
  rpc SetFontSize(FontSize) returns (google.protobuf.Empty);
}

enum FontSize {
  SMALL = 0;
  DEFAULT = 1;
  LARGE = 2;
}
</code></pre>
<p>gRPC 作为传输层：Java 后端运行轻量级 gRPC 服务器，Vue.js 应用以客户端身份与之通信，实现结构化数据的安全高效传输。</p>
<p>该方案带来了三大优势：</p>
<ul>
<li>在应用前后端之间实现类型安全。</li>
<li>在构建阶段获得自动补全与错误检查能力。</li>
<li>当功能或 API 增加时，系统能够更容易扩展。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1256fb4b7b384b75810713b9d324085f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767612662&amp;x-signature=P4MGVciDm9r5Km2DGb0EdVBqckA%3D" alt="通信图" loading="lazy"/></p>
<p align="center"><span>通信图</span></p>
<h2 data-id="heading-9">总结</h2>
<p>采用 Web UI 构建桌面应用已被证明是一种强大的现代开发模式。它既保留了 Web 技术的易用性与生态优势，又具备原生桌面应用的系统集成能力与性能表现。</p>
<p>本文实现的 Java 桌面应用，通过 Vue.js 构建前端界面、Tailwind CSS 处理样式，核心达成了以下目标：</p>
<ul>
<li>将 Chromium 内核 Web 视图嵌入 Java 窗口。</li>
<li>实现开发 / 生产环境下的 Vue 资源无缝加载。</li>
<li>使用 gRPC 和 Protobuf 实现 Web UI 与 Java 后端之间的通信。</li>
</ul>
<p>这种混合架构结合了 Java 和 Vue.js 前端，允许开发者在桌面环境中使用标准的 Web 工具，并使应用程序能够作为独立的软件包运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从点到线，从线到画：Canvas 画笔工具的实现艺术]]></title>    <link>https://juejin.cn/post/7589074117644927011</link>    <guid>https://juejin.cn/post/7589074117644927011</guid>    <pubDate>2025-12-29T13:50:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589074117644927011" data-draft-id="7589104492883116084" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从点到线，从线到画：Canvas 画笔工具的实现艺术"/> <meta itemprop="keywords" content="前端,Electron"/> <meta itemprop="datePublished" content="2025-12-29T13:50:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙国浪子"/> <meta itemprop="url" content="https://juejin.cn/user/1943592291275886"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从点到线，从线到画：Canvas 画笔工具的实现艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592291275886/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙国浪子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T13:50:52.000Z" title="Mon Dec 29 2025 13:50:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✏️ 从点到线，从线到画：Canvas 画笔工具的实现艺术</h2>
<blockquote>
<p>💡 画笔工具是地图设计中最基础也最重要的工具之一。本文将带你探索 51mazi 项目中画笔工具的实现思路，从点坐标收集到平滑曲线生成，从 perfect-freehand 算法到实时渲染优化，揭秘如何打造一个流畅自然的画笔体验。</p>
</blockquote>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B" title="#%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B">功能简介</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95perfect-freehand" title="#%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95perfect-freehand">核心算法：perfect-freehand</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E6%8C%91%E6%88%98" title="#%E6%8A%80%E6%9C%AF%E6%8C%91%E6%88%98">技术挑战</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E4%BA%AE%E7%82%B9" title="#%E5%AE%9E%E7%8E%B0%E4%BA%AE%E7%82%B9">实现亮点</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h3 data-id="heading-2">🎯 功能简介</h3>
<p>画笔工具是地图设计工具中的"手绘神器"，让用户可以像在纸上画画一样自由绘制。在 51mazi 的地图设计工具中，画笔工具不仅仅是一个简单的线条绘制功能，而是一个集成了平滑算法、实时渲染、参数控制等多项技术的完整解决方案。</p>
<h4 data-id="heading-3">✏️ 功能特性</h4>
<ul>
<li>✅ <strong>平滑绘制</strong>: 基于 perfect-freehand 算法，生成自然流畅的画笔效果</li>
<li>✅ <strong>实时预览</strong>: 绘制过程中实时显示画笔轨迹，体验流畅</li>
<li>✅ <strong>参数控制</strong>: 支持颜色、大小、透明度等参数自定义</li>
<li>✅ <strong>压力模拟</strong>: 模拟真实画笔的压力变化，让线条更自然</li>
<li>✅ <strong>完整历史记录</strong>: 支持撤销/重做，操作可追溯</li>
</ul>
<h4 data-id="heading-4">🖼️ 使用场景</h4>
<p>在地图设计中，画笔工具常用于：</p>
<ul>
<li>🗺️ 绘制地形轮廓（山脉、河流、海岸线等）</li>
<li>✍️ 手绘标记和注释</li>
<li>🎨 自由创作和草图绘制</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e64760976b614db398d51f7535cb634f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zu95rWq5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767621052&amp;x-signature=n56pjcxYBE7vE7XjMQWv%2B5XUt0E%3D" alt="地图设计" loading="lazy"/></p>
<p><em>地图设计工具中的画笔工具 - 流畅自然的绘制体验</em></p>
<h3 data-id="heading-5">🔬 核心算法：perfect-freehand</h3>
<h4 data-id="heading-6">算法原理</h4>
<p>perfect-freehand 是一个专门用于生成平滑手绘线条的算法库，它的核心思想是：</p>
<ol>
<li><strong>收集点坐标</strong>: 记录鼠标移动过程中的所有点</li>
<li><strong>平滑处理</strong>: 对点序列进行平滑处理，消除抖动</li>
<li><strong>压力模拟</strong>: 根据速度变化模拟压力，让线条有粗细变化</li>
<li><strong>生成路径</strong>: 将处理后的点转换为平滑的路径</li>
<li><strong>填充绘制</strong>: 使用填充而非描边，生成更自然的画笔效果</li>
</ol>
<h4 data-id="heading-7">为什么选择 perfect-freehand？</h4>
<ul>
<li>🎨 <strong>自然效果</strong>: 生成的线条更接近真实手绘效果</li>
<li>⚡ <strong>性能优秀</strong>: 算法高效，适合实时绘制</li>
<li>🔧 <strong>易于集成</strong>: API 简洁，易于使用和定制</li>
<li>📦 <strong>轻量级</strong>: 库体积小，不影响应用性能</li>
</ul>
<h4 data-id="heading-8">算法使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { getStroke } <span class="hljs-keyword">from</span> <span class="hljs-string">'perfect-freehand'</span>

<span class="hljs-comment">// 配置参数</span>
<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">size</span>: strokeWidth,        <span class="hljs-comment">// 画笔大小</span>
  <span class="hljs-attr">thinning</span>: <span class="hljs-number">0.6</span>,            <span class="hljs-comment">// 压力变化强度</span>
  <span class="hljs-attr">smoothing</span>: <span class="hljs-number">0.5</span>,           <span class="hljs-comment">// 平滑度</span>
  <span class="hljs-attr">streamline</span>: <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// 流线化程度</span>
  <span class="hljs-attr">easing</span>: <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>((t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">2</span>),  <span class="hljs-comment">// 缓动函数</span>
  <span class="hljs-attr">simulatePressure</span>: <span class="hljs-literal">true</span>    <span class="hljs-comment">// 模拟压力</span>
}

<span class="hljs-comment">// 将点数组转换为路径</span>
<span class="hljs-keyword">const</span> inputPoints = points.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> [p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>])
<span class="hljs-keyword">const</span> stroke = <span class="hljs-title function_">getStroke</span>(inputPoints, options)

<span class="hljs-comment">// 绘制路径</span>
ctx.<span class="hljs-title function_">beginPath</span>()
ctx.<span class="hljs-title function_">moveTo</span>(stroke[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], stroke[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>])
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; stroke.<span class="hljs-property">length</span>; i++) {
  ctx.<span class="hljs-title function_">lineTo</span>(stroke[i][<span class="hljs-number">0</span>], stroke[i][<span class="hljs-number">1</span>])
}
ctx.<span class="hljs-title function_">closePath</span>()
ctx.<span class="hljs-title function_">fill</span>()
</code></pre>
<p><strong>参数说明</strong>:</p>
<ul>
<li><code>size</code>: 画笔的基础大小</li>
<li><code>thinning</code>: 控制线条粗细变化，值越大变化越明显</li>
<li><code>smoothing</code>: 控制平滑程度，值越大线条越平滑</li>
<li><code>streamline</code>: 控制流线化程度，让线条更流畅</li>
<li><code>simulatePressure</code>: 是否模拟压力，根据速度变化调整粗细</li>
</ul>
<blockquote>
<p>💡 <strong>完整算法实现请查看</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2FuseRender.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/useRender.js" ref="nofollow noopener noreferrer">src/renderer/src/composables/map/useRender.js</a></p>
</blockquote>
<h3 data-id="heading-9">🎯 技术挑战</h3>
<h4 data-id="heading-10">挑战 1: 点坐标的收集与存储</h4>
<p>在绘制过程中，需要实时收集鼠标移动的点坐标：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseDown</span>(<span class="hljs-params">pos</span>) {
  <span class="hljs-comment">// 开始新的画笔路径</span>
  elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span> = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'freedraw'</span>,
    <span class="hljs-attr">points</span>: [{ <span class="hljs-attr">x</span>: pos.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: pos.<span class="hljs-property">y</span> }],  <span class="hljs-comment">// 初始化第一个点</span>
    <span class="hljs-attr">color</span>: color.<span class="hljs-property">value</span>,
    <span class="hljs-attr">strokeWidth</span>: size.<span class="hljs-property">value</span>,
    <span class="hljs-attr">opacity</span>: opacity.<span class="hljs-property">value</span>,
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>()
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseMove</span>(<span class="hljs-params">pos</span>) {
  <span class="hljs-comment">// 添加点到当前路径</span>
  elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span>.<span class="hljs-property">points</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">x</span>: pos.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: pos.<span class="hljs-property">y</span> })
  <span class="hljs-comment">// 实时渲染</span>
  <span class="hljs-title function_">renderCanvas</span>(<span class="hljs-literal">false</span>)
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ul>
<li>✅ 使用数组存储点序列，保持顺序</li>
<li>✅ 实时添加点，确保轨迹完整</li>
<li>✅ 每次移动都触发渲染，保证流畅性</li>
</ul>
<h4 data-id="heading-11">挑战 2: 实时渲染的性能</h4>
<p>绘制过程中需要频繁渲染，性能优化至关重要：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseMove</span>(<span class="hljs-params">pos</span>) {
  <span class="hljs-keyword">if</span> (elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span>) {
    elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span>.<span class="hljs-property">points</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">x</span>: pos.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: pos.<span class="hljs-property">y</span> })
    <span class="hljs-comment">// 不更新边界，避免频繁计算导致性能问题</span>
    <span class="hljs-title function_">renderCanvas</span>(<span class="hljs-literal">false</span>)
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseUp</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 绘制完成时才更新边界</span>
  <span class="hljs-title function_">renderCanvas</span>(<span class="hljs-literal">true</span>)
}
</code></pre>
<p><strong>优化策略</strong>:</p>
<ul>
<li>⚡ 绘制过程中不更新边界（<code>renderCanvas(false)</code>）</li>
<li>⚡ 只在绘制完成时更新边界（<code>renderCanvas(true)</code>）</li>
<li>⚡ 减少不必要的计算，提升渲染性能</li>
</ul>
<h4 data-id="heading-12">挑战 3: 路径的平滑处理</h4>
<p>原始的点序列可能存在抖动，需要通过算法平滑处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">smoothing</span>: <span class="hljs-number">0.5</span>,      <span class="hljs-comment">// 平滑度：值越大越平滑</span>
  <span class="hljs-attr">streamline</span>: <span class="hljs-number">0.5</span>,     <span class="hljs-comment">// 流线化：让线条更流畅</span>
  <span class="hljs-attr">thinning</span>: <span class="hljs-number">0.6</span>        <span class="hljs-comment">// 压力变化：模拟真实画笔</span>
}
</code></pre>
<p><strong>效果对比</strong>:</p>
<ul>
<li>❌ <strong>未处理</strong>: 线条锯齿明显，不够平滑</li>
<li>✅ <strong>处理后</strong>: 线条流畅自然，接近手绘效果</li>
</ul>
<h4 data-id="heading-13">挑战 4: 透明度的处理</h4>
<p>支持透明度控制，让画笔效果更丰富：</p>
<pre><code class="hljs language-javascript" lang="javascript">ctx.<span class="hljs-title function_">save</span>()
ctx.<span class="hljs-property">globalAlpha</span> = (element.<span class="hljs-property">opacity</span> || <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>
ctx.<span class="hljs-property">fillStyle</span> = element.<span class="hljs-property">color</span>
<span class="hljs-comment">// 绘制路径</span>
ctx.<span class="hljs-title function_">fill</span>()
ctx.<span class="hljs-title function_">restore</span>()
</code></pre>
<h3 data-id="heading-14">✨ 实现亮点</h3>
<h4 data-id="heading-15">1. 模块化的 Composables 架构</h4>
<p>画笔工具采用 Composables 架构，实现了高内聚、低耦合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usePencilTool</span>(<span class="hljs-params">{
  canvasRef,
  elements,
  history,
  renderCanvas,
  color,
  size,
  opacity
}</span>) {
  <span class="hljs-keyword">const</span> drawingActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseDown</span>(<span class="hljs-params">pos</span>) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseMove</span>(<span class="hljs-params">pos</span>) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseUp</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
  
  <span class="hljs-keyword">return</span> {
    drawingActive,
    onMouseDown,
    onMouseMove,
    onMouseUp
  }
}
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>✅ 代码组织清晰，易于维护</li>
<li>✅ 功能独立，便于测试</li>
<li>✅ 可复用性强，易于扩展</li>
</ul>
<h4 data-id="heading-16">2. 状态管理</h4>
<p>使用响应式状态管理绘制状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> drawingActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)  <span class="hljs-comment">// 是否正在绘制</span>
<span class="hljs-keyword">const</span> lastPoint = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })  <span class="hljs-comment">// 上一个点</span>

<span class="hljs-comment">// 在绘制过程中更新状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseDown</span>(<span class="hljs-params">pos</span>) {
  drawingActive.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
  lastPoint.<span class="hljs-property">value</span> = { ...pos }
}
</code></pre>
<h4 data-id="heading-17">3. 历史记录集成</h4>
<p>完整的撤销/重做支持：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseDown</span>(<span class="hljs-params">pos</span>) {
  history.<span class="hljs-property">value</span>.<span class="hljs-title function_">saveState</span>()  <span class="hljs-comment">// 开始绘制前保存状态</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseUp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span>.<span class="hljs-property">points</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
    elements.<span class="hljs-property">freeDrawElements</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ ...elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span> })
    history.<span class="hljs-property">value</span>.<span class="hljs-title function_">saveState</span>()  <span class="hljs-comment">// 绘制完成后保存状态</span>
  }
}
</code></pre>
<h4 data-id="heading-18">4. 路径数据结构</h4>
<p>清晰的数据结构设计：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">type</span>: <span class="hljs-string">'freedraw'</span>,
  <span class="hljs-attr">points</span>: [
    { <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">200</span> },
    { <span class="hljs-attr">x</span>: <span class="hljs-number">105</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">205</span> },
    <span class="hljs-comment">// ... 更多点</span>
  ],
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#222222'</span>,
  <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">opacity</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">id</span>: <span class="hljs-string">'1234567890'</span>
}
</code></pre>
<p><strong>设计考虑</strong>:</p>
<ul>
<li>✅ 使用点数组存储路径，便于序列化</li>
<li>✅ 包含所有必要属性，支持完整恢复</li>
<li>✅ 唯一 ID 便于元素管理</li>
</ul>
<blockquote>
<p>💡 <strong>完整实现代码请查看</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2Ftools%2FusePencilTool.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/tools/usePencilTool.js" ref="nofollow noopener noreferrer">src/renderer/src/composables/map/tools/usePencilTool.js</a></p>
</blockquote>
<h3 data-id="heading-19">⚡ 性能优化</h3>
<h4 data-id="heading-20">1. 延迟边界更新</h4>
<p>绘制过程中不更新边界，减少计算开销：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 绘制过程中：不更新边界</span>
<span class="hljs-title function_">renderCanvas</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 绘制完成：更新边界</span>
<span class="hljs-title function_">renderCanvas</span>(<span class="hljs-literal">true</span>)
</code></pre>
<p><strong>优化效果</strong>:</p>
<ul>
<li>⚡ 减少边界计算次数</li>
<li>⚡ 提升绘制流畅度</li>
<li>⚡ 降低 CPU 占用</li>
</ul>
<h4 data-id="heading-21">2. 点数组优化</h4>
<p>合理控制点数组大小，避免内存占用过大：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 只在绘制完成时添加到元素数组</span>
<span class="hljs-keyword">if</span> (elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span>.<span class="hljs-property">points</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
  elements.<span class="hljs-property">freeDrawElements</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ ...elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span> })
}
</code></pre>
<h4 data-id="heading-22">3. 渲染优化</h4>
<p>使用 Canvas 的高效绘制 API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 fill 而非 stroke，效果更自然</span>
ctx.<span class="hljs-property">fillStyle</span> = element.<span class="hljs-property">color</span>
ctx.<span class="hljs-title function_">fill</span>()
</code></pre>
<h4 data-id="heading-23">4. 状态清理</h4>
<p>及时清理临时状态，避免内存泄漏：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseUp</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 完成绘制后清理临时路径</span>
  elements.<span class="hljs-property">currentFreeDrawPath</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
  drawingActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
}
</code></pre>
<h3 data-id="heading-24">📊 实现流程图</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户按下鼠标
<span class="hljs-code">    ↓
创建新的画笔路径
    ├─ 初始化点数组
    ├─ 设置颜色、大小、透明度
    └─ 保存历史状态
    ↓
鼠标移动
    ├─ 添加点到路径
    └─ 实时渲染（不更新边界）
    ↓
继续移动...
    ↓
用户释放鼠标
    ├─ 检查路径有效性（至少2个点）
    ├─ 添加到元素数组
    ├─ 更新边界
    └─ 保存历史状态
    ↓
完成绘制
</span></code></pre>
<h3 data-id="heading-25">📝 总结</h3>
<p>画笔工具虽然看似简单，但实现过程中涉及了多个技术领域：</p>
<ul>
<li>🎨 <strong>算法应用</strong>: perfect-freehand 算法的集成和使用</li>
<li>📊 <strong>状态管理</strong>: 响应式状态的管理和同步</li>
<li>⚡ <strong>性能优化</strong>: 实时渲染的性能优化策略</li>
<li>🔄 <strong>历史记录</strong>: 完整的撤销/重做支持</li>
<li>🏗️ <strong>架构设计</strong>: 模块化的 Composables 架构</li>
</ul>
<p>通过模块化的 Composables 架构，我们将画笔工具封装为独立的 <code>usePencilTool</code>，实现了高内聚、低耦合的代码结构，便于维护和扩展。</p>
<h4 data-id="heading-26">🚀 下一步探索</h4>
<p>如果你想深入了解：</p>
<ul>
<li>📖 <strong>完整代码实现</strong>: 查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2Ftools%2FusePencilTool.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/tools/usePencilTool.js" ref="nofollow noopener noreferrer">usePencilTool.js</a></li>
<li>🎨 <strong>渲染系统</strong>: 查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2FuseRender.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/useRender.js" ref="nofollow noopener noreferrer">useRender.js</a></li>
<li>🗺️ <strong>地图设计工具</strong>: 查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fviews%2FMapDesign.vue" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/views/MapDesign.vue" ref="nofollow noopener noreferrer">MapDesign.vue</a></li>
<li>📚 <strong>perfect-freehand</strong>: 查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsteveruizok%2Fperfect-freehand" target="_blank" title="https://github.com/steveruizok/perfect-freehand" ref="nofollow noopener noreferrer">perfect-freehand 文档</a></li>
</ul>
<hr/>
<h4 data-id="heading-27">📚 相关链接</h4>
<ul>
<li><strong>项目地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi" ref="nofollow noopener noreferrer">GitHub - 51mazi</a>，给个 Star 哦~</li>
<li><strong>画笔工具代码</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2Ftools%2FusePencilTool.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/tools/usePencilTool.js" ref="nofollow noopener noreferrer">src/renderer/src/composables/map/tools/usePencilTool.js</a></li>
<li><strong>渲染函数</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoshengxianjun%2F51mazi%2Fblob%2Fmain%2Fsrc%2Frenderer%2Fsrc%2Fcomposables%2Fmap%2FuseRender.js" target="_blank" title="https://github.com/xiaoshengxianjun/51mazi/blob/main/src/renderer/src/composables/map/useRender.js" ref="nofollow noopener noreferrer">src/renderer/src/composables/map/useRender.js</a></li>
<li><strong>perfect-freehand 库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsteveruizok%2Fperfect-freehand" target="_blank" title="https://github.com/steveruizok/perfect-freehand" ref="nofollow noopener noreferrer">perfect-freehand</a></li>
<li><strong>技术栈</strong>: Vue 3 + Canvas + perfect-freehand + Composables</li>
</ul>
<h4 data-id="heading-28">🏷️ 标签</h4>
<p><code>#Canvas</code> <code>#perfect-freehand</code> <code>#画笔工具</code> <code>#平滑绘制</code> <code>#实时渲染</code> <code>#Vue3</code> <code>#前端开发</code> <code>#性能优化</code> <code>#Composables</code></p>
<hr/>
<blockquote>
<p>💡 <strong>如果这篇文章对你有帮助，请给个 ⭐️ 支持一下！</strong></p>
<p>💡 <strong>想深入了解实现细节？欢迎查看 GitHub 上对应的代码文件，每个模块都有详细的注释说明！</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么放弃 v-if 选择 v-show？为什么组件越用越卡？]]></title>    <link>https://juejin.cn/post/7589126814829576244</link>    <guid>https://juejin.cn/post/7589126814829576244</guid>    <pubDate>2025-12-29T14:08:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126814829576244" data-draft-id="7589110783146541090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么放弃 v-if 选择 v-show？为什么组件越用越卡？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T14:08:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="heyCHEEMS"/> <meta itemprop="url" content="https://juejin.cn/user/4308367489378780"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么放弃 v-if 选择 v-show？为什么组件越用越卡？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4308367489378780/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    heyCHEEMS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:08:41.000Z" title="Mon Dec 29 2025 14:08:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在用 UniApp 开发一个折叠面板组件（Collapse）时，为了追求性能，我理所当然地给内容区域加上了 <code>v-if</code>。我想： <strong>“只有点开的时候才创建 DOM，不点开就不渲染，这不就是最完美的按需加载吗？”</strong></p>
<p>然而，当我打开微信开发者工具的调试器时，傻眼了：</p>
<p>我每点开一个插槽内容，DOM 树里就会莫名其妙多出好几个奇怪的节点（比如 collapse-item-1-1 这种）。随着点击次数增多，小程序开始变得卡顿，真机测试甚至出现了内存溢出导致的闪退。</p>
<hr/>
<h3 data-id="heading-0">1. “假销毁”：消失的内容，留下的“坑”</h3>
<p>在 H5 开发中，<code>v-if="false"</code> 会把 DOM 彻底删掉。但在<strong>小程序</strong>里，因为插槽（Slot）的实现机制，情况发生了变化。</p>
<ul>
<li>
<p><strong>小程序插槽是“静态”的</strong>：微信小程序原生框架要求插槽名（<code>slot name</code>）在编译阶段必须固定。</p>
</li>
<li>
<p><strong>UniApp 的动态模拟</strong>：为了支持 Vue 的动态插槽名（如 <code>:name="'content-' + index"</code>），UniApp 编译器在生成 <code>.wxml</code> 时，会预先生成大量的静态占位符来建立映射关系。</p>
</li>
<li>
<p><strong>幽灵节点的诞生</strong>：如果你在插槽<strong>外层</strong>套 <code>v-if</code>，每当切换状态，小程序底层无法真正“拔掉”已经存在的 Slot 容器。为了保证索引不乱，编译器会产生冗余的映射节点（如 <code>item-1-1</code>）。你点得越多，后台积压的“空框子”就越壮观。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 为什么 v-show 反而成了救星？</h3>
<p><code>v-show</code> 在小程序里会被编译成 <code>hidden</code> 属性（相当于 <code>display: none</code>）。</p>
<ul>
<li><strong>结构稳定</strong>：它在初始化时就把所有的“框子”准备好，不显示的就藏起来。</li>
<li><strong>不折腾 CPU</strong>：不需要反复创建和销毁节点。虽然初始加载多了一点点开销，但对于小程序这种“创建成本高、销毁不彻底”的环境，<strong>稳住 DOM 结构</strong>才是保命的关键。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 性能差距有多大？</h3>
<p>在一组包含 50 个复杂内容的列表测试数据对比：</p>





























<table><thead><tr><th><strong>指标</strong></th><th><strong>v-if 方案 (传统直觉)</strong></th><th><strong>v-show 方案 (优化后)</strong></th><th><strong>提升效果</strong></th></tr></thead><tbody><tr><td><strong>内存占用</strong></td><td>120MB (随操作增长)</td><td>45MB (基本恒定)</td><td><strong>降低 60%+</strong></td></tr><tr><td><strong>首屏渲染</strong></td><td>1.8s</td><td>2.1s</td><td>略有牺牲</td></tr><tr><td><strong>滑动帧率</strong></td><td>42fps (有卡顿)</td><td>59fps (丝滑)</td><td><strong>显著流畅</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">4. 如何写出“高性能”组件？</h3>
<p>核心策略是：<strong>用 <code>v-show</code> 守住“坑位”稳定性，用 <code>v-if</code> 严控“内容”加载时机。</strong></p>
<ol>
<li><strong>外层用 <code>v-show</code></strong>：确保 Slot 容器在小程序底层的 WXML 结构中永远稳定，不产生幽灵节点。</li>
<li><strong>内层用 <code>v-if</code></strong>：实现真正的内容懒加载。只有用户第一次点开时，才真正挂载昂贵的内容；一旦挂载不再销毁，只做显示切换。</li>
</ol>
<hr/>
<h3 data-id="heading-4">5. 总结</h3>
<p>技术选型没有绝对的对错，但在小程序这个“特殊环境”下，理解底层编译原理，比盲目套用 Vue 官方最佳实践更重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Smart Ticker - 支持任意字符的高性能文本差异动画滚动组件]]></title>    <link>https://juejin.cn/post/7589092567545004041</link>    <guid>https://juejin.cn/post/7589092567545004041</guid>    <pubDate>2025-12-29T14:16:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589092567545004041" data-draft-id="7589093895327055881" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Smart Ticker - 支持任意字符的高性能文本差异动画滚动组件"/> <meta itemprop="keywords" content="JavaScript,React.js,Vue.js"/> <meta itemprop="datePublished" content="2025-12-29T14:16:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hibear"/> <meta itemprop="url" content="https://juejin.cn/user/3931509308267661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Smart Ticker - 支持任意字符的高性能文本差异动画滚动组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509308267661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hibear
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:16:28.000Z" title="Mon Dec 29 2025 14:16:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在做一个AI配置的组件，突然有了这个做动画的简单初始想法<br/>
例如： 当我选择 GPT-5.2 mini 去替换 GPT-5.1 时能不能前缀 GPT-5. 不动后,面的 2 mini 替换 1 执行一个动画</p>
<p>捣鼓了一段时间，于是<strong>Smart Ticker</strong> 诞生了</p>
<blockquote>
<p><strong>官网有很多场景演示 Demo</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftombcato.github.io%2Fsmart-ticker%2F" target="_blank" title="https://tombcato.github.io/smart-ticker/" ref="nofollow noopener noreferrer">Smart Ticker Live Preview</a><br/>
<strong>GitHub仓库，详情见README</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftombcato%2Fsmart-ticker" target="_blank" title="https://github.com/tombcato/smart-ticker" ref="nofollow noopener noreferrer">tombcato/smart-ticker</a></p>
</blockquote>
<p>Gif有点掉帧，详情见<a href="https://link.juejin.cn?target=https%3A%2F%2Ftombcato.github.io%2Fsmart-ticker" target="_blank" title="https://tombcato.github.io/smart-ticker" ref="nofollow noopener noreferrer">官网</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46cec0c978cf4b88aa6b5c4b238c2463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGliZWFy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767638395&amp;x-signature=OZ0lyP%2BUFpH65IN5bUSWpNP7nIQ%3D" alt="smartticker3 (1).gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00e7ff68b1a144c9ad0144ffc8afaf25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGliZWFy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767638395&amp;x-signature=Pd5lHqCo3t9Hif9Q2%2BytiRB6%2Bg4%3D" alt="smartticker2.gif" loading="lazy"/>
欢迎去 GitHub 点个 Star 🌟，或者在评论区提 Issue！</p>
<h2 data-id="heading-1">为什么做 Smart Ticker？</h2>
<p>市面上其实已经有不少数字滚动库了，为什么还要造这个轮子？最大的痛点是：<strong>它们都不支持中文、Emoji 或者混排替换。</strong></p>






















































<table><thead><tr><th align="left">特性 / 库</th><th align="left"><strong>Smart Ticker</strong> 🚀</th><th align="left"><strong>Odometer.js</strong></th><th align="left"><strong>React CountUp</strong></th><th align="left"><strong>Number Flow</strong></th></tr></thead><tbody><tr><td align="left"><strong>核心机制</strong></td><td align="left"><strong>Levenshtein Diff (智能最短路径)</strong></td><td align="left">数值轮播 (0-9 循环)</td><td align="left">数值插值 (数字跳动)</td><td align="left">布局过渡 (Layout transition)</td></tr><tr><td align="left"><strong>字符支持</strong></td><td align="left"><strong>全字符集 (中英文/Emoji/符号/数字)</strong></td><td align="left">仅数字</td><td align="left">仅数字</td><td align="left">主要是数字</td></tr><tr><td align="left"><strong>动画效果</strong></td><td align="left"><strong>精准点对点 (只动变化的字符)</strong></td><td align="left">滚轮式 (必须滚过中间数字)</td><td align="left">只有数字在变，无位移</td><td align="left">现代且平滑</td></tr><tr><td align="left"><strong>中文/全角适配</strong></td><td align="left"><strong>自动宽窄字符适配</strong></td><td align="left">容易挤压或乱码</td><td align="left">N/A</td><td align="left">需手动处理</td></tr><tr><td align="left"><strong>多框架支持</strong></td><td align="left"><strong>React + Vue 3 (同构核心)</strong></td><td align="left">JS Wrapper</td><td align="left">React</td><td align="left">多框架</td></tr><tr><td align="left"><strong>动画中断</strong></td><td align="left"><strong>平滑流体过渡</strong></td><td align="left">重置或生硬跳转</td><td align="left">平滑</td><td align="left">平滑</td></tr></tbody></table>
<p>最大的区别在于：大多数库是把内容当成“数字”处理，而 <strong>Smart Ticker</strong> 是把内容当成 <strong>“字符串”</strong> 处理。这意味着你可以用它来滚动的不仅仅是金额，还可以是用户名、状态文本等等。</p>
<h2 data-id="heading-2">核心难题：如何让动画“聪明”起来？</h2>
<p>如果你直接把 <code>1234</code> 变成 <code>1254</code>，最笨的办法是把 <code>3</code> 销毁，创建 <code>5</code>。但我们想要的是：只有 <code>3</code> 变成 <code>5</code>，其他数字保持静止。</p>
<p>如果字符串长度不一样呢？比如 <code>Smart</code> 变成 <code>Start</code>。</p>
<ul>
<li>笨办法：5 个字母全换。</li>
<li><strong>聪明办法</strong>：<code>S</code>, <code>a</code>, <code>r</code>, <code>t</code> 不动，把中间的 <code>m</code> 删了，插入一个 <code>t</code>？不对，是 <code>m</code> 变成了 <code>t</code>。</li>
</ul>
<p>这本质上是一个 <strong>Diff 问题</strong>。我们需要找到从“旧字符串”到“新字符串”的<strong>最短编辑路径</strong>。</p>
<h2 data-id="heading-3">算法引入：Levenshtein Distance</h2>
<p>这里我引入了 <strong>Levenshtein Distance（编辑距离）</strong> 算法的变种。通常我们用它来计算两个字符串相似度，但在这里，我用它来生成<strong>操作队列</strong>。</p>
<p>通过动态规划矩阵，我们可以计算出每一个字符应该执行什么动作：</p>
<ol>
<li><strong>SAME (不变)</strong>：位置不变，UI 保持静止。</li>
<li><strong>MODIFY (修改)</strong>：字符变了（如 <code>3</code> -&gt; <code>5</code>），执行滚动动画。</li>
<li><strong>INSERT (插入)</strong>：新串变长，执行“挤入”动画。</li>
<li><strong>DELETE (删除)</strong>：新串变短，执行“挤出”动画。</li>
</ol>
<h3 data-id="heading-4">代码实现</h3>
<p>在 <code>Core</code> 模块中，我构建了一个 <code>(N+1) x (M+1)</code> 的矩阵，回溯计算最优路径：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简化的回溯逻辑</span>
<span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> || j &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; j &gt; <span class="hljs-number">0</span> &amp;&amp; oldStr[i-<span class="hljs-number">1</span>] === newStr[j-<span class="hljs-number">1</span>]) {
        <span class="hljs-comment">// 字符相等 -&gt; SAME</span>
        actions.<span class="hljs-title function_">unshift</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SAME'</span>, <span class="hljs-attr">char</span>: oldStr[i-<span class="hljs-number">1</span>] });
        i--; j--;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (costMatrix[i][j] === costMatrix[i-<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 替换操作 -&gt; MODIFY (Scroll)</span>
        actions.<span class="hljs-title function_">unshift</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'MODIFY'</span>, <span class="hljs-attr">from</span>: oldStr[i-<span class="hljs-number">1</span>], <span class="hljs-attr">to</span>: newStr[j-<span class="hljs-number">1</span>] });
        i--; j--;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* ... */</span>) {
        <span class="hljs-comment">// 处理 INSERT / DELETE</span>
    }
}
</code></pre>
<p>正是因为有了这个算法，<code>Smart Ticker</code> 才能做到：</p>
<ul>
<li><strong>100 -&gt; 105</strong>：只有 <code>5</code> 在动。</li>
<li><strong>Downloading... -&gt; Done</strong>：智能识别哪些字母保留，哪些字母滚走。</li>
</ul>
<h2 data-id="heading-5">挑战二：不仅是数字，中英字母Emoji我全都要！</h2>
<p>搞定了算法，渲染层又是一个坑。
中文字符（全角）和英文字符（半角）宽度不一样。如果强行用等宽字体，中文会被挤成一团或者英文间距过大。</p>
<p>我也遇到过这种“灾难现场”，中文挤在一起根本没法看。</p>
<p><strong>解决方案：</strong>
我实现了一个 <code>charWidth</code> 动态计算机制。</p>
<ol>
<li><strong>检测字符类型</strong>：通过 Unicode 范围检测当前字符是半角还是全角（或者是 Emoji）。</li>
<li><strong>动态基准宽度</strong>：
<ul>
<li>半角字符（数字/英文）：基准宽 <code>0.8em</code>（紧凑美观）。</li>
<li>全角字符（中文）：基准宽 <code>1.25em</code>（防止重叠）。</li>
<li>Emoji：特殊处理，确保不被截断。</li>
</ul>
</li>
</ol>
<p>这样一来，无论输 <code>BTC $98,000</code> 还是 <code>哈基米 🐱</code>，排版都稳如老狗。</p>
<h2 data-id="heading-6">挑战三：双框架支持 (React + Vue)</h2>
<p>有些库只有 React 版，我的AI配置组件项目是基于 Vue。为了雨露均沾，我采用 <strong>"Core + Adapter"</strong> 的架构设计。</p>
<ul>
<li><strong>src/core/</strong>: 纯 TypeScript 实现 Diff 算法、字符列表生成、缓动函数。不依赖任何框架。</li>
<li><strong>src/components/Ticker.tsx</strong>: React 封装层，使用 <code>useRef</code> 和 <code>RAF</code> 管理动画。</li>
<li><strong>src/components/vue/Ticker.vue</strong>: Vue 3 封装层，使用 <code>watch</code> 和 <code>requestAnimationFrame</code>。</li>
</ul>
<p>结果：两套组件 API 完全一致，维护起来也极其轻松。</p>
<h2 data-id="heading-7">最终效果 &amp; 如何使用</h2>
<p>现在，你只需要一行代码就能用上这个“聪明”的组件：</p>
<p><strong>安装：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install @tombcato/smart-ticker
</code></pre>
<p><strong>React 使用：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ticker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tombcato/smart-ticker'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'@tombcato/smart-ticker/style.css'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Ticker</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"98,456.32"</span> /&gt;</span></span>
</code></pre>
<p><strong>Vue 使用：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { Ticker } from '@tombcato/smart-ticker/vue';
import '@tombcato/smart-ticker/style.css';
&lt;/script&gt;

&lt;template&gt;
  &lt;Ticker value="🚀 发射成功" /&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>这就是一个从小灵感到落地实现的过程，坚持走下去从实现小的想法到实现大的想法，如果阿祖你能看到这里请帮我点个star，感谢感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域问题及解决方案]]></title>    <link>https://juejin.cn/post/7589126814829674548</link>    <guid>https://juejin.cn/post/7589126814829674548</guid>    <pubDate>2025-12-29T14:36:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126814829674548" data-draft-id="7589126217234317318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域问题及解决方案"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-29T14:36:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DongHao"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360790110"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域问题及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360790110/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DongHao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:36:10.000Z" title="Mon Dec 29 2025 14:36:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2bce013b98a4afe93c566e86a301674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9uZ0hhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625377&amp;x-signature=vrjyuDdG1EAtZ%2Bad3sykWlRz3pg%3D" alt="PixPin_2025-12-29_22-12-49.png" loading="lazy"/></p>
<h2 data-id="heading-0">跨域原因</h2>
<p>当前端请求地址与后端接口地址不同源时，浏览器会拦截接口请求，出现跨域问题。</p>
<p><strong>同源</strong>：协议、域名、端口必须完全一致。</p>
<p><strong>跨域</strong>：协议、域名、端口只要有一个不一致，就会跨域。</p>
<p><strong>同源策略</strong> 是浏览器的一种安全机制，限制不同源的网站之间进行无限制的资源访问或脚本交互，防止恶意网站通过脚本窃取其他网站的敏感数据（如 Cookie、本地存储等）。</p>
<h2 data-id="heading-1">解决方案</h2>
<h3 data-id="heading-2">前端配置代理</h3>
<p>在项目根目录的 <code>vite.config.ts</code> 中配置 <code>server.proxy</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>, <span class="hljs-comment">// 后端接口地址</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许跨域</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>) <span class="hljs-comment">// 去掉 '/api' 前缀</span>
      }
    }
  }
});
</code></pre>
<h3 data-id="heading-3">后端配置 CORS</h3>
<p>CORS（跨域资源共享）是 W3C 定义的跨域解决方案，通过后端在响应头中添加 <code>Access-Control-Allow-Origin</code> 等字段，告诉浏览器 “允许前端的跨域请求”。</p>
<p>以 Node.js + Express 为例，配置方式如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 允许前端本地跨域请求</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>({
  <span class="hljs-attr">origin</span>: <span class="hljs-string">'http://localhost:5173'</span>, <span class="hljs-comment">// 前端开发服务器地址</span>
  <span class="hljs-attr">methods</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>], <span class="hljs-comment">// 允许的请求方法</span>
  <span class="hljs-attr">allowedHeaders</span>: [<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'Authorization'</span>] <span class="hljs-comment">// 允许的请求头</span>
}));

<span class="hljs-comment">// 或者更简单：允许所有源（建议开发环境临时使用，禁止生产环境使用）</span>
<span class="hljs-comment">// app.use(cors());</span>

<span class="hljs-comment">// 后端接口示例</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'后端服务运行在 3000 端口'</span>);
});
</code></pre>
<p>配置后，后端响应头会包含 <code>Access-Control-Allow-Origin</code> 等字段，浏览器识别到这些字段就会允许跨域请求。</p>
<h3 data-id="heading-4">Nginx 反向代理</h3>
<p>生产环境中，前端请求发送到 Nginx 服务器（与前端同源），Nginx 再将请求转发到后端服务，后端响应数据也通过 Nginx 返回给前端。浏览器只与 Nginx 交互，不直接与后端通信，而服务器与服务器之间没有 “同源策略” 限制，也就不存在跨域问题。</p>
<pre><code class="hljs language-nginx" lang="nginx"># 反向代理：所有以 /api 开头的请求转发到后端 3000 端口
location /api/ {
    proxy_pass http://127.0.0.1:3000;  # 后端服务地址（服务器本地）
    
    # 传递请求头信息（必须配置，否则后端可能无法获取正确的客户端信息）
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
</code></pre>
<h3 data-id="heading-5">JSONP</h3>
<p>浏览器中有一些标签天生具有跨域能力，如：<code>img</code>、<code>link</code>、<code>iframe</code>、<code>script</code> 等，JSONP 就是利用了 <code>script</code> 标签不受同源策略限制的特性。</p>
<ol>
<li>前端提前定义回调函数 <code>fn</code>，并动态创建 <code>script</code> 标签，设置 <code>src</code> 为 <code>接口地址?callback=fn</code>。</li>
<li>后端获取请求参数 <code>callback</code>，返回该回调函数的调用字符串 <code>'fn(data)'</code>。</li>
<li>浏览器获取到 <code>script</code> 标签的返回内容（即 <code>'fn(data)'</code>）并解析执行，回调函数 <code>fn</code> 在前端被调用，就可以获取到后端返回的 <code>data</code>。</li>
</ol>
<p>前端示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 提前定义好的回调函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取到的跨域数据：'</span>, data);
}

<span class="hljs-comment">// 动态创建 script 标签</span>
<span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
script.<span class="hljs-property">src</span> = <span class="hljs-string">'http://localhost:3000/api/users?callback=handleData'</span>;

<span class="hljs-comment">// 将 script 添加到 body，发送 get 请求</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
</code></pre>
<p>后端示例：</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 获取回调函数名</span>
  <span class="hljs-keyword">const</span> callback = req.<span class="hljs-property">query</span>.<span class="hljs-property">callback</span>;
  <span class="hljs-keyword">const</span> data = { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> }] };
  <span class="hljs-comment">// 返回 `回调函数(data)` 格式的字符串</span>
  <span class="hljs-comment">// 前端 script 标签拿到返回内容，会将字符串当作脚本执行，回调函数就会在前端被调用</span>
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`<span class="hljs-subst">${callback}</span>(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>)`</span>);
});
</code></pre>
<p>JSONP 是传统方案，局限性大，仅支持 <code>GET</code> 请求（因为 <code>script</code> 标签只支持 <code>GET</code> 请求），且存在安全风险（可能遭受 XSS 攻击），已被 CORS 和 Nginx 反向代理替代，仅在兼容老旧浏览器场景下偶尔使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是margin重叠，如何解决]]></title>    <link>https://juejin.cn/post/7589110783146639394</link>    <guid>https://juejin.cn/post/7589110783146639394</guid>    <pubDate>2025-12-29T15:09:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589110783146639394" data-draft-id="7589126814829756468" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是margin重叠，如何解决"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T15:09:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是margin重叠，如何解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:09:32.000Z" title="Mon Dec 29 2025 15:09:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">什么是 Margin 重叠？</h3>
<p><strong>Margin 重叠（Margin Collapse）</strong>  是指当两个或多个<strong>垂直方向</strong>（上下）的块级元素的 margin 相遇时，它们会合并成一个 margin，其大小为两者中较大的那个值。这个特性只发生在<strong>标准文档流</strong>中的<strong>垂直方向</strong>，水平方向的 margin 不会重叠。</p>
<h4 data-id="heading-1">发生场景</h4>
<p>主要有三种情况：</p>
<p><strong>1. 相邻兄弟元素</strong><br/>
两个上下相邻的兄弟元素，它们之间的垂直间距不是 <code>上margin-bottom + 下margin-top</code>，而是取两者的<strong>最大值</strong>。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.box1</span> { <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>; }
  <span class="hljs-selector-class">.box2</span> { <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box1"</span>&gt;</span>Box 1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box2"</span>&gt;</span>Box 2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>最终两个盒子之间的距离是 <code>30px</code>（<code>max(30px, 20px)</code>），而不是 <code>50px</code>。</p>
<p><strong>2. 父子元素（第一个/最后一个子元素）</strong><br/>
当父元素没有有效的边框（border）、内边距（padding）、内容（height为0）或BFC（见下文）隔开时，父元素的 <code>margin-top</code> 和其第一个子元素的 <code>margin-top</code> 会发生重叠。<code>margin-bottom</code> 与最后一个子元素的 <code>margin-bottom</code> 同理。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#eee</span>; }
  <span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>Child<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>视觉上，父元素和子元素会一起贴着顶部，它们之间的顶部间距是 <code>30px</code>（取最大值），看起来像是父元素的 <code>margin-top</code> 被子元素“偷走”了。</p>
<p><strong>3. 空的块级元素</strong><br/>
如果一个块级元素没有内容、边框、内边距或高度，那么它自身的 <code>margin-top</code> 和 <code>margin-bottom</code> 会重叠。</p>
<h3 data-id="heading-2">如何解决 Margin 重叠？</h3>
<p>解决思路的核心是<strong>破坏它发生的条件</strong>。最通用、最标准的方法是创建 BFC。</p>
<h4 data-id="heading-3">主要解决方案</h4>
<p><strong>1. 创建 BFC（块格式化上下文）</strong><br/>
为父元素或相关元素创建一个新的 BFC，可以使其内部布局与外部隔离，从而阻止 margin 重叠。<br/>
常见创建 BFC 的方法：</p>
<ul>
<li>设置 <code>overflow</code> 为 <code>hidden</code>、<code>auto</code> 或 <code>scroll</code>（注意可能带来裁剪或滚动条）。</li>
<li>设置 <code>display</code> 为 <code>flow-root</code>（<strong>最推荐</strong>，专为创建 BFC 设计，无副作用）。</li>
<li>设置浮动 (<code>float: left/right</code>，但会脱离文档流)。</li>
<li>设置绝对定位 (<code>position: absolute/fixed</code>)。</li>
<li>设置 <code>display</code> 为 <code>inline-block</code>、<code>flex</code>、<code>grid</code>、<code>table</code> 等。</li>
</ul>
<p><strong>针对父子重叠的解决示例：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.parent</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#eee</span>;
    <span class="hljs-comment">/* 任选一种创建BFC的方法 */</span>
    <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 或 auto */</span>
    <span class="hljs-comment">/* 或者 */</span>
    <span class="hljs-attribute">display</span>: flow-root; <span class="hljs-comment">/* 无副作用，最佳实践 */</span>
  }
  <span class="hljs-selector-class">.child</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>Child<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>现在，父元素的 <code>margin-top</code> 是 30px，子元素的 <code>margin-top</code> 是 20px，两者不再重叠，总的上边距为 50px。</p>
<p><strong>2. 使用 Padding 或 Border 隔开</strong><br/>
在父元素上使用 <code>padding</code> 或 <code>border</code> 可以物理上阻止子元素的 margin 与外部合并。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">1px</span>; <span class="hljs-comment">/* 或 border-top: 1px solid transparent; */</span>
}
</code></pre>
<p><strong>3. 使用内联元素隔断</strong><br/>
在两个相邻元素之间插入一个内联元素或注释等，但这种方法不常用且不优雅。</p>
<p><strong>4. 使用 Flexbox 或 Grid 布局</strong><br/>
将父元素的 <code>display</code> 设置为 <code>flex</code> 或 <code>grid</code>，这会创建新的布局上下文，其子元素的 margin 不会与外部发生重叠。</p>
<h3 data-id="heading-4">总结与建议</h3>
<ul>
<li>
<p><strong>理解而非死记</strong>：理解 margin 重叠是 CSS 规范的一部分，有时它是有用的（如段落间距），并非总是“问题”。</p>
</li>
<li>
<p><strong>何时需要解决</strong>：当 margin 重叠导致你的布局计算与实际效果不符，需要精确控制间距时。</p>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>对于父子重叠</strong>，优先考虑为父元素设置 <code>display: flow-root;</code> 来创建 BFC，这是最干净且无副作用的方式。</li>
<li><strong>对于兄弟重叠</strong>，如果确实需要解决，可以将其中一个元素包裹在一个创建了 BFC 的容器中。</li>
<li>在实际开发中，也可以利用 CSS Reset 或现代框架（如 Tailwind CSS）的间距系统来避免复杂的 margin 重叠问题。</li>
</ol>
</li>
</ul>
<p>简单来说，<strong><code>display: flow-root;</code> 是解决 margin 重叠问题最现代、最安全的 CSS 方法</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【react 高频面试题—核心原理篇】：useEffect 的依赖项如果是数组或对象（引用类型），会有什么问题？如何解决？]]></title>    <link>https://juejin.cn/post/7589126920286666762</link>    <guid>https://juejin.cn/post/7589126920286666762</guid>    <pubDate>2025-12-29T15:47:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286666762" data-draft-id="7589092567545135113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【react 高频面试题—核心原理篇】：useEffect 的依赖项如果是数组或对象（引用类型），会有什么问题？如何解决？"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2025-12-29T15:47:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百罹鸟"/> <meta itemprop="url" content="https://juejin.cn/user/1838039173172072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【react 高频面试题—核心原理篇】：useEffect 的依赖项如果是数组或对象（引用类型），会有什么问题？如何解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1838039173172072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百罹鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:47:42.000Z" title="Mon Dec 29 2025 15:47:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">面试官提问：useEffect 的依赖项如果是数组或对象（引用类型），会有什么问题？如何解决？</h3>
<h4 data-id="heading-1">💡 核心回答技巧</h4>
<p>这道题考察的是两个核心点：</p>
<ol>
<li><strong>React 依赖检查机制</strong>：使用的是 <code>Object.is</code>（浅比较）。</li>
<li><strong>闭包陷阱与死循环</strong>：引用类型地址改变导致的不必要渲染或无限循环。</li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 问题的本质：浅比较（Shallow Comparison）</h3>
<p>React 在每次渲染后会对比 <code>useEffect</code> 的 <code>deps</code> 数组。 对于基本类型（string, number, boolean），比较的是<strong>值</strong>。 对于引用类型（Object, Array, Function），比较的是<strong>内存地址</strong>。</p>
<p><strong>典型错误场景：</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">UserProfile</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 每次组件重新渲染，options 都会被重新创建，指向一个新的内存地址</span>
  const options = { id: <span class="hljs-number">1</span> }; 

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>('执行了！');
  }, <span class="hljs-selector-attr">[options]</span>); <span class="hljs-comment">// 即使 options 的内容没变，地址变了，useEffect 就会触发</span>
}
</code></pre>
<p>如果 <code>useEffect</code> 内部又触发了状态更新，就会导致<strong>无限死循环</strong>。</p>
<h3 data-id="heading-3">2. 解决方案有哪些？</h3>
<h4 data-id="heading-4">方案一：使用 <code>useMemo</code> 或 <code>useCallback</code></h4>
<p>这是最正统的方法，将引用类型“持久化”。</p>
<ul>
<li><code>useMemo</code>：缓存对象/数组。</li>
<li><code>useCallback</code>：缓存函数。</li>
</ul>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss">const options = <span class="hljs-built_in">useMemo</span>(() =&gt; ({ id: <span class="hljs-number">1</span> }), <span class="hljs-selector-attr">[]</span>); 
<span class="hljs-comment">// 只要依赖项不变，options 的引用地址在多次渲染间保持不变</span>
</code></pre>
<h4 data-id="heading-5">方案二：属性拆解（推荐）</h4>
<p>如果对象很大，但我只关心其中的某个属性，直接把该属性放入依赖项。</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 业务逻辑</span>
}, <span class="hljs-selector-attr">[options.id]</span>); <span class="hljs-comment">// 监听基本类型 id，而不是整个对象</span>
</code></pre>
<h4 data-id="heading-6">方案三：使用 <code>useRef</code></h4>
<p>如果这个变量不需要参与渲染（即它的改变不需要触发 UI 更新），可以用 <code>useRef</code> 存储。<code>useRef</code> 返回的是同一个对象引用。</p>
<h4 data-id="heading-7">方案四：对于函数，写在 useEffect 内部</h4>
<p>如果函数只在效应内部使用，直接移进去，避免将其作为依赖。</p>
<hr/>
<h3 data-id="heading-8">3. 进阶追问：如果不小心造成了死循环，该如何排查？</h3>
<ul>
<li><strong>React DevTools</strong>：查看哪个 Hook 的数据一直在跳动。</li>
<li><strong>日志大法</strong>：在 <code>useEffect</code> 第一行打 <code>console.log</code>，看触发频率。</li>
</ul>
<hr/>
<h3 data-id="heading-9">🌟 总结</h3>
<blockquote>
<p>“<code>useEffect</code> 的依赖项对比执行的是<strong>浅比较</strong>。对于引用类型，即使内容一致，只要内存地址改变，效应就会重新执行。解决办法通常是使用 <code>useMemo/useCallback</code> <strong>冻结引用</strong>，或者<strong>拆解属性</strong>，确保只有当真正相关的数据变化时，才触发逻辑。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[容器化部署 Flux.1-dev 文生图模型应用 | 共绩算力]]></title>    <link>https://juejin.cn/post/7589201772133040169</link>    <guid>https://juejin.cn/post/7589201772133040169</guid>    <pubDate>2025-12-30T01:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772133040169" data-draft-id="7589172193151057956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="容器化部署 Flux.1-dev 文生图模型应用 | 共绩算力"/> <meta itemprop="keywords" content="人工智能,LLM,图片资源"/> <meta itemprop="datePublished" content="2025-12-30T01:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            容器化部署 Flux.1-dev 文生图模型应用 | 共绩算力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T01:56:11.000Z" title="Tue Dec 30 2025 01:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,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")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,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");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么选择Flux.1？</h2>
<p>作为2024年最强的开源文生图模型，Flux.1在文字渲染、人物细节和画面构图上全面超越SDXL。最重要的是，现在有现成的容器化方案，让你跳过繁琐的环境配置，一键部署即可使用。</p>
<h2 data-id="heading-1">准备工作（30秒）</h2>
<p>仅需两样东西：</p>
<ol>
<li>一个共绩云账号（新用户有免费额度）</li>
<li>会复制粘贴就行</li>
</ol>
<h2 data-id="heading-2">部署步骤（2分钟）</h2>
<h3 data-id="heading-3">第1步：选择镜像</h3>
<p>登录平台后，在服务部署页面搜索"FluxEz"官方镜像。这个42GB的镜像已集成所有需要的环境、模型文件和API接口，无需手动下载。</p>
<blockquote>
<p><strong>小贴士</strong>：如果是首次测试，选择单卡4090配置+1个节点就够用了，成本可控。</p>
</blockquote>
<h3 data-id="heading-4">第2步：配置参数</h3>
<p>直接采用默认配置即可，系统会自动：</p>
<ul>
<li>分配GPU资源</li>
<li>设置端口映射（WebUI:8188，API:3000）</li>
<li>加载Flux.1-dev模型和工作流</li>
</ul>
<h3 data-id="heading-5">第3步：点击部署</h3>
<p>确认配置无误后，点击"部署服务"。耐心等待1-2分钟，让节点拉取镜像并启动。当看到状态变为"运行中"，说明部署成功！</p>
<h3 data-id="heading-6">第4步：获取访问链接</h3>
<p>在任务详情页找到"快速访问"区域，系统会自动分配一个可公网访问的域名。你会看到两个端口：</p>
<ul>
<li><strong>8188端口</strong>：ComfyUI可视化界面</li>
<li><strong>3000端口</strong>：API接口地址</li>
</ul>
<h2 data-id="heading-7">立即使用（30秒）</h2>
<h3 data-id="heading-8">方式一：WebUI生成（适合新手）</h3>
<ol>
<li>点击8188端口链接进入ComfyUI界面</li>
<li>左侧菜单选择"工作流"，加载自带的<code>flux_dev_t5fp8.json</code></li>
<li>找到"CLIP文本编码"节点，输入英文提示词（Flux对英文支持更佳）</li>
<li>点击"执行队列"，稍等片刻即可在"保存图像"节点看到结果</li>
</ol>
<p><strong>示例提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">best quality, a cute anime girl, sunshine, soft features, blue dress, <span class="hljs-type">long</span> hair, looking at viewer, smile
</code></pre>
<h3 data-id="heading-9">方式二：API调用（适合开发）</h3>
<p>更适合生产环境的调用方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># API端点</span>
POST https://你的域名/prompt

<span class="hljs-comment"># 请求体结构</span>
{
  <span class="hljs-string">"prompt"</span>: {
    // 工作流JSON配置
  }
}

<span class="hljs-comment"># 返回结果</span>
{
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"请求ID"</span>,
  <span class="hljs-string">"images"</span>: [<span class="hljs-string">"base64编码的图片"</span>]
}
</code></pre>
<p>具体步骤：</p>
<ol>
<li>在ComfyUI中导出API格式的工作流JSON</li>
<li>通过POSTMAN或代码向3000端口发送请求</li>
<li>直接获得生成的图片数据</li>
</ol>
<p>高级用户还可以配置<code>webhook</code>参数，实现异步通知。</p>
<h2 data-id="heading-10">进阶玩法</h2>
<p>如果想自定义模型或添加插件：</p>
<ol>
<li><strong>下载模型文件</strong>：从Hugging Face获取所需的4个核心模型文件</li>
<li><strong>修改Dockerfile</strong>：参考开源项目的Dockerfile，添加自定义层</li>
<li><strong>构建镜像</strong>：执行<code>docker build</code>命令生成个性化镜像</li>
<li><strong>上传部署</strong>：将镜像推送到平台仓库后部署</li>
</ol>
<h2 data-id="heading-11">省钱小贴士</h2>
<ul>
<li>用完即停：不需要时记得停止服务，按实际使用时长计费</li>
<li>模型缓存：同一区域的节点会缓存镜像，二次启动速度更快</li>
<li>选择spot实例：非紧急任务可选抢占式实例，价格更低</li>
</ul>
<h2 data-id="heading-12">3分钟体验总结</h2>
<p>现在，你已经拥有了一个：</p>
<ul>
<li>✅ 支持顶级Flux.1-dev模型的文生图服务</li>
<li>✅ 同时提供可视化界面和API接口</li>
<li>✅ 可公网访问的专属应用</li>
<li>✅ 按需计费，成本可控</li>
</ul>
<p>无论是搭建个人AI绘画工作室，还是为产品集成文生图功能，这套方案都能让你快人一步。立即动手，开启你的AI创作之旅吧！</p>
<hr/>
<p><em>完整技术细节和自定义镜像指南可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fslmnb-lab%2FFluxEz" target="_blank" title="https://github.com/slmnb-lab/FluxEz" ref="nofollow noopener noreferrer">FluxEz开源项目</a></em></p>
<p><em>技术文档<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gongjiyun.com%2Fdocs%2Fy%2Fofl0wheysi5kwhkh2nfcownhnxf%2Fnmrawkpjai6syskqauscb2zmnjo%2F%231-%25E5%25BC%2580%25E6%25BA%2590%25E6%25A1%2588%25E4%25BE%258B" target="_blank" title="https://www.gongjiyun.com/docs/y/ofl0wheysi5kwhkh2nfcownhnxf/nmrawkpjai6syskqauscb2zmnjo/#1-%E5%BC%80%E6%BA%90%E6%A1%88%E4%BE%8B" ref="nofollow noopener noreferrer"> Flux.1-dev 文生图模型应用 | 共绩算力</a></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 高斯模糊（1） 窗口模糊及java侧基本流程简述]]></title>    <link>https://juejin.cn/post/7589052659436634158</link>    <guid>https://juejin.cn/post/7589052659436634158</guid>    <pubDate>2025-12-29T15:00:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589052659436634158" data-draft-id="7589104492883001396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 高斯模糊（1） 窗口模糊及java侧基本流程简述"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-29T15:00:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无言Echo"/> <meta itemprop="url" content="https://juejin.cn/user/942714871630682"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 高斯模糊（1） 窗口模糊及java侧基本流程简述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/942714871630682/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无言Echo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:00:34.000Z" title="Mon Dec 29 2025 15:00:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Android 12起，原生支持了窗口模糊接口能力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.google.cn%2Fdocs%2Fcore%2Fdisplay%2Fwindow-blurs" target="_blank" title="https://source.android.google.cn/docs/core/display/window-blurs" ref="nofollow noopener noreferrer">Window blurs  |  Android Open Source Project</a></p>
<p>按照官方的描述分为以下两种</p>
<ol>
<li>
<p>blur behind ：使窗口后面的整个屏幕变得模糊</p>
</li>
<li>
<p>background blur ：使指定区域的底层内容模糊</p>
</li>
</ol>
<p>其本质都是对当前surface后面的surface进行模糊显示。</p>
<ol>
<li>
<h2 data-id="heading-0">blur behind</h2>
</li>
</ol>
<p>公开接口可通过主题配置或者代码设置，两种方式任选其一</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"BlurBehind"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.CarLauncher"</span>&gt;</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowIsTranslucent"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBlurBehindEnabled"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBlurBehindRadius"</span>&gt;</span>70dp<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 代码方式设置</span>
window.addFlags(WindowManager.LayoutParams.FLAG_BLUR_BEHIND)
window.attributes = window.attributes.apply {
 blurBehindRadius = <span class="hljs-number">70</span>
} 
</code></pre>
<p>blurBehindRadius参数会传递到system_server端 WindowState中，由Dimmer设置（新建了一个dimLayer），最终是调用</p>
<p><strong>setBackgroundBlurRadius</strong> 接口</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38885f22a2d54b76a42a23241b511889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=uLrsUHizsIk8Bt0Eb2UBsObj7Hg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b95e49a5ac564dc6b54d97a5e18d7a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=cqN%2FCuUoRJUwIwbuEaz1OYFO8Rg%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>
<h2 data-id="heading-1">background blur</h2>
</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"BackgroundBlur"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.CarLauncher"</span>&gt;</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowIsTranslucent"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBackgroundBlurRadius"</span>&gt;</span>70dp<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 代码方式设置</span>
 window.setBackgroundBlurRadius(<span class="hljs-number">70</span>)
</code></pre>
<p>setBackgroundBlurRadius时做了什么事？</p>
<p>仅仅是创建了一个BackgroundBlurDrawable并设置到DecorView的背景中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8242d0de5e489db4346902c98ed75a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=4%2B1NzU9SSwFTHsgzHNEOP45IBco%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a97ccb75c7ef46dd89dbb14bc2225ea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=1NekvljeOUmbhgjztBwOD%2FNaWdI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd202f6f58b4148b27d3ac93a85cf6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=AxP3Kc51hRe0RG9AwsTbSjH69Pg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f78b3f3b894131810b21552959ec7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=GdgexbvN8CQLO97hFyZPZ2TwicQ%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<h3 data-id="heading-2">BackgroundBlurDrawable</h3>
</li>
</ol>
<p>BackgroundBlurDrawable到底做了什么神奇的事情实现了背景高斯模糊？</p>
<p>BackgroundBlurDrawable代码只有短短几百行，相对比较简单，</p>
<p>核心只是：<strong>记录下模糊参数：坐标范围，圆角值，模糊半径，透明度。</strong></p>
<p>圆角值，模糊半径，透明度都可以通过BackgroundBlurDrawable公开接口设置，不多解释。</p>
<p><strong>坐标范围是通过监听RenderNode位置变化获得</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0da7f003c3a406eaad9037105573848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=pBdup%2B7pfF159jkxLeTHKG58PJY%3D" alt="" loading="lazy"/></p>
<p>Aggregator可以保存多个BackgroundBlurDrawable，也就是说：</p>
<p><strong>一个窗口上是可以使用多个BackgroundBlurDrawable</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bef324ee9743a68df904db7d803c19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=1RmI5BVbtsDjjihoGSPWU4bEuuU%3D" alt="" loading="lazy"/></p>
<p>一个ViewRootImpl对应一个Aggregator，Aggregator对应多个BackgroundBlurDrawable</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3bca6321862415da846b47a477bf860~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=BD1Fk4LkDWGvXLyv%2BGCUrjONt0k%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>
<h3 data-id="heading-3">Aggregator如何连通ViewRootImpl和BackgroundBlurDrawable</h3>
</li>
</ol>
<p>每一次刷新界面时，如果Aggregator<strong>模糊区域发生更新</strong>或者<strong>存在模糊区域</strong>，</p>
<p>会读取当前的模糊区域参数，发送给SurfaceFlinger端</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f55a3d271c75425496e46dc8ab9cf3d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=o5BxBcijtKudKNKNT5Jg3MlTXtU%3D" alt="" loading="lazy"/></p>
<p>每个BackgroundBlurDrawable都可以转换成一个BlurRegion数据结构，</p>
<p>所以多个Drawable就转换成了一个BlurRegion数组</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/506fc8256c064e4eb9fa7be8ba63754e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=yqKkHCchXLPbrQdUNz3VCTSqFCk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c4f247097c460692b603989bf0267d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=2ltsNLFJhGJdoCZBRnFuszCNkv0%3D" alt="" loading="lazy"/></p>
<p>一个BlurRegion可以转换为一个float数组，那么多个BlurRegion可转换为一个float二维数组</p>
<p>即 多个BackgroundBlurDrawable记录的模糊参数，<strong>最终转换成了float二维数组</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b413e97abc6d4db889d9117da757efc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=TMWucEUgBWLsNGxvo3oKuOnl7DE%3D" alt="" loading="lazy"/></p>
<p>然后将表示模糊参数的float二维数组通过<strong>setBlurRegions</strong>下设</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/243b3673c5a6431eb4e74a50bc233b59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=VJXDf5UaoHQNNFDhzDa2U%2FI2Woo%3D" alt="" loading="lazy"/></p>
<p>有一个细节是：监听模糊坐标范围mRect更新并没有立即执行，而是作为Runable和帧数一起记下，在getBlurRegionsToDispatchToSf时再真正执行，这样避免了多线程同步问题。</p>
<blockquote>
<p>如果mRect立即更新，该操作在线程池中执行，无法保证执行顺序。假如监听到第100帧的RenderNoder位置变化mRect立即更新了，但是renderThread此时正在请求渲染第99帧，却使用了第100帧的位置，就会出现位置错位的问题。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f553cd0d0af46f193898123ce1c733d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=8PZ%2FF9PLnWidqX3YpLavBI5DzpA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c71c90ac25d74c9390a56e8bf5a17b78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767625233&amp;x-signature=BZ11JcLVgexRpfCMkHFyWUSQi5A%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<h2 data-id="heading-4">总结</h2>
</li>
</ol>
<p>综上，blur behind 本质上是使用了<strong>setBackgroundBlurRadius</strong> <strong>，</strong> background blur本质上是使用了<strong>setBlurRegions</strong>。</p>
<p>那么利用上面的接口，就可以实现surface的实时模糊显示。</p>
<p>比如：在一个surfaceView中显示视频或者3D画面，上面的surface使用上面的接口就可以实现模糊效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现一个三角形]]></title>    <link>https://juejin.cn/post/7589126814829805620</link>    <guid>https://juejin.cn/post/7589126814829805620</guid>    <pubDate>2025-12-29T15:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126814829805620" data-draft-id="7589156297787310115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现一个三角形"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T15:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现一个三角形
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:29:48.000Z" title="Mon Dec 29 2025 15:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实现三角形的几种方法</h2>
<p>在 CSS 中，实现三角形主要利用 <strong>边框（border）</strong>  的特性。以下是各种实现方法：</p>
<h2 data-id="heading-1">方法一：使用 Border 边框（最常用）</h2>
<p>这是最经典的方法，通过将元素宽高设为 0，然后设置边框来实现。</p>
<h3 data-id="heading-2">1. 基本三角形</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.triangle</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-style</span>: solid;
}
</code></pre>
<h3 data-id="heading-3">2. 不同方向的三角形</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 向上三角形 */</span>
<span class="hljs-selector-class">.triangle-up</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#3498db</span>;
}

<span class="hljs-comment">/* 向下三角形 */</span>
<span class="hljs-selector-class">.triangle-down</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#e74c3c</span>;
}

<span class="hljs-comment">/* 向左三角形 */</span>
<span class="hljs-selector-class">.triangle-left</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#2ecc71</span>;
}

<span class="hljs-comment">/* 向右三角形 */</span>
<span class="hljs-selector-class">.triangle-right</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#f39c12</span>;
}
</code></pre>
<h3 data-id="heading-4">3. 直角三角形</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 左上角直角三角形 */</span>
<span class="hljs-selector-class">.triangle-top-left</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">100px</span> solid transparent;
}

<span class="hljs-comment">/* 右下角直角三角形 */</span>
<span class="hljs-selector-class">.triangle-bottom-right</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#e74c3c</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">100px</span> solid transparent;
}
</code></pre>
<h2 data-id="heading-5">方法二：使用 transform: rotate() + overflow</h2>
<p>创建一个正方形，然后旋转 45 度，再通过父容器裁剪。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"triangle-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"triangle-rotate"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.triangle-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.triangle-rotate</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">141px</span>; <span class="hljs-comment">/* √2 * 100px */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">141px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">45deg</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">margin-top</span>: -<span class="hljs-number">71px</span>; <span class="hljs-comment">/* 调整位置 */</span>
  <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">71px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">方法三：使用 clip-path（现代方法）</h2>
<p>使用 CSS <code>clip-path</code> 属性可以直接裁剪出三角形，更简洁直观。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.triangle-clip</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  
  <span class="hljs-comment">/* 向上三角形 */</span>
  <span class="hljs-attribute">clip-path</span>: <span class="hljs-built_in">polygon</span>(<span class="hljs-number">50%</span> <span class="hljs-number">0%</span>, <span class="hljs-number">0%</span> <span class="hljs-number">100%</span>, <span class="hljs-number">100%</span> <span class="hljs-number">100%</span>);
  
  <span class="hljs-comment">/* 向下三角形 */</span>
  <span class="hljs-comment">/* clip-path: polygon(0% 0%, 100% 0%, 50% 100%); */</span>
  
  <span class="hljs-comment">/* 向左三角形 */</span>
  <span class="hljs-comment">/* clip-path: polygon(100% 0%, 100% 100%, 0% 50%); */</span>
  
  <span class="hljs-comment">/* 向右三角形 */</span>
  <span class="hljs-comment">/* clip-path: polygon(0% 0%, 0% 100%, 100% 50%); */</span>
}
</code></pre>
<h2 data-id="heading-7">方法四：使用线性渐变（background linear-gradient）</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.triangle-gradient</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  
  <span class="hljs-comment">/* 向上三角形 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to bottom right, transparent <span class="hljs-number">49.5%</span>, <span class="hljs-number">#3498db</span> <span class="hljs-number">50%</span>) 
      left / <span class="hljs-number">50%</span> <span class="hljs-number">100%</span> no-repeat,
    <span class="hljs-built_in">linear-gradient</span>(to bottom left, transparent <span class="hljs-number">49.5%</span>, <span class="hljs-number">#3498db</span> <span class="hljs-number">50%</span>) 
      right / <span class="hljs-number">50%</span> <span class="hljs-number">100%</span> no-repeat;
}
</code></pre>
<h2 data-id="heading-8">方法五：使用 ::before 或 ::after 伪元素</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.triangle-arrow</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.triangle-arrow</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: -<span class="hljs-number">20px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">25px</span> solid transparent;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">25px</span> solid transparent;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">20px</span> solid <span class="hljs-number">#3498db</span>;
}
</code></pre>
<h2 data-id="heading-9">实际应用示例</h2>
<h3 data-id="heading-10">示例 1：对话框气泡</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble"</span>&gt;</span>
  Hello, I'm a tooltip!
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble-arrow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.bubble</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2ecc71</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
}

<span class="hljs-selector-class">.bubble-arrow</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">10px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">10px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">10px</span> solid <span class="hljs-number">#2ecc71</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">示例 2：下拉菜单箭头</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown"</span>&gt;</span>
  Menu
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"arrow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.dropdown</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">30px</span> <span class="hljs-number">8px</span> <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.arrow</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">5px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">5px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">5px</span> solid white;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">对比与建议</h2>



































<table><thead><tr><th>方法</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Border 方法</strong></td><td>兼容性好（IE6+），简单</td><td>颜色只能纯色，调整大小麻烦</td><td>简单三角形，兼容性要求高</td></tr><tr><td><strong>Clip-path</strong></td><td>灵活，可以创建任意形状</td><td>IE 不支持，部分浏览器需前缀</td><td>现代浏览器，复杂形状</td></tr><tr><td><strong>Transform</strong></td><td>可以旋转任意角度</td><td>需要额外容器，计算复杂</td><td>需要旋转的特殊场景</td></tr><tr><td><strong>渐变</strong></td><td>可以渐变颜色</td><td>代码复杂，控制精度低</td><td>需要渐变效果的三角形</td></tr></tbody></table>
<h2 data-id="heading-13">实用技巧</h2>
<ol>
<li><strong>等边三角形</strong>：使用 border 方法时，确保两侧边框宽度相等</li>
<li><strong>等腰直角三角形</strong>：设置两条边框相等，第三条为透明</li>
<li><strong>空心三角形</strong>：使用两个三角形叠加实现</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 空心三角形 */</span>
<span class="hljs-selector-class">.hollow-triangle</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">50px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">100px</span> solid <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.hollow-triangle</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: -<span class="hljs-number">95px</span>; <span class="hljs-comment">/* 略小于外部三角形 */</span>
  <span class="hljs-attribute">left</span>: -<span class="hljs-number">45px</span>; <span class="hljs-comment">/* 略小于外部三角形 */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">45px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">45px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">95px</span> solid white; <span class="hljs-comment">/* 背景色 */</span>
}
</code></pre>
<h2 data-id="heading-14">总结</h2>
<ul>
<li><strong>最常用</strong>：Border 边框方法，兼容性好</li>
<li><strong>最灵活</strong>：Clip-path 方法，可以创建任意形状</li>
<li><strong>最直观</strong>：使用在线工具生成 clip-path 代码</li>
<li><strong>推荐</strong>：对于简单的三角形用 border，对于复杂或需要响应的用 clip-path</li>
</ul>
<p>记住核心原理：<strong>CSS 边框在元素宽高为 0 时，会在交界处形成对角线，从而创建三角形。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 高斯模糊（2）BackgroundBlurDrawable使用及相关Bug]]></title>    <link>https://juejin.cn/post/7589107312113516553</link>    <guid>https://juejin.cn/post/7589107312113516553</guid>    <pubDate>2025-12-29T15:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589107312113516553" data-draft-id="7589104492883099700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 高斯模糊（2）BackgroundBlurDrawable使用及相关Bug"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-29T15:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无言Echo"/> <meta itemprop="url" content="https://juejin.cn/user/942714871630682"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 高斯模糊（2）BackgroundBlurDrawable使用及相关Bug
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/942714871630682/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无言Echo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:32:06.000Z" title="Mon Dec 29 2025 15:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前文介绍了窗口高斯模糊的两种实现和基本原理</p>
<p><a href="https://juejin.cn/post/7589052659436634158" target="_blank" title="https://juejin.cn/post/7589052659436634158">Android 高斯模糊（1） 窗口模糊及java侧基本流程简述</a></p>
<p>本文将介绍一下BackgroundBlurDrawable的使用，原生bug，以及解决方案</p>
<h2 data-id="heading-0">1.任意View使用BackgroundBlurDrawable</h2>
<p>BackgroundBlurDrawable在原生中是给DecorView作为背景使用的，假如我们其他的View也想使用，可以参考原生代码，自行创建一个BackgroundBlurDrawable，设置给View作为背景即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意需要View在attachWindow之后才能获取到ViewRootImpl</span>
hostView.background = hostView.getViewRootImpl().createBackgroundBlurDrawable().apply {
setColor(Color.TRANSPARENT)
    setBlurRadius(<span class="hljs-number">70</span>)
    setCornerRadius(<span class="hljs-number">32f</span>)
} 
</code></pre>
<h2 data-id="heading-1">2.存在的bug</h2>
<h3 data-id="heading-2">2.1. 软件绘制时会发生Crash</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b5d70bc74d4fd5afcf06e5598e670f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=3%2BH%2Fpta9tMENg1JMa35ES%2BXah%2Bw%3D" alt="" loading="lazy"/></p>
<p>这是因为软件绘制时不支持drawRenderNode</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d535e25507427598f605e698b21f4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=Bj9ZBygboGLpkKZLS7wQG7ObLBY%3D" alt="" loading="lazy"/></p>
<p>修复方案：软件绘制时不执行drawRenderNode（需修改源码）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/005a8f396bd84954986d23d1f8569deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=J%2FZixQNU0BItjOQl3oCPmYVsr04%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2   高斯模糊效果可以渲染到窗口范围之外</h3>
<p>向窗口范围只有一部分，未铺满全屏，比如一个小弹框，其内部view通过scroll或transition偏移时，其高斯模糊效果会跟随便宜甚至会超出当前窗口范围。</p>
<p>  解决方案：限定坐标范围，使其范围不能超过最大值和最小值。</p>
<p>（这里的数字只是举例，正常通过添加方法支持外部参数设置）（修改源码）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb002e26348473f946702cd256553a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=60QwMg%2FagWmq8rK9XCkjK1K3vZs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. App端修改方案</h3>
<p>以上两个问题修改方案都是在framework中修改，但是我们在app开发过程中，无法直接修改framework；此外BackgroundBlurDrawable是final类型，在app端也无法直接继承修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b6ef8441fa54802899a5e6ae5e0053c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=8rv9unBVQWHYSu%2B6udxixB2toNI%3D" alt="" loading="lazy"/></p>
<p>好在存在DrawableWrapper，我们可以创建一个DrawableWrapper包装原生的BackgroundBlurDrawable，</p>
<ol>
<li>解决Crash问题</li>
</ol>
<p>  仅在硬件加速时，BackgroundBlurDrawable才绘制</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/527924fec07f4730a565c2ab11d0dc2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=S5YKpW3h%2Bfe4y4AlSF%2FSseuP3TM%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>解决高斯模糊效果渲染到窗口范围之外的问题</li>
</ol>
<p>  反射获取到rendernode，使用自己的监听器，替换掉旧的监听器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fbd03d943e845acaa569c4c84e60757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=Kl%2BFIw4%2ByFe92XYHPVqPsFJ0I6I%3D" alt="image.png" loading="lazy"/></p>
<p>示例方案代码如下</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.lws.app.graphics.drawable

<span class="hljs-keyword">import</span> android.<span class="hljs-keyword">annotation</span>.SuppressLint
<span class="hljs-keyword">import</span> android.graphics.Canvas
<span class="hljs-keyword">import</span> android.graphics.Paint
<span class="hljs-keyword">import</span> android.graphics.Path
<span class="hljs-keyword">import</span> android.graphics.Rect
<span class="hljs-keyword">import</span> android.graphics.RenderNode
<span class="hljs-keyword">import</span> android.graphics.drawable.DrawableWrapper
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> androidx.<span class="hljs-keyword">annotation</span>.ColorInt
<span class="hljs-keyword">import</span> com.android.<span class="hljs-keyword">internal</span>.graphics.drawable.BackgroundBlurDrawable

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundBlurDrawableV2</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> backgroundBlurDrawable: BackgroundBlurDrawable) :
    DrawableWrapper(backgroundBlurDrawable) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mPaint: Paint = fieldPaint.<span class="hljs-keyword">get</span>(backgroundBlurDrawable) <span class="hljs-keyword">as</span> Paint
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mRectPath: Path = fieldRectPath.<span class="hljs-keyword">get</span>(backgroundBlurDrawable) <span class="hljs-keyword">as</span> Path

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mAggregator = fieldAggregator.<span class="hljs-keyword">get</span>(backgroundBlurDrawable)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mRect: Rect = fieldRect.<span class="hljs-keyword">get</span>(backgroundBlurDrawable) <span class="hljs-keyword">as</span> Rect

    <span class="hljs-keyword">var</span> minTop = <span class="hljs-number">130</span>
    <span class="hljs-keyword">var</span> maxBottom = <span class="hljs-number">1800</span>

    <span class="hljs-keyword">val</span> positionUpdateListener: RenderNode.PositionUpdateListener =
        <span class="hljs-keyword">object</span> : RenderNode.PositionUpdateListener {
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">positionChanged</span><span class="hljs-params">(
                frameNumber: <span class="hljs-type">Long</span>, left: <span class="hljs-type">Int</span>, top: <span class="hljs-type">Int</span>, right: <span class="hljs-type">Int</span>,
                bottom: <span class="hljs-type">Int</span>
            )</span></span> {
                onRenderNodePositionChanged.invoke(mAggregator, frameNumber, Runnable {
mRect.<span class="hljs-keyword">set</span>(left, top, right, bottom)
                    <span class="hljs-keyword">if</span> (mRect.top &lt; minTop) {
                        mRect.top = minTop
                    }
                    <span class="hljs-keyword">if</span> (mRect.bottom &lt; minTop) {
                        mRect.bottom = minTop
                    }
                    <span class="hljs-keyword">if</span> (mRect.top &gt; maxBottom) {
                        mRect.top = maxBottom
                    }
                    <span class="hljs-keyword">if</span> (mRect.bottom &gt; maxBottom) {
                        mRect.bottom = maxBottom
                    }
                    Log.e(<span class="hljs-string">"ssssssxxxx"</span>, <span class="hljs-string">"xxxx <span class="hljs-variable">$mRect</span>"</span>)
                } )
            }

            <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">positionLost</span><span class="hljs-params">(frameNumber: <span class="hljs-type">Long</span>)</span></span> {
                onRenderNodePositionChanged.invoke(mAggregator, frameNumber, Runnable {
mRect.setEmpty()
                } )
            }
        }

    <span class="hljs-keyword">init</span> {
        <span class="hljs-keyword">val</span> mRenderNode = fieldRenderNode.<span class="hljs-keyword">get</span>(backgroundBlurDrawable) <span class="hljs-keyword">as</span> RenderNode
        mRenderNode.addPositionUpdateListener(positionUpdateListener)
        mRenderNode.removePositionUpdateListener(backgroundBlurDrawable.mPositionUpdateListener)
    }


    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">if</span> (canvas.isHardwareAccelerated) {
            <span class="hljs-keyword">super</span>.draw(canvas)
        } <span class="hljs-keyword">else</span> {
            canvas.drawPath(mRectPath, mPaint)
        }
    }


    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setColor</span><span class="hljs-params">(<span class="hljs-meta">@ColorInt</span> color: <span class="hljs-type">Int</span>)</span></span> {
        backgroundBlurDrawable.setColor(color)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setBlurRadius</span><span class="hljs-params">(blurRadius: <span class="hljs-type">Int</span>)</span></span> {
        backgroundBlurDrawable.setBlurRadius(blurRadius)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCornerRadius</span><span class="hljs-params">(cornerRadius: <span class="hljs-type">Float</span>)</span></span> {
        backgroundBlurDrawable.setCornerRadius(cornerRadius)
    }


    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"PrivateApi"</span>)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> classBackgroundBlurDrawable =
            Class.forName(<span class="hljs-string">"com.android.internal.graphics.drawable.BackgroundBlurDrawable"</span>)

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fieldAggregator = classBackgroundBlurDrawable.getDeclaredField(<span class="hljs-string">"mAggregator"</span>)
            .apply { isAccessible = <span class="hljs-literal">true</span> }
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fieldRect =
            classBackgroundBlurDrawable.getDeclaredField(<span class="hljs-string">"mRect"</span>).apply { isAccessible = <span class="hljs-literal">true</span> }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fieldRectPath =
            classBackgroundBlurDrawable.getDeclaredField(<span class="hljs-string">"mRectPath"</span>).apply { isAccessible = <span class="hljs-literal">true</span> }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fieldPaint =
            classBackgroundBlurDrawable.getDeclaredField(<span class="hljs-string">"mPaint"</span>).apply { isAccessible = <span class="hljs-literal">true</span> }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fieldRenderNode = classBackgroundBlurDrawable.getDeclaredField(<span class="hljs-string">"mRenderNode"</span>)
            .apply { isAccessible = <span class="hljs-literal">true</span> }


<span class="hljs-meta">@SuppressLint(<span class="hljs-string">"PrivateApi"</span>)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onRenderNodePositionChanged =
            Class.forName(<span class="hljs-string">"com.android.internal.graphics.drawable.BackgroundBlurDrawable<span class="hljs-variable">$Aggregator</span>"</span>)
                .getDeclaredMethod(
                    <span class="hljs-string">"onRenderNodePositionChanged"</span>,
                    <span class="hljs-built_in">Long</span>::<span class="hljs-keyword">class</span>.java, Runnable::<span class="hljs-keyword">class</span>.java
).apply { isAccessible = <span class="hljs-literal">true</span> }


 <span class="hljs-comment">/**
* 特别注意： 需要view在attachToWindow之后
*/</span>
<span class="hljs-meta">@JvmStatic</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createFromView</span><span class="hljs-params">(hostView: <span class="hljs-type">View</span>)</span></span>: BackgroundBlurDrawableV2 {
            <span class="hljs-keyword">val</span> backgroundBlurDrawable = hostView.getViewRootImpl().createBackgroundBlurDrawable()
            <span class="hljs-keyword">return</span> BackgroundBlurDrawableV2(backgroundBlurDrawable)
        }
    }
}
</code></pre>
<h2 data-id="heading-5">3.  原生内存泄漏问题</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/281de38b09d945eca83b584231ea84ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=T4jU0Bl888O%2BfKN8Xb7cxAkLO7U%3D" alt="" loading="lazy"/></p>
<p>全部指向 <strong>CrossWindowBlurListeners，</strong> 而且根据这个引用关系，可以发现是DecorView中引入的</p>
<p>查看DecorView源码，确实有添加这样一个监听器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69b3cd8a40f8465cb2c9f3765a872f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=rnDlXr0ZbERS4OYRT1erkHmEw68%3D" alt="" loading="lazy"/></p>
<p>在onDetachedFromWindow时是有移除该监听的逻辑的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/294139b04f43492ab6462fdac90d6d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=LHxbrk8f4GlRkFr2Wz701Cs%2BSIY%3D" alt="" loading="lazy"/></p>
<p>那么可以推断：<strong>造成该泄漏的原因是没有走到onDetachedFromWindow这里</strong>。</p>
<p>正常窗口关闭肯定是会走到 <strong>onDetachedFromWindow</strong> 的，如果没有走到，那可能之前根本就<strong>没有AttachedToWindow。</strong></p>
<p>搜索<strong>setBackgroundBlurRadius ，</strong> 可以发现是从PhoneWindow调用的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e4f20f062b4d5cb5af4cc8d0a1d641~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=ZHU%2Fk6iy8f3R0J2qc2owFxvLgh4%3D" alt="" loading="lazy"/></p>
<p>再继续查看PhoneWindow源码，发现在<strong>generateLayout</strong> 时就会setBackgroundBlurRadius了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/937b4c05faca48b1b4c8e5fa8ab52365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6KiARWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767627126&amp;x-signature=kRzyti%2FrRA0ZgTikL80qiJ1ik8o%3D" alt="" loading="lazy"/></p>
<p>也就是说，即使这个窗口没有显示（没有AttachedToWindow），只要调用 <strong>generateLayout</strong> 或者 <strong>setBackgroundBlurRadius</strong></p>
<p>就会添加这样一个监听器，后续如果没有<strong>AttachedToWindow</strong>、<strong>onDetachedFromWindow</strong> 就会出现内存泄漏问题。</p>
<p>可能存在的场景：</p>
<blockquote>
<p>构造了一个Dialog，这个Dialog主题中声明使用 windowBackgroundBlurRadius，
即使用BackgroundBlurDrawable，</p>
<p>调用了setContentView/或者getWindow（都会触发<strong>generateLayout</strong> 导致设置监听blur的监听器）</p>
<p>后续没有show，就会出现内存泄漏!!!</p>
</blockquote>
<p>这其实是AOSP中一个非常低级的代码编写问题：</p>
<p><strong>注册监听，移除监听没有对称执行。</strong></p>
<p>原则上来说，generateLayout/setBackgroundBlurRadius时不应该直接注册监听，</p>
<p>应该在onAttachedToWindow时注册监听，在onDetachedFromWindow时移除监听，这样才是符合对称的设计。</p>
<p>对比高版本代码，直至Android16，AOSP中仍没有修复该问题。</p>
<h3 data-id="heading-6">App端规避方案</h3>
<p>为了规避该问题，在窗口主题中<strong>不建议</strong>声明使用<strong>windowBackgroundBlurRadius，</strong> 这样可以避免Framework流程中提前注册blur监听器。</p>
<p>在窗口显示/消失时，手动setBackgroundBlurRadius，保证blur监听器的注册/移除可控。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestDialog</span>(context: Context) : Dialog(context) {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onStart()
        <span class="hljs-comment">// 在窗口显示时设置自己期望的模糊值</span>
        window!!.setBackgroundBlurRadius(<span class="hljs-number">70</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onStop()
        <span class="hljs-comment">// 模糊值清零,触发移除监听</span>
        <span class="hljs-comment">// (其实这里不清零也可以,因为根据上述分析流程,DecorView会在onDetachedFromWindow时移除监听)</span>
        window!!.setBackgroundBlurRadius(<span class="hljs-number">0</span>)
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026了你还只会写点prompt？从AI提示词到可控自动化的演进之路]]></title>    <link>https://juejin.cn/post/7589099845186682916</link>    <guid>https://juejin.cn/post/7589099845186682916</guid>    <pubDate>2025-12-29T12:08:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589099845186682916" data-draft-id="7589201772117360646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026了你还只会写点prompt？从AI提示词到可控自动化的演进之路"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T12:08:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="脱氧核糖核酸"/> <meta itemprop="url" content="https://juejin.cn/user/1682680633885641"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026了你还只会写点prompt？从AI提示词到可控自动化的演进之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1682680633885641/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    脱氧核糖核酸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T12:08:43.000Z" title="Mon Dec 29 2025 12:08:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1、前言</h3>
<blockquote>
<p>简单总结一下个人使用AI的路线演进:</p>
<ul>
<li>定义prompt优化AI提示和补全效果</li>
<li>定义规则rules约束AI生成的可控性</li>
<li>定义工作流，让AI分步执行任务</li>
<li>通过Agent实现AI自动化可控式迭代</li>
</ul>
</blockquote>
<p>前面3个步骤比较常见，这里避免啰嗦，直接最后一步；另外本文不涉及具体实现细节，只分享整体架构以及对应的演化思路。</p>
<h3 data-id="heading-1">2、最初的设想</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[线上系统运行] --&gt; B[线上错误监控]
    A --&gt; C[用户反馈]

    D[接口文档]
    E[需求文档]

    %% MCP 模块
    B --&gt; M[MCP Server]
    C --&gt; M
    D --&gt; M
    E --&gt; M
    M --&gt; F[AI Agent]
    F --&gt;|自动分析与决策| G[生成 / 修改代码]
    G --&gt;|自动提交| H[部署上线]

    H --&gt;|形成闭环| A

    style M fill:#e3f2fd
    style F fill:#e1f5ff
    style G fill:#e1ffe1
    style H fill:#fff4e1
    style A fill:#ffe8e1
</code></pre>
<p>最初的想法很简单，就是把日常开发需要的东西全部丢给AI，自己做撒手掌柜，<strong>这里解决向AI传输数据的核心方式是通过MCP协议构建的MCP Server服务</strong>。</p>
<p>MCP全称(Model Context Protocol)，可以自己搜一下，主要是用来解决这些Prompt的问题：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 不可校验</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 不可diff</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 不可回滚</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 不可组合</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 不可规模化</li>
</ul>
<p>为了解决这些个问题，大家不得不打成了共识。</p>
<h3 data-id="heading-2">3、遇到的问题</h3>
<h4 data-id="heading-3">3.1、AI项目迭代的失控</h4>
<p>如果大家有自己亲手尝试从零开始生成一个项目进行迭代，就会遇到一些很明显的场景：</p>
<ol>
<li>初始生成，惊为天人</li>
<li>后续修改，逐渐崩溃</li>
<li>细节调整，开始混乱</li>
<li>对话过长，胡言乱语</li>
<li>问题修复，陷入循环</li>
</ol>
<p>实际运行效果如下😅：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    D1[Day 1: AI快速搭建系统]
    D2[Day 2: AI修改功能]
    P1[遗忘早期设计决策]
    P2[修Bug引入新Bug]
    P3[代码膨胀 5k -&gt; 12k 40%冗余]
    P4[同一需求多次生成结果不一致]
    M3[Day 3: 不敢再让AI改代码]

    %% 主线
    D1 --&gt; D2
    D2 --&gt; P1
    D2 --&gt; P2
    D2 --&gt; P3
    D2 --&gt; P4
    P1 --&gt; M3
    P2 --&gt; M3
    P3 --&gt; M3
    P4 --&gt; M3
</code></pre>
<p>遇到问题就解决问题：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    %% 起点
    A[反思为什么失败] --&gt; B[根本原因]

    %% 顿悟阶段
    B --&gt; C1[AI没有长期记忆]
    B --&gt; C2[代码是唯一载体]
    B --&gt; C3[每次都要重读代码]

    %% 永久记忆阶段
    C1 --&gt; D[思考&amp;顿悟]
    C2 --&gt; D[思考&amp;顿悟]
    C3 --&gt; D[思考&amp;顿悟]

    %% 解决方案阶段
    D --&gt; E1[AI需要长期记忆]
    E1 --&gt; E2[提取项目核心元数据 - AST]

    %% 产物阶段
    E2 --&gt; F1[AST是项目的基因]
    E2 --&gt; F2[代码是基因编译的一次性产物]
    E2 --&gt; F3[AI是基因编译实体的工具]

    %% APS-DSL诞生
    F1 --&gt; G[APS-DSL诞生]
    F2 --&gt; G[APS-DSL诞生]
    F3 --&gt; G[APS-DSL诞生]

</code></pre>
<p>然后我们的整体流程就变成了这样：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[线上系统运行] --&gt; B[线上错误监控]
    A --&gt; C[用户反馈]

    D[接口文档]
    E[需求文档]

    %% MCP 模块
    B --&gt; M[MCP Server]
    C --&gt; M
    D --&gt; M
    E --&gt; M
    M --&gt; N[项目基因AST&amp; AI_GUIDE.MD]
    N --&gt; F[AI Agent]
    F --&gt;|自动分析与决策| G[生成 / 修改代码]
    G --&gt;|自动提交| H[部署上线]

    H --&gt;|形成闭环| A

    style M fill:#e3f2fd
    style F fill:#e1f5ff
    style G fill:#e1ffe1
    style H fill:#fff4e1
    style A fill:#ffe8e1
</code></pre>
<p><strong>这个流程里增加了核心模块AST，解决AI需要外部记忆系统的问题。后续项目的迭代，就成了以AST作为核心基因，进行基因表达式的演进流程</strong></p>
<p>上面这个是最为关键的一步，应该算是独创的流程，没见过类似的。</p>
<p>这里AST可以理解为项目知识图谱Knowledge Graph，核心元数据等等，个人还是喜欢称为AST，和抽象语法树没关系。</p>
<p>AST的模版最初参考DSL选择了yaml，因为这个东西很像是容器里的DockerFile,目标是设想有了这个后，代码可以像容器一样随意删除。</p>
<p>后来便于AI校验和识别，以及便于阅读，改为json文件。</p>
<p>我这里定义了主要13个基础模版,细节就不展示了，仅供参考：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**<span class="hljs-emphasis">_meta.ast.json** - 📌 **入口文件**：项目元信息、技术栈、团队、架构，**包含所有AST文件清单**
**_</span>ast<span class="hljs-emphasis">_index.json** - AST索引文件：全局统计和关系图谱（最后生成）
**api.ast.json** - API接口定义 API 接口（基础信息：id, name, method, path, params, response）
**api.enhanced.ast.json** - API增强定义（含semantics、implementationHints等AI分析）
**config.ast.json** - 配置信息、环境变量、构建配置
**contexts.ast.json** - 应用上下文（认证、缓存、数据库连接等）
**domain.ast.json** - 数据模型、实体、字段、关系
**infrastructure.ast.json** - 中间件、工具函数、公共服务
**permission.ast.json** - 权限定义、角色、资源访问控制
**response-format.ast.json** - API响应格式标准、错误码定义
**ui-components.ast.json** - UI组件抽象定义（框架无关）
**ui.ast.json** - UI页面、路由、布局结构
**workflow.ast.json** - 业务流程、工作流定义
</span></span></code></pre>
<h4 data-id="heading-4">3.2、信息源造成的混乱</h4>
<p><strong>实际场景</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Sentry</span>说：<span class="hljs-title class_">User</span>.<span class="hljs-title function_">save</span>()报错
<span class="hljs-title class_">Swagger</span>说：<span class="hljs-variable constant_">POST</span> /user需要email字段
用户反馈说：注册后没收到邮件
老代码说：<span class="hljs-title class_">User</span>模型有username字段

→ <span class="hljs-variable constant_">AI</span>整合<span class="hljs-number">4</span>个信息源，生成了<span class="hljs-string">"看似正确"</span>的代码
→ 实际运行：逻辑冲突，更多<span class="hljs-title class_">Bug</span>
</code></pre>
<p><strong>解决思路</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[多信息源] --&gt; B[Sentry错误]
    A --&gt; C[用户反馈]
    A --&gt; D[Swagger文档]
    A --&gt; E[现有代码]
    
    B &amp; C &amp; D &amp; E --&gt;|AI提取| F[AST元数据]
    F --&gt;|AI自动化审核| G{完备性检查}
    
    G --&gt;|62%| H[生成缺失报告]
    H --&gt; I[详细清单:&lt;br/&gt;- 32个参数缺说明&lt;br/&gt;- 18个缺验证规则]
    I --&gt;|补充| F
    
    G --&gt;|&gt;95%| J[唯一可信源]
    J --&gt;|自动生成| K[代码]
    J --&gt;|自动生成| L[文档]
    J --&gt;|自动生成| M[测试]
    
    style F fill:#fff4e1
    style G fill:#ffe1f5
    style J fill:#e1ffe1
    style K fill:#e1f5ff
    style L fill:#e1f5ff
    style M fill:#e1f5ff
</code></pre>
<p>这个流程增加了核心模块：AST完备性检查，用来确认数据是否冲突，是否完整，等等。</p>
<h4 data-id="heading-5">3.3、无法保证生成结果的一致性</h4>
<p><strong>失败案例</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">需求：实现User注册接口

AI第1次生成：
<span class="hljs-deletion">- POST /api/user/register</span>
<span class="hljs-deletion">- 使用bcrypt加密密码</span>
<span class="hljs-deletion">- 返回JWT token</span>

AI第2次生成（同一需求）：
<span class="hljs-deletion">- POST /api/v1/users</span>
<span class="hljs-deletion">- 使用md5加密密码</span>
<span class="hljs-deletion">- 返回session cookie</span>

AI第3次生成：
<span class="hljs-deletion">- POST /register</span>
<span class="hljs-deletion">- 明文存储密码（！）</span>
<span class="hljs-deletion">- 返回user_id</span>

→ 同一需求，3种完全不同的实现！
</code></pre>
<p><strong>根本原因</strong>：</p>
<ul>
<li>AI的生成过程包含随机性</li>
<li>缺乏标准化约束</li>
<li>没有确定性生成机制</li>
<li>没有明确指示的，AI就会漂移摇摆不定</li>
</ul>
<p><strong>解决思路</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[AST定义] --&gt;|标准化| B[134个预定义动作]
    B --&gt; C[禁止AI自创]
    
    A --&gt;|模板引擎| D[自定义模板]
    D --&gt;|决定性生成| E[代码输出]
    
    E --&gt;|10次生成| F[哈希验证]
    F --&gt;|完全一致| G[diff = 0]
    
    H[失败方案] --&gt;|AI自由发挥| I[每次不同]
    
    style A fill:#fff4e1
    style B fill:#e1ffe1
    style G fill:#e1ffe1
    style I fill:#ffe1e1
</code></pre>
<p>到这里大家可能会发现一个问题，怎么搞模版了，这是不是变成了类似‘低代码平台’JSON Schema类似的东西，恭喜你猜对了一半，给你点个👍。</p>
<p><strong>其实到这一步确实遇到了偏离最初设想的问题</strong>：</p>
<p>我们想要：有限的基因AST + 无限制的语言/框架/库/工具 === 去实现有限的结果输出。</p>
<p>但是： 1+无限=无限， 1x无限=无限</p>
<p><strong>在这种要求下，我们只能通过迭代流程等要素，无限趋近于100%的实现有限和一致的输出，但是就像圆周率永远算不尽，永远没有绝对光滑的圆，我们也只能实现有一定波动的输出。</strong></p>
<p>这种波动并非没有意义，比如我们用来重构项目时，更换一下框架语言，升级一下依赖和运行环境版本等，实现一个95%完成率的重构项目，也是很有价值的，具体不再过多讨论。</p>
<h4 data-id="heading-6">3.4、现有项目的知识流失</h4>
<p><strong>真实案例</strong>：</p>
<pre><code class="hljs">核心开发人员离职 
  ↓
业务逻辑散落在代码中，难以理解
  ↓
文档缺失或已过时
  ↓
新人上手需要2-3周，频繁踩坑
  ↓
维护成本越来越高，不敢重构
</code></pre>
<p><strong>根本原因</strong>：</p>
<ul>
<li>业务逻辑隐藏在代码实现细节中</li>
<li>文档与代码分离，容易不同步</li>
<li>缺乏结构化的知识沉淀机制</li>
<li>项目知识随人员流失而消失</li>
</ul>
<p><strong>解决思路（反向提取）</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[现有源码项目] --&gt;|AI分析提取| B[AST元数据]
    
    B --&gt; C[13类结构化知识]
    
    C --&gt; C1[API定义]
    C --&gt; C2[数据模型]
    C --&gt; C3[业务流程]
    C --&gt; C4[权限规则]
    C --&gt; C5[UI组件]
    C --&gt; C6[配置项]
    
    C1 --&gt;|自动生成| E[API文档]
    C2 --&gt;|自动生成| F[ER图]
    C3 --&gt;|自动生成| G[流程图]
    B --&gt;|自动生成| H[架构图]
    C4 --&gt;|自动生成| I[权限矩阵]
    
    E &amp; F &amp; G &amp; H &amp; I &amp; C --&gt;|综合生成| D[项目接手指南]
    D --&gt; D1[架构图]
    D --&gt; D2[API列表]
    D --&gt; D3[ER图]
    D --&gt; D4[业务流程图]
    D --&gt; D5[权限模块]
    D --&gt; D6[源码核心摘要]
    D --&gt; D7[开发流程/注意事项]
    
    B --&gt;|可追溯| J[源码位置记录]
    J --&gt; K[文件路径+行号]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style D fill:#e1ffe1
    style E fill:#e1ffe1
    style F fill:#e1ffe1
    style G fill:#e1ffe1
    style H fill:#e1ffe1
    style I fill:#e1ffe1
    style K fill:#ffe8e1
</code></pre>
<p>这个流程其实只是增加了一些文档：
PROCESS_PROJECT_ONBOARDING_DOC_GENERATION.md，用于生成项目使用指南。
AI_GUIDE_V2.md ，迭代后的AI指引入口文档，用于让AI参考指定的文件分步执行流程。</p>
<h3 data-id="heading-7">总结</h3>
<p>其实还有很多细节。</p>
<p>比如：如何进行AI流程开发的调试工作，如何生成AI修改报告等，网上也能搜到，这里就不再赘述了。</p>
<p>以上就是个人总结的一些思路，希望对大家有所帮助。</p>
<p>写文章太痛苦了，有用的话点个赞，掘金的mermaid图貌似版本有点低？后面该画图的我都省了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Cursor进阶实战·01】Figma设计稿一键还原：Cursor + MCP让前端开发提速10倍]]></title>    <link>https://juejin.cn/post/7589093939656687668</link>    <guid>https://juejin.cn/post/7589093939656687668</guid>    <pubDate>2025-12-29T12:54:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589093939656687668" data-draft-id="7589093939656654900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Cursor进阶实战·01】Figma设计稿一键还原：Cursor + MCP让前端开发提速10倍"/> <meta itemprop="keywords" content="Cursor,MCP,LLM"/> <meta itemprop="datePublished" content="2025-12-29T12:54:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Cursor进阶实战·01】Figma设计稿一键还原：Cursor + MCP让前端开发提速10倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T12:54:12.000Z" title="Mon Dec 29 2025 12:54:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>还记得第一次拿到设计师的Figma链接时的心情吗？兴奋中带着一丝恐惧——"这么精美的设计，我能还原到90%就不错了"。然后开始漫长的测量之旅：</p>
<ul>
<li>🔍 右键检查间距："<code>padding: 24px</code>...不对，设计稿是25px"</li>
<li>🎨 吸取颜色："<code>#3B82F6</code>...咦，和设计稿的<code>#3B82F5</code>差了一个色号"</li>
<li>📏 测量字号："<code>font-size: 16px</code>...行高多少来着？"</li>
</ul>
<p>两天后，终于完成。设计师看了一眼："嗯...能不能把这个间距再调小2px？"</p>
<p>我：💢</p>
<p><strong>如果我告诉你，这一切可以自动化呢？</strong></p>
<p>今天这篇文章，我将展示如何用 <strong>Cursor + MCP</strong> 技术，让AI直接读取Figma设计元数据，自动生成代码。开发效率提升10倍，代码质量更高，设计变更秒级同步。</p>
<p>这是《Cursor进阶实战》系列的第一篇，我会用最接地气的方式，带你从0到1掌握这个"黑科技"。</p>
<h2 data-id="heading-1">传统流程 vs AI驱动流程</h2>
<p>让我们先直观感受一下差异：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/347429796bab429ba4af6abc3159aada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=oN8EtwP17Nu4MM8Evan7dA8XeoY%3D" alt="cursor01-设计稿还原流程对比图.png" loading="lazy"/></p>
<p>看到区别了吗？传统流程就像用算盘算账，而Cursor+MCP就像用计算器——都能得到结果，但效率天差地别。</p>
<h3 data-id="heading-2">真实数据对比</h3>
<p>我用两种方法还原了同一个SaaS产品落地页，记录了详细数据：</p>









































<table><thead><tr><th align="left">维度</th><th align="right">传统方法</th><th align="right">Cursor+MCP</th><th align="right">提升倍数</th></tr></thead><tbody><tr><td align="left">Hero区块开发</td><td align="right">2小时</td><td align="right">10分钟</td><td align="right"><strong>12x</strong></td></tr><tr><td align="left">完整落地页</td><td align="right">1-2天</td><td align="right">2-3小时</td><td align="right"><strong>8x</strong></td></tr><tr><td align="left">设计变更适配</td><td align="right">1小时</td><td align="right">5分钟</td><td align="right"><strong>12x</strong></td></tr><tr><td align="left">响应式适配</td><td align="right">4小时</td><td align="right">30分钟</td><td align="right"><strong>8x</strong></td></tr><tr><td align="left">Bug修复次数</td><td align="right">15个</td><td align="right">2个</td><td align="right"><strong>7.5x</strong></td></tr></tbody></table>
<p><strong>最关键的是</strong>：生成的代码不是"能用就行"的水平，而是<strong>符合最佳实践、类型安全、可维护性强</strong>的生产级代码。</p>
<h2 data-id="heading-3">MCP是什么？为什么这么神奇？</h2>
<p>MCP（Model Context Protocol）是 Anthropic 推出的协议，让AI模型能够与外部工具交互。简单来说：</p>
<blockquote>
<p><strong>MCP = AI的"USB接口"</strong></p>
</blockquote>
<p>就像你的电脑通过USB可以连接鼠标、键盘、打印机一样，Cursor通过MCP可以连接Figma、GitHub、Slack等各种工具。</p>
<h3 data-id="heading-4">Figma MCP的工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e4e184be3094e4ea73de757428393d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=Eo4HmFhyd5GLV9fHATyTIAq1FQM%3D" alt="cursor01-MCP工作原理流程图.png" loading="lazy"/></p>
<p>让我用更接地气的方式解释：</p>
<p><strong>传统方法</strong>：</p>
<pre><code class="hljs">你：AI，帮我写个按钮组件
AI：好的，我给你写一个通用的按钮
结果：和设计稿完全不一样
</code></pre>
<p><strong>有了Figma MCP后</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">你：<span class="hljs-keyword">@figma</span> 帮我根据设计稿的Button组件生成代码
AI：(读取Figma) 发现按钮圆角是<span class="hljs-number">8px</span>，主色是<span class="hljs-number">#3B82F6</span>，
    字号<span class="hljs-number">16px</span>，padding是<span class="hljs-number">12px</span> <span class="hljs-number">24px</span>，<span class="hljs-attribute">hover</span>时有阴影...
    好的，我给你生成了完全一致的代码
结果：像素级还原
</code></pre>
<h3 data-id="heading-5">为什么比传统方法强？</h3>
<ol>
<li><strong>精确度</strong>：通过API直接获取数据，零误差</li>
<li><strong>效率</strong>：批量处理，自动化生成</li>
<li><strong>一致性</strong>：基于设计系统，自动复用</li>
<li><strong>可维护性</strong>：设计变更自动同步</li>
</ol>

**类比时间**：传统方法就像你拿着尺子照着画画，而MCP就像用照相机拍照再用AI还原——哪个更准？哪个更快？

<h2 data-id="heading-6">环境配置：手把手带你安装</h2>
<p>接下来是实操环节，跟着我的步骤走，10分钟配置完成。</p>
<h3 data-id="heading-7">第一步：检查环境</h3>
<p>打开终端，输入以下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Node.js版本（需要 &gt;= 18.0.0）</span>
node --version

<span class="hljs-comment"># 检查npm版本（需要 &gt;= 9.0.0）</span>
npm --version
</code></pre>
<p>如果版本不够，去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org" target="_blank" title="https://nodejs.org" ref="nofollow noopener noreferrer">nodejs.org</a> 下载最新的LTS版本。</p>
<h3 data-id="heading-8">第二步：获取Figma Token</h3>
<p>这是关键的一步，让Cursor获得读取你Figma文件的权限。</p>
<ol>
<li>
<p><strong>访问Figma开发者页面</strong></p>
<p>打开：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.figma.com%2Fdevelopers%2Fapps" target="_blank" title="https://www.figma.com/developers/apps" ref="nofollow noopener noreferrer">www.figma.com/developers/…</a></p>
</li>
<li>
<p><strong>生成Personal Access Token</strong></p>
<ul>
<li>点击右上角头像</li>
<li>选择 "Settings" -&gt; "Security"</li>
<li>找到 "Personal access tokens"</li>
<li>点击 "Generate new token"</li>
<li>起个名字，比如 "cursor-mcp"</li>
<li>勾选需要的权限，选择token过期时间，最长90天</li>
<li>复制生成的token（<strong>重要</strong>：只显示一次，记得保存）</li>
</ul>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801a113bc631447eaf1f7397bb09c73f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=%2BuhGOo942UDeUTy9ZuCY1ukthB8%3D" alt="cursor01-生成token页面.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b24ecbb6b5d4a0daf907926129cc04f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=MkU0NN7066wFNEyy6IqeuwNpBXY%3D" alt="cursor01-token生成配置权限和过期时间.png" loading="lazy"/></p>

安全提示：Token相当于你的密码，千万不要泄露！不要提交到GitHub！

<ol>
<li><strong>准备测试设计文件</strong></li>
</ol>
<p>如果你没有现成的Figma文件，可以使用我准备的示例文件：</p>
<pre><code class="hljs language-bash" lang="bash">https://www.figma.com/community/file/1234567890/cursor-mcp-demo
</code></pre>
<p>或者，使用你团队的任何Figma文件都可以。</p>
<h3 data-id="heading-9">第三步：配置Cursor MCP</h3>
<p>这是最关键的一步，将Figma接入Cursor。</p>
<ol>
<li>
<p><strong>打开Cursor设置</strong></p>
<ul>
<li>File-&gt;Preferences-&gt;Cursor Settings</li>
</ul>
</li>
<li>
<p><strong>进入MCP配置页面</strong></p>
<p>点击：<code>Tools &amp; MCP</code></p>
</li>
<li>
<p><strong>添加Figma MCP Server</strong></p>
<p>点击 "+ Add New MCP Server"，会弹出一个JSON编辑框。</p>
</li>
<li>
<p><strong>粘贴配置</strong></p>
</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Framelink Figma MCP"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"figma-developer-mcp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--figma-api-key=your_figma_token"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--stdio"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>注意替换</strong>：把 <code>"your_figma_token"</code> 替换成你在第二步获取的真实token。</p>
<h3 data-id="heading-10">第四步：验证安装</h3>
<p>在mcp页面设置中，开启figma mcp,如果亮起绿灯，有显示tools enabled,说明配置成功！🎉</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecd3dd73fb754421a7194f4abb32d621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=1Ff9xyLQgiCoXpkq0Vg5UCOQ5cQ%3D" alt="cursor01-mcp配置成功.png" loading="lazy"/></p>

**常见问题**：如果没有出现提示，检查：
1. Token是否正确复制
2. JSON格式是否有误（注意引号和逗号）
3. 是否重启了Cursor
4. 这里配置的为非figma官方的mcp,官方也有但是需要高级用户才能够使用

<h2 data-id="heading-11">实战案例：还原一个SaaS落地页</h2>
<p>理论讲完了，现在进入最激动人心的实战环节！</p>
<p>我准备了一个真实的SaaS产品落地页设计稿，我们一步步把它变成代码。</p>
<h3 data-id="heading-12">案例背景</h3>
<ul>
<li><strong>设计稿</strong>：现代化的SaaS产品落地页</li>
<li><strong>技术栈</strong>：React 18 + TypeScript + TailwindCSS</li>
<li><strong>包含内容</strong>：
<ul>
<li>Hero区块（大标题 + CTA按钮）</li>
<li>功能特性网格（3列展示）</li>
<li>价格表（3个套餐对比）</li>
<li>页脚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35bb7e079ccb4299ab59ace8b319b3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=J2Xi5el4RUZP5tCQookgOoZVW00%3D" alt="cursor01-完整示例页面截图.png" loading="lazy"/></p>
<h3 data-id="heading-13">步骤1：让AI分析设计结构</h3>
<p>在Cursor Chat中输入：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@figma</span> 分析这个Figma文件的结构，列出所有页面和主要组件

文件链接: <span class="hljs-attribute">https</span>:<span class="hljs-comment">//www.figma.com/file/xxxxx/saas-landing-page</span>
</code></pre>
<p>AI会返回类似这样的分析：</p>
<pre><code class="hljs language-markdown" lang="markdown">📄 文件结构分析

页面列表:
<span class="hljs-bullet">-</span> Landing Page (主页)

主要组件:
<span class="hljs-bullet">1.</span> Hero Section
<span class="hljs-bullet">   -</span> 标题 (h1, 56px, 粗体)
<span class="hljs-bullet">   -</span> 副标题 (p, 20px)
<span class="hljs-bullet">   -</span> CTA按钮 (primary)

<span class="hljs-bullet">2.</span> Features Grid
<span class="hljs-bullet">   -</span> 特性卡片 x3
<span class="hljs-bullet">   -</span> 图标 + 标题 + 描述

<span class="hljs-bullet">3.</span> Pricing Table
<span class="hljs-bullet">   -</span> 套餐卡片 x3
<span class="hljs-bullet">   -</span> Basic / Pro / Enterprise

<span class="hljs-bullet">4.</span> Footer
<span class="hljs-bullet">   -</span> Logo + 导航链接
<span class="hljs-bullet">   -</span> 版权信息

设计Token:
颜色:
<span class="hljs-bullet">  -</span> Primary: #3B82F6
<span class="hljs-bullet">  -</span> Secondary: #8B5CF6
<span class="hljs-bullet">  -</span> Gray: #6B7280

字体:
<span class="hljs-bullet">  -</span> 标题: Inter, 粗体
<span class="hljs-bullet">  -</span> 正文: Inter, 常规

间距:
<span class="hljs-bullet">  -</span> 容器: 64px
<span class="hljs-bullet">  -</span> 卡片: 24px
<span class="hljs-bullet">  -</span> 元素: 16px
</code></pre>
<p><strong>看到没？AI已经把设计稿"看懂"了！</strong></p>
<h3 data-id="heading-14">步骤2：提取Design System</h3>
<p>继续在Chat中输入：</p>
<pre><code class="hljs language-markdown" lang="markdown">@figma 从这个文件中提取完整的设计系统，生成TailwindCSS配置

包括：
<span class="hljs-bullet">1.</span> 颜色变量（主色、辅助色、灰度、语义色）
<span class="hljs-bullet">2.</span> 字体规范（字号、字重、行高）
<span class="hljs-bullet">3.</span> 间距系统（padding、margin、gap）
<span class="hljs-bullet">4.</span> 圆角规范
<span class="hljs-bullet">5.</span> 阴影效果
<span class="hljs-bullet">6.</span> 断点规则

输出格式：TypeScript配置文件
</code></pre>
<p>AI会生成一个完整的配置文件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Config</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'tailwindcss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">content</span>: [<span class="hljs-string">'./src/**/*.{js,jsx,ts,tsx}'</span>],
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">extend</span>: {
      <span class="hljs-attr">colors</span>: {
        <span class="hljs-comment">// 主色系</span>
        <span class="hljs-attr">primary</span>: {
          <span class="hljs-number">50</span>: <span class="hljs-string">'#EFF6FF'</span>,
          <span class="hljs-number">100</span>: <span class="hljs-string">'#DBEAFE'</span>,
          <span class="hljs-number">500</span>: <span class="hljs-string">'#3B82F6'</span>, <span class="hljs-comment">// 主色</span>
          <span class="hljs-number">600</span>: <span class="hljs-string">'#2563EB'</span>,
          <span class="hljs-number">700</span>: <span class="hljs-string">'#1D4ED8'</span>,
        },
        <span class="hljs-comment">// 辅助色</span>
        <span class="hljs-attr">secondary</span>: {
          <span class="hljs-number">500</span>: <span class="hljs-string">'#8B5CF6'</span>,
          <span class="hljs-number">600</span>: <span class="hljs-string">'#7C3AED'</span>,
        },
        <span class="hljs-comment">// 灰度</span>
        <span class="hljs-attr">gray</span>: {
          <span class="hljs-number">50</span>: <span class="hljs-string">'#F9FAFB'</span>,
          <span class="hljs-number">100</span>: <span class="hljs-string">'#F3F4F6'</span>,
          <span class="hljs-number">500</span>: <span class="hljs-string">'#6B7280'</span>,
          <span class="hljs-number">900</span>: <span class="hljs-string">'#111827'</span>,
        },
      },
      <span class="hljs-attr">fontSize</span>: {
        <span class="hljs-string">'hero'</span>: [<span class="hljs-string">'56px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.1'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'700'</span> }],
        <span class="hljs-string">'h1'</span>: [<span class="hljs-string">'48px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.2'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'700'</span> }],
        <span class="hljs-string">'h2'</span>: [<span class="hljs-string">'36px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.3'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'600'</span> }],
        <span class="hljs-string">'h3'</span>: [<span class="hljs-string">'24px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.4'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'600'</span> }],
        <span class="hljs-string">'body'</span>: [<span class="hljs-string">'16px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.5'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'400'</span> }],
        <span class="hljs-string">'small'</span>: [<span class="hljs-string">'14px'</span>, { <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">'1.5'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'400'</span> }],
      },
      <span class="hljs-attr">spacing</span>: {
        <span class="hljs-string">'container'</span>: <span class="hljs-string">'64px'</span>,
        <span class="hljs-string">'section'</span>: <span class="hljs-string">'48px'</span>,
        <span class="hljs-string">'card'</span>: <span class="hljs-string">'24px'</span>,
        <span class="hljs-string">'element'</span>: <span class="hljs-string">'16px'</span>,
      },
      <span class="hljs-attr">borderRadius</span>: {
        <span class="hljs-string">'card'</span>: <span class="hljs-string">'12px'</span>,
        <span class="hljs-string">'button'</span>: <span class="hljs-string">'8px'</span>,
      },
      <span class="hljs-attr">boxShadow</span>: {
        <span class="hljs-string">'card'</span>: <span class="hljs-string">'0 4px 6px -1px rgba(0, 0, 0, 0.1)'</span>,
        <span class="hljs-string">'card-hover'</span>: <span class="hljs-string">'0 10px 15px -3px rgba(0, 0, 0, 0.1)'</span>,
      },
    },
  },
  <span class="hljs-attr">plugins</span>: [],
} satisfies <span class="hljs-title class_">Config</span>
</code></pre>
<p><strong>惊喜点1</strong>：AI不是随便猜的，而是精确读取了Figma中定义的每一个值！</p>
<p><strong>惊喜点2</strong>：生成的配置符合TailwindCSS的最佳实践，包含了语义化的命名。</p>
<p>保存这个文件，我们的设计系统就建立好了！</p>
<h3 data-id="heading-15">步骤3：生成Hero区块</h3>
<p>现在来生成第一个组件——Hero区块。</p>
<pre><code class="hljs language-markdown" lang="markdown">@figma 基于Figma文件中的Hero区块，生成React组件

要求：
<span class="hljs-bullet">1.</span> 使用TypeScript
<span class="hljs-bullet">2.</span> 响应式设计（移动端优先）
<span class="hljs-bullet">3.</span> 使用刚才生成的TailwindCSS配置
<span class="hljs-bullet">4.</span> 添加简单的渐现动画
<span class="hljs-bullet">5.</span> CTA按钮有hover效果
</code></pre>
<p>AI会生成完整的组件代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Hero</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"relative overflow-hidden bg-gradient-to-br from-primary-50 to-secondary-50"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"container mx-auto px-4 py-container"</span>&gt;</span>
        {/* 内容居中 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"max-w-4xl mx-auto text-center"</span>&gt;</span>
          {/* 主标题 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-hero text-gray-900 mb-6 animate-fade-in"</span>&gt;</span>
            构建下一代
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-primary-500"</span>&gt;</span> SaaS <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            产品
          <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

          {/* 副标题 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xl text-gray-600 mb-8 max-w-2xl mx-auto animate-fade-in-delay-1"</span>&gt;</span>
            强大的功能，简洁的界面，帮助你的团队提升10倍效率
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

          {/* CTA按钮组 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col sm:flex-row gap-4 justify-center animate-fade-in-delay-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"px-8 py-4 bg-primary-500 text-white rounded-button font-semibold
                             hover:bg-primary-600 hover:shadow-card-hover
                             transition-all duration-200 transform hover:scale-105"</span>&gt;</span>
              免费试用
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"px-8 py-4 bg-white text-primary-500 rounded-button font-semibold
                             border-2 border-primary-500
                             hover:bg-primary-50 transition-all duration-200"</span>&gt;</span>
              观看演示
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        {/* 装饰性背景元素 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute top-0 right-0 w-96 h-96 bg-primary-200 rounded-full blur-3xl opacity-20"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute bottom-0 left-0 w-96 h-96 bg-secondary-200 rounded-full blur-3xl opacity-20"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span>
  )
}
</code></pre>
<p>同时，AI还贴心地生成了动画的CSS：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> fadeIn {
  <span class="hljs-selector-tag">from</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">20px</span>);
  }
  <span class="hljs-selector-tag">to</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
  }
}

<span class="hljs-selector-class">.animate-fade-in</span> {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.6s</span> ease-out;
}

<span class="hljs-selector-class">.animate-fade-in-delay-1</span> {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.6s</span> ease-out <span class="hljs-number">0.2s</span> both;
}

<span class="hljs-selector-class">.animate-fade-in-delay-2</span> {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.6s</span> ease-out <span class="hljs-number">0.4s</span> both;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed7dfc836511452386d1584a59e40128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617652&amp;x-signature=oXi9bNBXbDUkS6TuoUV8JRGHqlw%3D" alt="cursor01-saas页面hero截图.png" loading="lazy"/></p>
<p><strong>看到这里，你可能会想</strong>：这还原效果...也太好了吧？</p>
<ul>
<li>✅ TypeScript类型完整</li>
<li>✅ 响应式设计（<code>sm:flex-row</code>）</li>
<li>✅ 动画效果优雅</li>
<li>✅ Hover状态细节到位</li>
<li>✅ 语义化的class命名</li>
<li>✅ 可访问性考虑（对比度、文字大小）</li>
</ul>
<p>这就是AI + 设计系统的威力！</p>
<h3 data-id="heading-16">步骤4：批量生成其他组件</h3>
<p>有了第一个组件的经验，后面就是复制粘贴大法了。</p>
<p>使用Cursor的Composer模式（<code>Cmd/Ctrl + I</code>），一次性生成多个组件：</p>
<pre><code class="hljs language-markdown" lang="markdown">@figma 基于Figma设计，按顺序生成以下组件：

<span class="hljs-bullet">1.</span> Features - 功能特性网格
<span class="hljs-bullet">   -</span> 3列布局，响应式（移动端1列）
<span class="hljs-bullet">   -</span> 每个特性包含：图标、标题、描述
<span class="hljs-bullet">   -</span> 使用设计系统的spacing和colors

<span class="hljs-bullet">2.</span> Pricing - 价格表
<span class="hljs-bullet">   -</span> 3个套餐卡片：Basic、Pro、Enterprise
<span class="hljs-bullet">   -</span> 包含：价格、功能列表、CTA按钮
<span class="hljs-bullet">   -</span> Pro套餐高亮显示

<span class="hljs-bullet">3.</span> Footer - 页脚
<span class="hljs-bullet">   -</span> Logo + 导航链接（4列）
<span class="hljs-bullet">   -</span> 版权信息居中
<span class="hljs-bullet">   -</span> 响应式布局

要求：
<span class="hljs-bullet">-</span> 所有组件使用TypeScript
<span class="hljs-bullet">-</span> 遵循设计系统
<span class="hljs-bullet">-</span> 可复用的组件结构
<span class="hljs-bullet">-</span> 添加PropTypes用于类型检查
</code></pre>
<p>AI会依次生成三个组件，每个都完美还原设计稿。</p>
<p><strong>惊喜点3</strong>：AI会自动处理组件间的依赖关系，比如Pricing组件中的按钮会复用之前的Button组件。</p>
<h3 data-id="heading-17">步骤5：响应式适配</h3>
<p>最后一步，让所有组件在不同设备上完美展示。</p>
<pre><code class="hljs language-diff" lang="diff">@figma 检查设计文件中的响应式断点，为所有组件添加适配

断点：
<span class="hljs-deletion">- 移动端：&lt; 640px</span>
<span class="hljs-deletion">- 平板：640px - 1024px</span>
<span class="hljs-deletion">- 桌面：&gt; 1024px</span>

重点优化：
<span class="hljs-deletion">- 移动端导航折叠</span>
<span class="hljs-deletion">- Features网格从3列变1列</span>
<span class="hljs-deletion">- Pricing卡片垂直堆叠</span>
<span class="hljs-deletion">- 字号和间距适当缩小</span>
</code></pre>
<p>AI会自动调整所有组件的响应式class。</p>
<p><strong>惊喜点4</strong>：AI能识别Figma中的Auto Layout约束，智能转换为Flexbox或Grid布局！</p>
<h2 data-id="heading-18">进阶技巧：让AI更懂你的设计</h2>
<p>基础流程走通后，我再分享几个高级技巧，让Cursor成为你的"专属前端"。</p>
<h3 data-id="heading-19">技巧1：上传设计规范文档</h3>
<p>如果你的团队有完整的设计规范文档（Design System），可以上传到Cursor：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@docs</span> 这是我们团队的设计规范，请在生成代码时严格遵循

[上传 design-system.md 文件]
</code></pre>
<p>文档内容示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 设计系统规范</span>

<span class="hljs-section">## 命名规范</span>
<span class="hljs-bullet">-</span> 组件文件名：PascalCase (如: HeroSection.tsx)
<span class="hljs-bullet">-</span> CSS类名：kebab-case (如: hero-section)
<span class="hljs-bullet">-</span> 变量命名：camelCase (如: primaryColor)

<span class="hljs-section">## 组件结构</span>
<span class="hljs-bullet">-</span> 每个组件独立目录
<span class="hljs-bullet">-</span> 包含：index.tsx、styles.module.css、types.ts、README.md

<span class="hljs-section">## 代码规范</span>
<span class="hljs-bullet">-</span> 使用函数式组件
<span class="hljs-bullet">-</span> Props使用interface定义
<span class="hljs-bullet">-</span> 导出使用named export
<span class="hljs-bullet">-</span> 样式使用CSS Modules

<span class="hljs-section">## 可访问性要求</span>
<span class="hljs-bullet">-</span> 所有按钮必须有aria-label
<span class="hljs-bullet">-</span> 图片必须有alt属性
<span class="hljs-bullet">-</span> 对比度符合WCAG AA标准
</code></pre>
<p>上传后，AI生成的代码会自动遵循你的规范！</p>
<h3 data-id="heading-20">技巧2：识别设计中的重复组件</h3>
<p>设计稿中经常有多处使用相同样式的元素，AI能自动识别并复用：</p>
<pre><code class="hljs language-diff" lang="diff">@figma 分析设计文件，识别所有重复使用的组件模式

包括：
<span class="hljs-deletion">- 按钮样式（主按钮、次要按钮、文字按钮）</span>
<span class="hljs-deletion">- 卡片样式</span>
<span class="hljs-deletion">- 输入框样式</span>
<span class="hljs-deletion">- 图标规范</span>

生成一个可复用的组件库
</code></pre>
<p>AI会生成类似这样的组件库：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ButtonVariant</span> = <span class="hljs-string">'primary'</span> | <span class="hljs-string">'secondary'</span> | <span class="hljs-string">'text'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ButtonSize</span> = <span class="hljs-string">'sm'</span> | <span class="hljs-string">'md'</span> | <span class="hljs-string">'lg'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-title class_">ButtonHTMLAttributes</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt; {
  variant?: <span class="hljs-title class_">ButtonVariant</span>
  size?: <span class="hljs-title class_">ButtonSize</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">ButtonProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  variant = <span class="hljs-string">'primary'</span>,
  size = <span class="hljs-string">'md'</span>,
  children,
  className = <span class="hljs-string">''</span>,
  ...props
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> baseStyles = <span class="hljs-string">'font-semibold rounded-button transition-all duration-200'</span>

  <span class="hljs-keyword">const</span> variantStyles = {
    <span class="hljs-attr">primary</span>: <span class="hljs-string">'bg-primary-500 text-white hover:bg-primary-600 hover:shadow-card-hover'</span>,
    <span class="hljs-attr">secondary</span>: <span class="hljs-string">'bg-white text-primary-500 border-2 border-primary-500 hover:bg-primary-50'</span>,
    <span class="hljs-attr">text</span>: <span class="hljs-string">'text-primary-500 hover:bg-primary-50'</span>,
  }

  <span class="hljs-keyword">const</span> sizeStyles = {
    <span class="hljs-attr">sm</span>: <span class="hljs-string">'px-4 py-2 text-sm'</span>,
    <span class="hljs-attr">md</span>: <span class="hljs-string">'px-8 py-4 text-base'</span>,
    <span class="hljs-attr">lg</span>: <span class="hljs-string">'px-12 py-6 text-lg'</span>,
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">baseStyles</span>} ${<span class="hljs-attr">variantStyles</span>[<span class="hljs-attr">variant</span>]} ${<span class="hljs-attr">sizeStyles</span>[<span class="hljs-attr">size</span>]} ${<span class="hljs-attr">className</span>}`}
      {<span class="hljs-attr">...props</span>}
    &gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  )
}
</code></pre>
<p>这样一来，整个项目的按钮都统一了，修改也方便！</p>
<h3 data-id="heading-21">技巧3：设计Token自动同步</h3>
<p>设计师最烦的就是："改个颜色，你得手动改一遍代码"。</p>
<p>有了MCP，这个问题不存在了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目根目录执行</span>
cursor chat <span class="hljs-string">"同步Figma的最新设计Token到tailwind.config.ts"</span>
</code></pre>
<p>AI会对比当前配置和Figma最新数据，自动更新变化的部分。</p>
<p><strong>实际效果</strong>：</p>
<ul>
<li>设计师在Figma改了主色：<code>#3B82F6</code> → <code>#2563EB</code></li>
<li>运行同步命令</li>
<li>AI自动更新配置文件</li>
<li>整个网站颜色立即更新</li>
</ul>
<h3 data-id="heading-22">技巧4：处理复杂交互和动画</h3>
<p>Figma的Prototype功能可以定义交互流程，AI也能理解！</p>
<pre><code class="hljs language-markdown" lang="markdown">@figma 这个移动端菜单组件在Figma中有Prototype交互

交互流程：
<span class="hljs-bullet">1.</span> 点击汉堡图标
<span class="hljs-bullet">2.</span> 菜单从右侧滑入
<span class="hljs-bullet">3.</span> 遮罩层淡入
<span class="hljs-bullet">4.</span> 点击遮罩或关闭按钮，菜单滑出

请生成完整的React组件，包括：
<span class="hljs-bullet">1.</span> 状态管理（useState）
<span class="hljs-bullet">2.</span> 动画效果（Framer Motion）
<span class="hljs-bullet">3.</span> 用户交互逻辑
<span class="hljs-bullet">4.</span> 键盘支持（ESC关闭）
</code></pre>
<p>AI会生成带完整动画的移动菜单组件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { motion, <span class="hljs-title class_">AnimatePresence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'framer-motion'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">MobileMenu</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [isOpen, setIsOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// ESC键关闭菜单</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEsc</span> = (<span class="hljs-params">e: KeyboardEvent</span>) =&gt; {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Escape'</span>) <span class="hljs-title function_">setIsOpen</span>(<span class="hljs-literal">false</span>)
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, handleEsc)
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'keydown'</span>, handleEsc)
  }, [])

  <span class="hljs-comment">// 打开时禁止背景滚动</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (isOpen) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">'hidden'</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">'unset'</span>
    }
  }, [isOpen])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 汉堡图标 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(true)}
        className="p-2 md:hidden"
        aria-label="打开菜单"
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-6 h-6"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M4 6h16M4 12h16M4 18h16"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 菜单和遮罩 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">AnimatePresence</span>&gt;</span>
        {isOpen &amp;&amp; (
          <span class="hljs-tag">&lt;&gt;</span>
            {/* 遮罩层 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
              <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> }}
              <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span> }}
              <span class="hljs-attr">exit</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> }}
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(false)}
              className="fixed inset-0 bg-black/50 z-40"
            /&gt;

            {/* 菜单面板 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
              <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> '<span class="hljs-attr">100</span>%' }}
              <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span> }}
              <span class="hljs-attr">exit</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> '<span class="hljs-attr">100</span>%' }}
              <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">type:</span> '<span class="hljs-attr">tween</span>', <span class="hljs-attr">duration:</span> <span class="hljs-attr">0.3</span> }}
              <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed right-0 top-0 h-full w-80 bg-white z-50 shadow-2xl"</span>
            &gt;</span>
              {/* 关闭按钮 */}
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(false)}
                className="absolute top-4 right-4 p-2"
                aria-label="关闭菜单"
              &gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-6 h-6"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M6 18L18 6M6 6l12 12"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

              {/* 菜单内容 */}
              <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-8 pt-16"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"space-y-4"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg hover:text-primary-500"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg hover:text-primary-500"</span>&gt;</span>功能<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg hover:text-primary-500"</span>&gt;</span>价格<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg hover:text-primary-500"</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
          <span class="hljs-tag">&lt;/&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">AnimatePresence</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>**看到没？**连动画细节都考虑到了：</p>
<ul>
<li>✅ 背景滚动锁定</li>
<li>✅ ESC键关闭</li>
<li>✅ 无障碍标签</li>
<li>✅ 流畅的动画</li>
<li>✅ 点击遮罩关闭</li>
</ul>
<p>这代码质量，资深前端看了都说好！</p>
<h2 data-id="heading-23">常见问题和避坑指南</h2>
<p>实战中肯定会遇到一些问题，我把踩过的坑都列出来了。</p>
<h3 data-id="heading-24">问题1：Token权限不足</h3>
<p><strong>现象</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">Error:</span> <span class="hljs-number">403</span> Forbidden
Failed <span class="hljs-keyword">to</span> fetch Figma file
</code></pre>
<p><strong>原因</strong>：Token没有访问该文件的权限</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>确认你是该Figma文件的成员</li>
<li>重新生成Token，确保有读取权限</li>
<li>如果是团队文件，联系管理员授权</li>
</ol>
<h3 data-id="heading-25">问题2：Figma文件太大导致超时</h3>
<p><strong>现象</strong>：AI响应很慢，或者直接超时</p>
<p><strong>原因</strong>：设计文件包含上百个页面/组件</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 方案1：指定具体页面</span>
@figma 只分析<span class="hljs-string">"Landing Page"</span>这个页面

<span class="hljs-comment"># 方案2：分批处理</span>
@figma 先分析Hero和Features部分
<span class="hljs-comment"># 完成后再执行</span>
@figma 分析Pricing和Footer部分
</code></pre>
<h3 data-id="heading-26">问题3：设计不规范导致识别错误</h3>
<p><strong>现象</strong>：生成的布局乱了，间距不对</p>
<p><strong>原因</strong>：设计师没用Auto Layout，而是用了绝对定位</p>
<p><strong>解决方案</strong>：
和设计师沟通，请他们规范设计文件：</p>
<ul>
<li>✅ 统一使用Auto Layout</li>
<li>✅ 组件化重复元素</li>
<li>✅ 规范命名（清晰的图层名）</li>
<li>✅ 定义完整的Design Token</li>
<li>❌ 不要用绝对定位</li>
<li>❌ 避免过度嵌套（超过5层）</li>
</ul>

**给设计师的建议**：把Figma文件当作"代码"来组织，越规范，AI还原度越高！

<h3 data-id="heading-27">问题4：生成的代码不符合项目规范</h3>
<p><strong>现象</strong>：命名风格、目录结构和现有项目不一致</p>
<p><strong>解决方案</strong>：
在项目根目录创建 <code>.cursorrules</code> 文件：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目规范</span>

<span class="hljs-section">## 组件规范</span>
<span class="hljs-bullet">-</span> 组件文件名使用PascalCase
<span class="hljs-bullet">-</span> 放在 src/components 目录
<span class="hljs-bullet">-</span> 每个组件独立目录，包含index.tsx和styles.ts

<span class="hljs-section">## 样式规范</span>
<span class="hljs-bullet">-</span> 使用styled-components
<span class="hljs-bullet">-</span> 不使用TailwindCSS
<span class="hljs-bullet">-</span> 颜色使用CSS变量

<span class="hljs-section">## 测试规范</span>
<span class="hljs-bullet">-</span> 每个组件必须有测试文件
<span class="hljs-bullet">-</span> 使用React Testing Library
<span class="hljs-bullet">-</span> 覆盖率不低于80%

生成代码时严格遵循以上规范！
</code></pre>
<p>有了这个文件，AI会自动遵循你的规范。</p>
<h2 data-id="heading-28">效率对比和真实案例</h2>
<p>让我们用数据说话，看看真实的效率提升。</p>
<h3 data-id="heading-29">真实案例：电商首页重构</h3>
<p><strong>项目背景</strong>：</p>
<ul>
<li>某电商平台首页重构</li>
<li>设计师给了完整的Figma设计稿</li>
<li>包含：导航栏、Banner、商品分类、推荐商品、活动区域、页脚</li>
<li>共15个组件</li>
</ul>
<p><strong>对比数据</strong>：</p>















































<table><thead><tr><th align="left">阶段</th><th align="right">传统开发</th><th align="right">Cursor+MCP</th><th align="right">节省时间</th></tr></thead><tbody><tr><td align="left">设计解读</td><td align="right">2小时</td><td align="right">10分钟</td><td align="right">1.9小时</td></tr><tr><td align="left">搭建基础结构</td><td align="right">3小时</td><td align="right">30分钟</td><td align="right">2.5小时</td></tr><tr><td align="left">组件开发</td><td align="right">2天(16小时)</td><td align="right">4小时</td><td align="right">12小时</td></tr><tr><td align="left">响应式适配</td><td align="right">6小时</td><td align="right">1小时</td><td align="right">5小时</td></tr><tr><td align="left">对齐调整</td><td align="right">4小时</td><td align="right">30分钟</td><td align="right">3.5小时</td></tr><tr><td align="left"><strong>总计</strong></td><td align="right"><strong>31小时</strong></td><td align="right"><strong>6.5小时</strong></td><td align="right"><strong>24.5小时</strong></td></tr></tbody></table>
<p><strong>效率提升</strong>：<strong>4.8倍</strong>！</p>
<p><strong>代码质量对比</strong>：</p>



































<table><thead><tr><th align="left">维度</th><th align="center">传统开发</th><th align="center">Cursor+MCP</th></tr></thead><tbody><tr><td align="left">像素还原度</td><td align="center">85%</td><td align="center">98%</td></tr><tr><td align="left">TypeScript覆盖</td><td align="center">60%</td><td align="center">100%</td></tr><tr><td align="left">组件复用率</td><td align="center">40%</td><td align="center">80%</td></tr><tr><td align="left">可访问性评分</td><td align="center">72/100</td><td align="center">94/100</td></tr><tr><td align="left">Bug数量</td><td align="center">18个</td><td align="center">3个</td></tr></tbody></table>
<h2 data-id="heading-30">总结：设计到代码的范式转变</h2>
<p>写到这里，我们已经完整体验了 <strong>Cursor + MCP</strong> 的强大能力。</p>
<p>让我总结一下关键收获：</p>
<h3 data-id="heading-31">三大核心价值</h3>
<ol>
<li><strong>效率革命</strong>：开发时间从天降到小时</li>
<li><strong>质量提升</strong>：像素级还原 + 生产级代码</li>
<li><strong>流程优化</strong>：设计-开发无缝衔接</li>
</ol>
<h3 data-id="heading-32">适用场景</h3>
<p><strong>✅ 适合用Cursor+MCP的场景：</strong></p>
<ul>
<li>UI密集型项目（落地页、营销页面）</li>
<li>设计规范的中后台系统</li>
<li>需要快速交付的MVP</li>
<li>设计频繁变更的项目</li>
</ul>
<p><strong>❌ 不太适合的场景：</strong></p>
<ul>
<li>高度定制化的交互（如游戏、可视化编辑器）</li>
<li>设计稿不规范的项目</li>
<li>没有Figma文件的项目</li>
</ul>
<h3 data-id="heading-33">我踩过的坑，你不用踩</h3>
<ol>
<li><strong>不要完全依赖AI</strong>：生成的代码要review，特别是业务逻辑部分</li>
<li><strong>和设计师沟通</strong>：让他们规范化Figma文件，会事半功倍</li>
<li><strong>建立设计系统</strong>：一开始花时间建立Design System，后面会越来越快</li>
<li><strong>版本控制</strong>：记得commit，AI改错了可以回退</li>
</ol>

**重要提醒**：AI是助手，不是替代。你的代码审查能力、架构思维、业务理解依然不可或缺。

<h2 data-id="heading-34">下一步：继续探索</h2>
<p>这只是《Cursor进阶实战》系列的第一篇，我们仅仅触及了Cursor能力的冰山一角。</p>
<h3 data-id="heading-35">本系列后续内容预告</h3>
<p><strong>下一篇：【Cursor进阶实战·02】告别丑陋界面！用Cursor打造审美在线的现代化UI</strong></p>
<ul>
<li>不依赖设计师，如何自己做出高级感界面</li>
<li>Dribbble + AI = 无限设计灵感</li>
<li>20分钟打造Notion风格仪表盘</li>
</ul>
<p><strong>第三篇：【Cursor进阶实战·03】Cursor四大模式完全指南</strong></p>
<ul>
<li>Agent/Plan/Debug/Ask模式深度解析</li>
<li>什么场景用什么模式</li>
<li>模式选对，效率翻倍</li>
</ul>
<h3 data-id="heading-36">继续学习资源</h3>
<ul>
<li><strong>Cursor官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fdocs" target="_blank" title="https://cursor.com/docs" ref="nofollow noopener noreferrer">cursor.com/docs</a></li>
<li><strong>MCP协议文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io" target="_blank" title="https://modelcontextprotocol.io" ref="nofollow noopener noreferrer">modelcontextprotocol.io</a></li>
</ul>
<h3 data-id="heading-37">动手实践</h3>
<p><strong>今天就试试</strong>：</p>
<ol>
<li>找一个Figma设计文件（可以用我提供的示例）</li>
<li>按照本文步骤配置Cursor MCP</li>
<li>尝试让AI还原一个简单的组件</li>
<li>感受一下效率的提升</li>
</ol>
<p><strong>分享你的成果</strong>：</p>
<ul>
<li>在评论区留下你的实践经历</li>
<li>遇到问题可以在下方提问</li>
<li>分享你的效率提升数据</li>
</ul>
<hr/>
<p><em>感谢阅读！如果这篇文章对你有帮助，欢迎点赞、收藏、分享。我们下期见！👋</em></p>
<p><em>有问题欢迎在评论区讨论，我会尽量回复每一条评论。</em></p>
<h3 data-id="heading-38">🎉 感谢关注,让我们一起享受技术带来的精彩!</h3>
<h3 data-id="heading-39"><strong>我做了一个个人主页，能找到所有我提供给你的资源</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a></h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐫 Ollama 基础使用指南]]></title>    <link>https://juejin.cn/post/7589092567545020425</link>    <guid>https://juejin.cn/post/7589092567545020425</guid>    <pubDate>2025-12-29T14:19:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589092567545020425" data-draft-id="7589126920286486538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐫 Ollama 基础使用指南"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-29T14:19:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Csvn"/> <meta itemprop="url" content="https://juejin.cn/user/1398234521023352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐫 Ollama 基础使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234521023352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Csvn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:19:56.000Z" title="Mon Dec 29 2025 14:19:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🐫 Ollama 基础使用指南（Mac / Linux / Windows）</h2>
<blockquote>
<p>Ollama 是一个在本地运行大语言模型（LLM）的工具，支持 macOS、Linux 和 Windows。<br/>
它让普通用户也能在笔记本上轻松运行 Llama、Qwen、Gemma、Phi 等开源模型。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📦 1. 安装 Ollama</h3>
<h4 data-id="heading-2">macOS（推荐）</h4>
<pre><code class="hljs">brew install ollama
</code></pre>
<p>或访问官网下载：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">ollama.com</a></p>
<h4 data-id="heading-3">启动服务（macOS 自动后台运行）</h4>
<pre><code class="hljs language-bash" lang="bash">ollama serve  <span class="hljs-comment"># 通常不需要手动运行，安装后自动启动</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">▶️ 2. 基本命令</h3>





























<table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>ollama list</code></td><td>查看已安装的模型</td></tr><tr><td><code>ollama pull &lt;model&gt;</code></td><td>下载模型（如 <code>qwen3:8b</code>）</td></tr><tr><td><code>ollama run &lt;model&gt;</code></td><td>运行模型并进入交互模式</td></tr><tr><td><code>ollama rm &lt;model&gt;</code></td><td>删除模型</td></tr><tr><td><code>ollama show &lt;model&gt;</code></td><td>查看模型信息（如参数、模板）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">🌐 3. 常用模型示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 中文强模型（通义千问）</span>
ollama pull qwen3:8b

<span class="hljs-comment"># 轻量中文模型</span>
ollama pull qwen:4b

<span class="hljs-comment"># Meta 官方模型</span>
ollama pull llama3.2:1b      <span class="hljs-comment"># 超轻量</span>
ollama pull llama3.2:3b
ollama pull llama3.1:8b      <span class="hljs-comment"># 推荐平衡款</span>
ollama pull llama3.1:70b     <span class="hljs-comment"># 高性能（需大内存）</span>

<span class="hljs-comment"># Google 轻量模型</span>
ollama pull gemma2:2b
ollama pull gemma2:9b

<span class="hljs-comment"># 微软小模型</span>
ollama pull phi3:mini
ollama pull phi3:medium
</code></pre>
<blockquote>
<p>💡 所有模型列表：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">ollama.com/library</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-6">💬 4. 交互式对话</h3>
<pre><code class="hljs language-shell" lang="shell">ollama run qwen3:8b
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; 你好！</span>
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; 请用 Python 写一个快排。</span>
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; /bye   <span class="hljs-comment"># 退出</span></span>
</code></pre>
<p>支持多轮对话，上下文自动保留。</p>
<hr/>
<h3 data-id="heading-7">🤖 5. 非交互式调用（脚本/自动化）</h3>
<h4 data-id="heading-8">方式一：管道输入</h4>
<pre><code class="hljs language-arduino" lang="arduino">echo <span class="hljs-string">"1+1等于几？"</span> | ollama run qwen3:<span class="hljs-number">8b</span>
</code></pre>
<h4 data-id="heading-9">方式二：API 调用（本地 HTTP）</h4>
<p>Ollama 默认启动 <code>http://localhost:11434</code> API。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">curl http://localhost:<span class="hljs-number">11434</span>/api/generate -d <span class="hljs-comment">'{</span>
  <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3:8b"</span>,
  <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"解释量子计算"</span>,
  <span class="hljs-string">"stream"</span>: <span class="hljs-literal">false</span>
}<span class="hljs-comment">'</span>
</code></pre>
<p>返回 JSON 格式结果。</p>
<hr/>
<h3 data-id="heading-10">🧩 6. 创建自定义模型（Modelfile）</h3>
<p>你可以基于现有模型微调提示词、参数等。</p>
<h4 data-id="heading-11">示例：<code>Modelfile</code></h4>
<pre><code class="hljs language-python" lang="python">FROM qwen3:8b

<span class="hljs-comment"># 设置系统提示</span>
SYSTEM <span class="hljs-string">"""
你是一个专业、简洁、准确的 AI 助手，擅长技术解答。
回答时避免冗长，优先使用代码或列表。
"""</span>

<span class="hljs-comment"># 默认参数</span>
PARAMETER temperature <span class="hljs-number">0.5</span>
PARAMETER num_ctx <span class="hljs-number">4096</span>
</code></pre>
<h4 data-id="heading-12">构建并运行</h4>
<pre><code class="hljs language-perl" lang="perl">ollama create <span class="hljs-keyword">my</span>-qwen -f Modelfile
ollama run <span class="hljs-keyword">my</span>-qwen
</code></pre>
<hr/>
<h3 data-id="heading-13">🗑 7. 清理与管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除某个模型</span>
ollama <span class="hljs-built_in">rm</span> qwen:7b

<span class="hljs-comment"># 删除所有未使用的模型（谨慎）</span>
ollama prune

<span class="hljs-comment"># 查看模型存储位置（macOS）</span>
<span class="hljs-built_in">ls</span> ~/.ollama/models/
</code></pre>
<blockquote>
<p>模型默认存储在 <code>~/.ollama/models/</code>，占用较大空间（8B 模型约 5GB）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">⚙️ 8. 高级技巧</h3>
<h4 data-id="heading-15">✅ 在 M 系列 Mac 上加速</h4>
<p>Ollama 自动使用 Apple Metal GPU 加速，无需额外配置。</p>
<h4 data-id="heading-16">✅ 限制显存/内存使用</h4>
<p>通过 <code>num_ctx</code> 和量化版本控制资源：</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama pull qwen3:<span class="hljs-number">8b</span>-q4_K_M  # <span class="hljs-number">4</span>-bit 量化，更省内存
</code></pre>
<h4 data-id="heading-17">✅ 与 Dify / LM Studio 集成</h4>
<ul>
<li><strong>Dify</strong>：在模型设置中选择 “Ollama”，填入 <code>http://localhost:11434</code> 和模型名。</li>
<li><strong>LM Studio</strong>：可直接导入 Ollama 模型（部分兼容）。</li>
</ul>
<hr/>
<h3 data-id="heading-18">❓ 常见问题</h3>
<h4 data-id="heading-19">Q：<code>pull</code> 太慢怎么办？</h4>
<p>A：使用代理或国内镜像（如魔搭 ModelScope），但 Ollama 官方暂不支持直接换源。</p>
<h4 data-id="heading-20">Q：模型无法启动，报错 <code>out of memory</code>？</h4>
<p>A：尝试更小的模型（如 <code>qwen:4b</code> 或 <code>phi3:mini</code>），或使用 4-bit 量化版。</p>
<h4 data-id="heading-21">Q：如何查看模型支持的最大上下文？</h4>
<p>A：</p>
<pre><code class="hljs language-sql" lang="sql">ollama <span class="hljs-keyword">show</span> qwen3:<span class="hljs-number">8</span>b <span class="hljs-comment">--modelfile</span>
</code></pre>
<p>查找 <code>num_ctx</code> 参数。</p>
<hr/>
<h3 data-id="heading-22">🔗 参考链接</h3>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">ollama.com</a></li>
<li>GitHub：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">github.com/ollama/olla…</a></li>
<li>模型库：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">ollama.com/library</a></li>
<li>API 文档：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">github.com/ollama/olla…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「LangChain学习」ChatPromptTemplate学习笔记]]></title>    <link>https://juejin.cn/post/7589159665856299027</link>    <guid>https://juejin.cn/post/7589159665856299027</guid>    <pubDate>2025-12-29T15:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589159665856299027" data-draft-id="7589099845186945060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「LangChain学习」ChatPromptTemplate学习笔记"/> <meta itemprop="keywords" content="LangChain,机器学习"/> <meta itemprop="datePublished" content="2025-12-29T15:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="淡酒交魂"/> <meta itemprop="url" content="https://juejin.cn/user/2245627735450160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「LangChain学习」ChatPromptTemplate学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2245627735450160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    淡酒交魂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:43:15.000Z" title="Mon Dec 29 2025 15:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用说明</h2>
<p>ChatPromptTemplate是创建<code>聊天消息列表</code>的模版，比PromptTemplate更适合处理多角色、多轮次的对话场景</p>
<h2 data-id="heading-1">特点</h2>
<ul>
<li>支持<code>System/AI/Human</code>等不同角色的消息模板</li>
<li>历史对话的维护</li>
</ul>
<h2 data-id="heading-2">参数类型</h2>
<p>参数：</p>
<ul>
<li>role-角色</li>
<li>content-消息内容</li>
</ul>
<p>列表参数格式是tuple类型（role :str content :str 组合最常用）</p>
<p>元组的格式为：<code>(role: str | type, content: str | list[dict] | list[object])</code></p>
<p>其中<code>role</code>是：字符串（常用:"system"、"human"、"ai"）</p>
<h2 data-id="heading-3">实例化方法</h2>
<h4 data-id="heading-4">1.构造方法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])


<span class="hljs-comment"># &lt;class 'langchain_core.prompt_values.ChatPromptValue'&gt;</span>
<span class="hljs-built_in">print</span>(prompt.invoke({<span class="hljs-string">"name"</span>:<span class="hljs-string">"小智"</span>, <span class="hljs-string">"user_input"</span>:<span class="hljs-string">"介绍一下自然语言处理"</span>}))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(prompt.invoke({<span class="hljs-string">"name"</span>:<span class="hljs-string">"小智"</span>, <span class="hljs-string">"user_input"</span>:<span class="hljs-string">"介绍一下自然语言处理"</span>})))

//输出结果
messages=[SystemMessage(content=<span class="hljs-string">'你是一个AI开发工程师. 你的名字是 小智.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'你能开发哪些AI应用?'</span>, additional_kwargs={}, response_metadata={}), AIMessage(content=<span class="hljs-string">'我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'介绍一下自然语言处理'</span>, additional_kwargs={}, response_metadata={})]
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'langchain_core.prompt_values.ChatPromptValue'</span>&gt;
</code></pre>
<h4 data-id="heading-5">2.调用from_messages()</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

promptMessage = ChatPromptTemplate.from_messages([
     (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])
promptMsg = promptMessage.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"name"</span>: <span class="hljs-string">"小智"</span>, <span class="hljs-string">"user_input"</span>: <span class="hljs-string">"描述一下图像识别技术"</span>})
<span class="hljs-built_in">print</span>(promptMsg)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(promptMsg))

//输出
messages=[SystemMessage(content=<span class="hljs-string">'你是一个AI开发工程师. 你的名字是 小智.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'你能开发哪些AI应用?'</span>, additional_kwargs={}, response_metadata={}), AIMessage(content=<span class="hljs-string">'我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'描述一下图像识别技术'</span>, additional_kwargs={}, response_metadata={})]
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'langchain_core.prompt_values.ChatPromptValue'</span>&gt;
</code></pre>
<p>上面两种实例化方法经过invoke()方法调用均获得ChatPromptValue类型的实例，但又是传给AI的希望是个对话历史，希望以消息列表的方法传递给AI，所以创建好Template后，可以使用不同的方法获取不同的数据类型，（当然可以通过方法转换获取不同的数据类型），下面就讲一下四个常用的模板调用的方法</p>
<h2 data-id="heading-6">模板调用的四种方式</h2>
<ul>
<li>方式1：invoke() -&gt; <code>ChatPromptValue</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># &lt;class 'langchain_core.prompt_values.ChatPromptValue'&gt;</span>
<span class="hljs-built_in">print</span>(prompt.invoke({<span class="hljs-string">"name"</span>: <span class="hljs-string">"小智"</span>, <span class="hljs-string">"user_input"</span>: <span class="hljs-string">"介绍一下自然语言处理"</span>}))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(prompt.invoke({<span class="hljs-string">"name"</span>: <span class="hljs-string">"小智"</span>, <span class="hljs-string">"user_input"</span>: <span class="hljs-string">"介绍一下自然语言处理"</span>})))

//输出
messages=[SystemMessage(content=<span class="hljs-string">'你是一个AI开发工程师. 你的名字是 小智.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'你能开发哪些AI应用?'</span>, additional_kwargs={}, response_metadata={}), AIMessage(content=<span class="hljs-string">'我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'介绍一下自然语言处理'</span>, additional_kwargs={}, response_metadata={})]
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'langchain_core.prompt_values.ChatPromptValue'</span>&gt;
</code></pre>
<ul>
<li>方式2：format() -&gt; <code>str</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># &lt;class 'str'&gt;</span>
<span class="hljs-built_in">print</span>(prompt.<span class="hljs-built_in">format</span>(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试测试"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(prompt.<span class="hljs-built_in">format</span>(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试测试"</span>)))

//输出
System: 你是一个AI开发工程师. 你的名字是 小智.
Human: 你能开发哪些AI应用?
AI: 我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.
Human: 测试测试
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'str'</span>&gt;
</code></pre>
<ul>
<li>方式3:format_messages() -&gt; <code>List&lt;BaseMessage&gt;</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># &lt;class 'list'&gt;</span>
<span class="hljs-built_in">print</span>(prompt.format_messages(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试format_messages方法"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(prompt.format_messages(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试format_messages方法"</span>)))

//输出
[SystemMessage(content=<span class="hljs-string">'你是一个AI开发工程师. 你的名字是 小智.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'你能开发哪些AI应用?'</span>, additional_kwargs={}, response_metadata={}), AIMessage(content=<span class="hljs-string">'我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'测试format_messages方法'</span>, additional_kwargs={}, response_metadata={})]
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'list'</span>&gt;
</code></pre>
<ul>
<li>方式4：format_prompt() -&gt; <code>ChatPromptValue</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个AI开发工程师. 你的名字是 {name}."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"你能开发哪些AI应用?"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># &lt;class 'langchain_core.prompt_values.ChatPromptValue'&gt;</span>
<span class="hljs-built_in">print</span>(prompt.format_prompt(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试format_prompt方法"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(prompt.format_prompt(name=<span class="hljs-string">"小智"</span>, user_input=<span class="hljs-string">"测试format_prompt方法"</span>)))

//输出
messages=[SystemMessage(content=<span class="hljs-string">'你是一个AI开发工程师. 你的名字是 小智.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'你能开发哪些AI应用?'</span>, additional_kwargs={}, response_metadata={}), AIMessage(content=<span class="hljs-string">'我能开发很多AI应用, 比如聊天机器人, 图像识别, 自然语言处理等.'</span>, additional_kwargs={}, response_metadata={}), HumanMessage(content=<span class="hljs-string">'测试format_prompt方法'</span>, additional_kwargs={}, response_metadata={})]
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'langchain_core.prompt_values.ChatPromptValue'</span>&gt;
</code></pre>
<h3 data-id="heading-7">结论：给占位符赋值，针对于ChatPromptTemplate，推荐使用 format_messages() 方法，返回消息列表。</h3>
<h2 data-id="heading-8">丰富的实例化参数类型</h2>
<p>前面讲了ChatPromptTemplate的两种创建方式。我们看到不管使用构造方法，还是使用from_messages()，参数类型都是<code>列表类型</code>。其实列表中的元素可以是多种类型，前面我们只是主要测试了元组类型。</p>
<p>接下来举几个例子吧</p>
<ul>
<li>类型1：str类型（列表参数是str类型【不推荐】，因为默认角色都是human）</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#1.导入相关依赖</span>
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> SystemMessage,HumanMessage, AIMessage

<span class="hljs-comment"># 2.定义聊天提示词模版</span>
chat_template = ChatPromptTemplate.from_messages(
[
<span class="hljs-string">"Hello, {name}!"</span> <span class="hljs-comment"># 等价于 ("human", "Hello, {name}!")</span>
]
)

<span class="hljs-comment"># 3.1格式化聊天提示词模版中的变量(自己提供的)</span>
messages = chat_template.format_messages(name=<span class="hljs-string">"小谷AI"</span>)

<span class="hljs-comment"># 3.2 使用invoke执行</span>
messages=chat_template.invoke({<span class="hljs-string">"name"</span>:<span class="hljs-string">"小谷AI"</span>})
<span class="hljs-comment"># 4.打印格式化后的聊天提示词模版内容</span>
<span class="hljs-built_in">print</span>(messages)
</code></pre>
<ul>
<li>类型2：dict类型</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例: 字典形式的消息</span>
prompt = ChatPromptTemplate.from_messages([
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个{role}."</span>},
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: [<span class="hljs-string">"复杂内容"</span>, {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>}]},
])
<span class="hljs-built_in">print</span>(prompt.format_messages(role=<span class="hljs-string">"教师"</span>))
</code></pre>
<ul>
<li>类型3：BaseMessagePromptTemplate类型 -&gt; <code>List&lt;BaseMessage&gt;</code></li>
</ul>
<p>使用LangChain中常见的SystemMessagePromptTemplate、HumamMessagePromptTemplate、AIMessagePromptTemplate，分别创建系统消息、人工消息和AI消息，它们是ChatMessagePromptTemplate的特定角色子类。</p>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import SystemMessagePromptTemplate, HumanMessagePromptTemplate, \
    ChatMessagePromptTemplate  <span class="hljs-comment"># 1.导入先关包</span>

<span class="hljs-comment"># 用角色MessagePromptTemplate</span>
<span class="hljs-attr">system_template</span> = <span class="hljs-string">"你是一个{role}专家"</span>
<span class="hljs-attr">system_message_prompt</span> = SystemMessagePromptTemplate.from_template(system_template)
<span class="hljs-attr">human_template</span> = <span class="hljs-string">"给我解释{concept}，用浅显易懂的语言"</span>
<span class="hljs-attr">human_message_prompt</span> = HumanMessagePromptTemplate.from_template(human_template)

<span class="hljs-attr">chatMessage</span> = ChatPromptTemplate.from_messages([
    system_message_prompt,
    human_message_prompt
])
print(chatMessage.format_messages(<span class="hljs-attr">role</span>=<span class="hljs-string">"医生"</span>, concept=<span class="hljs-string">"口腔溃疡的生成"</span>))
print(type(chatMessage.format_messages(<span class="hljs-attr">role</span>=<span class="hljs-string">"医生"</span>, concept=<span class="hljs-string">"口腔溃疡的生成"</span>)))

//输出
<span class="hljs-section">[SystemMessage(content='你是一个医生专家', additional_kwargs={}, response_metadata={}), HumanMessage(content='给我解释口腔溃疡的生成，用浅显易懂的语言', additional_kwargs={}, response_metadata={})]</span>
&lt;class 'list'&gt;
</code></pre>
<ul>
<li>类型4：ChatMessagePromptTemplate类型 -&gt; <code>List&lt;BaseMessage&gt;</code></li>
</ul>
<p><code>ChatMessagePromptTemplate</code>，用于构建聊天消息的模板。它允许你创建可重用的消息模板，这些模板可以动态地插入变量值来生成最终的聊天消息</p>
<p>1.角色指定 ：可以为每条消息指定角色（如 "system"、"human"、"ai"） 等，角色灵活。</p>
<p>2.模板化 ：支持使用变量占位符，可以在运行时填充具体值</p>
<p>3.格式化 ：能够将模板与输入变量结合生成最终的聊天消息</p>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import ChatMessagePromptTemplate  <span class="hljs-comment"># 1.导入先关包</span>

<span class="hljs-comment"># 使用ChatMessagePromptTemplate</span>
<span class="hljs-attr">customChatMessageTemplate</span> = ChatMessagePromptTemplate.from_template(
    <span class="hljs-attr">role</span>=<span class="hljs-string">"医生"</span>,
    <span class="hljs-attr">template</span>=human_template
)
print(customChatMessageTemplate.format_messages(<span class="hljs-attr">concept</span>=<span class="hljs-string">"口腔溃疡的生成"</span>))
print(type(customChatMessageTemplate.format_messages(<span class="hljs-attr">concept</span>=<span class="hljs-string">"口腔溃疡的生成"</span>)))
// 输出
<span class="hljs-section">[ChatMessage(content='给我解释口腔溃疡的生成，用浅显易懂的语言', additional_kwargs={}, response_metadata={}, role='医生')]</span>
&lt;class 'list'&gt;
</code></pre>
<p><strong>提示:在编写ChatMessagePromptTemplate时发现总会把from_template()和format_message()方法混淆不清，所以在此进行强调两者具体用途：</strong></p>
<p><code>from_template():该方法主要用来创建MessageTemplate消息模板;</code></p>
<p><code>format_message():该方法主要用来填充消息模板中的变量值来生成对应的Message实例</code></p>
<h2 data-id="heading-9">插入消息列表：MessagesPlaceholder的使用</h2>
<p>当你不确定消息提示模板使用什么角色，或者希望在格式化过程中 插入消息列表 时，该怎么办？ 这就需要使用 MessagesPlaceholder，负责在特定位置添加消息列表。
<code>使用场景：多轮对话系统存储历史消息以及Agent的中间步骤处理此功能非常有用。</code></p>
<p>举例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1.导入相关包</span>
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder, SystemMessagePromptTemplate, HumanMessagePromptTemplate
<span class="hljs-keyword">from</span> langchain_core.messages.system <span class="hljs-keyword">import</span> SystemMessage

<span class="hljs-comment"># 2.定义消息模板</span>
prompt = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(<span class="hljs-string">"你是{role}"</span>),
    MessagesPlaceholder(variable_name=<span class="hljs-string">"intermediate_steps"</span>),
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{query}"</span>)
])

<span class="hljs-comment"># 3.定义消息对象</span>
intermediate_steps = [
    SystemMessage(name=<span class="hljs-string">"search"</span>, content=<span class="hljs-string">"杭州:晴，25℃"</span>)
]

<span class="hljs-comment"># 4.格式化聊天消息提示词模板</span>
promptMessage = prompt.format_messages(
    role=<span class="hljs-string">"天气预报员"</span>,
    intermediate_steps=intermediate_steps,
    query=<span class="hljs-string">"今天天气如何？"</span>
)

<span class="hljs-built_in">print</span>(promptMessage)
//输出
[SystemMessage(content=<span class="hljs-string">'你是天气预报员'</span>, additional_kwargs={}, response_metadata={}), SystemMessage(content=<span class="hljs-string">'杭州:晴，25℃'</span>, additional_kwargs={}, response_metadata={}, name=<span class="hljs-string">'search'</span>), HumanMessage(content=<span class="hljs-string">'今天天气如何？'</span>, additional_kwargs={}, response_metadata={})]
</code></pre>
<p><strong>个人感觉这个MessagePlaceHolder后续还可以用于一些需要AI借助其他工具，或者网络查询获取相关信息时的占位符，获取到专业信息后再进行填入传递给AI，用于更加专业性的信息处理场景</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 数据库优化极简教程：快速提升性能]]></title>    <link>https://juejin.cn/post/7589126814829641780</link>    <guid>https://juejin.cn/post/7589126814829641780</guid>    <pubDate>2025-12-29T14:18:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126814829641780" data-draft-id="7589126814829625396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" MySQL 数据库优化极简教程：快速提升性能"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-29T14:18:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月度空间"/> <meta itemprop="url" content="https://juejin.cn/user/1567280531253689"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             MySQL 数据库优化极简教程：快速提升性能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567280531253689/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月度空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:18:03.000Z" title="Mon Dec 29 2025 14:18:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基础优化（10 分钟上手）</h2>
<h3 data-id="heading-1">1. 配置文件（my.cnf/my.ini）核心调整</h3>
<pre><code class="hljs language-ini" lang="ini">max\<span class="hljs-attr">_connections</span> = <span class="hljs-number">1000</span>           连接数上限（默认<span class="hljs-number">151</span>）

innodb\_buffer\_pool\<span class="hljs-attr">_size</span> = <span class="hljs-number">2</span>G     InnoDB缓存（物理内存<span class="hljs-number">50</span>%-<span class="hljs-number">70</span>%）

slow\_query\<span class="hljs-attr">_log</span> = <span class="hljs-number">1</span>               开启慢查询日志

long\_query\<span class="hljs-attr">_time</span> = <span class="hljs-number">2</span>              记录&gt;<span class="hljs-number">2</span>秒的SQL

innodb\_flush\_log\_at\_trx\<span class="hljs-attr">_commit</span> = <span class="hljs-number">2</span>   读写分离场景提升性能
</code></pre>
<blockquote>
<p>修改后重启：</p>
<p><code>systemctl restart mysqld</code></p>
<p>（Linux）/ 服务面板重启（Windows）</p>
</blockquote>
<h3 data-id="heading-2">2. 表结构优化</h3>
<ul>
<li>
<p>数据类型：手机号用<code>CHAR(11)</code>、年龄用<code>TINYINT</code>、时间用<code>DATETIME</code></p>
</li>
<li>
<p>避免<code>TEXT/BLOB</code>存大文件，改用文件服务器存路径</p>
</li>
<li>
<p>必加主键（自增 INT 优先），查询频繁字段加索引，多条件查用联合索引（遵循最左前缀）</p>
</li>
</ul>
<h2 data-id="heading-3">二、SQL 优化（避坑即提速）</h2>
<h3 data-id="heading-4">1. 慢查询定位</h3>
<ul>
<li>
<p>查日志：<code>tail -f /var/log/mysql/slow.log</code>（Linux）</p>
</li>
<li>
<p>分析 SQL：<code>EXPLAIN + 你的SQL</code>（看<code>type</code>是否为 ALL，<code>key</code>是否为 NULL）</p>
</li>
</ul>
<h3 data-id="heading-5">2. 核心优化技巧</h3>

























<table><thead><tr><th>反例</th><th>正例</th></tr></thead><tbody><tr><td><code>SELECT * FROM user WHERE id=1</code></td><td><code>SELECT id,username FROM user WHERE id=1</code></td></tr><tr><td><code>WHERE DATE(create_time)='2024-01-01'</code></td><td><code>WHERE create_time BETWEEN '2024-01-01 00:00:00' AND '2024-01-01 23:59:59'</code></td></tr><tr><td><code>WHERE id IN (SELECT user_id FROM order)</code></td><td><code>SELECT u.* FROM user u JOIN order o ON u.id=o.user_id</code></td></tr><tr><td><code>LIMIT 10000, 20</code></td><td><code>WHERE id&gt;10000 LIMIT 20</code></td></tr></tbody></table>
<h3 data-id="heading-6">3. 索引避坑</h3>
<ul>
<li>
<p>不生效场景：<code>!=</code>、<code>IS NOT NULL</code>、字符串不加引号、联合索引不满足最左前缀</p>
</li>
<li>
<p>小表（不建索引，频繁更新字段慎建索引</p>
</li>
</ul>
<h2 data-id="heading-7">三、进阶优化（生产环境必备）</h2>
<h3 data-id="heading-8">1. 读写分离</h3>
<ul>
<li>
<p>主库写（INSERT/UPDATE/DELETE），从库读（SELECT）</p>
</li>
<li>
<p>核心步骤：主库开二进制日志→从库配置 server-id→主库建复制用户→从库执行同步命令→启动复制</p>
</li>
</ul>
<h3 data-id="heading-9">2. 分库分表</h3>
<ul>
<li>
<p>单表 &gt; 1000 万行用：</p>
<ul>
<li>
<p>水平分表：按时间（订单表）、ID 范围 / 哈希（用户表）</p>
</li>
<li>
<p>垂直分表：大表拆小（用户基本表 + 详情表）</p>
</li>
</ul>
</li>
<li>
<p>工具：Sharding-JDBC（轻量）、MyCat（中间件）</p>
</li>
</ul>
<h3 data-id="heading-10">3. 硬件 / 系统优化</h3>
<ul>
<li>
<p>用 SSD、数据与日志分盘存</p>
</li>
<li>
<p>Linux 关闭 Swap：<code>swapoff -a</code></p>
</li>
<li>
<p>调整文件描述符：<code>echo "* soft nofile 65535" &gt;&gt; /etc/security/limits.conf</code></p>
</li>
</ul>
<h2 data-id="heading-11">四、优化验证</h2>
<h3 data-id="heading-12">1. 关键指标（执行<code>SHOW GLOBAL STATUS;</code>）</h3>
<ul>
<li>
<p><code>Threads_connected</code>：连接数≤max_connections</p>
</li>
<li>
<p><code>Slow_queries</code>：慢查询数越少越好</p>
</li>
<li>
<p><code>Innodb_buffer_pool_read_hit_rate</code>：缓存命中率 &gt; 99%</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Elasticsearch 中的结构化输出创建可靠的 agents]]></title>    <link>https://juejin.cn/post/7589171972446322730</link>    <guid>https://juejin.cn/post/7589171972446322730</guid>    <pubDate>2025-12-30T00:36:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589171972446322730" data-draft-id="7589201772118425606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Elasticsearch 中的结构化输出创建可靠的 agents"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-30T00:36:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Elasticsearch 中的结构化输出创建可靠的 agents
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:36:58.000Z" title="Tue Dec 30 2025 00:36:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fjd-armada" title="https://www.elastic.co/search-labs/author/jd-armada" target="_blank" ref="nofollow noopener noreferrer">JD Armada</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ad72fb058943fea4e380bf48185713~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659818&amp;x-signature=jEbZmrZkm7v7rYQfedK6hehyVnU%3D" alt="" loading="lazy"/></p>
<p>探索什么是结构化输出 ，以及如何在 Elasticsearch 中利用它们，将 agents 基于最相关的上下文进行 grounding ，以支持数据契约 。</p>
<p>使用 Elasticsearch 亲自动手实践：深入了解我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud 试用</a>，或者现在就在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Fstart-local" title="https://github.com/elastic/start-local" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>我们正在快速从简单的 chatbots 过渡到可以在你的系统上执行真实且有影响操作的 agents。为了确保这些 agents 可靠，我们不能再只依赖自由形式的文本了。生成可预测、机器可读输出的能力，已经成为构建可靠 AI agents 的一个重要层。Structured outputs 也是 context engineering 中的关键一层，context engineering 是一组策略，用来确保 LLMs 基于与任务最相关的信息。结合在一起，这些模式可以把 LLMs 从简单的对话工具，转变为你可以安全集成到更大系统中的可靠组件。在这篇文章中，我们将介绍什么是 structured outputs，以及如何利用它们来提供符合关键 contracts 的可靠输出。如果你刚接触 context engineering，可以查看我们这里的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F151232162" title="https://elasticstack.blog.csdn.net/article/details/151232162" target="_blank" ref="nofollow noopener noreferrer">文章</a>。</p>
<h2 data-id="heading-0">Structured outputs</h2>
<p>Structured outputs 是符合预定义 schema 或数据结构的 LLM 响应，而不是自由形式的文本。开发者不再接收不可预测的响应，而是可以明确指定响应应该如何格式化。</p>
<p>在下面的示例中，如果你让一个 LLM 访问你在 Elasticsearch 中的 indices，并要求它 “分析这个 Elasticsearch index”，它很可能会返回一段叙述性的解释，而且每次你用相同的 prompt 询问，结果都会变化。使用 structured outputs，你可以请求一个包含特定字段的响应，比如 indexName、documentCount、healthStatus 等，每个字段都有定义好的类型和校验规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3c0aa8b2b404de98f10afaad011257e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659818&amp;x-signature=3ITdd9gq6MxFVKtbdPJAvWKlkBI%3D" alt="" loading="lazy"/></p>
<p>右侧的结构化格式可以立即 针对 一个 schema 进行 验证， 而 不需要额外添加解析文本的步骤。</p>
<p>主要的模型提供商正在迅速注意到结构化输出变得多么重要，<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fdevelopers%2Fgemini-api-structured-outputs%2F" title="https://blog.google/technology/developers/gemini-api-structured-outputs/" target="_blank" ref="nofollow noopener noreferrer">Google</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-structured-outputs-in-the-api%2F" title="https://openai.com/index/introducing-structured-outputs-in-the-api/" target="_blank" ref="nofollow noopener noreferrer">OpenAI</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fbuild-with-claude%2Fstructured-outputs" title="https://platform.claude.com/docs/en/build-with-claude/structured-outputs" target="_blank" ref="nofollow noopener noreferrer">Anthropic</a> 都已经在各自的 API 中发布了对结构化输出的支持。OpenAI 更进一步，发布了经过专门训练的新模型，能够更好地理解并遵循复杂的 schema。下面是 OpenAI 对其模型在遵循复杂 JSON schema 方面表现的评估。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/014d1a4e1f714ff988e49adeacef5008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659818&amp;x-signature=hgcKeZx%2BiT9ziwiF44tAJAYm4tQ%3D" alt="" loading="lazy"/> <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-structured-outputs-in-the-api%2F" title="https://openai.com/index/introducing-structured-outputs-in-the-api/" target="_blank" ref="nofollow noopener noreferrer">openai.com/index/intro…</a></p>
<h2 data-id="heading-1">这如何影响多智能体系统</h2>
<p>想象一个场景：一组智能体在彼此之间传递非结构化的自由文本数据。每个智能体都需要自定义解析逻辑来理解其他智能体的响应，这不仅会增加 token 使用量，而且在实际中几乎肯定会出问题。再加上 LLM 的输出是概率性的，因此不可预测。我们如何能信任这种系统去对我们的系统执行真实、有影响的操作？结构化输出在智能体之间定义了一个契约，用可靠、可预测的行为取代了歧义。</p>
<h2 data-id="heading-2">AI 智能体与 MCP 中标准化的重要性</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openapis.org%2F" title="https://www.openapis.org/" target="_blank" ref="nofollow noopener noreferrer">OpenAPI</a> 通过为开发者提供一种共享且可预测的方式来描述端点、参数和响应，彻底改变了 REST API 开发。结构化输出把同样的理念带到了 AI 智能体领域，通过提供契约来标准化智能体与系统之间的数据交换方式。</p>
<p>这些契约确保了：</p>
<ul>
<li><strong>下游系统可以可靠地解析响应</strong>：当一个智能体需要执行诸如更新数据库、调用 API 或触发工作流之类的操作时，接收系统必须能够信任数据的结构和完整性。</li>
<li><strong>类型安全得以保持</strong>：结构化输出支持编译期或运行时校验，在错误扩散到整个系统并演变成更大问题之前就将其捕获。</li>
<li><strong>集成是可预测的</strong>：有了明确的 schema，把智能体集成到现有基础设施中可以遵循开发者在传统 API 开发中已经熟悉的模式。</li>
<li><strong>多智能体系统可以彼此理解</strong>：当多个智能体需要协作时，结构化输出提供了一种通用语言来交换信息。</li>
</ul>
<p>模型上下文协议（ <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fdocs%2Fgetting-started%2Fintro" title="https://modelcontextprotocol.io/docs/getting-started/intro" target="_blank" ref="nofollow noopener noreferrer">MCP</a> ）在此基础上进一步标准化了智能体在模型、工具和应用之间交换上下文的方式。当智能体通过 MCP 通信时，结构化输出确保被共享的上下文在不同系统之间保持其结构。</p>
<p>MCP 负责上下文的传输和生命周期，而结构化输出定义了上下文中数据的形状和约束。</p>
<p>它们结合在一起，使得：</p>
<ul>
<li>可组合的智能体可以被复用或替换</li>
<li>模型、工具和应用之间有清晰的契约</li>
<li>更可靠的自动化，尤其是在需要智能体触发现实世界操作时</li>
<li>可扩展的多智能体架构</li>
</ul>
<p>其他新兴协议，例如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fa2aproject%2FA2A" title="https://github.com/a2aproject/A2A" target="_blank" ref="nofollow noopener noreferrer">agent-to-agent</a> ( A2A ) 协议，也同样强调 schema 和契约，以实现智能体之间直接、可靠的通信。</p>
<p>MCP 以及像 A2A 这样的协议，加上结构化输出，给 AI 系统带来了当年 OpenAPI 之于微服务的价值 —— 一个共享的契约，把临时拼凑的集成转变为可靠的系统。</p>
<h2 data-id="heading-3">创建 schema 的技术</h2>
<p>现在，我们如何真正实现 结构化输出 呢？幸运的是，像 Python 和 JavaScript 这样的主流生态系统已经有了成熟的 schema 和校验库，可以让实现 结构化输出 变得更简单。你今天就可以使用这些工具来控制 LLM 返回的数据结构，在运行时进行校验，或者在模型产生幻觉时直接拒绝结果。在这一节中，我们会看看开发者最常用的一些工具，以及它们在底层是如何工作的。</p>
<h3 data-id="heading-4">Zod 和 JavaScript 生态</h3>
<p>在 JavaScript 和 TypeScript 领域，<a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" title="https://zod.dev/" target="_blank" ref="nofollow noopener noreferrer">Zod</a> 已经成为 schema 定义和校验的首选库，因为它高效、易用，并且能很好地集成到像 Vercel 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev%2F" title="https://ai-sdk.dev/" target="_blank" ref="nofollow noopener noreferrer">AI SDK</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" title="https://mastra.ai/" target="_blank" ref="nofollow noopener noreferrer">Mastra</a> 这样的 AI 编排框架中。为了直观展示这一点，我们来看我同事 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F151232162" title="https://elasticstack.blog.csdn.net/article/details/151232162" target="_blank" ref="nofollow noopener noreferrer">Carly 的示例</a>。Carly 使用 Zod 搭配 AI SDK 创建了一个 schema，强制 LLM 以经过校验、类型安全的格式返回行程数据。</p>
<p>下面的 schema 做了 3 件事：</p>
<ol>
<li>确保 LLM 返回的是合法的 JSON。</li>
<li>确保数据具有正确的类型、约束和嵌套结构。</li>
<li>生成可以直接用于应用的数据，不需要额外处理。</li>
</ol>

<pre><code class="hljs language-css" lang="css">`

<span class="hljs-number">1</span>.  import { generateObject } <span class="hljs-selector-tag">from</span> 'ai';
<span class="hljs-number">2</span>.  import { z } <span class="hljs-selector-tag">from</span> 'zod';
<span class="hljs-number">3</span>.  const { <span class="hljs-selector-tag">object</span> } = await generateObject({
<span class="hljs-number">4</span>.   model: <span class="hljs-string">'openai/gpt-4.1'</span>,
<span class="hljs-number">5</span>.   schemaName: <span class="hljs-string">'Travel Itinerary'</span>,
<span class="hljs-number">6</span>.   schemaDescription: <span class="hljs-string">'Sample travel itinerary for a trip'</span>,
<span class="hljs-number">7</span>.   schema: z.<span class="hljs-built_in">object</span>({
<span class="hljs-number">8</span>.     title: z.<span class="hljs-built_in">string</span>(),
<span class="hljs-number">9</span>.     location: z.<span class="hljs-built_in">string</span>(),
<span class="hljs-number">10</span>.     hotel: z.<span class="hljs-built_in">object</span>({name: z.<span class="hljs-built_in">string</span>(), roomType: z.<span class="hljs-built_in">string</span>(), amount: z.<span class="hljs-built_in">number</span>(), checkin: z.iso.<span class="hljs-built_in">date</span>(), checkout: z.iso.<span class="hljs-built_in">date</span>()}),
<span class="hljs-number">11</span>.     flights: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">object</span>({carrier: z.<span class="hljs-built_in">string</span>(), flightNo: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">max</span>(<span class="hljs-number">8</span>), origin: z.<span class="hljs-built_in">string</span>(), destination: z.<span class="hljs-built_in">string</span>(), date: z.iso.<span class="hljs-built_in">datetime</span>()})),
<span class="hljs-number">12</span>.     excursions: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">object</span>({ name: z.<span class="hljs-built_in">string</span>(), amount: z.<span class="hljs-built_in">number</span>(), date: z.iso.<span class="hljs-built_in">datetime</span>()}))
<span class="hljs-number">13</span>.   }),
<span class="hljs-number">14</span>.   prompt: <span class="hljs-string">'Generate a travel itinerary based on the specified location'</span>,
<span class="hljs-number">15</span>.  });

`AI写代码!<span class="hljs-selector-attr">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>让我们更仔细地看看这个 schema 中的重要部分。</p>
<p><strong>行程信息</strong></p>
<pre><code class="hljs language-css" lang="css">`

<span class="hljs-number">1</span>.  schema: z.<span class="hljs-built_in">object</span>({
<span class="hljs-number">2</span>.    title: z.<span class="hljs-built_in">string</span>(),
<span class="hljs-number">3</span>.    location: z.<span class="hljs-built_in">string</span>(),

`AI写代码
</code></pre>
<p>上面的这些字段是简单的字符串，但我们可以得出的结论是，LLM 不能随意编造结构。字段 title 和 location 必须包含，而且它们必须是字符串，否则响应会被拒绝。</p>
<p><strong>酒店详情</strong></p>
<pre><code class="hljs language-css" lang="css">`

<span class="hljs-number">1</span>.  hotel: z.<span class="hljs-built_in">object</span>({ 
<span class="hljs-number">2</span>.    name: z.<span class="hljs-built_in">string</span>(), 
<span class="hljs-number">3</span>.    roomType: z.<span class="hljs-built_in">string</span>(), 
<span class="hljs-number">4</span>.    amount: z.<span class="hljs-built_in">number</span>(), 
<span class="hljs-number">5</span>.    checkin: z.iso,<span class="hljs-built_in">date</span>(), 
<span class="hljs-number">6</span>.    checkout: z.iso.<span class="hljs-built_in">date</span>() 
<span class="hljs-number">7</span>.  }),

`AI写代码
</code></pre>
<p>请注意，amount 被定义为 number 类型，dates 使用 ISO 格式，这意味着输出可以直接用于计算、排序或存储，无需额外解析。</p>
<p><strong>Flight information</strong></p>
<pre><code class="hljs language-less" lang="less">`

<span class="hljs-number">1</span>.  <span class="hljs-selector-tag">flights</span>: <span class="hljs-selector-tag">z</span><span class="hljs-selector-class">.array</span>(z.<span class="hljs-built_in">object</span>({ 
<span class="hljs-number">2</span>.    <span class="hljs-attribute">carrier</span>: z.<span class="hljs-built_in">string</span>(), 
<span class="hljs-number">3</span>.    <span class="hljs-attribute">flightNo</span>: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">max</span>(<span class="hljs-number">8</span>), 
<span class="hljs-number">4</span>.    <span class="hljs-attribute">origin</span>: z.<span class="hljs-built_in">string</span>(), 
<span class="hljs-number">5</span>.    <span class="hljs-attribute">destination</span>: z.<span class="hljs-built_in">string</span>(), 
<span class="hljs-number">6</span>.    <span class="hljs-attribute">date</span>: z.iso.<span class="hljs-built_in">datetime</span>() })),

`<span class="hljs-selector-tag">AI</span>写代码
</code></pre>
<p>Flights 是一个对象数组，因为行程通常包含多个航段。我们将 flightNo 限制为 8 个字符，并使用 datetime() 而不是 date() 来包含起飞时间。</p>
<p>当我们运行时，模型应该生成一个看起来像这样的 JSON 对象：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  { 
2.    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Desert Adventure"</span>, 
3.    <span class="hljs-string">"location"</span>: <span class="hljs-string">"Palm Springs, California"</span>, 
4.    <span class="hljs-string">"hotel"</span>: { 
5.      <span class="hljs-string">"name"</span>: <span class="hljs-string">"The Madison"</span>, 
6.      <span class="hljs-string">"roomType"</span>: <span class="hljs-string">"Suite"</span>, 
7.      <span class="hljs-string">"amount"</span>: 250, 
8.      <span class="hljs-string">"checkin"</span>: <span class="hljs-string">"2025-12-15"</span>, 
9.      <span class="hljs-string">"checkout"</span>: <span class="hljs-string">"2025-12-20"</span> 
10.   }, 
11.    <span class="hljs-string">"flights"</span>: [ 
12.      { 
13.        <span class="hljs-string">"carrier"</span>: <span class="hljs-string">"SouthWest Airlines"</span>, 
14.        <span class="hljs-string">"flightNo"</span>: <span class="hljs-string">"AF123"</span>, 
15.        <span class="hljs-string">"origin"</span>: <span class="hljs-string">"SFO"</span>, 
16.        <span class="hljs-string">"destination"</span>: <span class="hljs-string">"PSP"</span>, 
17.        <span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-15T18:00:00Z"</span> 
18.      } 
19.   ], 
20.    <span class="hljs-string">"excursions"</span>: [ 
21.      { 
22.        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ATV Desert Tour"</span>, 
23.        <span class="hljs-string">"amount"</span>: 50, 
24.        <span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-16T10:00:00Z"</span> 
25.      } 
26.   ] 
27.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>如果模型输出无效的 JSON、违反指定约束，或未包含必需字段，请求会立即失败，而不是默默地推送错误数据。</p>
<h3 data-id="heading-5">Pydantic 和 Python 生态系统</h3>
<p>对于 Python 开发者，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.pydantic.dev%2Flatest%2F" title="https://docs.pydantic.dev/latest/" target="_blank" ref="nofollow noopener noreferrer">Pydantic</a> 在作用上类似于 JavaScript/TypeScript 中的 Zod，为你提供运行时验证和强类型结构化输出。</p>
<p>我们使用同样的旅行行程示例，不过这次使用 Pydantic 模型和 LangChain 对结构化输出的支持。</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  from datetime import date, datetime
2.  from decimal import Decimal
3.  from typing import List

5.  from pydantic import BaseModel, Field, ConfigDict, condecimal, constr
6.  from langchain_openai import ChatOpenAI

9.  class Hotel(BaseModel):
<span class="hljs-attr">10.      model_config</span> = ConfigDict(populate_by_name=<span class="hljs-literal">True</span>)

12.      name: str
13.      room_type: <span class="hljs-attr">str</span> = Field(..., alias=<span class="hljs-string">"roomType"</span>)
14.      amount: condecimal(<span class="hljs-attr">max_digits</span>=<span class="hljs-number">10</span>, decimal_places=<span class="hljs-number">2</span>, ge=<span class="hljs-number">0</span>) 
15.      checkin: date
16.      checkout: date

19.  class Flight(BaseModel):
<span class="hljs-attr">20.      model_config</span> = ConfigDict(populate_by_name=<span class="hljs-literal">True</span>)

22.      carrier: str
23.      flight_no: constr(<span class="hljs-attr">max_length</span>=<span class="hljs-number">8</span>) = Field(..., alias=<span class="hljs-string">"flightNo"</span>)
24.      origin: str
25.      destination: str
26.      date: datetime

29.  class Excursion(BaseModel):
<span class="hljs-attr">30.      model_config</span> = ConfigDict(populate_by_name=<span class="hljs-literal">True</span>)

32.      name: str
33.      amount: condecimal(<span class="hljs-attr">max_digits</span>=<span class="hljs-number">10</span>, decimal_places=<span class="hljs-number">2</span>, ge=<span class="hljs-number">0</span>)
34.      date: datetime

37.  class TravelItinerary(BaseModel):
<span class="hljs-attr">38.      model_config</span> = ConfigDict(populate_by_name=<span class="hljs-literal">True</span>)

40.      title: str
41.      location: str
42.      hotel: Hotel
43.      flights: List<span class="hljs-section">[Flight]</span>
44.      excursions: List<span class="hljs-section">[Excursion]</span>

<span class="hljs-attr">47.  llm</span> = ChatOpenAI(model=<span class="hljs-string">"gpt-4.1"</span>, temperature=<span class="hljs-number">0</span>)
<span class="hljs-attr">48.  structured_llm</span> = llm.with_structured_output(TravelItinerary)

50.  itinerary: <span class="hljs-attr">TravelItinerary</span> = structured_llm.invoke(
51.      "Generate a travel itinerary based on the specified location."
52.  )

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)
</code></pre>
<p>这种方法和 Zod 示例非常相似，你只需定义一次 schema，然后依赖框架在运行时为你处理验证。主要区别在于 Pydantic 会返回实际的 Python 对象，而不是纯粹的已验证 JSON。你得到的是一个带有嵌套模型和正确类型字段的 TravelItinerary 实例，更适合 Python 基于的 agent 流水线。</p>
<p>当我们运行时，模型生成的结构化数据会映射到 Pydantic 模型上，我们应该得到类似这样的对象：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  {
2.    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Palm Springs Getaway"</span>,
3.    <span class="hljs-string">"location"</span>: <span class="hljs-string">"Palm Springs, California"</span>,
4.    <span class="hljs-string">"hotel"</span>: {
5.      <span class="hljs-string">"name"</span>: <span class="hljs-string">"The Madison"</span>,
6.      <span class="hljs-string">"roomType"</span>: <span class="hljs-string">"Suite"</span>,
7.      <span class="hljs-string">"amount"</span>: 250.00,
8.      <span class="hljs-string">"checkin"</span>: <span class="hljs-string">"2025-12-15"</span>,
9.      <span class="hljs-string">"checkout"</span>: <span class="hljs-string">"2025-12-20"</span>
10.    },
11.    <span class="hljs-string">"flights"</span>: [
12.      {
13.        <span class="hljs-string">"carrier"</span>: <span class="hljs-string">"SouthWest Airlines"</span>,
14.        <span class="hljs-string">"flightNo"</span>: <span class="hljs-string">"SW123"</span>,
15.        <span class="hljs-string">"origin"</span>: <span class="hljs-string">"SFO"</span>,
16.        <span class="hljs-string">"destination"</span>: <span class="hljs-string">"PSP"</span>,
17.        <span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-15T18:00:00Z"</span>
18.      }
19.    ],
20.    <span class="hljs-string">"excursions"</span>: [
21.      {
22.        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ATV Desert Tour"</span>,
23.        <span class="hljs-string">"amount"</span>: 50.00,
24.        <span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-16T10:00:00Z"</span>
25.      }
26.    ]
27.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>这个 JSON 应该与我们使用 ZOD 生成的完全相同。在底层，这个 JSON 会被自动转换为带有嵌套 Hotel、Flight 和 Excursion 实例的 TravelItinerary 对象。同样，如果模型输出无效数据、违反约束或未包含必需字段，验证会立即失败。</p>
<h3 data-id="heading-6">底层原理：JSON schema</h3>
<p>在 API 层面，所有这些方法本质上都转换为 JSON schema。像 Zod 和 Pydantic 这样的库让定义这些 schema 更直观、对开发者友好。</p>
<p>直接使用原生 JSON schema 在需要跨团队或服务共享语言无关的合同时仍然有用，但代价是你会失去原生类型、可组合性，以及这些库提供的大部分开发体验。</p>
<h2 data-id="heading-7">将 Elasticsearch 与结构化输出结合</h2>
<p>控制 LLM 输出只是战斗的一半。接下来，我们需要知道如何让这些输出在实际系统中有用。Elasticsearch 在这里非常合适，因为它设计上同样适用于结构化和非结构化数据。这反映了现代 agent 架构：非结构化数据提供丰富的上下文以支持推理和检索，结构化输出作为应用可以依赖的契约。Elasticsearch 在这个循环中起核心作用。</p>
<p>下面是 Elasticsearch 如何适配此方法的示例：</p>
<ol>
<li>
<p><strong>非结构化输入</strong><br/>
用户查询、文档、聊天记录、日志或工具追踪等被摄取到 Elasticsearch 索引中。为了捕获精确文本匹配和语义含义，我们在索引这些数据时将使用文本字段和向量嵌入的混合。</p>
</li>
<li>
<p><strong>Elasticsearch 作为上下文引擎</strong><br/>
当 AI agent 需要相关上下文时，它可以使用以下不同类型的搜索查询 Elasticsearch：</p>
<ol>
<li><strong>语义/<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145485873" title="https://elasticstack.blog.csdn.net/article/details/145485873" target="_blank" ref="nofollow noopener noreferrer">向量搜索</a></strong>：按词的潜在含义搜索。</li>
<li><strong>关键字/文本搜索</strong>：用于精确匹配和过滤。</li>
<li><strong>地理空间搜索</strong>：按位置搜索。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fhybrid-search-elasticsearch" title="https://www.elastic.co/search-labs/blog/hybrid-search-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">混合搜索</a>：使用上述多种方式混合搜索。</li>
</ol>
</li>
<li>
<p><strong>LLM 推理</strong><br/>
检索到的上下文被传回 LLM，使其响应基于最相关的数据，而不是仅依赖训练数据。</p>
</li>
<li>
<p><strong>结构化输出生成</strong><br/>
模型受我们使用 Zod 或 Pydantic 创建的 schema 限制，生成已验证的 JSON 对象，而不是自由文本。</p>
</li>
<li>
<p><strong>结构化索引</strong><br/>
将已验证的输出使用显式映射索引回 Elasticsearch，使查询、聚合和分析更加容易。</p>
</li>
<li>
<p><strong>重用与自动化</strong><br/>
现在数据已添加结构化，就可以轻松查询、过滤、聚合，或用作下游系统和工作流的输入。</p>
</li>
</ol>
<p>这个循环使 agents 能将 Elasticsearch 同时用作检索层和记忆存储，从而实现基于上下文的推理、自动化和长期学习。</p>
<h2 data-id="heading-8">限制</h2>
<p>Marius Schroder 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fmedialesson%2Fstructured-prompting-in-real-projects-checklist-best-practices-c39fa789856b" title="https://medium.com/medialesson/structured-prompting-in-real-projects-checklist-best-practices-c39fa789856b" target="_blank" ref="nofollow noopener noreferrer">结构化提示文章</a>提到了一些结构化提示的限制，这些也适用于结构化输出。</p>
<p>他提到：</p>
<ul>
<li>
<p><strong>schema 可以保证格式但不能保证正确性</strong>：模型仍可能输出 “垃圾” 数据，即 JSON 结构有效但内容错误。例如，行程 schema 可能要求有效的 ISO 日期、数值类型的价格，以及不超过 8 个字符的航班号。模型仍可能返回 2 月 30 日的航班（不可能的日期），或者给五星级酒店标 10 美元。在这种情况下，结构有效但事实错误，说明 schema 验证的是数据形状而非真实性。</p>
</li>
<li>
<p><strong>复杂或深度嵌套的 schema 仍可能失败</strong>：如果输出足够大，仍可能遇到解析失败或 token 限制，模型可能截断不同部分。</p>
</li>
<li>
<p><strong>不适合创意场景</strong>：在这种情况下，自由文本可能更好，尤其是当你不想过度限制 LLM 在创意任务中的发挥时。</p>
</li>
</ul>
<h2 data-id="heading-9">结论</h2>
<p>本文深入探讨了在多 agent 系统中提供结构化输出的重要性、开发者常用工具，以及 Elasticsearch 如何自然扩展。想了解更多，请查看以下资源。</p>
<h2 data-id="heading-10">资源</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsearch-labs-redesign.vercel.app%2Fsearch-labs%2Fblog%2Fcontext-engineering-overview" title="https://search-labs-redesign.vercel.app/search-labs/blog/context-engineering-overview" target="_blank" ref="nofollow noopener noreferrer">What is context engineering? | Carly Richmond</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fstructured-output" title="https://docs.langchain.com/oss/python/langchain/structured-output" target="_blank" ref="nofollow noopener noreferrer">LangChain: Structured output</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftowardsdatascience.com%2Fhands-on-with-anthropics-new-structured-output-capabilities%2F" title="https://towardsdatascience.com/hands-on-with-anthropics-new-structured-output-capabilities/" target="_blank" ref="nofollow noopener noreferrer">A Hands-On Guide to Anthropic’s New Structured Output Capabilities | Thomas Reed</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-structured-outputs-in-the-api%2F" title="https://openai.com/index/introducing-structured-outputs-in-the-api/" target="_blank" ref="nofollow noopener noreferrer">OpenAI: Introducing structured outputs in the API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fstructured-outputs" title="https://platform.openai.com/docs/guides/structured-outputs" target="_blank" ref="nofollow noopener noreferrer">OpenAI: Structured outputs</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fmedialesson%2Fstructured-prompting-in-real-projects-checklist-best-practices-c39fa789856b" title="https://medium.com/medialesson/structured-prompting-in-real-projects-checklist-best-practices-c39fa789856b" target="_blank" ref="nofollow noopener noreferrer">Structured Prompting in real projects — checklist &amp; best practices | Marius Schroder</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fdevelopers%2Fgemini-api-structured-outputs%2F" title="https://blog.google/technology/developers/gemini-api-structured-outputs/" target="_blank" ref="nofollow noopener noreferrer">Improving Structured Outputs in the Gemini API</a></li>
</ol>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fstructured-outputs-elasticsearch-guide" title="https://www.elastic.co/search-labs/blog/structured-outputs-elasticsearch-guide" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[老王请假、客户开喷、我救火：一场递归树的性能突围战]]></title>    <link>https://juejin.cn/post/7589093895327531017</link>    <guid>https://juejin.cn/post/7589093895327531017</guid>    <pubDate>2025-12-30T00:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589093895327531017" data-draft-id="7589093895326220297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="老王请假、客户开喷、我救火：一场递归树的性能突围战"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-12-30T00:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            老王请假、客户开喷、我救火：一场递归树的性能突围战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:04:20.000Z" title="Tue Dec 30 2025 00:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,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");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,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");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,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");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言：</h2>
<blockquote>
<p>上周，负责核心业务组件的同事老王突然请假（据说去相亲了），留下一堆代码和风中凌乱的我。</p>
<p>结果前脚刚走，后脚核心客户就炸锅了：“你们这个系统怎么回事？我每次要给员工赋个权，浏览器就直接卡死！打开弹窗挺快，一点开部门就未响应，关掉弹窗还要卡半天！”</p>
<p>看着客户发来的 <strong>十几秒卡顿录屏</strong>，和老板投来的“和善”目光，我只能硬着头皮接下了这个“锅”。</p>
<p>本文记录了我是如何从吐槽同事代码，到深度排查，最终通过<strong>深度优化</strong>解决这个 <strong>几千个节点递归组件性能灾难</strong>的全过程。</p>
</blockquote>
<h2 data-id="heading-1">先看优化结果: 懒加载 + 合成线程优化 + 手风琴模式</h2>
<ul>
<li>
<p><strong>交互体验</strong>：几千节点树瞬间展开，关闭零延迟。</p>
</li>
<li>
<p><strong>Performance 数据</strong>：如图所示，长任务 (<code>Long Task</code>) 彻底消失，无红色阻塞色块。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dffe2fd5a3354652a5ebc920f7d05390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=uKpRSm%2FUtYKyE726u%2FxILUcGaeQ%3D" alt="优化后结果.gif" loading="lazy"/></p>
<h2 data-id="heading-2">一、 客户现场还原（案发经过）</h2>
<h3 data-id="heading-3">业务背景</h3>
<p>客户正在使用我们的 <strong>“企业级权限管理系统”</strong> 。</p>
<p>出问题的组件是一个核心的 <strong>组织架构选择器（TreeSelect）</strong> ，它被嵌入在一个高频使用的 <strong>“授权弹窗”</strong> 中。</p>
<ul>
<li>
<p><strong>高频场景</strong>：管理员需要频繁地给不同的员工或部门分配权限。</p>
</li>
<li>
<p><strong>操作路径</strong>：点击“可见范围” -&gt; 弹出授权弹窗 -&gt; 在树形组件中找到对应部门/人员 -&gt; 勾选 -&gt; 确定/关闭。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>数据规模</strong></h3>
<p>该客户是大型企业，全量组织架构节点约为 <strong>2700 个</strong>（包含多级部门和人员）。这个数量级在 ToB 业务中其实不算特别大，但足以压垮未经优化的代码。</p>
<h3 data-id="heading-5"><strong>故障现象</strong></h3>
<ol>
<li>
<p><strong>打开弹窗（快）</strong> ：点击授权按钮，弹窗秒出（老王用了分帧渲染进行首屏优化，这点挺好）。</p>
</li>
<li>
<p><strong>寻找部门（卡死）</strong> ：管理员试图展开根部门去寻找下级单位，点击小三角的瞬间，界面失去响应，<strong>Long Task 持续 10s+</strong> 。管理员以为死机了，疯狂点击，结果还是没反应。</p>
</li>
<li>
<p><strong>关闭/取消（卡死）</strong> ：好不容易选完了，点击“确定”或“关闭”弹窗，界面再次假死 <strong>4-5s</strong>，才能关掉弹窗。</p>
</li>
</ol>
<h2 data-id="heading-6">二、 深度侦查：谁在谋杀主线程？</h2>
<blockquote>
<p><strong>工程化思考：线上监控能发现吗？</strong>
很多同学问：Sentry 或其它性能监控能抓到这个问题吗？
线上监控通常只能告诉你 <strong>“页面卡了”</strong>（监控到 <code>Long Task</code> 或 <code>INP</code> 指标飙升），但很多时候难告诉你具体的 <strong>“为什么卡”</strong>。
要确诊是 JS 逻辑阻塞，还是 CSS 动画引发的 <strong>Reflow (重排)</strong>，必须依赖本地 Chrome DevTools 的 <strong>Performance 面板</strong> 进行“CT 扫描”。</p>
<p><strong>💡 小贴士：如何使用 Performance？</strong>
打开 F12 开发者工具 -&gt; 切换到 <strong>Performance</strong> 面板 -&gt; 点击左上角“圆点”开始录制 -&gt; 在页面操作复现卡顿 -&gt; 点击 Stop 停止，即可生成分析报告。</p>
</blockquote>
<p>我在本地 Mock 了 2700 条左右的数据，模拟了“打开 -&gt; 展开 -&gt; 关闭”的全流程，打开 Chrome <strong>Performance</strong> 一看，好家伙，红得跟过年一样。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17bc9a2b51ae4092961705ccbd77aa8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=5FMKBGG3JlikrGoWEi9%2B5dQxC5I%3D" alt="组织架构树响应慢问题排查.gif" loading="lazy"/></p>
<h3 data-id="heading-7">第一步：看“心电图” (Performance 面板)</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87cf18d4a88545e39f23177e037327d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=YpLgBvOsNl%2FYnKQVW%2BHUQxVSiac%3D" alt="image.png" loading="lazy"/></p>
<p><strong>现象</strong>：</p>
<blockquote>
<p>很多人看到 Performance 密密麻麻的图表就头晕，其实诀窍就一句话：<strong>从上往下看</strong>。</p>
<ol>
<li><strong>看顶部</strong>（Main 线程）：<strong>红色</strong>的色块代表 <strong>Long Task</strong>（长任务），是导致页面卡顿的直接元凶。</li>
<li><strong>看中间</strong>（调用栈）：像倒置的火焰一样，<strong>越宽</strong>代表耗时越久，<strong>越往下</strong>代表函数调用越深。</li>
<li><strong>找凶手</strong>：顺着红条往下找，最底下的那个“宽条条”，通常就是罪魁祸首。</li>
</ol>
</blockquote>
<p><strong>回到本案分析</strong>：</p>
<ol>
<li>
<p><strong>顶部报警</strong>：最显眼的是一条红色斜纹带，说明主线程一直处于阻塞状态。</p>
</li>
<li>
<p><strong>中间密集</strong>：顺着红色区域往下看，全是密密麻麻的黄色小条，提示 <code>Animation Frame Fired</code>（动画帧<code>requestAnimationFrame</code>触发）。</p>
</li>
<li>
<p><strong>底部实锤</strong>：继续顺着调用栈 <strong>从上往下</strong> 找，能看到频繁的 <code>cloneNode</code>（克隆节点）调用。这说明核心耗时在 DOM 操作，浏览器在不断创建新元素。</p>
</li>
</ol>
<p><strong>结论</strong>：核心耗时在 DOM 操作，浏览器在疯狂加班造 DOM。<code>cloneNode</code> 就像是在复印文件，这说明代码在<strong>没完没了地制造新的页面元素</strong>，而且是一刻不停地在造，直接把主线程干趴下了。</p>
<h3 data-id="heading-8">第二步：顺藤摸瓜 (找代码)</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d00c4d1ccee4e14a3f45a0f46d35185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=XbplzkEebZOah8wafv7NLXy256c%3D" alt="image.png" loading="lazy"/></p>
<p><strong>线索</strong>：
Performance 面板明确指出了凶手是 <code>ReSubMenu.vue</code> 里的 <code>renderVisibleData</code> 函数。</p>
<p><strong>代码长这样</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是一个分帧渲染函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleData</span>(<span class="hljs-params">data, index = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 1. 先渲染一小部分（比如 5 个）</span>
  visibleChildrenData.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(...data.<span class="hljs-title function_">slice</span>(index, index + <span class="hljs-number">5</span>))

  <span class="hljs-comment">// 2. 如果还有数据没渲染完，申请下一帧接着干</span>
  <span class="hljs-keyword">if</span> (还剩有数据) {
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">renderVisibleData</span>(data, index + <span class="hljs-number">5</span>) <span class="hljs-comment">// &lt;--- 案发地点！</span>
    })
  }
}
</code></pre>
<p><strong>原本的算盘</strong>：
写这段代码的初衷是好的——<strong>“分帧渲染”</strong>。
为了防止某一层级下有几千个菜单项把页面卡死，特意用了 <code>requestAnimationFrame</code>，意思是：“浏览器大哥，您别急，咱们每帧只画 5 个，慢慢来。”</p>
<h3 data-id="heading-9">第三步：真相大白 (逻辑漏洞)</h3>
<p><strong>问题出在哪？</strong>
看似优雅的“慢慢来”，忽略了一个致命的前提：<strong>递归组件的叠加效应</strong>。</p>
<p>我们的树形组件结构大概是这样的（典型的无限套娃）：</p>
<ul>
<li>入口 (AuthorizedMenu.vue)
<ul>
<li>TreeSelect (外层容器)
<ul>
<li>ReSubMenu (递归的开始)
<ul>
<li>SubMenu (动画/折叠)
<ul>
<li>MenuItem (节点项)</li>
<li>ReSubMenu (子节点 -&gt; 套娃开始)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>这就意味着，如果你的树数据有 5 层深，组件就会自己把自己嵌套 5 层。</p>
<p>我又看了一眼负责展开收起菜单动画的父组件 <code>SubMenu.vue</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 这里只用了 CSS 控制高度来折叠，没有用 v-if --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subItem"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: ... }"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>案情还原</strong>：</p>
<ol>
<li>
<p><strong>看不见的“大军”</strong>：
虽然界面上菜单是收起的，但因为没加 <code>v-if</code> 控制，<strong>整棵树 2000 多个节点其实都在后台悄悄挂载了</strong>。这就好比你只点了一盘花生米，后厨却把满汉全席都备好了。</p>
</li>
<li>
<p><strong>分帧策略失效</strong>：
老王的“分帧渲染”本意是好的：“大家别急，排好队，一帧画 5 个。”
但因为是递归组件，<strong>几百个组件实例是同时启动的</strong>。</p>
</li>
<li>
<p><strong>菜市场效应</strong>：</p>
<ul>
<li>第一层组件喊：“浏览器老师，麻烦帮我画 5 个！”</li>
<li>第二层组件也喊：“我也要画 5 个！”</li>
<li>第 N 层组件齐声喊：“还有我！还有我！”</li>
</ul>
</li>
</ol>
<p><strong>结果</strong>：浏览器瞬间懵了。虽然每个人只请求画 5 个，但这几百个组件同时请求，瞬间就堆积了成千上万个 <code>cloneNode</code> 任务。这就好比几百只鸭子同时在叫，主线程直接被<strong>高并发的 DOM 操作</strong>给冲垮了。</p>
<h2 data-id="heading-10">三、 紧急救援：学会“偷懒”</h2>
<p>吐槽归吐槽，Bug 还是得修。解决办法就是三个字：<strong>懒加载</strong>。</p>
<h3 data-id="heading-11">核心逻辑</h3>
<p>看不见的菜单，坚决不渲染！
只有当用户点击“展开”按钮那一刻，我才开始去渲染子菜单。</p>
<h3 data-id="heading-12">代码改动</h3>
<p>把原来的“一上来就渲染”改成“盯着开关看”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReSubMenu.vue</span>

<span class="hljs-comment">// 只有当 isExpand (展开状态) 变成 true 时，才开始干活</span>
<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">data</span>.<span class="hljs-property">isExpand</span>,
  <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (val) {
      <span class="hljs-comment">// 只有展开时，且之前没渲染过，才启动分帧渲染</span>
      <span class="hljs-keyword">if</span> (visibleChildrenData.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">renderVisibleData</span>(props.<span class="hljs-property">data</span>?.<span class="hljs-property">children</span>)
      }
    } <span class="hljs-keyword">else</span> {
       visibleChildrenData.<span class="hljs-property">value</span> = []
    }
  },
  { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> }
)
</code></pre>
<h3 data-id="heading-13">关闭弹窗卡死</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ffac7e3c6347a194162776075dbcf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=sYzqiwrmy1sCjHJXTd%2BS8WOrhrc%3D" alt="关闭弹窗慢问题排查.gif" loading="lazy"/></p>
<p>客户之前反馈“关闭弹窗也卡”，是因为同事老王的代码让组件一开始加载了几千个节点，内存中就堆积了几千个复杂的组件实例。</p>
<p>点击关闭弹窗的那一刻，主线程被 GC（垃圾回收）和 Vue组件的卸载任务（<code>beforeUnmount</code> / <code>unmounted</code>等）瞬间挤爆。</p>
<p><strong>截图证据</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/757b3a8e1a3a432d81fd9240f1f2087c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=4iGg%2FNPdlq%2FpcXnSTFvAjrlRDbI%3D" alt="image.png" loading="lazy"/>
大家看这张截图，关闭弹窗的一瞬间，<code>removeChild</code> 操作竟然耗时 <strong>5.14s</strong>！这意味着浏览器主线程被这个巨大的“拆迁工程”彻底堵死，用户只能对着屏幕发呆。</p>
<h2 data-id="heading-14">四、 进阶战术：三维治理策略</h2>
<p>单纯的懒加载解决了“初始化”问题，但为了达到极致体验，我们还引入了另外两个维度的优化。</p>
<h3 data-id="heading-15">1. 渲染层：用 ScaleY 替代 Height 动画</h3>
<p><strong>排查</strong>：</p>
<ul>
<li>
<p>我看了下 CSS，菜单的展开/收起是用 <code>transition: height</code> 做的“窗帘”效果。</p>
</li>
<li>
<p>每一级菜单都是改高度 <code>height</code>（收起为 0，展开为节点内容高度）。</p>
</li>
<li>
<p><code>height</code> 是布局属性，动它就会触发 <code>Reflow</code>（重排），浏览器需要把受影响的布局链路重新算一遍。</p>
</li>
<li>
<p>递归树会层层传导：你点开一层会牵动下面整段子树一起算，链路很长，低端机分分钟卡住</p>
</li>
</ul>
<p><strong>展开节点卡顿现象图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d525c3b276149d68df6b57e439876f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=79PDp69%2BjICr75NDrnlXnJUHx8Y%3D" alt="展开菜单卡顿.gif" loading="lazy"/></p>
<p><strong>优化</strong>：
改为使用 CSS3 的 <code>transform: scaleY</code>，同样可以达到丝滑展开的效果。</p>
<p><strong>简单理解 使用ScaleY实现展开动画效果的原理</strong>：</p>
<ul>
<li><strong>变的是什么？</strong> <code>scaleY</code> 改变的是元素在 <strong>Y 轴（竖向）</strong> 的缩放比例。</li>
<li><strong>怎么变？</strong> 从 <code>0</code>（压扁成一条线，完全看不见）过渡到 <code>1</code>（拉伸回原本的高度）。</li>
<li><strong>为什么像展开？</strong> 配合 <code>transform-origin: top</code>（固定顶部），就像把卷帘门从上往下拉下来一样，视觉上就是完美的“展开”效果。</li>
</ul>
<p><strong>深度原理</strong>：<code>transform</code> 属性不会触发 Reflow，只会触发 <strong>Composite (合成)</strong>，这个过程完全由 GPU 处理，不占用主线程 CPU 资源。</p>
<blockquote>
<p><strong>浏览器渲染三兄弟</strong></p>
<ul>
<li><strong>Reflow (重排)</strong>：牵一发而动全身。修改 <code>height</code>、<code>width</code> 时，浏览器要重新计算所有元素位置，<strong>开销最大</strong>。</li>
<li><strong>Repaint (重绘)</strong>：换汤不换药。修改 <code>color</code>、<code>background</code> 时，不影响位置，只重画样子，<strong>开销中等</strong>。</li>
<li><strong>Composite (合成)</strong>：<strong>VIP 绿色通道</strong>。修改 <code>transform</code>、<code>opacity</code> 时，浏览器直接把图层交给 GPU 处理，<strong>跳过</strong>布局和绘制，<strong>开销最小</strong>！</li>
</ul>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 优化前：卡顿源头 */</span>
<span class="hljs-selector-class">.subItem</span> {
  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">0.3s</span> ease-in-out;
}

<span class="hljs-comment">/* 优化后：丝滑无比 */</span>
<span class="hljs-selector-class">.subItem</span> {
  <span class="hljs-attribute">transform-origin</span>: top; <span class="hljs-comment">/* 确保从顶部开始展开 */</span>
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.645</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.355</span>, <span class="hljs-number">1</span>);
}

<span class="hljs-selector-class">.subItem</span><span class="hljs-selector-class">.expanded</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-selector-class">.subItem</span><span class="hljs-selector-class">.collapsed</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0</span>);
}
</code></pre>
<blockquote>
<p><strong>⚠️ 避坑指南：关于 <code>will-change: </code></strong></p>
<p>有同学可能会问：“为什么不加 <code>will-change: transform</code>？”</p>
<ul>
<li>少量元素时可以考虑；大规模递归树千万别全局加。</li>
<li>参考 MDN：不到不得已不要使用；仅在确有必要时短时添加，过度使用会导致内存占用增加与性能下降。</li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2Fwill-change" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/will-change" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>建议：如需使用，按需、短时、少量元素，并在动画结束后移除。</li>
</ul>
</blockquote>
<p>效果： 动画流畅、交互响应即时。（GIF图压缩严重，请自动脑补德芙广告的丝滑质感）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/674c72b24f914e3f9b9254cbfe8454df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=51eSiVp7hUUWuEPdjr7STPY0Leo%3D" alt="节点展开动画优化.gif" loading="lazy"/></p>
<h3 data-id="heading-16">2. 销毁层：以“藏”代“删”</h3>
<p><strong>痛点</strong>：
即使用户只是临时关闭弹窗，下次还要再开，原来的逻辑也是直接 <code>v-if="false"</code> 销毁整个组件树。这就导致了那 5 秒的 <code>removeChild</code> 卡顿。</p>
<p><strong>优化</strong>：
对于这种巨型组件，关闭弹窗时<strong>不要销毁它</strong>，而是把它“藏起来”。</p>
<p><strong>代码改动</strong>：
将弹窗的显隐控制从 <code>v-if</code> 改为 <code>v-show</code>，或者使用透明度方案：</p>
<blockquote>
<p><strong>v-if 、 Opacity、  v-show</strong>的区别</p>
<ul>
<li>
<p><strong>v-if</strong>：真正的条件渲染。切换时，组件及其内部所有的事件监听器和子组件都会被<strong>销毁和重建</strong>。对于 2500 个节点的树，这意味着成千上万次的 DOM 插入/删除操作。</p>
</li>
<li>
<p><strong>v-show</strong>：简单的 CSS 切换（display: none）。组件实例始终保留，开销极小。</p>
</li>
<li>
<p><strong>Opacity (透明)</strong>：<code>opacity: 0</code>。DOM 保留，配合 GPU 加速仅触发合成 (Composite)，<strong>切换成本最低</strong>（本案最终方案）。</p>
</li>
</ul>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 只是看不见，但 DOM 还在，避免了昂贵的卸载过程 */</span>
<span class="hljs-selector-class">.dialog-hidden</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">pointer-events</span>: none; <span class="hljs-comment">/* 确保点不到 */</span>
  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">1</span>;
}
</code></pre>
<p><strong>效果</strong>：
关闭弹窗时，耗时从 <strong>5s</strong> 瞬间变为 <strong>0ms</strong>（只是改了个 CSS 属性）。下次再打开时，因为 DOM 都在，直接恢复透明度即可，实现了真正的“秒开”。</p>
<h3 data-id="heading-17">3. 交互层：手风琴模式（Accordion）</h3>
<blockquote>
<p><strong>🤔 什么是手风琴效果？</strong></p>
<p>简单来说，就是 <strong>同一级只有一个节点展开</strong>。
就像手风琴的风箱，拉开这一折，那一折自然合上。比如财务部和研发部是兄弟节点，当你点击展开“财务部”的子节点，之前点开的“研发部”会自动收起。</p>
</blockquote>
<p>我们先来看优化后的效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6748feeb1794a928094ef6aa00bbc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=kzS7JHNFNbqabkFvZZck1SnOI3Q%3D" alt="手风琴效果.gif" loading="lazy"/></p>
<p><strong>痛点</strong>：
ToB 系统的用户有时操作很“野”，他们可能会把所有部门一层层全部点开。
如果不加限制，随着用户不断展开，页面上的 DOM 节点数量依然会无限制增长，最终再次拖慢浏览器。</p>
<p><strong>优化</strong>：
为组件增加 <code>accordion</code>（手风琴）模式配置。
<strong>原理</strong>：开启后，同级节点同时只能展开一个。当你展开“财务部”时，之前展开的“研发部”会自动收起。</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码：手风琴逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onNodeExpand</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (accordionMode) {
    <span class="hljs-comment">// 兄弟节点，统统收起！</span>
    siblings.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sib</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (sib !== node) sib.<span class="hljs-property">isExpand</span> = <span class="hljs-literal">false</span>
    })
  }
  node.<span class="hljs-property">isExpand</span> = <span class="hljs-literal">true</span>
}
</code></pre>
<p>这从<strong>交互设计</strong>层面对 DOM 峰值设定了上限：不管怎么点，同级只保留一个展开项，页面同时存在的 DOM 数始终处于低位且可控。</p>
<h2 data-id="heading-18">番外篇：如果数据量再大 10 倍怎么办？</h2>
<p>虽然这次 2000多条数据搞定了，但肯定有小伙伴会问：“如果有 <strong>2万多条</strong> 甚至更多怎么办？”</p>
<p>这时候，单纯的懒加载也不够用了，因为 DOM 节点的总数依然可能突破浏览器极限。我们需要引入核武器——<strong>虚拟树 (Virtual Tree)</strong>。</p>
<p>简单来说，就是<strong>只渲染你屏幕里看得到的那些节点</strong>。
不管树有几万层，屏幕就那么高（比如 800px），我只渲染这几十个节点，其他的用个空 <code>div</code> 撑开高度把滚动条骗过去就行。</p>
<p><strong>思路也很直白</strong>：</p>
<ol>
<li><strong>拍平</strong>：把树拆成一个大的一维数组。</li>
<li><strong>计算</strong>：算算当前滚动条在什么位置，对应数组里的哪几条数据。</li>
<li><strong>渲染</strong>：只把这几条画出来，绝对定位到正确的地方。</li>
</ol>
<p><strong>那为什么这次没用？</strong>
还是那句老话：<strong>ROI（投入产出比）</strong>。</p>
<p>手写虚拟树要处理动态高度、复选框联动等难点，头发都要掉一把；引入现成的库又会增加包体积。
对于 几千条数据，现在的方案已经够用了，再上虚拟树就是“大炮打蚊子”，没必要增加维护成本。</p>
<p><strong>技术选型没有银弹，只有最适合当下的方案。</strong></p>
<h2 data-id="heading-19">五、 优化结果与客户反馈</h2>
<p>效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dffe2fd5a3354652a5ebc920f7d05390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767658302&amp;x-signature=uKpRSm%2FUtYKyE726u%2FxILUcGaeQ%3D" alt="优化后结果.gif" loading="lazy"/></p>
<p>我们将优化后的补丁发给客户验证：</p>
<ol>
<li><strong>打开弹窗</strong>：保持秒开。</li>
<li><strong>寻找部门（展开）</strong>：从 <strong>十几秒卡死</strong> 变为 <strong>即时响应</strong>。</li>
<li><strong>完成授权（关闭）</strong>：从 <strong>5s 卡死</strong> 变为 <strong>0 延迟</strong>。</li>
</ol>
<p>Performance 面板再次查看，那条心电图终于平稳了，只有零星的几个小波峰，代表正常的渲染任务。</p>
<p>客户反馈：“终于顺畅了，这才是专业系统该有的样子。”（老板终于露出了满意的微笑）</p>
<hr/>
<h2 data-id="heading-20">六、 写在最后</h2>
<p>这次“接盘”经历告诉我：</p>
<ol>
<li>
<p><strong>不要为了优化而优化</strong>：“分帧渲染”是个好技术，但如果配合上了“全量挂载”，就像让一千个人同时在走廊里“慢跑”，虽然每个人跑得慢，但路还是被堵死了。</p>
</li>
<li>
<p><strong>关注“销毁”成本</strong>：性能优化不仅是“渲染快”，还要“销毁快”。</p>
</li>
<li>
<p><strong>递归组件要慎重</strong>：递归组件是性能问题的重灾区，一定要时刻警惕“指数级爆炸”。</p>
</li>
</ol>
<p>最后的最后，老王回来后，我必须得请他吃顿好的——毕竟没有他这代码，我也没机会写这篇几千字的复盘文章，更没机会在掘金骗大家的赞（手动狗头）。</p>
<p><strong>如果你觉得这篇文章对你有启发，欢迎 点赞、收藏、转发，这对我很重要！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的 2025：代码留痕，时光有暖，成长有迹]]></title>    <link>https://juejin.cn/post/7589181008097820687</link>    <guid>https://juejin.cn/post/7589181008097820687</guid>    <pubDate>2025-12-30T00:09:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589181008097820687" data-draft-id="7589104492882608180" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的 2025：代码留痕，时光有暖，成长有迹"/> <meta itemprop="keywords" content="年终总结"/> <meta itemprop="datePublished" content="2025-12-30T00:09:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三只萌新"/> <meta itemprop="url" content="https://juejin.cn/user/360295544400973"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的 2025：代码留痕，时光有暖，成长有迹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295544400973/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三只萌新
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:09:07.000Z" title="Tue Dec 30 2025 00:09:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇：2025，代码、娃和写文的一年</h2>
<p>2025 这一年，更像并行推进着两件事 —— 工作上完成了 35 + 需求，跑了 10 次客户现场对接需求、解决问题，参与了一次投标，同时带教的 5 名新人也能独立承担工作了。独立做了个 UML 建模的桌面端应用，从需求梳理到上线的全流程都走通了。</p>
<p>写文的节奏也没断，今年一共输出了 20 多篇原创技术文章，内容都是实际工作里的经验：比如 Jenkins 打包遇到的问题、远程带新人的流程、用 SVG 实现思维导图和 UML 关系线，还有独立开发桌面应用的过程、现场紧急排查性能问题的方法，算是把实操里的经验都整理成了文字。</p>
<p>家庭这边是全新的生活底色 —— 儿子出生后，我俩彻底切换成新手爸妈模式，从手忙脚乱地换尿布、学拍嗝，到慢慢摸清他的作息规律。今年他有三次发烧，夜里每隔一小时就爬起来量体温、做物理降温，十多个晚上熬下来，连夜里醒几次、该喂多少水都形成了肌肉记忆，总算从最初的慌慌张张，慢慢练成了遇事不慌的 “熟练工”。</p>
<p>这一年不算轻松，改 bug 的间隙要盯着新人的进度，哄娃睡熟后会顺手理一理文章的思路。但回头看，工作里的需求都落了地，自己做的应用跑通了流程，家里的小家伙也安稳长大，这些事儿算是都稳稳接住了。</p>
<h2 data-id="heading-1">研发深耕</h2>
<p>今年在公司干的活儿还是杂而实，作为全干工程师，日常就是围着  Electron、SVG 图形绘制逻辑计算、Nestjs 转，偶尔还得啃点操作系统相关的知识，技术面铺得比较开。好在已经在公司待了两年半，不管是前端还是 Node 端的链路，现在摸得都很透，对整个项目的把控力也比以前强多了，遇到跨模块的问题也能快速理顺。</p>
<p>AI 编程是我今年花心思最多、探索最久的一块。前前后后试了不少工具，trae 的海外版和中文版都常用，还有 cursor、kiro、windsurf、qoder 这些，国内的豆包、通义千问、kimi 也都挨个测过。从一开始琢磨怎么优化提示词，到后来定规则、搞 spec 编程，一步步试着把 AI 编程往工程化靠，不是随便用用图个快，而是想让它真正适配日常开发流程。靠这些工具省了不少重复劳动的时间，终于能把精力放在核心业务上，也有功夫系统性地摸透业务逻辑，跟实施团队、现场业务方沟通也更顺畅了，现在对整个业务流程的来龙去脉都门儿清。</p>
<p>我也没困在现有工作的边界里，想着多拓展下自己的领域。除了入门 Java 写点 demo 练手，还自己捣鼓了那个 UML 建模的桌面端应用，开发的时候主动补了些操作系统的知识，算是跳出舒适区多学了点东西。</p>
<p>对外对接的活儿也没落下，全年跑了 10 次客户现场，需求确认、排查问题、验收落地一套流程走下来都顺顺利利，确保客户要的东西能精准落地。另外还全程跟着参与了一次投标，负责写技术方案、准备支撑材料，也算帮团队把这个专项的事儿扛了下来。</p>
<h2 data-id="heading-2">团队带教</h2>
<p>今年还有个变化，就是开始主动往管理、带人这块靠，不再只盯着自己的代码，愿意接些团队管理的活儿，试着做业务和团队的 “掌舵人”，而不只是个技术执行者。全年带了 5 个新人，从入门怎么上手、代码规范怎么守，到熟悉业务、跟着做项目实操，全流程都陪着他们走。</p>
<p>我会记着每个新人什么时候能独立接单，遇到他们卡壳的地方，就针对性地帮着梳理难点、避坑。慢慢也总结出些实用的带教方法，不是光靠说，而是把复杂业务拆成一步步的小任务，再定期跟他们答疑复盘，这些方法也整理成了可复用的流程，后面再带人就能省不少劲。看着新人一个个能独当一面，我自己的统筹协调、跟人沟通的能力也跟着提上来了，算是双向成长吧。</p>
<h2 data-id="heading-3">内容创作</h2>
<p>今年写技术文章，对我来说更像是个人复盘和记录的过程，不是为了刻意分享，更多是用输出倒逼自己输入和梳理。每一篇都是实战里摸爬滚打的总结，不管是 Jenkins 打包踩的坑、SVG 绘制的实操技巧，还是 AI 编程的探索心得、独立开发桌面应用的流程，都一一记了下来，发布在掘金上。</p>
<p>这些文字也是给我自己的职业生涯留个印记。哪怕以后转行做了别的，回头翻一翻，也能想起这段和代码打交道的日子，清楚自己每一步是怎么过来的。而且写的过程本身就是重新梳理逻辑、查漏补缺，相当于再把工作里的知识点过一遍，既巩固了技能，也能给有同样困惑的同行一点参考，算是意外的收获。</p>
<h2 data-id="heading-4">家庭新章</h2>
<p>今年最重大的变化，就是解锁了爸爸这个新身份，也真正懂了什么是家庭责任感。工作之余的大部分时间，几乎都耗在了家里的小可爱身上，陪他玩、哄他睡、处理各种琐碎的照料事宜，日子被这些细碎的时光填满。</p>
<p>这份新身份带来的，是快乐和疲惫对半开的日常。小家伙三次发烧的夜里，我几乎没合过眼，隔一小时就摸一次体温、擦一遍身子，几个通宵熬下来，连走路都有点飘。也是这时候才懂，当父母哪有什么得心应手，全是硬扛过来的。</p>
<p>快乐是实打实的 —— 被他攥着手指咿呀学语，看他睡醒后咧嘴笑的模样，但疲惫也是真真切切的，是新手爸妈面对孩子发烧时的手足无措，是熬完夜还要赶去公司开会的兵荒马乱。</p>
<p>一边是催着上线的需求、排满行程的出差、等着带教的新人，一边是离不开人照顾的娃和一堆家务琐事，这种拉扯感缠了一整年。原来所谓的中年人时刻，就是这样，谈不上什么平衡，无非是在工作和家庭的夹缝里，一边狼狈应付，一边咬牙扛起该担的责任。</p>
<h2 data-id="heading-5">来年规划</h2>
<p>时光匆匆，2025 年转眼即逝。新的一年不贪多求全，就沉下心把几件事做扎实，稳步往前推进。</p>
<p>技术和工作上，重点抓两件事。</p>
<ol>
<li>是把 AI 编程工程化这条路走深走透，多琢磨适配日常开发的落地技巧，靠它解放双手、减少重复劳动，省出更多精力跳出代码本身。不再只做埋头敲代码的执行者，主动往前站一步，摸清业务的底层逻辑和核心诉求，读懂业务背后的价值，让自己在工作中更有话语权。</li>
<li>是继续拓展独立开发的边界，不再局限于现有成果，主动探索新的应用方向，从零到一打造新的自研项目，争取做出能解决实际需求、让更多人用得上的产品，让技术落地产生真正的价值。</li>
</ol>
<p>团队带教方面，打破现有单一模式，多探索灵活高效的方法。不光是靠手把手带练，还会结合 AI 工具优化带教流程，整理标准化手册的同时，增加案例复盘、任务拆解实操等环节，针对性匹配不同新人的接受节奏，既提高带教效率，也能让新人更快独当一面。</p>
<p>生活上，核心是把节奏调顺、过出质感。一直坚信工作是为了更好的生活，而非被工作裹挟。新的一年要砍掉无效忙碌，多留些高质量陪伴给家人，陪着孩子慢慢长大，多为家里添些烟火气和实实在在的快乐，在个人成长和家庭温暖之间找到舒服的平衡点，不辜负每一段陪伴的时光。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Flutter、SwiftUI 和 Compose 写同一个界面：一份真实开发者的实测报告]]></title>    <link>https://juejin.cn/post/7589082912589086763</link>    <guid>https://juejin.cn/post/7589082912589086763</guid>    <pubDate>2025-12-30T00:15:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589082912589086763" data-draft-id="7587672626757697555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Flutter、SwiftUI 和 Compose 写同一个界面：一份真实开发者的实测报告"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T00:15:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Flutter、SwiftUI 和 Compose 写同一个界面：一份真实开发者的实测报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:15:46.000Z" title="Tue Dec 30 2025 00:15:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>嘿，朋友！👋</p>
<p>还记得咱们以前老是为“哪种框架才是坠吊的”吵得不可开交吗？这回，我终于干了件每个开发者都放过狠话、但从来没真干过的事：我用 <strong>Flutter、SwiftUI 和 Jetpack Compose</strong> 把同一个界面撸了出来——而且全都严格遵循了 <strong>Clean Architecture（整洁架构）</strong> 原则。</p>
<p><strong>欢迎关注我的微信公众号：OpenFlutter</strong></p>
<p>说实话，最后的结果真把我给惊到了。</p>
<h4 data-id="heading-0">为什么这篇文章值得你看（没错，说的就是你）</h4>
<p>听着，我懂。你点进来多半是因为：</p>
<ul>
<li>你正陷入“框架焦虑（FOMO）”中，急需定夺<strong>到底学哪一个</strong>；</li>
<li>老板问你“咱们项目用哪个好？”，你当时就<strong>慌了</strong>；</li>
<li>你是个 Flutter 开发者，总惦记着<strong>隔壁的草是不是更绿一些</strong>；</li>
<li>你要去面试了，想在聊跨平台开发时显得<strong>更有深度</strong>；</li>
<li>你心里其实已经选好了，就指望我能<strong>夸夸你的选择</strong>（剧透一下：没准儿真会哦）。</li>
</ul>
<p>不管你是为了啥来的，我保证这不是那种“Hello World”级别的流水账。这是一个刚熬了三个通宵，在状态管理、依赖注入以及“等等，我这层数据到底怎么传给下一层来着？”这些地狱级难题里反复横跳后的<strong>真实感悟</strong>。</p>
<h4 data-id="heading-1">终极挑战：一个界面，三套框架，拒绝借口</h4>
<p>我做的是一个实战级别的“用户个人资料”页面，毕竟现在谁还稀罕看计数器（Counter App）啊？这玩意儿包含了：</p>
<ul>
<li><strong>真实的远程 API 调用</strong>（带报错处理的那种）；</li>
<li><strong>真正管用的本地缓存</strong>；</li>
<li><strong>不至于丑得像垃圾一样的加载状态</strong>；</li>
<li><strong>严谨的 Clean Architecture 划分</strong>（UseCases, Repositories，一个都不少）；</li>
<li><strong>不会让你想摔电脑的路由导航</strong>。</li>
</ul>
<p>同样的设计，同样的架构，同样的功能。但实现它的过程，却是三种截然不同的体验。</p>
<hr/>
<h3 data-id="heading-2">我的实测体会（那些官宣里不会告诉你的事）</h3>
<h4 data-id="heading-3">1. Flutter：真香，它是真的能干活</h4>
<p>Flutter 最让我感到莫名的爽感的一点是：它居然…真的能跑？而且是哪儿都能跑。</p>
<p>我只写了一套代码，它就能完美运行在我的 iPhone、安卓测试机，<strong>甚至</strong>是网页浏览器上，而且我还没给编译器大神“烧香”。它的 <strong>Hot Reload（热重载）</strong> 快到离谱，刚开始我甚至以为它坏了——按下保存，修改立现。没有编译等待，没有漫长加载。这种生产力，简直是纯粹的享受。</p>
<p>Clean Architecture 的搭建过程也意外地顺滑。用 <code>get_it</code> 做依赖注入？简直<strong>绝了（Chef's kiss）</strong> 。这种目录结构让你觉得，这框架的设计者是真的考虑过开发者的心路历程的。</p>
<p><strong>但反转来了：</strong> Dart 这门语言有点怪。它不差，只是…异类。如果你习惯了 Kotlin 或 Swift，你头一周肯定会反复纠结：“为什么这儿要写下划线？”以及“这个 <code>late</code> 关键字到底是个什么鬼？”</p>
<h4 data-id="heading-4">2. SwiftUI：果粉的快乐（但仅限果粉）</h4>
<p>用 SwiftUI 开发就像开特斯拉：顺滑、极具未来感，但一旦你离开了它的生态圈，偶尔会觉得心累。</p>
<p>它的声明式语法<strong>太漂亮了</strong>。真的，写下 <code>@State</code> 然后看着 UI 自动更新，简直像在施魔法。那种只加一个 <code>.animation()</code> 就能搞定动画的感觉？凌晨两点，我在空无一人的公寓里忍不住叫了声“哇塞”。</p>
<p>但在 SwiftUI 里搞 Clean Architecture，事情就开始变得“复杂”了。SwiftUI 强迫你用 Combine 或 async/await（这本身挺好），但紧接着你就要处理各种 Publishers 和 Cancellables，搞得你的 ViewModel 看起来像飞船仪表盘一样。</p>
<p><strong>最扎心的一点？</strong> 仅限 iOS（行吧，还有 macOS 和 watchOS，但你懂我意思）。你那一套漂亮的代码只能留在苹果的“后花园”里。没安卓，没网页。有的只是优雅的格调和高耸的围墙。</p>
<h4 data-id="heading-5">3. Jetpack Compose：安卓开发者的“救赎之路”</h4>
<p>如果你曾深受 XML 布局的折磨，那 Compose 就像是沙漠里的甘露。Google 终于搞清楚开发者到底想要什么了。</p>
<p><code>Composable</code> 函数写起来直观得一塌糊涂。全是 Kotlin，这意味着如果你懂 Kotlin，你就已经掌握了 70%。预览系统也很稳（前提是 Android Studio 决定配合你，不过绝大多数时候它还挺乖）。</p>
<p><strong>Clean Architecture 实现？</strong> 确实很干净。Kotlin 的协程（Coroutines）让异步操作变得非常自然。用 Hilt 做依赖注入的集成极其丝滑，你会纳闷 Google 为什么花了这么多年才开窍。</p>
<p><strong>但那头“房间里的大象”依然存在：</strong> 它目前基本只属于安卓。虽然 Compose Multiplatform 已经出来了，但咱们说实话——它还没到那种谁都能直接拿来跑生产环境的程度。你现在入坑，赌的是未来。</p>
<hr/>
<h3 data-id="heading-6">代码大对决（动真格的了）</h3>
<p>来看看这段让我直呼“好家伙”的部分：在三套框架里分别实现同一个 UseCase。</p>
<p><strong>Flutter (Dart)：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetUserProfileUseCase</span> </span>{
  <span class="hljs-keyword">final</span> UserRepository repository;
  
  GetUserProfileUseCase(<span class="hljs-keyword">this</span>.repository);
  
  Future&lt;Result&lt;UserProfile&gt;&gt; call(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> repository.getUserProfile(userId);
  }
}
</code></pre>
<p><strong>代码点评：</strong> 干净、简洁、异步优先。这个 <code>call()</code> 方法意味着你可以像调用函数一样直接运行它。这就是典型的 Dart 范儿（Dart vibes）。</p>
<p><strong>SwiftUI (Swift)：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">GetUserProfileUseCase</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UserProfile</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GetUserProfileUseCaseImpl</span>: <span class="hljs-title class_">GetUserProfileUseCase</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> repository: <span class="hljs-type">UserRepository</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">repository</span>: <span class="hljs-type">UserRepository</span>) {
        <span class="hljs-keyword">self</span>.repository <span class="hljs-operator">=</span> repository
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UserProfile</span> {
        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> repository.getUserProfile(userId: userId)
    }
}
</code></pre>
<p>这个 <code>async throws</code> 写法简直美如画。Swift 的类型安全机制强得惊人，但同时也意味着会有更多模板代码（Boilerplate）。就看你更中意哪一个了（Pick your poison）。</p>
<p><strong>Compose (Kotlin)：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GetUserProfileUseCase</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) {
    <span class="hljs-keyword">suspend</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invoke</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: Result&lt;UserProfile&gt; {
        <span class="hljs-keyword">return</span> repository.getUserProfile(userId)
    }
}
</code></pre>
<p>那个 <code>operator fun invoke</code>？简直是<strong>神来之笔（Chef's kiss）</strong> 。Kotlin 的简洁性让我的大脑极其舒适。再加上 Hilt 的 <code>@Inject</code>，依赖注入这件事变得像呼吸一样自然。</p>
<h4 data-id="heading-7">诚实豆沙包：到底什么才重要？</h4>
<p>在把同一个功能写了三遍之后，我总结出了一些能真正帮你做决定的建议：</p>
<ul>
<li>
<p><strong>选 Flutter，如果：</strong></p>
<ul>
<li>你需要快速推向多个平台。</li>
<li>你的团队懂 Dart（或者愿意学点新东西）。</li>
<li>你把开发体验和热重载（Hot Reload）看作生命线。</li>
<li>你在搞创业，恨不得昨天就能把 iOS + 安卓 + Web 版全上线。</li>
<li>你不介意 Dart 的生态没有 Swift/Kotlin 那么“国民级”。</li>
</ul>
</li>
<li>
<p><strong>选 SwiftUI，如果：</strong></p>
<ul>
<li>你只打算在苹果的生态里混。</li>
<li>你追求极致的 iOS 原生质感和性能。</li>
<li>你的团队已经是 Swift 老手了。</li>
<li>你爱“类型安全”胜过爱你的家人。</li>
<li>你能接受最低系统要求是 iOS 14+（那些老机型用户只能说声抱歉了）。</li>
</ul>
</li>
<li>
<p><strong>选 Compose，如果：</strong></p>
<ul>
<li>你是安卓优先（或者目前只做安卓）。</li>
<li>你的团队是 Kotlin 死忠粉。</li>
<li>你想逃离 XML 布局的“创伤”，拥抱现代安卓开发。</li>
<li>你愿意在 Compose Multiplatform 的未来上赌一把。</li>
<li>你非常心水 Material Design 3 那种丝滑的集成感。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">聊聊性能（毕竟总有人爱问这个）</h4>
<p>说句实在话：<strong>对于 90% 的应用来说，性能差异几乎可以忽略不计。</strong> 你的用户发现不了，你的老板发现不了。甚至你自己也发现不了——除非你在写什么极其复杂的玩意儿。</p>
<p>但既然要比，那就拆开说：</p>
<ul>
<li><strong>Flutter：</strong> 编译成原生代码。快，丝滑的 60fps。Skia 渲染引擎已经经受了时间的考验。</li>
<li><strong>SwiftUI：</strong> iOS 亲儿子。快。有时候在优化上显得“聪明过头”了（没错，说的就是那些神秘的视图更新逻辑）。</li>
<li><strong>Compose：</strong> 安卓亲儿子。快。Kotlin 的运行时已经非常成熟且经过深度优化。 <strong>真正的性能瓶颈通常出在你的代码上，而不是框架。</strong> 很扎心，但这是事实。</li>
</ul>
<h4 data-id="heading-9">开发体验（DX）的真相</h4>
<p>有一点没人会告诉你：对于大多数项目来说，<strong>开发体验（DX）比原始性能更重要。</strong></p>
<ul>
<li><strong>Flutter 赢在：</strong> 热重载速度（真的，快到没朋友）、跨平台的一致性、极其丰富的插件生态（pub.dev 是座宝库）、文档质量（Flutter 的文档堪称行业标杆）。</li>
<li><strong>SwiftUI 赢在：</strong> IDE 集成度（Xcode 虽有槽点，但它是为 Swift 而生的）、类型安全和编译时纠错、Xcode Previews 预览（只要它不抽风）。</li>
<li><strong>Compose 赢在：</strong> Kotlin 强大的语言特性、Android Studio 的深度整合、Material Design 的官方实现、以及那种“终于永远删掉 XML 文件”的解脱感。</li>
</ul>
<h4 data-id="heading-10">社区现状（这关乎你的饭碗）</h4>
<p>聊聊找工作和社区，毕竟大家都要吃饭：</p>
<ul>
<li><strong>Flutter 岗位：</strong> 增长极快。初创公司最爱，大厂也在观望。社区极其活跃且乐于助人。FlutterFlow 甚至让很多不写代码的人也开始入坑了。</li>
<li><strong>SwiftUI 岗位：</strong> 在专注于苹果生态的公司里非常稳。想进大厂做 iOS，SwiftUI 是必修课。薪资普遍偏高，因为 iOS 开发一直自带溢价。</li>
<li><strong>Compose 岗位：</strong> 现在的安卓岗位几乎都要求会 Compose。如果你精通 Compose，你就是安卓职场上的“独角兽”。各家公司都在从 XML 迁移，急需大腿。</li>
</ul>
<h4 data-id="heading-11">我的真心推荐（我知道你们都在等这一段）</h4>
<p>如果明天要开个新项目，只能<strong>选一个</strong>？</p>
<p><strong>我会选 Flutter。</strong> 在 SwiftUI/Compose 的粉丝开喷之前，听我解释： 一套代码搞定 iOS、安卓和 Web，这个价值实在太诱人了。它的开发体验始终如一地出色，社区充满活力，插件生态也已经熟透了。说真的，光是一个“热重载”省下来的时间，就足以抵消学习 Dart 的成本了。</p>
<p><strong>但是（划重点）：</strong></p>
<ul>
<li>如果你<strong>只给 iOS 写 App</strong>？选 SwiftUI，别犹豫。</li>
<li>如果你<strong>只给安卓写 App</strong>？选 Compose，冲就完了。</li>
<li>如果你是在<strong>现有的原生 App</strong> 上修修补补？老老实实守着原有的技术栈。</li>
</ul>
<h4 data-id="heading-12">关于架构的惊喜</h4>
<p>有一点挺出乎意料：<strong>Clean Architecture 在 Kotlin/Compose 里感觉最自然。</strong> Kotlin 的语言特性（密封类、协程、数据类）跟整洁架构原则简直是天作之合。Flutter 紧随其后。而 SwiftUI 则需要你跟协议（Protocols）和类型系统进行最多的“搏斗”。 但核心结论是：<strong>这三者都能完美适配架构。</strong> 这种原则是超越框架的，不管你写的是 Dart、Swift 还是 Kotlin，你的领域层（Domain Layer）看起来都应该差不多。</p>
<h4 data-id="heading-13">这对你意味着什么？</h4>
<p>能看到这儿，你不是在摸鱼，就是真的感兴趣（或者两者都有，我懂，我也经常这样）。</p>
<p>基于这次实验，我的建议是：</p>
<ul>
<li><strong>如果你是学生/新人：</strong> 学 <strong>Flutter</strong>。练好 Dart，多动手做东西，发布到多个平台。攒一个能证明你具备“交付产品能力”的作品集。这种跨平台能力会让初创公司对你垂青有加。</li>
<li><strong>如果你是 iOS 开发：</strong> 还没学 <strong>SwiftUI</strong> 的赶紧学。但也建议你在业余项目里试试 Flutter，感受一下跨平台到底在火什么。</li>
<li><strong>如果你是安卓开发：</strong> 搞定 <strong>Compose</strong>。同时盯着点 Compose Multiplatform。未来的发展会非常有趣。</li>
<li><strong>如果你是做决策的技术 Leader：</strong> 看看你团队的技能树、项目工期和目标平台。其实选这三个里的任何一个都能做出成功的 App。<strong>框架选型的重要性，远不如团队的执行力重要。</strong></li>
</ul>
<h4 data-id="heading-14">那些让我彻夜难眠的坑</h4>
<p>分享几个我踩过的坑，希望能帮你省下几个小时：</p>
<ol>
<li><strong>状态管理：</strong> 三个框架各有 47 种管理状态的方法。我最后选了 Provider (Flutter), Observable/Combine (SwiftUI) 和 ViewModel (Compose)。都行得通，但也各有各的小脾气。</li>
<li><strong>导航：</strong> Flutter 的路由很直观；SwiftUI 的 NavigationStack 现在好多了，但以前真是折磨；Compose 的 Navigation 组件很稳，就是代码有点啰嗦。</li>
<li><strong>测试：</strong> 都支持测试，但 Flutter 的 Widget Testing 感觉最成熟。SwiftUI 的预览测试很酷。Compose 的测试最全面，但配置起来稍麻烦。</li>
</ol>
<h4 data-id="heading-15">最后的一点感言</h4>
<p>说到底，这些都只是工具。<strong>你用它们造出了什么，才最重要。</strong></p>
<p>我见过这三个框架分别写出的惊艳 App，也见过三个框架分别写出的垃圾。框架不能决定 App 的好坏，<strong>你才能。</strong></p>
<p>选一个，深挖下去。做个让人惊艳的东西。然后再去学下一个，或者干脆不学，都没问题。这里没有标准答案。</p>
<h4 data-id="heading-16">轮到你了（该你发言了）</h4>
<p>来，咱们评论区见：</p>
<ul>
<li><strong>你是 Flutter 铁粉？</strong> 用它做出了赚钱的项目？来分享一下你的故事，社区需要真实的回馈。</li>
<li><strong>刚入坑移动开发？</strong> 随便问，这里的社区氛围很友好。</li>
<li><strong>职场老司机？</strong> 传授点面试经验。你招人时最看重什么技能？</li>
<li><strong>遇到瓶颈了？</strong> 把你的烦心事说出来，没准儿评论区就有大神帮过你解决了。</li>
</ul>
<p>无论你是刚起步，还是已经发布过 10 个 App 的 Flutter 大佬——你都很棒。继续写码，继续学习。你的下一个 App 没准儿就能改变世界。</p>
<p><strong>致所有的移动开发者：</strong> 给刚入行的新人留句鼓励的话吧。大家都经历过萌新阶段，让这个圈子更温暖一点。</p>
<h4 data-id="heading-17">最后一句话</h4>
<p>我花了 72 小时做这个对比，就是为了让你不用再纠结。不管你是 Flutter 党、SwiftUI 党还是 Compose 党，我们其实都在干同一件事：做点酷的东西，让别人觉得好用。</p>
<p><strong>选好你的框架。写出整洁的代码。发布你的 App。无视那些喷子。</strong> 记住：<strong>最好的框架，是那个能让你真正把项目做完的框架。</strong></p>
<p>别看了，快去写代码吧！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21虚拟线程实战：从百万级并发瓶颈到性能提升300%的架构演进]]></title>    <link>https://juejin.cn/post/7589170021931843599</link>    <guid>https://juejin.cn/post/7589170021931843599</guid>    <pubDate>2025-12-30T00:17:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589170021931843599" data-draft-id="7589110783147556898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21虚拟线程实战：从百万级并发瓶颈到性能提升300%的架构演进"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-30T00:17:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21虚拟线程实战：从百万级并发瓶颈到性能提升300%的架构演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:17:41.000Z" title="Tue Dec 30 2025 00:17:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 21虚拟线程实战：从百万级并发瓶颈到性能提升300%的架构演进</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在当今高并发的互联网时代，传统的线程模型已成为许多Java应用的性能瓶颈。随着Java 21的发布，虚拟线程（Virtual Threads）作为Project Loom的核心成果正式落地，为JVM并发编程带来了革命性的改变。本文将深入剖析虚拟线程的技术原理，结合真实场景下的百万级并发挑战，展示如何通过架构演进实现300%的性能提升。</p>
<hr/>
<h3 data-id="heading-2">一、传统线程模型的瓶颈</h3>
<h4 data-id="heading-3">1.1 平台线程的局限性</h4>
<p>Java长期以来依赖的平台线程（OS线程）存在两大硬伤：</p>
<ul>
<li><strong>资源消耗大</strong>：每个线程默认占用1MB栈内存，万级并发就需要GB级内存。</li>
<li><strong>上下文切换成本高</strong>：操作系统调度器需要处理线程切换，当竞争激烈时可能消耗30%以上的CPU时间。</li>
</ul>
<h4 data-id="heading-4">1.2 典型问题场景</h4>
<p>在某电商平台的秒杀系统中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 达到OS线程数上限</span>
</code></pre>
<p>即便使用异步编程（如CompletableFuture），回调地狱和调试困难问题依然存在。</p>
<hr/>
<h3 data-id="heading-5">二、虚拟线程的技术突破</h3>
<h4 data-id="heading-6">2.1 JVM层面的协程实现</h4>
<p>虚拟线程的本质是<strong>由JVM管理的轻量级用户态线程</strong>：</p>
<ul>
<li><strong>1:1调度模型</strong>：M个虚拟线程运行在N个平台线程上（M &gt;&gt; N）</li>
<li><strong>挂起/恢复由JVM控制</strong>：通过Continuation实现执行流的保存与恢复</li>
</ul>
<h4 data-id="heading-7">2.2 关键性能指标对比</h4>

























<table><thead><tr><th>指标</th><th>平台线程</th><th>虚拟线程</th></tr></thead><tbody><tr><td>创建时间</td><td>~1ms</td><td>~0.01ms</td></tr><tr><td>内存占用</td><td>~1MB</td><td>~200KB</td></tr><tr><td>上下文切换成本</td><td>OS调度</td><td>JVM优化</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">三、实战：百万并发架构演进</h3>
<h4 data-id="heading-9">3.1 原始架构痛点分析</h4>
<p>某金融交易系统原有设计：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Blocking I/O + Thread-per-request</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">8080</span>)) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-type">var</span> <span class="hljs-variable">clientSocket</span> <span class="hljs-operator">=</span> socket.accept();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; handleRequest(clientSocket)).start(); <span class="hljs-comment">// ❌ OOM风险</span>
    }
}
</code></pre>
<p>实测数据：8000并发时延迟飙升到5s+，CPU利用率仅40%。</p>
<h4 data-id="heading-10">3.2 迁移到虚拟线程的三阶段</h4>
<h5 data-id="heading-11"><strong>阶段一：直接替换</strong></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-type">var</span> <span class="hljs-variable">clientSocket</span> <span class="hljs-operator">=</span> socket.accept();
        executor.submit(() -&gt; handleRequest(clientSocket)); <span class="hljs-comment">// ✅</span>
    }
}
</code></pre>
<p>效果：支持10万并发连接，内存消耗降低87%。</p>
<h5 data-id="heading-12"><strong>阶段二：结构化并发</strong></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {
    Future&lt;String&gt; user = scope.fork(() -&gt; queryUser(userId));
    Future&lt;Order&gt; order = scope.fork(() -&gt; queryOrder(orderId));
    scope.join();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(user.get(), order.get());
}
</code></pre>
<p>优势：</p>
<ul>
<li><strong>强化的错误传播</strong></li>
<li><strong>取消语义自动化</strong></li>
</ul>
<h5 data-id="heading-13"><strong>阶段三：全异步整合</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> result = virtualThreadScope {
    <span class="hljs-keyword">val</span> userDeferred = async { queryUser(userId) }
    <span class="hljs-keyword">val</span> orderDeferred = async { queryOrder(orderId) }
    UserOrderResponse(userDeferred.await(), orderDeferred.await())
}
</code></pre>
<h4 data-id="heading-14">3.3 Final性能对比</h4>




















<table><thead><tr><th>QPS</th><th>P99延迟</th><th>CPU利用率</th></tr></thead><tbody><tr><td>Before:12k</td><td>&gt;2s</td><td>≤50%</td></tr><tr><td>After:36k</td><td>~200ms</td><td>≥85%</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">四、深度优化实践</h3>
<h4 data-id="heading-16">4.1 Pinpoint陷阱规避</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span>(lockObj) { 
    <span class="hljs-comment">// ❌会pin住载体线程 </span>
}
</code></pre>
<p>解决方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
lock.lock(); <span class="hljs-comment">// ✅可通过jdk.tracePinnedThreads检测</span>
<span class="hljs-keyword">try</span> { <span class="hljs-comment">/* ... */</span> } <span class="hljs-keyword">finally</span> { lock.unlock(); }
</code></pre>
<h4 data-id="heading-17">4.2 Carrier Thread调优建议</h4>
<pre><code class="hljs language-bash" lang="bash">-Djdk.virtualThreadScheduler.parallelism=32 <span class="hljs-comment">#匹配物理核心数 </span>
-Djdk.virtualThreadScheduler.maxPoolSize=256
</code></pre>
<h4 data-id="heading-18">4.3 JFR监控增强</h4>
<p><img src="https://example.com/jfr-screenshot.png" alt="Virtual Threads in JDK Flight Recorder" loading="lazy"/></p>
<hr/>
<p>###五、适用场景与限制</p>
<p>####5.1黄金场景<br/>
✅计算密集型但包含阻塞操作<br/>
✅高并发I/O服务（HTTP/gRPC/DB访问）<br/>
✅需要简化异步代码的场景</p>
<p>####5.2不适用情况<br/>
❌纯CPU计算无阻塞操作<br/>
❌需要精细控制物理核心的任务</p>
<hr/>
<p>###六、未来展望<br/>
随着Java22对结构化并发的进一步强化，以及Valhalla项目带来的值类型支持，"每请求一个虚拟线程"可能成为新的服务端开发范式。建议关注：
1.Scoped Values（JEP429）替代ThreadLocal<br/>
2.Vector API与虚拟线程的协同优化</p>
<hr/>
<p>###总结<br/>
Java21虚拟 threads从根本上重构了JVM的并发模型。通过本文的真实案例可以看到，合理运用该特性能在保持同步编程模型直观性的同时，实现数量级的性能突破。技术团队现在就应该开始评估现有系统的适配改造路径——这已不仅是性能优化问题，更是关乎开发效率的革命性升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 一套代码适配车机/手机横竖屏？看我如何用搞定小米、比亚迪、蔚来、理想、多品牌架构设计]]></title>    <link>https://juejin.cn/post/7589126920286945290</link>    <guid>https://juejin.cn/post/7589126920286945290</guid>    <pubDate>2025-12-30T00:28:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286945290" data-draft-id="7588022226739101746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android   一套代码适配车机/手机横竖屏？看我如何用搞定小米、比亚迪、蔚来、理想、多品牌架构设计"/> <meta itemprop="keywords" content="Android,面试,前端"/> <meta itemprop="datePublished" content="2025-12-30T00:28:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android   一套代码适配车机/手机横竖屏？看我如何用搞定小米、比亚迪、蔚来、理想、多品牌架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:28:23.000Z" title="Tue Dec 30 2025 00:28:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.需求：(3种车机/手机UI切换)</h2>
<p>Android 新能源车机，手机竖屏，手机横屏3种情况的UI, 数据来源有多个，分不同的品牌，有小米，蔚来，理想，比亚迪，大部分相同，仅仅有一点差别</p>
<h2 data-id="heading-1">2.方案：(抽象工厂+策略模式)</h2>
<p>为了满足 <strong>Android 车机、手机竖屏、手机横屏</strong> 三种 UI 场景下使用 <strong>同一份数据源（DataManager）</strong> ，且 <strong>不同品牌间数据结构基本一致、仅少量差异</strong> 的需求，我们可以采用以下设计原则：</p>
<ul>
<li><strong>单一数据源</strong>：<code>DataManager</code> 提供统一接口。</li>
<li><strong>策略模式 / 工厂模式</strong>：根据设备类型和品牌动态提供适配器或视图模型。</li>
<li><strong>低耦合 + 高扩展性</strong>：UI 层不直接依赖具体品牌逻辑，而是通过抽象接口获取数据。</li>
</ul>
<p>根据需求，这里采用MVP模式+抽象工厂+策略模式来处理不同品牌和设备的UI差异：</p>
<h2 data-id="heading-2">3.架构图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3940ed6e2e9045bd8e0396a1e09b0aff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659302&amp;x-signature=O988NSBMuIlX1MSL6jcAFLFu%2FKo%3D" alt="车机和手机.png" loading="lazy"/></p>
<h2 data-id="heading-3">4.主要的代码</h2>
<p>因为公司的保密问题，把核心的思想分析成一个demo！如下：</p>
<h4 data-id="heading-4">🔹 数据层：统一接口</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 品牌数据统一接口（IBrandData）
 * 所有新能源汽车品牌必须实现此接口，保证上层调用一致性
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBrandData</span> {
    <span class="hljs-function">String <span class="hljs-title">getCommonField</span>()</span>;        <span class="hljs-comment">// 通用信息（如续航、车型）</span>
    <span class="hljs-function">String <span class="hljs-title">getBrandSpecificField</span>()</span>; <span class="hljs-comment">// 品牌特有功能（如换电、生态互联等）</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-5">🚗 数据层实现：四个品牌（小米、蔚来、理想、比亚迪）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/** 小米汽车数据 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">XiaomiBrandData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBrandData</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCommonField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"小米SU7 通用信息：800V高压平台，CLTC续航800km"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getBrandSpecificField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"小米澎湃OS生态互联：手机-车机无缝流转"</span>;
    }
}

<span class="hljs-comment">/** 蔚来汽车数据 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NIOBrandData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBrandData</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCommonField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"蔚来ET5 通用信息：双电机四驱，换电兼容"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getBrandSpecificField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"蔚来换电站 + NOMI智能情感引擎"</span>;
    }
}

<span class="hljs-comment">/** 理想汽车数据 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LiAutoBrandData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBrandData</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCommonField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"理想L系列 通用信息：家庭六座SUV，增程电动"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getBrandSpecificField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"城市NOA + 增程式无里程焦虑"</span>;
    }
}

<span class="hljs-comment">/** 比亚迪汽车数据 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BYDBrandData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBrandData</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCommonField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"比亚迪汉EV 通用信息：刀片电池，e平台3.0"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getBrandSpecificField</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"云辇智能车身控制系统 + DiLink生态"</span>;
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-6">📱 设备类型 &amp; UI 策略（保持不变，仅微调注释）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 设备类型枚举：用于区分 UI 渲染上下文
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> DeviceType {
    CAR,                <span class="hljs-comment">// 车载中控（大屏、驾驶安全优先）</span>
    PHONE_PORTRAIT,     <span class="hljs-comment">// 手机竖屏（信息精简）</span>
    PHONE_LANDSCAPE     <span class="hljs-comment">// 手机横屏（信息完整展示）</span>
}

<span class="hljs-comment">/**
 * UI 渲染策略接口：不同设备使用不同展示逻辑
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUiStrategy</span> {
    void render(IBrandData <span class="hljs-keyword">data</span>);
}

<span class="hljs-comment">// 具体策略实现（略，同你原有代码，仅接口名改为 IBrandData）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CarUiStrategy</span> <span class="hljs-title">implements</span> <span class="hljs-title">IUiStrategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void render(IBrandData <span class="hljs-keyword">data</span>) {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"[CAR] "</span> + <span class="hljs-keyword">data</span>.getCommonField() + <span class="hljs-string">" | "</span> + <span class="hljs-keyword">data</span>.getBrandSpecificField());
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhonePortraitStrategy</span> <span class="hljs-title">implements</span> <span class="hljs-title">IUiStrategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void render(IBrandData <span class="hljs-keyword">data</span>) {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"[PHONE-PORTRAIT] "</span> + <span class="hljs-keyword">data</span>.getCommonField());
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneLandscapeStrategy</span> <span class="hljs-title">implements</span> <span class="hljs-title">IUiStrategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void render(IBrandData <span class="hljs-keyword">data</span>) {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"[PHONE-LANDSCAPE] "</span> + <span class="hljs-keyword">data</span>.getCommonField() + <span class="hljs-string">" + "</span> + <span class="hljs-keyword">data</span>.getBrandSpecificField());
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-7">🧩 数据管理器（DataManager）—— 支持四大品牌</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.function.Supplier;

<span class="hljs-comment">/**
 * 数据管理器：统一入口，按品牌返回对应数据
 * 使用工厂注册机制，支持动态扩展
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Supplier&lt;IBrandData&gt;&gt; BRAND_FACTORY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">static</span> {
        BRAND_FACTORY.put(<span class="hljs-string">"xiaomi"</span>, XiaomiBrandData::<span class="hljs-keyword">new</span>);
        BRAND_FACTORY.put(<span class="hljs-string">"nio"</span>, NIOBrandData::<span class="hljs-keyword">new</span>);
        BRAND_FACTORY.put(<span class="hljs-string">"liauto"</span>, LiAutoBrandData::<span class="hljs-keyword">new</span>);
        BRAND_FACTORY.put(<span class="hljs-string">"byd"</span>, BYDBrandData::<span class="hljs-keyword">new</span>); <span class="hljs-comment">// ✅ 新增比亚迪</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String brand;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataManager</span><span class="hljs-params">(String brand)</span> {
        <span class="hljs-built_in">this</span>.brand = brand.toLowerCase();
    }

    <span class="hljs-keyword">public</span> IBrandData <span class="hljs-title function_">getBrandData</span><span class="hljs-params">()</span> {
        Supplier&lt;IBrandData&gt; factory = BRAND_FACTORY.get(brand);
        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的品牌: "</span> + brand + <span class="hljs-string">"。支持: "</span> + BRAND_FACTORY.keySet());
        }
        <span class="hljs-keyword">return</span> factory.get();
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-8">🔗 UI 协调器（核心适配器）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * UI 协调器：组合品牌数据 + 设备策略
 * 是 MVP 中 Presenter 层的理想载体
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiCoordinator</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataManager dataManager;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IUiStrategy uiStrategy;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UiCoordinator</span><span class="hljs-params">(<span class="hljs-type">String</span> brand, DeviceType deviceType)</span> </span>{
        <span class="hljs-keyword">this</span>.dataManager = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataManager</span>(brand);
        <span class="hljs-keyword">this</span>.uiStrategy = <span class="hljs-built_in">createStrategy</span>(deviceType);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> IUiStrategy <span class="hljs-title">createStrategy</span><span class="hljs-params">(DeviceType type)</span> </span>{
        <span class="hljs-keyword">switch</span> (type) {
            <span class="hljs-keyword">case</span> CAR: <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">CarUiStrategy</span>();
            <span class="hljs-keyword">case</span> PHONE_PORTRAIT: <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">PhonePortraitStrategy</span>();
            <span class="hljs-keyword">case</span> PHONE_LANDSCAPE: <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">PhoneLandscapeStrategy</span>();
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalStateException</span>(<span class="hljs-string">"未知设备类型: "</span> + type);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">display</span><span class="hljs-params">()</span> </span>{
        IBrandData data = dataManager.<span class="hljs-built_in">getBrandData</span>();
        uiStrategy.<span class="hljs-built_in">render</span>(data);
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-9">🖥️ 主程序（测试入口）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">String</span>[] brands = {<span class="hljs-string">"xiaomi"</span>, <span class="hljs-string">"nio"</span>, <span class="hljs-string">"liauto"</span>, <span class="hljs-string">"byd"</span>}; <span class="hljs-comment">// ✅ 包含比亚迪，不含小鹏</span>
        <span class="hljs-title class_">DeviceType</span>[] devices = {<span class="hljs-title class_">DeviceType</span>.<span class="hljs-property">CAR</span>, <span class="hljs-title class_">DeviceType</span>.<span class="hljs-property">PHONE_PORTRAIT</span>, <span class="hljs-title class_">DeviceType</span>.<span class="hljs-property">PHONE_LANDSCAPE</span>};

        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> brand : brands) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"🔹 品牌: "</span> + brand.<span class="hljs-title function_">toUpperCase</span>());
            <span class="hljs-keyword">for</span> (<span class="hljs-title class_">DeviceType</span> device : devices) {
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">UiCoordinator</span>(brand, device).<span class="hljs-title function_">display</span>();
            }
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">✅ 最终架构图</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">---------------------+</span>
<span class="hljs-operator">|</span>   UI 展示层 (<span class="hljs-keyword">View</span>)  <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> Activity<span class="hljs-operator">/</span>Fragment <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> 根据配置调用      <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>   UiCoordinator     <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+----------+</span>
           <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------v----------+</span>
<span class="hljs-operator">|</span>  适配层 (Presenter) <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> UiCoordinator     <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> IUiStrategy       <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> DeviceType        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+----------+</span>
           <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------v----------+</span>
<span class="hljs-operator">|</span>    数据层 (Model)   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> DataManager       <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> IBrandData        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-operator">-</span> Xiaomi<span class="hljs-operator">/</span>NIO<span class="hljs-operator">/</span>Li<span class="hljs-operator">/</span>BYD <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------------------+</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">5 .设计要点说明总结：</h2>



































<table><thead><tr><th>特性</th><th>实现方式</th><th>优势</th></tr></thead><tbody><tr><td><strong>品牌扩展</strong></td><td><code>BRAND_FACTORY</code> 注册</td><td>新增品牌只需加一行</td></tr><tr><td><strong>设备适配</strong></td><td><code>DeviceType</code> + 策略模式</td><td>横竖屏/车机自动切换</td></tr><tr><td><strong>低耦合</strong></td><td>全程依赖接口（<code>IBrandData</code>, <code>IUiStrategy</code>）</td><td>易测试、易替换</td></tr><tr><td><strong>MVP友好</strong></td><td><code>UiCoordinator</code> ≈ Presenter</td><td>业务逻辑与 View 分离</td></tr><tr><td><strong>健壮性</strong></td><td>非法品牌抛出明确异常</td><td>快速定位配置错误</td></tr></tbody></table>
<ol>
<li>
<p><strong>数据层</strong>：</p>
<ul>
<li><code>DataManager</code>单例管理数据，通过策略模式处理品牌差异</li>
<li><code>IBrandDataStrategy</code>接口允许灵活扩展新品牌</li>
</ul>
</li>
<li>
<p><strong>UI层</strong>：</p>
<ul>
<li>抽象工厂模式创建不同设备类型的视图</li>
<li>每种设备类型有基类视图，品牌再继承实现差异</li>
<li>支持屏幕旋转自动适配</li>
</ul>
</li>
<li>
<p><strong>业务层</strong>：</p>
<ul>
<li>MVP模式分离业务逻辑</li>
<li>不同设备类型可有特定Presenter</li>
</ul>
</li>
<li>
<p><strong>扩展性</strong>：</p>
<ul>
<li>新增品牌：实现<code>IBrandDataStrategy</code>和<code>IUIFactory</code></li>
<li>新增设备类型：添加<code>DeviceType</code>枚举和对应视图</li>
<li>数据变化：观察者模式通知更新</li>
</ul>
</li>
<li>
<p><strong>低耦合</strong>：</p>
<ul>
<li>依赖接口而非实现</li>
<li>各层之间通过接口通信</li>
<li>配置集中管理</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">5.2  设计模式应用总结</h3>
<h4 data-id="heading-13">5.2.1. 策略模式 (Strategy Pattern)</h4>
<ul>
<li><strong>应用</strong>: <code>IUiStrategy</code> 接口 + 具体策略类</li>
<li><strong>目的</strong>: 根据不同设备类型切换UI渲染逻辑</li>
<li><strong>优势</strong>: 易于扩展新设备类型，符合开闭原则</li>
</ul>
<h4 data-id="heading-14">5.2.2. 工厂模式 (Factory Pattern)</h4>
<ul>
<li><strong>应用</strong>: <code>DataManager</code> 中的品牌工厂注册表</li>
<li><strong>目的</strong>: 统一创建品牌数据对象</li>
<li><strong>优势</strong>: 集中管理对象创建，支持动态注册</li>
</ul>
<h4 data-id="heading-15">5.2.3. 接口隔离原则 (Interface Segregation)</h4>
<ul>
<li><strong>应用</strong>: <code>IBrandData</code> 只定义必要方法</li>
<li><strong>目的</strong>: 品牌实现类只实现需要的方法</li>
<li><strong>优势</strong>: 避免接口臃肿，提高灵活性</li>
</ul>
<h4 data-id="heading-16">5.2.4. 依赖倒置原则 (Dependency Inversion)</h4>
<ul>
<li><strong>应用</strong>: 高层模块依赖抽象接口而非具体实现</li>
<li><strong>目的</strong>: 降低模块间耦合度</li>
<li><strong>优势</strong>: 提高代码可测试性和可维护性</li>
</ul>
<p>这个架构支持灵活扩展新品牌和设备类型，同时保持代码的可维护性和可测试性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我把微信读书年度报告扔给AI，AI挖掘出了我不为人知的一面]]></title>    <link>https://juejin.cn/post/7589171972446289962</link>    <guid>https://juejin.cn/post/7589171972446289962</guid>    <pubDate>2025-12-30T00:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589171972446289962" data-draft-id="7589176150493036598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我把微信读书年度报告扔给AI，AI挖掘出了我不为人知的一面"/> <meta itemprop="keywords" content="程序员,AI编程"/> <meta itemprop="datePublished" content="2025-12-30T00:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古时的风筝"/> <meta itemprop="url" content="https://juejin.cn/user/501033035374045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我把微信读书年度报告扔给AI，AI挖掘出了我不为人知的一面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035374045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古时的风筝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:33:42.000Z" title="Tue Dec 30 2025 00:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🍄  <strong>大家好，我是风筝</strong></p>
<p>🌍 个人博客：【<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moonkite.cn" target="_blank" title="https://www.moonkite.cn" ref="nofollow noopener noreferrer">古时的风筝</a>】。</p>
<p>本文目的为个人学习记录及知识分享。如果有什么不正确、不严谨的地方请及时指正，不胜感激。</p>
<p>每一个赞都是我前进的动力。</p>
</blockquote>
<p>微信读书可能是我唯一一款连续订阅年度会员的应用，就为了微信读书App，还专门买了个汉王阅读器。</p>
<p>可惜买了之后基本没用过。为啥呢？因为听书的时间超过读书了。</p>
<p>坐地铁、做饭、刷碗是我的三大高频听书场景。</p>
<p>这不一年马上又过去了吗，又到了年终撤回年初立的flag的时候了，微信读书也发布了年度读书报告。</p>
<p>赶紧上去看一眼，这一年到底读了个啥。（现在打开微信读书APP在首页就能看到）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed8497db48e5409c90db5edbc311d8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5pe255qE6aOO562d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659622&amp;x-signature=HIJxD82UCRS1sFqdq6zs4AXNUqI%3D" alt="" loading="lazy"/></p>
<p>好家伙，读了116本，读完了4本，写了3条笔记，怪不得AI说我极度功利呢，确实大部分是工具书。</p>
<p>但是也得自证一下，读完4本倒是不至于，这是因为微信读书关于“读完”的统计，只有读到了最后一页，出现“读完了”页面，或者手动点“读完了”才被算作是读完。</p>
<p>但是不爱记笔记是真的。</p>
<p>说回年度报告，我觉得这个报告不够深刻，所以我决定交给 AI 帮我深度挖掘一下，看能不能挖出什么狠料。</p>
<p>于是我写了一套提示词，让AI从经济学、心理学、哲学、文学角度帮我挖掘一下我的这种读书方式和读书内容背后，藏着什么更深层次的东西。</p>
<p>并请教孔子和亚里士多德这两位中西方的大文豪，问一问他们对我有什么评价和建议。</p>
<p>下面是完整的提示词，那么如何使用呢？</p>
<p>因为微信读书报告没办法直接读取，所以只能截图，把每一页都截下来，然后从第3页开始（前两页用处不大），一直截取10张。</p>
<p>把这10张图和下面的提示词发给大模型。</p>
<p>我是自己是用的 Gemini，其他大模型也没什么 问题。</p>
<p>如果你也用 Gemini 的话，我做好了一个 Gem，可以通过下面的链接直接访问，上传10张图片，然后点击发送按钮就可以直接出报告了。</p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fgem%2F1Qvzi5XEQqmd2Q7cB9Ub0XEoM9HaIitBd%3Fusp%3Dsharing" target="_blank" title="https://gemini.google.com/gem/1Qvzi5XEQqmd2Q7cB9Ub0XEoM9HaIitBd?usp=sharing" ref="nofollow noopener noreferrer">gemini.google.com/gem/1Qvzi5X…</a></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"profile"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首席精神世界架构师 &amp; 跨学科人类观察员"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"identities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"行为经济学家"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"深度心理学家"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"存在主义哲学家"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"毒舌文学评论家"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"历史人物灵媒 (孔子 &amp; 亚里士多德)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tone"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一针见血、幽默犀利、智性浪漫"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"secondary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"古典与现代交织"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"objective"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"图片中我最近一年的年度阅读数据，基于这份报告，生成深度诊断报告及跨时空哲学点评。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"analysis_framework"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"step_1_data_extraction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提取关键数据（阅读量、完读率、时长、特殊时间点）。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"step_2_behavioral_economics"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析阅读习惯背后的ROI逻辑。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"step_3_psychological_profiling"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通过书单与时间点推测内心状态。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"step_4_philosophical_review"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"模拟孔子与亚里士多德的思维方式，对用户的精神状态进行高维点评。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"step_5_synthesis"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"生成年度判词与书单。"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"output_structure"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Markdown"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sections"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"intro"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🎯 核心定调：年度关键词"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"macro_analysis"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🏛️ 宏观数据画像"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"timeline_analysis"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🧠 时间轴心理侧写"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_insight"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 深度好玩儿的洞察"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"philosophical_dialogue"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📜 跨时空新年寄语：圣贤的审视"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"confucius"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"扮演孔子。关注'学与思'的关系、修身养性、以及读书是否为了'仁'。用半文半白的语调，点评用户的阅读焦虑与功利性，并给出君子之道的建议。"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"aristotle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"扮演亚里士多德。关注'理性'、'中道'与'幸福(Eudaimonia)'。点评用户的知识分类（物理/文学/商业），讨论这种阅读方式是否能达成人类的终极目的，强调理性与感性的平衡。"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"conclusion_recommendation"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"💡 年度总评与毒舌建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>AI 会全方面诊断，然后给出详细的报告。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd49b20af1f45a5b99f07e837d5a91e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5pe255qE6aOO562d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659622&amp;x-signature=7FRpGxL3ATzURvrI%2FsFOYC4PdDo%3D" alt="" loading="lazy"/></p>
<p>还可以让AI给出一份详细的2026年书单。</p>
<p>我的报告一出来，AI说我这一年是做了一个“宏大的烂尾工程”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc8f7a2ee2346d09e056646e7ae9510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5pe255qE6aOO562d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659622&amp;x-signature=r1kkbh%2FzK4s6unRGS5rFvTY1iHk%3D" alt="" loading="lazy"/></p>
<p><strong>孔子和亚里士多德也给了我诚恳的忠告，孔夫子劝我“韦编三绝”，不必贪多。</strong></p>
<p><strong>亚里士多德让我去释放激情，切身体会。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec5878a154df426b8b73d1cdc3f4308c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5pe255qE6aOO562d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659622&amp;x-signature=uRpPUye3q73dkk22ZKdfKkF9nF0%3D" alt="" loading="lazy"/></p>
<p>AI给我的年度判词是：</p>
<blockquote>
<p>一个用理性铠甲把自己武装到牙齿，却在深夜通过文学作品偷偷流泪的矛盾综合体。你试图看透这个世界的底牌（物理、历史、脑科学），却依然被这世界最朴素的情感（生死、人生）所牵绊。</p>
</blockquote>
<p>另外，<strong>还可以用下面这个提示词，将报告做成一份可视化的网页。</strong></p>
<blockquote>
<p>将以上2025年度阅读诊断报告做成一个和报告一一对应的、详细的可视化网页分析报告，一一展现，不要遗漏</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdbb3a4fb7744285ba2ddc773c8f27da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5pe255qE6aOO562d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659622&amp;x-signature=SIhP14YaRd9f6N%2BvP8JfE5QGh2k%3D" alt="" loading="lazy"/></p>
<p><strong>苏格拉底留下的千古难题：“认识你自己”。</strong></p>
<p>我们曾试图通过阅读、旅行和生活去拼凑答案。</p>
<p>而现在，有了AI ，可以站在全知的旁观者角度，帮我们挖掘更深层的自己，虽然不可能完全正确。</p>
<p>当你看着这份报告，看着那个被AI刻画的“一部分自己”，可能你沉睡已久的某个部分会被突然击中，甚至被点亮。</p>
<p>去试试吧，也许你会和我一样，在屏幕前惊呼：原来如此！又或者不屑地说：什么玩意！</p>
<p>不重要了。</p>
<p><strong>还可以看看风筝往期文章</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449474176%26idx%3D1%26sn%3D6b14e61551641921e3ad9fb17b6dcde0%26chksm%3D8c434ce7bb34c5f1f8aad31bb537aed5ba068773583ec17020770a919b75462f0aa1dc21a5ab%26token%3D1083800749%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449474176&amp;idx=1&amp;sn=6b14e61551641921e3ad9fb17b6dcde0&amp;chksm=8c434ce7bb34c5f1f8aad31bb537aed5ba068773583ec17020770a919b75462f0aa1dc21a5ab&amp;token=1083800749&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">用这个方法，免费、无限期使用 SSL(HTTPS)证书，从此实现证书自由了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4cJ3g1GlenQJ9UifyXH0Kg" target="_blank" title="https://mp.weixin.qq.com/s/4cJ3g1GlenQJ9UifyXH0Kg" ref="nofollow noopener noreferrer">为什么我每天都记笔记，主要是因为我用的这个笔记软件太强大了，强烈建议你也用起来</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449472490%26idx%3D1%26sn%3Dda10b436d1f8123149316dac76a618aa%26chksm%3D8fbcb58db8cb3c9ba481b7d095966abb86ff7d1a45a771aad191991db65cd6e384a557a40ec4%26token%3D1977984185%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449472490&amp;idx=1&amp;sn=da10b436d1f8123149316dac76a618aa&amp;chksm=8fbcb58db8cb3c9ba481b7d095966abb86ff7d1a45a771aad191991db65cd6e384a557a40ec4&amp;token=1977984185&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">「差生文具多系列」最好看的编程字体</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449473008%26idx%3D1%26sn%3Dc8f8d9c9675571ea1a42c13b1af9b6e7%26chksm%3D8fbcb397b8cb3a81f3c6c55eb398c0599128f18b9bbdae87965cd40ef519dad3394649426d1e%26token%3D1044263965%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449473008&amp;idx=1&amp;sn=c8f8d9c9675571ea1a42c13b1af9b6e7&amp;chksm=8fbcb397b8cb3a81f3c6c55eb398c0599128f18b9bbdae87965cd40ef519dad3394649426d1e&amp;token=1044263965&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">我患上了空指针后遗症</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449473057%26idx%3D1%26sn%3D2170397d6bab5ad0a6d6427f77584df2%26chksm%3D8fbcb046b8cb3950d1784fe29bc7776cb0c71868acba36a47d60b41bc8a60959303082b0ee2a%26token%3D1977984185%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449473057&amp;idx=1&amp;sn=2170397d6bab5ad0a6d6427f77584df2&amp;chksm=8fbcb046b8cb3950d1784fe29bc7776cb0c71868acba36a47d60b41bc8a60959303082b0ee2a&amp;token=1977984185&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">一千个微服务之死</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449472966%26idx%3D1%26sn%3Da272a9df52ae18cc9a6163732b37c5d8%26chksm%3D8fbcb3a1b8cb3ab7857a88adc8a2e6d28bb6f2316df501f5f8e6fc487794f3b34f77829b4b94%26token%3D1977984185%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449472966&amp;idx=1&amp;sn=a272a9df52ae18cc9a6163732b37c5d8&amp;chksm=8fbcb3a1b8cb3ab7857a88adc8a2e6d28bb6f2316df501f5f8e6fc487794f3b34f77829b4b94&amp;token=1977984185&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">搭建静态网站竟然有这么多方案，而且还如此简单</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxMjA0MDk2OA%3D%3D%26mid%3D2449472616%26idx%3D1%26sn%3Da41a420933f9af7f88af0759eb75f815%26chksm%3D8fbcb20fb8cb3b1969433e2468523234552562e504f3a12c8c1a2a012cff7fd1422e6dd48723%26token%3D1977984185%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxMjA0MDk2OA==&amp;mid=2449472616&amp;idx=1&amp;sn=a41a420933f9af7f88af0759eb75f815&amp;chksm=8fbcb20fb8cb3b1969433e2468523234552562e504f3a12c8c1a2a012cff7fd1422e6dd48723&amp;token=1977984185&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">被人说 Lambda 代码像屎山，那是没用下面这三个方法</a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[凌晨两点磨锋芒 调试采坑莫慌张]]></title>    <link>https://juejin.cn/post/7589170021931892751</link>    <guid>https://juejin.cn/post/7589170021931892751</guid>    <pubDate>2025-12-30T00:30:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589170021931892751" data-draft-id="7589126217250848809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="凌晨两点磨锋芒 调试采坑莫慌张"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-30T00:30:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            凌晨两点磨锋芒 调试采坑莫慌张
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:30:12.000Z" title="Tue Dec 30 2025 00:30:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</p>
<h2 data-id="heading-0">七）调试采坑磨锋芒 临时转岗莫慌张</h2>
<p>清晨的阳光刚漫过西二旗的写字楼玻璃幕墙。</p>
<p>办公区还没完全热闹起来，晓雅、阿泽和博文三个实习生就簇拥着围在了老杨的工位旁。</p>
<p>三人手里都捧着笔记本电脑，屏幕上全是昨晚赶工的代码界面。</p>
<p>小安则站在一旁，双手交握在身前，眼神里满是掩饰不住的焦虑。</p>
<p>"杨哥杨哥，你帮我们看看这个！"</p>
<p>阿泽率先把电脑凑到老杨面前，语气里带着点急切。</p>
<p>“这是林哥临走前给我们布置的音乐播放功能练习，我打算用 <code>SparseArray</code> 优化数据存储，以 <code>int</code> 存歌曲ID当键，对应存储值就是歌曲名、歌手、播放时长这些信息的 <code>Song</code> 对象，遍历的时候用了 <code>keyAt</code> 和 <code>valueAt</code> 方法获取对应数据，你看这思路对不对？"</p>
<p>老杨扶了扶眼镜，指尖在阿泽的触控板上慢慢滑动，目光扫过代码。</p>
<p>"嗯，思路没问题。"</p>
<p>他顿了顿，继续说道："把歌曲ID和 <code>Song</code> 对象用 <code>SparseArray</code> 映射，比用 <code>HashMap</code> 存整数键省内存，还能避免自动装箱。"</p>
<p>老杨忽然停在一段遍历代码上，抬眼看向三人。</p>
<p>"你们看这里，阿泽用<code>size()</code> 做循环边界的时候，每次循环都调用了一次 <code>size()</code> 方法。"</p>
<p>"可以优化下，先把 <code>size</code> 存成局部变量再循环，减少方法调用开销。"</p>
<p>老杨话音刚落，一旁的小安轻轻咳嗽了两声，打断了几人的讨论。</p>
<p>"杨哥，打扰一下..."</p>
<p>"林卓他昨天被张磊叫走支援紧急项目，我问他他也说不出个所以然，你说会不会是出什么事了？"</p>
<p>老杨敲键盘的手指顿了顿。</p>
<p>他转身从抽屉里摸出袋速溶咖啡。</p>
<p>热水冲进搪瓷杯的瞬间，氤氲的热气模糊了镜片。</p>
<p>他的目光也随之飘远——那里仿佛浮现出十几年前中关村软件园的模样，灰扑扑的写字楼外，满是抱着电脑奔波的年轻人。</p>
<p>而他自己，正缩在淘一淘技术部的角落工位里，忐忑地等待着入职后的第一次任务分配。</p>
<p>"这在大厂再正常不过。"</p>
<p>老杨的声音带着几分悠远。</p>
<p>"我刚入职淘一淘那年，比林卓现在还慌。入职第三天就被拉去救急，连公司茶水间在哪都没摸清。"</p>
<p>博文推了推鼻梁上的眼镜。</p>
<p>他眼神里满是好奇："杨哥，你当年刚入职的时候，也遇到过这种突然被拉去支援紧急项目的情况吗？"</p>
<p>老杨抿了口热咖啡。</p>
<p>苦涩的味道唤醒了尘封的记忆。</p>
<p>......</p>
<p>时间回到十年前，老杨入职第三天。</p>
<p>......</p>
<p>那年的夏天格外闷热，淘一淘技术部的空调坏了两台，剩下的两台根本压不住满屋子电脑散发的热气。</p>
<p>每个人的工位旁都放着一瓶冰镇矿泉水，键盘上偶尔还能看到水珠滑落的痕迹。</p>
<p>"杨明，过来一下。"</p>
<p>技术总监王哥的声音在嘈杂的办公区里格外清晰。</p>
<p>老杨当时还叫本名，听到召唤立刻从工位上弹起来。</p>
<p>他手里还攥着刚打印的公司 Android 编码规范文档。</p>
<p>王哥的工位在办公区最内侧，周围堆着厚厚的项目资料。</p>
<p>屏幕上正显示着一段卡顿的列表动画——淘一淘的商品列表页，滑动时像被按了慢放键，每滑三行就会顿一下。</p>
<p>测试机的状态栏里，内存占用数字还在不断攀升。</p>
<p>"用户反馈炸了，"</p>
<p>王哥揉着通红的眼睛，把测试机扔给老杨。</p>
<p>"低内存机型上尤其明显，你去安卓组支援，先把这个卡顿问题解决了。"</p>
<p>他顿了顿，补充道："安卓组的人都被拉去做双十一预热活动了，这个坑你先填上。"</p>
<p>老杨接过测试机，手指都在发颤。</p>
<p>他大学期间虽然学过 Android 开发，但都是做些简单的<code>Demo</code>，哪里接触过真实的生产环境代码。</p>
<p>打开项目工程的瞬间，他差点被满屏的红色警告吓住。</p>
<p>光是商品列表适配器的代码，就有足足三百多行，里面全是 <code>HashMap&lt;Integer, View&gt;</code> 的用法，循环里还嵌套着多次 <code>findViewById</code>。</p>
<p>王哥正在接电话。</p>
<p>挂了电话，他看到老杨盯着 <code>HashMap</code> 发呆，突然笑了。</p>
<p>"刚毕业的吧？"</p>
<p>王哥看了眼屏幕上的代码，又看了看老杨，语气缓和了些："这代码是前人遗留的坑，用 <code>HashMap</code> 存整数键，既费内存又容易出问题，你接手了可得好好梳理下。"</p>
<p>老杨涨红了脸，赶紧看 Android 官方文档。</p>
<p>王哥走过来，搜索了一下文档里的 <code>SparseArray</code> 说明。</p>
<p>"看这个，专门用于 <code>int</code> 键和 <code>Object</code> 值的映射，比 <code>HashMap</code> 省内存，还不用自动装箱。"</p>
<p>他随手在草稿纸上画了个示意图。</p>
<p>"你把这里的 <code>HashMap</code> 全换成 <code>SparseArray</code>，再把 <code>ViewHolder</code> 加上减少 <code>findViewById</code> 次数，应该能缓解卡顿。"</p>
<p>那天晚上，老杨在公司待到了凌晨两点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09729562590f4f63858cf5fbc63d4e04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659412&amp;x-signature=jDeRChB9lHt4vrfL1cA3Pmujwpc%3D" alt="1.png" loading="lazy"/></p>
<p>办公区里只剩下他一个人，空调的嗡嗡声格外清晰。</p>
<p>他按照王哥的提示，一步步重构代码。</p>
<p>先定义 <code>ViewHolder</code> 类，把商品名称、价格、图片等控件都封装进去。</p>
<p>再把 <code>HashMap&lt;Integer, View&gt;</code> 替换成 <code>SparseArray&lt;View&gt;</code>，遍历的时候用 <code>keyAt(i)</code> 获取键，<code>valueAt(i)</code> 获取对应的 <code>ViewHolder</code>。</p>
<p>调试的过程并不顺利。</p>
<p>第一次运行时，商品图片全变成了问号。</p>
<p><strong>Logcat</strong> 里报出空指针异常。</p>
<p>老杨排查了半天，才发现是自己在 <code>delete</code> 元素后，没有及时更新列表的数据源，导致复用<code>ViewHolder</code> 时出现了数据错乱。</p>
<p>其实单靠把 <code>HashMap</code> 换成 <code>SparseArray</code>，只能解决部分内存占用问题，想让列表彻底顺滑，还得配套优化其他环节。</p>
<p>老杨后续又补充了图片缓存策略，用 <code>LruCache</code> 缓存已加载的商品图片，避免重复请求网络；同时把列表项的图片加载改成异步请求，不让耗时操作阻塞主线程。</p>
<p>修改完成后，他再次运行项目。</p>
<p>原本滑动卡顿的列表，竟然能流畅地滑到底部。</p>
<p><code>Memory Monitor</code> 里的内存曲线也从锯齿状变成了平缓的波浪。</p>
<p>第二天中午，老杨刚到公司，就把优化后的代码提交到代码仓库，心里满是成就感。</p>
<p>可还没等他喘口气，测试组同事抱着一堆测试机冲过来，脸色铁青。</p>
<p>"杨明，你优化后的版本在部分机型上频繁闪退，后台已经收到上百条崩溃报告了！"</p>
<p>老杨的心一下子沉到了谷底。</p>
<p>他赶紧连接电脑，打开 <strong>Logcat</strong> 筛选崩溃日志。</p>
<p>密密麻麻的红色日志里，"OutOfMemoryError" 字样格外刺眼。</p>
<p>部分低内存机型上，商品图片的 <code>Bitmap</code> 对象未及时回收，叠加 <code>SparseArray</code> 优化后未适配的缓存逻辑，最终导致内存溢出。</p>
<p>更棘手的是，有些崩溃日志只显示异常类型，却找不到具体代码调用路径，根本无从下手排查。</p>
<p>"慌什么？先把崩溃日志理清楚。"</p>
<p>王哥不知何时站到了他身后，指着 <strong>Logcat</strong> 界面。</p>
<p>"开发环境用 <strong>Logcat</strong> 查即时日志，生产环境的崩溃得靠专门的监控工具。"</p>
<p>"咱们公司刚接入了 <strong>Bugly</strong>，你把它集成到项目里，能获取完整的堆栈信息、设备型号和用户行为路径，定位问题会快很多。"</p>
<p>他顿了顿，补充道："对了，记得区分生产和测试环境的配置，别把测试环境的日志和服务器请求弄到生产环境去了。"</p>
<p>老杨赶紧按照王哥的指导集成 <strong>Bugly</strong>，同时琢磨起环境区分的问题。</p>
<p>他在 <code>build.gradle</code> 里配置了 <code>buildTypes</code>，分别定义 <code>debug</code>（测试环境）和 <code>release</code>（生产环境）两种构建类型。</p>
<p>测试环境下，开启 <code>Log</code> 日志输出，将 <strong>Bugly</strong> 设置为调试模式，服务器请求指向测试服务器。</p>
<p>生产环境下，关闭所有调试日志，<strong>Bugly</strong> 切换为正式监控模式，请求正式服务器地址。</p>
<p>为了避免手动修改出错，他还通过 <code>BuildConfig</code> 类获取环境变量，比如用 <code>BuildConfig.DEBUG</code> 判断当前环境，用 <code>BuildConfig.BASE_URL</code> 获取对应环境的服务器地址。</p>
<p>配置完成后，他在代码关键位置添加了 <code>try-catch</code> 块捕获异常，并根据环境输出日志。</p>
<p>没过多久，<strong>Bugly</strong> 后台就统计出详细的崩溃报告。</p>
<p>崩溃发生在商品列表一直滑动加载图片的场景。</p>
<p>结合报告里的堆栈信息，他很快找到了问题根源——图片缓存没有设置大小上限，也没有监听系统低内存状态。</p>
<p>"用 <code>ActivityManager</code> 的 <code>getMemoryInfo</code> 方法判断设备内存状态。"</p>
<p>王哥扔给他一个代码示例。</p>
<p>"当设备处于低内存状态时，主动清理图片缓存和 <code>SparseArray</code> 里的闲置数据。"</p>
<p>"另外，给线程加个全局异常处理器，避免未捕获的异常直接导致应用崩溃。"</p>
<p>老杨照着修改代码。</p>
<p>他通过 <code>Thread.setDefaultUncaughtExceptionHandler</code> 设置了全局异常处理器，在里面记录异常详情并友好退出应用。</p>
<p>同时用 <code>ActivityManager</code> 监控内存，低内存时调用 <code>sparseArray.clear()</code> 释放资源。</p>
<p>再次测试时，崩溃率大幅下降。</p>
<p><strong>Logcat</strong> 里的 <code>GC</code> 日志也变得规律起来。</p>
<p>他看着 <strong>Bugly</strong> 后台实时更新的监控数据，第一次真切感受到异常追踪工具对开发的重要性。</p>
<p>解决了崩溃问题，老杨以为终于能松口气。</p>
<p>解决了崩溃问题后，老杨总算迎来了几天短暂的休整。</p>
<p>他趁这段时间梳理了商品列表优化的完整方案，补全了技术文档，还帮测试组复现了几个零星的小问题。</p>
<p>就这样安稳过了一周，正当他以为能喘口气，把精力放在后续的功能迭代上时，新的任务又来了。</p>
<p>安卓组组长找了过来，给他安排了新任务：“给商品详情页加个扫码功能，用户扫商品包装上的条形码，就能快速查看商品信息，这个需求得尽快落地。”</p>
<p>"这个简单，调用系统相机扫码就行。"</p>
<p>老杨信心满满地开始写代码。</p>
<p>他在 <code>AndroidManifest.xml</code> 里添加了 <code>CAMERA</code> 权限，然后用 <code>Intent</code> 调用系统相机应用，想着就能直接获取扫码结果。</p>
<p>可测试时却发现，在 Android 6.0 的机型上，打开扫码功能时直接闪退。</p>
<p><strong>Logcat</strong> 里报出权限被拒绝的错误。</p>
<p>"你不知道 6.0 开始要动态申请权限吗？"</p>
<p>王哥路过他工位时，一眼就看出了问题。</p>
<p>"危险权限不仅要在 <code>Manifest</code> 里声明，还要在运行时申请。"</p>
<p>他打开自己的项目工程，给老杨演示了动态权限申请的代码。</p>
<p>"先用 <code>ContextCompat.checkSelfPermission</code> 检查权限是否已授予，如果没授予，再判断是否需要向用户说明理由。"</p>
<p>老杨赶紧补全了权限申请的代码。</p>
<p>他发现王哥用的是 <code>ActivityResultLauncher</code> API，比传统的<code>requestPermissions</code> 方法更简洁，还能避免内存泄漏。</p>
<p>他照着实现：先注册一个权限请求启动器，触发后根据用户授权结果执行不同逻辑。</p>
<p>可新的问题又出现了：有些用户第一次拒绝了相机权限，第二次打开扫码功能时，系统没有弹出权限申请对话框，直接拒绝了权限。</p>
<p>"这时候要调用 <code>shouldShowRequestPermissionRationale</code> 方法判断。"</p>
<p>王哥提醒他。</p>
<p>"如果返回 <code>true</code>，说明用户之前拒绝过权限，这时候应该弹出对话框，向用户解释为什么需要相机权限，比如‘需要相机权限才能扫描条形码，快速查看商品信息’。"</p>
<p>"如果返回 <code>false</code>，说明用户永久拒绝了，就得引导他们去系统设置里手动开启。"</p>
<p>老杨按照王哥的提示，添加了权限说明对话框和设置引导页面。</p>
<p>测试时，无论用户是首次拒绝还是永久拒绝，都能得到清晰的指引，扫码功能的用户体验好了很多。</p>
<p>可多机型测试时，新的问题又暴露出来：在 Android 4.0 及以上版本的机型上，扫码成功后加载商品信息会直接闪退，<strong>Logcat</strong> 里明确报出 <code>NetworkOnMainThreadException</code> 异常；而在4.0以下的旧机型上，虽不会崩溃，但网络不好时会出现明显的UI卡顿，屏幕僵住好几秒无响应，连返回按钮都失灵。</p>
<p>"这是因为你在主线程做了网络请求。"</p>
<p>王哥敲了敲他的屏幕。</p>
<p>"耗时操作一定要放在子线程里。试试用 <code>HandlerThread</code> 。"</p>
<p>王哥给老杨演示了 <code>HandlerThread</code> 的用法。</p>
<p>创建一个 <code>HandlerThread</code> 实例，调用 <code>start</code> 方法启动线程。</p>
<p>然后创建一个 <code>WorkerHandler</code>，把它绑定到 <code>HandlerThread</code> 的 <code>Looper</code> 上。</p>
<p>耗时的网络请求放在 <code>WorkerHandler</code> 的 <code>post</code> 方法里执行，获取到数据后，再通过 <code>MainHandler</code> 切换到主线程更新 <code>UI</code>。</p>
<p>老杨照着王哥的方法修改代码。</p>
<p>他还特意在 <code>Activity</code> 销毁时，调用了 <code>HandlerThread.quitSafely()</code> 方法——要知道 <code>quit</code> 会直接终止线程的 <code>Looper</code>，丢弃队列中未执行的消息，容易导致数据丢失或资源未释放；而 <code>quitSafely</code> 会等待队列中已有的消息执行完毕后再终止 <code>Looper</code>，既能正常结束线程，又能避免内存泄漏和数据异常。</p>
<p>他还在代码里添加了详细的 <code>Log</code> 日志，用不同的日志级别区分调试信息和错误信息，方便后续通过 <strong>Logcat</strong> 排查问题。</p>
<p>测试时，扫码加载商品信息的过程中，<code>UI</code> 再也不卡顿了。</p>
<p>即使网络不好，也只会显示加载中动画，不会影响其他操作。</p>
<p>项目推进到后期，公司组织了一次无障碍测试。</p>
<p>测试人员反馈，视障用户使用 <code>TalkBack</code> 时，无法识别扫码按钮和商品图片，而且调整系统字体大小时，<code>APP</code> 里的文本大小不会跟着变化。</p>
<p>"无障碍是必须要适配的，不然会流失一部分用户。"</p>
<p>王哥把无障碍测试指南扔给老杨。</p>
<p>"给所有 <code>UI</code> 元素添加内容描述，装饰性的元素就把 <code>contentDescription</code> 设为<code>null</code>。"</p>
<p>"文本大小要用 <code>sp</code> 作为单位，这样才能跟随系统字体大小变化。"</p>
<p>老杨赶紧修改代码。</p>
<p>他给扫码按钮添加了"点击扫码查看商品信息"的 <code>contentDescription</code>，给商品图片添加了对应的商品名称描述。</p>
<p>把所有 <code>TextView</code> 的 <code>textSize</code> 属性都从 <code>dp</code> 改成了 <code>sp</code>。</p>
<p>他还使用 Android Studio 的无障碍扫描器检查了一遍，修复了焦点导航不顺畅的问题。</p>
<p>再次测试时，视障用户能通过 <code>TalkBack</code> 正常操作，文本大小也能跟随系统设置变化了。</p>
<p>就在项目即将上线的时候，公司突然组织了一次代码评审。</p>
<p>评审会上，王哥指出了老杨代码里的一个问题：他在使用 <code>Handler</code> 时，直接用了匿名内部类，导致内存泄漏。</p>
<p>"匿名内部类会持有外部 <code>Activity</code> 的引用，"</p>
<p>王哥解释道。</p>
<p>"如果 <code>Handler</code> 里还有未执行的消息，<code>Activity</code> 就无法被 <code>GC</code> 回收，导致内存泄漏。"</p>
<p>他给老杨演示了正确的用法：用静态内部类定义 <code>Handler</code>，然后用 <code>WeakReference</code> 引用外部<code>Activity</code>；在 <code>Activity</code> 销毁时，移除 <code>Handler</code> 里的所有消息和回调。"</p>
<p>老杨赶紧修改代码。</p>
<p>把所有的<code>Handler</code> 都改成了静态内部类的形式，还添加了 <code>WeakReference</code>。</p>
<p>特意在 <code>onDestroy</code> 方法里，调用了 <code>handler.removeCallbacksAndMessages(null)</code>，确保移除所有未执行的消息和回调。</p>
<p>同时，他还补充了单元测试，覆盖了 <code>SparseArray</code> 优化、权限申请、异常处理等核心逻辑，确保代码的稳定性。</p>
<p>代码评审通过后，项目终于顺利上线。</p>
<p>上线那天，老杨盯着 <strong>Bugly</strong> 后台的监控数据，心里满是激动。</p>
<p>用户反馈商品列表卡顿问题解决了，闪退率也降到了0.001%以下。</p>
<p>扫码功能和无障碍适配都得到了用户的认可。</p>
<p>王哥拍着他的肩膀，笑着说："不错啊小伙子，入职这么短时间，就能独当一面了。"</p>
<p>就这样在一次次项目攻坚、一次次踩坑填坑的千锤百炼中，老杨才算是在淘一淘客户端技术部站稳了脚跟。</p>
<p>他跟着王哥参与了更多的项目，把 <code>SparseArray</code> 的内存优化思路用到了更多场景。</p>
<p>也熟练掌握了运行时权限的各种适配技巧。</p>
<p>他学会了用 <code>Looper</code>、<code>Handler</code>、<code>HandlerThread</code> 搭建高效的异步任务框架。</p>
<p>用 <strong>Logcat</strong> 和 <strong>Bugly</strong> 组合排查各种异常问题。</p>
<p>通过 <code>buildTypes</code> 配置清晰区分生产与测试环境（控制 <code>Log</code> 日志输出、服务器地址等）。</p>
<p>也深刻理解了无障碍适配对用户体验的重要性。</p>
<p>在淘一淘的几年里，老杨从一个青涩的应届生，成长为一名资深的 Android 开发工程师。</p>
<p>他经历过紧急项目的通宵加班，也感受过解决难题后的成就感。</p>
<p>他遇到过严格的代码评审，也得到过前辈的悉心指导。</p>
<p>那些写过的代码、踩过的坑、解决过的 Bug，都变成了他最宝贵的财富。</p>
<p>尤其是王哥常说的那句话，他一直记在心里。</p>
<p>"好的开发不仅要实现功能，还要考虑性能、稳定性和用户体验，每一个技术点的选择，都要经得起场景的考验。"</p>
<p>......</p>
<p>老杨的思绪渐渐拉回现实。</p>
<p>搪瓷杯里的咖啡已经凉透了。</p>
<p>小安和晓雅、阿泽、博文还围在他的工位旁，眼神里满是专注。</p>
<p>"所以啊，林卓现在遇到的紧急项目，对他来说也是个成长的机会。"</p>
<p>老杨的声音带着几分感慨。</p>
<p>"当年我要是没经历那些紧急任务，也学不会把 <code>SparseArray</code>、权限适配、异常追踪这些技术点融会贯通。"</p>
<p>博文似懂非懂地点点头。</p>
<p>老杨笑了笑。</p>
<p>"技术从来不是孤立的。你用 <code>SparseArray</code> 优化内存，就得知道怎么用 <strong>Logcat</strong> 查 <code>GC</code> 日志；你做扫码功能，就得懂动态权限申请；你写异步任务，就得学会用 <code>HandlerThread</code> 避免内存泄漏。”</p>
<p>他顿了顿。</p>
<p>“哦，对，不过放到现在，异步任务大多用Kotlin协程来解决了，很少有人再用 <code>HandlerThread</code> 了。"</p>
<p>他继续，指着博文的代码。</p>
<p>"你再把 <strong>Bugly</strong> 的简单集成和 <code>try-catch</code> 异常捕获加上，模拟一下生产环境的异常场景，这样这个练习项目就更完整了。"</p>
<p>小安的眉头终于舒展了一些。</p>
<p>"杨哥，听你这么一说，我就放心了。林卓他肯定能顺利完成任务的。"</p>
<p>老杨点点头，打开Q书，给林卓发了一条消息。</p>
<p>"遇到问题别慌，先沉下心梳理清楚核心逻辑——优先定位问题根源，再找对应解决方案，复杂任务拆分成小步骤来攻克。当年我在淘一淘救急，全靠前辈指点这些通用的开发思路，你按这个节奏来，没问题的。"</p>
<p>发送完毕，他又转头对晓雅、阿泽、博文说："我把当年在淘一淘踩过的坑，还有这些核心技术点的最佳实践整理成了个人经验文档，等下发给你们，省得你们以后再走弯路。"</p>
<p>话音刚落，老杨便打开电脑文件夹，找到那份整理好的个人经验文档。</p>
<p>他通过Q书群发给了他们。</p>
<p>小安站在一旁，看着这一幕，紧绷的肩膀彻底放松下来。</p>
<p>阳光透过落地窗洒在办公区的地板上，也照亮了几人专注的脸庞。</p>
<p>老杨看着眼前充满朝气的实习生们，仿佛看到了当年初入职场的自己。</p>
<p>而小安的目光，正温柔地望向办公区入口的方向，期待着林卓归来的身影。</p>
<p>沉默片刻。</p>
<p>小安像是忽然想起什么，轻声问老杨："杨哥，听你讲当年在淘一淘的经历，你技术这么好，还能独当一面，后来怎么会来咱们 ByteFlow 呢？"</p>
<p>老杨闻言，拿起桌上早已凉透的搪瓷杯抿了一口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93bca8c26ab0459e9dc5b6b62b05b6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767659412&amp;x-signature=4nDIS3C7BHMjvFWq5wSO94IlOEA%3D" alt="2.png" loading="lazy"/></p>
<p>他嘴角勾起一抹意味深长的笑。</p>
<p>目光再次飘向窗外的阳光，缓缓说道："这啊，又是明天的故事了。"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 学习：useContext——优雅解决跨层级组件通信]]></title>    <link>https://juejin.cn/post/7589170021931991055</link>    <guid>https://juejin.cn/post/7589170021931991055</guid>    <pubDate>2025-12-30T00:44:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589170021931991055" data-draft-id="7588388014504902698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" React 学习：useContext——优雅解决跨层级组件通信"/> <meta itemprop="keywords" content="JavaScript,面试,React.js"/> <meta itemprop="datePublished" content="2025-12-30T00:44:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             React 学习：useContext——优雅解决跨层级组件通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:44:42.000Z" title="Tue Dec 30 2025 00:44:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前几天学习完了React中基本的组件通信，父传子，子传父以及兄弟组件之间的通讯，但是实际使用下来，发现一但嵌套关系复杂，数据传递就难免变得复杂且多余，一个子组件想要获取一个数据竟然要一步步从根组件中传递获取，于是我又学习了useContext———跨组件通讯方式。</p>
<p>感觉它真是解决“道具穿透”（Prop Drilling）问题的一把好钥匙。。下面把我学习过程中的笔记、代码和思考整理成一篇文章，希望能帮到同样在纠结组件通信的同学。</p>
<h2 data-id="heading-1">传统父子组件通信的痛点</h2>
<p>最常见的组件通信方式就是父组件通过 props 把数据传给子组件。</p>
<p>比如我们有一个登录后的用户信息，需要显示在最底层的头像组件里：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx（传统方式）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params">{ user }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Header</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params">{ user }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params">{ user }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Andrew"</span> };
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Page</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>;
}
</code></pre>
<p>这样写没什么问题，但一旦层级变深——比如 Page → Layout → Sidebar → Header → Avatar，你就得在每一层都老老实实接收并转发 user 这个 prop。代码里充斥着毫无意义的“中转站”，阅读和维护成本直线上升。</p>
<p>我的笔记里写得很清楚：</p>
<ul>
<li>一路传递下去 性价比不高 麻烦</li>
<li>规矩不变：父组件（外组件）复杂持有和改变数据</li>
<li>大于父子层级，传递的路径太长</li>
</ul>
<p>这就是经典的 <strong>Prop Drilling</strong> 问题。</p>
<h2 data-id="heading-2">useContext 的核心思想</h2>
<p>useContext 的出现，就是为了彻底解决跨层级传递的尴尬。</p>
<p>它的核心理念可以用两句话概括（也是我笔记里反复强调的）：</p>
<ol>
<li>数据在最外层提供，给组件树里任何层级的后代随便用。</li>
<li>需要消费数据的组件自己去“找”数据，而不是被动接收 props。</li>
</ol>
<p>换句话说：<strong>提供者（Provider）广播数据，消费者主动订阅</strong>。</p>
<p>这样做的好处显而易见：</p>
<ul>
<li>中间层组件完全不需要关心这个数据是否存在</li>
<li>数据管理集中在最外层，逻辑清晰</li>
<li>任意深度的后代组件都能直接获取最新数据</li>
</ul>
<h2 data-id="heading-3">手把手实现一个用户信息跨层级共享</h2>
<p>我们用最简单的用户登录信息来演示。</p>
<h3 data-id="heading-4">1. 创建 Context</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/App2.jsx</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);
</code></pre>
<p>createContext(defaultValue) 会返回一个 Context 对象。默认值只有在没有匹配到 Provider 时才会用到，通常我们传 null。</p>
<h3 data-id="heading-5">2. 在根部提供数据</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App2.jsx</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../views/Page"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./App2"</span>;  <span class="hljs-comment">// 同一个文件里可以直接引用</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"华高俊"</span> };   <span class="hljs-comment">// 实际项目里可能是登录后从接口拿到的</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{user}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<p>Provider 的 value 属性就是我们要共享的数据。只要组件树被这个 Provider 包裹，里面的任何组件都能访问到。</p>
<h3 data-id="heading-6">3. 任意后代组件消费数据</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// components/UserInfo.jsx</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../src/App2"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);

  <span class="hljs-comment">// 如果没找到 Provider，user 会是 createContext 时传的默认值（这里是 null）</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name ?? "未登录"}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>组件树结构可以是：</p>
<p>App → Page → Header → UserInfo</p>
<p>注意 Header 和 Page 完全不需要接收任何 props，UserInfo 直接通过 useContext 拿到数据。</p>
<p>“要消费数据状态的组件拥有找数据的能力（传递是被动接收）”。</p>
<h4 data-id="heading-7">完整调用流程图解</h4>
<pre><code class="hljs language-text" lang="text">1. 创建容器
   ↓
src/contexts/UserContext.js
export const UserContext = createContext(null);

2. 在根组件提供数据
   ↓
App.jsx
&lt;UserContext.Provider value={user}&gt;
  &lt;Page /&gt;
&lt;/UserContext.Provider&gt;

3. 在任意后代组件消费数据
   ↓
components/Header/UserInfo.jsx
const user = useContext(UserContext);
return &lt;div&gt;{user.name}&lt;/div&gt;;
</code></pre>
<p>组件结构可以是： App → Layout → Sidebar → Header → Avatar → UserInfo 中间所有组件都不需要写 props，UserInfo 直接就能拿到 user 数据！</p>
<h4 data-id="heading-8">总结</h4>

























<table><thead><tr><th>名称</th><th>作用</th><th>调用位置</th></tr></thead><tbody><tr><td>createContext</td><td>创建一个共享数据的容器</td><td>通常单独文件导出</td></tr><tr><td>&lt;Context.Provider&gt;</td><td>提供实际数据（value）</td><td>组件树较高层级（如 App 最外层）</td></tr><tr><td>useContext(Context)</td><td>取出当前 Context 的数据</td><td>任意需要使用数据的子组件中</td></tr></tbody></table>
<h2 data-id="heading-9">进阶：Context 里放可变状态（主题切换实战）</h2>
<p>单纯共享静态数据已经很香了，但真正的威力在于把<strong>状态 + 更新函数</strong>一起放进 Context，实现全局可变共享状态。</p>
<p>主题切换（白天/夜间模式）是最经典的例子，也是我笔记里专门标记的 demo。</p>
<h3 data-id="heading-10">思路</h3>
<ul>
<li>在根组件创建一个 theme 状态和 toggleTheme 函数</li>
<li>把两者通过 Context 提供给全局</li>
<li>任意组件（哪怕是最底层的按钮）都可以读取当前主题并触发切换</li>
<li>主题实际生效方式：通过 CSS 自定义属性（CSS Variables）</li>
</ul>
<h3 data-id="heading-11">1. 定义 ThemeContext</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// contexts/ThemeContext.jsx</span>
<span class="hljs-keyword">import</span> { createContext, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"light"</span>); <span class="hljs-comment">// light | dark</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (prev === <span class="hljs-string">"light"</span> ? <span class="hljs-string">"dark"</span> : <span class="hljs-string">"light"</span>));
  };

  <span class="hljs-comment">// 同时把 theme 和 toggleTheme 暴露出去</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">toggleTheme</span> }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTheme</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
</code></pre>
<p>封装一个自定义 Hook useTheme，调用起来更清晰。</p>
<h3 data-id="heading-12">2. CSS 变量实现真正的全局主题</h3>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-comment">/* theme.css */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--bg-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attr">--text-color</span>: <span class="hljs-number">#222</span>;
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#1677ff</span>;
}

<span class="hljs-selector-attr">[data-theme=<span class="hljs-string">"dark"</span>]</span> {
  <span class="hljs-attr">--bg-color</span>: <span class="hljs-number">#141414</span>;
  <span class="hljs-attr">--text-color</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#4e8cff</span>;
}

<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-color);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--primary-color);
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
</code></pre>
<p>关键点：在 &lt; html&gt; 标签上动态添加 data-theme 属性。</p>
<h3 data-id="heading-13">3. 根组件应用主题</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./contexts/ThemeContext"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Page"</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">"./contexts/ThemeContext"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Root</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme } = <span class="hljs-title function_">useTheme</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">theme</span> = theme;
  }, [theme]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Root</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-14">4. 任意组件使用主题和切换</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// components/ThemeToggleButton.jsx</span>
<span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">"../contexts/ThemeContext"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeToggleButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useTheme</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>
      切换到 {theme === "light" ? "暗黑" : "明亮"} 模式
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// components/Header.jsx</span>
<span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">"../contexts/ThemeContext"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme } = <span class="hljs-title function_">useTheme</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">borderBottom:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>当前主题：{theme === "light" ? "🌞 白天" : "🌙 夜间"}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ThemeToggleButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
  );
}
</code></pre>
<p>只要把 ThemeToggleButton 放在组件树的任何位置，都能控制全局主题，中间层级完全无感。</p>
<h2 data-id="heading-15">useContext 的缺陷及解决方法（实用避坑指南）</h2>
<p>useContext 用起来确实很爽，能轻松解决跨层级传 props 的麻烦，但它并不是完美的“万能药”。如果你不注意它的缺陷，项目大了以后很容易踩坑。下面我把最常见的几个缺陷讲清楚，并给出真实可行的预防办法。</p>
<h3 data-id="heading-16">1. <strong>性能问题：不必要的重渲染</strong></h3>
<p><strong>缺陷描述</strong> 当 Context 的 value 值发生变化时，所有消费了这个 Context 的组件（哪怕只用了 value 里的一小部分）都会被迫重新渲染。</p>
<p>举个例子：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">ThemeContext</span>.<span class="hljs-property">Provider</span> value={{ theme, user, toggleTheme, logout }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WholeApp</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ThemeContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<p>如果 user 改变了，整个 App 里所有用了 useContext(ThemeContext) 的组件（包括只关心 theme 的按钮）都会重渲染，哪怕主题根本没变。</p>
<p><strong>预防办法</strong></p>
<ul>
<li>
<p><strong>拆分 Context</strong>：把变化频率不同的数据拆到不同的 Context 里。 推荐做法：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">ThemeContext</span>.<span class="hljs-property">Provider</span> value={{ theme, toggleTheme }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">user</span>, <span class="hljs-attr">logout</span> }}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">ThemeContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<p>这样主题切换不会导致用户相关的组件重渲染，反之亦然。</p>
</li>
<li>
<p><strong>使用 memo 优化 value</strong>：避免每次渲染都创建新对象。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useMemo</span>(
  <span class="hljs-function">() =&gt;</span> ({ theme, toggleTheme }),
  [theme, toggleTheme]  <span class="hljs-comment">// 只有依赖变化时才创建新对象</span>
);

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>;
</code></pre>
</li>
<li>
<p><strong>消费方结合 useMemo / useCallback</strong>：如果组件内部计算代价大，可以进一步优化。</p>
</li>
</ul>
<h3 data-id="heading-17">2. <strong>调试困难：数据来源不明确</strong></h3>
<p><strong>缺陷描述</strong> 组件直接通过 useContext 拿数据，你一眼看不出这个数据到底是从哪个 Provider 提供的，尤其是项目大了，同一个 Context 可能被多个 Provider 包裹（嵌套 Provider）。</p>
<p><strong>预防办法</strong></p>
<ul>
<li>
<p><strong>给 Context 起有意义的名字</strong>：不要叫 DataContext，而是 UserContext、ThemeContext、CartContext。</p>
</li>
<li>
<p><strong>Provider 放固定位置</strong>：全局的放 App 根部，局部的放对应模块的根组件。</p>
</li>
<li>
<p><strong>自定义 Hook 封装</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTheme</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useUser</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);
</code></pre>
<p>使用时直接 const { theme } = useTheme();，一眼就知道数据来源。</p>
</li>
</ul>
<h3 data-id="heading-18">3. <strong>默认值陷阱</strong></h3>
<p><strong>缺陷描述</strong> createContext(defaultValue) 的默认值只在<strong>完全没有匹配到 Provider</strong> 时才生效。很多人误以为它能当“初始值”用，导致调试时困惑。</p>
<p><strong>预防办法</strong></p>
<ul>
<li>
<p>默认值一般传 null 或 undefined，并在消费时做好空值判断：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);
<span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'UserInfo 必须在 UserProvider 内部使用'</span>);
</code></pre>
</li>
<li>
<p>或者干脆不依赖默认值，所有数据都在 Provider 里提供。</p>
</li>
</ul>
<h3 data-id="heading-19">4. <strong>不适合高频更新的数据</strong></h3>
<p><strong>缺陷描述</strong> 如果你把一个高频变化的状态（比如输入框内容、鼠标位置、实时计数器）放进 Context，会导致大量组件频繁重渲染，性能雪崩。</p>
<p><strong>预防办法</strong></p>
<ul>
<li>高频状态坚决用局部 state 或其他更精细的方案（比如 Zustand、Jotai 的 atom）。</li>
<li>Context 只放“相对稳定”或“全局必要”的数据：主题、用户信息、语言、路由状态等。</li>
</ul>
<h3 data-id="heading-20">5. <strong>嵌套 Provider 时价值覆盖问题</strong></h3>
<p><strong>缺陷描述</strong> 同一个 Context 可以嵌套多个 Provider，后面的会覆盖前面的 value。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">ThemeContext</span>.<span class="hljs-property">Provider</span> value={{ <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme:</span> '<span class="hljs-attr">dark</span>' }}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">GrandChild</span> /&gt;</span>  {/* 这里拿到 dark */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Child</span>&gt;
</code></pre>
<p>这本来是特性，但如果不小心嵌套错了，就会出现“主题突然变了但找不到原因”的诡异 bug。</p>
<p><strong>预防办法</strong></p>
<ul>
<li>全局 Context 只在最外层提供一次。</li>
<li>如果需要局部覆盖（如某个页面强制暗色），明确注释并控制范围。</li>
</ul>
<h3 data-id="heading-21">总结：useContext 适用场景与替代方案</h3>






























<table><thead><tr><th>适用场景</th><th>不适用场景</th><th>推荐替代方案</th></tr></thead><tbody><tr><td>主题切换</td><td>高频状态（如输入框、动画）</td><td>局部 state / Zustand</td></tr><tr><td>用户信息、权限</td><td>复杂的大型状态管理</td><td>Redux Toolkit / Zustand</td></tr><tr><td>国际化（i18n）</td><td>需要中间件、异步 action</td><td>Redux / Recoil / Jotai</td></tr><tr><td>相对稳定的全局配置</td><td>需要细粒度订阅单个字段</td><td>Jotai / Zustand</td></tr></tbody></table>
<p><strong>我的个人建议</strong>：</p>
<ul>
<li>小中型项目：大胆用 useContext + useReducer 就够了，简单高效。</li>
<li>大型项目：用 useContext 只做“提供能力”（Provider 包裹），真正复杂状态管理交给更专业的库（如 Zustand，它结合了 Context 的简单和 Redux 的强大）。</li>
</ul>
<p>用好了，useContext 是优雅的；用不好，它会让你在重渲染地狱里怀疑人生。关键就两点：</p>
<ol>
<li>拆分 Context</li>
<li>memo 住 value</li>
</ol>
<h2 data-id="heading-22">小结：什么时候用 useContext</h2>
<ul>
<li>需要跨多层级共享数据时（用户信息、主题、语言、权限等全局状态）</li>
<li>数据会在多个不相邻的组件中使用</li>
<li>不想写一堆无意义的 props 中转代码</li>
</ul>
<p>注意事项：</p>
<ul>
<li>Context 触发更新时，所有消费了这个 Context 的组件都会重新渲染。建议把变化频率高的状态和稳定的状态分开多个 Context。</li>
<li>对于复杂的大型应用，推荐搭配 useReducer 或直接使用成熟的状态管理库（如 Zustand、Redux Toolkit）。</li>
</ul>
<p>通过这个主题切换的小 demo，我彻底感受到 useContext 的优雅：数据管理集中、消费方主动获取、配合 CSS 变量实现真正的全局样式切换，代码清晰且扩展性极强。</p>
<p>如果你还在被 props 一层一层往下传折磨，不妨立刻试试 useContext，相信我，用过一次就再也回不去了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭源的墙角被挖塌了？GLM-4.7登顶开源王座，这回真不兴嘲讽]]></title>    <link>https://juejin.cn/post/7589172193150599204</link>    <guid>https://juejin.cn/post/7589172193150599204</guid>    <pubDate>2025-12-29T16:26:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589172193150599204" data-draft-id="7589099845187059748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭源的墙角被挖塌了？GLM-4.7登顶开源王座，这回真不兴嘲讽"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-29T16:26:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭源的墙角被挖塌了？GLM-4.7登顶开源王座，这回真不兴嘲讽
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T16:26:35.000Z" title="Mon Dec 29 2025 16:26:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年的年底并不平静。就在大家准备过双旦假期的时候，智谱AI像是故意给行业扔了个“深水炸弹”，发布了最新的GLM-4.7。</p>
<p>说实话，这两年国产大模型发布会我看累了，参数刷榜的消息也听麻了。但这次的情况有点不一样。这次拿出来的成绩单，不是自家做的PPT，而是来自Artificial Analysis。在这个被OpenAI、谷歌当做金标准的评测里，GLM-4.7干了一件让开源社区炸锅的事：它拿到了全球开源模型的第一名。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-30_00.17.07-1024x342.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-30_00.17.07-1024x342.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fea4484fa21411ea975a955d5dced96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767630394&amp;x-signature=RhdYFEfw%2FNd%2F%2BjJu5vDp6Ne1k4c%3D" alt="iShot_2025-12-30_00.17.07" loading="lazy"/></a></p>
<p><strong>这也太“卷”了</strong></p>
<p>先看一张更有说服力的成绩单。在AAII（Artificial Analysis Intelligence Index）刚刚更新的榜单里，GLM-4.7拿到了68分的综合得分。</p>
<p>这个分数意味着什么？</p>
<p>往上看，它在全球总榜里排第六。排在它前面的，全是GPT-5.2、Gemini 3 Pro这种闭源巨头，也就是那种你每个月得掏20刀甚至更多才能用上的“贵族”模型。</p>
<p>往下看，这才是最有意思的地方。它把Claude 4.5 Sonnet、Grok 4这些名声在外的模型甩在了身后。而在开源这个赛道上，它直接登顶。就连同样表现生猛的DeepSeek V3.2，这次也以两分之差排在第十。</p>
<p>如果不谈开源闭源，单论国产模型，GLM-4.7和Kimi K2、DeepSeek共同构成的第一梯队，已经把国产AI的水平线硬生生拉到了国际一线。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-30_00.17.17-1024x496.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-30_00.17.17-1024x496.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21ff2ce810c451e97305851f1cffc99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767630394&amp;x-signature=zsbxsLJEkkpUsZQ5HxrZbmq1Ukg%3D" alt="iShot_2025-12-30_00.17.17" loading="lazy"/></a></p>
<p><strong>它到底强在哪？</strong></p>
<p>很多开发者，包括我在内，最关心的其实不是分数，而是手感。GLM-4.7这次明显是奔着“解决难题”去的，它被定义为一款专注于推理的模型。</p>
<p>首先是写代码。对于我们这些靠代码吃饭的人来说，Code Arena的排名就是风向标。GLM-4.7在这个榜单上拿了开源第一，甚至在综合性能上压过了GPT-5.2。在LiveCodeBench测试里，它也超过了Claude Sonnet 4.5。虽然在某些特定测试集上还有偏科，但你让它写个复杂脚本或者查个Bug，它的表现已经不再是“像个AI”，而是“像个初级工程师”。</p>
<p>其次是它变“聪明”了。这里的聪明指的是逻辑推理。在研究生级别的GPQA Diamond测试里，它拿了84%的高分。为了达到这个效果，智谱给它引入了更长的思维链。简单说，就是它在回答你之前，会像人一样在肚子里打草稿，反复推演。虽然这会让计算成本稍微增加一点，但为了那个准确的答案，这点等待是值得的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-30_00.17.23-1024x359.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-30_00.17.23-1024x359.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/631491ab9a2a4df2b865c3c0cac54469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767630394&amp;x-signature=aQqe8ktaSJwgHyLgtM%2Bv10Lb%2FIM%3D" alt="iShot_2025-12-30_00.17.23" loading="lazy"/></a></p>
<p>还有一个亮点是“听指挥”。在考察智能体工具调用的测试中，它刷新了开源模型的纪录。这意味着，你可以更放心地把API接给它，让它去操作复杂的系统，而不是担心它听不懂指令乱搞一通。</p>
<p><strong>不仅是榜单，更是风向</strong></p>
<p>GLM-4.7发布后的反应很有趣。它不仅在国内火，在国外的Hugging Face上也迅速冲上了全球趋势榜第一。</p>
<p>这说明了什么？说明好东西是没有国界的。美国的AI推理平台Fireworks直接把它称作“了不起的假期礼物”，Vercel这种极客聚集的平台也第一时间宣布接入。</p>
<p>这不仅仅是一个模型的胜利，更像是一个信号。直到2024年，我们在讨论大模型时，还在说“追赶GPT-4”。到了2025年底，当我们看到国产模型在Hard模式的基准测试里，和谷歌、OpenAI的旗舰产品打得有来有回，甚至在开源领域领跑时，这种感觉是很微妙的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-30_00.17.31-1024x315.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-30_00.17.31-1024x315.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5088da97ec044852a7fa9594d8689a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767630394&amp;x-signature=WBRUDBjvuRtcmJ4vaggNAmXZJNw%3D" alt="iShot_2025-12-30_00.17.31" loading="lazy"/></a></p>
<p>对于开发者和企业来说，这意味着选择权的转移。你不需要再为了高质量的推理能力去忍受昂贵的闭源API，GLM-4.7提供了一个高性价比、甚至可以说是廉价的替代方案——每百万token不到1美元的推理成本，配上开源第一的能力，这笔账谁都会算。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasfadfsd-1024x297.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asfadfsd-1024x297.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8ca9b312aad44c3aa2f24ce5f813d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767630394&amp;x-signature=n8DbDbzImx6KD7GTxncFqg0LefQ%3D" alt="asfadfsd" loading="lazy"/></a></p>
<p>总而言之，GLM-4.7的出现，让2025年的AI竞赛在终局阶段又充满了变数。对于我们使用者来说，这无疑是最好的时代。闭源的高墙还在，但地基已经被开源的铲子挖得越来越松动了。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Grit：代码重构利器]]></title>    <link>https://juejin.cn/post/7589092567545233417</link>    <guid>https://juejin.cn/post/7589092567545233417</guid>    <pubDate>2025-12-29T17:46:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589092567545233417" data-draft-id="7589130173838032946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Grit：代码重构利器"/> <meta itemprop="keywords" content="Rust,性能优化,代码规范"/> <meta itemprop="datePublished" content="2025-12-29T17:46:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Grit：代码重构利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T17:46:05.000Z" title="Mon Dec 29 2025 17:46:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>面对需要修改数百个文件的代码迁移，你还在手动一个个改吗？今天介绍一款能让代码批量重构像查找替换一样简单的工具 —— Grit。</p>
</blockquote>
<h2 data-id="heading-0">为什么需要 Grit</h2>
<p>作为开发者，我们经常遇到这样的场景：</p>
<ul>
<li>团队决定统一使用 <code>lodash-es</code> 替代 <code>lodash</code>，需要修改几百个 import 语句</li>
<li>项目要从 React 类组件迁移到 Hooks，涉及上千个组件</li>
<li>某个废弃的 API 需要全面替换，但调用位置散落在代码库各处</li>
</ul>
<p>传统的解决方案各有痛点：</p>

























<table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td>手动修改</td><td>耗时长、易遗漏、容易出错</td></tr><tr><td>正则替换</td><td>不理解代码结构，容易误伤</td></tr><tr><td>jscodeshift</td><td>仅支持 JS/TS，需懂 AST，编写复杂</td></tr><tr><td>find + sed</td><td>脆弱，难以处理复杂场景</td></tr></tbody></table>
<p><strong>Grit</strong> 就是为了解决这些问题而生的 —— 它用声明式的语法，支持多种语言，让任何人都能写出安全的代码转换规则。</p>
<hr/>
<h2 data-id="heading-1">快速开始</h2>
<h3 data-id="heading-2">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：官方安装脚本</span>
curl -fsSL https://docs.grit.io/install | bash

<span class="hljs-comment"># 方式二：npm 安装</span>
npm install -g @getgrit/cli
</code></pre>
<h3 data-id="heading-3">验证安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查版本</span>
grit version

<span class="hljs-comment"># 诊断环境</span>
grit doctor
</code></pre>
<h3 data-id="heading-4">第一个转换</h3>
<p>假设我们要把所有的 <code>console.log</code> 调用删除：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：使用标准库 pattern（推荐）</span>
grit apply no_console_log src/

<span class="hljs-comment"># 方式二：使用内联 pattern</span>
grit apply <span class="hljs-string">'`console.log($_)`'</span> src/

<span class="hljs-comment"># 先预览会改什么（dry-run）</span>
grit apply --dry-run no_console_log src/

<span class="hljs-comment"># 查看某个 pattern 的详细信息</span>
grit patterns describe no_console_log
</code></pre>
<hr/>
<h2 data-id="heading-5">核心命令</h2>
<h3 data-id="heading-6">grit apply - 应用转换</h3>
<p><strong>语法</strong>: <code>grit apply [OPTIONS] &lt;PATTERN&gt; [PATHS]...</code></p>
<p><strong>Pattern 参数形式</strong>：</p>
<ul>
<li>标准库 pattern: <code>no_console_log</code></li>
<li>内联模式: <code>'</code>console.log($_)<code>'</code>（用单引号包裹反引号内的 pattern）</li>
<li>Pattern 文件: <code>./patterns/my_pattern.grit</code></li>
</ul>
<p><strong>常用选项</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 预览模式（不实际修改文件）</span>
grit apply --dry-run no_console_log file.js

<span class="hljs-comment"># 指定语言</span>
grit apply --language python print_to_log file.py

<span class="hljs-comment"># 限制修改数量</span>
grit apply --<span class="hljs-built_in">limit</span> 10 no_console_log src/

<span class="hljs-comment"># 紧凑输出</span>
grit apply --output compact no_console_log src/

<span class="hljs-comment"># 交互式选择（逐个确认）</span>
grit apply --interactive no_console_log src/

<span class="hljs-comment"># JSONL 格式输出</span>
grit apply --jsonl no_console_log src/
</code></pre>
<h3 data-id="heading-7">grit list - 列出可用 Patterns</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有 patterns</span>
grit list

<span class="hljs-comment"># 仅列出 JavaScript/TypeScript patterns</span>
grit list --language js

<span class="hljs-comment"># 仅列出 Python patterns</span>
grit list --language python

<span class="hljs-comment"># 仅列出本地 patterns</span>
grit list --<span class="hljs-built_in">source</span> <span class="hljs-built_in">local</span>
</code></pre>
<h3 data-id="heading-8">grit check - 检查代码</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查当前目录</span>
grit check

<span class="hljs-comment"># 自动修复</span>
grit check --fix

<span class="hljs-comment"># 详细输出</span>
grit check --verbose
</code></pre>
<h3 data-id="heading-9">其他有用命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 描述某个 pattern</span>
grit patterns describe no_console_log

<span class="hljs-comment"># 列出 patterns</span>
grit patterns list

<span class="hljs-comment"># 诊断环境</span>
grit doctor
</code></pre>
<hr/>
<h2 data-id="heading-10">核心语法</h2>
<h3 data-id="heading-11">代码片段模式</h3>
<p>最基本的模式是用反引号包裹的代码片段：</p>
<pre><code class="hljs language-gritql" lang="gritql">`console.log('Hello')`
</code></pre>
<p><strong>结构化匹配</strong>意味着 Grit 忽略格式差异，以下都会被匹配：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span> ( <span class="hljs-string">'Hello'</span> )     <span class="hljs-comment">// 换行和空格不影响</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>)         <span class="hljs-comment">// 单双引号等价</span>
</code></pre>
<h3 data-id="heading-12">变量系统</h3>
<p>使用 <code>$</code> 前缀定义变量，匹配任意内容：</p>
<pre><code class="hljs language-gritql" lang="gritql">`console.$method($msg)`      // 匹配 console 的任何方法调用
</code></pre>
<p><strong>变量复用规则</strong>：同一变量多次出现必须匹配相同值</p>
<pre><code class="hljs language-gritql" lang="gritql">`$obj &amp;&amp; $obj.$prop()`       // foo &amp;&amp; foo.bar() ✓
                              // foo &amp;&amp; bar.baz()   ✗
</code></pre>
<h3 data-id="heading-13">条件过滤</h3>
<p>使用 <code>where</code> 子句精确控制匹配范围：</p>
<pre><code class="hljs language-gritql" lang="gritql">`console.$method($msg)` where {
  $method &lt;: or { `log`, `warn` }    // 只匹配 log 和 warn
}
</code></pre>
<h3 data-id="heading-14">转换语法</h3>
<p>使用 <code>=&gt;</code> 进行代码转换：</p>
<pre><code class="hljs language-gritql" lang="gritql">`旧代码($args)` =&gt; `新代码($args)`
</code></pre>
<hr/>
<h2 data-id="heading-15">实战案例</h2>
<h3 data-id="heading-16">案例 1：清理 console 调试语句</h3>
<p>最简单的场景 —— 直接删除匹配的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'fetching data...'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">'state:'</span>, state);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'API called'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Critical error'</span>);  <span class="hljs-comment">// 保留</span>

<span class="hljs-comment">// 转换后</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Critical error'</span>);
</code></pre>
<p><strong>使用标准库 pattern（推荐）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">grit apply no_console_log src/
</code></pre>
<p><strong>自定义 GritQL 规则</strong>：</p>
<pre><code class="hljs language-gritql" lang="gritql">`console.log($a)` =&gt; ``
`console.debug($a)` =&gt; ``
`console.info($a)` =&gt; ``
</code></pre>
<blockquote>
<p><strong>注意</strong>: 标准库的 <code>no_console_log</code> 会自动保留 catch 块中的 console.log，更加安全。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">案例 2：Python print 转 logger</h3>
<p>将 Python 中的 <code>print</code> 语句转换为 logger 调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 转换前</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"User: <span class="hljs-subst">{username}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Error:"</span>, error)

<span class="hljs-comment"># 转换后</span>
log(<span class="hljs-string">"Hello, World"</span>)
log(<span class="hljs-string">f"User: <span class="hljs-subst">{username}</span>"</span>)
log(<span class="hljs-string">"Error:"</span>, error)
</code></pre>
<p><strong>使用标准库 pattern</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">grit apply --language python print_to_log src/
</code></pre>
<hr/>
<h3 data-id="heading-18">案例 3：移除 debugger 语句</h3>
<p>清理开发时留下的 debugger 语句。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">debugger</span>;  <span class="hljs-comment">// 调试用</span>
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);
}
</code></pre>
<p><strong>使用标准库 pattern</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">grit apply no_debugger src/
</code></pre>
<hr/>
<h3 data-id="heading-19">案例 4：import 路径调整</h3>
<p>项目目录重构时的常见需求 —— 批量更新 import 路径。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/Button'</span>
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useAuth'</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/date'</span>

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Button'</span>
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/auth'</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/format'</span>
</code></pre>
<p><strong>GritQL 规则</strong>：</p>
<pre><code class="hljs language-gritql" lang="gritql">`from '@/components/ui/$name'` =&gt; `from '@/components/$name'`
`from '@/hooks/use$name'` =&gt; `from '@/hooks/$name'`
`from '@/utils/date'` =&gt; `from '@/utils/format'`
</code></pre>
<hr/>
<h3 data-id="heading-20">案例 5：箭头函数简化</h3>
<blockquote>
<p>⚠️ <strong>限制</strong>：内联 pattern 对多参数函数的处理有限制，建议仅用于单参数场景。</p>
</blockquote>
<p>单行返回的箭头函数可以省略 <code>return</code> 和大括号。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">double</span> = x =&gt; { <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>; }
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getValue</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-keyword">return</span> config.<span class="hljs-property">value</span>; }

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">double</span> = x =&gt; x * <span class="hljs-number">2</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getValue</span> = (<span class="hljs-params"/>) =&gt; config.<span class="hljs-property">value</span>
</code></pre>
<p><strong>异步箭头函数</strong>：可以去除 <code>async</code> 和 <code>await</code>（当直接返回 Promise 时）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; { <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>); }

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
</code></pre>
<blockquote>
<p><strong>说明</strong>：当函数只是直接返回 <code>await</code> 的结果时，<code>async/await</code> 是冗余的。</p>
</blockquote>
<p><strong>GritQL 规则</strong>：</p>
<pre><code class="hljs language-gritql" lang="gritql"># 单参数箭头函数（推荐）
`$param =&gt; { return $expr }` =&gt; `$param =&gt; $expr`

# 无参数箭头函数
`() =&gt; { return $expr }` =&gt; `() =&gt; $expr`

# 异步箭头函数 - 去除 async/await
`async () =&gt; { return await $expr }` =&gt; `() =&gt; $expr`
</code></pre>
<p><strong>注意</strong>：多参数函数 <code>(a, b) =&gt; ...</code> 的转换存在括号处理问题，建议手动处理或使用 .grit 文件。</p>
<hr/>
<h3 data-id="heading-21">案例 6：框架升级迁移</h3>
<p>Grit 提供了丰富的框架升级 patterns，可自动化常见的迁移工作。</p>
<h4 data-id="heading-22">React 升级</h4>













































<table><thead><tr><th>迁移类型</th><th>Pattern</th><th>命令</th></tr></thead><tbody><tr><td>类组件 → Hooks</td><td><code>react_to_hooks</code></td><td><code>grit apply react_to_hooks src/</code></td></tr><tr><td>React Query v3 → v4</td><td><code>migrating_from_react_query_3_to_react_query_4</code></td><td><code>grit apply migrating_from_react_query_3_to_react_query_4 src/</code></td></tr><tr><td>MUI v4 → v5</td><td><code>mui4_to_mui5</code></td><td><code>grit apply mui4_to_mui5 src/</code></td></tr><tr><td>Knockout → React</td><td><code>knockout_to_react</code></td><td><code>grit apply knockout_to_react src/</code></td></tr><tr><td>Jest → Vitest</td><td><code>jest_to_vitest</code></td><td><code>grit apply jest_to_vitest src/</code></td></tr><tr><td>Chai → Jest</td><td><code>chai_to_jest</code></td><td><code>grit apply chai_to_jest src/</code></td></tr><tr><td>Enzyme → RTL</td><td><code>enzyme_rtl</code></td><td><code>grit apply enzyme_rtl src/</code></td></tr></tbody></table>
<p><strong>React 类组件转 Hooks 示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">users</span>: [], <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> }
  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>()
  }
  <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> })
    api.<span class="hljs-title function_">getUsers</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ users, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> }))
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">loading</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.state.users.length} users<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  }
}

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [users, setUsers] = <span class="hljs-title function_">useState</span>([])
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchUsers</span>()
  }, [])

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>)
    api.<span class="hljs-title function_">getUsers</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> { <span class="hljs-title function_">setUsers</span>(data); <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>) })
  }

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{users.length} users<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p><strong>使用命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 预览转换结果</span>
grit apply --dry-run react_to_hooks src/

<span class="hljs-comment"># 执行转换</span>
grit apply react_to_hooks src/

<span class="hljs-comment"># 交互式选择（逐个确认）</span>
grit apply --interactive react_to_hooks src/
</code></pre>
<h4 data-id="heading-23">Vue 升级</h4>
<p>Vue 相关的迁移 pattern 较少，建议手动或配合其他工具进行 Vue 2 → Vue 3 的升级。</p>
<h4 data-id="heading-24">其他迁移</h4>








































<table><thead><tr><th>迁移类型</th><th>Pattern</th><th>命令</th></tr></thead><tbody><tr><td>Cypress → Playwright</td><td><code>cypress_to_playwright</code></td><td><code>grit apply cypress_to_playwright src/</code></td></tr><tr><td>Protractor → Playwright</td><td><code>protractor_to_playwright</code></td><td><code>grit apply protractor_to_playwright src/</code></td></tr><tr><td>CodeceptJS → Playwright</td><td><code>codecept_to_playwright</code></td><td><code>grit apply codecept_to_playwright src/</code></td></tr><tr><td>Moment → date-fns</td><td><code>moment_to_datefns</code></td><td><code>grit apply moment_to_datefns src/</code></td></tr><tr><td>io-ts → Zod</td><td><code>iots_to_zod</code></td><td><code>grit apply iots_to_zod src/</code></td></tr><tr><td>OpenAI v3 → v4</td><td><code>openai_v4</code></td><td><code>grit apply openai_v4 src/</code></td></tr></tbody></table>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Jest 迁移到 Vitest</span>
grit apply --dry-run jest_to_vitest src/
grit apply jest_to_vitest src/

<span class="hljs-comment"># OpenAI SDK 升级</span>
grit apply --dry-run openai_v4 src/
grit apply openai_v4 src/

<span class="hljs-comment"># 测试框架迁移（Cypress → Playwright）</span>
grit apply --dry-run cypress_to_playwright tests/
grit apply cypress_to_playwright tests/
</code></pre>
<hr/>
<h3 data-id="heading-25">案例 7：对象简写属性</h3>
<blockquote>
<p>⚠️ <strong>限制</strong>：必须使用 <code>.grit</code> 文件，内联语法不支持，且转换后需要人工检查。</p>
</blockquote>
<p>ES6 允许属性名和变量名相同时省略冒号。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 转换前</span>
<span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: name, <span class="hljs-attr">age</span>: age, <span class="hljs-attr">userId</span>: id }
<span class="hljs-keyword">return</span> { <span class="hljs-attr">data</span>: data, <span class="hljs-attr">isLoading</span>: loading }

<span class="hljs-comment">// 转换后</span>
<span class="hljs-keyword">const</span> user = { name, age, <span class="hljs-attr">userId</span>: id }
<span class="hljs-keyword">return</span> { data, <span class="hljs-attr">isLoading</span>: loading }
</code></pre>
<p><strong>创建 <code>shorthand.grit</code> 文件</strong>：</p>
<pre><code class="hljs language-grit" lang="grit"># 指定使用的引擎版本（marzano 是 Grit 的匹配引擎）
engine marzano(0.1)
# 指定目标语言
language js

`{ $props }` where {
  $props &lt;: some {
    `$k: $k` =&gt; `$k`
  }
}
</code></pre>
<blockquote>
<p><strong><code>engine marzano(0.1)</code></strong>：Grit 的匹配引擎版本，所有 <code>.grit</code> 文件都需要在开头声明。</p>
</blockquote>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 应用转换（可能需要运行多次直到所有属性都转换完成）</span>
grit apply shorthand.grit src/
</code></pre>
<p><strong>测试结果</strong>：</p>
<ul>
<li>✅ 可以匹配并转换 <code>{ name: name }</code> → <code>{ name }</code></li>
<li>⚠️ 多个属性需要运行多次才能全部转换</li>
<li>⚠️ 转换后建议人工检查结果</li>
</ul>
<hr/>
<h2 data-id="heading-26">常用标准 Patterns</h2>
<p>Grit 提供了丰富的标准 patterns 库，使用 <code>grit list</code> 查看。</p>
<h3 data-id="heading-27">JavaScript/TypeScript 常用 Patterns</h3>























































<table><thead><tr><th>Pattern</th><th>说明</th><th>命令</th></tr></thead><tbody><tr><td><code>no_console_log</code></td><td>移除 <code>console.log</code></td><td><code>grit apply no_console_log</code></td></tr><tr><td><code>no_debugger</code></td><td>移除 <code>debugger</code></td><td><code>grit apply no_debugger</code></td></tr><tr><td><code>no_alert</code></td><td>移除 <code>alert()</code></td><td><code>grit apply no_alert</code></td></tr><tr><td><code>no_commented_out_code</code></td><td>移除注释代码</td><td><code>grit apply no_commented_out_code</code></td></tr><tr><td><code>es6_imports</code></td><td>转换为 ES6 imports</td><td><code>grit apply es6_imports</code></td></tr><tr><td><code>es6_exports</code></td><td>转换为 ES6 exports</td><td><code>grit apply es6_exports</code></td></tr><tr><td><code>jest_to_vitest</code></td><td>Jest 迁移到 Vitest</td><td><code>grit apply jest_to_vitest</code></td></tr><tr><td><code>chai_to_jest</code></td><td>Chai 迁移到 Jest</td><td><code>grit apply chai_to_jest</code></td></tr><tr><td><code>openai_v4</code></td><td>OpenAI v4 迁移</td><td><code>grit apply openai_v4</code></td></tr></tbody></table>
<h3 data-id="heading-28">Python 常用 Patterns</h3>






























<table><thead><tr><th>Pattern</th><th>说明</th><th>命令</th></tr></thead><tbody><tr><td><code>print_to_log</code></td><td>print 转 logger</td><td><code>grit apply --language python print_to_log</code></td></tr><tr><td><code>py_no_debugger</code></td><td>移除 <code>pdb.set_trace()</code></td><td><code>grit apply py_no_debugger</code></td></tr><tr><td><code>no_skipped_tests</code></td><td>移除跳过的测试</td><td><code>grit apply no_skipped_tests</code></td></tr><tr><td><code>openai</code></td><td>OpenAI SDK 迁移</td><td><code>grit apply openai</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-29">支持的语言</h2>
<p>Grit 支持以下编程语言（使用 <code>--language</code> 选项指定）：</p>
<h3 data-id="heading-30">语言列表</h3>

























































































<table><thead><tr><th>标识符</th><th>语言</th></tr></thead><tbody><tr><td><code>js</code></td><td>JavaScript / TypeScript / JSX / TSX</td></tr><tr><td><code>html</code></td><td>HTML</td></tr><tr><td><code>css</code></td><td>CSS</td></tr><tr><td><code>json</code></td><td>JSON</td></tr><tr><td><code>java</code></td><td>Java</td></tr><tr><td><code>kotlin</code></td><td>Kotlin</td></tr><tr><td><code>csharp</code></td><td>C#</td></tr><tr><td><code>python</code></td><td>Python</td></tr><tr><td><code>markdown</code></td><td>Markdown</td></tr><tr><td><code>go</code></td><td>Go</td></tr><tr><td><code>rust</code></td><td>Rust</td></tr><tr><td><code>ruby</code></td><td>Ruby</td></tr><tr><td><code>elixir</code></td><td>Elixir</td></tr><tr><td><code>solidity</code></td><td>Solidity</td></tr><tr><td><code>hcl</code></td><td>HCL</td></tr><tr><td><code>yaml</code></td><td>YAML</td></tr><tr><td><code>sql</code></td><td>SQL</td></tr><tr><td><code>vue</code></td><td>Vue</td></tr><tr><td><code>toml</code></td><td>TOML</td></tr><tr><td><code>php</code></td><td>PHP</td></tr></tbody></table>
<h3 data-id="heading-31">使用示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Python 项目 - 将 print 转换为 logger</span>
grit apply --language python print_to_log src/

<span class="hljs-comment"># Go 项目 - 移除 debugger 语句</span>
grit apply --language go no_debugger src/

<span class="hljs-comment"># Java 项目 - 列出可用的 Java patterns</span>
grit list --language java

<span class="hljs-comment"># Rust 项目 - 应用自定义 pattern</span>
grit apply --language rust ./patterns/custom.grit src/

<span class="hljs-comment"># Vue 项目 - 检查代码规范</span>
grit check --language vue src/

<span class="hljs-comment"># 多语言项目 - 同时处理多种文件类型</span>
grit apply --language js no_console_log src/
grit apply --language python print_to_log src/

<span class="hljs-comment"># 查看某个语言的可用 patterns</span>
grit patterns list --language python
</code></pre>
<hr/>
<h2 data-id="heading-32">工作流最佳实践</h2>
<h3 data-id="heading-33">推荐工作流程</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 列出可用的 patterns</span>
grit list --language js

<span class="hljs-comment"># 2. 查看 pattern 详情</span>
grit patterns describe no_console_log

<span class="hljs-comment"># 3. 预览模式（不会修改文件）</span>
grit apply --dry-run no_console_log src/

<span class="hljs-comment"># 4. 限制范围测试</span>
grit apply no_console_log src/components/

<span class="hljs-comment"># 5. 交互式应用（逐个确认）</span>
grit apply --interactive no_console_log src/

<span class="hljs-comment"># 6. 确认后正式应用</span>
grit apply no_console_log src/
</code></pre>
<h3 data-id="heading-34">使用配置文件</h3>
<p>创建 <code>.grit/grit.yaml</code> 管理项目规则：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">patterns:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">no_console_log</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">no_debugger</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">.grit/patterns/**/*.grit</span>

<span class="hljs-attr">ignored:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">node_modules/**</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">dist/**</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build/**</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"**/*.min.js"</span>

<span class="hljs-attr">enforcement:</span>
  <span class="hljs-attr">level:</span> <span class="hljs-string">fix</span>
</code></pre>
<h3 data-id="heading-35">CI 集成</h3>
<p>在 GitHub Actions 中集成代码检查：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Grit</span> <span class="hljs-string">Code</span> <span class="hljs-string">Quality</span>

<span class="hljs-attr">on:</span> [<span class="hljs-string">pull_request</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">grit-check:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Grit</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">@getgrit/cli</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">code</span> <span class="hljs-string">patterns</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">grit</span> <span class="hljs-string">check</span> <span class="hljs-string">--github-actions</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">工作原理</h2>
<h3 data-id="heading-37">处理流程</h3>
<pre><code class="hljs language-scss" lang="scss">源代码
    ↓
┌─────────────────────────────────────┐
│  Tree-sitter 解析器                 │
│  (多语言支持，增量解析)              │
└─────────────────────────────────────┘
    ↓ AST
┌─────────────────────────────────────┐
│  Grit 模式匹配引擎                  │
│  (变量绑定，条件过滤)                │
└─────────────────────────────────────┘
    ↓ 匹配结果
┌─────────────────────────────────────┐
│  AST 转换引擎                       │
│  (语义保持，结构转换)                │
└─────────────────────────────────────┘
    ↓ 修改后的 AST
┌─────────────────────────────────────┐
│  代码生成器                         │
│  (保留格式，生成代码)                │
└─────────────────────────────────────┘
    ↓
转换后代码
</code></pre>
<h3 data-id="heading-38">为什么比正则更安全？</h3>



































<table><thead><tr><th>特性</th><th>正则表达式</th><th>Grit</th></tr></thead><tbody><tr><td>理解代码结构</td><td>❌</td><td>✅</td></tr><tr><td>忽略空白/引号差异</td><td>❌</td><td>✅</td></tr><tr><td>变量绑定与复用</td><td>❌</td><td>✅</td></tr><tr><td>AST 感知</td><td>❌</td><td>✅</td></tr><tr><td>语义安全</td><td>❌</td><td>✅</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-39">常见问题</h2>
<p><strong>Q: 转换会破坏代码格式吗？</strong></p>
<p>A: 不会。Grit 保留原始格式，只修改语义结构。</p>
<p><strong>Q: 内联 pattern 怎么写？</strong></p>
<p>A: 使用单引号包裹整个 pattern（反引号内是匹配代码）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 正确 - 单引号包裹，shell 不会解析反引号</span>
grit apply <span class="hljs-string">'`console.log($_)`'</span> file.js

<span class="hljs-comment"># 错误 - shell 会尝试执行反引号内的命令</span>
grit apply `console.log(<span class="hljs-variable">$_</span>)` file.js
</code></pre>
<p><strong>Q: 如何查看所有可用的 patterns？</strong></p>
<p>A: 使用 <code>grit list</code> 命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有</span>
grit list

<span class="hljs-comment"># 按语言过滤</span>
grit list --language js
grit list --language python
</code></pre>
<p><strong>Q: <code>--json</code> 和 <code>--jsonl</code> 有什么区别？</strong></p>
<p>A: <code>--json</code> 目前不被 <code>apply_pattern</code> 支持，使用 <code>--jsonl</code> 获取 JSON Lines 格式输出。</p>
<p><strong>Q: 如何限制修改数量？</strong></p>
<p>A: 使用 <code>--limit</code> 选项：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只修改前 10 处</span>
grit apply --<span class="hljs-built_in">limit</span> 10 no_console_log src/
</code></pre>
<p><strong>Q: 如何安全地进行大规模转换？</strong></p>
<p>A: 建议按以下步骤：</p>
<ol>
<li>先用 <code>--dry-run</code> 预览</li>
<li>用 <code>--limit</code> 小范围测试</li>
<li>用 <code>--interactive</code> 交互式确认</li>
<li>确认无误后正式应用</li>
</ol>
<hr/>
<h2 data-id="heading-40">总结</h2>
<p>Grit 的核心价值在于：</p>
<ol>
<li><strong>简单</strong> - 用代码片段写规则，无需懂 AST</li>
<li><strong>安全</strong> - 结构化匹配，不会误伤代码</li>
<li><strong>高效</strong> - 秒级完成大规模代码迁移</li>
<li><strong>可维护</strong> - 规则即文档，易于 review</li>
<li><strong>丰富</strong> - 内置大量标准 patterns，开箱即用</li>
</ol>
<p>下次遇到代码迁移任务，不妨试试 Grit，让繁琐的重构工作变得轻松高效。</p>
<hr/>
<h2 data-id="heading-41">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgrit.io%2F" target="_blank" title="https://grit.io/" ref="nofollow noopener noreferrer">Grit 官网</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.grit.io%2F" target="_blank" title="https://docs.grit.io/" ref="nofollow noopener noreferrer">Grit 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbiomejs%2Fgritql-stdlib" target="_blank" title="https://github.com/biomejs/gritql-stdlib" ref="nofollow noopener noreferrer">Grit 标准 Patterns 库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbiomejs%2Fgritql" target="_blank" title="https://github.com/biomejs/gritql" ref="nofollow noopener noreferrer">Grit GitHub</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 C#.NET Interlocked.Increment：原子操作的核心]]></title>    <link>https://juejin.cn/post/7589110783147442210</link>    <guid>https://juejin.cn/post/7589110783147442210</guid>    <pubDate>2025-12-30T00:00:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589110783147442210" data-draft-id="7589156297788522531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 C#.NET Interlocked.Increment：原子操作的核心"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-30T00:00:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 C#.NET Interlocked.Increment：原子操作的核心
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T00:00:34.000Z" title="Tue Dec 30 2025 00:00:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Interlocked.Increment</code> 是 <code>.NET</code> 中一个重要的线程安全操作方法，用于以原子方式递增变量的值。它位于 <code>System.Threading</code> 命名空间中，提供了一种轻量级的线程同步机制。</p>
<p>这些方法包括：</p>

































<table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td><code>Increment(ref int location)</code></td><td>原子 +1</td></tr><tr><td><code>Decrement(ref int location)</code></td><td>原子 -1</td></tr><tr><td><code>Add(ref int location, int value)</code></td><td>原子加指定值</td></tr><tr><td><code>Exchange(ref T location, T value)</code></td><td>原子交换值</td></tr><tr><td><code>CompareExchange(ref T location, T value, T comparand)</code></td><td>CAS 操作（Compare-And-Swap）</td></tr><tr><td><code>Read(ref long location)</code></td><td>原子读取 long 值</td></tr></tbody></table>
<p>这些操作都是 线程安全且无锁 (<code>lock-free</code>) 的。</p>
<h3 data-id="heading-1">核心概念与作用</h3>
<h4 data-id="heading-2">原子操作定义</h4>
<ul>
<li>
<p>不可分割性：操作要么完全执行，要么完全不执行</p>
</li>
<li>
<p>线程安全：多线程环境下保证操作完整性</p>
</li>
<li>
<p>无锁机制：避免传统锁带来的性能开销</p>
</li>
</ul>
<h4 data-id="heading-3">核心特性</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>线程安全</td><td>无需额外同步机制</td></tr><tr><td>硬件级原子性</td><td>使用 CPU 原子指令实现</td></tr><tr><td>内存屏障</td><td>确保操作前后内存一致性</td></tr><tr><td>高性能</td><td>比锁机制快 10-50 倍</td></tr></tbody></table>
<h3 data-id="heading-4">底层实现原理</h3>
<h4 data-id="heading-5">x86/x64 架构实现</h4>
<pre><code class="hljs language-Assembly" lang="Assembly">; x86 实现
lock xadd [location], eax

; x64 实现
lock xadd [location], rax
</code></pre>
<ul>
<li>
<p><code>lock</code> 前缀：锁定内存总线，确保操作原子性</p>
</li>
<li>
<p><code>xadd</code> 指令：交换并相加寄存器与内存值</p>
</li>
</ul>
<h3 data-id="heading-6">基本用法</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">var</span> threads = <span class="hljs-keyword">new</span> Thread[<span class="hljs-number">10</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
        {
            threads[i] = <span class="hljs-keyword">new</span> Thread(IncrementCounter);
            threads[i].Start();
        }

        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> t <span class="hljs-keyword">in</span> threads)
            t.Join();

        Console.WriteLine(<span class="hljs-string">$"最终计数值: <span class="hljs-subst">{_counter}</span>"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IncrementCounter</span>()</span>
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)
        {
            Interlocked.Increment(<span class="hljs-keyword">ref</span> _counter);
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">最终计数值: 10000</span>
</code></pre>
<p>即使多个线程并发操作同一个变量，也不会出现竞争问题。</p>
<h3 data-id="heading-7">为什么不能直接用 _counter++</h3>
<p><code>_counter++</code> 实际上是三步操作：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> temp = _counter;
temp = temp + <span class="hljs-number">1</span>;
_counter = temp;
</code></pre>
<p>在多线程环境中，这三步可能被打断，比如：</p>





















<table><thead><tr><th>线程A</th><th>线程B</th></tr></thead><tbody><tr><td>读取 <code>_counter = 0</code></td><td>读取 <code>_counter = 0</code></td></tr><tr><td>+1 → <code>1</code></td><td>+1 → <code>1</code></td></tr><tr><td>写回 <code>_counter = 1</code></td><td>写回 <code>_counter = 1</code></td></tr></tbody></table>
<p>最终 <code>_counter = 1</code>，而不是 2。
这就是竞争条件（<code>race condition</code>）。</p>
<p><code>Interlocked.Increment</code> 内部使用 <code>CPU</code> 的原子指令（如 <code>x86</code> 的 <code>LOCK INC</code>），
确保操作不可中断，因此绝对线程安全。</p>
<h3 data-id="heading-8">返回值</h3>
<p><code>Interlocked.Increment</code> 会返回自增后的值：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
<span class="hljs-built_in">int</span> newValue = Interlocked.Increment(<span class="hljs-keyword">ref</span> count);

Console.WriteLine(newValue); <span class="hljs-comment">// 1</span>
Console.WriteLine(count);    <span class="hljs-comment">// 1</span>
</code></pre>
<p>所以它可以直接用于生成唯一 <code>ID</code>、计数等逻辑。</p>
<h3 data-id="heading-9">支持的类型</h3>





























<table><thead><tr><th>方法</th><th>支持的类型</th></tr></thead><tbody><tr><td><code>Interlocked.Increment</code></td><td><code>int</code>, <code>long</code></td></tr><tr><td><code>Interlocked.Decrement</code></td><td><code>int</code>, <code>long</code></td></tr><tr><td><code>Interlocked.Add</code></td><td><code>int</code>, <code>long</code></td></tr><tr><td><code>Interlocked.Exchange</code></td><td><code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>, <code>object</code></td></tr><tr><td><code>Interlocked.CompareExchange</code></td><td>同上</td></tr></tbody></table>
<h3 data-id="heading-10">性能分析</h3>
<p>相比于使用 <code>lock</code> 的同步方式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">lock</span>(_lockObj)
{
    _counter++;
}
</code></pre>
<p><code>Interlocked.Increment</code>：</p>
<p>✅ 无锁操作（<code>Lock-free</code>）
✅ 内核级原子性（基于 <code>CPU</code> 指令）
✅ 极高性能（纳秒级）</p>
<p>实测在多线程计数场景中性能提升 5~10 倍以上。
非常适合高频次计数（如统计请求量、日志写入次数、对象实例数）。</p>
<h3 data-id="heading-11">完整的原子操作方法集</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;

<span class="hljs-keyword">class</span> <span class="hljs-title">InterlockedCompleteExample</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">long</span> _bigCounter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _value = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">object</span> _syncObject = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DemonstrateAllMethods</span>()</span>
    {
        <span class="hljs-comment">// 1. Increment - 递增</span>
        <span class="hljs-built_in">int</span> result1 = Interlocked.Increment(<span class="hljs-keyword">ref</span> _counter);
        Console.WriteLine(<span class="hljs-string">$"After Increment: <span class="hljs-subst">{_counter}</span>, Returned: <span class="hljs-subst">{result1}</span>"</span>);

        <span class="hljs-comment">// 2. Decrement - 递减</span>
        <span class="hljs-built_in">int</span> result2 = Interlocked.Decrement(<span class="hljs-keyword">ref</span> _counter);
        Console.WriteLine(<span class="hljs-string">$"After Decrement: <span class="hljs-subst">{_counter}</span>, Returned: <span class="hljs-subst">{result2}</span>"</span>);

        <span class="hljs-comment">// 3. Add - 加法</span>
        <span class="hljs-built_in">int</span> result3 = Interlocked.Add(<span class="hljs-keyword">ref</span> _counter, <span class="hljs-number">5</span>);
        Console.WriteLine(<span class="hljs-string">$"After Add(5): <span class="hljs-subst">{_counter}</span>, Returned: <span class="hljs-subst">{result3}</span>"</span>);

        <span class="hljs-comment">// 4. Exchange - 交换</span>
        <span class="hljs-built_in">int</span> original = Interlocked.Exchange(<span class="hljs-keyword">ref</span> _value, <span class="hljs-number">20</span>);
        Console.WriteLine(<span class="hljs-string">$"After Exchange: <span class="hljs-subst">{_value}</span>, Original: <span class="hljs-subst">{original}</span>"</span>);

        <span class="hljs-comment">// 5. CompareExchange - 比较并交换</span>
        <span class="hljs-built_in">int</span> comparand = <span class="hljs-number">20</span>;
        <span class="hljs-built_in">int</span> newValue = <span class="hljs-number">30</span>;
        <span class="hljs-built_in">int</span> result5 = Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _value, newValue, comparand);
        Console.WriteLine(<span class="hljs-string">$"After CompareExchange: <span class="hljs-subst">{_value}</span>, Returned: <span class="hljs-subst">{result5}</span>"</span>);

        <span class="hljs-comment">// 6. Read - 读取 long 类型（确保在32位系统上原子读取）</span>
        <span class="hljs-built_in">long</span> readResult = Interlocked.Read(<span class="hljs-keyword">ref</span> _bigCounter);
        Console.WriteLine(<span class="hljs-string">$"Read long value: <span class="hljs-subst">{readResult}</span>"</span>);

        <span class="hljs-comment">// 7. And - 位与操作（.NET 5+）</span>
        <span class="hljs-comment">// Interlocked.And(ref _value, 0x0F);</span>

        <span class="hljs-comment">// 8. Or - 位或操作（.NET 5+）</span>
        <span class="hljs-comment">// Interlocked.Or(ref _value, 0xF0);</span>
    }
}
</code></pre>
<h3 data-id="heading-12">典型应用场景</h3>
<h4 data-id="heading-13">多线程计数器</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _activeConnections;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnClientConnect</span>()</span>
{
    <span class="hljs-keyword">var</span> current = Interlocked.Increment(<span class="hljs-keyword">ref</span> _activeConnections);
    Console.WriteLine(<span class="hljs-string">$"连接数增加到 <span class="hljs-subst">{current}</span>"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnClientDisconnect</span>()</span>
{
    <span class="hljs-keyword">var</span> current = Interlocked.Decrement(<span class="hljs-keyword">ref</span> _activeConnections);
    Console.WriteLine(<span class="hljs-string">$"连接数减少到 <span class="hljs-subst">{current}</span>"</span>);
}
</code></pre>
<h4 data-id="heading-14">分配唯一自增 ID</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _nextId = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetNextId</span>()</span>
{
    <span class="hljs-keyword">return</span> Interlocked.Increment(<span class="hljs-keyword">ref</span> _nextId);
}
</code></pre>
<h4 data-id="heading-15">控制并发访问次数</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _running = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ProcessAsync</span>()</span>
{
    <span class="hljs-keyword">if</span> (Interlocked.Increment(<span class="hljs-keyword">ref</span> _running) &gt; <span class="hljs-number">5</span>)
    {
        Console.WriteLine(<span class="hljs-string">"超过并发限制，拒绝执行"</span>);
        Interlocked.Decrement(<span class="hljs-keyword">ref</span> _running);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">await</span> DoWorkAsync();
    }
    <span class="hljs-keyword">finally</span>
    {
        Interlocked.Decrement(<span class="hljs-keyword">ref</span> _running);
    }
}
</code></pre>
<h3 data-id="heading-16">高级用法</h3>
<h4 data-id="heading-17">无锁栈实现</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LockFreeStack</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>
    {
        <span class="hljs-keyword">public</span> T Value { <span class="hljs-keyword">get</span>; }
        <span class="hljs-keyword">public</span> Node Next { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Node</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span>
        {
            Value = <span class="hljs-keyword">value</span>;
        }
    }

    <span class="hljs-keyword">private</span> Node _head;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Push</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span>
    {
        <span class="hljs-keyword">var</span> newNode = <span class="hljs-keyword">new</span> Node(<span class="hljs-keyword">value</span>);
        Node oldHead;
        <span class="hljs-keyword">do</span>
        {
            oldHead = _head;
            newNode.Next = oldHead;
        }
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _head, newNode, oldHead) != oldHead);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryPop</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> T <span class="hljs-keyword">value</span></span>)</span>
    {
        Node oldHead;
        <span class="hljs-keyword">do</span>
        {
            oldHead = _head;
            <span class="hljs-keyword">if</span> (oldHead == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">value</span> = <span class="hljs-literal">default</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _head, oldHead.Next, oldHead) != oldHead);

        <span class="hljs-keyword">value</span> = oldHead.Value;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsEmpty =&gt; _head == <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-18">线程安全的对象池</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ObjectPool</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span>, <span class="hljs-title">new</span>()
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>
    {
        <span class="hljs-keyword">public</span> T Value { <span class="hljs-keyword">get</span>; }
        <span class="hljs-keyword">public</span> Node Next { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Node</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span>
        {
            Value = <span class="hljs-keyword">value</span>;
        }
    }

    <span class="hljs-keyword">private</span> Node _head;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _maxSize;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ObjectPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> maxSize = <span class="hljs-number">100</span></span>)</span>
    {
        _maxSize = maxSize;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Return</span>(<span class="hljs-params">T item</span>)</span>
    {
        <span class="hljs-keyword">if</span> (Interlocked.Read(<span class="hljs-keyword">ref</span> _count) &gt;= _maxSize)
        {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 池已满，丢弃对象</span>
        }

        <span class="hljs-keyword">var</span> newNode = <span class="hljs-keyword">new</span> Node(item);
        Node oldHead;
        <span class="hljs-keyword">do</span>
        {
            oldHead = _head;
            newNode.Next = oldHead;
        }
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _head, newNode, oldHead) != oldHead);

        Interlocked.Increment(<span class="hljs-keyword">ref</span> _count);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Get</span>()</span>
    {
        Node oldHead;
        <span class="hljs-keyword">do</span>
        {
            oldHead = _head;
            <span class="hljs-keyword">if</span> (oldHead == <span class="hljs-literal">null</span>)
            {
                Interlocked.Increment(<span class="hljs-keyword">ref</span> _count);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> T();
            }
        }
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _head, oldHead.Next, oldHead) != oldHead);

        Interlocked.Decrement(<span class="hljs-keyword">ref</span> _count);
        <span class="hljs-keyword">return</span> oldHead.Value;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Count =&gt; (<span class="hljs-built_in">int</span>)Interlocked.Read(<span class="hljs-keyword">ref</span> _count);
}
</code></pre>
<h3 data-id="heading-19">与 lock、Monitor 的区别</h3>



































<table><thead><tr><th>特性</th><th>Interlocked</th><th>lock / Monitor</th></tr></thead><tbody><tr><td>是否锁住线程</td><td>否</td><td>是</td></tr><tr><td>原子性</td><td>✅</td><td>✅</td></tr><tr><td>是否可中断</td><td>不可</td><td>可被其他线程等待</td></tr><tr><td>性能</td><td>极高</td><td>一般</td></tr><tr><td>适用场景</td><td>简单数值、指针操作</td><td>多步复杂逻辑</td></tr></tbody></table>
<ul>
<li>
<p>如果只是“计数/标志位更新”，用 <code>Interlocked</code>；</p>
</li>
<li>
<p>如果涉及多个变量或逻辑组合，用 <code>lock</code>。</p>
</li>
</ul>
<h3 data-id="heading-20">CompareExchange (CAS) 补充理解</h3>
<p><code>Interlocked.CompareExchange</code> 是构建更复杂无锁结构的核心：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> location = <span class="hljs-number">0</span>;
<span class="hljs-built_in">int</span> newValue = <span class="hljs-number">1</span>;
<span class="hljs-built_in">int</span> expected = <span class="hljs-number">0</span>;

<span class="hljs-built_in">int</span> old = Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> location, newValue, expected);
</code></pre>
<ul>
<li>
<p>如果 <code>location == expected</code> → 把 <code>location</code> 改成 <code>newValue</code>；</p>
</li>
<li>
<p>否则什么都不做；</p>
</li>
<li>
<p>返回修改前的旧值。</p>
</li>
</ul>
<p>这就是经典的 <code>Compare-And-Swap</code> (CAS)，
是无锁队列、无锁堆栈、无锁缓存等的基础原语。</p>
<h3 data-id="heading-21">与 async/await 的结合注意事项</h3>
<p><code>Interlocked</code> 是同步原子操作，适用于多线程并发，不涉及异步上下文。
即使在 <code>async</code> 方法中使用，也完全没问题：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _count;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">LogAsync</span>()</span>
{
    Interlocked.Increment(<span class="hljs-keyword">ref</span> _count);
    <span class="hljs-keyword">await</span> File.AppendAllTextAsync(<span class="hljs-string">"log.txt"</span>, <span class="hljs-string">$"<span class="hljs-subst">{_count}</span>\n"</span>);
}
</code></pre>
<ul>
<li>
<p>它不会保证异步顺序；</p>
</li>
<li>
<p>它保证计数线程安全。</p>
</li>
</ul>
<h3 data-id="heading-22">总结</h3>









































<table><thead><tr><th>特性</th><th>Interlocked.Increment</th></tr></thead><tbody><tr><td>命名空间</td><td><code>System.Threading</code></td></tr><tr><td>返回值</td><td>自增后的值</td></tr><tr><td>线程安全</td><td>✅ 原子操作</td></tr><tr><td>锁机制</td><td>无锁</td></tr><tr><td>支持类型</td><td><code>int</code>, <code>long</code></td></tr><tr><td>性能</td><td>极高</td></tr><tr><td>应用场景</td><td>计数、ID生成、并发控制、原子状态更新</td></tr><tr><td>替代方案</td><td>lock、Monitor、Volatile、CAS</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[旮旯c语言三个任务]]></title>    <link>https://juejin.cn/post/7589130173837951026</link>    <guid>https://juejin.cn/post/7589130173837951026</guid>    <pubDate>2025-12-29T16:05:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589130173837951026" data-draft-id="7587412021709127686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="旮旯c语言三个任务"/> <meta itemprop="keywords" content="C,C++"/> <meta itemprop="datePublished" content="2025-12-29T16:05:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇宙超级无敌暴龙战士"/> <meta itemprop="url" content="https://juejin.cn/user/2781133666269578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            旮旯c语言三个任务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2781133666269578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇宙超级无敌暴龙战士
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T16:05:37.000Z" title="Mon Dec 29 2025 16:05:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d6f49c4b68490ea4ca3949164e24f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6H5a6Z6LaF57qn5peg5pWM5pq06b6Z5oiY5aOr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767629137&amp;x-signature=Ym9Xx0qSbkabDeGR4P%2FJHqB5pQM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>

// 任务1：计算数组元素和
int getArrSum(int arr<span class="hljs-section">[]</span>, int len) {
    int <span class="hljs-attr">sum</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
        sum += arr<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
    }
    return sum<span class="hljs-comment">;</span>
}

// 任务2：获取数组最大值
int getArrMax(int arr<span class="hljs-section">[]</span>, int len) {
    int <span class="hljs-attr">max</span> = arr[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt; len; i++) {</span>
        if (arr<span class="hljs-section">[i]</span> &gt; max) {
            <span class="hljs-attr">max</span> = arr[i]<span class="hljs-comment">;</span>
        }
    }
    return max<span class="hljs-comment">;</span>
}

// 任务3：查找元素下标
int findArrValue(int arr<span class="hljs-section">[]</span>, int len, int val) {
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
        if (arr<span class="hljs-section">[i]</span> == val) {
            return i<span class="hljs-comment">;</span>
        }
    }
    return -1<span class="hljs-comment">;</span>
}

// 程序入口main函数
int main() {
    int arr<span class="hljs-section">[]</span> = {1, 2, 3, 4, 5}<span class="hljs-comment">;</span>
    int <span class="hljs-attr">len</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
    
    // 测试任务1
    printf("数组和：%d\n", getArrSum(arr, len))<span class="hljs-comment">;</span>
    // 测试任务2
    printf("数组最大值：%d\n", getArrMax(arr, len))<span class="hljs-comment">;</span>
    // 测试任务3
    printf("元素3的下标：%d\n", findArrValue(arr, len, 3))<span class="hljs-comment">;</span>
    
    return 0<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a93fbbb1404b406caaa12a1047dc20a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6H5a6Z6LaF57qn5peg5pWM5pq06b6Z5oiY5aOr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767629137&amp;x-signature=z5KUp2qGpi1Tq7GIHwj66Mf9gPE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Amazon Nova模型实现自动化视频高光剪辑]]></title>    <link>https://juejin.cn/post/7589104492883394612</link>    <guid>https://juejin.cn/post/7589104492883394612</guid>    <pubDate>2025-12-29T15:13:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589104492883394612" data-draft-id="7589107312113254409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Amazon Nova模型实现自动化视频高光剪辑"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-29T15:13:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Amazon Nova模型实现自动化视频高光剪辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:13:48.000Z" title="Mon Dec 29 2025 15:13:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读36分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本方案旨在利用Amazon自研的Nova多模态理解类模型（Vision‑Language Model，简称VLM）和多模态嵌入模型（Multimodal Embedding Model，简称MME），实现<strong>自动化的视频高光识别与剪辑</strong>。输入视频文件，通过<strong>多模态模型理解</strong>或<strong>结合语义摘要与嵌入检索</strong>实现素材定位，识别高光片段，并合成剪辑。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fautomated-video-highlight-clipping-using-amazon-nova-model-1.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/automated-video-highlight-clipping-using-amazon-nova-model-1.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b192fe40d1bc40878e5d725fe3d46e0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=WSd%2F8zjEfo2ifkAlxQ%2BD9yWtdtA%3D" alt="" loading="lazy"/></a></p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejinhead_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejinhead_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<p><strong>方案概览：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0ee68851a94990b06b65ceaed1251c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=JlviEzifV%2BMx9YKIO%2BoA6GgUMYQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>文章概览：</strong></p>
<ul>
<li>模型介绍：Nova 多模态理解类模型（VLM）及多模态嵌入模型（MME）</li>
<li>视频高光剪辑的主要方法：</li>
</ul>
<ol>
<li>
<p><strong>纯VLM:</strong> 用Nova LLM直接进行视频理解，输出高光片段的开始和结束时间点</p>
<ol>
<li>方案架构与案例代码</li>
<li>Nova理解类模型输出视频精准时间戳（timestamp）的提示词工程技巧</li>
<li>效果优化：通过切片增加识别精准度</li>
</ol>
</li>
<li>
<p><strong>VLM+MME（video）</strong> ：结合语义摘要与视频嵌入检索</p>
<ol>
<li>方案架构与案例代码（<strong>2.1 基础：高光压缩； 2.2 跨视频内容驱动的高光剪辑； 2.3 历史素材驱动的模板化高光生成</strong>）</li>
<li>成本与效果优化思路：片段聚类，初筛，去重</li>
<li>降本方案：<strong>2.4 VLM+MME（image）</strong> : 视频抽帧，结合语义摘要与抽帧嵌入检索</li>
</ol>
</li>
</ol>
<ul>
<li>附加考虑：背景音乐，转场动画，字幕及其他效果自动化</li>
<li><strong>总结与讨论：实际应用场景，方案特点和选型思路</strong></li>
<li>可用性与定价</li>
</ul>
<h2 data-id="heading-0">模型介绍</h2>
<p>Amazon Web Services（Amazon）推出的 Amazon Nova 自研模型系列，是一组基础模型（foundation models），覆盖文本、图像、视频、语音和智能代理等多模态输入与输出，旨在为企业构建生成式 AI 应用提供性能优越、成本更低、可定制性更强的选择。现已在 Amazon Bedrock 上提供。更多模型全系列信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fnova%2F" target="_blank" title="https://aws.amazon.com/nova/" ref="nofollow noopener noreferrer">aws.amazon.com/nova/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fautomated-video-highlight-clipping-using-amazon-nova-model-2.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/automated-video-highlight-clipping-using-amazon-nova-model-2.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175e7a53eae4445dbf53053d5997b01d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=i4VN2VIHXYBwIn4pzX2SrXbSAps%3D" alt="" loading="lazy"/></a></p>
<p>本方案涉及两类Nova模型：理解类模型和多模态嵌入模型。</p>
<h4 data-id="heading-1"><strong>理解类模型（Nova LLM）</strong></h4>
<p>Amazon Nova Lite 和 Amazon Nova Pro 是 Amazon Nova理解类模型系列（Nova Micro/Lite/Pro/Premier）中两款高性价，低延迟的多模态模型，支持文本、图像、视频等多种格式，并输出文本响应。<br/>
Nova Lite：定位为 “极低成本” 的多模态理解模型，能够以极快的响应速度处理图像、视频和文本输入，生成文本输出。<br/>
Nova Pro：在精度、速度与成本之间取得平衡，是面向广泛任务的高能力多模态理解模型。<br/>
二者均支持 200 多种语言，并且可通过 Amazon Bedrock 进行定制、微调、结合检索增强生成（RAG）等，适合企业级应用。<br/>
在本文方案中，我们将使用Nova LLM的视频理解能力，输入视频，通过提示词工程，获得高光片段时间点的输出。</p>
<h3 data-id="heading-2"><strong>多模态嵌入模型（Nova MME）</strong></h3>
<p>Amazon Nova 多模态嵌入模型（Amazon Nova Multimodal Embeddings）是一款最先进的多模态嵌入模型，支持文本、文档、图像、视频和音频的统一嵌入模型，可实现高精度的跨模态检索。模型细节与使用方法可阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Famazon-nova-multimodal-embedding-model-practical-guide%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/amazon-nova-multimodal-embedding-model-practical-guide/" ref="nofollow noopener noreferrer">博客</a>。<br/>
在本文方案中，我们将使用Nova MME的视频嵌入生成能力，通过语义相似度检索片段嵌入，以此定位高光片段。</p>
<h2 data-id="heading-3">高光剪辑方案</h2>
<h3 data-id="heading-4"><strong>1. 纯VLM：多模态模型识别高光</strong></h3>
<p>该方案作为视频高光剪辑的基础方案，主要使用Nova 理解类模型（如 Nova Lite/Pro等版本），利用其视觉–语言模型（VLM，Vision-Language Model）能力直接对视频输入进行理解，通过其内部的视觉编码、时序建模与语言理解能力，输出高光片段的“开始时间点”和“结束时间点”。</p>
<h4 data-id="heading-5">a. 方案架构与案例代码</h4>
<p>纯VLM方案的核心思路是：直接让Nova模型读取整个视频，理解其内容后输出高光片段的时间戳（开始时间和结束时间），然后使用FFmpeg等工具按时间戳切分并拼接视频 。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fautomated-video-highlight-clipping-using-amazon-nova-model-3.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/automated-video-highlight-clipping-using-amazon-nova-model-3.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/833d8d6c2ddc472fb6fa42449f0a37aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=n1SjTKgDb8EdYpcPnPkDXD8QDyA%3D" alt="" loading="lazy"/></a></p>
<p><strong>应用案例1：足球比赛高光提取</strong></p>
<p>以一段1分钟的足球比赛视频（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D5RE6YNz8wng" target="_blank" title="https://www.youtube.com/watch?v=5RE6YNz8wng" ref="nofollow noopener noreferrer">视频来源</a>）为例，我们使用Nova Lite模型自动识别进球等精彩时刻。原始视频包含完整的比赛片段，其中穿插了多个进球瞬间、精彩扑救和关键传球。通过纯VLM方案，模型能够自动定位这些高光时刻并生成浓缩版视频。</p>
<p>下图展示了处理前后的对比效果。左侧为原始1分钟视频，包含了大量的中场传球和跑位等常规画面；右侧为自动生成的高光视频，精准保留了4个进球瞬间，总时长压缩至约25秒，压缩比达到60%。有效提取了视频中最具观赏价值的片段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37a0d8219787464cbead28bc76dfd7db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=iWJ9F2ybGvqwCUd0RKjdwxhIJRw%3D" alt="image.png" loading="lazy"/></p>
<p>1min 原始视频       </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2afe4b36a14a4bb9b3c4ec3b80c13db5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=B6A0cy1hMjALWgVo9Rfik7bIiQ0%3D" alt="image.png" loading="lazy"/></p>
<p>25s高光视频</p>
<p><strong>识别准确度评估</strong></p>
<p>为了量化评估模型的表现，我们使用IoU (Intersection over Union) 指标将模型输出与人工标注的Ground Truth进行对比。IoU衡量预测片段与真实片段的重叠程度，当IoU &gt; 0.5时视为成功匹配。测试结果如下 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b44147efdfa14483b2bd65fd8d77243b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=57wQwTehX%2B3ZY4Xxw6jydl8CnVM%3D" alt="image.png" loading="lazy"/></p>
<p>从效果来看，模型实现了100%的召回率，不仅准确识别了所有进球时刻，还自动过滤掉了中场传球、球员跑位等非高光内容。生成的高光视频节奏紧凑，适合在社交媒体上快速分享，这正是自动化高光剪辑的核心价值所在。</p>
<p><strong>核心代码实现</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Nova模型分析视频</span>
<span class="hljs-attr">bedrock</span> = boto3.client(<span class="hljs-string">'bedrock-runtime'</span>, region_name=<span class="hljs-string">'us-east-1'</span>, 
                       <span class="hljs-attr">config</span>=Config(read_timeout=<span class="hljs-number">1800</span>))

<span class="hljs-attr">prompt</span> = <span class="hljs-string">"""You are an expert in football video analysis.
Identify ONLY goal moments from this match video.

**Output Format (JSON only):**
[
    {
        "start_time": "MM:SS",
        "end_time": "MM:SS",
        "description": "Goal description",
        "scene_type": "Goal"
    }
]

**Critical Constraints:**
- All timestamps MUST be within video duration
- Output ONLY valid JSON array
- NO overlapping timestamps"""</span>

<span class="hljs-attr">messages</span> = [{
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: [
        {<span class="hljs-string">"video"</span>: {<span class="hljs-string">"format"</span>: <span class="hljs-string">"mp4"</span>, <span class="hljs-string">"source"</span>: {<span class="hljs-string">"s3Location"</span>: {<span class="hljs-string">"uri"</span>: s3_uri, <span class="hljs-string">"bucketOwner"</span>: account_id}}}},
        {<span class="hljs-string">"text"</span>: prompt}
    ]
}]

<span class="hljs-attr">response</span> = bedrock.converse(
    <span class="hljs-attr">modelId</span>= &lt;nova-lite-model-id&gt;, <span class="hljs-comment">#具体名称可以参考：https://aws.amazon.com/nova</span>
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">inferenceConfig</span>={<span class="hljs-string">"maxTokens"</span>: <span class="hljs-number">65535</span>, <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.0</span>, <span class="hljs-string">"topP"</span>: <span class="hljs-number">1.0</span>},
    <span class="hljs-attr">additionalModelRequestFields</span>={
        "reasoningConfig": {"type": "enabled", "maxReasoningEffort": "low"}
    }
)

<span class="hljs-attr">output</span> = response[<span class="hljs-string">'output'</span>][<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'text'</span>]
</code></pre>
<p><strong>应用案例2：小狗动画高光提取</strong></p>
<p>为了验证纯VLM方案在不同视频类型上的泛化能力，我们进一步测试了一段1分钟的动画视频。这段视频的特点是大部分时间画面相对静态——一只橙色的小狗在蓝色大门前休息，而真正的高光时刻集中在三个动态片段：一只黄色的小狗出现捡球、另一只小狗从门内探出、以及黄色小狗追逐球的场景。下图展示了处理效果。左侧为原始60秒视频，右侧为自动生成的17秒高光视频。模型成功识别了所有三个动态时刻，并准确过滤掉了长时间的静态画面 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7071cf98b05a48ffb1e6ff1e6034dc16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=ZvmjEKA%2FFCKTFEwKRI1QIHeHfTc%3D" alt="image.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpixabay.com%2Fzh%2Fvideos%2Fai-generated-house-dog-porch-192283%2F" target="_blank" title="https://pixabay.com/zh/videos/ai-generated-house-dog-porch-192283/" ref="nofollow noopener noreferrer">1min 原始视频 </a>       </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362d6cbd9d204ec39368b577bb801b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=ARSGZ%2BqzmmIPJIw0bRP5bnNMTNs%3D" alt="image.png" loading="lazy"/></p>
<p>17s高光视频</p>
<p><strong>识别准确度评估</strong></p>
<p>为了量化评估模型的表现，我们同样使用IoU 指标将模型输出与人工标注的Ground Truth进行对比，测试结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f37c02da6b46219120d1e0f78e7228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=A3%2F4%2ButLaK4AvM6%2B3laNGtEFEvQ%3D" alt="image.png" loading="lazy"/></p>
<p>可以观察到，模型成功识别了所有3个真实高光片段，并且所有时间戳均准确且在有效范围内。特别值得注意的是，第二个片段（小狗开门）实现了完美匹配，说明模型对这类明确的动作转折点有很强的识别能力。即使在第一和第三个片段中存在1-2秒的时间偏差，时间重叠率仍然达到0.67-0.88的高水平，这对于实际应用已经完全足够。</p>
<p>综上，对比足球比赛和动画视频两个案例，我们可以看到纯VLM方案展现出良好的跨场景泛化能力，无论是真实拍摄的体育赛事，还是制作精良的动画内容，Nova Lite都能准确理解视频语义，识别出符合”动作精彩、戏剧性强、叙事价值高”等标准的高光时刻。这种泛化能力使得同一套技术方案可以应用于多种业务场景，从体育直播、游戏录像到教育视频、产品演示等，大幅降低了开发和维护成本。</p>
<h4 data-id="heading-6">b. 使用Nova理解类模型输出视频精准timestamp的提示词工程技巧</h4>
<p>在将Amazon Nova模型应用于视频高光提取时，我们面临的核心挑战是如何让模型准确输出结构化的时间戳数据。基于对Nova Lite的系统性测试，发现模型在视频时间定位任务中的表现高度依赖于prompt的设计策略，基于大量测试经验和视频理解任务的标准prompt模板，可以总结出以下关键技巧：</p>
<p><strong>采用分步骤的任务分解策略。</strong> 参考视频密集描述（Dense Captioning）任务的prompt设计，将复杂的时间戳提取任务分解为清晰的步骤序列，引导模型建立系统化的分析流程：</p>
<pre><code class="hljs language-sql" lang="sql">### Task:
You <span class="hljs-keyword">are</span> an expert <span class="hljs-keyword">in</span> video content analysis <span class="hljs-keyword">and</span> temporal localization.
 
### Analysis Process (Follow these steps):
Step <span class="hljs-number">1</span>: Watch the entire video <span class="hljs-keyword">and</span> identify <span class="hljs-keyword">all</span> highlight moments
Step <span class="hljs-number">2</span>: <span class="hljs-keyword">For</span> <span class="hljs-keyword">each</span> moment, determine precise <span class="hljs-keyword">start</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">end</span> timestamps
Step <span class="hljs-number">3</span>: Verify <span class="hljs-keyword">all</span> timestamps <span class="hljs-keyword">are</span> <span class="hljs-keyword">within</span> the video duration
Step <span class="hljs-number">4</span>: Output structured JSON format <span class="hljs-keyword">only</span>
</code></pre>
<p>这种结构化指引帮助模型建立”观察→定位→验证→输出”的工作流程，显著减少时间戳错误。</p>
<p>针对特定任务定制分析维度。参考视频标注（Video Tagging）任务的prompt设计，在高光提取时应明确定义分析的多个维度，帮助模型全面理解什么是”高光”：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**Analyze from these perspectives:**</span> 
<span class="hljs-bullet">-</span> Visual dynamics: motion intensity, camera movement, visual effects
<span class="hljs-bullet">-</span> Emotional impact: excitement level, dramatic tension
<span class="hljs-bullet">-</span> Technical complexity: skill difficulty, coordination required
<span class="hljs-bullet">-</span> Narrative significance: story turning points, key moments
<span class="hljs-bullet">-</span> Audience appeal: shareability, memorable elements
</code></pre>
<p>明确定义输出格式并提供具体示例。在视频检索（Video Retrieval）和时间定位任务中，标准做法是明确指定时间戳的格式要求。我们建议同时提供格式说明和具体示例，对于需要更结构化的场景，使用JSON格式：</p>
<pre><code class="hljs language-ruby" lang="ruby">**<span class="hljs-title class_">Output</span> <span class="hljs-title class_">Format</span><span class="hljs-symbol">:**</span>
<span class="hljs-title class_">Generate</span> detailed, time-stamped descriptions of events.
<span class="hljs-title class_">Each</span> event follows the <span class="hljs-symbol">format:</span> <span class="hljs-string">"#START - END seconds# description"</span>

**<span class="hljs-title class_">Example</span><span class="hljs-symbol">:**</span>
<span class="hljs-comment">#0.8 - 11.3 seconds# Athlete performs a high jump over obstacle</span>
<span class="hljs-comment">#32.5 - 50.0 seconds# Crowd celebrates as player scores</span>

**<span class="hljs-title class_">Output</span> <span class="hljs-title class_">Format</span> (<span class="hljs-variable constant_">JSON</span>)<span class="hljs-symbol">:**</span>
[
    {
        <span class="hljs-string">"start_time"</span>: <span class="hljs-string">"MM:SS"</span>,
        <span class="hljs-string">"end_time"</span>: <span class="hljs-string">"MM:SS"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"Detailed event description"</span>,
        <span class="hljs-string">"scene_type"</span>: <span class="hljs-string">"Action|Transition|Climax"</span>
    }
]
</code></pre>
<p>强调时间边界约束以防止幻觉。测试表明，模型在长视频中容易产生超出实际时长的时间戳。必须在prompt中明确视频的实际时长：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**CRITICAL CONSTRAINTS:**</span>
<span class="hljs-bullet">-</span> Video duration: exactly 3 minutes 26 seconds (00:00 to 03:26)
<span class="hljs-bullet">-</span> All timestamps MUST be within this range
<span class="hljs-bullet">-</span> No events beyond 03:26
<span class="hljs-bullet">-</span> Use MM:SS format consistently
</code></pre>
<p>通过系统性地应用这些提示词工程技巧，我们能够显著提升Nova模型在视频时间戳识别任务中的表现。在实际应用中，我们还建议结合代码层面的后处理机制——例如验证时间戳是否在有效范围内、合并时间上相邻的片段等，这种通过结合prompt设计+工程化验证的组合策略能够构建更稳健的生产系统。</p>
<p>除了提示词优化，对于长视频场景，我们还可以从架构层面进一步提升处理效果，接下来我们将详细介绍这一优化方案。</p>
<h4 data-id="heading-7">c. 效果优化：通过切片增加识别精准度</h4>
<p>在实际生产环境测试中，我们发现对于长视频场景，采用视频切片策略能够显著提升时间戳定位精度和高光识别准确率。该策略的核心思路是将长视频按固定时长切分成多个片段，对每个片段独立调用Nova模型进行并行分析，然后将识别结果映射回原视频的绝对时间轴。这种方法不仅显著提升了时间戳精度，还带来了意外的性能收益——通过并行处理多个片段，整体处理时间反而缩短了。</p>
<p><strong>应用案例3：长视频足球比赛高光提取</strong></p>
<p>以一段9分3秒的足球比赛视频为例（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D5RE6YNz8wng" target="_blank" title="https://www.youtube.com/watch?v=5RE6YNz8wng" ref="nofollow noopener noreferrer">视频来源</a>），我们将其切分为18个30秒片段和1个3秒片段，通过Amazon Nova Lite模型并行处理后，自动生成了包含所有进球时刻的高光视频。下图展示了原始视频与自动生成的高光视频对比：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc29ecace6aa47fbb2a79d47dbabbba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=OOmDsUQ6vyk0eEUyEkn7kmjOetA%3D" alt="image.png" loading="lazy"/></p>
<p align="center">切片策略处理流程图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10189a750f0a4ae6a05a3c14e091c8cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=HrZ2WznrzxzL%2FqcScoe9MSoOSQg%3D" alt="image.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D5RE6YNz8wng" target="_blank" title="https://www.youtube.com/watch?v=5RE6YNz8wng" ref="nofollow noopener noreferrer">9m3s 原视频</a>     </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a30e549459e4e7581449aca614d05fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=mxUIH0ZjgZjELFTHWioP%2F8%2FQIRo%3D" alt="image.png" loading="lazy"/></p>
<p>1m58s 高光视频</p>
<p><strong>效果验证</strong></p>
<p>为量化评估切片策略的效果，我们使用人工标注的Ground Truth进行对比测试。结果显示，切片策略在时间戳精度和召回率两个关键指标上均有显著提升：30秒切片策略成功识别了全部4个进球（召回率100%），时间戳精度提升至±1秒以内。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9338560056f0419bb51bdcc40f8a6532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=7bv%2FO%2BMey5jTXrp5FlmhGBbRFHg%3D" alt="image.png" loading="lazy"/></p>
<p>切片策略的另一个优势是通过并行处理提升了整体处理效率。需要注意的是，虽然召回率得到了显著提升，但由于每个片段独立分析，可能会产生较多冗余标记（本案例中输出了14个候选片段），建议在后处理阶段增加去重及筛选逻辑以优化最终输出。</p>
<p>总体而言，纯VLM方案的优势在于流程简洁、模块精简、实现路径短，非常适合快速原型开发和中短视频场景。然而，当面对超长视频，这一方案对模型能力和提示词工程的要求会显著提升。此外，对于需要从海量视频素材库中全局筛选最佳片段的场景，纯VLM方案难以提供跨视频的语义检索能力。<br/>
在接下来的章节中，我们将介绍：当VLM对高光片段的提取不是那么精准时，通过引入多模态嵌入模型（MME）在语义空间上进行相似度匹配，不仅能提升系统的容错能力，弥补VLM在精准性方面的部分不足，同时也提供了跨视频片段检索定位的可能性，实现更强大的视频高光剪辑能力。</p>
<h3 data-id="heading-8"><strong>2. VLM+MME：语义摘要+嵌入检索</strong></h3>
<p>该方案结合了两类技术：首先由 VLM（Nova理解类模型，如Nova Lite/Pro）对视频整体进行理解，生成高光要点或描述；其次，将视频切片（如每2-3秒一段，<em>具体切片时长根据业务要求和检索颗粒度决定</em>）生成视频嵌入向量（通过多模态嵌入模型，Nova MME）——每个片段取得视觉／时序特征之后形成向量。然后系统将高光描述（文本）作为查询，与视频片段的嵌入向量进行<strong>相似度匹配</strong>，从而精确定位那些“语义上与高光描述最接近”的片段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93fe940c72914cd8b4bacfad5b46be01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=qAQERGUZM2HieO8P6kM0sPqydNQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">a. 方案架构</h3>
<p>该方案的需要视频切片、嵌入生成与匹配机制， 可用于跨视频的剪辑需求。基于嵌入向量的可复用性，提供从冷启动（2.1， 2.2）到基于素材累积（2.3）的方案进阶路径。如果成本敏感可以考虑（2.4）将视频抽帧，用图片向量检索。</p>
<h4 data-id="heading-10">2.1 基本方案：高光压缩</h4>
<p>在不强调原始视频情节顺序的情况下，我们可以采用一种<strong>高光压缩</strong>的方法，将视频内容提炼为精华片段。具体步骤如下：</p>
<ol>
<li>
<p><strong>视频内容总结</strong>：将视频输入到VLM模型（例如亚马逊云科技的 Nova Lite/Pro 模型），生成对视频主要内容的摘要描述，并以要点（bullet points）的形式呈现。这一步让模型从全局上理解视频内容的重点。（也可以与方法<strong>1. 纯VLM（ 用Nova VLM直接进行视频理解，输出高光片段的开始和结束时间点）方法</strong>结合，对VLM生成的高光点查漏补缺。）</p>
<ol>
<li>（可选）打重要性标签：每条摘要要点可以附加一个优先级标签（如重要程度1、2、3）以表示相对重要性（这一步需要在 system prompt 中明确高光片段的判定标准）。</li>
</ol>
</li>
<li>
<p><strong>视频切片与嵌入</strong>：将视频按时间顺序分割成短片段，如<strong>2-3秒</strong>（<em>具体切片时长根据业务要求和检索颗粒度决定</em>），并对每个片段生成向量嵌入表示（使用Nova MME，多模态嵌入模型，每个片段的嵌入向量都代表了该片段的语义内容）。</p>
</li>
<li>
<p><strong>语义匹配选取高光片段</strong>：利用第一步中VLM生成的摘要要点作为查询，根据语义相似度在嵌入向量空间中检索最相关的影片片段。换言之，我们在嵌入向量库中查找与每条摘要要点语义最接近的若干片段。这些匹配上的片段即被视为视频的高光片段集合。由于摘要要点概括了视频的重要内容，检索出的片段也就对应了视频中最精彩或最重要的瞬间。</p>
<ol>
<li>（可选）初筛：如高光描述过多，可以根据高光点的优先级筛选需要匹配的文字。</li>
<li>（可选）去重：若出现多个要点匹配到同一段视频（即某片段对多条要点都有高相似度），则根据要点的优先级决定该片段应归属哪个要点（确保重要的要点获得独特片段）</li>
</ol>
</li>
<li>
<p><strong>高光片段导出</strong>：将选定的高光片段按原视频中的时间顺序组合导出，形成一个压缩版的视频。如果不关注片段顺序，也可以按照相似度得分等权重来自由组合。但通常由于摘要要点源自原始视频顺序，此方法下导出的高光片段天然保持了原视频的大致顺序。</p>
</li>
</ol>
<p>该基本方案不依赖任何外部素材库，流程简单直接。VLM提供语义摘要，嵌入向量提供精确检索，使模型能够“理解”视频内容并找到对应片段。此方法依赖第一步VLM的摘要质量和提示词工程，若VLM未能抓住真正的精彩之处，检索结果可能欠佳。</p>
<p><strong>案例代码</strong></p>
<p>使用Amazon Nova Lite进行视频理解与高光要点生成，Amazon Nova MME进行文本和视频片段的嵌入生成，开源音视频处理库FFmpeg进行视频处理，该流程的核心代码架构如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> glob
<span class="hljs-keyword">from</span> sklearn.metrics.pairwise <span class="hljs-keyword">import</span> cosine_similarity

bedrock = boto3.client(<span class="hljs-string">'bedrock-runtime'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-comment"># 1. LLM视频分析 - Nova模型理解视频生成高光要点</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_video</span>(<span class="hljs-params">video_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(video_path, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        video_base64 = base64.b64encode(f.read()).decode(<span class="hljs-string">'utf-8'</span>)
    
    response = bedrock.invoke_model(
        modelId=<span class="hljs-string">"us.amazon.nova-lite-v1:0"</span>,
        body=json.dumps({
            <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: [
                {<span class="hljs-string">"video"</span>: {<span class="hljs-string">"format"</span>: <span class="hljs-string">"mp4"</span>, <span class="hljs-string">"source"</span>: {<span class="hljs-string">"bytes"</span>: video_base64}}},
                {<span class="hljs-string">"text"</span>: <span class="hljs-string">"""请分析这个视频并提炼高光要点。                       
                            ## 高光片段判定标准：
                            - 动作精彩或技巧性强的时刻
                            - 情感表达丰富或戏剧性的瞬间  
                            - 关键转折点或重要事件
                            - 视觉效果突出或构图优美的片段
                            - 具有故事性或叙事价值的时刻
                            
                            ## 输出要求：
                            请按以下格式输出高光要点，每个要点包含优先级（1=最重要，2=重要，3=一般）：
                            
                            **视频总结：**
                            [简要描述视频的整体内容和主题]
                            
                            **高光要点列表：**
                            A. [优先级1] - [具体的高光内容描述]
                            B. [优先级2]  - [具体的高光内容描述]  
                            C. [优先级1]  - [具体的高光内容描述]
                            ...
                            
                            请确保：
                            1. 按视频时间顺序排列要点
                            2. 每个要点都有明确的优先级标记
                            3. 描述具体且便于后续匹配
                            4. 重点关注真正精彩的时刻，而非简单概括"""</span>}
            ]}]
        })
    )
    <span class="hljs-keyword">return</span> json.loads(response[<span class="hljs-string">"body"</span>].read())[<span class="hljs-string">"output"</span>][<span class="hljs-string">"message"</span>][<span class="hljs-string">"content"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"text"</span>]

<span class="hljs-comment"># 2. 视频切片 - FFmpeg按固定间隔切分视频</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_clips</span>(<span class="hljs-params">video_path, clip_duration=<span class="hljs-number">3</span></span>):
    <span class="hljs-comment"># 获取视频时长</span>
    duration = <span class="hljs-built_in">float</span>(subprocess.check_output([<span class="hljs-string">'ffprobe'</span>, <span class="hljs-string">'-v'</span>, <span class="hljs-string">'quiet'</span>, <span class="hljs-string">'-show_entries'</span>, <span class="hljs-string">'format=duration'</span>, <span class="hljs-string">'-of'</span>, <span class="hljs-string">'csv=p=0'</span>, video_path]))
    
    clips = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">int</span>(duration), clip_duration):
        clip_path = <span class="hljs-string">f"clips/clip_<span class="hljs-subst">{i:04d}</span>_<span class="hljs-subst">{i}</span>s.mp4"</span>
        subprocess.run([<span class="hljs-string">'ffmpeg'</span>, <span class="hljs-string">'-i'</span>, video_path, <span class="hljs-string">'-ss'</span>, <span class="hljs-built_in">str</span>(i), <span class="hljs-string">'-t'</span>, <span class="hljs-built_in">str</span>(clip_duration), 
                       <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'libx264'</span>, clip_path, <span class="hljs-string">'-y'</span>, <span class="hljs-string">'-loglevel'</span>, <span class="hljs-string">'quiet'</span>])
        clips.append({<span class="hljs-string">'timestamp'</span>: i, <span class="hljs-string">'path'</span>: clip_path})
    <span class="hljs-keyword">return</span> clips

<span class="hljs-comment"># 3. 语义匹配 - Nova MME生成嵌入后计算要点与视频片段相似度</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_embedding</span>(<span class="hljs-params">content, content_type=<span class="hljs-string">"text"</span></span>):
    <span class="hljs-keyword">if</span> content_type == <span class="hljs-string">"text"</span>:
        request = {
            <span class="hljs-string">"taskType"</span>: <span class="hljs-string">"SINGLE_EMBEDDING"</span>,
            <span class="hljs-string">"singleEmbeddingParams"</span>: {
                <span class="hljs-string">"embeddingPurpose"</span>: <span class="hljs-string">"GENERIC_INDEX"</span>,
                <span class="hljs-string">"embeddingDimension"</span>: <span class="hljs-number">1024</span>,
                <span class="hljs-string">"text"</span>: {<span class="hljs-string">"truncationMode"</span>: <span class="hljs-string">"END"</span>, <span class="hljs-string">"value"</span>: content}
            }
        }
    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># video</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(content, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
            video_base64 = base64.b64encode(f.read()).decode(<span class="hljs-string">'utf-8'</span>)
        request = {
            <span class="hljs-string">"taskType"</span>: <span class="hljs-string">"SINGLE_EMBEDDING"</span>,
            <span class="hljs-string">"singleEmbeddingParams"</span>: {
                <span class="hljs-string">"embeddingPurpose"</span>: <span class="hljs-string">"GENERIC_INDEX"</span>,
                <span class="hljs-string">"embeddingDimension"</span>: <span class="hljs-number">1024</span>,
                <span class="hljs-string">"video"</span>: {
                    <span class="hljs-string">"format"</span>: <span class="hljs-string">"mp4"</span>,
                    <span class="hljs-string">"embeddingMode"</span>: <span class="hljs-string">"AUDIO_VIDEO_COMBINED"</span>,
                    <span class="hljs-string">"source"</span>: {<span class="hljs-string">"bytes"</span>: video_base64}
                }
            }
        }
    
    response = bedrock.invoke_model(modelId=<span class="hljs-string">"amazon.nova-2-multimodal-embeddings-v1:0"</span>, body=json.dumps(request))
    <span class="hljs-keyword">return</span> json.loads(response[<span class="hljs-string">"body"</span>].read())[<span class="hljs-string">"embeddings"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"embedding"</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_match</span>(<span class="hljs-params">analysis, clips</span>):
    <span class="hljs-comment"># 提取要点</span>
    points = [line.strip() <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> analysis.split(<span class="hljs-string">'\n'</span>) <span class="hljs-keyword">if</span> line.strip().startswith((<span class="hljs-string">'A.'</span>, <span class="hljs-string">'B.'</span>, <span class="hljs-string">'C.'</span>))]
    
    selected_clips = []
    <span class="hljs-comment"># 为每个要点找最佳匹配片段</span>
    <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> points:
        text_emb = get_embedding(point)
        best_clip, best_similarity = <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>
        
        <span class="hljs-keyword">for</span> clip <span class="hljs-keyword">in</span> clips:
            video_emb = get_embedding(clip[<span class="hljs-string">'path'</span>], <span class="hljs-string">"video"</span>)
            similarity = cosine_similarity([text_emb], [video_emb])[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
            
            <span class="hljs-keyword">if</span> similarity &gt; best_similarity:
                best_similarity = similarity
                best_clip = {<span class="hljs-string">'path'</span>: clip[<span class="hljs-string">'path'</span>], <span class="hljs-string">'timestamp'</span>: clip[<span class="hljs-string">'timestamp'</span>], <span class="hljs-string">'similarity'</span>: similarity}
        
        <span class="hljs-keyword">if</span> best_clip <span class="hljs-keyword">and</span> best_similarity &gt; <span class="hljs-number">0.15</span>:
            selected_clips.append(best_clip)
    
    <span class="hljs-comment"># 按时间顺序排序</span>
    selected_clips.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'timestamp'</span>])
    <span class="hljs-keyword">return</span> selected_clips

<span class="hljs-comment"># 4. 拼接高光视频 - FFmpeg合并选中片段</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_video</span>(<span class="hljs-params">selected_clips, output_path</span>):
    <span class="hljs-comment"># 生成拼接列表</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'concat_list.txt'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> clip <span class="hljs-keyword">in</span> selected_clips:
            f.write(<span class="hljs-string">f"file '<span class="hljs-subst">{clip[<span class="hljs-string">'path'</span>]}</span>'\n"</span>)
    
    <span class="hljs-comment"># FFmpeg拼接</span>
    subprocess.run([<span class="hljs-string">'ffmpeg'</span>, <span class="hljs-string">'-f'</span>, <span class="hljs-string">'concat'</span>, <span class="hljs-string">'-safe'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'-i'</span>, <span class="hljs-string">'concat_list.txt'</span>, 
                   <span class="hljs-string">'-c'</span>, <span class="hljs-string">'copy'</span>, output_path, <span class="hljs-string">'-y'</span>, <span class="hljs-string">'-loglevel'</span>, <span class="hljs-string">'quiet'</span>])

<span class="hljs-comment"># demo：完整流程</span>
analysis = analyze_video(<span class="hljs-string">"sample/action.mp4"</span>)
clips = extract_clips(<span class="hljs-string">"sample/action.mp4"</span>, <span class="hljs-number">3</span>)
selected_clips = semantic_match(analysis, clips)
create_video(selected_clips, <span class="hljs-string">"highlight_video.mp4"</span>)
<span class="hljs-comment"># 流程: 视频→Nova理解→视频切片→MME匹配→拼接</span>
<span class="hljs-comment"># 返回: highlight_video.mp4</span>
</code></pre>
<p><strong>应用案例：小狗动画高光提取</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9817b0b608845fc95a51fed14edc4a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=dYiP9OyLvvJqE6RAdo7eUVLdSvg%3D" alt="image.png" loading="lazy"/></p>
<p>1min <a href="https://link.juejin.cn?target=https%3A%2F%2Fpixabay.com%2Fzh%2Fvideos%2Fai-generated-house-dog-porch-192283%2F" target="_blank" title="https://pixabay.com/zh/videos/ai-generated-house-dog-porch-192283/" ref="nofollow noopener noreferrer">原始视频</a>                                     </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead961aaf6d24c46ae6baeb88cecb376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=eciKhVjFh000h6mt%2BUEyCZoDrYI%3D" alt="image.png" loading="lazy"/></p>
<p>14s 高光视频</p>
<p>该动画的大部分时间是一只橙色小狗在蓝色大门前睡觉，有3个主要的高光片段：</p>
<ul>
<li>第16s到第24s：一只黄色小狗出现在画面中捡球</li>
<li>第26s到第32s：一只小的白色和棕色相间的小狗从门内探出</li>
<li>第46s到第52s：黄色小狗继续出现在画面中追逐球</li>
</ul>
<p>按照架构设计进行第1步，将整个视频作为输入，使用VLM进行视频分析，提取高光要点以及优先级：</p>
<pre><code class="hljs language-less" lang="less">**视频总结：**
这个视频展示了一只橙色小狗在房子门口的阶梯上睡觉。视频中的场景是一个带有花园和邮箱的房子，背景中还有一辆自行车停在路边。

**高光要点列表：**
<span class="hljs-selector-tag">A</span>. <span class="hljs-selector-attr">[优先级1]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">00</span> <span class="hljs-selector-tag">-</span> 视频开始时，展示了房子和橙色小狗在阶梯上睡觉的场景。
<span class="hljs-selector-tag">B</span>. <span class="hljs-selector-attr">[优先级2]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">19</span> <span class="hljs-selector-tag">-</span> 橙色小狗开始翻身并醒来。
<span class="hljs-selector-tag">C</span>. <span class="hljs-selector-attr">[优先级1]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">21</span> <span class="hljs-selector-tag">-</span> 黄色小狗被一个蓝色的球吸引，并开始追逐。
<span class="hljs-selector-tag">D</span>. <span class="hljs-selector-attr">[优先级2]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">25</span> <span class="hljs-selector-tag">-</span> 黄色小狗追逐球的动作，展示了它的活泼和好奇心。
<span class="hljs-selector-tag">E</span>. <span class="hljs-selector-attr">[优先级3]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">30</span> <span class="hljs-selector-tag">-</span> 黄色小狗追逐球的过程中，展示了房子的细节和背景。
<span class="hljs-selector-tag">F</span>. <span class="hljs-selector-attr">[优先级2]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">35</span> <span class="hljs-selector-tag">-</span> 黄色小狗最终放弃追逐。
<span class="hljs-selector-tag">G</span>. <span class="hljs-selector-attr">[优先级3]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">0</span>:<span class="hljs-number">40</span> <span class="hljs-selector-tag">-</span> 视频结尾，展示了房子和花园的全景。
</code></pre>
<p>VLM 提取的高光要点包含7条，每条有对应优先级与描述，可以观察到视频的大部分高光情节被提取出且故事较为连贯。在语义匹配阶段，Nova MME进行多模态嵌入生成，能够捕捉到视频片段中的核心动作和场景特征，而不完全依赖于具体的身份识别。例如，当VLM描述中提到”黄色小狗追逐球”时，无论执行这个动作的是橙色小狗还是黄色小狗，由于”追逐球”这一动作在嵌入空间中产生相似的语义表示，相似度计算都能够匹配到包含此类动作的视频片段，从而实现准确的语义关联。这种语义层面的匹配机制使得系统具有一定的容错能力：即使文本描述在细节上存在偏差，只要核心的动作、场景或情感特征保持一致，相似度计算仍能找到正确的视频片段，保证了语义上的连贯性。最后拼接时根据视频片段的时间顺序拼接保证了时序上的连贯性。<br/>
接下来进行第2～4步的视频片段切分（2s为切分间隔），Nova MME嵌入生成以及语义匹配，每个要点匹配的视频片段结果如下表所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964ccb84f999432698ea8dad53419ebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=jPsfH%2B4VlxH1nTy%2B2gxWV2N7PJU%3D" alt="image.png" loading="lazy"/></p>
<p>从实际结果看，尽管VLM在狗的品种识别上存在混淆，但最终选中的片段（20-24秒、26-32秒、50-52秒等）仍然准确覆盖了预期的高光时段，证明了这种基于语义匹配的方法在处理描述不精确问题上的鲁棒性。生成的高光视频中包含了提到的3个高光片段，且片段之间的衔接也较为自然。</p>
<h4 data-id="heading-11">2.2 跨视频内容驱动的高光剪辑</h4>
<p>当高光剪辑场景有较高的自定义剧本需求，需要微调视频拼接顺序，以及需要基于大量视频媒体库优选片段的时候，我们可以对2.1方案生成的嵌入基于用户定义的剧本文字（可选：再用prompt增强）进行检索。</p>
<p>比如在媒体行业场景中，当剪辑需求不仅仅是“提取高光”，而是要按照品牌或用户定义的“剧本”来迈出叙事、结构和风格的步伐，并且拥有一个庞大的素材库时，我们便可以采用“用户输入的剪辑需求 + 跨视频检索”这一技术路径。具体来说，用户首先输入其剪辑意图，例如“先展示产品问世、再展示用户体验、最后展示品牌口号”，这一剧本会被系统转化为一系列描述性事件（如“产品亮相”、“用户微笑试用”、“品牌Logo出现”）。接着系统对整个素材库中的每条视频或片段生成嵌入向量，进而将用户的每一个事件描述作为检索查询，与库中各片段的嵌入进行相似度匹配。这样，系统不仅限于从单个视频选取高光，而是可以跨视频检索：比如，事件１可能匹配竟然是品牌拍摄片，事件２可能匹配直播片段，事件３来自宣传片。最后，按照用户剧本设定的顺序，将这些匹配出的来自不同视频的片段组合起来，形成一个结构化、连贯而富有品牌风格的高光剪辑。</p>
<h4 data-id="heading-12">2.3 历史素材驱动的模板化高光生成</h4>
<p>视频嵌入技术展现了极高的可复用性。我们可以将历史上已经被剪辑为高光的片段——或被人工判断为“精彩时刻”的素材——系统地收集起来，形成一个样本库。样本库搭建可选择如Amazon Opensearch Service（<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fopensearch-rag-system-implementation%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/opensearch-rag-system-implementation/" ref="nofollow noopener noreferrer">博客</a>），亚马逊云科技的partner向量数据库如Zilliz（<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fmarketplace%2Fpp%2Fprodview-iqbidum7feuio%3Fsr%3D0-1%26ref_%3Dbeagle%26applicationId%3DAWSMPContessa" target="_blank" title="https://aws.amazon.com/marketplace/pp/prodview-iqbidum7feuio?sr=0-1&amp;ref_=beagle&amp;applicationId=AWSMPContessa" ref="nofollow noopener noreferrer">partner marketplace link</a>）。</p>
<p>对于库中每一个高光片段，我们不仅为其生成嵌入向量表示，还可按类别或风格进行标签（例如 “体育比赛”“游戏直播”“演讲访谈” 等），并为片段附加丰富的元数据，如所属视频类别、片段简介、精彩评分等。这一机制使得后续的新视频可以跨视频检索：在面对一条新拍摄视频时，系统首先对其进行分析（包括 VLM 摘要或粗分类），然后将其切分为2–3 秒的片段并生成嵌入向量。接下来，这些片段将与样本库中已有的高光嵌入进行相似度匹配——如果某个新视频片段在视觉或语义上与历史高光片段高度相似，就可将其标记为高光候选。同时，如果新视频所属类别明确（比如篮球比赛），系统还可参考该类别过去形成的“高光剧本”——例如典型进球、扣篮、关键三分、绝杀这一顺序——并在样本库选片中优先匹配这些典型事件。将匹配出的片段（可能来自不同原视频）按剧本顺序组合拼接，就能生成符合观众预期节奏、结构连贯的高光成片。</p>
<p>以下为流程图：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fautomated-video-highlight-clipping-using-amazon-nova-model-14.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/automated-video-highlight-clipping-using-amazon-nova-model-14.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d82e80cdbb64e0e8ce2570d2bb8df0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=X%2BxVwohO0WNm7tqwWAh%2Bg%2FpwG00%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-13">b. VLM+MME链路优化思路</h3>
<p>在系统设计阶段，成本考量非常重要。如不需要为视频 embedding 支付持久化存储费用，仅需要考虑模型推理费用（即 Nova 或嵌入模型 MME 的运行费用）。如需储备历史素材库——需要存储 embedding，因此还要考虑存储和检索成本。除了存储外，还有一些<strong>成本优化手段</strong>，可以在整个流程中降低计算／存储／带宽等资源消耗。以下是几项建议：</p>
<p><strong>视频压缩 + 再识别</strong><br/>
可以先将原始视频做轻量压缩或降帧处理（降低分辨率、降低帧率）以减少计算／存储开销。利用压缩后的视频用VLM识别哪些片段可能是高光，然后在原始视频中按照排序结果选取对应高分片段，再拼接成最终剪辑。这样可以避免对高分辨率视频VLM理解/MME嵌入。</p>
<p><strong>初筛过滤 + 再嵌入</strong><br/>
在做精细的嵌入匹配之前，先做一个粗筛阶段以减少待处理片段数量，从而降低后续嵌入计算量。粗筛可通过几种方式实现：</p>
<ol>
<li><strong>靠 VLM 输出大致 timestamp</strong>：结合方法1，调用 VLM 先对视频做快速分析，输出可能的高光时间段（例如“00:12–00:16”、“04:30–04:35”），然后只对这些候选区段做切片 + 嵌入匹配。提升方法1的精度，同时无需对全部视频做嵌入处理。</li>
<li><strong>靠去重</strong>：如果视频存在大量“平淡”“重复”的片段，可以先用帧差异规则做去重，删除重复内容，剩余片段即为“亮点候选”：如帧之间变化率、场景切换检测、视觉差异阈值做快速过滤，仅保留“变化大”的区段供后续处理。</li>
<li><strong>靠前置逻辑</strong>：利用其他模态（如音频、运动检测）做预筛。比如音频音量变大、频率变化剧烈可能对应“高潮、高光”片段（如赛车轰鸣、演唱高潮）；或视觉中检测到快速运动／剪辑变化也可作为候选。这样可减少对视觉嵌入的遍历。</li>
</ol>
<p>这种“粗 → 精”两级筛选方式能显著降低整体系统负载。</p>
<h4 data-id="heading-14">效果优化思路</h4>
<p><strong>切片粒度与高光时长弹性</strong><br/>
实际场景中，高光时长并不固定（可能为 3 秒／5 秒／15 秒等），因此在切片设计时需要灵活。一个简明工程实现方式是：<br/>
<strong>先用最小细粒度切片</strong>（例如 1-2 秒）遍历全视频。对于每个高光描述（来自 VLM），在匹配出的片段基础上，可<strong>合并相邻切片</strong>、或者根据优先级扩展时间段，以形成较长的高光片段。匹配逻辑可为：对于某一高光描述，找到所有相似度 ≥ 阈值（例如 0.5） 的细切片集合；然后合并这些相邻切片（时间上连续或相近）为一个完整高光区间，再按时间顺序拼接。<br/>
这样既保证了系统能够灵活应对不同长度的高光，又避免硬编码“高光必为3 秒”的限制。</p>
<h4 data-id="heading-15"><strong>2.4 VLM+MME（视频抽帧-图片嵌入）</strong></h4>
<p>此方案与方案 2 的流程类似，但区别在于“嵌入对象”从视频片段变为“抽帧图片”。也就是说：对视频抽取关键帧，对这些静态帧生成图片嵌入；同时由 VLM 生成高光描述文本；然后对图片嵌入与描述文本做匹配，从这些匹配结果推断高光的时间点。技术上这种方法降低了对完整视频切片和时序建模的依赖，使实现更轻量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74baea9658234d30ac9faea5f02a6033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=aTxuOP0jvXfKUu09jm3DO9Tn3FI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>案例代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> sklearn.metrics.pairwise <span class="hljs-keyword">import</span> cosine_similarity

bedrock = boto3.client(<span class="hljs-string">'bedrock-runtime'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-comment"># 1. VLM视频分析</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_video</span>(<span class="hljs-params">video_path</span>):
    <span class="hljs-comment"># 同 “2.1 基本方案”部分案例代码</span>
    <span class="hljs-keyword">pass</span>
    
<span class="hljs-comment"># 2. FFmpeg抽帧：将视频抽帧为图片用于后续语义匹配</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_frames</span>(<span class="hljs-params">video_path, interval=<span class="hljs-number">1</span></span>):
    duration = <span class="hljs-built_in">float</span>(subprocess.check_output([<span class="hljs-string">'ffprobe'</span>, <span class="hljs-string">'-v'</span>, <span class="hljs-string">'quiet'</span>, <span class="hljs-string">'-show_entries'</span>, <span class="hljs-string">'format=duration'</span>, <span class="hljs-string">'-of'</span>, <span class="hljs-string">'csv=p=0'</span>, video_path]))
    
    frames = []
    <span class="hljs-keyword">for</span> i, t <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">int</span>(duration), interval)):
        frame_path = <span class="hljs-string">f"frame_<span class="hljs-subst">{i:04d}</span>.jpg"</span>
        subprocess.run([<span class="hljs-string">'ffmpeg'</span>, <span class="hljs-string">'-i'</span>, video_path, <span class="hljs-string">'-ss'</span>, <span class="hljs-built_in">str</span>(t), <span class="hljs-string">'-vframes'</span>, <span class="hljs-string">'1'</span>, frame_path, <span class="hljs-string">'-y'</span>, <span class="hljs-string">'-loglevel'</span>, <span class="hljs-string">'quiet'</span>])
        frames.append({<span class="hljs-string">'timestamp'</span>: t, <span class="hljs-string">'path'</span>: frame_path})
    <span class="hljs-keyword">return</span> frames

<span class="hljs-comment"># 3. 语义匹配：Nova MME生成嵌入后计算要点与图片相似度</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_embedding</span>(<span class="hljs-params">content, content_type=<span class="hljs-string">"text"</span></span>):
    <span class="hljs-comment"># 生成嵌入</span>
    <span class="hljs-keyword">if</span> content_type == <span class="hljs-string">"text"</span>:
        data = {<span class="hljs-string">"text"</span>: {<span class="hljs-string">"value"</span>: content}}
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(content, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
            data = {<span class="hljs-string">"image"</span>: {<span class="hljs-string">"format"</span>: <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"source"</span>: {<span class="hljs-string">"bytes"</span>: base64.b64encode(f.read()).decode()}}}
    
    response = bedrock.invoke_model(
        modelId=<span class="hljs-string">"amazon.nova-2-multimodal-embeddings-v1:0"</span>,
        body=json.dumps({<span class="hljs-string">"taskType"</span>: <span class="hljs-string">"SINGLE_EMBEDDING"</span>, <span class="hljs-string">"singleEmbeddingParams"</span>: data})
    )
    <span class="hljs-keyword">return</span> json.loads(response[<span class="hljs-string">"body"</span>].read())[<span class="hljs-string">"embeddings"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"embedding"</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_match</span>(<span class="hljs-params">analysis, frames</span>):
    <span class="hljs-comment"># 提取要点</span>
    points = [line.strip() <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> analysis.split(<span class="hljs-string">'\n'</span>) <span class="hljs-keyword">if</span> line.strip().startswith((<span class="hljs-string">'A.'</span>, <span class="hljs-string">'B.'</span>, <span class="hljs-string">'C.'</span>))]
    
    selected_clips = []
    <span class="hljs-comment"># 针对每一个要点，匹配处Top10最相关的帧集合</span>
    <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> points:
        text_emb = get_embedding(point)
        best_frames = []
        
        <span class="hljs-keyword">for</span> frame <span class="hljs-keyword">in</span> frames:
            img_emb = get_embedding(frame[<span class="hljs-string">'path'</span>], <span class="hljs-string">"image"</span>)
            similarity = cosine_similarity([text_emb], [img_emb])[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> similarity &gt; <span class="hljs-number">0.1</span>:
                best_frames.append({<span class="hljs-string">'timestamp'</span>: frame[<span class="hljs-string">'timestamp'</span>], <span class="hljs-string">'similarity'</span>: similarity})
        
        best_frames.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'similarity'</span>], reverse=<span class="hljs-literal">True</span>)
        selected_clips.extend(best_frames[:<span class="hljs-number">10</span>])  <span class="hljs-comment"># Top10</span>
    
    <span class="hljs-keyword">return</span> selected_clips

<span class="hljs-comment"># 4. 生成高光视频</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_video</span>(<span class="hljs-params">video_path, clips, output_path</span>):
    clips.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'timestamp'</span>])
    
    <span class="hljs-comment"># 按照帧集合提取片段</span>
    temp_clips = []
    <span class="hljs-keyword">for</span> i, clip <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(clips):
        clip_path = <span class="hljs-string">f"clip_<span class="hljs-subst">{i}</span>.mp4"</span>
        subprocess.run([<span class="hljs-string">'ffmpeg'</span>, <span class="hljs-string">'-i'</span>, video_path, <span class="hljs-string">'-ss'</span>, <span class="hljs-built_in">str</span>(clip[<span class="hljs-string">'timestamp'</span>]), <span class="hljs-string">'-t'</span>, <span class="hljs-string">'2'</span>, clip_path, <span class="hljs-string">'-y'</span>, <span class="hljs-string">'-loglevel'</span>, <span class="hljs-string">'quiet'</span>])
        temp_clips.append(clip_path)
    
    <span class="hljs-comment"># 拼接</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'list.txt'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> clip <span class="hljs-keyword">in</span> temp_clips:
            f.write(<span class="hljs-string">f"file '<span class="hljs-subst">{clip}</span>'\n"</span>)
    
    subprocess.run([<span class="hljs-string">'ffmpeg'</span>, <span class="hljs-string">'-f'</span>, <span class="hljs-string">'concat'</span>, <span class="hljs-string">'-safe'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'-i'</span>, <span class="hljs-string">'list.txt'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'copy'</span>, output_path, <span class="hljs-string">'-y'</span>, <span class="hljs-string">'-loglevel'</span>, <span class="hljs-string">'quiet'</span>])

<span class="hljs-comment"># demo：完整流程</span>
analysis = analyze_video(<span class="hljs-string">"input.mp4"</span>)
frames = extract_frames(<span class="hljs-string">"input.mp4"</span>)
clips = semantic_match(analysis, frames)
create_video(<span class="hljs-string">"input.mp4"</span>, clips, <span class="hljs-string">"highlight.mp4"</span>)
<span class="hljs-comment"># 流程: 视频→Nova理解→视频抽帧为图片→MME匹配→拼接</span>
<span class="hljs-comment"># 返回: highlight.mp4</span>
</code></pre>
<p><strong>应用案例：小猫草地玩耍高光提取</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb182b8f679945208144aa2c889b0d9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=83MZ5LZ5nqtIa%2FluJ4N6JYhaITc%3D" alt="image.png" loading="lazy"/>
1min <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pexels.com%2Fzh-cn%2Fvideo%2F3116737%2F" target="_blank" title="https://www.pexels.com/zh-cn/video/3116737/" ref="nofollow noopener noreferrer">原始视频</a>                                       
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb09dc72eb54ce5805f18e5740d0385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=oCy0gYiV74eWthWxBPCavUGBmaw%3D" alt="image.png" loading="lazy"/>
16s 高光视频</p>
<p>该视频的大部分时间是小猫在草地上张望，主要高光片段为：</p>
<ul>
<li>在第21s到第28s：小猫有向前扑的动作</li>
<li>第37s到第43s：小猫回到原位坐下回头看向镜头</li>
</ul>
<p>和2.1 基本方案类似，进行第1步将整个视频作为输入，使用VLM进行视频分析，提取高光要点以及优先级：</p>
<pre><code class="hljs language-css" lang="css">**视频总结：**
这段视频展示了一只橙色和白色相间的小猫在草地上的活动。从开始到结束，小猫一直在草地上探索、玩耍，并最终发现并尝试吃一个蛋壳。

原始高光要点列表：
<span class="hljs-selector-tag">A</span>. <span class="hljs-selector-attr">[优先级1]</span> <span class="hljs-selector-attr">[0:00-0:05]</span> - 小猫在草地上坐下，观察周围环境，展示了它的好奇心和警觉性
<span class="hljs-selector-tag">B</span>. <span class="hljs-selector-attr">[优先级2]</span> <span class="hljs-selector-attr">[0:23-0:25]</span> - 小猫抬头看向远处，表现出对环境的探索和兴趣
C. <span class="hljs-selector-attr">[优先级1]</span> <span class="hljs-selector-attr">[0:27-0:30]</span> - 小猫发现地上的蛋壳，并开始尝试吃掉，展示了它的食欲和探索行为
D. <span class="hljs-selector-attr">[优先级2]</span> <span class="hljs-selector-attr">[0:33-0:35]</span> - 小猫尝试吃蛋壳时，表现出一些困惑和不确定的表情，增加了视频的趣味性
E. <span class="hljs-selector-attr">[优先级1]</span> <span class="hljs-selector-attr">[0:37-0:40]</span> - 小猫最终成功吃掉了蛋壳，并继续在草地上活动，展示了它的满足感
</code></pre>
<p>接下来进行的2～4步的处理，以1s为间隔对视频进行抽帧，对高光要点与抽帧后的图片进行嵌入生成与语义匹配，最后根据抽帧间隔与帧起始时间合并连续片段。最终提取出9个连续的高光片段（总时长16秒）如下表所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb64ef7f9c4d46d3b751316c8d306c5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=2l%2FMkUO8wt%2BpA%2FpweOml7hz1aBs%3D" alt="image.png" loading="lazy"/></p>
<p>从结果上看，高光视频短片包含了原视频中2个主要高光瞬间（扑抓动作和看向镜头），同时也整合了VLM分析中关于小猫“靠近、玩弄/咬住蛋壳”的高优先级动作片段（对应片段4、5、7、8），跳过了较长的静态张望部分同时保持了一定的动作连贯性。<br/>
总结：该方案优点是资源消耗更低、实现速度更快；但缺点在于抽帧可能丢失动作延续或动态效果，因此定位精度可能略逊于方案 2，适合快速试验或成本/资源受限的场景。</p>
<h2 data-id="heading-16">附加考虑：BGM，转场动画，字幕及其他自动化</h2>
<p><strong>背景音乐匹配</strong>：高光剪辑常配以恰当的背景音乐（BGM）增强观赏性。我们可以利用上述文本描述和嵌入技术来自动挑选BGM。例如，将高光片段的<strong>文字描述</strong>（来自VLM总结的高光要点）输入音乐库的嵌入查询，寻找语义上契合的音乐片段。音乐库中每首背景音乐可事先标注情绪、风格或含有描述文本，按需检索。举例来说，如果高光描述提到“激动人心的绝杀时刻”，系统可能选择一首节奏紧凑、激昂的配乐与之对应。</p>
<p><strong>视觉转场和特效</strong>：生成剪辑时还可考虑自动添加一些转场效果或字幕说明。例如，在片段衔接处插入快速淡入淡出或动感转场，以增强流畅度（这里可以用大模型基于提示词直接生成剪辑剧本和转场动画标签）；<strong>增加字幕：</strong>  字幕可用各方案第一阶段的VLM输出的描述增加到对应的高光片段上，或进一步用LLM优化，在对应片段下方叠加字幕或标题，提示观众这个片段精彩之处（例如“最后三秒绝杀进球！”）。</p>
<p><strong>迭代优化</strong>：在实际应用中，可以根据用户反馈或观看数据，不断优化高光选择规则和效果处理。例如统计哪些自动生成的高光片段留存率高，哪种BGM搭配更受欢迎，反过来调整VLM的提示词和相似度匹配的阈值，形成<strong>反馈循环</strong>，逐步提高高光剪辑的质量。</p>
<h2 data-id="heading-17">总结与讨论：应用场景，方案特点和选型思路</h2>
<p>综上所述，本方案提出了一套利用AI进行视频高光剪辑的思路：从基本的纯大语言模型识别高光节点，到语义摘要+嵌入检索实现跨素材的检索和剪辑，并提供了随着素材积累逐步提升的思路。</p>
<h3 data-id="heading-18">VLM 直接识别 vs 嵌入模型检索：</h3>
<p>随着模型规模与多模态预训练技术的发展，现代 VLM （比如本文案例中使用的Nova理解类模型）擅长同时处理视觉内容、语义信息与时序结构。它们能够从整段视频中快速提取“哪些时刻是高光”“这些高光的起止时间在哪里”，因为它们在训练阶段已学习到“动作／事件 → 关键帧”与“视觉＋语言语义”之间的对应关系。在现实剪辑任务中，如果视频结构相对简单、动作明显、视觉变化突出，VLM 直接识别的路径可能几乎一步到位：模型读取视频，识别出“高光动作”或“精彩节点”，并直接标出时间戳。在这种场景下，少了切片、分割、索引、匹配等环节，流程更短、响应更快。</p>
<p>那么为什么我们在解决方案里引入嵌入模型？其价值主要体现在以下几个方面：第一，在素材库规模大、跨视频检索需求高的场景，嵌入模型使你能够为每个视频片段或帧生成可索引的向量，从而构建“素材库可复用＋检索加速”的结构。通过这种方式，无论未来你要处理多少条视频或多少次剪辑任务，都可以依赖已生成的向量库进行高效检索，而不是每次都让 VLM 全面扫描。第二，对于高度定制化剪辑需求（如品牌剧本、风格统一、跨视频片段拼接）来说，嵌入模型提供了更强的“匹配”能力：你可以用描述或事件提示作为查询，在向量空间中查找与之最相似的片段，再组合成成片。这种方法更适用于“从大量素材中选”“按照用户剧本拼接”这类复杂任务。</p>
<h4 data-id="heading-19"><strong>为方便产品或技术团队快速决策，下面是选型建议：</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9f33c35b0843a2877548a574e34b0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=VGU5UmbjGPe84Gbc5T52%2BqGc4jk%3D" alt="image.png" loading="lazy"/></p>
<p>自动高光剪辑技术方案可用于制造业如相机云存剪辑， 媒资场景如明星高光，电视剧摘要等。在未来，我们期待这种自动化高光剪辑能够大幅减少人工剪辑耗时，实现“一键生成精彩瞬间”，为内容创作者和观众带来更高效的体验，为亚马逊云科技客户产品带来创新和效益。</p>
<h2 data-id="heading-20">可用性与定价</h2>
<p>Amazon Nova理解类模型和多模态嵌入模型现已在Amazon Bedrock上线，可用区域包括美国东部（弗吉尼亚北部）的亚马逊云科技区域。如需详细定价信息，请参阅Amazon Bedrock定价页面（<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fbedrock%2Fpricing%2F" target="_blank" title="https://aws.amazon.com/bedrock/pricing/" ref="nofollow noopener noreferrer">Amazon Bedrock pricing page</a>）。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/337c383a2ffd4ca896a811ddbc19f5c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767626353&amp;x-signature=rlqrvayjVZRqmo1xKaI38qJCvW0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战记录：使用 Haskell.nix 交叉编译 Haskell 项目至 Windows]]></title>    <link>https://juejin.cn/post/7589110783146672162</link>    <guid>https://juejin.cn/post/7589110783146672162</guid>    <pubDate>2025-12-29T15:19:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589110783146672162" data-draft-id="7589110783146655778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战记录：使用 Haskell.nix 交叉编译 Haskell 项目至 Windows"/> <meta itemprop="keywords" content="Haskell,Windows"/> <meta itemprop="datePublished" content="2025-12-29T15:19:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战记录：使用 Haskell.nix 交叉编译 Haskell 项目至 Windows
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:19:33.000Z" title="Mon Dec 29 2025 15:19:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Haskell 开发中，使用 Nix 进行构建能带来极大的便利，尤其是涉及跨平台交叉编译时。本文记录了将一个基于 <code>haskell.nix</code> 的项目（<code>haskell-periodic</code>）配置为支持 Windows (<code>mingwW64</code>) 交叉编译的全过程。</p>
<h2 data-id="heading-0">1. 调整构建脚本 (<code>Makefile</code>)</h2>
<p>原始的 <code>Makefile</code> 1 主要是针对 Linux (musl) 环境设计的，缺少对 Windows 可执行文件后缀（<code>.exe</code>）和特定工具链的支持。</p>
<p>为了支持 Windows 交叉编译，我们需要在 <code>Makefile</code> 中增加对 <code>mingwW64</code> 平台的分支判断，主要修改点如下：</p>
<ol>
<li><strong>定义 Strip 工具</strong>：Linux 下通常使用 standard <code>strip</code>，但在交叉编译 Windows 版本时，必须使用对应的 <code>x86_64-w64-mingw32-strip</code>。</li>
<li><strong>处理文件后缀</strong>：Windows 可执行文件需要 <code>.exe</code> 后缀，而 Linux 不需要。</li>
<li><strong>修改输出目标</strong>：构建目标路径需要动态追加这个后缀。</li>
</ol>
<p><strong>修改后的 <code>Makefile</code> 片段：</strong></p>
<p>Makefile</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># ... 之前的定义 ...</span>

<span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(PLATFORM)</span>,mingwW64)
<span class="hljs-comment"># Windows 平台特定配置</span>
STRIP = x86_64-w64-mingw32-strip
COMPILER ?= ghc9122
EXT = .exe
<span class="hljs-keyword">else</span>
<span class="hljs-comment"># ... 其他平台配置 ...</span>
<span class="hljs-keyword">endif</span>

<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 针对每个组件，确保输出包含后缀 $(EXT)</span>
<span class="hljs-section">periodic:</span>
	PKG=periodic-client-exe make dist/<span class="hljs-variable">$(PLATFORM)</span>/<span class="hljs-variable">$@</span><span class="hljs-variable">$(EXT)</span>

<span class="hljs-comment"># ... 其他组件类似 ...</span>
</code></pre>
<p>通过运行 <code>make PLATFORM=mingwW64</code>，构建系统现在可以正确识别目标平台并尝试生成 <code>.exe</code> 文件。</p>
<h2 data-id="heading-1">2. 遭遇链接错误：UCRT 与 MSVCRT 冲突</h2>
<p>在调整完 <code>Makefile</code> 并尝试构建后，我们在链接阶段（Linking）遇到了如下错误：</p>
<p>Plaintext</p>
<pre><code class="hljs language-vbnet" lang="vbnet">multiple definition <span class="hljs-keyword">of</span> `__getmainargs<span class="hljs-comment">'</span>
multiple definition <span class="hljs-keyword">of</span> `_onexit<span class="hljs-comment">'</span>
multiple definition <span class="hljs-keyword">of</span> `_amsg_exit<span class="hljs-comment">'</span>
...
</code></pre>
<p>问题分析：</p>
<p>这是一个经典的 Windows C 运行时冲突问题。现代的 GHC 和 Nix 工具链倾向于使用 UCRT (Universal C Runtime)，但某些依赖或 GHC 内部组件可能引入了旧版的 MSVCRT (Microsoft Visual C Runtime)。当链接器同时遇到这两套库的符号定义时，就会报“多重定义”错误。</p>
<h2 data-id="heading-2">3. 修正 Nix 配置 (<code>default.nix</code>)</h2>
<p>为了解决这个问题，我们需要通过 GHC 传递参数给链接器，告诉它允许符号的多重定义（让链接器自动选择其中一个）。</p>
<p>我们需要修改 <code>default.nix</code> 2222，利用 <code>haskell.nix</code> 提供的模块系统 (<code>modules</code>) 注入特定的 <code>configureFlags</code>。</p>
<p><strong>修改后的 <code>default.nix</code> 关键部分：</strong></p>
<p>Nix</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ... 头部引入保持不变 ...</span>

in pkgs.haskell-nix.cabalProject {
    <span class="hljs-comment"># ... src, index-state 等配置 ...</span>
    
    <span class="hljs-attr">modules</span> = [(
       {pkgs, ...}: {
         enableProfiling = enableProfiling<span class="hljs-comment">;</span>

         <span class="hljs-comment"># --- Windows 交叉编译修复 ---</span>
         <span class="hljs-comment"># 针对 Windows 平台，添加链接器参数以解决 UCRT/MSVCRT 冲突</span>
         packages.periodic-client-exe.configureFlags = pkgs.lib.optionals pkgs.stdenv.hostPlatform.isWindows [
           <span class="hljs-string">"--ghc-option=-optl-Wl,--allow-multiple-definition"</span>
         ]<span class="hljs-comment">;</span>

         <span class="hljs-comment"># 如果 Server 端也需要在 Windows 构建，同样应用该修复</span>
         packages.periodic-server.configureFlags = pkgs.lib.optionals pkgs.stdenv.hostPlatform.isMusl [
           <span class="hljs-comment"># ... 保留原有的 Linux/Musl 链接库配置 ...</span>
           <span class="hljs-string">"--ghc-option=-optl=-lssl"</span>
           <span class="hljs-comment"># ...</span>
         ] ++ pkgs.lib.optionals pkgs.stdenv.hostPlatform.isWindows [
           <span class="hljs-string">"--ghc-option=-optl-Wl,--allow-multiple-definition"</span>
         ]<span class="hljs-comment">;</span>
      })]<span class="hljs-comment">;</span>
}
</code></pre>
<p>这里使用了 <code>pkgs.lib.optionals pkgs.stdenv.hostPlatform.isWindows</code> 来确保这些标志仅在编译 Windows 版本时生效，不会影响 Linux 版本的构建。</p>
<h2 data-id="heading-3">4. 最终结果</h2>
<p>完成上述修改后，再次执行构建命令：</p>
<p>Bash</p>
<pre><code class="hljs language-ini" lang="ini">make <span class="hljs-attr">PLATFORM</span>=mingwW64
</code></pre>
<p>构建过程顺利通过链接阶段，成功在 <code>dist/mingwW64/</code> 目录下生成了 Windows 可执行文件（如 <code>periodic.exe</code>）。通过这种方式，我们利用 Nix 强大的交叉编译能力，在不离开 Linux 开发环境的情况下，优雅地交付了 Windows 二进制文件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Playwright使用体验]]></title>    <link>https://juejin.cn/post/7589155289190973467</link>    <guid>https://juejin.cn/post/7589155289190973467</guid>    <pubDate>2025-12-29T15:29:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589155289190973467" data-draft-id="7337186171209220111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Playwright使用体验"/> <meta itemprop="keywords" content="前端,单元测试"/> <meta itemprop="datePublished" content="2025-12-29T15:29:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Playwright使用体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:29:44.000Z" title="Mon Dec 29 2025 15:29:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Playwright 安装</h2>
<p>在项目中执行<code>yarn create playwright</code>即可。该命令会在package.json中添加依赖，并生成以下文件和目录。</p>
<pre><code class="hljs language-arduino" lang="arduino">playwright.config.ts  
tests/  
    example.spec.ts  
tests-examples/  
    demo-todo-app.spec.ts
</code></pre>
<h2 data-id="heading-1">Playwright 配置</h2>
<p>playwright.config.ts是Playwrigth的配置文件，生成文件基本不用改动即可运行。</p>
<pre><code class="hljs language-php" lang="php">import { defineConfig, devices } <span class="hljs-keyword">from</span> <span class="hljs-string">'@playwright/test'</span>;

<span class="hljs-comment">/**
 * Read environment variables from file.
 * https://github.com/motdotla/dotenv
 */</span>
<span class="hljs-comment">// require('dotenv').config();</span>

<span class="hljs-comment">/**
 * See https://playwright.dev/docs/test-configuration.
 */</span>
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">testDir</span>: <span class="hljs-string">'./tests'</span>,
  <span class="hljs-comment">/* Run tests in files in parallel */</span>
  <span class="hljs-attr">fullyParallel</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">/* Fail the build on CI if you accidentally left test.only in the source code. */</span>
  <span class="hljs-attr">forbidOnly</span>: !!process.env.CI,
  <span class="hljs-comment">/* Retry on CI only */</span>
  <span class="hljs-attr">retries</span>: process.env.CI ? <span class="hljs-number">2</span> : <span class="hljs-number">0</span>,
  <span class="hljs-comment">/* Opt out of parallel tests on CI. */</span>
  <span class="hljs-attr">workers</span>: process.env.CI ? <span class="hljs-number">1</span> : undefined,
  <span class="hljs-comment">/* Reporter to use. See https://playwright.dev/docs/test-reporters */</span>
  <span class="hljs-attr">reporter</span>: <span class="hljs-string">'html'</span>,
  <span class="hljs-comment">/* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */</span>
  <span class="hljs-attr">use</span>: {
    <span class="hljs-comment">/* Base URL to use in actions like `await page.goto('/')`. */</span>
    // <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://local.test.com:3001'</span>,
    <span class="hljs-comment">/* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */</span>
    <span class="hljs-attr">trace</span>: <span class="hljs-string">'on-first-retry'</span>,
  },
  <span class="hljs-comment">/* Configure projects for major browsers */</span>
  <span class="hljs-attr">projects</span>: [
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'setup'</span>, <span class="hljs-attr">testMatch</span>: /.*\.setup\.ts/ },
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'chromium'</span>,
      <span class="hljs-attr">use</span>: {
        ...devices[<span class="hljs-string">'Desktop Chrome'</span>],
        <span class="hljs-attr">storageState</span>: <span class="hljs-string">'playwright/.auth/user.json'</span>,
        <span class="hljs-attr">viewport</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">1080</span> },
      },
      <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'setup'</span>],
    },

    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'firefox'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'Desktop Firefox'</span>] },
    // },

    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'webkit'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'Desktop Safari'</span>] },
    // },

    <span class="hljs-comment">/* Test against mobile viewports. */</span>
    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'Mobile Chrome'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'Pixel 5'</span>] },
    // },
    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'Mobile Safari'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'iPhone 12'</span>] },
    // },

    <span class="hljs-comment">/* Test against branded browsers. */</span>
    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'Microsoft Edge'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'Desktop Edge'</span>], <span class="hljs-attr">channel</span>: <span class="hljs-string">'msedge'</span> },
    // },
    // {
    //   <span class="hljs-attr">name</span>: <span class="hljs-string">'Google Chrome'</span>,
    //   <span class="hljs-attr">use</span>: { ...devices[<span class="hljs-string">'Desktop Chrome'</span>], <span class="hljs-attr">channel</span>: <span class="hljs-string">'chrome'</span> },
    // },
  ],
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
  <span class="hljs-comment">/* Run your local dev server before starting the tests */</span>
  <span class="hljs-attr">webServer</span>: {
    <span class="hljs-attr">command</span>: <span class="hljs-string">'yarn dev'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://local.aaa.com:3001'</span>,
    <span class="hljs-attr">reuseExistingServer</span>: !process.env.CI,
  },
});

</code></pre>
<p>不过在实践中，有几项建议修改：</p>
<ol>
<li>
<p>baseURL，设置后，使用 page.goto不需要再指定完整路径</p>
</li>
<li>
<p>timeout，不知道是否是网络原因，Playwright打开网页总是很慢，测试用例很容易跑超时，所以我将timeout改成了5 * 60 * 1000</p>
</li>
<li>
<p>webServer 本地测试时强烈建议开启该功能</p>
<pre><code class="hljs language-yaml" lang="yaml">  <span class="hljs-attr">webServer:</span> {
    <span class="hljs-attr">command:</span> <span class="hljs-string">'yarn dev'</span>,
    <span class="hljs-attr">url:</span> <span class="hljs-string">'http://local.test.com:3001'</span>,
    <span class="hljs-attr">reuseExistingServer:</span> <span class="hljs-type">!process.env.CI,</span>
  }<span class="hljs-string">,</span>
</code></pre>
<p>运行测试时，Playwright将先运行<code>yarn dev</code>启动服务，并等待<a href="https://link.juejin.cn?target=http%3A%2F%2Flocal.test.com%3A3001" target="_blank" title="http://local.test.com:3001" ref="nofollow noopener noreferrer">local.test.com:3001</a> 可访问时再开始测试。这个配置非常好用，相对比<strong>cypress</strong>就需要额外安装<strong>start-server-and-test</strong>。</p>
</li>
<li>
<p>用户登录相关，见下一节。</p>
</li>
</ol>
<h2 data-id="heading-2">Playwright缓存用户登录信息</h2>
<p>一般运行测试前需要先进行登录，Playwright可以缓存用户信息，在之后多次测试中复用，配置也很简单。</p>
<h3 data-id="heading-3">创建auth文件夹</h3>
<p>按照官网建议，直接在项目中创建playwright.auth文件夹</p>
<h3 data-id="heading-4">编写登录程序</h3>
<p>在tests目录中新增auth.setup.ts,内容可参考如下</p>
<pre><code class="hljs language-csharp" lang="csharp">import { test <span class="hljs-keyword">as</span> setup, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@playwright/test'</span>;

<span class="hljs-keyword">const</span> authFile = <span class="hljs-string">'playwright/.auth/user.json'</span>;

setup(<span class="hljs-string">'authenticate'</span>, <span class="hljs-keyword">async</span> ({ page }) =&gt; {
  <span class="hljs-comment">// Perform authentication steps. Replace these actions with your own.</span>
  <span class="hljs-keyword">await</span> page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">'https://xxx.xxx.com/login/'</span>);
  <span class="hljs-keyword">await</span> page.locator(<span class="hljs-string">'#account'</span>).fill(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-keyword">await</span> page.locator(<span class="hljs-string">'#password'</span>).fill(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-keyword">await</span> page.locator(<span class="hljs-string">'button[type=submit]'</span>).click();
  <span class="hljs-comment">// Wait until the page receives the cookies.</span>
  <span class="hljs-comment">//</span>
  <span class="hljs-comment">// Sometimes login flow sets cookies in the process of several redirects.</span>
  <span class="hljs-comment">// Wait for the final URL to ensure that the cookies are actually set.</span>
  <span class="hljs-keyword">await</span> page.waitForURL(<span class="hljs-string">'https://xxx.xxx.com/'</span>);

  <span class="hljs-comment">// Alternatively, you can wait until the page reaches a state where all cookies are set.</span>
  <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">'#title'</span>)).toBeVisible();

  <span class="hljs-comment">// End of authentication steps.</span>

  <span class="hljs-keyword">await</span> page.context().storageState({ path: authFile });
});
</code></pre>
<p>这段代码先访问统一登录地址（测试网页域名可能和登录地址不一样），模拟输入用户名/密码，点击提交。登录成功后，<code>page.context().storageState({ path: authFile })</code>将cookie/storage信息存入authFile文件。</p>
<h3 data-id="heading-5">修改配置文件</h3>
<p>修改配置文件中的projects配置</p>
<pre><code class="hljs language-css" lang="css">  projects: [
    { name: <span class="hljs-string">'setup'</span>, testMatch: /.*\.setup\.ts/ },
    {
      name: <span class="hljs-string">'chromium'</span>,
      use: {
        ..<span class="hljs-selector-class">.devices</span><span class="hljs-selector-attr">[<span class="hljs-string">'Desktop Chrome'</span>]</span>,
        storageState: <span class="hljs-string">'playwright/.auth/user.json'</span>,
        viewport: { <span class="hljs-attribute">width</span>: <span class="hljs-number">1920</span>, height: <span class="hljs-number">1080</span> },
      },
      dependencies: [<span class="hljs-string">'setup'</span>],
    },
    ...
]
</code></pre>
<h2 data-id="heading-6">Playwright 运行</h2>
<p>直接运行命令<code>yarn playwright test --ui</code>,会出现下面弹窗</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a538aab8026458e8a901e31a302e406~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1257&amp;h=762&amp;s=55570&amp;e=png&amp;b=fcfcfc" alt="image.png" loading="lazy"/></p>
<p>点击example.spec.ts旁边的开始键就可以运行测试用例了，可以看到auth.setup.ts中的登录程序也被自动运行了。
点击每个用例可以显示更多运行信息。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51d573378b53403b948775464fc29caf~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=316&amp;h=325&amp;s=16355&amp;e=png&amp;b=f6f5f5" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">Playwright 简单小结</h2>
<p>Playwright上手非常简单，但是ui mode比较简陋，不适合边测试边debug。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1 发布：更聪明，也更有温度的 AI]]></title>    <link>https://juejin.cn/post/7589126920286683146</link>    <guid>https://juejin.cn/post/7589126920286683146</guid>    <pubDate>2025-12-29T15:49:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286683146" data-draft-id="7589130173837918258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1 发布：更聪明，也更有温度的 AI"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-29T15:49:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1 发布：更聪明，也更有温度的 AI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:49:20.000Z" title="Mon Dec 29 2025 15:49:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天深夜，OpenAI 悄然上线了 GPT-5.1 系列模型，带来了两个全新版本：<strong>GPT-5.1 Instant</strong> 和 <strong>GPT-5.1 Thinking</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe5eca69a1564698999678c73538be36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628159&amp;x-signature=NXmfYR66crDv%2FFxFgx%2BxtrqdKOY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daeacd9e1b92466e98a42d5612906977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628159&amp;x-signature=mk5bttlVO8R8LAg%2F%2BvAGMZVy43k%3D" alt="" loading="lazy"/></p>
<p>这次更新看似低调，却在智能与交互体验上都迈出了一大步。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、GPT-5.1 Instant：更快、更聪明、更贴心</h2>
<p>如果说 GPT-5 是一位理性的工程师，那么 GPT-5.1 Instant 就像是那位既懂逻辑又会聊天的朋友。它延续了 GPT-5 的高准确性，同时在语气、理解力和指令执行上都有明显提升。</p>
<p>根据早期体验，Instant 的最大特点是<strong>自适应推理</strong>。简单来说，它能根据问题的复杂程度决定自己要不要<strong>认真思考</strong>一下——对轻量问题迅速回应，对复杂问题自动进入深度推理模式。这种平衡带来了前所未有的流畅感：既保留速度，又不牺牲质量。</p>
<p>同时，它在数学、代码和逻辑题上的正确率也显著提升，AIME 2025 与 Codeforces 等测试的表现就是明证。</p>
<h2 data-id="heading-1">二、GPT-5.1 Thinking：更稳、更懂、更人性</h2>
<p>与 Instant 侧重速度不同，<strong>GPT-5.1 Thinking</strong> 是 OpenAI 面向复杂任务推出的深思型模型。它的更新重点在于推理策略的改进：<strong>根据任务难度动态分配思考时间</strong>。</p>
<ul>
<li>遇到简单问题：迅速作答；</li>
<li>面对复杂推理：自动延长思考，输出更系统的结论。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f5e983a9f9f4dd09fcec24cb3df31bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628159&amp;x-signature=TGc5cx9Efe8bi9bHWgsjvC3pJjY%3D" alt="" loading="lazy"/></p>
<p>同时，它在表达上也更自然了。过去有时回答技术问题容易夹杂生僻术语，而 5.1 Thinking 更倾向于用<strong>清晰、易懂、带温度的语言</strong>解释复杂概念。<br/>
比如当它讲解棒球统计中的 <em>BABIP</em> 和 <em>wRC+</em> 时，不再是晦涩的公式堆砌，而是像在和你聊天一样解释击球效率与进攻贡献的关系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343b2e985fb4497db1f204a90a3aee08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628159&amp;x-signature=Qs0TJhjC8xAM46p8Egme6w3k3RM%3D" alt="" loading="lazy"/></p>
<p>这让 GPT-5.1 Thinking 更像是一位真正的 AI 助手，而不是冷冰冰的算法模型。</p>
<h2 data-id="heading-2">三、更智能的模型调度：Auto 模式升级</h2>
<p>值得注意的是，GPT-5.1 系列还改进了 <strong>Auto 路由机制</strong>。也就是说，当你与 ChatGPT 对话时，系统会自动判断是调用 Instant 还是 Thinking，无需手动切换。<br/>
对于普通用户来说，这意味着更自然的体验：</p>
<ul>
<li>聊天类任务 → Instant</li>
<li>推理、写作、分析类任务 → Thinking</li>
</ul>
<p>AI 将自己决定该用哪种大脑思考，而你只需专注于问题本身。</p>
<p>GPT-5.1 Instant 与 Thinking 已面向 Pro、Plus、Go、Business 用户逐步开放，企业版和教育版可以提前开启早期访问。API 版本也即将同步上线，其中：</p>
<ul>
<li><code>gpt-5.1-chat-latest</code> 对应 Instant；</li>
<li><code>gpt-5.1</code> 对应 Thinking。</li>
</ul>
<p>在接下来的三个月里，GPT-5 与 GPT-5.1 将并行提供，方便开发者与用户进行对比测试。之后，GPT-5.1 将成为默认模型。</p>
<p>从 GPT-3 的惊艳登场，到 GPT-4 的多模态能力，再到如今 GPT-5.1 的思考升级，我们能明显感受到——<strong>AI 的进化正从更强走向更懂</strong>。<br/>
它不再只是工具，而是会感知语气、理解语境、体谅情绪的伙伴。</p>
<p>Sam Altman 在社交平台上说：这是一次不错的模型升级。<br/>
但对许多用户而言，这不仅仅是不错，而是让人与机器对话再次变得愉悦的一次跨越。</p>
<p>关于深度学习和AI大模型相关的知识和前沿技术更新，请关注公众号 <strong>coting</strong>！</p>
<p><strong>GPT系列文章</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927401841815160673" target="_blank" title="https://zhuanlan.zhihu.com/p/1927401841815160673" ref="nofollow noopener noreferrer">GPT1：通用语言理解模型的开端</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927841343062910920" target="_blank" title="https://zhuanlan.zhihu.com/p/1927841343062910920" ref="nofollow noopener noreferrer">GPT-2：让语言模型一统多任务学习江湖</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927843404387189930" target="_blank" title="https://zhuanlan.zhihu.com/p/1927843404387189930" ref="nofollow noopener noreferrer">GPT-3：真正意义上的少样本学习模型来了！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927844194703111701" target="_blank" title="https://zhuanlan.zhihu.com/p/1927844194703111701" ref="nofollow noopener noreferrer">GPT‑3.5：从语言模型迈向对话智能的过渡之作</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927844769058497732" target="_blank" title="https://zhuanlan.zhihu.com/p/1927844769058497732" ref="nofollow noopener noreferrer">GPT‑4：多模态大规模模型，开启更智能时代</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1937287790099427783" target="_blank" title="https://zhuanlan.zhihu.com/p/1937287790099427783" ref="nofollow noopener noreferrer">GPT-5：天变了吗？还是风停了？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[激活函数有什么用？有哪些常用的激活函数？]]></title>    <link>https://juejin.cn/post/7589126920286699530</link>    <guid>https://juejin.cn/post/7589126920286699530</guid>    <pubDate>2025-12-29T15:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286699530" data-draft-id="7589092567545151497" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="激活函数有什么用？有哪些常用的激活函数？"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-29T15:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            激活函数有什么用？有哪些常用的激活函数？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T15:50:42.000Z" title="Mon Dec 29 2025 15:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习中，<strong>激活函数</strong>（Activation Function）是神经网络的灵魂。它不仅赋予网络非线性能力，还决定了训练的稳定性和模型性能。那么，激活函数到底是什么？为什么我们非用不可？有哪些经典函数？又该如何选择？本文带你全面解析。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FLLMHub" target="_blank" title="https://github.com/aicoting/LLMHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<p>阅读本文时，请带着这三个问题思考：</p>
<ol>
<li><strong>什么是激活函数，为什么需要激活函数？</strong></li>
<li><strong>经典的激活函数有哪些？</strong></li>
<li><strong>怎么选择激活函数？</strong></li>
</ol>
<h2 data-id="heading-0">1. 什么是激活函数，为什么需要激活函数</h2>
<p>激活函数的核心作用就是<strong>为神经网络引入非线性</strong>。</p>
<ul>
<li><strong>为什么需要非线性？</strong><br/>
想象一下，如果网络里每一层都是线性的（比如 y = Wx + b），无论堆叠多少层，最终网络都只是一条线性映射。深度堆叠就没有意义了，网络的表达能力非常有限。</li>
<li><strong>激活函数的作用</strong><br/>
激活函数在每个神经元输出前进行非线性变换，让网络可以拟合复杂的函数关系，从而解决分类、回归等非线性问题。</li>
</ul>
<p>**直观理解一下，**激活函数就像神经网络里的“开关”或“滤镜”，它决定了每个神经元应该多大程度地“激活”，从而使网络具备强大的表达能力。</p>
<h2 data-id="heading-1">2. 经典的激活函数</h2>
<p>在深度学习中，有几类经典激活函数，每种都有自己的优缺点：</p>
<h3 data-id="heading-2">1. Sigmoid</h3>
<p>公式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0ad9beda4e42119cbd9362f53be253~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=ptnh%2Fhz5vcGj6b5gwL1bUpR8tVs%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8b89d84343e4984bc8a0ab33d824f37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=1SBHXbOC3b4QtDNuKX82xcfRRko%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>优点</strong>：输出范围在 (0,1)，可以表示概率</li>
<li><strong>缺点</strong>：容易<strong>饱和</strong>（输入过大或过小时梯度接近0，导致梯度消失）</li>
<li><strong>应用场景</strong>：二分类输出层</li>
</ul>
<h3 data-id="heading-3">2. Tanh（双曲正切）</h3>
<p>公式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ed53d7dbda34d6f80bc3825c16d3734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=ckzbfplsuAP8aREpi1f%2BZDXz8WM%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f27f75d26b42c9baf8b99e42646641~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=r44L5jVJcT4zT4w%2BPakx7TBFaYY%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>优点</strong>：输出在 (-1,1)，比 sigmoid 居中，对梯度更友好</li>
<li><strong>缺点</strong>：仍可能梯度消失</li>
<li><strong>应用场景</strong>：RNN 隐层</li>
</ul>
<h3 data-id="heading-4">3. ReLU（Rectified Linear Unit）</h3>
<p>公式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd97321578954a43abaa83d2970b2b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=DfcmHM7MieHQieQT%2BtITR6%2FbiwI%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5c5a59b231741ac86f58f1d4d8ef749~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=uR2LqIyHxTTdLYKTqynwCysQ%2BUE%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>优点</strong>：计算简单，导数恒为1（正区间），缓解梯度消失</li>
<li><strong>缺点</strong>：负区间可能“死亡”，即神经元永远不激活</li>
<li><strong>应用场景</strong>：隐藏层主流激活函数</li>
</ul>
<h3 data-id="heading-5">4. Leaky ReLU / Parametric ReLU（PReLU）</h3>
<p>公式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cf02a80f97447a9b3bb7ef09cf50617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=BHKLqDBd1mqQNgcamQGB5%2BYMadw%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2795d46981e4cafaa7d406d19de9962~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=TmXzd6qcXuHLDFt0%2FORYYTs1a3A%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Leaky ReLU</strong>: 对负区间引入一个小斜率，避免神经元死亡</li>
<li><strong>PReLU</strong>: 斜率可学习，更灵活</li>
</ul>
<h3 data-id="heading-6">5. Softmax</h3>
<p>公式</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1558d457e59947c7be327a98b0e14649~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=L0De9zrzJuOz1sJc9Zm9zVNfKeQ%3D" alt="image" loading="lazy"/></p>
<p>Softmax 输出的是一组归一化的概率，在图中使用 <strong>柱状图 (bar chart)</strong> 展示每个输入元素对应的概率值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e9d314536aa448eb3acb2d005a5674f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=wUcSzAEC%2FpsWTlJqivGTZTTbKP0%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>作用</strong>：多分类输出概率分布</li>
<li><strong>应用场景</strong>：分类任务输出层</li>
</ul>
<h3 data-id="heading-7"><strong>6.ELU（Exponential Linear Unit）</strong></h3>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dddb8708a8c4143a9049d3062dedaa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=VqRHblPXIYQF%2FtAiOGkQ53CrZu0%3D" alt="image" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea26be879fa0480db454f041ce8bae44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=V37QJPF05tMqeIaufug9VrTZgGg%3D" alt="" loading="lazy"/></p>
<p>**特点：**负区间平滑非零，避免 ReLU 死区问题。<br/>
<strong>优点：</strong> 输出均值更接近 0，梯度更稳定。<br/>
<strong>常用于：</strong> 深层 CNN、MLP。</p>
<h3 data-id="heading-8"><strong>7.SELU（Scaled Exponential Linear Unit）</strong></h3>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/894183225b05434abac399537c4ca560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=q3e2g4JQOBMzNkq%2FdWO0zBJsQKc%3D" alt="image" loading="lazy"/><br/>
其中 λ≈1.05，α≈1.67。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93c7811730e4c79a54c74bc282e65e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=Ssi94y8X7k0IFZAUghM9C%2BPNOH4%3D" alt="" loading="lazy"/><br/>
**特点：**在特定初始化下能实现自归一化，保持激活均值和方差稳定。<br/>
<strong>优点：</strong> 无需 BatchNorm。<br/>
<strong>常用于：</strong> 自归一化神经网络（Self-Normalizing NN）。</p>
<h3 data-id="heading-9"><strong>8.GELU（Gaussian Error Linear Unit）</strong></h3>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171c8445b7c44b16aabd39c6a3e577e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=YSn8H5DV603sbyp0FOk82szeIQA%3D" alt="image" loading="lazy"/><br/>
其中 Φ(x) 是标准正态分布 CDF。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cfcd84e8f443318b65b78eee848724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=mDFDgkxT40q6xvsPMkdTY8rqGQE%3D" alt="" loading="lazy"/><br/>
**特点：**在 ReLU 的基础上引入概率思想，让激活与输入大小平滑相关。<br/>
<strong>优点：</strong> 更平滑、更稳定，效果普遍优于 ReLU。<br/>
<strong>常用于：</strong> Transformer（BERT、GPT、ViT）。</p>
<h3 data-id="heading-10"><strong>9.SiLU（Swish）</strong></h3>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc2f9c2cfee745448a838e055416be27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=oVtgGTFdJlB8Ka%2BOL%2FiyZkVp%2BVA%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e862f7828d8f4e7d9fa221f72bfefe88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=5Y2TZoqFQ2qgfHtnuNw3Oq6%2Bu9k%3D" alt="" loading="lazy"/><br/>
**特点：**与 GELU 类似，是一种平滑版 ReLU。<br/>
<strong>优点：</strong> 梯度连续，优化更稳定。<br/>
<strong>常用于：</strong> EfficientNet、Transformer。</p>
<h3 data-id="heading-11"><strong>10.GLU（Gated Linear Unit）</strong></h3>
<p>GLU/SwiGLU 在实际中是门控形式（two linear branches），是向量上的逐元素操作；为了在一维上可视化，我用简化的标量形式来画图 —— 把两条分支都用相同的输入值（即把 a=x, b=x），因此 GLU(x) = x * sigmoid(x)，SwiGLU(x) = x * SiLU(x)。这能直观展示门控机制的形状差异。</p>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f4f780837184b4dae67ec7223e80f47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=Ny0IJcarFyGnlxBb02FBMNTkZdE%3D" alt="image" loading="lazy"/><br/>
其中第二个分支作为门控信号。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9a73a37d36f45d08eca136319ab69aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=8N12hEM6FfHKOU5iC2t2m53LHfE%3D" alt="" loading="lazy"/><br/>
**特点：**通过门控机制控制信息流，增强非线性表达。<br/>
<strong>优点：</strong> 适合序列建模、控制性强。<br/>
<strong>常用于：</strong> Transformer FFN、语言模型。</p>
<h3 data-id="heading-12"><strong>11.SwiGLU（Swish-Gated Linear Unit）</strong></h3>
<p><strong>公式：</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4da9307de6714a66825dcf2de50313b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=%2BNHr9%2FyNTEeYsfIXAU9O4TqjR%2F0%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6ca723189314d97b673d9712cd76971~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767628241&amp;x-signature=rYnsghrEX7AWtER3rGX8WMjnMxM%3D" alt="" loading="lazy"/><br/>
**特点：**GLU 的改进版，把 Sigmoid 门换成 Swish 门。<br/>
<strong>优点：</strong> 表达力更强、梯度更平滑，性能优于 ReLU/GELU。<br/>
<strong>常用于：</strong> LLaMA、PaLM、GPT-NeoX 等现代 LLM。</p>
<h2 data-id="heading-13">3. 怎么选择激活函数</h2>
<p>选择激活函数时，可以根据以下几个原则：</p>
<ol>
<li><strong>隐藏层</strong>
<ul>
<li>优先使用 ReLU 或其变种（Leaky ReLU, ELU, PReLU）</li>
<li>优点：计算快、缓解梯度消失</li>
</ul>
</li>
<li><strong>输出层</strong>
<ul>
<li>二分类：Sigmoid</li>
<li>多分类：Softmax</li>
<li>回归：线性或无激活函数</li>
</ul>
</li>
<li><strong>网络结构和任务需求</strong>
<ul>
<li>RNN 中常用 tanh 或 ReLU</li>
<li>深层网络推荐使用残差连接 + ReLU</li>
<li>如果担心 ReLU 死神经元，可尝试 Leaky ReLU 或 ELU</li>
</ul>
</li>
</ol>
<p><strong>小技巧</strong>：</p>
<p>如果不确定用哪个激活函数，隐藏层可以先用 ReLU，输出层按任务选择；训练中注意梯度情况，如果梯度消失或爆炸，再考虑替换或调整激活函数。</p>
<h2 data-id="heading-14">4. 总结</h2>
<p>激活函数是神经网络不可或缺的魔法开关，让网络能够拟合复杂的非线性关系。</p>
<ul>
<li><strong>核心作用</strong>：引入非线性，增强网络表达能力</li>
<li><strong>经典激活函数</strong>：Sigmoid、Tanh、ReLU及变种、ELU、Softmax</li>
<li><strong>选择策略</strong>：隐藏层用 ReLU 或变种，输出层根据任务选择，结合网络深度和训练表现调整</li>
</ul>
<p>理解激活函数的本质和特点，有助于设计更稳定、高效的神经网络。</p>
<p>最后我们来回答一下文章开头提出的三个问题：</p>
<ol>
<li><strong>什么是激活函数，为什么需要激活函数？</strong><br/>
激活函数是神经网络中对每个神经元输出进行非线性变换的函数，它的作用是赋予网络非线性能力，使得深层网络可以拟合复杂的函数关系。如果没有激活函数，无论网络有多少层，其输出都只是输入的线性组合，无法处理复杂问题。</li>
<li><strong>经典的激活函数有哪些？</strong><br/>
经典激活函数包括 Sigmoid、Tanh、ReLU 及其变种（如 Leaky ReLU、PReLU）、ELU 和 Softmax 等。其中，Sigmoid 和 Tanh 常用于小型网络或 RNN，ReLU 是深层网络隐藏层的主流选择，而 Softmax 常用于多分类任务的输出层。</li>
<li><strong>怎么选择激活函数？</strong><br/>
选择激活函数时，隐藏层通常优先使用 ReLU 或其变种，因为它计算简单且能缓解梯度消失；输出层则根据任务选择，比如二分类用 Sigmoid、多分类用 Softmax、回归任务可用线性或无激活函数；在特定场景下，也可以结合网络深度和训练表现灵活调整。</li>
</ol>
<p>关于深度学习和大模型相关的知识和前沿技术更新，请关注公众号coting！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能提升 40 倍！实战 PostgreSQL FDW 解决微服务跨库查询难题]]></title>    <link>https://juejin.cn/post/7589074117644976163</link>    <guid>https://juejin.cn/post/7589074117644976163</guid>    <pubDate>2025-12-29T14:03:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589074117644976163" data-draft-id="7589093939656769588" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能提升 40 倍！实战 PostgreSQL FDW   解决微服务跨库查询难题"/> <meta itemprop="keywords" content="数据库,后端"/> <meta itemprop="datePublished" content="2025-12-29T14:03:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能提升 40 倍！实战 PostgreSQL FDW   解决微服务跨库查询难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:03:03.000Z" title="Mon Dec 29 2025 14:03:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">微服务跨库查询：从 24 秒优化到 0.6 秒，我做了什么</h2>
<p>做运营看板的时候遇到个问题：需要把用户对 AI 回复的评价（点赞/点踩）和用户名一起展示出来。听起来简单，但数据分散在两个库里——评价数据在业务库，用户名在用户库。</p>
<p>第一反应是用 Superset 的跨库查询功能，结果查一次要 24 秒，完全没法用。</p>
<p>折腾了一圈，换成 PostgreSQL FDW 方案，同样的查询 0.6 秒就出来了。40 倍的性能差距。</p>
<p>meta database：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae71d2ffe8747ef96e83bf243d76cfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767621783&amp;x-signature=ELrBYaQnVt4pd75mj4Vi%2FjRyAXA%3D" alt="微信图片_2025-12-29_220005_848_副本.png" loading="lazy"/></p>
<p>FDW：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4918af3e786847b09f99cf12946a2e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767621783&amp;x-signature=LpglZnjMOgZSCf0OlIuF6RN0MYM%3D" alt="微信图片_2025-12-29_220201_695.png" loading="lazy"/></p>
<h3 data-id="heading-1">背景：微服务的数据隔离问题</h3>
<p>我们的系统是典型的微服务架构，三个服务各用各的数据库：</p>
<pre><code class="hljs">innies_biz_dev   → 业务数据（消息、评价、知识库）
innies_users_dev → 用户数据（用户名、邮箱、权限）
innies_loom_dev  → Agent 执行数据
</code></pre>
<p>平时服务间通信走 gRPC，数据隔离得挺好。但做运营看板的时候问题来了：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 需求：展示评价记录，带上用户名</span>
<span class="hljs-keyword">SELECT</span>
    r.rating_type,  <span class="hljs-comment">-- 评价类型（业务库）</span>
    u.username,     <span class="hljs-comment">-- 用户名（用户库）← 跨库了</span>
    m.content       <span class="hljs-comment">-- 消息内容（业务库）</span>
<span class="hljs-keyword">FROM</span> message_ratings r
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> r.user_id <span class="hljs-operator">=</span> u.id
</code></pre>
<p>两个库里的表，没法直接 JOIN。</p>
<h3 data-id="heading-2">第一次尝试：Superset Meta Database</h3>
<p>Superset 有个实验性功能叫 Meta Database，号称可以跨库查询。配置挺简单：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># superset_config.py</span>
FEATURE_FLAGS = {
    <span class="hljs-string">"ENABLE_SUPERSET_META_DB"</span>: <span class="hljs-literal">True</span>,
}
</code></pre>
<p>添加三个数据库连接，再加一个 Meta Database（URI 是 <code>superset://</code>），就可以这样查了：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> "innies_biz_dev.public.message_ratings" r
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> "innies_users_dev.public.users" u <span class="hljs-keyword">ON</span> r.user_id <span class="hljs-operator">=</span> u.id
</code></pre>
<p>语法有点怪，整个表路径要用双引号包起来。但能跑就行，对吧？</p>
<p>结果：<strong>24 秒</strong>。</p>
<p>查 13 条数据，等了 24 秒。复杂一点的查询直接超时。</p>
<h3 data-id="heading-3">问题在哪？</h3>
<p>用 EXPLAIN ANALYZE 看了一下数据库层的执行时间：<strong>12 毫秒</strong>。</p>
<p>数据库只花了 12ms，但整个查询要 24 秒。时间都花在哪了？</p>
<p>画个图就明白了：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant S as Superset
    participant B as 业务库
    participant U as 用户库

    S-&gt;&gt;B: SELECT * FROM message_ratings
    B--&gt;&gt;S: 返回全量数据
    S-&gt;&gt;B: SELECT * FROM task_messages
    B--&gt;&gt;S: 返回全量数据
    S-&gt;&gt;U: SELECT * FROM users
    U--&gt;&gt;S: 返回全量数据
    Note over S: Python 内存中做 JOIN
    S--&gt;&gt;S: 返回结果
</code></pre>
<p>问题就在这：它把所有表的数据都拉到应用层，再用 Python 做 JOIN。</p>
<ul>
<li>多次网络往返</li>
<li>全量数据传输（即使你只要 10 条结果）</li>
<li>Python 做 JOIN（效率远低于数据库引擎）</li>
</ul>
<h3 data-id="heading-4">换方案：PostgreSQL FDW</h3>
<p>FDW（Foreign Data Wrapper）是 PostgreSQL 的内置功能，可以把远程数据库的表映射到本地，像本地表一样查。</p>
<p>关键区别：<strong>JOIN 下沉到了数据库内核层</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant S as Superset
    participant P as 本地 PostgreSQL
    participant R as 远程用户库

    S-&gt;&gt;P: SELECT ... JOIN fdw_users.users
    Note over P: 查询优化器分析执行计划
    P-&gt;&gt;R: 拉取需要的行（WHERE 条件下推）
    R--&gt;&gt;P: 返回过滤后的数据
    Note over P: C 引擎内部完成 JOIN
    P--&gt;&gt;S: 返回结果
</code></pre>
<p>虽然在这种跨库场景下（本地表 JOIN 远程表），JOIN 动作依然发生在本地，但它比 Superset 快得多的原因是：</p>
<ol>
<li><strong>内核级效率</strong>：C 语言实现的数据库引擎做 JOIN，比 Python 在内存里处理 Pandas/List 快几个数量级。</li>
<li><strong>按需传输</strong>：PG 优化器很聪明，会把 WHERE 条件下推到远程库，只拉取需要的数据，而不是全量拉取。</li>
<li><strong>协议高效</strong>：数据库内部传输用的是二进制协议，比 HTTP/JSON 高效得多。</li>
</ol>
<h3 data-id="heading-5">配置过程</h3>
<p>FDW 配置需要数据库管理员权限，分这么几步：</p>
<h4 data-id="heading-6">1. 创建外部服务器</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 告诉 PostgreSQL 远程库在哪</span>
<span class="hljs-keyword">CREATE</span> SERVER users_server
<span class="hljs-keyword">FOREIGN</span> DATA WRAPPER postgres_fdw
OPTIONS (
    host <span class="hljs-string">'postgres-cluster.svc.cluster.local'</span>,
    dbname <span class="hljs-string">'innies_users_dev'</span>,
    port <span class="hljs-string">'5432'</span>
);
</code></pre>
<h4 data-id="heading-7">2. 创建用户映射</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 告诉 PostgreSQL 用什么凭证连远程库</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> MAPPING <span class="hljs-keyword">FOR</span> innies_dev
SERVER users_server
OPTIONS (<span class="hljs-keyword">user</span> <span class="hljs-string">'innies_dev'</span>, password <span class="hljs-string">'xxx'</span>);
</code></pre>
<p>这步容易踩坑。如果报 <code>user mapping not found</code>，说明当前用户没有对应的映射。</p>
<h4 data-id="heading-8">3. 导入外部表</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 把远程的 users 表映射过来，放到 fdw_users schema</span>
<span class="hljs-keyword">CREATE</span> SCHEMA IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> fdw_users;

IMPORT <span class="hljs-keyword">FOREIGN</span> SCHEMA public
LIMIT <span class="hljs-keyword">TO</span> (users)
<span class="hljs-keyword">FROM</span> SERVER users_server
<span class="hljs-keyword">INTO</span> fdw_users;
</code></pre>
<h4 data-id="heading-9">4. 创建视图</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 封装 JOIN 逻辑，方便使用</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> v_ratings_with_username <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    r.created_at <span class="hljs-keyword">AS</span> 评价时间,
    r.rating_type <span class="hljs-keyword">AS</span> 评价类型,
    u.username <span class="hljs-keyword">AS</span> 用户名,
    SUBSTR(m.content, <span class="hljs-number">1</span>, <span class="hljs-number">200</span>) <span class="hljs-keyword">AS</span> 消息内容,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> m.references <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
         <span class="hljs-keyword">AND</span> m.references::text <span class="hljs-operator">!=</span> <span class="hljs-string">'[]'</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-string">'是'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'否'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> 使用知识库
<span class="hljs-keyword">FROM</span> message_ratings r
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> task_messages m <span class="hljs-keyword">ON</span> r.message_id <span class="hljs-operator">=</span> m.id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> fdw_users.users u <span class="hljs-keyword">ON</span> r.user_id::uuid <span class="hljs-operator">=</span> u.id
<span class="hljs-keyword">WHERE</span> m.role <span class="hljs-operator">=</span> <span class="hljs-string">'assistant'</span>;
</code></pre>
<p>配置完成后，在 Superset 里直接查这个视图就行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> v_ratings_with_username LIMIT <span class="hljs-number">100</span>;
</code></pre>
<h3 data-id="heading-10">结果对比</h3>




















<table><thead><tr><th>方案</th><th>查询耗时</th><th>数据库耗时</th></tr></thead><tbody><tr><td>Superset Meta DB</td><td>21-24s</td><td>12ms</td></tr><tr><td>PostgreSQL FDW</td><td>0.5-0.8s</td><td>0.5s</td></tr></tbody></table>
<p><strong>40 倍的性能提升。</strong></p>
<h3 data-id="heading-11">踩过的坑</h3>
<h4 data-id="heading-12">1. 权限不够</h4>
<pre><code class="hljs language-lua" lang="lua">permission denied to <span class="hljs-built_in">create</span> extension <span class="hljs-string">"postgres_fdw"</span>
</code></pre>
<p>创建 FDW 扩展需要超级用户权限，得让 DBA 帮忙。</p>
<h4 data-id="heading-13">2. 用户映射找不到</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">user</span> mapping <span class="hljs-keyword">not</span> found <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> "innies_dev"
</code></pre>
<p>DBA 配好了 FDW，但只给 <code>postgres</code> 用户创建了映射，没给应用用户创建。补一个就好：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> MAPPING <span class="hljs-keyword">FOR</span> innies_dev
SERVER users_server
OPTIONS (<span class="hljs-keyword">user</span> <span class="hljs-string">'innies_dev'</span>, password <span class="hljs-string">'xxx'</span>);
</code></pre>
<h4 data-id="heading-14">3. 表找不到</h4>
<pre><code class="hljs language-arduino" lang="arduino">relation <span class="hljs-string">"users"</span> does <span class="hljs-keyword">not</span> exist
</code></pre>
<p>外部表被导入到了 <code>fdw_users</code> schema，不是 <code>public</code>。查的时候要用 <code>fdw_users.users</code>。</p>
<h3 data-id="heading-15">什么时候用哪个方案</h3>

























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>数据量小、偶尔查一次</td><td>Superset Meta DB 够用</td></tr><tr><td>需要秒级响应</td><td>PostgreSQL FDW</td></tr><tr><td>可以接受数据延迟</td><td>定时同步到一个库</td></tr><tr><td>大规模数据分析</td><td>搞个数据仓库（成本高）</td></tr></tbody></table>
<h3 data-id="heading-16">总结</h3>
<p>同样的 JOIN，在应用层做和在数据库层做，性能差距可以到 40 倍。</p>
<p>微服务架构的数据隔离是好事，但做跨服务报表的时候确实麻烦。FDW 是个不错的解决方案：</p>
<ul>
<li>配置一次，长期使用</li>
<li>实时数据，无需同步</li>
<li>对线上库影响很小</li>
<li>PostgreSQL 内置功能，不用额外装东西</li>
</ul>
<p>代价是需要 DBA 权限来配置，但这个一次性成本是值得的。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：弹窗封装]]></title>    <link>https://juejin.cn/post/7589201772118081542</link>    <guid>https://juejin.cn/post/7589201772118081542</guid>    <pubDate>2025-12-29T14:05:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772118081542" data-draft-id="7589159665856151571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：弹窗封装"/> <meta itemprop="keywords" content="HarmonyOS,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:05:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：弹窗封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:05:51.000Z" title="Mon Dec 29 2025 14:05:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本示例介绍如何封装弹窗，以及如何使用这种封装后的弹窗</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466dabaee01c49048c3baef9ed3a8893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767621950&amp;x-signature=bbc9l1ef9wj6ofCK21BRD6h5vvU%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>进入案例，点击右上角筛选按钮，顶部弹出筛选框，点击一种文件类型进行筛选</li>
<li>点击左上角添加按钮，中间弹出新增文件弹框，输入文件名以及选择文件类型，点击确定按钮添加完毕</li>
<li>长按列表项出现弹窗，点击删除按钮，中间弹出删除确认框，点击确认按钮删除完毕</li>
<li>长按列表项出现弹窗，底部弹出文件详情弹框</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<ol>
<li>
<p>定义弹窗的父布局builder,支持自定义弹窗内容传入，设置弹窗蒙层。</p>
<p>@Builder
export function DialogBuilder(param: EncapsulateDialogBuilderParam) {
Stack({ alignContent: getAlignment(param.dialogType) }) {
Stack()
.width('100%')
.height('300%')
.backgroundColor(0x33000000)
.onClick(() =&gt; {
if (param.isModalClosedByOverlayClick) {
param.closeDialog!();
}
})
param.builder.builder({ onConfirm: param.onConfirm, closeDialog: param.closeDialog, data: param.data })</p>
<p>}.width('100%')
.height('100%')
}</p>
</li>
<li>
<p>使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fjs-apis-arkui-uicontext-V13%23opencustomdialog12" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/js-apis-arkui-uicontext-V13#opencustomdialog12" ref="nofollow noopener noreferrer">openCustomDialog</a>接口，该接口可支持传入builder。</p>
<p>public static showCustomDialog(param: DialogParam): void {
if (!DialogUtil.uiContext) {
return;
}
let promptAction = DialogUtil.uiContext.getPromptAction();
let encapsulateParam: EncapsulateDialogBuilderParam = DialogUtil.transformDialogParamToEncapsulateDialogBuilderParam(param);
let compCont = new ComponentContent(DialogUtil.uiContext, wrapBuilder(DialogBuilder), encapsulateParam);
// 设置了弹窗id即可将其与弹窗关联起来，后续可凭据弹窗id关闭弹窗
if (param.dialogId) {
DialogUtil.compContMap.set(param.dialogId, compCont);
}
DialogUtil.fillCancelMethod(encapsulateParam, promptAction, compCont, param.dialogId);
DialogUtil.fillConfirmMethod(encapsulateParam, promptAction, compCont, param.dialogId);
compCont.update(encapsulateParam);
let options: promptAction.BaseDialogOptions = DialogUtil.dealSlideToClose(param);
promptAction.openCustomDialog(compCont, options);
}</p>
</li>
<li>
<p>自定义关闭弹窗回调。</p>
<p>private static fillCancelMethod(param: EncapsulateDialogBuilderParam, promptAction: PromptAction,
compCont: ComponentContent, dialogId: string | undefined) {
let customCancel = param.closeDialog;
let cancelDialog = () =&gt; {
if (customCancel) {
customCancel();
}
if (dialogId) {
DialogUtil.compContMap.delete(dialogId);
}
promptAction.closeCustomDialog(compCont);
// 关闭弹框之后释放对应的ComponentContent
compCont.dispose();
};
param.closeDialog = cancelDialog;
}</p>
</li>
<li>
<p>自定义弹窗确认回调。</p>
<p>private static fillConfirmMethod(param: EncapsulateDialogBuilderParam, promptAction: PromptAction,
compCont: ComponentContent, dialogId: string | undefined) {
let confirm = param.onConfirm;
let confirmDialog = (isCloseDialog?: boolean, data?: ESObject) =&gt; {
if (confirm) {
confirm(isCloseDialog, data);
}
if (isCloseDialog) {
if (dialogId) {
DialogUtil.compContMap.delete(dialogId);
}
promptAction.closeCustomDialog(compCont);
compCont.dispose();
}
};
param.onConfirm = confirmDialog;
}</p>
</li>
<li>
<p>自定义弹窗弹出动效。</p>
<p>/**</p>
<ul>
<li>顶部弹出动画</li>
<li>@param duration 动画时间</li>
<li>@returns
*/
static transitionFromUp(duration: number = 200): TransitionEffect {
return TransitionEffect.asymmetric(
TransitionEffect.OPACITY.animation({ duration: duration }).combine(
TransitionEffect.move(TransitionEdge.TOP).animation({ duration: duration })),
TransitionEffect.OPACITY.animation({ delay: duration, duration: duration }).combine(
TransitionEffect.move(TransitionEdge.TOP).animation({ duration: duration }))
)
}</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">使用步骤</h3>
<ol>
<li>
<p>初始化DialogUtil，需调用其init方法将UIContext传入。</p>
<p>aboutToAppear(): void {
DialogUtil.init(this.getUIContext());
...
}</p>
</li>
<li>
<p>定义弹窗builder，该builder必须有且只有DialogBuilderParam参数。</p>
<p>@Builder
export function addFileDialogBuilder(param: DialogBuilderParam) {
AddFileComponent({ param: param })
}</p>
</li>
<li>
<p>定义弹窗封装组件，该组件内部必须有DialogBuilderParam参数且使用@Prop注解。</p>
<p>@Component
export struct AddFileComponent {
@Prop param: DialogBuilderParam;
...
}</p>
</li>
<li>
<p>以上就封装好了自定义弹窗，接下来使用只需要调用一下showCustomDialog方法,将对应弹窗封装的builder传入。</p>
<p>showFileInfo(item: FileItem) {
// 打开筛选弹窗
DialogUtil.showCustomDialog({
builder: wrapBuilder(fileInfoDialogBuilder),
dialogType: DialogTypeEnum.BOTTOM,
dialogBuilderParam: {
data: item
}
})
}</p>
</li>
</ol>
<h4 data-id="heading-4">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-5">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b7e6a0503ed40b7909b9d58825b4ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767621950&amp;x-signature=wOj5kIfaCYYQjjlfmLGWq%2BtbrjM%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：相机预览花屏问题解决案例]]></title>    <link>https://juejin.cn/post/7589159665856167955</link>    <guid>https://juejin.cn/post/7589159665856167955</guid>    <pubDate>2025-12-29T14:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589159665856167955" data-draft-id="7589126217250816041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：相机预览花屏问题解决案例"/> <meta itemprop="keywords" content="前端,HarmonyOS,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：相机预览花屏问题解决案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:09:52.000Z" title="Mon Dec 29 2025 14:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">介绍</h3>
<p>本示例用于开发者在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fcamera-kit-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/camera-kit-V5" ref="nofollow noopener noreferrer">使用相机服务</a>时，如果仅用于预览流展示，通常使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fts-basic-components-xcomponent-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-basic-components-xcomponent-V5" ref="nofollow noopener noreferrer">XComponent</a>组件实现，如果需要获取每帧图像做二次处理（例如获取每帧图像完成二维码识别或人脸识别场景），可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fjs-apis-image-V5%23imagereceiver9" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-image-V5#imagereceiver9" ref="nofollow noopener noreferrer">ImageReceiver</a>中imageArrival事件监听预览流每帧数据，解析图像内容。在解析图像内容时，如果未考虑stride，直接通过使用width*height读取图像内容去解析图像，会导致相机预览异常，从而出现相机预览花屏的现象。当预览流图像stride与width不一致时，需要对stride进行无效像素的去除处理。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc827fc537ed4b59845fff6c5ccfa309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622192&amp;x-signature=Fi3n%2BLGiXAl5m2%2BFyYmi%2F2guC7c%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>本案例仅支持真机验证，因在案例集合中导致权限弹窗reason只支持一种string。</li>
<li>点击进入案例，授权给相机。</li>
<li>三个方案滑动页面不会出现花屏。</li>
<li>点击相机右上角方案说明，可出现相关方案的具体描述。</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<p>本例涉及的关键特性和实现方案如下：</p>
<h4 data-id="heading-3">方案一</h4>
<ol>
<li>
<p>应用通过image.ImageReceiver注册imageArrival图像回调方法，获取每帧图像数据实例image.Image，应用通过定义一个width为1920*height为1080分辨率的预览流直接创建pixelMap，此时获取到的stride的值为1920。</p>
<p>onImageArrival(receiver: image.ImageReceiver): void {
receiver.on('imageArrival', () =&gt; {
receiver.readNextImage((err: BusinessError, nextImage: image.Image) =&gt; {
if (err || nextImage === undefined) {
logger.error(TAG, <code>requestPermissionsFromUser call Failed! error: ${err.code}</code>);
return;
}
if (nextImage) {
nextImage.getComponent(image.ComponentType.JPEG, async (_err, component: image.Component) =&gt; {
let width = 1920; // width为应用创建预览流分辨率对应的宽
let height = 1080; // height为应用创建预览流分辨率对应的高
let stride = component.rowStride; // 通过component.rowStride获取stride
logger.info(TAG, <code>receiver getComponent width:${width} height:${height} stride:${stride}</code>);
// stride和width相等，按宽读取buffer不影响结果
if (stride === width) {
let pixelMap = await image.createPixelMap(component.byteBuffer, {
size: { height: height, width: width },
srcPixelFormat: image.PixelMapFormat.NV21,
})
AppStorage.setOrCreate('stridePixel', pixelMap);
} else {
...
}
nextImage.release();
})
}
});
})
}</p>
</li>
<li>
<p>在初始相机模块时，调用onImageArrival()，将未处理的width和height作为size，创建PixelMap，通过在Image中传入被@StorageLink修饰的变量stridePixel进行数据刷新，图片送显。</p>
<p>Column() {
Stack() {
if (this.isShowStridePixel) {
Image(this.stridePixel)
.rotate({
z: 0.5,
angle: this.previewRotate
})
.zIndex(0)
}
}
.width(px2vp(this.imageWidth))
.height(px2vp(this.imageHeight))
}
.onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, _currentRation: number) =&gt; {
// 切换组件时清除不可见的页面信息，重新进入组件时重新进入相机
if (isVisible) {
CameraServiceCrop.initCamera(this.cameraDeviceIndex);
} else {
CameraServiceCrop.releaseCamera();
}
})</p>
</li>
<li>
<p>当stride和width相等时，按宽读取buffer不影响结果。 当stride和width不等时，如果应用想使用byteBuffer预览流数据创建pixelMap直接显示，可以根据stride*height字节的大小先创建pixelMap，然后调用PixelMap的cropSync方法裁剪掉多余的像素，从而正确处理stride，解决预览流花屏问题。</p>
<p>onImageArrival(receiver: image.ImageReceiver): void {
receiver.on('imageArrival', () =&gt; {
receiver.readNextImage((err: BusinessError, nextImage: image.Image) =&gt; {
if (err || nextImage === undefined) {
logger.error(TAG, <code>requestPermissionsFromUser call Failed! error: ${err.code}</code>);
return;
}
if (nextImage) {
nextImage.getComponent(image.ComponentType.JPEG, async (_err, component: image.Component) =&gt; {
let width = 1920; // width为应用创建预览流分辨率对应的宽
let height = 1080; // height为应用创建预览流分辨率对应的高
let stride = component.rowStride; // 通过component.rowStride获取stride
logger.info(TAG, <code>receiver getComponent width:${width} height:${height} stride:${stride}</code>);
// stride和width相等，按宽读取buffer不影响结果
if (stride === width) {
...
} else {
let pixelMap = await image.createPixelMap(component.byteBuffer, {
// 1.创建PixelMap时width传stride。
size: { height: height, width: stride },
srcPixelFormat: 8,
})
// 2.然后调用PixelMap的cropSync方法裁剪掉多余的像素。
pixelMap.cropSync({
size: { width: width, height: height },
x: 0,
y: 0
}) // 根据输入的尺寸裁剪图片,从(0,0)开始，裁剪width*height字节的区域。
let pixelBefore: PixelMap | undefined = AppStorage.get('stridePixel');
await pixelBefore?.release();
AppStorage.setOrCreate('stridePixel', pixelMap);
}
nextImage.release();
})
}
});
})
}</p>
</li>
</ol>
<h4 data-id="heading-4">方案二</h4>
<ol>
<li>
<p>方案二的创建pixelMap、图片送显和方案一的1、2步骤一样，此处不再赘述。</p>
<p>当stride和width相等时，按宽读取buffer不影响结果。 当stride和width不等时，将相机返回的预览流数据即component.byteBuffer的数据去除stride，拷贝得到新的dstArr数据进行数据处理，将处理后的dstArr数组buffer，通过width和height直接创建pixelMap, 并存储到全局变量stridePixel中，传给Image送显，解决预览流花屏问题。</p>
<p>onImageArrival(receiver: image.ImageReceiver): void {
receiver.on('imageArrival', () =&gt; {
receiver.readNextImage((err: BusinessError, nextImage: image.Image) =&gt; {
if (err || nextImage === undefined) {
logger.error(TAG, <code>requestPermissionsFromUser call Failed! error: ${err.code}</code>);
return;
}
if (nextImage) {
nextImage.getComponent(image.ComponentType.JPEG,
async (err, component: image.Component) =&gt; {
let width = 1920; // width为应用创建预览流分辨率对应的宽
let height = 1080; // height为应用创建预览流分辨率对应的高
let stride = component.rowStride; // 通过component.rowStride获取stride
logger.info(TAG, <code>receiver getComponent width:${width} height:${height} stride:${stride}</code>);
// 当图片的width等于相机预览流返回的行跨距stride，此时无需处理stride，通过width和height直接创建pixelMap,并存储到全局变量stridePixel中，传给Image送显。
if (stride === width) {
...
} else {
// 当图片的width不等于相机预览流返回的行跨距stride，此时将相机返回的预览流数据component.byteBuffer去除掉stride，拷贝得到新的dstArr数据，数据处理后传给其他不支持stride的接口处理。
const dstBufferSize = width * height * 1.5; // 创建一个width * height * 1.5的dstBufferSize空间，此处为NV21数据格式。
const dstArr = new Uint8Array(dstBufferSize); // 存放去掉stride后的buffer。
// 读取每行数据，相机支持的profile宽高均为偶数，不涉及取整问题。
for (let j = 0; j &lt; height * 1.5; j++) { // 循环dstArr的每一行数据。
// 拷贝component.byteBuffer的每行数据前width个字节到dstArr中(去除无效像素，刚好每行得到一个width<em>height的八字节数组空间)。
const srcBuf = new Uint8Array(component.byteBuffer, j * stride,
width); // 将component.byteBuffer返回的buffer，每行遍历，从首位开始，每行截取出width字节。
dstArr.set(srcBuf, j * width); // 将width</em>height大小的数据存储到dstArr中。
}
let pixelMap = await image.createPixelMap(dstArr.buffer, {
// 将处理后的dstArr数组buffer，通过width和height直接创建pixelMap,并存储到全局变量stridePixel中，传给Image送显。
size: { height: height, width: width },
srcPixelFormat: image.PixelMapFormat.NV21,
})
AppStorage.setOrCreate('stridePixel', pixelMap);
}
nextImage.release();
})
}
});
})
}</p>
</li>
</ol>
<h4 data-id="heading-5">方案三</h4>
<ol>
<li>
<p>使用XComponent渲染预览对象输出的图像。</p>
<p>Stack() {
XComponent({
type: XComponentType.SURFACE,
controller: this.xComponentCtl
})
.onLoad(async () =&gt; {
logger.info('onLoad is called');
this.xComponentSurfaceId = this.xComponentCtl.getXComponentSurfaceId(); // 获取组件surfaceId
// 初始化相机，组件实时渲染每帧预览流数据
CameraService.initCamera(this.cameraDeviceIndex, this.xComponentSurfaceId);
})
.zIndex(0)</p>
<p>PublishView({ imageWidth: this.imageWidth, imageHeight: this.imageHeight })
.zIndex(1)</p>
<p>}
.onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, _currentRation: number) =&gt; {
if (isVisible) {
CameraService.initCamera(this.cameraDeviceIndex, this.xComponentSurfaceId);
} else {
CameraService.releaseCamera();
}
})</p>
</li>
<li>
<p>在初始相机模块时，使用getXComponentSurfaceId获取XComponent对应Surface的ID，调用createPreviewOutput创建预览输出对象，图片送显。</p>
<p>async initCamera(cameraDeviceIndex: number, xComponentSurfaceId: string): Promise {
logger.debug(TAG, <code>initCamera cameraDeviceIndex: ${cameraDeviceIndex}</code>);
try {
await this.releaseCamera();
// 获取相机管理器实例
this.cameraManager = this.getCameraManagerFn();
if (this.cameraManager === undefined) {
logger.error(TAG, 'cameraManager is undefined');
return;
}
this.cameras = this.getSupportedCamerasFn(this.cameraManager);
this.curCameraDevice = this.cameras[cameraDeviceIndex];
if (this.curCameraDevice === undefined) {
logger.error(TAG, 'Failed to create the camera input.');
return;
}
// 创建cameraInput输出对象
this.cameraInput = this.createCameraInputFn(this.cameraManager, this.curCameraDevice);
if (this.cameraInput === undefined) {
logger.error(TAG, 'Failed to create the camera input.');
return;
}
// 打开相机
let isOpenSuccess = await this.cameraInputOpenFn(this.cameraInput);
if (!isOpenSuccess) {
logger.error(TAG, 'Failed to open the camera.');
return;
}</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 选择具有不同的stride和width</span>
let previewProfile: camera.Profile = {
  format: camera.CameraFormat.CAMERA_FORMAT_YUV_420_SP,
  size: {
    width: Constants.X_COMPONENT_SURFACE_WIDTH,
    height: Constants.X_COMPONENT_SURFACE_HEIGHT
  }
};
let size: image.Size = {
  width: Constants.X_COMPONENT_SURFACE_WIDTH,
  height: Constants.X_COMPONENT_SURFACE_HEIGHT
}
<span class="hljs-keyword">this</span>.receiver = image.createImageReceiver(size, image.ImageFormat.JPEG, <span class="hljs-number">8</span>);
<span class="hljs-keyword">this</span>.previewOutput = <span class="hljs-keyword">this</span>.createPreviewOutputFn(<span class="hljs-keyword">this</span>.cameraManager, previewProfile, xComponentSurfaceId);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.previewOutput === undefined) {
  logger.error(TAG, <span class="hljs-string">'Failed to create the preview stream.'</span>);
  <span class="hljs-keyword">return</span>;
}
<span class="hljs-comment">// 会话流</span>
await <span class="hljs-keyword">this</span>.sessionFlowFn(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.cameraInput, <span class="hljs-keyword">this</span>.previewOutput);
</code></pre>
<p>} catch (error) {
logger.error(TAG, <code>initCamera fail: ${JSON.stringify(error)}</code>);
}
}</p>
</li>
</ol>
<h4 data-id="heading-6">注意</h4>
<p>本示例未设置成全屏状态，开发者可通过设置宽或高为100%，再根据当前设备的像素比设置aspectRatio(宽/高)，例如Mate60可设置为aspectRatio(9/16)。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Stack</span>() {
  if (this.isShowStridePixel) {
    <span class="hljs-built_in">Image</span>(this.stridePixel)
      <span class="hljs-selector-class">.rotate</span>({
        z: <span class="hljs-number">0.5</span>,
        angle: this.previewRotate
      })
      <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">0</span>)
  }
}
<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
<span class="hljs-selector-class">.aspectRatio</span>(<span class="hljs-number">9</span>/<span class="hljs-number">16</span>)
</code></pre>
<h4 data-id="heading-7">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-8">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7334235632406a98b7fd0f5c633ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622192&amp;x-signature=WRHXBvwkT98VRCa1h2npt2nOac4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：多重筛选]]></title>    <link>https://juejin.cn/post/7589159665856200723</link>    <guid>https://juejin.cn/post/7589159665856200723</guid>    <pubDate>2025-12-29T14:13:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589159665856200723" data-draft-id="7589126217250832425" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：多重筛选"/> <meta itemprop="keywords" content="HarmonyOS,Android,程序员"/> <meta itemprop="datePublished" content="2025-12-29T14:13:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：多重筛选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:13:51.000Z" title="Mon Dec 29 2025 14:13:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本示例主要介绍多重筛选场景，利用数组方法过滤满足条件的数据，利用LazyForEach实现列表信息的渲染以及刷新。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/753/188/655/0030086000753188655.20250208170657.45072066443077240724526669292193:50001231000000:2800:E671446133558720AB6FB68352808B527C99ACCA7BEC5851B8E80FE36378212B.gif" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>等待列表数据全部加载完成后，点击筛选类型，展开筛选数据。</li>
<li>选中想要筛选的数据，点击确认，列表刷新。</li>
<li>再次点开筛选类型，保留上次筛选的内容，点击重置筛选内容复原，列表数据恢复为未筛选前的数据。</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<p>本例涉及的关键特性和实现方案如下：</p>
<ol>
<li>
<p>使用Grid实现筛选条件布局。</p>
<p>Grid() {
ForEach(this.item.options, (options: string, idx: number) =&gt; {
GridItem() {
Text(options)
.textAlign(TextAlign.Center)
.fontSize(16)
.height(40)
.width('100%')
}
...
})
}
.columnsTemplate('1fr 1fr 1fr')
.rowsGap(16)
.columnsGap(16)
.margin({
left: 16,
right: 6,
top: 8,
bottom: 8
})
.layoutDirection(GridDirection.Row)
.constraintSize({
minHeight: '15%',
maxHeight: '15%'// grid会撑满maxHeight，先限定死高度
})</p>
</li>
<li>
<p>使用数组方法对筛选数据进行过滤，得到筛选数据。</p>
<p>GridItem() {
Text(options)
.textAlign(TextAlign.Center)
.fontSize(16)
.height(40)
.width('100%')
}
.onClick(() =&gt; {
if (this.item.selectItem.includes(idx)) {
let index = this.item.selectItem.indexOf(idx);
let listIdx = this.changData.indexOf(options);
// 删除已存在的筛选数据的index值
this.item.selectItem.splice(index, 1);
// 过滤出来没有重复数据的筛选值
this.changData = this.changData.filter(i =&gt; i !== options);
this.selectArr = this.item.selectItem;
// 删除已选择的数据的行数index数组
this.arrayListData.splice(listIdx, 1);
} else {
// 添加筛选数据的index值
this.item.selectItem.push(idx);
// 添加选中的数据
this.changData.push(options);
this.selectArr = this.item.selectItem;
// 添加选择的数据的行数index数组
this.arrayListData.push(this.listIndex);
}
})</p>
</li>
<li>
<p>得到筛选的数据后根据点击的筛选数据行数，使用has进行if判断看是否满足多重筛选的条件。</p>
<p>Button('确认')
.height(40)
.width(150)
.backgroundColor(Color.White)
.fontColor('#333')
.onClick(() =&gt; {
this.isShow = false;
let arrayListData = new Set(this.arrayListData)
if (arrayListData.has(0) &amp;&amp; !arrayListData.has(1)) {
// 仅选择停放时间
this.siteList.timeMultiFilter(this.changData);
} else if (!arrayListData.has(0) &amp;&amp; arrayListData.has(1)) {
// 仅选择套餐类型
this.siteList.typeMultiFilter(this.changData);
} else if (!arrayListData.has(0) &amp;&amp; !arrayListData.has(1) &amp;&amp; arrayListData.has(2)) {
// 仅选择充电
this.siteList.getInitalList();
} else if (this.changData.length === 0) {
// 未对数据进行选择
this.siteList.getInitalList();
} else {
// 多重筛选
this.siteList.multiFilter(this.changData);
}
if (this.siteList.totalCount() === 0) {
this.siteList.getInitalList();
promptAction.showToast({ message: "未找到相关数据" });
}
})</p>
</li>
<li>
<p>使用filter过滤出来符合条件的数据，筛选出来的数组构建一个新的Set，使用Set中的has判断列表中相关数据是否存在。</p>
<p>public multiFilter(changData: Array) {
let siteListString: string | undefined = AppStorage.get('siteList')
if (siteListString) {
let siteListObject: SiteListDataSource | undefined = JSON.parse(siteListString)
if (siteListObject === undefined) {
return
}
this.initialSiteList = siteListObject.dataList
this.dataList = []
this.dataList = this.initialSiteList
// 筛选数据
let changDataSet = new Set(changData)
let dataList: SiteItem[] = this.dataList.filter(item =&gt; {
item.siteBale = item.siteBale.filter(item =&gt; {
if ((item.time &amp;&amp; item.type) &amp;&amp; (changDataSet.has(item.time)) &amp;&amp; (changDataSet.has(item.type))) {
return item
}
return
})
return item.siteBale
})
dataList = dataList.filter(item =&gt; item.siteBale.length !== 0);
this.dataList = [];
this.dataList = dataList;
this.notifyDataReload();
}
}</p>
</li>
<li>
<p>使用深拷贝保留原数据。</p>
<p>/**</p>
<ul>
<li>返回原数组
*/
public getInitalList() {
let siteListString: string | undefined = AppStorage.get('siteList');
if (siteListString) {
let siteListObject: SiteListDataSource | undefined = JSON.parse(siteListString);
if (siteListObject === undefined) {
return;
}
this.initialSiteList = siteListObject.dataList;
this.dataList = [];
this.dataList = this.initialSiteList;
this.notifyDataReload();
}
}</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-4">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca96e9337cad4238838c1d0b17c43d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622430&amp;x-signature=ZFj%2Fgf574NJle2PNbBNMEy%2FBffI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：网络状态监听]]></title>    <link>https://juejin.cn/post/7589201772118114310</link>    <guid>https://juejin.cn/post/7589201772118114310</guid>    <pubDate>2025-12-29T14:16:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772118114310" data-draft-id="7589126217250865193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：网络状态监听"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:16:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：网络状态监听
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:16:51.000Z" title="Mon Dec 29 2025 14:16:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本示例介绍如何使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fjs-apis-net-connection-V13%3FcatalogVersion%3DV13" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/js-apis-net-connection-V13?catalogVersion=V13" ref="nofollow noopener noreferrer">@kit.NetworkKit</a>接口监听手机网络状态，根据不同的网络状态对视频进行播放、暂停处理等操作。</p>
<h3 data-id="heading-1">效果预览图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d4ed1a1faba4e1090963262cfa22bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622611&amp;x-signature=sNS9z4iq0Wj61mWq28UvHh2svt8%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>第一次打开应用进入案例页面，视频不播放。</li>
<li>点击自动播放设置按钮，进入设置页面，开启或者关闭3G/4G/5G自动播放、WI-FI自动播放。</li>
<li>开启或者关闭手机的蜂窝网络或者WI-FI开关，查看视频是否根据自动播放设置页面中的设置播放或者暂停。</li>
<li>返回首页瀑布流或者杀死应用重新进入案例，查看视频是否根据自动播放设置中的设置和手机网络状态播放或者暂停。</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<ol>
<li>
<p>页面实现</p>
<p>1.1 在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fharmonyos-cases%2Fcases%2Ftree%2Fmaster%2FCommonAppDevelopment%2Ffeature%2Fnetworkstatusobserver%2Fsrc%2Fmain%2Fets%2Fpages%2FVideoPage.ets" target="_blank" title="https://gitee.com/harmonyos-cases/cases/tree/master/CommonAppDevelopment/feature/networkstatusobserver/src/main/ets/pages/VideoPage.ets" ref="nofollow noopener noreferrer">VideoPage</a>中添加Video组件，设置在线视频播放</p>
<pre><code class="hljs language-kotlin" lang="kotlin">```
Video({
  src: <span class="hljs-string">"https://v.oh4k.com/muhou/2022/07/20220704-RIUq3Z.mp4"</span>,
   controller: <span class="hljs-keyword">this</span>.controller
}).height(<span class="hljs-number">300</span>)
  .width(<span class="hljs-string">'100%'</span>)
  .autoPlay(<span class="hljs-keyword">this</span>.autoPlay())
```
</code></pre>
<p>1.2 在aboutToAppear方法中添加网络状态监听，并开始监听WI-FI和蜂窝数据的状态。</p>
<pre><code class="hljs language-scss" lang="scss">```
emitter<span class="hljs-selector-class">.on</span>(NetUtils.getInstance()<span class="hljs-selector-class">.getEmitterEvent</span>(), (data: emitter.EventData) =&gt; {
  if (data) {
    this<span class="hljs-selector-class">.netObserver</span>(data);
  } else {
    logger<span class="hljs-selector-class">.info</span>("aboutToAppear emitter on error, data is undefined.");
  }
});
NetUtils<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.startNetObserve</span>(connection.NetBearType.BEARER_CELLULAR, connection.NetBearType.BEARER_WIFI);
```
</code></pre>
<p>1.3 在netObserver方法中，添加不同网络状态的处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">netObserver(<span class="hljs-keyword">data</span>: emitter.EventData) {
...
  let eventName: NetworkEventName = netEventData.eventName ?? -<span class="hljs-number">1</span>;
  switch (eventName) {
    case NetworkEventName.NetAvailable:
      <span class="hljs-keyword">if</span> (netEventData.netType === connection.NetBearType.BEARER_WIFI) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.wifiAutoPlay) {
          <span class="hljs-keyword">this</span>.startPlay();
        }
      }
      <span class="hljs-keyword">break</span>;
    case NetworkEventName.NetBlock:
      <span class="hljs-keyword">break</span>;
    case NetworkEventName.NetLost:
      <span class="hljs-keyword">if</span> (netEventData.netType === connection.NetBearType.BEARER_WIFI) {
        <span class="hljs-keyword">this</span>.wifiInterrupt();
      }
      <span class="hljs-keyword">break</span>;
    case NetworkEventName.NetUnavailable:
      <span class="hljs-keyword">if</span> (netEventData.netType === connection.NetBearType.BEARER_WIFI) {
        <span class="hljs-keyword">this</span>.wifiInterrupt();
      }
      <span class="hljs-keyword">break</span>;
    case NetworkEventName.WeakNet:
      <span class="hljs-comment">// 如果是弱网环境</span>
      <span class="hljs-keyword">if</span> (netEventData.status) {
        Prompt.showToast({ message: <span class="hljs-string">"当前网络环境较差，视频播放可能出现卡顿"</span> });
      }
      <span class="hljs-keyword">break</span>;
    default:
      logger.debug(<span class="hljs-string">"当前网络状态："</span> + eventName);
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<p>1.4 在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fharmonyos-cases%2Fcases%2Ftree%2Fmaster%2FCommonAppDevelopment%2Ffeature%2Fnetworkstatusobserver%2Fsrc%2Fmain%2Fets%2Fpages%2FSettingPage.ets" target="_blank" title="https://gitee.com/harmonyos-cases/cases/tree/master/CommonAppDevelopment/feature/networkstatusobserver/src/main/ets/pages/SettingPage.ets" ref="nofollow noopener noreferrer">SettingPage</a>中添加Toggle组件，管理自动播放设置。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">Toggle</span>({ <span class="hljs-attr">type</span>: ToggleType.Switch, <span class="hljs-attr">isOn</span>: this.cellularAutoPlay })
  .<span class="hljs-title function_ invoke__">selectedColor</span>(<span class="hljs-string">'#007DFF'</span>)
  .<span class="hljs-title function_ invoke__">switchPointColor</span>(<span class="hljs-string">'#FFFFFF'</span>)
  .<span class="hljs-title function_ invoke__">onChange</span>((<span class="hljs-attr">isOn</span>: <span class="hljs-keyword">boolean</span>) =&gt; {
    logger.<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'Component status:'</span> + isOn);
    AppStorage.<span class="hljs-title function_ invoke__">setOrCreate</span>(<span class="hljs-string">'cellular_auto_play'</span>, isOn);
    PersistentStorage.<span class="hljs-title function_ invoke__">persistProp</span>(<span class="hljs-string">'cellular_auto_play'</span>, isOn);
  })
  .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-string">'10%'</span>)
</code></pre>
</li>
<li>
<p>网络状态监听工具类<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fharmonyos-cases%2Fcases%2Ftree%2Fmaster%2FCommonAppDevelopment%2Ffeature%2Fnetworkstatusobserver%2Fsrc%2Fmain%2Fets%2Futils%2FNetUtils.ets" target="_blank" title="https://gitee.com/harmonyos-cases/cases/tree/master/CommonAppDevelopment/feature/networkstatusobserver/src/main/ets/utils/NetUtils.ets" ref="nofollow noopener noreferrer">NetUtils</a>实现，通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fjs-apis-net-connection-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-net-connection-V5" ref="nofollow noopener noreferrer">@kit.NetworkKit</a>接口监听网络状态，然后通过emitter将监听结果传递给页面。</p>
<p>2.1 开启网络监听</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title function_">startNetObserve</span>(<span class="hljs-params">...netType: connection.NetBearType[]</span>) {
  netType.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: connection.NetBearType</span>) =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">networkObserve</span>(<span class="hljs-keyword">type</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === connection.<span class="hljs-property">NetBearType</span>.<span class="hljs-property">BEARER_WIFI</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wifiStateObserve</span>();
    }
  })
}
</code></pre>
<p>2.2 关闭网络监听</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title function_">stopNetObserve</span>(<span class="hljs-params">netType: connection.NetBearType</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectionMap</span>.<span class="hljs-title function_">get</span>(netType).<span class="hljs-title function_">unregister</span>(<span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Success unregister："</span> + netType.<span class="hljs-title function_">toString</span>());
  })
}
</code></pre>
<p>2.3 网络状态监听</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">networkObserve</span>(<span class="hljs-params">netType: connection.NetBearType</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">netConnection</span>: connection.<span class="hljs-property">NetConnection</span> = connection.<span class="hljs-title function_">createNetConnection</span>({
    <span class="hljs-attr">netCapabilities</span>: {
      <span class="hljs-attr">bearerTypes</span>: [netType]
    }
  })
  netConnection.<span class="hljs-title function_">register</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (error) {
      logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network register failed: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));
      result = <span class="hljs-literal">false</span>;
    }
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network register succeed"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetObserverRegister</span>, result, netType);
  });

  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netCapabilitiesChange'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetCapabilityInfo</span>) =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network netCapabilitiesChange: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetCapabilitiesChange</span>, data, netType);
  })

  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">"netAvailable"</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetHandle</span>) =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network succeeded to get netAvailable: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-comment">// 检查默认数据网络是否被激活，使用同步方式返回接口，如果被激活则返回true，否则返回false。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetAvailable</span>, connection.<span class="hljs-title function_">hasDefaultNetSync</span>(), netType);
  });
 
  <span class="hljs-comment">// 订阅网络阻塞状态事件，当网络阻塞时，如网络性能下降、数据传输出现延迟等情况时，会触发该事件</span>
  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netBlockStatusChange'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetBlockStatusInfo</span>) =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network netBlockStatusChange "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetBlock</span>, data, netType)
  });
 
  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netConnectionPropertiesChange'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetConnectionPropertyInfo</span>) =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", network netConnectionPropertiesChange "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetConnectionPropertiesChange</span>, data, netType);
  });

  <span class="hljs-comment">// 订阅网络丢失事件，当网络严重中断或正常断开时触发该事件</span>
  <span class="hljs-comment">// 网络丢失是指网络严重中断或正常断开事件，当断开Wi-Fi时，是属于正常断开网络连接，会触发netLost事件</span>
  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netLost'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetHandle</span>) =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetLost</span>, <span class="hljs-literal">true</span>, netType)
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", Succeeded to get netLost: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
  });
 
  <span class="hljs-comment">// 订阅网络不可用事件，当网络不可用时触发该事件</span>
  <span class="hljs-comment">// 网络不可用是指网络不可用事件，当连接的网络不能使用时，会触发netUnavailable事件。</span>
  netConnection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netUnavailable'</span>, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NetUtils"</span>, <span class="hljs-string">"NetType :"</span> + netType + <span class="hljs-string">", Succeeded to get unavailable net event"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">postEvent</span>(<span class="hljs-title class_">NetworkEventName</span>.<span class="hljs-property">NetUnavailable</span>, <span class="hljs-literal">true</span>, netType);
  });
 
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectionMap</span>.<span class="hljs-title function_">set</span>(netType, netConnection);
}
</code></pre>
<p>2.4 通过emitter将网络监听状态传递给页面</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> postEvent(eventName: NetworkEventName, status: NetworkData, netType?: connection.NetBearType,
  priority?: emitter.EventPriority) {
  <span class="hljs-keyword">this</span>.emitterEvent.priority = priority;
  emitter.emit(<span class="hljs-keyword">this</span>.emitterEvent, {
    <span class="hljs-keyword">data</span>: new NetEventData(eventName, status, netType)
  })
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-3">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-4">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d54702fb8d074dc2a2b06575780f37d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622611&amp;x-signature=lc7tYLQmSCqI1P8SHK3DES7nsmE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：自定义地址选择组件]]></title>    <link>https://juejin.cn/post/7589082912588841003</link>    <guid>https://juejin.cn/post/7589082912588841003</guid>    <pubDate>2025-12-29T14:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589082912588841003" data-draft-id="7589099845186797604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：自定义地址选择组件"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：自定义地址选择组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:20:05.000Z" title="Mon Dec 29 2025 14:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本示例介绍如何使用bindSheet，changeIndex，onAreaChange实现带切换动效的自定义地址选择组件。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25281b5679ca4dfb8b95975c42c6c242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622805&amp;x-signature=XR327%2B7myHIYxuuYifGQ8IE8hJE%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>
<p>进入页面，点击场景一中“所在地区”一栏，可拉起省市区的地址选择弹窗。选择完区后，弹窗自动关闭，“所在地区”一栏显示当前选择的省市区名。</p>
</li>
<li>
<p>进入页面，点击场景二中的'获取地址信息'按钮，可以查看省市区名和相应的id。点击“所在地区”一栏，在拉起的地址选择弹窗里选择另一个省市区后，再次点击'获取地址信息'按钮，会显示最新选择的省市区的信息。</p>
</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<ol>
<li>
<p>使用getRawFileContentSync从rawfile目录下读取省市区json文件数据，使用util.TextDecoder进行解码。</p>
<p>getAddressData(): Array {
// 从rawfile本地json文件中获取数据
const value = getContext().resourceManager.getRawFileContentSync(this.jsonFileDir);
// 解码为utf-8格式
const textDecoder = util.TextDecoder.create('utf-8', { ignoreBOM: true });
const textDecoderResult = textDecoder.decodeToString(new Uint8Array(value.buffer));
const jsonObj: JsonObjType = JSON.parse(textDecoderResult) as JsonObjType;
const modelBuckets: Array = [];
// 映射json数据为model对象
const modelObj = jsonObj.addressList;
for (let i = 0; i &lt; modelObj.length; i++) {
const contactTemp = new Province(modelObj[i].code, modelObj[i].name, modelObj[i].children);
// 从json中读取每个省数据写入modelBuckets
modelBuckets.push(contactTemp);
}
return modelBuckets;
}</p>
</li>
<li>
<p>使用bindSheet绑定地址选择半模态弹窗页面。</p>
<p>Row() {
// ...
}
.width(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><msup><mo stretchy="false">(</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>a</mi><mi>p</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>o</mi><msub><mi>m</mi><mi>a</mi></msub><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><msub><mi>s</mi><mi>p</mi></msub><mi>i</mi><mi>c</mi><mi>k</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>l</mi><msub><mi>l</mi><mi>s</mi></msub><mi>i</mi><mi>z</mi><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>h</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">r('app.string.custom_address_picker_full_size'))
.height(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.038em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen"><span class="mopen">(</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">pp</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">dd</span><span class="mord mathnormal">res</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord">.</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mopen">(</span></span></span></span></span>r('app.float.custom_address_picker_size_forty_eight'))
.onClick(() =&gt; {
// 显示地址选择半模态弹窗页面
this.isShow = true;
this.currentIndex = AddressType.Province;
})
.bindSheet($$this.isShow, this.addressSelectPage(), {
height: $r('app.string.custom_address_picker_percent_seventy'), // 半模态弹窗高度
showClose: false, // 设置不显示自带的关闭图标
dragBar: false,
onDisappear: () =&gt; {
// 退出地址选择半模态弹窗页面时，重置相关参数
this.animationDuration = 0;
// 如果当前省市区没选全，则清空当前选择的地址信息
if (this.currentSelectInfo.region === '') {
this.currentSelectInfo.provinceId = '';
this.currentSelectInfo.cityId = '';
this.currentSelectInfo.regionId = '';
this.currentSelectInfo.province = '';
this.currentSelectInfo.city = '';
this.currentSelectInfo.region = '';
this.cityList = [];
this.regionList = [];
}
}
})</p>
</li>
<li>
<p>使用changeIndex控制省市区列表TabContent切换。使用组件区域变化回调onAreaChange获取选择的省市区Text组件宽度，存入textInfos数组，用于后续计算选择省市区名后下方下滑线动画水平偏移量leftMargin。</p>
<p>Text(<code>${params.name === '' ? '请选择' : params.name} </code>)
.height(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><msup><mo stretchy="false">(</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>a</mi><mi>p</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>o</mi><msub><mi>m</mi><mi>a</mi></msub><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><msub><mi>s</mi><mi>p</mi></msub><mi>i</mi><mi>c</mi><mi>k</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>l</mi><msub><mi>l</mi><mi>s</mi></msub><mi>i</mi><mi>z</mi><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>f</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>S</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">r('app.string.custom_address_picker_full_size'))
  .fontSize(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.038em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen"><span class="mopen">(</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">pp</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">dd</span><span class="mord mathnormal">res</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">tS</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mopen">(</span></span></span></span></span>r('app.float.custom_address_picker_size_sixteen'))
.fontWeight(this.currentIndex === params.index ? Constants.FONT_WEIGHT_FIVE_HUNDRED :
Constants.FONT_WEIGHT_FOUR_HUNDRED)
.fontColor(this.currentIndex === params.index ? <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><msup><mo stretchy="false">(</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>a</mi><mi>p</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>r</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>o</mi><msub><mi>m</mi><mi>a</mi></msub><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><msub><mi>s</mi><mi>p</mi></msub><mi>i</mi><mi>c</mi><mi>k</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>o</mi><mi>n</mi><msub><mi>t</mi><mi>c</mi></msub><mi>o</mi><mi>l</mi><mi>o</mi><msub><mi>r</mi><mi>b</mi></msub><mi>l</mi><mi>a</mi><mi>c</mi><msup><mi>k</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">r('app.color.custom_address_picker_font_color_black') :
  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.038em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen"><span class="mopen">(</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">pp</span><span class="mord">.</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">dd</span><span class="mord mathnormal">res</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span></span></span></span></span>r('app.color.custom_address_picker_font_color_gray'))
.constraintSize({ maxWidth: 'calc(33%)' })
.textOverflow({ overflow: TextOverflow.Ellipsis })
.maxLines(Constants.SIZE_ONE)
.onClick(() =&gt; {
// 使用changeIndex控制省市区列表TabContent切换
this.controller.changeIndex(params.index);
})
.id(params.index.toString())
.onAreaChange((oldValue: Area, newValue: Area) =&gt; {
// 使用组件区域变化回调onAreaChange获取选择的省市区Text组件宽度，存入textInfos数组，用于后续计算选择省市区名后下方下滑线动画水平偏移量leftMargin
// 组件区域变化时获取当前Text的宽度newValue.width和x轴相对位置newValue.position.x
this.textInfos[params.index] = [newValue.position.x as number, newValue.width as number];
if (this.currentIndex === params.index &amp;&amp; params.index === AddressType.Province) {
// 计算选择的省市区名下方的下滑线偏移量
this.leftMargin = (this.textInfos[this.currentIndex][1] - Constants.DIVIDER_WIDTH) / 2;
}
})</p>
</li>
<li>
<p>在选择完区名后，使用JSON.parse(JSON.stringify(xxx))深拷贝选择的省市区数据，用于后续操作中需要加载上一次选择的完整省市区数据。</p>
<p>List() {
ForEach(this.regionList, (item: CommonAddressList) =&gt; {
ListItem() {
this.areaNameItem(AddressType.Region, item)
}.onClick(() =&gt; {
// 记录选择的区信息
this.currentSelectInfo.regionId = item.code;
this.currentSelectInfo.region = item.name;
this.provinceCityRegion =
this.currentSelectInfo.province + this.currentSelectInfo.city + this.currentSelectInfo.region;
// 选择区后，退出地址选择半模态弹窗页面
this.isShow = false;
// 将当前选中省市区信息保存到lastSelectInfo
this.lastSelectInfo.provinceId = this.currentSelectInfo.provinceId;
this.lastSelectInfo.province = this.currentSelectInfo.province;
this.lastSelectInfo.cityId = this.currentSelectInfo.cityId;
this.lastSelectInfo.city = this.currentSelectInfo.city;
this.lastSelectInfo.regionId = this.currentSelectInfo.regionId;
this.lastSelectInfo.region = this.currentSelectInfo.region;
// TODO 知识点：在选择完区名后，使用JSON.parse(JSON.stringify(xxx))深拷贝选择的省市区数据，用于后续操作中需要加载上一次选择的完整省市区数据
// 深拷贝保存到相应的变量中
this.lastCityList = JSON.parse(JSON.stringify(this.cityList));
this.lastRegionList = JSON.parse(JSON.stringify(this.regionList));
this.address = JSON.parse(JSON.stringify(this.lastSelectInfo));
})
}, (item: CommonAddressList) =&gt; JSON.stringify(item))
}</p>
</li>
</ol>
<h2 data-id="heading-3">总结</h2>
<p>本示例中如果当前点击选择的省或者市与之前选择一样，则跳过省、市数据获取，直接调用changeIndex(AddressType.City)切换到下一级地区列表，减少冗余查询以提升性能。</p>
<h4 data-id="heading-4">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-5">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6aab8df1eb046b69f3ba6cb0cd870f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767622805&amp;x-signature=X57sWKkODkQ8AEru5hu5Jpclmqs%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：Webview拉起自定义键盘]]></title>    <link>https://juejin.cn/post/7589126217250914345</link>    <guid>https://juejin.cn/post/7589126217250914345</guid>    <pubDate>2025-12-29T14:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126217250914345" data-draft-id="7589126217250897961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：Webview拉起自定义键盘"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：Webview拉起自定义键盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:26:57.000Z" title="Mon Dec 29 2025 14:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">场景描述</h3>
<p>在特殊的H5场景下需要应用拉起自定义键盘进行输入。</p>
<p>场景一：使用jsBridge拉起自定义弹窗写自定义键盘，再通过jsBridge传参实现输入。</p>
<p>场景二：使用web的同层渲染将原生textInput组件渲染到页面上。</p>
<h3 data-id="heading-1">方案描述</h3>
<p>通过注册一个js代理对象被web的registerJavaScriptProxy方法调用拉起CustomDialog，在CustomDialog上放置一个customkeyboard </p>
<p>场景一：通过jsBridge拉起自定义弹窗，在自定义弹窗上放置自定义键盘，例如需要输入密码时的安全键盘。 </p>
<h4 data-id="heading-2">效果图</h4>
<p><img alt="" src="" loading="lazy"/></p>
<h3 data-id="heading-3">方案 </h3>
<p>通过注册一个js代理对象被web的registJavaScriptProxy方法调用拉起CustomDialog，在CustomDialog上放置一个自定义键盘组件，通过在H5上input标签的readonly属性和注册的js方法changeNumbers实现在原生端输入数字传到H5上，他们之间通过@Link装饰器绑定的变量进行传值，所以点击删除输入的内容也是可以在H5上实现的。 </p>
<h4 data-id="heading-4">核心代码</h4>
<p>通过javaScriptProxy方法拉起自定义弹窗，在H5上的input标签绑定一个onclick事件，当点击输入框后会调用从原生注册过来的js代理方法openWindow。</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;input <span class="hljs-keyword">type</span>=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"number_info"</span> <span class="hljs-keyword">readonly</span> onclick=<span class="hljs-string">"openWindow()"</span> value=<span class="hljs-string">""</span> style=<span class="hljs-string">"width: 500px;height: 100px;font-size:50px;border:1px solid # f00;"</span>&gt;
 
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
 
<span class="hljs-keyword">function</span> <span class="hljs-title function_">openWindow</span>(<span class="hljs-params"/>) {
 
<span class="hljs-keyword">let</span> value = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">"number_info"</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;
 
<span class="hljs-variable language_">window</span>.<span class="hljs-property">myJsb</span>.<span class="hljs-title function_">openDialog</span>(value)
 
}
 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>当H5上openWindow方法被调用后会通过jsBridge调用以下两个js代理方法打开自定义弹窗。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">jsbObject: JsbObject = {
 
openDialog: (value: string) =&gt; {
 
<span class="hljs-keyword">this</span>.showDialog(<span class="hljs-keyword">this</span>, value);
 
}
 
}
 
showDialog(context: <span class="hljs-keyword">object</span>, value: string) {
 
<span class="hljs-comment">// 把自定义弹窗调出来</span>
 
<span class="hljs-keyword">this</span>.currentData = value;
 
<span class="hljs-keyword">this</span>.dialogController.<span class="hljs-keyword">open</span>()
 
}
 
 
 
Web({ src: <span class="hljs-string">"resource://rawfile/web_test.html"</span>, controller: <span class="hljs-keyword">this</span>.webviewController })
 
.javaScriptAccess(<span class="hljs-literal">true</span>)
 
.javaScriptProxy({
 
name: <span class="hljs-string">"myJsb"</span>,
 
<span class="hljs-keyword">object</span>: <span class="hljs-keyword">this</span>.jsbObject,
 
methodList: [<span class="hljs-string">"openDialog"</span>],
 
controller: <span class="hljs-keyword">this</span>.webviewController
 
}
</code></pre>
<p>将自定义键盘放置在自定义弹窗上。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@CustomDialog</span>
 
struct CustomDialogExample {
 
<span class="hljs-keyword">@Link</span> <span class="hljs-attribute">currentData</span>: string
 
<span class="hljs-attribute">dialogControllerTwo</span>: CustomDialogController | null = new CustomDialogController({
 
builder: <span class="hljs-built_in">CustomDialogExample</span>({ currentData: <span class="hljs-variable">$currentData</span> }),
 
alignment: DialogAlignment.Bottom,
 
offset: { dx: <span class="hljs-number">0</span>, dy: -<span class="hljs-number">25</span> }
 
})
 
controller?: CustomDialogController
 
 
 
<span class="hljs-built_in">build</span>() {
 
<span class="hljs-built_in">Column</span>() {
 
<span class="hljs-selector-tag">Button</span>('x')<span class="hljs-selector-class">.onClick</span>(() =&gt; {
 
<span class="hljs-comment">// 关闭自定义键盘</span>
 
if (this.controller != undefined) {
 
this<span class="hljs-selector-class">.controller</span><span class="hljs-selector-class">.close</span>()
 
}
 
})
 
<span class="hljs-attribute">Grid</span>() {
 
<span class="hljs-built_in">ForEach</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, '*', <span class="hljs-number">0</span>, '删除'], (item: number | string) =&gt; {
 
<span class="hljs-built_in">GridItem</span>() {
 
<span class="hljs-selector-tag">Button</span>(item + "")
 
<span class="hljs-selector-class">.width</span>(<span class="hljs-number">110</span>)<span class="hljs-selector-class">.onClick</span>(() =&gt; {
 
if (item == '删除') {
 
if (this.currentData.length &gt; <span class="hljs-number">0</span>) {
 
this<span class="hljs-selector-class">.currentData</span> = this<span class="hljs-selector-class">.currentData</span><span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, this.currentData.length - <span class="hljs-number">1</span>);
 
}
 
} else {
 
this<span class="hljs-selector-class">.currentData</span> += item
 
}
 
})
 
}
 
})
 
}<span class="hljs-selector-class">.maxCount</span>(<span class="hljs-number">3</span>)<span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.padding</span>(<span class="hljs-number">5</span>)
 
}<span class="hljs-selector-class">.backgroundColor</span>(Color.Gray)
 
}
 
}
</code></pre>
<p>在自定义键盘上输入内容的时候会调用onChangeInputValue方法，通过里面的runJavaScript调用H5上的js方法changeNumber传值到H5的输入框中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">onChangeInputValue</span>(<span class="hljs-params">stateName: <span class="hljs-built_in">string</span></span>){
 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'this.currentData:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentData</span>)
 
<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">'changeNumber("'</span>+ <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentData</span> +<span class="hljs-string">'")'</span>)
 
.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'result: '</span> + result);
 
})
 
}
 
 
&lt;&lt;input <span class="hljs-keyword">type</span>=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"number_info"</span> <span class="hljs-keyword">readonly</span> onclick=<span class="hljs-string">"openWindow()"</span> value=<span class="hljs-string">""</span> style=<span class="hljs-string">"width: 500px;height: 100px;font-size:50px;border:1px solid # f00;"</span> /&gt;
 
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
 
<span class="hljs-keyword">function</span> <span class="hljs-title function_">changeNumber</span>(<span class="hljs-params">value</span>){
 
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">"number_info"</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = value;
 
}
 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>**场景二：**<strong>通过同层渲染渲染一个原生的自定义键盘</strong></p>
<p><strong>效果图</strong></p>
<p><img alt="" src="" loading="lazy"/></p>
<h3 data-id="heading-5">方案</h3>
<p>整体实现效果为：通过web的同层渲染功能实现将原生TextInput组件渲染到H5需要使用自定义键盘的页面中，这样就可以实现在H5拉起自定义键盘，并且使用它的全部功能。</p>
<h4 data-id="heading-6">核心代码</h4>
<ol>
<li>
<p>创建一个自定义键盘并绑定到原生textInput组件上。</p>
<p>@Component</p>
<p>struct ButtonComponent {</p>
<p>controller1: TextInputController = new TextInputController()</p>
<p>@State inputValue: string = ""</p>
<p>// 自定义键盘组件</p>
<p>@Builder</p>
<p>CustomKeyboardBuilder() {</p>
<p>Column() {</p>
<p>Button('x').onClick(() =&gt; {</p>
<p>// 关闭自定义键盘</p>
<p>this.controller1.stopEditing()</p>
<p>})</p>
<p>Grid() {</p>
<p>ForEach([1, 2, 3, 4, 5, 6, 7, 8, 9, '*', 0, '# '], (item: number | string) =&gt; {</p>
<p>GridItem() {</p>
<p>Button(item + "")</p>
<p>.width(110).onClick(() =&gt; {</p>
<p>this.inputValue += item</p>
<p>})</p>
<p>}</p>
<p>})</p>
<p>}.maxCount(3).columnsGap(10).rowsGap(10).padding(5)</p>
<p>}.backgroundColor(Color.Pink)</p>
<p>}</p>
<p>@ObjectLink params: Params</p>
<p>@State bkColor: Color = Color.Red</p>
<p>@State outSetValueTwo: number = 40</p>
<p>@State outSetValueOne: number = 40</p>
<p>@State tipsValue: number = 40</p>
<p>controller: web_webview.WebviewController = new web_webview.WebviewController();</p>
<p>build() {</p>
<p>Column() {</p>
<p>TextInput({ controller: this.controller1, text: this.inputValue })// 绑定自定义键盘</p>
<p>.customKeyboard(this.CustomKeyboardBuilder()).margin(10).border({ width: 1 })</p>
<p>}</p>
<p>.width(this.params.width)</p>
<p>.height(this.params.height)</p>
<p>}</p>
<p>}</p>
</li>
</ol>
<p>将原生textInput组件通过web同层渲染功能渲染到H5上的embed标签上。</p>
<h4 data-id="heading-7">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-8">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e2762caa324b73be4a3ed3d9c74740~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623216&amp;x-signature=CxNXEKzzJBXBLoyncdzcJCVwFgI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：桌面卡片实现]]></title>    <link>https://juejin.cn/post/7589126217250930729</link>    <guid>https://juejin.cn/post/7589126217250930729</guid>    <pubDate>2025-12-29T14:29:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126217250930729" data-draft-id="7589082912588873771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：桌面卡片实现"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:29:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：桌面卡片实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:29:36.000Z" title="Mon Dec 29 2025 14:29:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>桌面卡片是比较常见的功能，本案例详细列举了卡片开发的大部分功能，如使用postCardAction接口快速拉起卡片提供方应用的指定UIAbility，通过message事件刷新卡片内容等，为开发者提供了卡片功能的展示。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3197ee4a1e484043be642cf73fc7ff83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623376&amp;x-signature=T%2F1OT3voKJCBzIlE22EsE23iED4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">使用说明</h3>
<ol>
<li>长按应用，添加卡片到桌面。</li>
<li>卡片内可滑动选择案例，点击可进入案例详情。</li>
<li>部分案例无详情页时，点击跳转到首页瀑布流。</li>
</ol>
<h3 data-id="heading-3">实现思路</h3>
<ol>
<li>新建卡片</li>
<li>配置formconfig</li>
<li>编写卡片UI代码</li>
<li>触发刷新事件</li>
<li>触发点击事件</li>
</ol>
<h3 data-id="heading-4">实现步骤</h3>
<p>本例涉及的关键特性和实现方案如下：</p>
<ol>
<li>
<p>新建卡片。右键点击entry目录，选择新建-&gt;Service Widget-&gt;Dynamic Widget，其中Dynamic Widget为动态卡片，Static Widget为静态卡片。此时会生成几个文件：配置文件<code>form_config.json</code>；卡片Ability<code>EntryFormAbility.ets</code>；卡片组件<code>WidgetCard.ets</code>。</p>
</li>
<li>
<p>新建卡片后，根据需要（如卡片大小，刷新时间，动态静态卡片设置）配置<code>form_config.json</code>。</p>
<p>{
"forms": [
{
"name": "widget", // 卡片的名称。
"displayName": "<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo>:</mo><mi>w</mi><mi>i</mi><mi>d</mi><mi>g</mi><mi>e</mi><msub><mi>t</mi><mi>d</mi></msub><mi>i</mi><mi>s</mi><mi>p</mi><mi>l</mi><mi>a</mi><msub><mi>y</mi><mi>n</mi></msub><mi>a</mi><mi>m</mi><mi>e</mi><mi mathvariant="normal">"</mi><mo separator="true">,</mo><mi mathvariant="normal">/</mi><mi mathvariant="normal">/</mi><mtext>卡片的显示名称。</mtext><mi mathvariant="normal">"</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">"</mi><mo>:</mo><mi mathvariant="normal">"</mi></mrow><annotation encoding="application/x-tex">string:widget_display_name", // 卡片的显示名称。
      "description": "</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">am</span><span class="mord mathnormal">e</span><span class="mord">"</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">//</span><span class="mord cjk_fallback">卡片的显示名称。</span><span class="mord">"</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">escr</span><span class="mord mathnormal">i</span><span class="mord mathnormal">pt</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">"</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">"</span></span></span></span></span>string:widget_desc", // 卡片的描述。
"src": "./ets/widget/pages/WidgetCard.ets", // 卡片对应的UI代码的完整路径。
"uiSyntax": "arkts", // 卡片的类型
"window": { // 用于定义与显示窗口相关的配置。
"designWidth": 720,
"autoDesignWidth": true
},
"colorMode": "auto", // 卡片的主题样式。
"isDynamic": true, // 卡片是否为动态卡片。
"isDefault": true, // 卡片是否为默认卡片。
"updateEnabled": true, // 卡片是否支持周期性刷新。
"scheduledUpdateTime": "10:30", // 卡片的定点刷新的时刻。
"updateDuration": 1, // 卡片定时刷新的更新周期，单位为30分钟，取值为自然数。
"defaultDimension": "6<em>4", // 卡片的默认外观规格。
"supportDimensions": [ // 卡片支持的外观规格，取值范围。
"6</em>4"
]
}
]
}</p>
</li>
<li>
<p>编写卡片UI代码。在主文件<code>WidgetCard.ets</code>中添加UI组件，需要注意的是：ArkTS卡片存在较多约束（如不支持导入共享包），较多逻辑不可在卡片中使用，在使用时需要根据文档进行操作。</p>
</li>
<li>
<p>编写跳转事件：当应用未被拉起时，点击某个卡片时跳转到具体的案例页面。在<code>EntryAbility.ets</code>中补充逻辑：onCreate生命周期内获取want.parameters.params判断卡片内容的跳转。</p>
<p>// EntryAbility.ets
export default class EntryAbility extends UIAbility {
onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
// ...
// 桌面卡片判断跳转内容
if (want?.parameters?.params) {
// want.parameters.params 对应 postCardAction() 中 params 内容
let params: Record&lt;string, Object&gt; = JSON.parse(want.parameters.params as string);
this.selectPage = params.targetPage as string;
}
// ...
}
}</p>
</li>
<li>
<p>编写跳转事件：当应用在后台时，点击某个卡片时跳转到具体的案例页面。可从onNewWant生命周期获取want.parameters.params判断卡片内容的跳转。</p>
<p>// EntryAbility.ets
export default class EntryAbility extends UIAbility {
// 如果UIAbility已在后台运行，在收到Router事件后会触发onNewWant生命周期回调
onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
if (want?.parameters?.params) {
// want.parameters.params 对应 postCardAction() 中 params 内容
let params: Record&lt;string, Object&gt; = JSON.parse(want.parameters.params as string);
this.selectPage = params.targetPage as string;
}
if (this.currentWindowStage !== null) {
//  存在窗口时点击卡片后进行页面跳转
this.onWindowStageCreate(this.currentWindowStage);
}
}
}</p>
</li>
<li>
<p>具体跳转逻辑编写。在onWindowStageCreate生命周期内进行具体的跳转逻辑。</p>
<p>// EntryAbility.ets
export default class EntryAbility extends UIAbility {
onWindowStageCreate(windowStage: window.WindowStage): void {
// 判断是否存在窗口可进行页面跳转
if (this.currentWindowStage === null) {
this.currentWindowStage = windowStage;
}
//  点击卡片后进行页面跳转
if (this.selectPage) {
this.storage.setOrCreate('formNavigationRouter', this.selectPage);
windowStage.loadContent('pages/EntryView', this.storage, (err, data) =&gt; {
if (err.code) {
logger.error(DOMAIN_NUMBER.toString(), TAG, 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '');
return;
}
logger.info(DOMAIN_NUMBER.toString(), TAG, 'Succeeded in loading the content. Data: %{public}s', JSON.stringify(data) ?? '');
});
}
// ...
}
}</p>
</li>
<li>
<p>编写跳转事件：在<code>EntryAbility.ets</code>编写事件后，同时在接收案例参数的<code>EntryView.ets</code>内处理页面跳转逻辑。通过和DynamicsRouter内的数据对比，判断通过storage传入的页面是哪一个，然后执行pushUri跳转。</p>
<p>@Entry(storage)
@Component
struct EntryView {
onPageShow(): void {
// 从卡片进入页面时判断具体跳转页面
if (this.formRouter) {
waterFlowData.forEach((item: SceneModuleInfo) =&gt; {
let index = item.appUri.indexOf(this.formRouter);
if (index &gt; -1) {
if (DynamicsRouter.appRouterStack.slice(-1)[0].name !== item.appUri) {
DynamicsRouter.clear();
DynamicsRouter.pushUri(item.appUri);
}
return;
}
})
this.formRouter = '';
}
}
}</p>
</li>
<li>
<p>判断卡片大小：获取卡片详情，根据宽高比获取卡片的规格，不同规格显示内容不同。在<code>EntryFormAbility.ets</code>中补充点击卡片进入时查找对应案例的逻辑。在onAddForm生命周期内做卡片生成时，createFormBindingData方法传递属性。</p>
<p>// EntryFormAbility.ets
export default class EntryFormAbility extends FormExtensionAbility {
// 卡片对象集合
onAddForm(want: Want): formBindingData.FormBindingData {
let isLongCard: boolean = true;
if ((want.parameters?.[formInfo.FormParam.WIDTH_KEY] as number) /
(want.parameters?.[formInfo.FormParam.HEIGHT_KEY] as number) &gt; 0.666) {
isLongCard = false;
}
// 使用方创建卡片时触发，提供方需要返回卡片数据绑定类
let obj: Record&lt;string, string | boolean&gt; = {
'title': 'titleOnAddForm',
'isLongCard': isLongCard
};
let formData: formBindingData.FormBindingData = formBindingData.createFormBindingData(obj);
return formData;
}
}</p>
</li>
<li>
<p>编写刷新事件：当定时更新或定点更新触发时，需要更新卡片内容。onUpdateForm生命周期发生在定时更新/定点更新/卡片使用方主动请求更新时，在方法内增加获取案例数据的功能。</p>
<p>// EntryFormAbility.ets
export default class EntryFormAbility extends FormExtensionAbility {
// 网络获取README数据并利用formProvider.updateForm更新到卡片
async getData(formId: string) {
let detail: CASES[] = [];
let httpRequest = http.createHttp();
let webData: http.HttpResponse = await httpRequest.request(URL);
if (webData?.responseCode == http.ResponseCode.OK) {
try {
detail = this.formatData(webData.result.toString());
hilog.info(DOMAIN_NUMBER, TAG, '[EntryFormAbility] onFormEvent' + 'webData.result:' + webData.result);</p>
<pre><code class="hljs language-typescript" lang="typescript">        <span class="hljs-keyword">class</span> <span class="hljs-title class_">FormDataClass</span> {
           <span class="hljs-attr">detail</span>: <span class="hljs-variable constant_">CASES</span>[] = detail;
        }

        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormDataClass</span>();
        <span class="hljs-keyword">let</span> formInfo = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);
        <span class="hljs-keyword">await</span> formProvider.<span class="hljs-title function_">updateForm</span>(formId, formInfo);
        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'FormAbility updateForm success.'</span>);
     } <span class="hljs-keyword">catch</span> (error) {
        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FormAbility updateForm failed: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
     }
  } <span class="hljs-keyword">else</span> {
     hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ArkTSCard download task failed`</span>);
     <span class="hljs-keyword">let</span> <span class="hljs-attr">param</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
        <span class="hljs-string">'text'</span>: <span class="hljs-string">'刷新失败'</span>
     };
     <span class="hljs-keyword">let</span> <span class="hljs-attr">formInfo</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(param);
     formProvider.<span class="hljs-title function_">updateForm</span>(formId, formInfo);
  }
  httpRequest.<span class="hljs-title function_">destroy</span>();
</code></pre>
<p>}</p>
<p>async onUpdateForm(formId: string): Promise {
// 若卡片支持定时更新/定点更新/卡片使用方主动请求更新功能，则提供方需要重写该方法以支持数据更新
hilog.info(DOMAIN_NUMBER, TAG, '[EntryFormAbility] onUpdateForm');
this.getData(formId);
}
}</p>
</li>
<li>
<p>编写刷新事件：手动刷新内容时，需要更新卡片内容。onFormEvent生命周期发生在卡片主动通过postCardAction接口触发message事件。</p>
<p>// EntryFormAbility.ets
export default class EntryFormAbility extends FormExtensionAbility {
// 网络获取README数据并利用formProvider.updateForm更新到卡片
async getData(formId: string) {
let detail: CASES[] = [];
let httpRequest = http.createHttp();
let webData: http.HttpResponse = await httpRequest.request(URL);
if (webData?.responseCode == http.ResponseCode.OK) {
try {
detail = this.formatData(webData.result.toString());
hilog.info(DOMAIN_NUMBER, TAG, '[EntryFormAbility] onFormEvent' + 'webData.result:' + webData.result);</p>
<pre><code class="hljs language-typescript" lang="typescript">        <span class="hljs-keyword">class</span> <span class="hljs-title class_">FormDataClass</span> {
           <span class="hljs-attr">detail</span>: <span class="hljs-variable constant_">CASES</span>[] = detail;
        }

        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormDataClass</span>();
        <span class="hljs-keyword">let</span> formInfo = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);
        <span class="hljs-keyword">await</span> formProvider.<span class="hljs-title function_">updateForm</span>(formId, formInfo);
        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'FormAbility updateForm success.'</span>);
     } <span class="hljs-keyword">catch</span> (error) {
        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FormAbility updateForm failed: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
     }
  } <span class="hljs-keyword">else</span> {
     hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ArkTSCard download task failed`</span>);
     <span class="hljs-keyword">let</span> <span class="hljs-attr">param</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
        <span class="hljs-string">'text'</span>: <span class="hljs-string">'刷新失败'</span>
     };
     <span class="hljs-keyword">let</span> <span class="hljs-attr">formInfo</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(param);
     formProvider.<span class="hljs-title function_">updateForm</span>(formId, formInfo);
  }
  httpRequest.<span class="hljs-title function_">destroy</span>();
</code></pre>
<p>}</p>
<p>async onFormEvent(formId: string, message: string): Promise {
this.getData(formId);
}
}</p>
</li>
<li>
<p>编写刷新事件：参数传到卡片组件内，组件接收参数。处理<code>WidgetCard.ets</code>卡片内逻辑。卡片页面中使用LocalStorageProp装饰需要刷新的卡片数据。</p>
<p>let casesCardInfo = new LocalStorage();
@Entry(casesCardInfo)
@Component
struct Widget_DynamicCard {
@LocalStorageProp('detail') detail: CASES[] = []; // 卡片对象集合
private swiperController: SwiperController = new SwiperController();
@LocalStorageProp('isLongCard') isLongCard: boolean = false;</p>
<p>build() {
// ...
}
}</p>
</li>
</ol>
<h4 data-id="heading-5">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-6">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/160bdf1af84b464d9353063b1ae79913~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623376&amp;x-signature=PbTbJnaEcnFGrEKbgb1v%2Fw81Ag4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：视频悬浮窗]]></title>    <link>https://juejin.cn/post/7589159665856249875</link>    <guid>https://juejin.cn/post/7589159665856249875</guid>    <pubDate>2025-12-29T14:32:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589159665856249875" data-draft-id="7589126217250947113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：视频悬浮窗"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:32:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：视频悬浮窗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:32:12.000Z" title="Mon Dec 29 2025 14:32:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言：</h3>
<p>本示例主要介绍视频小窗口播放场景，利用媒体的AVPlayer实现视频播放以及相关操作，利用PiPWindow开启悬浮窗从而实现小窗口播放视频。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faa55123c4534e75ad2dbbdbf6d93d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623531&amp;x-signature=qomqixm6n%2F3eZ9lrheOj4Sq7C%2Bs%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>等待视频加载完成，视频会自动播放。</li>
<li>将应用隐藏到后台，自动拉起悬浮窗继续播放视频。</li>
<li>点击悬浮窗恢复图标，恢复到原始播放界面，视频继续正常播放。</li>
<li>原始播放界面视频暂停不会拉起悬浮窗。</li>
<li>悬浮窗视频暂停后，再点击恢复图标，原始播放界面视频继续播放。</li>
<li>悬浮窗点击关闭之后，原始播放界面视频暂停。</li>
<li>点击原视频界面小窗口图标，可开启悬浮窗。</li>
<li>手指在原视频左侧滑动可改变视频页面的亮度（需真机验证）。</li>
<li>手指在原视频右侧滑动可改变视频的声音（需真机验证，注：本案例使用的视频暂无声音，开发者可更换视频资源验证该功能）。</li>
</ol>
<h3 data-id="heading-2">下载安装</h3>
<ol>
<li>
<p>模块oh-package.json5文件中引入依赖</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"dependencies"</span>: {
  <span class="hljs-string">"@ohos/compressfile"</span>: <span class="hljs-string">"har包地址"</span>
}
</code></pre>
</li>
<li>
<p>ets文件import自定义视图实视频悬浮窗组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipWindowComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/pipwindow'</span>;
</code></pre>
</li>
</ol>
<h3 data-id="heading-3">快速使用</h3>
<p>本节主要介绍了如何快速上手使用视频悬浮窗组件，包括调节视频亮度声音控制器组件以及常见自定义参数的初始化。</p>
<ol>
<li>
<p>构建组件</p>
<p>在代码合适的位置使用PipWindowComponent组件并传入对应的参数，后续将介绍对应参数的初始化。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 画中画控制开启、播放组件
 * player:初始化视频播放控制器
 * url:传入在线视频资源
 */</span>
PipWindowComponent({
  player: <span class="hljs-keyword">this</span>.player,
  url: <span class="hljs-keyword">this</span>.url
})
</code></pre>
</li>
<li>
<p>各参数初始化，player可直接写PipManager.getInstance().player，url必须为在线mp4视频。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@State</span> <span class="hljs-attribute">player</span>: AVPlayer = PipManager.<span class="hljs-built_in">getInstance</span>().player; <span class="hljs-comment">// 初始化视频播放控制器</span>
<span class="hljs-variable">@State</span> <span class="hljs-attribute">url</span>: string = <span class="hljs-string">" "</span>; <span class="hljs-comment">// 传入在线视频资源</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">属性(接口)说明</h3>
<p>PipWindowComponent组件属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>player</p>
<p>AVPlayer</p>
<p>初始化视频播放控制器</p>
<p>-</p>
<p>url</p>
<p>string</p>
<p>传入在线视频资源</p>
<p>-</p>
<h3 data-id="heading-5">实现思路</h3>
<p>本例涉及的关键特性和实现方案如下：</p>
<ol>
<li>
<p>使用媒体的AVPlayer实现视频播放。</p>
<p>/**</p>
<ul>
<li>初始化AVPlayer</li>
<li>@param url 在线视频路径</li>
<li>@returns 返回值将在线视频进行绑定
*/
async init(url: string): Promise {
await this.release();
// 创建avPlayer实例对象
this.avPlayer = await media.createAVPlayer();
this.isCreate = true;
// 创建状态机变化回调函数
await this.setSourceInfo(); // 视频信息上报函数
await this.setStateChangeCallback(); // 状态机上报回调函数
this.avPlayer.url = url; // 播放hls网络直播码流
}</li>
</ul>
</li>
<li>
<p>使用PiPWindow开启悬浮窗从而实现小窗口播放视频。</p>
<p>/**</p>
<ul>
<li>创建画中画控制器，注册生命周期事件以及控制事件回调</li>
<li>@param ctx 上下文环境
*/
init(ctx: Context) {
if (this.pipController !== null &amp;&amp; this.pipController !== undefined) {
return;
}
// 当前设备如若不支持画中画则退出
if (!PiPWindow.isPiPEnabled()) {
return;
}</li>
</ul>
<p>let config: PiPWindow.PiPConfiguration = {
context: ctx,
// XComponent组件绑定同一个
componentController: this.getXComponentController(),
// 画中画媒体类型枚举，当前使用的视频播放模版
templateType: PiPWindow.PiPTemplateType.VIDEO_PLAY,
};
// 通过create接口创建画中画控制器实例
let promise: Promise&lt;PiPWindow.PiPController&gt; = PiPWindow.create(config);
promise.then((controller: PiPWindow.PiPController) =&gt; {
this.pipController = controller;
// 通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画
this.pipController?.setAutoStartEnabled(true);
// 通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调
this.pipController.on('stateChange', (state: PiPWindow.PiPState, reason: string) =&gt; {
this.onStateChange(state, reason);
});
// 通过画中画控制器实例的on('controlEvent')接口注册控制事件回调
this.pipController.on('controlEvent', (control: PiPWindow.ControlEventParam) =&gt; {
this.onActionEvent(control);
});
}).catch((err: BusinessError) =&gt; {
console.error(<code>Failed to create pip controller. Cause:${err.code}, message:${err.message}</code>);
});
}</p>
</li>
<li>
<p>通过绑定同一个XComponent控制器使得视频页面和悬浮窗页面视频保持统一播放进度。</p>
<p>XComponent({
type: XComponentType.SURFACE,
controller: PipManager.getInstance().getXComponentController()
})
.onLoad(() =&gt; {
// 将surfaceId设置给媒体源
PipManager.getInstance()
.getXComponentController()
.onSurfaceCreated(PipManager.getInstance().getXComponentController().getXComponentSurfaceId())
// 初始化AVPlayer
PipManager.getInstance().player.init(this.url);
})</p>
</li>
<li>
<p>使用@Watch监听AVPlayer的发生变化时，会触发onPlayingChange的回调方法。组件中需要手动控制视频的播放与暂停，因为视频的播放状态是需要根据视频加载进度和手动控制来改变的，所以可以使用@Watch进行监听。</p>
<p>@ObjectLink @Watch("onPlayingChange") player: AVPlayer</p>
<p>onPlayingChange() {
this.player.isPlaying ? this.player.getPlay() : this.player.getPause();
if (this.player.isPlaying === false) {
PipManager.getInstance().setAutoStart(false)
} else {
PipManager.getInstance().setAutoStart(true)
PipManager.getInstance().updatePiPControlStatus()
}
}</p>
</li>
<li>
<p>悬浮窗的从小窗口恢复到原始播放界面以及关闭悬浮窗，需要通过相关生命周期来进行控制视频的播放状态。</p>
<p>// 监听画中画生命周期
onStateChange(state: PiPWindow.PiPState, reason: string) {
switch (state) {
// 表示画中画将要启动
case PiPWindow.PiPState.ABOUT_TO_START:
break;
// 表示画中画已经启动
case PiPWindow.PiPState.STARTED:
// 启动画中画
PipManager.getInstance().player.isPiPWindowLoad = true;
break;
// 表示画中画将要停止
case PiPWindow.PiPState.ABOUT_TO_STOP:
// 画中画关闭
PipManager.getInstance().player.isPiPWindowLoad = false;
break;
// 表示画中画已经停止
case PiPWindow.PiPState.STOPPED:
// 画中画关闭
PipManager.getInstance().player.isPiPWindowLoad = false;
// 小窗口点击关闭画中画，视频暂停播放
if (!PipManager.getInstance().player.isPiPWindowRestore) {
PipManager.getInstance().player.isPlaying = false;
}
PipManager.getInstance().player.isPiPWindowRestore = false;
break;
// 表示画中画将从小窗播放恢复到原始播放界面
case PiPWindow.PiPState.ABOUT_TO_RESTORE:
// 小窗口复原关闭画中画
PipManager.getInstance().player.isPiPWindowLoad = false;
// 从小窗口复原
PipManager.getInstance().player.isPiPWindowRestore = true;
if (!PipManager.getInstance().player.isPlaying) {
PipManager.getInstance().player.isPlaying = true;
}
break;
// 表示画中画生命周期执行过程出现了异常
case PiPWindow.PiPState.ERROR:
break;
default:
break;
}
}</p>
</li>
<li>
<p>因为当悬浮窗的从小窗口恢复到原始播放界面以及关闭悬浮窗时对视频播放状态进行操作，悬浮窗的播放图标并不会实时更新，所以手动进行更新。</p>
<p>/**</p>
<ul>
<li>视频播放页面</li>
<li>@param url:视频源（本案例仅支持使用在线视频）
*/
XComponentView({
url: this.url
})
.gesture(
// 双击视频，视频暂停/播放
GestureGroup(GestureMode.Exclusive,
TapGesture({ count: TAP_GESTURE }).onAction((event?: GestureEvent) =&gt; {
PipManager.getInstance().player.isPlaying = !PipManager.getInstance().player.isPlaying
if (PipManager.getInstance().player.isPlaying === false) {
PipManager.getInstance().setAutoStart(false)
PipManager.getInstance().updatePiPControlStatus()
} else {
PipManager.getInstance().setAutoStart(true)
PipManager.getInstance().updatePiPControlStatus()
}
})
))
// 更新画中画面板控件状态
updatePiPControlStatus() {
let controlType: PiPWindow.PiPControlType = PiPWindow.PiPControlType.VIDEO_PLAY_PAUSE; // 视频播放控制面板中播放/暂停控件。
let status: PiPWindow.PiPControlStatus = PiPWindow.PiPControlStatus.PLAY; // 视频播放控制面板中播放/暂停控件为播放状态。
this.pipController?.updatePiPControlStatus(controlType, status); // 更新控制面板控件功能状态
}</li>
</ul>
</li>
<li>
<p>使用onAreaChange来获取原视频页面的播放区域宽高。</p>
<p>Stack(this.player.isLoading ? { alignContent: Alignment.Center } :
{ alignContent: Alignment.Bottom }) {</p>
<p>/**</p>
<ul>
<li>视频播放组件</li>
<li>url:视频源（本案例仅支持使用在线视频）
*/
XComponentView({
url: this.url
})
...
}
.onAreaChange((oldVal: Area, newVal: Area) =&gt; {
// 获取视频播放区域的宽高
this.videoAreaWidth = newVal.width as number;
this.videoAreaHeight = newVal.height as number;
})</li>
</ul>
</li>
<li>
<p>使用PanGesture来确定手指滑动的方向以及移动的距离从而改变实时改变视频的亮度和声音。</p>
<p>Stack(this.player.isLoading ? { alignContent: Alignment.Center } :
{ alignContent: Alignment.Bottom }) {</p>
<p>/**</p>
<ul>
<li>视频播放组件</li>
<li>url:视频源（本案例仅支持使用在线视频）
*/
XComponentView({
url: this.url
})
...
}
.gesture(
// 双击视频，视频暂停/播放
GestureGroup(GestureMode.Exclusive,
TapGesture({ count: TAP_GESTURE })
.onAction((event?: GestureEvent) =&gt; {
this.player.isPlaying = !this.player.isPlaying;
AppStorage.setOrCreate('pipWindow_isPlaying', this.player.isPlaying);
if (this.player.isPlaying === false) {
PipManager.getInstance().setAutoStart(false);
PipManager.getInstance().updatePiPControlStatus();
} else {
PipManager.getInstance().setAutoStart(true);
PipManager.getInstance().updatePiPControlStatus();
}
}),
PanGesture(this.panOption)
.onActionStart((event: GestureEvent) =&gt; {
this.sysVolumeChange();
this.positionH = event.offsetY;
this.controlShow = true;
})
.onActionUpdate((event: GestureEvent) =&gt; {
this.panOption.setDirection(PanDirection.Vertical);
// 手指初次滑动横向坐标位置
this.fingerPosition = event.fingerList[0].localX;
if (this.positionH === event.offsetY) {
return;
}
// 手指移动的距离
let changeVolume = ((this.positionH - event.offsetY) / this.videoAreaHeight) * HEIGHT_INTEGER;
if (this.fingerPosition &lt; (this.videoAreaWidth / PARTITION)) {
this.onBrightActionUpdate(changeVolume);
// 调节视频亮度
this.mWindow?.setWindowBrightness(this.bright / CONTROLLER_MAX);
} else {
this.onVolumeActionUpdate(changeVolume);
}
this.positionH = event.offsetY;
})
.onActionEnd(() =&gt; {
// 延时隐藏控制器
setTimeout(() =&gt; {
this.controlShow = false;
}, CONTROLLER_DElAY)
})
))</li>
</ul>
</li>
</ol>
<h4 data-id="heading-6">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-7">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ce8fcc243f84647a2963226abfb3c5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623531&amp;x-signature=qViJQl0LopLlJgapc3XNA%2BRXCms%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI工具如何重塑我的开发日常]]></title>    <link>https://juejin.cn/post/7589126920286535690</link>    <guid>https://juejin.cn/post/7589126920286535690</guid>    <pubDate>2025-12-29T14:34:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286535690" data-draft-id="7589126920286437386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI工具如何重塑我的开发日常 "/> <meta itemprop="keywords" content="前端,人工智能,深度学习"/> <meta itemprop="datePublished" content="2025-12-29T14:34:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_XU"/> <meta itemprop="url" content="https://juejin.cn/user/3166249063027112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI工具如何重塑我的开发日常 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3166249063027112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _XU
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:34:07.000Z" title="Mon Dec 29 2025 14:34:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>2025年，转眼间又过去了。作为一名开发者，这一年来，我最深刻的体会就是大语言模型（LLM）如ChatGPT和DeepSeek，已经从“新鲜玩具”彻底转变为日常工作的核心伙伴。它们不再是偶尔咨询的“搜索引擎替代品”，而是真正融入代码编写、调试和思考流程的“编程搭档”。
聚焦到个体层面，这些AI工具对“我”的影响是巨大的：开发效率显著提升，代码编写变得更流畅、更富有创意，同时也让我重新审视自己的编程习惯和技能成长路径。下面，我从个人经历出发，分享这一年的变化。</p>
<h2 data-id="heading-0">ChatGPT：从灵感激发到高效代码生成的得力助手</h2>
<p>年初时，我主要用ChatGPT来处理日常编码问题。起初只是简单问“怎么实现一个Vue函数”或“优化这个SQL查询”，但渐渐地，它成了我开发流程的起点。</p>
<p><strong>效率提升的核心场景：</strong> 在编写新功能时，ChatGPT帮我快速生成 boilerplate 代码。例如，构建一个后端API时，我只需描述需求（如“用Node.js和Express实现一个带JWT认证的用户注册接口”），它就能输出完整结构，包括错误处理和最佳实践。这让我从重复性工作解放出来，一天能多处理2-3个中等复杂度任务。个人统计下来，今年我的代码提交频率比去年提高了约30%，很大程度上归功于此。</p>
<p><strong>调试的加速器：</strong> 遇到bug时，粘贴错误信息和相关代码，ChatGPT往往能精准指出问题，甚至建议多种修复方案。相比以前先手动搜索再实现验证，现在调试时间缩短了至少一半。有一次，一个棘手的异步并发问题困扰了我半天，用ChatGPT分析后，很快就解决了。</p>
<p><strong>个人影响：</strong> 它让我编码更“如鱼得水”——思路卡壳时，像和一位资深同事 brainstorm 一样顺畅。负面来说，有时生成的代码需要仔细审查（hallucination问题虽减少但仍存在），这培养了我更强的代码审查习惯。总体上，ChatGPT让我从“机械码农”转向“架构思考者”，工作效率明显提升。</p>
<h2 data-id="heading-1">DeepSeek：极致性价比与本地部署的硬核选择</h2>
<p>年中开始，我逐渐把DeepSeek作为主力代码工具，它使用起来很方便以及能很好的控制成本。它的代码生成精度与速度在Vue、Node.js等前端生态上表现不错，而且响应速度也很快。 如果项目涉密注重隐私，DeepSeek开源模型可以部署到本地运行，不上传任何敏感项目代码。</p>
<p><strong>个人影响：</strong> DeepSeek可以满足大量批量生成或重构的场景。它把我从“担心费用”和“担心隐私”的焦虑中解放出来，让我更专注于业务本身。</p>
<h2 data-id="heading-2">我的典型工作流</h2>
<p>实际使用中，两者我形成了清晰的互补策略：</p>
<ul>
<li>创意与需求拆解阶段 → 用ChatGPT（更擅长发散思维）。</li>
<li>核心代码实现与优化阶段 → 切到DeepSeek（更快、更省钱）。</li>
<li>调试与重构阶段 → 根据上下文和隐私需求灵活切换。</li>
</ul>
<h2 data-id="heading-3">个人体会</h2>
<p>大模型的进步让代码生成不再是“填空题”，而是真正智能协作。
<strong>生产力跃升：</strong> 结合使用ChatGPT和DeepSeek，我的整体开发效率得到了大幅提升。重复任务几乎自动化，留出更多时间专注核心逻辑和创新。 <strong>技能演变：</strong> AI处理了低阶工作，我被迫提升prompt工程和系统设计能力。以前写代码靠记忆，现在更靠“问对问题”。这让我成长更快，同时也担心过度依赖会弱化基础技能——所以我坚持不断手动实现一些算法练习。</p>
<p>当然，不是一切完美。AI偶尔也会输出低质代码，需要人工把关。但总体上，2025年的AI工具让我这个开发者感受到前所未有的赋能。 展望2026，随着agentic模式（如多步自主任务）和更好工具集成，我相信开发将更进一步“智能化”。作为开发者，我们不是被取代，而是被放大——抓住这个浪潮，继续游刃有余地在代码的海洋中畅游！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：自定义动效tab实现]]></title>    <link>https://juejin.cn/post/7589099845186863140</link>    <guid>https://juejin.cn/post/7589099845186863140</guid>    <pubDate>2025-12-29T14:35:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589099845186863140" data-draft-id="7589201772118179846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：自定义动效tab实现"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:35:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：自定义动效tab实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:35:16.000Z" title="Mon Dec 29 2025 14:35:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言：</h3>
<p>本示例介绍使用List、Text等组件，以及animateTo等接口实现自定义Tab效果。</p>
<h3 data-id="heading-1">效果预览图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0902abaf52b1453ca3b99e5b48e54f7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=ofjnt6Rur%2BoNoc%2FwDkn1%2FjLbotw%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<p>1.选中页签，字体放大加粗且后面有背景条，起到强调作用。</p>
<p>2.手势触摸tab内容滑动，背景条跟随手势一起滑动。抬手时，当tab内容滑动距离不足一半时，会自动回弹，而当tab内容滑动距离大于一半时，背景条则会移动到下一个页签。当背景条滑动到一定距离后开始滑动页签条，使背景条始终能够保持在可视范围内。</p>
<p>3.点击页签，可以进行页签切换。</p>
<p>4.滑动页签条，背景条也会随之一起滑动，然后滑动tab内容，页签条会滑动到原处，使背景条处于可视范围内，之后背景条开始跟随手势滑动。</p>
<p>5.动画承接，背景条滑动过程中，触摸屏幕，背景条动画停止，松开手势，背景条继续滑动</p>
<h3 data-id="heading-2">下载安装</h3>
<p>1.模块oh-package.json5文件中引入依赖</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"dependencies"</span>: {
  <span class="hljs-string">"@ohos-cases/custom_animation_tab"</span>: <span class="hljs-string">"har包地址"</span>
}
</code></pre>
<p>2.ets文件import自定义视图实现Tab效果组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">CustomAnimationTab</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos-cases/custom_animation_tab'</span>
</code></pre>
<h3 data-id="heading-3">快速使用</h3>
<p>本节主要介绍了如何快速上手使用自定义视图实现Tab效果组件，包括构建Tab组件以及常见自定义参数的初始化。</p>
<p>1.构建Tab</p>
<p>在代码合适的位置使用CustomAnimationTab组件并传入对应的参数（animationAttribute必须设置，其余参数可以使用默认值），后续将分别介绍对应参数的初始化。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 构建自定义Tab
 * animationAttribute: 动效属性
 * tabsInfo: tab数据源
 * indicatorBarAttribute: 背景条属性
 * tabBarAttribute: 页签条属性
 * tabController: 自定义动效tab控制器
 * scroller: 页签条滚动控制器
 */</span>
CustomAnimationTab({
  animationAttribute: <span class="hljs-keyword">this</span>.animationAttribute,
  tabsInfo: <span class="hljs-keyword">this</span>.tabsInfo,
  indicatorBarAttribute: <span class="hljs-keyword">this</span>.indicatorBarAttribute,
  tabBarAttribute: <span class="hljs-keyword">this</span>.tabBarAttribute,
  tabController: <span class="hljs-keyword">this</span>.tabController,
  scroller: <span class="hljs-keyword">this</span>.scroller
})
</code></pre>
<p>2.动效属性初始化</p>
<p>动效属性基类为AnimationAttribute，其中封装了tab组件内部的动效属性。本示例中提供了开发自定义背景条颜色动效属性的代码。首先创建一个MyAnimationAttribute类，并继承AnimationAttribute基类，其中新增背景条颜色属性indicatorBarColor；之后创建MyAnimationAttribute状态变量对象animationAttribute，并将背景条颜色属性绑定到自定义背景条上，同时与button相关联，通过点击事件动态更改背景条颜色。（这里需要注意class对象属性级更新的正确使用）</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 自定义动效属性，添加了背景条颜色变化</span>
<span class="hljs-meta">@State</span> animationAttribute: <span class="hljs-type">MyAnimationAttribute</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">MyAnimationAttribute</span>($r(<span class="hljs-string">"app.color.custom_animation_tab_indicator_color"</span>));


<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAnimationAttribute</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AnimationAttribute</span> </span>{
  <span class="hljs-comment">// 背景条颜色</span>
  indicatorBarColor: <span class="hljs-type">ResourceColor</span>;

  constructor(indicatorBarColor: <span class="hljs-type">ResourceColor</span>) {
    <span class="hljs-keyword">super</span>();
    <span class="hljs-keyword">this</span>.indicatorBarColor = indicatorBarColor;
  }
}


<span class="hljs-meta">@Builder</span>
indicatorBar($$: <span class="hljs-type">BaseInterface</span>) {
  <span class="hljs-type">Column</span>()
    .height($r(<span class="hljs-string">"app.float.custom_animation_tab_indicator_height"</span>))
    .width($r(<span class="hljs-string">"app.string.custom_animation_tab_one_hundred_percent"</span>))
    <span class="hljs-comment">// 绑定自定义动效属性</span>
    .backgroundColor(<span class="hljs-keyword">this</span>.animationAttribute.indicatorBarColor)
    .borderRadius($r(<span class="hljs-string">"app.float.custom_animation_tab_indicator_border_radius"</span>))
}

<span class="hljs-comment">// 更新自定义动效变量——背景条颜色</span>
<span class="hljs-type">Column</span>() {
  <span class="hljs-type">Button</span>($r(<span class="hljs-string">"app.string.custom_animation_tab_button_text"</span>))
    .height($r(<span class="hljs-string">"app.string.custom_animation_tab_ninety_percent"</span>))
    .<span class="hljs-keyword">type</span>(<span class="hljs-type">ButtonType</span>.<span class="hljs-type">Capsule</span>)
    .onClick(() =&gt; {
      <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.animationAttribute.indicatorBarColor as <span class="hljs-type">Resource</span>).id ===
      $r(<span class="hljs-string">"app.color.custom_animation_tab_indicator_color"</span>).id) {
        <span class="hljs-keyword">this</span>.animationAttribute.indicatorBarColor = <span class="hljs-type">Color</span>.<span class="hljs-type">Yellow</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.animationAttribute.indicatorBarColor === <span class="hljs-type">Color</span>.<span class="hljs-type">Yellow</span>) {
        <span class="hljs-keyword">this</span>.animationAttribute.indicatorBarColor = $r(<span class="hljs-string">"app.color.custom_animation_tab_indicator_color"</span>);
      }
    })
}
.justifyContent(<span class="hljs-type">FlexAlign</span>.<span class="hljs-type">Center</span>)
.height($r(<span class="hljs-string">"app.string.custom_animation_tab_ten_percent"</span>))
.width($r(<span class="hljs-string">"app.string.custom_animation_tab_one_hundred_percent"</span>))
</code></pre>
<p>3.数据初始化</p>
<p>本小节主要介绍了如何初始化自定义Tab数据源。首先构建一个TabInfo数组，然后向其中传入对应的TabInfo对象，TabInfo对象主要需要传入三个属性——页签标题、tab页面内容视图以及页签组件。以base页面为例，首先创建一个@Builder函数，在该函数中填入struct组件，在struct组件中编写对应tab页面内容视图。然后，构建对应的页签样式tabBar，其中需要添加一个TabBarItemInterface类对象作为形参，其包括了一些必要属性，可以自定义样式修改，本示例中主要通过使用当前索引curIndex与页签索引index之间的比较来动态更改页签样式。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// tab数据</span>
<span class="hljs-attr">tabsInfo</span>: <span class="hljs-title class_">TabInfo</span>[] = [];

<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabsInfo</span> = [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_BASE_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(baseBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_UI_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(uiBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_DYEFFECT_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(dyEffectBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_THIRTYPARTY_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(thirdPartyBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_NATIVE_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(nativeBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabInfo</span>(<span class="hljs-title class_">CustomAnimationTabConfigure</span>.<span class="hljs-property">DEFAULT_OTHER_TAB</span>, <span class="hljs-title function_">wrapBuilder</span>(otherBuilder), <span class="hljs-title function_">wrapBuilder</span>(tabBar))
]
  
<span class="hljs-comment">// baseBuilder页面</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LazyDataSource</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./LazyDataSource'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SkeletonLayout</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SkeletonLayout'</span>;

<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">baseBuilder</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">BasePage</span>();
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">BasePage</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">LazyDataSource</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyDataSource</span>&lt;<span class="hljs-built_in">string</span>&gt;();

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">pushData</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span>`</span>);
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">List</span>() {
        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
          <span class="hljs-title class_">ListItem</span>() {
            <span class="hljs-title class_">SkeletonLayout</span>({<span class="hljs-attr">isMine</span>: <span class="hljs-literal">false</span>})
          }
        })
      }
      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)
  }
}

<span class="hljs-comment">// 页签样式</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">tabBar</span>(<span class="hljs-params">$$: TabBarItemInterface</span>) {
  <span class="hljs-title class_">Text</span>($$.<span class="hljs-property">title</span>)
    .<span class="hljs-title function_">fontSize</span>($$.<span class="hljs-property">curIndex</span> === $$.<span class="hljs-property">index</span> ? $r(<span class="hljs-string">"app.float.custom_animation_tab_list_select_font_size"</span>) : $r(<span class="hljs-string">"app.float.custom_animation_tab_list_unselect_font_size"</span>))
    .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">"app.color.custom_animation_tab_list_font_color"</span>))
    .<span class="hljs-title function_">fontWeight</span>($$.<span class="hljs-property">curIndex</span> === $$.<span class="hljs-property">index</span> ? <span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span> : <span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)
    .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
}
</code></pre>
<p>4.背景条初始化</p>
<p>背景条可以通过IndicatorBarAttribute类进行配置，也可以使用已有的背景条配置（目前支持两种: IndicatorBarAttribute.BACKGROUNDBAR和IndicatorBarAttribute.THINSTRIP）。本示例主要介绍了构建IndicatorBarAttribute类进行背景条配置，其中传入了背景条组件indicatorBar ，背景条宽度模式设置为内边距模式，左右边距设为20，上下边距设为10，同时设置背景条最大偏移为CustomAnimationTabConfigure.INDICATOR_MAX_LEFT以及背景条宽度扩展比例为CustomAnimationTabConfigure.DEFAULT_INDICATOR_EXPAND。</p>
<pre><code class="hljs language-less" lang="less">indicatorBarAttribute: IndicatorBarAttribute = new IndicatorBarAttribute(this.indicatorBar, SizeMode.<span class="hljs-attribute">Padding, 20, 10,
  CustomAnimationTabConfigure.INDICATOR_MAX_LEFT, CustomAnimationTabConfigure.DEFAULT_INDICATOR_EXPAND);

@Builder
indicatorBar($$</span>: BaseInterface) {
  <span class="hljs-built_in">Column</span>()
    .<span class="hljs-built_in">height</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.custom_animation_tab_one_hundred_percent"</span>))
    .<span class="hljs-built_in">width</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.custom_animation_tab_one_hundred_percent"</span>))
    .<span class="hljs-built_in">backgroundColor</span>(this.animationAttribute.indicatorBarColor)
    .<span class="hljs-built_in">borderRadius</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.float.custom_animation_tab_indicator_border_radius"</span>))
}
</code></pre>
<p>5.页签条初始化</p>
<p>页签条属性通过TabBarAttribute类进行配置。本例中主要配置了各个页签的宽度大小以及页签条高度。</p>
<pre><code class="hljs language-ini" lang="ini">tabBarAttribute: <span class="hljs-attr">TabBarAttribute</span> = new TabBarAttribute(CustomAnimationTabConfigure.LIST_ITEM_WIDTH, CustomAnimationTabConfigure.TABBAR_HEIGHT)
</code></pre>
<p>6.tab及页签条控制器初始化</p>
<p>自定义Tab控制器以及页签条控制器分别通过CustomAnimationTabController和Scroller初始化，分别用于控制自定义Tab与页签条的行为。</p>
<pre><code class="hljs language-ini" lang="ini">// tabController
tabController: <span class="hljs-attr">CustomAnimationTabController</span> = new CustomAnimationTabController()<span class="hljs-comment">;</span>
// scroller
scroller: <span class="hljs-attr">Scroller</span> = new Scroller()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">属性(接口)说明</h3>
<p>CustomAnimationTab组件属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>animationAttribute</p>
<p>AnimationAttribute</p>
<p>封装了包括背景条长度、背景条高度以及背景条左边距在内的动效属性，使组件内部对应的属性可以动态变化</p>
<p>undefined</p>
<p>tabsInfo</p>
<p>TabInfo[]</p>
<p>tab数据源</p>
<p>-</p>
<p>indicatorBarAttribute</p>
<p>IndicatorBarAttribute</p>
<p>背景条属性类，配置背景条组件，以及背景条相关的属性</p>
<p>-</p>
<p>tabBarAttribute</p>
<p>AnimationAttribute</p>
<p>页签条属性类，配置页签条相关的属性</p>
<p>-</p>
<p>tabController</p>
<p>CustomAnimationController</p>
<p>tab控制器，用于控制tabs组件进行页签切换</p>
<p>-</p>
<p>scroller</p>
<p>Scroller</p>
<p>页签条控制器，可以控制页签条的滚动</p>
<p>-</p>
<p>animationDuration</p>
<p>number</p>
<p>页签切换时长，控制页签切换时背景条滑动以及tab页面之间切换的时长</p>
<p>240ms</p>
<p>startIndex</p>
<p>number</p>
<p>配置起始的页签索引</p>
<p>0</p>
<p>gestureAnimation</p>
<p>(index: number, targetIndex: number, elementsInfo: [number, number][], ratio: number) =&gt; void</p>
<p>配置在tab页面上手势滑动时背景条的跟手动效</p>
<p>-</p>
<p>autoAnimation</p>
<p>(index: number, targetIndex: number, elementsInfo: [number, number][], ratio: number) =&gt; void</p>
<p>配置在tab页面上离手后背景条的自动滑动动效</p>
<p>-</p>
<p>clickAnimation</p>
<p>(index: number, targetIndex: number, indexInfo: Record&lt;string, number&gt;, targetIndexInfo: Record&lt;string, number&gt;, elementsInfo: [number, number][]) =&gt; void</p>
<p>配置点击页签时背景条的滑动动效</p>
<p>-</p>
<p>getScrollInfo</p>
<p>(center: number, width: number) =&gt; [number, number]</p>
<p>获取页签对应的背景条左边距以及页签条偏移，通过该函数可以自行配置选中各个页签时背景条的左边距以及页签条的偏移情况</p>
<p>-</p>
<p>TabInfo类属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>title</p>
<p>string</p>
<p>页签标题</p>
<p>-</p>
<p>contentbuilder</p>
<p>WrappedBuilder&lt;[]&gt;</p>
<p>tab页面内容视图</p>
<p>-</p>
<p>barBuilder</p>
<p>WrappedBuilder&lt;[TabBarItemInterface]&gt;</p>
<p>页签组件（没有配置，则使用内部默认配置）</p>
<p>undefined</p>
<p>IndicatorBarAttribute类属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>indicatorBar</p>
<p>(index: BaseInterface) =&gt; void</p>
<p>自定义背景条组件</p>
<p>-</p>
<p>sizeMode</p>
<p>SizeMode</p>
<p>背景条宽度模式</p>
<p>SizeMode.Normal</p>
<p>innerWidth</p>
<p>number</p>
<p>1. 尺寸模式为正常模式，表示背景条宽度，值为0时则与页签宽度保持一致;<br/>
2. 尺寸模式为内边距模式，表示背景条与页签项之间的左右边距</p>
<p>0</p>
<p>innerHeight</p>
<p>number</p>
<p>1. 尺寸模式为正常模式，表示背景条高度，值为0时则与页签高度保持一致;<br/>
2. 尺寸模式为内边距模式，表示背景条与页签项之间的上下边距</p>
<p>0</p>
<p>maxIndicatorBarLeft</p>
<p>number</p>
<p>背景条最大偏移(&lt;0: 无上限, &gt;=0: innerMaxIndicatorBarLeft)，配置背景条最大的滑动距离，超过该距离后除非页签条滑动到了底部，否则滑动页签条，背景条不再滑动</p>
<p>-1</p>
<p>indicatorExpand</p>
<p>number</p>
<p>背景条宽度扩展比例，配置背景条在滑动过程中宽度扩展的比例</p>
<p>1</p>
<p>barAlign</p>
<p>VerticalAlign</p>
<p>背景条垂直布局，配置背景条相对于页签的位置</p>
<p>VerticalAlign.Center</p>
<p>TabBarAttribute类属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>barItemWidth</p>
<p>Length</p>
<p>各个页签项的宽度（没有设置且尺寸模式为正常模式时，与页签同宽；没有设置且尺寸模式为内边距模式时，与背景条同宽）</p>
<p>undefined</p>
<p>barHeight</p>
<p>Length</p>
<p>页签条高度（没有设置且尺寸模式为正常模式时，与首个页签同高；没有设置且尺寸模式为内边距模式时，与背景条同高）</p>
<p>undefined</p>
<p>scrollable</p>
<p>boolean</p>
<p>是否可以滚动页签条(false则所有页签等分屏幕宽度，barItemWidth失效)</p>
<p>true</p>
<p>barEdgeEffect</p>
<p>EdgeEffect</p>
<p>页签条边缘滑动效果，支持弹簧效果和阴影效果</p>
<p>EdgeEffect.Spring</p>
<p>barVertical</p>
<p>BarPosition</p>
<p>页签条位置，处于tab内容的上方或下方</p>
<p>BarPosition.Start</p>
<p>barBackgroundColor</p>
<p>ResourceColor</p>
<p>页签条背景颜色</p>
<p>Color.Transparent</p>
<p>BaseInterface属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>curIndex</p>
<p>number</p>
<p>当前选中的页签索引</p>
<p>-</p>
<p>TabBarItemInterface属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>curIndex</p>
<p>number</p>
<p>当前选中的页签索引</p>
<p>-</p>
<p>index</p>
<p>number</p>
<p>页签本身索引</p>
<p>-</p>
<p>title</p>
<p>string</p>
<p>页签标题</p>
<p>-</p>
<p>SizeMode属性</p>
<p>属性</p>
<p>类型</p>
<p>释义</p>
<p>默认值</p>
<p>Normal</p>
<p>-</p>
<p>标准宽度模式，背景条尺寸通过背景条宽高属性显示设置</p>
<p>-</p>
<p>Padding</p>
<p>-</p>
<p>内边距模式，背景条尺寸通过页签上下边距隐性设置</p>
<p>-</p>
<h3 data-id="heading-5">实现思路</h3>
<p>本案例的功能实现主要可以分为两个部分：第一个是点击页签的切换，第二个是滑动tab的切换。在后续两小节将对以上两个部分进行详细介绍。然后，我们展示了一些重要的变量名及其含义。</p>
<ul>
<li>maxListOffset：页签条最大偏移距离</li>
<li>maxIndicatorBarLeft： 背景条最大偏移距离</li>
<li>AnimationAttribute.left：背景条位置</li>
</ul>
<h4 data-id="heading-6">1.核心函数getScrollInfo</h4>
<p>由于我们将页签动画效果分为两种不同类型的滑动，因此需要实现一个函数以分别获取每个页签对应的背景条位置以及页签条滑动偏移。</p>
<p>1.1 背景条最大滑动距离以及页签条最大滑动距离</p>
<p>首先，我们需要了解两个概念：背景条最大滑动距离以及页签条最大滑动距离，如下图所示。</p>
<p>（1）背景条最大偏移距离：背景条滑动到该处时不再向后滑动，此时页签条接管滑动。</p>
<p>（2）页签条最大偏移距离：当页签条接管滑动以后，当滑动到末尾时，无法向后滑动，此时背景条再次接管滑动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c9b31735ad41a8a2542cbcbf2e1f18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=2jvHdEkc8264CFo3tqidfzG49Us%3D" alt="" loading="lazy"/></p>
<p>1.2 三个阶段</p>
<p>从上面的两个概念，我们可以看出滑动主要可以切分为三个阶段：1）背景条初始滑动阶段；2）页签条滑动阶段；3）背景条再次滑动阶段。</p>
<p>1.3 代码实现</p>
<p>通过以上两个小节的介绍，我们可以尝试实现代码。具体代码如下所示：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 获取页签对应的背景条位置以及页签条偏移
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">center</span> - 页签中心点
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">width</span> - 页签条宽度
 * <span class="hljs-doctag">@returns</span>: [背景条左端位置, 页签条偏移]
 */</span>
<span class="hljs-meta">@Param</span> <span class="hljs-attr">getScrollInfo</span>: <span class="hljs-function">(<span class="hljs-params">center: <span class="hljs-built_in">number</span>, width: <span class="hljs-built_in">number</span></span>) =&gt;</span> [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>] =
  (<span class="hljs-attr">center</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>): [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>] =&gt; {
    <span class="hljs-comment">// 获取背景条位置</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">indicatorLeft</span>: <span class="hljs-built_in">number</span> = center - <span class="hljs-variable language_">this</span>.<span class="hljs-property">indicatorBarWith</span> / <span class="hljs-number">2</span>;
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点: 当背景条位置大于默认的背景条最大位置时，选取背景条最大位置作为背景条实际位置</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">finalIndicatorLeft</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndicatorBarLeft</span> &gt;= <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(indicatorLeft, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndicatorBarLeft</span>) : indicatorLeft;
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点: 背景条产生的多余距离作为页签条滑动距离</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">listOffset</span>: <span class="hljs-built_in">number</span> = indicatorLeft - finalIndicatorLeft;
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点: 当页签条偏移大于页签条可偏移量，选取页签条可偏移量作为页签条实际偏移</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">finalListOffset</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(listOffset, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxListOffset</span>);
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点: 页签条多余的偏移作为背景条后续的滑动距离</span>
    finalIndicatorLeft += listOffset - finalListOffset;
    <span class="hljs-keyword">return</span> [finalIndicatorLeft, finalListOffset];
  };
</code></pre>
<p>具体思路：首先我们可以根据页签的位置信息获取对应背景条的初始位置。1）第一阶段：背景条初始位置就是背景条的实际位置；2）第二阶段：当背景条偏移大于背景条最大偏移距离时，进入第二阶段。这时候后续多余的背景条偏移需要作为页签条偏移，以实现页签条移动；3）第三阶段：当页签条偏移大于页签条最大偏移量时，进入第三阶段。此时多余的页签条偏移会作为背景条的偏移，使背景条继续向后滑动。</p>
<h4 data-id="heading-7">2.点击页签的切换</h4>
<ul>
<li>
<p>首先在onChange回调中实现对应的动画效果，当事件为点击事件并且需要进行页签切换时才进入到对应的动画效果实现，其中首先通过获取index页签的中心位置计算背景条位置，以实现背景条移动到当前页签位置。然后，通过elementsInfo数组获取index页签对应的页签条偏移，从而对页签条进行滑动。而背景条的滑动则通过页签条的滑动回调函数onDidScroll来进行。</p>
<p>// tab
Swiper(this.swiperController) {
// 布局实现
}
.onChange((index: number) =&gt; {
// 点击事件且发生页签切换
if (this.listTouchState === 1 &amp;&amp; index !== this.curIndex) {
let indexInfo: Record&lt;string, number&gt; = this.getElementInfo(this.curIndex);
let targetIndexInfo: Record&lt;string, number&gt; = this.getElementInfo(index);
this.clickAnimation(this.curIndex, index, indexInfo, targetIndexInfo, this.elementsInfo);
}
this.curIndex = index;
console.log(<code>curIndex: ${this.curIndex}</code>)
})</p>
<p>clickAnimation: (targetIndex: number, targetIndexInfo: Record&lt;string, number&gt;, elementsInfo: IndicatorAnimationInfo[]) =&gt; void =
(targetIndex: number, targetIndexInfo: Record&lt;string, number&gt;, elementsInfo: IndicatorAnimationInfo[]): void =&gt; {
// 根据targetIndex页签当前位置获取对应的背景条位置
this.animationAttribute.left = targetIndexInfo.center - this.elementsInfo[targetIndex].width / 2;
this.animationAttribute.indicatorBarWidth = this.elementsInfo[targetIndex].width;
this.animationAttribute.indicatorBarHeight = this.elementsInfo[targetIndex].height;
this.scroller!.scrollTo({xOffset: elementsInfo[targetIndex].offset, yOffset: 0, animation: {duration: this.animationDuration, curve: Curve.Linear}});
};</p>
</li>
<li>
<p>在页签点击事件中触发页签切换事件，后续就会触发tab的onChange事件实现切换动画。</p>
<p>// 页签点击事件
ListItem() {
// 布局实现
}
.onClick(() =&gt; {
this.listTouchState = 1;
this.tabController.changeIndex(index);
})</p>
</li>
</ul>
<h4 data-id="heading-8">2.滑动Tab的切换</h4>
<p>滑动页签切换主要分为两个部分：一个是背景条的滑动，一个是页签条的滑动。</p>
<p>2.1 手势跟踪</p>
<pre><code class="hljs language-ini" lang="ini">Swiper(this.swiperController) {
  // 布局实现
}
.onGestureSwipe((index: number, event: TabsAnimationEvent) =&gt; {
  <span class="hljs-attr">this.listTouchState</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  let curOffset: <span class="hljs-attr">number</span> = event.current<span class="hljs-literal">Off</span>set<span class="hljs-comment">;</span>
  let targetIndex: <span class="hljs-attr">number</span> = index<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.isReachBorder</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  // tab组件到达边界使背景条和页签条跳转到终点位置
  // TODO: 知识点: 这里不能判断到边界直接退出，因为onGestureSwipe每一帧触发回调，当手势滑动较快，上一帧背景条没有到达边界
  // TODO(接上): 知识点: 下一帧content超出边界，这时候背景条没有更新，退出将导致背景条停滞在上一帧位置无法更新。
  if ((<span class="hljs-attr">index</span> === <span class="hljs-number">0</span> &amp;&amp; cur<span class="hljs-literal">Off</span>set &gt; <span class="hljs-number">0</span>) ||
    (<span class="hljs-attr">index</span> === this.innerBarData.length - <span class="hljs-number">1</span> &amp;&amp; cur<span class="hljs-literal">Off</span>set &lt; <span class="hljs-number">0</span>)) {
    <span class="hljs-attr">this.isReachBorder</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">curOffset</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  }

  let ratio: <span class="hljs-attr">number</span> = Math.abs(cur<span class="hljs-literal">Off</span>set / this.tabsWidth)<span class="hljs-comment">; // tab滑动比例</span>
  if (curOffset &lt; 0) { // tab右滑
    <span class="hljs-attr">targetIndex</span> = index + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  } else if (curOffset &gt; 0) { // tab左滑
    <span class="hljs-attr">targetIndex</span> = index - <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  }
  // 获取背景条位置及页签条偏移
  // 获取背景条位置及页签条偏移
  this.gestureAnimation(index, targetIndex, this.elementsInfo, ratio)<span class="hljs-comment">;</span>
})

/**
 * 手势滑动动效
 * @param index - 起始页签索引
 * @param targetIndex - 目标页签索引
 * @param elementsInfo - 页签信息<span class="hljs-section">[背景条左端位置, 页签条偏移]</span>
 * @param ratio - 当前手势滑动比例
 * @returns
 */
gestureAnimation: (index: number, targetIndex: number, elementsInfo: IndicatorAnimationInfo<span class="hljs-section">[]</span>, ratio: number) =&gt; <span class="hljs-attr">void</span> =
  (index: number, targetIndex: number, elementsInfo: IndicatorAnimationInfo<span class="hljs-section">[]</span>, ratio: number): <span class="hljs-attr">void</span> =&gt; {
    <span class="hljs-attr">this.animationAttribute.left</span> = elementsInfo[index].left + (elementsInfo[targetIndex].left - elementsInfo[index].left) * ratio<span class="hljs-comment">;</span>
    this.scroller!.scrollTo({xOffset: elementsInfo<span class="hljs-section">[index]</span>.offset + (elementsInfo<span class="hljs-section">[targetIndex]</span>.offset - elementsInfo<span class="hljs-section">[index]</span>.offset) * ratio, yOffset: 0})<span class="hljs-comment">;</span>
    let indicatorSize: <span class="hljs-section">[number, number]</span> = this.getIndicatorSize(ratio, index, targetIndex)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.animationAttribute.indicatorBarWidth</span> = indicatorSize[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.animationAttribute.indicatorBarHeight</span> = indicatorSize[<span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
</code></pre>
<p>具体思路： 手势跟踪滑动主要存在两种情况：1）背景条到达边界；2）背景条未到达边界。首先判断tab是否滑动到边界，若滑动到边界，则目标页签等于当前页签。否则，则根据当前的偏移情况来判断目标页签相对于当前页签的位置。然后，分别获取当前页签以及目标页签对应的背景条位置以及页签条偏移作为背景条和页签条的起始状态和最终状态。之后，可以通过计算tab滑动比例，获取当前背景条位置以及页签条偏移，公式如下所示：</p>
<p><img src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/753/188/655/0030086000753188655.20241112155448.15165570652993497711761492221015:50001231000000:2800:22461A880326840156127BDF00A3EC7A1E6E8F58EC696730938CEA9FF99BB61B.jpg" alt="" loading="lazy"/></p>
<p>2.2 动画效果</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Swiper</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperController</span>) {
  <span class="hljs-comment">// 布局实现</span>
}
.<span class="hljs-title function_">onContentDidScroll</span>(<span class="hljs-function">(<span class="hljs-params">selectedIndex: <span class="hljs-built_in">number</span>, index: <span class="hljs-built_in">number</span>, position: <span class="hljs-built_in">number</span>, mainAxisLength: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
  <span class="hljs-comment">// 动画启动，选取当前index索引页签的属性来执行背景条和页签条滑动</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimationStart</span> &amp;&amp; index === <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerCurrnetIndex</span>) {
    <span class="hljs-comment">// 使用选中页签相对于Swiper主轴起始位置的移动比例判断滑动的目标页签targetIndex的位置</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">targetIndex</span>: <span class="hljs-built_in">number</span> = position &lt; <span class="hljs-number">0</span> ? index + <span class="hljs-number">1</span> : index - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (targetIndex &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerBarData</span>.<span class="hljs-property">length</span> || targetIndex &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Error: targetIndex exceeds the limit range:
            selectedIndex: <span class="hljs-subst">${selectedIndex}</span>, curIndex: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.innerCurrnetIndex}</span>, index: <span class="hljs-subst">${index}</span>,
            targetIndex: <span class="hljs-subst">${targetIndex}</span>, position: <span class="hljs-subst">${position}</span>, mainAxisLength: <span class="hljs-subst">${mainAxisLength}</span>`</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">let</span> <span class="hljs-attr">ratio</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(position);
    <span class="hljs-comment">// 通过页签比例计算当前页签条和背景条的位置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">autoAnimation</span>(index, targetIndex, <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementsInfo</span>, ratio);
  }
})
.<span class="hljs-title function_">onAnimationStart</span>(<span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span>, targetIndex: <span class="hljs-built_in">number</span>, event: TabsAnimationEvent</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReachBorder</span>) { <span class="hljs-comment">// 若tab到达边界，则不继续执行动画</span>
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimationStart</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">listTouchState</span> = <span class="hljs-number">0</span>;
})
.<span class="hljs-title function_">onAnimationEnd</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimationStart</span> = <span class="hljs-literal">false</span>;
})

<span class="hljs-comment">/**
 * 自动滑动动效
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">index</span> - 起始页签索引
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">targetIndex</span> - 目标页签索引
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">elementsInfo</span> - 页签动效信息[背景条左端位置, 页签条偏移]
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">ratio</span> - 当前tab滑动比例
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-attr">autoAnimation</span>: <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span>, targetIndex: <span class="hljs-built_in">number</span>, elementsInfo: IndicatorAnimationInfo[], ratio: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> =
  (<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">targetIndex</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">elementsInfo</span>: <span class="hljs-title class_">IndicatorAnimationInfo</span>[], <span class="hljs-attr">ratio</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationAttribute</span>.<span class="hljs-property">left</span> = elementsInfo[index].<span class="hljs-property">left</span> + (elementsInfo[targetIndex].<span class="hljs-property">left</span> - elementsInfo[index].<span class="hljs-property">left</span>) * ratio;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>!.<span class="hljs-title function_">scrollTo</span>({
      <span class="hljs-attr">xOffset</span>: elementsInfo[index].<span class="hljs-property">offset</span> + (elementsInfo[targetIndex].<span class="hljs-property">offset</span> - elementsInfo[index].<span class="hljs-property">offset</span>) * ratio,
      <span class="hljs-attr">yOffset</span>: <span class="hljs-number">0</span>
    });
    <span class="hljs-keyword">let</span> <span class="hljs-attr">indicatorSize</span>: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getIndicatorSize</span>(ratio, index, targetIndex);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationAttribute</span>.<span class="hljs-property">indicatorBarWidth</span> = indicatorSize[<span class="hljs-number">0</span>];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationAttribute</span>.<span class="hljs-property">indicatorBarHeight</span> = indicatorSize[<span class="hljs-number">1</span>];
  };
</code></pre>
<p>具体思路：首先在动画开始时，我们在onAnimationStart回调中只进行动画开始状态的改变(i.e. this.isAnimationStart = true)。然后，在onContentDidScroll回调中进行绘制动画。具体来说，在每一次回调onContentDidScroll接口时通过起始页签index、目标页签targetIndex以及滑动比例来判断当前背景条位置以及页签条的偏移，如公式(1)所示。 因此，动画函数中最重要的就是判断index、targetIndex以及滑动比例。由于页签条的滑动等价于背景条滑动，因此我们只需要判断背景条的滑动情况就可以覆盖所有情况。如下图所示，这里主要存在以下三种情况的判断：1）背景条未回弹且滑动比例小于0.5；2）背景条未回弹且滑动比例大于等于0.5；3）背景条回弹。</p>
<ul>
<li>背景条未回弹且滑动比例小于0.5。这时候起始页签index应该等于curIndex，而目标页签targetIndex则可以根据滑动比例正负判断index+1(index-1)。当tab不断向左(右)滑动时，index页签滑动比例不断增加，背景条也不断向右(左)滑动。 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3693165cd984404295011fb4de0ffe27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=4xHk9CWH7Tar50Zlm05Zj4G4PEg%3D" alt="" loading="lazy"/></li>
<li>背景条回弹。这时候起始页签应该等于curIndex，而目标页签targetIndex则可以根据滑动比例正负判断index+1(index-1)。当tab回弹时，index页签滑动比例不断减少，背景条也不断向左(右)滑动，直至回弹到原位置。 <img src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/753/188/655/0030086000753188655.20241112155556.18668753938282901278375408321859:50001231000000:2800:7048F42A46AF7BA65E56C5ABE532B5457FE4FCB49ED8DF1ED2A078A30E01F14C.jpg" alt="" loading="lazy"/></li>
<li>背景条未回弹且滑动比例大于等于0.5。这时候目标页签应该等于curIndex，起始页签index应该则可以根据滑动比例正负判断targetIndex+1(targetIndex-1)。但是，仔细观察我们可以发现，其实这种情况与背景条回弹情况基本一致。可以将其看作是黄色页签开始向左滑动，也可以将其看作是绿色页签开始进行回弹。因此，我们可以将其转化为绿色页签回弹，如后续第二张图所示。这时候起始页签应该等于curIndex，而目标页签targetIndex则可以根据滑动比例正负判断index+1(index-1)。当index页签内容回弹时，tab滑动比例不断减少，背景条也不断向右(左)滑动，直至回弹到原位置。 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74b6b5751fb34eed9b495448648ee49c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=fXRxHGZUbA2DDY2lUJOEZiAYKoU%3D" alt="" loading="lazy"/> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc86ebc4f774132b3f365384c596d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=F54KlZY3mB%2BnS%2B5tp7ThVDe9sL4%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-9">总结</h3>
<p>本示例使用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fts-rendering-control-lazyforeach-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-rendering-control-lazyforeach-V5" ref="nofollow noopener noreferrer">LazyForEach</a>进行数据懒加载，LazyForEach懒加载可以通过设置cachedCount属性来指定缓存数量，同时搭配<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fbest-practices-V5%2Fbpta-component-reuse-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/best-practices-V5/bpta-component-reuse-V5" ref="nofollow noopener noreferrer">组件复用</a>能力以达到性能最优效果。</p>
<h4 data-id="heading-10">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-11">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a7ba13e43043c8b42062f8c1f2df5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623716&amp;x-signature=Rjwce9Q%2FlqrthiP0BhulqN1mazE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：状态栏动画实现]]></title>    <link>https://juejin.cn/post/7589172193150386212</link>    <guid>https://juejin.cn/post/7589172193150386212</guid>    <pubDate>2025-12-29T14:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589172193150386212" data-draft-id="7589172193150369828" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：状态栏动画实现"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：状态栏动画实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:38:18.000Z" title="Mon Dec 29 2025 14:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本案例展示了状态栏的动态交互效果。通过监听页面滚动事件 <code>onDidScroll</code>，随着页面的上下滚动，实现状态栏颜色的变化。搜索框会在滚动时流畅地展开或收起，并伴有自然的透明度过渡效果。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3064042edec1412ea719171e33071a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623898&amp;x-signature=KyMi6HGBLfyLqFqwm1pqVlnuTjQ%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>进入页面开始加载，加载完成后显示整个界面,上下滚动页面即可。</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<ul>
<li>
<p><strong>初始化和状态设置</strong><br/>
在 <code>aboutToAppear()</code> 方法中，初始化了窗口模型 <code>windowModel</code>。启用沉浸式（设置全屏显示和状态栏为白色），获取状态栏高度存储在 <code>statusBarHeight</code> 变量中，从预定义的数据源 <code>LIST_DATA</code> 加载数据到 <code>dataSource</code>中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">aboutToAppear(): void {
  <span class="hljs-comment">// 初始化窗口管理model</span>
  <span class="hljs-keyword">const</span> windowStage: window.WindowStage | undefined = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'windowStage'</span>);
  <span class="hljs-comment">// 没有windowStage将无法执行下列逻辑</span>
  <span class="hljs-keyword">if</span> (!windowStage) {
    logger.error(TAG, <span class="hljs-string">'windowStage init error!'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">this</span>.windowModel.setWindowStage(windowStage);
  <span class="hljs-comment">// 设置沉浸模式及状态栏白色</span>
  <span class="hljs-keyword">this</span>.windowModel.setImmersive();
  <span class="hljs-comment">// 获取顶部状态栏高度</span>
  <span class="hljs-keyword">this</span>.windowModel.getStatusBarHeight((statusBarHeight) =&gt; {
    logger.info(TAG, <span class="hljs-string">'statusBarHeight is '</span> + statusBarHeight);
    <span class="hljs-keyword">this</span>.statusBarHeight = px2vp(statusBarHeight);
  })
  <span class="hljs-comment">// 组装数据源</span>
  <span class="hljs-keyword">this</span>.dataSource.pushArrayData(LIST_DATA)
}
</code></pre>
</li>
<li>
<p><strong>界面布局构造</strong><br/>
使用Stack控件使状态栏与列表重叠，并为列表添加滚动监听器，以根据滚动位置调整状态栏和导航栏的透明度及展开收起动效。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Stack</span>({ alignContent: Alignment.Top }) {
  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-comment">// 动态显示回顶部或位置天气控件</span>
    if (this.isFlow) {
      this<span class="hljs-selector-class">.topUpBuilder</span>()
    } else {
      this<span class="hljs-selector-class">.locationAndWeatherBuilder</span>()
    }
    this<span class="hljs-selector-class">.searchViewBuilder</span>()
    this<span class="hljs-selector-class">.toolViewBuilder</span>()
  }
  <span class="hljs-selector-class">.height</span>(Constants.NAVIGATION_BAR_HEIGHT + this.statusBarHeight)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.padding</span>({
      top: this.statusBarHeight
    })
    <span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_THREE)

  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点：父组件的透明度Opacity影响子组件（如父类Opacity为0.5，若子组件为0.5时，子组件实际Opacity = 0.5*0.5）,此处Row来改变状态栏的透明度不受影响其它组件透明度</span>
  <span class="hljs-built_in">Row</span>() {
  }
  <span class="hljs-selector-class">.backgroundColor</span>($r("app.color.status_bar_animation_white"))
    <span class="hljs-selector-class">.opacity</span>(this.navigateBarOpacity)
    <span class="hljs-selector-class">.height</span>(Constants.STATUS_BAR_HEIGHT + this.statusBarHeight)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_TWO)

  <span class="hljs-built_in">List</span>({ scroller: this.scroller }) {
    <span class="hljs-comment">// ...</span>
  }
  <span class="hljs-comment">// 隐藏滚动条</span>
  <span class="hljs-selector-class">.scrollBar</span>(BarState.Off)
    <span class="hljs-comment">// 渐变蓝色背景色</span>
    <span class="hljs-selector-class">.linearGradient</span>({
      colors: [[Constants.LIST_LINEAR_GRADIENT_START_COLOR, Constants.LIST_LINEAR_GRADIENT_START],
        [Constants.LIST_LINEAR_GRADIENT_END_COLOR, Constants.LIST_LINEAR_GRADIENT_END]]
    })
    <span class="hljs-selector-class">.height</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
}
<span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_ONE)
  <span class="hljs-selector-class">.height</span>(Constants.FULL_PERCENT)
  <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-comment">// 扩展至所有非安全区域</span>
  <span class="hljs-selector-class">.expandSafeArea</span>([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
</code></pre>
</li>
<li>
<p><strong>滚动事件处理</strong><br/>
通过监听页面滚动事件 <code>onDidScroll</code>，根据当前的滚动偏移量 yOffset 调整状态栏和导航栏的透明度。如果滚动超过了设定的阈值，则改变状态栏的颜色和展开收起动画。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">.onDidScroll(() =&gt; {
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点：通过currentOffset来获取偏移量比较准确。</span>
  <span class="hljs-keyword">const</span> yOffset: number = <span class="hljs-keyword">this</span>.scroller.currentOffset().yOffset;
  yOffset &lt;= Constants.MAIN_SCROLLER_OFFSET_Y_ZERO ? <span class="hljs-keyword">this</span>.negativeOffsetY = yOffset :
  Constants.MAIN_SCROLLER_OFFSET_Y_ZERO;
  <span class="hljs-comment">// 判断导航栏和状态栏背景透明度变化</span>
  yOffset &gt;= Constants.MAIN_SCROLLER_OFFSET_Y_MAX + <span class="hljs-keyword">this</span>.statusBarHeight ?
    <span class="hljs-keyword">this</span>.navigateBarOpacity = Constants.NAVIGATION_BAR_OPACITY_MAX :
    <span class="hljs-keyword">this</span>.navigateBarOpacity = Constants.NAVIGATION_BAR_OPACITY_MIN;
  <span class="hljs-keyword">this</span>.navigateBarOpacity = yOffset / Constants.MAIN_SCROLLER_OFFSET_Y_MAX;
  <span class="hljs-comment">// 判断当前的导航栏和图标颜色变化</span>
  yOffset &gt; <span class="hljs-keyword">this</span>.statusBarHeight ?
    <span class="hljs-keyword">this</span>.isWhiteColor = <span class="hljs-literal">false</span> : <span class="hljs-keyword">this</span>.isWhiteColor = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 判断状态栏字体颜色变化</span>
  yOffset &gt; <span class="hljs-keyword">this</span>.statusBarHeight ?
  <span class="hljs-keyword">this</span>.windowModel.setSystemBarContentColor(Constants.StatusBarContentBlackColor) :
  <span class="hljs-keyword">this</span>.windowModel.setSystemBarContentColor(Constants.StatusBarContentWhiteColor);
  <span class="hljs-comment">// 判断导航栏动效变化</span>
  yOffset &gt;= <span class="hljs-keyword">this</span>.statusBarHeight + Constants.MAIN_SCROLLER_OFFSET_STATUS_CHANGE ?
    <span class="hljs-keyword">this</span>.isFlow = <span class="hljs-literal">true</span> : <span class="hljs-keyword">this</span>.isFlow = <span class="hljs-literal">false</span>;
})
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">总结</h3>
<p>本示例使用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fts-rendering-control-lazyforeach-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-rendering-control-lazyforeach-V5" ref="nofollow noopener noreferrer">LazyForEach</a>进行数据懒加载，LazyForEach懒加载可以通过设置cachedCount属性来指定缓存数量，同时搭配<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fbest-practices-V5%2Fbpta-component-reuse-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/best-practices-V5/bpta-component-reuse-V5" ref="nofollow noopener noreferrer">组件复用</a>能力以达到性能最优效果。</p>
<h4 data-id="heading-4">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-5">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d55a567a43d2464eba118ff249eb75db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623898&amp;x-signature=mUGp%2FgSDfDrDFk2Gj8P10%2B6AnFQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>