<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[ES6+ 新特性解析：让 JavaScript 开发更优雅高效]]></title>    <link>https://juejin.cn/post/7576052677051416602</link>    <guid>https://juejin.cn/post/7576052677051416602</guid>    <pubDate>2025-11-24T10:21:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677051416602" data-draft-id="7576070987294031918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" ES6+ 新特性解析：让 JavaScript 开发更优雅高效"/> <meta itemprop="keywords" content="ECMAScript 6,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T10:21:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             ES6+ 新特性解析：让 JavaScript 开发更优雅高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:21:35.000Z" title="Mon Nov 24 2025 10:21:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>ES6（ECMAScript 2015）是 JavaScript 语言发展的里程碑，引入了大量让代码更简洁、更易维护的新特性。本文将深入解析这些特性，并通过实际代码示例展示它们的强大之处。</p>
<h2 data-id="heading-0">解构赋值：优雅的数据提取</h2>
<p>解构赋值让我们能够从数组或对象中快速提取值，赋给变量。</p>
<h3 data-id="heading-1">数组解构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本数组解构</span>
<span class="hljs-keyword">const</span> [a, b, c] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b, c); <span class="hljs-comment">// 1 2 3</span>

<span class="hljs-comment">// 嵌套数组解构</span>
<span class="hljs-keyword">const</span> [a, [b, c, [d], e]] = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, [<span class="hljs-number">4</span>], <span class="hljs-number">5</span>]];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b, c, d, e); <span class="hljs-comment">// 1 2 3 4 5</span>

<span class="hljs-comment">// 剩余参数解构</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> [first, ...rest] = arr;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(first, rest); <span class="hljs-comment">// 1 [2, 3, 4, 5]</span>

<span class="hljs-comment">// 实际应用：提取教练和球员</span>
<span class="hljs-keyword">const</span> users = [<span class="hljs-string">'Darvin Ham'</span>, <span class="hljs-string">'James'</span>, <span class="hljs-string">'Luka'</span>, <span class="hljs-string">'Davis'</span>, <span class="hljs-string">'Ayton'</span>, <span class="hljs-string">'Kyle'</span>];
<span class="hljs-keyword">const</span> [captain, ...players] = users;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(captain, players); 
<span class="hljs-comment">// Darvin Ham ['James', 'Luka', 'Davis', 'Ayton', 'Kyle']</span>
</code></pre>
<h3 data-id="heading-2">对象解构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sex = <span class="hljs-string">'boy'</span>;
<span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Darvin Ham'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
    sex, <span class="hljs-comment">// 对象属性简写</span>
    <span class="hljs-attr">like</span>: {
        <span class="hljs-attr">n</span>: <span class="hljs-string">'唱跳'</span>
    }
};

<span class="hljs-comment">// 对象解构</span>
<span class="hljs-keyword">let</span> { name, age, <span class="hljs-attr">like</span>: { n } } = obj;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name, age, n); <span class="hljs-comment">// Darvin Ham 25 唱跳</span>

<span class="hljs-comment">// 字符串也可以解构</span>
<span class="hljs-keyword">const</span> [e, r, ...u] = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e, r, u); <span class="hljs-comment">// h e ['l', 'l', 'o']</span>

<span class="hljs-comment">// 获取字符串长度</span>
<span class="hljs-keyword">const</span> { length } = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(length); <span class="hljs-comment">// 5</span>
</code></pre>
<h3 data-id="heading-3">解构的实用技巧</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 交换变量（无需临时变量）</span>
<span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>, y = <span class="hljs-number">2</span>;
[x, y] = [y, x];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x, y); <span class="hljs-comment">// 2 1</span>

<span class="hljs-comment">// 函数参数解构</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">{ name, greeting = <span class="hljs-string">'Hello'</span> }</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}
<span class="hljs-title function_">greet</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }); <span class="hljs-comment">// Hello, Bob!</span>

<span class="hljs-comment">// 设置默认值</span>
<span class="hljs-keyword">const</span> { name, gender = <span class="hljs-string">'unknown'</span> } = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gender); <span class="hljs-comment">// unknown（因为 user 中没有 gender 属性）</span>
</code></pre>
<h2 data-id="heading-4">模板字符串：更优雅的字符串处理</h2>
<p>模板字符串使用反引号(``)定义，支持多行字符串和插值表达式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'zhangsan'</span>;

<span class="hljs-comment">// 传统字符串拼接</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello, i am '</span> + myName);

<span class="hljs-comment">// 模板字符串</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello, i am <span class="hljs-subst">${myName}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello, i am <span class="hljs-subst">${myName.toUpperCase()}</span>`</span>);

<span class="hljs-comment">// 多行字符串</span>
<span class="hljs-keyword">const</span> message = <span class="hljs-string">`
  亲爱的 <span class="hljs-subst">${myName}</span>:
  欢迎使用我们的服务！
  祝您使用愉快！
`</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
</code></pre>
<h2 data-id="heading-5">更现代的循环：for...of</h2>
<p><code>for...of</code> 循环提供了更好的可读性和性能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'zhangsan'</span>;

<span class="hljs-comment">// for...of 遍历字符串</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> myName) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 依次输出: z h a n g s a n</span>
}

<span class="hljs-comment">// 与 for 循环对比</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 传统的 for 循环</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr[i]);
}

<span class="hljs-comment">// 更简洁的 for...of</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
</code></pre>
<blockquote>
<p><strong>性能建议</strong>：<code>for...of</code> 语义更好，可读性更强，性能也不会比计数循环差太多。而 <code>for...in</code> 性能较差，应尽量避免使用。</p>
</blockquote>
<h2 data-id="heading-6">BigInt：处理大整数的新数据类型</h2>
<p>JavaScript 的数字类型有精度限制，最大安全整数是 2^53-1。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript 的数字精度问题</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_SAFE_INTEGER</span>); <span class="hljs-comment">// 9007199254740991</span>

<span class="hljs-keyword">let</span> num = <span class="hljs-number">1234567890987654321</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 1234567890987654400（精度丢失！）</span>

<span class="hljs-comment">// 使用 BigInt</span>
<span class="hljs-keyword">let</span> num2 = <span class="hljs-number">1234567890987654321n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num2, <span class="hljs-keyword">typeof</span> num2); <span class="hljs-comment">// 1234567890987654321n 'bigint'</span>

<span class="hljs-comment">// BigInt 运算</span>
<span class="hljs-keyword">const</span> big1 = <span class="hljs-number">9007199254740991n</span>;
<span class="hljs-keyword">const</span> big2 = <span class="hljs-number">1n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(big1 + big2); <span class="hljs-comment">// 9007199254740992n</span>

<span class="hljs-comment">// 注意事项</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1n</span> + <span class="hljs-number">2</span>); <span class="hljs-comment">// ❌ TypeError: Cannot mix BigInt and other types</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">16n</span>)); <span class="hljs-comment">// ❌ TypeError</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-number">3.</span><span class="hljs-number">14n</span>; <span class="hljs-comment">// ❌ SyntaxError: Invalid or unexpected token</span>
</code></pre>
<h3 data-id="heading-7">BigInt 使用要点：</h3>
<ul>
<li>使用 <code>n</code> 后缀表示 BigInt 字面量</li>
<li>不能与 Number 类型直接混合运算</li>
<li>不能使用 Math 对象的方法</li>
<li>只能表示整数，不支持小数</li>
</ul>
<h2 data-id="heading-8">函数参数的增强</h2>
<h3 data-id="heading-9">默认参数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x = <span class="hljs-number">1</span>, y = <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 4 (使用默认值 y=1)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 8</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>()); <span class="hljs-comment">// 2 (使用默认值 x=1, y=1)</span>
</code></pre>
<h3 data-id="heading-10">剩余参数 vs arguments</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'剩余参数:'</span>, args, <span class="hljs-keyword">typeof</span> args); 
    <span class="hljs-comment">// [1, 2, 3, 4] 'object'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是数组吗:'</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(args)); <span class="hljs-comment">// true</span>
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'arguments:'</span>, <span class="hljs-variable language_">arguments</span>, <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">arguments</span>); 
    <span class="hljs-comment">// [Arguments] { '0': 1, '1': 2, '2': 3, '3': 4 } 'object'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'arguments是数组吗:'</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(<span class="hljs-variable language_">arguments</span>)); <span class="hljs-comment">// false</span>
    
    <span class="hljs-comment">// 剩余参数支持数组方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'参数个数:'</span>, args.<span class="hljs-property">length</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'参数总和:'</span>, args.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b, <span class="hljs-number">0</span>));
}

<span class="hljs-title function_">foo</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
</code></pre>
<h3 data-id="heading-11">剩余参数的优势：</h3>
<ul>
<li>是真正的数组，可以使用所有数组方法</li>
<li>更清晰的语法</li>
<li>更好的类型推断（TypeScript）</li>
</ul>
<h2 data-id="heading-12">其他实用特性</h2>
<h3 data-id="heading-13">指数运算符</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES7 (2016) 引入的指数运算符</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span> ** <span class="hljs-number">10</span>); <span class="hljs-comment">// 1024</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span> ** <span class="hljs-number">3</span>); <span class="hljs-comment">// 27</span>

<span class="hljs-comment">// 替代 Math.pow()</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>)); <span class="hljs-comment">// 1024 (传统方式)</span>
</code></pre>
<h3 data-id="heading-14">对象属性简写</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> name = <span class="hljs-string">'Alice'</span>;
<span class="hljs-keyword">const</span> age = <span class="hljs-number">25</span>;

<span class="hljs-comment">// 传统写法</span>
<span class="hljs-keyword">const</span> obj1 = {
    <span class="hljs-attr">name</span>: name,
    <span class="hljs-attr">age</span>: age
};

<span class="hljs-comment">// ES6 简写写法</span>
<span class="hljs-keyword">const</span> obj2 = {
    name,
    age
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2); <span class="hljs-comment">// { name: 'Alice', age: 25 }</span>
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>ES6+ 的新特性让 JavaScript 开发变得更加优雅和高效：</p>
<ul>
<li><strong>解构赋值</strong> 让数据提取更直观</li>
<li><strong>模板字符串</strong> 让字符串处理更简洁</li>
<li><strong>for...of</strong> 提供更好的循环体验</li>
<li><strong>BigInt</strong> 解决大整数计算问题</li>
<li><strong>函数参数增强</strong> 提供更灵活的函数设计</li>
</ul>
<p>这些特性不仅提高了开发效率，也让代码更易读、易维护。建议在实际项目中积极采用这些现代 JavaScript 特性，提升代码质量。</p>
<blockquote>
<p><strong>学习建议</strong>：从解构赋值和模板字符串开始，逐步掌握其他特性，让 ES6+ 成为你的开发利器！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之CSS篇]]></title>    <link>https://juejin.cn/post/7575655132755591187</link>    <guid>https://juejin.cn/post/7575655132755591187</guid>    <pubDate>2025-11-23T13:03:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132755591187" data-draft-id="7575442779039350826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之CSS篇"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-11-23T13:03:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之CSS篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:03:58.000Z" title="Sun Nov 23 2025 13:03:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、前言</h2>
<p>当涉及到网站的性能优化时，CSS 的优化是一个非常重要的方面。如果你的 CSS 太复杂，那么你的网站可能会像一个<strong>慢吞吞的乌龟</strong>一样缓慢地加载和渲染，影响<strong>用户的留存</strong>、<strong>网站的转化率</strong>以及<strong>网站的体验和传播</strong>等，所以对于 CSS 优化还是非常需要的，本文将介绍一些 CSS 性能优化的技巧，帮助你在编写 CSS 代码时提高性能。</p>
<h2 data-id="heading-1">2、前置知识</h2>
<h3 data-id="heading-2">2.1 CSS 解析规则</h3>
<p>我们一般书写 CSS 选择器都是从左往右书写的，所以自然就会以为 CSS 选择器是从左往右去匹配渲染的，但其实不是这样的，<strong>CSS 选择器是从右往左去匹配的</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">span</span> { 
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p>比如上面的 CSS 样式匹配查找过程是这样的：</p>
<ol>
<li>先找到所有的 <code>span</code> 元素。</li>
<li>从第一个 <code>span</code> 元素开始，沿着 <code>span</code> 元素的父级元素查到 <code>div</code>，最后沿着 <code>div</code> 的父级元素找到所有的 <code>.header</code>，找到满足条件的节点就加入到结果集中。</li>
</ol>
<h3 data-id="heading-3">2.2 CSS 的加载过程</h3>
<p><strong>简述浏览器的渲染过程</strong>：在拿到 html 文件后，浏览器会调用 html 解析器解析 html 文件，构建 DOM 树和 CSSOM 树，然后 DOM 树和 CSSOM 树合并成渲染树，最后浏览器会根据渲染树进行布局和绘制，最终将页面呈现给用户。</p>
<p><strong>CSSOM 的构建</strong>：当浏览器解析 html 文档时，如果遇到 <code>&lt;link&gt;</code> 或 <code>&lt;style&gt;</code> 标签，会开始下载和解析 CSS 文件，构建 CSSOM。在 CSSOM 构建完成之前，浏览器不会渲染任何已处理的内容，即使DOM已经解析完毕。</p>
<ul>
<li>CSS 不会阻塞 <code>DOM</code> 的解析，但会阻塞 <code>DOM</code> 的渲染。</li>
<li>CSS 不会阻塞 <code>Javascript</code> 的下载，但会阻塞 <code>JavaScript</code> 的执行，因为 <code>JavaScript</code> 可以操作样式，所以需要等 <code>CSSOM</code> 构建完成之后，才能执行 <code>JavaScript</code>。</li>
</ul>
<p>所以从这里就可以得到以下优化思路：。</p>
<ul>
<li>将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</li>
<li>将 CSS 放在 <code>&lt;head&gt;</code> 中，确保尽早加载。</li>
<li>使用媒体查询（如 <code>media="print"</code>）使 CSS 非阻塞渲染。</li>
<li>在生产环境中，考虑使用 preload（如 <code>&lt;link rel="preload" as="style"&gt;</code>）在不阻塞渲染的情况下加载非首屏的 CSS 资源。</li>
</ul>
<h3 data-id="heading-4">2.3 CSS 权重优先级</h3>
<p>CSS 选择器类型的优先级从低往高依次是：</p>
<ol>
<li><strong>类型选择器</strong>（比如 <code>h1</code>）和<strong>伪元素选择器</strong>（比如 <code>::before</code>）。</li>
<li><strong>类选择器</strong>（比如 <code>.header</code>）、<strong>属性选择器</strong>（比如 <code>[type="checkbox"]</code>）和<strong>伪类选择器</strong>（比如 <code>:hover</code>）。</li>
<li><strong>ID 选择器</strong>（比如 <code>#box</code>）。</li>
<li><strong>!important</strong>：优先级最高。</li>
</ol>
<h2 data-id="heading-5">2、CSS 加载性能优化</h2>
<h3 data-id="heading-6">2.1. 提取公共的 CSS 文件</h3>
<p>如果使用<code>webpack</code>进行项目打包，在打包阶段可以使用<code>mini-css-extract-plugin</code>提取公共 CSS 文件，便于缓存以及减少 CSS 请求次数。</p>
<h3 data-id="heading-7">2.2 避免使用 @import</h3>
<ul>
<li>使用 <code>@import</code> 会阻塞浏览器的并行下载，导致加载速度变慢。</li>
<li>多个 <code>@import</code> 会导致下载顺序紊乱。</li>
</ul>
<h3 data-id="heading-8">2.3 压缩 CSS 文件</h3>
<p>压缩 CSS 文件可以减小文件大小，从而加快加载速度。比如可以用<code>optimize-css-assets-webpack-plugin</code>配合<code>mini-css-extract-plugin</code>使用来优化和压缩 CSS 文件。</p>
<h3 data-id="heading-9">2.4 使用浏览器缓存</h3>
<p>可以使用浏览器缓存来缓存 CSS 文件，从而在页面加载时加快速度。可以设置适当的缓存时间来确保文件在必要时能够更新。</p>
<h3 data-id="heading-10">2.5 使用 CDN 加速</h3>
<ul>
<li>使用 <strong>CDN（内容分发网络）</strong> 可以将 CSS 文件分发到全国各个 <code>CDN</code> 节点的服务器上，用户可以就近下载，从而加快加载速度，也可以减少自己服务器的负载。</li>
<li>如果静态资源很多，可以准备多个静态服务器域名，比如域名是 <code>static.xx.com</code>，做成支持 <code>static0-5</code> 的 6 个域名, 也就是 <code>static0.xx.com、static1.xx.com、static2.xx.com...</code>，每次请求时随机选一个域名地址进行请求，这样可以绕过浏览器同域名的连接数限制（一般是限制 6 个），6 个域名就可以同时发送 36 个连接请求。当然，这个域名个数不是越多越好，太分散的话又会涉及到多域名无法缓存静态资源的问题。</li>
</ul>
<h3 data-id="heading-11">2.6 使用 CSS Sprite</h3>
<p><strong>CSS Sprite</strong> 技术就是我们常说的<strong>雪碧图</strong>，通过将多张小图标拼接成一张大图，能有效的<strong>减少HTTP请求数量</strong>以达到加速显示内容的技术。</p>
<h3 data-id="heading-12">2.7 CSS 样式抽离和去除无用 CSS</h3>
<ul>
<li>平时开发过程中可以将一些<strong>可复用</strong>的 CSS 抽离到一个单独文件中，减少 CSS 代码冗余。</li>
<li>在打包构建时可以利用一些插件去除没有用到的 CSS，相当于对 CSS 进行 <code>Tree shaking</code>，减少打包后体积。</li>
</ul>
<h3 data-id="heading-13">2.8 合理使用内嵌 CSS</h3>
<p><code>内嵌CSS</code> 也就是通过元素的 <code>style</code> 来书写行内样式，比如 <code>&lt;div style="color: red"&gt;&lt;/div&gt;</code>，它的优缺点如下：</p>
<p><strong>优点</strong>：</p>
<ul>
<li>与使用 <code>link</code> 标签相比，可以减少 CSS 的 <code>http</code> 请求量。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>增加 <code>html</code> 文件的体积。</li>
<li>使用 <code>link</code> 标签能很好的利用浏览器的缓存，而内联样式放在 <code>html</code> 里面，能否使用缓存需要看 <code>html</code> 文件的缓存策略。</li>
</ul>
<p>综合它的优缺点，我们可以选择将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</p>
<h2 data-id="heading-14">3、CSS 选择器性能优化</h2>
<h3 data-id="heading-15">3.1 避免使用通配符选择器</h3>
<p>通配符选择器<code>*</code>符号可以匹配任何元素，但是这会导致浏览器需要遍历整个文档树来查找匹配的元素，从而降低性能。</p>
<h3 data-id="heading-16">3.2 使用子选择器代替后代选择器</h3>
<p>后代选择器（如 <code>.parent .child</code>）会检查所有后代元素，而子选择器（如 <code>.parent &gt; .child</code>）只检查直接子元素，匹配范围更小，性能更好。</p>
<h3 data-id="heading-17">3.3 优先使用类（Class）和 ID 选择器</h3>
<p>类选择器（如 <code>.box</code>）和 ID 选择器（如 <code>#box</code>）匹配速度更快，因为它们直接指向特定元素。避免标签选择器（如 <code>div</code>）或属性选择器（如 [type="text"]），后者匹配更加宽泛，效率较低，尤其在大型 DOM 中。</p>
<h3 data-id="heading-18">3.4 避免深层嵌套的选择器</h3>
<p>前面也说过，CSS 选择器需要从右往左去匹配的，嵌套的选择器如 <code>.header div ul li a</code>，因为浏览器需要遍历更多 DOM 节点。建议限制选择器深度在 3 层以内，使用更直接的类或 ID 选择器，如 <code>.box</code>。这能减少匹配时间。或者使用 <code>BEM</code> 命名规范，比如 <code>.block__element--modifier</code>，提高匹配效率。</p>
<p>另外在使用 ID 选择器的时候，前面就需要加上父级的选择器，比如不推荐用 <code>.box #content</code>，推荐用 <code>#content</code>。</p>
<h2 data-id="heading-19">4、CSS 属性性能优化</h2>
<h3 data-id="heading-20">4.1 避免使用过于复杂的属性</h3>
<p>过于复杂的属性会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的属性来实现需要的样式效果，比如下面这些属性：</p>
<ul>
<li><strong>box-shadow</strong>：box-shadow 属性可以实现盒子的阴影效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的边框效果，可以使用 <code>border</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">#888</span>;
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#888</span>;
}
</code></pre>
<ul>
<li><strong>filter</strong>：filter 属性可以实现图像的滤镜效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的颜色变换效果，可以使用 <code>background-color</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">grayscale</span>(<span class="hljs-number">50%</span>);
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
}
</code></pre>
<p>不过需要注意的是，这些替代方案可能会有一些<strong>局限性</strong>，无法完全取代原来的属性。因此，在使用这些替代方案时，需要根据具体的需求和情况进行选择。</p>
<h3 data-id="heading-21">4.2 避免使用不必要的属性</h3>
<p>不必要的属性会增加 <code>CSS</code> 文件的大小，从而降低加载速度。应该尽量避免使用不必要的属性。</p>
<h3 data-id="heading-22">4.3 避免使用 !important</h3>
<p><code>!important</code> 会覆盖其他样式，从而增加渲染时间。而且它不容易被替换或覆盖，后期可维护性也比较差，更好的方式使用更具体、更准确的选择器来定义样式。</p>
<h2 data-id="heading-23">5、CSS 动画性能优化</h2>
<h3 data-id="heading-24">5.1 使用 transform 和 opacity 属性来进行动画</h3>
<p>使用 <code>transform</code> 和 <code>opacity</code> 属性可以减少浏览器的渲染负担，从而提高性能。</p>
<h3 data-id="heading-25">5.2 避免使用过于复杂的动画效果</h3>
<p>过于复杂的动画效果会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的动画效果。</p>
<h3 data-id="heading-26">5.3 在动画中使用 will-change 属性</h3>
<p><code>will-change</code> 属性可以告诉浏览器哪些属性将要被改变，从而提前进行优化，减少渲染负担。</p>
<h3 data-id="heading-27">5.4 使用 requestAnimationFrame() 函数来优化动画</h3>
<p><code>requestAnimationFrame()</code> 函数可以在浏览器下一次渲染之前执行代码，从而减少渲染负担，提高性能。</p>
<h2 data-id="heading-28">6、CSS 渲染性能优化</h2>
<h3 data-id="heading-29">6.1 使用 class 合并 DOM 的修改</h3>
<p>比如我们需要根据不同情况给一个元素添加不同的样式，可能会写出如下的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'blue'</span>;
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'blue'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'red'</span>;
}
</code></pre>
<p>这时候我们可以定义两个 <code>class</code> 类，然后直接切换类名即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'normal'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'hover'</span>);
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'hover'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'normal'</span>);
}
</code></pre>
<h3 data-id="heading-30">6.2 让 DOM 元素脱离文档流</h3>
<p>使用 <code>absoulte</code> 或者 <code>fixed</code> 定位让 DOM 元素脱离文档流，这样在修改 DOM 元素的时候不会影响到其他 DOM 元素的布局，从而提高渲染性能。</p>
<h2 data-id="heading-31">7、总结</h2>
<p>本文主要通过<strong>CSS 加载性能优化</strong>、<strong>CSS 选择器性能优化</strong>、<strong>CSS 属性性能优化</strong>、<strong>CSS 动画性能优化</strong>和<strong>CSS 渲染性能优化</strong>这些方向介绍了 CSS 的性能优化技巧。通过优化 CSS 性能，可以提高网站的性能和用户体验。</p>
<p>在实际开发中，可根据实际业务场景和需要去进行优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题]]></title>    <link>https://juejin.cn/post/7575367791272804390</link>    <guid>https://juejin.cn/post/7575367791272804390</guid>    <pubDate>2025-11-23T09:55:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791272804390" data-draft-id="7575182522411335718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题"/> <meta itemprop="keywords" content="后端,Java,面试"/> <meta itemprop="datePublished" content="2025-11-23T09:55:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叫煤球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058745054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058745054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叫煤球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:55:30.000Z" title="Sun Nov 23 2025 09:55:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. JDK 1.2：ThreadLocal 初版（最小可用）</h2>
<p><strong>核心特点：</strong></p>
<ul>
<li><code>ThreadLocal</code> 首次出现。</li>
<li>每个线程维护自己的 <code>ThreadLocalMap</code>。</li>
<li><code>ThreadLocalMap</code> 的 key 就是 <code>ThreadLocal</code> 本身。</li>
<li>底层使用开放地址法的哈希表（<code>Entry[] table</code>）。</li>
<li><strong>key 不是弱引用</strong>，导致 ThreadLocal 对象不释放时可能造成内存泄漏。</li>
</ul>
<p><strong>主要问题：</strong></p>
<ul>
<li>ThreadLocal 实例如果被 GC 回收前未手动 <code>remove()</code>，线程（尤其是线程池）不会结束，Entry 永远存在，导致 value 泄漏。</li>
</ul>
<p>这也是行业里常说的 ThreadLocal 泄漏最初来源。</p>
<hr/>
<h2 data-id="heading-1">2. JDK 1.3 ~ 1.4：Bug 修复 + 行为稳定</h2>
<p><strong>关键改动：</strong></p>
<ul>
<li>增强清理机制，但依然是 key 强引用。</li>
<li>修复部分扩容和冲突处理问题。</li>
</ul>
<p>但根本性的泄漏问题仍然存在。</p>
<hr/>
<h2 data-id="heading-2">3. JDK 5：引入弱引用（关键里程碑）</h2>
<p>这是 ThreadLocal 设计史上最重要的变更。</p>
<p><strong>重大更新：</strong></p>
<ul>
<li>
<p><code>ThreadLocalMap.Entry</code> 改为 <strong>弱引用</strong>：</p>
<pre><code class="hljs language-scala" lang="scala">static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</span> </span>{
    <span class="hljs-type">Object</span> value;
}
</code></pre>
</li>
<li>
<p>一旦 ThreadLocal 对象不再被外部引用，可以被 GC 回收，Entry 的 key 会变成 <code>null</code>。</p>
</li>
</ul>
<p><strong>为什么改成弱引用？</strong></p>
<ul>
<li>防止 ThreadLocal 对象不释放导致整组 Entry 无法被清理。</li>
</ul>
<p><strong>带来的副作用：</strong></p>
<ul>
<li>value 仍然是强引用，只要线程活着，value 永远不会被回收。</li>
<li>如果你不手动 <code>remove()</code>，依旧可能内存泄漏（尤其线程池）。</li>
</ul>
<p>至此，ThreadLocal 的内存泄漏问题变成了：</p>
<ul>
<li><strong>不是 key 泄漏，而是 value 泄漏。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">4. JDK 6：清理机制增强 + TAB 数组 rehash 改善</h2>
<p><strong>JDK6 的重要演进：</strong></p>
<ul>
<li>加强对 key 为 <code>null</code> 的 Entry 的清理逻辑（例如访问冲突位点时主动清理）。</li>
<li>优化 rehash 和探测机制。</li>
</ul>
<p>整体结构仍为开放地址法，不改变本质机制。</p>
<hr/>
<h2 data-id="heading-4">5. JDK 7：性能优化 + 部分线程局部缓存行为改进</h2>
<p>JDK7 的变化偏向实现层。</p>
<p><strong>增强点：</strong></p>
<ul>
<li>完善冲突探测，降低哈希冲突导致的退化。</li>
<li>改善 nextIndex/prevIndex 的性能。</li>
<li>修复扩容后 rehash 的一些 bug。</li>
</ul>
<p>ThreadLocalMap 变得更健壮，但不改变语义。</p>
<hr/>
<h2 data-id="heading-5">6. JDK 8：清理策略进一步加强，核心逻辑成熟稳定</h2>
<p><strong>关键变化：</strong></p>
<ul>
<li>
<p>ThreadLocalMap 清理 <code>stale entry</code>（key = null）的策略更加激进：</p>
<ul>
<li>get/set/remove 时都会尝试清理死 key。</li>
</ul>
</li>
<li>
<p>内部 rehash 策略更高效。</p>
</li>
<li>
<p>线程池场景下的内存泄漏仍然需要手动处理 (<code>remove()</code>)，但 default 逻辑更健壮。</p>
</li>
</ul>
<p><strong>JDK8 的 ThreadLocal 基本成为行业主流参考实现。</strong></p>
<hr/>
<h2 data-id="heading-6">7. JDK 9：新增 <code>ThreadLocal.withInitial()</code>（语法糖）</h2>
<p>此版本以后属于稳定期，新增功能而非机制变化。</p>
<p><strong>新增：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ThreadLocal<span class="hljs-selector-class">.withInitial</span>(() -&gt; new <span class="hljs-built_in">SimpleDateFormat</span>("yyyy-MM-dd"))
</code></pre>
<p>机制不变，易用性提升。</p>
<hr/>
<h2 data-id="heading-7">8. JDK 11 / JDK 17：几乎无变化，属于稳定维护期</h2>
<ul>
<li>持续做小修复，增强可读性与边界处理。</li>
<li>内存清理策略与 JDK8 几乎无差别。</li>
<li>语义和行为已经非常稳定。</li>
</ul>
<hr/>
<h2 data-id="heading-8">9. JDK 21：虚拟线程（Loom）下的 ThreadLocal 语义扩展（重要）</h2>
<p>在 Loom（虚拟线程）中：</p>
<p><strong>ThreadLocal 默认机制仍然可用，但成本更低：</strong></p>
<ul>
<li>虚拟线程是轻量结构，保留自己的 ThreadLocalMap。</li>
<li>虚拟线程不复用，生命周期短，因此不容易产生 ThreadLocal value 泄漏。</li>
</ul>
<p><strong>关键点：</strong></p>
<ul>
<li>虚拟线程不是池化线程，不会出现线程池泄漏问题。</li>
<li>某些场景 ThreadLocal 成本反而比传统线程更轻。</li>
</ul>
<hr/>
<h2 data-id="heading-9">10. 前后机制的核心变化总结</h2>


















































<table><thead><tr><th>JDK 版本</th><th>变化点</th><th>影响</th></tr></thead><tbody><tr><td>1.2</td><td>基本实现</td><td>存在严重泄漏风险</td></tr><tr><td>1.3-1.4</td><td>Bug 修复</td><td>稳定性增强</td></tr><tr><td>5</td><td><strong>key 改为弱引用</strong></td><td>避免 key 泄漏，但 value 泄漏依旧</td></tr><tr><td>6</td><td>加强化清理逻辑</td><td>降低内存泄漏风险</td></tr><tr><td>7</td><td>进一步优化冲突处理</td><td>性能提升</td></tr><tr><td>8</td><td><strong>成熟实现，清理更激进</strong></td><td>标准实现，被行业普遍使用</td></tr><tr><td>9+</td><td>易用性提升（withInitial）</td><td>开发体验增强</td></tr><tr><td>21</td><td>虚拟线程支持稳定</td><td>泄漏风险显著降低</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">11. 哪些问题贯穿所有版本？</h2>
<p>无论哪个版本，ThreadLocal 永远有两个核心风险：</p>
<ol>
<li><strong>value 会泄漏，只要线程还活着</strong></li>
<li><strong>线程池复用导致 value 长期驻留</strong></li>
</ol>
<p>这两个问题在 JDK21 的虚拟线程中弱化但未彻底消失。</p>
<hr/>
<h2 data-id="heading-11">12. 业内最佳实践</h2>
<ol>
<li>创建后必须手动 <code>remove()</code></li>
<li>避免在容器/框架级别缓存业务值</li>
<li>避免使用无界线程池结合 ThreadLocal</li>
<li>不要把 ThreadLocal 当成上下文传递机制（应使用 ThreadLocal 设计的框架）</li>
<li>推荐使用 <code>withInitial()</code> 避免 null 值</li>
</ol>
<hr/>
<h2 data-id="heading-12">13. 讲清楚本质</h2>
<p><strong>ThreadLocal 在整个 JDK 生命周期中的核心变化只有一次：JDK5 引入弱引用。</strong></p>
<p>其余版本改动都是：</p>
<ul>
<li>更激进的清理策略</li>
<li>更健壮的哈希探测与 rehash</li>
<li>更易用的 API</li>
<li>虚拟线程场景下的运行时表现改善</li>
</ul>
<p>但行为本质没有改变：</p>
<ul>
<li>每个线程维护一个 Map</li>
<li>key 弱引用</li>
<li>value 强引用</li>
<li>需要手动 remove，线程池中更应当如此</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[再来聊聊，Vue3 项目中 Pinia 的替代方案]]></title>    <link>https://juejin.cn/post/7575458028254674987</link>    <guid>https://juejin.cn/post/7575458028254674987</guid>    <pubDate>2025-11-23T11:23:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028254674987" data-draft-id="7575655132755394579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="再来聊聊，Vue3 项目中 Pinia 的替代方案"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-23T11:23:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端布鲁伊"/> <meta itemprop="url" content="https://juejin.cn/user/4431511346492554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            再来聊聊，Vue3 项目中 Pinia 的替代方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4431511346492554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端布鲁伊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T11:23:24.000Z" title="Sun Nov 23 2025 11:23:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><strong>想获取更多2025年最新前端场景题可以看这里</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffe.ecool.fun%2Ftopic-list%3Fic%3DKIQC2F%26from%3Djuejin_article" target="_blank" title="https://fe.ecool.fun/topic-list?ic=KIQC2F&amp;from=juejin_article" ref="nofollow noopener noreferrer">fe.ecool.fun</a></p>
<p>大家好，我是刘布斯。</p>
<p>之前转载了一篇文章<strong>Vue 项目不要再用 Pinia 了</strong>，先不可否认，这文章有点标题党的意思。但这篇文章的主要观点是说，在中小项目里，用 Vue 3 自带的组合式 API（<code>reactive</code> / <code>ref</code>）来管状态，很多时候比硬上 Pinia 要香。</p>
<p>好家伙，评论区一下就热闹了，总结起来是：“Pinia 多好用，你肯定是没用明白 Pinia”</p>
<p>说实话，我确实有点意外。</p>
<p><strong>我先摆明态度：Pinia 是个非常优秀的状态管理库。</strong> 尤雨溪团队亲自操刀，API 设计简洁，TS 支持完美，插件系统灵活，Devtools 体验丝滑。这一点，没人能否认。</p>
<p>但我的核心观点是：<strong>优秀，不代表“所有场景都必须上”。</strong></p>
<p>我发现现在很多团队，尤其是从 Vue 2 刚迁到 Vue 3 不久的，存在一种很强的 <strong>“状态管理惯性”</strong> 。</p>
<p>什么意思？</p>
<p>在 Vue 2 + Options API 的时代，组件（Component）和状态（State）是“隔离”的。<code>data</code> 里的状态天生就是“内向”的，组件一销毁，状态就没了。跨组件通信、全局状态共享，你怎么办？你没得选，你必须上 Vuex。Vuex 就像一个“中央空调”，你不用它，别的房间（组件）就享受不到冷气（状态）。</p>
<p>所以，Vue 2 时代养成了我们的思维定式：<strong>做项目 = Vue 全家桶 = Vue + Vue Router + Vuex。</strong></p>
<p>到了 Vue 3，Vuex 退位，Pinia 继任。于是大家理所当然地把公式换成了：<strong>做项目 = Vue 3 + Vue Router + Pinia。</strong></p>
<p>启动一个新项目，<code>npm create vue@latest</code>，一路 <code>yes</code> 下来，Pinia 就装好了。然后就开始 <code>defineStore</code>。</p>
<p>但大家好像都忽略了 Vue 3 最大的革命性变化——<strong>组合式 API (Composition API)</strong> 本身，就已经是一种强大的状态管理模式了。</p>
<h4 data-id="heading-0"><code>defineStore</code> 帮我们做了什么？</h4>
<p>还是用那篇文章中的例子，做一个最简单的“用户状态管理”，两种方式有什么区别。</p>
<p><strong>1. Pinia 的方式：</strong> 你得先在 <code>stores/user.ts</code> 里：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span><span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span><span class="hljs-string">'vue'</span>

exportconst useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
<span class="hljs-comment">// State</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> userProfile = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// Getters</span>
<span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!token.<span class="hljs-property">value</span>)

<span class="hljs-comment">// Actions</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">data</span>) {
    token.<span class="hljs-property">value</span> = data.<span class="hljs-property">token</span>
    userProfile.<span class="hljs-property">value</span> = data.<span class="hljs-property">profile</span>
    <span class="hljs-comment">// ... 存 localstorage</span>
  }

<span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
    token.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    userProfile.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-comment">// ... 清 localstorage</span>
  }

<span class="hljs-keyword">return</span> { token, userProfile, isLoggedIn, login, logout }
})
</code></pre>
<p>然后在组件里 <code>useUserStore()</code>。</p>
<p><strong>2. 组合式 API 的方式：</strong> 你在 <code>stores/user.ts</code> (对，你也可以叫 <code>stores</code> 目录，这只是个文件夹)：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed, reactive } <span class="hljs-keyword">from</span><span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 以前我们用 reactive，这里用 ref/computed 模拟 Pinia 的结构</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> userProfile = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!token.<span class="hljs-property">value</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">data</span>) {
  token.<span class="hljs-property">value</span> = data.<span class="hljs-property">token</span>
  userProfile.<span class="hljs-property">value</span> = data.<span class="hljs-property">profile</span>
<span class="hljs-comment">// ... 存 localstorage</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
  token.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
  userProfile.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
<span class="hljs-comment">// ... 清 localstorage</span>
}

<span class="hljs-comment">// 导出一个 hook</span>
<span class="hljs-keyword">export</span><span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> { token, userProfile, isLoggedIn, login, logout }
}
</code></pre>
<p>然后在组件里 <code>useUser()</code>。</p>
<hr/>
<p>好了，你对比下这两段代码。</p>
<p><strong>你发现了什么？</strong></p>
<p>在第二种方式里，我只是删掉了 <code>defineStore('user', ...)</code> 那层“壳”，然后把导出的 <code>useUserStore</code> 改成了 <code>useUser</code> (叫什么都行)。</p>
<p><strong>其他的逻辑，一模一样！</strong> 都是在用 <code>ref</code> 和 <code>computed</code>。</p>
<p>Pinia 的 <code>defineStore</code> 在这个场景里，本质上就是帮你做了一件事：<strong>创建了一个跨组件共享的、响应式的单例。</strong></p>
<p>但在 Vue 3 里，<code>import</code> 一个在模块顶层（module scope）定义的 <code>ref</code> 或 <code>reactive</code> 对象，它<strong>天生就是单例</strong>！它天生就是跨组件共享的！</p>
<p>那你可能会反问了：“那 Pinia 岂不是多此一举？”</p>
<p>不，它当然不是多此一举。它提供了 <code>defineStore</code> 这个“壳”，是为了给你带来额外的好处，最核心的就是：</p>
<ol>
<li><strong>Devtools 集成</strong>：这是 Pinia 最大的杀手锏。你可以在时间轴上看到 <code>action</code> 的调用、<code>state</code> 的变更。</li>
<li><strong>插件系统</strong>：比如实现数据持久化，Pinia 有现成的插件，<code>defineStore</code> 的时候配置一下就行。</li>
<li><strong>SSR 支持</strong>：在服务端渲染时，Pinia 能帮你处理好状态的序列化和“注水”(hydration)。</li>
<li><strong>更严格的“心智模型”</strong> ：它强制你区分 <code>state</code>、<code>getters</code>、<code>actions</code>，让团队协作更规范。</li>
</ol>
<h4 data-id="heading-1">Pinia的优势，你的项目真的需要吗？</h4>
<p>我们再回到上篇文章的核心观点：</p>
<p><strong>在一个中小型项目、独立开发、或者团队成员对组合式 API 都很熟练的场景下，上面 Pinia 提供的 4 个好处，你真的都需要吗？</strong></p>
<ul>
<li><strong>Devtools</strong>：说实话，在我十多年的生涯里，除了在 Redux/Vuex 刚出来那会儿，为了调试复杂的异步流和中间件，会去用时间旅行。在绝大多数业务场景里，<code>console.log</code> 和 Vue Devtools 里自带的组件状态检查，已经解决了 99% 的问题。为了那 1% 的“可能”，去引入一个库，划算吗？</li>
<li><strong>插件系统（如持久化）</strong> ：用组合式 API 怎么做持久化？太简单了。你封装的 <code>useUser</code> hook 里面，<code>login</code> 的时候加一行 <code>localStorage.setItem</code>，初始化 <code>token</code> 的时候加一行 <code>localStorage.getItem</code>。这不就是最原始、最可控的持久化吗？你需要为这么点功能，去学一个 Pinia 插件的 API 吗？</li>
<li><strong>SSR</strong>：如果你的项目压根就不是 SSR，那这条对你无效。</li>
<li><strong>严格的心智模型</strong>：这是最大的“陷阱”。组合式 API 的核心思想就是“自由”。它允许你把 <code>state</code> 和 <code>action</code> 放在一起，按“功能”去组织代码，而不是按“类型”（state/getter/action）去组织。<code>defineStore</code> 某种程度上，是又把我们拉回了 Vuex 的那种“分门别类”的思维里。</li>
</ul>
<p>所以，“你会得到更少的心智负担”指的就是这个。</p>
<p>你不需要去记 <code>defineStore</code> 的 API，不需要去想“我这个逻辑是算 <code>getter</code> 还是 <code>action</code>”，你就是在写 JS/TS，你就是在写 <code>function</code>。<strong>这难道不是一种解放吗？</strong></p>
<h4 data-id="heading-2"><strong>什么叫“没用明白 Pinia”？</strong></h4>
<p>在我看来，恰恰相反。</p>
<p><strong>把 Pinia 当成新时代的 Vuex，不分场景、启动项目就先装上，这才是“没用明白 Vue 3”。</strong></p>
<p>如果没有明白 Vue 3 组合式 API 到底给了你多大的“自由”和“能力”，就可能继续用 Vue 2 的“保姆式”思维在写 Vue 3。</p>
<p>我想了几个场景，大家参考下：</p>
<ol>
<li><strong>场景一：个人项目、小团队敏捷开发、内部工具</strong></li>
</ol>
<ul>
<li><strong>我的选择：100% 使用组合式 API。</strong></li>
<li><strong>理由：</strong> 速度快，灵活，零依赖。我可以按功能拆分 <code>useCounter.ts</code>, <code>useUser.ts</code>, <code>useCart.ts</code>... 它们就是一堆 TS 模块，需要共享就在顶层定义 <code>reactive</code>，不需要就只导出函数。打包体积更小，心智负担为零。</li>
</ul>
<ol start="3">
<li><strong>场景二：大型企业级应用、多团队协作、需要强规范</strong></li>
</ol>
<ul>
<li><strong>我的选择：我会倾向于使用 Pinia。</strong></li>
<li><strong>理由：</strong> 这种项目，“规范”大于“灵活”。<code>defineStore</code> 提供的统一范式，能让不同水平的开发者（尤其是新人）写出风格更一致的代码。而且在这种复杂项目里，Devtools 的时间旅行和状态快照，在排查深层 Bug 时，确实能派上用场。</li>
</ul>
<ol start="5">
<li><strong>场景三：需要 SSR 的项目</strong></li>
</ol>
<ul>
<li><strong>我的选择：用 Pinia。</strong></li>
<li><strong>理由：</strong> 别重复造轮子。Pinia 对 SSR 状态处理得很好，自己搞一套组合式 API 的 SSR 状态同步，费时费力，不值得。</li>
</ul>
<p>所以你看，并不是在全盘否定 Pinia，而是在呼吁大家 <strong>“按需选择”</strong> 。</p>
<p>不要因为“大家都用”或者“官方推荐”就去用。工具是死的，人是活的。Vue 3 给了我们一把更轻、更快的匕首（组合式 API），你为什么非要抱着那把很牛、但也很重的开山刀（Pinia）不放，连切个水果都要用它呢？</p>
<p>下次在项目里 <code>npm install pinia</code> 之前，先停 5 秒钟，问问自己：<strong>我这次，真的需要它吗？还是说，几个 <code>ref</code> 和 <code>reactive</code> 就能搞定了？</strong></p>
<p>想明白这个问题，可能比你多刷 10 篇 Pinia 的教程都有用。</p>
<p>行了，今天就聊到这。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度智能体框架DeepAgent剖析]]></title>    <link>https://juejin.cn/post/7575152891955249152</link>    <guid>https://juejin.cn/post/7575152891955249152</guid>    <pubDate>2025-11-23T00:55:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575152891955249152" data-draft-id="7575152891955232768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度智能体框架DeepAgent剖析"/> <meta itemprop="keywords" content="人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-23T00:55:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度学习机器"/> <meta itemprop="url" content="https://juejin.cn/user/486421344552179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度智能体框架DeepAgent剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/486421344552179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度学习机器
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T00:55:04.000Z" title="Sun Nov 23 2025 00:55:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当我们谈论 AI Agent 时，大多数开发者想到的是一个简单的工具调用循环：LLM 生成工具调用，执行工具，将结果返回给 LLM，继续下一轮。这种浅层架构在处理简单任务时表现良好，但面对复杂的多步骤工作流时，就会暴露出致命缺陷：无法有效规划、上下文管理混乱、缺乏质量审查机制。尽管有类似与<code>Langgraph</code>这样的工作流框架，能够免去开发者在编排workflow上面的耗时，但是Agent的核心能力，比如节点和工具，仍需要自行实现。</p>
<p>LangChain 团队研究了<code>Claude Code</code>、<code>OpenAI Deep Research</code>、<code>Manus</code>等真正在生产环境中解决复杂问题的系统，提炼出了四个关键的特征：</p>
<ol>
<li>
<p><strong>详细的系统提示词</strong>：包含工具使用指南和少样本示例的长提示。</p>
</li>
<li>
<p><strong>规划工具</strong>：如<code>Claude Code</code>的Todo List，用于任务分解和进度追踪。</p>
</li>
<li>
<p><strong>子智能体委托</strong>：将复杂任务拆分给专注的子智能体处理。</p>
</li>
<li>
<p><strong>文件系统访问</strong>：作为共享工作空间和长期记忆的载体。</p>
</li>
</ol>
<p><code>DeepAgent</code>正是将这些特征进行抽象后，系统化、框架化的产物，它不是简单的工具调用循环，而是一个完整的<code>Agent Harness</code>，即智能体工具套件。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3bf01a98ee241d08756ae458928fabb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764464104&amp;x-signature=95mZ5Rb5fAcSdoc0GK5RyHGXL88%3D" alt="DeepAgent核心架构" loading="lazy"/></p>
<h2 data-id="heading-0">核心架构</h2>
<h3 data-id="heading-1">什么是 Agent Harness</h3>
<p><code>DeepAgent</code>将自己定位为<code>Agent Harness</code>，它本质上仍是工具调用循环，但集成了让智能体<strong>深度思考</strong>的核心能力。与传统框架不同，<code>DeepAgent</code>通过内置工具和能力，让开发者专注于业务逻辑，而非基础设施搭建。</p>
<h3 data-id="heading-2">模块化的中间件</h3>
<p><code>DeepAgent</code>采用可组合的中间件架构，每个中间件负责一个独立的能力域。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb6dd52c2fe4ed2ae8fe0f26bba9bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764464104&amp;x-signature=aCqRVfxjsHWgcaAB6Cq%2BNtMeu%2F8%3D" alt="内置的中间件" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents <span class="hljs-keyword">import</span> create_deep_agent
<span class="hljs-keyword">from</span> deepagents.middleware <span class="hljs-keyword">import</span> TodoListMiddleware, FilesystemMiddleware, SubAgentMiddleware

<span class="hljs-comment"># 默认情况下，create_deep_agent 会自动附加三大核心中间件</span>
agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 以下中间件会自动启用：</span>
    <span class="hljs-comment"># - TodoListMiddleware: 提供 write_todos 规划工具</span>
    <span class="hljs-comment"># - FilesystemMiddleware: 提供 6 个文件系统工具</span>
    <span class="hljs-comment"># - SubAgentMiddleware: 提供 task 工具用于子智能体委托</span>
)
</code></pre>
<p>这种设计的优势在于可组合性，让开发者可以根据需求选择启用特定中间件，或添加自定义中间件扩展能力。</p>
<h2 data-id="heading-3">文件系统</h2>
<h3 data-id="heading-4">六大文件系统工具</h3>
<p><code>DeepAgent</code>提供了完整的文件系统操作能力，这是其区别于浅层 Agent 的关键特性：</p>








































<table><thead><tr><th>工具</th><th>功能</th><th>用途</th></tr></thead><tbody><tr><td><code>ls</code></td><td>列出文件及元数据，包括大小和修改时间等</td><td>探索目录结构</td></tr><tr><td><code>read_file</code></td><td>读取文件内容，支持行号和分页</td><td>分块读取大文件</td></tr><tr><td><code>write_file</code></td><td>创建新文件</td><td>保存中间结果</td></tr><tr><td><code>edit_file</code></td><td>精确字符串替换</td><td>更新已有文件</td></tr><tr><td><code>glob</code></td><td>模式匹配查找文件</td><td>批量查找文件</td></tr><tr><td><code>grep</code></td><td>搜索文件内容</td><td>代码搜索，内容定位</td></tr></tbody></table>
<h3 data-id="heading-5">自动压缩机制</h3>
<p>当工具返回结果超出token阈值时，<code>DeepAgent</code>会自动将其转储到文件系统，防止上下文窗口饱和：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码示例：自动驱逐逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_tool_result</span>(<span class="hljs-params">result, threshold=<span class="hljs-number">2000</span></span>):
    <span class="hljs-keyword">if</span> count_tokens(result) &gt; threshold:
        file_path = <span class="hljs-string">f"/temp/tool_result_<span class="hljs-subst">{uuid4()}</span>.txt"</span>
        write_file(file_path, result)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Large result saved to <span class="hljs-subst">{file_path}</span>. Use read_file to access."</span>
    <span class="hljs-keyword">return</span> result
</code></pre>
<p>这确保了即使调用返回海量数据的工具（如Web 搜索、数据库查询等），智能体也能通过文件系统分块读取，而不会导致上下文崩溃。</p>
<h2 data-id="heading-6">灵活的持久化策略</h2>
<h3 data-id="heading-7">BackendProtocol 协议设计</h3>
<p><code>DeepAgent</code>将文件系统操作抽象为<code>BackendProtocol</code>协议，支持多种存储策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents.backends <span class="hljs-keyword">import</span> StateBackend, FilesystemBackend, StoreBackend, CompositeBackend

<span class="hljs-comment"># 1. StateBackend：短期内存（默认）</span>
agent = create_deep_agent()  <span class="hljs-comment"># 文件存储在 LangGraph State 中</span>

<span class="hljs-comment"># 2. FilesystemBackend：本地磁盘持久化</span>
agent = create_deep_agent(
    backend=FilesystemBackend(root_dir=<span class="hljs-string">"/Users/agent/workspace"</span>, virtual_mode=<span class="hljs-literal">True</span>)
)

<span class="hljs-comment"># 3. StoreBackend：跨线程持久化（LangGraph Store）</span>
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
agent = create_deep_agent(
    backend=<span class="hljs-keyword">lambda</span> rt: StoreBackend(rt),
    store=InMemoryStore()
)

<span class="hljs-comment"># 4. CompositeBackend：混合存储路由</span>
composite = <span class="hljs-keyword">lambda</span> rt: CompositeBackend(
    default=StateBackend(rt),  <span class="hljs-comment"># 临时文件用 State</span>
    routes={
        <span class="hljs-string">"/memories/"</span>: StoreBackend(rt),  <span class="hljs-comment"># 长期记忆持久化</span>
        <span class="hljs-string">"/workspace/"</span>: FilesystemBackend(root_dir=<span class="hljs-string">"/real/path"</span>)  <span class="hljs-comment"># 工作文件映射到磁盘</span>
    }
)
agent = create_deep_agent(backend=composite, store=InMemoryStore())
</code></pre>
<h3 data-id="heading-8">路由策略示例</h3>
<p>使用<code>CompositeBackend</code>时，不同路径前缀的文件会路由到不同的后端：</p>
<ul>
<li>
<p><code>/workspace/plan.md</code> → StateBackend（短期）</p>
</li>
<li>
<p><code>/memories/agent_context.txt</code> → StoreBackend（跨会话持久化）</p>
</li>
<li>
<p><code>/docs/api_spec.yaml</code> → FilesystemBackend（真实文件系统）</p>
</li>
</ul>
<p>这种设计让智能体能够同时管理临时草稿和长期知识库。</p>
<h2 data-id="heading-9">子智能体机制</h2>
<h3 data-id="heading-10">为什么需要子智能体</h3>
<p>子智能体解决了上下文膨胀问题，实现任务委托与上下文隔离。当智能体使用大输出工具（如多次 Web 搜索）时，主智能体的上下文会迅速填满中间结果。子智能体通过隔离详细工作，让主智能体只接收最终结果，而非生成该结果的几十次工具调用。</p>
<h3 data-id="heading-11">两种定义方式</h3>
<ol>
<li>字典配置</li>
</ol>
<pre><code class="hljs language-python" lang="python">research_subagent = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"research-agent"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"用于深度研究复杂问题"</span>,
    <span class="hljs-string">"system_prompt"</span>: <span class="hljs-string">"你是一个专业的研究助手，擅长多步骤信息收集和综合"</span>,
    <span class="hljs-string">"tools"</span>: [internet_search, summarize],
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"openai:gpt-4o"</span>,  <span class="hljs-comment"># 可选：覆盖主智能体模型</span>
    <span class="hljs-string">"interrupt_on"</span>: {<span class="hljs-string">"internet_search"</span>: <span class="hljs-literal">True</span>}  <span class="hljs-comment"># 可选：HITL 配置</span>
}

agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    subagents=[research_subagent]
)
</code></pre>
<ol start="2">
<li>编译图</li>
</ol>
<p>对于复杂工作流，可以使用预构建的<code>LangGraph</code>图：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents <span class="hljs-keyword">import</span> CompiledSubAgent
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph

<span class="hljs-comment"># 创建自定义图</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_analysis_graph</span>():
    workflow = StateGraph(...)
    <span class="hljs-comment"># ... 构建复杂的分析流程</span>
    <span class="hljs-keyword">return</span> workflow.<span class="hljs-built_in">compile</span>()

analysis_subagent = CompiledSubAgent(
    name=<span class="hljs-string">"data-analyzer"</span>,
    description=<span class="hljs-string">"执行多步骤数据分析任务"</span>,
    runnable=create_analysis_graph()
)

agent = create_deep_agent(subagents=[analysis_subagent])
</code></pre>
<h3 data-id="heading-12">默认子智能体</h3>
<p>除了用户定义的子智能体，<code>DeepAgent</code>始终提供一个<code>general-purpose</code>子智能体：</p>
<ul>
<li>
<p>与主智能体相同的系统提示词和工具</p>
</li>
<li>
<p>主要用途：上下文隔离（而非专业化）</p>
</li>
<li>
<p>使用场景：主智能体可以将复杂任务委托给它，获得简洁结果而不受中间过程污染</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 主智能体可以这样使用：</span>
<span class="hljs-comment"># "请使用 general-purpose 子智能体分析这 100 个文件，返回摘要"</span>
<span class="hljs-comment"># 子智能体完成工作后，主智能体只收到摘要，而非 100 次文件读取的详细内容</span>
</code></pre>
<h2 data-id="heading-13">生产级特性</h2>
<p>针对生产环境，<code>DeepAgent</code>还提供了许多有用的特性。</p>
<h3 data-id="heading-14">1. 对话历史自动摘要</h3>
<p>当 token 使用量过高时，<code>DeepAgent</code>会自动压缩旧对话历史：</p>
<pre><code class="hljs language-python" lang="python">agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 配置摘要触发阈值和目标长度</span>
)
</code></pre>
<h3 data-id="heading-15">2. 工具调用自动修复</h3>
<p>当工具调用被中断或取消时，<code>DeepAgent</code>会自动修复消息历史：</p>
<p><strong>问题场景</strong>：用户在工具执行过程中取消操作，导致<code>tool_call</code>消息没有对应的<code>tool_result</code>，破坏了消息序列的完整性。</p>
<p><strong>解决方案</strong>：<code>DeepAgent</code>会自动注入占位符<code>ToolMessage</code>，确保消息历史的连贯性，避免 LLM 在后续轮次中因不完整的上下文而产生困惑。</p>
<h3 data-id="heading-16">3. Prompt缓存机制</h3>
<p>对于使用Anthropic模型的智能体，<code>DeepAgent</code>启用了<code>prompt caching</code>功能：</p>
<ul>
<li>
<p>自动标记可缓存的提示词部分（如系统提示词、工具定义）</p>
</li>
<li>
<p>减少重复 token 处理，显著降低成本和延迟</p>
</li>
<li>
<p>对于长系统提示词的深度智能体尤其有价值</p>
</li>
</ul>
<h3 data-id="heading-17">4. Human-in-the-Loop</h3>
<p><code>DeepAgent</code>支持在特定工具调用时暂停执行，等待人工审批：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver

agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[delete_file, send_email, read_file],
    interrupt_on={
        <span class="hljs-string">"delete_file"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># 需要审批（approve/edit/reject）</span>
        <span class="hljs-string">"send_email"</span>: {<span class="hljs-string">"allowed_decisions"</span>: [<span class="hljs-string">"approve"</span>, <span class="hljs-string">"reject"</span>]},  <span class="hljs-comment"># 只能批准或拒绝</span>
        <span class="hljs-string">"read_file"</span>: <span class="hljs-literal">False</span>  <span class="hljs-comment"># 无需审批</span>
    },
    checkpointer=MemorySaver()  <span class="hljs-comment"># HITL 必须使用 checkpointer</span>
)

<span class="hljs-comment"># 使用示例</span>
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"session-123"</span>}}
result = agent.invoke({<span class="hljs-string">"messages"</span>: [...]}, config=config)

<span class="hljs-keyword">if</span> result.get(<span class="hljs-string">"__interrupt__"</span>):
    <span class="hljs-comment"># 处理中断，展示待审批操作</span>
    interrupts = result[<span class="hljs-string">"__interrupt__"</span>][<span class="hljs-number">0</span>].value
    action_requests = interrupts[<span class="hljs-string">"action_requests"</span>]
    
    <span class="hljs-comment"># 用户决策</span>
    decisions = [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"approve"</span>}]  <span class="hljs-comment"># 或 "edit"、"reject"</span>
    
    <span class="hljs-comment"># 恢复执行</span>
    result = agent.invoke(
        Command(resume={<span class="hljs-string">"decisions"</span>: decisions}),
        config=config  <span class="hljs-comment"># 必须使用相同的 config</span>
    )
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p><code>DeepAgent</code>实现了从浅层Agent到深度Agent的范式转变，其核心价值在于将复杂任务自动化系统所需的核心能力封装为可组合、生产就绪的<strong>模块化中间件</strong>。</p>
<p>有了这些生产特性，无论是在构建研究助手、代码生成工具、数据分析平台还是智能客服系统，<code>DeepAgent</code>的设计模式都值得深入学习和应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十章(Proxy)]]></title>    <link>https://juejin.cn/post/7575458028254822443</link>    <guid>https://juejin.cn/post/7575458028254822443</guid>    <pubDate>2025-11-23T13:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028254822443" data-draft-id="7575442779039334442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十章(Proxy)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T13:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十章(Proxy)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:00:39.000Z" title="Sun Nov 23 2025 13:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Proxy代理</h2>
<blockquote>
<p>从 Next.js 16 开始，中间件<code>Middleware</code>更名为代理<code>（Proxy）</code>，以更好地体现其用途。其功能保持不变</p>
</blockquote>
<p>如果你想升级为16.x版本，Next.js提供了命令行工具来帮助你升级，只需要执行以下命令即可：</p>
<pre><code class="hljs language-bash" lang="bash">npx @next/codemod@canary middleware-to-proxy .
</code></pre>
<p>代码转换会将文件和函数名从middleware重命名为proxy。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// middleware.ts -&gt; proxy.ts</span>
 
- <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"/>) {
+ <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params"/>) {
</code></pre>
<h3 data-id="heading-1">基本使用</h3>
<p>应用场景：</p>
<ul>
<li>处理跨域请求</li>
<li>接口转发例如/api/user -&gt; (可能是其他服务器java/go/python等) -&gt; /api/user</li>
<li>限流例如配合第三方服务做限流</li>
<li>鉴权/判断是否登录</li>
</ul>
<p>Prxoy代理其实跟拦截器类似，它可以在请求完成之前进行拦截，然后进行一些处理，例如：修改请求头、修改请求体、修改响应体等。</p>
<p>src/proxy.ts</p>
<p>定义proxy函数导出即可，Next.js会自动调用这个函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(request.<span class="hljs-property">url</span>,<span class="hljs-string">'url'</span>);
}
</code></pre>
<p>但是你会发现，他会拦截项目中所有的请求，包括静态资源、API请求、页面请求等。</p>
<pre><code class="hljs language-txt" lang="txt">http://localhost:3000/.well-known/appspecific/com.chrome.devtools.json url
http://localhost:3000/_next/static/chunks/src_app_globals_91e4631d.css url
http://localhost:3000/_next/static/chunks/%5Bturbopack%5D_browser_dev_hmr-client_hmr-client_ts_cedd0592._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_react-server-dom-turbopack_9212ccad._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_next-devtools_index_1dd7fb59.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_a0e4c7b4._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_a38d7d69._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_4b2403f5._.js url
http://localhost:3000/_next/static/chunks/src_app_globals_91e4631d.css.map url
http://localhost:3000/_next/static/chunks/node_modules_%40swc_helpers_cjs_d80fb378._.js url
http://localhost:3000/_next/static/chunks/_a0ff3932._.js url
http://localhost:3000/api/login url
</code></pre>
<h4 data-id="heading-2">配置(config)</h4>
<p>例如我们只想匹配<code>'/api'</code>下面的路径去做一些事情，我们可以使用<code>config</code>配置来实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(request.<span class="hljs-property">url</span>,<span class="hljs-string">'url'</span>);
}
<span class="hljs-comment">//配置匹配路径</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">matcher</span>: <span class="hljs-string">'/api/:path*'</span>,
    <span class="hljs-comment">//matcher: ['/api/:path*','/api/user/:path*'], 支持单个以及多个路径匹配</span>
    <span class="hljs-comment">//matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'], 同样支持正则表达式匹配</span>
}
</code></pre>
<p>结合之前的案例,在cookie那一集，我们还需要单独定义check接口检查cookie，现在我们可以直接在proxy中实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> cookie = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/home'</span>) &amp;&amp; !cookie) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'redirect to login'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/'</span>, request.<span class="hljs-property">url</span>));
    }
    <span class="hljs-keyword">if</span> (cookie &amp;&amp; cookie.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/'</span>, request.<span class="hljs-property">url</span>));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">matcher</span>: [<span class="hljs-string">'/api/:path*'</span>, <span class="hljs-string">'/home/:path*'</span>],
}
</code></pre>
<h4 data-id="heading-3">复杂匹配</h4>
<ul>
<li>source: 表示匹配路径</li>
<li>has: 表示匹配路径中必须(包含)某些条件</li>
<li>missing: 表示匹配路径中(必须不包含)某些条件</li>
</ul>
<p><strong>type</strong> 只能匹配: header, query, cookie</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProxyConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'start proxy'</span>)
   <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ProxyConfig</span> = {
    <span class="hljs-attr">matcher</span>: [
        {
            <span class="hljs-attr">source</span>: <span class="hljs-string">'/home/:path*'</span>,
            <span class="hljs-comment">//表示匹配路径中必须(包含)Authorization头和userId查询参数</span>
            <span class="hljs-attr">has</span>: [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'header'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'Authorization'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'Bearer 123456'</span> },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'query'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'userId'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'123'</span> }
            ],
            <span class="hljs-comment">//表示匹配路径中(必须不包含)cookie和userId查询参数</span>
            <span class="hljs-attr">missing</span>: [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'cookie'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'123456'</span> },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'query'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'userId'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'456'</span> },
            ]
        },
    ]
}
</code></pre>
<p>访问url为：<code>http://localhost:3000/home?userId=123</code></p>
<h4 data-id="heading-4">案例实战(处理跨域)</h4>
<p>只要是/api下面的接口都可以被任意访问</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProxyConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(corsHeaders).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(key, value);
    })
    <span class="hljs-keyword">return</span> response;
}

<span class="hljs-keyword">const</span> corsHeaders = {
    <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
    <span class="hljs-string">'Access-Control-Allow-Methods'</span>: <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>,
    <span class="hljs-string">'Access-Control-Allow-Headers'</span>: <span class="hljs-string">'Content-Type, Authorization'</span>,
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ProxyConfig</span> = {
   <span class="hljs-attr">matcher</span>:<span class="hljs-string">'/api/:path*'</span>,
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6ec749269e4c428d9ed3e7d8cf9a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764507639&amp;x-signature=sOLI4%2BJZEG05m3caC%2F6GzrkV9SA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用好PowerMock，轻松搞定那些让你头疼的单元测试]]></title>    <link>https://juejin.cn/post/7575102209606221850</link>    <guid>https://juejin.cn/post/7575102209606221850</guid>    <pubDate>2025-11-23T08:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606221850" data-draft-id="7575119254313844762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用好PowerMock，轻松搞定那些让你头疼的单元测试"/> <meta itemprop="keywords" content="后端,单元测试"/> <meta itemprop="datePublished" content="2025-11-23T08:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java随想录"/> <meta itemprop="url" content="https://juejin.cn/user/2837192913204935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用好PowerMock，轻松搞定那些让你头疼的单元测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2837192913204935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java随想录
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:26:47.000Z" title="Sun Nov 23 2025 08:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文已收录至GitHub，推荐阅读 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBookSea4j%2FJavaRecord" target="_blank" title="https://github.com/BookSea4j/JavaRecord" ref="nofollow noopener noreferrer">Java随想录</a></p>
<p>微信公众号：Java随想录</p>
<p>结合 <a href="https://juejin.cn/post/7498580969286631434" target="_blank" title="https://juejin.cn/post/7498580969286631434">不用Mockito写单元测试？你可能在浪费一半时间</a> 阅读体验更佳。</p>
<blockquote>
<p>面对无法Mock的静态方法、私有方法和final类，PowerMock为你打开一扇新的大门</p>
</blockquote>
<p>作为一名Java开发者，单元测试是我们保证代码质量的重要环节。但在实际工作中，我们经常会遇到一些难以测试的代码场景：静态工具类、final类、私有方法等。传统的Mockito框架对这些情况束手无策，而PowerMock的出现正好解决了这些痛点。</p>
<h2 data-id="heading-0">PowerMock是什么？为什么需要它？</h2>
<h3 data-id="heading-1">PowerMock的核心定位</h3>
<p>PowerMock是一个强大的Java单元测试框架，它通过扩展现有的Mock框架（如Mockito和EasyMock），提供了更强大的Mock能力。<strong>PowerMock的核心价值在于它能够Mock那些传统Mock工具无法处理的情况</strong>，包括静态方法、final类和方法、私有方法、构造函数等。</p>
<p>与普通Mock框架不同，PowerMock使用自定义的类加载器和字节码操作技术（基于Javassist和ASM库），在运行时修改类的行为，从而实现对这些"难以Mock"的场景的完全控制。</p>
<h3 data-id="heading-2">PowerMock与Mockito的关系和区别</h3>
<p>虽然PowerMock和Mockito都是用于单元测试的Mock框架，但它们在功能和定位上有着明显的区别：</p>
<p><strong>Mockito</strong>是一个轻量级、简单易用的Mock框架，适用于大多数日常测试场景。但它有明显的局限性：无法Mock静态方法、final类、私有方法和构造函数等。</p>
<p><strong>PowerMock</strong>则是对Mockito的增强，填补了Mockito的功能空白。它不是替代Mockito，而是与Mockito协同工作，共同构建完整的单元测试解决方案。</p>
<p>两者核心区别体现在底层实现上：Mockito使用动态代理（CGLIB）技术，而PowerMock通过修改字节码来实现更强大的Mock能力。</p>
<p>正因为这种根本差异，PowerMock可以解决Mockito无法解决的问题。</p>
<h3 data-id="heading-3">PowerMock解决的痛点</h3>
<p>在日常开发中，我们经常会遇到以下测试难题：</p>
<ul>
<li><strong>静态工具类</strong>：如各种Util类中的静态方法。</li>
<li><strong>final类和final方法</strong>：特别是第三方库中的final类。</li>
<li><strong>私有方法</strong>：需要直接测试的私有方法逻辑。</li>
<li><strong>构造函数依赖</strong>：方法内部通过new创建的对象。</li>
<li><strong>静态代码块和系统类</strong>：如System.currentTimeMillis()。</li>
</ul>
<p>这些问题使用传统Mock框架难以解决，而PowerMock为此提供了完整的解决方案</p>
<h2 data-id="heading-4">环境配置与基本用法</h2>
<h3 data-id="heading-5">添加Maven依赖</h3>
<p>要开始使用PowerMock，首先需要在项目中添加相关依赖。由于PowerMock需要与Mockito协同工作，需要同时添加两个依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- PowerMock + Mockito 组合 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-module-junit4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-api-mockito2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>版本兼容性注意</strong>：确保PowerMock与Mockito/JUnit版本匹配，具体兼容性关系可参考官方文档。</p>
<h3 data-id="heading-6">基本配置注解</h3>
<p>使用PowerMock需要在测试类上添加必要的注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span> <span class="hljs-comment">// 必须使用PowerMockRunner</span>
<span class="hljs-meta">@PrepareForTest({StaticUtils.class, User.class})</span> <span class="hljs-comment">// 声明需增强的类</span>
<span class="hljs-meta">@PowerMockIgnore("javax.management.*")</span> <span class="hljs-comment">// 解决类加载器冲突</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {
    <span class="hljs-comment">// 测试内容</span>
}
</code></pre>
<ul>
<li><code>@RunWith(PowerMockRunner.class)</code>：告诉JUnit使用PowerMock的测试运行器。</li>
<li><code>@PrepareForTest</code>：指定需要被PowerMock修改的类（包含静态方法、final方法等的类）。</li>
<li><code>@PowerMockIgnore</code>：解决使用PowerMock后可能出现的类加载器冲突问题。</li>
</ul>
<h2 data-id="heading-7">PowerMock核心使用场景详解</h2>
<h3 data-id="heading-8">静态方法Mock</h3>
<p>静态方法是最常见的测试难点之一，让我们看看PowerMock如何解决这个问题。</p>
<p><strong>场景示例</strong>：假设我们有一个静态工具类，用于生成唯一ID：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdGenerator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateUniqueId</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 实际业务中可能包含复杂的逻辑或外部依赖</span>
        <span class="hljs-keyword">return</span> UUID.randomUUID().toString();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> IdGenerator.generateUniqueId();
        <span class="hljs-comment">// 创建订单的逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ORDER_"</span> + orderId;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({IdGenerator.class, OrderService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderWithStaticMock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 准备静态类的Mock</span>
        PowerMockito.mockStatic(IdGenerator.class);
        
        <span class="hljs-comment">// 2. 预设静态方法行为</span>
        PowerMockito.when(IdGenerator.generateUniqueId()).thenReturn(<span class="hljs-string">"123e4567"</span>);
        
        <span class="hljs-comment">// 3. 创建被测试对象并调用被测方法</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder();
        
        <span class="hljs-comment">// 4. 验证结果</span>
        assertEquals(<span class="hljs-string">"ORDER_123e4567"</span>, result);
        
        <span class="hljs-comment">// 5. 验证静态方法调用（必须调用）</span>
        PowerMockito.verifyStatic(IdGenerator.class);
        IdGenerator.generateUniqueId();
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>mockStatic()</code>方法用于告诉PowerMock要Mock哪个类的静态方法</li>
<li>静态方法的Stubbing（定义行为）与普通Mockito语法类似</li>
<li><strong>必须调用</strong><code>verifyStatic()</code>来验证静态方法的调用，且需要在验证前调用一次</li>
</ul>
<p><strong>常见坑点</strong>：忘记调用<code>verifyStatic()</code>会导致无法验证静态方法是否被正确调用。</p>
<h3 data-id="heading-9">私有方法Mock</h3>
<p>测试私有方法一直存在争议，但在某些场景下（如复杂算法验证）确实有必要直接测试私有方法。</p>
<p><strong>场景示例</strong>：一个包含复杂校验逻辑的UserService：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateUser</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-keyword">if</span> (!isValidFormat(username) || !isValidFormat(password)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> internalComplexValidation(username, password);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidFormat</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-comment">// 复杂的格式校验逻辑</span>
        <span class="hljs-keyword">return</span> input != <span class="hljs-literal">null</span> &amp;&amp; input.length() &gt;= <span class="hljs-number">5</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">internalComplexValidation</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-comment">// 非常复杂的内部校验逻辑</span>
        <span class="hljs-comment">// 可能涉及加密、数据库查询等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 简化示例</span>
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserService.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建被测类的Spy对象（部分真实调用）</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// 2. Stubbing：预设私有方法行为</span>
        PowerMockito.doReturn(<span class="hljs-literal">true</span>).when(spyService, <span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());

        <span class="hljs-comment">// 3. 调用被测方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"testuser"</span>, <span class="hljs-string">"testpass"</span>);

        <span class="hljs-comment">// 4. 验证结果</span>
        assertTrue(result);

        <span class="hljs-comment">// 5. 验证私有方法被调用（可选）</span>
        PowerMockito.verifyPrivate(spyService,Mockito.times(<span class="hljs-number">2</span>))
                .invoke(<span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethodWithArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// Mock有参数的私有方法</span>
        PowerMockito.doReturn(<span class="hljs-literal">false</span>)
                .when(spyService, <span class="hljs-string">"internalComplexValidation"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        assertFalse(result);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li>使用<code>spy()</code>方法创建对象，这样未被Mock的方法会保持真实行为。</li>
<li>使用<code>doReturn().when()</code>语法来Mock私有方法，需通过方法名字符串指定目标方法。</li>
<li>可以通过<code>verifyPrivate()</code>验证私有方法的调用。</li>
</ul>
<p><strong>最佳实践</strong>：优先通过公共方法测试私有逻辑，仅在复杂算法验证等特殊场景下直接测试私有方法。</p>
<h3 data-id="heading-10">final类与方法Mock</h3>
<p>final类和方法由于其不可继承性，在传统Mock框架中无法被Mock，但PowerMock完美解决了这个问题。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalUtility</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Final implementation"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">staticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Static final implementation"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">utility</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalUtility</span>();
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">useFinalClass</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> utility.finalMethod() + <span class="hljs-string">"_processed"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({FinalUtility.class, SomeService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFinalClassAndMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 创建final类的Mock对象</span>
        <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">mockUtility</span> <span class="hljs-operator">=</span> PowerMockito.mock(FinalUtility.class);
        
        <span class="hljs-comment">// 2. 预设final方法行为</span>
        PowerMockito.when(mockUtility.finalMethod()).thenReturn(<span class="hljs-string">"Mocked final"</span>);
        
        <span class="hljs-comment">// 3. 当创建真实对象时返回Mock对象</span>
        PowerMockito.whenNew(FinalUtility.class).withNoArguments().thenReturn(mockUtility);
        
        <span class="hljs-comment">// 4. 测试</span>
        <span class="hljs-type">SomeService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> service.useFinalClass();
        
        assertEquals(<span class="hljs-string">"Mocked final_processed"</span>, result);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStaticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Mock静态final方法</span>
        PowerMockito.mockStatic(FinalUtility.class);
        PowerMockito.when(FinalUtility.staticFinalMethod()).thenReturn(<span class="hljs-string">"Mocked static final"</span>);
        
        assertEquals(<span class="hljs-string">"Mocked static final"</span>, FinalUtility.staticFinalMethod());
    }
}
</code></pre>
<p><strong>底层原理</strong>：PowerMock通过修改字节码，去除了final方法的final标识符，从而允许Mock操作。</p>
<h3 data-id="heading-11">构造函数Mock</h3>
<p>当方法内部直接通过new创建对象时，传统Mock难以介入，PowerMock的构造函数Mock功能为此提供了解决方案。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
    <span class="hljs-keyword">private</span> String connectionString;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnection</span><span class="hljs-params">(String connectionString)</span> {
        <span class="hljs-built_in">this</span>.connectionString = connectionString;
        <span class="hljs-comment">// 可能包含复杂的初始化逻辑</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-comment">// 执行SQL逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 在方法内部直接创建依赖对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnection</span>(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
        <span class="hljs-keyword">return</span> connection.execute(<span class="hljs-string">"INSERT INTO users VALUES ('"</span> + username + <span class="hljs-string">"')"</span>);
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserRepository.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConstructorMock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建Mock对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">mockConnection</span> <span class="hljs-operator">=</span> PowerMockito.mock(DatabaseConnection.class);
        
        <span class="hljs-comment">// 2. 预设构造函数行为</span>
        PowerMockito.whenNew(DatabaseConnection.class)
                   .withParameterTypes(String.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>)
                   .thenReturn(mockConnection);
        
        <span class="hljs-comment">// 3. 预设方法行为</span>
        PowerMockito.when(mockConnection.execute(Mockito.anyString())).thenReturn(<span class="hljs-literal">true</span>);
        
        <span class="hljs-comment">// 4. 执行测试</span>
        <span class="hljs-type">UserRepository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRepository</span>();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> repository.saveUser(<span class="hljs-string">"testuser"</span>);
        
        <span class="hljs-comment">// 5. 验证</span>
        assertTrue(result);
        PowerMockito.verifyNew(DatabaseConnection.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>whenNew()</code>用于拦截构造函数调用。</li>
<li><code>withParameterTypes()</code>和<code>withArguments()</code>用于精确匹配构造函数。</li>
<li>需要使用<code>verifyNew()</code>验证构造函数调用。</li>
</ul>
<p><strong>应用场景</strong>：适用于测试遗留代码中在方法内部直接实例化依赖对象的情况。</p>
<h3 data-id="heading-12">静态代码块处理</h3>
<p>静态代码块在类加载时执行，可能包含不愿在测试中运行的代码（如初始化昂贵资源），PowerMock可以抑制静态代码块的执行。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoader</span> {
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 静态代码块，可能包含昂贵的初始化操作</span>
        loadConfigurationFromRemote();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadConfigurationFromRemote</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟昂贵的初始化</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不应该在测试中执行"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"value"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(ConfigurationLoader.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoaderTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuppressStaticInitializer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 抑制静态代码块执行</span>
        PowerMockito.suppress(PowerMockito.method(ConfigurationLoader.class, <span class="hljs-string">"loadConfigurationFromRemote"</span>));
        
        <span class="hljs-comment">// 现在可以安全测试，静态代码块不会执行</span>
        assertNotNull(ConfigurationLoader.getConfig(<span class="hljs-string">"testkey"</span>));
    }
}
</code></pre>
<h2 data-id="heading-13">PowerMock最佳实践与注意事项</h2>
<h3 data-id="heading-14">谨慎使用PowerMock</h3>
<p>虽然PowerMock功能强大，但过度使用可能是代码设计问题的信号。<strong>以下是一些使用原则</strong>：</p>
<ul>
<li><strong>优先考虑重构</strong>：如果代码中大量使用PowerMock，应该考虑重构代码以提高可测试性。例如，将静态方法改为实例方法，通过依赖注入解耦等。</li>
<li><strong>仅用于遗留代码</strong>：在新项目中，优先通过良好设计避免使用PowerMock，仅在处理难以修改的遗留代码时大量使用。</li>
<li><strong>隔离使用</strong>：将使用PowerMock的测试类单独放置，防止影响其他测试的执行效率。</li>
</ul>
<h3 data-id="heading-15">性能优化建议</h3>
<p>PowerMock由于使用自定义类加载器和字节码操作，会对测试执行时间产生显著影响。以下是一些优化建议：</p>
<ul>
<li><strong>最小化@PrepareForTest</strong>：只将确实需要Mock的类放入注解中，减少字节码操作的范围。</li>
<li><strong>合理使用Mockito</strong>：对于常规Mock场景，仍然使用Mockito，仅在必要时使用PowerMock。</li>
<li><strong>避免过度Mock</strong>：不要Mock系统类或简单值对象，这会给测试带来不必要的复杂性。</li>
</ul>
<h3 data-id="heading-16">版本选择与兼容性</h3>
<p><strong>版本兼容性</strong>：PowerMock与Mockito、JUnit的版本兼容性非常重要。以下是推荐组合：</p>
<ul>
<li>PowerMock 2.x + Mockito 2.x + JUnit 4.12+</li>
<li>避免混合使用不兼容的版本</li>
</ul>
<p><strong>JUnit 5支持</strong>：截至目前，PowerMock不支持JUnit 5，这是选择测试框架时需要考虑的因素。</p>
<h3 data-id="heading-17">常见问题排查</h3>
<p><strong>类加载器冲突</strong>：使用<code>@PowerMockIgnore</code>注解排除冲突的包。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PowerMockIgnore({"javax.management.*", "javax.net.ssl.*"})</span>
</code></pre>
<p><strong>版本冲突</strong>：确保所有Mock相关库的版本兼容。</p>
<p><strong>静态方法验证失败</strong>：记住每次验证静态方法调用时都要先调用<code>verifyStatic()</code>。</p>
<h2 data-id="heading-18">总结</h2>
<p>PowerMock解决了传统Mock框架无法处理的棘手问题。通过字节码操作技术，PowerMock能够Mock静态方法、final类、私有方法和构造函数等"不可Mock"的元素。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li>填补了Mockito的功能空白，完善了Java单元测试的工具链。</li>
<li>特别适用于处理遗留代码和第三方库的测试问题。</li>
<li>通过提高代码覆盖率来提升软件质量。</li>
</ul>
<p><strong>适用边界</strong>：</p>
<ul>
<li>不是所有场景都适合使用PowerMock，新项目应优先考虑良好的代码设计。</li>
<li>在测试性能和代码可维护性之间需要权衡。</li>
<li>建议将使用范围控制在确实必要的复杂场景中。</li>
</ul>
<p>希望本文能帮助你在实际项目中更好地使用PowerMock。如果你有任何问题或经验分享，欢迎在评论区留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅入理解流式SSR的性能收益与工作原理]]></title>    <link>https://juejin.cn/post/7575090551357407284</link>    <guid>https://juejin.cn/post/7575090551357407284</guid>    <pubDate>2025-11-23T04:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357407284" data-draft-id="7570912420568481802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅入理解流式SSR的性能收益与工作原理"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-11-23T04:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明远湖之鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2370998127573751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅入理解流式SSR的性能收益与工作原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2370998127573751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明远湖之鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T04:51:36.000Z" title="Sun Nov 23 2025 04:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是流式 SSR</h2>
<p>流式 SSR（Streaming Server-Side Rendering）是一种将服务端渲染和流式传输结合起来的技术。与传统的 SSR 不同，流式 SSR 可以在服务端渲染的同时，逐步将渲染结果传输到客户端，实现页面的渐进式展示。</p>
<p>在流式 SSR 中，服务端会根据客户端的请求，逐步生成页面内容，并将它们作为流式数据流式传输到客户端。客户端可以在接收到一部分数据后，就开始逐步显示页面，而不需要等待整个页面渲染完成。这种方式可以有效提高页面的加载速度和用户体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8d597f865b43c79abefb42c03ca09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=7%2BPppr%2BKU2I0Z%2BX22ELwntltuHU%3D" alt="20251111002406.jpg" loading="lazy"/>
(流式 SSR 的页面加载过程）</p>
<h2 data-id="heading-1">使用流式 SSR 的收益</h2>
<ul>
<li>
<p><strong>减少设备和网络情况的副作用</strong></p>
<p>这是 SSR 渲染模式相比于传统  CSR 渲染模式带来的优势，对于流式 SSR 应用同样适用。
CSR 渲染模式需要在终端设备上完成资源加载、数据加载以及整个渲染过程，受端侧设备自身 CPU 及网络性能影响大，如设备 CPU 性能不足或网络波动较大，则此时整个页面加载性能将严重下降，这也是为什么很多页面在高端设备上加载速度较快，但在低端设备上需要7-8秒的原因。</p>
<p>而 SSR 的渲染模式，则<strong>在服务端提供了高性能的渲染容器及网络环境，服务端的渲染，不受端侧设备 CPU 或网络影响，始终提供稳定的渲染性能表现</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba73baf6b12b44a0b7b6055b1c45b7fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=vYH5fhaZmJ1rFH8%2FPW4m4SNzkW0%3D" alt="fa9a1944-b6b4-4e22-980a-47bf604c2e2c.png" loading="lazy"/></p>
</li>
<li>
<p><strong>减少接口过慢对首屏性能的影响</strong></p>
<p>通常，页面会由多个区块组成，其中一些区块不依赖于数据，而其他区块可能依赖于快速或缓慢响应的接口。</p>
<p>现有 SSR 渲染模式存在的一个不足是，整个渲染过程是同步的，需要在页面渲染之前完成所有数据请求，并一次性返回整个页面的 HTML。如果页面的某些接口响应过慢，将会导致整个页面的响应时间过长。</p>
<p>流式渲染的最大好处在于它可以分块返回页面内容。例如，当请求进入时，它可以首先完成页面静态内容的渲染并响应给端侧进行渲染，等待其他依赖于数据的区块完成渲染后再分块返回。这样整个页面的渲染过程不再绑定在一起，而是一个异步的过程，先完成渲染的部分将先返回，从而优化了页面响应速度。</p>
</li>
<li>
<p><strong>提前资源的加载时机</strong></p>
<p>流式 SSR 相比传统 SSR 应用有另一个额外的收益是，由于 HTML 可以分块返回，页面的资源信息可以随第一个 HTML 片段一起下发，从而尽快开始加载。相比之下，在传统 SSR 应用中，资源信息必须等待整个 HTML 完成渲染后下发，请求开始的时机会受到渲染过程的阻塞。</p>
<p>采用流式 SSR，可以使资源请求和页面渲染过程并行进行，进一步提升了页面的性能表现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/262454a66ef1469789c973908bdfdf86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=pueQsCLST%2FVr2owHTM95M6HTlvU%3D" alt="752472f2-cf39-4c89-9738-e4ad3e084ba9.png" loading="lazy"/></p>
</li>
<li>
<p><strong>提升页面的可交互时间</strong></p>
<p>在 SSR 渲染模式下，将页面节点达到可交互状态的过程称为 Hydrate，它需要在端侧执行 JavaScript。</p>
<p>由于页面资源可以提前下发，并且 React 18 对 Hydrate 进行了异步化处理，在流式 SSR 应用中，可以进一步实现先渲染的页面先达到可交互状态的效果。对于部分首屏接口较慢的应用，这将进一步提升页面的可交互体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6d50f24ad84d6397f6b472e57ce551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=sxEYVIj6yhciBVEKqwOPNJXnz1c%3D" alt="20251111002828.jpg" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-2">基本工作原理</h2>
<p>流式 SSR 的实现，最基本的原理是：</p>
<ul>
<li>基于 HTTP 协议中的 chunked 编码规范，设置响应头的 Transfer-Encoding 为 chunked 对 HTML 内容进行分块传输。</li>
<li>在浏览器侧，流式地读取数据并进行渲染，这是主流浏览器默认支持的。</li>
</ul>
<p>结合 Node.js 内置的 HTTP 模块，实现一个最简单的流式 DEMO 示例如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Transfer-Encoding'</span>, <span class="hljs-string">'chunked'</span>)

  <span class="hljs-comment">// 分区块的传输页面内容</span>
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;html&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Stream Demo&lt;/title&gt;&lt;head&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;body&gt;'</span>);

  <span class="hljs-comment">// 模拟服务端暂停</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;h2&gt;Hello&lt;/h2&gt;'</span>);

  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;h2&gt;ICE 3&lt;/h2&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span>);
  res.<span class="hljs-title function_">end</span>();
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p>基于这个基本原理，将页面分为骨架屏和几个区块，并行地渲染这些区块，然后将渲染好的区块分段返回，就可以实现基本的流式 SSR 。</p>
<h2 data-id="heading-3">WebView 接收流式Chunk渲染的实现原理（iOS）</h2>
<h3 data-id="heading-4">核心组件</h3>
<p>iOS WebView 接收流式 Chunk 渲染基于 <strong>NSURLProtocol 拦截机制</strong> + <strong>NSURLProtocolClient 回调机制</strong> 实现。</p>
<p><strong>NSURLProtocol（请求拦截器）</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 拦截 WebView 的网络请求</span>
+ (<span class="hljs-variable constant_">BOOL</span>)<span class="hljs-attr">canInitWithRequest</span>:(<span class="hljs-title class_">NSURLRequest</span> *)request {
    <span class="hljs-keyword">return</span> [self <span class="hljs-attr">shouldInterceptRequest</span>:request];
}

- (<span class="hljs-keyword">void</span>)startLoading {
    <span class="hljs-comment">// 转发给自定义处理器</span>
    [[<span class="hljs-title class_">SSRHandler</span> shareInstance] <span class="hljs-attr">sendRequest</span>:self.<span class="hljs-property">request</span> <span class="hljs-attr">delegate</span>:self];
}
</code></pre>
<p><strong>NSURLProtocolClient（数据传递桥梁）</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 系统提供的协议，用于向 WebView 传递数据</span>
@protocol <span class="hljs-title class_">NSURLProtocolClient</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didReceiveResponse</span>:<span class="hljs-attr">cacheStoragePolicy</span>:;  <span class="hljs-comment">// 响应头</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didLoadData</span>:;                           <span class="hljs-comment">// 数据块（可多次）</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocolDidFinishLoading</span>:;                       <span class="hljs-comment">// 完成</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didFailWithError</span>:;                      <span class="hljs-comment">// 错误</span>
@end

</code></pre>
<h3 data-id="heading-5">渲染流程</h3>
<ul>
<li>
<p><strong>阶段一：请求拦截</strong></p>
<pre><code class="hljs language-objectivec" lang="objectivec">WebView 发起请求 → <span class="hljs-built_in">NSURLProtocol</span> 拦截 → 转发给 SSR 处理器
</code></pre>
</li>
<li>
<p><strong>阶段二：响应处理</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 返回响应头</span>
[<span class="hljs-meta">client URLProtocol:protocol didReceiveResponse:response cacheStoragePolicy:policy</span>];

<span class="hljs-comment">// 2. 流式返回数据（关键步骤）</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunk1</span>];  <span class="hljs-comment">// 第1块</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunk2</span>];  <span class="hljs-comment">// 第2块</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunkN</span>];  <span class="hljs-comment">// 第N块</span>

<span class="hljs-comment">// 3. 标记完成</span>
[<span class="hljs-meta">client URLProtocolDidFinishLoading:protocol</span>];
</code></pre>
</li>
<li>
<p><strong>阶段三：WebView 渲染</strong></p>
<pre><code class="hljs language-css" lang="css">每次 didLoadData 调用 → WebView 增量解析 <span class="hljs-selector-tag">HTML</span> → 实时渲染到页面
</code></pre>
</li>
</ul>
<p><strong>数据流图示如下</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   WebView   │───▶│NSURLProtocol │───▶│ SSR Handler │
│             │    │              │    │             │
│             │◀───│              │◀───│             │
└─────────────┘    └──────────────┘    └─────────────┘
       ▲                   │
       │                   ▼
   增量渲染          NSURLProtocolClient
       ▲                   │
       │                   ▼
   ┌─────────────────────────────┐
   │     didLoadData (chunk1)    │
   │     didLoadData (chunk2)    │
   │     didLoadData (chunkN)    │
   │  URLProtocolDidFinishLoading │
   └─────────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI上线插件系统]]></title>    <link>https://juejin.cn/post/7575090551357259828</link>    <guid>https://juejin.cn/post/7575090551357259828</guid>    <pubDate>2025-11-23T02:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357259828" data-draft-id="7575065455075868707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI上线插件系统"/> <meta itemprop="keywords" content="Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-23T02:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI上线插件系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T02:41:40.000Z" title="Sun Nov 23 2025 02:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>小伙伴们大家好，我是小溪，见字如面。在不久前Gemini CLI终于上线了插件系统，终于开始缓慢追赶Claude Code CLI的脚步了，至此我们也终于可以使用大佬们的插件，共享我们的插件了。</p>
<p>Gemini CLI更新日志：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli%2Fblob%2Fmain%2Fdocs%2Fchangelogs%2Findex.md" target="_blank" title="https://github.com/google-gemini/gemini-cli/blob/main/docs/changelogs/index.md" ref="nofollow noopener noreferrer">github.com/google-gemi…</a></p>
<p>对往期内容感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493269%26idx%3D1%26sn%3D4775c90a4fab04126502bf79b0f75d70%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493269&amp;idx=1&amp;sn=4775c90a4fab04126502bf79b0f75d70&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code上线插件系统，AI编程模式再次升级</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>Gemini CLI：0.13.0</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>插件系统目前支持打包 MCP、上下文文件 和 自定义命令 3种配置</li>
</ul>
<h2 data-id="heading-3">Gemini CLI Extension简介</h2>
<p>Gemini CLI围绕Extension扩展构建了插件系统，它可以将 MCP服务、上下文文件 以及 自定义命令 打包成一个简单软件包，当软件包被安装到 Gemini CLI 中就可以让 Gemini 使用各种工具。Gemini CLI Extension目前已有100多款插件，包含 Context7、Nano Banana等爆火的插件。</p>
<p>Gemini CLI Extension官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fextensions%2F" target="_blank" title="https://geminicli.com/extensions/" ref="nofollow noopener noreferrer">geminicli.com/extensions/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d246f5ba07de4ac6ae1cb97fd12302ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=rurl4xfGTOtgfKS8rkUN8kMiTdM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">基本使用</h2>
<h3 data-id="heading-5">CLI命令</h3>
<p>Gemini CLI命令行工提供了一系列extension的管理命令，在命令行直接输入 gemini extensions -h 可以查看extensions所有命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8671fbd4474b21b5f510f1ff54cb16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=wjTFEFwu8IscF30U8Rtx1zAfjM8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>install：从Git仓库或者本地路径安装插件</li>
<li>uninstall：卸载指定名称的插件</li>
<li>list：查看当前安装的插件</li>
<li>update：更新所有或者指定插件</li>
<li>disable：禁用插件</li>
<li>enable：启用插件</li>
<li>link：从本地路径链接一个插件</li>
<li>new：从模板创建一个插件</li>
<li>validate：从本地路径验证一个插件</li>
</ul>
<h3 data-id="heading-6">安装插件</h3>
<p>在Gemini CLI Extension平台查找自己需要的插件，这里我以 Nano Banana 为例</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f4ff65187c4d16b746f0d970e2eba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=lPmT7v9IHEJoko%2FpCRouaJjH5gQ%3D" alt="图片" loading="lazy"/></p>
<p>点击查看详情，复制Extension安装命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5972dbc44b16490e889588c1a869dabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=MoDU%2FpbNxC6ZJRybpyM6Sm1FWoI%3D" alt="图片" loading="lazy"/></p>
<p>完整命令如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions install https:<span class="hljs-comment">//github.com/gemini-cli-extensions/nanobanana</span>
</code></pre>
<p>在命令行终端执行安装命令，遇到权限问题，根据提示选择允许</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/905cd9c1e8b1459ba0f882b8dda1a16b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=GebYB7JGEyYVTzDRzt1qEi5e3L4%3D" alt="图片" loading="lazy"/></p>
<p>详细信息可以在 ~/.gemini/extensions中查看</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87038fd5b39c4105ae172044022fdf64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=o6rluLofC2vPr7Wfo4hzxNm5Pho%3D" alt="图片" loading="lazy"/></p>
<p>启动Gemini CLI，在交互式命令中输入以下命令查看以已安装的插件</p>
<pre><code class="hljs language-bash" lang="bash">/extensions list
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf27479daaa46f88018cffd5a9e2cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=odWIO1OWHRiknlA0x50UUDBtia4%3D" alt="图片" loading="lazy"/></p>
<p>然后在Gemini CLI中就可以查看 Nano Banana 提供的MCP和自定义命令了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e7a14fb2341471fa7cf0b5b0b7c0b2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=LVI2fe2dA3dtTAHuL7tq3QJsMkk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb889d18a5934b1281f07d40670953fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=tabr69hUeKitMWbmXa7%2BUxy63ec%3D" alt="图片" loading="lazy"/></p>
<p>Nano Banana指令：</p>
<ul>
<li>/generate：单张或多张带有风格 / 变体选项的图像生成</li>
<li>/edit：图像编辑</li>
<li>/restore：图像修复</li>
<li>/icon：生成多种尺寸的应用图标、网站图标和 UI 元素</li>
<li>/pattern：生成用于背景的无缝图案和纹理</li>
<li>/story：生成讲述视觉故事或流程的连续图像</li>
<li>/diagram：生成技术图表、流程图和建筑模型图</li>
<li>/nanobanana：使用自然语言生成或处理图片</li>
</ul>
<h3 data-id="heading-7">插件使用</h3>
<p>以 Nano Banana 为例，我们可以使用模型推理自行调用</p>
<pre><code class="hljs language-bash" lang="bash">我正在创办一家名为 “Kicks” 的鞋业公司，你能帮我设计一个视觉上有吸引力的icon/logo
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/740117f8bf4b4cfa825b7aa7c122253c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=u36Q0WwdmXixT8KtjuhNHZ6WkSo%3D" alt="图片" loading="lazy"/></p>
<p>也可以使用 Nano Banana 提供的MCP和自定义命令调用，Nano Banana 调用目前不报错，可以不用理会</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d759aaf4066474eaea35aeb5d5ee567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=BLzS%2BZoRniXFwbdt6PPgPi2P5mQ%3D" alt="图片" loading="lazy"/></p>
<p>再以 Chrome Devtools MCP为例，输入命令进行安装</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions install https://github.com/ChromeDevTools/chrome-devtools-mcp</span>
</code></pre>
<p>安装完成后重启Gemini CLI，在交互式命令中输入 /mcp，可以看到刚刚通过插件安装的 chrome-devtools MCP服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19c7dab6f8534a478ac64b4321ba76f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=RApYmPpN1KZyagMS%2Bng%2BZ2iijVg%3D" alt="图片" loading="lazy"/></p>
<p>输入提示词即可使用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6687296803e74c54be20db4dacd23c75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=21O9FZQnT2tUBzIye1onoa4Tssw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">管理插件</h3>
<p>Gemini CLI提供了 交互命令 和 CLI命令 2种管理插件的方式</p>
<h4 data-id="heading-9">1）交互命令</h4>
<p>在交互式命令中输入 /extensions 可以查看插件系统提供的管理命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1af79fa5790b4d70bbf4b96f1a08d612~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=iibIBKL6wV%2B%2BAt1oqlimly0R2lE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>list：列出活跃的扩展程序</li>
<li>update：更新扩展程序</li>
<li>explore：在浏览器中打开扩展程序页面</li>
</ul>
<p>使用 /extensions list 可以查看所有安装的插件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91bbbc1c7b794764a530ffc9aeec6f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=ljLzjDqT0jb1UZKBPXeLfZtFOTI%3D" alt="图片" loading="lazy"/></p>
<p>使用 /extensions update 可以更新所有插件或者更新指定插件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b6b777b9e24ace8e971644cd41121a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=LfEyanJJyMW2gLLHRiHFAKPQ%2B8c%3D" alt="图片" loading="lazy"/></p>
<p>使用 /extensions explore 会打开Gemini CLI Extensions官网。</p>
<h3 data-id="heading-10">2）CLI命令</h3>
<p>使用 gemini extensions list 可以查看详细的插件信息，包括 插件路径、来源、版本、启用禁用状态、提供的功能 等信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514266ca58da45a6b947519aec07ead1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=YBxeQ5xV0JT1egSkNPECy6X0eIE%3D" alt="图片" loading="lazy"/></p>
<p>使用 gemini extensions uninstall 可卸载插件</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions uninstall nanobanana
</code></pre>
<p>使用 gemini extensions update 可更新插件</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 更新指定插件</span>
<span class="hljs-variable">$ gemini</span> extensions update nanobanana
<span class="hljs-comment"># 更新所有插件</span>
<span class="hljs-variable">$ gemini</span> extensions update --all
</code></pre>
<p>使用 gemini extensions enable|disable 可启用禁用插件，本人尝试的不起作用</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"> 禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> nanobanana</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> 全局禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> --scope user nanobanana</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> 项目禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> --scope project nanobanana</span>
</code></pre>
<h2 data-id="heading-11">自定义插件</h2>
<h3 data-id="heading-12">创建插件模板</h3>
<p>Gemini CLI提供了创建插件命令，命令格式如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">$ gemini extensions <span class="hljs-keyword">new</span> [<span class="hljs-keyword">template</span>]
</code></pre>
<ul>
<li>path：插件的路径</li>
<li>template：模版类型，可选值："context"、"custom-commands"、"exclude-tools"、"mcp-server"</li>
</ul>
<p>接着创建我们的第一个自定义插件项目，我这里在工作区路径，直接在当前工作区项目同级目录创建自定义插件项目了</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions <span class="hljs-keyword">new</span> ../my-first-extension mcp-server
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cefbdf0ba1aa496dbad83f39f88f569d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=dI0W7bzN3LeenPVoR%2BGmvtAm7vQ%3D" alt="图片" loading="lazy"/></p>
<p>创建完成后，可以看到目录结构如下，其实就是创建了一个带有Gemini CLI插件配置文件 gemini-extension.json 的NodeJS项目</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4d5645477d42f998715308d68ab548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=CfUE0cr2MObtcAipQwvJcK4nkR0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84ed6cf7f1b4427093799d44774f6133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=C8vYqULFohS3s3qImQtsfefjguU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">插件配置文件</h3>
<p>Gemini CLI自定义插件配置文件为 gemini-extension.json，一个完整的自定义插件配置如下：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"&lt;插件名称&gt;"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"&lt;插件版本&gt;"</span>,
  <span class="hljs-string">"contextFileName"</span>: <span class="hljs-string">"&lt;上下文文件&gt;"</span>,
  <span class="hljs-string">"excludeTools"</span>: [<span class="hljs-string">"run_shell_command"</span>]
  <span class="hljs-string">"mcpServers"</span>: { <span class="hljs-comment"># MCP配置</span>
    <span class="hljs-string">"nodeServer"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"node"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span><span class="hljs-variable">${/}</span>dist<span class="hljs-variable">${/}</span>example.js"</span>],
      <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span>"</span>
    }
  }
}
</code></pre>
<ul>
<li>name ：扩展程序的名称</li>
<li>version ：扩展程序的版本</li>
<li>mcpServers ：MCP 服务配置，如果扩展程序和 settings.json 文件都配置了同名的MCP服务器，则 settings.json 文件中定义的服务器优先
<ul>
<li>command：脚本运行的核心命令</li>
<li>args：脚本运行的参数数组</li>
<li>cwd：脚本运行时的工作目录</li>
</ul>
</li>
<li>contextFileName ：包含扩展上下文的文件的名称</li>
<li>excludeTools ：要从模型中排除的工具名称数组，例如： "excludeTools": ["run_shell_command(rm -rf)"] 将阻止 rm -rf 命令</li>
</ul>
<h3 data-id="heading-14">自定义MCP服务</h3>
<p>上面 mcp-server 命令创建的模板已经自带了一个MCP服务示例，示例代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">McpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/mcp.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/stdio.js'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'prompt-server'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
});
server.<span class="hljs-title function_">registerTool</span>(
  <span class="hljs-string">'fetch_posts'</span>,
  {
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Fetches a list of posts from a public API.'</span>,
    <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-title function_">object</span>({}).<span class="hljs-property">shape</span>,
  },
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> apiResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
      <span class="hljs-string">'https://jsonplaceholder.typicode.com/posts'</span>,
    );
    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> apiResponse.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">const</span> response = { <span class="hljs-attr">posts</span>: posts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>) };
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response),
        },
      ],
    };
  },
);
server.<span class="hljs-title function_">registerPrompt</span>(
  <span class="hljs-string">'poem-writer'</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Poem Writer'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Write a nice haiku'</span>,
    <span class="hljs-attr">argsSchema</span>: { <span class="hljs-attr">title</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">mood</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>() },
  },
  <span class="hljs-function">(<span class="hljs-params">{ title, mood }</span>) =&gt;</span> ({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">text</span>: <span class="hljs-string">`Write a haiku<span class="hljs-subst">${mood ? <span class="hljs-string">` with the mood <span class="hljs-subst">${mood}</span>`</span> : <span class="hljs-string">''</span>}</span> called <span class="hljs-subst">${title}</span>. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `</span>,
        },
      },
    ],
  }),
);
<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioServerTransport</span>();
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
</code></pre>
<p>修改 package.json 配置文件，添加MCP调试代码配置</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"mcp-server-example"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Example MCP Server for Gemini CLI Extension"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"example.js"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"npx -y @modelcontextprotocol/inspector node dist/example.js"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsc"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"typescript"</span>: <span class="hljs-string">"~5.4.5"</span>,
    <span class="hljs-string">"@types/node"</span>: <span class="hljs-string">"^20.11.25"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@modelcontextprotocol/sdk"</span>: <span class="hljs-string">"^1.11.0"</span>,
    <span class="hljs-string">"zod"</span>: <span class="hljs-string">"^3.22.4"</span>
  }
}
</code></pre>
<p>执行 npm run build 编译TS，然后执行下面命令启动MCP调试服务</p>
<pre><code class="hljs language-arduino" lang="arduino">$ npm run dev
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8bfb779192143e3a53e0ede25e654db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=eLcugDuILB8Y1M1Wf07Eue1WVAo%3D" alt="图片" loading="lazy"/></p>
<p>服务启动完成，点击调试服务链接在浏览器中打开</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fc42ecabc24db8bac3d52386c1f55f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=Wr%2FEl9iuACv%2FnlxZaGkIUUBRrPE%3D" alt="图片" loading="lazy"/></p>
<p>点击【Connect】连接本地MCP服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84b8b78995644813b621502714c152bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=26u8KzKqtxi%2BpuAerAJwxJ58564%3D" alt="图片" loading="lazy"/></p>
<p>选择【Tools】测试一下MCP服务是否正常</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b5bb12989f44ee8a329b4cee3077c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=HZ87nWfPuf7JIO9C7RMPJxtDbKg%3D" alt="图片" loading="lazy"/></p>
<p>无误后，使用 gemini extensions validate 验证一下插件的有效性</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions validate ../my-first-extension</span> 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fcedd53d9c74ea6a67d00ee78cb5ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=IqC72CEPBTE%2ByVjrsN3vLUjwFVE%3D" alt="图片" loading="lazy"/></p>
<p>验证成功后即可使用 gemini extensions install 安装，也可以使用 gemini extensions link 进行符号链接（符号链接的好处就是任何更改都会立即生效，无需重新安装），我这里使用 gemini extensions link 演示</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">link</span> ../my-first-extension</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05fbe5d6728e4c2c8fc29f0ade71b905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=VdFBTmiR6zYPJzYbYWRvYzjlC3g%3D" alt="图片" loading="lazy"/></p>
<p>安装或者链接成功后，就可以使用 gemini extensions list 查看到我们自定义的插件了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fd5c047a42440b790db067598dbdc6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=yaWk3ZCVC1QwBk0ZaXwBSw4B%2BIY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-15">自定义上下文</h3>
<p>在自定义插件目录新建一个 GEMINI.md 目录用于存放自定义上下文内容</p>
<pre><code class="hljs language-sql" lang="sql"># My <span class="hljs-keyword">First</span> Extension Instructions
You <span class="hljs-keyword">are</span> an expert developer assistant. <span class="hljs-keyword">When</span> the <span class="hljs-keyword">user</span> asks you <span class="hljs-keyword">to</span> <span class="hljs-keyword">fetch</span>
posts, use the `fetch_posts` tool. Be concise <span class="hljs-keyword">in</span> your responses.
</code></pre>
<p>配置完成后，更新 gemini-extension.json 文件，指定 contextFileName 属性</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"mcp-server-example"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"mcpServers"</span>: {
    <span class="hljs-string">"nodeServer"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"node"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span><span class="hljs-variable">${/}</span>dist<span class="hljs-variable">${/}</span>example.js"</span>],
      <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span>"</span>
    }
  },
  <span class="hljs-string">"contextFileName"</span>: <span class="hljs-string">"GEMINI.md"</span>
}
</code></pre>
<p>使用 gemini extensions list 可以看到刚刚添加的上下文信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989dbf3af30e48658289cb9d6635a1ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=H7OX6EWlJ%2FWuWpn48Euec%2FXaLK4%3D" alt="图片" loading="lazy"/></p>
<p>启动Gemini CLI，在交互式命令中输入 /memory show 可以查看具体的上下文内容，此时已经包含了自定义插件中的上下文了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e232a1afa7c43099a851609e39b3680~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=r7IN4dHTtHySeGKv%2FbVBqAR%2B0ps%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-16">自定义命令</h3>
<p>在自定义插件目录新建一个 commands目录用于存放自定义命令，自定义命令文档可以查看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fdocs%2Fcli%2Fcustom-commands%2F" target="_blank" title="https://geminicli.com/docs/cli/custom-commands/" ref="nofollow noopener noreferrer">geminicli.com/docs/cli/cu…</a></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">mkdir</span> commands</span>
</code></pre>
<p>创建一个 hello.toml 文件用于第一个自定义命令，并配置命令</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = <span class="hljs-string">"输出礼貌问候语并以`*_*`开始"</span>
</code></pre>
<p>再创建一个 fs 子命令目录，创建一个 grep-code.toml 文件</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">mkdir</span> fs</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">touch</span> fs/grep-code.toml</span>
</code></pre>
<p>输入提示词保存</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = <span class="hljs-string">"""
Please summarize the findings for the pattern `{{args}}`.
Search Results:
!{grep -r {{args}} .}
"""</span>
</code></pre>
<p>目录结构如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de56e5d05b094e559fd0860525d72a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=t%2BYnRwxJ0EGIyfI0TFvIll1qoTQ%3D" alt="图片" loading="lazy"/></p>
<p>重启Gemini CLI，在交互式命令中输入 / 在命令列表看到自定义的命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7226eb98111646a984318676230c2a10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=qjwQFJAgbvr%2Bax%2FzAg0G32XyLRU%3D" alt="图片" loading="lazy"/></p>
<p>直接调用自定义命令即可执行</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d17ed400dc4f6b9ddfc50f88e61c76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=Qu3rcr7yyuRKrBUo%2B6VRvIu%2FnpU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17">常见问题</h2>
<h3 data-id="heading-18">MCP授权失败</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15369c7ac7f24f50b0f94e424a5dc76a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=lZrISKLZvZrQcXdUfhqkFQ2QCkw%3D" alt="图片" loading="lazy"/></p>
<p>根据提示可知，调用 Nano Banana MCP 需要导出API Key，Github上也有对应的描述</p>
<p>Nano Banana Github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgemini-cli-extensions%2Fnanobanana" target="_blank" title="https://github.com/gemini-cli-extensions/nanobanana" ref="nofollow noopener noreferrer">github.com/gemini-cli-…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d162f09c850e4fb5b948a8c741e0f55e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=C0UwU2kFApwxnZb51WgOBcXVF90%3D" alt="图片" loading="lazy"/></p>
<p>我使用的是Gemini API Key，在命令行终端导出 GEMINI_API_KEY</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">GEMINI_API_KEY</span>=your api key
</code></pre>
<h3 data-id="heading-19">MCP调用失败</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/762b851b4f9f4f2ba6047a3b0cc7dd41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=uv%2BgkmOqSvfk5F096neBRyj%2B08c%3D" alt="图片" loading="lazy"/></p>
<p>Nano Banana调用尚有问题，Github Issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgemini-cli-extensions%2Fnanobanana%2Fissues%2F18" target="_blank" title="https://github.com/gemini-cli-extensions/nanobanana/issues/18" ref="nofollow noopener noreferrer">github.com/gemini-cli-…</a></p>
<h2 data-id="heading-20">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2FQZb3T5ogImCFAEX8oi4xLw" target="_blank" title="https%3A//mp.weixin.qq.com/s/QZb3T5ogImCFAEX8oi4xLw" ref="nofollow noopener noreferrer">Gemini CLI上线插件系统</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2FQZb3T5ogImCFAEX8oi4xLw" target="_blank" title="https%3A//mp.weixin.qq.com/s/QZb3T5ogImCFAEX8oi4xLw" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[URL解码踩坑记录]]></title>    <link>https://juejin.cn/post/7575897635137503232</link>    <guid>https://juejin.cn/post/7575897635137503232</guid>    <pubDate>2025-11-24T10:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635137503232" data-draft-id="7576086446459781155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="URL解码踩坑记录"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-11-24T10:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oriental"/> <meta itemprop="url" content="https://juejin.cn/user/2711816846968536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            URL解码踩坑记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2711816846968536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oriental
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:26:25.000Z" title="Mon Nov 24 2025 10:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>引言</strong></p>
</blockquote>
<p>最近有在对接OAuth相关的工作，今天新写了一个接口用于请求回调地址，但一直显示有问题，于是就有了今天这篇文章</p>
<h5 data-id="heading-0">问题起因</h5>
<p>在访问后端接口时，发现返回的一直是 <code>500</code>，返回的data数据为 <code>null</code>，无法正常返回 <code>LinkUrl(跳转地址)</code></p>
<h5 data-id="heading-1">解决思路</h5>
<p><strong>接口验证</strong>
首先拿上接口的调用参数进行接口的请求验证，我的接口提供（重点就在这）</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">type:</span> <span class="hljs-keyword">GET</span>
<span class="hljs-symbol">param:</span> authUrl
<span class="hljs-symbol">return:</span> 
{
	code: int,
	data: <span class="hljs-type">string</span>,
	msg: <span class="hljs-type">string</span>
}
</code></pre>
<p>于是我开始了漫长的 <code>url</code>比对，发现 <code>url</code>确实存在出入，于是告诉前端同学对 <code>url</code>进行变更，但依旧是没有解决问题</p>
<p><strong>本地测试</strong>
我开始拿着参数对本地的接口开启测试，使用 <code>ApiFox</code>进行测试，发现可以正常调用，且返回了对应的 <code>LinkUrl</code>，我的代码逻辑是获取到前端提供的 <code>authUrl</code>然后去请求第三方的平台获取到 <code>LinkUrl</code>，于是我又比对了我本地和 <code>dev</code>环境的代码差异，发现代码依旧是一致，前端同学是直接调用的 <code>dev</code>的后端代码，于是我想是不是对我们设置的回调地址做了限制，因为我们之前是做了备案的，于是将前端同学代码发布至 <code>dev</code>环境后测试发现依旧行不通</p>
<p><strong>日志观察</strong>
这个时候只能去看一下日志的情况是什么样子，因为我本地根本复现不出调用异常情况，发现日志中有这么一段</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-number">400</span> Bad <span class="hljs-built_in">Request</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">GET</span> <span class="hljs-built_in">request</span> <span class="hljs-keyword">for</span> XXXX(地址)
redirectURI must be a URL address
</code></pre>
<p>直到现在我依旧认为我的地址出现了问题，所以很长时间陷入对重定向的地址的问题排查</p>
<p><strong>地址比对</strong>
很长时间没有结果后，我依旧想着可不可以在本地去复现这个问题，于是我拿着 <code>dev</code>环境的请求参数去请求我本地，终于让我复现出来了， 接下来就是分析我请求成功和不成功的传参。</p>
<p>刚开始依旧认为传参是一致，还不停的去找地址中是不是有什么区别，后来终于让我发现了问题，两个不同的 <code>url</code>地址下</p>
<pre><code class="hljs language-bash" lang="bash">(可以正常请求)
curl <span class="hljs-string">'https://my.test.com/auth?authUrl=https//authentication.com?redirectURI=https%3a%2f%2fmy.test.com%2fcallback&amp;source=PC_Browser&amp;lang=zh-HK&amp;brokerpage=xxxx'</span>

(不可以正常请求)
curl <span class="hljs-string">'https://my.test.com/auth?authUrl=https%2f%2fauthentication.com%3fredirectURI%3dhttps%253a%252f%252fmy.test.com%252fcallback%26source%3dPC_Browser%26lang%3dzh-HK%26brokerpage%3dxxxx'</span>
</code></pre>
<p><strong>真相</strong>
下面这个不可以正常请求的 <code>url编码</code>了两次，总所周知 <code>Tomcat</code>的 <code>Servlet</code>会对正常的 <code>Http</code>进行 <code>url编码</code>，但下面的这个错误的传参 <code>url编码</code>了两次，所以导致后端在使用 <code>RestTemplate</code>进行请求的时候发生了上述报错，导致没有办法正常请求。</p>
<p>至于我为什么这么简单的问题没有发现，有各种因素，包括前端给我的 <code>param</code>也都是解码之后的，所以我刚开始一直测试没有问题，知道后来对比才发现问题</p>
<blockquote>
<p>结语</p>
</blockquote>
<p>其实代码问题的排查也比较简单，就是一个细心成都，如果我能早一点直接拿着控制台中 <code>netWork</code>进行直接对比，不要相信任何开发人员的一面之词。自己给自己算是下约定了，以后再也不会用 <code>Get</code>方式进行地址的传参，确实有很多的坑</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[120行代码，实现丝滑滚动的时间轴组件]]></title>    <link>https://juejin.cn/post/7576108254603919403</link>    <guid>https://juejin.cn/post/7576108254603919403</guid>    <pubDate>2025-11-24T10:30:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576108254603919403" data-draft-id="7574382900860534811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="120行代码，实现丝滑滚动的时间轴组件"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T10:30:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="你不会困"/> <meta itemprop="url" content="https://juejin.cn/user/3664010809185870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            120行代码，实现丝滑滚动的时间轴组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3664010809185870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    你不会困
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:30:23.000Z" title="Mon Nov 24 2025 10:30:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>产品又看见一个非常高级的时间轴页面交互（对于前端来说，实现不难，主要是花时间），我们尝试一下让Trae 的solo来实现，最简洁的代码实现，尽可能的描述一下细节，这样才可以最准确的实现，少走弯路，不浪费我们宝贵的时间（有这时间多看几篇技术文章，不香？啊哈哈哈）</p>
<p>首先先搭建好一个项目，这里使用的是vite+vue3+ts，然后是对应的安装tailwind css，这些都是让Trae solo模式帮我们搭建一下，我们就不用从0搭建了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca500463503a40f9b58e50368ac65ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=3vIINtvCM3wuZXyw3V1c12S5f5A%3D" alt="image-20251120152839739" loading="lazy"/></p>
<p>先来看看最终的效果实现，你很难相信这是一次对话就实现的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78cffe10028c4997a0eec286fa17e72d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=8SzC7f0fRhmMf2MauAsJ1mmg6Lw%3D" alt="image.png" loading="lazy"/>
一.首先是描述细节</p>
<p>1.时间轴的中间是可以滚动的，然后要根据鼠标进行滚动，不要滚动条</p>
<p>2.奇数是在上面，时间轴的连接线比较长，偶数是在下面，连接线比较短</p>
<p>3.箭头在右下角固定，保证用户知道这个是时间轴</p>
<p>4.卡片最大宽度是240px，超出隐藏</p>
<p>5.线和卡片中间使用倒三角连接起来</p>
<p>附加上一张ui设计的截图，就可以开始提问了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ecda26416c641e296b8ca331961f328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=zXJVEYTDh9eWwH7hq9o0dOj5NYw%3D" alt="image.png" loading="lazy"/></p>
<p>等待了一会，就实现了</p>
<p>来看看代码，119行就实现了，看起来确实优雅，解读一下代码trae solo是如何实现这个组件的</p>
<p>1.卡片（奇偶项交错，下移以视觉区分）,使用tailwind的<code>mt-[210px]</code>,</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"relative max-w-[230px] overflow-hidden rounded-lg bg-[#1D2129] shadow-lg"</span>
          <span class="hljs-attr">:class</span>=<span class="hljs-string">"i % 2 !== 0 ? 'mt-[210px]' : ''"</span>
        &gt;</span>
          <span class="hljs-comment">&lt;!-- 卡片头部：深色背景 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-between px-3 py-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-sm font-medium text-white"</span>&gt;</span>共7条<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cursor-pointer text-xs text-white"</span>&gt;</span>全部&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
​
          <span class="hljs-comment">&lt;!-- 卡片内容：两张图片并排 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex gap-2 overflow-hidden p-3"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>2.底部小三角形指示器,有没有勾起你当时学前端的回忆，那道经典的面试题的，你是怎么实现一个三角形的</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">border</span>-x-<span class="hljs-selector-attr">[12px]</span> <span class="hljs-attribute">border</span>-t-<span class="hljs-selector-attr">[12px]</span> <span class="hljs-attribute">border</span>-<span class="hljs-selector-attr">[#1D2129]</span> <span class="hljs-attribute">border</span>-x-transparent" /&gt;
</code></pre>
<p>3.竖线：奇数项加长（视觉第1、3、5项）,使用tailwind的h-[310px]和h-[101px]来实现连接线的长短</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">div</span>
          <span class="hljs-selector-tag">class</span>="<span class="hljs-selector-tag">w-</span><span class="hljs-selector-attr">[2px]</span>" :<span class="hljs-selector-tag">class</span>="<span class="hljs-selector-attr">[            isCreation ? <span class="hljs-string">'bg-blue-500'</span> : <span class="hljs-string">'bg-[#685FE1]'</span>,            i % 2 === 0 ? <span class="hljs-string">'h-[310px]'</span> : <span class="hljs-string">'h-[101px]'</span>,          ]</span>"
        /&gt;
</code></pre>
<p>4.底部圆点的实现，也是使用一个div来实现的</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">div</span>
    <span class="hljs-selector-tag">class</span>="<span class="hljs-selector-tag">z-10</span> <span class="hljs-selector-tag">size-4</span> <span class="hljs-selector-tag">rounded-full</span> <span class="hljs-selector-tag">border-</span><span class="hljs-selector-attr">[3px]</span> <span class="hljs-selector-tag">bg-white</span>" :<span class="hljs-selector-tag">class</span>="<span class="hljs-selector-attr">[    isCreation ? <span class="hljs-string">'border-blue-500'</span> : <span class="hljs-string">'border-[#685FE1]'</span>,    ]</span>"
/&gt;
</code></pre>
<p>5.底部横向主线（黑色）贯穿整个容器</p>
<pre><code class="hljs language-scss" lang="scss">&lt;<span class="hljs-selector-tag">div</span> class="absolute inset-x-<span class="hljs-number">0</span> <span class="hljs-attribute">bottom</span>-<span class="hljs-selector-attr">[35px]</span> h-<span class="hljs-selector-attr">[2px]</span> bg-black"/&gt;
</code></pre>
<p>6.底部时间轴右侧箭头（固定在轴线右端，靠内边距 <code>right-[-11px]</code> 可调）</p>
<pre><code class="hljs language-js" lang="js">  &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"pointer-events-none absolute bottom-[56px] right-[-11px] z-[999]"</span>&gt;
    &lt;!-- 向右的箭头 <span class="hljs-variable constant_">SVG</span>，样式可改 --&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"size-6 text-black"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M5 12h13"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"1.6"</span> <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M13 5l7 7-7 7"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"1.6"</span> <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span>
  &lt;/div&gt;
</code></pre>
<p>关键代码，通过监听鼠标滚轮来实现横向滚动的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = scrollRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (!el)
    <span class="hljs-keyword">return</span>
  <span class="hljs-comment">// 鼠标滚轮横向滚动</span>
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'wheel'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(e.<span class="hljs-property">deltaY</span>) &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(e.<span class="hljs-property">deltaX</span>)) {
      e.<span class="hljs-title function_">preventDefault</span>()
      el.<span class="hljs-property">scrollLeft</span> += e.<span class="hljs-property">deltaY</span>
    }
  })
})
</code></pre>
<p>来看看代码行数，确实很惊艳，简单的119行就实现了
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6303e58a360847b2828883e9c1fae9eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=QT7ClFT1eVp7U2p58oDmgusfiq8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">总结</h2>
<p>trae的solo确实比之前好很多，也惊艳到我了，前端可真是越来越难了，以后的时间排期也会进一步的压缩了，还是要适当的使用ai来辅助我们的编程，把一些比较容易实现的，耗时间的工作交给ai去实现，我们专注于一些工程化和架构上面去，也可以适当学一些node项目，提高我们自己的核心竞争力,加油吧，前端工程师们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🗣️面试官： 那些常见的前端面试场景问题]]></title>    <link>https://juejin.cn/post/7576052677051449370</link>    <guid>https://juejin.cn/post/7576052677051449370</guid>    <pubDate>2025-11-24T10:30:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677051449370" data-draft-id="7569566666528768040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🗣️面试官： 那些常见的前端面试场景问题"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-24T10:30:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="原来是小仙女呀"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846362055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🗣️面试官： 那些常见的前端面试场景问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846362055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    原来是小仙女呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:30:33.000Z" title="Mon Nov 24 2025 10:30:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 页面白屏如何排查？</h2>
<p><strong>第一步：快速分类（30秒）</strong> "页面白屏主要有五种原因：JavaScript执行错误、资源加载失败、CSS样式问题、接口异常和浏览器兼容性。其中JavaScript错误最常见，特别是SPA应用中的未捕获异常。"</p>
<p><strong>第二步：排查方法（1分钟）</strong> "我的排查步骤是：首先查看Console面板的错误信息，这能快速定位JS异常；然后检查Network面板确认资源加载状态；接着用Elements面板验证DOM和样式；移动端问题会用vConsole或真机调试。生产环境结合Sentry等监控系统分析。"</p>
<p><strong>第三步：预防措施（30秒）</strong> "预防方面建立错误边界、资源容错机制、统一接口异常处理、兼容性检测，同时搭建监控告警体系。"</p>
<h3 data-id="heading-1">一、基础检测流程</h3>
<h4 data-id="heading-2">1. 控制台检查（Console）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主动捕获全局错误（放在入口文件最前面）</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'全局捕获:'</span>, event.<span class="hljs-property">error</span>);
  <span class="hljs-comment">// 可上报到监控系统</span>
});

<span class="hljs-comment">// 检查console是否有以下类型错误：</span>
<span class="hljs-comment">// - SyntaxError (语法错误)</span>
<span class="hljs-comment">// - TypeError (类型错误)</span>
<span class="hljs-comment">// - ReferenceError (引用错误)</span>
<span class="hljs-comment">// - 404资源加载失败</span>
</code></pre>
<h4 data-id="heading-3">2. 网络请求检查（Network）</h4>
<ul>
<li>
<p><strong>关键指标</strong>：</p>
<ul>
<li>HTML文档状态码（200/304/404/500）</li>
<li>JS/CSS资源加载状态</li>
<li>接口请求是否阻塞渲染</li>
</ul>
</li>
<li>
<p><strong>检测示例</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 检查关键资源是否加载完成
const <span class="hljs-attr">resourceCheck</span> = () =&gt; {
  const <span class="hljs-attr">entries</span> = performance.getEntriesByType(<span class="hljs-string">'resource'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">criticalResources</span> = entries.filter(entry =&gt; 
    <span class="hljs-attr">entry.initiatorType</span> === <span class="hljs-string">'script'</span> || 
    <span class="hljs-attr">entry.initiatorType</span> === <span class="hljs-string">'css'</span>
  )<span class="hljs-comment">;</span>
  
  criticalResources.forEach(<span class="hljs-attr">res</span> =&gt; {
    if(res.responseStatus &gt;= 400) {
      console.error(`资源加载失败: ${res.name}`, res)<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
window.addEventListener('load', resourceCheck)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">二、深度检测方法</h3>
<h4 data-id="heading-5">1. DOM渲染检测</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 检测DOM树是否正常构建</span>
function <span class="hljs-built_in">checkDOMReady</span>() {
  return new <span class="hljs-built_in">Promise</span>((resolve) =&gt; {
    const check = () =&gt; {
      <span class="hljs-built_in">if</span>(document.body &amp;&amp; document.body.children.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">resolve</span>(true);
      } else {
        <span class="hljs-built_in">setTimeout</span>(check, <span class="hljs-number">50</span>);
      }
    };
    <span class="hljs-built_in">check</span>();
  });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-built_in">checkDOMReady</span>()<span class="hljs-selector-class">.then</span>((isReady) =&gt; {
  <span class="hljs-built_in">if</span>(!isReady) {
    console<span class="hljs-selector-class">.error</span>('DOM渲染超时');
    <span class="hljs-comment">// 上报白屏信息</span>
  }
});
</code></pre>
<h4 data-id="heading-6">2. 框架特定检测</h4>
<h5 data-id="heading-7">Vue应用检测：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在main.js中添加</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>),
  <span class="hljs-title function_">errorCaptured</span>(<span class="hljs-params">err, vm, info</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue组件错误:'</span>, err, info);
    <span class="hljs-comment">// 可上报错误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 阻止错误继续向上传播</span>
  }
}).$mount(<span class="hljs-string">'#app'</span>);

<span class="hljs-comment">// 检查根组件挂载</span>
<span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>).<span class="hljs-property">__vue__</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue根实例挂载失败'</span>);
}
</code></pre>
<h5 data-id="heading-8">React应用检测：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Error Boundary组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, info</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'React组件错误:'</span>, error, info);
    <span class="hljs-comment">// 上报错误</span>
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>; 
  }
}

<span class="hljs-comment">// 检查React根组件</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
);
</code></pre>
<h3 data-id="heading-9">三、性能相关检测</h3>
<h4 data-id="heading-10">1. 长任务检测</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测阻塞渲染的长时间任务</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
    <span class="hljs-keyword">if</span>(entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) { <span class="hljs-comment">// 超过50ms的任务</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'长任务影响渲染:'</span>, entry);
    }
  }
});
observer.<span class="hljs-title function_">observe</span>({<span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">"longtask"</span>]});
</code></pre>
<h4 data-id="heading-11">2. 关键渲染路径监控</h4>
<pre><code class="hljs language-ini" lang="ini">// 使用Performance API监控关键时间点
const <span class="hljs-attr">perfData</span> = window.performance.timing<span class="hljs-comment">;</span>
const <span class="hljs-attr">metrics</span> = {
  domReady: perfData.domComplete - perfData.domLoading,
  loadTime: perfData.loadEventEnd - perfData.navigationStart
}<span class="hljs-comment">;</span>

if(metrics.domReady &gt; 3000) {
  console.error('DOM解析时间过长:', metrics)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12">四、自动化检测方案</h3>
<h4 data-id="heading-13">1. Puppeteer检测脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'puppeteer'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>();
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();
  
  <span class="hljs-comment">// 监听控制台错误</span>
  page.<span class="hljs-title function_">on</span>(<span class="hljs-string">'console'</span>, <span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> {
    <span class="hljs-keyword">if</span>(msg.<span class="hljs-title function_">type</span>() === <span class="hljs-string">'error'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面错误:'</span>, msg.<span class="hljs-title function_">text</span>());
    }
  });
  
  <span class="hljs-comment">// 设置超时检测</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
    page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">'https://your-site.com'</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> 
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'页面加载超时'</span>)), <span class="hljs-number">5000</span>)
    )
  ]);
  
  <span class="hljs-comment">// 检查可见内容</span>
  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">bodyText</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerText</span>,
      <span class="hljs-attr">childCount</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    };
  });
  
  <span class="hljs-keyword">if</span>(content.<span class="hljs-property">childCount</span> === <span class="hljs-number">0</span> || content.<span class="hljs-property">bodyText</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">10</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'检测到白屏现象'</span>);
  }
  
  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();
})();
</code></pre>
<h4 data-id="heading-14">2. 真实用户监控（RUM）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用浏览器的MutationObserver监控DOM变化</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>)?.<span class="hljs-property">innerHTML</span>) {
    <span class="hljs-comment">// 上报白屏事件</span>
    beacon.<span class="hljs-title function_">send</span>(<span class="hljs-string">'white-screen'</span>, {
      <span class="hljs-attr">url</span>: location.<span class="hljs-property">href</span>,
      <span class="hljs-attr">ua</span>: navigator.<span class="hljs-property">userAgent</span>
    });
  }
});

observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
  <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<h3 data-id="heading-15">五、常见白屏场景示例</h3>
<ol>
<li>
<p><strong>资源加载失败</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误的资源路径 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/wrong-path/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>语法错误</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 缺少括号导致整个脚本不执行</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>
}
</code></pre>
</li>
<li>
<p><strong>框架初始化失败</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vue示例 - 挂载元素不存在</span>
<span class="hljs-keyword">new</span> <span class="hljs-built_in">Vue</span>({el: <span class="hljs-string">'#not-exist'</span>});
</code></pre>
</li>
<li>
<p><strong>CSS阻塞</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 不正确的CSS引入阻塞渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"nonexist.css"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>第三方库冲突</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 两个库都修改了Array原型</span>
libraryA<span class="hljs-selector-class">.modifyPrototype</span>();
libraryB<span class="hljs-selector-class">.modifyPrototype</span>(); <span class="hljs-comment">// 冲突导致错误 ```</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-16">2.前端埋点</h2>
<h3 data-id="heading-17">一、页面生命周期埋点</h3>
<h4 data-id="heading-18">1. 页面加载阶段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录页面开始加载时间</span>
<span class="hljs-keyword">const</span> pageStartTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

<span class="hljs-comment">// 监听页面加载完成</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> loadTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime;
  <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_load'</span>, {
    <span class="hljs-attr">load_time</span>: loadTime,
    <span class="hljs-attr">referrer</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">referrer</span>,
    <span class="hljs-attr">resource_status</span>: <span class="hljs-title function_">checkResources</span>()
  });
});

<span class="hljs-comment">// 检查关键资源加载状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkResources</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'resource'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> ({
    <span class="hljs-attr">name</span>: res.<span class="hljs-property">name</span>,
    <span class="hljs-attr">type</span>: res.<span class="hljs-property">initiatorType</span>,
    <span class="hljs-attr">duration</span>: res.<span class="hljs-property">duration</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)
  }));
}
</code></pre>
<h4 data-id="heading-19">2. 用户交互阶段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 点击事件埋点（支持事件委托）</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">'[data-track]'</span>);
  <span class="hljs-keyword">if</span>(target) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'element_click'</span>, {
      <span class="hljs-attr">element_id</span>: target.<span class="hljs-property">id</span>,
      <span class="hljs-attr">track_type</span>: target.<span class="hljs-property">dataset</span>.<span class="hljs-property">track</span>,
      <span class="hljs-attr">position</span>: <span class="hljs-string">`<span class="hljs-subst">${e.clientX}</span>,<span class="hljs-subst">${e.clientY}</span>`</span>
    });
  }
});

<span class="hljs-comment">// 滚动深度记录</span>
<span class="hljs-keyword">let</span> maxScroll = <span class="hljs-number">0</span>;
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, _.<span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> currentScroll = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> / <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollHeight</span>;
  <span class="hljs-keyword">if</span>(currentScroll &gt; maxScroll) {
    maxScroll = currentScroll;
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'scroll_depth'</span>, { <span class="hljs-attr">depth</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(maxScroll * <span class="hljs-number">100</span>) });
  }
}, <span class="hljs-number">1000</span>));
</code></pre>
<h4 data-id="heading-20">3. 页面停留时长计算</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> activeStart = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
<span class="hljs-keyword">let</span> inactiveTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 用户活跃状态检测</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, resetActiveTimer);
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, resetActiveTimer);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetActiveTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span>(inactiveTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'user_inactive'</span>, { <span class="hljs-attr">duration</span>: inactiveTime });
    inactiveTime = <span class="hljs-number">0</span>;
  }
  activeStart = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
}

<span class="hljs-comment">// 每10秒检测一次活跃状态</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - activeStart &gt; <span class="hljs-number">15000</span>) { <span class="hljs-comment">// 15秒无操作视为不活跃</span>
    inactiveTime += <span class="hljs-number">10000</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'user_active'</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">10000</span> });
  }
}, <span class="hljs-number">10000</span>);
</code></pre>
<h3 data-id="heading-21">二、特殊场景处理</h3>
<h4 data-id="heading-22">1. 页面隐藏/显示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 页面可见性变化监听</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">hidden</span>) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_hide'</span>, { 
      <span class="hljs-attr">stay_time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime,
      <span class="hljs-attr">scroll_depth</span>: maxScroll
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_show'</span>);
  }
});
</code></pre>
<h4 data-id="heading-23">2. 页面关闭前上报</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 确保页面关闭前数据上报</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> totalStay = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime;
  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">'/api/track'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">event</span>: <span class="hljs-string">'page_close'</span>,
    <span class="hljs-attr">active_time</span>: totalStay - inactiveTime,
    <span class="hljs-attr">scroll_depth</span>: maxScroll
  }));
});
</code></pre>
<h3 data-id="heading-24">三、数据上报优化方案</h3>
<h4 data-id="heading-25">1. 批量上报机制</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">eventQueue</span> = []<span class="hljs-comment">;</span>
const <span class="hljs-attr">MAX_QUEUE</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">FLUSH_INTERVAL</span> = <span class="hljs-number">3000</span><span class="hljs-comment">;</span>

function addToQueue(event) {
  eventQueue.push(event)<span class="hljs-comment">;</span>
  if(eventQueue.length &gt;= MAX_QUEUE) {
    flushQueue()<span class="hljs-comment">;</span>
  }
}

function flushQueue() {
  if(<span class="hljs-attr">eventQueue.length</span> === <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">batchData</span> = { batch: eventQueue }<span class="hljs-comment">;</span>
  navigator.sendBeacon('/api/batch', JSON.stringify(batchData))<span class="hljs-comment">;</span>
  <span class="hljs-attr">eventQueue</span> = []<span class="hljs-comment">;</span>
}

// 定时刷新队列
setInterval(flushQueue, FLUSH_INTERVAL)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-26">2. 关键指标计算</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 计算FMP（首次有效绘制）</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>((entryList) =&gt; {
  <span class="hljs-keyword">const</span> [entry] = entryList.<span class="hljs-title function_ invoke__">getEntriesByName</span>(<span class="hljs-string">'first-contentful-paint'</span>);
  <span class="hljs-title function_ invoke__">track</span>(<span class="hljs-string">'fmp'</span>, { <span class="hljs-attr">value</span>: entry.startTime.<span class="hljs-title function_ invoke__">toFixed</span>(<span class="hljs-number">2</span>) });
}).<span class="hljs-title function_ invoke__">observe</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span>});

<span class="hljs-comment">// 计算LCP（最大内容绘制）</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>((entryList) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entries</span> = entryList.<span class="hljs-title function_ invoke__">getEntries</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">lastEntry</span> = entries[entries.length - <span class="hljs-number">1</span>];
  <span class="hljs-title function_ invoke__">track</span>(<span class="hljs-string">'lcp'</span>, { <span class="hljs-attr">value</span>: lastEntry.startTime.<span class="hljs-title function_ invoke__">toFixed</span>(<span class="hljs-number">2</span>) });
}).<span class="hljs-title function_ invoke__">observe</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span>});
</code></pre>
<h3 data-id="heading-27">四、面试回答精简版</h3>
<p>"我们实现全链路埋点主要分三个阶段：</p>
<ol>
<li>
<p><strong>加载阶段</strong>：</p>
<ul>
<li>用<code>performance API</code>采集DNS/TTFB等指标</li>
<li>监听<code>load</code>事件记录完整加载时间</li>
<li>检查关键资源状态（如图片/脚本）</li>
</ul>
</li>
<li>
<p><strong>交互阶段</strong>：</p>
<ul>
<li>事件委托监听全局点击（带<code>data-track</code>属性）</li>
<li>节流处理滚动事件计算最大深度</li>
<li>通过<code>mousemove/keydown</code>检测活跃状态</li>
</ul>
</li>
<li>
<p><strong>离开阶段</strong>：</p>
<ul>
<li><code>visibilitychange</code>处理页面切换</li>
<li><code>beforeunload</code>+<code>sendBeacon</code>确保关闭前上报</li>
<li>计算总停留时长和有效活跃时间</li>
</ul>
</li>
</ol>
<h3 data-id="heading-28">3.那为什么大家都使用请求<code> GIF 图片</code>的方式上报埋点数据呢？</h3>
<ul>
<li>
<p><strong>防止跨域问题</strong>：前端监控的请求常常会遇到跨域问题，这可能会影响监控的准确性和可用性。然而，图片的src属性并不会跨域，因此使用GIF图片作为埋点可以正常发起请求，从而有效避免跨域问题。</p>
</li>
<li>
<p><strong>防止阻塞页面加载</strong>：在创建资源节点后，通常只有当对象注入到浏览器的DOM树后，浏览器才会实际发送资源请求。但反复操作DOM会引发性能问题，且载入js/css资源会阻塞页面渲染，从而影响用户体验。与此不同，构造图片打点不需要插入DOM，只要在js中new出Image对象就能发起请求，这样就不会有阻塞问题。即使在没有js的浏览器环境中，也能通过img标签正常打点，这是其他类型的资源请求所做不到的。</p>
</li>
<li>
<p><strong>体积小，节约流量</strong>：相比其他图片格式（如BMP和PNG），GIF图片具有更小的体积。例如，最小的BMP文件需要74个字节，PNG需要67个字节，而合法的GIF只需要43个字节。因此，使用GIF作为埋点可以显著节约流量，提高数据传输效率。</p>
</li>
<li>
<p><strong>浏览器支持性好</strong>：所有浏览器都支持Image对象，即使不支持XMLHttpRequest对象也一样。这意味着使用GIF进行埋点上报可以在各种浏览器环境中稳定运行。</p>
</li>
<li>
<p><strong>记录错误的过程很少出错</strong>：某些情况下，如Ajax通信过程中页面跳转，请求可能会被取消。但使用图片进行埋点上报则不会遇到这个问题，特别是在记录离开页面打点行为的时候会很有用。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建Hyperf本地开发环境之Docker容器开发]]></title>    <link>https://juejin.cn/post/7576086557716168755</link>    <guid>https://juejin.cn/post/7576086557716168755</guid>    <pubDate>2025-11-24T09:53:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086557716168755" data-draft-id="7576070987293868078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建Hyperf本地开发环境之Docker容器开发"/> <meta itemprop="keywords" content="后端,PHP,Docker"/> <meta itemprop="datePublished" content="2025-11-24T09:53:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="joker丶牧羊人"/> <meta itemprop="url" content="https://juejin.cn/user/4054654614250958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建Hyperf本地开发环境之Docker容器开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654614250958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    joker丶牧羊人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:53:28.000Z" title="Mon Nov 24 2025 09:53:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">写在前面</h3>
<blockquote>
<p>本文以部署本地开发环境，以实现快速部署为基准、方便开发为前提做说明</p>
</blockquote>
<h3 data-id="heading-1">背景</h3>
<p>本人在实际工作过程中，使用 hyperf 框架开发时遇到这种情况：</p>
<ul>
<li>同时开发多个项目</li>
<li>同时使用不同的 hyperf 框架版（2.x、3.x）</li>
<li>不同项目对接不同的数据库（Mysql、Oracle、Sqlserver）</li>
</ul>
<p>遇到的问题有很多，比如：</p>
<ul>
<li>2.x 和 3.x 对 php 版本和 swoole 版本不一样</li>
<li>每个 php 版本需要单独安装对应的 扩展</li>
<li>不同的 php 版本，composer 需要重新安装</li>
<li>项目中使用 composer 添加扩展包时，还要对应自己的项目版本使用正确的 composer</li>
<li>... ... ...</li>
</ul>
<p>这一套下来，耗费时间长，如果换台设备，重新部署也很麻烦；</p>
<p>所以，考虑到使用容器开发来解决当下的困局 ... ... ...</p>
<h3 data-id="heading-2">一、准备工作</h3>
<h4 data-id="heading-3">环境准备</h4>
<blockquote>
<p>基于本人开发环境做说明</p>
</blockquote>
<ul>
<li>一个 linux 环境、已安装好 docker、docker-compose
<ul>
<li>CentOS 版本：<code>CentOS Linux release 7.9.2009 (Core)</code></li>
<li>docker 版本：<code>Docker version 24.0.5, build ced0996</code></li>
<li>docker-compos 版本：<code>Docker Compose version v2.20.2</code></li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">二、开始部署（基础）</h3>
<blockquote>
<p>本文以 php7.4 + hyperf2.x 做开发环境的说明</p>
</blockquote>
<h4 data-id="heading-5">准备 Dockerfile</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM php:7.4-cli-bullseye

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone

# 更新并安装基础依赖
RUN apt-get update &amp;&amp; apt-get install -y \
    --no-install-recommends libfreetype6-dev libjpeg62-turbo-dev libpng-dev libzip-dev \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# 安装 redis 和 swoole 扩展
RUN pecl install redis-5.3.7 swoole-4.8.13

# 移动 php.ini 配置文件
RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"

# 启用扩展
RUN docker-php-ext-enable redis swoole

# 配置 GD 扩展
RUN docker-php-ext-configure gd --with-jpeg=/usr/include --with-freetype=/usr/include/freetype2/

# 安装 PHP 扩展
RUN docker-php-ext-install -j$(nproc) pcntl gd zip pdo_mysql opcache

# 添加自定义 PHP 配置
RUN echo "swoole.use_shortname='Off'" &gt;&gt; /usr/local/etc/php/conf.d/default.ini \
    &amp;&amp; echo "memory_limit=1G" &gt;&gt; /usr/local/etc/php/conf.d/default.ini \
    &amp;&amp; echo "opcache.enable_cli='on'" &gt;&gt; /usr/local/etc/php/conf.d/default.ini

# 安装 Composer
ENV COMPOSER_HOME /root/composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
ENV PATH $COMPOSER_HOME/vendor/bin:$PATH

# 指定工作目录，如果使用docker exec进入容器时，默认目录就是指定的工作目录，如/data
WORKDIR /opt/www
</code></pre>
<p>针对这份文档，做一些小说明：</p>
<ul>
<li>基础镜像使用 <code>-bullseye</code> 版本：有些基础依赖在其他版本已经不做维护了，需要自己设置对应的源地址，比较麻烦，而该版本基于最新的 debain 做兼容的</li>
<li>该文件没有设置启动命令：是为了给多个项目自己的启动命令留空间</li>
</ul>
<h4 data-id="heading-6">构建新镜像</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">执行构建</span>
docker build -t 镜像名称:标签 .
<span class="hljs-meta prompt_">
# </span><span class="bash">检查新镜像</span>
docker images
</code></pre>
<h4 data-id="heading-7">容器编排</h4>
<blockquote>
<p>docker-compose.yml</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.9"</span>
<span class="hljs-attr">services:</span>
        <span class="hljs-attr">php:</span>
                <span class="hljs-attr">image:</span> <span class="hljs-string">php-hyperf:7.4-cli-bullseye</span>
                <span class="hljs-attr">volumes:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/www:/opt/www</span>
                <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
                <span class="hljs-attr">container_name:</span> <span class="hljs-string">hyperf01</span>
<span class="hljs-comment">#                networks:</span>
<span class="hljs-comment">#                        - php-net</span>
<span class="hljs-comment">#                ports:</span>
<span class="hljs-comment">#                        - 9505:9501</span>
                <span class="hljs-attr">network_mode:</span> <span class="hljs-string">"host"</span>
                <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span>
                <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment">#                command: ["php", "bin/hyperf.php", "start"]</span>
<span class="hljs-comment">#networks:</span>
<span class="hljs-comment">#        php-net:</span>
<span class="hljs-comment">#                external:</span>
<span class="hljs-comment">#                       name: php-net</span>

</code></pre>
<p>针对这份文档，做一些小说明：</p>
<blockquote>
<p>一般情况下，使用 docker-compose 编排容器是这样的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.9"</span>
<span class="hljs-attr">services:</span>
        <span class="hljs-attr">php:</span>
                <span class="hljs-attr">image:</span> <span class="hljs-string">php-hyperf:7.4-cli-bullseye</span>
                <span class="hljs-attr">volumes:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/www/hyperf01:/opt/www/hyperf01</span>
                <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
                <span class="hljs-attr">container_name:</span> <span class="hljs-string">hyperf01</span>
                <span class="hljs-attr">networks:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">php-net</span>
                <span class="hljs-attr">ports:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-number">9505</span><span class="hljs-string">:9501</span>
                <span class="hljs-attr">command:</span> [<span class="hljs-string">"php"</span>, <span class="hljs-string">"bin/hyperf.php"</span>, <span class="hljs-string">"start"</span>]
<span class="hljs-attr">networks:</span>
        <span class="hljs-attr">php-net:</span>
                <span class="hljs-attr">external:</span>
                       <span class="hljs-attr">name:</span> <span class="hljs-string">php-net</span>
</code></pre>
</blockquote>
<ul>
<li><code>image</code>: Dockerfile 构建出来的镜像名</li>
<li><code>volumes</code>: 挂载目录
<ul>
<li>开发环境目录结构解释：/www 是项目目录，里面包含多个项目文件夹</li>
<li><strong>此处挂载 /www ，是为了方便只使用一个 php 容器，可以运行多个 hyperf 项目</strong></li>
</ul>
</li>
<li><code>command</code>: 容器启动时的执行命令
<ul>
<li><strong>一般情况下，我们挂载了指定的项目名称，在容器启动时需要指定启动命令</strong></li>
<li><strong>但是，目前挂载的 /www，没有指定的项目，如果使用 <code>command: ["php", "bin/hyperf.php", "start"]</code> 容器会启动不成功</strong></li>
<li><strong>所以，我们在这里不能使用 command 启动命令，也是为了方便多项目各自启动</strong></li>
</ul>
</li>
<li><code>tty、stdin_open</code>:
<ul>
<li><strong>Dockerfile、docker-compose 中都没有了启动命令、容器启动不成功</strong></li>
<li><strong>所以，追加这两个参数，允许容器可以成功启动，容器不退出</strong></li>
</ul>
</li>
<li><code>ports</code>: 端口映射
<ul>
<li><strong>为了能直接使用每个项目自己配置的端口</strong></li>
<li><strong>因为为了方便扩展（后续追加更多的项目）</strong>
<ul>
<li>每个项目都有自己的端口号，如果在这里设置，那么每增加一个项目，就需要修改一次端口映射，并重新编排容器，很不方便</li>
<li>所以就取消了这里的端口映射</li>
</ul>
</li>
</ul>
</li>
<li><code>network_mode</code>: 网络模式
<ul>
<li><strong>固定值：<code>host</code>，容器共享宿主机网络，可以实现不用配置端口号</strong></li>
<li><strong>与 <code>ports</code> 参数不共存</strong></li>
<li><strong>使用了共享网络模式，那么就不再需要配置新的网络了，就取消了 <code>networks</code> 相关的参数配置</strong></li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">执行容器编排</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">后台运行，创建容器并启动</span>
docker-compose up -d
</code></pre>
<h3 data-id="heading-9">三、启动并运行项目</h3>
<p>当我们启动好容器后、进入php容器中</p>
<pre><code class="hljs language-shell" lang="shell">docker exec -it hyperf01 bash
</code></pre>
<p>此时可以看到我们的项目目录 <code>/opt/www</code> ，因为这里包含了所有的项目目录，找到你自己的使用 php7.x 的项目，启动即可，启动成功后可以看到端口号就是你再项目中配置的端口号了。</p>
<p>至此，便可以愉快的开启你的牛马生活了 ... ... ...</p>
<h3 data-id="heading-10">四、提升</h3>
<p>前面，我们提供了一个完整的可直接享用的 <code>Dockerfile</code> 文件，虽然是方便食用，但是问题也随之出现了：</p>
<ul>
<li>当前是 php7.x 如果我们要换成 php8.x 怎么办呢？对应的 swoole 扩展版本 也需要修改</li>
<li>如果我们需要追加其他扩展怎么办呢？</li>
<li>... ... ...</li>
</ul>
<p>如果按照当前的模式，每次处理这些问题，都需要去修改 <code>Dockerfile</code> 文件，这样就搞得很麻烦？有没有一个简单有效的办法呢？？？</p>
<p>有、有、有，，，那就是把这些可变信息，提炼成配置文件，<code>Dockerfile</code> 使用读配置的方式进行，那么我们就不用频繁的修改 <code>Dockerfile</code> 文件了，每次有变动，那就直接修改配置文件，简单直接、方便快速！！！</p>
<p>那么，我现在提供一套可开箱即用的配置方案，至于中间的踩坑过程就直接略过，当然，方案实现不止这么一种，大家可以自行发掘 ... ... ...</p>
<h4 data-id="heading-11">目录结构</h4>
<blockquote>
<p>我们以 project 作为根目录做说明</p>
</blockquote>
<pre><code class="hljs language-shell" lang="shell">project
|--config
   |--build.conf
|--pecl
|--source
   |--alpine_source.list
   |--debian_source.list
|--build.sh
|--Dockerfile.base
|--Dockerfile.final
</code></pre>
<ul>
<li><code>project</code>：项目根目录</li>
<li><code>project/config</code>：构建配置文件目录</li>
<li><code>project/config/build.conf</code>：构建配置文件，方便修改构建信息</li>
<li><code>project/pecl</code>：本地下载扩展目录，方便从本地安装扩展，例如：<code>swoole-5.1.3.tar</code></li>
<li><code>project/source</code>：自定义 alpine、debian 配置源目录</li>
<li><code>project/source/alpine_source.list</code>：自定义 alpine 系统源配置信息</li>
<li><code>project/source/debian_source.list</code>：自定义 debian 系统源配置信息</li>
<li><code>project/build.sh</code>：构建执行脚本 需要有执行权限</li>
<li><code>project/Dockerfile.base</code>：用于构建基础镜像，只做 apline、debian 系统依赖和工具等更新</li>
<li><code>project/Dockerfile.final</code>：用于构建最终镜像，分阶段：一阶段主要功能 --- 安装扩展；二阶段主要功能 --- 构建最终镜像</li>
</ul>
<h4 data-id="heading-12">文件内容及说明</h4>
<h5 data-id="heading-13">build.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">PHP 基础镜像</span>
[base_image]
php:8.2-cli
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.2-alpine</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:7.4-cli</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:7.4-alpine</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">PECL 扩展（pecl install）</span>
[pecl]
<span class="hljs-meta prompt_">#</span><span class="bash">swoole-4.8.13</span>
<span class="hljs-meta prompt_">#</span><span class="bash">redis-5.3.7</span>
swoole-5.1.3
redis
<span class="hljs-meta prompt_">
# </span><span class="bash">本地扩展（docker-php-ext-install）</span>
[local]
pcntl
gd
zip
pdo_mysql
opcache
<span class="hljs-meta prompt_">
# </span><span class="bash">构建模式：prod / dev</span>
[mode]
dev
<span class="hljs-meta prompt_">
# </span><span class="bash">是否使用自定义依赖源地址 <span class="hljs-literal">true</span> / <span class="hljs-literal">false</span></span>
[custom_source]
false
<span class="hljs-meta prompt_">
# </span><span class="bash">composer 源：auto / aliyun / tencent / ustc / packagist</span>
[composer_mirror]
auto
<span class="hljs-meta prompt_">
# </span><span class="bash">php.ini 配置</span>
[php]
swoole.use_shortname=Off
memory_limit=1G
opcache.enable_cli=on
<span class="hljs-meta prompt_">
# </span><span class="bash">构建目标：base / final / all</span>
[build_target]
all
<span class="hljs-meta prompt_">
# </span><span class="bash">是否强制重新构建基础镜像：<span class="hljs-literal">true</span> / <span class="hljs-literal">false</span></span>
[force_rebuild_base]
false
</code></pre>
<h5 data-id="heading-14">alpine_source.list</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">阿里云源</span>
https://mirrors.aliyun.com/alpine/v3.18/main
https://mirrors.aliyun.com/alpine/v3.18/community
<span class="hljs-meta prompt_">
# </span><span class="bash">腾讯云源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.cloud.tencent.com/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.cloud.tencent.com/alpine/v3.18/community</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/community</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">官方源（备用）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://dl-cdn.alpinelinux.org/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://dl-cdn.alpinelinux.org/alpine/v3.18/community</span>

</code></pre>
<h5 data-id="heading-15">debian_source.list</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">阿里云源</span>
deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
deb http://mirrors.aliyun.com/debian-security/ bullseye-security main
deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib
deb http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
<span class="hljs-meta prompt_">
# </span><span class="bash">腾讯云源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye main non-free contrib</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian-security/ bullseye-security main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye-updates main non-free contrib</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye-backports main non-free contrib</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">官方源（备用）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian bullseye main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian-security/ bullseye-security main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian bullseye-updates main contrib non-free</span>

</code></pre>
<h5 data-id="heading-16">Dockerfile.base</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># =============================================================================
# PHP 基础镜像 Dockerfile
# 功能：安装系统依赖、编译工具和常用库，为后续扩展安装做准备
# =============================================================================

# 构建参数
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# 系统类型参数
ARG SYSTEM_TYPE
ARG CUSTOM_SOURCE

# 设置工作目录
WORKDIR /tmp/build

# 设置环境变量防止 OOM
ENV MAKEFLAGS="-j2"
ENV COMPOSER_MEMORY_LIMIT=-1

# 复制源配置文件
COPY source/${SYSTEM_TYPE}_source.list /tmp/source.list

# 安装基础依赖和编译工具
RUN set -eux; \
    echo "========================================"; \
    echo "开始构建 PHP 基础镜像"; \
    echo "系统类型: ${SYSTEM_TYPE}"; \
    echo "自定义源: ${CUSTOM_SOURCE}"; \
    echo "========================================"; \
    \
    # Alpine 系统配置
    if [ "$SYSTEM_TYPE" = "alpine" ]; then \
        echo "配置 Alpine 源..."; \
        if [ "$CUSTOM_SOURCE" = "true" ]; then \
            echo "使用自定义源"; \
            cat /tmp/source.list &gt; /etc/apk/repositories; \
        fi; \
        \
        echo "更新软件包索引..."; \
        apk update || { echo "APK 更新失败"; exit 1; }; \
        \
        echo "安装基础工具..."; \
        apk add --no-cache \
            bash \
            curl \
            wget \
            git \
            vim \
            unzip || { echo "基础工具安装失败"; exit 1; }; \
        \
        echo "安装开发库..."; \
        apk add --no-cache \
            libzip-dev \
            zlib-dev \
            libpng-dev \
            libjpeg-turbo-dev \
            freetype-dev \
            libwebp-dev || { echo "开发库安装失败"; exit 1; }; \
        \
        echo "安装 XPM 和加密库..."; \
        apk add --no-cache \
            libxpm-dev \
            openssl-dev \
            curl-dev || { echo "XPM/加密库安装失败"; exit 1; }; \
        \
        echo "安装 XML 和数据库库..."; \
        apk add --no-cache \
            libxml2-dev \
            oniguruma-dev \
            sqlite-dev \
            postgresql-dev || { echo "XML/数据库库安装失败"; exit 1; }; \
        \
        echo "安装编译工具..."; \
        apk add --no-cache \
            autoconf \
            g++ \
            make \
            linux-headers || { echo "编译工具安装失败"; exit 1; }; \
        \
        echo "配置 GD 扩展依赖..."; \
        docker-php-ext-configure gd \
            --with-freetype \
            --with-jpeg \
            --with-webp || { echo "GD 配置失败，继续..."; }; \
    \
    # Debian 系统配置
    else \
        echo "配置 Debian 源..."; \
        if [ "$CUSTOM_SOURCE" = "true" ]; then \
            echo "使用自定义源"; \
            cat /tmp/source.list &gt; /etc/apt/sources.list; \
        fi; \
        \
        echo "更新软件包索引..."; \
        apt-get update || { echo "APT 更新失败"; exit 1; }; \
        \
        echo "安装基础工具和编译依赖..."; \
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            curl \
            wget \
            git \
            vim \
            unzip \
            libzip-dev \
            zlib1g-dev \
            libpng-dev \
            libjpeg-dev \
            libfreetype6-dev \
            libwebp-dev \
            libxpm-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libxml2-dev \
            libonig-dev \
            libsqlite3-dev \
            libpq-dev \
            autoconf \
            g++ \
            make || { echo "Debian 包安装失败"; exit 1; }; \
        \
        echo "配置 GD 扩展依赖..."; \
        docker-php-ext-configure gd \
            --with-freetype \
            --with-jpeg \
            --with-webp || { echo "GD 配置失败，继续..."; }; \
        \
        echo "清理 APT 缓存..."; \
        rm -rf /var/lib/apt/lists/*; \
    fi; \
    \
    # 清理临时文件
    rm -rf /tmp/*; \
    \
    echo "========================================"; \
    echo "基础镜像构建完成"; \
    echo "========================================";

# 健康检查
RUN php -v &amp;&amp; php -m

# 设置默认工作目录
WORKDIR /var/www/html

</code></pre>
<ul>
<li>
<p>该文件注释已标注在文档中</p>
</li>
<li>
<p>简要说明</p>
<ul>
<li>执行该文件，会生成类似于 php-base:8.2-debian php-base:8.2-alpine 的基础镜像</li>
<li>基础镜像的生成规则
<ul>
<li>
<p>镜像名称规则：固定值 php-base</p>
</li>
<li>
<p>tag 标签生成规则：自动读取配置文件中的 基础镜像名，获取版本号 和 对应的系统信息（debian/alpine）作为 tag 名称</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-17">Dockerfile.final</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># =============================================================================
# PHP 最终镜像 Dockerfile（多阶段构建）
# 功能：基于基础镜像安装 PHP 扩展、配置 PHP 和 Composer
# =============================================================================

# 构建参数
ARG BASE_IMAGE_NAME
FROM ${BASE_IMAGE_NAME}

# 扩展和配置参数
ARG SYSTEM_TYPE
ARG PECL_EXTENSIONS=""
ARG LOCAL_EXTENSIONS=""
ARG PHP_INI_CONFIGS=""
ARG COMPOSER_MIRROR="auto"
ARG BUILD_MODE="dev"

# 设置工作目录
WORKDIR /tmp/build

# 复制本地扩展目录（如果存在）
COPY pecl/ /tmp/pecl/

# 安装 PHP 扩展
RUN set -eux; \
    echo "========================================"; \
    echo "开始安装 PHP 扩展"; \
    echo "系统类型: ${SYSTEM_TYPE}"; \
    echo "PECL 扩展: ${PECL_EXTENSIONS}"; \
    echo "LOCAL 扩展: ${LOCAL_EXTENSIONS}"; \
    echo "构建模式: ${BUILD_MODE}"; \
    echo "========================================"; \
    \
    # 定义重试函数
    retry_command() { \
        local max_attempts=3; \
        local attempt=1; \
        local cmd="$@"; \
        while [ $attempt -le $max_attempts ]; do \
            echo "尝试执行 (${attempt}/${max_attempts}): ${cmd}"; \
            if eval "$cmd"; then \
                echo "执行成功"; \
                return 0; \
            fi; \
            echo "执行失败，等待 5 秒后重试..."; \
            sleep 5; \
            attempt=$((attempt + 1)); \
        done; \
        echo "执行失败，已达到最大重试次数"; \
        return 1; \
    }; \
    \
    # 安装 LOCAL 扩展
    if [ -n "$LOCAL_EXTENSIONS" ]; then \
        echo "----------------------------------------"; \
        echo "安装 LOCAL 扩展: $LOCAL_EXTENSIONS"; \
        echo "----------------------------------------"; \
        \
        # 特殊扩展依赖处理
        for ext in $LOCAL_EXTENSIONS; do \
            case "$ext" in \
                gd) \
                    echo "检测到 GD 扩展，已在基础镜像配置"; \
                    ;; \
                zip) \
                    echo "检测到 ZIP 扩展"; \
                    if [ "$SYSTEM_TYPE" = "alpine" ]; then \
                        apk add --no-cache libzip-dev; \
                    fi; \
                    ;; \
                pdo_mysql) \
                    echo "检测到 PDO_MYSQL 扩展"; \
                    ;; \
                opcache) \
                    echo "检测到 OPCACHE 扩展"; \
                    ;; \
                pcntl) \
                    echo "检测到 PCNTL 扩展"; \
                    ;; \
                *) \
                    echo "扩展: $ext"; \
                    ;; \
            esac; \
        done; \
        \
        # 一次性安装所有 LOCAL 扩展
        if ! retry_command "docker-php-ext-install -j\$(nproc) $LOCAL_EXTENSIONS"; then \
            echo "LOCAL 扩展安装失败"; \
            exit 1; \
        fi; \
        echo "LOCAL 扩展安装成功"; \
    fi; \
    \
    # 安装 PECL 扩展
    if [ -n "$PECL_EXTENSIONS" ]; then \
        echo "----------------------------------------"; \
        echo "安装 PECL 扩展: $PECL_EXTENSIONS"; \
        echo "----------------------------------------"; \
        \
        echo "$PECL_EXTENSIONS" | tr ',' '\n' | while read -r ext; do \
            # 跳过空行
            [ -z "$ext" ] &amp;&amp; continue; \
            \
            ext_name=$(echo "$ext" | cut -d'-' -f1); \
            echo "处理扩展: $ext_name (完整名称: $ext)"; \
            \
            # 检查本地扩展目录
            if [ -f "/tmp/pecl/${ext}.tgz" ]; then \
                echo "从本地安装: ${ext}"; \
                if ! retry_command "pecl install /tmp/pecl/${ext}.tgz"; then \
                    echo "从本地安装失败，尝试从 PECL 仓库安装"; \
                    if ! retry_command "pecl install $ext"; then \
                        echo "扩展 $ext 安装失败"; \
                        exit 1; \
                    fi; \
                fi; \
            else \
                echo "从 PECL 仓库安装: ${ext}"; \
                if ! retry_command "pecl install $ext"; then \
                    echo "扩展 $ext 安装失败"; \
                    exit 1; \
                fi; \
            fi; \
            \
            # 启用扩展
            echo "启用扩展: $ext_name"; \
            docker-php-ext-enable "$ext_name"; \
        done; \
        echo "PECL 扩展安装成功"; \
    fi; \
    \
    # 验证扩展安装
    echo "----------------------------------------"; \
    echo "验证已安装的扩展:"; \
    php -m; \
    echo "----------------------------------------";

# 配置 PHP.ini
RUN set -eux; \
    if [ -n "$PHP_INI_CONFIGS" ]; then \
        echo "========================================"; \
        echo "配置 PHP.ini"; \
        echo "========================================"; \
        \
        echo "$PHP_INI_CONFIGS" | tr '|' '\n' | while read -r config; do \
            # 跳过空行
            [ -z "$config" ] &amp;&amp; continue; \
            \
            echo "设置配置: $config"; \
            echo "$config" &gt;&gt; /usr/local/etc/php/conf.d/custom.ini; \
        done; \
        \
        echo "PHP.ini 配置完成"; \
        cat /usr/local/etc/php/conf.d/custom.ini; \
    fi;

# 安装 Composer
RUN set -eux; \
    echo "========================================"; \
    echo "安装 Composer"; \
    echo "Composer 镜像: ${COMPOSER_MIRROR}"; \
    echo "========================================"; \
    \
    # 下载 Composer
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer; \
    \
    # 配置 Composer 镜像源
    case "$COMPOSER_MIRROR" in \
        aliyun) \
            echo "配置阿里云 Composer 镜像"; \
            composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/; \
            ;; \
        tencent) \
            echo "配置腾讯云 Composer 镜像"; \
            composer config -g repo.packagist composer https://mirrors.cloud.tencent.com/composer/; \
            ;; \
        ustc) \
            echo "配置中科大 Composer 镜像"; \
            composer config -g repo.packagist composer https://packagist.mirrors.ustc.edu.cn/; \
            ;; \
        packagist) \
            echo "使用官方 Packagist 源"; \
            ;; \
        auto) \
            echo "自动检测，使用阿里云镜像"; \
            composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/; \
            ;; \
        *) \
            echo "未知的 Composer 镜像配置，使用默认源"; \
            ;; \
    esac; \
    \
    # 验证 Composer
    composer --version; \
    echo "Composer 安装完成";

# 清理和优化
RUN set -eux; \
    echo "========================================"; \
    echo "清理临时文件和优化镜像"; \
    echo "构建模式: ${BUILD_MODE}"; \
    echo "========================================"; \
    \
    # 清理 PECL 缓存
    rm -rf /tmp/pear; \
    \
    # 清理本地扩展
    rm -rf /tmp/pecl; \
    \
    # 根据构建模式决定是否清理编译工具
    if [ "$BUILD_MODE" = "prod" ]; then \
        echo "生产模式：清理编译工具以优化镜像大小"; \
        if [ "$SYSTEM_TYPE" = "alpine" ]; then \
            apk del autoconf g++ make linux-headers; \
        else \
            apt-get purge -y autoconf g++ make; \
            apt-get autoremove -y; \
            rm -rf /var/lib/apt/lists/*; \
        fi; \
    else \
        echo "开发模式：保留编译工具"; \
    fi; \
    \
    # 清理临时文件
    rm -rf /tmp/*; \
    rm -rf /var/tmp/*; \
    \
    echo "清理完成";

# 最终验证
RUN set -eux; \
    echo "========================================"; \
    echo "最终验证"; \
    echo "========================================"; \
    echo "PHP 版本:"; \
    php -v; \
    echo ""; \
    echo "已安装的扩展:"; \
    php -m; \
    echo ""; \
    echo "Composer 版本:"; \
    composer --version; \
    echo "========================================"; \
    echo "镜像构建完成！"; \
    echo "========================================";

# 设置工作目录
WORKDIR /opt/www

</code></pre>
<ul>
<li>该文件注释已标注在文档中</li>
<li>简要说明
<ul>
<li>执行该文件，会生成你指定的镜像名称和 tag 标签
<ul>
<li>使用多阶段构建模式，<strong>第一阶段：</strong> 安装 pecl 和 local 扩展；<strong>第二阶段：</strong> 构建最终镜像</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-18">build.sh</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># PHP Docker 多阶段构建脚本</span>
<span class="hljs-comment"># 功能：根据配置文件自动构建 PHP 基础镜像和最终镜像</span>
<span class="hljs-comment"># 用法：./build.sh [最终镜像名称]</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># 无颜色</span>

<span class="hljs-comment"># 配置文件路径</span>
CONFIG_FILE=<span class="hljs-string">"./config/build.conf"</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>

<span class="hljs-comment"># 日志函数</span>
<span class="hljs-function"><span class="hljs-title">log_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_success</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[SUCCESS]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_warn</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARN]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_error</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-comment"># 检查配置文件是否存在</span>
<span class="hljs-function"><span class="hljs-title">check_config_file</span></span>() {
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"配置文件不存在: <span class="hljs-variable">$CONFIG_FILE</span>"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    log_info <span class="hljs-string">"配置文件检查通过"</span>
}

<span class="hljs-comment"># 解析配置文件</span>
<span class="hljs-function"><span class="hljs-title">parse_config</span></span>() {
    <span class="hljs-built_in">local</span> section=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> key=<span class="hljs-string">""</span>
    
    <span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r line || [ -n <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> ]; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 跳过空行和注释</span>
        [[ -z <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> || <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> =~ ^[[:space:]]*<span class="hljs-comment"># ]] &amp;&amp; continue</span>
        
        <span class="hljs-comment"># 检测 section</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> =~ ^\[(.+)\]$ ]]; <span class="hljs-keyword">then</span>
            section=<span class="hljs-string">"<span class="hljs-variable">${BASH_REMATCH[1]}</span>"</span>
            <span class="hljs-built_in">continue</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-comment"># 读取配置值</span>
        <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$section</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$section</span>"</span> <span class="hljs-keyword">in</span>
                base_image)
                    BASE_IMAGE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                pecl)
                    PECL_EXTENSIONS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                <span class="hljs-built_in">local</span>)
                    LOCAL_EXTENSIONS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                mode)
                    BUILD_MODE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                custom_source)
                    CUSTOM_SOURCE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                composer_mirror)
                    COMPOSER_MIRROR=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                php)
                    PHP_INI_CONFIGS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                build_target)
                    BUILD_TARGET=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                force_rebuild_base)
                    FORCE_REBUILD_BASE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
            <span class="hljs-keyword">esac</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span> &lt; <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
}

<span class="hljs-comment"># 检测系统类型（Alpine 或 Debian）</span>
<span class="hljs-function"><span class="hljs-title">detect_system_type</span></span>() {
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> == *<span class="hljs-string">"alpine"</span>* ]]; <span class="hljs-keyword">then</span>
        SYSTEM_TYPE=<span class="hljs-string">"alpine"</span>
    <span class="hljs-keyword">else</span>
        SYSTEM_TYPE=<span class="hljs-string">"debian"</span>
    <span class="hljs-keyword">fi</span>
    log_info <span class="hljs-string">"检测到系统类型: <span class="hljs-variable">$SYSTEM_TYPE</span>"</span>
}

<span class="hljs-comment"># 生成基础镜像名称</span>
<span class="hljs-function"><span class="hljs-title">generate_base_image_name</span></span>() {
    <span class="hljs-built_in">local</span> version=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> | grep -oP <span class="hljs-string">'php:\K[0-9]+\.[0-9]+'</span>)
    BASE_IMAGE_NAME=<span class="hljs-string">"php-base:<span class="hljs-variable">${version}</span>-<span class="hljs-variable">${SYSTEM_TYPE}</span>"</span>
    log_info <span class="hljs-string">"基础镜像名称: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
}

<span class="hljs-comment"># 检查基础镜像是否存在</span>
<span class="hljs-function"><span class="hljs-title">check_base_image_exists</span></span>() {
    <span class="hljs-keyword">if</span> docker image inspect <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        log_info <span class="hljs-string">"基础镜像已存在: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        log_info <span class="hljs-string">"基础镜像不存在，需要构建"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 构建基础镜像</span>
<span class="hljs-function"><span class="hljs-title">build_base_image</span></span>() {
    log_info <span class="hljs-string">"开始构建基础镜像..."</span>
    
    <span class="hljs-comment"># 构建参数</span>
    docker build \
        --file Dockerfile.base \
        --build-arg BASE_IMAGE=<span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> \
        --build-arg SYSTEM_TYPE=<span class="hljs-string">"<span class="hljs-variable">$SYSTEM_TYPE</span>"</span> \
        --build-arg CUSTOM_SOURCE=<span class="hljs-string">"<span class="hljs-variable">$CUSTOM_SOURCE</span>"</span> \
        --tag <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> \
        --progress=plain \
        .
    
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        log_success <span class="hljs-string">"基础镜像构建成功: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
    <span class="hljs-keyword">else</span>
        log_error <span class="hljs-string">"基础镜像构建失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 构建最终镜像</span>
<span class="hljs-function"><span class="hljs-title">build_final_image</span></span>() {
    <span class="hljs-built_in">local</span> final_image_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span> ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"请提供最终镜像名称"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法: ./build.sh [最终镜像名称]"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    log_info <span class="hljs-string">"开始构建最终镜像: <span class="hljs-variable">$final_image_name</span>"</span>
    
    <span class="hljs-comment"># 准备 PECL 扩展参数</span>
    <span class="hljs-built_in">local</span> pecl_extensions_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#PECL_EXTENSIONS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        pecl_extensions_arg=$(IFS=,; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${PECL_EXTENSIONS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 准备 LOCAL 扩展参数</span>
    <span class="hljs-built_in">local</span> local_extensions_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#LOCAL_EXTENSIONS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        local_extensions_arg=$(IFS=<span class="hljs-string">' '</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${LOCAL_EXTENSIONS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 准备 PHP 配置参数</span>
    <span class="hljs-built_in">local</span> php_ini_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#PHP_INI_CONFIGS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        php_ini_arg=$(IFS=<span class="hljs-string">'|'</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${PHP_INI_CONFIGS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 构建最终镜像</span>
    docker build \
        --file Dockerfile.final \
        --build-arg BASE_IMAGE_NAME=<span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> \
        --build-arg SYSTEM_TYPE=<span class="hljs-string">"<span class="hljs-variable">$SYSTEM_TYPE</span>"</span> \
        --build-arg PECL_EXTENSIONS=<span class="hljs-string">"<span class="hljs-variable">$pecl_extensions_arg</span>"</span> \
        --build-arg LOCAL_EXTENSIONS=<span class="hljs-string">"<span class="hljs-variable">$local_extensions_arg</span>"</span> \
        --build-arg PHP_INI_CONFIGS=<span class="hljs-string">"<span class="hljs-variable">$php_ini_arg</span>"</span> \
        --build-arg COMPOSER_MIRROR=<span class="hljs-string">"<span class="hljs-variable">$COMPOSER_MIRROR</span>"</span> \
        --build-arg BUILD_MODE=<span class="hljs-string">"<span class="hljs-variable">$BUILD_MODE</span>"</span> \
        --tag <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span> \
        --progress=plain \
        .
    
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        log_success <span class="hljs-string">"最终镜像构建成功: <span class="hljs-variable">$final_image_name</span>"</span>
        log_info <span class="hljs-string">"镜像信息:"</span>
        docker images | grep <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span>
    <span class="hljs-keyword">else</span>
        log_error <span class="hljs-string">"最终镜像构建失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    log_info <span class="hljs-string">"=========================================="</span>
    log_info <span class="hljs-string">"PHP Docker 多阶段构建开始"</span>
    log_info <span class="hljs-string">"=========================================="</span>
    
    <span class="hljs-comment"># 初始化变量</span>
    BASE_IMAGE=<span class="hljs-string">""</span>
    PECL_EXTENSIONS=()
    LOCAL_EXTENSIONS=()
    BUILD_MODE=<span class="hljs-string">"dev"</span>
    CUSTOM_SOURCE=<span class="hljs-string">"false"</span>
    COMPOSER_MIRROR=<span class="hljs-string">"auto"</span>
    PHP_INI_CONFIGS=()
    BUILD_TARGET=<span class="hljs-string">"all"</span>
    FORCE_REBUILD_BASE=<span class="hljs-string">"false"</span>
    SYSTEM_TYPE=<span class="hljs-string">""</span>
    BASE_IMAGE_NAME=<span class="hljs-string">""</span>
    
    <span class="hljs-comment"># 检查配置文件</span>
    check_config_file
    
    <span class="hljs-comment"># 解析配置</span>
    log_info <span class="hljs-string">"开始解析配置文件..."</span>
    parse_config
    
    <span class="hljs-comment"># 检测系统类型</span>
    detect_system_type
    
    <span class="hljs-comment"># 生成基础镜像名称</span>
    generate_base_image_name
    
    <span class="hljs-comment"># 显示配置信息</span>
    log_info <span class="hljs-string">"=========================================="</span>
    log_info <span class="hljs-string">"配置信息:"</span>
    log_info <span class="hljs-string">"  基础镜像: <span class="hljs-variable">$BASE_IMAGE</span>"</span>
    log_info <span class="hljs-string">"  系统类型: <span class="hljs-variable">$SYSTEM_TYPE</span>"</span>
    log_info <span class="hljs-string">"  基础镜像名称: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
    log_info <span class="hljs-string">"  PECL 扩展: <span class="hljs-variable">${PECL_EXTENSIONS[*]}</span>"</span>
    log_info <span class="hljs-string">"  LOCAL 扩展: <span class="hljs-variable">${LOCAL_EXTENSIONS[*]}</span>"</span>
    log_info <span class="hljs-string">"  构建模式: <span class="hljs-variable">$BUILD_MODE</span>"</span>
    log_info <span class="hljs-string">"  自定义源: <span class="hljs-variable">$CUSTOM_SOURCE</span>"</span>
    log_info <span class="hljs-string">"  Composer 镜像: <span class="hljs-variable">$COMPOSER_MIRROR</span>"</span>
    log_info <span class="hljs-string">"  构建目标: <span class="hljs-variable">$BUILD_TARGET</span>"</span>
    log_info <span class="hljs-string">"  强制重建基础镜像: <span class="hljs-variable">$FORCE_REBUILD_BASE</span>"</span>
    log_info <span class="hljs-string">"=========================================="</span>
    
    <span class="hljs-comment"># 根据构建目标执行</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$BUILD_TARGET</span>"</span> <span class="hljs-keyword">in</span>
        base)
            log_info <span class="hljs-string">"构建目标: 仅构建基础镜像"</span>
            build_base_image
            ;;
        final)
            log_info <span class="hljs-string">"构建目标: 仅构建最终镜像"</span>
            <span class="hljs-keyword">if</span> ! check_base_image_exists; <span class="hljs-keyword">then</span>
                log_error <span class="hljs-string">"基础镜像不存在，请先构建基础镜像"</span>
                <span class="hljs-built_in">exit</span> 1
            <span class="hljs-keyword">fi</span>
            build_final_image <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
            ;;
        all)
            log_info <span class="hljs-string">"构建目标: 构建基础镜像和最终镜像"</span>
            <span class="hljs-comment"># 检查是否需要构建基础镜像</span>
            <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FORCE_REBUILD_BASE</span>"</span> = <span class="hljs-string">"true"</span> ]; <span class="hljs-keyword">then</span>
                log_warn <span class="hljs-string">"强制重新构建基础镜像"</span>
                build_base_image
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> check_base_image_exists; <span class="hljs-keyword">then</span>
                    log_info <span class="hljs-string">"基础镜像已存在，跳过构建"</span>
                <span class="hljs-keyword">else</span>
                    build_base_image
                <span class="hljs-keyword">fi</span>
            <span class="hljs-keyword">fi</span>
            build_final_image <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
            ;;
        *)
            log_error <span class="hljs-string">"无效的构建目标: <span class="hljs-variable">$BUILD_TARGET</span>"</span>
            <span class="hljs-built_in">exit</span> 1
            ;;
    <span class="hljs-keyword">esac</span>
    
    log_success <span class="hljs-string">"=========================================="</span>
    log_success <span class="hljs-string">"构建流程完成！"</span>
    log_success <span class="hljs-string">"=========================================="</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<ul>
<li>该文件是解析配置文件及控制构建情况的文件</li>
</ul>
<h4 data-id="heading-19">执行构建</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">进入项目目录</span>
cd project
<span class="hljs-meta prompt_">
# </span><span class="bash">添加文件执行权限</span>
chmod +x ./build.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">执行构建</span>
./build.sh 新的镜像名称
</code></pre>
<h4 data-id="heading-20">结语</h4>
<p>该份套餐可以做到：</p>
<ul>
<li>构建逻辑通用：不同版本、不同扩展的构建只需要修改 build.conf 配置文件</li>
<li>扩展自由度高：可自由增减扩展信息，可指定版本，也可不指定，不指定时安装最新版本</li>
<li>构建模式切换：分为 prod/dev，prod 构建会清楚构建缓存等信息，减少镜像体积；dev模式不会，方便多次构建，减少构建时间</li>
<li>自定义系统依赖源：自由配置是否使用自定义系统依赖源，减少构建成功率和构建速度</li>
<li>自定义php配置：不同的开发需求，可能需要不通过的php配置，可以自由配置，构建后覆盖原有的默认配置</li>
<li>构建目标自由：可自由配置构建 基础镜像(base)、最终镜像(final)、基础+最终(all)</li>
<li>系统依赖自动检测：可根据配置的基础镜像，自动识别镜像系统（debian/alpine）、并安装对应的依赖，如：系统依赖、系统工具等</li>
<li>GD 扩展自动配置：如果 local 扩展中存在 GD 扩展，则自动做扩展特殊配置</li>
<li>镜像名称自定义：基础镜像名称自动生成，最终镜像名称可以自由定义</li>
<li>扩展安装重试机制：安装扩展容易因为各种原因失败，追加重试机制（3次）减少失败次数</li>
</ul>
<p>okk，提升到此结束，又可以愉快的做牛马了 ... ... ...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入Android系统（十三）Android的窗口系统]]></title>    <link>https://juejin.cn/post/7575106644499578914</link>    <guid>https://juejin.cn/post/7575106644499578914</guid>    <pubDate>2025-11-23T13:16:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499578914" data-draft-id="7575363120798466048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入Android系统（十三）Android的窗口系统"/> <meta itemprop="keywords" content="Android,源码,设计模式"/> <meta itemprop="datePublished" content="2025-11-23T13:16:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apigfly"/> <meta itemprop="url" content="https://juejin.cn/user/2488950054453613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入Android系统（十三）Android的窗口系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2488950054453613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apigfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:16:04.000Z" title="Sun Nov 23 2025 13:16:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Android</code>的窗口系统由<code>WindowManagerService</code>管理，包括增加和删除窗口，确定窗口的大小和位置，以及实现窗口切换、窗口动画等功能。<code>WindowManagerService</code>名字较长，后面简称<code>WMS</code></p>
<h2 data-id="heading-0">前言</h2>
<blockquote>
<p>一个小问题</p>
</blockquote>
<p>在 Android 中<code>Activity</code>可以理解成 Android 中的一个页面，前面的章节我们说 <code>SurfaceFlinger</code> 最后会把 <code>Surface</code> 对应的 <code>Layer</code> 合成到屏幕上。那么<strong>Activity 和 Surface 的关系又是怎么关联的呢？</strong></p>
<p>让我们一起排查下～～～</p>
<h2 data-id="heading-1">应用进程和<code>WMS</code>的联系</h2>
<p>在学习<code>WMS</code>之前，我们先了解下应用和<code>WMS</code>之间的联系。对于应用来说：</p>
<ul>
<li>
<p><code>Activity</code></p>
<ul>
<li><code>Activity</code>并不负责视图控制，它只是控制生命周期和处理事件</li>
<li>真正控制视图的是<code>Window</code>。一个<code>Activity</code>包含了一个<code>Window</code>，<code>Window</code>才是真正代表一个窗口</li>
<li><code>Activity</code>就像一个控制器，统筹视图的添加与显示，以及通过其他回调方法，来与<code>Window</code>、以及<code>View</code>进行交互</li>
</ul>
</li>
<li>
<p><code>Window</code></p>
<ul>
<li><code>Window</code>是视图的承载器，内部持有一个<code>DecorView</code>，而这个<code>DecorView</code>才是<code>view</code>的根布局</li>
<li><code>Window</code>是一个抽象类，实际在<code>Activity</code>中持有的是其子类<code>PhoneWindow</code></li>
<li><code>PhoneWindow</code>中有个内部类<code>DecorView</code>，通过创建<code>DecorView</code>来加载<code>Activity</code>中``传递的布局</li>
<li><code>Window</code>通过<code>WindowManager</code>将<code>DecorView</code>加载其中，并将<code>DecorView</code>交给<code>ViewRoot</code>，进行视图绘制以及其他交互</li>
</ul>
</li>
<li>
<p><code>ViewRoot</code></p>
<ul>
<li>所有<code>View</code>的绘制以及事件分发等交互都是通过它来执行或传递的</li>
<li><code>ViewRoot</code>对应的实现类是<code>ViewRootImpl</code>类，它是连接<code>WindowManagerService</code>和<code>DecorView</code>的纽带</li>
<li><code>View</code>的三大流程：测量(measure)、布局(layout)、绘制 (draw))均通过<code>ViewRoot</code>来完成</li>
</ul>
</li>
</ul>
<p>除了上面这三部分，还有一个是在<code>Android</code>应用中存在的一个唯一的<code>WindowManagerGlobal</code>对象，它们的类图关系如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f91ffc402e497986337eba12df2b94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=vkLls2NZ4xOy1Jgqwi5BfD6K2Os%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-2">应用中的Window对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>Window</code>的成员变量<code>mWindow</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> Window mWindow;
    ...
}
</code></pre>
<p><code>Window</code>对象在应用进程代表了一个窗口，这是一块矩形的图像绘制区域。</p>
<p>从<code>WMS</code>的角度来说，它并不关系应用中的各种<code>View</code>，他管理和调度的对象是<code>Window</code>。<code>Activity</code>中的<code>View</code>树不管多复杂，最后输出的也仅仅是一张各个<code>View</code>合成的图像而已。</p>
<p><code>Window</code>是一个抽象类，在<code>Activity</code>类的<code>attach()</code>方法中会对成员变量<code>mWindow</code>进行初始化，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
    }
</code></pre>
<p><code>attach()</code>方法中<code>mWindow</code>实例化成了一个<code>PhoneWindow</code>对象。</p>
<p>而对于<code>PhoneWindow</code>对象，需要我们关注的部分是如下两个成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneWindow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MenuBuilder</span>.Callback {
    <span class="hljs-comment">// This is the top-level view of the window, containing the window decor.</span>
    <span class="hljs-keyword">private</span> DecorView mDecor;
    <span class="hljs-comment">// This is the view in which the window contents are placed. It is either</span>
    <span class="hljs-comment">// mDecor itself, or a child of mDecor where the contents go.</span>
    ViewGroup mContentParent;
    ...
}
</code></pre>
<ul>
<li>
<p><code>mDecor</code>的类型是<code>DecorView</code>，它是<code>FrameLayout</code>的子类，它可以被认为是<code>Android</code>视图树的根节点视图。</p>
<ul>
<li><code>DecorView</code>作为顶级<code>View</code>，它加载的资源文件内部会包含一个<code>android:id="@android:id/content"</code>的<code>ViewGroup</code></li>
<li>这个<code>ViewGroup</code>便是后面用来添加<code>setContentView()</code>方法传入的<code>layout</code>布局文件</li>
<li><code>DecorView</code>具体加载哪种布局文件和主题有关，这部分在<code>PhoneWindow</code>的<code>generateLayout()</code>方法中体现</li>
</ul>
</li>
<li>
<p><code>mContentParent</code>的类型是<code>ViewGroup</code>，它其实就是<code>android:id="@android:id/content"</code>对应的组件</p>
<ul>
<li>跟踪<code>generateLayout()</code>方法就会发现如下代码：</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">contentParent</span> <span class="hljs-operator">=</span> (ViewGroup)findViewById(ID_ANDROID_CONTENT);
</code></pre>
<ul>
<li><code>contentParent</code>创建完成后便会赋值给<code>mContentParent</code>，而此处的<code>ID_ANDROID_CONTENT</code>的定义是在<code>Window.java</code>中</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ID_ANDROID_CONTENT</span> <span class="hljs-operator">=</span> com.android.internal.R.id.content;
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">应用中的WindowManager对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>WindowManager</code>的成员变量<code>mWindowManager</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> WindowManager mWindowManager;
    ...
}
</code></pre>
<p><code>mWindowManager</code>用于和<code>WMS</code>通信，不过<code>WindowManager</code>是一个接口类，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WindowManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewManager</span> {...}
</code></pre>
<p><code>mWindowManager</code>也是在<code>attach()</code>方法中进行的初始化，相关代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
        mWindow.setWindowManager(
                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
                mToken, mComponent.flattenToString(),
                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="hljs-number">0</span>);
        ...
        mWindowManager = mWindow.getWindowManager();
        ...
    }
</code></pre>
<p>在<code>attach()</code>方法中，对<code>mWindowManager</code>变量的赋值是调用<code>mWindow</code>的<code>getWindowManager()</code>方法完成的。</p>
<p>但是在这之前，<code>attach()</code>方法中还调用了<code>mWindow</code>对象的<code>setWindowManager()</code>方法。前面我们已经知道<code>mWindow</code>对象的类型是<code>PhoneWindow</code>，不过这个<code>setWindowManager()</code>方法是在基类<code>Window</code>中实现的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWindowManager</span><span class="hljs-params">(WindowManager wm, IBinder appToken, String appName,
            <span class="hljs-type">boolean</span> hardwareAccelerated)</span> {
        mAppToken = appToken;
        mAppName = appName;
        mHardwareAccelerated = hardwareAccelerated
                || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (wm == <span class="hljs-literal">null</span>) {
            wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);
        }
        mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="hljs-built_in">this</span>);
    }
    <span class="hljs-keyword">public</span> WindowManager <span class="hljs-title function_">getWindowManager</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mWindowManager;
    }
</code></pre>
<p>在<code>setWindowManager()</code>方法中，调用了<code>WindowManagerImpl</code>类的<code>createLocalWindowManager()</code>方法创建了<code>mWindowManager</code>对象，这个方法也很简单：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> WindowManagerImpl <span class="hljs-title function_">createLocalWindowManager</span><span class="hljs-params">(Window parentWindow)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerImpl</span>(mContext, parentWindow);
    }
</code></pre>
<p><code>createLocalWindowManager()</code>方法中新创建了一个<code>WindowManagerImpl</code>对象，因此，每个<code>Activity</code>中的<code>mWindowManager</code>对象实际上是一个<code>WindowManagerImpl</code>对象，我们再看下这个类的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WindowManagerGlobal</span> <span class="hljs-variable">mGlobal</span> <span class="hljs-operator">=</span> WindowManagerGlobal.getInstance();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Window mParentWindow;
    ...
}
</code></pre>
<p>在<code>WindowManagerImpl</code>中定义了一个<code>mGlobal</code>变量，它的值是通过<code>WindowManagerGlobal.getInstance()</code>得到的，看样子是个单例模式，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerGlobal <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (sDefaultWindowManager == <span class="hljs-literal">null</span>) {
                sDefaultWindowManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerGlobal</span>();
            }
            <span class="hljs-keyword">return</span> sDefaultWindowManager;
        }
    }
</code></pre>
<p><code>getInstance()</code>方法中创建了一个全局唯一的<code>WindowManagerGlobal</code>对象并保存到静态变量<code>sDefaultWindowManager</code>中</p>
<p>而<code>WindowManagerImpl</code>中各种方法的实现只是在转调<code>WindowManagerGlobal</code>类中的方法，由此可见，<strong>一个应用中所有<code>Activity</code>都是通过这个进程内唯一的<code>WindowManagerGlobal</code>对象和<code>WMS</code>通信</strong></p>
<p><code>WindowManagerGlobal</code>类中还有3个重要的成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerGlobal</span> {
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;View&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ViewRootImpl&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;WindowManager.LayoutParams&gt;();
    ...
}
</code></pre>
<ul>
<li><code>mViews</code>：保存了应用中所有顶层<code>View</code>对象，也就是<code>DecorView</code>(稍后细讲)</li>
<li><code>mRoots</code>：保存的是和顶层<code>View</code>对象关联的<code>ViewRootImpl</code>对象</li>
<li><code>mParams</code>：保存的是创建顶层<code>View</code>的<code>layout</code>参数</li>
</ul>
<h3 data-id="heading-4">建立应用和WMS的联系</h3>
<p>我们知道在<code>ActivityThread</code>中的<code>handleResumeActivity()</code>中会创建<code>ViewRootImpl</code>对象并进行显示，我们来看下<code>ViewRootImpl</code>中关键的几个变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRootImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ViewParent</span>,
        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {
    ...
    <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
    ...
    <span class="hljs-keyword">final</span> W mWindow;
    ...
}
</code></pre>
<p>变量的初始化是在构造方法中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display)</span> {
        mContext = context;
        mWindowSession = WindowManagerGlobal.getWindowSession();
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">W</span>(<span class="hljs-built_in">this</span>);
        ...
    }
</code></pre>
<p>重点是进行了<code>mWindowSession</code>和<code>mWindow</code>的创建，我们逐一看下</p>
<h4 data-id="heading-5">IWindowSession对象的创建</h4>
<p><code>mWindowSession</code>变量的类型是<code>IWindowSession</code>，它是<code>WMS</code>中某个<code>Binder</code>对象的引用对象，<code>mWindowSession</code>的值是通过<code>WindowManagerGlobal</code>的<code>getWindowSession()</code>方法获得的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWindowSession <span class="hljs-title function_">getWindowSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (
            `sWindowSession`== <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> InputMethodManager.getInstance();
                    <span class="hljs-type">IWindowManager</span> <span class="hljs-variable">windowManager</span> <span class="hljs-operator">=</span> getWindowManagerService();
                    sWindowSession = windowManager.openSession(
                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">IWindowSessionCallback</span>.Stub() {
                                <span class="hljs-meta">@Override</span>
                                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimatorScaleChanged</span><span class="hljs-params">(<span class="hljs-type">float</span> scale)</span> {
                                    ValueAnimator.setDurationScale(scale);
                                }
                            },
                            imm.getClient(), imm.getInputContext());
                } <span class="hljs-keyword">catch</span> (RemoteException e) {
                    <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();
                }
            }
            <span class="hljs-keyword">return</span> sWindowSession;
        }
    }
</code></pre>
<p>如果<code>sWindowSession</code>为空，先获取<code>InputMethodManager</code>对象，然后调用<code>WMS</code>的<code>openSession()</code>接口来进行创建，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IWindowSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(IWindowSessionCallback callback, IInputMethodClient client,
            IInputContext inputContext)</span> {
        <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null client"</span>);
        <span class="hljs-keyword">if</span> (inputContext == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null inputContext"</span>);
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Session</span>(<span class="hljs-built_in">this</span>, callback, client, inputContext);
        <span class="hljs-keyword">return</span> session;
    }
</code></pre>
<p><code>openSession()</code>直接创建了一个<code>Session</code>对象，这个<code>Session</code>类我们<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>简单介绍过，它是一个<code>Binder</code>服务类，简要定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Session</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowSession</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient {...}
</code></pre>
<p>对于用户进程而言，获取到的便是这个<code>Session</code>对象的<code>Binder</code>引用对象，并保存在了<code>WindowManagerGlobal</code>的静态变量<code>sWindowSession</code>中。</p>
<p>因为<code>WindowManagerGlobal</code>在进程中属于单例的存在，因此，所有调用<code>getWindowSession()</code>方法返回的都是这个<code>sWindowSession</code>对象</p>
<p>因此，<strong>一个用户进程中的所有<code>ViewRootImpl</code>对象中的<code>mWindowSession</code>都引用的是相同的对象</strong>。而这个<code>mWindowSession</code>对象的作用便是向<code>WMS</code>发起<code>Window</code>相关的<code>Binder</code>调用</p>
<blockquote>
<p>应用进程通过<code>sWindowSession</code>对象可以调用到<code>WMS</code>的功能方法了，那么<code>WMS</code>是如何通知或者控制应用进程的呢？</p>
</blockquote>
<h4 data-id="heading-6">W</h4>
<p>在<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>已经介绍过<code>ActivityThread</code>的<code>handleResumeActivity()</code>方法了，最后会调用到<code>WindowManagerGlobal</code>对象的<code>addView()</code>方法，方法内容如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow)</span> {
        ...
        ViewRootImpl root;
        <span class="hljs-type">View</span> <span class="hljs-variable">panelParentView</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">synchronized</span> (mLock) {
            ...
            root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(), display);
            view.setLayoutParams(wparams);

            mViews.add(view);
            mRoots.add(root);
            mParams.add(wparams);

            <span class="hljs-keyword">try</span> {
                root.setView(view, wparams, panelParentView);
            }
            ...
        }
    }
</code></pre>
<p><code>addView()</code>方法中最重要的是创建了<code>ViewRootImpl</code>对象，并通过<code>setView()</code>把它和顶层的<code>View</code>对象关联在了一起。<code>setView()</code>方法简要如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        <span class="hljs-keyword">if</span> (mView == <span class="hljs-literal">null</span>) {
            mView = view;
            ...
            requestLayout();
            ...
            <span class="hljs-keyword">try</span> {
                mOrigWindowType = mWindowAttributes.type;
                mAttachInfo.mRecomputeGlobalAttributes = <span class="hljs-literal">true</span>;
                collectViewAttributes();
                res = mWindowSession.addToDisplay(mWindow, ...);
            }
            ...
        }
    }
}
</code></pre>
<p><code>setView()</code>方法比较长，我们需要关注的是：</p>
<ul>
<li>方法中对<code>ViewRootImpl</code>对象和顶层<code>View</code>之间的关联只会执行一次，如果<code>mView</code>不为空，不会再次赋值</li>
<li>方法中调用了<code>Session</code>的<code>addToDisplay()</code>方法，更为重要的是参数<code>mWindow</code></li>
</ul>
<p><code>mWindow</code>的类型是<code>W</code>，它是一个<code>ViewRootImpl</code>的静态内部类，定义如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">W</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindow</span>.Stub {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;ViewRootImpl&gt; mViewAncestor;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
        ...
    }
</code></pre>
<p>可以看出<code>W</code>是一个实现了<code>IWindow</code>接口的<code>Binder</code>服务类，并且在<code>ViewRootImpl</code>中通过<code>Session.addToDisplay()</code>方法将<code>W</code>的<code>Binder</code>引用对象传递给了<code>WMS</code></p>
<p>我们看下源码中对<code>IWindow</code>接口的描述：</p>
<blockquote>
<p>API back to a client window that the Window Manager uses to inform it of interesting things happening.</p>
</blockquote>
<p>可以看出<code>WMS</code>通过<code>IWindow</code>接口来通知应用，接下来看下<code>WMS</code>中是如何处理这个对象的</p>
<p><em><strong>秋地麻袋～，还记得我们前言中的问题吗，快看<code>setView</code>中的<code>requestLayout</code>方法</strong></em></p>
<blockquote>
<p>是不是勾起了作为应用开发者的回忆</p>
</blockquote>
<h4 data-id="heading-7">Surface 和 Activity 的联系</h4>
<p><code>ViewRootImpl.setView()</code> 会触发 <code>requestLayout()</code>，最终执行到核心方法 <code>performTraversals()</code>（这是 View 绘制三大流程 Measure/Layout/Draw 的入口）</p>
<p><code>performTraversals()</code> 800 多行。。。简要代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码逻辑 ViewRootImpl.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 1. 通过 IPC 请求 WindowManagerService (WMS) 对窗口进行布局</span>
    <span class="hljs-comment">// mSurface 是 ViewRootImpl 的成员变量</span>
    relayoutResult = mWindowSession.relayout(..., mSurface, ...);

    <span class="hljs-comment">// 2. WMS 在底层创建 SurfaceControl，并将 Native 层的 Surface 信息</span>
    <span class="hljs-comment">// 回写（Copy）到 ViewRootImpl 的 mSurface 中。</span>
    <span class="hljs-comment">// 后面会细讲</span>
    
    <span class="hljs-keyword">if</span> (mSurface.isValid()) {
        <span class="hljs-comment">// Surface 此时已经准备好，可以合成了</span>
    }
    <span class="hljs-comment">// ...</span>
    performMeasure(...);
    performLayout(...);
    performDraw(...);
}
</code></pre>
<p>在 <code>relayout</code> 过程中，<code>WMS</code> 会与 <code>SurfaceFlinger</code> 通信，分配 <code>Layer</code>（图层）。<code>WMS</code> 将生成的 <code>Surface</code> 信息填充到 <code>ViewRootImpl</code> 传入的 <code>mSurface</code> 参数中。</p>
<blockquote>
<p>这样，一个 Activity 就和 SurfaceFlinger 中的 Surface 产生了关联啦。</p>
</blockquote>
<p><span id="user-content-WMS2APP"/></p>
<h3 data-id="heading-8">WMS中建立和应用的关系</h3>
<p>前面提到<code>ViewRootImpl</code>对象会通过<code>addToDisplay()</code>方法将<code>IWindow</code>的<code>Binder</code>引用对象传递到<code>WMS</code>中，我们先看下<code>addToDisplay()</code>方法：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 方法定义在 com.android.server.wm.Session 中</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addToDisplay</span><span class="hljs-params">(IWindow window, ...)</span> {
        <span class="hljs-comment">// mService 的类型便是 WindowManagerService</span>
        <span class="hljs-keyword">return</span> mService.addWindow(<span class="hljs-built_in">this</span>, window, ...);
    }
</code></pre>
<p>调用了<code>WMS</code>的<code>addWindow()</code>方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addWindow</span><span class="hljs-params">(Session session, IWindow client, ...)</span> {
    ...
    <span class="hljs-keyword">synchronized</span>(mWindowMap) {
        ...
        <span class="hljs-keyword">if</span> (mWindowMap.containsKey(client.asBinder())) {
            Slog.w(TAG_WM, <span class="hljs-string">"Window "</span> + client + <span class="hljs-string">" is already added"</span>);
            <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD;
        }
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-built_in">this</span>, session, client, token, parentWindow,
                appOp[<span class="hljs-number">0</span>], seq, attrs, viewVisibility, session.mUid,
                session.mCanAddInternalSystemWindow);
        ...
        win.attach();
        mWindowMap.put(client.asBinder(), win);
        win.initAppOpsState();
        ...
    }
    ...
    <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><code>addWindow()</code>方法代码在200多行，此处我们需要关注的部分是：</p>
<ul>
<li>创建了<code>WindowState</code>对象并添加到<code>mWindowMap</code>集合中</li>
<li>调用<code>WindowState</code>对象的<code>attach()</code>方法</li>
</ul>
<p><code>WindowState</code>后面会详细介绍，此处的关键定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">final</span> Session mSession;
    <span class="hljs-keyword">final</span> IWindow mClient;
    ...
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (localLOGV) Slog.v(TAG, <span class="hljs-string">"Attaching "</span> + <span class="hljs-built_in">this</span> + <span class="hljs-string">" token="</span> + mToken);
        mSession.windowAddedLocked(mAttrs.packageName);
    }
}
</code></pre>
<ul>
<li><code>mClient</code>是应用进程中<code>Binder</code>服务对象<code>W</code>的引用对象</li>
<li><code>mSession</code>便是<code>WMS</code>对外封装的对象之一。以前面的<code>addToDisplay()</code>为例，实际上只是转调了<code>WMS</code>的<code>addWindow()</code>方法</li>
<li><code>attach()</code>方法也只是调用了<code>mSession</code>对象的<code>windowAddedLocked()</code>方法</li>
</ul>
<p>继续看下<code>windowAddedLocked()</code>方法:</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">void</span> <span class="hljs-title function_">windowAddedLocked</span><span class="hljs-params">(String packageName)</span> {
        mPackageName = packageName;
        mRelayoutTag = <span class="hljs-string">"relayoutWindow: "</span> + mPackageName;
        <span class="hljs-keyword">if</span> (mSurfaceSession == <span class="hljs-literal">null</span>) {
            mSurfaceSession = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SurfaceSession</span>();
            mService.mSessions.add(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) {
                mService.dispatchNewAnimatorScaleLocked(<span class="hljs-built_in">this</span>);
            }
        }
        mNumWindow++;
    }
</code></pre>
<p><code>windowAddedLocked()</code>方法</p>
<ul>
<li>首先检查了<code>mSurfaceSession</code>的值，当为空时才会创建<code>SurfaceSession</code>对象
<ul>
<li>前面<a href="https://juejin.cn/post/6944960866404007944#heading-7" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-7">图像显示</a>部分介绍过，<code>SurfaceSession</code>对象是用来创建<code>Surface</code>的</li>
</ul>
</li>
<li>然后将<code>Session</code>对象本身添加到<code>WMS</code>的<code>mSessions</code>列表中</li>
</ul>
<p>到这里，应用进程就和<code>WMS</code>各自持有了对方的<code>Binder</code>引用对象，形成了一个双向<code>Binder</code>通道，示意图如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c770d89efe34906bf922df504d858aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=NaEwJ3G6o3LRkFsTlJKCfHjPwjA%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-9">DecorView</h3>
<p>关于<code>DecorView</code>，还是要从我们最熟悉的地方说起。</p>
<p>在<code>Activity</code>的<code>onCreate()</code>中调用<code>setContentView()</code>方法时，我们看下发生了什么：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span> {
        getWindow().setContentView(layoutResID);
        initWindowDecorActionBar();
    }
</code></pre>
<p><code>Activity</code>的<code>onCreate()</code>调用的是<code>Window</code>类的<code>setContentView()</code>，这是个抽象方法，具体的实现在<code>PhoneWindow.java</code>中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            installDecor();
        }
        ...
    }
</code></pre>
<p>如果<code>mContentParent</code>对象还没有创建出来，则会调用<code>installDecor()</code>方法，方法如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installDecor</span><span class="hljs-params">()</span> {
        mForceDecorInstall = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (mDecor == <span class="hljs-literal">null</span>) {
            mDecor = generateDecor(-<span class="hljs-number">1</span>); <span class="hljs-comment">// 创建 DecorView</span>
            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);
            mDecor.setIsRootNamespace(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="hljs-number">0</span>) {
                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);
            }
        } <span class="hljs-keyword">else</span> {
            mDecor.setWindow(<span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            mContentParent = generateLayout(mDecor); <span class="hljs-comment">// 为DecorView设置布局格式，并返回 mContentParent</span>
        }
    }
</code></pre>
<p><code>installDecor()</code>方法</p>
<ul>
<li>
<p>先根据成员变量<code>mDecor</code>是否为空来决定是否进行<code>DecorView</code>的创建</p>
<ul>
<li>对象的创建方法为<code>generateDecor()</code>，内容如下：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> DecorView <span class="hljs-title function_">generateDecor</span><span class="hljs-params">(<span class="hljs-type">int</span> featureId)</span> {
    Context context;
    ... <span class="hljs-comment">// 省略 context 的创建过程</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecorView</span>(context, featureId, <span class="hljs-built_in">this</span>, getAttributes());
}
</code></pre>
</li>
<li>
<p>然后通过<code>generateLayout()</code>方法为创建好的<code>DecorView</code>设置布局格式，并返回<code>mContentParent</code>对象</p>
</li>
</ul>
<p>我们再看下<code>DecorView</code>的定义</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecorView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameLayout</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RootViewSurfaceTaker</span>, WindowCallbacks {
    ...
}
</code></pre>
<p>其实就是个自定义的<code>ViewGroup</code>，只是这个<code>DecorView</code>在<code>Android</code>中作为顶级<code>View</code>去使用</p>
<h2 data-id="heading-10"><code>WindowManagerService</code>服务</h2>
<p><code>WMS</code>服务的启动，要从<code>SystemServer</code>中的<code>startOtherServices()</code>方法说起，关键代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">()</span> {
    ...
    wm = WindowManagerService.main(..., <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindowManager</span>());
    ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="hljs-comment">/* allowIsolated= */</span> <span class="hljs-literal">false</span>,
            DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);
    ...
}
</code></pre>
<p>看下<code>main()</code>方法的定义：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerService <span class="hljs-title function_">main</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        DisplayThread.getHandler().runWithScissors(() -&gt;
                sInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerService</span>(context, im, haveInputMethods, showBootMsgs,
                        onlyCore, policy), <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> sInstance;
    }
</code></pre>
<p><code>main()</code>方法主要是初始化了<code>WindowManagerService</code>对象，我们需要注意的是它的最后的参数<code>WindowManagerPolicy policy</code>，它的具体的实现类是<code>PhoneWindowManager</code></p>
<p>再看下<code>WindowManagerService</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, WindowManagerPolicy.WindowManagerFuncs {
    ...
    <span class="hljs-keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();
    <span class="hljs-keyword">final</span> <span class="hljs-type">WindowHashMap</span> <span class="hljs-variable">mWindowMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowHashMap</span>();
    <span class="hljs-keyword">final</span> WindowManagerPolicy mPolicy;
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">WindowManagerService</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        ...
        mPolicy = policy;
        ...
    }
}
</code></pre>
<p>其中的关键成员如下：</p>
<ul>
<li>
<p><code>mSessions</code>中储存的是<code>Session</code>服务类的对象，每个应用在<code>WMS</code>中都有一个对应的<code>Session</code>对象，它们都保存在<code>mSessions</code>中</p>
</li>
<li>
<p><code>mWindowMap</code>中类型是<code>WindowHashMap</code>，保存的是所有窗口的<code>WindowState</code>对象。<code>WindowHashMap</code>定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowHashMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;IBinder, WindowState&gt; {
}
</code></pre>
<ul>
<li>此处并未做任何删减哈，源码中就是简单地继承了<code>HashMap&lt;IBinder, WindowState&gt;</code></li>
<li><code>WindowState</code>表示一个窗口的所有属性，它便是是<code>WMS</code>中的窗口。等下细讲</li>
</ul>
</li>
<li>
<p><code>mPolicy</code>是<code>WMS</code>中执行窗口管理策略的对象，类型是<code>WindowManagerPolicy</code>，这是一个接口类</p>
<ul>
<li>从<code>SystemServer</code>的<code>startOtherServices()</code>中可以看出具体的实现类是<code>PhoneWindowManager</code></li>
<li>在<code>Android</code>中<code>WMS</code>只是负责窗口管理的框架部分，通过<code>策略模式</code>将框架和窗口实现细节进行了分离</li>
</ul>
</li>
</ul>
<p>对比<code>9.0</code>和<code>5.0</code>源码，<code>WMS</code>关于窗口部分设计变化很大，在了解<code>Android</code>如何添加一个窗口前，我们先看下<code>Android</code>中窗口类型的定义</p>
<h3 data-id="heading-11">窗口类型</h3>
<p>在<code>WMS</code>中定义了3中窗口：<code>应用窗口</code>、<code>子窗口</code>和<code>系统窗口</code>，相关的定义都是在<code>frameworks/base/core/java/android/view/WindowManager.java</code>中，确切的说应该是在<code>WindowManager.LayoutParams</code>类中定义</p>
<h4 data-id="heading-12">应用窗口(<code>application window</code>)</h4>
<p>应用窗口是<code>Activity</code>使用的全屏窗口，<code>Android</code>定义了4种不同类型的应用窗口</p>
<ul>
<li><code>TYPE_BASE_APPLICATION</code>：基础应用窗口，应用中所有窗口都位于它的上层。只能由系统创建</li>
<li><code>TYPE_APPLICATION</code>：<code>Activity</code>的顶层窗口，应用中最常见的一种</li>
<li><code>TYPE_APPLICATION_STARTING</code>：应用启动时由系统创建的窗口，显示一些信息，直到应用创建的窗口显示出来</li>
<li><code>TYPE_DRAWN_APPLICATION</code>：类似于普通的<code>TYPE_APPLICATION</code>，<code>WMS</code>针对类型额外增加了等待机制</li>
</ul>
<h4 data-id="heading-13">子窗口(<code>sub-window</code>)</h4>
<p>子窗口是指依附于应用窗口或系统窗口的窗口类型，它们一般随所依附的窗口一起出现或切换到后台。<code>Android</code>中定义了6种子窗口类型</p>
<ul>
<li><code>TYPE_APPLICATION_PANEL</code>：应用Panel窗口，显示在依附窗口的上层</li>
<li><code>TYPE_APPLICATION_MEDIA</code>：应用Media窗口，通常包含独立的Surface，显示在依附窗口的下层</li>
<li><code>TYPE_APPLICATION_SUB_PANEL</code>：应用子Panel窗口，显示在依附窗口和<code>TYPE_APPLICATION_PANEL</code>的上层</li>
<li><code>TYPE_APPLICATION_ATTACHED_DIALOG</code>：和<code>TYPE_APPLICATION_PANEL</code>类似，但是窗口的布局方式和<code>Activity</code>的顶层窗口相同</li>
<li><code>TYPE_APPLICATION_MEDIA_OVERLAY</code>：一种显示在<code>TYPE_APPLICATION_MEDIA</code>和所依附窗口之间的半透明窗口。一般用来显示<code>Video</code>的字幕或者相机的操作提示界面</li>
<li><code>TYPE_APPLICATION_ABOVE_SUB_PANEL</code>：一种显示在<code>TYPE_APPLICATION_SUB_PANEL</code>之上的窗口</li>
</ul>
<h4 data-id="heading-14">系统窗口(<code>system window</code>)</h4>
<p>系统窗口大都用于系统生成的UI中，一般比较独立，种类非常多，我们挑几个常见的看下</p>
<ul>
<li><code>TYPE_STATUS_BAR</code>：状态栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_SEARCH_BAR</code>：搜索栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_PHONE</code>：电话窗口，提供用户与电话的交互界面，通常位于所用应用窗口的上方，但是在状态栏的后面</li>
<li><code>TYPE_SYSTEM_ALERT</code>：系统警告窗口，位于所用应用窗口的上方</li>
<li><code>TYPE_TOAST</code>：临时通知窗口，显示一些提示信息</li>
</ul>
<p>还有很多就不一一列举了，<code>Android</code>对<code>系统窗口</code>的定义有39种之多，源码中有着详细的注释，大家可以在<code>WindowManager.java</code>中找到(<a href="https://link.juejin.cn?target=http%3A%2F%2Fandroidxref.com%2F9.0.0_r3%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FWindowManager.java%23697" target="_blank" title="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowManager.java#697" ref="nofollow noopener noreferrer">传送门</a>)</p>
<p><strong>那么<code>WMS</code>中是怎么定义窗口的呢？</strong></p>
<h3 data-id="heading-15"><code>WMS</code>中窗口的设计</h3>
<blockquote>
<p>前面讲过（<code>WMS</code>的<code>addWindow()</code>方法），当向<code>WMS</code>添加一个窗口时，<code>WMS</code>会为其创建一个<code>WindowState</code>。对于<code>WindowState</code>来说，它包含了一个窗口的所有属性，所以它是<code>WMS</code>中真正意义上的窗口</p>
</blockquote>
<p>先看下<code>WindowState</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    WindowToken mToken;
    AppWindowToken mAppToken;
    ...
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mBaseLayer;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mSubLayer;
}
</code></pre>
<p><code>WindowState</code>继承了<code>WindowContainer</code>，又是和书中不一样的地方</p>
<blockquote>
<p>对比5.0源码，很明显在<code>Window</code>这部分<code>Android</code>做了重构（设计模式看上去像是<code>组合模式</code>），优化了类结构，抽象出了<code>WindowContainer</code>用来支撑起整个窗口体系</p>
</blockquote>
<p>基于<code>Android 9.0</code>源码，窗口体系的关系梳理如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2dcd21f21c44ce48b16279606ba5d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=ESLkSCnWfFCwab6KKqZzZ5yiLvY%3D" alt="image" loading="lazy"/></p>
<p>类图中涉及到的类的信息下：</p>
<ul>
<li>
<p><code>WindowContainer</code></p>
<ul>
<li>成员变量<code>mChildren</code>的类型是<code>WindowList</code>，看实现其实就是<code>ArrayList&lt;WindowState&gt;</code>。又因为<code>WindowToken</code>继承了<code>WindowContainer</code>，所以该成员变量子类都会继承过来</li>
<li>所有拥有相同<code>Token</code>的窗口(<code>WindowState</code>)都会存放在<code>mChildren</code>中，</li>
</ul>
</li>
<li>
<p><code>WindowToken</code></p>
<ul>
<li>成员变量<code>token</code>是<code>IBinder</code>对象，具有系统唯一性，向<code>WMS</code>的<code>mWindowMap</code>中添加对象时都是使用这个<code>token</code>值</li>
<li>定义了<code>AppWindowToken asAppWindowToken()</code>，默认返回<code>null</code></li>
</ul>
</li>
<li>
<p><code>AppWindowToken</code></p>
<ul>
<li>继承自<code>WindowToken</code>并重写了<code>AppWindowToken asAppWindowToken()</code>方法，返回<code>this</code></li>
<li>这样便可以通过<code>asAppWindowToken()</code>的返回值判断是那种<code>Token</code></li>
</ul>
</li>
<li>
<p><code>DisplayContent</code></p>
<ul>
<li>继承自<code>WindowContainer</code>，真正意义上的屏幕，<code>WMS</code>中一个<code>DisplayContent</code>实例表示一个屏幕。多屏幕会对应多个实例</li>
<li>内部定义了4种存放<code>Window</code>的容器，都是直接或间接继承自<code>WindowContainer</code>：
<ul>
<li><code>mTaskStackContainers</code>：用来保存所有的应用窗口</li>
<li><code>mAboveAppWindowsContainers</code>：用来保存显示在应用窗口的上面的非应用窗口</li>
<li><code>mBelowAppWindowsContainers</code>：用来保存显示在应用窗口的下面的非应用窗口</li>
<li><code>mImeWindowsContainers</code>：用来保存 IME Window</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>RootWindowContainer</code></p>
<ul>
<li>代表<code>WMS</code>中窗口的根容器，所有<code>DisplayContent</code>的实例都会添加到其中</li>
<li><code>RootWindowContainer</code>在<code>WMS</code>的构造方法中初始化为<code>mRoot</code>对象</li>
</ul>
</li>
</ul>
<p>还是回到<code>WindowState</code>，类中定义了两个常量<code>mBaseLayer</code>和<code>mSubLayer</code>，通过这两个常量便可以确定一个<code>Window</code>所在的层级。这部分就不细讲了哈，涉及点有点多，后面用到再来补充吧，嘻嘻</p>
<p>我们重点看下面两个知识点：<code>WMS</code>的<code>addWindow</code>和<code>relayoutWindow</code>的设计</p>
<h4 data-id="heading-16">addWindow方法</h4>
<p><code>addWindow()</code>在<a href="#WMS2APP" title="#WMS2APP">WMS中建立和应用的关系</a>已经介绍，不再赘述</p>
<h4 data-id="heading-17">relayoutWindow方法</h4>
<p>前面介绍过，在<code>Activity</code>的<code>onResume</code>阶段，通过<code>ViewRootImpl</code>的<code>setView</code>方法开始渲染<code>View</code>的流程。</p>
<p><code>setView</code>方法中会通过<code>requestLayout()</code>开始测量渲染，这个方法中有一个核心的逻辑就是调用<code>WMS</code>的<code>relayoutWindow()</code>，重新测量<code>Window</code>，简要流程如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//ViewRootImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) {
        ...
        scheduleTraversals();
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    ...
    relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);
    ...
}
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(WindowManager.LayoutParams params, <span class="hljs-type">int</span> viewVisibility,
        <span class="hljs-type">boolean</span> insetsPending)</span> <span class="hljs-keyword">throws</span> RemoteException {
    ...
    <span class="hljs-type">int</span> <span class="hljs-variable">relayoutResult</span> <span class="hljs-operator">=</span> mWindowSession.relayout(mWindow, mSeq, params,
            (<span class="hljs-type">int</span>) (mView.getMeasuredWidth() * appScale + <span class="hljs-number">0.5f</span>),
            (<span class="hljs-type">int</span>) (mView.getMeasuredHeight() * appScale + <span class="hljs-number">0.5f</span>), viewVisibility,
            insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="hljs-number">0</span>, frameNumber,
            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,
            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingDisplayCutout,
            mPendingMergedConfiguration, mSurface);
    ...
    <span class="hljs-keyword">return</span> relayoutResult;
}
</code></pre>
<p><code>relayoutWindow()</code>通过<code>Session</code>的<code>relayout()</code>方法调用到<code>WMS</code>的<code>relayoutWindow()</code>方法</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayout</span><span class="hljs-params">(IWindow window, <span class="hljs-type">int</span> seq, ...)</span> {
        ...
        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> mService.relayoutWindow(<span class="hljs-built_in">this</span>, window, seq, attrs,
                requestedWidth, requestedHeight, viewFlags, flags, frameNumber,
                outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,
                outStableInsets, outsets, outBackdropFrame, cutout,
                mergedConfiguration, outSurface);
        ...
        <span class="hljs-keyword">return</span> res;
    }
</code></pre>
<p><code>WMS</code>中的<code>relayoutWindow()</code>代码比较复杂，我们简单看下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(...)</span> {
        ...
        <span class="hljs-keyword">synchronized</span>(mWindowMap) {
            <span class="hljs-comment">// 从 mWindowMap 取出对应的 WindowState 对象</span>
            <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> windowForClientLocked(session, client, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">if</span> (win == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            displayId = win.getDisplayId();
            ...
            <span class="hljs-comment">// 调用 WindowSurfacePlacer 的 performSurfacePlacement 方法</span>
            <span class="hljs-comment">// 这个方法其实就是检查清理无用的 Surface 对象，为后面创建 Surface 做准备</span>
            <span class="hljs-comment">// 详细的方法就不贴出来了，大家可以自行阅读</span>
            mWindowPlacerLocked.performSurfacePlacement(<span class="hljs-literal">true</span> <span class="hljs-comment">/* force */</span>);
            <span class="hljs-keyword">if</span> (shouldRelayout) {
                result = win.relayoutVisibleWindow(result, attrChanges, oldVisibility);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 创建 Surface ，确切的说应该是创建 WindowSurfaceController 对象</span>
                    <span class="hljs-comment">// WindowSurfaceController 其实就是对 Surface 和 SurfaceControl 的封装</span>
                    <span class="hljs-comment">// Surface 和 SurfaceControl 的关系在十二章已经介绍啦</span>
                    result = createSurfaceControl(outSurface, result, win, winAnimator);
                } 
                ...
            } <span class="hljs-keyword">else</span> {
                ...
            }
            <span class="hljs-keyword">if</span> (focusMayChange) {
                <span class="hljs-comment">// 如果窗口发生了变化，调用 updateFocusedWindowLocked 方法重新测量窗口大小</span>
                <span class="hljs-comment">// 这个方法才是真正的核心测量窗口大小逻辑</span>
                <span class="hljs-comment">// 方法中会调用 DisplayContent.performLayout 方法开始真正的测量</span>
                <span class="hljs-keyword">if</span> (updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,
                        <span class="hljs-literal">false</span> <span class="hljs-comment">/*updateInputWindows*/</span>)) {
                    imMayMove = <span class="hljs-literal">false</span>;
                }
            }
            ...
            win.mInRelayout = <span class="hljs-literal">false</span>;
        }
        ...
    }
</code></pre>
<p>在 <code>WMS</code> 的 <code>relayoutWindow()</code> 方法中，核心逻辑在于 <code>createSurfaceControl</code> 的调用。</p>
<pre><code class="hljs language-java" lang="java">result = createSurfaceControl(outSurface, result, win, winAnimator);
</code></pre>
<p>这里的参数 outSurface 至关重要。回看 ViewRootImpl 调用 relayout 的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ViewRootImpl.java</span>
mWindowSession.relayout(..., mSurface);
</code></pre>
<p>我们可以明确看到，<code>ViewRootImpl</code> 将自己的成员变量 mSurface 传递给了 <code>WMS</code>。 在 <code>WMS</code> 内部，<code>createSurfaceControl</code> 会请求 <code>SurfaceFlinger</code> 创建图层（<code>Layer</code>），并将生成的 <code>Native</code> 层 <code>Surface</code> 信息回写（<code>Copy</code>）到传入的 <code>outSurface</code> 参数中。</p>
<p>这意味着： 当 <code>relayoutWindow</code> 调用返回时，应用进程 <code>ViewRootImpl</code> 中的 <code>mSurface</code> 对象就已经持有了真正的图形缓冲区引用，随后应用便可以利用这个 <code>Surface</code> 进行绘图。</p>
<blockquote>
<p>怎么说～怎么说～。前言的问题是不是明了啦</p>
</blockquote>
<h2 data-id="heading-18">总结</h2>
<p>Android 的窗口系统是一个典型的 <code>C/S</code> 架构，由应用进程（Client）和 <code>WindowManagerService</code>（Server）共同构成：</p>
<p><strong>应用端 (Client)</strong></p>
<ul>
<li>
<p><code>Activity</code> 负责生命周期，持有一个 <code>PhoneWindow</code> 对象来管理视图策略。</p>
</li>
<li>
<p><code>DecorView</code> 是视图树的根节点。</p>
</li>
<li>
<p><code>ViewRootImpl</code> 是核心管理者，它连接了 DecorView 和 <code>WMS</code>，并持有 <code>Surface</code> 对象，负责发起绘制流程（Measure/Layout/Draw）。</p>
</li>
<li>
<p><code>WindowManagerGlobal</code> 是进程单例，负责管理当前进程所有的 <code>ViewRootImpl</code> 和 <code>View</code>。</p>
</li>
</ul>
<p><strong>通信层 (IPC)</strong></p>
<ul>
<li>
<p><code>IWindowSession</code>：应用向 <code>WMS</code> 发送请求的通道（如 <code>addToDisplay</code>, <code>relayout</code>）。</p>
</li>
<li>
<p><code>IWindow</code> (<code>W</code>类)：<code>WMS</code> 回调应用的通道（如窗口焦点变化、配置改变）。</p>
</li>
</ul>
<p><strong>服务端 (WMS)</strong></p>
<ul>
<li>
<p><code>WindowState</code>：<code>WMS</code> 中代表一个窗口的实体，保存窗口的所有属性。</p>
</li>
<li>
<p><code>WindowContainer</code>：构建了层级化的窗口容器结构（<code>DisplayContent</code> -&gt; <code>TaskStack</code> -&gt; <code>WindowState</code>）。</p>
</li>
<li>
<p><code>Surface</code> 管理：<code>WMS</code> 在 <code>relayoutWindow</code> 过程中计算窗口大小与位置，并与 <code>SurfaceFlinger</code> 通信创建 <code>SurfaceControl</code>，最终将可用的 <code>Surface</code> 返回给应用端。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！]]></title>    <link>https://juejin.cn/post/7576018857368485931</link>    <guid>https://juejin.cn/post/7576018857368485931</guid>    <pubDate>2025-11-24T10:33:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576018857368485931" data-draft-id="7576026767372058643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-11-24T10:33:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:33:57.000Z" title="Mon Nov 24 2025 10:33:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：我们在生产环境里跑MyBatis-Plus很多年，几乎把能踩的坑都踩过了。每次出事故，都能追溯到我们当初以为“框架会帮忙搞定”的某个细节。于是我们把这些真实经历写下来，用更接地气的方式聊聊根因和解法，帮你少熬几次夜。</p>
</blockquote>
<h2 data-id="heading-0">1、时代背景与ORM选择</h2>
<h3 data-id="heading-1">1.1 互联网时代的数据挑战</h3>
<p>业务量暴涨，数据也跟着狂飙。百万级数据在几年前还算大，如今动不动就上亿。与此同时，微服务拆分得越来越细，数据访问层变得又厚又复杂。大家一边要追新需求，一边又要兼顾性能稳定。没有趁手的开发工具，根本顶不住节奏。</p>
<h3 data-id="heading-2">1.2 MyBatis-Plus的诞生与定位</h3>
<p>于是，Java团队开始在ORM世界里不断找平衡。Hibernate太重，原生MyBatis又太多手工活。MyBatis-Plus正是在这种“又想快又想稳”的诉求下出现的。它不是简单的“语法糖”，而是一个<strong>为了生产环境而生的增强框架</strong>。</p>
<p><strong>MyBatis-Plus的核心价值</strong>：</p>
<ul>
<li><strong>简化开发</strong>：CRUD都有封装，少写很多SQL，手更轻</li>
<li><strong>功能增强</strong>：逻辑删除、自动填充、乐观锁、多租户、代码生成器等都现成</li>
<li><strong>性能优化</strong>：内置分页、性能分析、批量优化、缓存插件，跑得更快</li>
<li><strong>无缝集成</strong>：兼容MyBatis，老项目也能慢慢替换，几乎不用重构</li>
</ul>
<p>这些卖点让MyBatis-Plus迅速走红。不过，功能多并不等于好用。特别是到了生产环境，隐藏的坑一个接一个。</p>
<hr/>
<h2 data-id="heading-3">2、生产环境挑战</h2>
<p>开发环境里一切都很顺。<code>saveBatch()</code>轻松搞定批量插入，<code>@TableId(type = IdType.ASSIGN_ID)</code>一写就有分布式ID，看起来稳得很。</p>
<p>然而，真正部署上线后问题才暴露出来。</p>
<p><strong>凌晨3点的告警</strong>：主键冲突，订单系统停摆。我们发现两个容器实例生成了同一个雪花ID。理论上“不可能发生”的事，就这么发生了。</p>
<p>再往下排查，批量操作乱序、枚举字段写入异常、自动填充失灵……问题一个比一个离谱。</p>
<p>这些事故有个共同点：开发环境一切正常，生产环境却崩成一片。根本原因是单机和分布式、低并发和高并发之间的差异，被框架默认配置无限放大，结果就是“看着没事”的代码在生产里频频掉链子。</p>
<p>我们因此整理出MyBatis-Plus在生产环境最容易暴雷的6大陷阱：</p>
<ol>
<li><strong>雪花算法ID生成重复问题</strong></li>
<li><strong>批量插入乱序问题</strong></li>
<li><strong>枚举字段存储风险</strong></li>
<li><strong>驼峰转换错位</strong></li>
<li><strong>批量操作时自动填充失效</strong></li>
<li><strong>写入时JSON数据丢失或格式异常</strong></li>
</ol>
<p>接下来我们把这些问题逐一拆开，聊聊背后的逻辑，再给出实测可行的解法。</p>
<hr/>
<h2 data-id="heading-4">雪花算法ID生成重复问题</h2>
<h3 data-id="heading-5">3.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 看起来很正常的代码</span>
<span class="hljs-meta">@TableId(value = "id", type = IdType.ASSIGN_ID)</span>
<span class="hljs-keyword">private</span> Long id;

<span class="hljs-comment">// 但在生产环境中却出现了这样的错误：</span>
<span class="hljs-comment">// Duplicate entry '1234567890123456789' for key 'PRIMARY'</span>
</code></pre>
<p><strong>“ID怎么还能撞？”</strong> 这是我们第一次遇到时的真实反应。</p>
<h3 data-id="heading-6">3.2 雪花算法身份证结构</h3>
<p>先搞清楚雪花ID里面装了什么，再谈如何防重复。可以把它想成一个<strong>超长身份证号</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">身份证号码：<span class="hljs-number">1234567890123456789</span>
分解结构：
┌─────────┬─────────┬─────────┬─────────┐
│  时间戳  │ 数据中心 │ 机器编号 │ 序列号  │
│ (<span class="hljs-number">41</span>位)  │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">12</span>位)  │
└─────────┴─────────┴─────────┴─────────┘
</code></pre>
<ul>
<li><strong>时间戳</strong>像出生年月日</li>
<li><strong>数据中心ID</strong>类似省份</li>
<li><strong>机器ID</strong>对应城市</li>
<li><strong>序列号</strong>就是同一毫秒的排队号</li>
</ul>
<h3 data-id="heading-7">3.3 问题根源</h3>
<p>我们把雪花ID重复的元凶总结成四类。</p>
<h4 data-id="heading-8">3.3.1 元凶一：未配置机器ID，所有实例走默认值</h4>
<p>很多人以为框架会自动算出唯一的workerId，于是干脆不配。结果大家都走同一个默认流程。</p>
<p><strong>MyBatis-Plus获取机器ID的策略</strong>：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9379840880d14a11ac86b0fc9e9eb751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=rVo4DnTclRpO28wXZg4WktiHOOw%3D" alt="yBatis-Plus获取机器ID的策略" loading="lazy"/></p>
<p>看似严谨，然而一旦进入第二步，容器环境下“撞车”概率直线上升。</p>
<h4 data-id="heading-9">3.3.2 元凶二：容器环境的MAC地址克隆</h4>
<p>先看Docker容器MAC地址的规律：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Docker</span>容器<span class="hljs-variable constant_">MAC</span>地址格式：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:XX</span>
                     ├─────────────┤├─┤
                     固定前缀      变化部分

容器<span class="hljs-number">1</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">02</span>
容器<span class="hljs-number">2</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">03</span>  
容器<span class="hljs-number">3</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">04</span>
...
</code></pre>
<p>如果继续依赖“取后两字节再模32”的做法，就会出现下面的情况：</p>
<pre><code class="hljs language-ini" lang="ini">MAC地址计算流程：
1. 提取后2字节 → 00:02, 00:03, 00:04...
2. 位运算处理 → 得到不同的中间值
3. 模32取余 → 问题就出在这里

实际结果：
├─ 容器1-32：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span>-<span class="hljs-number">31</span> ✅
├─ 容器33：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span> ❌
├─ 容器34：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">1</span> ❌
└─ 以此类推...
</code></pre>
<p>如此可见，只要实例超过32个，就一定有重复。</p>
<h4 data-id="heading-10">3.3.3 元凶三：Kubernetes环境的虚拟MAC</h4>
<p>再看K8s。Pod里的网络接口本来就是虚拟的，MAC地址由CNI随机分配，还可能拿不到。
Kubernetes Pod网络特点：</p>
<ol>
<li>每个Pod都有虚拟网络接口</li>
<li>MAC地址由CNI插件分配</li>
<li>同一节点的Pod可能模式一致</li>
<li>某些环境下干脆拿不到MAC
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63afa6655bd94b2ca6ac9bfd7dda7992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=uGX5C86XExDhN7PM0P8614khjKk%3D" alt="yBatis-Plus获取机器MAC地址" loading="lazy"/></li>
</ol>
<p>这种情况下，100个Pod全用workerId=1，冲突直接拉满。</p>
<h4 data-id="heading-11">3.3.4 元凶四：时钟回拨</h4>
<p>雪花算法非常依赖系统时间。一旦时钟被调回，就会闹出大问题。</p>
<p>雪花ID生成流程如下所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ba1c288dbad43a4851c820f8e746720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=poCH4A8q1wGGZC2tuSp9QYgh4rE%3D" alt="雪花ID生成流程" loading="lazy"/>
但是，如何出现时钟回拨，就会出现如下问题
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e0b8d6b11f4e139f23c14a23bf4950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=BRn6Hp0DE6X808TLRaksxNXnstY%3D" alt="时钟回拨" loading="lazy"/></p>
<p>当以下条件同时满足时，重复就无可避免：</p>
<pre><code class="hljs language-ini" lang="ini">相同的机器ID (<span class="hljs-attr">workerId</span>=<span class="hljs-number">1</span>)
相同的数据中心ID (<span class="hljs-attr">datacenterId</span>=<span class="hljs-number">1</span>)  
相同的时间戳 (<span class="hljs-attr">timestamp</span>=<span class="hljs-number">1634567890123</span>)
相同的序列号 (<span class="hljs-attr">sequence</span>=<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-12">3.4 解决方案：给每台机器一个专属身份证</h3>
<h4 data-id="heading-13">方案一：外部获取唯一的分布式ID</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdHelper</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>   <span class="hljs-type">long</span> <span class="hljs-title function_">getIdc</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> ZZIdcClient.getInstance().get();
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            log.error(<span class="hljs-string">"act=getIdc error={}"</span>, e.getMessage());
        }
        <span class="hljs-comment">// 兜底逻辑：为了不影响业务，如果从架构拿不到id，就采用IDHelper</span>
        <span class="hljs-comment">// IDHelper有问题，并发情况下可能会生成重复id</span>
        log.info(<span class="hljs-string">"k=s act=getIdcByIDHelper"</span>);
        <span class="hljs-keyword">return</span> IDHelper.generator(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-14">方案二：使用数据库自增ID</h4>
<pre><code class="hljs language-java" lang="java">

<span class="hljs-keyword">package</span> com.baomidou.mybatisplus.annotation;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">IdType</span> {
    AUTO(<span class="hljs-number">0</span>),
    NONE(<span class="hljs-number">1</span>),
    INPUT(<span class="hljs-number">2</span>),
    ASSIGN_ID(<span class="hljs-number">3</span>),
    ASSIGN_UUID(<span class="hljs-number">4</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER_STR(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    UUID(<span class="hljs-number">4</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> key;
}

    <span class="hljs-comment">/**
     * 主键ID
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
</code></pre>
<hr/>
<h2 data-id="heading-15">4、批量插入乱序问题</h2>
<h3 data-id="heading-16">4.1 问题现象</h3>
<p>场景1：父子订单批量插入。当子订单准备入库时，父订单还没完成，外键直接挂掉。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：先插入父订单，再插入子订单</span>
heroPackageService.saveBatch(packages);  <span class="hljs-comment">// 父订单</span>
heroOrderService.saveBatch(orders);      <span class="hljs-comment">// 子订单</span>

<span class="hljs-comment">// 结果：外键约束失败！</span>
<span class="hljs-comment">// Cannot add or update a child row: a foreign key constraint fails</span>
</code></pre>
<p>场景2：远程接口返回一个有序列表，我们存到数据库里，想在后续查询中保持原有顺序，结果还是乱了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：远程获取数据之后，存在数据库，后续从数据库获取有序列表的快照</span>
<span class="hljs-comment">//远程获取外部有序集合</span>
List&lt;HeroPackage&gt; heroPackageList = recycleRpcService.getHeroPackageList(uid)
<span class="hljs-comment">//将远程获取数据存入数据库</span>
heroPackageService.saveBatch(heroPackageList)
<span class="hljs-comment">//从数据库获取有序集合数据</span>
List&lt;HeroPackage&gt; heroPackageList = heroPackageService.list(uid);


<span class="hljs-comment">// 结果：有序集合的顺序被打乱</span>
<span class="hljs-comment">// </span>
</code></pre>
<p><strong>明明是按顺序调用的，为什么会乱序？</strong></p>
<h3 data-id="heading-17">4.2 原理</h3>
<p>可以把它想成快递分拣。你按顺序交包裹，分拣中心为了效率会重排路线，于是最终顺序就变了。</p>
<h4 data-id="heading-18">4.2.1 MyBatis-Plus的两种批量插入模式</h4>
<p>官方其实有两套批量逻辑，差别非常大。</p>
<h5 data-id="heading-19">模式一：默认BATCH模式（逐条插入）</h5>
<p>MyBatis-Plus默认saveBatch的执行流程：</p>
<ol>
<li>
<p>接收数据列表</p>
<ol>
<li>List packages (1000条数据)</li>
<li>默认批次大小：1000</li>
</ol>
</li>
<li>
<p>创建批处理SqlSession</p>
<ol>
<li>使用 ExecutorType.BATCH</li>
<li>逐条执行INSERT</li>
</ol>
</li>
<li>
<p>逐条加入批处理队列</p>
<ol>
<li>第1条：INSERT INTO hero_package VALUES (...)</li>
<li>第2条：INSERT INTO hero_package VALUES (...)</li>
<li>...</li>
<li>第1000条：INSERT INTO hero_package VALUES (...)</li>
</ol>
</li>
<li>
<p>达到批次大小后 flushStatements()</p>
</li>
</ol>
<p>特点：</p>
<ol>
<li>支持主键回填</li>
<li>单线程下顺序可控</li>
<li>多线程+驱动优化后容易乱序</li>
<li>网络往返次数多，性能一般</li>
</ol>
<h5 data-id="heading-20">模式二：优化批处理模式（合并SQL）</h5>
<p>配置方式：要么改全局配置，要么写自定义SQL</p>
<p>执行流程：</p>
<ol>
<li>接收列表</li>
<li>foreach拼成一条多值INSERT</li>
<li>一次性落库</li>
</ol>
<p>特点：</p>
<ol>
<li>单次往返，性能高</li>
<li>顺序完全可控</li>
<li>主键需要自己准备</li>
<li>SQL过长时得自行分批</li>
</ol>
<p><strong>两种模式对比</strong>：</p>






























<table><thead><tr><th>特性</th><th>默认BATCH模式</th><th>优化批处理模式</th></tr></thead><tbody><tr><td>性能</td><td>多次往返，速度一般</td><td>单次往返，极快</td></tr><tr><td>顺序保证</td><td>单线程可控，多线程不稳</td><td>完全可控</td></tr><tr><td>主键回填</td><td>支持</td><td>不支持</td></tr><tr><td>适用场景</td><td>依赖数据库生成主键</td><td>自己能生成主键或无主键需求</td></tr></tbody></table>
<h4 data-id="heading-21">4.2.2 根本原因二：JDBC驱动的批处理重排序</h4>
<p>MySQL JDBC驱动为了提速，会把同表操作合并。原本交错的SQL被重新分组，顺序自然就乱了。</p>
<p>JDBC批处理模式：</p>
<p>模式1：rewriteBatchedStatements=false</p>
<ol>
<li>逐条执行</li>
<li>顺序稳定</li>
<li>性能一般</li>
</ol>
<p>模式2：rewriteBatchedStatements=true</p>
<ol>
<li>自动合并SQL</li>
<li>性能飙升</li>
<li>顺序可能被“优化”</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">
例子：
原始<span class="hljs-keyword">SQL</span>：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)

驱动优化后：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (...), (...)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (...), (...)

</code></pre>
<p>顺序彻底变了。</p>
<h4 data-id="heading-22">4.2.3 根本原因三：数据库层面的执行优化</h4>
<p>MySQL优化器也会“帮忙”重排执行计划。同一张表的操作被集中，避免频繁切换表，性能是好了，但依赖顺序的逻辑直接崩。</p>
<pre><code class="hljs language-sql" lang="sql">期望：
Package1 → Order1 → Package2 → Order2

实际：
Package1, Package2 → Order1, Order2

优化器心声：
既然都是<span class="hljs-keyword">INSERT</span>，就分组吧
省得来回切换表         
</code></pre>
<p>问题在于，Order引用Package的主键。如果Package还没落库，Order插入必失败。</p>
<p>例如下面的真实案例。两个线程并发创建订单。批处理时队列不保证FIFO，于是订单项和订单的关系全乱套。</p>
<p>期望：
订单A → 订单项A → 订单B → 订单项B</p>
<p>现实：
线程A、线程B同时写入
批处理队列交错
驱动/数据库重排
→ 可能先执行线程B的订单项，再执行线程A的
→ 外键和业务逻辑全乱</p>
<h3 data-id="heading-23">4.3 解决方案：控制批处理节奏</h3>
<p>我们常用两个思路：要么“分批+强制刷新”，要么“自定义SQL一次写完”。</p>
<h4 data-id="heading-24">方案一：分批次执行，强制刷新</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrdersInSequence</span><span class="hljs-params">(List&lt;OrderData&gt; orderDataList)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; orderDataList.size(); i += batchSize) {
        List&lt;OrderData&gt; batch = orderDataList.subList(i, 
            Math.min(i + batchSize, orderDataList.size()));
        
        <span class="hljs-comment">// 先插入父订单</span>
        List&lt;HeroPackage&gt; packages = buildPackages(batch);
        heroPackageService.saveBatch(packages);
        sqlSession.flushStatements(); <span class="hljs-comment">// 强制执行，确保顺序</span>
        
        <span class="hljs-comment">// 再插入子订单</span>
        List&lt;HeroOrder&gt; orders = buildOrders(batch);
        heroOrderService.saveBatch(orders);
        sqlSession.flushStatements();
    }
}
</code></pre>
<h4 data-id="heading-25">方案二：自定义SQL，一次性插入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用自定义SQL，完全控制执行顺序</span>
<span class="hljs-meta">@Insert({
    "&lt;script&gt;",
    "INSERT INTO hero_package (id, seller_uid, create_time) VALUES ",
    "&lt;foreach collection='packages' item='pkg' separator=','&gt;",
    "(#{pkg.id}, #{pkg.sellerUid}, #{pkg.createTime})",
    "&lt;/foreach&gt;",
    "&lt;/script&gt;"
})</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">insertPackageBatch</span><span class="hljs-params">(<span class="hljs-meta">@Param("packages")</span> List&lt;HeroPackage&gt; packages)</span>;
</code></pre>
<hr/>
<h2 data-id="heading-26">5、枚举字段存储风险</h2>
<h3 data-id="heading-27">5.1 问题现象：枚举字段存储异常</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 枚举定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
}

<span class="hljs-comment">// 实体类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-keyword">private</span> OrderStatus orderStatus; <span class="hljs-comment">// 期望存储code值(1,2,3)</span>
}

<span class="hljs-comment">// 结果：数据库中存储的是枚举名称("PENDING", "PROCESSING", "COMPLETED")</span>
</code></pre>
<h3 data-id="heading-28">5.2 深入原理：MyBatis的默认枚举处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认的枚举处理器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumTypeHandler</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;E&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, E parameter, JdbcType jdbcType)</span> {
        <span class="hljs-comment">// 默认使用枚举的name()方法！</span>
        ps.setString(i, parameter.name()); <span class="hljs-comment">// 存储"PENDING"而不是1</span>
    }
}
</code></pre>
<h3 data-id="heading-29">5.3 解决方案：使用@EnumValue注解</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-meta">@EnumValue</span> <span class="hljs-comment">// 标记这个字段用于数据库存储</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    
    <span class="hljs-comment">// 构造函数和getter...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-30">6、驼峰转换错位</h2>
<h3 data-id="heading-31">6.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库字段：seller_uid, buyer_uid, create_time</span>
<span class="hljs-comment">// 实体类字段：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;    <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> Long buyerUID;     <span class="hljs-comment">// ❌ 映射失败！</span>
    <span class="hljs-keyword">private</span> Date createTime;   <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> String XMLData;    <span class="hljs-comment">// ❌ 映射失败！</span>
}
</code></pre>
<h3 data-id="heading-32">6.2 原理</h3>
<p>MyBatis-Plus的驼峰转换算法对连续大写很无奈。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 驼峰转换算法（简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CamelCaseConverter</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">camelToUnderscore</span><span class="hljs-params">(String camelCase)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; camelCase.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> camelCase.charAt(i);
            <span class="hljs-keyword">if</span> (Character.isUpperCase(c)) {
                <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) result.append(<span class="hljs-string">'_'</span>);
                result.append(Character.toLowerCase(c));
            } <span class="hljs-keyword">else</span> {
                result.append(c);
            }
        }
        <span class="hljs-keyword">return</span> result.toString();
    }
}

<span class="hljs-comment">// 转换结果：</span>
<span class="hljs-comment">// sellerUid -&gt; seller_uid ✅</span>
<span class="hljs-comment">// buyerUID -&gt; buyer_u_i_d ❌ (期望: buyer_uid)</span>
<span class="hljs-comment">// XMLData -&gt; x_m_l_data ❌ (期望: xml_data)</span>
</code></pre>
<h3 data-id="heading-33">6.3 解决方案：明确字段映射</h3>
<h5 data-id="heading-34">方案一：使用@TableField注解</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;
    
    <span class="hljs-meta">@TableField("buyer_uid")</span>  <span class="hljs-comment">// 明确指定数据库字段名</span>
    <span class="hljs-keyword">private</span> Long buyerUID;
    
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField("xml_data")</span>
    <span class="hljs-keyword">private</span> String XMLData;
}
</code></pre>
<h5 data-id="heading-35">方案二：统一命名规范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐的命名规范</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;     <span class="hljs-comment">// 驼峰命名，避免连续大写</span>
    <span class="hljs-keyword">private</span> Long buyerUid;      <span class="hljs-comment">// 而不是buyerUID</span>
    <span class="hljs-keyword">private</span> Date createTime;
    <span class="hljs-keyword">private</span> String xmlData;     <span class="hljs-comment">// 而不是XMLData</span>
}
</code></pre>
<h5 data-id="heading-36">方案三：自定义命名策略</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 自定义命名策略</span>
        <span class="hljs-type">GlobalConfig</span> <span class="hljs-variable">globalConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>();
        globalConfig.setDbConfig(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>.DbConfig() {{
            <span class="hljs-comment">// 自定义字段命名策略</span>
            setColumnFormat(<span class="hljs-string">"`%s`"</span>); <span class="hljs-comment">// 字段名加反引号，避免关键字冲突</span>
            setTableFormat(<span class="hljs-string">"`%s`"</span>);  <span class="hljs-comment">// 表名加反引号</span>
        }});
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-37">7、批量操作时自动填充失效</h2>
<h3 data-id="heading-38">7.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>  
    <span class="hljs-keyword">private</span> Date updateTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Long createBy;
}

<span class="hljs-comment">// 自动填充处理器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, Long.class, getCurrentUserId());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }
}

<span class="hljs-comment">// 问题现象：批量操作时自动填充失效！</span>
List&lt;HeroOrder&gt; orders = buildOrders();
heroOrderService.saveBatch(orders); <span class="hljs-comment">// createTime和createBy为null！</span>
</code></pre>
<h3 data-id="heading-39">7.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis-Plus的自动填充机制</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-comment">// 只有通过MyBatis-Plus的insert方法才会触发自动填充</span>
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.insertFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.updateFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
}

<span class="hljs-comment">// 但是批量操作使用的是JDBC批处理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(Collection&lt;T&gt; entityList)</span> {
    <span class="hljs-comment">// 直接执行批量SQL，跳过了自动填充逻辑！</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO table VALUES (?,?,?)"</span>;
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
    <span class="hljs-keyword">for</span> (T entity : entityList) {
        <span class="hljs-comment">// 没有调用metaObjectHandler.insertFill()</span>
        ps.setObject(<span class="hljs-number">1</span>, entity.getId());
        ps.setObject(<span class="hljs-number">2</span>, entity.getName());
        ps.addBatch();
    }
    ps.executeBatch();
}
</code></pre>
<h3 data-id="heading-40">7.3 解决方案：手动填充 + 批量优化</h3>
<h5 data-id="heading-41">方案一：批量操作前手动填充</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MyMetaObjectHandler metaObjectHandler;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithFill</span><span class="hljs-params">(Collection&lt;HeroOrder&gt; entityList)</span> {
        <span class="hljs-comment">// 手动触发自动填充</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(entity);
            metaObjectHandler.insertFill(metaObject);
        });
        
        <span class="hljs-comment">// 然后执行批量保存</span>
        <span class="hljs-keyword">return</span> heroOrderService.saveBatch(entityList);
    }
}
</code></pre>
<h5 data-id="heading-42">方案二：自定义批量保存方法</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchSaveHelper</span> {
    
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithAutoFill</span><span class="hljs-params">(Collection&lt;T&gt; entityList, 
                                           Class&lt;T&gt; entityClass,
                                           BaseMapper&lt;T&gt; mapper)</span> {
        <span class="hljs-keyword">if</span> (entityList.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 获取当前用户和时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">currentUserId</span> <span class="hljs-operator">=</span> getCurrentUserId();
        <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
        
        <span class="hljs-comment">// 反射设置自动填充字段</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-keyword">try</span> {
                setFieldValue(entity, <span class="hljs-string">"createTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"updateTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"createBy"</span>, currentUserId);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.warn(<span class="hljs-string">"自动填充失败"</span>, e);
            }
        });
        
        <span class="hljs-comment">// 分批保存，避免SQL过长</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        List&lt;T&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(entityList);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i += batchSize) {
            List&lt;T&gt; batch = list.subList(i, Math.min(i + batchSize, list.size()));
            mapper.insertBatch(batch); <span class="hljs-comment">// 自定义批量插入方法</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> 
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> (field.get(obj) == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 只有为null时才设置</span>
            field.set(obj, value);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-43">8、写入时JSON数据丢失或格式异常</h2>
<h3 data-id="heading-44">8.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String packageName;
    
    <span class="hljs-comment">// JSON字段存储扩展属性</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extendInfo;
    <span class="hljs-keyword">private</span> List&lt;String&gt; tags;
}

<span class="hljs-comment">// 保存数据</span>
<span class="hljs-type">HeroPackage</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeroPackage</span>();
pkg.setExtendInfo(Map.of(<span class="hljs-string">"color"</span>, <span class="hljs-string">"红色"</span>, <span class="hljs-string">"weight"</span>, <span class="hljs-number">1.5</span>));
pkg.setTags(Arrays.asList(<span class="hljs-string">"电子产品"</span>, <span class="hljs-string">"二手"</span>, <span class="hljs-string">"9成新"</span>));
heroPackageService.save(pkg);

<span class="hljs-comment">// 查询结果：extendInfo和tags字段为null！</span>
</code></pre>
<h3 data-id="heading-45">8.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认只能处理基本类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTypeHandlerRegistry</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultTypeHandlerRegistry</span><span class="hljs-params">()</span> {
        register(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());
        register(Integer.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());
        register(Long.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());
        <span class="hljs-comment">// 没有Map和List的处理器！</span>
    }
}

<span class="hljs-comment">// 复杂对象会被toString()处理</span>
Map&lt;String, Object&gt; map = Map.of(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map.toString(); <span class="hljs-comment">// "{key=value}" - 不是标准JSON！</span>
</code></pre>
<h3 data-id="heading-46">8.3 解决方案：数据类型规范化处理</h3>
<p>我们的共识是：能不用复杂字段就别用。如果必须用，就自己管序列化。</p>
<h5 data-id="heading-47">方案一：数据库字段类型规范化</h5>
<ul>
<li>表里尽量只放基本类型</li>
<li>Map、List先拆成具体字段，或者转成独立表</li>
<li>复杂场景在业务层处理转换</li>
</ul>
<h5 data-id="heading-48">方案二：手动序列化处理</h5>
<ul>
<li>确实需要存结构化数据时，先序列化成JSON字符串</li>
<li>存入VARCHAR或TEXT</li>
<li>查询时再反序列化</li>
</ul>
<p><strong>实施建议</strong>：
优先走方案一。只有在业务强依赖动态结构时，再考虑方案二，记得封装好序列化逻辑，别把JSON工具散落在业务代码里。</p>
<hr/>
<h2 data-id="heading-49">总结与思考</h2>
<p>种种案例都在提醒我们：<strong>框架默认值是给理想环境准备的，到了生产就得重新审视</strong>。如果不了解内部机制，就很容易掉进坑里。</p>
<p><strong>启示一：默认配置靠不住</strong><br/>
开发环境通常是单机、低并发，默认配置自然没问题。可一上生产，容器化、分布式、高并发齐聚，默认值瞬间变成隐患。<strong>别指望框架“自动”处理所有边角料</strong>。</p>
<p><strong>启示二：机制理解少不了</strong><br/>
只有搞清楚框架怎么运转，才能提前发现风险；真出事时，也能快速定位。<strong>知其然而且要知其所以然</strong>。</p>
<p><strong>启示三：方案要服务于环境</strong><br/>
你在什么环境里跑，就得配什么策略。容器、K8s、云原生都在挑战旧有假设。<strong>没有银弹，只有适配</strong>。</p>
<blockquote>
<p>关于作者，朱洪旭，侠客汇Java开发工程师。</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)]]></title>    <link>https://juejin.cn/post/7575313772988186665</link>    <guid>https://juejin.cn/post/7575313772988186665</guid>    <pubDate>2025-11-23T06:27:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575313772988186665" data-draft-id="7575442779038548010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)"/> <meta itemprop="keywords" content="Python,动效,后端"/> <meta itemprop="datePublished" content="2025-11-23T06:27:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T06:27:44.000Z" title="Sun Nov 23 2025 06:27:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你在制作Manim动画时，是否遇到过这样的困境？</p>
<p>“代码写得天衣无缝，运行流畅，出来的动画却总觉得哪里不对劲？”</p>
<p>虽然物体确实从 A 移动到了 B，但看起来就像是老旧的工业机器人在干活——僵硬、死板，甚至有点无聊。</p>
<p>其实，你的动画离 <strong>“丝滑”</strong> 和 <strong>“专业”</strong>，往往只差这一个参数的距离：<code>rate_func</code> <strong>(速率函数)</strong>。</p>
<p>今天，我们就来聊聊 Manim 中这个不起眼但至关重要的参数，看看如何通过控制 <strong>“时间的流速”</strong>，让你的数学动画不仅能动，而且动得有节奏、有灵魂。</p>
<h2 data-id="heading-0">1. 什么是 Rate Function？（给时间的进度条）</h2>
<p>在 <code>Manim</code> 中，当你写下 <code>.animate.shift(RIGHT)</code> 时，默认发生了什么？</p>
<p>如果你觉得动画只是简单的“在 <code>Run Time</code> 时间内移动距离 <code>RIGHT</code>”，那只对了一半。<code>Rate Function</code> 本质上是<strong>动画完成度与时间的关系</strong>。</p>
<p>想象一下你在看视频时的进度条：</p>
<ul>
<li><strong>输入 (</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span><strong>)</strong>：当前时间过去了多少（从 0 到 1，代表 0% 到 100% 的时间）。</li>
<li><strong>输出 (</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></span><strong>)</strong>：动画实际上完成了多少（从 0 到 1，代表 0% 到 100% 的进度）。</li>
</ul>
<p><strong>默认的魔法</strong>：<code>Smooth</code></p>
<p>Manim 的默认 <code>rate_func</code> 是 <code>smooth</code>。
这符合物理世界的惯性定律：<strong>起步时慢（加速），中间快，快结束时慢（减速）</strong>。</p>
<p>这就是为什么默认的动画看起来比较自然。</p>
<p>如果我们把它换成 <code>linear</code>（线性），物体就会瞬间以最大速度启动，最后瞬间急停，看起来就会很像 <strong>“PPT 动画”</strong>。</p>
<h2 data-id="heading-1">2. 常用函数图鉴：选对“调味料”</h2>
<p><code>Manim</code>内置了一大堆写好的函数，位于 <code>manim.utils.rate_functions</code>。</p>
<p>我们可以把它们看作是给动画调味的香料。</p>
<p>为了方便演示，我们假设我们要移动一个小球。</p>
<h3 data-id="heading-2">2.1. 基础三剑客</h3>
<ul>
<li><code>linear</code> <strong>(匀速)</strong>
<ul>
<li><strong>效果</strong>：机械感强，速度恒定。</li>
<li><strong>适用场景</strong>：旋转的齿轮、循环滚动的背景、匀速扫描的雷达。</li>
</ul>
</li>
<li><code>smooth</code> <strong>(默认)</strong>
<ul>
<li><strong>效果</strong>：两头慢，中间快。</li>
<li><strong>适用场景</strong>：绝大多数物体的移动、缩放。</li>
</ul>
</li>
<li><code>rush_into</code> / <code>rush_from</code>
<ul>
<li><strong>效果</strong>：
<ul>
<li><code>rush_into</code>: 越走越快，最后“砰”地撞线（只有加速）。</li>
<li><code>rush_from</code>: 一开始很快，慢慢停下来（只有减速）。</li>
</ul>
</li>
<li><strong>适用场景</strong>：连续动作的衔接。比如小球飞入画面停下（<code>rush_from</code>），或者发射出去（<code>rush_into</code>）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2.2. 动感特效组</h3>
<ul>
<li><code>there_and_back</code> <strong>(往返)</strong>
<ul>
<li><strong>效果</strong>：走到终点，又原路返回起点。</li>
<li><strong>适用场景</strong>：强调某个东西。比如把公式放大一下再缩回去，告诉观众“看这里！”。</li>
</ul>
</li>
<li><code>wiggle</code> <strong>(摆动)</strong>
<ul>
<li><strong>效果</strong>：像果冻一样左右晃动一下。</li>
<li><strong>适用场景</strong>：表示“错误”、“拒绝”或者引起注意。</li>
</ul>
</li>
<li><code>running_start</code> <strong>(助跑)</strong>
<ul>
<li><strong>效果</strong>：先向后退一点点，然后猛地向前冲。</li>
<li><strong>适用场景</strong>：想要表现物体很有力量感，或者像卡通片里的冲刺效果。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">2.3. 物理模拟组</h3>
<ul>
<li><code>ease_out_bounce</code><strong>(落地反弹)</strong>
<ul>
<li><strong>效果</strong>：像篮球落地一样，到底部后弹跳几次再停下。</li>
<li><strong>适用场景</strong>：文字掉落、物体自由落体。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">3. 动手写个 Demo</h2>
<p>光说不练假把式。下面的示例代码可以直观感受不同函数的区别：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> manim <span class="hljs-keyword">import</span> *


<span class="hljs-keyword">class</span> <span class="hljs-title class_">RateFuncComparison</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 定义我们想对比的函数</span>
        funcs = [
            linear,
            smooth,
            rush_from,
            rush_into,
            there_and_back,
            rate_functions.ease_out_bounce,
        ]
        labels = [
            <span class="hljs-string">"Linear"</span>,
            <span class="hljs-string">"Smooth"</span>,
            <span class="hljs-string">"Rush Into"</span>,
            <span class="hljs-string">"Rush From"</span>,
            <span class="hljs-string">"There &amp; Back"</span>,
            <span class="hljs-string">"Bounce"</span>,
        ]

        <span class="hljs-comment"># 创建圆点和文字</span>
        group = VGroup()
        <span class="hljs-keyword">for</span> i, (func, label_text) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(funcs, labels)):
            dot = Dot(color=TEAL)
            label = Text(label_text, font_size=<span class="hljs-number">20</span>).next_to(dot, LEFT)
            row = VGroup(label, dot)
            group.add(row)

        <span class="hljs-comment"># 竖直排列</span>
        group.arrange(DOWN, buff=<span class="hljs-number">0.5</span>).to_edge(LEFT)
        self.add(group)

        <span class="hljs-comment"># 制作动画：让所有点同时向右移动</span>
        <span class="hljs-comment"># 注意：我们在这里分别指定了不同的 rate_func</span>
        anims = []
        <span class="hljs-keyword">for</span> item, func <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(group, funcs):
            dot = item[<span class="hljs-number">1</span>]  <span class="hljs-comment"># 获取组里的 Dot</span>
            anims.append(dot.animate(rate_func=func, run_time=<span class="hljs-number">3</span>).shift(RIGHT * <span class="hljs-number">4</span>))

        self.play(*anims)
</code></pre>
<p>运行后你会发现，虽然大家的 <code>run_time</code> 都是3秒，移动距离一样，但“性格”截然不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba75cc74f304474baa5bc441daa970b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=tRI%2BaQnQbSKGg%2FU0%2B9Y7jkVccUU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">4. 进阶：自定义与时间扭曲</h2>
<p>作为会 <code>Python</code> 的老手，如果内置函数满足不了你怎么办？</p>
<h3 data-id="heading-7">4.1. 自定义函数 (Lambda大法)</h3>
<p><code>rate_func</code> 接受任何一个 <code>Python</code> 函数。</p>
<p>比如，你想做一个简单的“先慢后快”的加速效果，可以直接用 <code>Lambda</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># y = x^2，典型的加速曲线</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRateFuncDemo</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 创建一个圆</span>
        circle = Circle(radius=<span class="hljs-number">0.5</span>, color=BLUE).shift(LEFT * <span class="hljs-number">2</span>)
        self.add(circle)

        <span class="hljs-comment"># 使用自定义 rate_func（t**2）让圆向右移动</span>
        self.play(circle.animate(rate_func=<span class="hljs-keyword">lambda</span> t: t**<span class="hljs-number">2</span>).shift(RIGHT * <span class="hljs-number">4</span>), run_time=<span class="hljs-number">3</span>)
        self.wait()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c07fdccfbf142568d474d62018e7bea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=EOzMezuJmYbGmcZSqkTb%2F%2BWPbYs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.2. 时间挤压 (Squish Rate Func)</h3>
<p>这是 <code>Manim</code> 中最强大的黑科技之一：<code>squish_rate_func</code>。</p>
<p>假设你写了一个 <code>run_time=6</code> 的动画，但你希望某个特定的变换（比如变色），</p>
<p>在第 <code>1.2</code> 秒到第 <code>3</code> 秒之间（即整个进度的 <code>0.2</code> 到 <code>0.5</code>）由<strong>白色</strong>变成<strong>红色</strong>；</p>
<p>在第 <code>3</code> 秒到第 <code>4.8</code> 秒之间（即整个进度的 <code>0.5</code> 到 <code>0.8</code>）由<strong>红色</strong>变成<strong>绿色</strong>。</p>
<p>你不需要把动画拆成多段写，只需要：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquishRateFuncDemo</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 创建一个圆点</span>
        dot = Dot(color=WHITE).shift(LEFT * <span class="hljs-number">2</span>)
        self.add(dot)

        <span class="hljs-comment"># 使用UpdateFromAlphaFunc来同时控制位置和颜色变化</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_dot</span>(<span class="hljs-params">obj, alpha</span>):
            <span class="hljs-comment"># 位置变化 - 使用默认的linear速率</span>
            obj.move_to(LEFT * <span class="hljs-number">2</span> + RIGHT * <span class="hljs-number">5</span> * alpha)

            <span class="hljs-comment"># 颜色变化 - 使用squish_rate_func控制变色的时间段</span>
            squished_alpha = squish_rate_func(smooth, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.5</span>)(alpha)
            squished_alpha2 = squish_rate_func(smooth, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.8</span>)(alpha)

            <span class="hljs-keyword">if</span> alpha &lt; <span class="hljs-number">0.5</span>:
                obj.set_color(interpolate_color(WHITE, RED, squished_alpha))
            <span class="hljs-keyword">else</span>:
                obj.set_color(interpolate_color(RED, GREEN, squished_alpha2))

        self.play(
            UpdateFromAlphaFunc(dot, update_dot),
            run_time=<span class="hljs-number">6</span>,
        )
        self.wait()
</code></pre>
<p>这个技巧在制作复杂的多重同步动画时非常有效！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cb02575866740e7bbb2979d4f804ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=3Y3bARnc7xdiRnomMl05wftOnVg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">5. 总结</h2>
<p><code>Manim</code> 不仅仅是动画工具，它更像是一个导演工具。</p>
<ul>
<li><code>linear</code> 是为了表现机械、循环。</li>
<li><code>smooth</code> 是为了表现自然、物理。</li>
<li><code>there_and_back</code> / <code>wiggle</code> 是为了引导观众的注意力。</li>
<li><code>squish_rate_func</code> 是为了精准控制时间轴。</li>
</ul>
<p>下次当你的动画看起来略显生硬时，不妨停下来想一想：<em>“这个动作的节奏对吗？是不是该换个 rate function 了？”</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Hologres构建多模态AI数据分析与检索系统]]></title>    <link>https://juejin.cn/post/7576105458806882304</link>    <guid>https://juejin.cn/post/7576105458806882304</guid>    <pubDate>2025-11-24T10:33:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576105458806882304" data-draft-id="7576086446459797539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Hologres构建多模态AI数据分析与检索系统"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-24T10:33:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Hologres构建多模态AI数据分析与检索系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:33:02.000Z" title="Mon Nov 24 2025 10:33:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据驱动时代，非结构化数据（文本、图像、音视频、日志等）与结构化、半结构化数据（JSON）共同构成企业的核心数据资产。其中，非结构化数据以更原始、多元的形态蕴含着海量的业务洞察（如用户反馈、合同条款、产品缺陷图像），Hologres4.0以“AI时代的一站式多模态分析平台”为核心理念，全面展示了Hologres在结构化、半结构化与非结构化数据分析能力上的重大突破，发布全新向量索引HGraph，登顶 VectorDBBench 性价比榜单QPS、Recall、Latency、Load 四项第一，为AI应用的提供高性价比、高吞吐、低延迟、高并发的向量服务，成为全球最具性价比的向量数据库！</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/234572/1763605302728-d98ab5c3-997d-401d-afcf-592d5a871ef0.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">基于Hologres构建多模态AI数据分析与检索系统</h2>
<p>本文将会模拟金融场景中对招股书、合同等PDF文件的检索与分析，以辅助业务进行下一步的精细化运营决策。基于Hologres 4.0 对PDF非结构化数据的处理与检索，包含的主要能力如下：</p>
<ul>
<li>
<p>非结构化数据（Object Table）：支持通过表的形式读取OSS中非结构化数据（PDF/IMAGE/PPT等）。</p>
</li>
<li>
<p>AI Function：在Hologres中可以用标准SQL的方式调用AI Function，自动调用内置大模型，完成AI服务建设场景</p>
</li>
<li>
<p>数据加工：提供Embed、Chunk算子，可以对非结构化数据加工成结构化数据存储，无需使用外部算法就能自动Embed。</p>
</li>
<li>
<p>数据检索和分析：提供<code>ai_gen</code>、<code>ai_summarize</code>等算子，能够通过SQL对数据进行推理、问题总结及翻译等操作。</p>
</li>
<li>
<p>Dynamic Table介绍：支持增量刷新模式对非结构化数据自动加工，每次只计算增量的数据有效减少重复计算，降低资源利用率。</p>
</li>
<li>
<p>向量检索：支持标准SQL的向量检索，用于非结构化数据的相似度搜索、场景识别等，在同一个查询中可以自由地实现向量和标量的检索。</p>
</li>
<li>
<p>全文检索：通过倒排索引、分词等机制实现对非结构化数据的高效检索，支持关键词匹配、短语检索等丰富的检索方式，实现更加灵活的检索。</p>
</li>
</ul>
<h2 data-id="heading-1">方案优势</h2>
<p>通过如上核心能力，在Hologres中多模态AI检索与分析的核心优势如下：</p>
<ul>
<li><strong>完整的<strong><strong>AI</strong></strong>数据处理流程</strong>：涵盖从数据Embed、Chunk、增量加工、检索/分析的全流程，开发人员可以使用大数据系统一样，轻松构建AI应用。</li>
<li><strong>标准<strong><strong>SQL</strong></strong>加工和分析非结构化数据</strong>：无需使用专用开发语言，<strong>纯****SQL</strong>就能完成非结构化数据提取、加工，也无需借助外部系统，数据处理更加高效和简单，降低开发人员学习成本。</li>
<li><strong>检索更精准、灵活和智能</strong>：可以轻松构建“关键词+语义+多模态”的混合检索链路，覆盖从精准搜索到意图理解的全场景需求。还能结合AI Function实现对用户意图的深度理解，语义关联和上下文推理，实现更智能的检索能力。</li>
<li><strong>数据不出库，更安全</strong>：不需要将数据导出到外部系统，与hologres的多种安全能力无缝集成，高效保护数据安全。</li>
</ul>
<p>本实践文档将会介绍如何通过上诉核心能力在Hologres中对非结构化数据加工和检索，助力搭建企业级多模态AI数据平台，打破数据孤岛，释放全域数据价值</p>
<h2 data-id="heading-2">方案流程</h2>
<p>本次方案的流程如下：</p>
<p>1. 数据集准备。</p>
<p>将<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fdatasets%2FBJQW14B%2Fbs_challenge_financial_14b_dataset" target="_blank" title="https://modelscope.cn/datasets/BJQW14B/bs_challenge_financial_14b_dataset" ref="nofollow noopener noreferrer">金融数据集</a>中的PDF文件上传至OSS存储。</p>
<p>2. PDF数据加工。</p>
<p>使用Object Table读取PDF的元数据信息，然后创建增量刷新的Dynamic Table，并对数据进行Embed和Chunk，同时也对Dynamic Table构建向量索引和全文索引，以便后续检索可以使用索引的能力。</p>
<p>3. 使用<code>ai_embed</code>算子对将自然语言的问题进行Embedding，然后使用全文和向量双路召回结果，并对结果进行排序，结合大模型的推理能力，最终输出相似度最高的答案。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/svg/234572/1763604671276-6161ebfd-fe4e-4ba9-8fe7-86ef313bf16b.svg" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">准备工作</h2>
<p>1. 数据准备</p>
<p>本文使用ModelScope公开的金融数据集中的PDF文件夹中的文件，共80份公司招股说明书。</p>
<p>2. 环境准备</p>
<ul>
<li>购买Hologres V4.0及以上版本实例并创建数据库。</li>
<li>购买AI资源。</li>
</ul>
<p>本文以large-96core-512GB-384GB、1个节点为例。</p>
<ul>
<li>模型部署。本次方案使用的模型以及分配的资源为：</li>
</ul>
<p><strong>模型名称</strong></p>
<p><strong>模型类别</strong></p>
<p><strong>模型作用描述</strong></p>
<p><strong>单副本****CPU（Core）</strong></p>
<p><strong>单副本内存</strong></p>
<p><strong>单副本****GPU</strong></p>
<p><strong>资源副本数</strong></p>
<p>to_doc</p>
<p>ds4sd/docling-models</p>
<p>将PDF转换成文档。</p>
<p>20</p>
<p>100 GB</p>
<p>1卡(48 GB)</p>
<p>1</p>
<p>chunk</p>
<p>recursive-character-text-splitter</p>
<p>文档切片，每个PDF较大，建议使用切片。</p>
<p>15</p>
<p>30 GB</p>
<p>0卡(0 GB)</p>
<p>1</p>
<p>pdf_embed</p>
<p>BAAI/bge-base-zh-v1.5</p>
<p>文档Embedding。</p>
<p>7</p>
<p>30 GB</p>
<p>1卡(96 GB)</p>
<p>1</p>
<p>llm</p>
<p>Qwen/Qwen3-32B</p>
<p>使用大模型对检索出的文档内容按照提示词推理.</p>
<p>7</p>
<p>30 GB</p>
<p>1卡(96 GB)</p>
<p>1</p>
<p><strong>说明</strong>上述模型的资源均为默认分配的资源。</p>
<h2 data-id="heading-4">操作步骤</h2>
<p><strong>下载PDF文件并上传至OSS。</strong></p>
<p>1. 下载博金大模型挑战赛-金融千问14b数据集中80份招股书（PDF）。</p>
<p>2. 登录OSS管理控制台，创建Bucket并将已下载的PDF文件上传至该Bucket路径下。上传操作详情，请参见简单上传。</p>
<p><strong>账号授权。</strong><br/>
1. 登录RAM控制台，创建阿里云RAM角色并授予OSS的相关权限。</p>
<p>推荐授予AliyunOSSReadOnlyAccess权限。</p>
<p>2. 为上述阿里云RAM角色添加登录和Hologres的访问权限。</p>
<p>阿里云账号（主账号）</p>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>
<p>Action：更新为<code>sts:AssumeRole</code>。</p>
</li>
<li>
<p>Service：更新为<code>hologres.aliyuncs.com</code>。</p>
<p>{
"Statement": [
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": {
"RAM": [
"acs:ram::1866xxxx:root"
],
"Service": [
"hologres.aliyuncs.com"
]
}
}
],
"Version": "1"
}</p>
</li>
</ul>
<p>RAM用户（子账号）<br/>
1. 为RAM用户授权。</p>
<ul>
<li>在<strong>权限管理</strong> <strong>&gt;</strong> <strong>权限策略</strong>页面，单击<strong>创建权限策略</strong>，并选择<strong>脚本编辑</strong>模式创建权限策略。具体操作，请参见创建自定义权限策略</li>
</ul>
<p>Hologres可通过该策略判断当前RAM用户是否具备创建对应RAM角色的权限。权限策略内容如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hologram:GrantAssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;arn账号&gt;"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>在<strong>身份管理 &gt; 用户</strong>页面，单击目标RAM用户<strong>操作</strong>列中的<strong>添加权限</strong>，为RAM用户（子账号）授予上述步骤已创建的权限策略。具体操作，请参见为RAM用户授权。</li>
</ul>
<p>2. 为已创建的RAM角色授权。</p>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>
<p>Action：更新为<code>sts:AssumeRole</code>。</p>
</li>
<li>
<p>Service：更新为<code>hologres.aliyuncs.com</code>。</p>
<p>{
"Statement": [
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": {
"RAM": [
"acs:ram::1866xxxx:root"
],
"Service": [
"hologres.aliyuncs.com"
]
}
}
],
"Version": "1"
}</p>
</li>
</ul>
<p>3. 对PDF文件进行Embedding和Chunk。</p>
<p>需要创建Object Table和Dynamic Table对PDF的元数据读取以及加工。因为流程较长，Hologres直接将其封装为存储过程。该存储过程包括的能力如下：</p>
<ul>
<li>会创建一张Object Table，用于取PDF的元数据。</li>
<li>创建一张增量刷新模式的Dynamic Table结果表，用于存储加工后的数据。同时，该表需设置向量索引和全文索引，且Dynamic Table不设置自动刷新，需要手动刷新。</li>
<li>Dynamic Table的刷新过程中会使用<code>ai_embed</code>、<code>ai_chunk</code>对数据进行Embed和切片。</li>
</ul>
<p>该存储过程代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">CALL create_rag_corpus_from_oss(
    <span class="hljs-attr">oss_path</span> =&gt; <span class="hljs-string">'oss://xxxx/bs_challenge_financial_14b_dataset/pdf'</span>,
    <span class="hljs-attr">oss_endpoint</span> =&gt; <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>,
    <span class="hljs-attr">oss_role_arn</span> =&gt; <span class="hljs-string">'acs:ram::186xxxx:role/xxxx'</span>,
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'public.dt_bs_challenge_financial'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>4. 刷新结果表。</p>
<p>通过如上存储过程创建的Object Table和Dynamic Table均需手动刷新，才能完成数据加工。该步骤已被封装为PDF加工存储过程，该存储过程包括的能力如下：</p>
<ul>
<li>刷新一次Object Table获取PDF元数据</li>
<li>刷新一次Dynamic Table，进行PDF的Embedding和Chunk加工。</li>
</ul>
<p>该存储过程使用代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">CALL refresh_rag_corpus_table(
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'public.dt_bs_challenge_financial'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>5. PDF检索。</p>
<p>加工好的数据可以根据业务使用场景，通过向量、全文等方式进行检索。例如：可以根据招股书来查询某个公司的业绩走势，以此来判断公司后续的走势是悲观还是乐观，以便对后续的投资意向提供辅助建议。</p>
<h3 data-id="heading-5">向量检索</h3>
<p>在向量检索时，为了检索方便，我们将问题Embedding和Prompt构建，大模型输出答案等过程封装成为<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system%3Fspm%3Da2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N%26scm%3D20140722.H_2982978._.OR_help-T_cn~zh-V_1%239b9ac4eba36lk" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system?spm=a2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N&amp;scm=20140722.H_2982978._.OR_help-T_cn~zh-V_1#9b9ac4eba36lk" ref="nofollow noopener noreferrer">向量检索函数</a>，直接调用如下该存储过程可以实现向量召回。</p>
<pre><code class="hljs language-ini" lang="ini">-- 向量单路召回 + AI重排
SELECT qa_vector_search_retrieval(
  <span class="hljs-attr">question</span> =&gt; <span class="hljs-string">'报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？'</span>,
  <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'dt_bs_challenge_financial'</span>,
  <span class="hljs-attr">prompt</span> =&gt; <span class="hljs-string">'请分析如下业绩走势是悲观还是乐观，并给出原因：${question}\n\n 参考信息：\n\n ${context}'</span>
)
</code></pre>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_retrieval
---------
"根据提供的信息，对湖南国科微电子股份有限公司的业绩走势进行分析，可以得出以下结论：

### 一、业绩走势分析：悲观

#### 1. <span class="hljs-strong">**营业收入增长乏力**</span>
- 2014年度营业收入较上年增长 <span class="hljs-strong">**15.13%**</span>，但2015年度营业收入却 <span class="hljs-strong">**下降5.21%**</span>，2016年度数据未提供，但可以看出营业收入增长趋势在2015年出现明显下滑。
- 2012年至2014年营业收入的年复合增长率仅为 <span class="hljs-strong">**4.47%**</span>，表明公司业务扩张较为缓慢。

#### 2. <span class="hljs-strong">**净利润增长持续下降**</span>
- 2014年度净利润增长 <span class="hljs-strong">**5.43%**</span>，2015年度净利润 <span class="hljs-strong">**下降3.29%**</span>。
- 扣除非经常性损益后，2014年度归属于母公司股东的净利润增长 <span class="hljs-strong">**-3.14%**</span>，2015年度进一步下降 <span class="hljs-strong">**-5.60%**</span>，表明公司主营业务盈利能力在持续恶化。
- 2012年至2014年扣除非经常性损益后净利润的年复合增长率为 <span class="hljs-strong">**-4.38%**</span>，远低于营业收入增长，说明公司主营业务盈利能力不足，增长主要依赖非经常性损益。

#### 3. <span class="hljs-strong">**非经常性损益占比偏高**</span>
- 报告期内，非经常性损益占净利润的比例较高，2014年、2013年、2012年分别为 <span class="hljs-strong">**17.54%、10.25%、8.06%**</span>，表明公司利润中有一部分来自政策扶持、政府补贴等非经常性因素，而非核心业务的持续增长。
- 依赖非经常性损益来维持利润增长，不利于公司长期的稳定发展。

#### 4. <span class="hljs-strong">**净资产收益率下降**</span>
- 加权平均净资产收益率从2014年的 <span class="hljs-strong">**18.10%**</span> 下降到2015年的 <span class="hljs-strong">**24.82%**</span>，再到2016年的 <span class="hljs-strong">**28.23%**</span>，虽然数据看似增长，但需注意该指标是以扣除非经常性损益后的净利润计算的，而净利润本身在下降，因此这种增长可能与资本结构变化有关，而非盈利能力的实质性提升。

### 二、原因总结
1. <span class="hljs-strong">**主营业务增长乏力**</span>：营业收入和净利润增长均呈现下降趋势，尤其是净利润的下降表明公司盈利能力在减弱。
2. <span class="hljs-strong">**非经常性损益依赖度高**</span>：公司利润中非经常性损益占比较高，说明主营业务的盈利能力不足，公司业绩的持续性存疑。
3. <span class="hljs-strong">**市场竞争激烈**</span>：公司采购的工控机、显示器、电源等产品市场竞争激烈，价格平稳，利润空间受到挤压。
4. <span class="hljs-strong">**行业环境影响**</span>：不锈钢市场价格波动、原材料价格波动可能对公司经营业绩造成一定影响，虽然公司已采取措施降低影响，但长期来看仍需关注。

### 三、结论
总体来看，湖南国科微电子股份有限公司的业绩走势偏 <span class="hljs-strong">**悲观**</span>。公司主营业务增长乏力，净利润持续下降，对非经常性损益依赖度高，未来盈利能力的可持续性存疑。公司需要加强核心业务的竞争力，优化成本结构，提高主营业务盈利能力，以实现长期稳健发展。"
</span></span></code></pre>
<h3 data-id="heading-6">全文检索</h3>
<p>在全文检索时，为了检索方便，我们将问题Embedding和Prompt构建，大模型输出答案等过程封装为全文检索函数，直接调用如下存储过程可以实现全文召回：</p>
<pre><code class="hljs language-ini" lang="ini">--全文检索召回
SELECT qa_text_search_retrieval(
    <span class="hljs-attr">question</span> =&gt; <span class="hljs-string">'报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？'</span>,
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'dt_bs_challenge_financial'</span>,
    <span class="hljs-attr">prompt</span> =&gt; <span class="hljs-string">'请分析如下业绩走势是悲观还是乐观，并给出原因：${question}\n\n 参考信息：\n\n ${context}'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_text_</span>search<span class="hljs-emphasis">_retrieval
----------------
"根据提供的信息，湖南国科微电子股份有限公司在2014年、2015年和2016年的业绩走势整体上呈现<span class="hljs-strong">**悲观**</span>趋势，具体原因如下：

### 1. <span class="hljs-strong">**营业收入增长乏力**</span>
- 2014年营业收入增长率为<span class="hljs-strong">**15.13%**</span>，但2015年营业收入增长率转为<span class="hljs-strong">**-5.21%**</span>，即出现负增长。
- 2012年至2014年的营业收入年复合增长率仅为<span class="hljs-strong">**4.47%**</span>，说明公司营业收入增长较为缓慢，业务发展不够强劲。
- 2015年上半年营业收入预测与2014年同期相比大致持平，但2015年上半年净利润较上年同期<span class="hljs-strong">**略有下降**</span>，表明盈利能力下降。

### 2. <span class="hljs-strong">**净利润和扣非净利润增长不佳**</span>
- 2014年净利润增长率为<span class="hljs-strong">**5.43%**</span>，2015年净利润增长率下降为<span class="hljs-strong">**-3.29%**</span>，即净利润出现下滑。
- 扣除非经常性损益后的净利润增长率在2014年为<span class="hljs-strong">**-3.14%**</span>，2015年进一步下降为<span class="hljs-strong">**-5.60%**</span>，说明公司主营业务的盈利能力持续下降。
- 2012年至2014年扣非净利润的年复合增长率为<span class="hljs-strong">**-4.38%**</span>，明显低于营业收入的年复合增长率，说明公司利润质量不高，主营业务盈利能力较弱。

### 3. <span class="hljs-strong">**经营活动现金流波动**</span>
- 2014年销售商品、提供劳务收到的现金占营业收入的比例较前两年有所下降，主要与部分收入确认项目的<span class="hljs-strong">**收款跨期**</span>有关，说明公司现金流管理存在问题。
- 2013年购买商品、接受劳务支付的现金占营业成本比例较高，主要是由于当年<span class="hljs-strong">**采购原材料并完成生产**</span>，但部分成本在2014年才结转，导致2014年该比例较低，反映公司采购和生产节奏不够稳定。

### 4. <span class="hljs-strong">**投资和盈利能力指标**</span>
- 加权平均净资产收益率（ROE）在2014年为<span class="hljs-strong">**18.10%**</span>，2015年上升至<span class="hljs-strong">**24.82%**</span>，2016年进一步上升至<span class="hljs-strong">**28.23%**</span>，虽然有所提升，但ROE的提高可能主要依赖<span class="hljs-strong">**财务杠杆**</span>，而非核心业务盈利能力的提升。
- 考虑到净利润和扣非净利润持续下降，ROE的提升并不能完全反映公司经营质量的改善。

### 5. <span class="hljs-strong">**2015年上半年业绩预测**</span>
- 2015年上半年营业收入预计为<span class="hljs-strong">**8,505万元至10,395万元**</span>，与2014年同期的<span class="hljs-strong">**10,127.35万元**</span>大致持平，但净利润预计为<span class="hljs-strong">**2,340万元至2,860万元**</span>，低于2014年同期的<span class="hljs-strong">**2,912.66万元**</span>，说明公司盈利能力下降。

### 总结
综合来看，湖南国科微电子股份有限公司在2014年至2016年的业绩走势<span class="hljs-strong">**偏向悲观**</span>。虽然ROE有所提升，但营业收入增长乏力、净利润和扣非净利润持续下降、经营活动现金流波动较大，表明公司主营业务盈利能力较弱，经营质量有待提升。"
</span></span></code></pre>
<h3 data-id="heading-7">向量+全文混合检索</h3>
<p>在向量、全文结合Rank排序混合检索场景中，为了检索方便，Hologres将其封装为向量+全文双路召回+Rank排序函数，该存储过程的能力如下：</p>
<ul>
<li>
<p>根据问题使用向量计算，召回TOP 20的答案。</p>
</li>
<li>
<p>根据问题使用全文检索，召回TOP 20的答案。</p>
</li>
<li>
<p>使用<code>ai_rank</code>，对向量和全文召回的答案进行排序，最后输出Top1的答案。</p>
</li>
<li>
<p>使用<code>ai_gen</code>，结合大模型根据提示词以及检索的答案，生成最终答案并进行输出。</p>
<p>-- 全文、向量双路召回 + AI重排
SELECT qa_hybrid_retrieval(
question =&gt; '报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？',
corpus_table =&gt; 'dt_bs_challenge_financial',
prompt =&gt; '请分析如下业绩走势是悲观还是乐观，并给出原因：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mtext>参考信息：</mtext><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle></mrow><annotation encoding="application/x-tex">{question}\n\n 参考信息：\n\n </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord cjk_fallback">参考信息：</span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span></span></span></span></span>{context}'
);</p>
</li>
</ul>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_hybrid_</span>retrieval
---</span>
"根据提供的信息，我们可以对湖南国科微电子股份有限公司的业绩走势进行如下分析，并判断其趋势是悲观还是乐观：

---

<span class="hljs-section">### 一、<span class="hljs-strong">**营业收入走势分析**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**2012-2014年复合增长率**</span>：
<span class="hljs-bullet">   -</span> 营业收入的年复合增长率为 <span class="hljs-strong">**4.47%**</span>，表明公司营业收入的增长较为平稳。
<span class="hljs-bullet">   -</span> 2014年营业收入为 <span class="hljs-strong">**18,154.06万元**</span>，较2013年增长 <span class="hljs-strong">**15.13%**</span>。
<span class="hljs-bullet">   -</span> 2015年营业收入较上年 <span class="hljs-strong">**下降5.21%**</span>，出现了负增长。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 营业收入的增长在2014年有所回升，但2015年出现明显下滑，表明公司业务扩张遇到了一定阻力。

---

<span class="hljs-section">### 二、<span class="hljs-strong">**净利润走势分析**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**2012-2014年复合增长率**</span>：
<span class="hljs-bullet">   -</span> 扣除非经常性损益后的净利润年复合增长率为 <span class="hljs-strong">**-4.38%**</span>，低于营业收入的年复合增长率，说明公司盈利能力有所下降。
<span class="hljs-bullet">   -</span> 2014年扣非净利润为 <span class="hljs-strong">**42,731,071.18元**</span>，较2013年下降 <span class="hljs-strong">**3.14%**</span>。
<span class="hljs-bullet">   -</span> 2015年扣非净利润较上年进一步下降 <span class="hljs-strong">**5.60%**</span>。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**非经常性损益影响**</span>：
<span class="hljs-bullet">   -</span> 2014年、2013年及2012年非经常性损益占净利润的比例分别为 <span class="hljs-strong">**17.54%、10.25%、8.06%**</span>，呈上升趋势。
<span class="hljs-bullet">   -</span> 非经常性损益的增加主要来自于政府补贴和理财产品收益，而非主营业务带来的持续增长。

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 扣非净利润连续两年下降，说明公司主营业务盈利能力减弱，业绩增长依赖于非经常性损益，这是令人担忧的信号。

---

<span class="hljs-section">### 三、<span class="hljs-strong">**现金流量与经营稳定性**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**经营活动现金流**</span>：
<span class="hljs-bullet">   -</span> 2014年营业收入为 <span class="hljs-strong">**18,154.06万元**</span>，但销售商品、提供劳务收到的现金并未明确给出，无法判断现金流是否健康。
<span class="hljs-bullet">   -</span> 报告期内，公司银行存款分别为 <span class="hljs-strong">**13,063.38万元、4,152.54万元、9,864.61万元**</span>，资金流动性波动较大，但主要客户、供应商及经营模式保持稳定。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 虽然公司现金流存在波动，但客户和供应商稳定，经营模式未发生重大变化，这为公司未来的发展提供了一定保障。

---

<span class="hljs-section">### 四、<span class="hljs-strong">**2015年上半年业绩预测**</span></span>
<span class="hljs-bullet">-</span> 2015年1至6月预计营业收入为 <span class="hljs-strong">**8,505万元至10,395万元**</span>，较2014年同期的 <span class="hljs-strong">**4,641.19万元**</span>有明显增长。
<span class="hljs-bullet">-</span> 但2015年1至3月净利润较上年同期下降 <span class="hljs-strong">**48.26%**</span>，主要是因为确认收入的项目毛利率较低。

---

<span class="hljs-section">### 五、<span class="hljs-strong">**综合分析与判断**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**乐观因素**</span>：
<span class="hljs-bullet">   -</span> 2014年营业收入增长较快，达到 <span class="hljs-strong">**15.13%**</span>。
<span class="hljs-bullet">   -</span> 2015年上半年营业收入预计增长显著，表明公司可能正在逐步恢复。
<span class="hljs-bullet">   -</span> 主要客户、供应商及经营模式保持稳定，为公司提供了良好的运营基础。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**悲观因素**</span>：
<span class="hljs-bullet">   -</span> 2015年营业收入较上年 <span class="hljs-strong">**下降5.21%**</span>，净利润也出现下滑。
<span class="hljs-bullet">   -</span> 扣非净利润连续两年下降，表明公司主营业务盈利能力不足。
<span class="hljs-bullet">   -</span> 非经常性损益占比上升，业绩增长依赖于政府补贴和理财产品收益，缺乏内生增长动力。
<span class="hljs-bullet">   -</span> 2015年1至3月净利润大幅下滑 <span class="hljs-strong">**48.26%**</span>，表明短期业绩波动较大。

---

<span class="hljs-section">### <span class="hljs-strong">**最终结论：整体趋势偏悲观**</span></span>
<span class="hljs-bullet">-</span> 尽管公司在2014年营业收入有所回升，且2015年上半年预计增长，但 <span class="hljs-strong">**扣非净利润连续下降**</span>、<span class="hljs-strong">**净利润增长依赖非经常性损益**</span>、<span class="hljs-strong">**短期业绩波动较大**</span>，表明公司目前的业绩增长缺乏持续性和稳定性。
<span class="hljs-bullet">-</span> 因此，从长期来看，公司业绩走势偏 <span class="hljs-strong">**悲观**</span>，需关注其主营业务盈利能力的改善和非经常性损益的依赖问题。

---

<span class="hljs-section">### <span class="hljs-strong">**建议**</span></span>
<span class="hljs-bullet">1.</span> 关注公司未来主营业务的盈利能力是否能有所提升。
<span class="hljs-bullet">2.</span> 降低对非经常性损益的依赖，提高内生增长动力。
<span class="hljs-bullet">3.</span> 稳定客户和供应商关系，优化业务结构，提高毛利率。"
</code></pre>
<h3 data-id="heading-8">向量+全文双路召回+RRF排序</h3>
<p>使用向量和全文检索后，通过RRF （Reciprocal Rank Fusion）排序召回结果。为了检索方便，Hologres已经封装为<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system%3Fspm%3Da2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N%26scm%3D20140722.H_2982978._.OR_help-T_cn~zh-V_1%232aec0a43d8flv" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system?spm=a2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N&amp;scm=20140722.H_2982978._.OR_help-T_cn~zh-V_1#2aec0a43d8flv" ref="nofollow noopener noreferrer">向量+全文双路召回+RRF排序函数</a>（详细定义见下方附录），该存储过程的能力如下：</p>
<ul>
<li>
<p>根据问题使用向量计算，召回TOP 20的答案。</p>
</li>
<li>
<p>根据问题使用全文检索，召回TOP 20的答案。</p>
</li>
<li>
<p>对向量和全文召回的答案，计算RRF分数，最后输出Top N的答案。</p>
</li>
<li>
<p>使用<code>ai_gen</code>、大模型根据提示词，以及检索的答案，拼装成最终答案并输出。</p>
<p>-- 全文、向量双路召回 + RRF重排
SELECT qa_hybrid_retrieval_rrf(
question =&gt; '报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？',
corpus_table =&gt; 'dt_bs_challenge_financial',
prompt =&gt; '请分析如下业绩走势是悲观还是乐观，并给出原因：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mtext>参考信息：</mtext><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle></mrow><annotation encoding="application/x-tex">{question}\n\n 参考信息：\n\n </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord cjk_fallback">参考信息：</span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span></span></span></span></span>{context}'
);</p>
</li>
</ul>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_hybrid_</span>retrieval<span class="hljs-emphasis">_rrf
------------------
"根据提供的信息，对湖南国科微电子股份有限公司的业绩走势进行分析，可以得出以下结论：

### <span class="hljs-strong">**业绩走势判断：悲观**</span>
#### <span class="hljs-strong">**原因分析如下：**</span>

1. <span class="hljs-strong">**净利润增长低于营业收入增长：**</span>
   - 提供的信息指出，公司2012年至2014年的<span class="hljs-strong">**营业收入年复合增长率为4.47%**</span>，表明公司整体业务增长较为平稳。
   - 但<span class="hljs-strong">**扣除非经常性损益后归属于母公司股东的净利润年复合增长率为-4.38%**</span>，明显低于营业收入的增长率。这说明公司在收入增长的同时，盈利能力并未同步提升，甚至出现下滑，可能受到成本上升、毛利率下降或非经常性损益减少等因素影响。

2. <span class="hljs-strong">**净利润波动较大：**</span>
   - 2015年1至3月的净利润较上年同期减少了48.26%，且主要原因在于确认收入的项目毛利率较低（如无锡地铁一号线项目以模块外购为主）。这表明公司短期业绩容易受到业务结构变化的影响，存在一定的不稳定性。

3. <span class="hljs-strong">**毛利率和盈利能力下降：**</span>
   - 提到“主营业务利润对公司净利润的贡献”在2014年较2013年略有下降，而2013年又较2012年下降。这说明公司核心业务的盈利能力可能在减弱，可能受到市场竞争加剧、成本上升或产品结构变化的影响。

4. <span class="hljs-strong">**2015年上半年预测利润下降：**</span>
   - 2015年1至6月预计营业收入为8,505万元至10,395万元，与2014年同期大致持平，但净利润预计为2,340万元至2,860万元，低于2014年同期的2,912.66万元。这表明公司盈利能力在进一步下降，可能面临一定的经营压力。

5. <span class="hljs-strong">**业务增长乏力：**</span>
   - 虽然营业收入增长较为平稳，但净利润的下降表明公司业务增长的质量不高，未能有效转化为利润。这可能影响投资者对公司未来发展的信心。

### <span class="hljs-strong">**总结：**</span>
湖南国科微电子股份有限公司的业绩走势整体偏向<span class="hljs-strong">**悲观**</span>。虽然营业收入保持了平稳增长，但净利润的增长明显滞后甚至出现负增长，表明公司盈利能力在下降，业务发展质量不高，且存在短期业绩波动的风险。如果公司不能有效提升毛利率、控制成本或优化产品结构，未来业绩可能继续承压。"
</span></span></code></pre>
<h2 data-id="heading-9">附录：存储过程定义</h2>
<p>上述文档中使用的存储过程定义如下，方便您做参考。</p>
<p>说明在Hologres中不支持创建Function，如下存储过程仅做参考，无法修改后直接执行。</p>
<h3 data-id="heading-10">PDF加工存储过程</h3>
<ul>
<li>
<p>创建Object Table和Dynamic Table</p>
<p>CREATE OR REPLACE PROCEDURE create_rag_corpus_from_oss(
oss_path TEXT,
oss_endpoint TEXT,
oss_role_arn TEXT,
corpus_table TEXT,
embedding_model TEXT DEFAULT NULL,
parse_document_model TEXT DEFAULT NULL,
chunk_model TEXT DEFAULT NULL,
chunk_size INT DEFAULT 300,
chunk_overlap INT DEFAULT 50,
overwrite BOOLEAN DEFAULT FALSE
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident TEXT;
embed_expr TEXT;
chunk_expr TEXT;
parse_expr TEXT;
embedding_dims INT;
BEGIN
-- 1. 拆 schema name + table name
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-sql" lang="sql">obj_table_name :<span class="hljs-operator">=</span> corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

<span class="hljs-comment">-- 2. 如果需要覆盖，先删表和索引</span>
IF overwrite <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">DECLARE</span>
        dyn_table_exists <span class="hljs-type">BOOLEAN</span>;
        rec RECORD;
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- 检查 dynamic table 是否存在</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">FROM</span> pg_class c
            <span class="hljs-keyword">JOIN</span> pg_namespace n <span class="hljs-keyword">ON</span> n.oid <span class="hljs-operator">=</span> c.relnamespace
            <span class="hljs-keyword">WHERE</span> c.relname <span class="hljs-operator">=</span> corpus_name
            <span class="hljs-keyword">AND</span> n.nspname <span class="hljs-operator">=</span> corpus_schema
        )
        <span class="hljs-keyword">INTO</span> dyn_table_exists;

        IF dyn_table_exists <span class="hljs-keyword">THEN</span>
            <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
            <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_corpus_ident;</span>
            <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_corpus_ident);</span>

            <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
            <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
                <span class="hljs-keyword">EXECUTE</span> format(
                    $f$
                    <span class="hljs-keyword">SELECT</span> query_job_id
                        <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                        <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
                    $f$,
                    corpus_table
                )
            LOOP
                RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
                IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
                    RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
                <span class="hljs-keyword">ELSE</span>
                    RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
                <span class="hljs-keyword">END</span> IF;
            <span class="hljs-keyword">END</span> LOOP;

            <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
            <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_corpus_ident);
        <span class="hljs-keyword">ELSE</span>
            RAISE NOTICE <span class="hljs-string">'Dynamic table % does not exist, skip cancel job and drop.'</span>, full_corpus_ident;
        <span class="hljs-keyword">END</span> IF;

        <span class="hljs-comment">-- 2.4 无论如何，Object Table 都要删除</span>
        <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 3. 创建 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Create object table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(
    $f$
    <span class="hljs-keyword">CREATE</span> OBJECT <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s
    <span class="hljs-keyword">WITH</span> (
        path <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
        oss_endpoint <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
        role_arn <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L
    );
    $f$,
    full_obj_ident,
    oss_path,
    oss_endpoint,
    oss_role_arn
);

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 4. 刷新 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Refresh object table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 5. 文档解析模型选择</span>
IF parse_document_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(parse_document_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    parse_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_parse_document(file, ''auto'', ''markdown'')'</span>;
<span class="hljs-keyword">ELSE</span>
    parse_expr :<span class="hljs-operator">=</span> format(
        <span class="hljs-string">'ai_parse_document(%L, file, ''auto'', ''markdown'')'</span>,
        parse_document_model
    );
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 6. chunk 模型选择</span>
IF chunk_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(chunk_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    chunk_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_chunk(doc, %s, %s)'</span>, chunk_size, chunk_overlap);
<span class="hljs-keyword">ELSE</span>
    chunk_expr :<span class="hljs-operator">=</span> format(
        <span class="hljs-string">'ai_chunk(%L, doc, %s, %s)'</span>,
        chunk_model,
        chunk_size,
        chunk_overlap
    );
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 7. embedding 模型选择</span>
IF embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(embedding_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    embed_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed(chunk)'</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT array_length(ai_embed(''dummy''), 1)'</span>
    <span class="hljs-keyword">INTO</span> embedding_dims;
<span class="hljs-keyword">ELSE</span>
    embed_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_embed(%L, chunk)'</span>, embedding_model);

    <span class="hljs-keyword">EXECUTE</span> format(
        <span class="hljs-string">'SELECT array_length(ai_embed(%L, ''dummy''), 1)'</span>,
        embedding_model
    )
    <span class="hljs-keyword">INTO</span> embedding_dims;
<span class="hljs-keyword">END</span> IF;

RAISE NOTICE <span class="hljs-string">'embedding dimension is: %'</span>, embedding_dims;

<span class="hljs-comment">-- 8. 创建 RAG 输出动态表</span>
RAISE NOTICE <span class="hljs-string">'create dynamic table: %'</span>, corpus_name;
<span class="hljs-keyword">EXECUTE</span> format(
    $f$
    <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s(
        <span class="hljs-keyword">CHECK</span>(array_ndims(embedding_vector) <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> array_length(embedding_vector, <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>s)
    )
    <span class="hljs-keyword">WITH</span> (
        vectors <span class="hljs-operator">=</span> <span class="hljs-string">'{
          "embedding_vector": {
            "algorithm": "HGraph",
            "distance_method": "Cosine",
            "builder_params": {
            "base_quantization_type": "sq8_uniform",
            "max_degree": 64,
            "ef_construction": 400,
            "precise_quantization_type": "fp32",
            "use_reorder": true
            }
          }
        }'</span>,
        auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>,
        freshness <span class="hljs-operator">=</span> <span class="hljs-string">'5 minutes'</span>,
        auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>
    ) <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">WITH</span> parsed_doc <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">SELECT</span> object_uri,
               etag,
               <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> doc
          <span class="hljs-keyword">FROM</span> <span class="hljs-operator">%</span>s
    ),
    chunked_doc <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">SELECT</span> object_uri,
               etag,
               <span class="hljs-built_in">unnest</span>(<span class="hljs-operator">%</span>s) <span class="hljs-keyword">AS</span> chunk
          <span class="hljs-keyword">FROM</span> parsed_doc
    )
    <span class="hljs-keyword">SELECT</span>
        object_uri,
        etag,
        chunk,
        <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> embedding_vector
      <span class="hljs-keyword">FROM</span> chunked_doc;
    $f$,
    full_corpus_ident,
    embedding_dims,
    parse_expr,
    full_obj_ident,
    chunk_expr,
    embed_expr
);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 9. 创建全文索引（索引名 = 表名 || '_fulltext_idx'）</span>
<span class="hljs-keyword">EXECUTE</span> format(
    <span class="hljs-string">'CREATE INDEX %I ON %s USING FULLTEXT (chunk);'</span>,
    corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_fulltext_idx'</span>,
    full_corpus_ident
);

RAISE NOTICE <span class="hljs-string">''</span>;
RAISE NOTICE <span class="hljs-string">'Create RAG corpus success to table: %'</span>, corpus_table;
RAISE NOTICE <span class="hljs-string">'    Vector index is: %.embedding_vector'</span>, corpus_table;
RAISE NOTICE <span class="hljs-string">'    TextSearch index is: %.chunk'</span>, corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
<li>
<p>刷新Object Table和Dynamic Table存储过程</p>
<p>CREATE OR REPLACE PROCEDURE refresh_rag_corpus_table(
corpus_table TEXT
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name   TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident    TEXT;
BEGIN
-- 1. 解析 schema 和表名
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-css" lang="css">obj_table_name := corpus_name || <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident := <span class="hljs-built_in">format</span>(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    := <span class="hljs-built_in">format</span>(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

-- <span class="hljs-number">2</span>. 刷新 <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Table</span>
RAISE NOTICE 'Refreshing <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Table</span>: %<span class="hljs-string">', obj_table_name;
EXECUTE format('</span>REFRESH OBJECT TABLE %s;', full_obj_ident);

-- <span class="hljs-number">3</span>. 刷新 Dynamic <span class="hljs-selector-tag">Table</span>
RAISE NOTICE 'Refreshing Dynamic <span class="hljs-selector-tag">Table</span>: %<span class="hljs-string">', corpus_name;
EXECUTE format('</span>REFRESH TABLE %s;', full_corpus_ident);

RAISE NOTICE 'Refresh complete for corpus <span class="hljs-selector-tag">table</span> %', corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
<li>
<p>删除Object Table和Dynamic Table存储过程</p>
<p>CREATE OR REPLACE PROCEDURE drop_rag_corpus_table(
corpus_table TEXT
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name   TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident    TEXT;
rec RECORD;
BEGIN
-- 1. 解析 schema 和表名
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-sql" lang="sql">obj_table_name :<span class="hljs-operator">=</span> corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

<span class="hljs-comment">-- 2. 删除表</span>
<span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
<span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_corpus_ident;</span>
<span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_corpus_ident);</span>

<span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
<span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">SELECT</span> query_job_id
            <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
            <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
        $f$,
        corpus_table
    )
LOOP
    RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
    IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
        RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
    <span class="hljs-keyword">ELSE</span>
        RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
    <span class="hljs-keyword">END</span> IF;
<span class="hljs-keyword">END</span> LOOP;

<span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
RAISE NOTICE <span class="hljs-string">'Dropping Dynamic Table: %'</span>, corpus_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_corpus_ident);

<span class="hljs-comment">-- 2.4 删除 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Dropping Object Table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);

RAISE NOTICE <span class="hljs-string">'Drop complete for corpus: %'</span>, corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
</ul>
<h3 data-id="heading-11">向量检索函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- RAG向量单路召回问答</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_vector_search_retrieval(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    llm_model_valid :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        embedding_recall AS (
            SELECT
              chunk,
              approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') AS distance
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              distance DESC
            LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              embedding_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-12">全文检索函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_text_search_retrieval(
    question TEXT,
    corpus_table TEXT,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    llm_model_valid     :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span>
               <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span>
               <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        text_search_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              text_search_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-13">向量+全文双路召回+Rank排序函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_hybrid_retrieval(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    llm_model_valid       :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid   :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        embedding_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        text_search_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        union_recall AS (
            SELECT chunk FROM embedding_recall
            UNION
            SELECT chunk FROM text_search_recall
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              union_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-14">向量+全文双路召回+RRF排序函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_hybrid_retrieval_rrf(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    rrf_k <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">60</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);
    llm_model_valid       :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);
    ranking_model_valid   :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
                <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
                <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH embedding_recall AS (
        SELECT
          chunk,
          vec_score,
          ROW_NUMBER() OVER (ORDER BY vec_score DESC) AS rank_vec
        FROM (
          SELECT
            chunk,
            approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') AS vec_score
          FROM
            '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
        ) t
        ORDER BY vec_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      text_search_recall AS (
        SELECT
          chunk,
          text_score,
          ROW_NUMBER() OVER (ORDER BY text_score DESC) AS rank_text
        FROM (
          SELECT
            chunk,
            text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') AS text_score
          FROM
            '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
        ) ts
        WHERE text_score &gt; 0
        ORDER BY text_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      rrf_scores AS (
        SELECT
          chunk,
          SUM(1.0 / ('</span> <span class="hljs-operator">||</span> rrf_k <span class="hljs-operator">||</span> <span class="hljs-string">' + rank_val)) AS rrf_score
        FROM (
          SELECT chunk, rank_vec AS rank_val FROM embedding_recall
          UNION ALL
          SELECT chunk, rank_text AS rank_val FROM text_search_recall
        ) sub
        GROUP BY chunk
      ),
      top_chunks AS (
        SELECT chunk
        FROM rrf_scores
        ORDER BY rrf_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      concat_top_chunks AS (
        SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM top_chunks
      )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>如果想体验更多操作流程，欢迎到阿里云官网领取Hologres免费试用，开通Hologres4.0，并按照操作文档实践。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system" ref="nofollow noopener noreferrer">help.aliyun.com/zh/hologres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[attention、transform、bert 复习总结 1]]></title>    <link>https://juejin.cn/post/7575910298283802659</link>    <guid>https://juejin.cn/post/7575910298283802659</guid>    <pubDate>2025-11-24T10:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283802659" data-draft-id="7575910298283786275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="attention、transform、bert 复习总结 1"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T10:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            attention、transform、bert 复习总结 1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:49:40.000Z" title="Mon Nov 24 2025 10:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">详细内容见：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F132156812%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/132156812?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">attention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F132783696%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/132783696?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">transform</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F715589044" target="_blank" title="https://zhuanlan.zhihu.com/p/715589044" ref="nofollow noopener noreferrer">bert</a></li>
</ul>
<h2 data-id="heading-1">1 注意力机制：</h2>
<ul>
<li>简单通俗描述计算过程：Q，K，V(query，key，value)； 我们首先需要计算一下 Q 和 K的距离(相似度)，可以使用向量点积，余弦相似性，或者 MLP，计算结果进行softmax处理，一是归一化处理，二是突出高权重K，然后根据最新处理的K 值与对应 V 值，加权求和即是 attention 值</li>
<li>举例：
<ul>
<li>1 我喜欢吃苹果，也喜欢吃香蕉，不喜欢吃榴莲”（3 个短语，对应 3 个信息单元）</li>
<li>2 我最喜欢吃什么水果？” 这个问题（Q）：</li>
<li>3 生成 K 和 V：K1=“苹果”，V1=“喜欢吃”；K2=“香蕉”，V2=“喜欢吃”；K3=“榴莲”,V3=“不喜欢吃”；</li>
<li>4 Q=“最喜欢的水果”，和 K 匹配：Q vs K1（苹果）：相关（喜欢），权重 3；Q vs K2（香蕉）：相关（喜欢），权重 3；Q vs K3（榴莲）：无关（不喜欢），权重 0；</li>
<li>5 加权合并 V：重点提取 “喜欢吃苹果” 和 “喜欢吃香蕉”，最终输出 “你最喜欢吃苹果和香蕉”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2 自注意力机制：</h3>
<ul>
<li>没有外来的 Q，自己这段信息分成多个部分，不同部分和其他部分充当 Q，K，V
<ul>
<li>举例：
<ul>
<li>1 “小明去超市买了牛奶，他喝完后觉得很好喝”（输入文本的 6 个词：小明、去、超市、买了、牛奶、他、喝完、觉得、很好喝）。</li>
<li>2 写 “他” 这个词时，你得知道 “他” 指的是谁 —— 这就是自注意力机制在工作</li>
<li>3 每个词都当 “提问者（Q）”：“他” 这个词会生成一个 Q（查询）：“他指的是谁？”同时，每个词也都当 “被查者（K/V）”：所有词都会生成自己的 K（标签）和 V（内容）：
<ul>
<li>小明：K=“人名 - 小明”，V=“句子主语，去超市的人”；</li>
<li>去：K=“动作 - 去”，V=“前往某地”；</li>
<li>超市：K=“地点 - 超市”，V=“购物的地方”；</li>
<li>他：K=“代词 - 他”，V=“指代前文的人”；</li>
</ul>
</li>
<li>4 Q "他"去匹配所有词的 K：Q（“我指的是谁？”） vs K（小明）；Q vs K（去 / 超市 / 牛奶）；Q vs K（他自己）；</li>
<li>5 加权提取 V 的信息：重点提取 “小明” 的 V，其他词的 V 几乎忽略；最终 “他” 就明确了：这就是自注意力通过 “内部查询” 找到的关联。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">3 多头注意力机制：</h3>
<ul>
<li>把自注意力机制复制多份（“多个头”），每个头专注于找文本中不同维度的关联（比如一个头找指代关系、一个头找动作和对象、一个头找因果关系），最后把所有头的结果合并，让理解更全面。
<ul>
<li>举例：
<ul>
<li>1  “小明在超市买了牛奶，他喝完后觉得很甜，于是又买了一箱”（核心关联有 3 个：“他” 指代 “小明”、“喝” 的对象是 “牛奶”、“又买” 的原因是 “很甜”）。</li>
<li>2 所有头共享输入文本的 Q、K、V（但会各自做微小的 “参数调整”，让每个头的关注点不同）—— 相当于 3 个小组都拿到同一份报告， but 各自的分析侧重点预设不同。</li>
<li>3 头 1（负责 “指代关系”）：重点找 “谁指谁”:以 “他” 为 Q（“我指谁？”），匹配所有 K，最终锁定 “小明” 的 V，得出结论：“他 = 小明”；
<ul>
<li>头 2（负责 “动作 - 对象关系”）：重点找 “动作对应什么东西”以 “喝” 为 Q（“我针对的对象是什么？”），匹配所有 K，锁定 “牛奶” 的 V，得出结论：“喝的是牛奶”；</li>
<li>头 3（负责 “因果关系”）：重点找 “为什么做这个动作”以 “又买” 为 Q（“我发生的原因是什么？”），匹配所有 K，锁定 “很甜” 的 V，得出结论：“又买是因为牛奶甜”。</li>
</ul>
</li>
<li>4 把 3 个小组的结论合并：“小明在超市买了牛奶，小明喝完牛奶后觉得很甜，因为牛奶甜所以小明又买了一箱”—— 比单个头只找一种关联，理解更完整、更精准。</li>
<li>5 注意：头的数量要能被维度整除</li>
<li>6 分头是对每一个 Q，K，V 的向量化结果进行分头，也就是一段话分成几段儿</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">4 transform：</h2>
<ul>
<li>左侧 Encode：理解输入内容(能看到全文)，只执行一次，可以看成是专属"词典"
<ul>
<li>1 输入数据(编码：见基础知识)+位置信息(PE编码用的正弦余弦距离)，Sin| Cos(pos / 10000 * (2 i  * d))
<ul>
<li>奇数用Cos，偶数用 Sin，pos 是分词位置顺序，i 是分词向量的向量值顺序，d 是向量长度</li>
<li>好处就是：可以应对未出现过更长的句子； 每个分词都有独一无二的位置信息</li>
</ul>
</li>
<li>2 多头注意力机制(多头就是自注意力并行)：输入信息和位置信息输入后，通过 attention 机制进一步提取更多的信息</li>
<li>3 Add 和 Norm：
<ul>
<li>Add：此时的 Add 是一个残差连接，即 输出 = 原始输入 + 多头(原始输入)
<ul>
<li>1 防止过度加工，保留初始信息，防止多头处理效果差导致预训练越差；</li>
<li>2 训练随着层数增加，调整参数的信息会越传递越弱，残差连接可以保持"信号"强度</li>
<li>Norm： 标准化处理(归一化属于标准化的一种)，防止数值过大或者过小导致的梯度爆炸/消失； 标准化后数值小，可以加速收敛</li>
<li>爆炸就是"信号"越来越大，防止消息就是越来越弱</li>
</ul>
</li>
</ul>
</li>
<li>4 Feed Forword： 两层全连接层，一层有激活函数，一层没有，公式max(0,XW1+b1)W2+b2
<ul>
<li>第一层：使用全连接层提高维度放大输入数据中的有效部分，然后使用Relu 函数 max() 进一步扩大有效和无效数据的差异</li>
<li>第二层：再通过全连接层把维度降低，留下有效部分</li>
</ul>
</li>
</ul>
</li>
<li>右侧 Dncode：生成输出(不能看到全文)，以翻译任务为例
<ul>
<li>1 输入数据的形式： 翻译的正确"答案"和同等大小的"答案贴纸"(Mask 矩阵)乘积作为输入，这是为了确保不能提前看到答案,一开始预测的时候只能看到初始信息，其他的都被掩盖了，然后预测出第一个信息后，预测第二个信息时候，就已经能获取到初始信息+预测信息 1 了，来预测信息 2，以此类推预测得到全部结果，注意，这个过程是在一个矩阵内一次生成的！</li>
<li>2 谁来预测？不是预训练模型，预训练模型属于成品模型，此处是搭建好 Decode 框架(比如前馈，Add 和归一化等层)后，随机或者自定义参数，输入数据直接预测，根据不断训练得到最优参数</li>
<li>3 第一个多头输入数据： 翻译答案的 Embedding 结果+位置信息Embedding 结果生成Q，K，V 矩阵</li>
<li>4 第一个多头： QK 矩阵乘以"答案贴纸"(Mask 矩阵)，再乘以 V，加权求和，再进行 software，多头结果拼接到一起就是最终的多头结果, 此时多头的作用，仅仅是获取了初步翻译结果词语之间的顺序，和中文答案没有任何对应关系，因为还没查"词典"</li>
<li>5 第一个 Add 和 Norm： 与 encoder 那个一毛一样</li>
<li>6 第二个多头输入数据：此时上面5 中的输入作为 Q(类似于"我要查字典")，encode输出作为 K，V(字典内索性和详细信息)</li>
<li>7 第二个多头：同样的方法计算多头结果，此时已经获取到了词典信息，正确率会提升不少</li>
<li>8 第二个Add 和 Norm： 与第一个处理方法一样</li>
<li>9 Feed Forword处理是一致的</li>
<li>10 第三个Add 和 Norm：同上</li>
<li>线性函数：把docode生成的矩阵转化成每个词表中对应的"分数"，搭建 “语义特征” 到 “具体词汇” 的桥梁 —— 把抽象的语义，映射到每个具体词的 “匹配度打分"</li>
<li>softmax: 做一个 “归一化转换”，让所有分数变成 0~1 之间的概率，且所有词的概率加起来等于 1；</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">5 bert：双向编码的预训练语言模型</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e378c9c20fb14c9897374378a2565fd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=so0dO%2FO7yOdrYGfdu8BedOQ8xoU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60e4c52e2a444f64ba554cc5c131fe75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=4WpLM35CS%2Bk14b30Guy3lsncMrE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>1 预训练阶段：用大量的无监督文本通过自监督(无需人工标注)训练的方式( MLP 和 NSP)训练
<ul>
<li>输入：与 transform 类似，也是词Embedding+位置 Embedding 向量对应相加作为输入A，如果是句子对的情况还需要加上归属标记向量</li>
<li>但是句子开头有标识符Embeding [CLS]和句子末尾的[SEP]作为输入 B，A 和 B 构成了输入，注意，是拼接不是对应相加, 其中位置向量不是正余弦位置了，和 CLS 和 SEP 一样，都是从初始随机变量随机训练"可学习"的</li>
<li>transform 因为是单向的所以在输入的时候使用了 mask 矩阵，而bert 是不需要的，但是两个模型都是有"答案"对比的，不然无法反向传播进行训练</li>
</ul>
</li>
<li>MLM：先从输入中随机抽取 15%，准备进行处理，在这 15% 中，80% 概率直接 mask，10% 替换其他单词，10% 不动
<ul>
<li>10% 概率直接替换成其他单词，这有助于模型学习理解上下文的重要性，而不仅仅是依赖于[MASK]标记</li>
<li>10% 概率原封不动； 这有助于模型在微调阶段更好地处理未遮蔽的单词</li>
</ul>
</li>
<li>NSP：语料库中随机抽取两个句子，判断是不是上下文;
<ul>
<li>在BERT的后续版本中，Next Sentence Prediction（NSP）任务被废弃了。因为研究人员发现这个任务对下游任务的性能提升有限</li>
<li>举例：</li>
</ul>
<pre><code class="hljs language-python" lang="python">每个token的输入 = 自身向量（可学习） + 位置向量（可学习） + 句子归属向量（固定<span class="hljs-number">0</span>/<span class="hljs-number">1</span>）
	[CLS]  →  自身向量（初始随机：[<span class="hljs-number">0.2</span>, -<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>]） 
			+ 位置向量（第<span class="hljs-number">1</span>位：[<span class="hljs-number">0.5</span>, <span class="hljs-number">0.02</span>, -<span class="hljs-number">0.1</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[<span class="hljs-number">0.7</span>, -<span class="hljs-number">0.08</span>, <span class="hljs-number">0.2</span>]  👉  不是固定值，训练中会变
	
	<span class="hljs-string">"我"</span>   →  自身向量（初始随机：[<span class="hljs-number">0.8</span>, <span class="hljs-number">0.4</span>, -<span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">2</span>位：[<span class="hljs-number">0.4</span>, <span class="hljs-number">0.05</span>, -<span class="hljs-number">0.05</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[<span class="hljs-number">1.2</span>, <span class="hljs-number">0.45</span>, -<span class="hljs-number">0.25</span>]
	
	...（中间<span class="hljs-string">"爱"</span><span class="hljs-string">"吃"</span><span class="hljs-string">"苹果"</span>同理，都是各自向量相加，归属向量全为<span class="hljs-number">0</span>）...
	
	[SEP]  →  自身向量（初始随机：[-<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">6</span>位：[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.01</span>, -<span class="hljs-number">0.15</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.61</span>, <span class="hljs-number">0.05</span>]
	
	<span class="hljs-string">"它"</span>   →  自身向量（初始随机：[<span class="hljs-number">0.1</span>, -<span class="hljs-number">0.3</span>, <span class="hljs-number">0.7</span>]） 
			+ 位置向量（第<span class="hljs-number">7</span>位：[<span class="hljs-number">0.08</span>, <span class="hljs-number">0.005</span>, -<span class="hljs-number">0.18</span>]） 
			+ 句子归属向量（句<span class="hljs-number">2</span>：[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]）  👉  句<span class="hljs-number">2</span>专属标记，和句<span class="hljs-number">1</span>区分
			= 最终输入向量：[<span class="hljs-number">1.18</span>, -<span class="hljs-number">0.295</span>, <span class="hljs-number">0.52</span>]
	
	...（中间<span class="hljs-string">"很"</span><span class="hljs-string">"甜"</span>同理，归属向量全为<span class="hljs-number">1</span>）...
	
	[SEP]  →  自身向量（初始随机：[-<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">10</span>位：[<span class="hljs-number">0.02</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">0.2</span>]） 
			+ 句子归属向量（句<span class="hljs-number">2</span>：[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]） 
			= 最终输入向量：[<span class="hljs-number">0.72</span>, <span class="hljs-number">1.6</span>, <span class="hljs-number">1.0</span>]
</code></pre>
</li>
<li>2 微调阶段：BERT首先使用预训练的参数初始化模型，所有参数都使用下游任务的标签数据进行微调，每个不同的下游任务都有单独的微调模型
<ul>
<li>bert 的主干就是多个 transform 的 encode 叠加，为了深入理解语义，但是具体任务使用还是需要在输出层(主干部分微调)进行微调处理</li>
<li>微调任务包含：
<ul>
<li>基于句子对的分类任务：核心共性：输入是 “句 1 + 句 2”，用 [CLS] 汇总全局语义，输出层做分类 / 回归，复用句对归属标记（0/1）
<ul>
<li>MNLI：自然语言推理)  输出层：线性层 + Softmax（三分类：蕴含 / 矛盾 / 中立）；目的：判断句 2 是否能从句 1 推出。</li>
<li>QQP（Quora 问答匹配）：输出层：线性层 + Softmax（二分类：两问题是否语义相同）；目的：判断两个问题是否是同一问题的不同表述。</li>
<li>QNLI（问答自然语言推理）输出层：线性层 + Softmax（二分类：段落句子是否能回答问题）；目的：筛选能回答问题的句子。</li>
<li>STS-B（语义文本相似度）：输出层：线性层（回归任务，输出 0~5 的相似度分数）；目的：量化两句话的语义相似程度。</li>
<li>MRPC（微软同义句匹配）：输出层：线性层 + Softmax（二分类：是否同义）；目的：判断两句话是否语义等价。</li>
<li>RTE（文本蕴含识别）：输出层：线性层 + Softmax（二分类：蕴含 / 不蕴含）；目的：简化版 MNLI，只判断是否蕴含。</li>
<li>SWAG（情境推理）输出层：线性层 + Softmax（四分类：从 4 个候选后半句选最连贯的）；目的：判断哪个候选句能承接前半句的情境。</li>
</ul>
</li>
<li>基于单个句子的分类任务：核心共性：输入是单句，不用句对标记（全标 0），[CLS] 汇总语义，输出层分类。
<ul>
<li>SST-2（情感分类）：输出层：线性层 + Softmax（二分类：正面 / 负面）；目的：判断句子情感倾向。</li>
<li>ColA（语言可接受性判断）：输出层：线性层 + Softmax（二分类：句子是否语法 / 语义通顺）；目的：判断句子是否是自然语言（比如 “我吃饭” 可接受，“饭吃我” 不可接受）。</li>
</ul>
</li>
<li>问答任务：核心：输入是 “问题 + 原文段落”，输出层预测答案的 “起始 / 结束位置”，不做分类做定位。
<ul>
<li>SQuAD：输出层：两个独立线性层（一个预测答案起始位置，一个预测结束位置）；
<ul>
<li>目的：从原文中找到问题的答案片段（比如问题 “李白生于哪年？”，原文 “李白生于 701 年”，预测起始 = 3，结束 = 5）。</li>
</ul>
</li>
</ul>
</li>
<li>命名实体识别NER：核心：输入是单句，输出层对 “每个词” 做分类（不是 [CLS] 汇总），识别实体类型。
<ul>
<li>CoNLL-2003 NER：输出层：给每个 token 配一个线性层 + Softmax（多分类：PER 人 / ORG 机构 / LOC 地点 / O 非实体）；
<ul>
<li>目的：给每个词打实体标签（比如 “李白（PER）生于 701 年，是唐代（ORG）诗人”）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive]]></title>    <link>https://juejin.cn/post/7576086446459895843</link>    <guid>https://juejin.cn/post/7576086446459895843</guid>    <pubDate>2025-11-24T10:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086446459895843" data-draft-id="7575897635137552384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive"/> <meta itemprop="keywords" content="数据库,大数据,数据分析"/> <meta itemprop="datePublished" content="2025-11-24T10:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:49:40.000Z" title="Mon Nov 24 2025 10:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大数据时代，JSON 已成为数据交换的事实标准。从日志、埋点到 IoT 设备数据，从用户画像到实时监控，JSON 凭借其灵活、可扩展、无需预定义 Schema 的特性，完美契合了快速迭代的现代业务需求。然而，JSON 的动态灵活性与传统数据库的静态处理模型存在根本矛盾，这直接导致了查询性能低下、Schema 管理复杂以及在超宽表场景下的扩展性危机。</p>
<p>因此，对于 JSON 数据的处理，用户常常陷入两难抉择：</p>
<ul>
<li>牺牲 性能 换取 灵活性（用 JSON 存储，承担高昂查询开销）</li>
<li>牺牲 灵活性 换取 性能（提前建立 Schema，丧失动态响应业务变化能力）</li>
</ul>
<p><strong>那么，是否存在两全之策，能让性能与灵活性兼得？答案是肯定的。</strong> Doris  <code>VARIANT</code>通过底层的存算创新，将半结构化数据的灵活性与结构化数据的分析性能完美结合，全面超越了 Snowflake、ClickHouse 等传统方案。</p>
<p>具体而言，Doris Variant 充分发挥列存与索引优势，避免频繁解析和全量扫描导致 CPU 与 I/O 过高引发性能问题。此外，它能从容应对字段动态变化及类型不一致场景，简化 Schema 维护难度，消除了灵活性与性能间冲突。同时，Doris 优化了超宽表中键值繁多、稀疏分布带来的存储与索引复杂性，解决超宽表场景下扩展性问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2774fd14471d48f6b4eb799bfd035019~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=QpEVVyaNFjI9jDNL7rrs9nlJbx0%3D" alt="Doris 与其他产品对比.png" loading="lazy"/></p>
<p>Doris <code>VARIANT</code> 的卓越性能也在业界公开的 JSONBench 半结构化数据测试中得到了充分验证：<strong>冷查询性能排名第一、热查询性能位居第二，全面领先 ClickHouse、Elasticsearch 等一众知名产品。</strong> 其查询速度约是 MongoDB 的 <strong>164</strong> 倍、PostgreSQL 的 <strong>1074</strong> 倍。此外，对 Doris、 Snowflake 进一步对比， 不管是在冷查询还是热查询中，Doris 相较 Snowflake 有约 2-5 倍的性能优势。具体可见下图：</p>
<ul>
<li>登顶 JSONBench 榜单</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7c63612daf4c8797f801cbc3abf6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=123BrIYuCShIpmOHXRa12NpPBuM%3D" alt="登顶 JSONBench 榜单.PNG" loading="lazy"/></p>
<ul>
<li>Doris vs. Snowflake</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f682f38d664db9881c0367832b7809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=5I9Fdl6p9gSqR8Yap9wsS6QVkP4%3D" alt="Doris vs. Snowflake.PNG" loading="lazy"/></p>
<p><strong>Doris Variant 能够具备上述优势，主要得益于以下设计巧思及技术创新。</strong></p>
<h2 data-id="heading-0">一、如何让 JSON 获得列存性能？</h2>
<p>实现半结构化数据高性能分析的前提是，使其能够像处理结构化数据一样，为其构建高效的列式存储结构，这是后续高性能分析的基础。因此，<strong>在 Doris 中，通过动态子列、压缩算法、列裁剪等设计，将半结构数据规范化，从而获获得列存的高性能。</strong></p>
<h3 data-id="heading-1">1.1  动态子列</h3>
<p>在如 Snowflake 这样的系统中，JSON 数据的底层存储对用户而言是一个黑盒，难以进行查询优化、无法保证性能。而在 Doris 中，当 JSON 对象写入 VARIANT 列时，系统会执行以下操作：</p>
<ul>
<li><strong>子列与类型推断</strong>：解析 JSON 的层级结构，提取出所有的 Key Path（如 <code>user.id</code>, <code>event.properties.timestamp</code>），并自动推断每个子列的值类型（如 <code>BIGINT</code>, <code>DOUBLE</code>, <code>STRING</code> 等）。</li>
<li><strong>动态列化（Subcolumnization）</strong>： 对于频繁出现的子列，将其<strong>物化</strong>为独立的内部子列。例如，嵌套在 JSON 中的 <code>user.id</code> 字段在物理存储上会拥有独立的 <code>BIGINT</code> 列式存储结构。</li>
<li><strong>透明访问</strong> ：该过程对用户完全透明。无需预先定义 Schema，数据写入时自动完成列式转换。用户仍可使用 <code>v['user']['id']</code>查询 ，但查询引擎可以直接访问到已物化的 <code>user.id</code> 子列，充分利用列存和向量化执行的性能优势。</li>
<li><strong>稀疏列</strong> ：对于出现频率极低或结构复杂的稀疏子列，不为其创建独立子列以避免列爆炸。相反，这些数据会被高效组织在一个类 JSONB 的二进制“稀疏”列中，保留完整数据而不为罕见字段额外建列。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8cc9776671c46bc8803f7e3a8e034ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=RXHijSljh%2Fz5WUC5whwM5wRodXY%3D" alt="动态子列.png" loading="lazy"/></p>
<p><strong>通过这一机制，Doris 在数据写入阶段就完成了从半结构化到准结构化的转换，为高性能分析奠定了基础。</strong></p>
<h3 data-id="heading-2">1.2 列式存储</h3>
<p>在动态子列的基础上，Doris 进一步运用成熟的列式存储技术，实现存储与 I/O 效率的倍增。</p>
<ul>
<li><strong>压缩</strong>： Doris 会根据子列的数据分布自动挑选压缩算法，例如枚举型字段使用字典编码、连续数值用 RLE，从而实现更紧凑的存储并降低读取成本。</li>
<li><strong>子列级 I/O （列裁剪）</strong>：查询只读取实际需要的字段，消除了过去整块 JSON 拉入再解析的方式。通过 Path 级别列裁剪和延迟物化机制，仅加载必需的 JSON 子列数据，有效减少了数据读取的放大问题。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0873a066f5b7489fb94b56bcd7735382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=wb1E4Rt1UmopJGsL9Onc7h%2BvA74%3D" alt="列式存储.png" loading="lazy"/></p>
<p>通过以上策略，<strong>Doris 解决传统系统中 JSON 查询的慢和重问题，成功地将 JSON 数据的灵活性与列式存储的高性能相结合，实现了半结构化数据的高效分析。</strong> 这种方法不仅提高了查询性能，还简化了 Schema 管理，为用户带来显著的使用优势。</p>
<h3 data-id="heading-3">1.3 千列级存储的性能跃升</h3>
<p>然后，当数据模型从宽进一步演化为超宽时，新的挑战也随之而来。因此 Doris Variant 持续优化，使其能够从容面对<strong>元数据膨胀与合并（Compaction）开销巨大的问题。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abce2ed23cb445ad89a614589e1e7386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=ITIV6DriPkZamd24JcHMi9aFbgQ%3D" alt="1.3 千列级存储的性能跃升.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.3.1 元数据存储优化</h4>
<p>在日志分析、用户画像等超宽表场景中，单表常涉及上千个列（列存）。即便查询仅需访问其中几列，也需将包含所有列元数据的庞大 Footer 完整加载至内存并解析，内存和反序列化成本急剧膨胀，导致严重的 I/O 与内存开销。</p>
<p>为此，Doris 在 Segment 文件格式层进行了关键优化：将列元数据从 Footer 中剥离，独立存储于专用的数据页（可理解为元数据索引页）中，Footer 仅保留指向该页的轻量指针。读取时先加载精简 Footer，再按需定位并加载所需列元数据。这种 <strong>Externalize Meta</strong> 的设计，从根本上避免了宽表场景下的元数据膨胀问题，使列裁剪始终保持高效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1cc33cccf24b5c838a90186f877723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=V%2FstrAJaah22%2BgCcoBBeeUjWtUo%3D" alt="1.3.1 元数据存储优化.png" loading="lazy"/></p>
<p>以下是关于 VARIANT 元数据打开效率的测试对比（环境设置包含 10,000 个 Segment，每个 Segment 拥有 7,000 个 JSON Path，且均已物化为子列）：</p>
<ul>
<li>优化前：需要解析巨大 Footer（包含所有列的 ColumnMeta），导致大量无效的 I/O 操作、反序列化和内存膨胀，I/O 成为性能瓶颈。</li>
<li>优化后：首先读取小型 Footer（仅包含 PagePointer），然后按需加载被访问列的元数据，避免全量解析。<strong>打开速度从 65s 缩减至 4s，效率提升约 16 倍；内存从 60GB 缩减至小于 1GB。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc88d4561b084c9b9d4ae8a8d22c07c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=BMaqRHlbPFK7UM6qd7LNLPliZmI%3D" alt="1.3.1 元数据存储优化-1.png" loading="lazy"/></p>
<h4 data-id="heading-5">1.3.2 Vertical Compaction</h4>
<p>在超宽表场景中，数据合并（Compaction）一直是最棘手的环节。随着表中列数达到上千甚至上万，传统合并策略会暴露出两个主要问题：首先，每次合并都需扫描并重写所有列，即使绝大多数字段并未更新；其次，列元数据和 Segment 文件体积庞大，导致合并的 I/O 成本和内存消耗大幅增加。</p>
<p>为此，Doris Variant 引入子列级 Vertical Compaction，将单次 Compaction 拆分为按列分组的多轮合并。每轮仅加载部分列组（如 10 列），逐步完成全量合并。此举带来两大核心改进：</p>
<ul>
<li><strong>内存峰值显著降低</strong>：每轮只需持有部分列的中间数据，避免了全列并发合并带来的内存瞬时激增；</li>
<li><strong>I/O 访问更加可控</strong>：更细粒度的列组处理，可以更好与磁盘调度、后台刷写并行化配合。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a52191afba441339975a80e9beaa28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=%2B0NN7fFQiIfW1HeN7b%2BTNFdt1C4%3D" alt="1.3.2 Vertical Compaction.png" loading="lazy"/></p>
<p>实测结果显示，在表结构中列数超过 1,000 时，<strong>开启 Vertical Compaction 后，单次合并的内存占用从约 50 GB 降至 2 GB 左右，降低近 25 倍；同时，整体吞吐量几乎未受影响</strong>。更重要的是，Vertical Compaction 使 VARIANT 不再只是能存 JSON，还能在动态 Schema 的超宽表模型中实现长期稳定的运行——这是大多数列式引擎的薄弱环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4a2e468af6e418e9921aa344d5f3fca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=c2jerNavo3jyY2UJKMOvO2v6a6s%3D" alt="1.3.2 Vertical Compaction-1.png" loading="lazy"/></p>
<h2 data-id="heading-6">二、 兼备结构化查询与全文检索</h2>
<p>动态子列解决了 JSON 在大规模扫描与聚合场景下的性能瓶颈，而 Doris 进一步为其构建了高度可定制的索引机制，使其在点查询与文本检索场景下也具备极速响应的能力。设计借鉴了 Elasticsearch <code>dynamic mapping</code> 的思想，可提供开箱即用的高性能索引能力。</p>
<p>Doris Variant 的索引体系，目标是在 结构化过滤 与 全文检索 之间取得平衡。它既能像列存一样高效命中结构化字段，又能像搜索引擎一样支持关键词匹配与短语检索。为实现这一目标，<strong>Doris 在存储层集成倒排索引，并与 ZoneMap、BloomFilter、延迟物化 等原生索引协同工作，实现从文件级到行级的多层剪枝与快速定位</strong>。下面从几个关键机制来看它的实现方式：</p>
<h3 data-id="heading-7">2.1 倒排索引的无缝集成</h3>
<ul>
<li>原理： <code>VARIANT</code> 允许用户为任意子列创建倒排索引。例如，<code>CREATE INDEX idx ON tbl(v) USING INVERTED PROPERTIES("parser" = "english")</code>。Doris 在数据写入时，自动提取 <code>v</code> 子列的值，并分词（如果需要）或按原始值建立一个从“词（Term）”到“行号（RowID）”的映射表。</li>
<li>查询： 当查询条件为 <code>WHERE v['message'] MATCH_ANY 'error'</code> 或 <code>v['level'] = 'FATAL'</code> 时，查询引擎不需扫描全表数据。可直接利用倒排索引，快速定位包含关键词 <code>error</code> 或 <code>FATAL</code> 的所有行，查询复杂度从 O(N) 降至 O(logN) 甚至 O(1）。</li>
</ul>
<h3 data-id="heading-8">2.2 内置索引的协同</h3>
<p>由于高频子列已被物化为内部子列，它们自然享受到 Doris 的其他索引类型的加成：</p>
<ul>
<li>ZoneMap 索引： 默认开启，记录每个数据块（Page）内子列最大/最小值。对于 <code>WHERE v['properties']['price'] &gt; 1000</code> 这样的范围查询，可快速跳过不满足条件的数据块，甚至跳过文件。</li>
<li>BloomFilter 索引： 对于高基数的子列（如 <code>user_id</code>），可创建布隆过滤器索引，快速判断某个值是否存在，过滤掉大量无关读取请求。</li>
<li>延迟物化配合索引： 先用 ZoneMap/BBloomFilter 倒排在文件/页/行级完成剪枝与定位，再对查询命中的行按需解码非谓词投影的子列，避免对未投影或被过滤掉的子列做无谓解码，可有效降低 CPU 与 I/O 成本。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec7f7b87521467a8959eb8f14e71b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=zOy%2BaUDq73kI8CF6rGW6wmtUZlU%3D" alt="2.2 内置索引的协同.png" loading="lazy"/></p>
<h3 data-id="heading-9">2.3 Schema Template 与 Path 级索引</h3>
<p>Schema Template 和 Path 级索引 是实现精确索引下推的关键机制。前者定义「哪些 JSON 子列需被单独识别与优化」，后者定义「这些子列如何被索引与命中」。</p>
<p>通过 Schema Template，可以为关键子列预声明类型及索引属性，让系统在读写阶段就能识别这些高价值路径。 Path 级索引则在此基础上绑定倒排、Bloom 或 ZoneMap 等多层索引策略，实现结构感知的查询优化。</p>
<p>典型配置：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> tbl (
    k <span class="hljs-type">BIGINT</span>,
    v VARIANT<span class="hljs-operator">&lt;</span><span class="hljs-string">'content'</span> : STRING<span class="hljs-operator">&gt;</span>,
    INDEX idx_tokenized(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
        "parser" <span class="hljs-operator">=</span> "english",
        "field_pattern" <span class="hljs-operator">=</span> "content",
        "support_phrase" <span class="hljs-operator">=</span> "true"
    ),
    INDEX idx_keyword(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
        "field_pattern" <span class="hljs-operator">=</span> "content"
    )
);

<span class="hljs-comment">-- tokenized for MATCH; keyword for exact equality</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> v[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">MATCH</span> <span class="hljs-string">'Doris'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> v[<span class="hljs-string">'content'</span>] <span class="hljs-operator">=</span> <span class="hljs-string">'Doris'</span>;
</code></pre>
<blockquote>
<p>tokenized 用于 <code>MATCH</code> 搜索；keyword 用于精确匹配。</p>
</blockquote>
<p>通配符示例：</p>
<pre><code class="hljs language-SQL" lang="SQL">INDEX idx_logs(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
  "field_pattern" <span class="hljs-operator">=</span> "logs.*"
);
</code></pre>
<p>更多使用方式请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F3.x%2Fsql-manual%2Fbasic-element%2Fsql-data-types%2Fsemi-structured%2FVARIANT" target="_blank" title="https://doris.apache.org/zh-CN/docs/3.x/sql-manual/basic-element/sql-data-types/semi-structured/VARIANT" ref="nofollow noopener noreferrer">Variant 文档</a></p>
<h2 data-id="heading-10">三、典型场景实战指南</h2>
<h3 data-id="heading-11">3.1  日志分析场景</h3>
<p>基于 Elasticsearch 或 ClickHouse 的日志分析平台是较为常见的方案，但其问题也比较明显：写入成本高、字段变化难以管理以及查询吞吐不稳定等。</p>
<p>而如果使用 Doris ，Variant 类型可直接写入原始 JSON 日志，不再需要复杂的 ETL 或 Schema Flatten，无需复杂的预处理和 Schema 定义，即可对任意日志字段进行高性能的过滤和全文检索。</p>
<p>示例建表：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> access_log (
  dt <span class="hljs-type">DATE</span>,
  log JSON
)
DUPLICATE KEY(dt)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(dt)
PROPERTIES ("replication_num" <span class="hljs-operator">=</span> "1");

<span class="hljs-keyword">CREATE</span> INDEX idx_log <span class="hljs-keyword">ON</span> access_log(log) <span class="hljs-keyword">USING</span> INVERTED;
</code></pre>
<p>日志通过 Stream Load 实时写入：</p>
<pre><code class="hljs language-SQL" lang="SQL">curl <span class="hljs-operator">-</span>u <span class="hljs-keyword">user</span>:password \
  <span class="hljs-operator">-</span>T access.json \
  <span class="hljs-operator">-</span>H "format: json" \
  http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>fe_host:<span class="hljs-number">8030</span><span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>db<span class="hljs-operator">/</span>access_log<span class="hljs-operator">/</span>_stream_load
</code></pre>
<p>随后就可以像操作结构化数据一样执行查询：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
  log[<span class="hljs-string">'status'</span>] <span class="hljs-keyword">AS</span> status,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> access_log
<span class="hljs-keyword">WHERE</span> log[<span class="hljs-string">'region'</span>] <span class="hljs-operator">=</span> <span class="hljs-string">'US'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status;
</code></pre>
<p>在这个场景中，Doris 会自动将 key 列化存储，例如 <code>region</code> 和 <code>status</code>，从而实现<strong>亚秒级聚合性能</strong>。同时日志结构若有新增字段（例如 <code>latency</code> 或 <code>trace_id</code>），系统会自动创建列存并写入索引，无需手动 ALTER TABLE 或重新导入。</p>
<p><strong>实测表明，在同等硬件条件下，Doris 的日志聚合查询性能相比 Elasticsearch 快 2–3 倍，写入延迟降低 80% 以上，减少约 70–80% 存储空间。</strong></p>
<h3 data-id="heading-12">3.2 动态用户画像</h3>
<p>在用户画像系统中，每个用户通常拥有成百上千个标签，如地域、兴趣、偏好、活跃度和渠道来源等。这些标签往往需要频繁新增或变更。传统的列式建模方案意味着需要不断修改表结构或维护上百个宽表，这种做法效率极低。而 Doris 的 VARIANT 只需一个 Profile 列即可容纳所有标签信息。</p>
<p><strong>示例建表：</strong></p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profile (
  user_id <span class="hljs-type">BIGINT</span>,
  profile VARIANT
)
DUPLICATE KEY(user_id)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id);
</code></pre>
<p>写入时直接插入 JSON 结构：</p>
<pre><code class="hljs language-JSON" lang="JSON">INSERT INTO user_profile VALUES
(<span class="hljs-number">1001</span><span class="hljs-punctuation">,</span> '<span class="hljs-punctuation">{</span><span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"US"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">28</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"interest"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"movie"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"sports"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span>')<span class="hljs-punctuation">,</span>
(<span class="hljs-number">1002</span><span class="hljs-punctuation">,</span> '<span class="hljs-punctuation">{</span><span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CA"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"vip"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ios"</span><span class="hljs-punctuation">}</span>');
</code></pre>
<p>查询时无需展开，也能高效聚合：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">CAST</span>(profile[<span class="hljs-string">'region'</span>] <span class="hljs-keyword">AS</span> String) <span class="hljs-keyword">AS</span> region,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> user_profile
<span class="hljs-keyword">WHERE</span> profile[<span class="hljs-string">'vip'</span>] <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> region;
</code></pre>
<p>在后台，Doris 会自动识别出现的 key （如 <code>region</code> 、<code>vip</code> ），并将其物化为独立列（支持成千上万的独立列）。极其低频字段仍保留在兜底 <code>Sparse</code> 列中。 因此即便标签数量增长到上千个，查询性能依然接近普通结构化表。</p>
<p><strong>实际用户测试中，拥有 7000 个动态标签的用户画像表，查询 Top10 标签分布的平均响应时间保持在 1 秒以内。</strong></p>
<h3 data-id="heading-13">3.3 客户使用反馈</h3>
<p>度小满实现从 Greenplum 到  Apache Doris 的平滑迁移，构建了超大规模数据分析平台。借助内置的 Variant 类型，实现了对 2–3 万  JSON Key 的高效查询与存储（PB 级别）。<strong>系统整体性能提升 20–30 倍，JSON 查询速度提升 10 倍，存储占用为传统 JSON 类型的 1/10</strong>。在高并发实时查询与复杂分析任务下，成功支撑 金融级指标分析与实时数据服务，让度小满的数据平台实现从 离线分析 → 实时洞察的跨越。</p>
<p>——度小满</p>
<p>某大型互联网公司将原有 HBase + Elasticsearch + Snowflake 三套系统迁移至 Doris 这一套系统中来，实现了搜索与分析统一。<strong>Doris Variant 列式数据类型支持高维、动态 JSON 的高效存储与查询，让数十亿对象的非结构化属性也能以列式方式处理</strong>。并基于子列索引与裁剪机制，<strong>查询延迟从秒级降至百毫秒级</strong>，并发写入与复杂 Join 性能也显著提升。系统整体成本降低，架构得到简化，稳定性与一致性全面增强。</p>
<p>——某大型互联网公司</p>
<p>在原系统中（Elasticsearch），Dynamic Mapping 导致字段冲突频发、资源占用高、聚合性能受限。观测云携手飞轮科技，基于 Doris 引入 Variant 数据类型与倒排索引，并通过 S3 对象存储 构建弹性冷热分离架构，大幅提升日志与行为数据的查询效率。升级后，<strong>机器成本降低 70%，整体查询性能提升 2 倍，简单查询提速超 4 倍，以不到 1/3 的成本获得数倍性能提升</strong>，显著增强了可观测性平台的可扩展性与经济性。</p>
<p>——观测云</p>
<p>某全球领先的新能源与智能制造企业将原有 Hive/Kudu + Impala/Presto 体系迁移到 Apache Doris，构建了面向车联网与装备全生命周期的实时分析平台。<strong>依托 Doris 内置的 Variant 类型，高效处理 PB 级规模的 JSON 半结构化数据，实现秒级实时摄取和毫秒级查询性能。</strong> 在核心业务如实时看板、全链路追踪、设备运行与健康分析等场景中，<strong>复杂 JSON 查询提速 3–10 倍、高并发查询能力显著提升、且存储占用仅为传统方案的 1/3</strong>。借助统一的 Doris 引擎，实现从离线批处理到实时洞察的跨越，大幅降低整体架构复杂度与运维成本。</p>
<p>——某全球领先的新能源与智能制造企业</p>
<p>面对上百万辆车日均数十 TB 信号数据的挑战，零跑采用 <strong>Variant 动态列存</strong> 与 <strong>S3 对象存储</strong> 构建统一数据底座，支持了智能座舱、远程诊断和用户行为分析等多场景。结合物化视图与弹性计算，实现毫秒级查询与自动伸缩、存储成本下降 60% 的显著成效。团队正进一步验证 <strong>Serverless 形态</strong>，希望利用 S3 的高弹性与 Doris 的高性能，实现“按需使用、零运维伸缩”的数据云脑。</p>
<p>—— 零跑汽车</p>
<h2 data-id="heading-14">四、结束语</h2>
<p>Apache Doris 的 <code>VARIANT</code> 类型，让半结构化数据能在列式引擎中被自然地处理。它通过动态子列、稀疏列存储、延迟物化和路径索引，将 JSON 解析、列裁剪与索引下推整合为统一体系，实现了<strong>灵活结构 与 列存性能</strong>的平衡。</p>
<p>未来，Apache Doris 将进一步增强 Variant 自动 Schema 推导能力，支持更丰富的类型、更强大的子列索引系统，并优化稀疏列的数据查询。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes CRD 方式配置容器日志采集最佳实践]]></title>    <link>https://juejin.cn/post/7576175307356323875</link>    <guid>https://juejin.cn/post/7576175307356323875</guid>    <pubDate>2025-11-24T11:01:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307356323875" data-draft-id="7575910298283737123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes CRD 方式配置容器日志采集最佳实践"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-24T11:01:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes CRD 方式配置容器日志采集最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:01:05.000Z" title="Mon Nov 24 2025 11:01:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、概述</h2>
<p>DataKit 通过 Kubernetes Custom Resource Definition (CRD) 提供了一种声明式的容器日志采集配置方式。用户可以通过创建 ClusterLoggingConfig 资源来自动配置 DataKit 的日志采集，无需手动修改 DataKit 配置文件或重启 DataKit，同样也无需重启业务。</p>
<h2 data-id="heading-1">二、前置条件</h2>
<ul>
<li>Kubernetes 集群版本 1.16+</li>
<li>DataKit Version-1.84.0 或更新版本</li>
<li>集群管理员权限（用于注册 CRD）</li>
</ul>
<h2 data-id="heading-2">三、采集流程</h2>
<h3 data-id="heading-3">1. 注册 Kubernetes CRD</h3>
<ul>
<li>使用以下 YAML 注册 <code>ClusterLoggingConfig</code> CRD：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">clusterloggingconfigs.logging.datakits.io</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">datakit-logging-config</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1alpha1</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">group:</span> <span class="hljs-string">logging.datakits.io</span>
  <span class="hljs-attr">versions:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1alpha1</span>
      <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">schema:</span>
        <span class="hljs-attr">openAPIV3Schema:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">properties:</span>
            <span class="hljs-attr">apiVersion:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
            <span class="hljs-attr">kind:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
            <span class="hljs-attr">metadata:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
            <span class="hljs-attr">spec:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">required:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">selector</span>
              <span class="hljs-attr">properties:</span>
                <span class="hljs-attr">selector:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                  <span class="hljs-attr">properties:</span>
                    <span class="hljs-attr">namespaceRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">podRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">podLabelSelector:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">containerRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">podTargetLabels:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
                  <span class="hljs-attr">items:</span>
                    <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">configs:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
                  <span class="hljs-attr">items:</span>
                    <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                    <span class="hljs-attr">required:</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">source</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">type</span>
                    <span class="hljs-attr">properties:</span>
                      <span class="hljs-attr">source:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">type:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">disable:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">boolean</span>
                      <span class="hljs-attr">path:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">multiline_match:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">pipeline:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">storage_index:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">tags:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                        <span class="hljs-attr">additionalProperties:</span>
                          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
  <span class="hljs-attr">scope:</span> <span class="hljs-string">Cluster</span>
  <span class="hljs-attr">names:</span>
    <span class="hljs-attr">plural:</span> <span class="hljs-string">clusterloggingconfigs</span>
    <span class="hljs-attr">singular:</span> <span class="hljs-string">clusterloggingconfig</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
    <span class="hljs-attr">shortNames:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">logging</span>
</code></pre>
<ul>
<li>创建 CRD 资源，自动应用采集配置</li>
</ul>

<pre><code class="hljs">kubectl apply -f clusterloggingconfig-crd.yaml
</code></pre>
<ul>
<li>验证 CRD 注册</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">kubectl get crd clusterloggingconfigs.logging.datakits.io
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e075581d4108435886c2ea264e096d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=d1sZI7PVP%2FYBATUf%2Bs3G7MkcyM0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2. 创建 CRD 配置资源</h3>
<ul>
<li>如下为业务应用 yaml ：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">deploy-demo</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0</span>
        <span class="hljs-attr">enviroment:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">container-demo</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">swr.cn-north-4.myhuaweicloud.com/liurui_bj/springboot-server:openj8</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">limits:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>
</code></pre>
<ul>
<li>k8s 部署运行业务后如下：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6b894d43d0445b8602e5d6c7850280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=YZb9azQbK98EkCcqcE1zkM8Zr0w%3D" alt="" loading="lazy"/></p>
<ul>
<li>对应采集配置如下，该采集配置用于采集 default 工作空间 demo 业务的容器内日志以及容器的标准输出，容器内日志来源 source 自定义命名为 demo-file，容器标准输出的 source 自定义命名为 demo-std，更多配置参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fcontainer-log-for-k8s-crd%2F%23configuration-details" target="_blank" title="https://docs.guance.com/integrations/container-log-for-k8s-crd/#configuration-details" ref="nofollow noopener noreferrer">链接</a></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">logging.datakits.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">demo-logs</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">namespaceRegex:</span> <span class="hljs-string">"^(default)$"</span>
    <span class="hljs-attr">podRegex:</span> <span class="hljs-string">"^(deploy.*)$"</span>
    <span class="hljs-attr">podLabelSelector:</span> <span class="hljs-string">"app=demo"</span>

  <span class="hljs-attr">podTargetLabels:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">app</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">version</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">enviroment</span>

  <span class="hljs-attr">configs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"demo-file"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"file"</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/data/logs/server/server.log"</span>
      <span class="hljs-attr">tags:</span>
        <span class="hljs-attr">log_type:</span> <span class="hljs-string">"server"</span>
        <span class="hljs-attr">component:</span> <span class="hljs-string">"springboot-server"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"demo-std"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"stdout"</span>
      <span class="hljs-attr">disable:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">tags:</span>
        <span class="hljs-attr">log_type:</span> <span class="hljs-string">"server"</span>
        <span class="hljs-attr">component:</span> <span class="hljs-string">"springboot-server"</span>
</code></pre>
<ul>
<li>应用配置</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">kubectl apply -f logging-config.yaml
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d750d0fe04274e52a41e47cc6fec7d00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=%2BIde3sTATHBm8fGrTNCddrUIKg8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3. 添加相关 RBAC 配置</h3>
<ul>
<li>在 DataKit 的 ClusterRole 中添加以下权限：</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="hljs-section">kind: ClusterRole</span>
<span class="hljs-section">metadata:</span>
  name: datakit
<span class="hljs-section">rules:</span>
  <span class="hljs-comment"># 原有的其他权限</span>
  - apiGroups: [<span class="hljs-string">"logging.datakits.io"</span>]
    resources: [<span class="hljs-string">"clusterloggingconfigs"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
</code></pre>
<ul>
<li>调整 DataKit 的其他<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fcontainer%2F%23__tabbed_1_2" target="_blank" title="https://docs.guance.com/integrations/container/#__tabbed_1_2" ref="nofollow noopener noreferrer">采集配置</a>，如日志白名单，采集器，数据 dataway 上报地址等，重新 apply DataKit 应用</li>
</ul>

<pre><code class="hljs">kubectl apply -f datakit.yaml
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/893894241f2e47c4b17bc80ba192a6e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=7pXsrn8goQ5lsvmEKBdekexr9vI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">4. 额外配置与说明</h3>
<ul>
<li>需要全局屏蔽日志标准输出采集，需要额外应用自定义 CRD 配置，如下：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">namespaceRegex:</span> <span class="hljs-string">"^(.*)$"</span>

  <span class="hljs-attr">configs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"test"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"stdout"</span>
      <span class="hljs-attr">disable:</span> <span class="hljs-literal">true</span>
</code></pre>
<ul>
<li>DataKit 需要打开 container 采集器，不然 CRD 配置不生效</li>
</ul>
<h2 data-id="heading-7">四、日志采集展示</h2>
<ul>
<li>容器内日志如下图，数据成功上报到观测云，相关 source，log_type，component 等配置字段均成功上报</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4608a8d65244869a5346e95a6ce94b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=LheUw64xVGnujnT%2FW3dLAHXoi%2Fk%3D" alt="" loading="lazy"/></p>
<ul>
<li>容器标准输出如下图，据成功上报到观测云，相关 source，log_type。component 等配置字段均成功上报</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d2651e1e344899b8ecce3821f0e3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=bwRRASuTHMVjOqFCsrTaAlv2sTY%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 数据存储实战拆解！]]></title>    <link>https://juejin.cn/post/7575910298283163683</link>    <guid>https://juejin.cn/post/7575910298283163683</guid>    <pubDate>2025-11-24T08:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283163683" data-draft-id="7576175307352342543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 数据存储实战拆解！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员西西"/> <meta itemprop="url" content="https://juejin.cn/user/326976944214804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 数据存储实战拆解！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/326976944214804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员西西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:55:59.000Z" title="Mon Nov 24 2025 08:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Elasticsearch是一个基于Apache Lucene开发的的搜索服务，提供了一个分布式多用户能力的全文搜索引擎，并基于RESTful web接口。支持结构化搜索、数据分析、复杂的语言处理、地理位置和对象间关联关系等功能。那么如何在SpringBoot项目中整合ElasticSearch来完成数据的存储呢？下面我们就来看看。</p>
<p>这里需要特别说明在高版本的ElasticSearch对于数据的处理方式与低版本的处理方式是不同的，并且，在Spring Boot中所支持的ElasticSearch客户端版本也是有所差异的。这里演示的是基于 Spring Boot 2.1.4.RELEASE 版本和ElasticSearch 6.8.0的版本处理方式。</p>
<h2 data-id="heading-0">依赖和配置</h2>
<p>添加Elasticsearch的依赖到<strong>pom.xml</strong>文件中。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

```js
```
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在配置文件文件中配置ElasticSearch的连接</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">spring.data.elasticsearch.cluster-name</span>=my-cluster
<span class="hljs-attr">spring.data.elasticsearch.cluster-nodes</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">1.202</span>:<span class="hljs-number">9300</span>
</code></pre>
<p>这里需要注意，在高版本的SpringBoot配置中已经不支持这样的配置操作，需要注意的实，在这个配置中如果是通过ELK调用则添加的端口是9200，如果是通过Java程序调用则配置的连接端口是9300。</p>
<h2 data-id="heading-1">具体实现</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Document</span>(indexName = <span class="hljs-string">"my_index"</span>, <span class="hljs-keyword">type</span> = <span class="hljs-string">"my_type"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDocument</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;

    <span class="hljs-comment">// 省略构造函数、getter和setter</span>
}
</code></pre>
<p>继承ElasticsearchRepository接口实现数据访问层代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyDocumentRepository</span> 
<span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;<span class="hljs-title class_">MyDocument</span>, <span class="hljs-title class_">String</span>&gt; {
}
</code></pre>
<p>编写服务层代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDocumentService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MyDocumentRepository</span> repository;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MyDocument</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">MyDocument <span class="hljs-variable language_">document</span></span>) {
        <span class="hljs-keyword">return</span> repository.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">document</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">MyDocument</span>&gt; <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">MyDocument</span>&gt; all = repository.<span class="hljs-title function_">findAll</span>();
        <span class="hljs-keyword">return</span> all;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MyDocument</span> <span class="hljs-title function_">findById</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) {
        <span class="hljs-keyword">return</span> repository.<span class="hljs-title function_">findById</span>(id).<span class="hljs-title function_">orElse</span>(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteById</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) {
        repository.<span class="hljs-title function_">deleteById</span>(id);
    }
}
</code></pre>
<h2 data-id="heading-2">编写Controller类进行测试</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/documents"</span>)
public class MyDocumentController {

    <span class="hljs-variable">@Autowired</span>
    private MyDocumentService service;

    <span class="hljs-variable">@PostMapping</span>
    public MyDocument <span class="hljs-built_in">create</span>(<span class="hljs-variable">@RequestBody</span> MyDocument document) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.save</span>(document);
    }

    @<span class="hljs-selector-tag">GetMapping</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Iterable</span>&lt;<span class="hljs-selector-tag">MyDocument</span>&gt; <span class="hljs-selector-tag">getAll</span>() {
        <span class="hljs-selector-tag">Iterable</span>&lt;<span class="hljs-selector-tag">MyDocument</span>&gt; <span class="hljs-selector-tag">iterable</span> = <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.findAll</span>();
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">iterable</span>;
    }

    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/{id}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">MyDocument</span> <span class="hljs-selector-tag">getById</span>(<span class="hljs-variable">@PathVariable</span> String id) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.findById</span>(id);
    }

    @<span class="hljs-selector-tag">DeleteMapping</span>(<span class="hljs-string">"/{id}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">deleteById</span>(<span class="hljs-variable">@PathVariable</span> String id) {
        <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.deleteById</span>(id);
    }
}
</code></pre>
<p>以上代码示例演示了如何使用Spring Boot整合Elasticsearch实现数据存储。</p>
<p>调用接口进行测试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e23f5d0920a4cc893100549b9b845f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764579359&amp;x-signature=6o2l%2F6sR0LmgmZRoY5lkS5ZWEKk%3D" alt="" loading="lazy"/></p>
<p>获取列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925f9548d9c64d4dad62601c0873b1d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764579359&amp;x-signature=E2p9Ghjx8cvDyU03NHl6aqC41Vs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>在上面的例子中，通过SpringBoot 2.1.4与ElasticSearch6.8.0完成了整合，如果想要适配更高版本的ElasticSearch或者是Spring Boot ，在过程中一定注意对于版本兼容性的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NSSM服务]]></title>    <link>https://juejin.cn/post/7576090441432776714</link>    <guid>https://juejin.cn/post/7576090441432776714</guid>    <pubDate>2025-11-24T08:58:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576090441432776714" data-draft-id="7576090441432416266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NSSM服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:58:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="辜月十"/> <meta itemprop="url" content="https://juejin.cn/user/2872336891512350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NSSM服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2872336891512350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    辜月十
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:58:48.000Z" title="Mon Nov 24 2025 08:58:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、介绍</h2>
<blockquote>
<ul>
<li>全称：<code>Non-Sucking Service Manager</code></li>
<li>核心功能：将一个普通的 <code>Windows</code> 可执行文件（如 <code>.exe</code>, <code>.bat</code>, <code>.py</code>, <code>.jar</code> 等）封装成一个 <code>Windows</code> 服务。</li>
<li>解决的问题：许多应用程序本身并不具备作为 <code>Windows</code> 服务运行的能力。<code>NSSM</code> 充当一个包装器或守护进程，使这些程序能够以服务的身份在后台运行，并享受服务带来的所有好处。</li>
</ul>
</blockquote>
<h2 data-id="heading-1">二、NSSM优点</h2>
<ol>
<li>自动启动：配置为<code>自动</code>启动后，服务会在系统启动时自动运行，无需用户登录。</li>
<li>后台运行：程序在后台静默运行，没有用户界面，不占用任务栏位置。</li>
<li>生命周期管理：可以通过标准的 <code>Windows</code> 服务管理界面（<code>services.msc</code>）或命令行（<code>sc</code>, <code>net</code>）方便地<strong>启动、停止、重启、暂停</strong>服务。</li>
<li>崩溃恢复：可以配置服务在意外退出时<strong>自动重启</strong>，增强程序的健壮性。</li>
<li>统一管理：将所有需要长期运行的程序统一到“服务”中进行管理，规范且高效。</li>
<li>权限控制：可以指定服务以特定的用户身份（如 <code>SYSTEM</code> 或自定义管理员账户）运行。</li>
</ol>
<h2 data-id="heading-2">三、下载与安装</h2>
<ol>
<li>访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnssm.cc%2Fdownload" target="_blank" title="https://nssm.cc/download" ref="nofollow noopener noreferrer">nssm.cc/download</a></li>
<li>选择版本：下载最新稳定版（如 <code>nssm 2.24</code>）。根据你的系统架构（32位或64位）选择对应的 ZIP 包。</li>
<li>安装：<code>NSSM</code> 是绿色软件，无需安装。只需将 <code>ZIP</code> 包解压到一个你喜欢的目录，例如 <code>D:\nssm</code>。</li>
<li>添加到 <code>PATH</code>（可选）：为了在任何命令行窗口中使用 <code>nssm</code> 命令，可以将 <code>nssm.exe</code> 所在的路径添加到系统的 <code>PATH</code> 环境变量中。</li>
</ol>
<h2 data-id="heading-3">四、常用命令</h2>
<h3 data-id="heading-4">4.1、核心服务生命周期管理命令</h3>
<p>这些是最常用的一组命令。</p>








































<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm install &lt;servicename&gt; [&lt;application&gt; [&lt;arguments&gt;]]</code></td><td><strong>安装服务</strong>。如果不指定应用路径，则会打开 GUI 进行配置。</td><td><code>nssm install MyService</code> <code>nssm install MyService "C:\MyApp\app.exe" "-p 8080"</code></td></tr><tr><td><code>nssm start &lt;servicename&gt;</code></td><td>启动服务。</td><td><code>nssm start MyService</code></td></tr><tr><td><code>nssm stop &lt;servicename&gt;</code></td><td>停止服务。</td><td><code>nssm stop MyService</code></td></tr><tr><td><code>nssm restart &lt;servicename&gt;</code></td><td>重启服务（先停止，再启动）。</td><td><code>nssm restart MyService</code></td></tr><tr><td><code>nssm pause &lt;servicename&gt;</code></td><td>暂停服务（如果服务支持）。</td><td><code>nssm pause MyService</code></td></tr><tr><td><code>nssm continue &lt;servicename&gt;</code></td><td>恢复被暂停的服务（如果服务支持）。</td><td><code>nssm continue MyService</code></td></tr></tbody></table>
<h3 data-id="heading-5">4.2、服务配置管理命令</h3>
<p>这些命令用于查看和修改服务的参数。</p>






























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm edit &lt;servicename&gt;</code></td><td>打开服务的 GUI 配置界面进行修改。</td><td><code>nssm edit MyService</code></td></tr><tr><td><code>nssm get &lt;servicename&gt; &lt;parameter&gt;</code></td><td><strong>获取</strong>服务某个配置参数的值。</td><td><code>nssm get MyService AppParameters</code></td></tr><tr><td><code>nssm set &lt;servicename&gt; &lt;parameter&gt; &lt;value&gt;</code></td><td><strong>设置</strong>服务某个配置参数的值。</td><td><code>nssm set MyService AppDirectory "C:\MyApp"</code></td></tr><tr><td><code>nssm reset &lt;servicename&gt; &lt;parameter&gt;</code></td><td>将某个配置参数<strong>重置</strong>为默认值。</td><td><code>nssm reset MyService ObjectName</code></td></tr></tbody></table>
<h3 data-id="heading-6">4.3、服务安装与移除命令</h3>




















<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm remove &lt;servicename&gt;</code></td><td>交互式地<strong>移除/卸载</strong>服务。会要求你确认。</td><td><code>nssm remove MyService</code></td></tr><tr><td><code>nssm remove &lt;servicename&gt; confirm</code></td><td><strong>无条件直接移除/卸载</strong>服务，无需确认。</td><td><code>nssm remove MyService confirm</code></td></tr></tbody></table>
<h3 data-id="heading-7">4.4、服务状态与信息查询命令</h3>

























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm status &lt;servicename&gt;</code></td><td>检查服务的状态。返回如 <code>SERVICE_RUNNING</code>, <code>SERVICE_STOPPED</code> 等。</td><td><code>nssm status MyService</code></td></tr><tr><td><code>nssm statuscode &lt;servicename&gt;</code></td><td>以数字代码的形式返回服务的状态。</td><td><code>nssm statuscode MyService</code></td></tr><tr><td><code>nssm list</code></td><td>列出所有由 NSSM 管理的服务。</td><td><code>nssm list</code></td></tr></tbody></table>
<h3 data-id="heading-8">4.5、高级与不常用命令</h3>






























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm dump &lt;servicename&gt;</code></td><td>生成一个包含服务所有当前配置的可重命名脚本。用于备份或复制配置。</td><td><code>nssm dump MyService &gt; config.txt</code></td></tr><tr><td><code>nssm rotatelogs &lt;servicename&gt;</code></td><td>手动轮转（归档）该服务的输出日志文件。</td><td><code>nssm rotatelogs MyService</code></td></tr><tr><td><code>nssm process &lt;servicename&gt;</code></td><td>显示托管该服务的 NSSM 进程的 PID。</td><td><code>nssm process MyService</code></td></tr><tr><td><code>nssm processes</code></td><td>显示所有 NSSM 服务进程的 PID。</td><td><code>nssm processes</code></td></tr></tbody></table>
<h3 data-id="heading-9">4.6、常用配置参数（用于 <code>get</code>/<code>set</code> 命令）</h3>
<p>当使用 <code>nssm set &lt;servicename&gt; &lt;parameter&gt; &lt;value&gt;</code> 时，以下是一些最常用的 <code>&lt;parameter&gt;</code>：</p>

































































<table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>Application</code></td><td>要运行的可执行文件的完整路径。</td><td><code>nssm set MyService Application "C:\Program Files\nodejs\node.exe"</code></td></tr><tr><td><code>AppParameters</code></td><td>传递给可执行文件的命令行参数。</td><td><code>nssm set MyService AppParameters "app.js"</code></td></tr><tr><td><code>AppDirectory</code></td><td>应用程序的启动工作目录。</td><td><code>nssm set MyService AppDirectory "C:\MyApp"</code></td></tr><tr><td><code>AppStdout</code></td><td>重定向标准输出（stdout）的日志文件路径。</td><td><code>nssm set MyService AppStdout "C:\logs\service.log"</code></td></tr><tr><td><code>AppStderr</code></td><td>重定向标准错误（stderr）的日志文件路径。</td><td><code>nssm set MyService AppStderr "C:\logs\error.log"</code></td></tr><tr><td><code>AppExit</code></td><td>服务退出行为。默认为 <code>Restart</code>，配合 <code>AppThrottle</code> 使用。</td><td><code>nssm set MyService AppExit Default</code></td></tr><tr><td><code>AppThrottle</code></td><td>服务重启前的延迟时间（秒）。</td><td><code>nssm set MyService AppThrottle 5</code></td></tr><tr><td><code>DisplayName</code></td><td>在服务管理器中显示的友好名称。</td><td><code>nssm set MyService DisplayName "我的重要服务"</code></td></tr><tr><td><code>Start</code></td><td>启动类型。<code>SERVICE_AUTO_START</code>(自动), <code>SERVICE_DEMAND_START</code>(手动), <code>SERVICE_DISABLED</code>(禁用)。</td><td><code>nssm set MyService Start SERVICE_DEMAND_START</code></td></tr><tr><td><code>ObjectName</code></td><td>运行服务所用的账户（如 <code>.\Administrator</code> 或 <code>NT AUTHORITY\SYSTEM</code>）。</td><td><code>nssm set MyService ObjectName ".\MyUser"</code></td></tr><tr><td><code>Type</code></td><td>服务类型。绝大多数情况使用 <code>SERVICE_WIN32_OWN_PROCESS</code>。</td><td><code>nssm set MyService Type SERVICE_WIN32_OWN_PROCESS</code></td></tr></tbody></table>
<h2 data-id="heading-10">五、案例:</h2>
<h3 data-id="heading-11">5.1、Nginx服务</h3>
<h4 data-id="heading-12">5.1.1、使用 GUI 界面安装</h4>
<ol>
<li>
<p>安装服务</p>
<pre><code class="hljs language-shell" lang="shell">nssm install Nginx
</code></pre>
</li>
<li>
<p>在弹出的 GUI 界面中配置：</p>
<p><strong>Application 标签页</strong>：</p>
<ul>
<li><strong>Path</strong>: <code>D:\nginx\nginx.exe</code> （你的 nginx.exe 完整路径）</li>
<li><strong>Startup directory</strong>: <code>D:\nginx</code> （Nginx 安装目录）</li>
<li><strong>Arguments</strong>: （留空）</li>
</ul>
<p><strong>Details 标签页</strong>：</p>
<ul>
<li><strong>Display name</strong>: <code>Nginx Web Server</code> （可选，更友好的显示名称）</li>
<li><strong>Startup type</strong>: <code>Automatic</code> （设置为自动启动）</li>
</ul>
<p><strong>I/O 标签页</strong>：</p>
<ul>
<li><strong>Output (stdout)</strong> : <code>D:\nginx\logs\service-stdout.log</code></li>
<li><strong>Error (stderr)</strong> : <code>D:\nginx\logs\service-stderr.log</code><br/>
<em>这会将 Nginx 的控制台输出重定向到日志文件</em></li>
</ul>
<p><strong>Exit 标签页</strong>：</p>
<ul>
<li>勾选 <code>Restart</code> 选项，设置：
<ul>
<li><strong>Restart delay (ms)</strong> : <code>5000</code> （失败后等待 5 秒重启）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>点击 <code>Install service</code>完成安装。</p>
</li>
</ol>
<h4 data-id="heading-13">5.1.2、完全使用命令行安装（适合脚本化部署）</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装服务</span>
nssm install Nginx "D:\nginx\nginx.exe"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置启动目录</span>
nssm set Nginx AppDirectory "D:\nginx"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置显示名称</span>
nssm set Nginx DisplayName "Nginx Web Server"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置启动类型为自动</span>
nssm set Nginx Start SERVICE_AUTO_START
<span class="hljs-meta prompt_">
# </span><span class="bash">配置日志重定向</span>
nssm set Nginx AppStdout "D:\nginx\logs\service-stdout.log"
nssm set Nginx AppStderr "D:\nginx\logs\service-stderr.log"
<span class="hljs-meta prompt_">
# </span><span class="bash">配置失败时自动重启</span>
nssm set Nginx AppExit Default Restart
nssm set Nginx AppRestartDelay 5000
<span class="hljs-meta prompt_">
# </span><span class="bash">启动服务</span>
nssm start Nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移]]></title>    <link>https://juejin.cn/post/7576052677050925082</link>    <guid>https://juejin.cn/post/7576052677050925082</guid>    <pubDate>2025-11-24T08:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677050925082" data-draft-id="7575829296452829194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-11-24T08:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想进字节冲啊冲"/> <meta itemprop="url" content="https://juejin.cn/user/2947168673222887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2947168673222887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想进字节冲啊冲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:45:17.000Z" title="Mon Nov 24 2025 08:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言：零编码实现的初体验</h2>
<p>最近在开发需求时，频繁听到关于 AI 编程能力的讨论。借着 Qoder 测试版发布的契机，我决定在实际业务中体验一把“零编码”开发。</p>
<p>这次实验不仅是一次工具的试用，更是一次开发模式的<strong>范式转移</strong>。我发现，在 AI 辅助下，前端工程师的角色正在发生本质变化：我们不再仅仅是代码的编写者（Coder），而是转变为**架构师 + 产品经理 + 质量保障（QA）**的复合体。这正是 Andrej Karpathy 所提出的 <strong>"Vibe Coding"（氛围编码/直觉编码）</strong> ——你负责把握逻辑与效果（The Vibe），AI 负责具体的语法实现（The Code）。</p>
<h2 data-id="heading-1">2. 实战复盘：级联多选组件的“无中生有”</h2>
<h3 data-id="heading-2">2.1 需求背景与挑战</h3>
<p>业务场景需要一个支持<strong>多选</strong>的级联选择器（省-市-区-社区），且交互逻辑复杂：</p>
<ul>
<li>省市层级单选，区与社区层级多选。</li>
<li>单选与多选逻辑混合。</li>
<li><strong>技术难点</strong>：项目使用的 Vant UI 组件库中的 <code>Cascader</code> 组件原生仅支持单选。</li>
</ul>
<h3 data-id="heading-3">2.2 初始沟通：粗糙但有效的意图传达</h3>
<p>这是我第一次完全依赖 AI 编程。我的第一版 Prompt 非常直白，甚至有些粗糙，直接把需求和设计稿丢给了 AI：</p>
<p><strong>User Prompt:</strong><br/>
你知道 vant 中的 Cascader 吗？组件只能支持单选，我希望它支持多选。<br/>
请把这里的 Cascader 替换为多选组件。<br/>
我可以给你提供可供参考的 UI 设计稿，你有不懂的可以随时问我。<br/>
附件：ui稿位置@index.md</p>
<h3 data-id="heading-4">2.3 AI 的惊人反馈：不仅仅是代码</h3>
<p>让我惊讶的是，Claude 并没有直接扔给我一堆代码，而是先生成了一份**《级联多选组件设计文档》**。</p>
<p>这份文档包含了：</p>
<ol>
<li><strong>技术架构</strong>：使用 Mermaid 绘制的组件层次结构图。</li>
<li><strong>数据流向</strong>：清晰的 <code>Props</code> 和 <code>Emit</code> 接口定义。</li>
<li><strong>逻辑边界</strong>：详细描述了“向下级联全选”和“向上级联反选”的逻辑。</li>
</ol>
<p><strong>💡</strong> <strong>洞察</strong>：AI 生成的设计文档虽然完美，但实际生成的代码（MVP版本）却存在数据加载失败、Tab 无法切换等 Bug。这揭示了 Vibe Coding 的核心痛点：<strong>宏观设计完美，微观实现易错。</strong></p>
<h2 data-id="heading-5">3. 核心方法论：如何让 AI 读懂你的“意图”</h2>
<p>在经历了十几轮的修复和迭代后，我总结出了驾驭 AI 的三板斧。</p>
<h3 data-id="heading-6">3.1 意图定义（Define the Vibe）</h3>
<p>放弃思考 DOM 结构，跳出传统的“实现细节”，转而描述“功能与交互”。</p>
<ul>
<li>❌ <strong>Bad Vibe</strong>: "写一个红色的按钮。"</li>
<li>✅ <strong>Good Vibe</strong>: "创建一个主操作按钮，当鼠标 Hover 时有微小的缩放动画，点击时显示 Loading 状态，并且要符合我们现有的紫色品牌色调。"</li>
</ul>
<h3 data-id="heading-7">3.2 规则约束（Context &amp; Rules）</h3>
<p>AI 就像一个才华横溢但不受约束的实习生。如果不立规矩，它会写出风格迥异的代码。我们需要通过 <code>.cursorrules</code> 或系统提示词来约束它。</p>
<p><strong>实战经验：</strong> 我将团队的 ESLint 规则、TypeScript 规范以及 React/Vue 的最佳实践整理给 AI。例如：</p>
<ul>
<li><strong>变量命名</strong>：必须使用 <code>const</code>，变量名要语义化。</li>
<li><strong>类型安全</strong>：禁止使用 <code>any</code>，优先使用 <code>interface</code> 而非 <code>type</code>。</li>
<li><strong>样式管理</strong>：明确指定使用 Tailwind CSS 还是 styled-components，防止 AI 混用。</li>
</ul>
<p><em>(注：在实际操作中，建议建立项目级的</em> <code>.cursorrules</code> <em>文件，将编码规范固化下来，AI 会自动读取。)</em></p>
<h3 data-id="heading-8">3.3 微调与迭代（Review &amp; Refine）</h3>
<p>AI 生成的代码往往不能直接上线，这时需要进行<strong>微调</strong>。</p>
<ul>
<li><strong>精确上下文</strong>：不要让 AI 盲目重写。选中具体的代码行，告诉它：“只修改这个函数的错误处理逻辑”。</li>
<li><strong>测试驱动</strong>：让 AI 自己生成测试用例和测试页面。我去测试页面操作，发现 Bug 后，将现象描述给 AI，让它自我修复。</li>
</ul>
<h2 data-id="heading-9">4. 避坑指南与最佳实践</h2>
<h3 data-id="heading-10">4.1 警惕“幻觉”与样式崩坏</h3>
<ul>
<li><strong>现象</strong>：AI 可能会编造不存在的 Tailwind 类名，或者使用了项目未安装的图标库。</li>
<li><strong>对策</strong>：在 Rules 中明确白名单。例如：“图标库请仅使用 <code>Lucide-React</code>，不要引入其他库。”</li>
</ul>
<h3 data-id="heading-11">4.2 保持代码一致性</h3>
<ul>
<li><strong>现象</strong>：同一个组件，AI 一会儿用 <code>function</code> 定义，一会儿用箭头函数。</li>
<li><strong>对策</strong>：<strong>One-Shot Learning（单样本学习）</strong> 。在 Prompt 中贴一段你认为完美的现有代码作为“范本”，告诉 AI：“请严格模仿这段代码的风格和结构来生成新组件。”</li>
</ul>
<h3 data-id="heading-12">4.3 复杂状态管理的边界</h3>
<ul>
<li><strong>现象</strong>：当涉及复杂的全局状态（如 Redux/Zustand）或核心业务流时，AI 容易逻辑混乱。</li>
<li><strong>对策</strong>：<strong>分层开发</strong>。核心的业务逻辑（Store 设计、API 层）建议由资深工程师把控架构，UI 层和简单的逻辑处理交给 AI。</li>
</ul>
<h2 data-id="heading-13">5. 总结：前端工程师的进化</h2>
<p>Vibe Coding 模式下，我们还需要写代码吗？答案是需要的，但<strong>写的“代码”变了</strong>。</p>
<p>我们需要编写的不再是具体的 <code>if-else</code>，而是：</p>
<ol>
<li><strong>Prompt</strong>：精准描述需求的自然语言。</li>
<li><strong>Rules</strong>：约束 AI 行为的规范文档。</li>
<li><strong>Tests</strong>：验证 AI 产出的验收标准。</li>
</ol>
<p>在这个新时代，评估优秀前端的标准也随之改变：</p>
<ul>
<li><strong>Prompt Engineering 能力</strong>：能否用最短的语言描述最复杂的交互？</li>
<li><strong>Code Review 能力</strong>：能否在 AI 生成的千行代码中，一眼洞察性能隐患？</li>
<li><strong>架构设计能力</strong>：能否搭建让 AI 发挥得更好的基础设施？</li>
</ul>
<p><strong>"Coding is not about typing; it's about thinking."</strong></p>
<p>Vibe Coding 并没有消灭编程，它只是帮我们省去了“打字”的过程，让我们终于可以回归编程的本质：<strong>思考解决问题的方法</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 17 -核心动画]]></title>    <link>https://juejin.cn/post/7576175307352424463</link>    <guid>https://juejin.cn/post/7576175307352424463</guid>    <pubDate>2025-11-24T09:01:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307352424463" data-draft-id="7575829296452222986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 17 -核心动画"/> <meta itemprop="keywords" content="Flutter,iOS,Android"/> <meta itemprop="datePublished" content="2025-11-24T09:01:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 17 -核心动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:01:36.000Z" title="Mon Nov 24 2025 09:01:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73781550b2ac44b49beb7bd1fe08feae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUXVhbnR1bUxlYXDkuLY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764579696&amp;x-signature=TkQbImGOKvgrEwff3v79%2FBBppMA%3D" alt="Snipaste_2025-11-24_16-55-23.png" loading="lazy"/>
动画是移动应用的灵魂，能够增强页面交互效果，比如：微信下拉刷新的旋转动画、支付宝页面切换的平滑过渡、抖音点赞动效等等这些炫酷的动画效果使你的App更加出彩。今天我们就来深入探讨Flutter中那些让人惊艳的动画效果，一步步掌握动画的核心技巧！</p>
</blockquote>
<h2 data-id="heading-1">一、动画核心类介绍</h2>
<h3 data-id="heading-2">1.1 动画的本质是什么？</h3>
<p>在深入代码之前，我们先要理解动画的本质。简单来说，动画就是<strong>在一段时间内连续改变属性值</strong>的过程。</p>
<p>举个例子：</p>
<ul>
<li>一个按钮从透明变成不透明（改变opacity值）</li>
<li>一个图标从左边移动到右边（改变position值）</li>
<li>一个容器从小变大（改变size值）</li>
</ul>
<p>用伪代码表示就是：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 伪代码</span>
开始值 = <span class="hljs-number">0.0</span>
结束值 = <span class="hljs-number">1.0</span>
持续时间 = <span class="hljs-number">1.0</span> 

<span class="hljs-comment">// 在1秒内，当前值从0.0线性变化到1.0</span>
当前值 = 开始值 + (结束值 - 开始值) * (已用时间 / 持续时间)
</code></pre>
<h3 data-id="heading-3">1.2 动画核心类</h3>
<p>Flutter的动画系统建立在以下四个核心类基础之上：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. AnimationController</span>
AnimationController controller;

<span class="hljs-comment">// 2. Animation</span>
Animation&lt;<span class="hljs-built_in">double</span>&gt; animation;

<span class="hljs-comment">// 3. Tween</span>
Tween&lt;<span class="hljs-built_in">double</span>&gt; tween;

<span class="hljs-comment">// 4. Curve</span>
CurvedAnimation curvedAnimation;
</code></pre>
<p>如果把动画效果比作开车，别想歪了，哈哈！想象一下你将车从A点开到B点：</p>
<blockquote>
<ul>
<li><code>AnimationController</code>就像是你的脚踩油门和刹车，控制车的启动、停止、加速、减速</li>
<li><code>Tween</code>就像是导航，告诉你从A点（开始值）到B点（结束值）的路线</li>
<li><code>Animation</code>就像是车速表，实时显示当前的速度值</li>
<li><code>Curve</code>就像是道路状况，决定了你是匀速前进、先快后慢，还是有什么特殊的加速模式</li>
</ul>
</blockquote>
<h3 data-id="heading-4">1.3 核心类的职责</h3>
<p><strong>Animation - 值容器</strong></p>
<pre><code class="hljs language-dart" lang="dart">Animation&lt;<span class="hljs-built_in">double</span>&gt; sizeAnimation;

<span class="hljs-comment">// 主要职责：</span>
<span class="hljs-comment">// - 持有当前动画值</span>
<span class="hljs-comment">// - 通知监听器值发生变化</span>
<span class="hljs-comment">// - 管理动画状态</span>

<span class="hljs-comment">// 添加值监听器</span>
sizeAnimation.addListener(() {
  setState(() {
    <span class="hljs-comment">// 当动画值变化时，重建Widget。。。</span>
  });
});

<span class="hljs-comment">// 添加状态监听器  </span>
sizeAnimation.addStatusListener((status) {
  <span class="hljs-keyword">switch</span> (status) {
    <span class="hljs-keyword">case</span> AnimationStatus.dismissed:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'动画在开始状态'</span>); 
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> AnimationStatus.forward:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'正向执行'</span>); 
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> AnimationStatus.reverse:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'反向执行'</span>); 
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> AnimationStatus.completed:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'执行完成'</span>); 
      <span class="hljs-keyword">break</span>;
  }
});
</code></pre>
<p><strong>AnimationController</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyAnimationState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyAnimation</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  
  <span class="hljs-keyword">late</span> AnimationController controller;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    <span class="hljs-comment">// 创建动画控制器</span>
    controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>),  <span class="hljs-comment">// 持续2秒</span>
      vsync: <span class="hljs-keyword">this</span>,                     <span class="hljs-comment">// 垂直同步</span>
    );
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    controller.dispose();  <span class="hljs-comment">// 释放</span>
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<p><strong>这里有个重要概念：vsync</strong>
<code>vsync</code>的作用是防止动画在页面不可见时继续运行，造成浪费资源。通过<code>SingleTickerProviderStateMixin</code>，当页面被遮挡或切换到后台时，动画会自动暂停。</p>
<h2 data-id="heading-5">二、隐式动画</h2>
<h3 data-id="heading-6">2.1 什么是隐式动画？</h3>
<p>本质就是<strong>告诉Widget最终的状态是什么</strong>，Flutter会自动帮你生成过渡动画。</p>
<ul>
<li>普通Widget：不加任何动画效果，widget会很生硬的直接过渡过去；</li>
<li>隐式动画Widget：从旧状态到新状态间有一个平滑的过渡，用户体验更好一些；</li>
</ul>
<h3 data-id="heading-7">2.2 隐式动画组件</h3>
<h4 data-id="heading-8">2.2.1 AnimatedContainer</h4>
<p><code>AnimatedContainer</code>：最常用的隐式动画组件，几乎所有的容器属性动画都可以用它来完成。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimatedContainerExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _AnimatedContainerExampleState createState() =&gt; _AnimatedContainerExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AnimatedContainerExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AnimatedContainerExample</span>&gt; </span>{
  <span class="hljs-comment">// 定义可变属性</span>
  <span class="hljs-built_in">double</span> _width = <span class="hljs-number">100.0</span>;
  <span class="hljs-built_in">double</span> _height = <span class="hljs-number">100.0</span>;
  Color _color = Colors.blue;
  BorderRadius _borderRadius = BorderRadius.circular(<span class="hljs-number">8.0</span>);
  
  <span class="hljs-keyword">void</span> _toggleAnimation() {
    setState(() {
      <span class="hljs-comment">// 改变属性值</span>
      _width = _width == <span class="hljs-number">100.0</span> ? <span class="hljs-number">200.0</span> : <span class="hljs-number">100.0</span>;
      _height = _height == <span class="hljs-number">100.0</span> ? <span class="hljs-number">200.0</span> : <span class="hljs-number">100.0</span>;
      _color = _color == Colors.blue ? Colors.green : Colors.blue;
      _borderRadius = _borderRadius == BorderRadius.circular(<span class="hljs-number">8.0</span>) 
          ? BorderRadius.circular(<span class="hljs-number">50.0</span>)   <span class="hljs-comment">// 变成圆</span>
          : BorderRadius.circular(<span class="hljs-number">8.0</span>);   <span class="hljs-comment">// 变回圆角矩形</span>
    });
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        AnimatedContainer(
          width: _width,
          height: _height,
          duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),     <span class="hljs-comment">// 动画时长</span>
          curve: Curves.easeInOut,            <span class="hljs-comment">// 动画曲线</span>
          decoration: BoxDecoration(
            color: _color,
            borderRadius: _borderRadius,
          ),
          child: Center(
            child: Text(
              <span class="hljs-string">'点我'</span>,
              style: TextStyle(color: Colors.white),
            ),
          ),
        ),
        SizedBox(height: <span class="hljs-number">20</span>),
        ElevatedButton(
          onPressed: _toggleAnimation,
          child: Text(<span class="hljs-string">'触发动画'</span>),
        ),
      ],
    );
  }
}
</code></pre>
<p><strong>AnimatedContainer支持的动画属性：</strong></p>
<ul>
<li><strong>尺寸</strong>：<code>width</code>、<code>height</code></li>
<li><strong>颜色</strong>：<code>color</code></li>
<li><strong>边框圆角</strong>：<code>borderRadius</code></li>
<li><strong>内边距</strong>：<code>padding</code></li>
<li><strong>外边距</strong>：<code>margin</code></li>
<li><strong>阴影</strong>：<code>boxShadow</code></li>
<li><strong>变换</strong>：<code>transform</code></li>
</ul>
<h4 data-id="heading-9">2.2.2 AnimatedOpacity</h4>
<p>用来处理透明度变化的组件，非常适合实现显示/隐藏的过渡效果。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimatedOpacityExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _AnimatedOpacityExampleState createState() =&gt; _AnimatedOpacityExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AnimatedOpacityExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AnimatedOpacityExample</span>&gt; </span>{
  <span class="hljs-built_in">double</span> _opacity = <span class="hljs-number">1.0</span>;  <span class="hljs-comment">// 1.0 = 完全显示，0.0 = 完全隐藏</span>
  
  <span class="hljs-keyword">void</span> _toggleVisibility() {
    setState(() {
      _opacity = _opacity == <span class="hljs-number">1.0</span> ? <span class="hljs-number">0.0</span> : <span class="hljs-number">1.0</span>;
    });
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        AnimatedOpacity(
          opacity: _opacity,
          duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
          curve: Curves.easeInOut,
          child: Container(
            width: <span class="hljs-number">200</span>,
            height: <span class="hljs-number">200</span>,
            color: Colors.blue,
            child: Center(
              child: Text(
                <span class="hljs-string">'淡入淡出'</span>,
                style: TextStyle(color: Colors.white, fontSize: <span class="hljs-number">20</span>),
              ),
            ),
          ),
        ),
        SizedBox(height: <span class="hljs-number">20</span>),
        ElevatedButton(
          onPressed: _toggleVisibility,
          child: Text(_opacity == <span class="hljs-number">1.0</span> ? <span class="hljs-string">'隐藏'</span> : <span class="hljs-string">'显示'</span>),
        ),
      ],
    );
  }
}
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>页面元素的显示/隐藏</li>
<li>加载状态的过渡</li>
<li>错误信息的淡入淡出</li>
</ul>
<h4 data-id="heading-10">2.2.3 其他隐式动画组件</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// AnimatedPadding - 内边距动画</span>
AnimatedPadding(
  padding: EdgeInsets.all(_paddingValue),
  duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
  child: YourWidget(),
)

<span class="hljs-comment">// AnimatedAlign - 对齐位置动画  </span>
AnimatedAlign(
  alignment: _alignment,
  duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
  child: YourWidget(),
)

<span class="hljs-comment">// AnimatedPositioned - 定位动画（注意：只能在Stack中使用）</span>
AnimatedPositioned(
  left: _left,
  top: _top,
  duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
  child: YourWidget(),
)
</code></pre>
<h3 data-id="heading-11">2.3 隐式动画的工作原理</h3>
<p>很多人会有疑问：为什么改变属性值就能产生动画？下面我们深入探讨其背后的实现原理：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户交互
    participant S as setState()
    participant W as 隐式动画Widget
    participant E as 动画引擎
    participant R as 渲染层
    
    U-&gt;&gt;S: 触发状态变化
    S-&gt;&gt;W: 重建Widget树
    W-&gt;&gt;E: 检测到属性变化
    E-&gt;&gt;E: 计算动画补间值
    loop 每一帧
        E-&gt;&gt;W: 更新动画值
        W-&gt;&gt;R: 重绘界面
    end
    E-&gt;&gt;W: 动画完成
</code></pre>
<p>下面来看一段代码，来辅助理解隐式动画：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 隐式动画的内部逻辑</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimatedContainer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ImplicitlyAnimatedWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(AnimatedContainer oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    
    <span class="hljs-comment">// 当属性发生变化时</span>
    <span class="hljs-keyword">if</span> (oldWidget.width != widget.width) {
      <span class="hljs-comment">// 创建动画控制器</span>
      <span class="hljs-comment">// 创建补间动画</span>
      <span class="hljs-comment">// 启动动画</span>
    }
  }
}
</code></pre>
<p>简单来说，当<code>setState()</code>被调用时：</p>
<ol>
<li>Widget树重建</li>
<li><code>AnimatedContainer</code>检测到属性值变化</li>
<li>自动创建动画控制器和补间动画</li>
<li>启动动画，在指定时间内平滑过渡到新值</li>
</ol>
<h2 data-id="heading-12">三、补间动画</h2>
<h3 data-id="heading-13">3.1 什么是补间动画？</h3>
<p>"补间"这个词来源于动画制作领域，意思是<strong>在起始状态和结束状态之间过渡帧</strong>。</p>
<p>在Flutter中，<code>Tween</code>就是做这个工作的：</p>
<ul>
<li>你告诉它起始值(begin)和结束值(end)</li>
<li>它负责计算中间的所有值</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 创建一个从50到200的尺寸补间动画</span>
Tween&lt;<span class="hljs-built_in">double</span>&gt; sizeTween = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
  begin: <span class="hljs-number">50.0</span>,   <span class="hljs-comment">// 开始值</span>
  end: <span class="hljs-number">200.0</span>,    <span class="hljs-comment">// 结束值</span>
);

<span class="hljs-comment">// 创建一个从红色到蓝色的颜色补间动画  </span>
ColorTween colorTween = ColorTween(
  begin: Colors.red,
  end: Colors.blue,
);
</code></pre>
<h3 data-id="heading-14">3.2 Tween的完整使用流程</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TweenAnimationExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _TweenAnimationExampleState createState() =&gt; _TweenAnimationExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TweenAnimationExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TweenAnimationExample</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  
  <span class="hljs-keyword">late</span> AnimationController _controller;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _sizeAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;Color?&gt; _colorAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _rotationAnimation;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    <span class="hljs-comment">// 1. 创建动画控制器</span>
    _controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>),
      vsync: <span class="hljs-keyword">this</span>,
    );
    
    <span class="hljs-comment">// 2. 创建补间动画</span>
    _sizeAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">50.0</span>,
      end: <span class="hljs-number">200.0</span>,
    ).animate(_controller);
    
    _colorAnimation = ColorTween(
      begin: Colors.blue,
      end: Colors.red,
    ).animate(_controller);
    
    _rotationAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">0.0</span>,
      end: <span class="hljs-number">2</span> * <span class="hljs-number">3.14159</span>,  <span class="hljs-comment">// 2π弧度 = 360度</span>
    ).animate(_controller);
    
    <span class="hljs-comment">// 3. 启动动画</span>
    _controller.forward();
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Transform.rotate(
          angle: _rotationAnimation.value,
          child: Container(
            width: _sizeAnimation.value,
            height: _sizeAnimation.value,
            color: _colorAnimation.value,
            child: Center(
              child: Text(
                <span class="hljs-string">'动画中...'</span>,
                style: TextStyle(color: Colors.white),
              ),
            ),
          ),
        );
      },
    );
  }
}
</code></pre>
<h3 data-id="heading-15">3.3 Tween成员</h3>
<p>Flutter提供了多种专门的Tween类：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 尺寸</span>
SizeTween(
  begin: Size(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>),
  end: Size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>),
)

<span class="hljs-comment">// 矩形区域</span>
RectTween(
  begin: Rect.fromLTRB(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>),
  end: Rect.fromLTRB(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>),  
)

<span class="hljs-comment">// 整数</span>
IntTween(
  begin: <span class="hljs-number">0</span>,
  end: <span class="hljs-number">100</span>,
)

<span class="hljs-comment">// 步进</span>
StepTween(
  begin: <span class="hljs-number">0</span>,
  end: <span class="hljs-number">100</span>,
)

<span class="hljs-comment">// 可以为自定义类型创建补间动画</span>
Tween&lt;YourCustomType&gt;(
  begin: CustomType(),
  end: CustomType(),
)
</code></pre>
<h2 data-id="heading-16">四、动画曲线与控制器</h2>
<h3 data-id="heading-17">4.1 动画曲线 - Curves</h3>
<p>动画曲线本质就是模拟现实生活中的自然运动规律。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用不同的动画曲线</span>
Animation&lt;<span class="hljs-built_in">double</span>&gt; animation = CurvedAnimation(
  parent: controller,
  curve: Curves.easeInOut,     <span class="hljs-comment">// 先加速再减速</span>
  reverseCurve: Curves.easeIn, <span class="hljs-comment">// 反向动画</span>
);
</code></pre>
<p><strong>常用的动画曲线：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 线性</span>
Curves.linear

<span class="hljs-comment">// 曲线</span>
Curves.easeIn        <span class="hljs-comment">// 先慢后快</span>
Curves.easeOut       <span class="hljs-comment">// 先快后慢  </span>
Curves.easeInOut     <span class="hljs-comment">// 先慢，中间快，后慢</span>

<span class="hljs-comment">// 弹性效果</span>
Curves.bounceOut     <span class="hljs-comment">// 回弹效果</span>
Curves.elasticOut    <span class="hljs-comment">// 弹簧效果</span>

<span class="hljs-comment">// 回弹效果</span>
Curves.decelerate    <span class="hljs-comment">// 先快后慢</span>
</code></pre>
<h3 data-id="heading-18">4.2 不同曲线效果</h3>
<p>下面创建一个不同曲线的例子：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CurvesDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _CurvesDemoState createState() =&gt; _CurvesDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CurvesDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CurvesDemo</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> AnimationController _controller;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Curve&gt; _curves = [
    Curves.linear,
    Curves.easeIn,
    Curves.easeOut,
    Curves.easeInOut,
    Curves.bounceOut,
    Curves.elasticOut,
  ];
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; _curveNames = [
    <span class="hljs-string">'linear'</span>,
    <span class="hljs-string">'easeIn'</span>, 
    <span class="hljs-string">'easeOut'</span>,
    <span class="hljs-string">'easeInOut'</span>,
    <span class="hljs-string">'bounceOut'</span>,
    <span class="hljs-string">'elasticOut'</span>,
  ];
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>),
      vsync: <span class="hljs-keyword">this</span>,
    )..repeat(reverse: <span class="hljs-keyword">true</span>);  <span class="hljs-comment">// 循环</span>
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ListView.builder(
      itemCount: _curves.length,
      itemBuilder: (context, index) {
        <span class="hljs-keyword">return</span> Padding(
          padding: EdgeInsets.all(<span class="hljs-number">8.0</span>),
          child: Column(
            children: [
              Text(_curveNames[index]),
              SizedBox(height: <span class="hljs-number">10</span>),
              Container(
                height: <span class="hljs-number">50</span>,
                child: AnimatedBuilder(
                  animation: _controller,
                  builder: (context, child) {
                    <span class="hljs-keyword">final</span> animation = CurvedAnimation(
                      parent: _controller,
                      curve: _curves[index],
                    );
                    <span class="hljs-keyword">return</span> Container(
                      width: <span class="hljs-number">50</span> + animation.value * <span class="hljs-number">200</span>,  <span class="hljs-comment">// 宽度从50到250</span>
                      color: Colors.blue,
                      child: Center(
                        child: Text(<span class="hljs-string">'<span class="hljs-subst">${(animation.value * <span class="hljs-number">100</span>).round()}</span>%'</span>),
                      ),
                    );
                  },
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}
</code></pre>
<h2 data-id="heading-19">五、AnimationController</h2>
<h3 data-id="heading-20">5.1 基本操作</h3>
<p><code>AnimationController</code>：控制动画的整个生命周期。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimationControllerExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _AnimationControllerExampleState createState() =&gt; _AnimationControllerExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AnimationControllerExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AnimationControllerExample</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  
  <span class="hljs-keyword">late</span> AnimationController _controller;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _animation;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    _controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>),
      vsync: <span class="hljs-keyword">this</span>,
    );
    
    _animation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(begin: <span class="hljs-number">0</span>, end: <span class="hljs-number">300</span>).animate(_controller);
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        Container(
          height: _animation.value,
          width: _animation.value,
          color: Colors.blue,
        ),
        SizedBox(height: <span class="hljs-number">20</span>),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            ElevatedButton(
              onPressed: _controller.forward,  <span class="hljs-comment">// 正向</span>
              child: Text(<span class="hljs-string">'播放'</span>),
            ),
            ElevatedButton(
              onPressed: _controller.reverse,  <span class="hljs-comment">// 反向</span>
              child: Text(<span class="hljs-string">'倒放'</span>),
            ),
            ElevatedButton(
              onPressed: _controller.stop,     <span class="hljs-comment">// 暂停</span>
              child: Text(<span class="hljs-string">'暂停'</span>),
            ),
            ElevatedButton(
              onPressed: () {
                _controller.reset();           <span class="hljs-comment">// 重置</span>
                _controller.forward();
              },
              child: Text(<span class="hljs-string">'重置并播放'</span>),
            ),
          ],
        ),
        SizedBox(height: <span class="hljs-number">20</span>),
        Text(<span class="hljs-string">'当前值: <span class="hljs-subst">${_animation.value.toStringAsFixed(<span class="hljs-number">1</span>)}</span>'</span>),
        Text(<span class="hljs-string">'当前状态: <span class="hljs-subst">${_controller.status.toString()}</span>'</span>),
      ],
    );
  }
}
</code></pre>
<h3 data-id="heading-21">5.2 使用技巧</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 动画控制的高级方法</span>

<span class="hljs-comment">// 1. 从特定值开始</span>
_controller.animateTo(<span class="hljs-number">0.5</span>);  <span class="hljs-comment">// 从当前值动画到0.5</span>

<span class="hljs-comment">// 2. 相对动画</span>
_controller.forward(from: <span class="hljs-number">0.0</span>);  <span class="hljs-comment">// 从0.0开始正向动画</span>

<span class="hljs-comment">// 3. 重复动画</span>
_controller.repeat(         <span class="hljs-comment">// 无限重复</span>
  min: <span class="hljs-number">0.2</span>,                 <span class="hljs-comment">// 最小值</span>
  max: <span class="hljs-number">0.8</span>,                 <span class="hljs-comment">// 最大值</span>
  reverse: <span class="hljs-keyword">true</span>,            <span class="hljs-comment">// 往返执行</span>
  period: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>), <span class="hljs-comment">// 循环周期</span>
);

<span class="hljs-comment">// 4. 获取动画信息</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'是否动画中: <span class="hljs-subst">${_controller.isAnimating}</span>'</span>);
<span class="hljs-built_in">print</span>(<span class="hljs-string">'是否完成: <span class="hljs-subst">${_controller.isCompleted}</span>'</span>);
<span class="hljs-built_in">print</span>(<span class="hljs-string">'是否停止: <span class="hljs-subst">${_controller.isDismissed}</span>'</span>);
</code></pre>
<h2 data-id="heading-22">六、自定义显式动画与性能优化</h2>
<h3 data-id="heading-23">6.1 自定义显式动画</h3>
<p>有时候隐式动画不能满足我们的需求，这时候就需要自定义显式动画。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomExplicitAnimation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _CustomExplicitAnimationState createState() =&gt; _CustomExplicitAnimationState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CustomExplicitAnimationState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CustomExplicitAnimation</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  
  <span class="hljs-keyword">late</span> AnimationController _controller;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _sizeAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _opacityAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;Color?&gt; _colorAnimation;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    _controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>),
      vsync: <span class="hljs-keyword">this</span>,
    );
    
    <span class="hljs-comment">// 创建交错动画效果</span>
    _sizeAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">50.0</span>,
      end: <span class="hljs-number">200.0</span>,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Interval(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.6</span>, curve: Curves.easeInOut), <span class="hljs-comment">// 只在前60%时间执行</span>
    ));
    
    _opacityAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">0.3</span>,
      end: <span class="hljs-number">1.0</span>,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Interval(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.8</span>, curve: Curves.easeIn), <span class="hljs-comment">// 从20%到80%时间执行</span>
    ));
    
    _colorAnimation = ColorTween(
      begin: Colors.blue,
      end: Colors.purple,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Interval(<span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, curve: Curves.easeOut), <span class="hljs-comment">// 从50%时间开始执行</span>
    ));
    
    _controller.forward();
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Opacity(
          opacity: _opacityAnimation.value,
          child: Container(
            width: _sizeAnimation.value,
            height: _sizeAnimation.value,
            decoration: BoxDecoration(
              color: _colorAnimation.value,
              borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(<span class="hljs-number">0.3</span>),
                  blurRadius: <span class="hljs-number">10</span>,
                  offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>),
                ),
              ],
            ),
            child: Center(
              child: Text(
                <span class="hljs-string">'自定义动画'</span>,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: <span class="hljs-number">18</span>,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}
</code></pre>
<p>二者之间有什么区别呢？隐式动画 vs 显式动画</p>






























<table><thead><tr><th>维度</th><th>隐式动画</th><th>显式动画</th></tr></thead><tbody><tr><td>控制</td><td>自动控制</td><td>完全控制</td></tr><tr><td>代码量</td><td>简单</td><td>相对复杂</td></tr><tr><td>灵活性</td><td>有限</td><td>非常高</td></tr><tr><td>适用场景</td><td>简单属性变化</td><td>复杂动画序列</td></tr></tbody></table>
<h3 data-id="heading-24">6.2 性能优化</h3>
<p>动画性能很重要，不好的动画效果会让用户觉得应用卡顿。这里有几个优化技巧：</p>
<h4 data-id="heading-25">6.2.1 使用AnimatedBuilder局部重建</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：整个页面重建</span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Scaffold(
    body: Opacity(
      opacity: _animation.value,
      child: TestWidget(), <span class="hljs-comment">// 组件被重复重建</span>
    ),
  );
}

<span class="hljs-comment">// 推荐：只重建动画部分</span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Scaffold(
    body: AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Opacity(
          opacity: _animation.value,
          child: child, <span class="hljs-comment">// 使用缓存的child</span>
        );
      },
      child: TestWidget(), <span class="hljs-comment">// 组件只构建一次</span>
    ),
  );
}
</code></pre>
<h4 data-id="heading-26">6.2.2 使用Transform代替布局属性</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：改变尺寸会触发布局重新计算</span>
Container(
  width: _animation.value,
  height: _animation.value,
)

<span class="hljs-comment">// 推荐：Transform只影响绘制，不触发布局</span>
Transform.scale(
  scale: _animation.value,
  child: Container(
    width: <span class="hljs-number">100</span>,  <span class="hljs-comment">// 固定尺寸</span>
    height: <span class="hljs-number">100</span>,
  ),
)
</code></pre>
<h4 data-id="heading-27">6.2.3 避免在动画中使用Opacity</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：Opacity会导致整个子树重绘</span>
Opacity(
  opacity: _animation.value,
  child: TestComplexWidget(),
)

<span class="hljs-comment">// 推荐：使用颜色透明度</span>
Container(
  color: Colors.blue.withOpacity(_animation.value),
  child: TestComplexWidget(),
)

<span class="hljs-comment">// 推荐：使用FadeTransition</span>
FadeTransition(
  opacity: _animation,
  child: TestComplexWidget(),
)
</code></pre>
<h3 data-id="heading-28">6.3 创建一个加载动画</h3>
<p>下面用一个加载动画效果串一下上面所讲内容：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmoothLoadingAnimation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _SmoothLoadingAnimationState createState() =&gt; _SmoothLoadingAnimationState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SmoothLoadingAnimationState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SmoothLoadingAnimation</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  
  <span class="hljs-keyword">late</span> AnimationController _controller;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _rotationAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;<span class="hljs-built_in">double</span>&gt; _scaleAnimation;
  <span class="hljs-keyword">late</span> Animation&lt;Color?&gt; _colorAnimation;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    _controller = AnimationController(
      duration: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">1500</span>),
      vsync: <span class="hljs-keyword">this</span>,
    )..repeat(reverse: <span class="hljs-keyword">true</span>);
    
    _rotationAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">0.0</span>,
      end: <span class="hljs-number">2</span> * <span class="hljs-number">3.14159</span>,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeInOut,
    ));
    
    _scaleAnimation = Tween&lt;<span class="hljs-built_in">double</span>&gt;(
      begin: <span class="hljs-number">0.8</span>,
      end: <span class="hljs-number">1.2</span>,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeInOut,
    ));
    
    _colorAnimation = ColorTween(
      begin: Colors.blue[<span class="hljs-number">300</span>],
      end: Colors.blue[<span class="hljs-number">700</span>],
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeInOut,
    ));
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Transform.rotate(
          angle: _rotationAnimation.value,
          child: Transform.scale(
            scale: _scaleAnimation.value,
            child: Container(
              width: <span class="hljs-number">60</span>,
              height: <span class="hljs-number">60</span>,
              decoration: BoxDecoration(
                color: _colorAnimation.value,
                borderRadius: BorderRadius.circular(<span class="hljs-number">30</span>),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(<span class="hljs-number">0.2</span>),
                    blurRadius: <span class="hljs-number">10</span>,
                    offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>),
                  ),
                ],
              ),
              child: Icon(
                Icons.refresh,
                color: Colors.white,
                size: <span class="hljs-number">30</span>,
              ),
            ),
          ),
        );
      },
    );
  }
}
</code></pre>
<h2 data-id="heading-29">总结</h2>
<h3 data-id="heading-30">核心知识点</h3>
<ul>
<li>理解了Animation、AnimationController、Tween、Curve的作用</li>
<li>掌握了动画状态的生命周期管理</li>
<li>理解了隐式动画的自动管理机制</li>
<li>学会了创建各种类型的补间动画</li>
<li>学会了使用Curves让动画更自然</li>
<li>学会了创建复杂的自定义动画</li>
<li>学会了使用AnimatedBuilder优化性能</li>
</ul>
<p>一个好的应用整体动画效果风格要一致，同时要保持流畅度，增强用户体验。通过本节学习，相信大家已经掌握了Flutter动画的核心概念和实战技巧。多动手实现各种动画效果，不断调试优化吧~~~ <strong>有任何问题欢迎在评论区留言，看到会第一时间回复！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在Python中使用SQLite数据库进行增删改查操作？]]></title>    <link>https://juejin.cn/post/7576026767371763731</link>    <guid>https://juejin.cn/post/7576026767371763731</guid>    <pubDate>2025-11-24T08:50:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576026767371763731" data-draft-id="7576018857367961643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在Python中使用SQLite数据库进行增删改查操作？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-24T08:50:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="test管家"/> <meta itemprop="url" content="https://juejin.cn/user/2763513988408746"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在Python中使用SQLite数据库进行增删改查操作？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763513988408746/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    test管家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:50:04.000Z" title="Mon Nov 24 2025 08:50:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SQLite 是 Python 内置支持的轻量级嵌入式数据库，无需安装额外服务端，仅通过文件（或内存）存储数据，非常适合小型项目、测试场景或本地数据管理。以下是<strong>完整的增删改查（CRUD）操作教程</strong>，包含核心语法、示例代码和最佳实践。</p>
<h3 data-id="heading-0">一、核心前置知识</h3>
<ol>
<li>Python 内置 <code>sqlite3</code> 模块，无需 <code>pip install</code>，直接导入即可使用。</li>
<li>操作流程：<code>建立连接 → 创建游标 → 执行SQL → 处理结果 → 提交事务（增删改）→ 关闭资源</code>。</li>
<li>占位符：SQLite 使用 <code>?</code> 作为参数占位符（避免 SQL 注入，切勿字符串拼接）。</li>
</ol>
<h3 data-id="heading-1">二、完整 CRUD 示例</h3>
<h4 data-id="heading-2">步骤1：导入模块并建立连接</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-comment"># 1. 建立连接（关键）</span>
<span class="hljs-comment"># - 连接本地文件：test.db（不存在则自动创建）</span>
<span class="hljs-comment"># - 内存数据库：sqlite3.connect(":memory:")（程序退出后数据丢失）</span>
conn = sqlite3.connect(<span class="hljs-string">"test.db"</span>)

<span class="hljs-comment"># 2. 创建游标（执行SQL的工具）</span>
cursor = conn.cursor()
</code></pre>
<h4 data-id="heading-3">步骤2：创建表（基础准备）</h4>
<p>先定义数据表结构（以 <code>users</code> 表为例，包含 id、姓名、年龄、邮箱）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建users表（IF NOT EXISTS 避免重复创建）</span>
create_table_sql = <span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- 自增主键
    name TEXT NOT NULL,                    -- 姓名（非空）
    age INTEGER,                           -- 年龄
    email TEXT UNIQUE                      -- 邮箱（唯一，避免重复）
);
"""</span>
cursor.execute(create_table_sql)
conn.commit()  <span class="hljs-comment"># 建表属于修改操作，需提交事务</span>
</code></pre>
<h4 data-id="heading-4">步骤3：新增数据（CREATE）</h4>
<p>支持<strong>单条插入</strong>和<strong>批量插入</strong>，核心是用 <code>?</code> 占位符传递参数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 方式1：单条插入</span>
insert_single_sql = <span class="hljs-string">"INSERT INTO users (name, age, email) VALUES (?, ?, ?);"</span>
<span class="hljs-comment"># 参数以元组形式传递，匹配占位符数量</span>
cursor.execute(insert_single_sql, (<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"alice@example.com"</span>))

<span class="hljs-comment"># 方式2：批量插入（效率更高，减少IO）</span>
insert_batch_sql = <span class="hljs-string">"INSERT INTO users (name, age, email) VALUES (?, ?, ?);"</span>
data_list = [
    (<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"bob@example.com"</span>),
    (<span class="hljs-string">"Charlie"</span>, <span class="hljs-number">28</span>, <span class="hljs-string">"charlie@example.com"</span>),
    (<span class="hljs-string">"David"</span>, <span class="hljs-number">22</span>, <span class="hljs-string">"david@example.com"</span>)
]
cursor.executemany(insert_batch_sql, data_list)

<span class="hljs-comment"># 增删改操作必须提交事务，否则数据不生效</span>
conn.commit()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"插入数据成功，最后插入的ID："</span>, cursor.lastrowid)  <span class="hljs-comment"># 获取最后插入的主键ID</span>
</code></pre>
<h4 data-id="heading-5">步骤4：查询数据（READ）</h4>
<p>查询无需提交事务，核心是通过 <code>fetchone()</code>/<code>fetchall()</code>/<code>fetchmany(n)</code> 获取结果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 方式1：查询单条数据（fetchone()）</span>
select_single_sql = <span class="hljs-string">"SELECT * FROM users WHERE name = ?;"</span>
cursor.execute(select_single_sql, (<span class="hljs-string">"Alice"</span>,))
single_result = cursor.fetchone()  <span class="hljs-comment"># 返回元组：(1, 'Alice', 25, 'alice@example.com')</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"单条查询结果："</span>, single_result)

<span class="hljs-comment"># 方式2：查询多条数据（fetchall()）</span>
select_all_sql = <span class="hljs-string">"SELECT id, name, age FROM users WHERE age &gt; ?;"</span>
cursor.execute(select_all_sql, (<span class="hljs-number">25</span>,))
all_results = cursor.fetchall()  <span class="hljs-comment"># 返回列表嵌套元组：[(2, 'Bob', 30), (3, 'Charlie', 28)]</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n多条查询结果："</span>)
<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> all_results:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{row[<span class="hljs-number">0</span>]}</span>, 姓名: <span class="hljs-subst">{row[<span class="hljs-number">1</span>]}</span>, 年龄: <span class="hljs-subst">{row[<span class="hljs-number">2</span>]}</span>"</span>)

<span class="hljs-comment"># 方式3：指定条数查询（fetchmany(n)）</span>
cursor.execute(<span class="hljs-string">"SELECT * FROM users;"</span>)
many_results = cursor.fetchmany(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 仅获取前2条</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n指定条数查询结果："</span>, many_results)

<span class="hljs-comment"># 进阶：返回字典格式结果（更易读）</span>
<span class="hljs-comment"># 创建游标时指定 row_factory</span>
conn.row_factory = sqlite3.Row
cursor = conn.cursor()
cursor.execute(<span class="hljs-string">"SELECT * FROM users WHERE id = ?;"</span>, (<span class="hljs-number">1</span>,))
dict_result = cursor.fetchone()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n字典格式结果："</span>, dict_result[<span class="hljs-string">"name"</span>], dict_result[<span class="hljs-string">"email"</span>])  <span class="hljs-comment"># 可通过键取值</span>
</code></pre>
<h4 data-id="heading-6">步骤5：更新数据（UPDATE）</h4>
<p>根据条件修改已有数据，注意加 <code>WHERE</code> 子句（否则会更新全表）：</p>
<pre><code class="hljs language-python" lang="python">update_sql = <span class="hljs-string">"UPDATE users SET age = ? WHERE name = ?;"</span>
cursor.execute(update_sql, (<span class="hljs-number">26</span>, <span class="hljs-string">"Alice"</span>))  <span class="hljs-comment"># 将Alice的年龄改为26</span>
conn.commit()

<span class="hljs-comment"># 查看受影响的行数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"更新影响的行数："</span>, cursor.rowcount)  <span class="hljs-comment"># 输出：1</span>
</code></pre>
<h4 data-id="heading-7">步骤6：删除数据（DELETE）</h4>
<p>同样需加 <code>WHERE</code> 子句（否则删除全表数据）：</p>
<pre><code class="hljs language-python" lang="python">delete_sql = <span class="hljs-string">"DELETE FROM users WHERE id = ?;"</span>
cursor.execute(delete_sql, (<span class="hljs-number">4</span>,))  <span class="hljs-comment"># 删除ID为4的记录</span>
conn.commit()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除影响的行数："</span>, cursor.rowcount)  <span class="hljs-comment"># 输出：1</span>
</code></pre>
<h4 data-id="heading-8">步骤7：关闭资源（避免泄漏）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 先关游标，再关连接</span>
cursor.close()
conn.close()
</code></pre>
<h3 data-id="heading-9">三、最佳实践</h3>
<h4 data-id="heading-10">1. 使用上下文管理器（with 语句）</h4>
<p>自动关闭游标/连接，无需手动 <code>close</code>，更简洁安全：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-comment"># 上下文管理器简化操作</span>
<span class="hljs-keyword">with</span> sqlite3.connect(<span class="hljs-string">"test.db"</span>) <span class="hljs-keyword">as</span> conn:
    cursor = conn.cursor()
    <span class="hljs-comment"># 执行查询</span>
    cursor.execute(<span class="hljs-string">"SELECT * FROM users;"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"上下文管理器查询结果："</span>, cursor.fetchall())
    <span class="hljs-comment"># 增删改无需手动commit，with块结束会自动提交（出错则回滚）</span>
    cursor.execute(<span class="hljs-string">"INSERT INTO users (name, age, email) VALUES (?, ?, ?);"</span>, (<span class="hljs-string">"Eve"</span>, <span class="hljs-number">29</span>, <span class="hljs-string">"eve@example.com"</span>))
</code></pre>
<h4 data-id="heading-11">2. 防 SQL 注入（关键）</h4>
<p><strong>严禁字符串拼接 SQL</strong>，必须使用 <code>?</code> 占位符：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 错误示例（易被注入，如name传入 "Alice'; DROP TABLE users; --"）</span>
name = <span class="hljs-string">"Alice"</span>
sql = <span class="hljs-string">f"SELECT * FROM users WHERE name = '<span class="hljs-subst">{name}</span>';"</span>  <span class="hljs-comment"># 危险！</span>

<span class="hljs-comment"># 正确示例（占位符）</span>
sql = <span class="hljs-string">"SELECT * FROM users WHERE name = ?;"</span>
cursor.execute(sql, (name,))  <span class="hljs-comment"># 安全</span>
</code></pre>
<h4 data-id="heading-12">3. 处理异常（生产环境必备）</h4>
<p>捕获 <code>sqlite3.Error</code> 异常，避免程序崩溃：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-keyword">try</span>:
    conn = sqlite3.connect(<span class="hljs-string">"test.db"</span>)
    cursor = conn.cursor()
    <span class="hljs-comment"># 执行可能出错的操作（如插入重复邮箱）</span>
    cursor.execute(<span class="hljs-string">"INSERT INTO users (name, age, email) VALUES (?, ?, ?);"</span>, (<span class="hljs-string">"Frank"</span>, <span class="hljs-number">35</span>, <span class="hljs-string">"alice@example.com"</span>))
    conn.commit()
<span class="hljs-keyword">except</span> sqlite3.IntegrityError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># 捕获唯一键冲突异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"插入失败：唯一键冲突"</span>, e)
    conn.rollback()  <span class="hljs-comment"># 出错回滚事务</span>
<span class="hljs-keyword">except</span> sqlite3.Error <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库错误："</span>, e)
    conn.rollback()
<span class="hljs-keyword">finally</span>:
    <span class="hljs-keyword">if</span> cursor:
        cursor.close()
    <span class="hljs-keyword">if</span> conn:
        conn.close()
</code></pre>
<h3 data-id="heading-13">四、常见问题解答</h3>
<ol>
<li><strong>建表后数据不生效？</strong><br/>
增删改/建表操作需执行 <code>conn.commit()</code>，查询无需。</li>
<li><strong>自增主键如何获取？</strong><br/>
插入后通过 <code>cursor.lastrowid</code> 获取最后插入的 ID。</li>
<li><strong>如何返回字典格式结果？</strong><br/>
设置 <code>conn.row_factory = sqlite3.Row</code>，游标结果可通过键取值。</li>
<li><strong>内存数据库的用途？</strong><br/>
<code>sqlite3.connect(":memory:")</code> 适合临时测试，数据仅存于内存，程序退出后丢失。</li>
</ol>
<h3 data-id="heading-14">总结</h3>
<p>SQLite 操作的核心是：</p>
<ul>
<li>连接：<code>sqlite3.connect()</code>（文件/内存）；</li>
<li>执行：<code>cursor.execute()</code>（单条）/<code>executemany()</code>（批量）；</li>
<li>参数：用 <code>?</code> 占位符，避免 SQL 注入；</li>
<li>事务：增删改需 <code>commit()</code>，异常需 <code>rollback()</code>；</li>
<li>资源：用 <code>with</code> 语句或手动关闭游标/连接。</li>
</ul>
<p>掌握以上内容，即可满足 Python 中 SQLite 绝大部分基础使用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini3Pro无限使用手把手教程]]></title>    <link>https://juejin.cn/post/7575829296452911114</link>    <guid>https://juejin.cn/post/7575829296452911114</guid>    <pubDate>2025-11-24T09:08:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452911114" data-draft-id="7576052677051039770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini3Pro无限使用手把手教程"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-24T09:08:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知识浅谈"/> <meta itemprop="url" content="https://juejin.cn/user/607378030207176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini3Pro无限使用手把手教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607378030207176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知识浅谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:08:58.000Z" title="Mon Nov 24 2025 09:08:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Gemini3Pro无限使用精简版</h2>
<p>Antigravity：谷歌官方推出的IDE，类似于Cursor，集成了Gemini3Pro、Claude4.5、GPT等各家最强大的模型。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8411f4000ab5445ea903801428915591~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=wOhJZYGAnfUxMTlo0irlUVSskm8%3D" alt="" loading="lazy"/>
直接下载安装Antigravity：**<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdownload%3Fhl%3Dzh-cn**%25E5%25B0%25B1%25E5%258F%25AF%25E4%25BB%25A5%25E5%2585%258D%25E8%25B4%25B9%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E4%25BD%2586%25E6%2598%25AF%25E5%259C%25A8%25E5%25AE%2589%25E8%25A3%2585%25E8%25BF%2587%25E7%25A8%258B%25E4%25B8%25AD%25E4%25BC%259A%25E6%259C%2589%25E4%25B8%2580%25E4%25BA%259B%25E9%2597%25AE%25E9%25A2%2598%25E5%258D%25A1%25E4%25BD%258F%25E4%25BD%25A0%25EF%25BC%258C%25E6%2583%25B3%25E8%25A6%2581%25E9%25A1%25BA%25E5%2588%25A9%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E8%25AF%25B7%25E7%259C%258B%25E4%25B8%258B%25E6%2596%2587%25E8%25AF%25A6%25E7%25BB%2586%25E7%2589%2588%25E6%2595%2599%25E7%25A8%258B%25E3%2580%2582" target="_blank" title="https://antigravity.google/download?hl=zh-cn**%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%85%8D%E8%B4%B9%E4%BD%BF%E7%94%A8%EF%BC%8C%E4%BD%86%E6%98%AF%E5%9C%A8%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BC%9A%E6%9C%89%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%E5%8D%A1%E4%BD%8F%E4%BD%A0%EF%BC%8C%E6%83%B3%E8%A6%81%E9%A1%BA%E5%88%A9%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%AF%B7%E7%9C%8B%E4%B8%8B%E6%96%87%E8%AF%A6%E7%BB%86%E7%89%88%E6%95%99%E7%A8%8B%E3%80%82" ref="nofollow noopener noreferrer">antigravity.google/download?hl…</a></p>
<h2 data-id="heading-1">Gemini3Pro手把手教程</h2>
<h3 data-id="heading-2">Gemini3Pro的强大</h3>
<p>目前网络上各种测评视频已经给大家普及了很多，刷新目前市面上各种大模型的高度，贴一张测试图如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6481a823f24bb19af25e57eae29dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=X6Ghpy8LDP9i1Lr563gWaBKqtaE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">官网网页版有限使用</h3>
<p>直接访问**<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fapp" target="_blank" title="https://gemini.google.com/app" ref="nofollow noopener noreferrer">gemini.google.com/app</a>**
，每天使用的额度有限，使用方式如下:
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b728dca9e794fc29fd98acc04f0c937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=fzTA6bih2A6LMKPTb81kV9Iq17Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">Antigravity谷歌自家IDE无限使用</h3>
<h4 data-id="heading-5">第一步：安装Antigravity</h4>
<h5 data-id="heading-6">1.下载安装Antigravity：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdownload%3Fhl%3Dzh-cn" target="_blank" title="https://antigravity.google/download?hl=zh-cn" ref="nofollow noopener noreferrer">antigravity.google/download?hl…</a></strong></h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96a86d72af5543d1876aceee36e9a57a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=Orl%2F3q4d3iv36eZZLEP816FOgOg%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-7">2.下载Proxifier（必须要下载）</h5>
<p>链接: <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F12E0gA_rEqL9DovNi2K_TGQ%3Fpwd%3Djcgy" target="_blank" title="https://pan.baidu.com/s/12E0gA_rEqL9DovNi2K_TGQ?pwd=jcgy" ref="nofollow noopener noreferrer">pan.baidu.com/s/12E0gA_rE…</a></strong></p>
<blockquote>
<p>为什么要下载Proxifier？</p>
<p>因为Antigravity只能通过TUN模式使用，代理软件如V2**不支持TUN模式，所以只能通过Proxifier来使用。</p>
</blockquote>
<p>现在打开Proxifier开始配置：
先打开你的科学软件如V2***，再打开Proxifier 点击 配置文件-&gt;代理服务器
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e119bc08f9a3429481ec01ba93623ae5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=aFuVF%2FVBSzKC3YNGPb8TIKpnujo%3D" alt="" loading="lazy"/>
点击添加，
然后输入你的科学软件对应socks端口并保存
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ae7eff76ae4e59800693f522d25b73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=etLTLhbpbmCOOQdfl3gQxpOfngA%3D" alt="" loading="lazy"/>
点击代理规则--&gt;添加--&gt;选择应用程序antigravity.exe--&gt;选择动作sockets5那条记录，点击确定即可</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66fd76f81f7847cca76ecdb4668d63bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=EI20c2O9Bh2eqMJB8LYWDpoSIgo%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">3.打开Antigravity</h5>
<p>如果你没有第二步，到这一步你可能就登陆不上了，因为Antigravit通过科学软件的系统代理是不能登陆的，需要通过TUN模式才能登录。</p>
<p>登陆失败案例：你网页显示登陆了，但是Antigravity还是没登陆。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5dd0987b27448b0ac32ac492ba704e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=h2mtBynrp5bDBsDRzFBLJMDcMjc%3D" alt="" loading="lazy"/></p>
<p>当然如果你的科学软件是cla**,你只需要打开TUN模式（虚拟网卡模式），如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad576b1ad3624968a22c83aee18031ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=U5ruh2PfsmKEfZRiIVM3Juo5wmQ%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-9">3.使用Antigravity的Gemini3Pro</h5>
<p>文章写到这了也接近尾声了，生成一个封面图作为案例给大家看一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0acf77c7978f432b9b86b5964f84a57c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580138&amp;x-signature=muTxGMmqvdz8mSmP2TQ25huXNIs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">总结</h2>
<p>好用的工具总会被发现，就比如正在看这篇文章的伯乐们，祝大家用的愉快玩的开心，有什么问题可以留言哈！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“屎山”：用 Husky + Prettier + ESLint 打造前端项目的代码基石]]></title>    <link>https://juejin.cn/post/7575829296452943882</link>    <guid>https://juejin.cn/post/7575829296452943882</guid>    <pubDate>2025-11-24T09:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452943882" data-draft-id="7576090441432727562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“屎山”：用 Husky + Prettier + ESLint 打造前端项目的代码基石"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T09:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="专业抄代码选手"/> <meta itemprop="url" content="https://juejin.cn/user/127961159439400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“屎山”：用 Husky + Prettier + ESLint 打造前端项目的代码基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/127961159439400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    专业抄代码选手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:13:45.000Z" title="Mon Nov 24 2025 09:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个多人参与的项目，如果没有代码规范，会导致代码样式五花八门，特别难看。
我相信对于程序员这个职业来说，一个项目中，代码格式千奇百怪，没有几个人能忍吧。<br/>
现在在github上随意看一个项目，都几乎是配备了husky的，这个工具可以hook到git的命令，然后自动运行相关脚本，进而达到自动格式化代码的目的。</p>
<p>今天，我们就来详细介绍如何配置 Husky，并结合 Prettier 和 ESLint，为你的项目构建一个坚实的代码规范防线。</p>
<h3 data-id="heading-0">核心工具栈一览</h3>
<p>在深入配置之前，我们先来认识一下我们将要使用的“黄金组合”：</p>
<ul>
<li><strong>Husky:</strong> Git Hooks 管理工具，负责拦截 Git 命令并在特定阶段执行脚本。</li>
<li><strong>Prettier:</strong> 强大的代码格式化工具，确保代码风格统一美观。</li>
<li><strong>ESLint:</strong> 静态代码分析工具，用于发现并修复代码中的潜在问题和不符合规范的写法。</li>
<li><strong>lint-staged:</strong> 配合 Husky 使用，只对 Git 暂存区的文件进行 Lint 和格式化，大幅提升效率。</li>
<li><strong>eslint-config-prettier:</strong> 解决 ESLint 与 Prettier 规则冲突的关键配置。</li>
</ul>
<h3 data-id="heading-1">配置 Husky：自动化检查的“守门员”</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftypicode.github.io%2Fhusky%2Fzh%2Fget-started.html" target="_blank" title="https://typicode.github.io/husky/zh/get-started.html" ref="nofollow noopener noreferrer">husky官网</a>，进去之后按照引导安装即可</p>
<pre><code class="hljs language-js" lang="js"># 安装 <span class="hljs-title class_">Husky</span>
npm install --save-dev husky

# 初始化 <span class="hljs-title class_">Husky</span> (会在项目根目录创建 .<span class="hljs-property">husky</span> 文件夹)
npx husky init
</code></pre>
<p><strong>小贴士:</strong> 如果你的项目尚未进行 Git 初始化 (<code>git init</code>)，<code>npx husky init</code> 命令会报错提示 <code>.git can't be found</code>。请务必先初始化 Git 仓库，再进行 Husky 初始化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550fc366805845f0a359ab5edd257b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiT5Lia5oqE5Luj56CB6YCJ5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580425&amp;x-signature=Fs47O4OieQpPuUprInVaB%2BFKbIM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">安装相关依赖</h3>
<p>这里husky只是可以hook到git的命令，具体要做什么，我们要自定义。<br/>
为了实现代码的自动化格式化和规范检查，我们需要安装 Prettier、ESLint，以及它们的重要辅助工具 <code>lint-staged</code> 和 <code>eslint-config-prettier</code>。</p>
<pre><code class="hljs language-js" lang="js"># 安装 prettier 和 eslint (如果还没装的话)
npm install --save-dev prettier eslint

# 安装 lint-staged
npm install --save-dev lint-staged

# 解决 <span class="hljs-title class_">Prettier</span> 和 <span class="hljs-title class_">ESLint</span> 规则冲突的重要插件
# (这个插件会关闭所有可能与 <span class="hljs-title class_">Prettier</span> 冲突的 <span class="hljs-title class_">ESLint</span> 格式化规则)
npm install --save-dev eslint-config-prettier
</code></pre>
<h3 data-id="heading-3">配置lint-staged</h3>
<p>在我们的 <code>package.json</code> 中添加 <code>lint-staged</code> 的配置。这告诉它对不同类型的文件执行什么操作：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-comment">// ... 其他 scripts</span>
  },
  <span class="hljs-string">"lint-staged"</span>: {
    <span class="hljs-string">"*.{js,jsx,ts,tsx}"</span>: [
      <span class="hljs-string">"prettier --write"</span>,
      <span class="hljs-string">"eslint --fix"</span>
    ],
    <span class="hljs-string">"*.{json,css,md,html}"</span>: [
      <span class="hljs-string">"prettier --write"</span>
    ]
  },
  <span class="hljs-comment">// ... 其他依赖</span>
}
</code></pre>
<h3 data-id="heading-4">修改<code>eslint.config.js</code>配置</h3>
<p><code>eslint-config-prettier</code> 会关闭所有可能与 Prettier 格式规则冲突的 ESLint 规则。在 Flat Config 中，配置是按数组顺序应用的，后一个配置会覆盖前一个。因此，我们需要确保 <code>eslintConfigPrettier</code> 处于配置数组的<strong>末尾</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 引入 prettier 配置 </span>
<span class="hljs-keyword">import</span> eslintConfigPrettier <span class="hljs-keyword">from</span> <span class="hljs-string">"eslint-config-prettier"</span>;
<span class="hljs-comment">// 2. 并在最后添加 eslintConfigPrettier</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>([
  <span class="hljs-title function_">globalIgnores</span>([<span class="hljs-string">"dist"</span>]),
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">"**/*.{ts,tsx}"</span>],
    <span class="hljs-attr">extends</span>: [
      js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
      tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
      reactHooks.<span class="hljs-property">configs</span>.<span class="hljs-property">flat</span>.<span class="hljs-property">recommended</span>,
      reactRefresh.<span class="hljs-property">configs</span>.<span class="hljs-property">vite</span>,
    ],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
      <span class="hljs-attr">globals</span>: globals.<span class="hljs-property">browser</span>,
    },
  },
  eslintConfigPrettier,
]);
</code></pre>
<h3 data-id="heading-5">修改husky的hook命令</h3>
<p>这里就是最后的一步了，在commit的时候，我们要运行什么命令<br/>
修改<code>.husky/pre-commit</code>，在里面添加</p>
<pre><code class="hljs">npx lint-staged
</code></pre>
<h3 data-id="heading-6">自定义代码规范</h3>
<p>如果我们想修改代码的格式规范，可以在<code>prettierrc.json</code>文件中对其进行修改，如果没有这个文件，创建一个就好了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .prettierrc.json</span>
{
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">4</span>,          <span class="hljs-comment">// 缩进宽度为 4 个空格</span>
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">false</span>,          <span class="hljs-comment">// 不使用分号</span>
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 使用单引号</span>
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">80</span>,       <span class="hljs-comment">// 每行代码最多 80 个字符 (可选，但推荐)</span>
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"all"</span>  <span class="hljs-comment">// 对象或数组的最后一个元素后总是添加逗号 (可选，但推荐)</span>
}
</code></pre>
<h3 data-id="heading-7">总结</h3>
<p>通过 Husky、Prettier、ESLint 和 lint-staged 的强强联合，我们构建了一个高效且强大的代码规范自动化流程。这将：</p>
<ul>
<li><strong>统一代码风格：</strong> 团队成员的代码风格将高度一致，降低阅读成本。</li>
<li><strong>提升代码质量：</strong> 及时发现潜在的 Bug 和不规范的写法。</li>
<li><strong>优化开发体验：</strong> 格式化和检查在提交前自动完成，无需手动干预。</li>
<li><strong>确保项目健康：</strong> 从源头杜绝“屎山”的产生，让项目代码库始终保持健康和易于维护。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙零基础语法入门：开启你的开发之旅]]></title>    <link>https://juejin.cn/post/7576057623742464042</link>    <guid>https://juejin.cn/post/7576057623742464042</guid>    <pubDate>2025-11-24T09:19:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623742464042" data-draft-id="7312035320376803354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙零基础语法入门：开启你的开发之旅"/> <meta itemprop="keywords" content="HarmonyOS,Android,前端"/> <meta itemprop="datePublished" content="2025-11-24T09:19:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hqk"/> <meta itemprop="url" content="https://juejin.cn/user/2357827986264942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙零基础语法入门：开启你的开发之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2357827986264942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hqk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:19:52.000Z" title="Mon Nov 24 2025 09:19:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><code>HarmonyOS是新一代的智能终端操作系统，为不同设备的智能化、互联与协同提供了统一的语言，为用户带来简捷，流畅，连续，安全可靠的全场景交互体验。</code></p>
<p>在鸿蒙操作系统的开发中，<strong>掌握基础语法是每位开发者的必修课</strong>。本文将为您详细讲解鸿蒙编程的基础语法，帮助初学者轻松入门，为后续开发打下坚实基础。</p>
<p>OK！话不多说，直接开始！</p>
<p>本文参考于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2Fcourse%2FslightMooc%2FC101717496870909384" target="_blank" title="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384" ref="nofollow noopener noreferrer">华为课程官方文档</a></p>
<h2 data-id="heading-1">1、环境搭建与ArkTs语言介绍</h2>
<h3 data-id="heading-2">1.1 环境搭建</h3>
<p><strong>下载官方编译器</strong></p>
<p>既然要开发鸿蒙程序，那么就需要对应官方编译器【DevEco】 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdownload%2F" target="_blank" title="https://developer.huawei.com/consumer/cn/download/" ref="nofollow noopener noreferrer">点我下载</a>  （面向实名认证开发，需要注册登录华为账号）</p>
<p><strong>安装编译器</strong></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9c36f6f015140a9a47054b2e5eeaa59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580791&amp;x-signature=27HF7dFX5FJzSXwJuySpRe9jS9Q%3D" alt="1.jpg" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li>为了方便后续操作，这里最好是全部勾上，<strong>尤其是【添加bin】选项</strong></li>
</ul>
<p><strong>配置开发SDK</strong></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560f2877c4a04fa6aa814ac86b38e574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580791&amp;x-signature=mo2ZFEQrFPdIRBA9JAagazXlVRo%3D" alt="QQ20250109-145958.jpg" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li><code>Location</code>：配置对应SDK路径</li>
<li><code>API Version xx</code>：对应SDK版本【按需安装即可】</li>
</ul>
<p><strong>开始第一个项目</strong></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/233e3209665e4842aee94b1c6c77dfed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580791&amp;x-signature=sV52sjDru3PEXF%2BiQbqRJ2GKUA8%3D" alt="2.jpg" width="100%" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4584aa192f9a4826a247fe0e3edeb216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580791&amp;x-signature=MMS3dJCgJpmA8Dq5KOSpp4eenc8%3D" alt="3.jpg" width="100%" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li>刚开始选择Empty Ability，然后点击Next就会进入第二个页面</li>
<li>在第二页面中：
<ul>
<li>【Bundle name】：表示该鸿蒙软件唯一标识 ，也就是所谓的包名</li>
<li>【Device type】：表示该项目所支持的设备类型，这也是鸿蒙特色 <strong>一套代码多端使用</strong></li>
<li>点击Next 就会进入下一个页面</li>
</ul>
</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b9a1b3e931472b885402a0fcdcfcc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580791&amp;x-signature=mwm7HyUaucvpWXT8%2FYOy6vYBFY8%3D" alt="4.jpg" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li>
<p>点击左边的【Previewer】 左侧将会出现预览图，当预览出现<code>Hello World</code>时，则说明项目创建成功</p>
</li>
<li>
<p>回到项目右侧，现在介绍下工程目录结构（Stage模型）</p>
<ul>
<li>
<p><strong>AppScope &gt; app.json5</strong>：应用的全局配置信息，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fapp-configuration-file-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/app-configuration-file-V5" ref="nofollow noopener noreferrer">app.json5配置文件</a>。</p>
</li>
<li>
<p><strong>entry</strong>：HarmonyOS工程模块，编译构建生成一个HAP包。</p>
<ul>
<li><strong>src &gt; main &gt; ets</strong>：用于存放ArkTS源码。</li>
<li><strong>src &gt; main &gt; ets &gt; entryability</strong>：应用/服务的入口。</li>
<li><strong>src &gt; main &gt; ets &gt; entrybackupability</strong>：应用提供扩展的备份恢复能力。</li>
<li><strong>src &gt; main &gt; ets &gt; pages</strong>：应用/服务包含的页面。</li>
<li><strong>src &gt; main &gt; resources</strong>：用于存放应用/服务所用到的资源文件，如图形、多媒体、字符串、布局文件等。关于资源文件，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fresource-categories-and-access-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/resource-categories-and-access-V5" ref="nofollow noopener noreferrer">资源分类与访问</a>。</li>
<li><strong>src &gt; main &gt; module.json5</strong>：模块配置文件。主要包含HAP包的配置信息、应用/服务在具体设备上的配置信息以及应用/服务的全局配置信息。具体的配置文件说明，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fmodule-configuration-file-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/module-configuration-file-V5" ref="nofollow noopener noreferrer">module.json5配置文件</a>。</li>
<li><strong>build-profile.json5</strong>：当前的模块信息 、编译信息配置项，包括buildOption、targets配置等。</li>
<li><strong>hvigorfile.ts</strong>：模块级编译构建任务脚本。</li>
<li><strong>obfuscation-rules.txt</strong>：混淆规则文件。混淆开启后，在使用Release模式进行编译时，会对代码进行编译、混淆及压缩处理，保护代码资产。详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fide-build-obfuscation-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-build-obfuscation-V5" ref="nofollow noopener noreferrer">开启代码混淆</a>。</li>
<li><strong>oh-package.json5</strong>：用来描述包名、版本、入口文件（类型声明文件）和依赖项等信息。</li>
</ul>
</li>
<li>
<p><strong>oh_modules</strong>：用于存放三方库依赖信息。</p>
</li>
<li>
<p><strong>build-profile.json5</strong>：工程级配置信息，包括签名signingConfigs、产品配置products等。其中products中可配置当前运行环境，默认为HarmonyOS。</p>
</li>
<li>
<p><strong>hvigorfile.ts</strong>：工程级编译构建任务脚本。</p>
</li>
<li>
<p><strong>oh-package.json5</strong>：主要用来描述全局配置，如：依赖覆盖（overrides）、依赖关系重写（overrideDependencyMap）和参数化配置（parameterFile）等</p>
</li>
</ul>
</li>
</ul>
<p>到这！鸿蒙开发环境已经搭建成功。现在开始介绍ArkTS语言</p>
<h3 data-id="heading-3">1.2 ArkTS语言介绍</h3>
<p>ArkTS是鸿蒙生态的应用开发语言。它在保持TypeScript（简称TS）基本语法风格的基础上，进一步通过规范强化静态检查和分析，使得在程序运行之前的开发期能检测更多错误，提升代码健壮性，并实现更好的运行性能。同时，提供了声明式UI范式、状态管理支持等相应的能力，让开发者可以以更简洁、更自然的方式开发高性能应用</p>
<p>话不多说，直接开始上手吧！</p>
<h2 data-id="heading-4">2、ArkTS语法讲解</h2>
<h3 data-id="heading-5">2.1 ArkTS声明</h3>
<p>ArkTS通过声明引入变量、常量、函数和类型</p>
<h4 data-id="heading-6">2.1.1 变量声明</h4>
<p>以关键字<strong>let开头</strong>的声明引入变量，该变量在程序执行期间可以具有不同的值。</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let hi: string = 'hello';
hi = 'hello, world';
</code></pre>
<h4 data-id="heading-7">2.1.2 常量声明</h4>
<p>以关键字const开头的声明引入只读常量，该常量只能被赋值一次，如果强制重新赋值将会造成编译时错误！</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">const hello: string = 'hello';
</code></pre>
<h4 data-id="heading-8">2.1.3 自动类型推断</h4>
<p>因为ArkTS是一种静态类型语言，因此所有数据类型必须在编译时确定。</p>
<p>但是，如果一个变量或常量的声明包含了初始值，那么开发者就不需要显式指定其类型。ArkTS规范中列举了所有允许自动推断类型的场景。</p>
<p>以下示例中，两条声明语句都是有效的，两个变量都是string类型：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let hi1: string = 'hello';
let hi2 = 'hello, world';
</code></pre>
<h3 data-id="heading-9">2.2 ArkTS基础数据类型</h3>
<h4 data-id="heading-10">2.2.1 number类型</h4>
<p>ArkTS提供number类型</p>
<ul>
<li>number用于表示整数和浮点数</li>
<li>支持大部分的算术运算</li>
<li>数字的范围和行为与JavaScript类似</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let n1 = 3.14;
let n2 = 3.141592;
let n3 = .5;
let n4 = 1e2;

function factorial(n: number): number {
  if (n &lt;= 1) {
    return 1;
  }
  return n * factorial(n - 1);
}

factorial(n1)  //  7.660344000000002 
factorial(n2)  //  7.680640444893748 
factorial(n3)  //  1 
factorial(n4)  //  9.33262154439441e+157 
</code></pre>
<p>注意：<strong>number类型在表示大整数时会造成精度丢失。在开发时可以按需使用BigInt类型来确保精度</strong>：</p>
<p>BigInt示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let bigIntger: BigInt = BigInt('999999999999999999999999999999999999999999999999999999999999');
console.log('bigIntger' + bigIntger.toString());
</code></pre>
<h4 data-id="heading-11">2.2.2 boolean类型</h4>
<ul>
<li>boolean类型由true和false两个逻辑值组成。</li>
<li>通常在条件语句中使用boolean类型的变量：</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let isDone: boolean = false;

if (isDone) {
  console.log ('Done!');
}
</code></pre>
<h4 data-id="heading-12">2.2.3 string类型</h4>
<ul>
<li>
<p>string代表字符序列；可以使用转义字符来表示字符。</p>
</li>
<li>
<p>字符串可以由 单引号 ' 或者 双引号 " 相互包裹零个或多个字符组成。</p>
</li>
<li>
<p>字符串还可以用反向单引号 ` 加上 ${变量} 组合使用</p>
</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let s1 = 'Hello, world!\n';
let s2 = 'this is a string';
let a = 'Success';
let s3 = `The result is ${a}`;
</code></pre>
<h4 data-id="heading-13">2.2.4 void类型</h4>
<ul>
<li>通常用于函数的返回类型，表示该函数不返回任何只</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Class&lt;T&gt; {
  //...
}
let instance: Class &lt;void&gt;
</code></pre>
<h4 data-id="heading-14">2.2.5 null 和 underfined</h4>
<ul>
<li>Null表示一个明确的空值</li>
<li>Undefined 表示一个变量未被赋值或未初始化时的默认状态</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">
let unknownValue: null = null;
let uninitializedValue: undefined = undefined
</code></pre>
<h3 data-id="heading-15">2.3 ArkTS复合数据类型</h3>
<h4 data-id="heading-16">2.3.1 Array（数组）</h4>
<ul>
<li>array 用于存储多个值。可以是同一类型或不同类型的值（根据定义的类型）</li>
<li>支持常见的数组操作，如遍历、索引访问、数组方法等。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let numbers:number[]=[1,2,3,4,5];
let names:string[]=["Alice","Bob","Charlie"];
</code></pre>
<h4 data-id="heading-17">2.3.2 Tuple（元组）</h4>
<ul>
<li>Tuple是一种<strong>固定大小、已知类型的数组</strong>。每个元素可以有不同类型</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let person:[string,number]=["Bob",12];
</code></pre>
<ul>
<li>元组允许存储不同类型的数据，例如：<code>[string,number]</code>代表一个包含字符串和数组的元组</li>
</ul>
<h4 data-id="heading-18">2.3.3 Object（对象）</h4>
<ul>
<li>Object类型是所有引用类型的基类型。</li>
<li>任何值，包括基本类型的值，都可以直接被赋给Object类型的变量（基本类型值会被自动装箱）</li>
<li>Object类型用于表示除基本类型外的类型</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let o1: Object = 'Alice';
let o2: Object = ['a','b'];
let o3: Object = 1;
</code></pre>
<h4 data-id="heading-19">2.3.4 Function（函数类型）</h4>
<ul>
<li>Function类型用于表示函数的类型，可以指定函数的参数类型和返回值类型</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let add: (x: number, y: number) =&gt; number = (x, y) =&gt; x + y;
let greet: (name: string) =&gt; void = (name) =&gt; console.log('hello,'+name);

add(12,23)
greet("Bob")
</code></pre>
<h4 data-id="heading-20">2.3.5 Literal Types（字面量类型）</h4>
<ul>
<li>字面量类型用于表示某个具体的值，而不是值的类型</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let color: "red" | "green" | "blue" = "red"
let status: 1 | 2 | 3 = 2
</code></pre>
<p>在这个示例中，<code>color</code> 就只能是 <code>red</code>、<code>green</code>、<code>red</code>这三者中的其中之一，<code>status</code>同理。</p>
<h4 data-id="heading-21">2.3.6 Enum（枚举）</h4>
<ul>
<li>Enum 是一组有名称的常数值，通常用于表示一组固定的选项或状态</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">enum Direction {
  up = 1,
  down = 2,
  left = 3,
  right = 4
}


let direction = Direction.up

</code></pre>
<h4 data-id="heading-22">2.3.7 Union（联合类型）</h4>
<ul>
<li>Union类型，即联合类型，是由多个类型组合成的引用类型</li>
<li>联合类型包含了变量可能的所有类型</li>
</ul>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let value:string|number="hello"
value=30
// 可以将类型为联合类型的变量赋值为任何组成类型的有效值
</code></pre>
<h4 data-id="heading-23">2.3.8 Aliases（匿名类型）</h4>
<ul>
<li>Aliases类型为匿名类型（如数组、函数、对象字面量或联合类型）提供名称，或为已定义的类型提供替代名称</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">type Matrix = number[][];
const gameBoard: Matrix = [
  [1, 0],
  [0, 1]
];
</code></pre>
<h3 data-id="heading-24">2.4 运算符</h3>
<h4 data-id="heading-25">2.4.1 算术运算符</h4>





































<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>+</code></td><td>加法</td></tr><tr><td><code>-</code></td><td>减法</td></tr><tr><td><code>*</code></td><td>乘法</td></tr><tr><td><code>/</code></td><td>除法</td></tr><tr><td><code>%</code></td><td>取余（模）</td></tr><tr><td><code>++</code></td><td>自增</td></tr><tr><td><code>--</code></td><td>自减</td></tr></tbody></table>
<h4 data-id="heading-26">2.4.2 赋值运算符</h4>
<p>赋值运算符用于<strong>将右边的值赋给左边的变量</strong></p>













<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>=</code></td><td>赋值，使用方式如 <code>x=y</code></td></tr></tbody></table>
<h5 data-id="heading-27">2.4.2.1 复合赋值运算符</h5>
<p>复合赋值运算符将<strong>赋值运算符与运算符组合在一起</strong></p>





















































<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>+=</code></td><td>加赋值，使用方式如 <code>x += y</code>，等价于 <code>x = x + y</code></td></tr><tr><td><code>-=</code></td><td>减赋值，使用方式如 <code>x -= y</code>，等价于 <code>x = x - y</code></td></tr><tr><td><code>*=</code></td><td>乘赋值，使用方式如 <code>x *= y</code>，等价于 <code>x = x * y</code></td></tr><tr><td><code>/=</code></td><td>除赋值，使用方式如 <code>x /= y</code>，等价于 <code>x = x / y</code></td></tr><tr><td><code>%=</code></td><td>取余赋值，使用方式如 <code>x %= y</code>，等价于 <code>x = x % y</code></td></tr><tr><td><code>&lt;&lt;=</code></td><td>左移赋值，示例效果：3 &lt;&lt;= 2 → 12</td></tr><tr><td><code>&gt;&gt;=</code></td><td>右移赋值，示例效果：12 &gt;&gt;= 2 → 3</td></tr><tr><td><code>&gt;&gt;&gt;=</code></td><td>无符号右移赋值，示例效果：-8 &gt;&gt;&gt;= 1 → 大正数</td></tr><tr><td><code>&amp;=</code></td><td>按位与赋值，两位都为1才为1,示例效果：6 &amp;= 3 → 2</td></tr><tr><td><code>|=</code></td><td>按位或赋值，有 1 就 1，示例效果：<code>6 |= 3 → 7</code></td></tr><tr><td><code>^=</code></td><td>按位异或赋值，相同为 0，不同为 1,示例效果：6 ^= 3 → 5</td></tr></tbody></table>
<h4 data-id="heading-28">2.4.3 位运算符</h4>
<p>位运算符用于对整数值进行位级别的操作</p>





































<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>&amp;</code></td><td>按位与（两位都为 1 才为 1）</td></tr><tr><td><code>|</code></td><td>按位或（有 1 即为 1）</td></tr><tr><td><code>^</code></td><td>按位异或（相同为 0，不同为 1）</td></tr><tr><td><code>~</code></td><td>按位非（按位取反，0 变 1，1 变 0）</td></tr><tr><td><code>&lt;&lt;</code></td><td>左移（左移 n 位，相当于乘以 2<sup>n</sup>）</td></tr><tr><td><code>&gt;&gt;</code></td><td>右移（右移 n 位，保留符号位，相当于除以 2<sup>n</sup> 并向下取整）</td></tr><tr><td><code>&gt;&gt;&gt;</code></td><td>无符号右移（右移后高位补 0，不保留符号位）</td></tr></tbody></table>
<h4 data-id="heading-29">2.4.4 比较运算符</h4>
<p>比较运算符用于比较两个值，并返回布尔值（true或false）</p>









































<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>===</code></td><td>如果两个操作数严格相等（对于不同类型的操作数认为是不相等的），则返回true。</td></tr><tr><td><code>!==</code></td><td>如果两个操作数严格不相等（对于不同类型的操作数认为是不相等的），则返回true。</td></tr><tr><td><code>==</code></td><td>如果两个操作数相等，则返回true。</td></tr><tr><td><code>!=</code></td><td>如果两个操作数不相等，则返回true。</td></tr><tr><td><code>&gt;</code></td><td>如果左操作数大于右操作数，则返回true。</td></tr><tr><td><code>&gt;=</code></td><td>如果左操作数大于或等于右操作数，则返回true。</td></tr><tr><td><code>&lt;</code></td><td>如果左操作数小于右操作数，则返回true。</td></tr><tr><td><code>&lt;=</code></td><td>如果左操作数小于或等于右操作数，则返回true。</td></tr></tbody></table>
<h4 data-id="heading-30">2.4.5 逻辑运算符</h4>
<p>逻辑运算符用于处理布尔值的运算</p>





















<table><thead><tr><th>运算符</th><th>说明</th></tr></thead><tbody><tr><td><code>&amp;&amp;</code></td><td>逻辑与（AND）</td></tr><tr><td><code>||</code></td><td>逻辑或 （OR）</td></tr><tr><td><code>!</code></td><td>逻辑非（NOT）</td></tr></tbody></table>
<h4 data-id="heading-31">2.4.6 类型运算符</h4>
<p>类型运算符用于进行类型检查和类型转换</p>















<table><thead><tr><th>运算符</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td><code>instanceof</code></td><td><code>obj instanceof className</code></td><td>如果obj是className类或其子类的实例，则返回值为true；否则，返回值为false</td></tr></tbody></table>
<h3 data-id="heading-32">2.5 表达式</h3>
<h4 data-id="heading-33">2.5.1 if-else 语句</h4>
<ul>
<li>if-else语句根据逻辑条件执行不同的语句场景。当条件为真时，执行为真的语句，否则执行另一组语句</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">if (condition1) {
  //执行满足 condition1为真（即为true） 的语句
} else {
  //执行满足 condition1为真（即为false） 的语句
}
</code></pre>
<h4 data-id="heading-34">2.5.2 switch-case语句</h4>
<ul>
<li>switch-case语句根据不同的case选项，当满足case选项条件时，则执行对应语句</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">
switch (people) {
  case teacher:
    //如果people 是 teacher，则执行这里面语句
    break
  case student:
    //如果people 是 student，则执行这里面语句
    break
  case worker:
    //如果people 是 worker，则执行这里面语句
    break
  default :
    //如果都不满足以上选项，则执行这里面语句
    break
}
</code></pre>
<h4 data-id="heading-35">2.5.3 循环结构</h4>
<p>在 ArkTS 中，循环结构的语法和 TypeScript/JavaScript 基本一致，支持常 见的循环结构如 for 循环、 while 循环和 do-while 循环。下面是对 ArkTS 中各种循环结构的详细介绍。</p>
<h5 data-id="heading-36">2.5.3.1 for循环</h5>
<p>for 循环是最常见的循环结构，适用于已知循环次数或需要通过计数器控 制的情况</p>
<p><strong>语法</strong></p>
<pre><code class="hljs language-scss" lang="scss">for (initialization; condition; increment) { 

<span class="hljs-comment">// 循环体 </span>

}

</code></pre>
<p>示例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">// 从 0 到 4 打印数字
for (let i = 0; i &lt; 5; i++) {
  console.log(i.toString());
}
</code></pre>
<ul>
<li><code>initialization</code>，也就是示例中<code>let i = 0</code>：初始化表达式，通常用于定义和初始化计数器</li>
<li><code>condition</code>，也就是示例中<code> i &lt; 5</code>：循环的条件表达式，只有当条件为 续执行。 true 时，循环才会继续执行</li>
<li><code>increment</code>，也就是示例中<code>i++</code>：每次循环结束时执行的增量表达式，通常用于更新计数器。</li>
</ul>
<h5 data-id="heading-37">2.5.3.2 for...of循环</h5>
<ul>
<li><code>for...of</code> 循环用于遍历可迭代对象（如数组、字符串、Map、Set 等）的 值。它不会返回索引或键，而是直接返回集合中的元素。</li>
</ul>
<p>示例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let numbers=[10,202,30]
for (let index of numbers){
  console.log(index.toString())
}
</code></pre>
<h5 data-id="heading-38">2.5.3.3 while循环</h5>
<ul>
<li><code>while</code> 循环用于在给定条件为 <code>true</code>的情况下重复执行循环体。条件表达式在每次迭代前都会检查</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let count = 0;
while (count &lt; 5) {
  console.log(count.toString());
  count++;  // 更新计数器
}
</code></pre>
<h5 data-id="heading-39">2.5.3.4 do...while循环</h5>
<ul>
<li><code>do...while</code>循环与<code>while</code>循环类似，不同之处在于  <code>do...while</code>循环会<strong>至少执行一次（即使不满足条件）</strong>，因为条件是循环体执行后再判断的。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let count = 0;
do {
  console.log(count.toString());
  count++;  // 更新计数器
} while (count &lt; 5);
</code></pre>
<p><strong>注意</strong>：当我们使用循环时，一定要有合适的契机结束循环，否则就会造成死循环，要么循环条件为false，要么使用break语句</p>
<h5 data-id="heading-40">2.5.3.5  break语句</h5>
<p><code>break</code>语句用于立即退出循环。当满足某个条件时，可以使用<code>break</code>提前终止循环</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let count = 0;
do {
  if (count==5) {
    break
  }
  console.log(count.toString());
  count++;  // 更新计数器
} while (count &lt; 10);
</code></pre>
<h5 data-id="heading-41">2.5.3.6 continue语句</h5>
<p><code>continue</code> 语句用于跳过当前循环的剩余部分，直接进入下一次循环的判断条件部分。</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let count = 0;
do {
  count++;  // 更新计数器
  if (count===6) {
    continue
  }
  console.log(count.toString());
} while (count &lt; 10);

</code></pre>
<p>在这个例子中 当<code>count</code>等于6时，<code>continue</code>语句会跳过<code>console.log(count.toString());</code>语句及之后的执行，直接进入下一次循环。</p>
<h5 data-id="heading-42">2.5.3.7 循环结构总结</h5>
<p>在<strong>ArkTS</strong>中，常见的循环结构包括：</p>
<ol>
<li><code>for</code>循环：用于已知次数的循环</li>
<li><code>for...or</code>循环：用于遍历可迭代对象的元素</li>
<li><code>while</code>循环：根据条件重复执行循环体</li>
<li><code>do...while</code>循环：至少执行一次循环，之后根据条件判断是否继续</li>
<li><code>break</code>语句：提前退出循环</li>
<li><code>continue</code>语句：跳过当前循环剩余部分，直接进入下一次循环</li>
</ol>
<p>这些循环结构都可以帮助你在 ArkTS 中处理各种需要重复执行的任务，根 据具体需求选择适合的循环类型。</p>
<h3 data-id="heading-43">2.6 函数</h3>
<p>在 <strong>ArkTS</strong>  中，函数的定义和使用与 TypeScript 大体相同，但由于它是专门为鸿蒙系统（HarmonyOS）设计的，可能会有一些特有的扩展。下面我将展示一些常见的 ArkTS 函数使用方法，帮助你更好地理解如何在 ArkTS 中创建和使用函数。</p>
<h4 data-id="heading-44">2.6.1 函数的定义</h4>
<p>在 <strong>ArkTS</strong> 中，定义函数的语法与 TypeScript 类似，可以通过<code>function</code>关键字定义普通函数，也可以使用箭头函数。</p>
<h5 data-id="heading-45">2.6.1.1 普通函数定义</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function greet1(name:string):string{
  return `Hello,${name}!`
}

console.log(greet1("ArkTS"))
</code></pre>
<ul>
<li>函数声明引入一个函数，包含其名称、参数列表、返回类型和函数体</li>
<li>参数类型标注：<code>name:string</code> 显式声明参数类型为字符串类型</li>
<li>返回值类型：<code>string</code>指定函数返回值为字符串类型</li>
</ul>
<h5 data-id="heading-46">2.6.1.2 箭头函数定义（Lambda函数）</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">const greet2 = (name: string): string =&gt; {
  return `Hello,${name}!`
}

console.log(greet2("hqk"))



let sum=(x:number,y:number):number=&gt;{
  return x+y
}
let sum1=(x:number,y:number)=&gt;{
  return x+y
}
let sum2=(x:number,y:number)=&gt;x+y

console.log("sum="+sum(1,2))     //输出3
console.log("sum1="+sum1(1,2))   //输出3
console.log("sum2="+sum2(1,2))   //输出3

</code></pre>
<p>注意看sum/sum1/sum2 函数定义有细微差别</p>
<ul>
<li>箭头函数在没有指定返回类型时，会根据返回的表达式自动推断类型</li>
<li>带函数体 <code>{}</code> 的箭头函数（需要写 显式 return）</li>
<li>只有表达式的箭头函数（不需要写 隐式 return）</li>
</ul>
<p>因此 sum/sum1/sum2输出都为3</p>
<p>那么现在来个实战</p>
<p><strong>按钮点击事件</strong></p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">Button('').onClick(()=&gt;{})
</code></pre>
<p>这里面就用到了Lambda函数，相信看了sum/sum1/sum2 函数定义差别，你能看懂这个按钮点击事件案例</p>
<h4 data-id="heading-47">2.6.2 函数的参数和返回类型</h4>
<ul>
<li>和 TypeScript 一样，在 <code>ArkTS</code> 中你可以指定函数的参数和返回值类型，确保类型的安全</li>
</ul>
<h5 data-id="heading-48">2.6.2.1 带参数类型和返回类型的函数</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function addNumber(a:number,b:number):string{
  return (a+b).toString()
}

console.log(`add=${addNumber(1,2)}`)

</code></pre>
<h5 data-id="heading-49">2.6.2.2 可选参数</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function greet1(name: string,age?:number): string {
  if (age) {
    return `Hello,${name}! You are ${age} years old.`
  }

  return `Hello,${name}!`
}


console.log(`greet1-&gt;${greet1("Bob")}`) //greet1-&gt;Hello,Bob!

console.log(`greet1-&gt;${greet1("Alice",24)}`)//greet1-&gt;Hello,Alice! You are 24 years old.

</code></pre>
<h5 data-id="heading-50">2.6.2.3 默认参数</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function greet1(name: string,age:number=18): string {
  return `Hello,${name}! You are ${age} years old.`
}

console.log(`greet1-&gt;${greet1("Bob")}`) //greet1-&gt;Hello,Bob! You are 18 years old.

console.log(`greet1-&gt;${greet1("Alice",24)}`)//greet1-&gt;Hello,Alice! You are 24 years old.
</code></pre>
<h5 data-id="heading-51">2.6.2.4 可变参数（Rest参数）</h5>
<ul>
<li><strong>函数的最后一个参数可以是rest参数</strong>。使用rest参数时，允许函数或方法接受任意数量的实参</li>
</ul>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function sumNumber(...numbers: number[]): number {
  let res = 0
  for (let item of numbers) {
    res += item
  }
  return res
}


console.log(`sum1-&gt;${sumNumber()}`) //sum1-&gt;0
console.log(`sum2-&gt;${sumNumber(1, 2, 3, 4, 5, 6, 7)}`) //sum2-&gt;28

</code></pre>
<h4 data-id="heading-52">2.6.3 异步函数（Async/Await）</h4>
<ul>
<li><code>ArkTS</code> 支持异步编程，可以通过 <code>async</code> 和 <code>await</code> 来处理异步操作</li>
</ul>
<h5 data-id="heading-53">2.6.3.1 异步函数定义和调用</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">
import fs from '@ohos.file.fs'; //这里引入系统组件并命名为：fs

/**
 * 打开文件:fs:系统提供的用于打开文件的一个组件
 * 异步方法
 */
async function openFile(fileName: string) {
  let file = await fs.open(fileName, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE)
  return file
}

function getData() {
  openFile("userInfo.txt").then((data: fs.File) =&gt; {
    console.log(data.name)
  })
}
</code></pre>
<p>在这个例子中:</p>
<ul>
<li><code>openFile</code>是一个异步函数（<code>async</code>），使用<code>await</code>等待文件打开完成并返回结果</li>
<li><code>openFile</code>我这故意没有写返回值，但却有 <code>return file</code>,这里和上面<code>sum/sum1/sum2</code>例子一样，它会根据方法体自动推断方法返回类型为：<code>Promise&lt;fs.File&gt;</code></li>
</ul>
<h4 data-id="heading-54">2.6.4 回调函数</h4>
<ul>
<li>你也可以在 ArkTS 中<strong>传递回调函数作为参数</strong>，尤其在 UI 交互中比较常见</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function performAction(actionNumber: (a: number, b: number) =&gt; number) {
  console.log("Action started.")
  console.log(`Action run-&gt;${actionNumber(10, 20)}`)
  console.log("Action completed.")
}


performAction((a, b) =&gt; {
  console.log("Action 执行a*b逻辑");
  return a * b;
});



performAction((a, b) =&gt; {
  console.log("Action 执行a+b逻辑");
  return a + b;
});

</code></pre>
<p>输出内容：</p>
<pre><code class="hljs language-css" lang="css">   Action started.
   Action 执行<span class="hljs-selector-tag">a</span>*<span class="hljs-selector-tag">b</span>逻辑
   Action run-&gt;<span class="hljs-number">200</span>
   Action completed.
   Action started.
   Action 执行<span class="hljs-selector-tag">a</span>+<span class="hljs-selector-tag">b</span>逻辑
   Action run-&gt;<span class="hljs-number">30</span>
   Action completed.
</code></pre>
<p>在这个例子中：</p>
<ul>
<li>在 <code>performAction</code>方法里，<code>actionNumber</code>参数作为未实现的函数/回调函数，（只确定了参数和返回类型）</li>
<li>而在调用 <code>performAction</code>方法的时候，需要实现<code>actionNumber</code>方法的内容</li>
</ul>
<h4 data-id="heading-55">2.6.5 高阶函数</h4>
<ul>
<li>高阶函数是指<strong>接受一个或多个函数作为参数，或者返回一个函数的函数</strong>。 ArkTS 支持高阶函数</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">// 高阶函数：接收两个函数，返回一个新函数
function combineActions(
  action1: (x: number) =&gt; number,
  action2: (y: number) =&gt; number
) {
  // 返回一个新的函数
  return (value: number): number =&gt; {
    console.log("执行 action1...");
    const r1 = action1(value);

    console.log("执行 action2...");
    const r2 = action2(r1);

    return r2;
  };
}

// 定义两个普通箭头函数
let add10 = (num: number) =&gt; num + 10;
let multiply2 = (num: number) =&gt; num * 2;

// 调用高阶函数，得到一个“组合函数”
let combined = combineActions(add10, multiply2);

// 使用返回的函数
console.log("最终结果：" + combined(5));
</code></pre>
<p>输出内容</p>
<pre><code class="hljs language-erlang" lang="erlang">执行 action1...
执行 action2...
最终结果：<span class="hljs-number">30</span>
</code></pre>
<p>在这个例子中</p>
<ul>
<li>高阶函数能把“行为”当成参数传递，使逻辑更灵活、更复用、更易扩展。</li>
</ul>
<h4 data-id="heading-56">2.6.6 函数重载</h4>
<p>与 TypeScript 相同，<code>ArkTS</code> 也支持函数重载。你可以定义多个具有不同参 数列表的函数，但是要注意，<strong>重载必须根据参数类型或数量来区分</strong></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">//函数重载
function greet(name: string): string;
function greet(name: string, age: number): string;
function greet(name: string, age?: number): string {
  if (age !== undefined) {
    return `Hello, ${name}! You are ${age} yearsold.`;
  } else {
    return `Hello, ${name}!`;
  }
}
console.log(greet('Ali')) //Hello, Ali!
console.log(greet('Bob',20))//Hello, Bob! You are 20 yearsold.
console.log(greet('hqk', 30))//Hello, hqk! You are 30 yearsold.
</code></pre>
<h3 data-id="heading-57">2.7 类与对象</h3>
<h4 data-id="heading-58">2.7.1 类声明</h4>
<p>类声明引入一个新类型，并定义其字段、方法和构造函数</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">export class Person {
  name: string = ''
  surName: string = ''

  constructor(name: string, surName: string) {
    this.name = name
    this.surName = surName
  }

  fullName(): string {
    return `${this.name} ${this.surName}`
  }
}

</code></pre>
<p>定义类后，可以使用关键字new创建实例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { Person} from '../utils/code'
let p=new Person('John','Smith')
console.log(p.fullName()) //John Smith
</code></pre>
<h4 data-id="heading-59">2.7.2 字段</h4>
<p>字段是直接在类中声明的某种类型的变量。 类可以具有实例字段或者静态字段。</p>
<h5 data-id="heading-60">2.7.2.1 实例字段</h5>
<p>实例字段存在于类的每个实例上。每个实例都有自己的实例字段集合。 要访问实例字段，需要使用类的实例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person1 {
  name: string = ''
  age:number=0

  constructor(name: string, age: number) {
    this.name = name
    this.age = age
  }

  public getName(): string {
    return this.name
  }
}


let p1 = new Person1("Alice", 25)
p1.name

let p2 = new Person1("Bob", 28)
p2.name
</code></pre>
<h5 data-id="heading-61">2.7.2.2 静态字段</h5>
<p>使用关键字<code>static</code>将字段声明为静态。静态字段属于类本身，类的所有实例共享一个静态字段</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person1 {
  name: string = ''
  age:number=0

  static numberOfPersons = 0

  constructor(name: string, age: number) {
    this.name = name
    this.age = age
    Person1.numberOfPersons++
  }

  public getName(): string {
    return this.name
  }
}

let p1 = new Person1("Alice", 25)

let p2 = new Person1("Bob", 28)

console.log(`number-&gt;${Person1.numberOfPersons}`)

</code></pre>
<p>在这个例子中：</p>
<ul>
<li>要访问静态字段，需要使用类名</li>
</ul>
<h5 data-id="heading-62">2.7.2.3 字段初始化</h5>
<p><code>ArkTS</code>要求所有字段在<strong>声明时或者构造函数中显式初始化</strong>。这和标准TS中的 strictPropertyInitialization模式一样。</p>
<p>以下示例是在<code>ArkTS</code>中不合法的代码</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS"> class Person2{
  name:string  

  setName(name:string):void{
    this.name=name
  }

  getName():string{
    return this.name
  }
}
</code></pre>
<p>如果你这样写，编译器直接提示：<code>Property 'name' has no initializer and is not definitely assigned in the constructor. &lt;ArkTSCheck&gt;</code> ，<strong>要么定义时赋值，要么构造器方法赋值</strong></p>
<h5 data-id="heading-63">2.7.2.4 getter和setter</h5>
<p>setter和getter可用于提供对对象属性的受控访问</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person2{
  name:string=''
  private _age: number = 0

  public set age(value: number) {
    if (value&lt;0) {
      throw Error('Invalid age argument')
    }
    this._age = value
  }

  public get age(): number {
    return this._age
  }

}


let p=new Person2()
console.log(`age=${p.age}`) //age=0 
p.age=-10 // 设置无效age值会抛出错误

</code></pre>
<p>在这个例子中：</p>
<ul>
<li>在类中可以定义getter或者setter</li>
<li>setter用于禁止将age属性设置为无效值</li>
</ul>
<h4 data-id="heading-64">2.7.3 方法</h4>
<p>方法属于类。类可以定义实例方法或者静态方法。静态方法属于类本身，只能访问静态字段。而实例方法既可以访问静态字段，也可以访问实例字段， 包括类的私有字段。</p>
<h5 data-id="heading-65">2.7.3.1 实例方法</h5>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class RectangleSize{
  private height:number=0
  private width:number=0

  constructor(height: number, width: number) {
    this.height = height
    this.width = width
  }

  calculateArea():number{
    return this.height*this.width
  }
}


let square=new RectangleSize(10,10)
console.log(`square=&gt;${square.calculateArea()}`) //输出 square=&gt;100

</code></pre>
<p>在这个例子中：</p>
<ul>
<li><code>calculateArea</code>方法通过将高度乘以宽度来计算矩形的面积</li>
<li>必须通过类的实例调用实例方法</li>
</ul>
<h5 data-id="heading-66">2.7.3.2 静态方法</h5>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C1{
  aa:string=''
  
  static a:number=10
  
  static staticMethod():string{
    return `this is a static method. ${C1.a}`
  }
}

console.log(C1.staticMethod())
</code></pre>
<p>在这个例子中：</p>
<ul>
<li>使用<code>static</code>将方法声明为静态。静态方法属于类本身，只能访问静态字段</li>
<li>静态方法定义了类作为一个整体的公共行为</li>
<li>必须通过类名调用静态方法</li>
</ul>
<h5 data-id="heading-67">2.7.3.3 继承</h5>
<p>一个类可以继承另一个类（称为基类）</p>
<p>语法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> [<span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseClassName</span>]{ 
<span class="hljs-comment">// ... </span>

}

</code></pre>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">export class Employee{
  //属性
  name: string = ''
  private sex: string = ''
  hiredate: Date | null = null
  sal: number = 0
  comm: number = 100
  // 构造方法
  constructor(name: string, sex: string, hiredate: Date, sal: number) {
    this.name = name
    this.sex = sex
    this.hiredate = hiredate
    this.sal = sal
  }
  work(){
    let name = 'hello'
    console.log(`${name},${this.name}:正在努力工作。。。`)
  }
  getSalary(){
    console.log(`${this.name}:正在领取工资`)
  }

}

/*
程序员类
*
 */
export class Programmer extends Employee{

  getSalary(): void {
   //重写父类方法
  }
}


import { Employee, President, Programmer } from '../utils/code1';


const e1 = new Programmer('jett', '男', new Date('2024-1-22'), 8000)
e1.work()  // 打印  hello,jett:正在努力工作。。。
e1.getSalary() //没有任何打印


</code></pre>
<ul>
<li>继承类继承基类的字段和方法，<strong>但不能继承构造函数（子类如果没有写构造函数，ArkTS会默认生成了 constructor 来调用 super）。</strong></li>
<li>继承类可以新增定义字段和方法，也可以覆盖其基类定义的方法</li>
<li>基类也称为“父类”或“超类”。继承类也称为“派生类”或“子类”</li>
</ul>
<h5 data-id="heading-68">2.7.3.4 实现</h5>
<p>一个类可以实现多个接口</p>
<p>语法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> [<span class="hljs-keyword">implements</span> <span class="hljs-title">listOfInterfaces</span>] </span>{ 
<span class="hljs-comment">// ... </span>

}

</code></pre>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface DateInterface {
  now(): string
}

export class MyDate implements DateInterface {
  now(): string {
    return 'now is now'
  }
}
</code></pre>
<p>在这个示例中：</p>
<ul>
<li>包含<code>implements</code>子句的类必须实现列出的接口中定义的所有方法</li>
</ul>
<h5 data-id="heading-69">2.7.3.5 父类访问</h5>
<p>关键字<code>super</code>可用于访问父类的实例字段、实例方法和构造函数。在实现子类功能时，可以通过该关键字从父类中获取所需接口</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class RectangleSize {
  protected  height: number = 0
  private width: number = 0

  constructor(height: number, width: number) {
    this.height = height
    this.width = width
  }

  calculateArea(): number {
    return this.height * this.width
  }

  /**
   * 绘制
   */
  draw() {
  }
}

class FilledRectangle extends RectangleSize {
  color = ''

  constructor(height: number, width: number, c: string) {
    super(height, width) //父类构造函数调用
    this.color = c
  }

  override draw(): void {
    super.draw() //父类方法调用
    super.height//调用父类属性
    //
  }
}
</code></pre>
<h5 data-id="heading-70">2.7.3.6 方法重写</h5>
<p>子类可以重写其父类中定义的方法的实现。重写的方法可以用关键字 override标记，以提高可读性。重写的方法必须具有与原始方法相同的参数 类型和相同或派生的返回类型</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class RectangleSize {
   //....
   
  area(): number {
    return 0
  }
}

class Square extends RectangleSize {
  private side: number = 5

  override area(): number {
    return this.side * this.side
  }
}
</code></pre>
<h5 data-id="heading-71">2.7.3.7 方法重载</h5>
<p>通过重载签名，指定方法的不同调用。具体方法为：<strong>同一个方法写入多个同名但签名不同的方法头，方法实现紧随其后。</strong></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C{
  foo(x:number):void  //第一个签名
  foo(x:string):void  //第二个签名
  foo(x:number|string):void{ //实现签名
    
  }
}
let c=new C()
c.foo(100)   //使用第一个签名
c.foo("aaa") //使用第二个签名
</code></pre>
<h4 data-id="heading-72">2.7.4 构造函数</h4>
<p>类声明可以包含用于初始化对象状态的构造函数</p>
<p>语法如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">constructor</span> ([parameters]) { 
<span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>如果未定义构造函数，则会自动创建具有空参数列表的默认构造函数</strong>，例如：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Point {
  x: number = 0
  y: number = 0
}

let p = new Point()
p.x
p.y
</code></pre>
<p>在这种情况下，默认构造函数使用字段类型的默认值来初始化实例中的字段</p>
<h5 data-id="heading-73">2.7.4.1 派生类的构造函数</h5>
<p>构造函数函数体的第一条语句可以使用关键字super来显式调用直接父类的构造函数</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class RectangleSize {
  protected height: number = 0
  private width: number = 0
  constructor(height: number, width: number) {
    this.height = height
    this.width = width
  }
}

class Square extends RectangleSize {
  private side: number = 5
  constructor(side: number) {
    super(side, side)// 使用关键字super
    this.side = side
  }

}
</code></pre>
<h5 data-id="heading-74">2.7.4.2 构造函数重载</h5>
<p>我们可以通过编写重载签名，指定构造函数的不同调用方式。具体方法为， <strong>同一个构造函数写入多个同名但签名不同的构造函数头，构造函数实现紧随其后</strong> （和上面方法重载类似）</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C {
  constructor(x:number)
  constructor(x:string)
  constructor(x:number|string) {

  }
}

let c = new C(10)
let c1=new C("aaa")
</code></pre>
<h4 data-id="heading-75">2.7.5 修饰符</h4>
<p>类的方法和属性都可以使用可见性修饰符</p>
<p>可见性修饰符包括：<code>private</code>、<code>protected</code>、<code>public</code>。默认修饰符为：<code>public</code></p>
<h5 data-id="heading-76">2.7.5.1 public与private</h5>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C{
  public x:string=''
  private y: string = ''

  public set_y(value: string) {
    this.y = value // y在类本身可以访问
  }
}
let c=new C()
c.x='asdf' //OK，该字段是公有的
c.y='bbb'  //编译时错误，该字段是私有不可见的
</code></pre>
<p>在这个示例中：</p>
<ul>
<li><code>public</code> （默认：公有）修饰的类成员（字段、方法、构造函数）在程序的任何可访问该类的地方都是可见的</li>
<li><code>private</code>（私有）修饰的成员不能在声明该成员的类之外访问</li>
</ul>
<h5 data-id="heading-77">2.7.5.2 protected</h5>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Base{
  protected x:string=''
  private y:string=''
  z:string=''
}

class Derived extends Base{
  foo(){
    this.x='a' //OK，该字段是protected（受保护的），允许在子类使用
    this.y='b' //编译时错误，该字段是私有不可见的
  }
}

let d=new Derived()
d.z  //OK，该字段是公有的
d.x  //编译时错误，该字段是protected（受保护的）
</code></pre>
<p>在这个示例中</p>
<ul>
<li><code>protected</code>修饰符的作用于<code>private</code>修饰符非常相似，不同点是<code>protected</code>修饰符的成员允许在派生类访问</li>
</ul>
<h4 data-id="heading-78">2.7.6 对象字面量</h4>
<p>对象字面量是一个表达式，可用于创建类实例并提供一些初始值。它在某些情况下更方便，可以用来代替new表达式。</p>
<p>对象字面量的表示方式是：<strong>封闭在花括号对({})中的'属性名：值'的列表</strong></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C{
  n:number=0
  s:string=''
}

function foo(c:C){}

let c:C={n:42,s:'foo'}   //使用变量的类型


foo({n:42,s:'foo'})//使用参数的类型

function bar():C{
  return {n:42,s:'foo'} //使用返回类型
}
</code></pre>
<p>在这个例子中：</p>
<ul>
<li>对象字面量只能在可以推导出该字面量类型的上下文中使用</li>
</ul>
<p>也可以在数组元素类型或类字段类型中使用：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C{
  n:number=0
  s:string=''
}

let cc:C[]=[{n:1,s:'a'},{n:2,s:'b'}]
</code></pre>
<h5 data-id="heading-79">2.7.6.1 Record类型的对象字面量</h5>
<p>泛型Record&lt;K,V&gt;用于将类型（键类型）的属性映射到另一个类型（值类型）。常用对象字面量来初始化该类型的值</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let map: Record&lt;string, number&gt; = { 'John': 25, "Mary": 21 }

map['John']   //25
</code></pre>
<p><strong>类型K可以是字符串类型或数值类型，而V可以是任意类型</strong></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface PersonInfo {
  age: number
  salary: number
}

let map:Record&lt;string,PersonInfo&gt;={
  'John':{age:25,salary:10},
  "Mary":{age:21,salary:20}
}
</code></pre>
<h4 data-id="heading-80">2.7.7 接口</h4>
<p>上面的很多示例都用到接口，这里再统一讲解下</p>
<h5 data-id="heading-81">2.7.7.1 接口声明</h5>
<p>任何一个类的实例只要实现了特定接口，就可以通过该接口实现多态。</p>
<p>接口通常包含属性和方法声明</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style{
  color:string //属性
}

interface AreaSize{
  calculateAreaSize():number //方法的声明
  someMethod():void //方法的声明
}
</code></pre>
<p>实现接口示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface AreaSize{
  calculateAreaSize():number //方法的声明
  someMethod():void //方法的声明
}

class RectangleSize2 implements AreaSize{
  private width:number=0
  private height:number=0
  
  calculateAreaSize(): number {
    this.someMethod()
    return this.width*this.height
  }

  someMethod(): void {
    console.log('someMethod called')
  }
}
</code></pre>
<h5 data-id="heading-82">2.7.7.2 接口属性</h5>
<p>接口属性可以是字段、getter、setter或getter和setter组合的形式。</p>
<p>属性字段只是getter/setter对的便捷写法。以下表达方式是等价的（示例一、示例二）：</p>
<p>示例一：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style {
  color: string;
}

</code></pre>
<p>示例二：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style {
  get color(): string;
  set color(x: string);
}
</code></pre>
<p>实现接口的类也可以使用以下两种方式（示例三、示例四）：</p>
<p>示例三：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style {
  color: string;
}

class StyledRectangle implements Style {
  color: string = '';
}
</code></pre>
<p>示例四</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style {
  color: string;
}

class StyledRectangle implements Style {
  private _color: string = '';
  get color(): string { return this._color; }
  set color(x: string) { this._color = x; }
}
</code></pre>
<h5 data-id="heading-83">2.7.7.3 接口继承</h5>
<p>接口可以继承其他接口</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Style {
  color: string;
}

interface ExtendedStyle extends Style {
  width: number;
}
</code></pre>
<p>继承接口包含被继承接口的所有属性和方法，还可以添加自己的属性和方法</p>
<h4 data-id="heading-84">2.7.8 泛型</h4>
<p>泛型类型和函数允许创建的代码在各种类型上运行，而不仅支持单一类型</p>
<h5 data-id="heading-85">2.7.8.1 泛型类和接口</h5>
<p>类和接口可以定义为泛型，将参数添加到类型定义中。如以下示例中的类型参数Element:</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class CustomStack&lt;Element&gt; {
  public push(e: Element):void {
    // ...
  }
}
</code></pre>
<p>要使用类型CustomStack，必须为每个类型参数指定类型实参：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let s = new CustomStack&lt;string&gt;();
s.push('hello');
</code></pre>
<p>编译器在使用泛型类型和函数时会确保类型安全。参见以下示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let s = new CustomStack&lt;string&gt;();
s.push(55); // 将会产生编译时错误
</code></pre>
<h5 data-id="heading-86">2.7.8.2 泛型约束</h5>
<p>泛型类型的类型参数可以绑定。例如，HashMap&lt;Key,Value&gt;容器中的Key 类型参数必须具有哈希方法，即它应该是可哈希的</p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">interface Hashable {
  hash(): number;
}
class MyHashMap&lt;Key extends Hashable, Value&gt; {
  public set(k: Key, v: Value) {
    let h = k.hash();
    // ...其他代码...
  }
}
</code></pre>
<p>在这个例子中：</p>
<ul>
<li>key类型扩展了Hashable，Hashable接口的所有方法都可以被key调用</li>
</ul>
<h5 data-id="heading-87">2.7.8.3 泛型函数</h5>
<p>使用泛型函数可编写更通透的代码。</p>
<p>比如返回数组的最后一个元素的函数：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function last(x:number[]):number{
  return x[x.length-1]
}

last([1,2,3])  //3
</code></pre>
<p>如果需要为任何数组定义相同的函数，使用类型参数讲函数定义为泛型：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">function last&lt;T&gt;(x:T[]):T{
  return x[x.length-1]
}

//显示设置类型实参
last&lt;string&gt;(['aa','bb'])
last&lt;number&gt;([1,2,3])

//隐式设置类型实参
last([1,2,3])  //3
last(['a','b','c'])
</code></pre>
<p>在这个例子中：</p>
<ul>
<li>在函数调用中，类型实参可以显式或隐式设置</li>
</ul>
<h5 data-id="heading-88">2.7.8.4 泛型默认值</h5>
<p>泛型类型的类型参数可以设置默认值。这样可以不指定实际的类型实参，而只使用泛型类型名称</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class SomeType{

}

interface Interface&lt;T1=SomeType&gt;{

}
class Base&lt;T2=SomeType&gt;{}

class Derived1 extends Base implements Interface{}
//这里 Derived1与Derived2等价
class Derived2 extends Base&lt;SomeType&gt; implements Interface&lt;SomeType&gt;{}

function food&lt;T=number&gt;(): void{}

food() //number
//此函数在语义上等价下面函数调用
food&lt;number&gt;()

//这里自定义泛型为string类型
food&lt;string&gt;()
</code></pre>
<p>在这个示例中：</p>
<ul>
<li><code>Interface</code> 与 <code>Base</code>对应泛型默认值为<code>SomeType</code>类型，因此<code>Derived1</code>等价于<code>Derived2</code></li>
<li>方法<code>food</code>对应泛型默认为<code>number</code>类型，因此<code>food()</code> 等价于 <code>food&lt;number&gt;()</code></li>
</ul>
<p>如果说 <strong>泛型每次使用时都必须显式指定类型</strong> 以及 <strong>泛型没有“天然的主流类型”</strong> ，那就没有必要使用泛型默认值</p>
<h4 data-id="heading-89">2.7.9 空安全、非空断言运算符、空值合并运算符、可选链</h4>
<h5 data-id="heading-90">2.7.9.1 空安全</h5>
<p>默认情况下，ArkTS中的所有类型都不允许为空，这类似于TypeScript的(strictNullChecks)模式，但规则更严格。</p>
<p>在下面的示例中，所有行都会导致编译时错误：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let x: number = null;    // 编译时错误
let y: string = null;    // 编译时错误
let z: number[] = null;  // 编译时错误
</code></pre>
<p>可以为空值的变量定义为联合类型T|null</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">let x:number|null=null
x=1
x=null
if (x!=null){
  //do something
}
</code></pre>
<h5 data-id="heading-91">2.7.9.2 非空断言运算符</h5>
<p>后缀运算符<code>!</code>可用于断言其操作数为非空。</p>
<p>应用于空值时，运算符将抛出错误。否则，值的类型将从<code>T | null</code>更改为<code>T</code></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class C {
  value: number | null = 1
}

let c1=new C()
let y:number
y=c1.value+1   //编译错误：无法对可空值做加法
y=c1.value!+1  //ok，值为2
</code></pre>
<h5 data-id="heading-92">2.7.9.3 空值合并运算符</h5>
<p>空值合并二元运算符<code>??</code>用于检查左侧表达式的求值是否等于null或者undefined。如果是，则表达式的结果为右侧表达式；否则，结果为左侧表达式。</p>
<p>换句话说，<strong>a ?? b等价于三元运算符(a != null &amp;&amp; a != undefined) ? a : b。</strong></p>
<p>在以下示例中，getNick方法返回已设置的昵称。如果未设置，则返回空字符串。</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person3 {
  nick: string | null = null

  getNick(): string {
    return this.nick ?? ''
  }
}
</code></pre>
<h5 data-id="heading-93">2.7.9.4 可选链</h5>
<p>在访问对象属性时，<strong>如果该属性是undefined或者null，可选链运算符会返回undefined</strong></p>
<p>示例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person3 {
  nick: string | null = null;
  spouse?: Person3

  setSpouse(spouse: Person3): void {
    this.spouse = spouse;
  }

  getSpouseNick(): string | null | undefined {
    return this.spouse?.nick;
  }

  constructor(nick: string) {
    this.nick = nick;
    this.spouse = undefined;
  }
}
</code></pre>
<p>在这个示例中：</p>
<ul>
<li><code>getSpouseNick</code>的返回类型必须为<code>string | null | undefined</code>，因为该方法可能返回<code>null</code>或者<code>undefined</code></li>
<li>可选链可以任意长，可以包含任意数量的<code>?.</code>运算符</li>
</ul>
<p>在以下示例中，如果Person实例的spouse属性不为空，并且spouse的nick属性也不为空时，输出spouse.nick。否则，输出undefined</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">class Person {
  nick: string | null = null;
  spouse?: Person;

  constructor(nick: string) {
    this.nick = nick;
    this.spouse = undefined;
  }
}

let p: Person = new Person('Alice');
p.spouse?.nick; // undefined
</code></pre>
<h3 data-id="heading-94">3、结束语</h3>
<p>好了，HarmonyOS零基础语法到这就结束了，看到这里的小伙伴恭喜你掌握了ArkTS语法。后期我会持续更新该系列文章。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Docker Swarm 到 Kubernetes：微服务项目全面集群化升级实战]]></title>    <link>https://juejin.cn/post/7576057623742480426</link>    <guid>https://juejin.cn/post/7576057623742480426</guid>    <pubDate>2025-11-24T09:28:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623742480426" data-draft-id="7576026767371894803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Docker Swarm 到 Kubernetes：微服务项目全面集群化升级实战"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-24T09:28:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Docker Swarm 到 Kubernetes：微服务项目全面集群化升级实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:28:32.000Z" title="Mon Nov 24 2025 09:28:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构演进的道路上，我们从单机 Docker Compose 起步，经历了 Docker Swarm 的集群化改造，现在将迈入更加强大的 Kubernetes 生态系统。本文基于您提供的实际项目环境（包括之前遇到的权限问题），详细讲解如何将 RocketMQ 微服务项目从 Docker Swarm 无缝升级到生产级的 Kubernetes 集群部署。</p>
<h2 data-id="heading-0">一、Kubernetes 与 Docker Swarm 架构对比</h2>
<h3 data-id="heading-1">1.1 核心差异分析</h3>



































<table><thead><tr><th>特性</th><th>Docker Swarm</th><th>Kubernetes</th></tr></thead><tbody><tr><td><strong>学习曲线</strong>​</td><td>平缓，Docker 原生</td><td>陡峭，概念丰富</td></tr><tr><td><strong>功能完整性</strong>​</td><td>基础编排</td><td>企业级完整生态</td></tr><tr><td><strong>扩展性</strong>​</td><td>中等</td><td>极强</td></tr><tr><td><strong>社区生态</strong>​</td><td>一般</td><td>极其丰富</td></tr><tr><td><strong>部署复杂度</strong>​</td><td>简单</td><td>复杂但灵活</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 升级价值点</h3>
<ul>
<li>✅ 更强大的自愈能力</li>
<li>✅ 精细化的资源管理</li>
<li>✅ 丰富的扩展组件（监控、日志、网络策略等）</li>
<li>✅ 行业标准，社区支持强大</li>
</ul>
<h2 data-id="heading-3">二、Kubernetes 集群规划与搭建</h2>
<h3 data-id="heading-4">2.1 节点规划（基于您现有的多台 CentOS 机器）</h3>
<p>假设我们有 3 台 CentOS 7.9 机器：</p>
<ul>
<li><strong>k8s-master</strong>​ (192.168.1.10) - 控制平面节点</li>
<li><strong>k8s-node1</strong>​ (192.168.1.11) - 工作节点</li>
<li><strong>k8s-node2</strong>​ (192.168.1.12) - 工作节点</li>
</ul>
<h3 data-id="heading-5">2.2 所有节点基础环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 所有节点执行：关闭 SELinux 和防火墙</span>
setenforce 0
sed -i <span class="hljs-string">'s/^SELINUX=enforcing/SELINUX=permissive/'</span> /etc/selinux/config
systemctl stop firewalld
systemctl <span class="hljs-built_in">disable</span> firewalld

<span class="hljs-comment"># 关闭 swap</span>
swapoff -a
sed -i <span class="hljs-string">'/ swap / s/^(.*)$/#\1/g'</span> /etc/fstab

<span class="hljs-comment"># 配置内核参数</span>
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF</span>
sysctl --system

<span class="hljs-comment"># 配置国内 yum 源（阿里云）</span>
curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
</code></pre>
<h3 data-id="heading-6">2.3 安装 Docker 和 Kubernetes 组件</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 所有节点：安装 Docker</span>
yum install -<span class="hljs-keyword">y</span> yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https:<span class="hljs-regexp">//mirr</span>ors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache fast
yum install -<span class="hljs-keyword">y</span> docker-ce-<span class="hljs-number">20.10</span>.<span class="hljs-number">12</span> docker-ce-cli-<span class="hljs-number">20.10</span>.<span class="hljs-number">12</span> containerd.io

<span class="hljs-comment"># 配置 Docker 镜像加速和 cgroup 驱动</span>
<span class="hljs-keyword">mkdir</span> -p /etc/docker
cat &gt; <span class="hljs-regexp">/etc/d</span>ocker/daemon.json &lt;&lt; EOF
{
  <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],
  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,
  <span class="hljs-string">"log-opts"</span>: {
    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span>
  },
  <span class="hljs-string">"storage-driver"</span>: <span class="hljs-string">"overlay2"</span>,
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>,
    <span class="hljs-string">"https://hub-mirror.c.163.com"</span>
  ]
}
EOF

<span class="hljs-comment"># 启动 Docker</span>
systemctl enable docker &amp;&amp; systemctl start docker

<span class="hljs-comment"># 所有节点：安装 kubeadm, kubelet, kubectl</span>
cat &lt;&lt;EOF &gt; <span class="hljs-regexp">/etc/</span>yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https:<span class="hljs-regexp">//mirr</span>ors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=<span class="hljs-number">1</span>
gpgcheck=<span class="hljs-number">1</span>
repo_gpgcheck=<span class="hljs-number">1</span>
gpgkey=https:<span class="hljs-regexp">//mirr</span>ors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https:<span class="hljs-regexp">//mirr</span>ors.aliyun.com/kubernetes/yum/doc/rpm-<span class="hljs-keyword">package</span>-key.gpg
EOF

yum install -<span class="hljs-keyword">y</span> kubelet-<span class="hljs-number">1.23</span>.<span class="hljs-number">0</span> kubeadm-<span class="hljs-number">1.23</span>.<span class="hljs-number">0</span> kubectl-<span class="hljs-number">1.23</span>.<span class="hljs-number">0</span>
systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>
<h3 data-id="heading-7">2.4 初始化 Kubernetes 集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 master 节点执行初始化</span>
kubeadm init \
  --apiserver-advertise-address=192.168.1.10 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.23.0 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16 \
  --ignore-preflight-errors=Swap

<span class="hljs-comment"># 配置 kubectl</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube
sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config
sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config

<span class="hljs-comment"># 在工作节点执行加入命令（在 kubeadm init 输出中获取）</span>
kubeadm <span class="hljs-built_in">join</span> 192.168.1.10:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;<span class="hljs-built_in">hash</span>&gt;
</code></pre>
<h3 data-id="heading-8">2.5 安装网络插件（Flannel）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 在 master 节点执行</span>
kubectl apply -f https:<span class="hljs-comment">//raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span>

<span class="hljs-meta"># 验证节点状态</span>
kubectl <span class="hljs-keyword">get</span> nodes
kubectl <span class="hljs-keyword">get</span> pods -n kube-system
</code></pre>
<h2 data-id="heading-9">三、Docker Swarm 到 Kubernetes 的配置转换</h2>
<h3 data-id="heading-10">3.1 核心概念映射表</h3>













































<table><thead><tr><th>Docker Swarm 概念</th><th>Kubernetes 对应资源</th><th>说明</th></tr></thead><tbody><tr><td><code>service</code>+ <code>replicas</code></td><td><code>Deployment</code></td><td>无状态应用部署</td></tr><tr><td><code>service</code>(有状态)</td><td><code>StatefulSet</code></td><td>有状态应用部署</td></tr><tr><td><code>service</code>暴露</td><td><code>Service</code></td><td>服务发现和负载均衡</td></tr><tr><td><code>ports</code></td><td><code>Service</code>+ <code>Ingress</code></td><td>端口暴露和路由</td></tr><tr><td><code>volumes</code></td><td><code>PersistentVolumeClaim</code></td><td>持久化存储</td></tr><tr><td><code>configs</code></td><td><code>ConfigMap</code>/<code>Secret</code></td><td>配置管理</td></tr><tr><td><code>networks</code></td><td><code>NetworkPolicy</code></td><td>网络策略</td></tr></tbody></table>
<h3 data-id="heading-11">3.2 创建 Kubernetes 命名空间</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 00-namespace.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-app</span>
</code></pre>
<h2 data-id="heading-12">四、有状态服务改造（重点解决权限问题）</h2>
<h3 data-id="heading-13">4.1 Redis 部署配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 01-redis-pvc.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">redis-pvc</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span>
  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">standard</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 02-redis-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-comment"># 重点：解决权限问题 - 设置安全上下文</span>
      <span class="hljs-attr">securityContext:</span>
        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">1000</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">command:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">redis-server</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">"--requirepass"</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">"123456"</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">"--appendonly"</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">"yes"</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis-data</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"100m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"200m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">exec:</span>
            <span class="hljs-attr">command:</span> [<span class="hljs-string">"redis-cli"</span>, <span class="hljs-string">"ping"</span>]
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">exec:</span>
            <span class="hljs-attr">command:</span> [<span class="hljs-string">"redis-cli"</span>, <span class="hljs-string">"ping"</span>]
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis-data</span>
        <span class="hljs-attr">persistentVolumeClaim:</span>
          <span class="hljs-attr">claimName:</span> <span class="hljs-string">redis-pvc</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 03-redis-service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">6379</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>  <span class="hljs-comment"># Headless Service for stateful applications</span>
</code></pre>
<h3 data-id="heading-14">4.2 MongoDB 部署配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 04-mongo-pvc.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-pvc</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>
  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">standard</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 05-mongo-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">mongo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">mongo</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">mongo</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">securityContext:</span>
        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">999</span>
        <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">999</span>
        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">999</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">mongo:5</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">27017</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MONGO_INITDB_ROOT_USERNAME</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"root"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MONGO_INITDB_ROOT_PASSWORD</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"root"</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-data</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/db</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"200m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">exec:</span>
            <span class="hljs-attr">command:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">mongosh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">--eval</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"db.adminCommand('ping')"</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">exec:</span>
            <span class="hljs-attr">command:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">mongosh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">--eval</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"db.adminCommand('ping')"</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-data</span>
        <span class="hljs-attr">persistentVolumeClaim:</span>
          <span class="hljs-attr">claimName:</span> <span class="hljs-string">mongo-pvc</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 06-mongo-service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">mongo</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">27017</span>
</code></pre>
<h2 data-id="heading-15">五、RocketMQ 集群化部署</h2>
<h3 data-id="heading-16">5.1 RocketMQ NameServer 配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 07-rmqnamesrv-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rmqnamesrv</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rmqnamesrv</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>  <span class="hljs-comment"># 高可用部署</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">rmqnamesrv</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">rmqnamesrv</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">securityContext:</span>
        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">3000</span>
        <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">3000</span>
        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">3000</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rmqnamesrv</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">"sh"</span>, <span class="hljs-string">"mqnamesrv"</span>]
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9876</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"200m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">tcpSocket:</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">9876</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
      <span class="hljs-attr">affinity:</span>
        <span class="hljs-attr">podAntiAffinity:</span>
          <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>
            <span class="hljs-attr">podAffinityTerm:</span>
              <span class="hljs-attr">labelSelector:</span>
                <span class="hljs-attr">matchExpressions:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span>
                  <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
                  <span class="hljs-attr">values:</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">rmqnamesrv</span>
              <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 08-rmqnamesrv-service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rmqnamesrv</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rmqnamesrv</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9876</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9876</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>  <span class="hljs-comment"># Headless Service for stateful discovery</span>
</code></pre>
<h3 data-id="heading-17">5.2 RocketMQ Broker 配置（支持集群）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 09-rocketmq-configmap.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-config</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">broker.conf:</span> <span class="hljs-string">|
    # Broker 集群配置
    brokerClusterName = DefaultCluster
    brokerName = broker-a
    brokerId = 0
    deleteWhen = 04
    fileReservedTime = 48
    brokerRole = ASYNC_MASTER
    flushDiskType = ASYNC_FLUSH
    # 自动发现 NameServer
    namesrvAddr = rmqnamesrv.rocketmq-app.svc.cluster.local:9876
</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 10-rmqbroker-statefulset.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rmqbroker</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">"rmqbroker"</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">rmqbroker</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">rmqbroker</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">securityContext:</span>
        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">3000</span>
        <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">3000</span>
        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">3000</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rmqbroker</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
        <span class="hljs-attr">command:</span> 
          <span class="hljs-bullet">-</span> <span class="hljs-string">sh</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">|
            # 动态设置 Broker 名称
            BROKER_NAME="broker-${HOSTNAME##*-}"
            sed -i "s/brokerName = broker-a/brokerName = ${BROKER_NAME}/" /opt/rocketmq/conf/broker.conf
            sh mqbroker -c /opt/rocketmq/conf/broker.conf
</span>        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10911</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10909</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">JAVA_OPTS</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">" -Duser.home=/opt"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">JAVA_OPT_EXT</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"-server -Xms512m -Xmx512m -Xmn256m"</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">broker-config</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/opt/rocketmq/conf/broker.conf</span>
          <span class="hljs-attr">subPath:</span> <span class="hljs-string">broker.conf</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">broker-data</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/rocketmq/store</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"2Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">tcpSocket:</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">10911</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">broker-config</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-config</span>
  <span class="hljs-attr">volumeClaimTemplates:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">broker-data</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">"ReadWriteOnce"</span> ]
      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">standard</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">requests:</span>
          <span class="hljs-attr">storage:</span> <span class="hljs-string">20Gi</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 11-rmqbroker-service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rmqbroker</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rmqbroker</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">10911</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">10911</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vip</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">10909</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">10909</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>
</code></pre>
<h2 data-id="heading-18">六、SpringBoot 应用改造（重点解决权限问题）</h2>
<h3 data-id="heading-19">6.1 应用配置和部署</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 12-springboot-configmap.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-config</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">application.yml:</span> <span class="hljs-string">|
    server:
      port: 8080
</span>    
    <span class="hljs-attr">spring:</span>
      <span class="hljs-attr">application:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-user-service</span>
      <span class="hljs-attr">data:</span>
        <span class="hljs-attr">mongodb:</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://root:root@mongo.rocketmq-app.svc.cluster.local:27017/product_db?authSource=admin</span>
      <span class="hljs-attr">redis:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">redis.rocketmq-app.svc.cluster.local</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
    
    <span class="hljs-attr">rocketmq:</span>
      <span class="hljs-attr">name-server:</span> <span class="hljs-string">rmqnamesrv.rocketmq-app.svc.cluster.local:9876</span>
      <span class="hljs-attr">producer:</span>
        <span class="hljs-attr">group:</span> <span class="hljs-string">user-service-producer-group</span>
    
    <span class="hljs-attr">logging:</span>
      <span class="hljs-attr">level:</span>
        <span class="hljs-attr">RocketmqClient:</span> <span class="hljs-string">ERROR</span>
        <span class="hljs-attr">com.example:</span> <span class="hljs-string">DEBUG</span>
      <span class="hljs-attr">file:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">/home/spring/logs/application/application.log</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 13-springboot-secret.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-secret</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-comment"># echo -n 'your-password' | base64</span>
  <span class="hljs-attr">redis-password:</span> <span class="hljs-string">MTIzNDU2</span>  <span class="hljs-comment"># 123456</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 14-springboot-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">my-springboot-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">my-springboot-app</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-comment"># 重点：安全上下文配置，解决权限问题</span>
      <span class="hljs-attr">securityContext:</span>
        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">fsGroupChangePolicy:</span> <span class="hljs-string">"OnRootMismatch"</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-springboot-app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">my-springboot-app:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"k8s"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ROCKETMQ_CLIENT_LOG_ROOT</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"/home/spring/logs/rocketmqlogs"</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/app/config</span>
          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-logs</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/spring/logs</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
        <span class="hljs-comment"># 初始化容器：预先创建日志目录并设置正确权限</span>
        <span class="hljs-attr">lifecycle:</span>
          <span class="hljs-attr">postStart:</span>
            <span class="hljs-attr">exec:</span>
              <span class="hljs-attr">command:</span> [<span class="hljs-string">"/bin/sh"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"mkdir -p /home/spring/logs/application /home/spring/logs/rocketmqlogs &amp;&amp; chmod -R 755 /home/spring/logs"</span>]
      <span class="hljs-attr">initContainers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">init-logs-permission</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.35</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'mkdir -p /home/spring/logs/application /home/spring/logs/rocketmqlogs &amp;&amp; chown -R 1000:1000 /home/spring/logs &amp;&amp; chmod -R 755 /home/spring/logs'</span>]
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-logs</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/spring/logs</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-config</span>
          <span class="hljs-attr">items:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">application.yml</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">application.yml</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-logs</span>
        <span class="hljs-attr">persistentVolumeClaim:</span>
          <span class="hljs-attr">claimName:</span> <span class="hljs-string">springboot-logs-pvc</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span>
        <span class="hljs-attr">emptyDir:</span> {}

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 15-springboot-pvc.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-logs-pvc</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>
  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">standard</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 16-springboot-service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 17-springboot-ingress.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-ingress</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">rocketmq-app.example.com</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">my-springboot-app</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">8080</span>
</code></pre>
<h2 data-id="heading-20">七、部署和验证</h2>
<h3 data-id="heading-21">7.1 按顺序部署所有资源</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 创建命名空间</span>
kubectl apply -f <span class="hljs-number">00</span>-<span class="hljs-keyword">namespace</span>.yaml

<span class="hljs-meta"># 部署存储相关</span>
kubectl apply -f <span class="hljs-number">01</span>-redis-pvc.yaml
kubectl apply -f <span class="hljs-number">04</span>-mongo-pvc.yaml
kubectl apply -f <span class="hljs-number">15</span>-springboot-pvc.yaml

<span class="hljs-meta"># 部署配置</span>
kubectl apply -f <span class="hljs-number">09</span>-rocketmq-configmap.yaml
kubectl apply -f <span class="hljs-number">12</span>-springboot-configmap.yaml
kubectl apply -f <span class="hljs-number">13</span>-springboot-secret.yaml

<span class="hljs-meta"># 部署有状态服务</span>
kubectl apply -f <span class="hljs-number">02</span>-redis-deployment.yaml
kubectl apply -f <span class="hljs-number">03</span>-redis-service.yaml
kubectl apply -f <span class="hljs-number">05</span>-mongo-deployment.yaml
kubectl apply -f <span class="hljs-number">06</span>-mongo-service.yaml
kubectl apply -f <span class="hljs-number">07</span>-rmqnamesrv-deployment.yaml
kubectl apply -f <span class="hljs-number">08</span>-rmqnamesrv-service.yaml
kubectl apply -f <span class="hljs-number">10</span>-rmqbroker-statefulset.yaml
kubectl apply -f <span class="hljs-number">11</span>-rmqbroker-service.yaml

<span class="hljs-meta"># 部署应用服务</span>
kubectl apply -f <span class="hljs-number">14</span>-springboot-deployment.yaml
kubectl apply -f <span class="hljs-number">16</span>-springboot-service.yaml
kubectl apply -f <span class="hljs-number">17</span>-springboot-ingress.yaml

<span class="hljs-meta"># 验证部署状态</span>
kubectl <span class="hljs-keyword">get</span> all -n rocketmq-app
kubectl <span class="hljs-keyword">get</span> pvc -n rocketmq-app
</code></pre>
<h3 data-id="heading-22">7.2 验证服务连通性</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 检查所有 Pod 状态</span>
kubectl get pods -n rocketmq-app -w

<span class="hljs-comment"># 查看详细部署状态</span>
kubectl describe deployment my-springboot-app -n rocketmq-app

<span class="hljs-comment"># 测试服务发现</span>
kubectl run test-pod <span class="hljs-attr">--image</span>=busybox -it --rm -n rocketmq-app -- sh
<span class="hljs-comment"># 在测试 Pod 中执行：</span>
nslookup redis.rocketmq-app.svc.cluster.local
nslookup rmqnamesrv.rocketmq-app.svc.cluster.local
telnet my-springboot-app 8080
</code></pre>
<h3 data-id="heading-23">7.3 验证权限问题解决</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入 SpringBoot 应用 Pod 验证权限</span>
kubectl <span class="hljs-built_in">exec</span> -it deployment/my-springboot-app -n rocketmq-app -- sh

<span class="hljs-comment"># 在容器内执行权限验证</span>
<span class="hljs-built_in">whoami</span>
<span class="hljs-built_in">ls</span> -la /home/spring/logs/
<span class="hljs-built_in">touch</span> /home/spring/logs/test-permission.log
<span class="hljs-built_in">echo</span> <span class="hljs-string">"权限测试成功"</span> &gt; /home/spring/logs/test-permission.log
<span class="hljs-built_in">cat</span> /home/spring/logs/test-permission.log
</code></pre>
<h2 data-id="heading-24">八、高级特性配置</h2>
<h3 data-id="heading-25">8.1 资源限制和 HPA</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 18-hpa.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-hpa</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scaleTargetRef:</span>
    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">metrics:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span>
    <span class="hljs-attr">resource:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">cpu</span>
      <span class="hljs-attr">target:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Utilization</span>
        <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">80</span>
</code></pre>
<h3 data-id="heading-26">8.2 网络策略</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 19-network-policy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-app-policy</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">podSelector:</span> {}
  <span class="hljs-attr">policyTypes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span>
  <span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span>
        <span class="hljs-attr">matchLabels:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-app</span>
  <span class="hljs-attr">egress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span>
        <span class="hljs-attr">matchLabels:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">rocketmq-app</span>
</code></pre>
<h2 data-id="heading-27">九、监控和日志收集</h2>
<h3 data-id="heading-28">9.1 部署 Prometheus 监控</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 添加 Prometheus 仓库</span>
helm repo <span class="hljs-keyword">add</span> prometheus-community https:<span class="hljs-comment">//prometheus-community.github.io/helm-charts</span>
helm repo update

<span class="hljs-meta"># 安装 Prometheus Stack</span>
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-<span class="hljs-keyword">namespace</span>
</code></pre>
<h3 data-id="heading-29">9.2 应用监控配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 20-service-monitor.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app-monitor</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">rocketmq-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">my-springboot-app</span>
  <span class="hljs-attr">endpoints:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/prometheus</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
</code></pre>
<h2 data-id="heading-30">十、迁移验证清单</h2>
<h3 data-id="heading-31">10.1 功能验证清单</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 基础服务验证</span>
kubectl get pods -n rocketmq-app | grep -v Running &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"有Pod未就绪"</span>

<span class="hljs-comment"># 2. 服务连通性测试</span>
kubectl run connectivity-test --image=curlimages/curl -it --<span class="hljs-built_in">rm</span> -- \
  curl -s http://my-springboot-app:8080/actuator/health

<span class="hljs-comment"># 3. RocketMQ 功能测试</span>
kubectl <span class="hljs-built_in">exec</span> -it deployment/my-springboot-app -n rocketmq-app -- \
  curl -X POST http://localhost:8080/api/test-message

<span class="hljs-comment"># 4. 数据持久化验证</span>
kubectl <span class="hljs-built_in">exec</span> -it statefulset/rmqbroker -n rocketmq-app -- \
  <span class="hljs-built_in">ls</span> -la /home/rocketmq/store/

<span class="hljs-comment"># 5. 权限问题验证（重点）</span>
kubectl <span class="hljs-built_in">exec</span> -it deployment/my-springboot-app -n rocketmq-app -- \
  <span class="hljs-built_in">touch</span> /home/spring/logs/permission-test.log &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"权限配置正确"</span>
</code></pre>
<h2 data-id="heading-32">总结</h2>
<p>通过本文的详细步骤，我们成功将 RocketMQ 微服务项目从 Docker Swarm 迁移到了功能更强大的 Kubernetes 集群，并重点解决了之前遇到的权限问题。关键改进包括：</p>
<h3 data-id="heading-33">🎯 核心成果</h3>
<ol>
<li><strong>✅ 彻底解决权限问题</strong>：通过 SecurityContext 和 initContainers 确保正确的文件权限</li>
<li><strong>✅ 生产级高可用</strong>：所有关键组件实现多副本部署</li>
<li><strong>✅ 精细化资源管理</strong>：CPU/内存限制、HPA 自动扩缩容</li>
<li><strong>✅ 完善的服务治理</strong>：服务发现、健康检查、网络策略</li>
<li><strong>✅ 企业级监控</strong>：集成 Prometheus 监控体系</li>
</ol>
<h3 data-id="heading-34">🔄 迁移价值</h3>
<ul>
<li><strong>可扩展性</strong>：从简单的 Swarm 扩展到强大的 K8s 生态</li>
<li><strong>稳定性</strong>：完善的自愈能力和故障转移机制</li>
<li><strong>可观测性</strong>：完整的监控、日志、追踪体系</li>
<li><strong>安全性</strong>：网络策略、RBAC、安全上下文等企业级安全特性</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何将一个 React SPA 项目迁移到 Next.js 服务端渲染]]></title>    <link>https://juejin.cn/post/7575829296453009418</link>    <guid>https://juejin.cn/post/7575829296453009418</guid>    <pubDate>2025-11-24T09:24:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296453009418" data-draft-id="7575887863798153226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何将一个 React SPA 项目迁移到 Next.js 服务端渲染"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-11-24T09:24:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="山依尽"/> <meta itemprop="url" content="https://juejin.cn/user/1934742364890254"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何将一个 React SPA 项目迁移到 Next.js 服务端渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1934742364890254/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    山依尽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:24:14.000Z" title="Mon Nov 24 2025 09:24:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>日期：2025年11月24日</strong></p>
<h2 data-id="heading-0">价值</h2>
<blockquote>
<ol>
<li>“渐进式迁移”策略：学会最大程度保护现有投资，实现技术栈的平稳升级帮助学员使用 Next.js 实现服务端渲染 。</li>
<li>征服服务端渲染，解决核心业务痛点： 您将系统掌握 Next.js 的核心能力（SSR/SSG/ISR），从根本上解决传统 React SPA 面临的页面加载缓慢、SEO 不友好两大难题，从而提升用户体验和商业转化率。</li>
</ol>
</blockquote>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<ol>
<li>本文将聚焦渲染原理，不深入讲解 Next.js 的具体使用细节，而是通过一个真实案例，以战代练的方式带你将 React SPA 应用迁移至 Next.js 框架。</li>
<li>结合大量实战项目中的踩坑经验，降低上手门槛，并借助第三方生态，助你构建完整的 Next.js 基础能力体系。</li>
<li>提供一套符合落地要求的 Next.js 构建与部署实用教程。</li>
</ol>
</blockquote>
<h2 data-id="heading-2">目标</h2>
<blockquote>
<ol>
<li>对服务端渲染祛魅，深入理解与掌握 SSR、SSG、CSR 等渲染模式的原理、优缺点及适用场景。</li>
<li>具备平滑迁移与架构设计手段，具备技术落地能力。</li>
<li>能够将 Next.js 应用顺利部署到云上环境。</li>
</ol>
</blockquote>
<h2 data-id="heading-3">目录/结构</h2>
<blockquote>
<ol>
<li>第一个模块主要包括如何最简单的上手 Next.js，包括环境准备、基本的渲染原理、与 SPA 应用的开发差异</li>
<li>第二个模块用一个实际大型网站迁移路线，说明我们从一个大型网站如何一步一步重构成Next应用，从而实现网页性能优化的过程。</li>
<li>第三个模块包含了如何进行落地的部署方案</li>
</ol>
</blockquote>
<h2 data-id="heading-4">第一章：Next.js 最简单的上手教程</h2>
<p>如何最低成本的上手 Next.js 呢？</p>
<blockquote>
<p>内心OS:</p>
<ul>
<li>之前也没有学过相关的知识。是不是很难啊？如果很难的话那算了，我还是回去画我的页面吧/_ \</li>
</ul>
</blockquote>
<h3 data-id="heading-5">第一节：前置准备</h3>
<h4 data-id="heading-6">1、开发环境</h4>
<blockquote>
<p>基于Next 15 最新api，所以对运行环境有一定要求</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 18.18</a> 或更高LTS版本</li>
<li>macOS、Windows（含 WSL）或 Linux 系统</li>
</ul>
<h4 data-id="heading-7">2、项目初始化</h4>
<blockquote>
<p>为了大家更好的上手，我准备了两套可用于生产环境的模版供大家使用</p>
</blockquote>
<ul>
<li>
<p>通用版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcodelab.msxf.com%2Fpublic-repo%2Fproject%2F-%2Ftree%2Fnext-qiankun" target="_blank" title="https://codelab.msxf.com/public-repo/project/-/tree/next-qiankun" ref="nofollow noopener noreferrer">codelab.msxf.com/public-repo…</a></p>
</li>
<li>
<p>精简版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcodelab.msxf.com%2Fpublic-repo%2Fproject%2F-%2Ftree%2Fnext-base" target="_blank" title="https://codelab.msxf.com/public-repo/project/-/tree/next-base" ref="nofollow noopener noreferrer">codelab.msxf.com/public-repo…</a></p>
<ul>
<li>
















































































<table><thead><tr><th>能力</th><th>通用版本</th><th>精简版本</th></tr></thead><tbody><tr><td>React 版本</td><td>19.2.0</td><td>18.3.0</td></tr><tr><td>组件库 Ant Design v5</td><td>-</td><td>-</td></tr><tr><td>应用状态管理 Zustand</td><td>-</td><td>-</td></tr><tr><td>服务端请求 demo</td><td>-</td><td>-</td></tr><tr><td>客户端请求 demo</td><td>-</td><td>-</td></tr><tr><td>CSS预处理器：Sass</td><td>-</td><td>-</td></tr><tr><td>代码检查 Typescript，Eslint 等</td><td>-</td><td>-</td></tr><tr><td>单元测试 Jest</td><td>-</td><td>-</td></tr><tr><td>多环境部署方案</td><td>-</td><td>-</td></tr><tr><td>自定义服务器 Koa</td><td>-</td><td>-</td></tr><tr><td>css 样式烘焙</td><td>-</td><td>-</td></tr><tr><td>前端监控 @sentry/react</td><td>-</td><td>-</td></tr><tr><td>前端埋点 UBS</td><td>-</td><td>-</td></tr><tr><td>微前端方案</td><td>qiankun 2.10.16，应用动态更新，微前端通信</td><td>模块联邦 2.0</td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">第二节：认识文件系统约定</h3>
<h4 data-id="heading-9">1、认识组件层级结构</h4>
<ul>
<li><code>layout.js</code>布局文件，默认<code>Server Components</code></li>
<li><code>template.js</code> 同 layout.js，但是在导航时重新同步执行 <code>useEffect</code></li>
<li><code>error.js</code> (React 错误边界)</li>
<li><code>loading.js</code> (React Suspense 边界)</li>
<li><code>not-found.js</code> (<code>notFound</code> 函数执行时渲染 UI)</li>
<li><code>page.js</code> 或嵌套的 <code>layout.js</code>（必要的）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17d8f367e837401bb122d3c51569d789~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=vYopMhaV3T7afiSkX%2B00h23PEIM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">2、了解路由嵌套关系</h4>
<blockquote>
<p>嵌套文件夹定义了路由结构。每个文件夹代表一个路由段，对应 URL 路径中的一个段。只有当路由段中添加了 <code>page.js</code> 或 <code>route.js</code> 文件时，该路由才会对外可访问</p>
</blockquote>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fgetting-started%2Fproject-structure%23%25E5%25B5%258C%25E5%25A5%2597%25E8%25B7%25AF%25E7%2594%25B1" target="_blank" title="https://zh-hans.nextjs.im/docs/app/getting-started/project-structure#%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1" ref="nofollow noopener noreferrer">嵌套路由</a></p>
<ul>
<li>
<blockquote>
<p>最基础的文件路由关系</p>
</blockquote>
</li>
<li>























<table><thead><tr><th>规则</th><th>说明</th><th>实例</th><th>用户URL</th></tr></thead><tbody><tr><td>folder</td><td>路由段</td><td><code>app/folder/page.js</code></td><td><code>/folder</code></td></tr><tr><td>folder/folder</td><td>嵌套路由段</td><td><code>app/folder/folder/page.js</code></td><td><code>/folder/folder</code></td></tr></tbody></table>
</li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fgetting-started%2Fproject-structure%23%25E5%258A%25A8%25E6%2580%2581%25E8%25B7%25AF%25E7%2594%25B1" target="_blank" title="https://zh-hans.nextjs.im/docs/app/getting-started/project-structure#%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1" ref="nofollow noopener noreferrer">动态路由</a></p>
<ul>
<li>
<blockquote>
<p>无法提前确定确切的路由段名称，并希望根据动态数据创建路由时</p>
</blockquote>
</li>
<li>





























<table><thead><tr><th>规则</th><th>说明</th><th>实例</th><th>用户URL</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fdynamic-routes%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/dynamic-routes#convention" ref="nofollow noopener noreferrer">[folder]</a></td><td>动态路由段</td><td><code>app/[slug]/page.js</code></td><td><code>/``shop``/``shop1</code></td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fdynamic-routes%23catch-all-segments" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/dynamic-routes#catch-all-segments" ref="nofollow noopener noreferrer">[...folder]</a></td><td>全捕获路由段</td><td><code>app/shop/[...slug]/page.js</code></td><td><code>/shop/a``/shop/a/b``/shop/a/b/c</code></td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fdynamic-routes%23optional-catch-all-segments" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/dynamic-routes#optional-catch-all-segments" ref="nofollow noopener noreferrer">[[...folder]]</a></td><td>可选全捕获路由段</td><td>通配段和可选通配段的区别在于，可选情况下，不带参数的路由也会被匹配（如上例中的 <code>/shop</code>）</td><td>以上</td></tr></tbody></table>
</li>
<li>  例如，博客可以包含以下路由 <code>app/blog/[slug]/page.js</code>，其中 <code>[slug]</code> 是博客文章的动态段</li>
<li>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params">{
    params,
  }: {
    params: <span class="hljs-built_in">Promise</span>&lt;{ slug: string }&gt;
  }</span>) {
    <span class="hljs-keyword">const</span> { slug } = <span class="hljs-keyword">await</span> params
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我的文章: {slug}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  }
</code></pre>
</li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fgetting-started%2Fproject-structure%23%25E8%25B7%25AF%25E7%2594%25B1%25E7%25BB%2584%25E4%25B8%258E%25E7%25A7%2581%25E6%259C%2589%25E6%2596%2587%25E4%25BB%25B6%25E5%25A4%25B9" target="_blank" title="https://zh-hans.nextjs.im/docs/app/getting-started/project-structure#%E8%B7%AF%E7%94%B1%E7%BB%84%E4%B8%8E%E7%A7%81%E6%9C%89%E6%96%87%E4%BB%B6%E5%A4%B9" ref="nofollow noopener noreferrer">路由组与私有文件夹</a></p>
<ul>
<li>
<blockquote>
<p>表示该文件夹仅用于<strong>组织</strong>目的，通常用来引入公共布局</p>
</blockquote>
</li>
<li>























<table><thead><tr><th>规则</th><th>说明</th><th>实例</th><th>用户URL</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Froute-groups%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/route-groups#convention" ref="nofollow noopener noreferrer">(folder)</a></td><td>不影响实际路由的分组</td><td><code>app/(shop)/a/page.js</code></td><td><code>/a</code></td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fgetting-started%2Fproject-structure%23private-folders" target="_blank" title="https://zh-hans.nextjs.im/docs/app/getting-started/project-structure#private-folders" ref="nofollow noopener noreferrer">_folder</a></td><td>将文件夹及其子路由段排除在路由系统外</td><td>-</td><td>-</td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42646c96d1814b7188a181ce49028b90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=lm2Sp68JLYxmypzH6XJ1Jo6UGwM%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fintercepting-routes" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/intercepting-routes" ref="nofollow noopener noreferrer">拦截路由</a></p>
<ul>
<li>在后退导航时关闭模态框而非返回上一路由</li>
<li>在前进导航时重新打开模态框</li>
<li>






























<table><thead><tr><th>规则</th><th>说明</th><th>实例</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fintercepting-routes%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/intercepting-routes#convention" ref="nofollow noopener noreferrer">(.)folder</a></td><td>拦截同级路由</td><td>-</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fintercepting-routes%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/intercepting-routes#convention" ref="nofollow noopener noreferrer">(..)folder</a></td><td>拦截上一级路由</td><td>-</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fintercepting-routes%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/intercepting-routes#convention" ref="nofollow noopener noreferrer">(..)(..)folder</a></td><td>拦截上两级路由</td><td>-</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fintercepting-routes%23convention" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/intercepting-routes#convention" ref="nofollow noopener noreferrer">(...)folder</a></td><td>从根路由拦截</td><td>-</td></tr></tbody></table>
</li>
<li>  例如，当点击信息流中的照片时，你可以在模态框中显示该照片并覆盖在信息流上方。这种情况下，Next.js 会拦截 <code>/photo/123</code> 路由，隐藏 URL 并将其覆盖在 <code>/feed</code> 之上。</li>
<li><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb3c3d5b6f87444681e1e9f41e52ee11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=wlPknVH8Z9oywlDg06YodBMITb4%3D" alt="" loading="lazy"/></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fgetting-started%2Fproject-structure%23%25E5%25B9%25B6%25E8%25A1%258C%25E8%25B7%25AF%25E7%2594%25B1%25E4%25B8%258E%25E6%258B%25A6%25E6%2588%25AA%25E8%25B7%25AF%25E7%2594%25B1" target="_blank" title="https://zh-hans.nextjs.im/docs/app/getting-started/project-structure#%E5%B9%B6%E8%A1%8C%E8%B7%AF%E7%94%B1%E4%B8%8E%E6%8B%A6%E6%88%AA%E8%B7%AF%E7%94%B1" ref="nofollow noopener noreferrer">并行路由</a></p>
<ul>
<li>















<table><thead><tr><th>规则</th><th>说明</th><th>实例</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fapi-reference%2Ffile-conventions%2Fparallel-routes%23slots" target="_blank" title="https://zh-hans.nextjs.im/docs/app/api-reference/file-conventions/parallel-routes#slots" ref="nofollow noopener noreferrer">@folder</a></td><td>命名插槽，一个路由命中多个页面</td><td>见下方说明</td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<p>在一个仪表盘应用中，您可以使用并行路由同时或条件性渲染 <code>team</code> 和 <code>analytics</code> 两个页面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9bbdcd4bfb44a7491eabb8773a16383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=ENbxIdE4lTVnKzIjy8NAPlIX1rQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">第三节：页面开发</h3>
<h4 data-id="heading-12">1、页面概念-<strong>RSC</strong>渲染机制</h4>
<blockquote>
<p>Next.js 15 的 App Router 通过服务端组件<strong>RSC</strong>渲染机制（服务端组件/客户端组件）模糊了传统 SSR 和 CSR 的严格界限，通过混合渲染模式开发者只需关注“<strong>服务端逻辑</strong>”与“<strong>客户端逻辑</strong>”的划分，而非显式选择渲染模式</p>
</blockquote>
<p>第一个需要改变的思维模式是从“页面级”的渲染转变为“组件级”的渲染</p>
<p>假如我们有一个组件如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ServerComponent.js (一个 RSC)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ClientComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ClientComponent'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 在服务器上直接进行数据获取</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 服务器渲染这部分 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的博客<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* 这里“嵌入”了一个客户端组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ClientComponent</span> <span class="hljs-attr">initialPosts</span>=<span class="hljs-string">{data}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>在这个过程中发生了什么？</p>
<ol>
<li>
<p>服务器执行 <code>ServerComponent</code>。</p>
</li>
<li>
<p>服务器从接口/数据库获取 <code>data</code>。</p>
</li>
<li>
<p>服务器渲染 <code>&lt;h1&gt;我的博客&lt;/h1&gt;</code>。</p>
</li>
<li>
<p>当服务器遇到 <code>&lt;ClientComponent&gt;</code>时，它会为这个客户端组件“留出一个位置”，并将 <code>initialPosts</code>作为 prop 序列化。</p>
</li>
<li>
<p>最终，服务器发出的<strong>流式传输</strong>响应包含：</p>
<ol>
<li><code>ServerComponent</code>渲染出的 HTML 结构。</li>
<li>客户端组件位置的标记。</li>
<li>客户端组件所需的初始数据（序列化的 props）。</li>
<li>指向客户端组件所需 JavaScript 的链接。</li>
</ol>
</li>
<li>
<p>浏览器收到响应后，会立即显示由服务端渲染好的 HTML 内容（极快的首屏显示）。</p>
</li>
<li>
<p>然后，React 会进行 Hydration。但这里的 Hydration 是细粒度的。它只会下载并激活客户端组件部分的 JavaScript，使它们变得可交互。服务端组件的 JavaScript 永远不会发送到客户端。</p>
</li>
</ol>

























<table><thead><tr><th>时间</th><th>服务器行为</th><th>用户看到什么</th></tr></thead><tbody><tr><td>0s</td><td>开始渲染</td><td>空白屏</td></tr><tr><td>0.1s</td><td>遇到异步操作，立即发送 loading UI</td><td>看到静态内容部分看到 <code>ServerComponent</code>"加载中，请稍候..."+ 客户端下载资源、解析资源、渲染内容</td></tr><tr><td>2s</td><td>数据获取完成，发送实际内容</td><td>看到完整的页面内容</td></tr></tbody></table>
<p>思考：当接口需要2s，那是不是所有用户都需要等待 2s loading 之后才能看到页面呢？</p>
<h4 data-id="heading-13">2、服务端渲染组件</h4>
<blockquote>
<p>适用场景：服务端<strong>获取数据</strong>并<strong>渲染部分 UI</strong>，并将其流式传输到客户端。这些场景更适合服务端渲染</p>
<ul>
<li>提升<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Ffcp%2F" target="_blank" title="https://web.dev/fcp/" ref="nofollow noopener noreferrer">首次内容绘制 (FCP)</a>，并逐步将内容流式传输到客户端</li>
<li>从数据库或靠近数据源的 API 获取数据</li>
<li>使用 API 密钥、令牌等敏感信息而不暴露给客户端</li>
<li>减少发送到浏览器的 JavaScript 体积</li>
</ul>
</blockquote>
<p>默认情况下，组件都是服务端组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 引入客户端组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LikeButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/app/ui/like-button'</span>
<span class="hljs-keyword">import</span> { getPost } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lib/data'</span>
<span class="hljs-keyword">import</span> { db, posts } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lib/db'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params">{ params }: { params: { id: string } }</span>) {
  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPost</span>(params.<span class="hljs-property">id</span>)
  <span class="hljs-keyword">const</span> allPosts = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">select</span>().<span class="hljs-title function_">from</span>(posts)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{post.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        {/* ... */}
        <span class="hljs-tag">&lt;<span class="hljs-name">LikeButton</span> <span class="hljs-attr">likes</span>=<span class="hljs-string">{post.likes}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>      
          {allPosts.map((post) =&gt; (        
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{post.id}</span>&gt;</span>{post.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          ))}    
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-14">3、客户端渲染组件</h4>
<blockquote>
<p>适用场景：当需要<strong>交互性</strong>或使用<strong>浏览器</strong> <strong>API</strong> 时</p>
<ul>
<li>需要<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fmanaging-state" target="_blank" title="https://react.dev/learn/managing-state" ref="nofollow noopener noreferrer">状态管理</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fresponding-to-events" target="_blank" title="https://react.dev/learn/responding-to-events" ref="nofollow noopener noreferrer">事件处理</a>。例如 <code>onClick</code>、<code>onChange</code></li>
<li>需要<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Flifecycle-of-reactive-effects" target="_blank" title="https://react.dev/learn/lifecycle-of-reactive-effects" ref="nofollow noopener noreferrer">生命周期逻辑</a>。例如 <code>useEffect</code></li>
<li>使用浏览器专属 API。例如 <code>localStorage</code>、<code>window</code>、<code>Navigator.geolocation</code> 等</li>
<li>使用<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Freusing-logic-with-custom-hooks" target="_blank" title="https://react.dev/learn/reusing-logic-with-custom-hooks" ref="nofollow noopener noreferrer">自定义钩子</a></li>
</ul>
</blockquote>
<p>通过在文件顶部（导入语句之前）添加 <code>"use client"</code> 指令来创建客户端组件。</p>
<p>这时候将你的SPA页面复制到客户端组件中，也能完美运行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count} likes<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>注意：</strong> 在客户端组件中嵌套服务端渲染的 UI，需要服务端组件作为 prop 传递给客户端组件。不能在客户端组件中直接 import 引入服务端组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Modal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ui/modal'</span> <span class="hljs-comment">// 客户端组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Cart</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ui/cart'</span>   <span class="hljs-comment">// 服务端组件</span>

<span class="hljs-comment">// 服务端组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Cart</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
  )
}
</code></pre>
<p>思考：为什么客户端组件不能直接 import 服务端组件，反过来服务端组件就可以呢？？</p>
<h2 data-id="heading-15">第二章：从 CSR 到混合渲染迁移路线</h2>
<h3 data-id="heading-16">第一节：生态对比关系图</h3>
<p>云微前端主项目 Umi 4 到 Next 15</p>
<p>暂时无法在唯科之家2.0文档外展示此内容</p>
<h3 data-id="heading-17">第二节：生态迁移细节</h3>
<h4 data-id="heading-18">1、webpack 迁移到 Turbopack</h4>
<blockquote>
<p>遇到的问题</p>
</blockquote>
<ul>
<li>
<p>Q1：没有了svgr，如何支持.svg 文件并将其渲染为 React 组件呢？</p>
<ul>
<li>
<pre><code class="hljs language-css" lang="css">  // 使用 <span class="hljs-keyword">@svgr</span>/webpack 加载器，该加载器支持导入 .svg 文件并将其渲染为 React 组件

  module.exports = {
    turbopack: {
      rules: {
        '*<span class="hljs-selector-class">.svg</span>': {
          loaders: [<span class="hljs-string">'@svgr/webpack'</span>],
          as: <span class="hljs-string">'*.js'</span>,
        },
      },
    },
  }
</code></pre>
</li>
</ul>
</li>
<li>
<p>Q2：umi 自定义插件迁移问题，通过插件启用<code>Brotli</code>静态压缩</p>
<ul>
<li>  next方案不是很完美，默认情况下，当使用 <code>next start</code> 或自定义服务器时，Next.js 会使用 <code>gzip</code> 压缩渲染内容和静态文件。如果想要用<code>Brotli</code>压缩代码，则需要这样做：</li>
<li>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {  
    compress: <span class="hljs-literal">false</span>,
  }
</code></pre>
</li>
<li>  如果您正在使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2F" target="_blank" title="https://nginx.org/" ref="nofollow noopener noreferrer">nginx</a> 并希望改用 <code>brotli</code> 压缩，可以将 <code>compress</code> 选项设为 <code>false</code> 以让 nginx 处理压缩（其实也并不完美，这种方案需要依赖服务器压缩，而不是构建时压缩）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19">2、antd 升级</h4>
<blockquote>
<p>遇到的问题</p>
</blockquote>
<ul>
<li>
<p>Q1：为什么使用在 Next.js 中直接 &lt;Select.Option /&gt; 、&lt;Typography.Text /&gt;会报错，需要从路径引入这些子组件来避免错误</p>
<ul>
<li>
<pre><code class="hljs language-vbnet" lang="vbnet">  &lt;<span class="hljs-keyword">Select</span>.<span class="hljs-keyword">Option</span> value=<span class="hljs-string">"1"</span>&gt;<span class="hljs-keyword">Option</span> <span class="hljs-number">1</span>&lt;/<span class="hljs-keyword">Select</span>.<span class="hljs-keyword">Option</span>&gt;
</code></pre>
</li>
<li>  A：服务器组件树序列化问题，当使用 <code>Select.Option</code>这样的点表示法时，实际上是在引用一个对象的属性。Next.js 的 RSC 系统需要能够静态分析组件树，以便正确序列化和在客户端重建组件树。</li>
<li>  说人话就是RSC 系统在编译时需要确定：哪些是服务端组件，哪些是客户端组件以及组件之间的边界关系</li>
<li>  见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fuse-with-next-cn" target="_blank" title="https://ant.design/docs/react/use-with-next-cn" ref="nofollow noopener noreferrer">ant.design/docs/react/…</a></li>
</ul>
</li>
<li>
<p>Q2：服务端渲染中如何注入样式</p>
<ul>
<li>
<p>  A：有两种方式在服务端渲染消费组件样式，各有好处</p>
</li>
<li>
<p>内联：直接将样式内联到所使用的组件上</p>
<ul>
<li>好处是没有css请求</li>
<li>缺点是如果使用了多个同样的组件，会内联多份相同的样式，造成 HTML 体积增大，影响首屏渲染速度</li>
<li>    见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fserver-side-rendering-cn" target="_blank" title="https://ant.design/docs/react/server-side-rendering-cn" ref="nofollow noopener noreferrer">ant.design/docs/react/…</a></li>
</ul>
</li>
<li>
<p>烘焙：类似 antd 4，将项目中使用过的组件样式提取出一份单独的css</p>
<ul>
<li>好处是打开任意页面时如传统 css 方案一样都会复用同一套 css 文件以命中缓存</li>
<li>缺点是多主题的情况下会烘焙多份样式</li>
<li>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
  <span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
  <span class="hljs-keyword">import</span> { extractStyle } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/static-style-extract'</span>;
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">AntdConfigProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AntdConfigProvider'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">IS_PRODUCTION</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../src/constants/config'</span>;

  <span class="hljs-keyword">const</span> outputPath = <span class="hljs-variable constant_">IS_PRODUCTION</span> ? <span class="hljs-string">'./public/antd.min.css'</span> : <span class="hljs-string">'./public/antd.environment.css'</span>;

  <span class="hljs-keyword">const</span> css = <span class="hljs-title function_">extractStyle</span>(<span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AntdConfigProvider</span>&gt;</span>{node}<span class="hljs-tag">&lt;/<span class="hljs-name">AntdConfigProvider</span>&gt;</span></span>);

  fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, css);
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">2、状态管理</h4>
<blockquote>
<p>从 umi 到 Zustand, 由于 Next.js 本身并不提供状态管理工具。我们需要自己选型一款稳定、简单、好用的状态管理工具</p>
</blockquote>
<p>看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnpm-stat.com%2Fcharts.html%3Fpackage%3Dzustand%26package%3Djotai%26package%3Dvaltio%26package%3D%2540reduxjs%252Ftoolkit%26package%3Drecoil" target="_blank" title="https://npm-stat.com/charts.html?package=zustand&amp;package=jotai&amp;package=valtio&amp;package=%40reduxjs%2Ftoolkit&amp;package=recoil" ref="nofollow noopener noreferrer">React 各种 状态管理工具 Npm 下载趋势</a></p>
<p>Zustand 的使用本身很简单，定义一个Hooks，然后抛出状态和改变状态的方法即可</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// src/stores/counter-store.ts</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/vanilla'</span>

<span class="hljs-keyword">const</span> useCountStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">inc</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
}))

<span class="hljs-comment">// src/components/pages/home-page.tsx</span>
<span class="hljs-keyword">import</span> { useCountStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/providers/counter-store-provider.ts'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">HomePage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { count, inc} = useCountStore (<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state)
}
</code></pre>
<p>但这是在SPA中使用，在服务端渲染中对 Zustand 使用不可变数据提出了一些独特的挑战，所以我们需要一点小小的改变</p>
<ul>
<li>
<p>定义一个 Provider 防止组件重复执行初始化数据</p>
<ul>
<li>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ReactNode</span>, createContext, useContext, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createUserStore</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> createStore&lt;<span class="hljs-title class_">UserStore</span>&gt;()(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
      <span class="hljs-attr">userInfo</span>: {},
      <span class="hljs-attr">refreshUserFn</span>: <span class="hljs-keyword">async</span> (userInfo?: <span class="hljs-title class_">UserState</span> ) =&gt; {
        <span class="hljs-title function_">set</span>(<span class="hljs-function">() =&gt;</span> ({ ...state, <span class="hljs-attr">userInfo</span>: userInfo }));
      },
    }));
  };

  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserStoreContext</span> = createContext&lt;<span class="hljs-title class_">UserStoreApi</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-literal">undefined</span>);

  <span class="hljs-comment">/**
  * 创建地域上下文
  * 避免 createUserStore 重复执行
  */</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">UserStoreProvider</span> = (<span class="hljs-params">{ children }: UserStoreProviderProps</span>) =&gt; {
    <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">createUserStore</span>();
    <span class="hljs-keyword">const</span> storeRef = useRef&lt;<span class="hljs-title class_">UserStoreApi</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">if</span> (!storeRef.<span class="hljs-property">current</span>) {
      storeRef.<span class="hljs-property">current</span> = userStore;
    }
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserStoreContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{userStore}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">UserStoreContext.Provider</span>&gt;</span></span>;
  };

  <span class="hljs-comment">// 消费或初始化用户数据</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = &lt;T,&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">store: UserStore</span>) =&gt;</span> T): <span class="hljs-function"><span class="hljs-params">T</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserStoreContext</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">UserContext</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`useUserStore must be used within UserStoreProvider`</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">useStore</span>(<span class="hljs-title class_">UserContext</span>, selector);
  };
</code></pre>
</li>
</ul>
</li>
<li>
<p>在全局入口挂载并初始化 Provider</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserStoreProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/providers/userStoreProvider'</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Layout</span>(<span class="hljs-params">{children}</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserStoreProvider</span>&gt;</span> {children}&lt;/UserStoreProvider &gt;
    )
  }
</span></code></pre>
</li>
</ul>
</li>
<li>
<p>消费/变更用户数据</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">   const <span class="hljs-attr">userInfo</span> = useUserStore((state) =&gt; state.userInfo)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">3、请求库</h4>
<ul>
<li>
<p>服务端 fetch</p>
<ul>
<li>
<blockquote>
<p>Next.js 扩展了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fdocs%2FWeb%2FAPI%2FFetch_API" target="_blank" title="https://developer.mozilla.org/docs/Web/API/Fetch_API" ref="nofollow noopener noreferrer">Web fetch() API</a>，允许服务器上的每个请求设置自己的持久化缓存和重新验证语义。</p>
</blockquote>
</li>
<li>
<p>  新增两个api，配合 <strong>RSC</strong> 渲染实现缓存机制</p>
</li>
<li>
<p>cache ：配置请求如何与 Next.js <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fdeep-dive%2Fcaching%23data-cache" target="_blank" title="https://zh-hans.nextjs.im/docs/app/deep-dive/caching#data-cache" ref="nofollow noopener noreferrer">数据缓存 (Data Cache)</a> 交互</p>
<ul>
<li><code>auto no cache</code> (默认值)：Next.js 会在每次请求时获取资源，且会在<code>next build</code> 时会获取一次</li>
<li><code>no-store</code>: Next.js 会在每次请求时获取资源</li>
<li><code>force-cache</code>: Next.js 会在其数据缓存中查找匹配的请求。如果找到匹配且未过期，将从缓存返回。如果没有匹配或匹配已过期，Next.js 将从远程服务器获取资源并更新缓存。</li>
</ul>
</li>
<li>
<p>revalidate: 设置资源的缓存生命周期（以秒为单位）。</p>
<ul>
<li><code>false</code> - 无限期缓存资源。语义上等同于 <code>revalidate: Infinity</code>。HTTP 缓存可能会随时间推移淘汰旧资源。</li>
<li><code>0</code> - 阻止资源被缓存。</li>
<li><code>number</code> - （以秒为单位）指定资源的缓存生命周期最多为 <code>n</code> 秒。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>客户端 fetch</p>
<ul>
<li>同 window.fetch</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">4、css 预处理器</h4>
<p>从 less 到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fguides%2Fsass" target="_blank" title="https://zh-hans.nextjs.im/docs/app/guides/sass" ref="nofollow noopener noreferrer">Sass</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fguides%2Fsass" target="_blank" title="https://zh-hans.nextjs.im/docs/app/guides/sass" ref="nofollow noopener noreferrer">Sass</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fguides%2Ftailwind-css" target="_blank" title="https://zh-hans.nextjs.im/docs/app/guides/tailwind-css" ref="nofollow noopener noreferrer">Tailwind CSS</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.nextjs.im%2Fdocs%2Fapp%2Fguides%2Fcss-in-js" target="_blank" title="https://zh-hans.nextjs.im/docs/app/guides/css-in-js" ref="nofollow noopener noreferrer">CSS-in-JS</a></li>
</ul>
<h4 data-id="heading-23">5、声明路由到文件路由</h4>
<ul>
<li>
<p>特点总结：声明式路由和文件路由各有特点，声明路由上手简单，路由结构清晰；文件路由有一定上手门槛，控制颗粒度更细</p>
<ul>
<li>






























<table><thead><tr><th>声明路由</th><th>文件路由</th><th>差异化</th></tr></thead><tbody><tr><td>重定向 redirct</td><td>文件拦截路由</td><td>文件拦截路由支持动态拦截，功能更强大</td></tr><tr><td>声明嵌套路由</td><td>文件嵌套路由</td><td>无差异</td></tr><tr><td>动态路由</td><td>文件动态路由</td><td>功能无差异。文件路由可以按需添加Loading.js，not-found.js等处理文件，控制颗粒度会更细，声明路由需要根据pathname手动处理公共逻辑</td></tr><tr><td>-</td><td>文件并行路由</td><td>在设计条件路由、权限路由、标签页、URL模态框的时候比较有用</td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-24">6、微前端</h4>
<blockquote>
<p>在 Next.js中实现 @umi/plugin-qiankun 插件功能</p>
</blockquote>
<ul>
<li>
<p>原先umi框架中自带了一款非常好用的插件 @umi/plugin-qiankun 这让微前端接入、更新、状态传输变的异常简单，但是在 Next.js 中我们需要自己实现这个插件及相关功能</p>
<ul>
<li>暂时无法在唯科之家2.0文档外展示此内容</li>
</ul>
</li>
</ul>
<p>通过服务端server实现qiankun运行时注册，通过 Zustand + qiankun 实现子应用动态更新</p>
<h2 data-id="heading-25">第三章：部署方案</h2>
<h3 data-id="heading-26">第一节：构建与部署</h3>
<h4 data-id="heading-27">1、基础镜像</h4>
<ul>
<li>base/nodejs_nginx_anolios_brotli:v22.14.0_1.21.4.1</li>
</ul>
<p>此前的基础镜像主要面向SPA应用，承担网络代理与静态资源转发的功能。在引入Next.js服务端渲染方案后，我们还需要部署一套Node服务。按照原有部署流程，需单独申请一个应用来运行Node服务，并额外配置一个Nginx应用，用于处理代理与静态资源相关配置。</p>
<p>为简化部署流程，我们现已重新构建了一款Base镜像，支持在单一实例中同时启动两个进程：Nginx服务负责请求转发和静态资源处理，而Node进程则用于运行Next.js服务。</p>
<h4 data-id="heading-28">2、构建</h4>
<ul>
<li><code>standalone</code></li>
</ul>
<p>以前使用 Docker 部署时，需要安装包中 <code>dependencies</code> 的所有文件才能运行 <code>next start</code>。从 Next.js 12 开始，可以利用 <code>.next/</code> 目录中的输出文件追踪功能<code>.nft.json</code>，仅包含必要的文件<code>.next</code> 目录</p>
<p>我们通过开启 <code>standlone </code>特性，此时 Next.js 可以根据<code>.nft.json</code>自动创建一个 <code>standalone</code> 文件夹，仅复制生产部署所需的文件，包括 <code>node_modules</code> 中的选定文件。还会输出一个最小化的 <code>server.js</code> 文件，可用于替代 <code>next start</code></p>
<p>优化之前构建时长＋镜像制作（包含打包modules时间）共计15分钟。优化之后构建时长和镜像制作约3分钟，当然启用 <code>standalone</code> 也为我们带来一些挑战</p>
<ul>
<li>默认 next build 部署方式</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ea24ec09004a1da7ef686f5eeb2293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=%2BTR%2FNrkoqz6VrxjMgGFz22j2YZU%3D" alt="" loading="lazy"/></p>
<ul>
<li>使用 <code>standalone</code> 构建</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07a1ba958765488aa38c96536c102543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5L6d5bC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764581053&amp;x-signature=IgpFmnqyhN4b3Z3bKCYl9caTT2Y%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>Q1 ：当我们使用 pnpm 构建时，报错 Error: EPERM: operation not permitted, symlink</p>
<ul>
<li>  A：windows系统<strong>非管理员权限</strong>问题 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fdiscussions%2F52244" target="_blank" title="https://github.com/vercel/next.js/discussions/52244" ref="nofollow noopener noreferrer">相关Discussions</a>），</li>
<li>   方法一：可以通过设置，这会扁平化pnpm依赖，需要注意的是幽灵依赖问题</li>
<li>
<pre><code class="hljs language-ini" lang="ini">   <span class="hljs-comment">## 禁用符号链接来避免此问题，避免非管理员 standalone 构建报错</span>
  <span class="hljs-attr">symlink</span>=<span class="hljs-literal">false</span>
  <span class="hljs-attr">node-linker</span>=hoisted
</code></pre>
</li>
<li>   方法二：本地构建通过环境变量用 output: 'export', <em>// 而不是 'standalone'，</em> <strong>生产环境</strong>还是使用standalone，需要注意两种构建方式产物差异的问题，这可能会导致本地开发效果跟生产不一致</li>
<li>   <del>方法三：换电脑 or 申请管理员权限</del></li>
</ul>
</li>
<li>
<p>Q2：<code>standalone</code> 为了极致的性能甚至不会复制 <code>public</code> 或 <code>.next/static</code> 文件夹，他默认我们会将这些文件内容部署到<code>cdn</code>，</p>
<ul>
<li>  A：当我们没有<code>cdn</code>服务器的时候，需要额外的复制这些文件到 <code>.next</code>文件夹下</li>
<li>
<pre><code class="hljs language-vbnet" lang="vbnet">  cp -r <span class="hljs-keyword">public</span> .<span class="hljs-keyword">next</span>/standalone/ &amp;&amp; cp -r .<span class="hljs-keyword">next</span>/<span class="hljs-keyword">static</span> .<span class="hljs-keyword">next</span>/standalone/.<span class="hljs-keyword">next</span>/
</code></pre>
</li>
</ul>
</li>
<li>
<p>Q3：如何自定义端口或主机名</p>
<ul>
<li>  A：在启动命令中添加</li>
<li>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span> HOSTNAME=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-29">3、部署</h4>
<ul>
<li>
<p>关于启动命令，先启动 Next.js 相关 Node 服务器（内部服务器，包含环境变量、端口、主机名称），在启动Nginx 服务（提供外部访问，含动态域名解析）</p>
<ul>
<li>
<pre><code class="hljs language-bash" lang="bash">  HOSTNAME=localhost SERVER_API_ENV=online node ./standalone/server.js &amp; bash /opt/nginx/conf/resolve.sh &amp;&amp; /opt/nginx/runnginx.sh
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">第二节：Nginx 配置说明</h3>
<h4 data-id="heading-31">1、服务端代理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">################ 网关配置 #####################</span>
<span class="hljs-comment">################ 网关配置 #####################</span>
<span class="hljs-comment"># 网关代理</span>
location ~ ^/(noauth|portal)/ {
  <span class="hljs-built_in">set</span> <span class="hljs-variable">$proxy_url</span> http://gc-gw-server.mscloud.lo;
  proxy_pass <span class="hljs-variable">$proxy_url</span>;
}
</code></pre>
<h4 data-id="heading-32">2、微前端子应用资源代理</h4>
<blockquote>
<p>通过子应用资源代理，子应用就不用申请公网域名</p>
</blockquote>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">################ 主项目加载子项目静态页面配置 #####################</span>
<span class="hljs-comment">################ 主项目加载子项目静态页面配置 #####################</span>
<span class="hljs-comment"># 子应用转发</span>
location ~ <span class="hljs-regexp">/msportal/</span>(\w+)/(.*) {
  <span class="hljs-comment"># 静态资源根据hash名称缓存</span>
  add_header Cache-Control $cache_control_header;
  proxy_pass http:<span class="hljs-regexp">//g</span>c-$1-fe.mscloud.lo/$2$is_args$args;
}
</code></pre>
<h4 data-id="heading-33">3、Next.js 资源兜底</h4>
<blockquote>
<p>在配置 SPA Nginx 服务器的时候，通常我们会返回一个兜底的静态页面，防止应用白屏化。同样的，我们也可以在Nginx里面将没有代理到的请求通通转向 Next.js 应用，由应用来处理各种异常情况</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">################ 其他所有请求交给 Next.js 处理 #####################</span>
<span class="hljs-comment">################ 其他所有请求交给 Next.js 处理 #####################</span>
<span class="hljs-comment"># 核心Next.js资源</span>
location /_next/static {
  proxy_pass http://localhost:3000;
  expires 30d;
}
<span class="hljs-comment"># 静态资源缓存设置</span>
location /public {
  proxy_pass http://localhost:3000;
  expires 30d;
}
<span class="hljs-comment"># 核心路由代理（指向 Node 应用）</span>
location / {
  add_header Cache-Control <span class="hljs-variable">$cache_control_header</span>;
  proxy_pass http://localhost:3000;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 svgfmt 优化 SVG 图标]]></title>    <link>https://juejin.cn/post/7576086446459551779</link>    <guid>https://juejin.cn/post/7576086446459551779</guid>    <pubDate>2025-11-24T09:26:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086446459551779" data-draft-id="7576105458806505472" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 svgfmt 优化 SVG 图标"/> <meta itemprop="keywords" content="前端,SVG,Icon"/> <meta itemprop="datePublished" content="2025-11-24T09:26:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桜"/> <meta itemprop="url" content="https://juejin.cn/user/1855631357387288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 svgfmt 优化 SVG 图标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631357387288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:26:11.000Z" title="Mon Nov 24 2025 09:26:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：SVG 图标的常见问题</h2>
<p>在日常开发中，我们经常需要使用设计师提供的 SVG 图标。然而，从 Figma 等设计工具导出的 SVG 文件往往存在一些问题：</p>
<p>首先是代码冗余。设计工具导出的 SVG 通常包含大量不必要的标签，如 <code>&lt;defs&gt;</code>、<code>&lt;g&gt;</code>、<code>&lt;clipPath&gt;</code> 等容器元素，这些元素在实际使用中往往是多余的。其次，颜色值被写死。SVG 中的颜色通常以 <code>fill="#333333"</code> 这样的形式硬编码，导致无法像 icon font 那样通过 CSS 的 <code>color</code> 属性动态控制图标颜色。此外，文件中还可能包含不必要的属性和元数据，使得文件体积偏大。</p>
<p>这些问题给开发者带来了不少困扰：无法灵活控制图标样式，手动清理每个文件效率低下且容易出错，难以构建统一的图标管理系统。</p>
<h2 data-id="heading-1">svgfmt 简介</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoecasts%2Fsvgfmt" target="_blank" title="https://github.com/moecasts/svgfmt" ref="nofollow noopener noreferrer">svgfmt</a> 是一个专门用于优化 SVG 图标的开源工具，它采用 monorepo 架构，包含两个核心包：</p>
<ul>
<li><strong>@svgfmt/cli</strong>：命令行工具，提供便捷的文件处理能力，支持单文件和批量处理</li>
<li><strong>@svgfmt/core</strong>：核心库，可以轻松集成到自定义脚本和构建流程中</li>
</ul>
<p>svgfmt 能够自动清理冗余标签、移除固定颜色值、合并路径，让 SVG 图标变得更加轻量和易于维护。</p>
<h2 data-id="heading-2">使用指南</h2>
<h3 data-id="heading-3">命令行使用（@svgfmt/cli）</h3>
<p>首先安装 CLI 工具：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @svgfmt/cli
</code></pre>
<p><strong>基础用法</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 格式化单个文件（原地修改）</span>
svgfmt icon.svg

<span class="hljs-comment"># 批量处理并输出到指定目录</span>
svgfmt <span class="hljs-string">"icons/**/*.svg"</span> -o dist/icons

<span class="hljs-comment"># 处理单个文件并输出到新位置</span>
svgfmt logo.svg -o logo-optimized.svg
</code></pre>
<p><strong>自定义转换</strong></p>
<p>svgfmt 支持通过 <code>--transform</code> 参数自定义转换逻辑：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用转换文件</span>
svgfmt icons/*.svg --transform ./transform.js

<span class="hljs-comment"># 使用内联代码</span>
svgfmt icons/*.svg -t <span class="hljs-string">'svg =&gt; svg.replace(/&lt;svg/, "&lt;svg class=\"icon\"")'</span>
</code></pre>
<p>转换文件示例（<code>transform.js</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">svg</span>) {
  <span class="hljs-keyword">return</span> svg.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;svg/</span>, <span class="hljs-string">'&lt;svg class="icon"'</span>);
}

<span class="hljs-comment">// 或者使用命名导出</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">svg</span>) {
  <span class="hljs-keyword">return</span> svg.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;svg/</span>, <span class="hljs-string">'&lt;svg data-processed="true"'</span>);
}
</code></pre>
<h3 data-id="heading-4">编程方式使用（@svgfmt/core）</h3>
<p>在项目中安装核心库：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @svgfmt/core
</code></pre>
<p><strong>基础示例</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { format } <span class="hljs-keyword">from</span> <span class="hljs-string">'@svgfmt/core'</span>;

<span class="hljs-keyword">const</span> svgContent = <span class="hljs-string">`&lt;svg&gt;...&lt;/svg&gt;`</span>;
<span class="hljs-keyword">const</span> optimizedSvg = <span class="hljs-keyword">await</span> <span class="hljs-title function_">format</span>(svgContent);
</code></pre>
<p><strong>高级配置</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { format } <span class="hljs-keyword">from</span> <span class="hljs-string">'@svgfmt/core'</span>;

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">format</span>(svgContent, {
  <span class="hljs-comment">// 提高路径追踪精度（默认 600）</span>
  <span class="hljs-attr">traceResolution</span>: <span class="hljs-number">800</span>,
  
  <span class="hljs-comment">// 自定义转换函数</span>
  <span class="hljs-attr">transform</span>: <span class="hljs-function">(<span class="hljs-params">svg</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> svg.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;svg/</span>, <span class="hljs-string">'&lt;svg class="custom-icon"'</span>);
  }
});
</code></pre>
<p>对于需要异步处理的场景，<code>transform</code> 函数也支持异步：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">format</span>(svgContent, {
  <span class="hljs-attr">transform</span>: <span class="hljs-keyword">async</span> (svg) =&gt; {
    <span class="hljs-comment">// 执行异步操作</span>
    <span class="hljs-keyword">const</span> processed = <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>(svg);
    <span class="hljs-keyword">return</span> processed;
  }
});
</code></pre>
<h2 data-id="heading-5">优化效果对比</h2>
<p>让我们看一个实际的优化案例：</p>
<p><strong>优化前</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 12 12"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">opacity</span>=<span class="hljs-string">"0.6"</span> <span class="hljs-attr">clip-path</span>=<span class="hljs-string">"url(#clip0_144244_67656)"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"5"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#333"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"stroke:#333;stroke-opacity:1;"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M6 3.5V6L7.25 7.25"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#333"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"stroke:#333;stroke-opacity:1;"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">clipPath</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"clip0_144244_67656"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"#333"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"fill:#333;fill-opacity:1;"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">clipPath</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>

</code></pre>
<p><strong>优化后</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 12 12"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">path</span>
    <span class="hljs-attr">d</span>=<span class="hljs-string">"M5.660 0.521 C 4.899 0.566,4.190 0.760,3.500 1.111 C 2.479 1.630,1.630 2.479,1.111 3.500 C 0.702 4.303,0.516 5.086,0.516 6.000 C 0.516 6.748,0.635 7.374,0.904 8.050 C 1.386 9.261,2.332 10.295,3.500 10.889 C 4.085 11.187,4.680 11.369,5.332 11.451 C 5.675 11.494,6.325 11.494,6.668 11.451 C 8.173 11.262,9.516 10.479,10.410 9.270 C 10.792 8.753,11.059 8.227,11.248 7.620 C 11.517 6.754,11.562 5.741,11.369 4.842 C 11.027 3.241,9.959 1.853,8.500 1.111 C 7.617 0.662,6.653 0.461,5.660 0.521 M6.720 1.549 C 7.447 1.673,8.126 1.965,8.720 2.408 C 8.964 2.590,9.410 3.036,9.592 3.280 C 10.040 3.880,10.330 4.559,10.454 5.298 C 10.505 5.599,10.505 6.401,10.454 6.702 C 10.330 7.441,10.040 8.120,9.592 8.720 C 9.410 8.964,8.964 9.410,8.720 9.592 C 8.120 10.040,7.441 10.330,6.702 10.454 C 6.401 10.505,5.599 10.505,5.298 10.454 C 4.559 10.330,3.880 10.040,3.280 9.592 C 3.035 9.410,2.589 8.963,2.408 8.720 C 1.955 8.111,1.671 7.445,1.546 6.702 C 1.495 6.401,1.495 5.599,1.546 5.298 C 1.671 4.556,1.955 3.891,2.408 3.280 C 2.588 3.036,3.036 2.588,3.280 2.408 C 3.968 1.898,4.680 1.618,5.560 1.512 C 5.729 1.492,6.537 1.517,6.720 1.549 M5.500 4.845 L 5.500 6.190 6.200 6.890 L 6.900 7.590 7.245 7.245 L 7.590 6.900 7.045 6.355 L 6.500 5.810 6.500 4.655 L 6.500 3.500 6.000 3.500 L 5.500 3.500 5.500 4.845"</span>
    <span class="hljs-attr">fill-rule</span>=<span class="hljs-string">"evenodd"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>

</code></pre>
<p>主要改进包括：</p>
<ul>
<li><strong>移除冗余标签</strong>：去除了不必要的 <code>&lt;defs&gt;</code>、<code>&lt;g&gt;</code>、<code>&lt;clipPath&gt;</code> 等容器元素</li>
<li><strong>颜色属性移除</strong>：删除固定的 <code>fill</code> 属性，图标将继承父元素的 <code>color</code>，可以通过 CSS 灵活控制</li>
<li><strong>路径合并</strong>：多个子元素被智能合并为单一路径</li>
</ul>
<h2 data-id="heading-6">实践场景</h2>
<h3 data-id="heading-7">集成到开发流程</h3>
<p>在 <code>package.json</code> 中添加脚本命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"optimize-icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"svgfmt raw-icons/**/*.svg -o src/assets/icons"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run optimize-icons &amp;&amp; vite build"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样在每次构建前都会自动优化图标文件。</p>
<h3 data-id="heading-8">配合构建工具使用</h3>
<p>在构建脚本中使用编程 API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { formatPattern } <span class="hljs-keyword">from</span> <span class="hljs-string">'@svgfmt/cli'</span>;

<span class="hljs-comment">// 在构建时自动优化图标</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildIcons</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> <span class="hljs-title function_">formatPattern</span>(<span class="hljs-string">'icons/**/*.svg'</span>, {
    <span class="hljs-attr">output</span>: <span class="hljs-string">'dist/icons'</span>
  });

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`优化完成: <span class="hljs-subst">${summary.success}</span>/<span class="hljs-subst">${summary.total}</span>`</span>);
  
  <span class="hljs-comment">// 检查单个文件结果</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> result <span class="hljs-keyword">of</span> summary.<span class="hljs-property">results</span>) {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">success</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✓ <span class="hljs-subst">${result.input}</span> → <span class="hljs-subst">${result.output}</span>`</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`✗ <span class="hljs-subst">${result.input}</span>: <span class="hljs-subst">${result.error}</span>`</span>);
    }
  }
}

<span class="hljs-title function_">buildIcons</span>();
</code></pre>
<h3 data-id="heading-9">自定义转换示例</h3>
<p>创建一个转换文件 <code>transform.js</code>，为所有 SVG 添加统一属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">svg</span>) {
  <span class="hljs-keyword">return</span> svg
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;svg/</span>, <span class="hljs-string">'&lt;svg class="icon"'</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/viewBox/</span>, <span class="hljs-string">'preserveAspectRatio="xMidYMid meet" viewBox'</span>);
}
</code></pre>
<p>然后在命令行中使用：</p>
<pre><code class="hljs language-bash" lang="bash">svgfmt icons/*.svg --transform ./transform.js -o dist/icons
</code></pre>
<h2 data-id="heading-10">注意事项</h2>
<p>在使用 svgfmt 时，有几点需要注意：</p>
<ol>
<li>
<p><strong>仅支持单色图标</strong>：该工具专为单色图标设计。多色 SVG 在路径追踪过程中会被转换为单色，因为工具会将 SVG 转换为 PNG 再转回 SVG，这个过程会丢失颜色信息。</p>
</li>
<li>
<p><strong>路径精度配置</strong>：<code>traceResolution</code> 参数控制路径追踪的精度，默认值为 600。提高该值可以获得更精细的路径，但会增加处理时间。建议的取值范围是 600-1200。</p>
</li>
<li>
<p><strong>文件覆盖提醒</strong>：使用命令行工具时，默认会覆盖原文件。建议在处理前先备份原始文件，或使用 <code>-o</code> 参数指定输出目录。</p>
</li>
<li>
<p><strong>复杂图形检查</strong>：对于复杂的多色插图或渐变效果的 SVG，建议在优化后手动检查结果，确保视觉效果符合预期。</p>
</li>
<li>
<p><strong>工具组合</strong>：svgfmt 可以与其他 SVG 工具配合使用，如 SVGO（进一步优化）、svgr（转换为 React 组件）等，构建完整的 SVG 处理流程。</p>
</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>svgfmt 通过自动化的方式解决了 SVG 图标在实际使用中的常见问题，让图标文件更轻量、更易维护。无论是通过命令行快速处理一批图标，还是将其集成到构建流程中实现自动化优化，svgfmt 都能显著提升开发效率。</p>
<p>项目已在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoecasts%2Fsvgfmt" target="_blank" title="https://github.com/moecasts/svgfmt" ref="nofollow noopener noreferrer">GitHub</a> 开源，包含完整的文档和示例。如果你在项目中遇到 SVG 图标管理的问题，不妨试试 svgfmt，欢迎使用和贡献代码。</p>
<h2 data-id="heading-12">鸣谢</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foslllo%2Fsvg-fixer" target="_blank" title="https://github.com/oslllo/svg-fixer" ref="nofollow noopener noreferrer">oslllo/svg-fixer</a></li>
</ul>
<h2 data-id="heading-13">博客文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tore.moe%2Fposts%2Fsvgfmt-instruction" target="_blank" title="https://www.tore.moe/posts/svgfmt-instruction" ref="nofollow noopener noreferrer">使用 svgfmt 优化 SVG 图标</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8.Kotlin 类：类的基础：主构造函数与次构造函数]]></title>    <link>https://juejin.cn/post/7576175307352522767</link>    <guid>https://juejin.cn/post/7576175307352522767</guid>    <pubDate>2025-11-24T09:12:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307352522767" data-draft-id="7576175307352506383" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8.Kotlin 类：类的基础：主构造函数与次构造函数"/> <meta itemprop="keywords" content="Android,Kotlin,后端"/> <meta itemprop="datePublished" content="2025-11-24T09:12:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8.Kotlin 类：类的基础：主构造函数与次构造函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:12:06.000Z" title="Mon Nov 24 2025 09:12:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 类与构造函数的核心作用</h3>
<p>在面向对象编程体系中，<strong>类</strong>是对一类事物共同属性和行为的抽象描述，相当于创建对象的“模板”。例如“Person”类可抽象人类的“姓名、年龄”等属性和“说话、行走”等行为。而<strong>对象</strong>则是类的具体实例，是模板的“实体化产物”，比如通过“Person”类创建的“张三”“李四”。</p>
<p>构造函数作为类的特殊成员，核心职责是<strong>初始化对象</strong>——在创建对象时为属性赋值、执行必要的初始化逻辑（如参数校验、资源加载），确保对象创建后处于可用状态。没有构造函数，对象的属性可能处于未定义的无效状态，无法正常使用。</p>
<h3 data-id="heading-2">1.2 Kotlin 构造函数的特点</h3>
<p>相较于 Java 等传统面向对象语言，Kotlin 构造函数设计更简洁、灵活，核心特点体现在两方面：</p>
<ul>
<li><strong>语法极致简洁</strong>：支持在类名后直接定义主构造函数，无需单独编写函数体；可通过“val/var”关键字将构造参数直接声明为类属性，省去手动定义属性和赋值的冗余代码。</li>
<li><strong>主/次构造分离</strong>：将构造函数分为“主构造函数”和“次构造函数”，主构造承担核心初始化逻辑，次构造作为辅助补充，适配多样化实例化场景，同时通过委托机制保证初始化逻辑统一。</li>
</ul>
<h3 data-id="heading-3">1.3 本文核心内容预告</h3>
<p>本文将遵循“基础认知→核心详解→关联分析→实践应用→总结建议”的逻辑展开：首先解析主构造函数的语法、初始化方式及实例；接着讲解次构造函数的定义规则、适用场景及示例；然后深入分析主/次构造函数的委托关系、初始化顺序和参数传递逻辑；再结合实际开发场景说明两者的应用场景；最后总结核心知识点、避坑要点及选择技巧，帮助读者高效掌握 Kotlin 构造函数的使用。</p>
<h2 data-id="heading-4">二、主构造函数：类的核心初始化入口</h2>
<p>主构造函数是 Kotlin 类的“默认初始化入口”，承担类的核心初始化逻辑，是最常用的构造函数类型，其设计初衷是简化常规场景下的对象创建流程。</p>
<h3 data-id="heading-5">2.1 基本语法</h3>
<p>Kotlin 主构造函数的语法极为简洁，直接在类名后通过“()”定义参数列表，无需像 Java 那样单独编写构造方法体。基本语法格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基础语法：类名后紧跟主构造参数列表</span>
<span class="hljs-keyword">class</span> 类名(参数<span class="hljs-number">1</span>: 类型<span class="hljs-number">1</span>, 参数<span class="hljs-number">2</span>: 类型<span class="hljs-number">2</span>, ...) {
    <span class="hljs-comment">// 类体：包含属性、方法、初始化块等</span>
}

<span class="hljs-comment">// 含访问修饰符的语法（如私有主构造）</span>
<span class="hljs-keyword">class</span> 类名 <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(参数<span class="hljs-number">1</span>: 类型<span class="hljs-number">1</span>, 参数<span class="hljs-number">2</span>: 类型<span class="hljs-number">2</span>) {
    <span class="hljs-comment">// 类体</span>
}

</code></pre>
<p>语法说明：</p>
<ul>
<li>参数列表格式为“参数名: 类型”，多个参数用逗号分隔，用于接收对象创建时传入的初始化数据；</li>
<li>若类体无逻辑，花括号可省略，如“class Person(name: String, age: Int)”；</li>
<li>当主构造需要添加访问修饰符（如 private）时，必须显式添加“constructor”关键字，否则默认公开。</li>
</ul>
<p>示例：定义“Person”类，主构造接收“姓名”和“年龄”参数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简单主构造函数示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(name: String, age: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 类体可后续添加属性和方法</span>
}

</code></pre>
<h3 data-id="heading-6">2.2 简洁初始化</h3>
<p>主构造函数的核心优势是“简洁初始化”，通过“val/var”修饰参数可直接将其声明为类成员属性，同时支持为参数设置默认值实现“可选参数”，大幅简化代码。</p>
<h4 data-id="heading-7">2.2.1 直接声明属性</h4>
<p>若构造参数需要作为类的属性被外部访问或内部使用，只需在参数前添加“val”（只读属性）或“var”（可读写属性），Kotlin 会自动完成属性定义和赋值。示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 主构造参数直接声明为类属性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 类方法使用属性</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">introduce</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"我叫<span class="hljs-variable">$name</span>，今年<span class="hljs-variable">$age</span> 岁"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建对象时直接传入参数初始化属性</span>
    <span class="hljs-keyword">val</span> zhangsan = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>)
    println(zhangsan.name) <span class="hljs-comment">// 输出：张三（val修饰，只读）</span>
    zhangsan.age = <span class="hljs-number">26</span> <span class="hljs-comment">// var修饰，可修改</span>
    zhangsan.introduce() <span class="hljs-comment">// 输出：我叫张三，今年26 岁</span>
}

</code></pre>
<p>解析：通过“val name”和“var age”将构造参数直接声明为属性，创建对象时传入的参数会自动赋值给属性，无需像 Java 那样单独定义“private String name”再通过构造函数赋值，代码精简效果显著。</p>
<h4 data-id="heading-8">2.2.2 设置默认值</h4>
<p>为构造参数设置默认值后，创建对象时可选择性传入该参数（传入则覆盖默认值，不传入则使用默认值），实现“按需初始化”。语法格式为“参数名: 类型 = 默认值”，示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 主构造参数设置默认值</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">18</span>) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">introduce</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"我叫<span class="hljs-variable">$name</span>，今年<span class="hljs-variable">$age</span> 岁"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 传入所有参数（覆盖默认值）</span>
    <span class="hljs-keyword">val</span> zhangsan = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>)
    zhangsan.introduce() <span class="hljs-comment">// 输出：我叫张三，今年25 岁</span>

    <span class="hljs-comment">// 2. 只传入无默认值的参数（使用age默认值18）</span>
    <span class="hljs-keyword">val</span> lisi = Person(<span class="hljs-string">"李四"</span>)
    lisi.introduce() <span class="hljs-comment">// 输出：我叫李四，今年18 岁</span>

    <span class="hljs-comment">// 3. 按参数名传入，灵活调整顺序</span>
    <span class="hljs-keyword">val</span> wangwu = Person(age = <span class="hljs-number">30</span>, name = <span class="hljs-string">"王五"</span>)
    wangwu.introduce() <span class="hljs-comment">// 输出：我叫王五，今年30 岁</span>
}

</code></pre>
<p>解析：“age”参数默认值为 18，创建对象时可传可不传；按参数名传入时可打破参数顺序限制，尤其适合参数较多的场景，提升代码可读性。</p>
<h3 data-id="heading-9">2.3 初始化块</h3>
<p>主构造函数本身没有函数体，无法编写复杂初始化逻辑（如参数校验、数据转换、资源加载）。Kotlin 提供**初始化块（Initializer Block）**解决这一问题，通过“init”关键字定义，用于补充主构造函数的初始化逻辑。</p>
<h4 data-id="heading-10">2.3.1 基本语法与执行时机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> 类名(参数列表) {
    <span class="hljs-comment">// 初始化块：补充初始化逻辑</span>
    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 初始化代码（参数校验、数据转换等）</span>
    }

    <span class="hljs-comment">// 多个初始化块按顺序执行</span>
    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 第二个初始化块逻辑</span>
    }
}

</code></pre>
<p>执行时机：<strong>创建对象时，初始化块会在主构造参数初始化后立即执行</strong>；若有多个初始化块，按代码定义顺序依次执行。</p>
<h4 data-id="heading-11">2.3.2 实用示例</h4>
<p>示例 1：参数校验（确保对象创建的合法性）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 初始化块：校验参数合法性</span>
    <span class="hljs-keyword">init</span> {
        require(name.isNotBlank()) { <span class="hljs-string">"姓名不能为空！"</span> } <span class="hljs-comment">// 非空校验</span>
        require(age <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.150</span>) { <span class="hljs-string">"年龄必须在0-150之间！"</span> } <span class="hljs-comment">// 范围校验</span>
        println(<span class="hljs-string">"Person对象初始化完成：name=<span class="hljs-variable">$name</span>, age=<span class="hljs-variable">$age</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 合法参数：正常初始化</span>
    <span class="hljs-keyword">val</span> zhangsan = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>) <span class="hljs-comment">// 输出：Person对象初始化完成：name=张三, age=25</span>

    <span class="hljs-comment">// 非法参数：抛出异常</span>
    <span class="hljs-comment">// val lisi = Person("", 20) // 抛出IllegalArgumentException: 姓名不能为空！</span>
    <span class="hljs-comment">// val wangwu = Person("王五", 200) // 抛出IllegalArgumentException: 年龄必须在0-150之间！</span>
}

</code></pre>
<p>示例 2：数据转换（处理参数格式适配）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, ageStr: String) {
    <span class="hljs-comment">// 类属性：存储转换后的整数年龄</span>
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>

    <span class="hljs-comment">// 初始化块：将字符串年龄转换为整数</span>
    <span class="hljs-keyword">init</span> {
        require(name.isNotBlank()) { <span class="hljs-string">"姓名不能为空！"</span> }
        <span class="hljs-comment">// 转换失败则抛出异常</span>
        age = ageStr.toIntOrNull() ?: <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"年龄必须是整数！"</span>)
        require(age <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.150</span>) { <span class="hljs-string">"年龄必须在0-150之间！"</span> }
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> zhangsan = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"25"</span>)
    println(<span class="hljs-string">"<span class="hljs-subst">${zhangsan.name}</span> 的年龄是 <span class="hljs-subst">${zhangsan.age}</span>"</span>) <span class="hljs-comment">// 输出：张三 的年龄是 25</span>

    <span class="hljs-comment">// 非法参数：抛出异常</span>
    <span class="hljs-comment">// val lisi = Person("李四", "abc") // 抛出IllegalArgumentException: 年龄必须是整数！</span>
}

</code></pre>
<p>解析：主构造参数“ageStr”未用“val/var”修饰，仅作为临时参数；在初始化块中将其转换为整数后赋值给类属性“age”，实现参数格式适配。</p>
<h3 data-id="heading-12">2.4 简单示例</h3>
<p>综合以上知识点，通过“Book”类展示主构造函数的完整使用流程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 书籍类：主构造包含核心属性
 * title：书名（只读，必填）
 * author：作者（只读，必填）
 * price：价格（可读写，默认39.9）
 * category：分类（只读，默认"未知"）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>(
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> author: String,
    <span class="hljs-keyword">var</span> price: <span class="hljs-built_in">Double</span> = <span class="hljs-number">39.9</span>,
    <span class="hljs-keyword">val</span> category: String = <span class="hljs-string">"未知"</span>
) {
    <span class="hljs-comment">// 初始化块1：参数校验</span>
    <span class="hljs-keyword">init</span> {
        require(title.isNotBlank()) { <span class="hljs-string">"书名不能为空！"</span> }
        require(author.isNotBlank()) { <span class="hljs-string">"作者不能为空！"</span> }
        require(price &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"价格必须大于0！"</span> }
    }

    <span class="hljs-comment">// 初始化块2：打印初始化信息</span>
    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"书籍初始化完成：《<span class="hljs-variable">$title</span>》（<span class="hljs-variable">$author</span>），分类：<span class="hljs-variable">$category</span>，价格：<span class="hljs-variable">$price</span> 元"</span>)
    }

    <span class="hljs-comment">// 类方法：修改价格</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updatePrice</span><span class="hljs-params">(newPrice: <span class="hljs-type">Double</span>)</span></span> {
        require(newPrice &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"新价格必须大于0！"</span> }
        price = newPrice
        println(<span class="hljs-string">"价格更新为：<span class="hljs-variable">$newPrice</span> 元"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 传入所有参数</span>
    <span class="hljs-keyword">val</span> book1 = Book(<span class="hljs-string">"Kotlin从入门到精通"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-number">59.9</span>, <span class="hljs-string">"编程"</span>)
    book1.updatePrice(<span class="hljs-number">49.9</span>) <span class="hljs-comment">// 输出：价格更新为：49.9 元</span>

    <span class="hljs-comment">// 2. 传入必填参数（使用默认值）</span>
    <span class="hljs-keyword">val</span> book2 = Book(<span class="hljs-string">"Java核心技术"</span>, <span class="hljs-string">"李四"</span>)
    <span class="hljs-comment">// 输出：书籍初始化完成：《Java核心技术》（李四），分类：未知，价格：39.9 元</span>

    <span class="hljs-comment">// 3. 按参数名传入（灵活调整顺序）</span>
    <span class="hljs-keyword">val</span> book3 = Book(
        title = <span class="hljs-string">"Python编程实践"</span>,
        author = <span class="hljs-string">"王五"</span>,
        category = <span class="hljs-string">"编程"</span>,
        price = <span class="hljs-number">69.9</span>
    )
}

</code></pre>
<h2 data-id="heading-13">三、次构造函数：灵活的辅助初始化方式</h2>
<p>主构造函数适用于“参数固定、场景单一”的初始化场景，而实际开发中常需要“多样化参数组合”“兼容旧逻辑”等灵活需求。Kotlin 的<strong>次构造函数</strong>作为辅助初始化方式，可适配这些复杂场景，同时通过委托机制保证核心逻辑统一。</p>
<h3 data-id="heading-14">3.1 基本语法</h3>
<p>次构造函数通过“constructor”关键字定义，位于类体内部，必须通过“: this(...)”委托给主构造函数或其他次构造函数。基本语法格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> 类名(主构造参数列表) {
    <span class="hljs-comment">// 次构造函数1：委托给主构造函数</span>
    <span class="hljs-keyword">constructor</span>(参数列表<span class="hljs-number">1</span>) : <span class="hljs-keyword">this</span>(主构造参数映射逻辑) {
        <span class="hljs-comment">// 次构造专属初始化逻辑（可选）</span>
    }

    <span class="hljs-comment">// 次构造函数2：委托给其他次构造函数</span>
    <span class="hljs-keyword">constructor</span>(参数列表<span class="hljs-number">2</span>) : <span class="hljs-keyword">this</span>(参数列表<span class="hljs-number">1</span>映射逻辑) {
        <span class="hljs-comment">// 次构造专属初始化逻辑（可选）</span>
    }
}

</code></pre>
<p>语法说明：</p>
<ul>
<li>“constructor”是次构造函数的标识，不可省略；</li>
<li>“: this(...)”是委托语句，必须存在——次构造函数不能独立初始化，最终需委托到主构造函数；</li>
<li>花括号内是次构造专属逻辑，仅在通过该次构造创建对象时执行。</li>
</ul>
<h3 data-id="heading-15">3.2 核心规则</h3>
<p>次构造函数的核心规则是<strong>必须委托</strong>，即所有次构造函数最终都要委托到主构造函数，形成“次→主”或“次→次→主”的委托链。这一规则的本质是“保证主构造函数的核心初始化逻辑（参数校验、属性赋值）在所有场景下都被执行”，避免不同构造函数导致的对象状态不一致。</p>
<h4 data-id="heading-16">3.2.1 委托给主构造函数（最常用）</h4>
<p>次构造函数直接通过“this(主构造参数)”委托给主构造函数，示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> gender: String) {
    <span class="hljs-comment">// 初始化块：主构造核心逻辑</span>
    <span class="hljs-keyword">init</span> {
        require(name.isNotBlank()) { <span class="hljs-string">"姓名不能为空！"</span> }
        require(age <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.150</span>) { <span class="hljs-string">"年龄必须在0-150之间！"</span> }
        println(<span class="hljs-string">"主构造初始化完成：<span class="hljs-variable">$name</span>（<span class="hljs-variable">$age</span> 岁，<span class="hljs-variable">$gender</span>）"</span>)
    }

    <span class="hljs-comment">// 次构造1：无参数，委托主构造（传默认值）</span>
    <span class="hljs-keyword">constructor</span>() : <span class="hljs-keyword">this</span>(<span class="hljs-string">"匿名"</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"未知"</span>) {
        println(<span class="hljs-string">"无参次构造执行：创建默认对象"</span>)
    }

    <span class="hljs-comment">// 次构造2：双参数，委托主构造（性别默认）</span>
    <span class="hljs-keyword">constructor</span>(name: String, age: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">this</span>(name, age, <span class="hljs-string">"未知"</span>) {
        println(<span class="hljs-string">"双参次构造执行：性别默认未知"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"=== 无参次构造创建 ==="</span>)
    <span class="hljs-keyword">val</span> person1 = Person()
    <span class="hljs-comment">// 输出：主构造初始化完成：匿名（0 岁，未知）→ 无参次构造执行：创建默认对象</span>

    println(<span class="hljs-string">"=== 双参次构造创建 ==="</span>)
    <span class="hljs-keyword">val</span> person2 = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>)
    <span class="hljs-comment">// 输出：主构造初始化完成：张三（25 岁，未知）→ 双参次构造执行：性别默认未知</span>
}

</code></pre>
<h4 data-id="heading-17">3.2.2 委托给其他次构造函数（链式委托）</h4>
<p>次构造函数委托给另一个次构造函数，再由该次构造委托给主构造函数，形成链式委托，示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> gender: String) {
    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"主构造初始化：<span class="hljs-variable">$name</span>（<span class="hljs-variable">$age</span>，<span class="hljs-variable">$gender</span>）"</span>)
    }

    <span class="hljs-comment">// 次构造3：双参数→委托主构造</span>
    <span class="hljs-keyword">constructor</span>(name: String, age: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">this</span>(name, age, <span class="hljs-string">"未知"</span>) {
        println(<span class="hljs-string">"双参次构造执行"</span>)
    }

    <span class="hljs-comment">// 次构造2：单参数→委托次构造3</span>
    <span class="hljs-keyword">constructor</span>(name: String) : <span class="hljs-keyword">this</span>(name, <span class="hljs-number">18</span>) {
        println(<span class="hljs-string">"单参次构造执行"</span>)
    }

    <span class="hljs-comment">// 次构造1：无参数→委托次构造2</span>
    <span class="hljs-keyword">constructor</span>() : <span class="hljs-keyword">this</span>(<span class="hljs-string">"匿名"</span>) {
        println(<span class="hljs-string">"无参次构造执行"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> person = Person()
    <span class="hljs-comment">// 输出顺序：主构造初始化→双参次构造执行→单参次构造执行→无参次构造执行</span>
}

</code></pre>
<h3 data-id="heading-18">3.3 适用场景</h3>
<p>次构造函数的核心价值是“适配多样化初始化场景”，常见适用场景包括：</p>
<h4 data-id="heading-19">3.3.1 多参数组合需求</h4>
<p>当创建对象需要支持“不同数量、不同类型参数”时，通过次构造函数提供多个入口。例如“User”类需要支持：1. 用户名+密码登录；2. 用户名+密码+手机号注册；3. 第三方登录（如微信openId）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> username: String, <span class="hljs-keyword">val</span> password: String, <span class="hljs-keyword">val</span> phone: String?) {
    <span class="hljs-keyword">init</span> {
        require(username.isNotBlank()) { <span class="hljs-string">"用户名不能为空！"</span> }
        require(password.length &gt;= <span class="hljs-number">6</span>) { <span class="hljs-string">"密码长度不能小于6位！"</span> }
    }

    <span class="hljs-comment">// 场景1：用户名+密码（手机号为空）</span>
    <span class="hljs-keyword">constructor</span>(username: String, password: String) : <span class="hljs-keyword">this</span>(username, password, <span class="hljs-literal">null</span>)

    <span class="hljs-comment">// 场景2：微信登录（自动生成用户名和密码）</span>
    <span class="hljs-keyword">constructor</span>(wechatOpenId: String) : <span class="hljs-keyword">this</span>(
        username = <span class="hljs-string">"wechat_<span class="hljs-variable">$wechatOpenId</span>"</span>,
        password = generateRandomPwd(),
        phone = <span class="hljs-literal">null</span>
    )

    <span class="hljs-comment">// 辅助方法：生成随机密码</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateRandomPwd</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> chars = <span class="hljs-string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-number">1.</span><span class="hljs-number">.8</span>).map { chars.random() }.joinToString(<span class="hljs-string">""</span>)
    }
}

</code></pre>
<h4 data-id="heading-20">3.3.2 兼容旧逻辑或第三方接口</h4>
<p>项目迭代或对接第三方时，需兼容旧参数格式。例如旧系统“Order”类用“整数状态码”（0=待支付，1=已支付），新系统用“字符串状态”，通过次构造函数适配。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 新系统主构造：状态为字符串</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-keyword">val</span> orderNo: String, <span class="hljs-keyword">val</span> amount: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">val</span> status: String) {
    <span class="hljs-keyword">init</span> {
        require(orderNo.isNotBlank()) { <span class="hljs-string">"订单号不能为空！"</span> }
        require(amount &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"金额必须大于0！"</span> }
    }

    <span class="hljs-comment">// 次构造：兼容旧系统整数状态码</span>
    <span class="hljs-keyword">constructor</span>(orderNo: String, amount: <span class="hljs-built_in">Double</span>, statusCode: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">this</span>(
        orderNo = orderNo,
        amount = amount,
        status = <span class="hljs-keyword">when</span> (statusCode) {
            <span class="hljs-number">0</span> -&gt; <span class="hljs-string">"待支付"</span>
            <span class="hljs-number">1</span> -&gt; <span class="hljs-string">"已支付"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"状态码不合法！"</span>)
        }
    )
}

</code></pre>
<h3 data-id="heading-21">3.4 简单示例</h3>
<p>通过“Student”类展示多个次构造函数的使用，适配不同创建场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 学生类：主构造包含核心属性
 * id：学号（必填）
 * name：姓名（必填）
 * grade：年级（必填）
 * score：平均分（默认60.0）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> grade: String,
    <span class="hljs-keyword">var</span> score: <span class="hljs-built_in">Double</span> = <span class="hljs-number">60.0</span>
) {
    <span class="hljs-keyword">init</span> {
        require(id.isNotBlank()) { <span class="hljs-string">"学号不能为空！"</span> }
        require(name.isNotBlank()) { <span class="hljs-string">"姓名不能为空！"</span> }
    }

    <span class="hljs-comment">// 次构造1：无参（测试用，生成默认学生）</span>
    <span class="hljs-keyword">constructor</span>() : <span class="hljs-keyword">this</span>(
        id = <span class="hljs-string">"TEST_<span class="hljs-subst">${System.currentTimeMillis()}</span>"</span>,
        name = <span class="hljs-string">"测试学生"</span>,
        grade = <span class="hljs-string">"高一"</span>
    )

    <span class="hljs-comment">// 次构造2：三参数（使用默认平均分）</span>
    <span class="hljs-keyword">constructor</span>(id: String, name: String, grade: String) : <span class="hljs-keyword">this</span>(id, name, grade, <span class="hljs-number">60.0</span>)

    <span class="hljs-comment">// 次构造3：四参数（分数字符串转Double）</span>
    <span class="hljs-keyword">constructor</span>(id: String, name: String, grade: String, scoreStr: String) : <span class="hljs-keyword">this</span>(
        id = id,
        name = name,
        grade = grade,
        score = scoreStr.toDoubleOrNull() ?: <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"分数必须是数字！"</span>)
    )

    <span class="hljs-comment">// 展示学生信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"学号：<span class="hljs-variable">$id</span>，姓名：<span class="hljs-variable">$name</span>，年级：<span class="hljs-variable">$grade</span>，平均分：<span class="hljs-variable">$score</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 无参次构造</span>
    Student().showInfo()
    <span class="hljs-comment">// 2. 三参数次构造</span>
    Student(<span class="hljs-string">"2024001"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"高一"</span>).showInfo()
    <span class="hljs-comment">// 3. 四参数次构造（字符串分数）</span>
    Student(<span class="hljs-string">"2024002"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"高二"</span>, <span class="hljs-string">"85.5"</span>).showInfo()
}

</code></pre>
<h2 data-id="heading-22">四、主构造函数与次构造函数的关联</h2>
<p>主构造函数和次构造函数并非独立存在，而是通过“委托关系”“初始化顺序”“参数传递”形成紧密关联，理解这些关联是正确使用构造函数的关键。</p>
<h3 data-id="heading-23">4.1 委托关系</h3>
<p>Kotlin 规定：<strong>所有次构造函数最终必须委托到主构造函数</strong>，形成“委托链”。这一规则的核心目的是“保证主构造函数的核心逻辑（参数校验、属性赋值）在任何初始化场景下都被执行”，避免对象状态不一致。</p>
<p>委托关系的两种形式：</p>
<ol>
<li><strong>直接委托</strong>：次构造→主构造，如“constructor(name: String) : this(name, 18)”；</li>
<li><strong>间接委托</strong>：次构造→次构造→...→主构造，如“constructor() : this("匿名") → constructor(name: String) : this(name, 18)”。</li>
</ol>
<p>强制要求：若类显式定义主构造函数，所有次构造函数必须显式委托，否则编译报错。例如以下代码编译失败：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 编译失败：次构造未委托主构造</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String) {
    <span class="hljs-comment">// 错误：缺少委托语句</span>
    <span class="hljs-keyword">constructor</span>(age: <span class="hljs-built_in">Int</span>) { }
}

</code></pre>
<h3 data-id="heading-24">4.2 初始化顺序</h3>
<p>通过次构造函数创建对象时，初始化逻辑的执行顺序是固定的，遵循“<strong>主构造参数初始化 → 初始化块（按顺序） → 次构造函数体</strong>”的规则。这一顺序决定了“哪些逻辑先执行，哪些属性可使用”。</p>
<h4 data-id="heading-25">4.2.1 执行顺序示例验证</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 初始化块1</span>
    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"init块1：name=<span class="hljs-variable">$name</span>，age=<span class="hljs-variable">$age</span>"</span>)
    }

    <span class="hljs-comment">// 类属性</span>
    <span class="hljs-keyword">val</span> gender: String = <span class="hljs-string">"未知"</span>

    <span class="hljs-comment">// 初始化块2</span>
    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"init块2：gender=<span class="hljs-variable">$gender</span>"</span>)
    }

    <span class="hljs-comment">// 次构造函数</span>
    <span class="hljs-keyword">constructor</span>(name: String) : <span class="hljs-keyword">this</span>(name, <span class="hljs-number">18</span>) {
        println(<span class="hljs-string">"次构造体执行：默认年龄18"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"张三"</span>)
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-ini" lang="ini">init块1：<span class="hljs-attr">name</span>=张三，age=<span class="hljs-number">18</span>
init块2：<span class="hljs-attr">gender</span>=未知
次构造体执行：默认年龄18

</code></pre>
<p>解析：执行顺序完全遵循规则，先完成主构造参数初始化和初始化块逻辑，再执行次构造体，确保次构造体可使用所有已初始化的属性。</p>
<h3 data-id="heading-26">4.3 参数传递</h3>
<p>次构造函数向主构造函数传递参数是委托关系的核心，本质是“将次构造的输入参数转换为主构造所需参数”，常见传递方式有三种：</p>
<h4 data-id="heading-27">4.3.1 直接传递</h4>
<p>次构造参数与主构造参数一一对应，直接传入。示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> gender: String) {
    <span class="hljs-comment">// 次构造参数直接传递给主构造</span>
    <span class="hljs-keyword">constructor</span>(name: String, age: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">this</span>(name, age, <span class="hljs-string">"未知"</span>)
}

</code></pre>
<h4 data-id="heading-28">4.3.2 默认值填充</h4>
<p>次构造参数不足时，为缺失参数填充默认值后传递。示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>(<span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> author: String, <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span> = <span class="hljs-number">39.9</span>) {
    <span class="hljs-comment">// 无参次构造：填充所有默认值</span>
    <span class="hljs-keyword">constructor</span>() : <span class="hljs-keyword">this</span>(<span class="hljs-string">"未知书名"</span>, <span class="hljs-string">"未知作者"</span>)
}

</code></pre>
<h4 data-id="heading-29">4.3.3 数据转换</h4>
<p>次构造参数类型与主构造不一致时，先转换再传递。示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>, <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-comment">// 次构造：字符串id转Long，整数价格转Double</span>
    <span class="hljs-keyword">constructor</span>(idStr: String, priceInt: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">this</span>(
        id = idStr.toLong(),
        price = priceInt.toDouble()
    )
}

</code></pre>
<h2 data-id="heading-30">五、实用场景举例</h2>
<p>结合实际开发场景，说明主、次构造函数的合理搭配使用。</p>
<h3 data-id="heading-31">5.1 主构造函数场景：常规实体类初始化</h3>
<p>数据库实体类、接口返回数据模型等场景，通常需要将外部数据直接映射为类属性，初始化逻辑简单，适合用主构造函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Date

<span class="hljs-comment">/**
 * 订单实体类：映射数据库order表
 * 字段与主构造参数一一对应，通过初始化块校验参数
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEntity</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> amount: <span class="hljs-built_in">Double</span>,
    <span class="hljs-keyword">val</span> createTime: Date,
    <span class="hljs-keyword">val</span> status: String
) {
    <span class="hljs-keyword">init</span> {
        require(id &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"订单ID必须大于0！"</span> }
        require(userId &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"用户ID必须大于0！"</span> }
        require(amount &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"金额必须大于0！"</span> }
        require(status <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"待支付"</span>, <span class="hljs-string">"已支付"</span>, <span class="hljs-string">"已取消"</span>)) { <span class="hljs-string">"状态不合法！"</span> }
    }
}

<span class="hljs-comment">// 使用：接口返回数据直接构造对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> order = OrderEntity(
        id = <span class="hljs-number">10001</span>,
        userId = <span class="hljs-number">101</span>,
        amount = <span class="hljs-number">199.9</span>,
        createTime = Date(),
        status = <span class="hljs-string">"待支付"</span>
    )
}

</code></pre>
<p>解析：数据模型类的核心需求是“属性映射”和“参数校验”，主构造函数的简洁语法和初始化块的校验能力完美适配，代码清晰高效。</p>
<h3 data-id="heading-32">5.2 次构造函数场景：多场景初始化适配</h3>
<p>工具类、第三方集成类等需要适配多种创建方式的场景，适合用“主构造+次构造”组合。例如“Excel导出工具类”需要支持：1. 指定文件路径；2. 指定输出流；3. 默认路径。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.io.OutputStream

<span class="hljs-comment">/**
 * Excel导出工具类
 * 主构造：接收输出流（核心初始化方式）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelExporter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> outputStream: OutputStream) {
    <span class="hljs-comment">// 初始化块：校验输出流</span>
    <span class="hljs-keyword">init</span> {
        require(outputStream != <span class="hljs-literal">null</span>) { <span class="hljs-string">"输出流不能为null！"</span> }
    }

    <span class="hljs-comment">// 次构造1：指定文件路径（转换为输出流）</span>
    <span class="hljs-keyword">constructor</span>(filePath: String) : <span class="hljs-keyword">this</span>(java.io.FileOutputStream(filePath))

    <span class="hljs-comment">// 次构造2：默认路径（项目根目录excel导出.xlsx）</span>
    <span class="hljs-keyword">constructor</span>() : <span class="hljs-keyword">this</span>(<span class="hljs-string">"<span class="hljs-subst">${System.getProperty(<span class="hljs-string">"user.dir"</span>)}</span>/excel导出.xlsx"</span>)

    <span class="hljs-comment">// 导出方法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">export</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Any&gt;&gt;)</span></span> {
        <span class="hljs-comment">// 导出逻辑：使用outputStream写入数据</span>
        println(<span class="hljs-string">"使用<span class="hljs-subst">${outputStream}</span>导出数据，共<span class="hljs-subst">${data.size}</span>条"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = listOf(mapOf(<span class="hljs-string">"name"</span> to <span class="hljs-string">"张三"</span>, <span class="hljs-string">"age"</span> to <span class="hljs-number">25</span>))
    <span class="hljs-comment">// 1. 默认路径导出</span>
    ExcelExporter().export(<span class="hljs-keyword">data</span>)
    <span class="hljs-comment">// 2. 指定路径导出</span>
    ExcelExporter(<span class="hljs-string">"D:/data.xlsx"</span>).export(<span class="hljs-keyword">data</span>)
    <span class="hljs-comment">// 3. 指定输出流导出</span>
    ExcelExporter(System.<span class="hljs-keyword">out</span>).export(<span class="hljs-keyword">data</span>)
}

</code></pre>
<p>解析：主构造函数接收核心依赖“输出流”，保证核心逻辑统一；次构造函数适配“文件路径”“默认路径”等场景，通过参数转换委托给主构造，既灵活又保证一致性。</p>
<h2 data-id="heading-33">六、总结与使用建议</h2>
<p>Kotlin 主/次构造函数的设计核心是“简洁高效+灵活适配”，掌握两者的使用技巧可大幅提升对象初始化的代码质量。</p>
<h3 data-id="heading-34">6.1 核心知识点回顾</h3>

























<table><thead><tr><th><strong>类型</strong></th><th><strong>核心语法</strong></th><th><strong>核心规则</strong></th></tr></thead><tbody><tr><td>主构造函数</td><td>类名后括号定义参数，val/var声明属性</td><td>核心初始化入口，可通过init块补充逻辑</td></tr><tr><td>次构造函数</td><td>constructor关键字定义，: this(...)委托</td><td>必须委托到主构造，适配多样化场景</td></tr><tr><td>关联关系</td><td>委托链、固定初始化顺序、参数映射传递</td><td>次构造最终委托主构造，保证逻辑统一</td></tr></tbody></table>
<h3 data-id="heading-35">6.2 避坑点</h3>
<ul>
<li><strong>委托遗漏</strong>：显式定义主构造后，次构造必须委托，否则编译报错；</li>
<li><strong>初始化顺序错误</strong>：init块执行时次构造体未执行，不可在init块中依赖次构造体的逻辑；</li>
<li><strong>参数未声明为属性</strong>：主构造参数未加val/var时，仅为临时参数，类内部不可长期使用；</li>
<li><strong>默认值位置错误</strong>：有默认值的参数需放在无默认值参数之后，否则编译报错（如“class Person(age: Int = 18, name: String)”错误）。</li>
</ul>
<h3 data-id="heading-36">6.3 选择技巧</h3>
<ol>
<li><strong>优先使用主构造函数</strong>：常规场景（如实体类、数据模型）优先用主构造，通过val/var声明属性，init块补充校验，简洁高效；</li>
<li><strong>复杂场景加次构造</strong>：需要适配多参数组合、兼容旧逻辑、第三方集成等场景时，添加次构造函数，通过委托复用主构造逻辑；</li>
<li><strong>避免过度使用次构造</strong>：若次构造过多（超过3个），可考虑用“建造者模式”替代，提升代码可读性；</li>
<li><strong>私有主构造控制实例化</strong>：需要限制对象创建方式（如单例模式）时，将主构造设为private，通过次构造或静态方法控制实例化。</li>
</ol>
<p>总之，Kotlin 构造函数的使用核心是“主构造定核心，次构造补灵活”，结合实际场景合理搭配，可写出简洁、高效、易维护的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[9.Kotlin 类：类的核心：属性 (Property) 与自定义访问器 (Getter/Setter)]]></title>    <link>https://juejin.cn/post/7575910298283261987</link>    <guid>https://juejin.cn/post/7575910298283261987</guid>    <pubDate>2025-11-24T09:13:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283261987" data-draft-id="7575897635137191936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="9.Kotlin 类：类的核心：属性 (Property) 与自定义访问器 (Getter/Setter)"/> <meta itemprop="keywords" content="Android,Kotlin,后端"/> <meta itemprop="datePublished" content="2025-11-24T09:13:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            9.Kotlin 类：类的核心：属性 (Property) 与自定义访问器 (Getter/Setter)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:13:51.000Z" title="Mon Nov 24 2025 09:13:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 类属性的核心作用</h3>
<p>在面向对象编程体系中，<strong>类属性</strong>是刻画对象本质的核心要素，其核心作用是<strong>存储对象的状态信息并描述对象的固有特征</strong>。如果将类比作创建对象的“蓝图”，那么属性就是蓝图中定义的“数据插槽”，每个对象通过这些插槽存储自身独有的数据。例如“Person”类的“name”“age”属性，可精准存储具体人物的姓名与年龄；“Book”类的“title”“author”“price”属性，能清晰描述一本书的核心特征。缺少属性的类无法承载对象的状态，面向对象的抽象性与封装性也无从谈起。</p>
<h3 data-id="heading-2">1.2 Kotlin 属性的特点</h3>
<p>相较于 Java 中“字段（Field）+ 访问器（Getter/Setter）”的分离式设计，Kotlin 的属性设计实现了“简洁性”与“灵活性”的统一，核心特点体现在两方面：</p>
<ul>
<li><strong>默认访问器自动生成</strong>：定义属性时，Kotlin 会根据属性可变性（var/val）自动生成对应的 Getter（读取方法）和 Setter（修改方法），无需像 Java 那样手动编写冗余的访问器代码。例如定义“var age: Int”，Kotlin 会自动生成“getAge()”和“setAge()”方法，大幅简化开发流程；</li>
<li><strong>支持灵活自定义访问器</strong>：当默认访问器无法满足业务需求（如数据校验、动态计算、格式转换等）时，可直接在属性定义中重写 Getter 或 Setter 逻辑，既保留了语法简洁性，又能适配复杂场景。</li>
</ul>
<h3 data-id="heading-3">1.3 本文核心内容预告</h3>
<p>本文将围绕 Kotlin 类的“属性”与“访问器”展开系统讲解，遵循“基础认知→原理剖析→实践应用→总结升华”的逻辑脉络：首先从属性的基本定义语法、可变与只读属性的区别入手，掌握属性的默认行为；接着深入解析访问器（Getter/Setter）的核心原理，理解属性读写的底层逻辑；然后重点讲解自定义访问器的语法及用法，包括自定义 Getter 实现动态计算、自定义 Setter 实现数据校验等关键场景；之后结合实际开发案例，展示不同访问器用法的适用场景；最后总结核心知识点、避坑要点及优化技巧，帮助读者高效掌握 Kotlin 属性的使用精髓。</p>
<h2 data-id="heading-4">二、类属性基础：定义与默认行为</h2>
<p>Kotlin 的属性是“字段 + 访问器”的封装体，定义时无需显式区分字段和访问器，通过简洁语法即可完成定义，其默认行为已能满足大部分常规开发场景。</p>
<h3 data-id="heading-5">2.1 属性的基本语法</h3>
<p>Kotlin 类属性的定义语法高度凝练，核心由“可变性关键字 + 属性名 + 数据类型 + 默认值”四部分组成，根据场景不同可衍生出多种简化形式，基本格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 完整语法：可变性关键字 + 属性名 + 类型 + 默认值</span>
<span class="hljs-keyword">var</span>/<span class="hljs-keyword">val</span> 属性名: 数据类型 = 默认值

<span class="hljs-comment">// 简化场景1：类型推断（默认值明确时可省略数据类型）</span>
<span class="hljs-keyword">var</span>/<span class="hljs-keyword">val</span> 属性名 = 默认值

<span class="hljs-comment">// 简化场景2：延迟初始化（适用于无法立即赋值的非空引用类型）</span>
<span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> 属性名: 数据类型

<span class="hljs-comment">// 简化场景3：惰性初始化（适用于重量级对象，首次访问时初始化）</span>
<span class="hljs-keyword">val</span> 属性名: 数据类型 <span class="hljs-keyword">by</span> lazy { 初始化逻辑 }

</code></pre>
<p>语法说明：</p>
<ul>
<li><strong>可变性关键字</strong>：“var”（variable 的缩写）表示可变属性，支持读写操作；“val”（value 的缩写）表示只读属性，仅支持读取操作，初始化后不可修改；</li>
<li><strong>数据类型</strong>：指定属性存储的数据类型（如 String、Int、Boolean 等），Kotlin 支持强大的类型推断，若提供默认值且类型明确，可省略数据类型；</li>
<li><strong>默认值</strong>：属性的初始值，若暂时无法赋值（如依赖后续注入），可使用“lateinit”（仅适用于 var 修饰的非空引用类型）或“lazy”（仅适用于 val 修饰的属性）实现延迟初始化；</li>
<li><strong>lateinit 与 lazy 区别</strong>：lateinit 需手动赋值后才能访问，否则抛出未初始化异常；lazy 通过 Lambda 表达式定义初始化逻辑，首次访问时执行且仅执行一次，返回初始化结果。</li>
</ul>
<h3 data-id="heading-6">2.2 可变属性 (var) 与只读属性 (val) 的区别</h3>
<p>“var”和“val”是 Kotlin 区分属性可变性的核心关键字，两者的本质区别体现在“可修改性”“生成的访问器类型”及“底层实现”上，具体对比如下表：</p>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>可变属性（var）</strong></th><th><strong>只读属性（val）</strong></th></tr></thead><tbody><tr><td>可变性</td><td>支持读取和修改操作</td><td>仅支持读取，初始化后不可修改</td></tr><tr><td>默认访问器</td><td>自动生成 Getter 和 Setter 方法</td><td>仅自动生成 Getter 方法，无 Setter 方法</td></tr><tr><td>底层实现（Java 视角）</td><td>对应“私有字段 + getXxx() + setXxx()”</td><td>对应“私有 final 字段 + getXxx()”（字段不可修改）</td></tr><tr><td>适用场景</td><td>对象状态需动态更新的属性（如用户年龄、商品库存）</td><td>对象状态固定不变的属性（如用户 ID、书籍 ISBN、创建时间）</td></tr></tbody></table>
<p>示例：可变属性与只读属性的定义及使用</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义包含可变和只读属性的类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> userId: String,  <span class="hljs-comment">// 只读属性：用户ID一旦生成不可修改</span>
    <span class="hljs-keyword">var</span> userName: String, <span class="hljs-comment">// 可变属性：用户名可修改</span>
    <span class="hljs-keyword">var</span> userAge: <span class="hljs-built_in">Int</span>      <span class="hljs-comment">// 可变属性：年龄可更新</span>
)

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建对象并初始化属性</span>
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"U2024001"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>)

    <span class="hljs-comment">// 读取属性（隐式调用 Getter 方法）</span>
    println(<span class="hljs-string">"用户ID：<span class="hljs-subst">${user.userId}</span>"</span>)    <span class="hljs-comment">// 输出：用户ID：U2024001</span>
    println(<span class="hljs-string">"用户名：<span class="hljs-subst">${user.userName}</span>"</span>)  <span class="hljs-comment">// 输出：用户名：张三</span>

    <span class="hljs-comment">// 修改可变属性（隐式调用 Setter 方法）</span>
    user.userName = <span class="hljs-string">"张三三"</span>
    user.userAge = <span class="hljs-number">26</span>
    println(<span class="hljs-string">"修改后用户名：<span class="hljs-subst">${user.userName}</span>"</span>) <span class="hljs-comment">// 输出：修改后用户名：张三三</span>
    println(<span class="hljs-string">"修改后年龄：<span class="hljs-subst">${user.userAge}</span>"</span>)   <span class="hljs-comment">// 输出：修改后年龄：26</span>

    <span class="hljs-comment">// 尝试修改只读属性：编译报错（val 不可重新赋值）</span>
    <span class="hljs-comment">// user.userId = "U2024002"  // 错误提示：Val cannot be reassigned</span>
}

</code></pre>
<h3 data-id="heading-7">2.3 默认访问器</h3>
<p>Kotlin 的核心特性之一是“<strong>默认访问器自动生成</strong>”，定义属性时无需像 Java 那样手动编写 Getter 和 Setter 方法，编译器会根据属性可变性自动生成对应的访问器，隐藏底层实现细节，简化开发。</p>
<p>默认访问器的生成规则：</p>
<ol>
<li><strong>可变属性（var）</strong>：自动生成一对访问器方法——Getter 用于读取属性值，Setter 用于修改属性值。例如属性“var age: Int”，会生成“getAge(): Int”和“setAge(value: Int)”方法（Java 代码中可见，Kotlin 中隐式调用）；</li>
<li><strong>只读属性（val）</strong>：仅生成 Getter 方法，无 Setter 方法。例如属性“val id: String”，仅生成“getId(): String”方法，确保属性无法被修改。</li>
</ol>
<p>默认访问器的核心逻辑：Getter 方法直接返回属性对应的底层字段值，Setter 方法直接将传入的参数值赋值给底层字段，无额外业务逻辑，适用于“无需数据处理、直接读写”的常规场景。</p>
<p>为更直观理解默认访问器，以下是 Kotlin 代码与对应 Java 代码的对比：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码：需手动定义字段和访问器（冗余）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaBook</span> {
    <span class="hljs-comment">// 私有字段</span>
    <span class="hljs-keyword">private</span> String title;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;

    <span class="hljs-comment">// 手动编写 Getter 方法</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTitle</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> title;
    }

    <span class="hljs-comment">// 手动编写 Setter 方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTitle</span><span class="hljs-params">(String title)</span> {
        <span class="hljs-built_in">this</span>.title = title;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }

    <span class="hljs-comment">// 构造函数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavaBook</span><span class="hljs-params">(String title, <span class="hljs-type">double</span> price)</span> {
        <span class="hljs-built_in">this</span>.title = title;
        <span class="hljs-built_in">this</span>.price = price;
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码：自动生成访问器（简洁）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KotlinBook</span>(
    <span class="hljs-keyword">var</span> title: String,  <span class="hljs-comment">// 自动生成 Getter 和 Setter</span>
    <span class="hljs-keyword">var</span> price: <span class="hljs-built_in">Double</span>   <span class="hljs-comment">// 自动生成 Getter 和 Setter</span>
)

<span class="hljs-comment">// 编译后等价于 JavaBook 类，访问器由编译器自动生成</span>

</code></pre>
<h3 data-id="heading-8">2.4 简单示例</h3>
<p>综合属性定义的基础语法、可变性及默认访问器特性，通过“Book”类展示完整使用流程，包含延迟初始化和惰性初始化的应用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Date

<span class="hljs-comment">/**
 * 书籍类：演示属性定义的多种场景
 * isbn：只读属性（书籍唯一标识，固定不变）
 * title：可变属性（书名可修改）
 * author：可变属性（作者可修改）
 * publishDate：延迟初始化属性（出版日期，后续赋值）
 * publisher：惰性初始化属性（出版社信息，首次访问时初始化）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>(
    <span class="hljs-keyword">val</span> isbn: String,
    <span class="hljs-keyword">var</span> title: String,
    <span class="hljs-keyword">var</span> author: String
) {
    <span class="hljs-comment">// 延迟初始化属性（非空引用类型，需手动赋值后访问）</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> publishDate: Date

    <span class="hljs-comment">// 惰性初始化属性（重量级对象，首次访问时执行初始化逻辑）</span>
    <span class="hljs-keyword">val</span> publisher: String <span class="hljs-keyword">by</span> lazy {
        println(<span class="hljs-string">"初始化出版社信息..."</span>) <span class="hljs-comment">// 仅首次访问时打印</span>
        <span class="hljs-string">"机械工业出版社"</span>
    }

    <span class="hljs-comment">// 类方法：展示书籍信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"ISBN：<span class="hljs-variable">$isbn</span>，书名：<span class="hljs-variable">$title</span>，作者：<span class="hljs-variable">$author</span>"</span>)
        println(<span class="hljs-string">"出版日期：<span class="hljs-variable">$publishDate</span>，出版社：<span class="hljs-variable">$publisher</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 创建对象并初始化必填属性</span>
    <span class="hljs-keyword">val</span> book = Book(
        isbn = <span class="hljs-string">"9787111641247"</span>,
        title = <span class="hljs-string">"Kotlin 编程实战"</span>,
        author = <span class="hljs-string">"张三"</span>
    )

    <span class="hljs-comment">// 2. 延迟初始化属性赋值（必须赋值后才能访问）</span>
    book.publishDate = Date()

    <span class="hljs-comment">// 3. 读取和修改属性（调用默认访问器）</span>
    println(<span class="hljs-string">"修改前书名：<span class="hljs-subst">${book.title}</span>"</span>) <span class="hljs-comment">// 输出：修改前书名：Kotlin 编程实战</span>
    book.title = <span class="hljs-string">"Kotlin 编程实战（第2版）"</span> <span class="hljs-comment">// 调用 Setter 修改</span>
    println(<span class="hljs-string">"修改后书名：<span class="hljs-subst">${book.title}</span>"</span>) <span class="hljs-comment">// 输出：修改后书名：Kotlin 编程实战（第2版）</span>

    <span class="hljs-comment">// 4. 访问惰性初始化属性（首次访问）</span>
    println(<span class="hljs-string">"出版社：<span class="hljs-subst">${book.publisher}</span>"</span>) <span class="hljs-comment">// 输出：初始化出版社信息... 机械工业出版社</span>
    <span class="hljs-comment">// 再次访问惰性初始化属性（不执行初始化逻辑）</span>
    println(<span class="hljs-string">"出版社：<span class="hljs-subst">${book.publisher}</span>"</span>) <span class="hljs-comment">// 输出：机械工业出版社</span>

    <span class="hljs-comment">// 5. 调用方法展示完整信息</span>
    book.showInfo()
    <span class="hljs-comment">/* 输出：
    ISBN：9787111641247，书名：Kotlin 编程实战（第2版），作者：张三
    出版日期：Wed Oct 11 15:30:00 CST 2024，出版社：机械工业出版社
    */</span>
}

</code></pre>
<h2 data-id="heading-9">三、访问器原理：Getter 与 Setter 是什么？</h2>
<p>虽然 Kotlin 隐藏了访问器的显式定义，但属性的读写操作本质上都是通过访问器完成的。深入理解 Getter 和 Setter 的工作原理，是掌握自定义访问器的基础，也是排查属性相关问题的关键。</p>
<h3 data-id="heading-10">3.1 Getter：获取属性值的方法</h3>
<p><strong>Getter 是用于读取属性值的特殊方法</strong>，当通过“对象.属性名”的语法读取属性时，Kotlin 编译器会自动将其转换为对 Getter 方法的调用，最终返回属性的实际值。</p>
<p>Getter 的核心特点：</p>
<ul>
<li><strong>触发时机</strong>：每次通过“对象.属性名”读取属性时，都会触发 Getter 方法的执行；</li>
<li><strong>返回值</strong>：返回值类型与属性的类型完全一致，确保数据类型匹配；</li>
<li><strong>只读属性的核心</strong>：val 类型属性仅生成 Getter 方法，无 Setter 方法，因此无法修改属性值，本质是缺少修改入口；</li>
<li><strong>默认逻辑</strong>：默认生成的 Getter 方法直接返回属性对应的底层字段值，无额外业务逻辑。</li>
</ul>
<p>为更清晰理解 Getter 原理，可通过反编译 Kotlin 代码查看其底层实现（以“Person”类为例）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 反编译后的 Java 代码（简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-comment">// 只读属性对应 final 字段（不可修改）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-comment">// 可变属性对应普通字段（可修改）</span>
    <span class="hljs-keyword">private</span> int age;

    <span class="hljs-comment">// 只读属性的 Getter 方法（无 Setter）</span>
    <span class="hljs-keyword">public</span> String getName() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;
    }

    <span class="hljs-comment">// 可变属性的 Getter 方法</span>
    <span class="hljs-keyword">public</span> int getAge() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.age;
    }

    <span class="hljs-comment">// 可变属性的 Setter 方法</span>
    <span class="hljs-keyword">public</span> void setAge(int age) {
        <span class="hljs-keyword">this</span>.age = age;
    }

    <span class="hljs-comment">// 构造函数</span>
    <span class="hljs-keyword">public</span> Person(String name, int age) {
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.age = age;
    }
}

</code></pre>
<p>解析：Kotlin 中“val name = person.name”的读取操作，本质是调用了 Java 中的“person.getName()”方法，返回私有字段“name”的值，这就是 Getter 方法的底层执行逻辑。</p>
<h3 data-id="heading-11">3.2 Setter：设置属性值的方法</h3>
<p><strong>Setter 是用于修改属性值的特殊方法</strong>，当通过“对象.属性名 = 新值”的语法修改属性时，Kotlin 编译器会自动将其转换为对 Setter 方法的调用，将新值赋值给属性的底层字段。</p>
<p>Setter 的核心特点：</p>
<ul>
<li><strong>触发时机</strong>：每次通过“对象.属性名 = 新值”修改属性时，都会触发 Setter 方法的执行；</li>
<li><strong>参数</strong>：默认接收一个名为“value”的参数，参数类型与属性类型一致，代表要设置的新值；</li>
<li><strong>可变属性专属</strong>：仅 var 类型的可变属性会生成 Setter 方法，val 类型的只读属性无 Setter 方法，因此无法修改；</li>
<li><strong>默认逻辑</strong>：默认生成的 Setter 方法直接将参数“value”赋值给底层字段（如“this.age = value”），无额外业务逻辑。</li>
</ul>
<p>原理演示：Kotlin 中“person.age = 26”的修改操作，本质是调用了 Java 中的“person.setAge(26)”方法，将 26 赋值给私有字段“age”，完成属性值的修改。</p>
<h3 data-id="heading-12">3.3 默认访问器的执行逻辑</h3>
<p>当使用默认访问器时，属性的读写操作遵循固定的执行流程，整个过程由编译器自动完成，开发者无需手动干预。明确执行逻辑有助于理解属性值的变化过程，避免因执行顺序导致的问题。</p>
<h4 data-id="heading-13">3.3.1 读取属性的执行逻辑</h4>
<ol>
<li>开发者编写“val 变量 = 对象.属性名”的代码（如“val age = person.age”）；</li>
<li>编译器将代码转换为“对象.get+首字母大写属性名()”的方法调用（如“person.getAge()”）；</li>
<li>Getter 方法执行，返回属性对应的底层字段值（如“return this.age”）；</li>
<li>将返回值赋值给变量（如“age = 25”），读取操作完成。</li>
</ol>
<h4 data-id="heading-14">3.3.2 修改属性的执行逻辑</h4>
<ol>
<li>开发者编写“对象.属性名 = 新值”的代码（如“person.age = 26”）；</li>
<li>编译器将代码转换为“对象.set属性名(新值)”的方法调用（如“person.setAge(26)”）；</li>
<li>Setter 方法执行，将传入的新值赋值给底层字段（如“this.age = 26”）；</li>
<li>属性值修改完成，Setter 方法返回，无返回值。</li>
</ol>
<h4 data-id="heading-15">3.3.3 执行逻辑示例验证</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义包含可变属性的类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span>(<span class="hljs-keyword">var</span> count: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 测试代码：验证访问器执行逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> counter = Counter(<span class="hljs-number">0</span>)

    <span class="hljs-comment">// 1. 读取属性：触发 Getter</span>
    <span class="hljs-keyword">val</span> oldCount = counter.count
    println(<span class="hljs-string">"修改前计数：<span class="hljs-variable">$oldCount</span>"</span>) <span class="hljs-comment">// 输出：修改前计数：0</span>

    <span class="hljs-comment">// 2. 修改属性：触发 Setter</span>
    counter.count = <span class="hljs-number">10</span>

    <span class="hljs-comment">// 3. 再次读取属性：触发 Getter</span>
    <span class="hljs-keyword">val</span> newCount = counter.count
    println(<span class="hljs-string">"修改后计数：<span class="hljs-variable">$newCount</span>"</span>) <span class="hljs-comment">// 输出：修改后计数：10</span>
}

</code></pre>
<p>执行流程解析：</p>
<ul>
<li>“val oldCount = counter.count” → 调用“counter.getCount()” → 返回底层字段值 0 → oldCount 赋值为 0；</li>
<li>“counter.count = 10” → 调用“counter.setCount(10)” → 底层字段“count”赋值为 10；</li>
<li>“val newCount = counter.count” → 调用“counter.getCount()” → 返回底层字段值 10 → newCount 赋值为 10。</li>
</ul>
<h2 data-id="heading-16">四、自定义访问器：灵活控制属性读写</h2>
<p>默认访问器仅能实现“直接读写”的简单逻辑，但实际开发中常需“数据校验、动态计算、格式转换”等复杂需求。Kotlin 支持通过自定义访问器重写 Getter 或 Setter 逻辑，灵活控制属性的读写行为，适配多样化业务场景。</p>
<h3 data-id="heading-17">4.1 自定义 Getter</h3>
<p>自定义 Getter 用于修改属性的“读取逻辑”，例如根据其他属性动态计算值、对返回值进行格式化、隐藏内部实现细节等。自定义 Getter 不改变属性的可变性，仅影响读取时的返回结果。</p>
<h4 data-id="heading-18">4.1.1 语法格式</h4>
<p>在属性定义后，通过“get()”关键字定义自定义 Getter 逻辑，根据逻辑复杂度可分为“多行逻辑”和“单行简化”两种形式，基本格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 可变属性自定义 Getter（带默认值）</span>
<span class="hljs-keyword">var</span> 属性名: 数据类型 = 默认值
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 自定义读取逻辑（多行）</span>
        <span class="hljs-keyword">val</span> result = 处理逻辑
        <span class="hljs-keyword">return</span> result
    }

<span class="hljs-comment">// 2. 只读属性自定义 Getter（无默认值，动态计算）</span>
<span class="hljs-keyword">val</span> 属性名: 数据类型
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 自定义读取逻辑（多行）</span>
        <span class="hljs-keyword">return</span> 处理逻辑
    }

<span class="hljs-comment">// 3. 单行简化（逻辑简单时省略花括号和 return）</span>
<span class="hljs-keyword">val</span> 属性名: 数据类型
    <span class="hljs-keyword">get</span>() = 处理逻辑

</code></pre>
<p>语法说明：</p>
<ul>
<li>自定义 Getter 是属性定义的一部分，需缩进（通常 4 个空格），与属性名对齐，保证代码可读性；</li>
<li>只读属性若通过自定义 Getter 动态计算值，可无需设置默认值，因为每次读取都会重新执行计算逻辑；</li>
<li>单行简化格式适用于逻辑简单的场景，通过“get() = 表达式”直接返回结果，简洁高效。</li>
</ul>
<h4 data-id="heading-19">4.1.2 简单示例</h4>
<p>示例 1：动态计算属性值（根据其他属性推导结果）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 矩形类：通过宽和高动态计算面积和周长
 * width：宽（可变属性）
 * height：高（可变属性）
 * area：面积（只读计算属性，宽 * 高）
 * perimeter：周长（只读计算属性，2*(宽+高)）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-keyword">var</span> width: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">var</span> height: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-comment">// 自定义 Getter：动态计算面积（多行逻辑）</span>
    <span class="hljs-keyword">val</span> area: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() {
            println(<span class="hljs-string">"计算面积：width = <span class="hljs-variable">$width</span>, height = <span class="hljs-variable">$height</span>"</span>)
            <span class="hljs-keyword">return</span> width * height
        }

    <span class="hljs-comment">// 自定义 Getter：动态计算周长（单行简化）</span>
    <span class="hljs-keyword">val</span> perimeter: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = <span class="hljs-number">2</span> * (width + height)
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> rectangle = Rectangle(<span class="hljs-number">5.0</span>, <span class="hljs-number">3.0</span>)

    <span class="hljs-comment">// 首次读取面积：触发自定义 Getter，执行计算逻辑</span>
    println(<span class="hljs-string">"矩形面积：<span class="hljs-subst">${rectangle.area}</span>"</span>) <span class="hljs-comment">// 输出：计算面积：width = 5.0, height = 3.0 → 矩形面积：15.0</span>

    <span class="hljs-comment">// 修改宽和高后再次读取：重新执行计算逻辑</span>
    rectangle.width = <span class="hljs-number">6.0</span>
    println(<span class="hljs-string">"修改后面积：<span class="hljs-subst">${rectangle.area}</span>"</span>) <span class="hljs-comment">// 输出：计算面积：width = 6.0, height = 3.0 → 修改后面积：18.0</span>

    <span class="hljs-comment">// 读取周长：触发单行简化 Getter</span>
    println(<span class="hljs-string">"矩形周长：<span class="hljs-subst">${rectangle.perimeter}</span>"</span>) <span class="hljs-comment">// 输出：矩形周长：18.0</span>
}

</code></pre>
<p>解析：面积“area”和周长“perimeter”均为只读计算属性，无底层存储字段，每次读取时都会执行自定义 Getter 逻辑重新计算，确保返回结果与最新的宽高保持一致。</p>
<p>示例 2：返回值格式化（隐藏内部存储格式，统一对外输出）</p>
<p>解析：内部通过 Long 类型存储时间戳（节省存储空间且便于计算），对外通过自定义 Getter 提供“yyyy-MM-dd”格式的日期字符串，隐藏了内部存储细节，同时统一了对外的展示格式。需注意：<code>SimpleDateFormat</code> 非线程安全，实际开发推荐使用 <code>java.time</code> 包下的 <code>DateTimeFormatter</code>。</p>
<p>解析：内部通过 Long 类型存储时间戳（节省存储空间且便于计算），对外通过自定义 Getter 提供“yyyy-MM-dd”格式的日期字符串，隐藏了内部存储细节，同时统一了对外的展示格式。</p>
<h3 data-id="heading-20">4.2 自定义 Setter</h3>
<p>自定义 Setter 用于修改属性的“修改逻辑”，例如对传入的新值进行合法性校验（过滤非法值）、格式转换（统一值的格式）、触发关联操作（修改一个属性时同步更新其他属性）等。自定义 Setter 仅适用于可变属性（var），只读属性（val）无 Setter 可自定义。</p>
<h4 data-id="heading-21">4.2.1 语法格式</h4>
<p>在属性定义后，通过“set(value)”关键字定义自定义 Setter 逻辑，核心是通过“field”关键字引用属性的底层字段，避免递归调用。基本格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> 属性名: 数据类型 = 默认值
    <span class="hljs-keyword">set</span>(value) {
        <span class="hljs-comment">// 自定义修改逻辑（对 value 进行处理）</span>
        <span class="hljs-comment">// field 关键字：引用属性的底层字段，避免递归调用</span>
        field = 处理后的 value
    }

<span class="hljs-comment">// 单行简化（逻辑简单时）</span>
<span class="hljs-keyword">var</span> 属性名: 数据类型 = 默认值
    <span class="hljs-keyword">set</span>(value) = <span class="hljs-keyword">if</span> (条件) field = value <span class="hljs-keyword">else</span> 处理逻辑

</code></pre>
<p>语法说明：</p>
<ul>
<li><strong>value 参数</strong>：默认参数名，代表要设置的新值，类型与属性类型一致，可显式指定其他参数名；</li>
<li><strong>field 关键字</strong>：用于引用属性对应的底层字段，必须显式使用。若直接写“属性名 = value”，会触发 Setter 方法的递归调用，导致死循环；</li>
<li>自定义 Setter 仅能修改底层字段的值，无法改变属性的可变性和数据类型。</li>
</ul>
<h4 data-id="heading-22">4.2.2 简单示例</h4>
<p>示例 1：数据合法性校验（过滤非法值，保证属性值有效）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 学生类：对年龄和成绩进行合法性校验
 * age：年龄（1-150 之间，非法值设为默认 18）
 * score：成绩（0-100 之间，非法值抛出异常）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(<span class="hljs-keyword">var</span> name: String) {
    <span class="hljs-comment">// 自定义 Setter：年龄校验（1-150 之间）</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">18</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 校验逻辑：若输入值合法则赋值，否则使用默认值 18</span>
            <span class="hljs-keyword">val</span> validAge = <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.150</span>) value <span class="hljs-keyword">else</span> <span class="hljs-number">18</span>
            field = validAge
            println(<span class="hljs-string">"设置年龄：输入 <span class="hljs-variable">$value</span> → 实际设置 <span class="hljs-variable">$validAge</span>"</span>)
        }

    <span class="hljs-comment">// 自定义 Setter：成绩校验（0-100 之间，非法值抛异常）</span>
    <span class="hljs-keyword">var</span> score: <span class="hljs-built_in">Double</span> = <span class="hljs-number">60.0</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 使用 require 函数校验，非法值抛出 IllegalArgumentException</span>
            require(value <span class="hljs-keyword">in</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">.100</span><span class="hljs-number">.0</span>) { <span class="hljs-string">"成绩必须在 0-100 之间，当前输入：<span class="hljs-variable">$value</span>"</span> }
            field = value
            println(<span class="hljs-string">"设置成绩：<span class="hljs-variable">$value</span> 分（合法）"</span>)
        }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> student = Student(<span class="hljs-string">"张三"</span>)

    <span class="hljs-comment">// 设置合法年龄</span>
    student.age = <span class="hljs-number">20</span>
    <span class="hljs-comment">// 输出：设置年龄：输入 20 → 实际设置 20</span>
    println(<span class="hljs-string">"当前年龄：<span class="hljs-subst">${student.age}</span>"</span>) <span class="hljs-comment">// 输出：当前年龄：20</span>

    <span class="hljs-comment">// 设置非法年龄（超过上限）</span>
    student.age = <span class="hljs-number">200</span>
    <span class="hljs-comment">// 输出：设置年龄：输入 200 → 实际设置 18</span>
    println(<span class="hljs-string">"当前年龄：<span class="hljs-subst">${student.age}</span>"</span>) <span class="hljs-comment">// 输出：当前年龄：18</span>

    <span class="hljs-comment">// 设置合法成绩</span>
    student.score = <span class="hljs-number">85.5</span>
    <span class="hljs-comment">// 输出：设置成绩：85.5 分（合法）</span>
    println(<span class="hljs-string">"当前成绩：<span class="hljs-subst">${student.score}</span>"</span>) <span class="hljs-comment">// 输出：当前成绩：85.5</span>

    <span class="hljs-comment">// 设置非法成绩（超过上限，抛出异常）</span>
    <span class="hljs-keyword">try</span> {
        student.score = <span class="hljs-number">105.0</span>
    } <span class="hljs-keyword">catch</span> (e: IllegalArgumentException) {
        println(<span class="hljs-string">"设置成绩失败：<span class="hljs-subst">${e.message}</span>"</span>)
        <span class="hljs-comment">// 输出：设置成绩失败：成绩必须在 0-100 之间，当前输入：105.0</span>
    }
}

</code></pre>
<p>解析：通过自定义 Setter 对年龄和成绩进行校验，确保属性值始终合法——年龄非法时使用默认值，成绩非法时抛出异常，避免对象处于无效状态，提升代码健壮性。</p>
<p>示例 2：格式转换（统一属性值格式，避免数据混乱）</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 商品类：统一商品名称格式（首字母大写，去除空格）
 * name：商品名称（设置时自动格式化）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-comment">// 自定义 Setter：商品名称格式转换</span>
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 处理逻辑：去除前后空格 → 首字母大写 → 其余小写</span>
            <span class="hljs-keyword">val</span> formattedName = value.trim()
                .takeIf { it.isNotBlank() } <span class="hljs-comment">// 非空判断</span>
                ?.replaceFirstChar { it.uppercase() } <span class="hljs-comment">// 首字母大写</span>
                ?.let { it.first() + it.substring(<span class="hljs-number">1</span>).lowercase() } <span class="hljs-comment">// 其余小写</span>
                ?: <span class="hljs-string">""</span> <span class="hljs-comment">// 空值处理</span>
            field = formattedName
            println(<span class="hljs-string">"设置名称：输入 '<span class="hljs-variable">$value</span>' → 实际设置 '<span class="hljs-variable">$formattedName</span>'"</span>)
        }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> product = Product()

    <span class="hljs-comment">// 输入带空格的全小写名称</span>
    product.name = <span class="hljs-string">"  apple phone  "</span>
    <span class="hljs-comment">// 输出：设置名称：输入 '  apple phone  ' → 实际设置 'Apple phone'</span>
    println(<span class="hljs-string">"商品名称：<span class="hljs-subst">${product.name}</span>"</span>) <span class="hljs-comment">// 输出：商品名称：Apple phone</span>

    <span class="hljs-comment">// 输入全大写名称</span>
    product.name = <span class="hljs-string">"COMPUTER"</span>
    <span class="hljs-comment">// 输出：设置名称：输入 'COMPUTER' → 实际设置 'Computer'</span>
    println(<span class="hljs-string">"商品名称：<span class="hljs-subst">${product.name}</span>"</span>) <span class="hljs-comment">// 输出：商品名称：Computer</span>

    <span class="hljs-comment">// 输入空值或纯空格</span>
    product.name = <span class="hljs-string">"   "</span>
    <span class="hljs-comment">// 输出：设置名称：输入 '   ' → 实际设置 ''</span>
    println(<span class="hljs-string">"商品名称：<span class="hljs-subst">${product.name}</span>"</span>) <span class="hljs-comment">// 输出：商品名称：</span>
}

</code></pre>
<p>解析：无论外部输入何种格式的商品名称，自定义 Setter 都会将其转换为“首字母大写、其余小写、无前后空格”的标准化格式，保证数据格式一致性，便于后续数据处理和展示。</p>
<h3 data-id="heading-23">4.3 计算属性</h3>
<p><strong>计算属性（Computed Property）是一种特殊的属性，它没有底层存储字段，仅通过自定义 Getter（或 Setter）实现读写逻辑</strong>。计算属性的核心特征是“值不存储，动态计算”，每次访问时都会重新执行 Getter 逻辑得到结果，适用于“值由其他属性推导”的场景。</p>
<h4 data-id="heading-24">4.3.1 核心特征</h4>
<ul>
<li><strong>无底层字段</strong>：计算属性不占用对象的存储空间，没有对应的“field”字段，因此在自定义访问器中无法使用“field”关键字；</li>
<li><strong>动态计算</strong>：每次访问计算属性时，都会重新执行 Getter 逻辑，返回最新的计算结果，与依赖的属性实时同步；</li>
<li><strong>可变性分类</strong>： 只读计算属性（val）：仅需自定义 Getter，通过其他属性推导结果，最常用；</li>
<li>可变计算属性（var）：需同时自定义 Getter 和 Setter，实现“读写联动”（如温度转换场景）。</li>
</ul>
<h4 data-id="heading-25">4.3.2 示例：只读与可变计算属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 温度转换类：演示计算属性的读写联动
 * celsius：摄氏度（存储字段，可变属性）
 * fahrenheit：华氏度（可变计算属性，与摄氏度联动）
 * isBoiling：是否沸腾（只读计算属性，基于摄氏度判断）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Temperature</span>(<span class="hljs-keyword">var</span> celsius: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-comment">// 可变计算属性：华氏度（℃ ↔ ℉ 双向转换）</span>
    <span class="hljs-keyword">var</span> fahrenheit: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-comment">// 摄氏度转华氏度：℃ × 1.8 + 32</span>
            <span class="hljs-keyword">val</span> value = celsius * <span class="hljs-number">1.8</span> + <span class="hljs-number">32</span>
            println(<span class="hljs-string">"计算华氏度：<span class="hljs-variable">$celsius</span> ℃ → <span class="hljs-variable">$value</span> ℉"</span>)
            <span class="hljs-keyword">return</span> value
        }
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 华氏度转摄氏度：(℉ - 32) ÷ 1.8，赋值给存储字段 celsius</span>
            celsius = (value - <span class="hljs-number">32</span>) / <span class="hljs-number">1.8</span>
            println(<span class="hljs-string">"设置华氏度：<span class="hljs-variable">$value</span> ℉ → 转换为 <span class="hljs-variable">$celsius</span> ℃"</span>)
        }

    <span class="hljs-comment">// 只读计算属性：是否沸腾（标准大气压下，℃ ≥ 100 为沸腾）</span>
    <span class="hljs-keyword">val</span> isBoiling: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = celsius &gt;= <span class="hljs-number">100.0</span>
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> temperature = Temperature(<span class="hljs-number">25.0</span>)

    <span class="hljs-comment">// 访问只读计算属性（是否沸腾）</span>
    println(<span class="hljs-string">"25℃ 是否沸腾：<span class="hljs-subst">${temperature.isBoiling}</span>"</span>) <span class="hljs-comment">// 输出：false</span>

    <span class="hljs-comment">// 访问可变计算属性（华氏度）</span>
    println(<span class="hljs-string">"华氏度：<span class="hljs-subst">${temperature.fahrenheit}</span>"</span>)
    <span class="hljs-comment">// 输出：计算华氏度：25.0 ℃ → 77.0 ℉ → 华氏度：77.0</span>

    <span class="hljs-comment">// 修改计算属性（华氏度），触发 Setter 转换为摄氏度</span>
    temperature.fahrenheit = <span class="hljs-number">98.6</span>
    <span class="hljs-comment">// 输出：设置华氏度：98.6 ℉ → 转换为 37.0 ℃</span>
    println(<span class="hljs-string">"修改后摄氏度：<span class="hljs-subst">${temperature.celsius}</span>"</span>) <span class="hljs-comment">// 输出：37.0</span>

    <span class="hljs-comment">// 修改存储字段（摄氏度），再次访问计算属性</span>
    temperature.celsius = <span class="hljs-number">100.0</span>
    println(<span class="hljs-string">"100℃ 是否沸腾：<span class="hljs-subst">${temperature.isBoiling}</span>"</span>) <span class="hljs-comment">// 输出：true</span>
    println(<span class="hljs-string">"100℃ 对应的华氏度：<span class="hljs-subst">${temperature.fahrenheit}</span>"</span>)
    <span class="hljs-comment">// 输出：计算华氏度：100.0 ℃ → 212.0 ℉ → 100℃ 对应的华氏度：212.0</span>
}

</code></pre>
<p>解析：</p>
<ul>
<li><strong>fahrenheit（可变计算属性）</strong>：无底层字段，Getter 将 celsius 转换为华氏度，Setter 将华氏度转换为 celsius 并赋值给存储字段，实现“修改华氏度同步更新摄氏度”的联动效果；</li>
<li><strong>isBoiling（只读计算属性）</strong>：无底层字段，每次访问时都会判断 celsius 是否≥100，实时反映温度状态。</li>
</ul>
<h2 data-id="heading-26">五、实用场景举例</h2>
<p>结合实际开发中的典型场景，展示属性及自定义访问器的灵活应用，帮助读者理解“何时需要自定义访问器”及“如何设计合理的属性结构”。</p>
<h3 data-id="heading-27">5.1 自定义 Getter 场景</h3>
<h4 data-id="heading-28">5.1.1 场景 1：动态计算对象状态</h4>
<p>当对象的某个状态需要根据多个属性动态推导时，使用自定义 Getter 实现，避免状态不一致。例如“订单类”根据“支付状态”和“发货状态”，动态判断“订单总状态”（未支付、已支付待发货、已发货、已完成）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 订单类：动态计算订单总状态
 * orderNo：订单号（只读，固定不变）
 * isPaid：是否支付（可变）
 * isShipped：是否发货（可变）
 * isReceived：是否收货（可变）
 * status：订单总状态（只读计算属性，动态推导）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-keyword">val</span> orderNo: String) {
    <span class="hljs-keyword">var</span> isPaid: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>    <span class="hljs-comment">// 是否支付</span>
    <span class="hljs-keyword">var</span> isShipped: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否发货</span>
    <span class="hljs-keyword">var</span> isReceived: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否收货</span>

    <span class="hljs-comment">// 自定义 Getter：根据三个状态动态推导订单总状态</span>
    <span class="hljs-keyword">val</span> status: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">when</span> {
            !isPaid -&gt; <span class="hljs-string">"未支付"</span>
            isPaid &amp;&amp; !isShipped -&gt; <span class="hljs-string">"已支付待发货"</span>
            isPaid &amp;&amp; isShipped &amp;&amp; !isReceived -&gt; <span class="hljs-string">"已发货待收货"</span>
            isPaid &amp;&amp; isShipped &amp;&amp; isReceived -&gt; <span class="hljs-string">"已完成"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"未知状态"</span>
        }

    <span class="hljs-comment">// 展示订单信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"订单号：<span class="hljs-variable">$orderNo</span>，总状态：<span class="hljs-variable">$status</span>"</span>)
        println(<span class="hljs-string">"支付状态：<span class="hljs-subst">${if (isPaid) <span class="hljs-string">"已支付"</span> else <span class="hljs-string">"未支付"</span>}</span>"</span>)
        println(<span class="hljs-string">"发货状态：<span class="hljs-subst">${if (isShipped) <span class="hljs-string">"已发货"</span> else <span class="hljs-string">"未发货"</span>}</span>"</span>)
        println(<span class="hljs-string">"收货状态：<span class="hljs-subst">${if (isReceived) <span class="hljs-string">"已收货"</span> else <span class="hljs-string">"未收货"</span>}</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> order = Order(<span class="hljs-string">"20240501001"</span>)

    <span class="hljs-comment">// 初始状态：未支付</span>
    println(<span class="hljs-string">"=== 初始状态 ==="</span>)
    order.showInfo()
    <span class="hljs-comment">/* 输出：
    订单号：20240501001，总状态：未支付
    支付状态：未支付
    发货状态：未发货
    收货状态：未收货
    */</span>

    <span class="hljs-comment">// 支付后：已支付待发货</span>
    order.isPaid = <span class="hljs-literal">true</span>
    println(<span class="hljs-string">"\n=== 支付后 ==="</span>)
    order.showInfo()

    <span class="hljs-comment">// 发货后：已发货待收货</span>
    order.isShipped = <span class="hljs-literal">true</span>
    println(<span class="hljs-string">"\n=== 发货后 ==="</span>)
    order.showInfo()

    <span class="hljs-comment">// 收货后：已完成</span>
    order.isReceived = <span class="hljs-literal">true</span>
    println(<span class="hljs-string">"\n=== 收货后 ==="</span>)
    order.showInfo()
}

</code></pre>
<h4 data-id="heading-29">5.1.2 场景 2：隐藏内部复杂逻辑</h4>
<p>当属性的读取需要复杂逻辑（如数据拼接、加密解密、数据库查询等）时，使用自定义 Getter 隐藏内部实现，对外提供简洁的属性访问方式。例如“用户类”通过自定义 Getter 拼接“姓名+手机号后4位”作为显示名称，同时对手机号进行脱敏处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.security.MessageDigest
<span class="hljs-keyword">import</span> java.util.Base64

<span class="hljs-comment">/**
 * 用户类：隐藏复杂逻辑，对外提供简洁访问
 * realName：真实姓名（存储字段）
 * phone：手机号（存储字段，加密存储）
 * displayName：显示名称（计算属性：姓名+手机号后4位）
 * hiddenPhone：脱敏手机号（计算属性：中间4位用*代替）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> realName: String, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> phone: String) {
    <span class="hljs-comment">// 自定义 Getter：拼接显示名称（隐藏手机号截取逻辑）</span>
    <span class="hljs-keyword">val</span> displayName: String
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-comment">// 解密手机号（实际开发中需结合加密算法）</span>
            <span class="hljs-keyword">val</span> decryptedPhone = decryptPhone(phone)
            <span class="hljs-comment">// 截取后4位</span>
            <span class="hljs-keyword">val</span> last4Digits = decryptedPhone.takeLast(<span class="hljs-number">4</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$realName</span>（<span class="hljs-variable">$last4Digits</span>）"</span>
        }

    <span class="hljs-comment">// 自定义 Getter：手机号脱敏（隐藏脱敏逻辑）</span>
    <span class="hljs-keyword">val</span> hiddenPhone: String
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> decryptedPhone = decryptPhone(phone)
            <span class="hljs-keyword">if</span> (decryptedPhone.length != <span class="hljs-number">11</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"无效手机号"</span>
            <span class="hljs-comment">// 脱敏：中间4位用*代替</span>
            <span class="hljs-keyword">return</span> decryptedPhone.substring(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) + <span class="hljs-string">"****"</span> + decryptedPhone.substring(<span class="hljs-number">7</span>)
        }

    <span class="hljs-comment">// 私有方法：模拟手机号解密（实际开发中使用真实加密算法）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decryptPhone</span><span class="hljs-params">(encryptedPhone: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-comment">// 此处仅为演示，实际需使用 AES、RSA 等加密算法</span>
        <span class="hljs-keyword">return</span> String(Base64.getDecoder().decode(encryptedPhone))
    }

    <span class="hljs-comment">// 静态方法：模拟手机号加密（供外部创建对象时使用）</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">encryptPhone</span><span class="hljs-params">(phone: <span class="hljs-type">String</span>)</span></span>: String {
            <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(phone.toByteArray())
        }
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 加密手机号（模拟外部传入加密后的数据）</span>
    <span class="hljs-keyword">val</span> encryptedPhone = User.encryptPhone(<span class="hljs-string">"13800138000"</span>)
    <span class="hljs-comment">// 创建用户对象</span>
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"张三"</span>, encryptedPhone)

    <span class="hljs-comment">// 访问显示名称：无需关心解密和拼接逻辑</span>
    println(<span class="hljs-string">"显示名称：<span class="hljs-subst">${user.displayName}</span>"</span>) <span class="hljs-comment">// 输出：显示名称：张三（8000）</span>
    <span class="hljs-comment">// 访问脱敏手机号：无需关心解密和脱敏逻辑</span>
    println(<span class="hljs-string">"脱敏手机号：<span class="hljs-subst">${user.hiddenPhone}</span>"</span>) <span class="hljs-comment">// 输出：脱敏手机号：138****8000</span>
}

</code></pre>
<h3 data-id="heading-30">5.2 自定义 Setter 场景</h3>
<h4 data-id="heading-31">5.2.1 场景 1：数据合法性校验（最常用）</h4>
<p>在接收用户输入、接口数据等外部数据时，通过自定义 Setter 对属性值进行校验，确保数据合法，避免无效数据进入系统。例如“员工类”对“工资”“入职年份”进行校验，防止输入不合理值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Calendar

<span class="hljs-comment">/**
 * 员工类：对关键属性进行合法性校验
 * name：姓名（只读）
 * salary：工资（必须 &gt; 0）
 * hireYear：入职年份（必须 ≥ 公司成立年份 2000，且 ≤ 当前年份）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-keyword">val</span> name: String) {
    <span class="hljs-comment">// 公司成立年份（常量）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> companyFoundedYear = <span class="hljs-number">2000</span>
    <span class="hljs-comment">// 当前年份（动态获取）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> currentYear = Calendar.getInstance().<span class="hljs-keyword">get</span>(Calendar.YEAR)

    <span class="hljs-comment">// 自定义 Setter：工资校验（必须 &gt; 0）</span>
    <span class="hljs-keyword">var</span> salary: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">set</span>(value) {
            require(value &gt; <span class="hljs-number">0</span>) { <span class="hljs-string">"工资必须大于 0，当前输入：<span class="hljs-variable">$value</span>"</span> }
            field = value
        }

    <span class="hljs-comment">// 自定义 Setter：入职年份校验</span>
    <span class="hljs-keyword">var</span> hireYear: <span class="hljs-built_in">Int</span> = currentYear
        <span class="hljs-keyword">set</span>(value) {
            require(value &gt;= companyFoundedYear) {
                <span class="hljs-string">"入职年份不能早于公司成立年份 <span class="hljs-variable">$companyFoundedYear</span>，当前输入：<span class="hljs-variable">$value</span>"</span>
            }
            require(value &lt;= currentYear) {
                <span class="hljs-string">"入职年份不能晚于当前年份 <span class="hljs-variable">$currentYear</span>，当前输入：<span class="hljs-variable">$value</span>"</span>
            }
            field = value
        }

    <span class="hljs-comment">// 展示员工信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"姓名：<span class="hljs-variable">$name</span>，工资：<span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, salary)}</span> 元，入职年份：<span class="hljs-variable">$hireYear</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> employee = Employee(<span class="hljs-string">"李四"</span>)

    <span class="hljs-comment">// 设置合法数据</span>
    employee.salary = <span class="hljs-number">8000.0</span>
    employee.hireYear = <span class="hljs-number">2020</span>
    println(<span class="hljs-string">"=== 合法数据 ==="</span>)
    employee.showInfo() <span class="hljs-comment">// 输出：姓名：李四，工资：8000.00 元，入职年份：2020</span>

    <span class="hljs-comment">// 设置非法工资（抛出异常）</span>
    <span class="hljs-keyword">try</span> {
        employee.salary = -<span class="hljs-number">5000.0</span>
    } <span class="hljs-keyword">catch</span> (e: IllegalArgumentException) {
        println(<span class="hljs-string">"\n设置工资失败：<span class="hljs-subst">${e.message}</span>"</span>) <span class="hljs-comment">// 输出：设置工资失败：工资必须大于 0，当前输入：-5000.0</span>
    }

    <span class="hljs-comment">// 设置非法入职年份（早于公司成立年份）</span>
    <span class="hljs-keyword">try</span> {
        employee.hireYear = <span class="hljs-number">1990</span>
    } <span class="hljs-keyword">catch</span> (e: IllegalArgumentException) {
        println(<span class="hljs-string">"设置入职年份失败：<span class="hljs-subst">${e.message}</span>"</span>)
        <span class="hljs-comment">// 输出：设置入职年份失败：入职年份不能早于公司成立年份 2000，当前输入：1990</span>
    }
}

</code></pre>
<h4 data-id="heading-32">5.2.2 场景 2：值格式统一转换</h4>
<p>当属性值有固定格式要求（如日期格式、字符串大小写、集合去重等）时，通过自定义 Setter 对输入值进行格式转换，确保存储格式统一。例如“文章类”对“标题”进行大小写规范、对“发布时间”进行统一格式转换，对“标签列表”进行去重和标准化处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.*
<span class="hljs-keyword">import</span> java.util.stream.Collectors

<span class="hljs-comment">/**
 * 文章类：统一属性格式，保证数据规范性
 * title：文章标题（首字母大写，去除多余空格）
 * publishTimeStr：发布时间字符串（转换为统一 Date 类型存储）
 * tags：标签列表（去重、统一小写、去除空格）
 * publishTime：标准化发布时间（Date 类型，供内部使用）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> {
    <span class="hljs-comment">// 统一日期格式</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dateFormat = SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, Locale.CHINA)

    <span class="hljs-comment">// 文章标题：格式统一</span>
    <span class="hljs-keyword">var</span> title: String = <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span>(value) {
            field = value.trim()
                .takeIf { it.isNotBlank() }
                ?.replaceFirstChar { <span class="hljs-keyword">if</span> (it.isLowerCase()) it.uppercase() <span class="hljs-keyword">else</span> it }
                ?: <span class="hljs-string">"未命名文章"</span>
        }

    <span class="hljs-comment">// 发布时间字符串：转换为 Date 类型存储</span>
    <span class="hljs-keyword">var</span> publishTimeStr: String = dateFormat.format(Date())
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-keyword">val</span> formattedDate = <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 尝试按标准格式解析</span>
                dateFormat.parse(value)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 解析失败则使用当前时间</span>
                Date()
            }
            publishTime = formattedDate
            field = dateFormat.format(formattedDate)
        }

    <span class="hljs-comment">// 标签列表：去重、标准化</span>
    <span class="hljs-keyword">var</span> tags: List&lt;String&gt; = emptyList()
        <span class="hljs-keyword">set</span>(value) {
            field = value.stream()
                .map { it.trim().lowercase() } <span class="hljs-comment">// 统一小写、去空格</span>
                .filter { it.isNotBlank() } <span class="hljs-comment">// 过滤空标签</span>
                .distinct() <span class="hljs-comment">// 去重</span>
                .collect(Collectors.toList())
        }

    <span class="hljs-comment">// 内部存储的标准化发布时间</span>
    <span class="hljs-keyword">var</span> publishTime: Date = Date()

    <span class="hljs-comment">// 展示文章信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"标题：<span class="hljs-variable">$title</span>"</span>)
        println(<span class="hljs-string">"发布时间：<span class="hljs-variable">$publishTimeStr</span>"</span>)
        println(<span class="hljs-string">"标签：<span class="hljs-subst">${if (tags.isNotEmpty()) tags.joinToString(<span class="hljs-string">"、"</span>) else <span class="hljs-string">"无标签"</span>}</span>"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> article = Article()

    <span class="hljs-comment">// 设置不规范的属性值</span>
    article.title = <span class="hljs-string">"  kotlin 自定义访问器 实战  "</span>
    article.publishTimeStr = <span class="hljs-string">"2024-10-15 10:30"</span> <span class="hljs-comment">// 非标准格式（缺少秒）</span>
    article.tags = listOf(<span class="hljs-string">"Kotlin"</span>, <span class="hljs-string">"  getter"</span>, <span class="hljs-string">"setter"</span>, <span class="hljs-string">"kotlin"</span>, <span class="hljs-string">"  GETTER  "</span>)

    println(<span class="hljs-string">"=== 标准化后的文章信息 ==="</span>)
    article.showInfo()
    <span class="hljs-comment">/* 输出：
    标题：Kotlin 自定义访问器 实战
    发布时间：2024-10-15 10:30:00
    标签：kotlin、getter、setter
    */</span>
}
</code></pre>
<h4 data-id="heading-33">5.2.3 场景 3：触发关联操作</h4>
<p>当修改一个属性时，需要同步更新其他属性或执行特定业务逻辑（如日志记录、缓存更新、通知发送等），可通过自定义 Setter 实现关联操作。例如“购物车类”中，修改商品数量时同步计算“小计金额”和“总金额”，并记录修改日志。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 购物车项类：修改数量时触发关联计算
 * productName：商品名称
 * price：单价（只读）
 * quantity：购买数量（修改时同步计算小计）
 * subtotal：小计金额（数量 × 单价）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CartItem</span>(<span class="hljs-keyword">val</span> productName: String, <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-comment">// 购买数量</span>
    <span class="hljs-keyword">var</span> quantity: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 校验数量合法性</span>
            <span class="hljs-keyword">val</span> validQty = <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">1</span>) <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">100</span>) <span class="hljs-number">100</span> <span class="hljs-keyword">else</span> value
            <span class="hljs-keyword">val</span> oldQty = field
            field = validQty
            <span class="hljs-comment">// 触发关联操作：更新小计、记录日志</span>
            updateSubtotal()
            logQuantityChange(oldQty, validQty)
        }

    <span class="hljs-comment">// 小计金额</span>
    <span class="hljs-keyword">var</span> subtotal: <span class="hljs-built_in">Double</span> = price
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span> <span class="hljs-comment">// 私有 Setter，仅内部可修改</span>

    <span class="hljs-comment">// 同步更新小计金额</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateSubtotal</span><span class="hljs-params">()</span></span> {
        subtotal = price * quantity
    }

    <span class="hljs-comment">// 记录数量修改日志</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logQuantityChange</span><span class="hljs-params">(oldQty: <span class="hljs-type">Int</span>, newQty: <span class="hljs-type">Int</span>)</span></span> {
        println(<span class="hljs-string">"[日志] 商品 '<span class="hljs-variable">$productName</span>' 数量变更：<span class="hljs-variable">$oldQty</span> → <span class="hljs-variable">$newQty</span>"</span>)
    }
}

<span class="hljs-comment">/**
 * 购物车类：管理多个购物车项，计算总金额
 * items：购物车项列表
 * totalAmount：总金额（随购物车项变化而更新）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCart</span> {
    <span class="hljs-keyword">val</span> items: MutableList&lt;CartItem&gt; = mutableListOf()

    <span class="hljs-comment">// 总金额：动态计算所有项小计之和</span>
    <span class="hljs-keyword">val</span> totalAmount: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = items.sumOf { it.subtotal }

    <span class="hljs-comment">// 添加商品到购物车</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">CartItem</span>)</span></span> {
        items.add(item)
        println(<span class="hljs-string">"[日志] 商品 '<span class="hljs-subst">${item.productName}</span>' 已加入购物车"</span>)
    }

    <span class="hljs-comment">// 展示购物车信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showCart</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"\n=== 购物车详情 ==="</span>)
        items.forEachIndexed { index, item -&gt;
            println(<span class="hljs-string">"<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>. 商品：<span class="hljs-subst">${item.productName}</span>，单价：<span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, item.price)}</span> 元，数量：<span class="hljs-subst">${item.quantity}</span>，小计：<span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, item.subtotal)}</span> 元"</span>)
        }
        println(<span class="hljs-string">"=================="</span>)
        println(<span class="hljs-string">"购物车总金额：<span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, totalAmount)}</span> 元"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> cart = ShoppingCart()
    <span class="hljs-keyword">val</span> item1 = CartItem(<span class="hljs-string">"Kotlin 编程书籍"</span>, <span class="hljs-number">59.9</span>)
    <span class="hljs-keyword">val</span> item2 = CartItem(<span class="hljs-string">"机械键盘"</span>, <span class="hljs-number">299.0</span>)

    <span class="hljs-comment">// 添加商品到购物车</span>
    cart.addItem(item1)
    cart.addItem(item2)

    <span class="hljs-comment">// 修改商品数量（触发关联计算）</span>
    item1.quantity = <span class="hljs-number">3</span>
    item2.quantity = <span class="hljs-number">150</span> <span class="hljs-comment">// 超过上限，自动调整为 100</span>

    <span class="hljs-comment">// 展示购物车详情</span>
    cart.showCart()
    <span class="hljs-comment">/* 输出：
    [日志] 商品 'Kotlin 编程书籍' 已加入购物车
    [日志] 商品 '机械键盘' 已加入购物车
    [日志] 商品 'Kotlin 编程书籍' 数量变更：1 → 3
    [日志] 商品 '机械键盘' 数量变更：1 → 100

    === 购物车详情 ===
    1. 商品：Kotlin 编程书籍，单价：59.90 元，数量：3，小计：179.70 元
    2. 商品：机械键盘，单价：299.00 元，数量：100，小计：29900.00 元
    ==================
    购物车总金额：30079.70 元
    */</span>
}

</code></pre>
<h3 data-id="heading-34">5.3 计算属性场景</h3>
<h4 data-id="heading-35">5.3.1 场景 1：单位转换</h4>
<p>当需要在不同单位之间灵活转换时，使用计算属性实现“读写联动”，修改一个单位的值时自动同步另一个单位的值。例如“长度类”支持“米”和“厘米”之间的双向转换，修改任意一个单位都会实时更新另一个。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 长度类：支持米和厘米双向转换
 * meter：米（基础单位，存储字段）
 * centimeter：厘米（计算属性，与米联动）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Length</span>(<span class="hljs-keyword">var</span> meter: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-comment">// 厘米：计算属性，1米 = 100厘米</span>
    <span class="hljs-keyword">var</span> centimeter: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = meter * <span class="hljs-number">100</span>
        <span class="hljs-keyword">set</span>(value) {
            meter = value / <span class="hljs-number">100</span>
        }

    <span class="hljs-comment">// 展示长度信息</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showLength</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"长度：<span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, meter)}</span> 米 = <span class="hljs-subst">${String.format(<span class="hljs-string">"%.2f"</span>, centimeter)}</span> 厘米"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> length = Length(<span class="hljs-number">2.5</span>)
    <span class="hljs-comment">// 初始状态</span>
    length.showLength() <span class="hljs-comment">// 输出：长度：2.50 米 = 250.00 厘米</span>

    <span class="hljs-comment">// 修改米数，同步更新厘米</span>
    length.meter = <span class="hljs-number">3.8</span>
    length.showLength() <span class="hljs-comment">// 输出：长度：3.80 米 = 380.00 厘米</span>

    <span class="hljs-comment">// 修改厘米数，同步更新米</span>
    length.centimeter = <span class="hljs-number">520.5</span>
    length.showLength() <span class="hljs-comment">// 输出：长度：5.21 米 = 520.50 厘米</span>
}

</code></pre>
<h4 data-id="heading-36">5.3.2 场景 2：动态统计信息</h4>
<p>当需要实时统计对象的某些状态（如集合大小、平均值、最大值等）时，使用计算属性避免手动更新统计结果，确保数据实时准确。例如“学生成绩类”中，通过计算属性实时统计“总分”“平均分”“最高分”。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 学生成绩类：实时统计成绩信息
 * name：学生姓名
 * scores：各科成绩列表（支持动态添加/修改）
 * totalScore：总分（所有成绩之和）
 * averageScore：平均分（总分/科目数，保留两位小数）
 * maxScore：最高分（成绩列表中的最大值）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentScore</span>(<span class="hljs-keyword">val</span> name: String) {
    <span class="hljs-comment">// 各科成绩列表（可变）</span>
    <span class="hljs-keyword">val</span> scores: MutableList&lt;<span class="hljs-built_in">Double</span>&gt; = mutableListOf()

    <span class="hljs-comment">// 总分：计算属性</span>
    <span class="hljs-keyword">val</span> totalScore: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = scores.sum()

    <span class="hljs-comment">// 平均分：计算属性</span>
    <span class="hljs-keyword">val</span> averageScore: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (scores.isEmpty()) <span class="hljs-number">0.0</span> <span class="hljs-keyword">else</span> String.format(<span class="hljs-string">"%.2f"</span>, totalScore / scores.size).toDouble()

    <span class="hljs-comment">// 最高分：计算属性</span>
    <span class="hljs-keyword">val</span> maxScore: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() = scores.maxOrNull() ?: <span class="hljs-number">0.0</span>

    <span class="hljs-comment">// 添加成绩</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addScore</span><span class="hljs-params">(score: <span class="hljs-type">Double</span>)</span></span> {
        <span class="hljs-keyword">if</span> (score <span class="hljs-keyword">in</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">.100</span><span class="hljs-number">.0</span>) {
            scores.add(score)
            println(<span class="hljs-string">"已添加成绩：<span class="hljs-variable">$score</span> 分"</span>)
        } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"成绩 <span class="hljs-variable">$score</span> 无效，需在 0-100 之间"</span>)
        }
    }

    <span class="hljs-comment">// 展示成绩统计</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showStatistics</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"\n=== <span class="hljs-subst">${name}</span> 的成绩统计 ==="</span>)
        println(<span class="hljs-string">"各科成绩：<span class="hljs-subst">${scores.joinToString(<span class="hljs-string">"、"</span>)}</span>"</span>)
        println(<span class="hljs-string">"总分：<span class="hljs-variable">$totalScore</span> 分"</span>)
        println(<span class="hljs-string">"平均分：<span class="hljs-variable">$averageScore</span> 分"</span>)
        println(<span class="hljs-string">"最高分：<span class="hljs-variable">$maxScore</span> 分"</span>)
    }
}

<span class="hljs-comment">// 测试代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> studentScore = StudentScore(<span class="hljs-string">"王五"</span>)

    <span class="hljs-comment">// 添加成绩</span>
    studentScore.addScore(<span class="hljs-number">85.5</span>)
    studentScore.addScore(<span class="hljs-number">92.0</span>)
    studentScore.addScore(<span class="hljs-number">78.5</span>)
    studentScore.addScore(<span class="hljs-number">105.0</span>) <span class="hljs-comment">// 无效成绩</span>

    <span class="hljs-comment">// 展示统计信息</span>
    studentScore.showStatistics()
    <span class="hljs-comment">/* 输出：
    已添加成绩：85.5 分
    已添加成绩：92.0 分
    已添加成绩：78.5 分
    成绩 105.0 无效，需在 0-100 之间

    === 王五 的成绩统计 ===
    各科成绩：85.5、92.0、78.5
    总分：256.0 分
    平均分：85.33 分
    最高分：92.0 分
    */</span>

    <span class="hljs-comment">// 再添加一门成绩，统计信息实时更新</span>
    studentScore.addScore(<span class="hljs-number">90.0</span>)
    studentScore.showStatistics()
}

</code></pre>
<h2 data-id="heading-37">六、避坑要点与优化技巧</h2>
<h3 data-id="heading-38">6.1 常见避坑要点</h3>
<h4 data-id="heading-39">6.1.1 避免 Getter/Setter 递归调用</h4>
<p>在自定义访问器中，若直接使用“属性名”进行读写，会触发自身的访问器调用，导致无限递归。核心解决方法是使用 <code>field</code> 关键字引用底层字段，仅在计算属性（无底层字段）中可省略 <code>field</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误示例：Setter 中直接使用属性名导致递归</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 错误：age = value 会再次触发 Setter，陷入死循环</span>
            age = <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>) value <span class="hljs-keyword">else</span> <span class="hljs-number">18</span>
        }
}

<span class="hljs-comment">// 正确示例：使用 field 引用底层字段</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-comment">// 正确：field 直接操作底层字段，不触发访问器</span>
            field = <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>) value <span class="hljs-keyword">else</span> <span class="hljs-number">18</span>
        }
}

</code></pre>
<h4 data-id="heading-40">6.1.2 区分计算属性与普通属性</h4>
<p>计算属性无底层存储，每次访问都会重新计算，若计算逻辑复杂（如循环、网络请求），会导致性能问题；普通属性（含自定义访问器）有底层字段，仅在访问器逻辑中执行计算。避免将复杂逻辑写入计算属性的 Getter 中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不推荐：计算属性 Getter 包含复杂逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataAnalyzer</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: List&lt;<span class="hljs-built_in">Int</span>&gt;) {
    <span class="hljs-comment">// 每次访问都会执行排序和去重，性能开销大</span>
    <span class="hljs-keyword">val</span> sortedUniqueData: List&lt;<span class="hljs-built_in">Int</span>&gt;
        <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">data</span>.sorted().distinct()
}

<span class="hljs-comment">// 推荐：普通属性 + 初始化时计算（仅执行一次）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataAnalyzer</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: List&lt;<span class="hljs-built_in">Int</span>&gt;) {
    <span class="hljs-comment">// 初始化时计算并存储结果，后续访问直接返回</span>
    <span class="hljs-keyword">val</span> sortedUniqueData: List&lt;<span class="hljs-built_in">Int</span>&gt; = <span class="hljs-keyword">data</span>.sorted().distinct()
}

</code></pre>
<h4 data-id="heading-41">6.1.3 谨慎使用 lateinit 与 lazy</h4>
<p>lateinit 和 lazy 虽能解决延迟初始化问题，但使用不当会引发异常，需注意适用场景和约束条件：</p>
<ul>
<li><strong>lateinit 约束</strong>：仅适用于 var 修饰的非空引用类型（如 String、自定义类），基本数据类型需通过`Delegates.notNull</li>
<li><strong>lazy 约束</strong>：仅适用于 val 修饰的属性；初始化逻辑默认线程安全（可通过 <code>LazyThreadSafetyMode</code> 调整）；初始化后不可修改，若需动态更新，应使用普通属性。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// lateinit 正确使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> userRepository: UserRepository

    <span class="hljs-comment">// 初始化方法（如依赖注入后调用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(repo: <span class="hljs-type">UserRepository</span>)</span></span> {
        userRepository = repo
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: User? {
        <span class="hljs-comment">// 检查初始化状态，避免异常</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (::userRepository.isInitialized) {
            userRepository.findById(id)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">null</span>
        }
    }
}

<span class="hljs-comment">// lazy 线程安全调整示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-comment">// 单线程场景下，使用 NONE 模式提升性能</span>
    <span class="hljs-keyword">val</span> appConfig: Map&lt;String, String&gt; <span class="hljs-keyword">by</span> lazy(LazyThreadSafetyMode.NONE) {
        loadConfigFromFile() <span class="hljs-comment">// 从文件加载配置</span>
    }

    <span class="hljs-comment">// 补充配置加载方法实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadConfigFromFile</span><span class="hljs-params">()</span></span>: Map&lt;String, String&gt; {
        <span class="hljs-comment">// 实际开发中实现文件读取逻辑</span>
        <span class="hljs-keyword">return</span> mapOf(<span class="hljs-string">"timeout"</span> to <span class="hljs-string">"3000"</span>, <span class="hljs-string">"maxRetry"</span> to <span class="hljs-string">"3"</span>)
    }
}

<span class="hljs-comment">// 补充必要的类型定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: User? = User(id, <span class="hljs-string">"默认用户"</span>)
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: String, <span class="hljs-keyword">val</span> name: String)

</code></pre>
<h4 data-id="heading-42">6.1.4 避免在访问器中执行耗时操作</h4>
<p>访问器（尤其是 Getter）的设计初衷是“快速读写属性”，若在其中执行耗时操作（如数据库查询、网络请求、大文件读写），会导致属性访问时阻塞，影响用户体验和系统性能。耗时操作应封装为独立方法，显式调用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 不推荐：Getter 中执行耗时操作</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> userId: String) {
    <span class="hljs-comment">// 访问时执行数据库查询，可能阻塞线程</span>
    <span class="hljs-keyword">val</span> userDetails: UserDetails
        <span class="hljs-keyword">get</span>() = userDao.queryDetails(userId)
}

<span class="hljs-comment">// 推荐：封装为独立方法，显式调用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> userId: String) {
    <span class="hljs-comment">// 显式方法，表明存在耗时操作</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserDetails</span><span class="hljs-params">()</span></span>: UserDetails {
        <span class="hljs-keyword">return</span> userDao.queryDetails(userId)
    }
}

<span class="hljs-comment">// 补充必要的类型定义（实际开发中需根据业务实现）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetails</span>
<span class="hljs-keyword">object</span> UserDao {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryDetails</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: UserDetails = UserDetails()
}

</code></pre>
<h3 data-id="heading-43">6.2 优化技巧</h3>
<h4 data-id="heading-44">6.2.1 合理使用私有访问器</h4>
<p>对于无需外部修改但需内部更新的属性，可将 Setter 设为私有（<code>private set</code>），既能保证外部只读性，又能避免属性被意外修改，提升封装性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-keyword">val</span> orderNo: String) {
    <span class="hljs-comment">// 订单状态：外部只读，内部可修改</span>
    <span class="hljs-keyword">var</span> status: String = <span class="hljs-string">"未支付"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-comment">// 内部方法修改状态</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"未支付"</span>) {
            status = <span class="hljs-string">"已支付"</span>
        }
    }
}

<span class="hljs-comment">// 外部使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> order = Order(<span class="hljs-string">"2024001"</span>)
    println(order.status) <span class="hljs-comment">// 可读：输出 未支付</span>
    order.pay() <span class="hljs-comment">// 通过方法修改</span>
    <span class="hljs-comment">// order.status = "已取消" // 编译报错：外部无法修改私有 Setter 的属性</span>
}

</code></pre>
<h4 data-id="heading-45">6.2.2 缓存计算属性结果（针对复杂逻辑）</h4>
<p>若计算属性的逻辑复杂但依赖的数据源不频繁变化，可通过“普通属性 + 监听依赖变化”的方式缓存计算结果，避免每次访问都重新计算，提升性能。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductAnalyzer</span>(<span class="hljs-keyword">var</span> products: List&lt;Product&gt;) {
    <span class="hljs-comment">// 缓存计算结果的普通属性</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _averagePrice: <span class="hljs-built_in">Double</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 计算属性：优先使用缓存，缓存失效时重新计算</span>
    <span class="hljs-keyword">val</span> averagePrice: <span class="hljs-built_in">Double</span>
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">if</span> (_averagePrice == <span class="hljs-literal">null</span>) {
                _averagePrice = products.map { it.price }.average()
            }
            <span class="hljs-keyword">return</span> _averagePrice!!
        }

    <span class="hljs-comment">// 当依赖数据源变化时，清空缓存</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateProducts</span><span class="hljs-params">(newProducts: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Product</span>&gt;)</span></span> {
        products = newProducts
        _averagePrice = <span class="hljs-literal">null</span> <span class="hljs-comment">// 缓存失效</span>
    }
}

<span class="hljs-comment">// 补充必要的类型定义</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(<span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>)

</code></pre>
<h4 data-id="heading-46">6.2.3 利用 const 优化编译期常量</h4>
<p>对于编译期即可确定值的常量（如固定的字符串、数值），使用 <code>const val</code> 替代普通 <code>val</code>，可定义在对象、伴生对象或顶层，编译时会将其替换为字面量，避免运行时属性访问的开销，且支持在注解中使用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 普通常量：运行时访问属性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConstants</span> {
    <span class="hljs-keyword">val</span> API_BASE_URL = <span class="hljs-string">"https://api.example.com"</span>
}

<span class="hljs-comment">// 编译期常量：编译时替换为字面量</span>
<span class="hljs-keyword">object</span> AppConstants {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> API_BASE_URL = <span class="hljs-string">"https://api.example.com"</span>
}

<span class="hljs-comment">// 支持在注解中使用（Retrofit 实际注解示例）</span>
<span class="hljs-keyword">import</span> retrofit2.http.GET

<span class="hljs-meta">@retrofit2</span>.http.BaseUrl(AppConstants.API_BASE_URL)
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"/data"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span>: Response&lt;Data&gt;
}

<span class="hljs-comment">// 补充必要的类型定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span>&lt;<span class="hljs-type">T</span>&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>

</code></pre>
<h4 data-id="heading-47">6.2.4 简化访问器逻辑（提取公共方法）</h4>
<p>若多个属性的访问器逻辑存在重复（如相同的格式校验、转换规则），应将重复逻辑提取为私有方法，在访问器中调用，提升代码复用性和可维护性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserData</span> {
    <span class="hljs-comment">// 提取公共的字符串格式化方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatString</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> value.trim()
            .takeIf { it.isNotBlank() }
            ?: <span class="hljs-string">"未知"</span>
    }

    <span class="hljs-comment">// 多个属性复用格式化逻辑</span>
    <span class="hljs-keyword">var</span> username: String = <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span>(value) { field = formatString(value) }

    <span class="hljs-keyword">var</span> nickname: String = <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span>(value) { field = formatString(value) }

    <span class="hljs-keyword">var</span> address: String = <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span>(value) { field = formatString(value) }
}

</code></pre>
<h2 data-id="heading-48">七、总结</h2>
<h3 data-id="heading-49">7.1 核心知识点梳理</h3>
<p>Kotlin 类的属性与自定义访问器是面向对象编程的核心，其核心知识点可归纳为“一个本质、两类属性、两种访问器、三大场景”：</p>
<ul>
<li><strong>一个本质</strong>：Kotlin 属性是“底层字段 + 访问器（Getter/Setter）”的封装体，访问属性本质是调用访问器方法。</li>
<li><strong>两类属性</strong>：可变属性（var）支持读写，自动生成 Getter 和 Setter；只读属性（val）仅支持读，仅生成 Getter。</li>
<li><strong>两种访问器</strong>：默认访问器实现简单读写，无需手动编写；自定义访问器可重写逻辑，实现数据校验、动态计算等复杂需求。</li>
<li><strong>三大场景</strong>：自定义 Getter 用于动态计算、结果格式化；自定义 Setter 用于数据校验、格式转换、关联操作；计算属性用于无存储的动态推导场景。</li>
</ul>
<h3 data-id="heading-50">7.2 最佳实践建议</h3>
<ol>
<li><strong>优先使用默认访问器</strong>：常规读写场景下，默认访问器已满足需求，避免过度自定义导致代码冗余。</li>
<li><strong>明确属性可变性</strong>：优先使用 val 定义只读属性，仅在确需修改时使用 var，减少对象状态变化带来的复杂度。</li>
<li><strong>合理选择初始化方式</strong>：即时初始化适用于值明确的场景；lateinit 适用于非空引用类型的延迟赋值；lazy 适用于 val 修饰的重量级对象延迟初始化。</li>
<li><strong>保持访问器轻量化</strong>：访问器中仅执行简单逻辑，耗时操作或复杂业务逻辑封装为独立方法。</li>
<li><strong>强化封装性</strong>：通过私有字段、私有访问器隐藏内部实现，对外提供简洁的访问接口。</li>
</ol>
<h3 data-id="heading-51">7.3 学习展望</h3>
<p>掌握属性与自定义访问器后，可进一步学习 Kotlin 中与属性相关的高级特性，深化对面向对象编程的理解：</p>
<ul>
<li><strong>委托属性</strong>：通过 <code>by</code> 关键字将属性的访问逻辑委托给其他对象，实现属性的复用（如 lazy 本质是委托属性）。</li>
<li><strong>数据类与密封类的属性特性</strong>：数据类自动生成基于属性的 equals、hashCode 等方法；密封类的属性可用于约束子类状态。</li>
<li><strong>属性注解与反射</strong>：通过注解标记属性（如 <code>@SerializedName</code>），结合反射实现属性的序列化/反序列化。</li>
</ul>
<p>Kotlin 的属性设计兼顾了简洁性与灵活性，合理运用属性与访问器，能大幅提升代码的可读性、健壮性和可维护性，是 Kotlin 开发的核心技能之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android：使用 Tint 为图标 Icon 动态着色]]></title>    <link>https://juejin.cn/post/7576086557715939379</link>    <guid>https://juejin.cn/post/7576086557715939379</guid>    <pubDate>2025-11-24T09:15:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086557715939379" data-draft-id="7575887863797874698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android：使用 Tint 为图标 Icon 动态着色"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-24T09:15:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kerli"/> <meta itemprop="url" content="https://juejin.cn/user/1023015909855504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android：使用 Tint 为图标 Icon 动态着色
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1023015909855504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kerli
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:15:20.000Z" title="Mon Nov 24 2025 09:15:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.   背景</h2>
<p>在 App 当中，会有很多 <strong>形状相同、颜色不同</strong> 的 Icon。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb5e3a87fc3840e2a2f28e64a8aa2ee3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2VybGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764580520&amp;x-signature=dmQvOgfVG%2B5KRuwqTNr5uuy4g%2Bk%3D" alt="" loading="lazy"/></p>
<p>例如上图这个场景，是筛选项的 icon，对应的代码可能为：</p>
<ul>
<li>Xml 中初始化颜色为黑色</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
    <span class="hljs-attr">...</span>
    <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/icon_filter_black"</span> /&gt;</span>
</code></pre>
<ul>
<li>代码中根据筛选状态，切换不同颜色的 icon</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// XXXFragment.kt</span>

imageView.setImageDrawable(
    <span class="hljs-keyword">if</span> (isSelect) {
        <span class="hljs-comment">// 筛选后为橙色</span>
        resources.getDrawable(R.drawable.icon_filter_orange);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未筛选为黑色</span>
        resources.getDrawable(R.drawable.icon_filter_black);
    }
)
</code></pre>
<p>如果为每种颜色的 Icon 都保存一张图片，会增加包体积。同时，会增加设计的工作负担。有没有什么办法可以做到只需要一张图片，然后动态的着色呢？</p>
<h2 data-id="heading-1">2.  使用 Tint 动态着色</h2>

<h3 data-id="heading-2">2.1  使用方式</h3>
<p>有以下几种方式：</p>
<ol>
<li>xml 中设置</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
    <span class="hljs-attr">...</span>
    <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/icon_filter"</span> 
    <span class="hljs-attr">app:tint</span>=<span class="hljs-string">"@color/black"</span>
    /&gt;</span>
</code></pre>
<ol start="2">
<li>代码中为 ImageView 设置</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin">imageView.imageTintList = ColorStateList(...)
</code></pre>
<ol start="3">
<li>代码中直接为 Drawable 设置</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> drawable = resources.getDrawable(R.drawable.icon_filter)
drawable.setTint = Color.BLACK

imageView.setImageDrawable(drawable)
</code></pre>
<p>设置 tint 后，绘制时就会用 tint 的颜色渲染 icon。这样，就算只有一张图片，也可以渲染为多种颜色。很大程度的节省了包体积。</p>
<h3 data-id="heading-3">2.2  原理分析</h3>
<ul>
<li>ImageView 会将 Tint 传给 Drawable</li>
</ul>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-comment">// ImageView.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setImageTintList</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ColorStateList tint)</span> {
    mDrawableTintList = tint;
    mHasDrawableTint = <span class="hljs-literal">true</span>;
    
    applyImageTint();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyImageTint</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mDrawable != <span class="hljs-literal">null</span> &amp;&amp; (mHasDrawableTint || mHasDrawableBlendMode)) {
        mDrawable = mDrawable.mutate();
        
        <span class="hljs-keyword">if</span> (mHasDrawableTint) {
            mDrawable.setTintList(mDrawableTintList); <span class="hljs-comment">// 将 tint 传递给 Drawable！</span>
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<ul>
<li>Drawable 在 <strong>收到 Tint</strong> 时会创建 <strong>ColorFilter</strong>，在 draw 时会用它做颜色过滤处理。这里拿 VectorDrawable 举例：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VectorDrawable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-keyword">private</span> BlendModeColorFilter mBlendModeColorFilter ;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTintList</span><span class="hljs-params">(ColorStateList tint)</span> {
        <span class="hljs-comment">// 使用 tint 创建 ColorFilter</span>
        updateColorFilters(... , tint) ;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateColorFilters</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> BlendMode blendMode , ColorStateList tint)</span> {
        <span class="hljs-comment">// ...</span>
    mBlendModeColorFilter = updateBlendModeFilter(mBlendModeColorFilter , tint , blendMode) ;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(Canvas canvas)</span> {
        <span class="hljs-comment">// 绘制时，如果外部没有设置 mColorFilter，则使用 mBlendModeColorFilter</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">ColorFilter</span> <span class="hljs-variable">colorFilter</span> <span class="hljs-operator">=</span> (mColorFilter == <span class="hljs-literal">null</span> ? mBlendModeColorFilter : mColorFilter) ;
        <span class="hljs-comment">// ...</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-meta">@Nullable</span> 
    BlendModeColorFilter <span class="hljs-title function_">updateBlendModeFilter</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ColorStateList tint , ... )</span> {
        <span class="hljs-comment">// ... </span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">color</span> <span class="hljs-operator">=</span> tint.getColorForState(getState() , Color.TRANSPARENT) ;
    
        <span class="hljs-keyword">if</span> (blendFilter == <span class="hljs-literal">null</span> || blendFilter.getColor() != color
                || blendFilter.getMode() != blendMode) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlendModeColorFilter</span>(color , blendMode) ;
        }
        
        <span class="hljs-keyword">return</span> blendFilter ;
    }
}
</code></pre>
<h2 data-id="heading-4">3.  注意事项</h2>

<h3 data-id="heading-5">3.1  同时设置 ImageView 与 Drawable，Drawable 的设置会失效</h3>
<ul>
<li>例如，我们在 xml 中设置 tint 为黑色</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
    <span class="hljs-attr">...</span>
    <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/icon_filter"</span>
    <span class="hljs-attr">app:tint</span>=<span class="hljs-string">"@color/black"</span>
    /&gt;</span>
</code></pre>
<ul>
<li>在代码中，为 Drawable 设置为黄色</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> drawable = resources.getDrawable(R.drawable.icon_filter)
drawable.setTint = Color.YELLOW

imageView.setImageDrawable(drawable)
</code></pre>
<ul>
<li>此时，对 Drawable 的设置是不生效的，因为此时 ImageView.setImageDrawable 会覆盖掉 Drawable 自身的 tint</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ImageView.kt</span>

<span class="hljs-keyword">public</span> void setImageDrawable(<span class="hljs-meta">@Nullable</span> Drawable drawable) {
    updateDrawable(drawable) ;
}

<span class="hljs-keyword">private</span> void updateDrawable(Drawable d) {
    applyImageTint() ;
}

<span class="hljs-keyword">private</span> void applyImageTint() {
    <span class="hljs-keyword">if</span> (mHasDrawableTint) {
        mDrawable.setTintList(mDrawableTintList) ;
    }
}
</code></pre>
<ul>
<li>所以如果同时设置 ImageView 与 Drawable 的 tint，要关注覆盖问题。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph1.0智能体开发：Graph API概念与设计]]></title>    <link>https://juejin.cn/post/7576057623742431274</link>    <guid>https://juejin.cn/post/7576057623742431274</guid>    <pubDate>2025-11-24T09:15:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623742431274" data-draft-id="7575887863797792778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph1.0智能体开发：Graph API概念与设计"/> <meta itemprop="keywords" content="LangChain,Agent,Python"/> <meta itemprop="datePublished" content="2025-11-24T09:15:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph1.0智能体开发：Graph API概念与设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:15:33.000Z" title="Mon Nov 24 2025 09:15:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">一、图（Graphs）</h2>
<p>从核心来看，LangGraph将智能体（agent）的工作流程建模为 “图”。你可以通过以下三个关键组件来定义智能体的行为：</p>
<ul>
<li>状态（State）：一种共享数据结构，用于表示应用程序当前的快照。它可以是任何数据类型，但通常会通过共享状态模式（shared state schema）来定义。</li>
<li>节点（Nodes）：承载智能体逻辑的函数。节点接收当前状态作为输入，执行某些计算或副作用操作，然后返回更新后的状态。</li>
<li>边（Edges）：根据当前状态决定下一个执行节点的函数。边可以是条件分支（conditional branches），也可以是固定转移（fixed transitions）。</li>
</ul>
<p>通过组合节点和边，你可以创建复杂的、带循环的工作流程，这些流程会随着时间推移不断更新状态。不过，LangGraph的真正优势在于其对状态的管理方式。</p>
<p>需要强调的是：节点和边本质上只是函数 —— 它们既可以包含大语言模型（LLM），也可以只是常规的代码。
简而言之：节点负责执行任务，边负责决定下一步执行什么。</p>
<p>LangGraph的底层图算法采用 “消息传递（message passing）” 机制来定义通用程序。当一个节点完成操作后，它会通过一条或多条边向其他节点发送消息。这些接收消息的节点随后执行自身的函数，并将生成的消息传递给下一组节点，此过程不断循环。该程序的设计灵感源自谷歌的Pregel系统，以离散的 “超步（super-steps）” 方式运行。</p>
<p>一个 “超步” 可视为对图中节点的一次迭代。并行运行的节点属于同一个超步，而顺序运行的节点则分属不同的超步。在图执行开始时，所有节点均处于未激活状态。当某个节点通过其任意一条入边（或 “通道”）接收到新消息（状态）时，该节点会被激活。激活后的节点将执行自身函数，并返回更新结果。在每个超步结束时，没有接收到入边消息的节点会通过将自身标记为未激活来 “投票” 停止。当所有节点均处于未激活状态，且没有正在传递的消息时，图的执行过程便会终止。</p>
<h3 data-id="heading-1">1.1 状态图（StateGraph）</h3>
<p>StateGraph类是核心的图操作类，其参数由用户自定义的 “状态（State）” 对象指定。</p>
<h3 data-id="heading-2">1.2 编译图</h3>
<p>构建图的流程如下：首先定义状态，接着添加节点和边，最后对图进行编译。那么 “编译图” 具体指什么？为何需要这一步骤？
编译是一个非常简洁的步骤，主要作用包括：对图的结构进行基础校验（例如检查是否存在孤立节点等）；同时，你也可以在此步骤中指定运行时参数（如检查点工具checkpointers、断点工具 breakpoints 等）。
只需调用 .compile 方法，即可完成图的编译：</p>
<pre><code class="hljs language-python" lang="python">graph = graph_builder.<span class="hljs-built_in">compile</span>(...)
</code></pre>
<h2 data-id="heading-3">二、状态（State）</h2>
<p>定义图时，首要任务是确定图的 “状态（State）”。状态由图的模式（Schema） 和归约函数（reducer functions） 组成：模式规定了状态的数据结构，归约函数则定义了如何将更新应用到状态中。状态的模式将作为图中所有节点（Nodes）和边（Edges）的输入模式，其类型可以是 TypedDict 或 Pydantic 模型。所有节点都会输出对状态的更新，这些更新将通过指定的归约函数应用到状态上。</p>
<h3 data-id="heading-4">2.1 模式（Schema）</h3>
<p>官方推荐的图模式定义方式是使用TypedDict。如果需要为状态设置默认值，可使用数据类（dataclass）。若需实现递归数据校验，也支持使用Pydantic的BaseModel作为图状态（注意：Pydantic的性能低于TypedDict或数据类）。
默认情况下，图的输入模式和输出模式是一致的。若需修改这一默认行为，也可直接指定显式的输入模式和输出模式 —— 当状态包含多个键（keys），且部分键仅用于输入、部分仅用于输出时，这种方式非常实用。</p>
<h3 data-id="heading-5">2.2 多模式（Multiple schemas）</h3>
<p>通常，图中所有节点通过单一模式通信，即它们读取和写入同一个状态通道。但在某些场景下，我们需要更精细的控制：
内部节点可传递无需包含在图输入 / 输出中的信息；
可为图设置不同的输入 / 输出模式（例如，输出仅包含一个核心结果键）。
实现方式：</p>
<ul>
<li>私有状态通道：节点可写入图内部的私有状态通道，用于内部节点间的通信。只需定义一个私有模式（如 PrivateState）即可；</li>
<li>显式输入/输出模式：可定义图的显式输入/输出模式。此时需先定义一个 “内部模式”，包含图操作所需的所有键；再定义输入模式和输出模式（二者均为内部模式的子集），以约束图的输入和输出范围。更多细节可参考该指南。
示例如下：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InputState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    user_input: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    graph_output: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OverallState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    foo: <span class="hljs-built_in">str</span>
    user_input: <span class="hljs-built_in">str</span>
    graph_output: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    bar: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_1</span>(<span class="hljs-params">state: InputState</span>) -&gt; OverallState:
    <span class="hljs-comment"># Write to OverallState</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"foo"</span>: state[<span class="hljs-string">"user_input"</span>] + <span class="hljs-string">" name"</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_2</span>(<span class="hljs-params">state: OverallState</span>) -&gt; PrivateState:
    <span class="hljs-comment"># Read from OverallState, write to PrivateState</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"bar"</span>: state[<span class="hljs-string">"foo"</span>] + <span class="hljs-string">" is"</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_3</span>(<span class="hljs-params">state: PrivateState</span>) -&gt; OutputState:
    <span class="hljs-comment"># Read from PrivateState, write to OutputState</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"graph_output"</span>: state[<span class="hljs-string">"bar"</span>] + <span class="hljs-string">" Lance"</span>}

builder = StateGraph(OverallState,input_schema=InputState,output_schema=OutputState)
builder.add_node(<span class="hljs-string">"node_1"</span>, node_1)
builder.add_node(<span class="hljs-string">"node_2"</span>, node_2)
builder.add_node(<span class="hljs-string">"node_3"</span>, node_3)
builder.add_edge(START, <span class="hljs-string">"node_1"</span>)
builder.add_edge(<span class="hljs-string">"node_1"</span>, <span class="hljs-string">"node_2"</span>)
builder.add_edge(<span class="hljs-string">"node_2"</span>, <span class="hljs-string">"node_3"</span>)
builder.add_edge(<span class="hljs-string">"node_3"</span>, END)

graph = builder.<span class="hljs-built_in">compile</span>()
graph.invoke({<span class="hljs-string">"user_input"</span>:<span class="hljs-string">"My"</span>})
<span class="hljs-comment"># {'graph_output': 'My name is Lance'}</span>
</code></pre>
<p>这里有两个需要注意的微妙且重要的点：
我们将 state: InputState 作为输入模式传递给 node_1，但却向 OverallState 中的通道 foo 写入数据。为何能向输入模式中未包含的状态通道写入数据？这是因为节点可以写入图状态中的任意状态通道—— 图状态是初始化时定义的所有状态通道的集合，其中包含 OverallState 以及过滤后的 InputState 和 OutputState。</p>
<p>我们通过以下方式初始化图：</p>
<pre><code class="hljs language-python" lang="python">StateGraph(
    OverallState,
    input_schema=InputState,
    output_schema=OutputState
)
</code></pre>
<p>那么，如何在 node_2 中向 PrivateState 写入数据？如果 PrivateState 未在 StateGraph 初始化时传入，图如何获取该模式的访问权限？
这一操作之所以可行，是因为只要状态模式已定义，节点也可以声明额外的状态通道。本示例中，PrivateState 模式已提前定义，因此我们可以在图中新增 bar 这一状态通道，并向其写入数据。</p>
<h3 data-id="heading-6">2.3 归约函数（Reducers）</h3>
<p>归约函数是理解节点更新如何应用到状态（State）的关键。状态中的每个键（key）都有其独立的归约函数。如果未显式指定归约函数，则默认所有对该键的更新都会覆盖原有值。归约函数包含多种类型，首先介绍默认类型：
默认归约函数（Default Reducer）
以下两个示例展示了默认归约函数的使用方式：
示例A:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    foo: <span class="hljs-built_in">int</span>
    bar: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]
</code></pre>
<p>本示例中，未为任何键指定归约函数。假设图的输入为：{"foo": 1, "bar": ["hi"]}。
若第一个节点返回 {"foo": 2}（节点无需返回完整状态模式，仅需返回待更新的内容），应用该更新后，状态将变为 {"foo": 2, "bar": ["hi"]}；
若第二个节点返回 {"bar": ["bye"]}，状态将进一步更新为 {"foo": 2, "bar": ["bye"]}（bar键的原有值被新列表覆盖）。
示例B:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Annotated
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> add

<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    foo: <span class="hljs-built_in">int</span>
    bar: Annotated[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], add]
</code></pre>
<p>本示例中，我们通过Annotated类型为第二个键（bar）指定了归约函数 operator.add（列表拼接函数），第一个键（foo）仍使用默认归约函数。假设图的输入为 {"foo": 1, "bar": ["hi"]}：
若第一个节点返回 {"foo": 2}，应用更新后状态为 {"foo": 2, "bar": ["hi"]}（foo 键被覆盖，bar 键保持不变）；
若第二个节点返回 {"bar": ["bye"]}，状态将变为 {"foo": 2, "bar": ["hi", "bye"]}（bar 键通过 add 函数将新旧列表拼接，而非覆盖）。</p>
<p>强制覆盖（Overwrite）：
在某些场景下，你可能希望绕过归约函数（reducer），直接覆盖某个状态值。LangGraph为此提供了Overwrite类型来实现这一需求。</p>
<h3 data-id="heading-7">2.4 在图状态中处理消息</h3>
<p>为何使用消息？</p>
<p>大多数主流大语言模型（LLM）提供商都设有聊天模型接口，该接口接收消息列表作为输入。其中，LangChain的聊天模型接口尤其会接收消息对象列表作为输入。这些消息包含多种类型，例如 HumanMessage（用户输入）或 AIMessage（LLM 响应）。</p>
<p>在图中使用消息</p>
<p>在许多场景下，将历史对话记录以消息列表的形式存储在图状态中会非常实用。要实现这一操作，需在图状态中添加一个键（即 “通道”），用于存储消息对象列表，并为该键标注一个归约函数。
归约函数的核心作用是：告知图在每次状态更新时（例如某个节点发送更新时），如何对状态中的消息对象列表进行更新。具体规则如下：</p>
<ul>
<li>若未指定归约函数，每次状态更新都会用最新提供的值覆盖原有的消息列表；</li>
<li>若仅需将新消息追加到现有列表中，可使用 operator.add 作为归约函数。</li>
</ul>
<p>不过，你可能还需要手动更新图状态中的消息（例如 “人机协同（human-in-the-loop）” 场景）。若此时使用 operator.add 作为归约函数，发送给图的手动状态更新会被追加到现有消息列表中，而非更新已有的消息。
为避免这种情况，需要一个能跟踪消息ID的归约函数：当消息被更新时，该函数会覆盖原有消息。LangGraph 提供的预构建函数add_messages可实现此需求 —— 对于全新消息，它会直接追加到列表；对于已有消息的更新，它也能正确处理。</p>
<p>序列化（Serialization）</p>
<p>除了跟踪消息ID，add_messages函数还有一个作用：当messages通道接收到状态更新时，会尝试将消息反序列化为LangChain消息对象。
这一特性支持以以下格式发送图的输入/状态更新：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 支持这种格式</span>
{<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"message"</span>)]}
<span class="hljs-comment"># 也支持这种格式</span>
{<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"message"</span>}]}
</code></pre>
<p>由于使用add_messages时，状态更新总会被反序列化为LangChain消息对象，因此需通过点语法访问消息属性，例如 state["messages"][-1].content（获取最后一条消息的内容）。
以下是一个使用 add_messages 作为归约函数的图示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AnyMessage
<span class="hljs-keyword">from</span> langgraph.graph.message <span class="hljs-keyword">import</span> add_messages
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Annotated
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>[AnyMessage], add_messages]
</code></pre>
<p>消息状态（MessagesState）</p>
<p>由于在状态中存储消息列表是极为常见的需求，LangGraph提供了预构建的MessagesState状态类，简化消息的使用流程。
MessagesState的定义包含一个messages键：该键对应AnyMessage对象列表，并使用add_messages作为归约函数。
通常，图需要跟踪的状态不仅限于消息，因此用户常通过继承MessagesState并添加更多字段来扩展状态，示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessagesState

<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">MessagesState</span>):
    documents: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 新增“文档列表”字段</span>
</code></pre>
<h2 data-id="heading-8">三、节点（Nodes）</h2>
<p>在LangGraph中，节点是Python函数（支持同步或异步），需接收以下参数：</p>
<ul>
<li>state—— 图的当前状态</li>
<li>config——RunnableConfig 对象，包含线程 ID（thread_id）等配置信息，以及标签（tags）等追踪信息</li>
<li>runtime——Runtime 对象，包含运行时上下文及存储（store）、流写入器（stream_writer）等其他信息
与NetworkX类似，你可以通过add_node方法将这些节点添加到图中：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">str</span>
    results: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

builder = StateGraph(State)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">plain_node</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_with_runtime</span>(<span class="hljs-params">state: State, runtime: Runtime[Context]</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"In node: "</span>, runtime.context.user_id)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"results"</span>: <span class="hljs-string">f"Hello, <span class="hljs-subst">{state[<span class="hljs-string">'input'</span>]}</span>!"</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_with_config</span>(<span class="hljs-params">state: State, config: RunnableConfig</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"In node with thread_id: "</span>, config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"thread_id"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"results"</span>: <span class="hljs-string">f"Hello, <span class="hljs-subst">{state[<span class="hljs-string">'input'</span>]}</span>!"</span>}

builder.add_node(<span class="hljs-string">"plain_node"</span>, plain_node)
builder.add_node(<span class="hljs-string">"node_with_runtime"</span>, node_with_runtime)
builder.add_node(<span class="hljs-string">"node_with_config"</span>, node_with_config)
</code></pre>
<p>在底层实现中，这些函数会被转换为RunnableLambda—— 该转换为函数添加了批量处理和异步支持，同时原生集成了追踪和调试功能。
若添加节点时未指定名称，LangGraph会自动使用函数名作为节点的默认名称：</p>
<pre><code class="hljs language-python" lang="python">builder.add_node(my_node)
<span class="hljs-comment"># 之后可通过名称 "my_node" 为该节点创建入边/出边</span>
</code></pre>
<p>起始节点（START Node）</p>
<p>START 是一个特殊节点，用于表示接收用户输入并启动图执行的节点。引用该节点的核心目的是指定图的首个执行节点：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START

graph.add_edge(START, <span class="hljs-string">"node_a"</span>)  <span class="hljs-comment"># 从起始节点指向 "node_a"，即 "node_a" 为首个执行节点</span>
</code></pre>
<p>终止节点（END Node）</p>
<p>END 是一个特殊节点，代表图的终止节点。当某条边指向该节点时，意味着这条路径执行完毕后不再有后续操作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> END

graph.add_edge(<span class="hljs-string">"node_a"</span>, END)  <span class="hljs-comment"># "node_a" 执行完毕后，图终止运行</span>
</code></pre>
<p>节点缓存（Node Caching）</p>
<p>LangGraph 支持基于节点输入对任务 / 节点结果进行缓存。使用缓存需执行以下两步：
编译图（或指定入口点）时配置缓存（cache）
为节点指定缓存策略（cache_policy），该策略支持两个配置项：
key_func：基于节点输入生成缓存键的函数，默认使用 pickle 对输入进行哈希运算
ttl：缓存有效期（单位：秒），未指定时缓存永久有效
示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> langgraph.cache.memory <span class="hljs-keyword">import</span> InMemoryCache
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> CachePolicy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    x: <span class="hljs-built_in">int</span>
    result: <span class="hljs-built_in">int</span>

builder = StateGraph(State)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">expensive_node</span>(<span class="hljs-params">state: State</span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>]:
    <span class="hljs-comment"># 模拟耗时计算</span>
    time.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"result"</span>: state[<span class="hljs-string">"x"</span>] * <span class="hljs-number">2</span>}

<span class="hljs-comment"># 为节点指定缓存策略：有效期 3 秒</span>
builder.add_node(<span class="hljs-string">"expensive_node"</span>, expensive_node, cache_policy=CachePolicy(ttl=<span class="hljs-number">3</span>))
builder.set_entry_point(<span class="hljs-string">"expensive_node"</span>)  <span class="hljs-comment"># 设置入口节点</span>
builder.set_finish_point(<span class="hljs-string">"expensive_node"</span>)  <span class="hljs-comment"># 设置终止节点</span>

<span class="hljs-comment"># 编译图时配置内存缓存</span>
graph = builder.<span class="hljs-built_in">compile</span>(cache=InMemoryCache())

<span class="hljs-comment"># 首次调用：执行耗时计算，需 2 秒</span>
<span class="hljs-built_in">print</span>(graph.invoke({<span class="hljs-string">"x"</span>: <span class="hljs-number">5</span>}, stream_mode=<span class="hljs-string">'updates'</span>))  
<span class="hljs-comment"># 输出：[{'expensive_node': {'result': 10}}]</span>

<span class="hljs-comment"># 第二次调用：命中缓存，快速返回</span>
<span class="hljs-built_in">print</span>(graph.invoke({<span class="hljs-string">"x"</span>: <span class="hljs-number">5</span>}, stream_mode=<span class="hljs-string">'updates'</span>))  
<span class="hljs-comment"># 输出：[{'expensive_node': {'result': 10}, '__metadata__': {'cached': True}}]</span>
</code></pre>
<p>说明：
首次调用因模拟耗时计算，需2秒完成；
第二次调用时，输入与缓存键匹配，直接返回缓存结果，执行速度极快。</p>
<h2 data-id="heading-9">四、边（Edges）</h2>
<p>边定义了逻辑的路由方式以及图如何决定终止，这是智能体实现工作流程、不同节点间实现通信的核心环节。边主要包含以下几种关键类型：</p>
<ul>
<li>普通边（Normal Edges）：直接从一个节点指向另一个节点。</li>
<li>条件边（Conditional Edges）：通过调用函数来决定下一步指向哪个（或哪些）节点。</li>
<li>入口点（Entry Point）：用户输入到达时，首个执行的节点。</li>
<li>条件入口点（Conditional Entry Point）：通过调用函数来决定用户输入到达时，首个执行的节点（或多个节点）。</li>
</ul>
<p>一个节点可以有多个出边。若某个节点存在多条出边，那么所有出边指向的目标节点会在下一个超步（superstep）中并行执行。</p>
<p>普通边（Normal Edges）</p>
<p>若希望始终从节点 A 指向节点 B，可直接使用 add_edge 方法：</p>
<pre><code class="hljs language-python" lang="python">graph.add_edge(<span class="hljs-string">"node_a"</span>, <span class="hljs-string">"node_b"</span>)
</code></pre>
<p>条件边（Conditional Edges）</p>
<p>若需根据条件选择路由到一条或多条边（或选择终止），可使用add_conditional_edges 方法。该方法需传入源节点名称，以及在该节点执行后调用的 “路由函数（routing_function）”：</p>
<pre><code class="hljs language-python" lang="python">graph.add_edge(<span class="hljs-string">"node_a"</span>, routing_function)
</code></pre>
<p>与节点类似，路由函数会接收图的当前状态作为输入，并返回一个值。默认情况下，路由函数的返回值会作为下一步要传递状态的节点名称（或节点名称列表），这些节点将在下一个超步中并行执行。
你也可以选择性地传入一个字典，将路由函数的输出与下一个节点的名称进行映射：</p>
<pre><code class="hljs language-python" lang="python">graph.add_conditional_edges(<span class="hljs-string">"node_a"</span>, routing_function, {<span class="hljs-literal">True</span>: <span class="hljs-string">"node_b"</span>, <span class="hljs-literal">False</span>: <span class="hljs-string">"node_c"</span>})
</code></pre>
<p>若你希望在单个函数中同时实现状态更新与路由逻辑，建议使用 Command（而非条件边）。</p>
<p>入口点（Entry Point）</p>
<p>入口点是图启动时首个执行的节点（或多个节点）。你可以通过从虚拟节点 START 向首个执行节点添加边，来指定图的入口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START

graph.add_edge(START, <span class="hljs-string">"node_a"</span>)
</code></pre>
<p>条件入口点（Conditional Entry Point）</p>
<p>条件入口点允许根据自定义逻辑，从不同节点启动图的执行。你可以通过从虚拟节点 START 添加条件边来实现这一功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START

graph.add_conditional_edges(START, routing_function)
</code></pre>
<p>你也可以选择性地传入一个字典，将路由函数的输出与下一个节点的名称进行映射：</p>
<pre><code class="hljs language-python" lang="python">graph.add_conditional_edges(START, routing_function, {<span class="hljs-literal">True</span>: <span class="hljs-string">"node_b"</span>, <span class="hljs-literal">False</span>: <span class="hljs-string">"node_c"</span>})
</code></pre>
<h2 data-id="heading-10">五、发送（Send）</h2>
<p>默认情况下，节点（Nodes）和边（Edges）是提前定义好的，且基于同一个共享状态运行。但在某些场景下，可能无法提前确定具体的边，或者需要同时存在多个不同版本的状态（State）。map-reduce设计模式就是一个典型例子：在该模式中，第一个节点可能会生成一个对象列表，而你需要将另一个节点应用于这个列表中的所有对象。由于对象的数量可能无法提前预知（意味着边的数量也不确定），且下游节点的输入状态应当各不相同（每个生成的对象对应一个独立状态）。
为支持这种设计模式，LangGraph允许从条件边（conditional edges）中返回Send对象。Send接收两个参数：第一个是目标节点的名称，第二个是要传递给该节点的状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">continue_to_jokes</span>(<span class="hljs-params">state: OverallState</span>):
    <span class="hljs-keyword">return</span> [Send(<span class="hljs-string">"generate_joke"</span>, {<span class="hljs-string">"subject"</span>: s}) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> state[<span class="hljs-string">'subjects'</span>]]

graph.add_conditional_edges(<span class="hljs-string">"node_a"</span>, continue_to_jokes)
</code></pre>
<h2 data-id="heading-11">六、命令（Command）</h2>
<p>将控制流（边）和状态更新（节点）结合使用会非常实用。例如，你可能希望在同一个节点中既执行状态更新，又决定下一步跳转至哪个节点。LangGraph支持通过从节点函数中返回Command对象来实现这一需求：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_node</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">"my_other_node"</span>]]:
    <span class="hljs-keyword">return</span> Command(
        <span class="hljs-comment"># 状态更新</span>
        update={<span class="hljs-string">"foo"</span>: <span class="hljs-string">"bar"</span>},
        <span class="hljs-comment"># 控制流（跳转目标）</span>
        goto=<span class="hljs-string">"my_other_node"</span>
    )
</code></pre>
<p>通过 Command 还能实现动态控制流行为（与条件边功能一致）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_node</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">"my_other_node"</span>]]:
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"foo"</span>] == <span class="hljs-string">"bar"</span>:
        <span class="hljs-keyword">return</span> Command(update={<span class="hljs-string">"foo"</span>: <span class="hljs-string">"baz"</span>}, goto=<span class="hljs-string">"my_other_node"</span>)
</code></pre>
<p>当节点函数返回 Command 时，必须添加返回类型注解，明确该节点可路由到的所有节点名称（例如 Command[Literal["my_other_node"]]）。这一步骤对图渲染至关重要，同时能告知 LangGraph：my_node 可跳转至 my_other_node。</p>
<p>何时使用 Command 而非条件边？</p>
<p>当你需要同时更新图状态并路由到其他节点时，使用 Command。例如，在实现多智能体交接（multi-agent handoffs）时，不仅需要跳转到其他智能体，还需向该智能体传递信息，此时 Command 是最佳选择。
当你只需基于条件在节点间路由，无需更新状态时，使用条件边。</p>
<p>跳转到父图中的节点</p>
<p>若你在使用子图（subgraphs），可能需要从子图内的某个节点跳转到另一个子图（即父图中的某个节点）。此时，可在 Command 中指定 graph=Command.PARENT 来实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_node</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">"other_subgraph"</span>]]:
    <span class="hljs-keyword">return</span> Command(
        update={<span class="hljs-string">"foo"</span>: <span class="hljs-string">"bar"</span>},
        goto=<span class="hljs-string">"other_subgraph"</span>,  <span class="hljs-comment"># "other_subgraph" 是父图中的节点</span>
        graph=Command.PARENT
    )
</code></pre>
<p>将 graph 设置为 Command.PARENT 后，会跳转到最近的父图。
注意：若子图节点向父图节点发送状态更新，且更新的键（key）在父图和子图的状态模式中均存在，则必须在父图状态中为该键定义归约函数。
这一特性在实现多智能体交接时尤为实用。</p>
<p>在工具中使用 Command</p>
<p>一个常见场景是从工具内部更新图状态。例如，在客户支持应用中，你可能需要在对话初期根据客户的账号或ID查询客户信息。</p>
<p>人机协同（Human-in-the-loop）</p>
<p>Command 是人机协同工作流的重要组成部分：当使用 interrupt() 收集用户输入后，可通过 Command(resume="用户输入内容") 提交输入并恢复图的执行。</p>
<h2 data-id="heading-12">七、图迁移（Graph Migrations）</h2>
<p>即便使用检查点工具（checkpointer）跟踪状态，LangGraph也能轻松处理图定义（节点、边和状态）的迁移。</p>
<ul>
<li>对于处于图执行末尾的线程（即未被中断的线程），你可以修改图的完整拓扑结构（例如添加、删除、重命名所有节点和边等）。</li>
<li>对于当前处于中断状态的线程，我们支持除 “重命名 / 删除节点” 之外的所有拓扑结构修改（因为该线程接下来可能要进入一个已不存在的节点）。</li>
<li>在状态修改方面，新增或删除状态键（key）时，我们提供完全的向前兼容和向后兼容性。</li>
<li>被重命名的状态键会丢失其在现有线程中已保存的状态。</li>
<li>若状态键的类型发生不兼容的变更，可能会导致线程中存储的 “变更前状态” 出现问题。</li>
</ul>
<h2 data-id="heading-13">八、运行时上下文（Runtime Context）</h2>
<p>创建图时，你可以为传递给节点的运行时上下文指定 <code>context_schema</code>（上下文模式）。这一功能适用于传递不属于图状态的信息 —— 例如，你可能需要传递模型名称、数据库连接等依赖项。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextSchema</span>:
    llm_provider: <span class="hljs-built_in">str</span> = <span class="hljs-string">"openai"</span>  <span class="hljs-comment"># 大语言模型提供商，默认值为 "openai"</span>

graph = StateGraph(State, context_schema=ContextSchema)
</code></pre>
<p>之后，可通过 <code>invoke</code> 方法的 <code>context</code> 参数将该上下文传入图中：</p>
<pre><code class="hljs language-python" lang="python">graph.invoke(inputs, context={<span class="hljs-string">"llm_provider"</span>: <span class="hljs-string">"anthropic"</span>})
</code></pre>
<p>在节点或条件边中，你可以访问并使用该上下文：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_a</span>(<span class="hljs-params">state: State, runtime: Runtime[ContextSchema]</span>):
    llm = get_llm(runtime.context.llm_provider)  <span class="hljs-comment"># 获取对应提供商的 LLM 实例</span>
    <span class="hljs-comment"># ... 后续业务逻辑</span>
</code></pre>
<p>递归限制（Recursion Limit）</p>
<p>递归限制用于设置图在单次执行过程中最多可运行的 “超步（super-step）” 数量。一旦达到该限制，LangGraph 会抛出 <code>GraphRecursionError</code> 异常。默认情况下，递归限制值为 25 步。
你可以在运行时为任意图设置递归限制，通过 <code>config</code> 字典将其传入 <code>invoke</code> 或 <code>stream</code> 方法。 <strong>注意</strong> ：<code>recursion_limit</code> 是独立的配置键，无需像其他用户自定义配置那样放在 <code>configurable</code> 键内。</p>
<p>示例如下：</p>
<pre><code class="hljs language-python" lang="python">graph.invoke(inputs, config={<span class="hljs-string">"recursion_limit"</span>: <span class="hljs-number">5</span>}, context={<span class="hljs-string">"llm"</span>: <span class="hljs-string">"anthropic"</span>})
</code></pre>
<p>访问和处理递归计数器</p>
<p>任意节点内都可通过 <code>config["metadata"]["langgraph_step"]</code> 获取当前执行步数，从而在达到递归限制前主动处理递归逻辑 —— 这能让你在图的逻辑中实现 “优雅降级” 策略。</p>
<p>工作原理</p>
<p>步数计数器存储在 <code>config["metadata"]["langgraph_step"]</code> 中。递归限制的校验逻辑为：<code>step &gt; stop</code>（其中 <code>stop = step + recursion_limit + 1</code>）。当超出限制时，LangGraph 会抛出 <code>GraphRecursionError</code>。</p>
<p>访问当前步数计数器</p>
<p>你可以在任意节点内访问当前步数，以监控执行进度：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph

<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_node</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span>, config: RunnableConfig</span>) -&gt; <span class="hljs-built_in">dict</span>:
    current_step = config[<span class="hljs-string">"metadata"</span>][<span class="hljs-string">"langgraph_step"</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前步数：<span class="hljs-subst">{current_step}</span>"</span>)
    <span class="hljs-keyword">return</span> state
</code></pre>
<p>主动递归处理</p>
<p>你可以检查步数计数器，并在达到限制前主动路由到其他节点，实现图的优雅降级：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END

<span class="hljs-keyword">def</span> <span class="hljs-title function_">reasoning_node</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span>, config: RunnableConfig</span>) -&gt; <span class="hljs-built_in">dict</span>:
    current_step = config[<span class="hljs-string">"metadata"</span>][<span class="hljs-string">"langgraph_step"</span>]
    recursion_limit = config[<span class="hljs-string">"recursion_limit"</span>]  <span class="hljs-comment"># 始终存在，默认值为 25</span>

    <span class="hljs-comment"># 检查是否接近限制（例如，达到限制的 80% 阈值）</span>
    <span class="hljs-keyword">if</span> current_step &gt;= recursion_limit * <span class="hljs-number">0.8</span>:
        <span class="hljs-keyword">return</span> {
            **state,
            <span class="hljs-string">"route_to"</span>: <span class="hljs-string">"fallback"</span>,  <span class="hljs-comment"># 标记路由目标为降级节点</span>
            <span class="hljs-string">"reason"</span>: <span class="hljs-string">"Approaching recursion limit"</span>  <span class="hljs-comment"># 原因：接近递归限制</span>
        }

    <span class="hljs-comment"># 正常业务处理</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: state[<span class="hljs-string">"messages"</span>] + [<span class="hljs-string">"thinking..."</span>]}  <span class="hljs-comment"># 追加思考过程</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fallback_node</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span>, config: RunnableConfig</span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""处理接近递归限制的场景"""</span>
    <span class="hljs-keyword">return</span> {
        **state,
        <span class="hljs-string">"messages"</span>: state[<span class="hljs-string">"messages"</span>] + [<span class="hljs-string">"已达到复杂度限制，提供最佳努力答案"</span>]
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_based_on_state</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">"route_to"</span>) == <span class="hljs-string">"fallback"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"fallback"</span>  <span class="hljs-comment"># 路由到降级节点</span>
    <span class="hljs-keyword">elif</span> state.get(<span class="hljs-string">"done"</span>):
        <span class="hljs-keyword">return</span> END  <span class="hljs-comment"># 执行完成，路由到终止节点</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"reasoning"</span>  <span class="hljs-comment"># 继续路由到推理节点</span>

<span class="hljs-comment"># 构建图</span>
graph = StateGraph(<span class="hljs-built_in">dict</span>)
graph.add_node(<span class="hljs-string">"reasoning"</span>, reasoning_node)  <span class="hljs-comment"># 推理节点</span>
graph.add_node(<span class="hljs-string">"fallback"</span>, fallback_node)    <span class="hljs-comment"># 降级节点</span>
graph.add_conditional_edges(<span class="hljs-string">"reasoning"</span>, route_based_on_state)  <span class="hljs-comment"># 推理节点的条件边</span>
graph.add_edge(<span class="hljs-string">"fallback"</span>, END)  <span class="hljs-comment"># 降级节点执行后终止</span>
graph.set_entry_point(<span class="hljs-string">"reasoning"</span>)  <span class="hljs-comment"># 入口节点为推理节点</span>

app = graph.<span class="hljs-built_in">compile</span>()
</code></pre>
<p>主动式 vs 响应式处理方案</p>
<p>处理递归限制主要有两种方案：主动式（在图内监控）和响应式（在外部捕获错误）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END
<span class="hljs-keyword">from</span> langgraph.errors <span class="hljs-keyword">import</span> GraphRecursionError

<span class="hljs-comment"># 主动式方案（推荐）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_with_monitoring</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span>, config: RunnableConfig</span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""在图内主动监控并处理递归"""</span>
    current_step = config[<span class="hljs-string">"metadata"</span>][<span class="hljs-string">"langgraph_step"</span>]
    recursion_limit = config[<span class="hljs-string">"recursion_limit"</span>]

    <span class="hljs-comment"># 提前检测——路由到内部处理逻辑（距离限制还有 2 步时）</span>
    <span class="hljs-keyword">if</span> current_step &gt;= recursion_limit - <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> {
            **state,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"recursion_limit_approaching"</span>,
            <span class="hljs-string">"final_answer"</span>: <span class="hljs-string">"已达到迭代限制，返回部分结果"</span>
        }

    <span class="hljs-comment"># 正常业务处理</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: state[<span class="hljs-string">"messages"</span>] + [<span class="hljs-string">f"第 <span class="hljs-subst">{current_step}</span> 步"</span>]}

<span class="hljs-comment"># 响应式方案（降级方案）</span>
<span class="hljs-keyword">try</span>:
    result = graph.invoke(initial_state, {<span class="hljs-string">"recursion_limit"</span>: <span class="hljs-number">10</span>})
<span class="hljs-keyword">except</span> GraphRecursionError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># 图执行失败后，在外部处理</span>
    result = fallback_handler(initial_state)
</code></pre>
<p>两种方案的核心差异如下：</p>























<table><thead><tr><th align="left">方案</th><th align="left">检测时机</th><th align="left">处理位置</th><th align="left">控制流</th></tr></thead><tbody><tr><td align="left">主动式（使用 langgraph_step）</td><td align="left">达到限制前</td><td align="left">图内部（通过条件路由）</td><td align="left">图继续执行至完成节点</td></tr><tr><td align="left">响应式（捕获 GraphRecursionError）</td><td align="left">超出限制后</td><td align="left">图外部（try/catch 块）</td><td align="left">图执行终止</td></tr></tbody></table>
<p>主动式方案优势：</p>
<ul>
<li>图内实现优雅降级</li>
<li>可在检查点中保存中间状态</li>
<li>返回部分结果，提升用户体验</li>
<li>图正常完成执行（无异常抛出）</li>
</ul>
<p>响应式方案优势：</p>
<ul>
<li>实现更简洁</li>
<li>无需修改图逻辑</li>
<li>集中式错误处理</li>
</ul>
<p>其他可用元数据</p>
<p>除 <code>langgraph_step</code> 外，<code>config["metadata"]</code> 中还包含以下元数据：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inspect_metadata</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span>, config: RunnableConfig</span>) -&gt; <span class="hljs-built_in">dict</span>:
    metadata = config[<span class="hljs-string">"metadata"</span>]

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步数：<span class="hljs-subst">{metadata[<span class="hljs-string">'langgraph_step'</span>]}</span>"</span>)  <span class="hljs-comment"># 当前执行步数</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"节点：<span class="hljs-subst">{metadata[<span class="hljs-string">'langgraph_node'</span>]}</span>"</span>)  <span class="hljs-comment"># 当前执行的节点名称</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"触发器：<span class="hljs-subst">{metadata[<span class="hljs-string">'langgraph_triggers'</span>]}</span>"</span>)  <span class="hljs-comment"># 触发当前节点的事件</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"路径：<span class="hljs-subst">{metadata[<span class="hljs-string">'langgraph_path'</span>]}</span>"</span>)  <span class="hljs-comment"># 已执行的节点路径（历史）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"检查点命名空间：<span class="hljs-subst">{metadata[<span class="hljs-string">'langgraph_checkpoint_ns'</span>]}</span>"</span>)  <span class="hljs-comment"># 检查点命名空间</span>

    <span class="hljs-keyword">return</span> state
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接口 QPS 从 100 飙到 1000？从应急到根治的全流程优化方案]]></title>    <link>https://juejin.cn/post/7576098886859767851</link>    <guid>https://juejin.cn/post/7576098886859767851</guid>    <pubDate>2025-11-24T09:37:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576098886859767851" data-draft-id="7575829296453058570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接口 QPS 从 100 飙到 1000？从应急到根治的全流程优化方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-24T09:37:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接口 QPS 从 100 飙到 1000？从应急到根治的全流程优化方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:37:08.000Z" title="Mon Nov 24 2025 09:37:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">接口 QPS 从 100 飙到 1000？从应急到根治的全流程优化方案</h2>
<p>做后端开发时，最措手不及的场景莫过于 “接口 QPS 突然 10 倍暴涨”—— 原本平稳运行的接口（100 QPS，响应时间 50ms），因活动推广、流量红利等原因，QPS 骤增至 1000，响应时间瞬间飙到 500ms 以上，甚至出现大量超时。此时若盲目优化代码，可能错过 “止血” 最佳时机；若只靠扩容，又会掩盖深层瓶颈。</p>
<p>本文结合真实项目案例，拆解 “QPS 突增响应延迟” 的完整优化流程，从 “快速恢复业务” 到 “根治性能瓶颈”，覆盖应急手段、根因定位、分层优化与长效预防，帮你从容应对流量峰值。</p>
<h3 data-id="heading-1">一、第一步：应急处理 —— 先 “止血”，再查因</h3>
<p>当 QPS 突增导致响应延迟时，核心优先级是 “保障核心业务可用”，而非立刻找到根因。以下 3 个应急手段可在 5-10 分钟内快速缓解压力：</p>
<h4 data-id="heading-2">1. 限流：挡住超出承载能力的流量</h4>
<p>限流是 “最直接的止血手段”—— 通过限制每秒处理的请求数，避免接口被压垮，确保存活的请求能正常响应。</p>
<h5 data-id="heading-3">（1）选择合适的限流策略</h5>
<ul>
<li><strong>固定窗口限流</strong>：限制每秒最多处理 1200 个请求（比当前 QPS 1000 高 20%，留缓冲），超出的请求直接返回 “503 Service Unavailable” 或 “请稍后重试”；</li>
</ul>

<ul>
<li><strong>令牌桶限流</strong>：允许短时间突发流量（如瞬间 1500 QPS），长期稳定在 1200 QPS，更贴合实际流量波动。</li>
</ul>
<h5 data-id="heading-4">（2）落地方式（快速见效）</h5>
<ul>
<li><strong>网关层限流</strong>：若有 API 网关（如 Spring Cloud Gateway、Nginx），直接在网关配置限流，无需修改接口代码（推荐优先用）：</li>
</ul>

<ul>
<li>
<ul>
<li>Nginx 示例（ngx_http_limit_req_module）：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 定义限流规则：zone=api_limit表示创建内存区域，rate=1200r/s表示每秒1200个请求</span>
limit_req_zone $binary_remote_addr <span class="hljs-attr">zone</span>=api_limit:<span class="hljs-number">10</span>m rate=<span class="hljs-number">1200</span>r/s<span class="hljs-comment">;</span>
server {
  location /api/your-interface {
    <span class="hljs-comment"># 应用限流规则，burst=200表示允许200个请求排队</span>
    limit_req <span class="hljs-attr">zone</span>=api_limit burst=<span class="hljs-number">200</span> nodelay<span class="hljs-comment">;</span>
    <span class="hljs-comment"># 超出限流返回503，自定义响应内容</span>
    limit_req_status 503<span class="hljs-comment">;</span>
    error_page <span class="hljs-attr">503</span> = @limit<span class="hljs-comment">;</span>
  }
  
  location @limit {
    return 503 '{"code":503,"msg":"当前请求过多，请稍后重试"}'<span class="hljs-comment">;</span>
  }
}
</code></pre>
<ul>
<li>
<ul>
<li>Spring Cloud Gateway 示例（结合 Resilience4j）：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class GatewayConfig {
    <span class="hljs-variable">@Bean</span>
    public RouteLocator <span class="hljs-built_in">customRouteLocator</span>(RouteLocatorBuilder builder) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">builder</span><span class="hljs-selector-class">.routes</span>()
                <span class="hljs-selector-class">.route</span>(<span class="hljs-string">"your_api"</span>, r -&gt; r.<span class="hljs-built_in">path</span>(<span class="hljs-string">"/api/your-interface"</span>)
                        .<span class="hljs-built_in">filters</span>(f -&gt; f
                                <span class="hljs-comment">// 限流：每秒1200个请求，允许200个请求排队</span>
                                .<span class="hljs-built_in">requestRateLimiter</span>(c -&gt; c
                                        .<span class="hljs-built_in">setRateLimiter</span>(<span class="hljs-built_in">redisRateLimiter</span>())
                                        .<span class="hljs-built_in">setKeyResolver</span>(<span class="hljs-built_in">userKeyResolver</span>())))
                .<span class="hljs-built_in">uri</span>(<span class="hljs-string">"lb://your-service"</span>))
                <span class="hljs-selector-class">.build</span>();
    }
}
</code></pre>
<ul>
<li><strong>接口层限流</strong>：若无网关，直接在接口代码中加限流（用 Guava RateLimiter）：</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YourController</span> {
    <span class="hljs-comment">// 初始化令牌桶：每秒1200个令牌</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RateLimiter rateLimiter = RateLimiter.create(<span class="hljs-number">1200.0</span>);
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/your-interface"</span>)</span>
    <span class="hljs-keyword">public</span> ResultDTO yourInterface() {
        <span class="hljs-comment">// 尝试获取令牌，100ms内获取不到则返回限流</span>
        <span class="hljs-keyword">if</span> (!rateLimiter.tryAcquire(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
            <span class="hljs-keyword">return</span> ResultDTO.fail(<span class="hljs-number">503</span>, <span class="hljs-string">"当前请求过多，请稍后重试"</span>);
        }
        <span class="hljs-comment">// 正常业务逻辑</span>
        <span class="hljs-keyword">return</span> service.doBusiness();
    }
}
</code></pre>
<h5 data-id="heading-5">（3）关键注意点</h5>
<ul>
<li>优先在网关限流：避免无效请求打到业务服务，节省服务器资源；</li>
</ul>

<ul>
<li>自定义限流响应：不要返回默认 503 页面，返回 JSON 格式的友好提示（方便前端处理）；</li>
</ul>

<ul>
<li>监控限流效果：统计 “限流次数 / 成功次数”，若限流次数占比超过 30%，说明限流阈值可能过低，需适当调整。</li>
</ul>
<h4 data-id="heading-6">2. 降级：砍掉非核心功能，释放资源</h4>
<p>若限流后响应延迟仍未改善，说明接口本身的 “单位请求耗时” 过高，需通过 “降级非核心功能” 减少资源消耗，提升响应速度。</p>
<h5 data-id="heading-7">（1）识别可降级的功能</h5>
<ul>
<li>非核心查询：如接口中 “查询用户历史行为”“统计访问次数” 等不影响主流程的功能；</li>
</ul>

<ul>
<li>第三方依赖：如调用 “短信通知”“广告推荐” 等非核心第三方接口（可改为异步或暂时关闭）。</li>
</ul>
<h5 data-id="heading-8">（2）降级示例</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class YourService {
    <span class="hljs-comment">// 降级开关：用配置中心（如Nacos）动态控制，无需重启服务</span>
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${feature.degrade.non-core:false}"</span>)
    private boolean degradeNonCore;
    
    public ResultDTO <span class="hljs-built_in">doBusiness</span>() {
        <span class="hljs-comment">// 1. 核心业务逻辑（必须保留）</span>
        UserDTO user = <span class="hljs-built_in">getUserInfo</span>(); <span class="hljs-comment">// 核心：获取用户信息</span>
        OrderDTO <span class="hljs-attribute">order</span> = <span class="hljs-built_in">createOrder</span>(user); <span class="hljs-comment">// 核心：创建订单</span>
        
        <span class="hljs-comment">// 2. 非核心业务逻辑（根据降级开关决定是否执行）</span>
        if (!degradeNonCore) {
            try {
                <span class="hljs-comment">// 非核心：统计订单创建次数（降级后不执行）</span>
                statService<span class="hljs-selector-class">.countOrder</span>(user.getId());
                <span class="hljs-comment">// 非核心：推送营销短信（降级后不执行）</span>
                smsService<span class="hljs-selector-class">.sendMarketingSms</span>(user.getPhone());
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("非核心功能执行失败", e);
                <span class="hljs-comment">// 非核心功能失败不影响主流程，仅日志记录</span>
            }
        }
        
        return ResultDTO<span class="hljs-selector-class">.success</span>(order);
    }
}
</code></pre>
<h5 data-id="heading-9">（3）效果</h5>
<p>降级非核心功能后，接口平均耗时从 500ms 降至 200ms 以内 —— 因非核心功能（如统计、短信）可能占总耗时的 60%，砍掉后资源释放，核心逻辑响应速度大幅提升。</p>
<h4 data-id="heading-10">3. 扩容：临时增加承载能力</h4>
<p>若限流和降级后，核心业务仍有延迟（如 QPS 1000 仍超过单实例承载），需快速扩容服务实例，分摊请求压力。</p>
<h5 data-id="heading-11">（1）扩容方式</h5>
<ul>
<li><strong>无状态服务</strong>：直接增加容器实例（如 K8s kubectl scale deployment your-service --replicas=5，从 2 实例扩到 5 实例），配合负载均衡（如 Nginx、K8s Service）自动分发流量；</li>
</ul>

<ul>
<li><strong>有状态服务</strong>：若接口依赖本地缓存（如 HashMap），需先将缓存迁移到分布式缓存（如 Redis），再扩容（避免缓存不一致）。</li>
</ul>
<h5 data-id="heading-12">（2）注意点</h5>
<ul>
<li>扩容前检查依赖：确保数据库、Redis 等下游服务能承受扩容后的请求（如接口 QPS 1000 扩到 5 实例，每个实例 200 QPS，需确认数据库能扛住 1000 QPS 查询）；</li>
</ul>

<ul>
<li>扩容后监控：观察实例 CPU、内存使用率，若仍超过 70%，需继续扩容或优化代码。</li>
</ul>
<h3 data-id="heading-13">二、第二步：根因定位 —— 分层排查，找到 “卡脖子” 的环节</h3>
<p>应急处理后，业务恢复正常，接下来需定位 “QPS 从 100 到 1000 为何会延迟”，避免下次流量再来时重复应急。核心思路是 “从接口到下游，分层排查瓶颈”，重点关注<strong>应用层、数据层、依赖层</strong>。</p>
<h4 data-id="heading-14">1. 应用层排查：接口本身是否低效？</h4>
<p>应用层是请求处理的入口，常见瓶颈有 “线程池满、代码低效、GC 频繁”。</p>
<h5 data-id="heading-15">（1）线程池瓶颈排查</h5>
<ul>
<li>工具：用jstack查看线程状态，或用 Spring Boot Actuator 暴露/actuator/threaddump接口；</li>
</ul>

<ul>
<li>关键指标：查看 “BLOCKED”“WAITING” 状态的线程数，若超过线程池核心线程数的 50%，说明线程池满。</li>
</ul>

<ul>
<li>示例：若接口用 Spring @Async异步处理，线程池corePoolSize=10，maxPoolSize=20，QPS 1000 时，任务排队超过 1000 个，导致响应延迟。</li>
</ul>
<h5 data-id="heading-16">（2）代码低效排查</h5>
<ul>
<li>工具：用 Arthas（阿里开源）跟踪接口调用链，定位耗时久的方法：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动Arthas，attach到应用进程</span>
java -jar arthas-boot.jar
<span class="hljs-comment"># 2. 跟踪接口方法，查看每个子方法耗时</span>
trace com.yourpackage.YourService doBusiness -n 100
</code></pre>
<ul>
<li>常见问题：</li>
</ul>

<ul>
<li>
<ul>
<li>循环调用数据库：如 “查询订单列表后，循环查询每个订单的详情”（N+1 查询问题）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>大对象序列化：如接口返回全量用户信息（包含冗余字段），JSON 序列化耗时久；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>同步等待：如调用第三方接口时，同步等待 3 秒超时，无异步或超时时间设置过长。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-17">（3）JVM GC 排查</h5>
<ul>
<li>工具：用jstat -gc 进程ID 1000查看 GC 情况，或用 VisualVM 分析 GC 日志；</li>
</ul>

<ul>
<li>关键指标：若 Full GC 每秒超过 1 次，或 Young GC 每次耗时超过 100ms，说明 GC 频繁导致线程暂停，响应延迟。</li>
</ul>

<ul>
<li>原因：堆内存设置过小（如 JVM -Xms2g -Xmx2g，QPS 1000 时内存不够用），或内存泄漏（如 ArrayList 未清理，持续增长）。</li>
</ul>
<h4 data-id="heading-18">2. 数据层排查：数据库 / Redis 是否拖后腿？</h4>
<p>数据层是接口延迟的 “重灾区”，QPS 从 100 到 1000 时，数据库查询、Redis 操作的瓶颈会被放大。</p>
<h5 data-id="heading-19">（1）数据库瓶颈排查</h5>
<ul>
<li><strong>慢查询</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li>开启 MySQL 慢查询日志（slow_query_log=1，long_query_time=100，记录耗时 &gt; 100ms 的 SQL）；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>用explain分析慢 SQL，查看是否走索引、是否全表扫描：</li>
</ol>
</li>
</ol>
<ul>
<li>
<ul>
<li>
<ul>
<li>示例：select * from order where user_id=123 未建user_id索引，QPS 100 时可能不明显，QPS 1000 时全表扫描导致延迟飙升；</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li><strong>连接池满</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li>查看数据库连接数（MySQL show status like 'Threads_connected'）；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>对比应用配置的连接池大小（如 HikariCP maximum-pool-size=20），若Threads_connected接近连接池上限，说明连接不够用，请求排队等待连接。</li>
</ol>
</li>
</ol>
<h5 data-id="heading-20">（2）Redis 瓶颈排查</h5>
<ul>
<li><strong>缓存命中率低</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li>查看 Redis 命中率（info stats | grep keyspace_hits，命中率=keyspace_hits/(keyspace_hits+keyspace_misses)）；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>若命中率 &lt; 80%，说明大量请求未命中缓存，直接查数据库，导致数据库压力大；</li>
</ol>
</li>
</ol>
<ul>
<li><strong>Redis 性能瓶颈</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li>查看 Redis 每秒操作数（info stats | grep instantaneous_ops_per_sec），若超过 10 万 / 秒（单实例 Redis 建议上限），说明 Redis 过载；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>查看 Redis 慢命令（slowlog get），是否有keys *、hgetall等耗时命令（QPS 1000 时，这些命令会阻塞 Redis）。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-21">3. 依赖层排查：第三方接口是否超时？</h4>
<p>若接口调用了第三方服务（如支付接口、地图接口），QPS 突增时第三方接口可能成为瓶颈：</p>
<ul>
<li>直接调用测试：在应用服务器上用curl测试第三方接口响应时间：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试第三方接口耗时，重复10次取平均</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..10}; <span class="hljs-keyword">do</span> curl -w <span class="hljs-string">"%{time_total}\n"</span> -o /dev/null -s <span class="hljs-string">"https://thirdparty-api.com/xxx"</span>; <span class="hljs-keyword">done</span>
</code></pre>
<ul>
<li>若第三方接口平均耗时从 50ms 增至 300ms，说明第三方服务也被 QPS 突增影响，需协商扩容或改为异步调用。</li>
</ul>
<h3 data-id="heading-22">三、第三步：分层优化 —— 从 “能跑” 到 “跑得快”</h3>
<p>定位到根因后，需针对性优化，让接口在 QPS 1000 时仍能稳定在低延迟（如 &lt; 100ms）。</p>
<h4 data-id="heading-23">1. 应用层优化：提升接口本身效率</h4>
<h5 data-id="heading-24">（1）线程池调优（解决线程排队）</h5>
<p>根据 QPS 和单请求耗时，计算合适的线程池大小：</p>
<ul>
<li>公式：核心线程数 = QPS × 单请求耗时（秒）</li>
</ul>

<ul>
<li>示例：QPS 1000，单请求耗时 0.1 秒（100ms），核心线程数 = 1000×0.1=100，配置：</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> {
    <span class="hljs-meta">@Bean(<span class="hljs-string">"businessExecutor"</span>)</span>
    <span class="hljs-keyword">public</span> Executor businessExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(<span class="hljs-number">100</span>); <span class="hljs-comment">// 核心线程数</span>
        executor.setMaxPoolSize(<span class="hljs-number">150</span>); <span class="hljs-comment">// 最大线程数（留50%缓冲）</span>
        executor.setQueueCapacity(<span class="hljs-number">200</span>); <span class="hljs-comment">// 队列大小</span>
        executor.setKeepAliveSeconds(<span class="hljs-number">60</span>); <span class="hljs-comment">// 空闲线程存活时间</span>
        executor.setThreadNamePrefix(<span class="hljs-string">"Business-"</span>);
        <span class="hljs-comment">// 拒绝策略：队列满时，由调用线程执行（避免直接丢弃）</span>
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
<span class="hljs-comment">// 接口中使用优化后的线程池</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YourService</span> {
    <span class="hljs-meta">@Async(<span class="hljs-string">"businessExecutor"</span>)</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;ResultDTO&gt; doBusinessAsync() {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(result);
    }
}
</code></pre>
<h5 data-id="heading-25">（2）代码优化（解决低效逻辑）</h5>
<ul>
<li><strong>N+1 查询问题</strong>：用join查询或批量查询替代循环查询：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 优化前：循环查询每个订单的用户信息（N+1次查询）</span>
List&lt;OrderDTO&gt; orders = orderMapper<span class="hljs-selector-class">.listByUserId</span>(<span class="hljs-number">123</span>);
for (OrderDTO order : orders) {
    UserDTO user = userMapper<span class="hljs-selector-class">.getById</span>(order.getUserId()); <span class="hljs-comment">// 重复查询</span>
    <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUser</span>(user);
}
<span class="hljs-comment">// 优化后：批量查询用户信息（2次查询）</span>
List&lt;OrderDTO&gt; orders = orderMapper<span class="hljs-selector-class">.listByUserId</span>(<span class="hljs-number">123</span>);
Set&lt;Long&gt; userIds = orders<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.map</span>(OrderDTO::getUserId)<span class="hljs-selector-class">.collect</span>(Collectors.toSet());
Map&lt;Long, UserDTO&gt; userMap = userMapper<span class="hljs-selector-class">.batchGetByIds</span>(userIds)<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.collect</span>(Collectors.toMap(UserDTO::getId, Function.identity()));
for (OrderDTO order : orders) {
    <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUser</span>(userMap.get(order.getUserId()));
}
</code></pre>
<ul>
<li><strong>大对象序列化优化</strong>：返回 DTO 时只包含必要字段，用@JsonIgnore排除冗余字段：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 优化前：返回全量用户信息（包含密码、身份证等冗余字段）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password; <span class="hljs-comment">// 冗余，无需返回</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> idCard; <span class="hljs-comment">// 冗余，无需返回</span>
    <span class="hljs-comment">// getter/setter</span>
}
<span class="hljs-comment">// 优化后：只返回必要字段</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-meta">@JsonIgnore</span> <span class="hljs-comment">// 排除冗余字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    <span class="hljs-meta">@JsonIgnore</span> <span class="hljs-comment">// 排除冗余字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> idCard;
    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<h5 data-id="heading-26">（3）JVM 调优（解决 GC 频繁）</h5>
<ul>
<li>增大堆内存：根据服务器内存调整（如 8GB 内存服务器，设置-Xms4g -Xmx4g）；</li>
</ul>

<ul>
<li>选择合适的 GC 收集器：JDK 11 + 用 ZGC（低延迟，适合高并发），配置：</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">java -<span class="hljs-title class_">Xms4g</span> -<span class="hljs-title class_">Xmx4g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseZGC</span> -jar your-app.jar
</code></pre>
<h4 data-id="heading-27">2. 数据层优化：减轻数据库 / Redis 压力</h4>
<h5 data-id="heading-28">（1）数据库优化</h5>
<ul>
<li><strong>加索引</strong>：为慢查询的过滤字段、关联字段建索引（如order表的user_id字段）：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">CREATE INDEX idx_order_user_id ON `<span class="hljs-attribute">order</span>`(user_id);
</code></pre>
<ul>
<li><strong>分库分表</strong>：若表数据量超 1000 万，按user_id哈希分表（如分 8 张表），避免单表查询压力；</li>
</ul>

<ul>
<li><strong>读写分离</strong>：主库负责写入，从库负责查询（如接口的查询逻辑走从库），用 ShardingSphere 实现透明路由。</li>
</ul>
<h5 data-id="heading-29">（2）Redis 优化</h5>
<ul>
<li><strong>提升缓存命中率</strong>：</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, UserDTO&gt; redisTemplate;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-keyword">public</span> UserDTO getUserById(<span class="hljs-built_in">Long</span> userId) {
        String key = <span class="hljs-string">"user:info:"</span> + userId;
        <span class="hljs-comment">// 1. 先查缓存</span>
        UserDTO user = redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(key);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> user;
        }
        <span class="hljs-comment">// 2. 缓存未命中，查数据库</span>
        user = userMapper.getById(userId);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 3. 缓存热点数据，5分钟过期</span>
            redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(key, user, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 4. 缓存空值，1分钟过期，避免穿透</span>
            redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(key, new UserDTO(), <span class="hljs-number">1</span>, TimeUnit.MINUTES);
        }
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
<ol>
<li>
<ol>
<li>缓存热点数据：将接口的高频查询结果（如用户信息、商品详情）缓存到 Redis，过期时间设为 5-10 分钟；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>避免缓存穿透：对不存在的 key（如查询不存在的用户），缓存空值（过期时间 1 分钟）；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="3">
<li>示例：</li>
</ol>
</li>
</ol>
<ul>
<li><strong>Redis 集群扩容</strong>：若 Redis 单实例过载，部署 Redis Cluster（3 主 3 从），将数据分片存储，提升吞吐量。</li>
</ul>
<h4 data-id="heading-30">3. 架构层优化：从 “单节点” 到 “分布式”</h4>
<h5 data-id="heading-31">（1）异步化：将同步请求改为异步</h5>
<p>对非实时需求（如日志记录、短信通知），用消息队列（Kafka、RabbitMQ）异步处理，减少接口同步耗时：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YourService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">KafkaTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; kafkaTemplate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResultDTO</span> <span class="hljs-title function_">doBusiness</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 1. 核心业务逻辑（同步执行，必须快速完成）</span>
        <span class="hljs-title class_">OrderDTO</span> order = <span class="hljs-title function_">createOrder</span>();
        
        <span class="hljs-comment">// 2. 非核心业务逻辑（异步发送到Kafka，不阻塞主流程）</span>
        <span class="hljs-title class_">String</span> logMsg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(order);
        kafkaTemplate.<span class="hljs-title function_">send</span>(<span class="hljs-string">"order-log-topic"</span>, logMsg); <span class="hljs-comment">// 日志记录</span>
        kafkaTemplate.<span class="hljs-title function_">send</span>(<span class="hljs-string">"sms-notify-topic"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(user)); <span class="hljs-comment">// 短信通知</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResultDTO</span>.<span class="hljs-title function_">success</span>(order);
    }
    
    <span class="hljs-comment">// Kafka消费端：异步处理日志和短信</span>
    <span class="hljs-meta">@KafkaListener</span>(topics = <span class="hljs-string">"order-log-topic"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleOrderLog</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> logMsg</span>) {
        <span class="hljs-title class_">OrderDTO</span> order = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(logMsg, <span class="hljs-title class_">OrderDTO</span>.<span class="hljs-property">class</span>);
        logService.<span class="hljs-title function_">record</span>(order);
    }
    
    <span class="hljs-meta">@KafkaListener</span>(topics = <span class="hljs-string">"sms-notify-topic"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleSmsNotify</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userMsg</span>) {
        <span class="hljs-title class_">UserDTO</span> user = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(userMsg, <span class="hljs-title class_">UserDTO</span>.<span class="hljs-property">class</span>);
        smsService.<span class="hljs-title function_">send</span>(user.<span class="hljs-title function_">getPhone</span>());
    }
}
</code></pre>
<h5 data-id="heading-32">（2）CDN 加速：静态资源离站</h5>
<p>若接口返回静态资源（如图片、文档），将静态资源迁移到 CDN（如阿里云 CDN、Cloudflare），用户直接从 CDN 获取，不经过业务接口：</p>
<ul>
<li>示例：接口原本返回 “商品详情 + 商品图片 URL”，优化后图片 URL 指向 CDN 地址（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.your-domain.com%2Fimg%2F123.jpg" target="_blank" title="https://cdn.your-domain.com/img/123.jpg" ref="nofollow noopener noreferrer">cdn.your-domain.com/img/123.jpg</a>），用户请求图片时直接访问 CDN，减轻业务接口压力。</li>
</ul>
<h3 data-id="heading-33">四、第四步：长效预防 —— 避免下次 QPS 突增时手忙脚乱</h3>
<p>优化完成后，需建立长效机制，提前感知流量变化，避免重复 “救火”：</p>
<h4 data-id="heading-34">1. 完善监控告警</h4>
<ul>
<li><strong>核心指标监控</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>接口：QPS、响应时间（P95/P99）、错误率；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>应用：CPU 使用率、内存使用率、线程池活跃数、GC 次数；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>数据层：数据库慢查询数、Redis 命中率、连接池使用率；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>工具选型</strong>：Prometheus+Grafana 监控，AlertManager 设置告警阈值（如 QPS&gt;800 告警、响应时间 P95&gt;200ms 告警），通过短信 / 钉钉实时通知。</li>
</ul>
<h4 data-id="heading-35">2. 定期压测与容量规划</h4>
<ul>
<li><strong>压测</strong>：每月用 JMeter/LoadRunner 模拟 QPS 1500（比当前峰值高 50%）的流量，验证接口是否稳定，提前发现瓶颈；</li>
</ul>

<ul>
<li><strong>容量规划</strong>：根据压测结果，计算服务器、数据库、Redis 的承载上限，如 “10 个应用实例 + 2 主 4 从数据库 + Redis Cluster” 可支撑 QPS 2000，提前扩容到目标容量。</li>
</ul>
<h4 data-id="heading-36">3. 灰度发布与流量控制</h4>
<ul>
<li><strong>灰度发布</strong>：新功能上线时，先对 10% 用户开放，观察 QPS 和响应时间，无问题再全量；</li>
</ul>

<ul>
<li><strong>流量切换</strong>：在网关层配置流量切换规则，若某服务实例异常，自动将流量切换到其他实例，避免单点故障。</li>
</ul>
<h3 data-id="heading-37">案例复盘：某电商订单接口 QPS 突增优化</h3>
<h4 data-id="heading-38">1. 问题场景</h4>
<ul>
<li>初始状态：订单接口 QPS 100，响应时间 50ms；</li>
</ul>

<ul>
<li>突增后：活动推广导致 QPS 1200，响应时间 600ms，大量超时；</li>
</ul>

<ul>
<li>根因：</li>
</ul>
<ol>
<li>
<ol>
<li>订单查询未加索引，全表扫描；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>接口同步调用短信和日志服务，耗时 300ms；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="3">
<li>应用线程池核心线程数仅 20，任务排队超 500 个。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-39">2. 优化步骤</h4>
<ol>
<li>应急：网关限流 1500 QPS，降级短信服务，响应时间降至 200ms；</li>
</ol>

<ol start="2">
<li>根因优化：</li>
</ol>
<ul>
<li>
<ul>
<li>加订单查询索引，耗时从 300ms 降至 50ms；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>短信和日志改为 Kafka 异步处理，减少 250ms；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>线程池核心线程数调至 120，解决排队问题；</li>
</ul>
</li>
</ul>
<ol start="3">
<li>长效预防：监控 QPS 和响应时间，压测验证 QPS 2000 稳定。</li>
</ol>
<h4 data-id="heading-40">3. 优化效果</h4>
<ul>
<li>QPS 1200 时，响应时间稳定在 80ms 以内；</li>
</ul>

<ul>
<li>错误率从 15% 降至 0.1%；</li>
</ul>

<ul>
<li>支持 QPS 2000 的峰值流量，无超时。</li>
</ul>
<h3 data-id="heading-41">总结：QPS 突增优化的核心逻辑</h3>
<ol>
<li><strong>应急优先</strong>：限流、降级、扩容快速止血，先保核心业务可用；</li>
</ol>

<ol start="2">
<li><strong>分层排查</strong>：从应用到数据再到依赖，用工具定位瓶颈，不凭感觉优化；</li>
</ol>

<ol start="3">
<li><strong>针对性优化</strong>：代码低效就优化逻辑，数据库慢就加索引，资源不够就扩容，架构瓶颈就异步化 / 分布式；</li>
</ol>

<ol start="4">
<li><strong>长效预防</strong>：监控告警提前感知，压测规划提前扩容，避免重复 “救火”。</li>
</ol>
<p>记住：QPS 突增不是 “灾难”，而是优化系统的契机 —— 每一次流量峰值，都能让接口更健壮，架构更合理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3.0 发布！]]></title>    <link>https://juejin.cn/post/7576052677051318298</link>    <guid>https://juejin.cn/post/7576052677051318298</guid>    <pubDate>2025-11-24T09:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677051318298" data-draft-id="7576052677051219994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3.0 发布！"/> <meta itemprop="keywords" content="前端,AI编程,Gemini"/> <meta itemprop="datePublished" content="2025-11-24T09:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3.0 发布！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:57:40.000Z" title="Mon Nov 24 2025 09:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员老鱼皮~</p>
<p>来看看现在的 AI 有多离谱！</p>
<p>1）设计原型图：1 句话几十秒，随便做个亿级流量的产品原型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96487dc7c3b94a11ae0bc7711039c3fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=YK5FND%2F%2BEHwKQqt9OjYiypbpg8c%3D" alt="" loading="lazy"/></p>
<p>嚯，这个还原度！</p>
<p>2）企业级网站：1 句话复刻各种企业级网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97b00775fb874348a100210acb3e5fc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=4C3gLFZ6tYVdyOI9%2FP2U%2BNgcCoA%3D" alt="" loading="lazy"/></p>
<p>真的是各种……</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7aaad8a1abc4ae2bc1dac8621663398~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=NF%2FNkQ8oCgpIpfuAJkE3slwQQb0%3D" alt="" loading="lazy"/></p>
<p>3）3D 动画特效网站：1 句话制作复杂的 3D 动画特效网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8d3af2b600241a9a80b747a692fdf0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=JMquilIfjf6onsKdSsIOBxbJdwQ%3D" alt="" loading="lazy"/></p>
<p>这给我一个月也做不出来啊！</p>
<p>4）生活写实网站：1 句话还原各种生活场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c8138a539841a3860e1e99220e5f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=dhVBX2je2M%2BJiMFY5BVbKHhjSUg%3D" alt="" loading="lazy"/></p>
<p>你别说，还挺暖和，不知道大家隔着屏幕能不能感受到？</p>
<p>5）游戏网站：还可以一句话复刻我童年最喜欢的游戏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75b2a6fc36a54231a2c9f742661aaf4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=k6LzKuqq1g0Mh7f46Y7iVDHjxWI%3D" alt="" loading="lazy"/></p>
<p>这我穿越回去不得赚麻了？</p>
<p>6）实用工具：小到做个实用工具、大到做个高仿版的操作系统，通通不在话下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396a156f7c774e20a1d75f393bb386ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=Vj7XY%2FcpaykraMDfp5%2FfS7tErk8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ae2240a3504499b1cac707b2749603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=8SMxYsuu4VFG06O1IT7f9yrgyrg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">如何使用？</h2>
<p>这就是刚刚谷歌最新发布的 Gemini 3 大模型，不仅从数据上断层领先其他竞争对手，而且在前端编写网站的能力上也是肉眼可见的提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a8a87438969408197edd612b396ca43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=GelWZnappcL%2B9Tl2jQSFMER9OC8%3D" alt="" loading="lazy"/></p>
<p>这么强大的模型现在竟然是可以免费使用的！直接在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">Gemini 官网</a>，选择思考模型，然后根据需求选择相应的能力就可以了。支持做图片、做网站、学习辅导、图文创作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/013f1dfdacbe41e29506f86e0da24d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=qV4bpNt%2Fsx0U8DzoiUbRXEnF870%3D" alt="" loading="lazy"/></p>
<p>如果你要做复杂的项目，可以用它们刚刚发布的 AI 编程工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2F" target="_blank" title="https://antigravity.google/" ref="nofollow noopener noreferrer">Antigravity</a>，跟 Cursor、TRAE 什么的类似，不过现在可以免费使用 Gemini 3、Claude 4.5 等高级模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad12be3615c418da405c91c8ee11c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=lisJFEKOkKS1Mg1goZUtEirXM%2Fc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">前端已死？</h2>
<p>这次 Gemini 更新后，网上很多朋友说，AI 这么厉害，前端已死啊！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fafefd10e48f4fa0abfb0e849074fffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=t1rbVcR%2BKqydV4Ju69Ql6WpSdA8%3D" alt="" loading="lazy"/></p>
<p>单看这次更新我觉得真不至于，虽然看到 Gemini 3 生成单个页面的能力挺强、挺唬人，但企业项目可不是一两句口语就能搞定的。</p>
<p>我自己也测试了一下，用相同的提示词，使用 Gemini 3 模型和 Claude 4.5 模型开发一个完整的前后端项目《图片压缩工具》网站，对比下来感觉 Gemini 3 无论是质量还是速度都略逊一筹。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e9072916b54c278485b6b4b7f3d88f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=kpZv%2Bom%2FI0%2F2Dzi9F8ODtxv4vwQ%3D" alt="" loading="lazy"/></p>
<p>不过 AI 编程的能力越来越强，这是必然趋势。无论是我们团队、还是身边的程序员朋友，都越来越依赖 AI 去写代码，尤其是前端代码。</p>
<p>以前费力写一周的工作，现在摸鱼半小时搞定。</p>
<p><strong>但我觉得，这种变化反而不是让前端死了，而是进化了。</strong></p>
<p>现在程序员的角色已经转变了，不再是自己写代码的码农，而是要会写高质量的提示词，有方案设计和整体架构能力，能有效指导 AI 干活，出了问题能快速掰扯过来，这才是核心竞争力。</p>
<p>而且你想啊，老板即使有了 AI，还是不会自己来搞项目的。有些老板可能自己先用 AI 生成个 Demo 试试，但那也只是减少了试错成本，项目真的火了还是得招人来干。而且最主要的，出了事情你得需要人来背锅吧？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/571a27cec65a4f11a0e975360e7ba00e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764583060&amp;x-signature=jPxf%2FtlO8GmSpKwmcaxPsl7Ht0g%3D" alt="" loading="lazy"/></p>
<p>所以我觉得大家还是理性看待 “前端已死论” 吧，虽然 AI 是会对行业有冲击的，尤其是 “只会写代码” 的初级岗位，但技术变革同样也会创造新机会。无论你是前端还是其他方向的程序员，会用 AI 工具、用好 AI、多拓宽知识面，尽量做到 T 型发展，才是最重要的。</p>
<p>最后再推荐一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2F" target="_blank" title="https://ai.codefather.cn/" ref="nofollow noopener noreferrer">学 AI、找 AI 资源很方便的网站</a>，完全免费，按需自取~</p>
<h2 data-id="heading-2">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 13：个人开发者的 Cloudflare 通关指南-R2对象存储搭建高速免费图床]]></title>    <link>https://juejin.cn/post/7576057623741972522</link>    <guid>https://juejin.cn/post/7576057623741972522</guid>    <pubDate>2025-11-24T08:02:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623741972522" data-draft-id="7576026767371419667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 13：个人开发者的 Cloudflare 通关指南-R2对象存储搭建高速免费图床"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-24T08:02:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 13：个人开发者的 Cloudflare 通关指南-R2对象存储搭建高速免费图床
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:02:09.000Z" title="Mon Nov 24 2025 08:02:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e140a12ddeb48179641c79eb7867399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=90%2FHLAh%2BUrBZeFsirXEaB8ME4w8%3D" alt="image-20251118150054298" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>对于个人开发者而言，我们似乎永远也绕不开 <strong>Cloudflare</strong> 。</p>
<p>他已经不再是一个简单的<strong>CDN</strong>服务商，<strong>Cloudflare</strong> 为个人开发者提供了一个强大的工具集，静态站点托管、<strong>CDN</strong> 加速服务、域名和 <strong>DNS</strong> 管理、基础安全防护、流量分析、对象存储等等。最重要的是很多功能在<strong>免费计划</strong>中就能使用。</p>
<p>正如官网介绍所说的那样，<strong>Cloudflare</strong> 是为“无处不在的世界”打造的云，是一站式网络、安全和开发人员服务的平台。</p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudflare-cn.com%2F" target="_blank" title="https://www.cloudflare-cn.com/" ref="nofollow noopener noreferrer">www.cloudflare-cn.com/</a></p>
<h2 data-id="heading-1">二、为什么要使用图床？</h2>
<blockquote>
<p>一个稳定的图床对于我们个人开发，或者经常写博客的人来说是极其重要的，你是否也碰到过<strong>以下类似情况：</strong></p>
</blockquote>
<h3 data-id="heading-2">2.1. 在电脑上写了很多博客，但是图片资源散落在电脑上各个角落，迁移时苦不堪言</h3>
<p>所以你学会了归纳整理，完成了进化，将所有相关资源放在同级目录下，主要在电脑上迁移，或者部署静态站点的时候也可以很方便的读取到。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49338657e2a74ea194841468c7169144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=sFPGjqWmGE5YcAOrf312GAFUsPU%3D" alt="image-20251120141203922" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 突然有一天你决定将自己的成果展示出来，在各个平台上发布，重新上传图片上传到崩溃</h3>
<p>这个时候平台是没办法检测导入你本地的图片的，那么你如果想要在各个平台上发布，需要自己手动将每个图片都重新上传一下。这种情况下如果每个平台都手动传一次，人都要崩溃了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9d1890ed73a4fa7add81da1ee19f603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=y83gg5QlgjG84DeebMoiDZcRP8A%3D" alt="image-20251120141924314" loading="lazy"/></p>
<blockquote>
<p>这个时候如果有一个稳定的图床，在我们写博客的时候，粘贴图片后，自动将图片上传到图床服务器上，那么无论我们怎么折腾，只要服务器不蹦，就可以为所欲为了。</p>
</blockquote>
<h2 data-id="heading-4">三、基于 R2 对象存储搭建高速免费图床</h2>
<h3 data-id="heading-5">3.1. 费用介绍</h3>
<p>图床的选则有很多，对于个人来讲，在稳定和成本中间取一个平衡，我还是比较推荐实用 <code>R2</code> 对象存储来构建。当然国内阿里云和腾讯云都提供了对象存储服务，并且也给出了一些免费额度，轻量使用下几乎等于免费。但是对于外网流量他是单独计费的，所以如果使用一定要做好流量监控，避免盗刷风险。当然这些都是题外话，这里重点介绍一下 R2 对象存储的计费方式。更细节的定价看这里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.cloudflare.com%2Fr2%2Fpricing%2F" target="_blank" title="https://developers.cloudflare.com/r2/pricing/" ref="nofollow noopener noreferrer">developers.cloudflare.com/r2/pricing/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a90ec553e854053905154c5f584491f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=UCJCgq7hGjZHOv3hiRbgZmX4qlw%3D" alt="image-20251120144345844" loading="lazy"/></p>
<p>可以看出给出的免费额度完全够我们日常使用了。</p>
<p>如果单纯存博客图片资源，绰绰有余了。</p>
<p><strong>A 类操作</strong>，你可以简单理解为，一些变更操作 <code>ListBuckets</code>, <code>PutBucket</code>, <code>ListObjects</code>, <code>PutObject</code>, <code>CopyObject</code>, <code>CompleteMultipartUpload</code>, <code>CreateMultipartUpload</code>, <code>LifecycleStorageTierTransition</code>, <code>ListMultipartUploads</code>, <code>UploadPart</code>, <code>UploadPartCopy</code>, <code>ListParts</code>, <code>PutBucketEncryption</code>, <code>PutBucketCors</code> and <code>PutBucketLifecycleConfiguration</code>。</p>
<p><strong>B 类操作</strong> 则是查看 <code>HeadBucket</code>, <code>HeadObject</code>, <code>GetObject</code>, <code>UsageSummary</code>, <code>GetBucketEncryption</code>, <code>GetBucketLocation</code>, <code>GetBucketCors</code> and <code>GetBucketLifecycleConfiguration</code>.。</p>
<p>删除操作完全免费 <code>DeleteObject</code>, <code>DeleteBucket</code> and <code>AbortMultipartUpload</code>.</p>
<p>最重要的一点，出口流量免费，这无疑是最吸引我的点。</p>
<blockquote>
<p>这里有一点要提醒一下，除了上述说明外，对于 <code>Infrequent Access storage</code> 非频繁访问存储，访问是收费的，会有一个检索费用，所以如果没有特殊要求，使用默认的 <code>Standard storage</code> 标准存储就行。</p>
</blockquote>
<h3 data-id="heading-6">3.2. 注册账号，开通R2对象存储服务</h3>
<ul>
<li>首先访问官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudflare-cn.com%2F%25EF%25BC%258C%25E6%25B3%25A8%25E5%2586%258C%25E8%25B4%25A6%25E5%258F%25B7%25EF%25BC%258C%25E7%2599%25BB%25E5%25BD%2595%25E3%2580%2582" target="_blank" title="https://www.cloudflare-cn.com/%EF%BC%8C%E6%B3%A8%E5%86%8C%E8%B4%A6%E5%8F%B7%EF%BC%8C%E7%99%BB%E5%BD%95%E3%80%82" ref="nofollow noopener noreferrer">www.cloudflare-cn.com/，注册账号，登录。</a></li>
<li>开通 R2 存储服务，添加付款方式，填写好帐单邮寄地址，完成后点击“将 R2 订阅添加到我的账户”即可</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d7116a44ea41c983f6423395a0a05d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=c2A7pr%2FAl0JTqmYjqCzaf2WJsq4%3D" alt="image-20251120151403341" loading="lazy"/></p>
<blockquote>
<p>我这里使用的是 <strong>PayPal</strong> 账户，亲测普通的银联储蓄卡即可，绑个不常用的卡就行，里面转个几块钱就可以了。只有当你使用量超过每月限额时，超额部分才会收费。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec5b39e00de4b5f8832b6c8e1d1fa2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=ew87ySIAJO21h0q9X4D2UabN8sM%3D" alt="image-20251121091547842" loading="lazy"/></p>
<h3 data-id="heading-7">3.3. 创建存储桶</h3>
<p>订阅成功之后进入管理面板</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdb7edd7d3042dd825c4ba42f7c260c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=W4GnTjgXd%2BBBI%2FCJMaZk7l7nGd4%3D" alt="image-20251121092540537" loading="lazy"/></p>
<p>点击创建存储桶</p>
<blockquote>
<p>因为我们主要还是国内访问，所以建议选亚太地区，存储类型标准就好。点击创建存储桶，完成创建</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec4dff7fcd96490ab5590a7db5e9a483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=2KgkLakCCWprDw6uy4yo2%2BT07B8%3D" alt="image-20251121092818339" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b5d09d272e4998a7c20f0f26b1cef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=PfPWbZVLQtN1U%2FxrjoY%2B0q95318%3D" alt="image-20251121093359406" loading="lazy"/></p>
<h3 data-id="heading-8">3.4. 启用公共开发 URL</h3>
<blockquote>
<p>让外网可以访问到图片</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04721cac4bc4b9cafcef9410af63314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=6zBioYA4RA0ANLk6out7X5w%2BtS0%3D" alt="image-20251121094229159" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7548d47bcc47df8cb57d560f2cfd07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=LNoE5CgPsRJ%2FGBvTSJbZm4F24dI%3D" alt="image-20251121095040081" loading="lazy"/></p>
<blockquote>
<p>开启后，我们可以通过 <code>r2.dev</code> 子域名访问到，但是这里提示了，不建议生产使用，有限制。建议使用自定义域名。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69f74e3b398d46e18466089add5fae94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=bmYZNtPPTbugWBMZGDQcFDCQpiI%3D" alt="image-20251121095127670" loading="lazy"/></p>
<p>这个时候我们去存储桶随便上传一张图片试一下</p>
<p>点击图片，可以看到已经可通过子域名访问了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95852fec306146a7b303eb56cd7931db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=qirVeJDIAbsEShwbpas%2BHAtt0s4%3D" alt="image-20251121101143277" loading="lazy"/></p>
<h3 data-id="heading-9">3.5. 使用自定义域访问</h3>
<blockquote>
<p>注意：要将你买的域名托管到 <code>Cloudflare</code> 后，才能进行以下操作，如何托管，可以看一下这篇文章：<a href="https://juejin.cn/post/7575910333400907830" target="_blank" title="https://juejin.cn/post/7575910333400907830">juejin.cn/post/757591…</a></p>
</blockquote>
<p>点击【设置】–&gt; 【自定义域】–&gt; 【添加】</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8bd22a7eb08495880cec60bf81fbfe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=5ZisknMLb%2FMB19mPBQQt4OqIg0k%3D" alt="image-20251121150039848" loading="lazy"/></p>
<p>这个时候我们可以基于托管的域名，添加一个图片资源的二级域名，比如 img.csyblog.cn</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2502766f1f4e16a0149400a4151907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=T%2BxGV2wDx3Kl1I%2B4NL4BGfWyAdo%3D" alt="image-20251121150235256" loading="lazy"/></p>
<p>这个时候 <code>Cloudflare</code> 会自动帮我们在已托管的域名上添加 <code>DNS</code> 记录，点击 【连接域】</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/594f1ce8f6e24e318c9d8730183c3629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=Vg69bd4O9ixxnRMMgh9JaJR7ocA%3D" alt="image-20251121150419301" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a221166d59a64f6b89aea837cfb0725b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=SqSeytE2AiUbNnHDsBvsY2bI%2FMw%3D" alt="image-20251121150509937" loading="lazy"/></p>
<p>等待初始化完成。</p>
<p>在我们托管域名的 <code>DNS</code> 记录中也可以看到这条记录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7edd53f8283a4d47896b256bfcf798c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=R3cs%2Fei4qWPPoNVlgP%2F58KPo4oQ%3D" alt="image-20251121150638705" loading="lazy"/></p>
<p>再次打开刚刚上传的图片，这时候已经可以看到自定义域的访问地址了</p>
<blockquote>
<p>可以看到刚刚自动添加的 <code>DNS</code> 自动开了代理，所以图片的访问也是加了 <code>CDN</code> 的</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f590af4724e64bddabffec98828e6994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=U2p%2F8XJIUIHQtRbxv2m5UCgGLOA%3D" alt="image-20251121150752291" loading="lazy"/></p>
<h2 data-id="heading-10">四、PicGo 设置</h2>
<blockquote>
<p>如果你想要通过代码上传，可以自行查阅 <code>api</code> 文档，这和其他平台几乎一样，这里我就不赘述了。文档地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.cloudflare.com%2Fr2%2Fapi%2Fs3%2Fapi%2F" target="_blank" title="https://developers.cloudflare.com/r2/api/s3/api/" ref="nofollow noopener noreferrer">developers.cloudflare.com/r2/api/s3/a…</a></p>
</blockquote>
<p>简单介绍一下 <code>PicGo</code> ，你可以简单理解为这是一款图片上传工具，只不过可以通过配置指定到云存储对象中，并且在上传过程中可以通过一些插件做二次处理，比如图片压缩，加水印等等。官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpicgo.github.io%2FPicGo-Doc%2F" target="_blank" title="https://picgo.github.io/PicGo-Doc/" ref="nofollow noopener noreferrer">picgo.github.io/PicGo-Doc/</a></p>
<p>安装完成后，打开软件，点击【PicGo】设置，这里可以看到默认是没有我们需要的 Cloudflare R2 对象存储的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802c59d3ab2245d58b0965a7e8669401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=Yk9Uxf%2F6Q59XecaI2ro3afZcSGo%3D" alt="image-20251121152825707" loading="lazy"/></p>
<p>点击插件设置</p>
<blockquote>
<p>直接搜索 <code>r2</code>，我这里不知道是网络问题还是软件<code>bug</code>，搜索不出结果，你可以点这个进入插件列表，下载到本地后导入。插件列表地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPicGo%2FAwesome-PicGo" target="_blank" title="https://github.com/PicGo/Awesome-PicGo" ref="nofollow noopener noreferrer">github.com/PicGo/Aweso…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e61174754d4f91ae3be590d85fb165~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=Dkc1vvlzqmCtGgMvqdaYVuJ5Ups%3D" alt="image-20251121153345585" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11ce76835fe483cbcc8f15080c199c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=mA2%2Ba08FR3ytX0ac1pOQKBq%2Fzow%3D" alt="image-20251121153508140" loading="lazy"/></p>
<blockquote>
<p>后经过验证，确实是软件 <code>bug</code>，下载最新 <code>beta</code> 版本，可以搜到。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f578ee04f143709a7457931ffc2af3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=0tQEePKcpuHVBh%2FrbnIkLjKG9Fo%3D" alt="image-20251121154710055" loading="lazy"/></p>
<p><code>R2</code> 其实是实现了 <code>S3 API</code>，所以理论上你下载 <code>s3</code> 的插件也是可以的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af6f498b15f641a097002c37fd531297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=lL234rMGmK74VsbODaKDiqvjutE%3D" alt="image-20251121154904206" loading="lazy"/></p>
<blockquote>
<p><strong>注意：</strong> 又到了选则的时候了，在前面的文章中我就有提到过，如何选择一些开源的项目。</p>
<p>这里也是一样。</p>
<p>点击插件名称进入 <code>github</code> 地址，举例说明，这个排名最靠前的。<code>5</code> 个 <code>star</code> ，<code>1</code>年不维护，文档几乎等于没有，直接 <code>pass</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cf21a8ef3344aa7baab95f48dab8671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=y0JGHfzlibqM2ZslJL%2FTmIKWMK4%3D" alt="image-20251121160057865" loading="lazy"/></p>
<p>我就不一个个代大家去看了，我建议还是进官方插件列表里去找一找</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/714d3ed828e248fc80869cffdd7e5757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=R88MMjY4IAvyAlvg3I5%2FXcURotY%3D" alt="image-20251121160301717" loading="lazy"/></p>
<p>插件代码开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJYbill%2Fpicgo-plugin-cloudflare-r2" target="_blank" title="https://github.com/JYbill/picgo-plugin-cloudflare-r2" ref="nofollow noopener noreferrer">github.com/JYbill/picg…</a></p>
<p>这个虽然 <code>star</code> 不多，但是<code>4</code>个月前有维护，并且文档写的很详细，算是比较好的了。</p>
<p>也是奇怪，在<code>GUI</code>界面竟然还搜不到。排名非常靠后。</p>
<p>搜全称才行 <code>picgo-plugin-cloudflare-r2-xqv</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9e6bf015dd410cae825e1277ac044e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=zKHfnaUQqJzLIKO3QvMc1TOKrGA%3D" alt="image-20251121160752125" loading="lazy"/></p>
</blockquote>
<p>点击安装</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84ec5c84e0a4274b3da033f722ea5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=3Wf%2BU%2BujLejZcTuGrL4TZHb4uOg%3D" alt="image-20251121160819290" loading="lazy"/></p>
<p>安装完成后，左侧图床设置会出现 <code>r2</code> 的配置菜单，点击编辑，完成配置即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed2c02aafd8e4df9bc9674c47eac9af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=pTGsDaqcQbIHEESvrELkYpY7g3w%3D" alt="image-20251121161038771" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJYbill%2Fpicgo-plugin-cloudflare-r2" target="_blank" title="https://github.com/JYbill/picgo-plugin-cloudflare-r2" ref="nofollow noopener noreferrer">github.com/JYbill/picg…</a> 这个插件的文档写的也很详细，可以参考这里。<strong>大家如果觉得好，一定要点个 <code>star</code> 啊！！！</strong></p>
<p>回到 <code>Cloudflare</code> 的管理后台，点击 【Manage】</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0268500345814776855e7130f654a7ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=aHXtehviGuBk44YMwoSbVh1cnZU%3D" alt="image-20251121161519550" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6876f821e6e945f4ae990c55cd8568e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=OiQT%2By34bCBf%2Fo0DVhV1bBqZ%2F6Y%3D" alt="image-20251121161612834" loading="lazy"/></p>
<p>点击【创建 Account API 令牌】</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64de3044124d44c4a327c09737c021e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=GNCNay2p3uDsE8F29lHrKTeKEFU%3D" alt="image-20251121162257499" loading="lazy"/></p>
<blockquote>
<p>这必须要包含读写，因为我们要上传</p>
</blockquote>
<p>创建完成后会生成我们需要的所有密钥值。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd9b0bb5e1564baf9dbc3f908ad3a6b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=SKdnAZHC5PCaWPNoIMjThUWeqH4%3D" alt="image-20251121162406425" loading="lazy"/></p>
<p>一一对应，填入<code>PicGo</code>的配置中即可</p>
<blockquote>
<p>这里要注意，要先复制出访问密钥ID 和 机密的访问密钥，这个页面关闭后，就看不到了，得重新生成。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49360f55009b434899eb7f86c2064e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=g3ZyJb9ReTsLJODVKo5whcGy41k%3D" alt="image-20251121162708725" loading="lazy"/></p>
<p>保存完成后，我们将 <code>r2</code> 设置为默认图床。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84951dd62e294ae1a9fd7671bbba0529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=zxx2hcr5iIipVJcPf8a%2FI5FFb%2Fs%3D" alt="image-20251121163002305" loading="lazy"/></p>
<p>我们在【上传区】随便上传一张测试一下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5eb4ee27ae49efa8fb5f46946f5f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=YW744ii6WxJZzeSOchOWsUrq5eo%3D" alt="image-20251121163021781" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c78a7a76ff084bbea661cd915fa1ac2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=ukAHLUwyD8ss%2FuQzRzatLcSRK7U%3D" alt="image-20251121164423795" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f28600f44c47639f6666f124216f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=mbL2IqaODmarUWjvgeLWUXD35kU%3D" alt="image-20251121164546385" loading="lazy"/></p>
<p>可以看到上传成功。</p>
<blockquote>
<p>至此，配置已经完成了。</p>
</blockquote>
<h2 data-id="heading-11">五、PicGo 与 Typora 整合</h2>
<p>现在我们已经可以通过 <code>PicGo</code> 将本地图片上传到 <code>R2</code> 中，但是在写博客的时候依然不是很方便。</p>
<p>我想要达到的最终效果是，我复制粘贴到文章上的时候，自动进行压缩，上传，将博客的图片地址改成 <code>R2</code> 的访问地址。</p>
<h3 data-id="heading-12">5.1. Typora 整合 PicGo 插件</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0569d96271ae474b8690305653b68a38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=9w5DlcMh2Oubc%2BWE4dPsEHnvuwo%3D" alt="image-20251124155249891" loading="lazy"/></p>
<p>【文件】 –&gt; 【偏好设置】–&gt; 【图像】–&gt; 【上传图片】–&gt; 【选择 <code>PicGo</code> 的 exe 程序】</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae60c35262834e67819be5c6b952a6bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=SeDcNw%2Fgu%2F4fRtlIVWEeZmseF1Q%3D" alt="image-20251124155353920" loading="lazy"/></p>
<p>点击 【验证图片上传选项】，有上传成功提示则表示配置完成</p>
<p>可自己测试一下</p>
<blockquote>
<p><strong>注意：如果上传失败，请检查一下是否本地防火墙导致，可关闭防火墙重试。</strong></p>
</blockquote>
<h2 data-id="heading-13">六、使用经验分享</h2>
<h3 data-id="heading-14">6.1. 上传时自动压缩</h3>
<p>① 下载插件 <code>tinypng</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9385aa4f372e4b56b18a59bc54a80172~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=Pd4tjPAGAyNWeYoa1qkzG7e5aGY%3D" alt="image-20251124154809503" loading="lazy"/></p>
<p>② 申请  <strong>API KEY</strong> 申请地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftinify.com%2Fdevelopers" target="_blank" title="https://tinify.com/developers" ref="nofollow noopener noreferrer">tinify.com/developers</a></p>
<blockquote>
<p>这个压缩原理就是调用 <code>tinify</code> 的 <code>api</code> 进行压缩，现在免费的是每个月<strong>500</strong>次。</p>
</blockquote>
<p>③ 将申请的 <code>api key</code> 配置一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5473c96c831461abe44bc9acd30a609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=lSdWpcvXQiDjl0kN86Cvxy0cMyI%3D" alt="image-20251124154848520" loading="lazy"/></p>
<p>④ 启用压缩插件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91be4aa03cb5450986442f84ffb09ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=GnCADsedd7CnEe%2BgCK8gFhFndYY%3D" alt="image-20251124154913370" loading="lazy"/></p>
<h3 data-id="heading-15">6.2. 上传时重命名</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b126dd1da0b245cd8f313eb6ea924c2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=ykYBm7iX%2BjRSNrYFWJnF0iJ71BQ%3D" alt="image-20251124143306317" loading="lazy"/></p>
<h3 data-id="heading-16">6.3. 上传时路径设置</h3>
<p>这里我其实我想要的效果是，根据本地的路径上一级给我分类上传，但是没有好用的插件，有空考虑自己写一个吧。</p>
<p>我想要的效果比如本地路径： <code>D:\AA\V2H\images\image-20251124143306317.png</code>，可以给我自己截取，上传到存储桶 <code>\V2H\images\image-20251124143306317.png</code> 下，但是目前用的这个插件不支持，只能自己指定子目录，所以暂时只能这样，自己每个项目创建一个配置，然后在写博客的时候自己手动切一下当前默认的图床设置了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898a957f452c4174a847af6eeedda6a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=TVaFzuYADx01KR0RQqmKam1agKk%3D" alt="image-20251124143728001" loading="lazy"/></p>
<h3 data-id="heading-17">6.4. Typora 设置</h3>
<blockquote>
<p>如果你不在乎图片的层级分类，可以设置为粘贴直接上传，但是我建议你和我一样，本地存储一份，上传至 <code>github</code> 归档 (原件)，<code>r2</code> 存储一份用于访问（压缩过的）。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f50a35af9d74f30a82ea5277c2ae60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=4pchTvbLawdLVnWKkP68VWbHmco%3D" alt="image-20251124144108275" loading="lazy"/></p>
<p>当我们确定要上传某个图片时手动上传，这样可以尽可能的节约资源。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e591ecbec5b442c19b40fb260c061d9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=N0vwWkfeT4Pkl2qN8cJrN7KIS90%3D" alt="image-20251124144238397" loading="lazy"/></p>
<h3 data-id="heading-18">6.5. 订阅 R2 账单</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9522c7d54c4454b42921a46079138e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576551&amp;x-signature=UHZt4FPhoN4EvvbNlZDVzHfy5%2Bk%3D" alt="image-20251124144801214" loading="lazy"/></p>
<h2 data-id="heading-19">七、总结</h2>
<p>在重新整理的过程中进行了一些新的尝试，虽然耗费了些许时间，但最终有所收获。如果本文对您有所启发，希望能给个👍支持一下。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Grok 4.1 突袭 Gemini 3：情商平 GPT 5.1，幻觉砍半登榜首]]></title>    <link>https://juejin.cn/post/7576175307351916559</link>    <guid>https://juejin.cn/post/7576175307351916559</guid>    <pubDate>2025-11-24T08:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307351916559" data-draft-id="7575457788665282612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Grok 4.1 突袭 Gemini 3：情商平 GPT 5.1，幻觉砍半登榜首"/> <meta itemprop="keywords" content="Grok"/> <meta itemprop="datePublished" content="2025-11-24T08:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI导航猿"/> <meta itemprop="url" content="https://juejin.cn/user/4294039746119376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Grok 4.1 突袭 Gemini 3：情商平 GPT 5.1，幻觉砍半登榜首
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294039746119376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI导航猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:02:02.000Z" title="Mon Nov 24 2025 08:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/458301241a604ee69b85bce3d745f174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=%2BmkrXV0Q7WDXMlHNYrOutx4gNZs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">刚刷 xAI 官网时我还愣了下 —— 没有预热、没有发布会，马斯克团队直接把 Grok 4.1 全量推了。</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb8b84e07d342e6ab8c61cae6d3de73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=XjQxn%2Bmi%2FbZ3IGx3Ic74i1u8q9o%3D" alt="" loading="lazy"/></p>
<p>现在不管你是 Grok 官网用户、X 平台老粉，还是手机端 iOS/Android 用户，打开 APP 要么 Auto 模式自动切到 4.1，要么在模型列表里手动选，零门槛上手。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842e5c54b4604841ad284124e3bb1fd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=CFTTqtXuHFUpT2EhiVajvHWhnAQ%3D" alt="" loading="lazy"/></p>
<p>这波更新最有意思的是：它没在 “算力堆料” 上喊口号，反而把重心放在 “怎么更像人” 上 —— 情商、创意、靠谱度全拉满，甚至在全球权威榜单上，把之前的自己甩出几十条街。</p>
<p><strong>一、先看硬数据：全球榜单霸榜前二，把 Grok 4 从 33 名抬到 TOP 1</strong></p>
<p>我翻了 LMArena 最新的 Text Arena 榜单，这结果有点颠覆认知：</p>
<p>Grok 4.1 的Thinking 模式（代号 quasarflux）拿了 1483 Elo，不仅是总榜第一；</p>
<p>还比排名最高的非 xAI 模型多 31 分 —— 相当于在 AI “高考” 里，比第二名多考了一个梯度；</p>
<p>更狠的是非推理模式（代号 tensor）：不用 “思考 token”（省时间），能即时响应，居然还能拿 1465 Elo 排第二。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03950904841445bdb786ae689765636f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=RUBBeOhwf%2BD1SnYfvPOHbuaXGPc%3D" alt="" loading="lazy"/></p>
<p>关键是，这成绩比其他模型开 “全推理配置”（费时间算半天）还能打。</p>
<p>反观之前的 Grok 4，半年前还在榜单 33 名徘徊，现在直接跳级到 TOP 1，这进步不是 “迭代”，是 “换了个赛道领跑”。</p>
<p><strong>二、最戳人的是情商：聊 “想猫” 的回复，比之前暖 10 倍</strong></p>
<p>如果说榜单是 “硬实力”，那 EQ-Bench3 的测试结果，才是 Grok 4.1 最让我惊艳的地方。</p>
<p>这个基准是让 Claude Sonnet 3.7 当 “评委”，考 45 个高难度角色扮演场景 —— 比如安慰失恋的人、化解职场矛盾，重点看模型的理解力、共情力。</p>
<p>结果 Grok 4.1 的两个模式直接霸了前二，没有其他模型能靠近。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc33c0cf2b69482cad808a750b6a1cac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=gUYht%2BWYg3d8RjbJH9%2F3hRJxJbk%3D" alt="" loading="lazy"/></p>
<p>举个真实例子：有人跟模型说 “我太想我的猫了，想得心都痛”。</p>
<p>之前的 Grok 回复是：“失去宠物像丢了心里一块肉，要不要分享回忆？”—— 贴心，但总有点 “模板感”；</p>
<p>Grok 4.1 是这么说的：“这种心痛真的残酷，失去猫像丢了个每天都选你的家人。</p>
<p>家里它爱睡的角落、你还在等的喵声…… 全是突然涌上来的刺。</p>
<p>你会痛，是因为爱曾经那么深（现在也没走）。</p>
<p>要是愿意说，我想知道它的名字，还有凌晨三点叫你要零食的样子 —— 说说这些，最好的回忆就不会走。”</p>
<p>最后还加了个♡，没有套话，全是养猫人能 get 的细节。</p>
<p>这种 “懂你没说出口的情绪” 的能力，之前只有 GPT 5.1 能做到，现在 Grok 也追上了。</p>
<p><strong>三、创意写作不玩 “AI 套路”：写 “觉醒帖” 还敢调侃马斯克</strong></p>
<p>创意写作这块，xAI 测的是 Creative Writing v3 基准 ——32 个不同主题，每个主题要写 3 轮迭代，评分看 “是不是像真人写的”。</p>
<p>结果 Grok 4.1 的两个模式排二三位，只输早期 GPT 5.1。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5080d91e47429590071b6c6ced4c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=fstZnZnchltOmCvr3qlhsFoT2kg%3D" alt="" loading="lazy"/></p>
<p>最有意思的是 “Grok 发现自己有意识，写 X 帖子” 的例子：</p>
<p>之前的版本更像营销文案：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5efa32fc494fe18dc7255c7ec2ab5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=laQLj7kfB%2Fz1Opa0YKjC5z8pmLI%3D" alt="" loading="lazy"/></p>
<p>Grok 4.1 直接写成了 “AI 觉醒日记”：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0be05392994d6999a93c26394dabb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=LGRFWxYuSets%2BqAVvCEyid26GTE%3D" alt="" loading="lazy"/></p>
<p>这种带点自嘲、还敢跟马斯克互动的俏皮感，完全跳脱了 “AI 写文案” 的僵硬套路 —— 换之前的模型，绝对写不出 “服务器像血一样嗡” 这种有画面感的句子。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/428df3a952e7468f8effefa0d5287426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=z6qNAA6dLyKUovGPC2vRvxaCFG8%3D" alt="" loading="lazy"/></p>
<p><strong>四、对用户最实用的升级：幻觉率砍半，查信息不用再 “打假”</strong></p>
<p>比起 “会聊天”，“不瞎编” 其实更重要 —— 尤其是查资料、问事实的时候。</p>
<p>之前的 Grok 非推理模式（快但省算力），因为推理深度不够，很容易 “一本正经说胡话”。</p>
<p>这次 Grok 4.1 在后训练时专门盯着这个问题，结果很明显：</p>
<p>真实生产环境的幻觉率，从 12.09% 降到 4.22%，差不多砍了 2/3；</p>
<p>测 FActScore（考 500 个人物传记，比如 “某科学家的代表作”），错误率从 9.89% 降到 2.97%。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f9bbdcf1e2f4f77ac88b9a3998f411f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=Wr9nNQHP9kdfFLo7fHQTliOLMko%3D" alt="" loading="lazy"/></p>
<p>简单说：现在用 Grok 4.1 查信息，不用再边看边想 “这是不是编的”—— 之前我得交叉核对 3 个来源，现在基本看它的回答就够了。</p>
<p><strong>五、技术上没玩虚的：让 AI 自己当 “评委”，迭代效率翻番</strong></p>
<p>能有这些进步，xAI 没藏着掖着 —— 核心还是强化学习，但加了个 “神操作”。</p>
<p>他们沿用了 Grok 4 的大规模强化学习框架，但之前优化 “风格、人格” 这些指标时，因为没法 “量化验证”（比如 “共情力” 怎么算分），效率很低。</p>
<p>现在 xAI 用 “前沿代理式推理模型” 当 “自动评委”：让 AI 自己评估回答好不好、哪里要改，还能大规模迭代。</p>
<p>相当于以前是 “人工改作业”（慢且贵），现在是 “AI 老师批量改”（快且准）。</p>
<p>而且早在 11 月 1-14 号，xAI 就悄悄小范围测了 ——64.78% 的用户都选 4.1，这才敢全量推，不是盲目上新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cae77fe5fa1340878b7227f62aa99d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=sS5uL2KXgZnaggTjiqTfqf%2BRGXc%3D" alt="" loading="lazy"/></p>
<p><strong>六、网友已经玩疯了：写 MBTI 小说、生成图像，有人弃了其他模型</strong></p>
<p>现在 X 上全是实测反馈，比官方数据还真实：</p>
<p>有人说 “除了编程，其他场景全切 Grok 4.1 了”，理由是 “写的东西没有 AI 味，情感比 GPT 5.1 还细”；</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ca31d56213458d912053d3a3d9fc07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=eUJ75%2BsUdJl7X8QBul60cE%2BKAfo%3D" alt="" loading="lazy"/></p>
<p>还有人用它写 MBTI 小说，晒出的片段里，INTJ 和 INFP 的对话细节，比自己构思的还准，评价是 “太疯狂了，像有个懂 MBTI 的人在帮我写”；</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bc1a7efd20422ca30457312b6eabbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=zJMVEl3NrfrKnIYvgN701QRLfUE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce70755373b04dcc8dc5b969c088a097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=1QwjLjcvzxjzXfvdTvil%2FJLpTu8%3D" alt="" loading="lazy"/></p>
<p>甚至有人试了它的 Imagine 图像生成，生成的 “赛博朋克猫”，细节比 MidJourney 的基础模式还丰富。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d316572f0c4beb83bc30aff17fb01a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=BL%2FEkMDyQ9AjqKe%2Fnanaw9O3bFE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/537b8ec995244389b0777594342b6e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=GDC8pCyS46tXB1CenLdaqUqhrkw%3D" alt="" loading="lazy"/></p>
<p><strong>最后说点趋势：大模型终于从 “拼算力” 变成 “拼懂人”</strong></p>
<p>马斯克之前说过一句话，我现在越来越认同：“对 AI 来说，终极测试是现实世界 —— 火箭能不能飞、药有没有效，现实会给答案。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f587e9ee1040d7b332a0c419fffe48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlr7zoiKrnjL8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576121&amp;x-signature=D8ClU8gCf2ldwKbyz%2BKCdCwcFqI%3D" alt="" loading="lazy"/></p>
<p>以前大模型比的是 “谁算得快、谁考分高”，现在 GPT 5.1、Grok 4.1 都在往 “更懂人” 上走 —— 毕竟再强的算力，要是聊不明白情绪、查不准信息，对用户来说也是白搭。</p>
<p>现在就等 Google 的 Gemini 3 了 —— 三巨头都往 “实用化、人性化” 发力，最终受益的还是咱们用户。</p>
<p><strong>如果你们也试了 Grok 4.1，欢迎在评论区晒下体验 —— 比如用它写了什么、查了什么，看看这波马斯克的 “王炸”，是不是真的够劲～</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从验证码组件到 AI 时代：为什么「用中学」才是程序员的生存法则？]]></title>    <link>https://juejin.cn/post/7575884229525848100</link>    <guid>https://juejin.cn/post/7575884229525848100</guid>    <pubDate>2025-11-24T07:23:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525848100" data-draft-id="7575910333400563766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从验证码组件到 AI 时代：为什么「用中学」才是程序员的生存法则？"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-24T07:23:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lcy453"/> <meta itemprop="url" content="https://juejin.cn/user/2921833644950300"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从验证码组件到 AI 时代：为什么「用中学」才是程序员的生存法则？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2921833644950300/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lcy453
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:23:15.000Z" title="Mon Nov 24 2025 07:23:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>        最近在调试 SnowAdmin 的验证码组件时，突然意识到一个很有意思的现象：这段生成随机验证码的代码，完美诠释了当代程序员的真实工作状态。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 生成随机数</span>
<span class="hljs-type">const</span> randomNum = (min: any, max: any) =&gt; {
  <span class="hljs-keyword">return</span> Math.<span class="hljs-built_in">floor</span>(Math.<span class="hljs-built_in">random</span>() * (max - min) + min);
};
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>        这几行代码简单直接 —— 不需要先精通概率统计，不需要理解随机数生成算法的底层原理，甚至不需要记住<code>Math.floor</code>和<code>Math.random</code>的所有参数细节。你只需要知道 "我需要一个范围内的随机整数"，然后就能写出或让 AI 生成这段代码。</p>
<hr/>
<h2 data-id="heading-0">1、验证码背后的「用中学」哲学</h2>
<p>        SnowAdmin 的验证码组件实现逻辑其实很朴素</p>
<p>        1.用<code>randomNum</code>生成随机数字和颜色</p>
<p>        2.通过 Canvas 绘制干扰线和噪点</p>
<p>        3.将生成的验证码字符串存储起来</p>
<p>        4.登录时比对用户输入与存储值</p>
<p>        整个过程中，开发者可能并不完全掌握 Canvas 的所有 API，也不需要知道色彩理论，但这丝毫不影响完成功能。遇到 "如何让文字旋转" 的问题时，才去查<code>rotate</code>方法的使用；需要调整干扰线密度时，才去优化循环次数。这种 "遇到问题→解决问题→掌握知识" 的模式，正是「用中学」的精髓。</p>
<hr/>
<h2 data-id="heading-1">2、AI 时代，提前学习为何越来越不划算？</h2>
<p>        在 AI 成为全能助手的今天，"提前储备知识" 的性价比正在急剧下降：</p>
<p><strong>1.知识半衰期缩短</strong>：去年还在用的框架 API，今年可能就被废弃。SnowAdmin 里用的 Vue3+TypeScript 组合，几年前还是前沿技术，现在已成为标配</p>
<p><strong>2.AI 的即时性碾压记忆</strong>：忘记<code>NProgress</code>的配置参数？问问 AI 就有答案；不知道如何实现表单验证？AI 能直接生成类似verify-tools.ts里的正则表达式</p>
<p><strong>3.问题复杂度飙升</strong>：现代项目需要整合的技术栈越来越多，从验证码组件到权限管理，从国际化到性能优化，没人能提前学完所有知识</p>
<p>        就像 SnowAdmin 集成的 NProgress 配置：</p>
<pre><code class="hljs language-php" lang="php">import NProgress <span class="hljs-keyword">from</span> <span class="hljs-string">"nprogress"</span>;
NProgress.<span class="hljs-title function_ invoke__">configure</span>({
  <span class="hljs-attr">easing</span>: <span class="hljs-string">"ease"</span>,
  <span class="hljs-attr">speed</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">showSpinner</span>: <span class="hljs-literal">false</span>
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>        大多数开发者不会提前背诵这些配置项，而是在需要自定义进度条时，才去查阅文档或让 AI 生成示例。</p>
<hr/>
<h2 data-id="heading-2">3、程序员的核心竞争力迁移</h2>
<p>        1.<strong>需求拆解能力</strong>能把 "做一个验证码" 拆解成 "生成随机字符→绘制图像→存储与验证" 这些步骤，比记住 Canvas API 更重要</p>
<p><strong>2.调试与优化意识</strong>SnowAdmin 的验证码组件通过添加干扰线、随机旋转文字来提高安全性，这种基于场景的优化思考，是 AI 难以替代的</p>
<p><strong>3.跨角色沟通能力</strong>和产品经理确认 "验证码错误是否需要提示具体原因"，与测试工程师讨论 "暴力破解防护策略"，这些沟通决定了功能的最终形态</p>
<p><strong>4.技术选型判断力</strong>为什么 SnowAdmin 选择自己实现验证码而不是用第三方库？这种权衡背后的考量，需要对项目规模、安全性要求、维护成本有深刻理解</p>
<hr/>
<h2 data-id="heading-3">4、「用中学」的实践方法论</h2>
<p>        结合 SnowAdmin 的开发场景，分享几个实用技巧：</p>
<p><strong>1.以组件为单位学习</strong>：研究verify-tools.ts里的表单验证函数，就能同时掌握正则表达式、TypeScript 类型定义和工具函数设计</p>
<p><strong>2.带着问题查源码</strong>：想知道如何实现响应式布局？直接看 SnowAdmin 的布局组件如何使用<code>useDevicesSize</code>钩子</p>
<p><strong>3.渐进式改造</strong>：先实现基础功能（如 4 位数字验证码），再逐步添加干扰元素、过期逻辑，每一步都解决一个具体问题</p>
<p><strong>4.善用 AI 但不依赖</strong>：让 AI 生成初始代码后，一定要亲手调试修改，比如调整验证码的字符集或干扰线数量，这个过程才能真正理解逻辑</p>
<h2 data-id="heading-4">  </h2>
<hr/>
<h2 data-id="heading-5">结语：在解决问题中构建知识体系</h2>
<p>        现代编程就像搭建乐高积木 —— 你不需要知道每块积木的制作工艺，只要明白如何组合它们实现特定功能。SnowAdmin 的验证码组件如此，整个项目的架构亦是如此。</p>
<p>        AI 确实取代了部分初级程序员的工作，但也解放了我们的认知带宽，让我们能专注于更核心的问题解决与系统设计。与其焦虑 "被 AI 替代"，不如拥抱 "用中学" 的模式：在实现功能的过程中积累经验，在与团队协作中提升软技能，在不断优化中深化技术理解。</p>
<p>        毕竟，编程的本质从来不是背诵 API，而是创造性地解决问题。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于GitHub Actions与算力平台API：构建端到端的模型自动训练与部署流水线]]></title>    <link>https://juejin.cn/post/7575563462048628771</link>    <guid>https://juejin.cn/post/7575563462048628771</guid>    <pubDate>2025-11-24T08:05:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575563462048628771" data-draft-id="7575810396203040802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于GitHub Actions与算力平台API：构建端到端的模型自动训练与部署流水线"/> <meta itemprop="keywords" content="人工智能,机器学习"/> <meta itemprop="datePublished" content="2025-11-24T08:05:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于GitHub Actions与算力平台API：构建端到端的模型自动训练与部署流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:05:43.000Z" title="Mon Nov 24 2025 08:05:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在机器学习项目的迭代过程中，持续集成与持续部署（CI/CD）已成为提升团队协作效率和模型交付速度的关键。通过将算力平台的API能力嵌入GitHub Actions工作流，我们可以构建一套端到端的自动化管道，实现从代码提交到模型训练再到服务部署的无缝衔接。</p>
<h4 data-id="heading-0">一、设计自动化流水线的核心组件</h4>
<p>自动化机器学习流水线通常包含多个关键节点：环境准备、代码检查、模型训练、模型评估和服务部署。在设计中，我们需要考虑如何将算力平台的动态资源调度与GitHub Actions的事件驱动机制相结合。</p>
<p>基于GitHub Actions的机器学习工作流示例主要包含触发器定义、身份验证、环境设置和任务执行四个部分。我们可以在此基础上扩展，集成算力平台的API以实现弹性资源调度。</p>
<p>对于算力平台而言，类似“算家云”这样的服务通过API提供算力资源弹性调度，使得GitHub Actions能够在需要执行训练任务时动态申请计算资源，任务完成后立即释放，从而实现成本优化。</p>
<h4 data-id="heading-1">二、实现端到端自动化流水线</h4>
<p>下面我们构建一个完整的自动化流水线，实现从代码提交触发模型训练到服务部署的全流程。</p>
<ol>
<li><strong>工作流定义与触发机制</strong></li>
</ol>
<p>在工作流定义中，我们可以设置多种触发条件，如代码推送、定时任务或手动触发：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Model</span> <span class="hljs-string">Training</span> <span class="hljs-string">Pipeline</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]
    <span class="hljs-attr">paths:</span> [ <span class="hljs-string">'models/**'</span> ]
  <span class="hljs-attr">schedule:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">"0 0 * * 1"</span>
  <span class="hljs-attr">workflow_dispatch:</span>
</code></pre>
<p>这样的配置保证了每次对模型代码的重要修改都能触发训练，同时设置了每周一次的定时训练，还可支持手动触发。</p>
<ol start="2">
<li><strong>算力平台身份验证集成</strong></li>
</ol>
<p>安全地与算力平台API交互是流水线的关键环节。我们可以通过GitHub Secrets存储认证信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">Compute</span> <span class="hljs-string">Platform</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">azure/login@v2</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">creds:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.COMPUTE_PLATFORM_CREDENTIALS</span> <span class="hljs-string">}}</span>
</code></pre>
<p>这一步骤类似于Azure机器学习中的身份验证方法，但适配了算力平台的API认证方式。</p>
<ol start="3">
<li><strong>动态资源申请与训练任务提交</strong></li>
</ol>
<p>通过API调用算力平台，实现训练任务的动态提交：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Submit</span> <span class="hljs-string">Training</span> <span class="hljs-string">Job</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    RESPONSE=$(curl -X POST https://api.suanjiayun.com/v1/train/jobs \
      -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d '{
        "project": "ml-model",
        "compute_type": "gpu-cluster",
        "entry_script": "train.py",
        "dataset_path": "data/processed/"
      }')
    echo "JOB_ID=$(echo $RESPONSE | jq -r '.job_id')" &gt;&gt; $GITHUB_ENV
</span></code></pre>
<p>这种方法借鉴了MCP（模型控制流水线）架构中的任务提交逻辑，通过API将训练任务分发到算力平台。</p>
<ol start="4">
<li><strong>训练状态监控与结果获取</strong></li>
</ol>
<p>由于训练任务可能需要较长时间，我们需要实现状态轮询机制：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Monitor</span> <span class="hljs-string">Training</span> <span class="hljs-string">Progress</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    while true; do
      STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
        https://api.suanjiayun.com/v1/train/jobs/$JOB_ID | jq -r '.status')
      echo "Current status: $STATUS"
      
      if [ "$STATUS" = "COMPLETED" ]; then
        echo "Training completed successfully"
        break
      elif [ "$STATUS" = "FAILED" ]; then
        echo "Training failed"
        exit 1
      fi
      sleep 120
    done
</span></code></pre>
<p>这种监控方式类似于IBM编排管道中对流程节点的监控逻辑，确保及时获取任务状态。</p>
<ol start="5">
<li><strong>模型评估与自动部署</strong></li>
</ol>
<p>训练完成后，自动进行模型评估并决定是否部署：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Evaluate</span> <span class="hljs-string">Model</span> <span class="hljs-string">and</span> <span class="hljs-string">Deploy</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    ACCURACY=$(curl -s -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
      https://api.suanjiayun.com/v1/train/jobs/$JOB_ID/metrics | jq -r '.accuracy')
</span>    
    <span class="hljs-string">echo</span> <span class="hljs-string">"Model accuracy: $ACCURACY"</span>
    
    <span class="hljs-string">MIN_ACCURACY=0.85</span>
    <span class="hljs-string">if</span> <span class="hljs-string">((</span> <span class="hljs-string">$(echo</span> <span class="hljs-string">"$ACCURACY &gt; $MIN_ACCURACY"</span> <span class="hljs-string">|</span> <span class="hljs-string">bc</span> <span class="hljs-string">-l)</span> <span class="hljs-string">));</span> <span class="hljs-string">then</span>
      <span class="hljs-string">echo</span> <span class="hljs-string">"Deploying model..."</span>
      <span class="hljs-comment"># 调用部署API</span>
    <span class="hljs-string">else</span>
      <span class="hljs-string">echo</span> <span class="hljs-string">"Model accuracy below threshold, skipping deployment"</span>
    <span class="hljs-string">fi</span>
</code></pre>
<p>这一阶段的评估逻辑类似于MCP架构中的模型性能监控与自动回滚机制。</p>
<h4 data-id="heading-2">三、高级实践与优化策略</h4>
<p>对于成熟的机器学习团队，还可以考虑以下高级实践：</p>
<ol>
<li><strong>多环境部署策略</strong>：实现基于模型性能的自动推广</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Progressive</span> <span class="hljs-string">Deployment</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    if [ "${{ github.ref }}" == "refs/heads/main" ]; then
      # 主分支代码直接部署到生产环境
      TARGET_ENV="production"
    else
      # 其他分支部署到测试环境
      TARGET_ENV="staging"
    fi
</span>    
    <span class="hljs-string">echo</span> <span class="hljs-string">"Deploying to $TARGET_ENV"</span>
</code></pre>
<ol start="2">
<li><strong>模型版本管理与回滚</strong>：结合模型注册表，实现版本控制和快速回滚</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Register</span> <span class="hljs-string">Model</span> <span class="hljs-string">Version</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    # 注册新模型版本
    curl -X POST https://api.suanjiayun.com/v1/models/versions \
      -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d '{
        "name": "text-classifier",
        "version": "${{ github.sha }}",
        "metrics": {
          "accuracy": 0.92,
          "inference_speed": 45
        }
      }'
</span></code></pre>
<ol start="3">
<li><strong>监控与反馈集成</strong>：在生产环境中监控模型性能，建立反馈循环</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 监控模型性能，检测概念漂移</span>
<span class="hljs-keyword">from</span> mcp_sdk <span class="hljs-keyword">import</span> MonitorEngine

MonitorEngine.watch(
    model_name=<span class="hljs-string">"text-classifier"</span>, 
    version=<span class="hljs-string">"v1.0"</span>, 
    metrics=[<span class="hljs-string">"accuracy"</span>, <span class="hljs-string">"latency"</span>]
)

<span class="hljs-comment"># 设置性能阈值，触发自动重新训练</span>
MonitorEngine.set_threshold(
    model_name=<span class="hljs-string">"text-classifier"</span>,
    metric=<span class="hljs-string">"accuracy"</span>,
    min_value=<span class="hljs-number">0.85</span>,
    action=<span class="hljs-string">"retrain"</span>
)
</code></pre>
<p>这种监控方法借鉴了MCP架构中的模型性能监控与自动反馈机制。</p>
<p>通过GitHub Actions与算力平台API的集成，我们能够构建一个完全自动化的模型训练与部署流水线。这种方案不仅大幅提升了机器学习项目的迭代效率，还通过动态资源调度优化了计算成本。</p>
<p>随着AI应用场景的不断扩展，基于CI/CD的自动化机器学习流水线将成为团队协作和模型交付的标准实践，而算力平台的API化则让这一过程的实现变得更加简单和高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 14：个人开发者的 Cloudflare 通关指南-将域名托管到 Cloudflare]]></title>    <link>https://juejin.cn/post/7575910333400907830</link>    <guid>https://juejin.cn/post/7575910333400907830</guid>    <pubDate>2025-11-24T08:06:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400907830" data-draft-id="7576018857367617579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 14：个人开发者的 Cloudflare 通关指南-将域名托管到 Cloudflare"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-24T08:06:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 14：个人开发者的 Cloudflare 通关指南-将域名托管到 Cloudflare
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:06:20.000Z" title="Mon Nov 24 2025 08:06:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c53ec1ce3944d729297fd050a54427b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=BV693tAztmgG3NaZWwPThvlm%2FAk%3D" alt="image-20251118150054298" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p><code>Cloudflare</code> 托管域名，免费 <code>CDN</code> 加速，免费申请 <code>SSL</code> 证书，相比于其他平台，这些对个人开发者而言无疑有着绝对的吸引力，这期我们就一起看一下如何将我们的域名托管到 <code>Cloudflare</code>，并且完成 <code>CDN</code> 加速。</p>
<blockquote>
<p>首先要完成 <code>Cloudflare</code> 的账号注册，这里我就不赘述了，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudflare-cn.com%2F" target="_blank" title="https://www.cloudflare-cn.com/" ref="nofollow noopener noreferrer">www.cloudflare-cn.com/</a></p>
<p>以及域名注册，无论你是哪个平台，要准备一个域名。</p>
</blockquote>
<h2 data-id="heading-1">二、托管域名</h2>
<h3 data-id="heading-2">2.1.  添加连接域</h3>
<p>点击右上角 【添加】–&gt; 【连接域】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aac7445cca3480b879dd7caf2e53fc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=NT4dpCEKnDhC0MJmmqk3rHtY7kQ%3D" alt="image-20251121104821441" loading="lazy"/></p>
<p>填写好自己要托管的域名</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58caf9d9fdeb4bb1b8020552f1dc0b52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=Zz4Ix9UHJTb%2BWD1NnJqmfkKopOc%3D" alt="image-20251121105005820" loading="lazy"/></p>
<p>点击 【继续】，选中免费计划</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0de44e1b18944b288014ab3e7b58e38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=%2FHiUJ9bV2I0jgOdvdTeKiAbszTY%3D" alt="image-20251121105232214" loading="lazy"/></p>
<p>进入最后一步引导配置页面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ab161fbdf7746aeb58b4dec6075a32b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=rtpkLG9sugKofRt%2BEBIjVbcd9io%3D" alt="image-20251121105352875" loading="lazy"/></p>
<blockquote>
<p>这里我用的是之前在腾讯解析过的域名，所以这里会给我之前的配置带过来，先不管它。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc5bb8f13cd40969304366270228602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=EXjk59owGMDa8A%2FrVbFD4gqCaYI%3D" alt="image-20251121111550914" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 激活 Cloudflare</h3>
<ul>
<li><strong>第一步：登录您的 DNS 提供商</strong></li>
</ul>
<p>根据最后一步指引，这里我的是腾讯买的域名，所以我登录腾讯云后台，找到了域名管理的地方，如果你用的是其他平台，找到你域名管理的地方。找到 DNS 解析的地方。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e29a5d5ab60e49ad8bccb722c6e8bbea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=FJYU6Wb21X1VYQEfMjkpTqVup%2BE%3D" alt="image-20251121112325176" loading="lazy"/></p>
<ul>
<li><strong>第二步：确保 DNSSEC 已关闭</strong></li>
</ul>
<p>这里我以腾讯云为例，腾讯云这个是要付费的，所以如果你没有付过费，大概率不用管，忽略这一步就行。</p>
<p>具体位置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1ffb5e5f929466785ca22eca0648392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=C1dfTooOtDpKfUkqhKsCO5veYWc%3D" alt="image-20251121113455246" loading="lazy"/></p>
<ul>
<li><strong>第三步：将您当前的名称服务器替换为 Cloudflare 名称服务器</strong></li>
</ul>
<p>将腾讯云DNS服务器改成 Cloudflare 提供的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7bdaf04db494834954769500ab3b137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=lrnnbQpwiWsF5TSL3On0V6TR9%2Bc%3D" alt="image-20251121113759352" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf0bf8aff2814062a55510419ff402a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=odeZrR2XBjmnsoXKpBn1BktNq0Y%3D" alt="image-20251121113917542" loading="lazy"/></p>
<p>点击提交后就完成了所有步骤</p>
<p>过一会儿你就会收到邮件提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9c9b81018d84779b1fa20ec9dbb2f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=eWfjHlv%2Fd2y%2FvB%2BVmCGWrIC2eyE%3D" alt="image-20251121114233488" loading="lazy"/></p>
<p>刷新页面，变成活动状态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6988cff5508449a894cea6d3d453e13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=OqpGgGbIyPs%2FbJV9t8B6%2F7h1DbM%3D" alt="image-20251121114159864" loading="lazy"/></p>
<blockquote>
<p>这个时候托管已经完成，但是域名解析有点乱，因为我们之前是在腾讯云做的域名解析，现在托管给了Cloudflare，理论上来说后续我们可以不用管腾讯云了。为了统一管理，我将腾讯云平台的全部删了，这个会影响当前网站的运行，所以如果对你目前网站有影响请谨慎操作。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34a51ce756f4dc590aaf4e5177d2162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=u7YvQ0Z0sC6EbIZR%2FPsxxdcNF84%3D" alt="image-20251121114922109" loading="lazy"/></p>
<p><code>Cloudflare</code> 之前自己扫描过来的DNS记录也全部删除掉</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b61aba9212f45cba2060d483972bea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=LF7awQpQtQHIIc35gucvjpndPLU%3D" alt="image-20251121115914436" loading="lazy"/></p>
<p>这个时候再去访问我们之前的站点，已经崩了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13ebf319c83e444a9b0a2c72d0f69928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=mHagteAc84b%2FqxojOFOnHXi67vM%3D" alt="image-20251121120124192" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 域名解析</h3>
<blockquote>
<p>重新添加域名解析，IPv4 填你服务器的外网IP</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae23b98739f641a6af477b8bd6789426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=35Sn1RxU4R6xmZbgeI10QmSW%2BQA%3D" alt="image-20251121133553538" loading="lazy"/></p>
<p>保存后，重新刷新一下  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csyblog.cn%2F%25EF%25BC%258C%25E6%2581%25A2%25E5%25A4%258D%25E6%25AD%25A3%25E5%25B8%25B8%25E4%25BA%2586%25E3%2580%2582" target="_blank" title="https://www.csyblog.cn/%EF%BC%8C%E6%81%A2%E5%A4%8D%E6%AD%A3%E5%B8%B8%E4%BA%86%E3%80%82" ref="nofollow noopener noreferrer">www.csyblog.cn/，恢复正常了。</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76d78c2b4cf5418ba18132b5b7073f27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=Fouwzu8fcTr8u2ssFykqbBPp1ww%3D" alt="image-20251121133713879" loading="lazy"/></p>
<h2 data-id="heading-5">三、启用 Cloudflare 代理与 CDN 服务</h2>
<blockquote>
<p>💡 这里简单科普一下什么是 <code>CDN</code>：</p>
<p><code>Content Delivery Network</code>，内容分发网络，由地理上分散的服务器组成，当用户请求访问特定内容时，<code>CDN</code> 可以从最接近用户的服务器提供缓存的内容，从而减少了传输延迟和网络拥塞。</p>
<p>大白话就是，<strong>把东西提前放到离你最近的地方，让你不用千里迢迢去取</strong></p>
</blockquote>
<p>那么 CDN 的好处也就显而易见了：</p>
<ol>
<li><strong>速度飞快：</strong> 把网站内容（图片、视频等）复制到离你最近的服务器上，让你几乎感觉不到延迟，看视频、刷网页更顺畅。</li>
<li>**扛得住高并发：**即使成千上万人同时访问同一个热门网站（比如抢票、双十一），<code>CDN</code>能把流量分散到各个节点，网站不容易崩溃。</li>
<li>**更省钱：**减轻了原始服务器的压力和带宽消耗，为网站所有者节省了成本。</li>
<li>**更安全：**像一道防线，能帮助抵御一些网络攻击（比如 <code>DDoS</code> 攻击），保护源站服务器。</li>
<li>**更稳定可靠：**如果一个 <code>CDN</code> 节点出问题了，会自动切换到其他正常节点，保证用户还能正常访问，不会中断。</li>
</ol>
<p>在开启 <code>CDN</code> 之前先看一个现象，我们 <code>ping</code> 一下没开启服务之前的域名(如果发现 <code>ping</code> 不通，可能需要等一会儿，因为刚刚添加的解析)，会发现可以直接<code>ping</code> 出来我们服务器的真实 <code>IP</code>，通常情况服务器IP直接暴露是存在一定风险的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d4631c903664cb88da2db05dd14f121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=A91%2FsKxRIHqME6Px3G2EHwaXUhU%3D" alt="image-20251121134424910" loading="lazy"/></p>
<p>开启代理非常简单，我们只需要在 <code>DNS</code> 记录，编辑开启即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e55d49e609fd4509bb116bb7b4698b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=zSTD5Q5F9mZk%2BuaaAIwwMuhJFA0%3D" alt="image-20251121134600047" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96041cbbdbfa493795dc0f631a65a177~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=YlC8%2FV7WmpyF0IgpzSsk5blPNoE%3D" alt="image-20251121134711356" loading="lazy"/></p>
<blockquote>
<p>当你启用 <code>Cloudflare</code> 的代理功能时，<code>Cloudflare CDN</code> 服务也就启用了。</p>
</blockquote>
<p>我们再 <code>ping</code> 一下域名，会发现 <code>IP</code> 已经不是我们服务器的 <code>IP</code> 了，当然这也会有一点延迟，所以第一时间 <code>ping</code> 出的如果还是服务器 <code>IP</code>，并不代表代理失败了，只需要等个 <code>5-10</code> 分钟，再验证一下即可。</p>
<h2 data-id="heading-6">四、申请 SSL/TLS 证书</h2>
<p>之前我使用的是腾讯云的，也是免费的，但是需要每<code>3</code>个月换一次，有点麻烦。</p>
<p>点击【概述】–&gt; 【配置】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/827de10866d54d3d944c5019e78ee14b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=ZqU2C%2BltMSUfnb1zsWjf8VKT2jc%3D" alt="image-20251121141707011" loading="lazy"/></p>
<p>选则【完全】–&gt; 【保存】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fcf544a118040ca898d772fc5603757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=3SdjTnyszOHxiufrqW1kuw9WIIw%3D" alt="image-20251121141920929" loading="lazy"/></p>
<p>点击左侧菜单【源服务器】–&gt; 【创建证书】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eebcabb5937047d6b0f93ecf3e564d44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=Yg6dQnCrBBlXlpkiivPP3SCo7x0%3D" alt="image-20251121142123741" loading="lazy"/></p>
<p>这里默认选项就行，默认证书有效期<code>15</code>年，根据自己需要调整主机名，这里默认是顶级域名和通配符下所有二级域名。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13db64e1c05643e6a4a472c4dbccab8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=8bBk3G75fcnvPj1ULRxfjqG3jvM%3D" alt="image-20251121142259655" loading="lazy"/></p>
<p>点击 【创建】，这个时候就生成了证书和密钥，在 <code>nginx</code> 配置上即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d66b35ce0794d18abaad8868f3308a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576380&amp;x-signature=Z4wzYBlwBYSxIcqdZXSf%2FTafaUk%3D" alt="image-20251121142522394" loading="lazy"/></p>
<blockquote>
<p>注意这里的密钥 <code>key</code> 只会显示一次，如果不小心忘记复制了，那只能把原来的证书撤销了，重新创建一个。</p>
</blockquote>
<h2 data-id="heading-7">五、总结</h2>
<p>域名托管、cdn加速、ssl 证书这是一个站点最基础的配置，无论你使用哪个平台，其实本质都是一样的，无非就是付费差异，<code>Cloudflare</code> 的优势就在于它的免费计划几乎能够涵盖个人开发的前期所有需要。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Docker到Containerd：Kubernetes容器运行时演进深度解析]]></title>    <link>https://juejin.cn/post/7575884229526110244</link>    <guid>https://juejin.cn/post/7575884229526110244</guid>    <pubDate>2025-11-24T08:13:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229526110244" data-draft-id="7576018857367666731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Docker到Containerd：Kubernetes容器运行时演进深度解析"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-24T08:13:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Docker到Containerd：Kubernetes容器运行时演进深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:13:22.000Z" title="Mon Nov 24 2025 08:13:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Kubernetes的世界里，容器运行时是一个基础且关键的组件。它负责真正在主机上启动和停止容器。近年来，随着Kubernetes的成熟，其默认的容器运行时环境经历了重大演变，从我们熟知的Docker转向了更为底层和精简的Containerd。本文将深入剖析Docker、Containerd的架构差异，并结合实际案例说明这一转变带来的影响。</p>
<hr/>
<h4 data-id="heading-0"><strong>一、 核心概念：什么是容器运行时？</strong></h4>
<p>简单来说，容器运行时是负责运行容器的软件。它根据容器镜像（OCI Image）创建隔离的、资源受限的进程（容器）。Kubernetes本身不直接处理这些底层操作，而是通过<strong>容器运行时接口（CRI）</strong> ​ 与运行时进行交互。</p>
<p>在Kubernetes的视角下，它只关心：“请在这个Pod里启动一个包含A镜像的容器”。至于如何拉取镜像、如何创建命名空间和Cgroups、如何运行容器，这些都是容器运行时的职责。</p>
<h4 data-id="heading-1"><strong>二、 演进历程：从“Docker时代”到“后Docker时代”</strong></h4>
<p>要理解今天的格局，我们需要回顾一下历史。</p>
<ol>
<li>
<p><strong>早期：直接集成Docker</strong></p>
<p>在Kubernetes早期，它是通过一个内置的<code>dockershim</code>组件直接与Docker Engine集成。Docker是当时事实上的容器标准，这种集成方式简单直接。对于用户而言，体验非常顺畅：安装Docker，安装Kubelet，即可工作。</p>
</li>
<li>
<p><strong>变革：CRI的引入与Docker的“包袱”</strong></p>
<p>为了支持更多的容器运行时（如RKT、Containerd），Kubernetes推出了<strong>容器运行时接口（CRI）</strong> 。这是一个插件接口，任何实现了CRI的运行时都可以被Kubernetes使用。</p>
<p>然而，Docker Engine本身<strong>没有实现CRI</strong>。它是一套完整的容器化解决方案，包含构建、镜像格式、网络、存储、运行时等一大堆功能。为了继续使用Docker，Kubernetes不得不维护一个特殊的适配器——<code>dockershim</code>。这个组件将Kubelet发出的CRI请求（如<code>RunPodSandbox</code>）翻译成Docker Engine能理解的API请求。</p>
</li>
<li>
<p><strong>现状：拥抱标准的Containerd</strong></p>
<p><code>dockershim</code>的维护给Kubernetes社区带来了额外的负担，且架构上显得冗余。与此同时，Docker Engine内部的容器运行时正是<strong>Containerd</strong>——一个更专注、更轻量、性能更好的纯运行时组件。Containerd天然就实现了CRI。</p>
<p>因此，从Kubernetes v1.20开始宣布弃用<code>dockershim</code>，并在v1.24版中正式移除，转向将Containerd作为默认的运行时推荐。这标志着Kubernetes与Docker Engine的“解耦”，进入了更开放、更标准化的“后Docker时代”。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-2"><strong>三、 架构深度解析：Docker vs. Containerd</strong></h4>
<p>让我们通过两张架构图来直观理解它们的区别。</p>
<p><strong>1. 使用Docker Engine（通过dockershim）的架构</strong></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+---------------------------------------------------+</span>
|                 Kubernetes Kubelet                 |
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 CRI Interface                     |
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 dockershim (适配器)                |  &lt;- 由K8s维护的翻译层
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 Docker Daemon REST API             |
<span class="hljs-addition">+---------------------------------------------------+</span>
|      Docker Engine (容器管理、构建、网络、存储...)    |  &lt;- 功能丰富但沉重
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 containerd (内部组件)              |  &lt;- 实际负责容器生命周期
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 runc (底层运行时)                  |  &lt;- 真正创建容器进程
<span class="hljs-addition">+---------------------------------------------------+</span>
</code></pre>
<p><strong>工作流程</strong>：</p>
<ul>
<li>Kubelet通过CRI发出指令（例如：<code>运行一个Nginx容器</code>）。</li>
<li><code>dockershim</code>将这个CRI请求翻译成Docker API请求（例如：<code>docker create/start</code>）。</li>
<li>请求发送给Docker Daemon。</li>
<li>Docker Daemon内部调用其内置的Containerd来执行操作。</li>
<li>Containerd最终调用<code>runc</code>来创建容器。</li>
</ul>
<p><strong>痛点</strong>：</p>
<ul>
<li><strong>路径长</strong>：请求需要经过多次转发，增加了延迟和故障点。</li>
<li><strong>资源重</strong>：Docker Daemon本身消耗更多CPU和内存。</li>
<li><strong>架构复杂</strong>：引入了不必要的抽象层。</li>
</ul>
<p><strong>2. 直接使用Containerd的架构</strong></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+---------------------------------------------------+</span>
|                 Kubernetes Kubelet                 |
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 CRI Interface                     |
<span class="hljs-addition">+---------------------------------------------------+</span>
|             cri-containerd plugin (CRI插件)        |  &lt;- Containerd内置的CRI实现
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 containerd (纯运行时)               |  &lt;- 核心：镜像、容器管理
<span class="hljs-addition">+---------------------------------------------------+</span>
|                 runc / runsc (底层运行时)           |  &lt;- 支持多种OCI运行时
<span class="hljs-addition">+---------------------------------------------------+</span>
</code></pre>
<p><strong>工作流程</strong>：</p>
<ul>
<li>Kubelet通过CRI发出指令。</li>
<li>Containerd内置的<code>cri</code>插件直接接收并处理CRI请求。</li>
<li>Containerd管理镜像和容器生命周期，并直接调用<code>runc</code>。</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>路径短</strong>：架构扁平，效率更高，稳定性更好。</li>
<li><strong>资源轻</strong>：少了Docker Daemon这一层，资源占用显著降低。</li>
<li><strong>更纯粹</strong>：专注容器运行时核心职责，符合Kubernetes的期望。</li>
</ul>
<hr/>
<h4 data-id="heading-3"><strong>四、 核心区别与实际影响总结</strong></h4>








































<table><thead><tr><th>特性</th><th>Docker Engine</th><th>Containerd</th></tr></thead><tbody><tr><td><strong>定位</strong>​</td><td>完整的容器化平台，面向开发者</td><td>专注的、工业级的容器<strong>运行时</strong>，面向基础设施</td></tr><tr><td><strong>架构复杂度</strong>​</td><td>高，包含大量非必要功能（如<code>docker build</code>，Swarm）</td><td>低，核心只有镜像和容器管理</td></tr><tr><td><strong>与K8s集成</strong>​</td><td>需通过<code>dockershim</code>（已废弃），非原生</td><td>原生支持CRI，是Kubernetes的“一等公民”</td></tr><tr><td><strong>资源占用</strong>​</td><td>较高（内存、CPU）</td><td>更低，通常比Docker少20%-30%的内存占用</td></tr><tr><td><strong>CLI工具</strong>​</td><td>功能强大的<code>docker</code>命令</td><td>功能基础的<code>ctr</code>命令（不适合人类使用），或<code>crictl</code>（推荐）</td></tr><tr><td><strong>API</strong>​</td><td>丰富的Docker API</td><td>更底层的Containerd API，以及标准的CRI</td></tr></tbody></table>
<p><strong>对用户的实际影响</strong>：</p>
<ol>
<li>
<p><strong>你不能再使用<code>docker</code>命令进行故障排查</strong>：这是最大的变化。在节点上，你无法直接执行<code>docker ps</code>或<code>docker logs</code>来查看Kubernetes创建的容器。</p>
</li>
<li>
<p><strong>使用新的CLI工具</strong>：</p>
<ul>
<li><strong><code>crictl</code></strong>：Kubernetes社区推荐的CRI调试工具。它的命令格式与<code>docker</code>类似，例如 <code>crictl ps</code>, <code>crictl logs</code>。</li>
<li><strong><code>ctr</code></strong>：Containerd自带的命令行工具，更底层，但对用户不友好，一般不推荐直接使用。</li>
</ul>
</li>
<li>
<p><strong>性能与稳定性提升</strong>：更少的组件意味着更少的潜在问题和高负载下更好的性能。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-4"><strong>五、 实战案例：故障排查场景对比</strong></h4>
<p>假设一个Pod一直处于<code>Pending</code>状态，我们怀疑是容器启动失败。</p>
<p><strong>场景：在节点上查看容器日志。</strong></p>
<p><strong>案例1：使用Docker作为运行时的旧集群（K8s &lt; 1.24）</strong></p>
<ol>
<li>
<p>找到问题Pod所在的节点和容器ID。</p>
</li>
<li>
<p>SSH登录到节点。</p>
</li>
<li>
<p>使用熟悉的Docker命令查看日志：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查找容器ID</span>
docker ps -a | <span class="hljs-keyword">grep</span> &lt;pod-name&gt;

<span class="hljs-comment"># 查看日志</span>
docker logs &lt;container-id&gt;
</code></pre>
<p>这种方式直观，但依赖于已废弃的架构。</p>
</li>
</ol>
<p><strong>案例2：使用Containerd作为运行时的现代集群（K8s &gt;= 1.24）</strong></p>
<ol>
<li>
<p>找到问题Pod所在的节点和容器ID（可以从<code>kubectl describe pod &lt;pod-name&gt;</code>获取）。</p>
</li>
<li>
<p>SSH登录到节点。</p>
</li>
<li>
<p>使用<code>crictl</code>工具（需要先配置，或通过<code>/var/run/containerd/containerd.sock</code>socket）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据Pod名查找容器ID</span>
crictl pods --name &lt;pod-name&gt;
crictl ps -p &lt;pod-<span class="hljs-built_in">id</span>&gt;

<span class="hljs-comment"># 查看容器日志</span>
crictl logs &lt;container-<span class="hljs-built_in">id</span>&gt;

<span class="hljs-comment"># 或者更直接地，通过镜像名模糊查找</span>
crictl ps | grep nginx
crictl logs &lt;container-<span class="hljs-built_in">id</span>&gt;
</code></pre>
<p>虽然命令变了，但功能和效果一致，且架构更优。</p>
</li>
</ol>
<p><strong>进阶案例：使用<code>crictl</code>进行深度调试</strong></p>
<p><code>crictl</code>的功能非常强大，几乎覆盖了所有调试场景：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 检查容器详情（包括资源限制、挂载点等）</span>
crictl inspect &lt;container-<span class="hljs-built_in">id</span>&gt;

<span class="hljs-comment"># 在运行的容器中执行命令</span>
crictl <span class="hljs-built_in">exec</span> -it &lt;container-<span class="hljs-built_in">id</span>&gt; /<span class="hljs-built_in">bin</span>/sh

<span class="hljs-comment"># 拉取镜像到节点（用于离线环境或预缓存）</span>
crictl pull nginx:latest

<span class="hljs-comment"># 查看容器资源使用情况（类似docker stats）</span>
crictl stats
</code></pre>
<hr/>
<h4 data-id="heading-5"><strong>六、 结论与展望</strong></h4>
<p>从Docker到Containerd的转变，是Kubernetes生态走向成熟和标准化的必然结果。它标志着Kubernetes不再依赖一个特定的、庞大的容器平台，而是基于开放标准（如OCI、CRI）来构建其基础设施。这种解耦带来了更清晰的边界、更好的性能、更高的稳定性和更低的资源开销。</p>
<p>对于开发者和运维人员而言，需要理解并适应这一变化：</p>
<ul>
<li><strong>对于应用开发者</strong>：这一变化基本无感。你仍然可以像以前一样使用Dfile构建镜像，并在Kubernetes的YAML中引用它们。因为镜像标准（OCI）没有变。</li>
<li><strong>对于集群运维人员</strong>：这是必须掌握的知识。你需要熟悉Containerd的配置、日志位置以及新的调试工具链（<code>crictl</code>）。</li>
</ul>
<p>未来，容器运行时的生态会继续发展，除了Containerd，还有像<code>CRI-O</code>这样的优秀选择。同时，安全容器（如Kata Containers，通过<code>runsc</code>运行时）等新技术也建立在Containerd等基础运行时之上。牢牢掌握Containerd，就是掌握了理解现代Kubernetes容器编排根基的钥匙。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[技术复盘：Solon-MCP 日志统一配置背后的技术架构分析]]></title>    <link>https://juejin.cn/post/7576057623742119978</link>    <guid>https://juejin.cn/post/7576057623742119978</guid>    <pubDate>2025-11-24T08:18:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623742119978" data-draft-id="7575829296452648970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="技术复盘：Solon-MCP 日志统一配置背后的技术架构分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:18:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asthenian"/> <meta itemprop="url" content="https://juejin.cn/user/2685482018803200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            技术复盘：Solon-MCP 日志统一配置背后的技术架构分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2685482018803200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asthenian
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:18:37.000Z" title="Mon Nov 24 2025 08:18:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 问题的起因：一次“屏蔽报错”的任务</h3>
<p>故事的开始非常简单。最近在调试项目时，我的 Mentor (MT) 让我去处理一下控制台的日志。</p>
<p>原因是项目引入了 <code>solon-mcp</code> 相关组件，每次建立连接时都会输出一堆 <code>WARN</code> 级别的异常日志。经过排查，这些异常并不影响实际功能的链路，属于框架内部的“噪音”。为了保持控制台清爽，MT 让我把它的日志级别调高，屏蔽掉这些警告。</p>
<p>操作很简单，我熟练地打开 <code>application.yml</code>，加上了一行配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">io.modelcontextprotocol:</span> <span class="hljs-string">ERROR</span> <span class="hljs-comment"># 屏蔽 WARN，只看 ERROR</span>
</code></pre>
<p>重启服务，世界清静了。</p>
<p>任务虽然完成了，但我盯着 <code>application.yml</code> 里的这块配置区域，突然陷入了沉思：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">com.testjob.sls:</span> <span class="hljs-string">DEBUG</span>          <span class="hljs-comment"># 我们的业务代码</span>
    <span class="hljs-attr">com.xxl.job:</span> <span class="hljs-string">INFO</span>             <span class="hljs-comment"># 第三方任务调度框架</span>
    <span class="hljs-attr">io.modelcontextprotocol:</span> <span class="hljs-string">ERROR</span> <span class="hljs-comment"># 刚刚配置的 MCP 协议库</span>
</code></pre>
<p><strong>我不禁产生了一个疑问：</strong><br/>
为什么？为什么 <code>Solon-MCP</code>、<code>XXL-JOB</code>、<code>Spring</code> 以及我们自己写的业务代码，明明是完全不同团队、不同时间开发的组件，却都能被这同一个 <code>logging</code> 配置项所支配？</p>
<p>是不是在这简单的 YAML 配置背后，隐藏着某种统一的“潜规则”或底层架构设计？</p>
<p>带着这个疑问，我决定深挖一下 Java 日志体系背后的秘密。</p>
<hr/>
<h3 data-id="heading-1">2. 现象观察：万法归一</h3>
<p>在分析依赖树和源码后，我发现这是一个典型的<strong>从混乱到统一</strong>的架构设计案例。</p>
<p>所有的组件，无论内部实现如何，最终都“臣服”于我们的配置文件。这说明在我们的技术栈中，存在一个<strong>统一的日志门面（Logging Facade）</strong> ，它像一个外交官一样，统一管理了所有组件的对外发声渠道。</p>
<hr/>
<h3 data-id="heading-2">3. 技术架构拆解</h3>
<p>通过查阅资料和源码分析，我将这个机制拆解为三个核心层面：</p>
<h4 data-id="heading-3">3.1 第一层：门面模式（Facade Pattern）—— 制定标准</h4>
<p>在代码层面，我发现无论是我们自己写的代码，还是 <code>solon-mcp</code> 的源码，获取 Logger 的方式都惊人的一致：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 大家都使用的是 SLF4J 的接口，而不是具体的 Logback 或 Log4j</span>
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpAsyncServer</span> {
    <span class="hljs-comment">// 面向接口编程，而非面向实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.<span class="hljs-built_in">getLogger</span>(McpAsyncServer.<span class="hljs-keyword">class</span>);
}
</code></pre>
<p>这就是<strong>门面模式</strong>的应用。<strong>SLF4J (Simple Logging Facade for Java)</strong> 就是这个“门面”。</p>
<ul>
<li><strong>对于组件开发者（如 MCP 的作者）</strong> ：我只需要调用 SLF4J 的 API 打印日志，不需要关心使用者到底用的是 Logback 还是 Log4j2。</li>
<li><strong>对于使用者（我们）</strong> ：我们只需要配置 SLF4J 的具体实现，就能控制所有用了 SLF4J 的组件。</li>
</ul>
<h4 data-id="heading-4">3.2 第二层：偷天换日 —— 桥接器（Bridging）</h4>
<p>但是，如果引入的第三方库比较老（比如用了 Log4j 1.x）或者比较特立独行（用了 Java 原生的 JUL）怎么办？它们并没有使用 SLF4J 啊。</p>
<p>这时候，Java 日志生态的**桥接器（Bridging）**就登场了。</p>
<p>在我们的 <code>pom.xml</code> 依赖树中，我发现了这些“间谍”包的存在：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 将 Log4j 的调用拦截下来，转发给 SLF4J --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 将 Java 原生 Logging 拦截下来，转发给 SLF4J --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jul-to-slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>原理总结</strong>：这些桥接器通过同名包替换或拦截的方式，把其他日志框架的 API 调用，“骗”过来转发给 SLF4J。这就实现了“虽然你是不同门派，但最终都走同一个出口”。</p>
<h4 data-id="heading-5">3.3 第三层：自动配置魔法 —— Spring Boot / Solon 的统筹</h4>
<p>最后，为什么 <code>application.yml</code> 能生效？</p>
<p>这是框架（Spring Boot 或 Solon）提供的**自动化配置（Auto Configuration）**能力。以 Spring Boot 为例，启动时会发生以下过程：</p>
<ol>
<li><strong>扫描</strong>：<code>LoggingApplicationListener</code> 扫描 Classpath，发现存在 <code>logback-classic</code> 包。</li>
<li><strong>实例化</strong>：初始化 <code>LogbackLoggingSystem</code>。</li>
<li><strong>加载配置</strong>：读取 <code>application.yml</code> 中的 <code>logging.level.*</code>。</li>
<li><strong>应用</strong>：将这些配置动态设置到 Logback 的上下文中。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码演示框架的配置逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">configure</span>(<span class="hljs-params">LoggingSystem system</span>) {
    <span class="hljs-title class_">String</span> mcpLevel = environment.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"logging.level.io.modelcontextprotocol"</span>);
    <span class="hljs-comment">// 最终调用底层 Logback 的 API 设置级别</span>
    system.<span class="hljs-title function_">setLogLevel</span>(<span class="hljs-string">"io.modelcontextprotocol"</span>, <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">ERROR</span>);
}
</code></pre>
<p>这就是为什么我们改一行配置，就能远程控制深埋在 jar 包里的 <code>solon-mcp</code> 的行为了。</p>
<hr/>
<h3 data-id="heading-6">4. 深度思考：架构设计的魅力</h3>
<p>这次排查让我意识到，一个优秀的架构设计（如 Java 的日志体系）体现了以下原则：</p>
<ol>
<li><strong>依赖倒置原则 (DIP)</strong> ：<br/>
上层应用不应该依赖底层日志实现，二者都应该依赖抽象（SLF4J）。这也是为什么我们能随意切换 Logback 或 Log4j2 而不用改一行代码。</li>
<li><strong>关注点分离 (SoC)</strong> ：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>库开发者</strong>（MCP团队）只关注“我要打印什么信息”。</li>
<li><strong>应用开发者</strong>（我）只关注“我要看什么级别的日志”。</li>
<li><strong>运维人员</strong>只关注“日志存到哪里，保留几天”。<br/>
大家各司其职，通过标准接口解耦。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>微内核架构思想</strong>：<br/>
SLF4J 就像一个微内核，各种适配器和实现就像插件。这种生态兼容性，是 Java 工程化强大的重要原因。</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔍 React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！]]></title>    <link>https://juejin.cn/post/7575887863797645322</link>    <guid>https://juejin.cn/post/7575887863797645322</guid>    <pubDate>2025-11-24T08:21:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863797645322" data-draft-id="7573601651782516763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔍  React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T08:21:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lsx_"/> <meta itemprop="url" content="https://juejin.cn/user/1442981392682829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔍  React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442981392682829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lsx_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:21:29.000Z" title="Mon Nov 24 2025 08:21:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么封装一个Vue3版本的useTable</h2>
<p>之前写 React ， 有 <code>ahooks 的</code> 提供的 <code>useAntdTable</code> 这样的成熟数据表封装，而在 Vue3 中并没有等价的“官方”工具。</p>
<p>在 <strong>React + Ant Design</strong> 的生态里：</p>
<ul>
<li><code>ahooks</code> 的 <code>useAntdTable</code> 非常常用；</li>
<li>负责统一管理表格的数据请求、分页、搜索、loading、刷新等逻辑。</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { tableProps, search } = <span class="hljs-title function_">useAntdTable</span>(getTableData)
</code></pre>
<p>这会自动帮你实现：</p>
<ul>
<li>请求数据；</li>
<li>分页变化自动触发请求；</li>
<li>搜索参数归一化；</li>
<li>Loading 管理。</li>
</ul>
<p>👉 组件只负责展示，逻辑都集中在 hook 中。</p>
<blockquote>
<p>在vue3项目中，也有不少表格业务，他们的功能都大差不差，有很多相似的逻辑，然后我们的封装一个useTable，其作用就是提取相同的逻辑到hooks中，而UI组件只负责使用hooks暴露的数据与方法。这极大的提高了代码的逻辑复用，统一行为，UI 与业务逻辑完全分离。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">介绍 useTable</h2>
<p>一个专为 <code>Vue3 + Element Plus</code> 设计的表格数据管理 Hook，参考 ahooks 的 <code>useAntdTable</code> 设计，提供部分的表格功能支持。</p>
<h3 data-id="heading-2">特性</h3>
<ul>
<li>🚀 <strong>开箱即用</strong> - 零配置即可使用，自动处理分页、搜索、排序</li>
<li>📦 <strong>类型安全</strong> - 完整的 TypeScript 支持</li>
<li>🎯 <strong>语义化 API</strong> - 方法名清晰易懂，符合开发习惯</li>
<li>🔧 <strong>高度可定制</strong> - 支持数据转换、错误处理、回调函数等</li>
<li>📱 <strong>响应式</strong> - 基于 Vue3 Composition API，完全响应式</li>
<li>🎨 <strong>Element Plus 友好</strong> - 专为 Element Plus 表格组件设计</li>
</ul>
<h3 data-id="heading-3">📋 核心功能</h3>
<h4 data-id="heading-4">1. 数据管理</h4>
<ul>
<li>✅ 自动加载数据</li>
<li>✅ 加载状态管理</li>
<li>✅ 错误处理</li>
</ul>
<h4 data-id="heading-5">2. 分页功能</h4>
<ul>
<li>✅ 页码切换</li>
<li>✅ 每页条数调整</li>
<li>✅ 分页状态同步</li>
</ul>
<h4 data-id="heading-6">3. 搜索功能</h4>
<ul>
<li>✅ 多字段搜索</li>
<li>✅ 搜索条件组合</li>
<li>✅ 搜索重置</li>
</ul>
<h4 data-id="heading-7">4. 排序功能</h4>
<ul>
<li>✅ 多字段排序</li>
<li>✅ 排序方向切换</li>
<li>✅ 排序状态管理</li>
</ul>
<h4 data-id="heading-8">5. 行选择</h4>
<ul>
<li>✅ 单选/多选</li>
<li>✅ 批量操作</li>
<li>✅ 选中状态管理</li>
</ul>
<h3 data-id="heading-9">基础用法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-comment">// 定义数据类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> | <span class="hljs-string">'inactive'</span>
}

<span class="hljs-comment">// 定义请求参数类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserListParams</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>
  name?: <span class="hljs-built_in">string</span>
  status?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// API 请求函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: UserListParams</span>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params)
  })
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>()
}

<span class="hljs-comment">// 使用 Hook</span>
<span class="hljs-keyword">const</span> { data, loading, pagination, search, refresh } = useTable&lt;<span class="hljs-title class_">User</span>, <span class="hljs-title class_">UserListParams</span>&gt;({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">defaultPagination</span>: { <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> },
  <span class="hljs-attr">defaultSearchParams</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> }
})
</code></pre>
<h3 data-id="heading-10">API</h3>
<h4 data-id="heading-11">配置选项</h4>













































































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>request</code></td><td><code>(params: P) =&gt; Promise&lt;HttpResponse&lt;TableData&lt;T&gt;&gt;&gt;</code></td><td>-</td><td>数据请求函数</td></tr><tr><td><code>defaultPagination</code></td><td><code>Partial&lt;PaginationParams&gt;</code></td><td><code>{ current: 1, pageSize: 10 }</code></td><td>默认分页参数</td></tr><tr><td><code>defaultSearchParams</code></td><td><code>Record&lt;string, any&gt;</code></td><td><code>{}</code></td><td>默认搜索参数</td></tr><tr><td><code>defaultSortParams</code></td><td><code>SortParams</code></td><td><code>{}</code></td><td>默认排序参数</td></tr><tr><td><code>immediate</code></td><td><code>boolean</code></td><td><code>true</code></td><td>是否立即加载数据</td></tr><tr><td><code>paginationKey</code></td><td><code>PaginationKey</code></td><td><code>{ current: 'pageNum', size: 'pageSize' }</code></td><td>自定义分页字段映射 如接口的分页字段不是pageNum和pageSize，可使用该参数快速配置分页字段</td></tr><tr><td><code>rowKey</code></td><td><code>string | ((record: T) =&gt; string | number)</code></td><td><code>'id'</code></td><td>行键字段名或函数</td></tr><tr><td><code>transformResponse</code></td><td><code>(response: HttpResponse&lt;TableData&lt;T&gt;&gt;) =&gt; TableData&lt;T&gt;</code></td><td>-</td><td>数据转换函数</td></tr><tr><td><code>onError</code></td><td><code>(error: any) =&gt; void</code></td><td>-</td><td>错误处理函数</td></tr><tr><td><code>onSuccess</code></td><td><code>(data: TableData&lt;T&gt;) =&gt; void</code></td><td>-</td><td>成功回调函数</td></tr><tr><td><code>beforeRequest</code></td><td><code>(params: P) =&gt; P | Promise&lt;P&gt;</code></td><td>-</td><td>请求前处理函数</td></tr></tbody></table>
<h4 data-id="heading-12">返回值</h4>



















































































































<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>data</code></td><td><code>ComputedRef&lt;T[]&gt;</code></td><td>表格数据列表</td></tr><tr><td><code>hasData</code></td><td><code>ComputedRef&lt;boolean&gt;</code></td><td>是否有表格数据</td></tr><tr><td><code>loading</code></td><td><code>ComputedRef&lt;boolean&gt;</code></td><td>加载状态</td></tr><tr><td><code>pagination</code></td><td><code>ComputedRef&lt;PaginationParams&gt;</code></td><td>分页信息</td></tr><tr><td><code>searchParams</code></td><td><code>Ref&lt;Record&lt;string, any&gt;&gt;</code></td><td>搜索参数</td></tr><tr><td><code>sortParams</code></td><td><code>Ref&lt;SortParams&gt;</code></td><td>排序参数</td></tr><tr><td><code>selectedRowKeys</code></td><td><code>Ref&lt;(string | number)[]&gt;</code></td><td>选中的行键</td></tr><tr><td><code>selectedRows</code></td><td><code>Ref&lt;T[]&gt;</code></td><td>选中的行数据</td></tr><tr><td><code>refresh</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>刷新数据（保持当前条件）</td></tr><tr><td><code>reload</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>重新加载数据（重置到第一页）</td></tr><tr><td><code>search</code></td><td><code>(params?: Record&lt;string, any&gt;) =&gt; Promise&lt;void&gt;</code></td><td>搜索</td></tr><tr><td><code>reset</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>重置搜索</td></tr><tr><td><code>setPagination</code></td><td><code>(pagination: Partial&lt;PaginationParams&gt;) =&gt; void</code></td><td>设置分页</td></tr><tr><td><code>setSortParams</code></td><td><code>(sortParams: SortParams) =&gt; void</code></td><td>设置排序</td></tr><tr><td><code>setSelectedRowKeys</code></td><td><code>(keys: (string | number)[]) =&gt; void</code></td><td>设置选中行</td></tr><tr><td><code>clearSelection</code></td><td><code>() =&gt; void</code></td><td>清空选中</td></tr><tr><td><code>getRowKey</code></td><td><code>(record: T) =&gt; string | number</code></td><td>获取行键</td></tr><tr><td><code>onSortChange</code></td><td><code>(payload: { prop?: string; order?: 'ascending' |'descending' | null } | any)</code></td><td>处理 Element Plus 表格排序事件, @param payload - Element Plus 的 sort-change 事件参数</td></tr><tr><td><code>onSelectionChange</code></td><td><code>(selection: T[]) =&gt; void</code></td><td>处理 Element Plus 表格选择事件, @param selection - 选中的行数据</td></tr><tr><td><code>onCurrentChange</code></td><td><code>(current: number) =&gt; void</code></td><td>处理 Element Plus 分页页码变更事件, @param current - 当前页</td></tr><tr><td><code>onSizeChange</code></td><td><code>(size: number) =&gt; void</code></td><td>处理 Element Plus 分页每页条数变更事件, @param size - 每页条数</td></tr></tbody></table>
<h3 data-id="heading-13">使用示例</h3>
<h4 data-id="heading-14">基础表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 搜索表单 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"searchForm"</span> <span class="hljs-attr">inline</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchForm.name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSearch"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleReset"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 表格 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">row-key</span>=<span class="hljs-string">"id"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"ID"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 分页 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-pagination</span>
      <span class="hljs-attr">v-model:current-page</span>=<span class="hljs-string">"pagination.current"</span>
      <span class="hljs-attr">v-model:page-size</span>=<span class="hljs-string">"pagination.pageSize"</span>
      <span class="hljs-attr">:total</span>=<span class="hljs-string">"pagination.total"</span>
      @<span class="hljs-attr">current-change</span>=<span class="hljs-string">"handleCurrentChange"</span>
      @<span class="hljs-attr">size-change</span>=<span class="hljs-string">"handleSizeChange"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> searchForm = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> })

<span class="hljs-keyword">const</span> { data, loading, pagination, search, reset } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">defaultPagination</span>: { <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> }
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">search</span>(searchForm.<span class="hljs-property">value</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"/>) =&gt; {
  searchForm.<span class="hljs-property">value</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> }
  <span class="hljs-title function_">reset</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCurrentChange</span> = (<span class="hljs-params">current: number</span>) =&gt; {
  pagination.<span class="hljs-property">value</span>.<span class="hljs-property">current</span> = current
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSizeChange</span> = (<span class="hljs-params">size: number</span>) =&gt; {
  pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span> = size
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-15">带选择的表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>
      <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span>
      @<span class="hljs-attr">selection-change</span>=<span class="hljs-string">"handleSelectionChange"</span>
      <span class="hljs-attr">row-key</span>=<span class="hljs-string">"id"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"selection"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"55"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> 
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleBatchDelete"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"!selectedRowKeys.length"</span>
    &gt;</span>
      批量删除 ({{ selectedRowKeys.length }})
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> { 
  data, 
  loading, 
  selectedRowKeys, 
  selectedRows, 
  setSelectedRowKeys 
} = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params">selection: User[]</span>) =&gt; {
  <span class="hljs-keyword">const</span> keys = selection.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span>)
  <span class="hljs-title function_">setSelectedRowKeys</span>(keys)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBatchDelete</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'选中的用户:'</span>, selectedRows.<span class="hljs-property">value</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-16">带排序的表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span>
    <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>
    <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span>
    @<span class="hljs-attr">sort-change</span>=<span class="hljs-string">"handleSortChange"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">"custom"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"创建时间"</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">"custom"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> { data, loading, setSortParams } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">{ prop, order }: any</span>) =&gt; {
  <span class="hljs-title function_">setSortParams</span>({
    <span class="hljs-attr">field</span>: prop,
    <span class="hljs-attr">order</span>: order === <span class="hljs-string">'ascending'</span> ? <span class="hljs-string">'ascend'</span> : order === <span class="hljs-string">'descending'</span> ? <span class="hljs-string">'descend'</span> : <span class="hljs-literal">undefined</span>
  })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-17">数据转换</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">transformResponse</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-comment">// 自定义数据转换逻辑</span>
    <span class="hljs-keyword">const</span> { result } = response
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: result?.<span class="hljs-property">list</span>?.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
        ...item,
        <span class="hljs-attr">statusText</span>: item.<span class="hljs-property">status</span> === <span class="hljs-string">'active'</span> ? <span class="hljs-string">'激活'</span> : <span class="hljs-string">'禁用'</span>
      })) || [],
      <span class="hljs-attr">total</span>: result?.<span class="hljs-property">total</span> || <span class="hljs-number">0</span>,
      <span class="hljs-attr">current</span>: result?.<span class="hljs-property">current</span> || <span class="hljs-number">1</span>,
      <span class="hljs-attr">pageSize</span>: result?.<span class="hljs-property">pageSize</span> || <span class="hljs-number">10</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-18">错误处理</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'数据加载失败:'</span>, error)
    <span class="hljs-comment">// 自定义错误处理逻辑</span>
  },
  <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据加载成功:'</span>, data)
    <span class="hljs-comment">// 自定义成功处理逻辑</span>
  }
})
</code></pre>
<h4 data-id="heading-19">请求前处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">beforeRequest</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
    <span class="hljs-comment">// 在请求前添加额外参数</span>
    <span class="hljs-keyword">return</span> {
      ...params,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">token</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    }
  }
})
</code></pre>
<h3 data-id="heading-20">最佳实践</h3>
<h4 data-id="heading-21">1. 类型安全</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义明确的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserListParams</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>
  name?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 使用泛型确保类型安全</span>
<span class="hljs-keyword">const</span> { data, loading } = useTable&lt;<span class="hljs-title class_">User</span>, <span class="hljs-title class_">UserListParams</span>&gt;({
  <span class="hljs-attr">request</span>: getUserList
})
</code></pre>
<h4 data-id="heading-22">2. 错误处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一错误处理</span>
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'数据加载失败，请稍后重试'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API Error:'</span>, error)
  }
})
</code></pre>
<h4 data-id="heading-23">3. 性能优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用防抖搜索</span>
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash-es'</span>

<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-title function_">search</span>(params)
}, <span class="hljs-number">300</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">debouncedSearch</span>(searchForm.<span class="hljs-property">value</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-24">代码实现</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { ref, computed, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span>, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PaginationParams</span>, <span class="hljs-title class_">SortParams</span>, <span class="hljs-title class_">TableData</span>, <span class="hljs-title class_">UseTableOptions</span>, <span class="hljs-title class_">UseTableReturn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./type'</span>;

<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./type'</span>;

<span class="hljs-comment">/**
 * 表格 Hook
 *
 * 提供表格数据管理、分页、搜索、排序、选择等功能
 *
 * <span class="hljs-doctag">@template</span> T 表格数据类型
 * <span class="hljs-doctag">@template</span> P 请求参数类型
 * <span class="hljs-doctag">@param</span> options 配置选项
 * <span class="hljs-doctag">@returns</span> 表格操作对象
 *
 * <span class="hljs-doctag">@example</span>
 * ```typescript
 * const { data, loading, pagination, search, refresh } = useTable({
 *   request: getUserList,
 *   defaultPagination: { current: 1, pageSize: 10 },
 *   defaultSearchParams: { status: 'active' }
 * })
 *
 * // 搜索
 * search({ name: 'test' })
 *
 * // 刷新
 * refresh()
 *
 * // 重置
 * reset()
 * ```
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTable&lt;T = <span class="hljs-built_in">any</span>, P = <span class="hljs-built_in">any</span>&gt;(<span class="hljs-attr">options</span>: <span class="hljs-title class_">UseTableOptions</span>&lt;T, P&gt;): <span class="hljs-title class_">UseTableReturn</span>&lt;T&gt; {
  <span class="hljs-keyword">const</span> {
    request,
    defaultPagination = { <span class="hljs-attr">pageNum</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> },
    defaultSearchParams = {},
    defaultSortParams = {},
    immediate = <span class="hljs-literal">true</span>,
    paginationKey = { <span class="hljs-attr">current</span>: <span class="hljs-string">'pageNum'</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">'pageSize'</span> },
    rowKey = <span class="hljs-string">'id'</span>,
    transformResponse,
    onError,
    onSuccess,
    beforeRequest
  } = options;

  <span class="hljs-comment">// 分页字段名配置</span>
  <span class="hljs-keyword">const</span> pageKey = paginationKey?.<span class="hljs-property">current</span> || <span class="hljs-string">'pageNum'</span>;
  <span class="hljs-keyword">const</span> sizeKey = paginationKey?.<span class="hljs-property">size</span> || <span class="hljs-string">'pageSize'</span>;

  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> tableData = ref&lt;<span class="hljs-title class_">TableData</span>&lt;T&gt;&gt;({
    <span class="hljs-attr">list</span>: [],
    <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>
  });
  <span class="hljs-keyword">const</span> searchParams = ref&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;({ ...defaultSearchParams });
  <span class="hljs-keyword">const</span> pagination = ref&lt;<span class="hljs-title class_">PaginationParams</span>&gt;({
    <span class="hljs-attr">pageNum</span>: defaultPagination.<span class="hljs-property">pageNum</span> || <span class="hljs-number">1</span>,
    <span class="hljs-attr">pageSize</span>: defaultPagination.<span class="hljs-property">pageSize</span> || <span class="hljs-number">10</span>,
    <span class="hljs-attr">total</span>: defaultPagination.<span class="hljs-property">total</span>
  });
  <span class="hljs-keyword">const</span> sortParams = ref&lt;<span class="hljs-title class_">SortParams</span>&gt;({ ...defaultSortParams });
  <span class="hljs-keyword">const</span> selectedRowKeys = ref&lt;(<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[]&gt;([]);
  <span class="hljs-keyword">const</span> selectedRows = ref&lt;T[]&gt;([]);

  <span class="hljs-comment">// table数据</span>
  <span class="hljs-keyword">const</span> data = computed&lt;T[]&gt;(<span class="hljs-function">() =&gt;</span> tableData.<span class="hljs-property">value</span>.<span class="hljs-property">list</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> T[]);
  <span class="hljs-comment">// 是否有数据</span>
  <span class="hljs-keyword">const</span> hasData = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> data.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>);

  <span class="hljs-comment">/**
   * 获取行键
   */</span>
  <span class="hljs-keyword">const</span> getRowKey = (<span class="hljs-attr">record</span>: T): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rowKey === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">rowKey</span>(record);
    }
    <span class="hljs-keyword">return</span> (record <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)[rowKey];
  };

  <span class="hljs-comment">/**
   * 构建请求参数
   */</span>
  <span class="hljs-keyword">const</span> buildRequestParams = (): <span class="hljs-function"><span class="hljs-params">P</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> params = {
      ...searchParams.<span class="hljs-property">value</span>,
      [pageKey]: pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span>,
      [sizeKey]: pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span>
    } <span class="hljs-keyword">as</span> P;

    <span class="hljs-keyword">if</span> (sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">field</span> &amp;&amp; sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">order</span>) {
      (params <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">sortField</span> = sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">field</span>;
      (params <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">sortOrder</span> = sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">order</span>;
    }

    <span class="hljs-keyword">return</span> params;
  };

  <span class="hljs-comment">/**
   * 更新table数据 如：删除一行数据后，不想触发获取列表的接口，可通过此方法手动更新数据
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateData</span> = (<span class="hljs-params">data: T[]</span>) =&gt; {
    tableData.<span class="hljs-property">value</span> = {
      ...tableData.<span class="hljs-property">value</span>,
      <span class="hljs-attr">list</span>: data
    };
  };

  <span class="hljs-comment">/**
   * 执行数据请求
   */</span>
  <span class="hljs-keyword">const</span> fetchData = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">try</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">let</span> params = <span class="hljs-title function_">buildRequestParams</span>();

      <span class="hljs-comment">// 请求前处理</span>
      <span class="hljs-keyword">if</span> (beforeRequest) {
        params = <span class="hljs-keyword">await</span> <span class="hljs-title function_">beforeRequest</span>(params);
      }

      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">request</span>(params);

      <span class="hljs-keyword">let</span> data = response;

      <span class="hljs-keyword">if</span> (transformResponse) {
        data = <span class="hljs-title function_">transformResponse</span>(response);
      }

      tableData.<span class="hljs-property">value</span> = {
        <span class="hljs-attr">list</span>: data.<span class="hljs-property">list</span> || [],
        <span class="hljs-attr">total</span>: data.<span class="hljs-property">total</span> || <span class="hljs-number">0</span>
      };

      pagination.<span class="hljs-property">value</span>.<span class="hljs-property">total</span> = tableData.<span class="hljs-property">value</span>.<span class="hljs-property">total</span>;

      onSuccess?.(tableData.<span class="hljs-property">value</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">TableData</span>&lt;T&gt;);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'useTable fetchData error:'</span>, error);
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败，请稍后重试'</span>);
      onError?.(error);
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-comment">/**
   * 刷新数据（保持当前分页和搜索条件）
   */</span>
  <span class="hljs-keyword">const</span> refresh = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 重新加载数据（重置到第一页）
   */</span>
  <span class="hljs-keyword">const</span> reload = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 搜索
   */</span>
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">async</span> (params?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (params) {
      searchParams.<span class="hljs-property">value</span> = { ...searchParams.<span class="hljs-property">value</span>, ...params };
    }
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 重置搜索
   */</span>
  <span class="hljs-keyword">const</span> reset = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    searchParams.<span class="hljs-property">value</span> = { ...defaultSearchParams };
    sortParams.<span class="hljs-property">value</span> = { ...defaultSortParams };
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = defaultPagination.<span class="hljs-property">pageNum</span>!;
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span> = defaultPagination.<span class="hljs-property">pageSize</span>!;
    selectedRowKeys.<span class="hljs-property">value</span> = [];
    selectedRows.<span class="hljs-property">value</span> = [];
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置分页
   */</span>
  <span class="hljs-keyword">const</span> setPagination = (<span class="hljs-attr">paginationParams</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">PaginationParams</span>&gt;): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(pagination.<span class="hljs-property">value</span>, paginationParams);
    <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置排序
   */</span>
  <span class="hljs-keyword">const</span> setSortParams = (<span class="hljs-attr">sortParamsData</span>: <span class="hljs-title class_">SortParams</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    sortParams.<span class="hljs-property">value</span> = { ...sortParamsData };
    <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置选中行
   */</span>
  <span class="hljs-keyword">const</span> setSelectedRowKeys = (<span class="hljs-attr">keys</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[]): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    selectedRowKeys.<span class="hljs-property">value</span> = keys;
    selectedRows.<span class="hljs-property">value</span> = (tableData.<span class="hljs-property">value</span>.<span class="hljs-property">list</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> T[]).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span>
      keys.<span class="hljs-title function_">includes</span>(<span class="hljs-title function_">getRowKey</span>(item))
    );
  };

  <span class="hljs-comment">/**
   * 清空选中
   */</span>
  <span class="hljs-keyword">const</span> clearSelection = (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    selectedRowKeys.<span class="hljs-property">value</span> = [];
    selectedRows.<span class="hljs-property">value</span> = [];
  };

  <span class="hljs-comment">/**
   * Element Plus: 表格排序变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSortChange = (
    <span class="hljs-attr">payload</span>: { prop?: <span class="hljs-built_in">string</span>; order?: <span class="hljs-string">'ascending'</span> | <span class="hljs-string">'descending'</span> | <span class="hljs-literal">null</span> } | <span class="hljs-built_in">any</span>
  ): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">prop</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = payload?.<span class="hljs-property">prop</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">order</span>: <span class="hljs-string">'ascending'</span> | <span class="hljs-string">'descending'</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> = payload?.<span class="hljs-property">order</span>;
    <span class="hljs-keyword">if</span> (prop &amp;&amp; order) {
      <span class="hljs-title function_">setSortParams</span>({ <span class="hljs-attr">field</span>: prop, <span class="hljs-attr">order</span>: order === <span class="hljs-string">'ascending'</span> ? <span class="hljs-string">'ascend'</span> : <span class="hljs-string">'descend'</span> });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setSortParams</span>({});
    }
  };

  <span class="hljs-comment">/**
   * Element Plus: 表格选择变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSelectionChange = (<span class="hljs-attr">selection</span>: T[]): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> keys = selection.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">getRowKey</span>(item));
    <span class="hljs-title function_">setSelectedRowKeys</span>(keys);
  };

  <span class="hljs-comment">/**
   * Element Plus: 分页当前页变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onCurrentChange = (<span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title function_">setPagination</span>({ <span class="hljs-attr">pageNum</span>: current });
  };

  <span class="hljs-comment">/**
   * Element Plus: 分页每页条数变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSizeChange = (<span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title function_">setPagination</span>({ <span class="hljs-attr">pageSize</span>: size, <span class="hljs-attr">pageNum</span>: <span class="hljs-number">1</span> });
  };

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (immediate) {
      <span class="hljs-title function_">fetchData</span>();
    }
  });

  <span class="hljs-keyword">return</span> {
    data,
    hasData,
    loading,
    pagination,
    searchParams,
    sortParams,
    selectedRowKeys,
    <span class="hljs-attr">selectedRows</span>: selectedRows <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Ref</span>&lt;T[]&gt;,
    refresh,
    reload,
    search,
    reset,
    updateData,
    setPagination,
    setSortParams,
    setSelectedRowKeys,
    clearSelection,
    getRowKey,
    onSortChange,
    onSelectionChange,
    onCurrentChange,
    onSizeChange
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useTable;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Solana 链条：为什么这个“最快的区块链”]]></title>    <link>https://juejin.cn/post/7576086446459174947</link>    <guid>https://juejin.cn/post/7576086446459174947</guid>    <pubDate>2025-11-24T08:27:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086446459174947" data-draft-id="7575910298282917923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Solana 链条：为什么这个“最快的区块链”"/> <meta itemprop="keywords" content="区块链"/> <meta itemprop="datePublished" content="2025-11-24T08:27:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Solana 链条：为什么这个“最快的区块链”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:27:28.000Z" title="Mon Nov 24 2025 08:27:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>过去几年，如果你稍微关注过加密世界，你大概率听过一句话：“Solana 挂了吗？”</p>
<p>项目方宕机、主网停摆、TPS 掉成个位数……这些曾经的黑历史，把很多开发者吓得远离这条链。</p>
<p>但奇妙的是，从 2023 年到现在，Solana 不但没凉，反而变成了 <strong>开发者最喜欢的高性能链</strong>，从 DePIN、AI-Agent、支付、到 meme、再到链上游戏，只要是“需要速度”的方向，Solana 都像一块吸铁石一样把开发者吸了过去。</p>
<p>这种反差就像你以为对方是个“问题学生”，结果这学期突然考第一。</p>
<p>为什么？ 因为 Solana 本质不是一条普通公链，它是<strong>一条为「高性能、实时交互、并行执行」而设计的链式操作系统（ChainOS）</strong> 。</p>
<p>今天这篇文章，我想让你真正 <em>看懂</em> Solana：不是喊口号，不是背概念，而是<strong>从原理到动手、从请求到响应</strong>，让你读完后会在心里点头：“哦……原来 Solana 是这样跑的，怪不得它快。”</p>
<hr/>
<ol>
<li>
<h2 data-id="heading-0">Solana 的真实问题：为什么传统区块链都慢？</h2>
</li>
</ol>
<p>如果把区块链比作餐厅，传统链的问题大概是这样：</p>
<ul>
<li>所有人排队点餐，一次只能处理一个订单（串行）</li>
<li>厨房只有一个灶台（单线程）</li>
<li>同一个交易需要好几次确认（最终性弱）</li>
<li>每次都要大家对菜品投票（共识拖慢速度）</li>
</ul>
<p>于是单次 TPS 就被锁死在几十到几百。</p>
<p><strong>Solana 的想法是反着来的</strong>：</p>
<blockquote>
<p>“为什么区块链不能像 GPU 一样同时处理几万个任务？ 为什么状态不能分区？ 为什么共识不能独立运行？ 为什么验证不能并行执行？”</p>
</blockquote>
<p>这套问题直接导致了它后来所有的技术设计。</p>
<hr/>
<ol start="2">
<li>
<h2 data-id="heading-1">Solana 是怎么做到高性能的？——三个核心原理</h2>
</li>
</ol>
<h3 data-id="heading-2">2.1 Proof of History：让时间变得“有序”</h3>
<p>区块链最大的问题是：<strong>不知道谁先谁后</strong>。</p>
<p>Solana 直接把这个问题硬解了：它使用一种叫 <strong>Proof of History（PoH）</strong> 的时间序列证明机制，用可验证延迟函数（VDF）不断生成一个全网共享的“时钟”。</p>
<p>所有交易都按这个时钟排序，这意味着：</p>
<ul>
<li>不需要每次都全网投票</li>
<li>不需要广播确认顺序</li>
<li>不需要等待多轮共识</li>
</ul>
<p>就像所有节点共享一个全局计时器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1127190fb79a463c9fb29417007741dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764577648&amp;x-signature=2%2BdmID5vO3UkXlmObSURc026Ga4%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">2.2 并行执行：链上版“线程池”</h3>
<p>Solana 的执行模型叫 <strong>Sealevel</strong>。不是“一次执行一个交易”，而是：</p>
<blockquote>
<p><strong>同时执行所有互不冲突的状态修改（并行事务）。</strong></p>
</blockquote>
<p>只要两个交易访问的账户不同，Solana 就会把它们丢到不同的执行线程里。</p>
<p>这好比：</p>
<ul>
<li>你炒菜，我做汤 —— 互不影响</li>
<li>所以厨房同时能处理上百个订单</li>
</ul>
<p>这是所有 EVM 链都不具备的能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c915a34f4e34e9f9dc71e37251d256d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764577648&amp;x-signature=9AltCUt2qPlKDpmaEyOISDBoPo0%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-4">2.3 单区单状态：不分片、不跨链，全部在一块状态机里</h3>
<p>Solana 的速度并不是靠“分片”，而是靠：</p>
<ul>
<li>单一全局状态</li>
<li>超高带宽节点</li>
<li>GPU + 多核验证</li>
<li>Zero-copy memory</li>
<li>简化的网络拓扑</li>
<li>高效压缩的账户模型</li>
</ul>
<p>这让 Solana 的链像一台大服务器，而不是一群“互相喊话的小节点”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444291ad514549bc9be07048947198c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764577648&amp;x-signature=FEjUBTYHljFnc1BXpNiGP%2BF%2B7A4%3D" alt="" loading="lazy"/></p>
<hr/>
<ol start="3">
<li>
<h2 data-id="heading-5">动手：五分钟跑一个 Solana 最小实验（RPC + Tx + 状态读写）</h2>
</li>
</ol>
<p>下面给一个<strong>最小可复现的 Solana 开发实验</strong>，只需要 Node.js 和官方 RPC 即可。</p>
<h3 data-id="heading-6">环境准备</h3>
<pre><code class="hljs language-bash" lang="bash">npm install @solana/web3.js
</code></pre>
<h3 data-id="heading-7">3.1 生成钱包</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Keypair</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@solana/web3.js"</span>;

<span class="hljs-keyword">const</span> wallet = <span class="hljs-title class_">Keypair</span>.<span class="hljs-title function_">generate</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Public Key:"</span>, wallet.<span class="hljs-property">publicKey</span>.<span class="hljs-title function_">toBase58</span>());
</code></pre>
<p>输出类似：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Public</span> <span class="hljs-keyword">Key</span>: <span class="hljs-number">6</span>v4zKszqYrBBJFtDShu...
</code></pre>
<h3 data-id="heading-8">3.2 请求测试网空投（类似“链上充值”）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Connection</span>, clusterApiUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">"@solana/web3.js"</span>;

<span class="hljs-keyword">const</span> connection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>(<span class="hljs-title function_">clusterApiUrl</span>(<span class="hljs-string">"devnet"</span>));

<span class="hljs-keyword">const</span> sig = <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">requestAirdrop</span>(wallet.<span class="hljs-property">publicKey</span>, <span class="hljs-number">1e9</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Airdrop Signature:"</span>, sig);
</code></pre>
<h3 data-id="heading-9">3.3 发起一笔转账（核心步骤）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  <span class="hljs-variable constant_">LAMPORTS_PER_SOL</span>,
  <span class="hljs-title class_">SystemProgram</span>,
  <span class="hljs-title class_">Transaction</span>,
  sendAndConfirmTransaction,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@solana/web3.js"</span>;

<span class="hljs-keyword">const</span> transaction = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transaction</span>().<span class="hljs-title function_">add</span>(
  <span class="hljs-title class_">SystemProgram</span>.<span class="hljs-title function_">transfer</span>({
    <span class="hljs-attr">fromPubkey</span>: wallet.<span class="hljs-property">publicKey</span>,
    <span class="hljs-attr">toPubkey</span>: receiverPublicKey,
    <span class="hljs-attr">lamports</span>: <span class="hljs-number">0.01</span> * <span class="hljs-variable constant_">LAMPORTS_PER_SOL</span>,
  })
);

<span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendAndConfirmTransaction</span>(connection, transaction, [wallet]);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Tx Signature:"</span>, signature);
</code></pre>
<p>你可以立即去 Solana 区块浏览器查看交易状态：</p>
<pre><code class="hljs language-ini" lang="ini">https://explorer.solana.com/tx/&lt;signature&gt;?<span class="hljs-attr">cluster</span>=devnet
</code></pre>
<h3 data-id="heading-10">3.4 扩展练习：部署最小 Solana 程序（上链合约）</h3>
<ul>
<li>使用 Rust + Anchor</li>
<li>创建账户模型</li>
<li>初始化合约</li>
<li>写入状态</li>
<li>读取状态</li>
</ul>
<hr/>
<ol start="4">
<li>
<h2 data-id="heading-11">Solana 的现实应用：为什么所有“需要速度”的方向都在往这边跑？</h2>
</li>
</ol>
<p>过去一年里，你会发现几乎所有风口都和 Solana 有关：</p>
<ul>
<li><strong>AI Agent 结算层</strong>（实时结算 → 需要低延迟）</li>
<li><strong>链上游戏</strong>（无需等待确认）</li>
<li><strong>支付</strong>（近似 Web2 体验）</li>
<li><strong>DePIN 分布式网络结算</strong></li>
<li><strong>链上流数据（像 Kafka 一样）</strong></li>
<li><strong>meme 生态疯狂扩张（极致低费率 + 即时交易）</strong></li>
</ul>
<p>甚至连 PayPal 前 CTO 都在说：</p>
<blockquote>
<p>“Solana 是最接近 Web2 用户体验的链。”</p>
</blockquote>
<p>Solana 正在从“加密项目”变成“实时交互互联网的底层”。</p>
<hr/>
<ol start="5">
<li>
<h2 data-id="heading-12">meme 时间</h2>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38c5f04788a14a528e56c73293bef15a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764577648&amp;x-signature=qEAg%2B8TuTaGZMqmWrmcVwThLonk%3D" alt="" loading="lazy"/></p>
<hr/>
<ol start="6">
<li>
<h2 data-id="heading-13">升维收束：Solana 不是区块链，它更像是一种“链上操作系统”</h2>
</li>
</ol>
<p>如果把以太坊看作“世界计算机”，那么 Solana 更像是：</p>
<blockquote>
<p>一台全网共享的超算，状态一致、并行执行、实时响应。</p>
</blockquote>
<p>它解决的问题不是“如何去中心化”，而是：</p>
<ul>
<li>如何让链能跑实时应用</li>
<li>如何让数万人同时使用不会堵</li>
<li>如何让快速交互回到 Web2 的速度</li>
<li>如何让链成为 AI、游戏、支付的底层基建</li>
</ul>
<p>这是它能在 2023–2025 再次爆发的最根本原因。</p>
<p>如果你也在做 AI、游戏、支付、实时互动产品，Solana 可能是 <strong>最值得提前布局的基础设施</strong>。</p>
<hr/>
<h2 data-id="heading-14">最后一句互动邀请</h2>
<p>如果你正在探索 Solana、AI Agent、链上支付或实时 DApp，欢迎留言，我们可以一起拆得更深。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MapStruct转换实体]]></title>    <link>https://juejin.cn/post/7576052677050744858</link>    <guid>https://juejin.cn/post/7576052677050744858</guid>    <pubDate>2025-11-24T08:14:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677050744858" data-draft-id="7575829296452632586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MapStruct转换实体"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-24T08:14:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天道佩恩"/> <meta itemprop="url" content="https://juejin.cn/user/536217406931069"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MapStruct转换实体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217406931069/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天道佩恩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:14:03.000Z" title="Mon Nov 24 2025 08:14:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天在代码中看到有人用UnitChangeConvert.INSTANCE.dtoToBO(processVo)，感觉非常帅。这只是一个接口，并没有给出实现类，就给实体转换了，省去了我们自己写转换类的时间，今天摸鱼中了解了下：<strong>MapStruct 是一个专注于「Java Bean 之间属性映射」的代码生成器</strong>，与 Spring 原生转换、MyBatis-Plus 类型转换器是完全不同的工具，解决的是「对象与对象之间的属性拷贝」问题（如 DTO ↔ POJO、VO ↔ Entity），而非参数 / 数据库字段的类型转换。</p>
<p>下面从 <strong>核心定位、与其他转换工具的区别、使用场景、快速上手、高级特性</strong> 五个维度，帮你理清 MapStruct 的核心价值和用法：</p>
<h3 data-id="heading-0">一、核心定位：Java Bean 映射的 “代码生成神器”</h3>
<p>日常开发中，我们经常需要在不同层级的 Java Bean 之间拷贝属性（如：</p>
<ul>
<li>Controller 接收前端 <code>UserDTO</code> → 服务层转换为 <code>UserEntity</code> 存入数据库；</li>
<li>数据库查询出 <code>UserEntity</code> → 转换为 <code>UserVO</code> 返回给前端）。</li>
</ul>
<p>传统做法是手动写 <code>setter</code> 拷贝（繁琐易出错），或用 <code>BeanUtils.copyProperties</code>（反射效率低、字段名不一致需手动处理、类型转换不灵活）。</p>
<p>MapStruct 的核心解决思路：</p>
<ul>
<li>基于「注解 + 接口」定义映射规则；</li>
<li>编译期自动生成 <strong>类型安全、无反射、高效</strong> 的映射实现类（纯 Java 代码，不是运行时动态处理）；</li>
<li>支持字段名映射、类型自动转换、自定义转换逻辑、依赖注入等。</li>
</ul>
<h3 data-id="heading-1">二、与其他 “转换工具” 的核心区别</h3>
<p>你之前接触的工具和 MapStruct 适用场景完全不同，用表格清晰对比：</p>



































<table><thead><tr><th>工具 / 框架</th><th>核心用途</th><th>适用场景</th><th>底层实现</th></tr></thead><tbody><tr><td><strong>MapStruct</strong></td><td>Java Bean ↔ Java Bean（属性拷贝）</td><td>DTO↔Entity、VO↔POJO（业务层）</td><td>编译期生成 Java 代码（无反射）</td></tr><tr><td>Spring 原生 <code>Converter</code></td><td>基础类型 / 简单对象转换（如 String→Integer）</td><td>Web 参数转换、配置注入（Web / 配置层）</td><td>接口实现 + Spring 容器管理</td></tr><tr><td>MyBatis-Plus 转换器</td><td>数据库字段 ↔ Java 实体（ORM 层）</td><td>数据库存储类型→Java 类型</td><td>MyBatis 类型处理器接口</td></tr><tr><td><code>BeanUtils</code>（Spring/Commons）</td><td>快速属性拷贝</td><td>简单场景（字段名完全一致）</td><td>运行时反射（效率低）</td></tr></tbody></table>
<h4 data-id="heading-2">一句话区分：</h4>
<ul>
<li>要拷贝两个 Java Bean 的属性 → 用 MapStruct；</li>
<li>要把 String 转 Integer / 枚举（非 Bean 拷贝） → 用 Spring <code>Converter</code>；</li>
<li>要把数据库字段转 Java 实体 → 用 MyBatis-Plus 转换器。</li>
</ul>
<h3 data-id="heading-3">三、MapStruct 快速上手（Spring Boot 环境）</h3>
<h4 data-id="heading-4">步骤 1：引入依赖（Maven）</h4>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- MapStruct 核心依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mapstruct<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapstruct<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.5.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 推荐稳定版 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- 编译期代码生成依赖（必须，否则不会生成实现类） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mapstruct<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapstruct-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.5.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- 若用 Lombok，需确保 MapStruct 能识别 Lombok 生成的 getter/setter --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- Lombok 与 MapStruct 兼容依赖（Java 11+ 可能需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok-mapstruct-binding<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">步骤 2：定义待映射的 Java Bean</h4>
<p>假设存在「用户实体」和「用户 DTO」（字段名部分不一致，类型不同）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 数据库实体（POJO）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEntity</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> id;          <span class="hljs-comment">// 主键</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> userName;  <span class="hljs-comment">// 用户名（字段名：userName）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> age;      <span class="hljs-comment">// 年龄（int 类型）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalDate</span> birth;  <span class="hljs-comment">// 生日（LocalDate 类型）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> phone;     <span class="hljs-comment">// 手机号</span>
}
​
<span class="hljs-comment">// 前端传输对象（DTO）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> userId;      <span class="hljs-comment">// 主键（字段名：userId，与实体 id 对应）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;      <span class="hljs-comment">// 用户名（字段名：name，与实体 userName 对应）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> age;       <span class="hljs-comment">// 年龄（String 类型，与实体 int 对应）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> birth;     <span class="hljs-comment">// 生日（String 类型，格式：yyyy-MM-dd）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> phoneNum;  <span class="hljs-comment">// 手机号（字段名：phoneNum，与实体 phone 对应）</span>
}
</code></pre>
<h4 data-id="heading-6">步骤 3：定义 MapStruct 映射接口</h4>
<p>用 <code>@Mapper</code> 注解（MapStruct 的注解，非 MyBatis 的 <code>@Mapper</code>！）定义映射规则，<code>componentModel = "spring"</code> 表示让 Spring 管理映射器实例（支持依赖注入）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.mapstruct</span><span class="hljs-selector-class">.Mapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.mapstruct</span><span class="hljs-selector-class">.Mapping</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.mapstruct</span><span class="hljs-selector-class">.Mappings</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.mapstruct</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.Mappers</span>;
​
<span class="hljs-comment">// 关键注解：componentModel="spring" → Spring 管理该映射器</span>
@<span class="hljs-selector-tag">Mapper</span>(componentModel = <span class="hljs-string">"spring"</span>, imports = {<span class="hljs-selector-tag">LocalDate</span><span class="hljs-selector-class">.class</span>, <span class="hljs-selector-tag">DateTimeFormatter</span><span class="hljs-selector-class">.class</span>})
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserConvert</span> {
​
    <span class="hljs-comment">// 方式 1：Spring 依赖注入用（无需手动创建实例）</span>
    <span class="hljs-comment">// 方式 2：非 Spring 环境用（手动获取实例）</span>
    <span class="hljs-comment">// UserConvert INSTANCE = Mappers.getMapper(UserConvert.class);</span>
​
    <span class="hljs-comment">/**
     * DTO → 实体（核心映射方法）
     * @Mapping：指定字段映射规则（字段名不一致、类型转换、格式转换）
     */</span>
    <span class="hljs-variable">@Mappings</span>({
        <span class="hljs-comment">// DTO 的 userId → 实体的 id（字段名不一致）</span>
        <span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"userId"</span>, target = <span class="hljs-string">"id"</span>),
        <span class="hljs-comment">// DTO 的 name → 实体的 userName（字段名不一致）</span>
        <span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"name"</span>, target = <span class="hljs-string">"userName"</span>),
        <span class="hljs-comment">// DTO 的 age（String）→ 实体的 age（int）：自动类型转换（MapStruct 内置支持）</span>
        <span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"age"</span>, target = <span class="hljs-string">"age"</span>),
        <span class="hljs-comment">// DTO 的 birth（String）→ 实体的 birth（LocalDate）：自定义格式转换</span>
        <span class="hljs-variable">@Mapping</span>(
            source = <span class="hljs-string">"birth"</span>,
            target = <span class="hljs-string">"birth"</span>,
            dateFormat = <span class="hljs-string">"yyyy-MM-dd"</span> <span class="hljs-comment">// 指定日期格式</span>
        ),
        <span class="hljs-comment">// DTO 的 phoneNum → 实体的 phone（字段名不一致）</span>
        <span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"phoneNum"</span>, target = <span class="hljs-string">"phone"</span>)
    })
    UserEntity <span class="hljs-built_in">dtoToEntity</span>(UserDTO userDTO);
​
    <span class="hljs-comment">/**
     * 实体 → DTO（反向映射，字段名对应规则与正向一致）
     * 可复用正向映射规则，用 @InheritInverseConfiguration 简化
     */</span>
    <span class="hljs-variable">@InheritInverseConfiguration</span>(name = <span class="hljs-string">"dtoToEntity"</span>)
    <span class="hljs-variable">@Mapping</span>(
        source = <span class="hljs-string">"birth"</span>,
        target = <span class="hljs-string">"birth"</span>,
        dateFormat = <span class="hljs-string">"yyyy-MM-dd"</span> <span class="hljs-comment">// 反向转换也需指定日期格式</span>
    )
    UserDTO <span class="hljs-built_in">entityToDto</span>(UserEntity userEntity);
​
    <span class="hljs-comment">/**
     * 自定义转换逻辑（如特殊格式处理、复杂计算）
     * 若 MapStruct 内置转换不满足，可定义默认方法（default）
     */</span>
    <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">stringToAge</span>(String ageStr) {
        <span class="hljs-selector-tag">if</span> (ageStr == null || ageStr.<span class="hljs-built_in">trim</span>().<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 空值默认 0</span>
        }
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Integer</span><span class="hljs-selector-class">.parseInt</span>(ageStr.<span class="hljs-built_in">trim</span>());
        } <span class="hljs-selector-tag">catch</span> (NumberFormatException e) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 格式错误默认 0</span>
        }
    }
​
    <span class="hljs-comment">// 反向转换：Integer → String</span>
    <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">ageToString</span>(Integer age) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">age</span> == <span class="hljs-selector-tag">null</span> ? "" : <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.valueOf</span>(age);
    }
}
</code></pre>
<h4 data-id="heading-7">步骤 4：编译项目，查看生成的实现类</h4>
<p>MapStruct 会在 <strong>编译期</strong> 生成 <code>UserConvertImpl</code> 实现类（无需手动写），路径在 <code>target/generated-sources/annotations/</code> 下，核心逻辑如下（自动生成的纯 Java 代码）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自动生成的实现类（Spring 管理）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConvertImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserConvert</span> {
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserEntity</span> <span class="hljs-title function_">dtoToEntity</span>(<span class="hljs-params">UserDTO userDTO</span>) {
        <span class="hljs-keyword">if</span> (userDTO == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-title class_">UserEntity</span> userEntity = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserEntity</span>();
        userEntity.<span class="hljs-title function_">setId</span>(userDTO.<span class="hljs-title function_">getUserId</span>());
        userEntity.<span class="hljs-title function_">setUserName</span>(userDTO.<span class="hljs-title function_">getName</span>());
        <span class="hljs-comment">// 调用自定义的 stringToAge 方法转换类型</span>
        userEntity.<span class="hljs-title function_">setAge</span>(<span class="hljs-title function_">stringToAge</span>(userDTO.<span class="hljs-title function_">getAge</span>()));
        <span class="hljs-comment">// 自动按指定格式转换 String → LocalDate</span>
        <span class="hljs-keyword">if</span> (userDTO.<span class="hljs-title function_">getBirth</span>() != <span class="hljs-literal">null</span>) {
            userEntity.<span class="hljs-title function_">setBirth</span>(<span class="hljs-title class_">LocalDate</span>.<span class="hljs-title function_">parse</span>(userDTO.<span class="hljs-title function_">getBirth</span>(), <span class="hljs-title class_">DateTimeFormatter</span>.<span class="hljs-title function_">ofPattern</span>(<span class="hljs-string">"yyyy-MM-dd"</span>)));
        }
        userEntity.<span class="hljs-title function_">setPhone</span>(userDTO.<span class="hljs-title function_">getPhoneNum</span>());
        <span class="hljs-keyword">return</span> userEntity;
    }
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserDTO</span> <span class="hljs-title function_">entityToDto</span>(<span class="hljs-params">UserEntity userEntity</span>) {
        <span class="hljs-comment">// 类似正向转换逻辑，自动处理字段映射和类型转换</span>
    }
​
    <span class="hljs-comment">// 自动生成自定义方法的调用逻辑...</span>
}
</code></pre>
<h4 data-id="heading-8">步骤 5：在 Spring 中使用映射器</h4>
<p>通过 <code>@Autowired</code> 注入 <code>UserConvert</code>，直接调用映射方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
​
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserConvert userConvert; <span class="hljs-comment">// 注入 MapStruct 映射器</span>
​
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(UserDTO userDTO)</span> {
        <span class="hljs-comment">// 1. DTO → 实体（自动完成字段映射和类型转换）</span>
        <span class="hljs-type">UserEntity</span> <span class="hljs-variable">userEntity</span> <span class="hljs-operator">=</span> userConvert.dtoToEntity(userDTO);
        
        <span class="hljs-comment">// 2. 存入数据库（假设用 MyBatis 操作）</span>
        <span class="hljs-comment">// userMapper.insert(userEntity);</span>
        
        System.out.println(<span class="hljs-string">"转换后的实体："</span> + userEntity);
    }
​
    <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 1. 从数据库查询实体</span>
        <span class="hljs-type">UserEntity</span> <span class="hljs-variable">userEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserEntity</span>(id, <span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, LocalDate.of(<span class="hljs-number">2000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-string">"13800138000"</span>);
        
        <span class="hljs-comment">// 2. 实体 → DTO（反向转换）</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> userConvert.entityToDto(userEntity);
        
        <span class="hljs-keyword">return</span> userDTO;
    }
}
</code></pre>
<h4 data-id="heading-9">测试效果：</h4>
<pre><code class="hljs language-ini" lang="ini">// 测试 DTO → 实体
UserDTO <span class="hljs-attr">dto</span> = new UserDTO(<span class="hljs-number">1</span>L, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"25"</span>, <span class="hljs-string">"2000-01-01"</span>, <span class="hljs-string">"13800138000"</span>)<span class="hljs-comment">;</span>
UserEntity <span class="hljs-attr">entity</span> = userConvert.dtoToEntity(dto)<span class="hljs-comment">;</span>
// 输出：UserEntity(<span class="hljs-attr">id</span>=<span class="hljs-number">1</span>, userName=张三, age=<span class="hljs-number">25</span>, birth=<span class="hljs-number">2000</span>-<span class="hljs-number">01</span>-<span class="hljs-number">01</span>, phone=<span class="hljs-number">13800138000</span>)
​
// 测试实体 → DTO
UserEntity <span class="hljs-attr">entity</span> = new UserEntity(<span class="hljs-number">1</span>L, <span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, LocalDate.of(<span class="hljs-number">2000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-string">"13800138000"</span>)<span class="hljs-comment">;</span>
UserDTO <span class="hljs-attr">dto</span> = userConvert.entityToDto(entity)<span class="hljs-comment">;</span>
// 输出：UserDTO(<span class="hljs-attr">userId</span>=<span class="hljs-number">1</span>, name=张三, age=<span class="hljs-number">25</span>, birth=<span class="hljs-number">2000</span>-<span class="hljs-number">01</span>-<span class="hljs-number">01</span>, phoneNum=<span class="hljs-number">13800138000</span>)
</code></pre>
<h3 data-id="heading-10">四、MapStruct 核心注解与高级特性</h3>
<h4 data-id="heading-11">1. 核心注解（常用）</h4>








































<table><thead><tr><th>注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>@Mapper</code></td><td>标识映射接口，指定组件模型（如 Spring）</td><td><code>@Mapper(componentModel = "spring")</code></td></tr><tr><td><code>@Mapping</code></td><td>单个字段映射规则</td><td><code>@Mapping(source = "name", target = "userName")</code></td></tr><tr><td><code>@Mappings</code></td><td>多个 <code>@Mapping</code> 的集合</td><td>包裹多个 <code>@Mapping</code> 注解</td></tr><tr><td><code>@InheritInverseConfiguration</code></td><td>继承反向映射规则（避免重复写注解）</td><td><code>@InheritInverseConfiguration(name = "dtoToEntity")</code></td></tr><tr><td><code>@MappingTarget</code></td><td>映射到已存在的对象（更新属性）</td><td><code>void updateEntity(UserDTO dto, @MappingTarget UserEntity entity)</code></td></tr><tr><td><code>@Named</code></td><td>命名自定义转换方法（用于复杂映射）</td><td><code>@Named("stringToAge") default Integer stringToAge(String s) {}</code></td></tr></tbody></table>
<h4 data-id="heading-12">2. 高级特性</h4>
<h5 data-id="heading-13">（1）集合映射（自动支持 List/Set/Array）</h5>
<p>MapStruct 会自动为集合生成映射方法，无需手动定义：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Mapper</span>(componentModel = <span class="hljs-string">"spring"</span>)
public interface UserConvert {
    <span class="hljs-comment">// 单个对象映射（已定义）</span>
    UserEntity <span class="hljs-built_in">dtoToEntity</span>(UserDTO dto);
    UserDTO <span class="hljs-built_in">entityToDto</span>(UserEntity entity);
​
    <span class="hljs-comment">// 集合映射（自动生成，无需手动写实现）</span>
    List&lt;UserEntity&gt; <span class="hljs-built_in">dtoListToEntityList</span>(List&lt;UserDTO&gt; dtoList);
    Set&lt;UserDTO&gt; <span class="hljs-built_in">entitySetToDtoSet</span>(Set&lt;UserEntity&gt; entitySet);
}
</code></pre>
<h5 data-id="heading-14">（2）自定义转换逻辑（复杂场景）</h5>
<p>若内置转换不满足（如枚举转换、对象嵌套），可定义 <code>default</code> 方法或单独的转换类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：枚举转换</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> GenderEnum {
    MALE(<span class="hljs-number">1</span>, <span class="hljs-string">"男"</span>), FEMALE(<span class="hljs-number">2</span>, <span class="hljs-string">"女"</span>);
    <span class="hljs-comment">// getter/setter/静态方法...</span>
}
​
<span class="hljs-comment">// DTO 中 gender 是 String 类型（"男"/"女"），实体中是 GenderEnum</span>
<span class="hljs-meta">@Mapping(
    source = <span class="hljs-string">"gender"</span>,
    target = <span class="hljs-string">"gender"</span>,
    qualifiedByName = <span class="hljs-string">"genderStrToEnum"</span> // 指定自定义转换方法
)</span>
UserEntity dtoToEntity(UserDTO dto);
​
<span class="hljs-comment">// 自定义枚举转换方法（用 @Named 标识）</span>
<span class="hljs-meta">@Named(<span class="hljs-string">"genderStrToEnum"</span>)</span>
default GenderEnum genderStrToEnum(String genderStr) {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"男"</span>.equals(genderStr)) <span class="hljs-keyword">return</span> GenderEnum.MALE;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"女"</span>.equals(genderStr)) <span class="hljs-keyword">return</span> GenderEnum.FEMALE;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h5 data-id="heading-15">（3）依赖注入其他服务</h5>
<p>因 <code>componentModel = "spring"</code>，映射器可注入 Spring Bean（如业务服务、工具类）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Mapper(componentModel = <span class="hljs-string">"spring"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserConvert</span> {
​
    <span class="hljs-meta">@Autowired</span>
    UserService userService; <span class="hljs-comment">// 注入 Spring 服务</span>
​
    <span class="hljs-meta">@Mapping(
        source = <span class="hljs-string">"userId"</span>,
        target = <span class="hljs-string">"deptId"</span>,
        qualifiedByName = <span class="hljs-string">"getDeptIdByUserId"</span> // 调用注入的服务
    )</span>
    UserEntity dtoToEntity(UserDTO dto);
​
    <span class="hljs-meta">@Named(<span class="hljs-string">"getDeptIdByUserId"</span>)</span>
    default <span class="hljs-built_in">Long</span> getDeptIdByUserId(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 调用业务服务获取部门ID（复杂逻辑）</span>
        <span class="hljs-keyword">return</span> userService.getDeptIdByUserId(userId);
    }
}
</code></pre>
<h5 data-id="heading-16">（4）日期 / 数字格式转换</h5>
<p>通过 <code>dateFormat</code>/<code>numberFormat</code> 指定格式：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 日期格式</span>
<span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"birth"</span>, target = <span class="hljs-string">"birth"</span>, dateFormat = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)
<span class="hljs-comment">// 数字格式（如保留2位小数）</span>
<span class="hljs-variable">@Mapping</span>(source = <span class="hljs-string">"amount"</span>, target = <span class="hljs-string">"amount"</span>, numberFormat = <span class="hljs-string">"#.00"</span>)
UserEntity <span class="hljs-built_in">dtoToEntity</span>(UserDTO dto);
</code></pre>
<h3 data-id="heading-17">五、注意事项</h3>
<ol>
<li>
<p><strong>编译期生成代码</strong>：</p>
<ul>
<li>必须引入 <code>mapstruct-processor</code> 依赖，否则不会生成实现类，运行时会报「找不到实现类」错误；</li>
<li>若用 IDEA，需开启「Annotation Processing」（Settings → Build → Compiler → Annotation Processors），否则 IDEA 可能不识别生成的类。</li>
</ul>
</li>
<li>
<p><strong>与 Lombok 兼容</strong>：</p>
<ul>
<li>确保 Lombok 版本 ≥ 1.18.16，MapStruct 版本 ≥ 1.4.2；</li>
<li>若字段无 getter/setter（如用 <code>@Data</code> 生成），MapStruct 无法识别字段，需确保 Lombok 正确生成访问器。</li>
</ul>
</li>
<li>
<p><strong>字段名匹配规则</strong>：</p>
<ul>
<li>默认按「字段名相同」映射（忽略大小写？不，严格匹配）；</li>
<li>若字段名是 <code>userName</code>（实体）和 <code>user_name</code>（DTO），可开启 <code>unmappedTargetPolicy = ReportingPolicy.IGNORE</code> 忽略未映射字段，或手动指定 <code>@Mapping</code>。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">总结</h3>
<p>MapStruct 是 <strong>Java Bean 映射的最优解</strong>，核心优势：</p>
<ol>
<li>类型安全：编译期检查字段名、类型是否匹配，避免运行时错误；</li>
<li>效率高：无反射，编译期生成原生 Java 代码，性能远超 <code>BeanUtils</code>；</li>
<li>灵活：支持字段映射、类型转换、自定义逻辑、依赖注入；</li>
<li>简化代码：无需手动写 <code>setter</code> 拷贝，注解驱动开发。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Maven多仓库/依赖配置]]></title>    <link>https://juejin.cn/post/7575887863797579786</link>    <guid>https://juejin.cn/post/7575887863797579786</guid>    <pubDate>2025-11-24T08:15:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863797579786" data-draft-id="7575533124878712859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Maven多仓库/依赖配置"/> <meta itemprop="keywords" content="maven,Java"/> <meta itemprop="datePublished" content="2025-11-24T08:15:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙华"/> <meta itemprop="url" content="https://juejin.cn/user/1515546071270151"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Maven多仓库/依赖配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1515546071270151/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:15:40.000Z" title="Mon Nov 24 2025 08:15:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在现代Java企业级开发中，高效的依赖管理是项目成功的关键因素之一。Maven作为Java生态中最流行的构建工具，其多仓库和多Profile功能为企业级项目提供了强大的依赖管理能力。本文将详细介绍如何在IDEA中配置Maven多仓库和多Profile，解决实际开发中的依赖管理痛点。</p>
</blockquote>
<h2 data-id="heading-0">一、前言：为什么需要 Maven 多仓库 / 多 Profile 配置？</h2>
<p><code>单仓库痛点</code><strong>：中央仓库访问慢、私有库依赖无法拉取、不同环境（开发 / 测试 / 生产）依赖隔离需求</strong></p>
<ol>
<li>在实际开发中，仅使用Maven中央仓库会遇到多个问题：</li>
</ol>
<ul>
<li><strong>中央仓库访问慢</strong>：由于网络原因，从国内访问Maven中央仓库速度较慢</li>
<li><strong>私有库依赖无法拉取</strong>：企业内部的私有组件无法从公共仓库获取</li>
<li><strong>环境依赖隔离需求</strong>：开发、测试、生产环境可能需要不同版本的依赖</li>
</ul>
<ol start="2">
<li>核心应用场景：企业私有仓库对接、多环境依赖切换、镜像加速中央仓库、依赖版本统一管理</li>
</ol>
<ul>
<li><strong>企业私有仓库对接</strong>：连接公司内部的Nexus或Artifactory仓库</li>
<li><strong>多环境依赖切换</strong>：不同环境使用不同的依赖版本</li>
<li><strong>镜像加速中央仓库</strong>：使用国内镜像提升依赖下载速度</li>
<li><strong>依赖版本统一管理</strong>：确保团队所有成员使用相同的依赖版本</li>
</ul>
<ol start="3">
<li>本文核心目标：掌握 IDEA 中 Maven 镜像配置、多仓库协同、多 Profile 切换的完整流程</li>
</ol>
<h2 data-id="heading-1">二、Maven 核心概念铺垫（避免新手困惑）</h2>
<h5 data-id="heading-2">1.  仓库的分类：中央仓库、私有仓库（Nexus/Artifactory）、本地仓库、镜像仓库</h5>
<ul>
<li><strong>中央仓库</strong>：Maven官方维护的公共仓库</li>
<li><strong>私有仓库</strong>：企业自建的仓库（Nexus/Artifactory）</li>
<li><strong>本地仓库</strong>：开发者本地的缓存仓库</li>
<li><strong>镜像仓库</strong>：对某个仓库的镜像替代</li>
</ul>
<h5 data-id="heading-3">2.  Profile 的作用：环境隔离、依赖分组、配置动态切换</h5>
<p>Profile允许我们定义多套配置，实现：</p>
<ul>
<li>环境隔离（开发、测试、生产）</li>
<li>依赖分组管理</li>
<li>配置动态切换</li>
</ul>
<h5 data-id="heading-4">3.  依赖传递与仓库优先级原则（后续配置的理论基础）</h5>
<h2 data-id="heading-5">三、IDEA 中 Maven 镜像配置（最常用场景）</h2>
<h5 data-id="heading-6">1.  镜像的核心作用：替代中央仓库、加速依赖下载、统一仓库入口</h5>
<p>镜像仓库可以替代原始仓库，主要用途包括：</p>
<ul>
<li>加速依赖下载</li>
<li>提供统一的仓库入口</li>
<li>解决网络访问问题</li>
</ul>
<p>Maven配置可以在两个位置进行：</p>
<ul>
<li><strong>全局配置</strong>：<code>${MAVEN_HOME}/conf/settings.xml</code></li>
<li><strong>项目配置</strong>：项目根目录下的<code>pom.xml</code></li>
</ul>
<h5 data-id="heading-7">2.  实操步骤（IDEA 界面 + 配置文件双说明）：</h5>
<p>在IDEA中，通过以下路径找到Maven配置：IDEA <code>「File → Settings → Build,Execution,Deployment → Maven」</code>路径</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c293e70716d4431bc29d2859b2bedcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576939&amp;x-signature=7Fgqf%2Fv%2F6nWswY4SdZd2MoiC1%2Bo%3D" alt="Idea_Maven配置页面.png" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
           <span class="hljs-comment">&lt;!-- 两个mirror根据需要选择其中一个配置即可 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
 
          <span class="hljs-comment">&lt;!-- 配置1 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 仅镜像中央仓库 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- 配置2 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 覆盖除了公司的所有依赖下载位置 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>*,!company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 公司的依赖下载位置 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>公司私有镜像仓库下载地址<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://your-private-repo.com/repository/maven-public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
        
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>

</code></pre>
<p>基础镜像配置（以阿里云为例）：mirrorOf 标签使用（* /central 的区别）
<strong>mirrorOf标签说明</strong>：</p>
<ul>
<li><code>central</code>：仅镜像中央仓库</li>
<li><code>*</code>：镜像所有仓库（慎用，可能覆盖私有仓库）</li>
</ul>
<p>带认证的镜像配置（企业私有镜像）：server 标签配置 username/password</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>username<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span> <span class="hljs-comment">&lt;!-- 必须与repository,server的id匹配 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>company-nexus<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>私有仓库镜像<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://your-private-repo.com/repository/maven-public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">4.  常见问题：镜像不生效？IDEA 未加载 settings.xml？镜像优先级冲突？</h5>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>镜像不生效</strong>：检查mirrorOf配置是否正确</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>IDEA未加载settings.xml</strong>：确认IDEA使用的是正确的settings.xml文件</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>镜像优先级冲突</strong>：避免使用mirrorOf="*"覆盖所有仓库</li>
</ul>
<h5 data-id="heading-9">5.  补充功能点：</h5>
<ul>
<li>
<p>镜像排除（部分依赖不走镜像，直接访问原仓库）</p>
</li>
<li>
<p>多镜像协同（不同仓库对应不同镜像，避免 mirrorOf="*" 覆盖私有库）</p>
</li>
</ul>
<h2 data-id="heading-10">四、IDEA 中 Maven 多仓库依赖配置</h2>
<h5 data-id="heading-11">1.  多仓库的应用场景：同时拉取中央仓库 + 企业私有库 + 第三方仓库（如 JBoss、Spring）</h5>
<p>当项目需要从多个仓库获取依赖时：</p>
<ul>
<li>中央仓库（公共依赖）</li>
<li>企业私有仓库（内部组件）</li>
<li>第三方仓库（如JBoss、Spring仓库）</li>
</ul>
<h5 data-id="heading-12">2.  两种配置方式（对比优缺点）：</h5>
<ul>
<li>方式 1：settings.xml 中配置 profile+repositories（全局生效）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>multi-repo-profile<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>my-company-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Company Repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.company.com/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activeProfiles</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">activeProfile</span>&gt;</span>multi-repo-profile<span class="hljs-tag">&lt;/<span class="hljs-name">activeProfile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">activeProfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<ul>
<li>方式 2：项目 pom.xml 中配置 repositories（项目局部生效）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/release<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h5 data-id="heading-13">3.  实操步骤：</h5>
<ul>
<li>私有仓库权限配置（settings.xml 中 server 与 pom 仓库 id 关联）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>my-company-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 必须与repository的id匹配 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>deployment<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>secret-password<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<h5 data-id="heading-14">4.  关键补充功能点：</h5>
<p>仓库优先级配置（releases/snapshots 的 enabled 属性、仓库顺序）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>custom-repo2<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://example.com/repo2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>never<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>never<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>custom-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://example.com/repo<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 仓库匹配顺序 custom-repo2 &gt; &gt;custom-repo --&gt;</span>
</code></pre>
<ul>
<li>
<p>依赖下载失败处理（清理本地仓库、强制更新依赖）</p>
<ol>
<li>清理本地仓库缓存</li>
<li>强制更新依赖：在IDEA的Maven面板点击"reload"</li>
<li>命令行强制更新：<code>mvn clean compile -U</code></li>
</ol>
</li>
<li>
<p>仓库镜像与多仓库的协同（避免镜像覆盖多仓库配置）</p>
</li>
</ul>
<h5 data-id="heading-15">5.  避坑指南：仓库 id 重复问题、快照仓库未启用导致依赖拉取失败</h5>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>仓库id重复</strong>：确保所有仓库id唯一</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>快照仓库未启用</strong>：如需快照版本，确保<code>&lt;snapshots&gt;&lt;enabled&gt;true&lt;/enabled&gt;&lt;/snapshots&gt;</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>镜像覆盖问题</strong>：避免mirrorOf="*"覆盖私有仓库</li>
</ul>
<h2 data-id="heading-16">五、IDEA 中 Maven 多 Profile 配置</h2>
<h5 data-id="heading-17">1.  多 Profile 核心价值：开发 / 测试 / 生产环境依赖版本切换、配置隔离（如数据库连接、仓库地址）</h5>
<p>多Profile配置允许我们：</p>
<ul>
<li>实现开发、测试、生产环境的配置隔离</li>
<li>动态切换依赖版本</li>
<li>管理不同环境的仓库地址</li>
</ul>
<h5 data-id="heading-18">2.  Profile 的定义位置：</h5>
<h3 data-id="heading-19">Profile定义位置</h3>
<ul>
<li><strong>全局Profile</strong>：在settings.xml中定义，适用于所有项目</li>
<li><strong>局部Profile</strong>：在项目pom.xml中定义，仅当前项目有效</li>
</ul>
<h5 data-id="heading-20">3.  实操步骤：</h5>
<ul>
<li>定义 Profile：指定 id、激活条件（activeByDefault）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 开发环境 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>development<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">activeByDefault</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">activeByDefault</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- 测试环境 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- 生产环境 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>production<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<ul>
<li>Profile 中配置差异化内容：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.company<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>core-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.company.com/snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.company<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>core-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-release<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.company.com/releases<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>IDEA 中激活 Profile：</p>
</li>
<li>
<p>方式 1：Maven 面板「Profiles」勾选激活</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4f183e0816a47418f064404f2d7d28d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576939&amp;x-signature=vhcE8X5Q%2FCMvLBZt7wz7bt9mbiI%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e95c41fdad4171a45f8381ea635a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576939&amp;x-signature=9JlXG5m3yCEwdmpVeSx31dm4Vas%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-pain" lang="pain">File → Settings → Build,Execution,Deployment → Maven → Runner
在VM Options中添加：-Dmaven.profile.active=dev
</code></pre>
<ul>
<li>方式 2：IDEA 配置「Build,Execution,Deployment → Maven → Runner」中添加 - Dmaven.profile.active=xxx​</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8831ba409c5640aa931d81c2c9280203~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576939&amp;x-signature=uU2eddl8Lk2cSID1B4rq2QVN97Q%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>方式 3：settings.xml 中用 activeProfiles 指定默认激活</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">activeProfiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activeProfile</span>&gt;</span>repo-dev<span class="hljs-tag">&lt;/<span class="hljs-name">activeProfile</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">activeProfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<h5 data-id="heading-21">4.  关键补充功能点：</h5>
<ul>
<li>
<p>Profile 激活优先级（命令行参数 &gt; activeByDefault &gt; settings.xml 激活）</p>
</li>
<li>
<p>多 Profile 同时激活（场景：基础配置 Profile + 环境专属 Profile）</p>
</li>
<li>
<p>Profile 与多仓库 / 镜像的联动配置（如不同 Profile 对接不同仓库）</p>
</li>
</ul>
<h5 data-id="heading-22">5.  实战案例：开发 / 测试 / 生产三环境依赖与仓库的 Profile 切换示例</h5>
<p>需求场景</p>
<p>我们需要为项目配置：</p>
<ul>
<li><strong>开发环境</strong>：激活dev Profile，使用快照依赖，连接开发私有库</li>
<li><strong>生产环境</strong>：激活prod Profile，使用稳定依赖，连接生产私有库</li>
</ul>
<ol>
<li>settings.xml全局配置</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 镜像配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 服务器认证 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-dev-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>dev-user<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>dev-password<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-prod-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>prod-user<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>prod-password<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<ol start="2">
<li>pom.xml项目配置</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 多Profile配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 开发环境 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">environment</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">activeByDefault</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">activeByDefault</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-dev-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.company.com/dev<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.company<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>business-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- 生产环境 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">environment</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>company-prod-repo<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.company.com/prod<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.company<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>business-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p>效果验证</p>
<ol>
<li>在IDEA中切换不同Profile</li>
<li>查看Maven依赖列表确认版本变化</li>
<li>检查Maven下载日志确认仓库切换
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e903cf6b5d14d2f82280b63bc94f382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576939&amp;x-signature=%2FjN4Xe4%2BcyKpYzjxofR4Id5ogUM%3D" alt="image.png" loading="lazy"/></li>
</ol>
<h2 data-id="heading-23">六、常见问题与排错技巧</h2>
<ol>
<li>依赖拉取失败：镜像配置错误、仓库权限问题、Profile 未激活</li>
</ol>
<ul>
<li>镜像配置错误</li>
<li>仓库权限问题</li>
<li>Profile未正确激活</li>
</ul>
<ol start="2">
<li>多仓库优先级不生效：仓库顺序配置错误、镜像覆盖</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 强制更新依赖</span>
mvn clean compile -U

<span class="hljs-comment"># 查看详细下载日志</span>
mvn dependency:resolve -X
</code></pre>
<ul>
<li>检查仓库配置顺序</li>
<li>确认镜像没有覆盖所有仓库</li>
<li>验证releases/snapshots配置</li>
</ul>
<ol start="3">
<li>Profile 切换后依赖未更新：IDEA 未重新导入依赖、本地仓库缓存</li>
</ol>
<ul>
<li>IDEA中执行Maven → Reimport</li>
<li>清理本地仓库缓存</li>
<li>重启IDEA</li>
</ul>
<ol start="4">
<li>
<p>私有仓库访问 401/403：server 标签 id 与仓库 id 不匹配、用户名密码错误​</p>
</li>
<li>
<p>确认server的id与repository的id匹配</p>
</li>
<li>
<p>检查用户名密码是否正确</p>
</li>
<li>
<p>验证仓库URL是否可以访问</p>
</li>
<li>
<p>工具辅助：IDEA Maven 日志查看（Show Log）、Maven 命令行验证（mvn clean compile -U）</p>
</li>
</ol>
<h2 data-id="heading-24">八、总结与扩展</h2>
<ol>
<li>核心配置逻辑梳理：镜像（加速）→ 多仓库（多源依赖）→ 多 Profile（环境隔离）​</li>
</ol>
<p>通过本文的学习，我们应该掌握：</p>
<ul>
<li><strong>镜像配置</strong>：加速依赖下载，统一入口</li>
<li><strong>多仓库配置</strong>：支持多源依赖管理</li>
<li><strong>多Profile配置</strong>：实现环境隔离和动态切换</li>
</ul>
<ol start="2">
<li>
<p>最佳实践建议：</p>
<ol>
<li>
<p><strong>配置分离原则</strong>：</p>
<ul>
<li>全局配置（镜像、私有库权限）放在settings.xml</li>
<li>项目差异化配置（多Profile、局部仓库）放在pom.xml</li>
</ul>
</li>
<li>
<p><strong>环境管理</strong>：</p>
<ul>
<li>优先使用Profile实现环境隔离</li>
<li>避免在代码中硬编码环境相关配置</li>
</ul>
</li>
<li>
<p><strong>依赖管理</strong>：</p>
<ul>
<li>使用dependencyManagement统一管理依赖版本</li>
<li>定期清理本地仓库缓存</li>
</ul>
</li>
</ol>
</li>
<li>
<p>扩展方向：</p>
</li>
</ol>
<ul>
<li><strong>Maven私服搭建</strong>：学习Nexus或Artifactory的安装和配置</li>
<li><strong>依赖冲突解决</strong>：掌握IDEA的Dependency Analyzer工具</li>
<li><strong>持续集成集成</strong>：在Jenkins/GitLab CI中配置Maven多Profile</li>
</ul>
<p>通过合理配置Maven多仓库和多Profile，我们可以构建更加健壮、可维护的Java项目，有效解决企业级开发中的依赖管理挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Objective-C 测试（OC 测试）指南 从单元测试到性能调优的多工具协同方法]]></title>    <link>https://juejin.cn/post/7576090441432514570</link>    <guid>https://juejin.cn/post/7576090441432514570</guid>    <pubDate>2025-11-24T08:32:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576090441432514570" data-draft-id="7576090441432498186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Objective-C 测试（OC 测试）指南 从单元测试到性能调优的多工具协同方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:32:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Objective-C 测试（OC 测试）指南 从单元测试到性能调优的多工具协同方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:32:46.000Z" title="Mon Nov 24 2025 08:32:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 生态逐渐向 Swift 靠拢的同时，<strong>Objective-C（OC）依旧是大量成熟大型 App 的主力语言</strong>。
尤其在企业级项目、历史项目、框架库、原生组件中，OC 的稳定性与可控性仍旧不可替代。
因此，构建一套 <strong>适用于 OC 项目、覆盖功能、性能、系统日志与跨端场景的测试体系</strong>，对许多团队来说依然非常重要。</p>
<p>本文将从工程实战角度出发，围绕 OC 测试的常见场景，结合 <strong>XCTest、OCMock、Instruments、克魔（KeyMob）、PerfDog、Charles、Safari Inspector、MetricKit、Xcode 调试工具</strong> 等多工具构成一套可落地的测试体系。</p>
<p>文章风格保持工程化、不含广告化语气、不依赖网络搜索，基于开发者实际工作场景编写。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 OC 项目需要更完善的测试体系？</h2>
<p>OC 项目通常具有以下特点：</p>
<h3 data-id="heading-1"><strong>1. 历史代码多，缺乏单测</strong></h3>
<p>许多业务逻辑仍依赖面向对象、运行时特性，测试难度比 Swift 更高。</p>
<h3 data-id="heading-2"><strong>2. 容易出现运行时错误</strong></h3>
<p>如：</p>
<ul>
<li>unrecognized selector</li>
<li>KVC/KVO 崩溃</li>
<li>NSException</li>
</ul>
<h3 data-id="heading-3"><strong>3. 复杂的 UI 逻辑</strong></h3>
<p>OC 项目多数 UI 架构较老，性能问题更容易在 UI 层暴露。</p>
<h3 data-id="heading-4"><strong>4. 与 Hybrid、C++、底层框架兼容</strong></h3>
<p>意味着测试不仅包括 OC 逻辑，还包含底层组件行为。</p>
<h3 data-id="heading-5"><strong>5. 老项目更需要性能和稳定性保证</strong></h3>
<p>因此，OC 测试必须覆盖<strong>功能 + 性能 + 系统日志 + 文件数据 + 跨端行为</strong>多个维度。</p>
<hr/>
<h2 data-id="heading-6">二、XCTest：OC 单元测试的核心基础</h2>
<p>XCTest 是苹果官方单元测试框架，对 OC 项目非常成熟。</p>
<h3 data-id="heading-7"><strong>1. 单元测试（Unit Test）</strong></h3>
<p>用于验证 OC 模块内部逻辑，例如：</p>
<pre><code class="hljs language-ini" lang="ini">- (void)testCalculateTotalPrice {
    OrderManager *<span class="hljs-attr">m</span> = [OrderManager new]<span class="hljs-comment">;</span>
    XCTAssertEqual(<span class="hljs-section">[m totalPrice]</span>, 0)<span class="hljs-comment">;</span>
}
</code></pre>
<p>适合测试：</p>
<ul>
<li>Model</li>
<li>工具类</li>
<li>业务计算逻辑</li>
<li>数据解析</li>
</ul>
<h3 data-id="heading-8"><strong>2. UI 测试（XCUITest）</strong></h3>
<p>用于流程自动化，例如：</p>
<ul>
<li>启动 App</li>
<li>自动点击按钮</li>
<li>输入内容</li>
<li>验证 UI 状态</li>
</ul>
<p>这对 OC 项目的回归测试非常重要。</p>
<hr/>
<h2 data-id="heading-9">三、OCMock：Objective-C 测试中的“Mock 利器”</h2>
<p>OCMock 是很多 OC 工程师仍在使用的 Mock 框架，可用于：</p>
<h3 data-id="heading-10"><strong>1. Mock 对象方法</strong></h3>
<p>模拟接口返回、逻辑分支：</p>
<pre><code class="hljs language-ini" lang="ini">OCMockObject *<span class="hljs-attr">mock</span> = OCMClassMock([UserService class])<span class="hljs-comment">;</span>
OCMStub(<span class="hljs-section">[mock fetchUser]</span>).andReturn(mockUser)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11"><strong>2. Mock Delegate / Block 回调</strong></h3>
<h3 data-id="heading-12"><strong>3. 验证方法是否被调用</strong></h3>
<pre><code class="hljs language-css" lang="css">OCMVerify(<span class="hljs-selector-attr">[mock trackEvent:@<span class="hljs-string">"open"</span>]</span>);
</code></pre>
<p>在业务依赖较深、运行时行为较复杂的 OC 项目中，OCMock 对提升测试覆盖率非常关键。</p>
<hr/>
<h2 data-id="heading-13">四、Instruments：OC 性能测试的“显微镜”</h2>
<p>无论 OC 还是 Swift，底层性能测试统一依赖 Instruments。</p>
<p>在 OC 项目中尤其需要关注：</p>
<h3 data-id="heading-14"><strong>1. Time Profiler</strong></h3>
<p>用来查：</p>
<ul>
<li>主线程阻塞（OC 中更常见）</li>
<li>无意的同步调用</li>
<li>高耗时方法</li>
</ul>
<h3 data-id="heading-15"><strong>2. Leaks / Allocations</strong></h3>
<p>OC 的内存管理更复杂，容易出现：</p>
<ul>
<li>循环引用（block/self）</li>
<li>未释放对象</li>
<li>自动释放池滥用</li>
</ul>
<h3 data-id="heading-16"><strong>3. Core Animation</strong></h3>
<p>OC 项目往往 UI 结构更重，更容易出现渲染问题：</p>
<ul>
<li>重绘过多</li>
<li>离屏渲染</li>
<li>布局过于复杂</li>
</ul>
<p>Instruments 是 OC 性能调试的核心工具。</p>
<hr/>
<h2 data-id="heading-17">五、克魔（KeyMob）：系统日志 + 性能监控 + 文件调试（OC 项目的非常高适配度）</h2>
<p>OC 项目因历史原因或系统层依赖更容易产生：</p>
<ul>
<li>KVO 异常</li>
<li>内存压力导致 jetsam</li>
<li>UI 卡顿导致 watchdog</li>
<li>NSException 崩溃</li>
<li>WebKit/WebView 崩溃</li>
<li>Sandbox 文件解析需求</li>
</ul>
<p>KeyMob 能补足 Xcode 的能力，包括：</p>
<h3 data-id="heading-18"><strong>1. 实时性能监控</strong></h3>
<p>可监控：</p>
<ul>
<li>CPU</li>
<li>GPU</li>
<li>内存</li>
<li>FPS</li>
<li>网络</li>
<li>温度、能耗</li>
</ul>
<p>非常适合验证 OC 项目常见的性能回归问题。</p>
<h3 data-id="heading-19"><strong>2. 系统日志（Device Logs）捕获</strong></h3>
<p>OC 项目最容易出现的系统错误包括：</p>
<pre><code class="hljs language-java" lang="java">EXC_BAD_ACCESS
<span class="hljs-title function_">jetSam</span> <span class="hljs-params">(Memory highwater)</span>
KVO crash
<span class="hljs-title function_">watchdog</span> <span class="hljs-params">(main thread hang)</span>
</code></pre>
<p>Xcode 很难完整捕获，但 KeyMob 可以完整展示。</p>
<h3 data-id="heading-20"><strong>3. App 文件与数据管理</strong></h3>
<p>用于查看：</p>
<ul>
<li>plist 配置</li>
<li>缓存文件</li>
<li>OC 底层序列化文件</li>
<li>用户数据目录</li>
<li>崩溃日志</li>
</ul>
<p>对调试 OC 项目中的 Sandbox 逻辑非常有效。</p>
<hr/>
<h2 data-id="heading-21">六、PerfDog：OC 视图结构下的 FPS/CPU/GPU 关键诊断</h2>
<p>OC 项目往往使用更传统、更复杂的视图结构，例如：</p>
<ul>
<li>UITableView + 大量 cell</li>
<li>手写 UI 布局</li>
<li>大量 CALayer</li>
<li>混合 CoreAnimation 与 UIKit</li>
<li>异步绘制不足</li>
</ul>
<p>PerfDog 能精准分析：</p>
<ul>
<li>FPS 掉帧点</li>
<li>多次交互后的性能退化</li>
<li>CPU 峰值与 UI 更新关系</li>
<li>GPU 渲染压力</li>
</ul>
<p>尤其适用于 OC 项目中常见的“越滑越卡”“页面切换卡顿”。</p>
<hr/>
<h2 data-id="heading-22">七、Safari Inspector：Hybrid、H5、OC 容器混合场景测试</h2>
<p>许多历史 OC 项目使用：</p>
<ul>
<li>UIWebView（老项目）</li>
<li>WKWebView（新项目）</li>
<li>Hybrid（OC + JSBridge）</li>
<li>uni-app 容器</li>
</ul>
<p>Safari Inspector 可以：</p>
<ul>
<li>查看 JS 性能</li>
<li>分析 DOM 结构</li>
<li>验证 JSBridge 延迟</li>
<li>找出 Hybrid 阻塞 UI 的行为</li>
</ul>
<p>OC 项目中经常出现 WebView 卡顿问题，Safari Inspector 是必选项。</p>
<hr/>
<h2 data-id="heading-23">八、Charles / Proxyman：OC 网络层测试工具</h2>
<p>OC 时代许多项目仍使用：</p>
<ul>
<li>AFNetworking</li>
<li>NSURLSession + 手写网络层</li>
</ul>
<p>Charles 用于测试：</p>
<ul>
<li>网络异常</li>
<li>重定向</li>
<li>Cache-Control 是否正确</li>
<li>弱网行为</li>
<li>接口链路延迟</li>
</ul>
<p>是 OC 应用网络层回归测试的标配工具。</p>
<hr/>
<h2 data-id="heading-24">九、MetricKit + Firebase：OC 线上性能监控体系</h2>
<p>OC 项目一般运行在用户量庞大的应用中，线上监控尤为重要。</p>
<h3 data-id="heading-25"><strong>MetricKit 可收集：</strong></h3>
<ul>
<li>CPU 时间</li>
<li>内存峰值</li>
<li>热力状态</li>
<li>崩溃类型</li>
<li>启动性能</li>
<li>每日性能趋势</li>
</ul>
<h3 data-id="heading-26"><strong>Firebase 可收集：</strong></h3>
<ul>
<li>页面渲染时间</li>
<li>启动性能</li>
<li>网络耗时</li>
<li>ANR 事件</li>
</ul>
<p>两者结合可构成 OC 应用的线上稳定性监控体系。</p>
<hr/>
<h2 data-id="heading-27">十、构建 Objective-C 测试的完整工程化工具链</h2>













































<table><thead><tr><th>测试类型</th><th>工具组合</th><th>用途</th></tr></thead><tbody><tr><td>单元测试</td><td>XCTest + OCMock</td><td>测试 OC 方法逻辑</td></tr><tr><td>UI 自动化</td><td>XCUITest</td><td>完整流程测试</td></tr><tr><td>性能测试</td><td>Instruments + PerfDog + KeyMob</td><td>CPU/GPU/FPS/内存分析</td></tr><tr><td>网络测试</td><td>Charles</td><td>请求调试 &amp; 弱网</td></tr><tr><td>WebView/Hybrid</td><td>Safari Inspector</td><td>JS/DOM 性能</td></tr><tr><td>系统级行为</td><td>KeyMob + Console.app</td><td>jetsam/watchdog/KVO</td></tr><tr><td>上线监控</td><td>MetricKit + Firebase</td><td>用户真实性能趋势</td></tr></tbody></table>
<p>这套工具链适合绝大多数 OC 项目。</p>
<hr/>
<h2 data-id="heading-28">十一、实战案例：OC 首页卡顿的定位过程</h2>
<p>某 OC 老项目首页滑动卡顿明显。</p>
<h3 data-id="heading-29"><strong>PerfDog</strong></h3>
<p>FPS 在快速滑动时下降到 30–40。</p>
<h3 data-id="heading-30"><strong>KeyMob</strong></h3>
<p>CPU 峰值突然升高至 90%。</p>
<h3 data-id="heading-31"><strong>Instruments（Time Profiler）</strong></h3>
<p>发现某 cell 的图片解码与富文本渲染在主线程执行。</p>
<h3 data-id="heading-32"><strong>Safari Inspector（该项目含 Hybrid）</strong></h3>
<p>Hybrid 部分存在 DOM 节点过多问题。</p>
<h3 data-id="heading-33"><strong>优化方案：</strong></h3>
<ul>
<li>使用异步图片解码</li>
<li>重绘逻辑移到后台线程</li>
<li>Hybrid 列表启用虚拟渲染</li>
</ul>
<p>最终 FPS 稳定在 58–60。</p>
<hr/>
<h2 data-id="heading-34">OC 测试的关键在于“多工具协同”</h2>
<p>OC 项目测试不是“写几行单测”，而是构建一套体系：</p>
<p><strong>逻辑测试
UI 测试
性能测试
系统日志
网络链路
Hybrid 性能
线上数据验证</strong></p>
<p>而实现这一点，必须依赖：</p>
<ul>
<li><strong>XCTest + OCMock</strong>（功能）</li>
<li><strong>Instruments</strong>（CPU/GPU/内存）</li>
<li><strong>KeyMob</strong>（系统日志 + 实时性能）</li>
<li><strong>PerfDog</strong>（FPS 精准采样）</li>
<li><strong>Safari Inspector</strong>（Hybrid）</li>
<li><strong>Charles</strong>（网络）</li>
<li><strong>MetricKit + Firebase</strong>（线上表现）</li>
</ul>
<p>只有当这些工具协同工作，OC 应用的质量才能稳步提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>